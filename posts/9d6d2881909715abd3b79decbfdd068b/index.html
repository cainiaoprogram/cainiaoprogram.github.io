<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Harmony Ble 蓝牙App （一）扫描 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Harmony Ble 蓝牙App （一）扫描" />
<meta property="og:description" content="Harmony Ble 蓝牙App （一）扫描 前言正文一、创建工程二、工程配置① 权限配置② Debug配置③ UI配置 三、扫描① 扫描接口② 扫描类 四、业务处理① Slice的生命周期② 蓝牙开关和动态权限请求 五、扫描设备六、显示设备① 自定义蓝牙类② 提供者③ 显示设备 七、源码 前言 关于Android的低功耗蓝牙，我做了很多介绍了，那么对于Harmony来说这一块我没有做过介绍，而实际中我确实做过一个Harmony的BLE项目，所以这里分享一些内容出来。
正文 在Harmony中进行Ble的蓝牙开发实际上和Android中类似，但是又有一些不同，因为Harmony的SDK还在不断的完善。而这里我们使用的是API 6进行项目开发，使用的语言是Java，至于为什么使用API 6而不是最新的API 9，因为我买不起遥遥领先，所以只能用API 6的HUAWEI P30进行真机测试。蓝牙这种APP一定是要使用真机测试的，你用虚拟机是不行的，话不多说，我们开始吧。
一、创建工程 下面开始创建工程。
选择Empty Ability，点击Next。我们创建一个名为HarmonyBle的项目，语言为Java。
点击Finish完成创建。
默认的工程就是这个样子的，是不是很像Android创建的工程呢？
二、工程配置 ① 权限配置 Harmony中同样有权限这个概念，也需要配置静态权限和动态权限，只不过配置静态权限的地方不一样。Harmony是在config.json中，里面的代码如下：
{ &#34;app&#34;: { &#34;bundleName&#34;: &#34;com.llw.ble&#34;, &#34;vendor&#34;: &#34;example&#34;, &#34;version&#34;: { &#34;code&#34;: 1000000, &#34;name&#34;: &#34;1.0.0&#34; } }, &#34;deviceConfig&#34;: { }, &#34;module&#34;: { &#34;package&#34;: &#34;com.llw.ble&#34;, &#34;name&#34;: &#34;.MyApplication&#34;, &#34;mainAbility&#34;: &#34;com.llw.ble.MainAbility&#34;, &#34;deviceType&#34;: [ &#34;phone&#34;, &#34;tablet&#34;, &#34;tv&#34;, &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/9d6d2881909715abd3b79decbfdd068b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-20T21:15:00+08:00" />
<meta property="article:modified_time" content="2023-11-20T21:15:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Harmony Ble 蓝牙App （一）扫描</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>Harmony Ble 蓝牙App （一）扫描</h4> 
 <ul><li><a href="#_1" rel="nofollow">前言</a></li><li><a href="#_5" rel="nofollow">正文</a></li><li><ul><li><a href="#_11" rel="nofollow">一、创建工程</a></li><li><a href="#_28" rel="nofollow">二、工程配置</a></li><li><ul><li><a href="#__30" rel="nofollow">① 权限配置</a></li><li><a href="#_Debug_114" rel="nofollow">② Debug配置</a></li><li><a href="#_UI_198" rel="nofollow">③ UI配置</a></li></ul> 
   </li><li><a href="#_328" rel="nofollow">三、扫描</a></li><li><ul><li><a href="#__332" rel="nofollow">① 扫描接口</a></li><li><a href="#__347" rel="nofollow">② 扫描类</a></li></ul> 
   </li><li><a href="#_512" rel="nofollow">四、业务处理</a></li><li><ul><li><a href="#_Slice_535" rel="nofollow">① Slice的生命周期</a></li><li><a href="#__639" rel="nofollow">② 蓝牙开关和动态权限请求</a></li></ul> 
   </li><li><a href="#_754" rel="nofollow">五、扫描设备</a></li><li><a href="#_822" rel="nofollow">六、显示设备</a></li><li><ul><li><a href="#__828" rel="nofollow">① 自定义蓝牙类</a></li><li><a href="#__885" rel="nofollow">② 提供者</a></li><li><a href="#__1035" rel="nofollow">③ 显示设备</a></li></ul> 
   </li><li><a href="#_1113" rel="nofollow">七、源码</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>前言</h2> 
<p>  关于Android的低功耗蓝牙，我做了很多介绍了，那么对于Harmony来说这一块我没有做过介绍，而实际中我确实做过一个Harmony的BLE项目，所以这里分享一些内容出来。</p> 
<h2><a id="_5"></a>正文</h2> 
<p>  在Harmony中进行Ble的蓝牙开发实际上和Android中类似，但是又有一些不同，因为Harmony的SDK还在不断的完善。而这里我们使用的是API 6进行项目开发，使用的语言是Java，至于为什么使用API 6而不是最新的API 9，因为我买不起遥遥领先，所以只能用API 6的HUAWEI P30进行真机测试。蓝牙这种APP一定是要使用真机测试的，你用虚拟机是不行的，话不多说，我们开始吧。</p> 
<p><img src="https://images2.imgbox.com/01/2a/Yl9lvsvj_o.gif" alt="在这里插入图片描述"></p> 
<h3><a id="_11"></a>一、创建工程</h3> 
<p>  下面开始创建工程。</p> 
<p><img src="https://images2.imgbox.com/07/30/jao9JKqX_o.png" alt="在这里插入图片描述"></p> 
<p>选择<code>Empty Ability</code>，点击Next。我们创建一个名为<code>HarmonyBle</code>的项目，语言为Java。</p> 
<p><img src="https://images2.imgbox.com/f8/d4/5DusT1Yb_o.png" alt="在这里插入图片描述"></p> 
<p>点击<code>Finish</code>完成创建。</p> 
<p><img src="https://images2.imgbox.com/95/4b/iGt3lm9F_o.png" alt="在这里插入图片描述"></p> 
<p>默认的工程就是这个样子的，是不是很像Android创建的工程呢？</p> 
<h3><a id="_28"></a>二、工程配置</h3> 
<h4><a id="__30"></a>① 权限配置</h4> 
<p>  Harmony中同样有权限这个概念，也需要配置静态权限和动态权限，只不过配置静态权限的地方不一样。Harmony是在<code>config.json</code>中，里面的代码如下：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"app"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"bundleName"</span><span class="token operator">:</span> <span class="token string">"com.llw.ble"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"vendor"</span><span class="token operator">:</span> <span class="token string">"example"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"version"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"code"</span><span class="token operator">:</span> <span class="token number">1000000</span><span class="token punctuation">,</span>
      <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"1.0.0"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"deviceConfig"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"module"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"package"</span><span class="token operator">:</span> <span class="token string">"com.llw.ble"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">".MyApplication"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"mainAbility"</span><span class="token operator">:</span> <span class="token string">"com.llw.ble.MainAbility"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"deviceType"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">"phone"</span><span class="token punctuation">,</span>
      <span class="token string">"tablet"</span><span class="token punctuation">,</span>
      <span class="token string">"tv"</span><span class="token punctuation">,</span>
      <span class="token string">"wearable"</span><span class="token punctuation">,</span>
      <span class="token string">"car"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string-property property">"distro"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"deliveryWithInstall"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token string-property property">"moduleName"</span><span class="token operator">:</span> <span class="token string">"entry"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"moduleType"</span><span class="token operator">:</span> <span class="token string">"entry"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"installationFree"</span><span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"abilities"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"skills"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"entities"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
              <span class="token string">"entity.system.home"</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string-property property">"actions"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
              <span class="token string">"action.system.home"</span>
            <span class="token punctuation">]</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"com.llw.ble.MainAbility"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"description"</span><span class="token operator">:</span> <span class="token string">"$string:mainability_description"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"icon"</span><span class="token operator">:</span> <span class="token string">"$media:icon"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"label"</span><span class="token operator">:</span> <span class="token string">"$string:entry_MainAbility"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"launchType"</span><span class="token operator">:</span> <span class="token string">"standard"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"orientation"</span><span class="token operator">:</span> <span class="token string">"unspecified"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"visible"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"page"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  你阅读一下，你就会发现，这和Android的<code>AndroidManifest.xml</code>配置文件好像差不多啊。只不过一个用的是json，一个用的是xml。</p> 
<p>  所以我们配置权限也是在<code>config.json</code>中，例如扫描蓝牙时我们需要定位权限。可以在里面增加如下代码：</p> 
<pre><code class="prism language-json">    <span class="token string-property property">"reqPermissions"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"ohos.permission.LOCATION"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"ohos.permission.USE_BLUETOOTH"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"ohos.permission.DISCOVER_BLUETOOTH"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"ohos.permission.MANAGE_BLUETOOTH"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
</code></pre> 
<p>如下图所示，注意json中标点符号。</p> 
<p><img src="https://images2.imgbox.com/72/44/lZX23BfX_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_Debug_114"></a>② Debug配置</h4> 
<p>  然后我们就应该要来写代码了，不过在此之前，我们先了解一下Ability和Slice的区别，Ability就像一个画框，而Slice就像一个画布。我们可以在一个画框里面加载多个画布，就好像多个页面之前的跳转，我们可以用Slice来进行，下面我们增加一个扫描的Slice，我们复制一下MainAbilitySlice，再粘贴一下，出现的弹窗中改名字</p> 
<p><img src="https://images2.imgbox.com/71/60/zL2nUfls_o.png" alt="在这里插入图片描述"><br>   为什么要通过这种方式来创建Java文件呢？因为DevEco Studio我创建不了Java文件，可能是这个版本的DS没有这个选项亦或是我没有找到。</p> 
<p>  下面我们需要创建对应layout文件，再resources/base/layout下创建一个slice_scan.xml，代码如下：</p> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DirectionalLayout</span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>ohos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.huawei.com/res/ohos<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">ohos:</span>height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">ohos:</span>width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">ohos:</span>alignment</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>center<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">ohos:</span>orientation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>vertical<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ListContainer</span>
        <span class="token attr-name"><span class="token namespace">ohos:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$+id:lc_device<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">ohos:</span>height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">ohos:</span>width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>DirectionalLayout</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>  然后我们再修改ScanSlice中的内容，让它加载我们刚写好的slice_scan.xml。修改onStart()方法，代码如下所示：</p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onStart</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onStart</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setUIContent</span><span class="token punctuation">(</span><span class="token class-name">ResourceTable<span class="token punctuation">.</span>Layout_slice_scan</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>现在App打开之后默认会运行MainAbility，我们看一下这个里面。</p> 
<pre><code class="prism language-typescript"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainAbility</span> <span class="token keyword">extends</span> <span class="token class-name">Ability</span> <span class="token punctuation">{<!-- --></span>
    <span class="token decorator"><span class="token at operator">@</span><span class="token function">Override</span></span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onStart</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onStart</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setMainRoute</span><span class="token punctuation">(</span>MainAbilitySlice<span class="token punctuation">.</span>class<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  可以看到，在setMainRoute()方法中，默认加载的是<code>MainAbilitySlice</code>，将它改为我们刚写好的<code>ScanSlice</code>，代码：<code>super.setMainRoute(ScanSlice.class.getName());</code></p> 
<p>然后我们先运行一下看看，通过USB链接到鸿蒙手机上。</p> 
<p><img src="https://images2.imgbox.com/9e/b2/31qxz26A_o.png" alt="在这里插入图片描述"></p> 
<p>这里会提示报错，浏览一下错误信息。</p> 
<p><img src="https://images2.imgbox.com/26/1c/UiGer6ZD_o.png" alt="在这里插入图片描述"></p> 
<p>  这里是说我们需要配置Signing。点击Run下面或者右侧弹窗的<code>Open signing configs</code>，会打开一个配置窗口，如下图所示：</p> 
<p><img src="https://images2.imgbox.com/e7/1b/3w1sXCMQ_o.png" alt="在这里插入图片描述"></p> 
<p>我们点击<code>Signing Configs</code>选项，需要你进行登录，如下图所示：</p> 
<p><img src="https://images2.imgbox.com/7b/74/UvVC3p3q_o.png" alt="在这里插入图片描述"></p> 
<p>  这里就需要你登录华为的帐号了，我们当前在本地运行所以是Debug模式，旁边有一个Release表示发布版本，它里面配置的东西和Debug模式一致，区别在于Debug模式下的配置信息只要我们登录之后，DevEco Studio会帮助我们自动生成，而Release中的信息则需要开发者去华为开发者官网上去创建应用并申请配置文件和证书，比较麻烦，但是如果你要上架应用则必须做这一步，在国内，华为应用市场上架应用是最严格的。华为的你搞得定，其他的都是小趴菜，不值一提。</p> 
<p>  下面我们先登录，会打开一个网页，登录成功之后，你会看到这样的页面。</p> 
<p><img src="https://images2.imgbox.com/15/fc/P4gDCjq9_o.png" alt="在这里插入图片描述"></p> 
<p>  然后我们回到DS，就会自动配置Debug模式下的证书和配置文件，如下图所示：</p> 
<p><img src="https://images2.imgbox.com/6f/b9/Qg5AGDtV_o.png" alt="在这里插入图片描述"></p> 
<p>  点击OK，会在DS中进行一个配置，配置好之后你可以在工程目录下的<code>build.gradle</code>中看到debug的相关信息，如下图所示。</p> 
<p><img src="https://images2.imgbox.com/a7/88/SY42cSvL_o.png" alt="在这里插入图片描述"></p> 
<p>然后我们再运行一下看看，这一次毫无疑问是可以运行成功的。如下图所示：</p> 
<p><img src="https://images2.imgbox.com/e5/24/WrXcJQtQ_o.jpg" alt="在这里插入图片描述" width="300" height="600"></p> 
<h4><a id="_UI_198"></a>③ UI配置</h4> 
<p>可以看到默认的标题栏就如同<code>Android</code>默认的<code>ActionBar</code>，丑的很特别，我们去掉它，在config.json中添加如下代码：</p> 
<pre><code class="prism language-typescript">        <span class="token string-property property">"metaData"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"customizeData"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{<!-- --></span>
              <span class="token string-property property">"extra"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
              <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"hwc-theme"</span><span class="token punctuation">,</span>
              <span class="token string-property property">"value"</span><span class="token operator">:</span> <span class="token string">"androidhwext:style/Theme.Emui.Light.NoTitleBar"</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> 
<p>添加位置如下所示：</p> 
<p><img src="https://images2.imgbox.com/aa/9f/GEIY6IQ3_o.png" alt="在这里插入图片描述"></p> 
<p>下面我们再运行一下看看。</p> 
<p><img src="https://images2.imgbox.com/d3/7c/96CYlu5S_o.jpg" alt="在这里插入图片描述" width="300" height="600"><br> 是不是<code>Unbelievable!</code> 同样为了标题好看，我们在element下创建一个<code>color.json</code>，里面的代码如下所示：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"color"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"white"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"value"</span><span class="token operator">:</span> <span class="token string">"#FFF"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"black"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"value"</span><span class="token operator">:</span> <span class="token string">"#000"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"blue"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"value"</span><span class="token operator">:</span> <span class="token string">"#FFA7D3FF"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"bg_color"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"value"</span><span class="token operator">:</span> <span class="token string">"#F8F8F8"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"gray"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"value"</span><span class="token operator">:</span> <span class="token string">"#989898"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>我们再修改一下scan_slice.xml中的代码，如下所示：</p> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DirectionalLayout</span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>ohos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.huawei.com/res/ohos<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">ohos:</span>height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">ohos:</span>width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">ohos:</span>alignment</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>center<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">ohos:</span>background_element</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$color:bg_color<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">ohos:</span>orientation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>vertical<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DirectionalLayout</span>
        <span class="token attr-name"><span class="token namespace">ohos:</span>height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>50vp<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">ohos:</span>width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">ohos:</span>alignment</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>vertical_center<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">ohos:</span>background_element</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$color:blue<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">ohos:</span>orientation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>horizontal<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">ohos:</span>start_padding</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>12vp<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Text</span>
            <span class="token attr-name"><span class="token namespace">ohos:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$+id:title<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">ohos:</span>height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_content<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">ohos:</span>width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_content<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">ohos:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>选择设备<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">ohos:</span>text_color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#FFF<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">ohos:</span>text_font</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>HwChinese-medium<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">ohos:</span>text_size</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>18fp<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">ohos:</span>weight</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Text</span>
            <span class="token attr-name"><span class="token namespace">ohos:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$+id:tx_scan_status<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">ohos:</span>height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_content<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">ohos:</span>width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_content<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">ohos:</span>end_margin</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>6vp<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">ohos:</span>padding</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8vp<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">ohos:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>搜索<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">ohos:</span>text_color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#FFF<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">ohos:</span>text_size</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>14fp<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>DirectionalLayout</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ListContainer</span>
        <span class="token attr-name"><span class="token namespace">ohos:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$+id:lc_device<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">ohos:</span>height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">ohos:</span>width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>DirectionalLayout</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>这个<code>DirectionalLayout</code>布局就是线性布局，我们可以点击右侧导航栏的<code>Previewer</code>进行布局预览，如下图所示。</p> 
<p><img src="https://images2.imgbox.com/32/21/WzPK2nSI_o.png" alt="在这里插入图片描述"></p> 
<p>右上角的T图标，点击之后可以查看当前布局的层级。</p> 
<p><img src="https://images2.imgbox.com/dd/03/FaKMwOyA_o.png" alt="在这里插入图片描述"></p> 
<p>  这里说明一下，有时候在通过资源使用颜色值的时候会无法生效，所以就会直接使用<code>#FFF</code>，在代码里也是如此，这应该属于编译器的Bug。</p> 
<p>标题栏就写好了，还有状态栏我们没有改，状态栏我们在MainAbility中进行修改，代码如下所示：</p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onStart</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Window</span> window <span class="token operator">=</span> <span class="token class-name">WindowManager</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTopWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        window<span class="token punctuation">.</span><span class="token function">setStatusBarColor</span><span class="token punctuation">(</span><span class="token class-name">Color</span><span class="token punctuation">.</span><span class="token function">getIntColor</span><span class="token punctuation">(</span><span class="token string">"#A7D3FF"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onStart</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setMainRoute</span><span class="token punctuation">(</span><span class="token class-name">ScanSlice</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>还是修改<code>onStart()</code>方法，然后我们运行一下看看。</p> 
<p><img src="https://images2.imgbox.com/ad/5e/uAc3uNyw_o.jpg" alt="在这里插入图片描述" width="300" height="600"><br> 好了，下面我们来写扫描需要的内容代码。</p> 
<h3><a id="_328"></a>三、扫描</h3> 
<p>  首先我们在<code>com.llw.ble</code>包下新建一个<code>core</code>包，<code>core</code>包下创建一个<code>BleCore</code>类，这里面就是控制Ble蓝牙相关的一切，比如扫描，连接，读写数据等操作，我们先不写代码。下面在<code>core</code>包下创建一个<code>scan</code>包。</p> 
<h4><a id="__332"></a>① 扫描接口</h4> 
<p><code>scan</code>包下新建一个<code>ScanCallback</code>接口，代码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ScanCallback</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">void</span> <span class="token function">onScanResult</span><span class="token punctuation">(</span><span class="token class-name">BleScanResult</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">onGroupScanResultsEvent</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BleScanResult</span><span class="token punctuation">&gt;</span></span> results<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

    <span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">onScanFailed</span><span class="token punctuation">(</span><span class="token class-name">String</span> failed<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="__347"></a>② 扫描类</h4> 
<p>然后在<code>scan</code>包下新建一个BleScan类，代码如下所示：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BleScan</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BleCentralManager</span> centralManager<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> isScanning <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">ScanCallback</span> scanCallback<span class="token punctuation">;</span>

    <span class="token comment">// 创建扫描过滤器然后开始扫描</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BleScanFilter</span><span class="token punctuation">&gt;</span></span> filters<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token class-name">BleScan</span> mInstance<span class="token punctuation">;</span>

    <span class="token comment">//初始化</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">BleScan</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mInstance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">BleScan</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mInstance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    mInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BleScan</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> mInstance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">BleScan</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">BleScanCallback</span> centralManagerCallback <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BleScanCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        centralManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BleCentralManager</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> centralManagerCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 当前是否正在扫描
     * @return true 扫描中，false 未扫描
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isScanning</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> isScanning<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 设置过滤信息
     * @param filters 蓝牙扫描过滤列表
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setFilters</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BleScanFilter</span><span class="token punctuation">&gt;</span></span> filters<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>filters <span class="token operator">=</span> filters<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 设置扫描回调，页面需要实现才能获取扫描到的设备
     * @param scanCallback 扫描回调
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setScanCallback</span><span class="token punctuation">(</span><span class="token class-name">ScanCallback</span> scanCallback<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>scanCallback <span class="token operator">=</span> scanCallback<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 开始扫描
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startScan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>centralManager <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">localScanFailed</span><span class="token punctuation">(</span><span class="token string">"Bluetooth not turned on."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        centralManager<span class="token punctuation">.</span><span class="token function">startScan</span><span class="token punctuation">(</span>filters<span class="token punctuation">)</span><span class="token punctuation">;</span>
        isScanning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 停止扫描
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">stopScan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isScanning<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">localScanFailed</span><span class="token punctuation">(</span><span class="token string">"Not currently scanning, your stop has no effect."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        centralManager<span class="token punctuation">.</span><span class="token function">stopScan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        isScanning <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 实现扫描回调
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BleScanCallback</span> <span class="token keyword">implements</span> <span class="token class-name">BleCentralManagerCallback</span> <span class="token punctuation">{<!-- --></span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">scanResultEvent</span><span class="token punctuation">(</span><span class="token class-name">BleScanResult</span> bleScanResult<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>scanCallback <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                scanCallback<span class="token punctuation">.</span><span class="token function">onScanResult</span><span class="token punctuation">(</span>bleScanResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">scanFailedEvent</span><span class="token punctuation">(</span><span class="token keyword">int</span> resultCode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>scanCallback <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                scanCallback<span class="token punctuation">.</span><span class="token function">onScanFailed</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>resultCode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">groupScanResultsEvent</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BleScanResult</span><span class="token punctuation">&gt;</span></span> scanResults<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 对扫描结果进行处理</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>scanCallback <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                scanCallback<span class="token punctuation">.</span><span class="token function">onGroupScanResultsEvent</span><span class="token punctuation">(</span>scanResults<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 本地扫描失败处理
     * @param failed 错误信息
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">localScanFailed</span><span class="token punctuation">(</span><span class="token class-name">String</span> failed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>scanCallback <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            scanCallback<span class="token punctuation">.</span><span class="token function">onScanFailed</span><span class="token punctuation">(</span>failed<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  这里面采用单例模式，在初始化之后直接调用，然后再实现扫描回调接口，返回扫描信息，有开始、停止扫描和是否正在扫描方法。这个类你可以直接用，也可以再封装到BleCore中，这里我们封装到BleCore中，修改BleCore中的代码，如下所示：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BleCore</span>  <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token class-name">BleCore</span> mInstance<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BleScan</span> bleScan<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">BleCore</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//蓝牙扫描</span>
        bleScan <span class="token operator">=</span> <span class="token class-name">BleScan</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">BleCore</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mInstance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">BleCore</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mInstance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    mInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BleCore</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> mInstance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPhyScanCallback</span><span class="token punctuation">(</span><span class="token class-name">ScanCallback</span> scanCallback<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        bleScan<span class="token punctuation">.</span><span class="token function">setScanCallback</span><span class="token punctuation">(</span>scanCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isScanning</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> bleScan<span class="token punctuation">.</span><span class="token function">isScanning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startScan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        bleScan<span class="token punctuation">.</span><span class="token function">startScan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">stopScan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        bleScan<span class="token punctuation">.</span><span class="token function">stopScan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_512"></a>四、业务处理</h3> 
<p>  这里的业务处理主要是两个，第一个是蓝牙开关监听，第二个动态权限申请。</p> 
<p>再进行业务处理之前，我们先修改一下MyApplication类的名字，修改为BleApp，修改后再改动里面的代码，如下所示：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BleApp</span> <span class="token keyword">extends</span> <span class="token class-name">AbilityPackage</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">BleCore</span> bleCore<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onInitialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onInitialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        bleCore <span class="token operator">=</span> <span class="token class-name">BleCore</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">BleCore</span> <span class="token function">getBleCore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> bleCore<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_Slice_535"></a>① Slice的生命周期</h4> 
<p>  首先我们来看一下Slice的生命周期，这个就比较重要，下面我们首先在<code>com.llw.ble</code>下创建一个<code>utils</code>包，<code>utils</code>包下创建一个LogUtils类，代码如下所示：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LogUtils</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">HiLogLabel</span> <span class="token constant">LABEL</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HiLogLabel</span><span class="token punctuation">(</span><span class="token class-name">HiLog</span><span class="token punctuation">.</span><span class="token constant">LOG_APP</span><span class="token punctuation">,</span> <span class="token number">0x00201</span><span class="token punctuation">,</span> <span class="token string">"HarmonyBle"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">HiLogLabel</span> logLabel<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setLogLabel</span><span class="token punctuation">(</span><span class="token class-name">HiLogLabel</span> logLabel<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">LogUtils</span><span class="token punctuation">.</span>logLabel <span class="token operator">=</span> logLabel<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token class-name">Log</span><span class="token punctuation">(</span><span class="token class-name">String</span> content<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">HiLog</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token constant">LABEL</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token class-name">LogI</span><span class="token punctuation">(</span><span class="token class-name">String</span> <span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token class-name">String</span> content<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">HiLogLabel</span> label <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HiLogLabel</span><span class="token punctuation">(</span><span class="token class-name">HiLog</span><span class="token punctuation">.</span><span class="token constant">LOG_APP</span><span class="token punctuation">,</span> <span class="token number">0x00201</span><span class="token punctuation">,</span> <span class="token constant">TAG</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HiLog</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>label<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token class-name">LogD</span><span class="token punctuation">(</span><span class="token class-name">String</span> <span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token class-name">String</span> content<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">HiLogLabel</span> label <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HiLogLabel</span><span class="token punctuation">(</span><span class="token class-name">HiLog</span><span class="token punctuation">.</span><span class="token constant">LOG_APP</span><span class="token punctuation">,</span> <span class="token number">0x00201</span><span class="token punctuation">,</span> <span class="token constant">TAG</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HiLog</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>label<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token class-name">LogE</span><span class="token punctuation">(</span><span class="token class-name">String</span> <span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token class-name">String</span> content<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">HiLogLabel</span> label <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HiLogLabel</span><span class="token punctuation">(</span><span class="token class-name">HiLog</span><span class="token punctuation">.</span><span class="token constant">LOG_APP</span><span class="token punctuation">,</span> <span class="token number">0x00201</span><span class="token punctuation">,</span> <span class="token constant">TAG</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HiLog</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>label<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token class-name">LogW</span><span class="token punctuation">(</span><span class="token class-name">String</span> <span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token class-name">String</span> content<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">HiLogLabel</span> label <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HiLogLabel</span><span class="token punctuation">(</span><span class="token class-name">HiLog</span><span class="token punctuation">.</span><span class="token constant">LOG_APP</span><span class="token punctuation">,</span> <span class="token number">0x00201</span><span class="token punctuation">,</span> <span class="token constant">TAG</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HiLog</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>label<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>  这是因为Harmony中打印日志比较麻烦，所以写一个工具类，封装一下，下面我们修改一下<code>ScanSlice</code>类中的代码，如下所示：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ScanSlice</span> <span class="token keyword">extends</span> <span class="token class-name">AbilitySlice</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TAG</span> <span class="token operator">=</span> <span class="token class-name">ScanSlice</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onStart</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onStart</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setUIContent</span><span class="token punctuation">(</span><span class="token class-name">ResourceTable<span class="token punctuation">.</span>Layout_slice_scan</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LogUtils<span class="token punctuation">.</span>LogD</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"onStart"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">LogUtils<span class="token punctuation">.</span>LogD</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"onActive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onInactive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">LogUtils<span class="token punctuation">.</span>LogD</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"onInactive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onForeground</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">LogUtils<span class="token punctuation">.</span>LogD</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"onForeground"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onBackground</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">LogUtils<span class="token punctuation">.</span>LogD</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"onBackground"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">LogUtils<span class="token punctuation">.</span>LogD</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"onStop"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>然后我们运行一下看看，检查控制台日志：</p> 
<p><img src="https://images2.imgbox.com/4f/5e/rIPcT7KQ_o.png" alt="在这里插入图片描述"></p> 
<p>然后我们通过Home键回到桌面，看看日志：</p> 
<p><img src="https://images2.imgbox.com/12/f1/iWlX875A_o.png" alt="在这里插入图片描述"></p> 
<p>然后我们点击桌面上的图标回到应用中，看看日志：</p> 
<p><img src="https://images2.imgbox.com/3e/d6/sp3ugZ4A_o.png" alt="在这里插入图片描述"></p> 
<p>再回到桌面，然后我们通过后台的运行程序进入应用，看看日志：</p> 
<p><img src="https://images2.imgbox.com/71/24/AYogeG0B_o.png" alt="在这里插入图片描述"><br> 这两种回到应用的方式日志一样，然后我们按返回键回到桌面，看看日志：</p> 
<p><img src="https://images2.imgbox.com/6d/20/Cezv6JWY_o.png" alt="在这里插入图片描述"><br> 那么现在你对于Slice的生命周期就比较了解了，下面我们进行代码的编写。</p> 
<h4><a id="__639"></a>② 蓝牙开关和动态权限请求</h4> 
<p>  首先处理蓝牙相关的，在<code>BleCore</code>中添加如下代码：</p> 
<pre><code class="prism language-java">	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BluetoothHost</span> mBluetoothHost<span class="token punctuation">;</span>
</code></pre> 
<p>在构造方法中实例化</p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token class-name">BleCore</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// 获取蓝牙本机管理对象</span>
        mBluetoothHost <span class="token operator">=</span> <span class="token class-name">BluetoothHost</span><span class="token punctuation">.</span><span class="token function">getDefaultHost</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>然后我们再写两个方法：</p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isEnableBt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> mBluetoothHost<span class="token punctuation">.</span><span class="token function">getBtState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">BluetoothHost</span><span class="token punctuation">.</span><span class="token constant">STATE_ON</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">enableBt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mBluetoothHost<span class="token punctuation">.</span><span class="token function">enableBt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>  用于判断是否打开蓝牙和打开蓝牙，回到<code>ScanSlice</code>中我们需要使用<code>BleCore</code>来处理蓝牙相关的工作，代码如下所示：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ScanSlice</span> <span class="token keyword">extends</span> <span class="token class-name">AbilitySlice</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TAG</span> <span class="token operator">=</span> <span class="token class-name">ScanSlice</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">BleCore</span> bleCore<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Text</span> txScanStatus<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">ListContainer</span> lcDevice<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onStart</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onStart</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setUIContent</span><span class="token punctuation">(</span><span class="token class-name">ResourceTable<span class="token punctuation">.</span>Layout_slice_scan</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        bleCore <span class="token operator">=</span> <span class="token class-name">BleApp</span><span class="token punctuation">.</span><span class="token function">getBleCore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        txScanStatus <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Text</span><span class="token punctuation">)</span> <span class="token function">findComponentById</span><span class="token punctuation">(</span><span class="token class-name">ResourceTable<span class="token punctuation">.</span>Id_tx_scan_status</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        lcDevice <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ListContainer</span><span class="token punctuation">)</span> <span class="token function">findComponentById</span><span class="token punctuation">(</span><span class="token class-name">ResourceTable<span class="token punctuation">.</span>Id_lc_device</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//点击监听</span>
        txScanStatus<span class="token punctuation">.</span><span class="token function">setClickedListener</span><span class="token punctuation">(</span>component <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 判断是否打开蓝牙</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bleCore<span class="token punctuation">.</span><span class="token function">isEnableBt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//打开蓝牙</span>
            bleCore<span class="token punctuation">.</span><span class="token function">enableBt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  首先在<code>onStart()</code>中对BleCore进行实例化，<code>findComponentById</code>就如同<code>findViewById</code>，然后在<code>onActive()</code>中调用刚才我们所写的方法。</p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 判断是否打开蓝牙</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bleCore<span class="token punctuation">.</span><span class="token function">isEnableBt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//打开蓝牙</span>
            bleCore<span class="token punctuation">.</span><span class="token function">enableBt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>然后是定位权限的处理，同样在onActive()中，增加代码如下所示：</p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 判断是否打开蓝牙</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// 是否获取定位权限</span>
        <span class="token class-name">String</span> locationPermission <span class="token operator">=</span> <span class="token string">"ohos.permission.LOCATION"</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">verifySelfPermission</span><span class="token punctuation">(</span>locationPermission<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">IBundleManager</span><span class="token punctuation">.</span><span class="token constant">PERMISSION_GRANTED</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">requestPermissionsFromUser</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span>locationPermission<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>这里首先我们定义一个权限，然后判断是否授予，没有授予则进行请求，下面运行一下看看：</p> 
<p><img src="https://images2.imgbox.com/43/62/NcFu3UyK_o.gif" alt="在这里插入图片描述"></p> 
<p>  那么我们就完成了蓝牙打开和定位权限动态申请，你可以在运行一次，你会发现，你还需要请求权限的，因为DS默认安装时不会保留应用的数据，而蓝牙打开了属于系统层面的，所以你可以不用再打开蓝牙，而需要重新请求定位权限，为了避免这一点，我们点击<code>Run→ Edit Configurations...</code></p> 
<p><img src="https://images2.imgbox.com/97/8d/VP9MBHyU_o.png" alt="在这里插入图片描述"></p> 
<p>在弹出的窗口上勾选<code>Keep Application Data</code></p> 
<p><img src="https://images2.imgbox.com/27/6b/p6TCRuqX_o.png" alt="在这里插入图片描述"></p> 
<p>点击OK，再运行即可。</p> 
<h3><a id="_754"></a>五、扫描设备</h3> 
<p>  接下来我们进行扫描的处理，在ScanSlice中增加如下方法代码：</p> 
<pre><code class="prism language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startScan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        bleCore<span class="token punctuation">.</span><span class="token function">startScan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        txScanStatus<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"停止"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">stopScan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        bleCore<span class="token punctuation">.</span><span class="token function">stopScan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        txScanStatus<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"搜索"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>  这里就是扫描和停止方法，同时修改一下Text文本，在<code>onStart()</code>中首先实现扫描回调监听，然后处理再处理<code>txScanStatus</code>文本的点击事件，代码如下所示：</p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onStart</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        bleCore<span class="token punctuation">.</span><span class="token function">setPhyScanCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//点击监听</span>
        txScanStatus<span class="token punctuation">.</span><span class="token function">setClickedListener</span><span class="token punctuation">(</span>component <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bleCore<span class="token punctuation">.</span><span class="token function">isScanning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">stopScan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//扫描开关停止扫描</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">startScan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//开始扫描</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>这里<code>this</code>会报错，鼠标放在上面，Alt + Enter，出现弹窗。</p> 
<p><img src="https://images2.imgbox.com/c6/4e/emtohFSb_o.png" alt="在这里插入图片描述"></p> 
<p>选择最后一个，就会给你实现<code>ScanCallback</code>中的<code>onScanResult()</code>方法，代码如下所示：</p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onScanResult</span><span class="token punctuation">(</span><span class="token class-name">BleScanResult</span> result<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">LogUtils<span class="token punctuation">.</span>LogD</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">getPeripheralDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeviceAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>我们在里面打印一下扫描到的设备Mac地址，最后我们在<code>onActive()</code>中增加如下所示代码：</p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// 是否在扫描中</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bleCore<span class="token punctuation">.</span><span class="token function">isScanning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">startScan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>下面运行一下，看看控制台日志：</p> 
<p><img src="https://images2.imgbox.com/b3/5e/qZamkcLf_o.png" alt="在这里插入图片描述"></p> 
<p>扫描出来了，只不过目前还看不到，所以我们要渲染一下，让它可以看到。</p> 
<h3><a id="_822"></a>六、显示设备</h3> 
<p>要显示设备，首先我们需要写一个Bean。</p> 
<h4><a id="__828"></a>① 自定义蓝牙类</h4> 
<p>在core包下新建一个BleDevice类，里面的代码如下所示：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BleDevice</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> realName <span class="token operator">=</span> <span class="token string">"Unknown device"</span><span class="token punctuation">;</span> <span class="token comment">//蓝牙设备真实名称</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> macAddress<span class="token punctuation">;</span>                  <span class="token comment">//地址</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> rssi<span class="token punctuation">;</span>                           <span class="token comment">//信号强度</span>
    <span class="token keyword">private</span> <span class="token class-name">BlePeripheralDevice</span> device<span class="token punctuation">;</span>         <span class="token comment">//设备</span>

    <span class="token keyword">public</span> <span class="token class-name">BleDevice</span><span class="token punctuation">(</span><span class="token class-name">BleScanResult</span> scanResult<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>device <span class="token operator">=</span> scanResult<span class="token punctuation">.</span><span class="token function">getPeripheralDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>macAddress <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">getDeviceAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> name <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">getDeviceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>name<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>realName <span class="token operator">=</span> name<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rssi <span class="token operator">=</span> scanResult<span class="token punctuation">.</span><span class="token function">getRssi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getRealName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> realName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setRealName</span><span class="token punctuation">(</span><span class="token class-name">String</span> realName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>realName <span class="token operator">=</span> realName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getMacAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> macAddress<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMacAddress</span><span class="token punctuation">(</span><span class="token class-name">String</span> macAddress<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>macAddress <span class="token operator">=</span> macAddress<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getRssi</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> rssi<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setRssi</span><span class="token punctuation">(</span><span class="token keyword">int</span> rssi<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rssi <span class="token operator">=</span> rssi<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">BlePeripheralDevice</span> <span class="token function">getDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> device<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setDevice</span><span class="token punctuation">(</span><span class="token class-name">BlePeripheralDevice</span> device<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>device <span class="token operator">=</span> device<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  这个Bean没有什么好说的，下面要做的就是列表Item的渲染，在Android中我们使用的是适配器<code>Adapter</code>，而在Harmony中使用的是提供者<code>Provider</code>。</p> 
<h4><a id="__885"></a>② 提供者</h4> 
<p>同样我们先写布局，在layout下新建一个<code>item_scan_device.xml</code>，代码如下所示：</p> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DirectionalLayout</span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>ohos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.huawei.com/res/ohos<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">ohos:</span>height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_content<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">ohos:</span>width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">ohos:</span>alignment</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>vertical_center<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">ohos:</span>background_element</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#FFF<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">ohos:</span>bottom_padding</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8vp<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">ohos:</span>orientation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>horizontal<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">ohos:</span>right_padding</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>16vp<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">ohos:</span>top_margin</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1vp<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">ohos:</span>top_padding</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8vp<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Image</span>
        <span class="token attr-name"><span class="token namespace">ohos:</span>height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_content<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">ohos:</span>width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_content<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">ohos:</span>end_margin</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>16vp<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">ohos:</span>image_src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$graphic:ic_bluetooth<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">ohos:</span>start_margin</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>16vp<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DirectionalLayout</span>
        <span class="token attr-name"><span class="token namespace">ohos:</span>height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_content<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">ohos:</span>width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_content<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">ohos:</span>orientation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>vertical<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">ohos:</span>weight</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Text</span>
            <span class="token attr-name"><span class="token namespace">ohos:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$+id:device_name<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">ohos:</span>height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_content<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">ohos:</span>width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_content<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">ohos:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>设备名称<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">ohos:</span>text_size</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>16fp<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Text</span>
            <span class="token attr-name"><span class="token namespace">ohos:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$+id:device_address<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">ohos:</span>height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_content<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">ohos:</span>width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_content<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">ohos:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>设备地址<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">ohos:</span>text_color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$color:gray<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">ohos:</span>text_size</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>14fp<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">ohos:</span>top_margin</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>4vp<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>DirectionalLayout</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Text</span>
        <span class="token attr-name"><span class="token namespace">ohos:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$+id:rssi<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">ohos:</span>height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_content<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">ohos:</span>width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_content<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">ohos:</span>align_parent_end</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">ohos:</span>text_color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#000000<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">ohos:</span>text_size</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>10fp<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>DirectionalLayout</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>  几个主要内容，设备名称、Mac地址、Rssi信号强度，然后这里有一个图标，在<code>graphic</code>下创建一个<code>ic_bluetooth.xml</code>，代码如下所示：</p> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>vector</span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>ohos</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.huawei.com/res/ohos<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">ohos:</span>height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>48vp<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">ohos:</span>width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>48vp<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">ohos:</span>viewportHeight</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1024<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">ohos:</span>viewportWidth</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1024<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>path</span>
        <span class="token attr-name"><span class="token namespace">ohos:</span>fillColor</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#A7D3FF<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">ohos:</span>pathData</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>M53.31,512a458.69,458.69 0,1 1,917.38 0A458.69,458.69 0,0 1,53.31 512zM584.96,301.82a356.16,356.16 0,0 0,-39.81 -26.69c-12.1,-6.34 -32,-13.89 -52.74,-3.01 -20.48,10.82 -25.86,31.23 -27.78,44.67 -1.92,13.18 -1.92,30.21 -1.92,48.45v77.18l-57.92,-49.6a32,32 0,0 0,-41.6 48.64L445.44,512 363.2,582.4a32,32 0,1 0,41.6 48.64l57.92,-49.6v77.18c0,18.24 0,35.33 1.92,48.51 1.92,13.44 7.23,33.86 27.78,44.61 20.74,10.88 40.64,3.33 52.74,-2.94a356.48,356.48 0,0 0,39.81 -26.69l39.42,-28.8c10.62,-7.74 21.31,-15.55 29.06,-23.1 8.64,-8.58 18.56,-21.57 18.56,-40.06 0,-18.56 -9.92,-31.55 -18.56,-40.06 -7.68,-7.55 -18.43,-15.36 -29.06,-23.17L548.99,512l75.39,-54.98c10.62,-7.74 21.31,-15.55 29.06,-23.17 8.64,-8.51 18.56,-21.5 18.56,-40 0,-18.56 -9.92,-31.55 -18.56,-40.06 -7.68,-7.62 -18.43,-15.36 -29.06,-23.17l-39.42,-28.8zM526.72,367.36v64.77c0,7.36 0,11.01 2.37,12.16 2.3,1.28 5.25,-0.9 11.2,-5.25l44.8,-32.7 8.32,-6.08c3.97,-2.94 5.95,-4.42 5.95,-6.53 0,-2.18 -1.98,-3.65 -5.95,-6.53l-8.32,-6.14 -36.1,-26.3a3344.06,3344.06 0,0 0,-9.34 -6.78c-5.44,-3.97 -8.19,-5.95 -10.5,-4.8 -2.37,1.15 -2.37,4.54 -2.37,11.33v12.86zM526.72,656.45L526.72,591.74c0,-7.36 0,-11.01 2.37,-12.16 2.3,-1.22 5.25,0.96 11.2,5.25l44.8,32.7 8.32,6.14c3.97,2.88 5.95,4.35 5.95,6.53 0,2.11 -1.98,3.58 -5.95,6.53l-8.32,6.08 -36.1,26.37 -9.34,6.78c-5.44,3.97 -8.19,5.95 -10.5,4.74 -2.37,-1.15 -2.37,-4.48 -2.37,-11.33v-12.8z<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>path</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>vector</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>  下面我们写提供者，在com.llw.ble下创建一个provider包，包下创建一个ScanDeviceProvider类，代码如下所示：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ScanDeviceProvider</span> <span class="token keyword">extends</span> <span class="token class-name">BaseItemProvider</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BleDevice</span><span class="token punctuation">&gt;</span></span> deviceList<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AbilitySlice</span> slice<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ScanDeviceProvider</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BleDevice</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">,</span> <span class="token class-name">AbilitySlice</span> slice<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>deviceList <span class="token operator">=</span> list<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>slice <span class="token operator">=</span> slice<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> deviceList <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> deviceList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getItem</span><span class="token punctuation">(</span><span class="token keyword">int</span> position<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>deviceList <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> position <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> position <span class="token operator">&lt;</span> deviceList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> deviceList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getItemId</span><span class="token punctuation">(</span><span class="token keyword">int</span> position<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> position<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Component</span> <span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token keyword">int</span> position<span class="token punctuation">,</span> <span class="token class-name">Component</span> component<span class="token punctuation">,</span> <span class="token class-name">ComponentContainer</span> componentContainer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token class-name">Component</span> cpt<span class="token punctuation">;</span>
        <span class="token class-name">ScanDeviceHolder</span> holder<span class="token punctuation">;</span>

        <span class="token class-name">BleDevice</span> device <span class="token operator">=</span> deviceList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>component <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            cpt <span class="token operator">=</span> <span class="token class-name">LayoutScatter</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>slice<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">ResourceTable<span class="token punctuation">.</span>Layout_item_scan_device</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            holder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScanDeviceHolder</span><span class="token punctuation">(</span>cpt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//将获取到的子组件信息绑定到列表项的实例中</span>
            cpt<span class="token punctuation">.</span><span class="token function">setTag</span><span class="token punctuation">(</span>holder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            cpt <span class="token operator">=</span> component<span class="token punctuation">;</span>
            <span class="token comment">// 从缓存中获取到列表项实例后，直接使用绑定的子组件信息进行数据填充。</span>
            holder <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ScanDeviceHolder</span><span class="token punctuation">)</span> cpt<span class="token punctuation">.</span><span class="token function">getTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        holder<span class="token punctuation">.</span>deviceName<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>device<span class="token punctuation">.</span><span class="token function">getRealName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        holder<span class="token punctuation">.</span>deviceAddress<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>device<span class="token punctuation">.</span><span class="token function">getMacAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        holder<span class="token punctuation">.</span>rssi<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">Locale</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"%d dBm"</span><span class="token punctuation">,</span> device<span class="token punctuation">.</span><span class="token function">getRssi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> cpt<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 用于保存列表项的子组件信息
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ScanDeviceHolder</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Text</span> deviceName<span class="token punctuation">;</span>
        <span class="token class-name">Text</span> deviceAddress<span class="token punctuation">;</span>
        <span class="token class-name">Text</span> rssi<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token class-name">ScanDeviceHolder</span><span class="token punctuation">(</span><span class="token class-name">Component</span> component<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            deviceName <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Text</span><span class="token punctuation">)</span> component<span class="token punctuation">.</span><span class="token function">findComponentById</span><span class="token punctuation">(</span><span class="token class-name">ResourceTable<span class="token punctuation">.</span>Id_device_name</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            deviceAddress <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Text</span><span class="token punctuation">)</span> component<span class="token punctuation">.</span><span class="token function">findComponentById</span><span class="token punctuation">(</span><span class="token class-name">ResourceTable<span class="token punctuation">.</span>Id_device_address</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            rssi <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Text</span><span class="token punctuation">)</span> component<span class="token punctuation">.</span><span class="token function">findComponentById</span><span class="token punctuation">(</span><span class="token class-name">ResourceTable<span class="token punctuation">.</span>Id_rssi</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  通过提供者的代码，可以看到它和适配器的写法差不多，不同的是你得注意<code>getComponent()</code>方法中的处理，另外提供者默认提供了Item的点击方法，所以我们不用再自己去写了。</p> 
<h4><a id="__1035"></a>③ 显示设备</h4> 
<p>  我们回到ScanSlice中使用，首先我们创建几个变量，代码如下所示：</p> 
<pre><code class="prism language-java">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BleDevice</span><span class="token punctuation">&gt;</span></span> mList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">ScanDeviceProvider</span> provider<span class="token punctuation">;</span>
</code></pre> 
<p>然后在onStart()方法中进行初始化：</p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onStart</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        provider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScanDeviceProvider</span><span class="token punctuation">(</span>mList<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        lcDevice<span class="token punctuation">.</span><span class="token function">setItemProvider</span><span class="token punctuation">(</span>provider<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//列表item点击监听</span>
        lcDevice<span class="token punctuation">.</span><span class="token function">setItemClickedListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span>listContainer<span class="token punctuation">,</span> component<span class="token punctuation">,</span> position<span class="token punctuation">,</span> id<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>

        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>这里设置了列表提供者，然后添加item点击监听，最后我们在扫描回调中渲染数据，修改代码如下所示：</p> 
<pre><code class="prism language-java">
    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token class-name">BleDevice</span> bleDevice<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BleDevice</span><span class="token punctuation">&gt;</span></span> deviceList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">BleDevice</span> devi <span class="token operator">:</span> deviceList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bleDevice<span class="token punctuation">.</span><span class="token function">getMacAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>devi<span class="token punctuation">.</span><span class="token function">getDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeviceAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> index<span class="token punctuation">;</span>
            index <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onScanResult</span><span class="token punctuation">(</span><span class="token class-name">BleScanResult</span> result<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">BleDevice</span> bleDevice <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BleDevice</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token function">findIndex</span><span class="token punctuation">(</span>bleDevice<span class="token punctuation">,</span> mList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//添加新设备</span>
            mList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>bleDevice<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//更新已有设备的rssi和时间戳</span>
            mList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setRssi</span><span class="token punctuation">(</span>bleDevice<span class="token punctuation">.</span><span class="token function">getRssi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">getUITaskDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">syncDispatch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> provider<span class="token punctuation">.</span><span class="token function">notifyDataChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>这里添加一个<code>findIndex()</code>方法，用于添加设备和更新设备，最终通过UI线程同步刷新提供者，再修改一个开始扫描和停止扫描的方法代码：</p> 
<pre><code class="prism language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startScan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mList<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        provider<span class="token punctuation">.</span><span class="token function">notifyDataChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bleCore<span class="token punctuation">.</span><span class="token function">startScan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        txScanStatus<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"停止"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LogUtils<span class="token punctuation">.</span>LogD</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span><span class="token string">"开始扫描设备！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">stopScan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        bleCore<span class="token punctuation">.</span><span class="token function">stopScan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        txScanStatus<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"搜索"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LogUtils<span class="token punctuation">.</span>LogD</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span><span class="token string">"已经停止扫描设备！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>运行一下看看：</p> 
<p><img src="https://images2.imgbox.com/b6/11/CBs7jzA5_o.gif" alt="在这里插入图片描述"></p> 
<h3><a id="_1113"></a>七、源码</h3> 
<p>如果对你有所帮助的话，不妨 Star 或 Fork，山高水长，后会有期~</p> 
<p>源码地址：<a href="https://github.com/lilongweidev/HarmonyBle-Java">HarmonyBle-Java</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/77aec34c20b0a01bc139fa5fa1e79679/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">服务器SSH（免密登录）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b69aa879aa08210d0f7d5808938e54ea/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">MATLAB 嵌套switch语句||MATLAB while循环</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>