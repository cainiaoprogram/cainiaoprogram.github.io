<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>自动化运维工具--saltstack部署及使用 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="自动化运维工具--saltstack部署及使用" />
<meta property="og:description" content="目录
一、saltstack简介
1、介绍
2、Salt的核心功能
3、saltstack通信机制
二、saltstack部署
1、部署环境
2、配置yum源
3、安装master与minion
4、连接认证master和minion
三、salt运行
1、执行格式
2、实操演示
一、saltstack简介 1、介绍 saltstack是一个配置管理系统(客户端和服务端)，能够维护预定义状态的远程节点。
saltstack是一个分布式远程执行系统，用来在远程节点上执行命令和查询数据。
saltstack是运维人员提高工作效率、规范业务配置与操作的利器。
2、Salt的核心功能 ①使命令发送到远程系统是并行的而不是串行的
②使用安全加密的协议
③使用最小最快的网络载荷
④提供简单的编程接口
Salt同样引入了更加细致化的领域控制系统来远程执行，使得系统成为目标不止可以通过主机名，还可以通过系统属性。
3、saltstack通信机制 SaltStack 采用 C/S模式，minion与master之间通过ZeroMQ消息队列通信，默认监听4505端口。
Salt Master运行的第二个网络服务就是ZeroMQ REP系统，默认监听4506端口。
二、saltstack部署 1、部署环境 主机名IP地址服务PC1192.168.30.11salt-masterPC2192.168.3.12salt-minion 2、配置yum源 sudo rpm --import https://repo.saltproject.io/py3/redhat/7/x86_64/latest/SALTSTACK-GPG-KEY.pub curl -fsSL https://repo.saltproject.io/py3/redhat/7/x86_64/latest.repo | sudo tee /etc/yum.repos.d/salt.repo 3、安装master与minion PC1执行: yum install -y salt-master	#安装master端 systemctl enable --now salt-master	#开机自启并启动master服务 PC2执行: yum install -y salt-minion #安装minion端 systemctl enable --now salt-minion.service #开机自启并启动minion服务 4、连接认证master和minion 认证原理：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/e5b911b7739b523f9debba575e6d3b42/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-25T10:35:56+08:00" />
<meta property="article:modified_time" content="2023-07-25T10:35:56+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">自动化运维工具--saltstack部署及使用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="-toc" style="margin-left:40px;"></p> 
<p id="%E4%B8%80%E3%80%81saltstack%E7%AE%80%E4%BB%8B-toc" style="margin-left:40px;"><a href="#%E4%B8%80%E3%80%81saltstack%E7%AE%80%E4%BB%8B" rel="nofollow">一、saltstack简介</a></p> 
<p id="1%E3%80%81%E4%BB%8B%E7%BB%8D-toc" style="margin-left:80px;"><a href="#1%E3%80%81%E4%BB%8B%E7%BB%8D" rel="nofollow">1、介绍</a></p> 
<p id="2%E3%80%81Salt%E7%9A%84%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD-toc" style="margin-left:80px;"><a href="#2%E3%80%81Salt%E7%9A%84%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD" rel="nofollow">2、Salt的核心功能</a></p> 
<p id="3%E3%80%81saltstack%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6-toc" style="margin-left:80px;"><a href="#3%E3%80%81saltstack%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6" rel="nofollow">3、saltstack通信机制</a></p> 
<p id="%E4%BA%8C%E3%80%81saltstack%E9%83%A8%E7%BD%B2-toc" style="margin-left:40px;"><a href="#%E4%BA%8C%E3%80%81saltstack%E9%83%A8%E7%BD%B2" rel="nofollow">二、saltstack部署</a></p> 
<p id="1%E3%80%81%E9%83%A8%E7%BD%B2%E7%8E%AF%E5%A2%83-toc" style="margin-left:80px;"><a href="#1%E3%80%81%E9%83%A8%E7%BD%B2%E7%8E%AF%E5%A2%83" rel="nofollow">1、部署环境</a></p> 
<p id="2%E3%80%81%E9%85%8D%E7%BD%AEyum%E6%BA%90-toc" style="margin-left:80px;"><a href="#2%E3%80%81%E9%85%8D%E7%BD%AEyum%E6%BA%90" rel="nofollow">2、配置yum源</a></p> 
<p id="3%E3%80%81%E5%AE%89%E8%A3%85master%E4%B8%8Eminion-toc" style="margin-left:80px;"><a href="#3%E3%80%81%E5%AE%89%E8%A3%85master%E4%B8%8Eminion" rel="nofollow">3、安装master与minion</a></p> 
<p id="4%E3%80%81%E8%BF%9E%E6%8E%A5%E8%AE%A4%E8%AF%81master%E5%92%8Cminion-toc" style="margin-left:80px;"><a href="#4%E3%80%81%E8%BF%9E%E6%8E%A5%E8%AE%A4%E8%AF%81master%E5%92%8Cminion" rel="nofollow">4、连接认证master和minion</a></p> 
<p id="%E4%B8%89%E3%80%81salt%E8%BF%90%E8%A1%8C-toc" style="margin-left:40px;"><a href="#%E4%B8%89%E3%80%81salt%E8%BF%90%E8%A1%8C" rel="nofollow">三、salt运行</a></p> 
<p id="1%E3%80%81%E6%89%A7%E8%A1%8C%E6%A0%BC%E5%BC%8F-toc" style="margin-left:80px;"><a href="#1%E3%80%81%E6%89%A7%E8%A1%8C%E6%A0%BC%E5%BC%8F" rel="nofollow">1、执行格式</a></p> 
<p id="2%E3%80%81%E5%AE%9E%E6%93%8D%E6%BC%94%E7%A4%BA-toc" style="margin-left:80px;"><a href="#2%E3%80%81%E5%AE%9E%E6%93%8D%E6%BC%94%E7%A4%BA" rel="nofollow">2、实操演示</a></p> 
<hr id="hr-toc"> 
<p></p> 
<h3 id="%E4%B8%80%E3%80%81saltstack%E7%AE%80%E4%BB%8B">一、saltstack简介</h3> 
<h4 id="1%E3%80%81%E4%BB%8B%E7%BB%8D">1、介绍</h4> 
<p><br> saltstack是一个配置管理系统(客户端和服务端)，能够维护预定义状态的远程节点。<br> saltstack是一个分布式远程执行系统，用来在远程节点上执行命令和查询数据。<br> saltstack是运维人员提高工作效率、规范业务配置与操作的利器。</p> 
<h4 id="2%E3%80%81Salt%E7%9A%84%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD"><br> 2、Salt的核心功能</h4> 
<p><br> ①使命令发送到远程系统是并行的而不是串行的<br> ②使用安全加密的协议<br> ③使用最小最快的网络载荷<br> ④提供简单的编程接口<br> Salt同样引入了更加细致化的领域控制系统来远程执行，使得系统成为目标不止可以通过主机名，还可以通过系统属性。</p> 
<h4 id="3%E3%80%81saltstack%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6"><br> 3、saltstack通信机制</h4> 
<p><br> SaltStack 采用 C/S模式，minion与master之间通过ZeroMQ消息队列通信，默认监听4505端口。<br> Salt Master运行的第二个网络服务就是ZeroMQ REP系统，默认监听4506端口。</p> 
<h3 id="%E4%BA%8C%E3%80%81saltstack%E9%83%A8%E7%BD%B2">二、saltstack部署</h3> 
<h4 id="1%E3%80%81%E9%83%A8%E7%BD%B2%E7%8E%AF%E5%A2%83">1、部署环境</h4> 
<table cellspacing="0" style="width:195.63pt;"><tbody><tr><td style="background-color:#4f81bd;vertical-align:middle;width:43.2pt;"><span style="color:#ffffff;"><strong>主机名</strong></span></td><td style="background-color:#4f81bd;vertical-align:middle;width:82.2pt;"><span style="color:#ffffff;"><strong>IP地址</strong></span></td><td style="background-color:#4f81bd;vertical-align:middle;width:70.2pt;"><span style="color:#ffffff;"><strong>服务</strong></span></td></tr><tr><td style="vertical-align:middle;"><span style="color:#000000;">PC1</span></td><td style="vertical-align:middle;"><span style="color:#000000;">192.168.30.11</span></td><td style="vertical-align:middle;"><span style="color:#000000;">salt-master</span></td></tr><tr><td style="vertical-align:middle;"><span style="color:#000000;">PC2</span></td><td style="vertical-align:middle;"><span style="color:#000000;">192.168.3.12</span></td><td style="vertical-align:middle;"><span style="color:#000000;">salt-minion</span></td></tr></tbody></table> 
<h4 id="2%E3%80%81%E9%85%8D%E7%BD%AEyum%E6%BA%90">2、配置yum源</h4> 
<pre><code>sudo rpm --import https://repo.saltproject.io/py3/redhat/7/x86_64/latest/SALTSTACK-GPG-KEY.pub
curl -fsSL https://repo.saltproject.io/py3/redhat/7/x86_64/latest.repo | sudo tee /etc/yum.repos.d/salt.repo</code></pre> 
<h4 id="3%E3%80%81%E5%AE%89%E8%A3%85master%E4%B8%8Eminion">3、安装<span style="color:#000000;">master与minion</span></h4> 
<pre><code>PC1执行:
yum install -y salt-master	    
#安装master端
systemctl enable  --now  salt-master	
#开机自启并启动master服务
PC2执行:
yum install -y salt-minion
#安装minion端
systemctl enable --now salt-minion.service  
#开机自启并启动minion服务</code></pre> 
<h4 id="4%E3%80%81%E8%BF%9E%E6%8E%A5%E8%AE%A4%E8%AF%81master%E5%92%8Cminion">4、连接认证master和minion</h4> 
<p>认证原理：<img alt="" height="333" src="https://images2.imgbox.com/eb/8a/JT6jIYfH_o.png" width="879"></p> 
<p>①minion在第一次启动时，会在/etc/salt/pki/minion/下自动生成一对密钥，然后将公钥发给master</p> 
<p>②master收到minion的公钥后，通过salt-key命令接受该公钥。此时master的/etc/salt/pki/master/minions目录将会存放以minion id命名的公钥，然后master就能对minion发送控制指令了</p> 
<pre><code>PC1执行:
lsof -i:4506
#查看4506端口端口状态如下，有监听但是无建立连接的。
COMMAND      PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
salt-mast 101552 root   43u  IPv4 162865      0t0  TCP *:4506 (LISTEN)
lsof -i:4505
#查看4505端口端口状态如下，有监听但是无建立连接的。
COMMAND      PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
salt-mast 101546 root   35u  IPv4 154229      0t0  TCP *:4505 (LISTEN)
PC2执行：
rpm -qc salt-minion
#查找minion配置文件位置
vim /etc/salt/minion
#打开配置文件修改第16行内容，去掉注释加上自己的master地址然后保存退出
.
.
master: 192.168.30.11
.
.
systemctl restart salt-minion.service
#重启minion服务使得配置生效
PC1执行：
lsof -i:4506
#查看4506端口状态如下，一个服务监听端口，一个master与pc2建立连接的端口。
COMMAND      PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
salt-mast 101552 root   43u  IPv4 162865      0t0  TCP *:4506 (LISTEN)
salt-mast 101552 root   51u  IPv4 219147      0t0  TCP pc1:4506-&gt;192.168.30.12:57896 (ESTABLISHED)
lsof -i:4505
#查看4505端口端口状态如下，minion还在等待master端执行命令允许minion连接。
COMMAND      PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
salt-mast 101546 root   35u  IPv4 154229      0t0  TCP *:4505 (LISTEN)</code></pre> 
<p><img alt="" height="752" src="https://images2.imgbox.com/67/c1/QR3h2exw_o.png" width="1200"></p> 
<p><img alt="" height="243" src="https://images2.imgbox.com/25/26/0ONcdyMH_o.png" width="1200"></p> 
<pre><code>PC1执行：
使用salt-key命令加参数，配置master允许minion连接
    -L                 列出所有公钥信息
    -a minion地址      接受指定minion等待认证的key
    -A                 接受所有minion等待认证的key
    -r minion地址      拒绝指定minion等待认证的key
    -R                 拒绝所有minion等待认证的key
    -f minion地址      显示指定key的指纹信息
    -F                 显示所有key的指纹信息
    -d minion地址      删除指定minion的key
    -D                 删除所有minion的key
    -y                 自动回答yes
#查看有哪些主机等待连接
salt-key -A
#允许所有主机连接，具体看下图1操作
lsof -i :4505
#查看客户端是否与master建立连接了，下图2
</code></pre> 
<p><img alt="" height="421" src="https://images2.imgbox.com/ea/cc/XMvLLoSW_o.png" width="1200"></p> 
<p><img alt="" height="150" src="https://images2.imgbox.com/f1/9b/VlxR29hz_o.png" width="1200"></p> 
<h3 id="%E4%B8%89%E3%80%81salt%E8%BF%90%E8%A1%8C">三、salt运行</h3> 
<h4 id="1%E3%80%81%E6%89%A7%E8%A1%8C%E6%A0%BC%E5%BC%8F">1、执行格式</h4> 
<pre><code>salt [options] '&lt;target&gt;' &lt;function&gt; [arguments]
#执行格式
target：指定哪些minion，默认的规则是使用glob匹配minion id        # salt '*' test.ping
targets也可以使用正则表达式        # salt -E 'server[1-3]' test.ping
targets也可以指定列表              # salt -L 'server2,server3' test.ping
funcation：module提供的功能,Salt内置了大量有效的functions
arguments：通过空格来界定参数
# 常用target参数
    -E       正则匹配
    -L       列表匹配 
    -S       CIDR匹配网段
    -G       grains匹配
    --grain-pcre     grains加正则匹配
    -N       组匹配
    -R       范围匹配
    -C       综合匹配（指定多个匹配）
    -I       pillar值匹配
# 常用的options
    --version             查看saltstack的版本号
    --versions-report     查看saltstack以及依赖包的版本号
    -h       查看帮助信息
    -c CONFIG_DIR         指定配置文件目录(默认为/etc/salt/)
    -t TIMEOUT            指定超时时间(默认是5s)
    --async     异步执行
    -v      verbose模式，详细显示执行过程
    --username=USERNAME      指定外部认证用户名
    --password=PASSWORD      指定外部认证密码
    --log-file=LOG_FILE      指定日志记录文件</code></pre> 
<h4 id="2%E3%80%81%E5%AE%9E%E6%93%8D%E6%BC%94%E7%A4%BA">2、实操演示</h4> 
<pre><code class="hljs">1、连通性测试
salt '*' test.ping
#测试所有minion与master的连通性
salt 'pc2' test.ping
##测试pc2主机minion与master的连通性
2、安装软件
salt 'node1' pkg.install httpd
3、卸载软件
salt 'node1' pkg.remove httpd
4、测试各种模块
salt '*' test.echo 'hello'
salt '*' network.ping baidu.com        
# 使用ping命令测试到某主机的连通性
salt '*' network.connect baidu.com 80  
# #测试minion至某一台服务器的网络是否连通
salt '*' network.get_hostname  
# 获取主机名
salt '*' network.active_tcp    
# 返回所有活动的tcp连接
salt '*' network.ip_addrs      
# 返回一个IPv4的地址列表
alt '*' network.get_fqdn       
# 查看主机的fqdn(完全限定域名)</code></pre> 
<p> </p> 
<p></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/325e1b31120712323a4af16f005c6787/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">C&#43;&#43; web server服务器 开发</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1ae06c9f20d7e75d8ab905170a0cdeb5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">ffmpeg最简单方式支持nvidia硬编解码</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>