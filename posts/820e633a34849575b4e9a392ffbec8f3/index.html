<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Qiling框架学习-Qilinglab - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Qiling框架学习-Qilinglab" />
<meta property="og:description" content="Qiling框架学习-Qilinglab 简介 Qiling框架是一个超轻量级的“沙盒”，适用于Linux、MacOS、Windows、FreeBSD、DOS、UEFI和MBR。它是建立在Unicorn引擎之上的二进制仿真框架，支持x86（16、32和64位）、ARM、ARM64和MIPS。麒麟框架也凭借Demigod支持Linux内核模块(.ko)，微软视窗驱动(.sys）和苹果MacOS内核(.kext)。
然而，麒麟框架不是旨于构建另一个“沙盒”工具，而是为逆向工程设计的框架。因此，二进制检测和API是麒麟框架的主要及优先关注点。使用麒麟框架可以节省时间。拥有丰富API的麒麟框架将逆向工程及二进制代码检测快速的提升到了一个新的层次。
此外，麒麟框架还提供了对寄存器、内存、文件系统、操作系统和调试器的API访问。麒麟框架也提供了虚拟机级别的API，如保存和恢复执行状态。
安装 使用pip安装 pip3 install qiling 使用 pip 安装最新的开发版本 pip3 install --user https://github.com/qilingframework/qiling/archive/dev.zip 从github克隆框架手动安装 git clone https://github.com/qilingframework/qiling cd qiling python3 setup.py install 另外不要忘记初始化 rootfs。
git submodule update --init --recursive qilinglab qilinglab是一个包含十几个小挑战的程序，用于快速上手Qiling框架的主要功能。
因为平时接触到的ARM架构相对来说比较多，我这里以arm架构作为学习的开始
首先使用file指令查看下载到的qilinglab程序
基本使用模板
from qiling import * def challenge1(ql: Qiling): pass if __name__ == &#39;__main__&#39;: path = [&#39;qilinglab-aarch64&#39;] # 可执行程序 rootfs = &#34;/qiling/examples/rootfs/arm64_linux&#34; # 机器文件系统的根 ql.verbose = 0 ql = Qiling(path, rootfs) ql.run() #如果需要其他共享库来模拟二进制文件，我们需要下载它们并将它们添加到我们的 rootfs 中 在ql." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/820e633a34849575b4e9a392ffbec8f3/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-01-13T14:21:17+08:00" />
<meta property="article:modified_time" content="2023-01-13T14:21:17+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Qiling框架学习-Qilinglab</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="QilingQilinglab_0"></a>Qiling框架学习-Qilinglab</h2> 
<h3><a id="_1"></a>简介</h3> 
<p>Qiling框架是一个超轻量级的“沙盒”，适用于Linux、MacOS、Windows、FreeBSD、DOS、UEFI和MBR。它是建立在Unicorn引擎之上的二进制仿真框架，支持x86（16、32和64位）、ARM、ARM64和MIPS。麒麟框架也凭借Demigod支持Linux内核模块(.ko)，微软视窗驱动(.sys）和苹果MacOS内核(.kext)。</p> 
<p>然而，麒麟框架不是旨于构建另一个“沙盒”工具，而是为逆向工程设计的框架。因此，二进制检测和API是麒麟框架的主要及优先关注点。使用麒麟框架可以节省时间。拥有丰富API的麒麟框架将逆向工程及二进制代码检测快速的提升到了一个新的层次。</p> 
<p>此外，麒麟框架还提供了对寄存器、内存、文件系统、操作系统和调试器的API访问。麒麟框架也提供了虚拟机级别的API，如保存和恢复执行状态。</p> 
<h3><a id="_8"></a>安装</h3> 
<h4><a id="pip_9"></a>使用pip安装</h4> 
<pre><code class="prism language-shell">pip3 <span class="token function">install</span> qiling

使用 pip 安装最新的开发版本

pip3 <span class="token function">install</span> <span class="token parameter variable">--user</span> https://github.com/qilingframework/qiling/archive/dev.zip
</code></pre> 
<h4><a id="github_18"></a>从github克隆框架手动安装</h4> 
<pre><code class="prism language-shell"><span class="token function">git</span> clone https://github.com/qilingframework/qiling

<span class="token builtin class-name">cd</span> qiling

python3 setup.py <span class="token function">install</span>
</code></pre> 
<p>另外不要忘记初始化 rootfs。</p> 
<pre><code class="prism language-shell"><span class="token function">git</span> submodule update <span class="token parameter variable">--init</span> <span class="token parameter variable">--recursive</span>
</code></pre> 
<h3><a id="qilinglab_35"></a>qilinglab</h3> 
<p>qilinglab是一个包含十几个小挑战的程序，用于快速上手Qiling框架的主要功能。<br> 因为平时接触到的ARM架构相对来说比较多，我这里以arm架构作为学习的开始</p> 
<p>首先使用file指令查看下载到的qilinglab程序<br> <img src="https://images2.imgbox.com/e3/7b/GPBemQk9_o.png" alt="在这里插入图片描述"></p> 
<p>基本使用模板</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> qiling <span class="token keyword">import</span> <span class="token operator">*</span>

<span class="token keyword">def</span> <span class="token function">challenge1</span><span class="token punctuation">(</span>ql<span class="token punctuation">:</span> Qiling<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>

<span class="token keyword">if</span> __name__  <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    path <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'qilinglab-aarch64'</span><span class="token punctuation">]</span> <span class="token comment"># 可执行程序</span>
    rootfs <span class="token operator">=</span> <span class="token string">"/qiling/examples/rootfs/arm64_linux"</span> <span class="token comment"># 机器文件系统的根</span>
    ql<span class="token punctuation">.</span>verbose <span class="token operator">=</span> <span class="token number">0</span>
    ql <span class="token operator">=</span> Qiling<span class="token punctuation">(</span>path<span class="token punctuation">,</span> rootfs<span class="token punctuation">)</span>
    ql<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#如果需要其他共享库来模拟二进制文件，我们需要下载它们并将它们添加到我们的 rootfs 中</span>
</code></pre> 
<p>在ql.run()前加一句ql.verbose = 0方便看输出内容<br> verbose = 0 为不在标准输出流输出日志信息 verbose = 1 为输出进度条记录</p> 
<p>执行二进制程序<br> <img src="https://images2.imgbox.com/d0/21/yKUXNSMl_o.png" alt="在这里插入图片描述"></p> 
<p>输出挑战列表，并提示Some challenges will results in segfaults and infinite loops if they aren’t solved</p> 
<p>同步放在IDA Pro里面查看<br> 因为本身lab是为了熟悉qiling框架，所以程序没有去除符号表和做混淆，很直观可以看到逆向后的程序逻辑</p> 
<p>main()–&gt;start()函数，主要是输出挑战内容，调用challange X函数和checker函数对结果进行校验<br> start()<br> <img src="https://images2.imgbox.com/8c/4a/CICfrjSS_o.png" alt="在这里插入图片描述"></p> 
<p>checker()<br> <img src="https://images2.imgbox.com/42/86/rdJS88I6_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="challange1_82"></a>challange1</h4> 
<p>题目要求：在0X1337地址处写入1337</p> 
<p><img src="https://images2.imgbox.com/45/1d/RluO9ZmB_o.png" alt="在这里插入图片描述"></p> 
<p>操作内存手册：https://docs.qiling.io/en/latest/memory/<br> 麒麟提供了几种管理模拟内存空间的方法：<br> <img src="https://images2.imgbox.com/50/6b/VraJOxqA_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-shell">写入内存地址
ql.mem.write<span class="token punctuation">(</span>address, data<span class="token punctuation">)</span>

映射内存区域
在写入内存之前映射内存。info可以为空。
ql.mem.map<span class="token punctuation">(</span>addr,size,info <span class="token operator">=</span> <span class="token punctuation">[</span>my_first_map<span class="token punctuation">]</span><span class="token punctuation">)</span>

地址：
你需要对齐内存偏移量和地址以进行映射。
addr//size*size -<span class="token operator">&gt;</span> 0x7fefc9e0//4096*4096

大小：
应映射的内存量

此参数取决于操作系统<span class="token punctuation">;</span>如果使用 linux 系统，请考虑至少使用 <span class="token number">4096</span> 的倍数进行对齐
</code></pre> 
<p>slove-challenge1</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">challenge1</span><span class="token punctuation">(</span>ql<span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    ql<span class="token punctuation">.</span>mem<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token number">0x1337</span><span class="token operator">//</span><span class="token number">4096</span><span class="token operator">*</span><span class="token number">4096</span><span class="token punctuation">,</span><span class="token number">0x1000</span><span class="token punctuation">,</span> info <span class="token operator">=</span> <span class="token string">"[challenge1]"</span><span class="token punctuation">)</span>
    ql<span class="token punctuation">.</span>mem<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token number">0x1337</span><span class="token punctuation">,</span> ql<span class="token punctuation">.</span>pack16<span class="token punctuation">(</span><span class="token number">1337</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># pack16(value) == struct.pack('H', value) </span>
    <span class="token comment">#struct.pack用于将Python的值根据格式符，转换为字符串，h表示short，l表示long</span>
</code></pre> 
<p>运行结束后可以通过kill命令手动结束程序运行<br> <img src="https://images2.imgbox.com/7d/08/Br4MrkJe_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="challange2_124"></a>challange2</h4> 
<p>题目要求：使uname系统调用返回正确的值</p> 
<p><img src="https://images2.imgbox.com/e7/6b/ishp5SmI_o.png" alt="在这里插入图片描述"></p> 
<p>uname系统调用返回有关底层操作系统的信息,传入一个utsname结构体buffer让它填充</p> 
<p>utsname结构体的相关信息参考<br> https://man7.org/linux/man-pages/man3/uname.3p.html<br> <img src="https://images2.imgbox.com/a8/d4/d8n1zcw8_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">utsname</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> sysname<span class="token punctuation">[</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> nodename<span class="token punctuation">[</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> release<span class="token punctuation">[</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> version<span class="token punctuation">[</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> machine<span class="token punctuation">[</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> domainname<span class="token punctuation">[</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>通过挑战条件为</p> 
<pre><code class="prism language-c">uname<span class="token punctuation">.</span>sysname <span class="token operator">==</span> <span class="token string">"QilingOS"</span><span class="token punctuation">;</span>
uname<span class="token punctuation">.</span>version <span class="token operator">==</span> <span class="token string">"ChallengeStart"</span><span class="token punctuation">;</span>
</code></pre> 
<p>需要通过qiling提供的系统调用uname，修改返回地uname结构体即可。<br> https://docs.qiling.io/en/latest/hijack/<br> <img src="https://images2.imgbox.com/43/c5/Ovp8Z4De_o.png" alt="在这里插入图片描述"></p> 
<p><strong>劫持 POSIX 系统调用</strong></p> 
<p>POSIX 系统调用可以hook以允许用户修改其参数、更改返回值或完全替换其功能。当指定的系统调用即将被调用时,系统调用可以通过其名称或号码挂钩，并在一个或多个阶段被拦截;<br> 进入系统调用前,可用于完全替换系统调用功能;<br> 退出系统调用后,可用于篡改系统调用参数值,可用于篡改返回值;<br> <strong>QL_INTERCEPT.CALL</strong>| <strong>QL_INTERCEPT.ENTER</strong> | <strong>QL_INTERCEPT.EXIT</strong></p> 
<p>slove-challenge2<br> <img src="https://images2.imgbox.com/ec/22/fihWcIep_o.png" alt="在这里插入图片描述"></p> 
<p>JOANSIVION大佬这里的方法是获取寄存器sp栈指针的地址，然后找到偏移量，就是结构体的指针地址，然后作为mem写入的起始地址<br> name的地址为 <strong>-0x1B0</strong><br> 然后0x1F0+name = <strong>0x1F0-0x1B0 = 0x40</strong></p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">hook_uname_on_exit</span><span class="token punctuation">(</span>ql<span class="token punctuation">,</span> pName<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#out_struct_addr = ql.arch.regs.sp + 0x40</span>
    <span class="token comment">#sysname_addr = out_struct_addr</span>
    <span class="token comment">#ql.mem.write(sysname_addr, b'QilingOS\x00')</span>
    <span class="token comment">#ql.mem.write(out_struct_addr + 65 * 3, b'ChallengeStart\x00')</span>
    <span class="token comment">#使用这种方法定义函数时为def hook_uname_on_exit(ql, *args):</span>
    ql<span class="token punctuation">.</span>mem<span class="token punctuation">.</span>write<span class="token punctuation">(</span>pName<span class="token punctuation">,</span> <span class="token string">b'QilingOS\x00'</span><span class="token punctuation">)</span>
    ql<span class="token punctuation">.</span>mem<span class="token punctuation">.</span>write<span class="token punctuation">(</span>pName <span class="token operator">+</span> <span class="token number">65</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">b'ChallengeStart\x00'</span><span class="token punctuation">)</span>
    <span class="token comment">#通过 os.set_syscall 加上 QL_INTERCEPT.EXIT 参数，在调用结束后劫持 uname 的返回值，替换成验证的字符串</span>
    
<span class="token keyword">def</span> <span class="token function">challenge2</span><span class="token punctuation">(</span>ql<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ql<span class="token punctuation">.</span>os<span class="token punctuation">.</span>set_syscall<span class="token punctuation">(</span><span class="token string">'uname'</span><span class="token punctuation">,</span> hook_uname_on_exit<span class="token punctuation">,</span> QL_INTERCEPT<span class="token punctuation">.</span>EXIT<span class="token punctuation">)</span>
    <span class="token comment">#系统调用可以通过其名称或号码来引用,通过引用其编号替换uname系统调用的等效替代</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/ea/28/CurOAQqg_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="challange3_197"></a>challange3</h4> 
<p>题目要求：/dev/urandom 和 getrandom 相等</p> 
<p><img src="https://images2.imgbox.com/4c/3d/IaAgWw1N_o.png" alt="在这里插入图片描述"></p> 
<p>程序需要使/dev/urandom 和 getrandom 相等，且一个字节的随机数和其他的随机数都不一样。</p> 
<p>getrandom的系统调用定义如下</p> 
<pre><code class="prism language-c"><span class="token class-name">ssize_t</span> <span class="token function">getrandom</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> buflen<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
The getrandom() system call fills the buffer pointed to by buf
with up to buflen random bytes.  These bytes can be used to seed
user-space random number generators or for cryptographic purposes.
*/</span>
</code></pre> 
<p>对 getrandom的劫持与Challenge2一样</p> 
<p>对 /dev/urandom的劫持要用到 QlFsMappedObject的add_fs_mapper，它可以实现将模拟环境中的<strong>路径劫持</strong>到主机上的路径或将<strong>读/写操作</strong>重定向到用户定义的对象。</p> 
<p><img src="https://images2.imgbox.com/bf/f2/LDVTxvtN_o.png" alt="在这里插入图片描述"></p> 
<p>slove-challenge3</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">Fake_urandom</span><span class="token punctuation">(</span>QlFsMappedObject<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">read</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># return a constant value upon reading</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>size <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">b"\x02"</span>  <span class="token comment"># byUrandom</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">b"\x01"</span> <span class="token operator">*</span> size

    <span class="token keyword">def</span> <span class="token function">fstat</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># syscall fstat will ignore it if return -1</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span>

    <span class="token keyword">def</span> <span class="token function">close</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">0</span>
    
<span class="token keyword">def</span> <span class="token function">fake_getrandom</span><span class="token punctuation">(</span>ql<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> buflen<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ql<span class="token punctuation">.</span>mem<span class="token punctuation">.</span>write<span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">b"\x01"</span><span class="token operator">*</span>buflen<span class="token punctuation">)</span>
    ql<span class="token punctuation">.</span>os<span class="token punctuation">.</span>set_syscall_return<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    
<span class="token keyword">def</span> <span class="token function">challenge3</span><span class="token punctuation">(</span>ql<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ql<span class="token punctuation">.</span>add_fs_mapper<span class="token punctuation">(</span><span class="token string">"/dev/urandom"</span><span class="token punctuation">,</span> Fake_urandom<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">#将虚拟路径映射到用户定义的文件类型，该对象允许对交互进行更精细的控制</span>
    ql<span class="token punctuation">.</span>os<span class="token punctuation">.</span>set_syscall<span class="token punctuation">(</span><span class="token string">'getrandom'</span><span class="token punctuation">,</span> fake_getrandom<span class="token punctuation">,</span> QL_INTERCEPT<span class="token punctuation">.</span>EXIT<span class="token punctuation">)</span>
    <span class="token comment">#同2系统调用</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/fc/b6/rX4UViyv_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="challenge_4_251"></a>challenge 4</h4> 
<p>题目要求：进入禁止的循环<br> IDA F5无效<br> <img src="https://images2.imgbox.com/4b/ed/ykiGZpod_o.png" alt="在这里插入图片描述"></p> 
<p>查看汇编<br> <img src="https://images2.imgbox.com/1b/c5/xs1ELeYo_o.png" alt="在这里插入图片描述"></p> 
<p>loc_FD8()函数<br> LDR 将存储器地址为SP+0x20-8的半字数据读入寄存器w0<br> LDR 将存储器地址为SP+0x20-4的半字数据读入寄存器w1<br> CMP 比较W1和W0的值<br> B.LT 比较结果是大于，跳转loc_FC0()函数，否则不跳转<br> 因为判断条件一直不成立，程序进入死循环，不会跳转循环语句<br> 我们需要在比较前将W0值改为1<br> 我们需要使用ql<br> https://docs.qiling.io/en/latest/hook/</p> 
<p>slove-challenge4</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">forbidden_loop_hook</span><span class="token punctuation">(</span>ql<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token comment">#hook_address 将 x0 改成比 x1 小即可</span>
    <span class="token comment">#ql.arch.regs.x0 = 1</span>
    <span class="token comment">#ql.arch.regs.write("x0", 1)</span>

    ql<span class="token punctuation">.</span>arch<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"w0"</span><span class="token punctuation">,</span> <span class="token number">0x1</span><span class="token punctuation">)</span>
 
<span class="token keyword">def</span> <span class="token function">challenge4</span><span class="token punctuation">(</span>ql<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token comment"># Get the module base address</span>

    <span class="token comment"># https://github.com/qilingframework/qiling/blob/dev/qiling/profiles/linux.ql 可知 qiling 默认配置 linux64 加载基地址为 0x555555554000</span>

    <span class="token comment">#base_addr = ql.mem.get_lib_base(ql.path)</span>

    <span class="token comment"># Address we need to patch</span>
    test_forbidden_loop_enter <span class="token operator">=</span> <span class="token number">0x555555554000</span> <span class="token operator">+</span> <span class="token number">0xFE0</span>

    <span class="token comment"># cmp指令偏移是 0xFE0</span>
    <span class="token comment"># Place hook</span>
    ql<span class="token punctuation">.</span>hook_address<span class="token punctuation">(</span>forbidden_loop_hook<span class="token punctuation">,</span> test_forbidden_loop_enter<span class="token punctuation">)</span>
</code></pre> 
<p>cmp指令偏移是 0xFE0<br> <img src="https://images2.imgbox.com/f6/a5/JpkPzQF9_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/b7/0b/n7TaoKZH_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="challenge5_302"></a>challenge5</h4> 
<p>题目要求：预测每次调用rand()函数的值</p> 
<p><img src="https://images2.imgbox.com/aa/73/pvGTJlKt_o.png" alt="在这里插入图片描述"></p> 
<p>在第二个for循环中，存在判断语句rand()函数的值是否都相同为0，我们需要挟持rand()函数的值让它都是0</p> 
<p><strong>rand()是库函数，不是系统调用，所以不能用set_syscall，应该用set_api</strong></p> 
<p>参考Qiling文档Hijacking OS API (POSIX)<br> <img src="https://images2.imgbox.com/00/20/KqIoKFSO_o.png" alt="在这里插入图片描述"></p> 
<p>slove-challenge5</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">rand_hook</span><span class="token punctuation">(</span>ql<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span><span class="token punctuation">:</span>

    ql<span class="token punctuation">.</span>arch<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>x0 <span class="token operator">=</span> <span class="token number">0</span>

<span class="token keyword">def</span> <span class="token function">challenge5</span><span class="token punctuation">(</span>ql<span class="token punctuation">)</span><span class="token punctuation">:</span>

    ql<span class="token punctuation">.</span>os<span class="token punctuation">.</span>set_api<span class="token punctuation">(</span><span class="token string">"rand"</span><span class="token punctuation">,</span> rand_hook<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/eb/c1/0J6613XK_o.png" alt="在这里插入图片描述"></p> 
<p>这里为什么没有报sloved，排查问题也排查不出呀</p> 
<h4><a id="challenge6_331"></a>challenge6</h4> 
<p>题目要求：避免无限循环</p> 
<p><img src="https://images2.imgbox.com/14/7d/vr3rJOj3_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/5c/f7/kYAHyiEW_o.png" alt="在这里插入图片描述"></p> 
<p><strong>B.NE</strong> 表示不相等时直接向后跳转<br> 程序不断的将1 mov至寄存器w0，然后cmp w0 和0的值，不相同时跳转，程序陷入无限死循环，我们需要在cmp前使w0=0.就可以跳出循环</p> 
<p>slove-challenge6</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">infinite_loop_bypass_hook</span><span class="token punctuation">(</span>ql<span class="token punctuation">)</span><span class="token punctuation">:</span>

    ql<span class="token punctuation">.</span>arch<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"w0"</span><span class="token punctuation">,</span> <span class="token number">0x0</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">challenge6</span><span class="token punctuation">(</span>ql<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token comment"># Address we need to patch</span>

    <span class="token comment"># cmp_infinite_loop_addr = base_addr + 0x1118 = 0x555555554000 + 0x1118</span>

    <span class="token comment"># Place hook</span>

    ql<span class="token punctuation">.</span>hook_address<span class="token punctuation">(</span>infinite_loop_bypass_hook<span class="token punctuation">,</span> <span class="token number">0x555555554000</span> <span class="token operator">+</span> <span class="token number">0x1118</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/07/5c/EKd9CZyD_o.png" alt="在这里插入图片描述"></p> 
<p>输出 challenge5 SOLVED<br> 之前卡住判断是因为challnege6存在死循环，然后解决完死循环的问题，challenge5就解决了</p> 
<h4><a id="challenge_7_364"></a>challenge 7</h4> 
<p>题目要求:不要浪费时间等待sleep()函数</p> 
<p><img src="https://images2.imgbox.com/b7/64/sQVm6VTm_o.png" alt="在这里插入图片描述"></p> 
<p>这里可以挟持sleep()函数，修改sleep的值</p> 
<p>slove-challenge7</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">fake_sleep</span><span class="token punctuation">(</span>ql<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ql<span class="token punctuation">.</span>arch<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"w0"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token comment">#法二 </span>
    <span class="token comment">#return</span>
<span class="token keyword">def</span> <span class="token function">hook_nanosleep</span><span class="token punctuation">(</span>ql<span class="token punctuation">:</span> Qiling<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 注意参数列表</span>
    <span class="token keyword">return</span>

<span class="token keyword">def</span> <span class="token function">challenge7</span><span class="token punctuation">(</span>ql<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ql<span class="token punctuation">.</span>os<span class="token punctuation">.</span>set_api<span class="token punctuation">(</span><span class="token string">"sleep"</span><span class="token punctuation">,</span> fake_sleep<span class="token punctuation">)</span>
    <span class="token comment">#法三</span>
    <span class="token comment">#ql.set_syscall('nanosleep', hook_nanosleep)</span>
</code></pre> 
<p>这个challenge7解决后，程序恢复正常，开始输出各个challenge的信息</p> 
<p>参考其他大佬的方法，这里还有几种解决方法：<br> 1、挟持sleep()函数，将其替换为空函数<br> 2、劫持系统调用，根据DEBUG信息，sleep其实是调用了nanosleep()</p> 
<pre><code>参考
https://man7.org/linux/man-pages/man3/sleep.3.html
https://man7.org/linux/man-pages/man2/nanosleep.2.html
	On Linux, sleep() is implemented via nanosleep(2). 
</code></pre> 
<p><img src="https://images2.imgbox.com/35/7b/DqYpSPCl_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="challenge8_404"></a>challenge8</h4> 
<p>题目要求：解包结构体并在目标地址写入内容</p> 
<p><img src="https://images2.imgbox.com/98/10/v6Th3IcX_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/c8/4a/h43zTFjd_o.png" alt="在这里插入图片描述"></p> 
<p>NOP 无操作</p> 
<p>这个题目没咋看懂，函数调用了两次malloc()函数，结构体嵌套？<br> 看了一下其他人的方法，是通过利用特殊字符串或者结构定位想要的指令地址<br> 通过固定的 0x3DFCD6EA539 去找到结构体位置，进而修改 flag</p> 
<p>qiling从内存搜索字符串<br> <img src="https://images2.imgbox.com/9b/30/9TQvn7T7_o.png" alt="在这里插入图片描述"></p> 
<p>这里才理解了QQQ的原理</p> 
<p>slove-challenge7</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">search_heap1</span><span class="token punctuation">(</span>ql<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token comment">#从内存中搜索字符串</span>
    nMagic <span class="token operator">=</span> <span class="token number">0x3DFCD6EA00000539</span>
    pMagics <span class="token operator">=</span> ql<span class="token punctuation">.</span>mem<span class="token punctuation">.</span>search<span class="token punctuation">(</span>ql<span class="token punctuation">.</span>pack64<span class="token punctuation">(</span>nMagic<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">#内存可能出现了几次字符串，使用字符串“Random data”验证是否找到了正确的数据</span>
    <span class="token keyword">for</span> pMagic <span class="token keyword">in</span> pMagics<span class="token punctuation">:</span>
    	pHeap1 <span class="token operator">=</span> pMagic <span class="token operator">-</span> <span class="token number">8</span>    	
    	heap1 <span class="token operator">=</span> ql<span class="token punctuation">.</span>mem<span class="token punctuation">.</span>read<span class="token punctuation">(</span>pHeap1<span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">)</span>
    	pHeap2<span class="token punctuation">,</span> _<span class="token punctuation">,</span> pFlag <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">"QQQ"</span><span class="token punctuation">,</span> heap1<span class="token punctuation">)</span>  	
<span class="token comment">#比较地址和读到的字符串</span>
    	<span class="token keyword">if</span> ql<span class="token punctuation">.</span>mem<span class="token punctuation">.</span>string<span class="token punctuation">(</span>pHeap2<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"Random data"</span><span class="token punctuation">:</span>
<span class="token comment">#找到结构体的位置然后写入1</span>
    		ql<span class="token punctuation">.</span>mem<span class="token punctuation">.</span>write<span class="token punctuation">(</span>pFlag<span class="token punctuation">,</span> <span class="token string">b"\x01"</span><span class="token punctuation">)</span>
    		<span class="token keyword">break</span>

<span class="token keyword">def</span> <span class="token function">challenge8</span><span class="token punctuation">(</span>ql<span class="token punctuation">)</span><span class="token punctuation">:</span>

    ql<span class="token punctuation">.</span>hook_address<span class="token punctuation">(</span>search_heap1<span class="token punctuation">,</span> <span class="token number">0x555555554000</span> <span class="token operator">+</span> <span class="token number">0x11DC</span><span class="token punctuation">)</span> <span class="token comment"># 0x11DC : nop</span>

</code></pre> 
<p><img src="https://images2.imgbox.com/26/ad/Ur0cYJFy_o.png" alt="在这里插入图片描述"></p> 
<p>这个题目确实有点云里雾里，后续再研究研究</p> 
<h4><a id="challenge9_451"></a>challenge9</h4> 
<p>题目要求：修改字符串操作使得 iMpOsSiBlE 正确</p> 
<p><img src="https://images2.imgbox.com/d4/8b/QKeJMAV9_o.png" alt="在这里插入图片描述"></p> 
<p>tolower(int c) 把给定的字母转换为小写字母</p> 
<p>解决的两个思路<br> 1、在两个字符串比较前，让tolower()失效<br> 2、直接修改strcmp(src, dest) == 0 的值</p> 
<p>solve-challenge9</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">fake_strcmp</span><span class="token punctuation">(</span>ql<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>

    ql<span class="token punctuation">.</span>arch<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"x0"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>  

<span class="token keyword">def</span> <span class="token function">fake_tolower</span><span class="token punctuation">(</span>ql<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span>

<span class="token keyword">def</span> <span class="token function">challenge9</span><span class="token punctuation">(</span>ql<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token comment">#ql.os.set_api('strcmp', fake_strcmp)</span>

    ql<span class="token punctuation">.</span>os<span class="token punctuation">.</span>set_api<span class="token punctuation">(</span><span class="token string">'tolower'</span><span class="token punctuation">,</span> fake_tolower<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/6f/1e/cmrupxFZ_o.png" alt="在这里插入图片描述"></p> 
<p>方法二同时会解决challenge2，后面看一下</p> 
<h4><a id="challenge10_485"></a>challenge10</h4> 
<p>题目要求：伪造成 ’cmdline’ 文件来返回正确的内容<br> <img src="https://images2.imgbox.com/f4/e3/zJ0v0xty_o.png" alt="在这里插入图片描述"></p> 
<p>通过篡改/proc/self/cmdline 这个文件内容为”qilinglab”</p> 
<p>解决的两个思路<br> 1、像challenge3对 /dev/urandom的劫持的那样，通过 add_fs_mapper 映射到自定义实现或主机路径，它可以实现将模拟环境中的<strong>路径劫持</strong>到主机上的路径或将<strong>读/写操作</strong>重定向到用户定义的对象。<br> 2、直接修改strcmp(buf，“qilinglab”) == 0 的值，这也是为啥challenge 9的方法二可以同时解决challenge 10</p> 
<p>solve-challenge10</p> 
<pre><code class="prism language-python"><span class="token comment">#未通过</span>
<span class="token keyword">class</span> <span class="token class-name">Fake_cmdline</span><span class="token punctuation">(</span>QlFsMappedObject<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">read</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">b'qilinglab'</span>

    <span class="token keyword">def</span> <span class="token function">fstat</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span>

    <span class="token keyword">def</span> <span class="token function">close</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">0</span>

<span class="token keyword">def</span> <span class="token function">challenge10</span><span class="token punctuation">(</span>ql<span class="token punctuation">)</span><span class="token punctuation">:</span>

    ql<span class="token punctuation">.</span>add_fs_mapper<span class="token punctuation">(</span><span class="token string">"/proc/self/cmdline"</span><span class="token punctuation">,</span> Fake_cmdline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/3c/a1/Kb1q6bOj_o.png" alt="在这里插入图片描述"></p> 
<p>JOANSIVION也提到直接用我们的另一个主机文件系统替换目标文件<br> 本地创建一个文本</p> 
<pre><code class="prism language-shell"><span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> <span class="token string">"qilinglab"</span> <span class="token operator">&gt;</span> fake_cmdline
</code></pre> 
<pre><code>ql.add_fs_mapper("/proc/self/cmdline", "./fake_cmdline")
</code></pre> 
<p>为啥大家这样解决都没问题，我challenge9无论采用ql.os.set_api(‘tolower’, fake_tolower)的方案，还是直接替换目标文件，后面这里一直通不过呀？？？<br> <strong>有无大佬这里能指点一下</strong><br> 最后只能采用挟持strcmp()函数的方案</p> 
<h4><a id="challenge11_531"></a>challenge11</h4> 
<p>题目要求：绕过CPUID/MIDR_EL1检查</p> 
<p><img src="https://images2.imgbox.com/ab/e9/vqMzTqRn_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/ec/25/8bvYhg63_o.png" alt="在这里插入图片描述"></p> 
<p><strong>MRS</strong> CPUid指令，可以加载特殊功能寄存器的值到通用寄存器<br> aarch64的伪代码：</p> 
<pre><code>if ( _ReadStatusReg(ARM64_SYSREG(3, 0, 0, 0, 0)) &gt;&gt; 16 == 4919 )
  {
    result = (__int64)a1;
    *a1 = 1;
  }
</code></pre> 
<p>这里是将CPU的信息保存到X0中，然后运行比较运算</p> 
<p>solve-challenge11<br> 为了通过挑战，我们需要将返回值替换为0x1337</p> 
<p>简便方法：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">fake_end</span><span class="token punctuation">(</span>ql<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ql<span class="token punctuation">.</span>arch<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"x1"</span><span class="token punctuation">,</span> <span class="token number">0x1337</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">challenge11</span><span class="token punctuation">(</span>ql<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ql<span class="token punctuation">.</span>hook_address<span class="token punctuation">(</span>fake_end<span class="token punctuation">,</span> <span class="token number">0x555555554000</span><span class="token operator">+</span> <span class="token number">0x1400</span><span class="token punctuation">)</span>
</code></pre> 
<p>或者采用qiling的函数 hook_code(),可以hook CPU所有的指令，</p> 
<p><img src="https://images2.imgbox.com/dd/c8/5xTGPrWU_o.png" alt="在这里插入图片描述"></p> 
<p>法二：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">midr_el1_hook</span><span class="token punctuation">(</span>ql<span class="token punctuation">,</span> address<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># opcode: \x00\x00\x38\xD5  </span>
    <span class="token keyword">if</span> ql<span class="token punctuation">.</span>mem<span class="token punctuation">.</span>read<span class="token punctuation">(</span>address<span class="token punctuation">,</span> size<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">b"\x00\x00\x38\xD5"</span><span class="token punctuation">:</span>
        <span class="token comment"># Write the expected value to x0</span>
        ql<span class="token punctuation">.</span>arch<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>x0 <span class="token operator">=</span> <span class="token number">0x1337</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span>
        <span class="token comment"># Go to next instruction</span>
        <span class="token comment"># opcode take 4 bytes so next instruction will be pc + 4</span>
        ql<span class="token punctuation">.</span>arch<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>arch_pc <span class="token operator">+=</span> <span class="token number">4</span>

<span class="token keyword">def</span> <span class="token function">challenge11</span><span class="token punctuation">(</span>ql<span class="token punctuation">)</span><span class="token punctuation">:</span>

    ql<span class="token punctuation">.</span>hook_code<span class="token punctuation">(</span>midr_el1_hook<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/3e/d8/C6W2CTHk_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_588"></a>完整代码</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> struct

<span class="token keyword">from</span> qiling <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment"># from unicorn.unicorn_const import UC_MEM_WRITE</span>
<span class="token keyword">from</span> qiling<span class="token punctuation">.</span>const <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> qiling<span class="token punctuation">.</span>os<span class="token punctuation">.</span>mapper <span class="token keyword">import</span> QlFsMappedObject

<span class="token keyword">def</span> <span class="token function">challenge1</span><span class="token punctuation">(</span>ql<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#ql.mem.map(addr, size) must be page aligned</span>
    ql<span class="token punctuation">.</span>mem<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token number">0x1000</span><span class="token punctuation">,</span> <span class="token number">0x1000</span><span class="token punctuation">,</span> info <span class="token operator">=</span> <span class="token string">"[challenge1]"</span><span class="token punctuation">)</span>
    ql<span class="token punctuation">.</span>mem<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token number">0x1337</span><span class="token punctuation">,</span> ql<span class="token punctuation">.</span>pack16<span class="token punctuation">(</span><span class="token number">1337</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">hook_uname_on_exit</span><span class="token punctuation">(</span>ql<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#sp = ql.arch.regs.sp</span>
    out_struct_addr <span class="token operator">=</span> ql<span class="token punctuation">.</span>arch<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>sp <span class="token operator">+</span> <span class="token number">0x40</span>
    sysname_addr <span class="token operator">=</span> out_struct_addr
    ql<span class="token punctuation">.</span>mem<span class="token punctuation">.</span>write<span class="token punctuation">(</span>sysname_addr<span class="token punctuation">,</span> <span class="token string">b'QilingOS\x00'</span><span class="token punctuation">)</span>
    ql<span class="token punctuation">.</span>mem<span class="token punctuation">.</span>write<span class="token punctuation">(</span>out_struct_addr <span class="token operator">+</span> <span class="token number">65</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">b'ChallengeStart\x00'</span><span class="token punctuation">)</span>
    <span class="token comment">#ql.mem.write(pName, b'QilingOS\x00')</span>
    <span class="token comment">#ql.mem.write(pName + 65 * 3, b'ChallengeStart\x00')</span>

<span class="token keyword">def</span> <span class="token function">challenge2</span><span class="token punctuation">(</span>ql<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ql<span class="token punctuation">.</span>os<span class="token punctuation">.</span>set_syscall<span class="token punctuation">(</span><span class="token string">'uname'</span><span class="token punctuation">,</span> hook_uname_on_exit<span class="token punctuation">,</span> QL_INTERCEPT<span class="token punctuation">.</span>EXIT<span class="token punctuation">)</span>

    <span class="token comment">#系统调用可以通过其名称或号码来引用,通过引用其编号替换uname系统调用的等效替代</span>

<span class="token keyword">class</span> <span class="token class-name">Fake_urandom</span><span class="token punctuation">(</span>QlFsMappedObject<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">read</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">:</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>size <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">b"\x02"</span>  <span class="token comment"># byUrandom</span>

        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">b"\x01"</span> <span class="token operator">*</span> size
    <span class="token keyword">def</span> <span class="token function">fstat</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># syscall fstat will ignore it if return -1</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span>
    <span class="token keyword">def</span> <span class="token function">close</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">0</span>

<span class="token keyword">def</span> <span class="token function">fake_getrandom</span><span class="token punctuation">(</span>ql<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> buflen<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span><span class="token punctuation">:</span>

    ql<span class="token punctuation">.</span>mem<span class="token punctuation">.</span>write<span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">b"\x01"</span><span class="token operator">*</span>buflen<span class="token punctuation">)</span>
    ql<span class="token punctuation">.</span>os<span class="token punctuation">.</span>set_syscall_return<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">challenge3</span><span class="token punctuation">(</span>ql<span class="token punctuation">)</span><span class="token punctuation">:</span>

    ql<span class="token punctuation">.</span>add_fs_mapper<span class="token punctuation">(</span><span class="token string">"/dev/urandom"</span><span class="token punctuation">,</span> Fake_urandom<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    ql<span class="token punctuation">.</span>os<span class="token punctuation">.</span>set_syscall<span class="token punctuation">(</span><span class="token string">'getrandom'</span><span class="token punctuation">,</span> fake_getrandom<span class="token punctuation">,</span> QL_INTERCEPT<span class="token punctuation">.</span>EXIT<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">forbidden_loop_hook</span><span class="token punctuation">(</span>ql<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token comment">#ql.arch.regs.x0 = 1</span>
    <span class="token comment">#hook_address 将 x0 改成比 x1 小即可</span>
    <span class="token comment">#ql.arch.regs.write("x0", 1)</span>
    ql<span class="token punctuation">.</span>arch<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"w0"</span><span class="token punctuation">,</span> <span class="token number">0x1</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">challenge4</span><span class="token punctuation">(</span>ql<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token comment"># Get the module base address</span>
    <span class="token comment"># https://github.com/qilingframework/qiling/blob/dev/qiling/profiles/linux.ql 可知 qiling 默认配置 linux64 加载基地址为 0x555555554000</span>
    <span class="token comment">#base_addr = ql.mem.get_lib_base(ql.path)</span>
    <span class="token comment"># Address we need to patch</span>
    test_forbidden_loop_enter <span class="token operator">=</span> <span class="token number">0x555555554000</span> <span class="token operator">+</span> <span class="token number">0xFE0</span>
    <span class="token comment"># cmp指令偏移是 0xFE0</span>
    <span class="token comment"># Place hook</span>

    ql<span class="token punctuation">.</span>hook_address<span class="token punctuation">(</span>forbidden_loop_hook<span class="token punctuation">,</span> test_forbidden_loop_enter<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">rand_hook</span><span class="token punctuation">(</span>ql<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ql<span class="token punctuation">.</span>arch<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>x0 <span class="token operator">=</span> <span class="token number">0</span>

<span class="token keyword">def</span> <span class="token function">challenge5</span><span class="token punctuation">(</span>ql<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ql<span class="token punctuation">.</span>os<span class="token punctuation">.</span>set_api<span class="token punctuation">(</span><span class="token string">"rand"</span><span class="token punctuation">,</span> rand_hook<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">infinite_loop_bypass_hook</span><span class="token punctuation">(</span>ql<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ql<span class="token punctuation">.</span>arch<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"w0"</span><span class="token punctuation">,</span> <span class="token number">0x0</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">challenge6</span><span class="token punctuation">(</span>ql<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token comment"># Get the module base address</span>
    <span class="token comment">#base_addr = ql.mem.get_lib_base(ql.path)</span>
    <span class="token comment">#print(base_addr)</span>
    <span class="token comment"># Address we need to patch</span>
    <span class="token comment"># cmp_infinite_loop_addr = base_addr + 0x1118</span>
    <span class="token comment"># Place hook</span>

    ql<span class="token punctuation">.</span>hook_address<span class="token punctuation">(</span>infinite_loop_bypass_hook<span class="token punctuation">,</span> <span class="token number">0x555555554000</span> <span class="token operator">+</span> <span class="token number">0x1118</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">fake_sleep</span><span class="token punctuation">(</span>ql<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ql<span class="token punctuation">.</span>arch<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"w0"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">challenge7</span><span class="token punctuation">(</span>ql<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ql<span class="token punctuation">.</span>os<span class="token punctuation">.</span>set_api<span class="token punctuation">(</span><span class="token string">"sleep"</span><span class="token punctuation">,</span> fake_sleep<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">search_heap1</span><span class="token punctuation">(</span>ql<span class="token punctuation">)</span><span class="token punctuation">:</span>
    nMagic <span class="token operator">=</span> <span class="token number">0x3DFCD6EA00000539</span><span class="token punctuation">;</span>
    pMagics <span class="token operator">=</span> ql<span class="token punctuation">.</span>mem<span class="token punctuation">.</span>search<span class="token punctuation">(</span>ql<span class="token punctuation">.</span>pack64<span class="token punctuation">(</span>nMagic<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> pMagic <span class="token keyword">in</span> pMagics<span class="token punctuation">:</span>
    	pHeap1 <span class="token operator">=</span> pMagic <span class="token operator">-</span> <span class="token number">8</span>
    	heap1 <span class="token operator">=</span> ql<span class="token punctuation">.</span>mem<span class="token punctuation">.</span>read<span class="token punctuation">(</span>pHeap1<span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">)</span>
    	pHeap2<span class="token punctuation">,</span> _<span class="token punctuation">,</span> pFlag <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">"QQQ"</span><span class="token punctuation">,</span> heap1<span class="token punctuation">)</span>

    	<span class="token keyword">if</span> ql<span class="token punctuation">.</span>mem<span class="token punctuation">.</span>string<span class="token punctuation">(</span>pHeap2<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"Random data"</span><span class="token punctuation">:</span>
    		ql<span class="token punctuation">.</span>mem<span class="token punctuation">.</span>write<span class="token punctuation">(</span>pFlag<span class="token punctuation">,</span> <span class="token string">b"\x01"</span><span class="token punctuation">)</span>
    		<span class="token keyword">break</span>
    		<span class="token keyword">return</span>

<span class="token keyword">def</span> <span class="token function">challenge8</span><span class="token punctuation">(</span>ql<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#pBase = ql.mem.get_lib_base(ql.path)</span>
    ql<span class="token punctuation">.</span>hook_address<span class="token punctuation">(</span>search_heap1<span class="token punctuation">,</span> <span class="token number">0x555555554000</span> <span class="token operator">+</span> <span class="token number">0x11DC</span><span class="token punctuation">)</span> <span class="token comment"># 0x11DC : nop</span>
<span class="token comment">#def fake_strcmp(ql, *args):</span>
    <span class="token comment">#ql.arch.regs.write("x0", 0)</span>
<span class="token keyword">def</span> <span class="token function">fake_tolower</span><span class="token punctuation">(</span>ql<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span>

<span class="token keyword">def</span> <span class="token function">challenge9</span><span class="token punctuation">(</span>ql<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#ql.os.set_api('strcmp', fake_strcmp)</span>
    ql<span class="token punctuation">.</span>os<span class="token punctuation">.</span>set_api<span class="token punctuation">(</span><span class="token string">"tolower"</span><span class="token punctuation">,</span> fake_tolower<span class="token punctuation">)</span>   

<span class="token keyword">class</span> <span class="token class-name">Fake_cmdline</span><span class="token punctuation">(</span>QlFsMappedObject<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">read</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">b"qilinglab"</span>
    <span class="token keyword">def</span> <span class="token function">close</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">0</span>

<span class="token keyword">def</span> <span class="token function">challenge10</span><span class="token punctuation">(</span>ql<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ql<span class="token punctuation">.</span>add_fs_mapper<span class="token punctuation">(</span><span class="token string">"/proc/self/cmdline"</span><span class="token punctuation">,</span> Fake_cmdline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">fake_end</span><span class="token punctuation">(</span>ql<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ql<span class="token punctuation">.</span>arch<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"x1"</span><span class="token punctuation">,</span> <span class="token number">0x1337</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">challenge11</span><span class="token punctuation">(</span>ql<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ql<span class="token punctuation">.</span>hook_address<span class="token punctuation">(</span>fake_end<span class="token punctuation">,</span> <span class="token number">0x555555554000</span><span class="token operator">+</span> <span class="token number">0x1400</span><span class="token punctuation">)</span>   

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    path <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"./qilinglab-aarch64"</span><span class="token punctuation">]</span>
    rootfs <span class="token operator">=</span> <span class="token string">"/home/snjuxp/qiling/examples/rootfs/arm64_linux"</span>
    ql <span class="token operator">=</span> Qiling<span class="token punctuation">(</span>path<span class="token punctuation">,</span> rootfs<span class="token punctuation">,</span> verbose<span class="token operator">=</span>QL_VERBOSE<span class="token punctuation">.</span>DEBUG<span class="token punctuation">)</span>
    <span class="token comment">#ql = Qiling(path, rootfs)</span>
    ql<span class="token punctuation">.</span>verbose <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token comment">#ql.verbose = 4</span>
    <span class="token comment"># ql.mem.map_info()</span>
    <span class="token comment">#ql.mem.get_formatted_mapinfo()</span>
    challenge1<span class="token punctuation">(</span>ql<span class="token punctuation">)</span>
    challenge2<span class="token punctuation">(</span>ql<span class="token punctuation">)</span>
    challenge3<span class="token punctuation">(</span>ql<span class="token punctuation">)</span>
    challenge4<span class="token punctuation">(</span>ql<span class="token punctuation">)</span>
    challenge5<span class="token punctuation">(</span>ql<span class="token punctuation">)</span>
    challenge6<span class="token punctuation">(</span>ql<span class="token punctuation">)</span>
    challenge7<span class="token punctuation">(</span>ql<span class="token punctuation">)</span>
    challenge8<span class="token punctuation">(</span>ql<span class="token punctuation">)</span>
    challenge9<span class="token punctuation">(</span>ql<span class="token punctuation">)</span>
    challenge10<span class="token punctuation">(</span>ql<span class="token punctuation">)</span>
    challenge11<span class="token punctuation">(</span>ql<span class="token punctuation">)</span>
    ql<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_747"></a>总结</h3> 
<p>这应该是农历新年的最后一篇文章了，同时也是2023新年的第一篇文章。今年学习了解了不少知识，射频安全，BLE，Fuzz，还有一些安全方案，2023年还有很多方向需要深入研究的，英语也需要多多练习口语，车联网安全的学习还任重而道远。2022的前半年都在疫情中度过，年末又恶感新冠，无论如何，希望2023身体健康。</p> 
<p>参考：<br> https://docs.qiling.io/<br> https://bbs.kanxue.com/thread-268989.htm#msg_header_h2_13<br> https://joansivion.github.io/qilinglabs/<br> https://ryze-t.com/2022/09/08/Qiling%E6%A1%86%E6%9E%B6%E5%85%A5%E9%97%A8-QilingLab/<br> https://blog.csdn.net/Ga4ra/article/details/124412806<br> https://github.com/badmonkey7/qilinglab-solution</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f9aa17c8b2d6b10b1038c02c84d8360b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">appium基本使用（Android）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7f83c983127f9d3f4282aef5b528ef26/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">YOLOv5训练自己的数据集(超详细)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>