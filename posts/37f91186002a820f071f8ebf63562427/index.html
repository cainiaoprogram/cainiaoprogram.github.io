<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MyCat入门配置详解和常见九种数据分片算法 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="MyCat入门配置详解和常见九种数据分片算法" />
<meta property="og:description" content="MyCat入门配置详解和常见九种数据分片算法 第一节 分库分表概述 1、为什么要拆分？ ①MySQL 实例内部结构 [1]单一架构 [2]复制架构 尽管搭建了复制架构，但是实际上从逻辑上来说仍然只有一个 db_hr 数据库。
②性能瓶颈 MySQL 工作过程中的性能瓶颈主要来自于下面三个方面（同等硬件条件下）：
数据存储量：单表 1000 万条数据达到极限；500 万条开始性能明显下降；300 万条开始就应该考虑拆分。I/O 瓶颈：关系型数据库以硬盘作为主要存储介质，所以必然存在 I/O 瓶颈。访问量瓶颈：通常 MySQL 的最大连接数默认是100，最大可以达到 16384。 由此我们可以看出，对数据库进行拆分主要是出于数据量不断增加的挑战。
2、拆分方式 ①垂直拆分 垂直拆分是最容易想到的拆分方式。它按照项目的业务功能模块，把从属于不同模块的数据库表分散到对应的不同数据库中。
这种拆分方式的优缺点是：
优点 拆分规则明确，按照不同的功能模块或服务分配不同数据库数据维护与定位简单 缺点 并没有解决单表数据量太大的问题会出现跨库 join需要对上层应用系统的代码进行重构，修改原有的事务操作 ②水平拆分 针对一张数据量很大的表，把它拆分为多张表，数据分流保存到各个拆分后的数据库表中。
如果数据量继续增加，超过一个单库能够容纳的极限则需要继续分库：
这种拆分方式的优缺点评价：
只分表不分库： 同库无分布式事务问题，事务处理相对简单同库无跨库 join 问题表拆分后不存在超大型表的性能问题只要拆分规则定义好，很难出现扩展性的限制，但拆分规则设定并不简单，规则一定会和业务挂钩，如根据 id、根据时间等。 既分表又分库： 异库存在分布式事务问题异库存在跨库 join 问题多数据源管理难度加大，代码复杂度增加 3、MyCat 简介 尽管拆分后必然要面对很多问题，但是随着数据量的增加又不得不拆分。所以我们开发的上层应用系统必须有能力对接拆分后的多个数据库。MyCat 就是帮助我们实现这一功能的数据库中间件。
MyCat 是一款数据库中间件。
对于应用程序来说完全透明：不管底层的数据如何拆分，应用只需要连接 MyCat 即可完成对数据的操作。
支持 MySQL、SQL Server、Oracle、DB2、PostgreSQL 等主流数据库。
MyCat 不存储数据，它只是数据的路由。
底层拦截用户发送过来的 SQL 语句并进行分析：如分片分析、路由分析、读写分离分析、缓存分析等，然后将此 SQL 发往后端的真实数据库，并将返回的结果做适当的处理，最终再返回给用户。
Mycat的特性如下:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/37f91186002a820f071f8ebf63562427/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-07T14:48:28+08:00" />
<meta property="article:modified_time" content="2023-11-07T14:48:28+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">MyCat入门配置详解和常见九种数据分片算法</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="MyCat_0"></a>MyCat入门配置详解和常见九种数据分片算法</h2> 
<h2><a id="__2"></a>第一节 分库分表概述</h2> 
<h3><a id="1_4"></a>1、为什么要拆分？</h3> 
<h4><a id="MySQL__6"></a>①MySQL 实例内部结构</h4> 
<h5><a id="1_8"></a>[1]单一架构</h5> 
<p><img src="https://images2.imgbox.com/d1/70/a6INBlmA_o.png" alt="images"></p> 
<h5><a id="2_12"></a>[2]复制架构</h5> 
<p>尽管搭建了复制架构，但是实际上从逻辑上来说仍然只有一个 db_hr 数据库。</p> 
<p><img src="https://images2.imgbox.com/60/4e/nX7l9tX6_o.png" alt="images"></p> 
<h4><a id="_18"></a>②性能瓶颈</h4> 
<p>MySQL 工作过程中的性能瓶颈主要来自于下面三个方面（同等硬件条件下）：</p> 
<ul><li>数据存储量：单表 1000 万条数据达到极限；500 万条开始性能明显下降；300 万条开始就应该考虑拆分。</li><li>I/O 瓶颈：关系型数据库以硬盘作为主要存储介质，所以必然存在 I/O 瓶颈。</li><li>访问量瓶颈：通常 MySQL 的最大连接数默认是100，最大可以达到 16384。</li></ul> 
<p>由此我们可以看出，对数据库进行拆分主要是出于数据量不断增加的挑战。</p> 
<h3><a id="2_28"></a>2、拆分方式</h3> 
<h4><a id="_30"></a>①垂直拆分</h4> 
<p>垂直拆分是最容易想到的拆分方式。它按照项目的业务功能模块，把从属于不同模块的数据库表分散到对应的不同数据库中。</p> 
<p><img src="https://images2.imgbox.com/92/e8/Puz5oMC6_o.png" alt="images"></p> 
<p>这种拆分方式的优缺点是：</p> 
<ul><li>优点 
  <ul><li>拆分规则明确，按照不同的功能模块或服务分配不同数据库</li><li>数据维护与定位简单</li></ul> </li><li>缺点 
  <ul><li>并没有解决单表数据量太大的问题</li><li>会出现跨库 join</li><li>需要对上层应用系统的代码进行重构，修改原有的事务操作</li></ul> </li></ul> 
<h4><a id="_46"></a>②水平拆分</h4> 
<p>针对一张数据量很大的表，把它拆分为多张表，数据分流保存到各个拆分后的数据库表中。</p> 
<p><img src="https://images2.imgbox.com/41/94/20MnQrpf_o.png" alt=""></p> 
<p>如果数据量继续增加，超过一个单库能够容纳的极限则需要继续分库：</p> 
<p><img src="https://images2.imgbox.com/55/f9/fnMRjNgA_o.png" alt="images"></p> 
<p>这种拆分方式的优缺点评价：</p> 
<ul><li>只分表不分库： 
  <ul><li>同库无分布式事务问题，事务处理相对简单</li><li>同库无跨库 join 问题</li><li>表拆分后不存在超大型表的性能问题</li><li>只要拆分规则定义好，很难出现扩展性的限制，但拆分规则设定并不简单，规则一定会和业务挂钩，如根据 id、根据时间等。</li></ul> </li><li>既分表又分库： 
  <ul><li>异库存在分布式事务问题</li><li>异库存在跨库 join 问题</li><li>多数据源管理难度加大，代码复杂度增加</li></ul> </li></ul> 
<h3><a id="3MyCat__68"></a>3、MyCat 简介</h3> 
<p>尽管拆分后必然要面对很多问题，但是随着数据量的增加又不得不拆分。所以我们开发的上层应用系统必须有能力对接拆分后的多个数据库。MyCat 就是帮助我们实现这一功能的数据库中间件。</p> 
<p><img src="https://images2.imgbox.com/af/53/1N0CAAcF_o.png" alt="images"></p> 
<p>MyCat 是一款数据库中间件。</p> 
<p>对于应用程序来说完全透明：不管底层的数据如何拆分，应用只需要连接 MyCat 即可完成对数据的操作。</p> 
<p>支持 MySQL、SQL Server、Oracle、DB2、PostgreSQL 等主流数据库。</p> 
<p>MyCat <strong>不存储数据</strong>，它只是<strong>数据的路由</strong>。</p> 
<p>底层拦截用户发送过来的 SQL 语句并进行分析：如分片分析、路由分析、读写分离分析、缓存分析等，然后将此 SQL 发往后端的真实数据库，并将返回的结果做适当的处理，最终再返回给用户。</p> 
<p>Mycat的特性如下:</p> 
<ul><li>支持SQL92标准</li><li>遵守Mysql原生协议，跨语言，跨平台，跨数据库的通用中间件代理</li><li>基于心跳的自动故障切换，支持读写分离，支持MySQL主从，以及galera cluster集群</li><li>支持Galera for MySQL集群，Percona Cluster或者MariaDB cluster</li><li>基于Nio实现，有效管理线程，高并发问题</li><li>支持数据的多片自动路由与聚合，支持sum,count,max等常用的聚合函数</li><li>支持单库内部任意join，支持跨库2表join</li><li>支持通过全局表，ER关系的分片策略，实现了高效的多表join查询</li><li>支持多租户方案</li><li>支持分布式事务</li><li>支持全局序列号，解决分布式下的主键生成问题</li><li>分片规则丰富，插件化开发，易于扩展</li><li>强大的web，命令行监控</li><li>支持前端作为mysq通用代理，后端JDBC方式支持Oracle、DB2、SQL Server 、 mongodb</li><li>支持密码加密</li><li>支持服务降级</li><li>支持IP白名单</li><li>支持SQL黑名单、sql注入攻击拦截</li><li>支持分表(1.6以后版本)</li><li>集群基于ZooKeeper管理，在线升级，扩容，智能优化，大数据处理（2.0以后版本）</li></ul> 
<h2><a id="__107"></a>第二节 安装与配置</h2> 
<h3><a id="1_MyCat__109"></a>1、获取 MyCat 程序</h3> 
<h4><a id="_111"></a>①方式一</h4> 
<p>访问这个地址下载：https://codeload.github.com/MyCATApache/Mycat-Server/zip/Mycat-server-1675-release</p> 
<h4><a id="_115"></a>②方式二</h4> 
<p>由老师发给你。</p> 
<h3><a id="2_MyCat__119"></a>2、解压 MyCat 压缩包</h3> 
<p><img src="https://images2.imgbox.com/e3/04/KmDQg6A8_o.png" alt="images"></p> 
<h3><a id="3_IDEA__123"></a>3、使用 IDEA 打开</h3> 
<p><img src="https://images2.imgbox.com/5f/3c/8G5p5uMf_o.png" alt="images"></p> 
<h3><a id="4_schemaxml_127"></a>4、配置 schema.xml</h3> 
<p>从这里开始，我们就是在初步搭建 MyCat 服务器。我们想要初步实现的目标：</p> 
<ul><li>MyCat 中配置虚拟数据库、虚拟数据库表，物理库和物理表暂时不拆分</li><li>启动 MyCat</li><li>使用客户端连接到 MyCat</li></ul> 
<p>而让 MyCat 连接物理库、配置虚拟库、虚拟表都需要在 schema.xml 中配置。</p> 
<h4><a id="_137"></a>①配置文件位置</h4> 
<p><img src="https://images2.imgbox.com/54/96/wBqYpeqR_o.png" alt="images"></p> 
<h4><a id="_MyCat__141"></a>②告诉 MyCat 如何连接物理库</h4> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!--
	dataHost 标签：配置物理库的连接方式。可以配置多个。本质上是连接到数据库服务器。
	name 属性：给当前 dataHost 标签命名，便于其它地方引用。
 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dataHost</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>virtual-host-hello<span class="token punctuation">"</span></span>
		  <span class="token attr-name">maxCon</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1000<span class="token punctuation">"</span></span>
		  <span class="token attr-name">minCon</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span>
		  <span class="token attr-name">balance</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>
		  <span class="token attr-name">writeType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>
		  <span class="token attr-name">dbType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mysql<span class="token punctuation">"</span></span>
		  <span class="token attr-name">dbDriver</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>jdbc<span class="token punctuation">"</span></span>
		  <span class="token attr-name">switchType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span>
		  <span class="token attr-name">slaveThreshold</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

	<span class="token comment">&lt;!--
		heartbeat 标签：设置做心跳检查时使用的 SQL 语句。
	--&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>heartbeat</span><span class="token punctuation">&gt;</span></span>select user()<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>heartbeat</span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!--
		writeHost 标签：具体配置连接物理库的信息，可以有多个。
		host 属性：命名 一般writeHost用M1 readHost用S1。
		url 属性：物理库的 URL 地址
		user 属性：连接物理库使用的用户名
		password 属性：连接物理库使用的密码
	 --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>writeHost</span> <span class="token attr-name">host</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hostM1<span class="token punctuation">"</span></span>
			   <span class="token attr-name">url</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>jdbc:mysql://localhost:3306<span class="token punctuation">"</span></span>
			   <span class="token attr-name">user</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>root<span class="token punctuation">"</span></span>
			   <span class="token attr-name">password</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>root<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dataHost</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h4><a id="_dataNode_179"></a>③配置 dataNode</h4> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!--
	dataNode 标签：配置数据节点。本质上是连接到数据库服务器上的一个具体物理数据库。
	name 属性：给当前 dataNode 标签命名，便于其它地方引用。
	dataHost 属性：引用一个已经配置好的 dataHost。
	database 属性：指定一个具体的物理库的名称。
--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dataNode</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>data-node-hello<span class="token punctuation">"</span></span> <span class="token attr-name">dataHost</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>virtual-host-hello<span class="token punctuation">"</span></span> <span class="token attr-name">database</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>db_hr<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre> 
<h4><a id="_193"></a>④创建虚拟库和虚拟表</h4> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!--
	schema 标签：配置虚拟库，里面子标签配置虚拟表。
	name 属性：给当前 schema 标签命名，便于其它地方引用。同时也是指定虚拟数据库的名称。
 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>schema</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>virtual-db-hello<span class="token punctuation">"</span></span> <span class="token attr-name">checkSQLschema</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">sqlMaxLimit</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

	<span class="token comment">&lt;!-- table 标签：配置虚拟表。 --&gt;</span>
	<span class="token comment">&lt;!-- name 属性：指定虚拟表的名称。 --&gt;</span>
	<span class="token comment">&lt;!-- dataNode 属性：通过指定 dataNode 指定当前虚拟表要连接的物理库。如果有多个，可以使用逗号分开，也可以使用 dn$1-3 这样的表达式。 --&gt;</span>
	<span class="token comment">&lt;!-- subTables 属性：指定虚拟表对应的物理表。 --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>virtual_t_emp<span class="token punctuation">"</span></span>
		   <span class="token attr-name">primaryKey</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>emp_id<span class="token punctuation">"</span></span>
		   <span class="token attr-name">dataNode</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>data-node-hello<span class="token punctuation">"</span></span>
		   <span class="token attr-name">autoIncrement</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
		   <span class="token attr-name">fetchStoreNodeByJdbc</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
		   <span class="token attr-name">subTables</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>t_emp<span class="token punctuation">"</span></span>
	<span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>schema</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h3><a id="5_serverxml_218"></a>5、配置 server.xml</h3> 
<h4><a id="_220"></a>①配置文件位置</h4> 
<p><img src="https://images2.imgbox.com/d4/15/W3Bf1xQR_o.png" alt="images"></p> 
<h4><a id="_MyCat__224"></a>②配置 MyCat 自身的连接信息</h4> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!-- user 标签：配置外界连接 MyCat 时使用的连接信息 --&gt;</span>
<span class="token comment">&lt;!-- name 属性：指定用户名。 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>myCat<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!-- password 属性：指定密码。 --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>hello<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>

	<span class="token comment">&lt;!-- schemas 属性：要连接的虚拟库的名称。
	请到 schema.xml 配置文件中找到 schema 标签，复制过来 schema 标签的 name 属性。 --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>schemas<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>virtual-db-hello<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>user</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h3><a id="6_MyCat_241"></a>6、启动 MyCat</h3> 
<h4><a id="_MyCat__243"></a>①找到 MyCat 启动类</h4> 
<p><img src="https://images2.imgbox.com/2c/8e/rsnv7lOr_o.png" alt="images"></p> 
<h4><a id="_JVM__247"></a>②配置 JVM 参数</h4> 
<ul><li>指定 MYCAT_HOME：这个参数是需要指定 MyCat 工程的 src/main 目录的完整路径。</li><li>指定直接内存大小：如果 512M 不够，那就指定 1024M。</li></ul> 
<blockquote> 
 <p>-DMYCAT_HOME=D:\idea2019workspace\mycat210722\src\main<br> -XX:MaxDirectMemorySize=512M</p> 
</blockquote> 
<h4><a id="_255"></a>③运行程序</h4> 
<p><img src="https://images2.imgbox.com/b0/e0/cEvuONFo_o.png" alt="images"></p> 
<h3><a id="7_259"></a>7、两个坑</h3> 
<h4><a id="_261"></a>①第一个</h4> 
<p>如果 schema 标签的配置是从官方提供的配置中复制过来的，那么可能会带有 randomDataNode 属性，此时会有下面问题：</p> 
<p><img src="https://images2.imgbox.com/06/10/XKe7Wica_o.png" alt="images"></p> 
<p>如果尝试连接 MyCat 时，没有指定一个具体的数据库名称，MyCat 会访问 randomDataNode 属性指定的数据节点。而如果这个数据节点不存在，那么就会访问失败。</p> 
<h4><a id="_269"></a>②第二个</h4> 
<p><img src="https://images2.imgbox.com/a8/03/bzoeitbT_o.png" alt="images"></p> 
<p>调整 JDK 版本操作如下：</p> 
<p><img src="https://images2.imgbox.com/7a/8a/BCtZjYg8_o.png" alt="images"></p> 
<p><img src="https://images2.imgbox.com/8d/96/OUxUx7Y6_o.png" alt="images"></p> 
<h2><a id="__279"></a>第三节 数据分片</h2> 
<h3><a id="1_281"></a>1、数据分片概念</h3> 
<p>从虚拟库、虚拟表看到的数据，逻辑上是一个整体。而实际上数据的物理存储是分散在不同物理库、物理表中。每个实际的物理表可以看成是一个数据分片。</p> 
<p>数据进入数据库时，经过不同<strong>拆分规则</strong>的分流进入了不同的数据分片。我们对拆分规则有两点期望：</p> 
<ul><li>数据存储的过程中：执行 insert 语句后将数据准确插入到对应分片</li><li>数据提取的过程中：能够准确的从指定分片查询到我们需要的数据</li></ul> 
<h3><a id="2_290"></a>2、数据分片的具体算法使用详解（见末尾附录）</h3> 
<p>[取模分片](# ①取模分片)</p> 
<p>[全局 id 分片](# ②全局 id 分片)</p> 
<p>[枚举分片](# ③枚举分片)</p> 
<p>[固定 hash 分片](# ④固定 hash 分片)</p> 
<p>[固定范围分片](# ⑤固定范围分片)</p> 
<p>[取模范围分片](# ⑥取模范围分片)</p> 
<p>[字符串 hash 分片](# ⑦字符串 hash 分片)</p> 
<p>[时间分片](# ⑧时间分片)</p> 
<p>[一致性 hash 分片](# ⑨一致性 hash 分片)</p> 
<h2><a id="__join_310"></a>第四节 跨库 join</h2> 
<p>概念：A 表和 B 表做关联查询，但是 A 表和 B 表不在同一个数据库中。</p> 
<h3><a id="1_314"></a>1、全局表</h3> 
<p>系统中基本都会存在数据字典信息，如数据分类信息、项目的配置信息等。这些字典数据最大的特点就是数据量不大并且很少会被改变。同时绝大多数的业务场景都会涉及到字典表的操作。 因此为了避免频繁的跨库join操作，结合冗余数据思想，可以考虑把这些字典信息在每一个分库中都存在一份。</p> 
<p>mycat在进行join操作时，当业务表与全局表进行聚合会优先选择相同分片的全局表，从而避免跨库join操作。在进行数据插入时，会把数据同时插入到所有分片的全局表中。</p> 
<p>修改 schema.xml</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tb_global<span class="token punctuation">"</span></span> <span class="token attr-name">dataNode</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dn142,dn145<span class="token punctuation">"</span></span> <span class="token attr-name">primaryKey</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>global_id<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>global<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> 
<h3><a id="2ER_328"></a>2、ER表</h3> 
<p>ER 表也是一种为了避免跨库join的手段，在业务开发时，经常会使用到主从表关系的查询，如商品表与商品详情表。</p> 
<p>ER 表的出现就是为了让有关系的表数据存储于同一个分片中，从而避免跨库 join 的出现。</p> 
<p>修改 schema.xml</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tb_goods<span class="token punctuation">"</span></span> <span class="token attr-name">dataNode</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dn129,dn130<span class="token punctuation">"</span></span> <span class="token attr-name">primaryKey</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>goods_id<span class="token punctuation">"</span></span> <span class="token attr-name">rule</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sharding-by-murmur-goods<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>childTable</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tb_goods_detail<span class="token punctuation">"</span></span> <span class="token attr-name">primaryKey</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>goods_detail_id<span class="token punctuation">"</span></span> <span class="token attr-name">joinKey</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>goods_id<span class="token punctuation">"</span></span> <span class="token attr-name">parentKey</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>goods_id<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>childTable</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>再次添加 goods 数据的时候,有关系的表数据存储于同一个分片中</p> 
<h2><a id="_346"></a>附：分片算法</h2> 
<h2><a id="_348"></a>①取模分片</h2> 
<p>[点击返回](# 2、数据分片的具体算法)</p> 
<h3><a id="1_352"></a>1、理解</h3> 
<p>根据 id 值进行模运算，然后根据取模的计算结果决定数据分流后存入的目标物理表。这里涉及到的用于取模计算的数据库表字段值，<strong>不能指望由数据库自增</strong>来得到——因为这个数据是在决定分流到哪个物理表时用到的，此时还没有执行 insert 语句。所以这个数据必须由程序员指定，<strong>在 Java 代码中生成</strong>。</p> 
<p><img src="https://images2.imgbox.com/80/91/7uGC4ggw_o.png" alt="images"></p> 
<h3><a id="2_358"></a>2、操作</h3> 
<h4><a id="_360"></a>①创建用于测试的物理表</h4> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>db_hr<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>t_emp1<span class="token punctuation">`</span></span> <span class="token punctuation">(</span> <span class="token identifier"><span class="token punctuation">`</span>emp_id<span class="token punctuation">`</span></span> <span class="token keyword">INT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>emp_name<span class="token punctuation">`</span></span> <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>emp_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>db_hr<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>t_emp2<span class="token punctuation">`</span></span> <span class="token punctuation">(</span> <span class="token identifier"><span class="token punctuation">`</span>emp_id<span class="token punctuation">`</span></span> <span class="token keyword">INT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>emp_name<span class="token punctuation">`</span></span> <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>emp_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>db_hr<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>t_emp3<span class="token punctuation">`</span></span> <span class="token punctuation">(</span> <span class="token identifier"><span class="token punctuation">`</span>emp_id<span class="token punctuation">`</span></span> <span class="token keyword">INT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>emp_name<span class="token punctuation">`</span></span> <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>emp_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre> 
<h4><a id="_subTables__370"></a>②配置 subTables 属性</h4> 
<ul><li>所在位置：schema.xml 配置文件中 schema 标签的子标签 table 的 subTables 属性。</li><li>属性值设置方式： 
  <ul><li>单个值：t_user</li><li>多个值： 
    <ul><li>将多个物理表名称用逗号隔开：t_user1,t_user2,t_user3</li><li>使用正则表达式格式指定数值区间：t_user$1-5</li><li>将多个用区间表示的物理表名称用逗号隔开：t_user$1-5,t_user$7-10</li></ul> </li></ul> </li></ul> 
<h4><a id="_380"></a>③配置拆分规则</h4> 
<ul><li>在 schema.xml 中配置 rule 属性</li></ul> 
<p>在 table 标签中通过 rule 属性指定规则名称即可。当前取模分片的名称是 mod-lang，这些规则名称是在 rule.xml 中定义的。</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!-- 取模分片 --&gt;</span>
<span class="token comment">&lt;!-- 配置 1：通过 subTables 属性指定物理表 --&gt;</span>
<span class="token comment">&lt;!-- 配置 2：通过 rule 属性指定拆分规则 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>virtual_t_emp<span class="token punctuation">"</span></span>
	   <span class="token attr-name">primaryKey</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>emp_id<span class="token punctuation">"</span></span>
	   <span class="token attr-name">dataNode</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>data-node-hello<span class="token punctuation">"</span></span>
	   <span class="token attr-name">autoIncrement</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
	   <span class="token attr-name">fetchStoreNodeByJdbc</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
	   <span class="token attr-name">subTables</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>t_emp$1-3<span class="token punctuation">"</span></span>
	   <span class="token attr-name">rule</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mod-long<span class="token punctuation">"</span></span>
<span class="token punctuation">/&gt;</span></span>
</code></pre> 
<ul><li> <p>在 rule.xml 中配置 mod-long 规则</p> 
  <ul><li>配置 tableRule 标签</li></ul> <pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tableRule</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mod-long<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span><span class="token punctuation">&gt;</span></span>
		<span class="token comment">&lt;!-- 指定用于执行取模分片的字段 --&gt;</span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>columns</span><span class="token punctuation">&gt;</span></span>emp_id<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>columns</span><span class="token punctuation">&gt;</span></span>
		
		<span class="token comment">&lt;!-- 具体规则名称 --&gt;</span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>algorithm</span><span class="token punctuation">&gt;</span></span>mod-long<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>algorithm</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tableRule</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
  <ul><li>配置 function 标签</li></ul> <pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>function</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mod-long<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>io.mycat.route.function.PartitionByMod<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!-- 物理表的数量，需要正好就是取模的数值 --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>count<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>function</span><span class="token punctuation">&gt;</span></span>
</code></pre> </li></ul> 
<h4><a id="_MyCat_429"></a>④重启 MyCat</h4> 
<p>MyCat 配置文件修改后重启 MyCat 程序才能够生效。</p> 
<h3><a id="3_433"></a>3、测试</h3> 
<h4><a id="_435"></a>①数据存储操作</h4> 
<pre><code class="prism language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> virtual_t_emp<span class="token punctuation">(</span>emp_id<span class="token punctuation">,</span> emp_name<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'tom01'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> virtual_t_emp<span class="token punctuation">(</span>emp_id<span class="token punctuation">,</span> emp_name<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'tom02'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> virtual_t_emp<span class="token punctuation">(</span>emp_id<span class="token punctuation">,</span> emp_name<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'tom03'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> virtual_t_emp<span class="token punctuation">(</span>emp_id<span class="token punctuation">,</span> emp_name<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'tom04'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> virtual_t_emp<span class="token punctuation">(</span>emp_id<span class="token punctuation">,</span> emp_name<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'tom05'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>数据插入后，请打开物理表查看是否分流到了三个物理表。</p> 
<ul><li> <p>t_emp1</p> <p>emp_id emp_name</p> <p>3 tom03</p> </li><li> <p>t_emp2</p> <p>emp_id emp_name</p> <p>1 tom01<br> 4 tom04</p> </li><li> <p>t_emp3</p> <p>emp_id emp_name</p> <p>2 tom02<br> 5 tom05</p> </li></ul> 
<h4><a id="_469"></a>②数据查询操作</h4> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> emp_id<span class="token punctuation">,</span>emp_name <span class="token keyword">FROM</span> virtual_t_emp <span class="token keyword">WHERE</span> emp_id<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">;</span>
</code></pre> 
<p>效果：</p> 
<p>emp_id emp_name</p> 
<pre><code>   4      tom04     
</code></pre> 
<h3><a id="4_483"></a>4、注意</h3> 
<p>如果在 insert 语句中没有指定 emp_id 字段，则有下面的报错：</p> 
<p><img src="https://images2.imgbox.com/3c/18/gwX5SV4V_o.png" alt="images"></p> 
<h2><a id="_id__491"></a>②全局 id 分片</h2> 
<p>[点击返回](# 2、数据分片的具体算法)</p> 
<h3><a id="1_495"></a>1、理解</h3> 
<p>全局 id 分片和上面的取模分片就一个区别：id 的来源不同。</p> 
<ul><li>取模分片：由程序员提供 id 值。</li><li>全局 id 分片：由 MyCat 提供 id 值。</li></ul> 
<p><img src="https://images2.imgbox.com/a4/af/iDr9iMIf_o.png" alt="images"></p> 
<p>具体来说，MyCat 提供 id 值有下面这些办法：</p> 
<ul><li>基于本地文件</li><li>基于数据库</li><li>基于 zookeeper</li><li>基于时间戳</li></ul> 
<h3><a id="2_511"></a>2、操作</h3> 
<h4><a id="_513"></a>①基于本地文件</h4> 
<h5><a id="_sequence_confproperties_515"></a>第一步：配置 sequence_conf.properties</h5> 
<p>文件位置：</p> 
<p><img src="https://images2.imgbox.com/50/5a/M8m2w8p2_o.png" alt="images"></p> 
<p>配置内容：</p> 
<pre><code class="prism language-properties"># 使用过的历史分段，可不配置
USER.HISIDS=

# ID 的起始值，从这个值开始生成 ID
USER.MINID=1

# 最大ID值
USER.MAXID=200000

# 当前ID值
USER.CURID=1000
</code></pre> 
<p>配置中属性名前缀的作用：</p> 
<p><img src="https://images2.imgbox.com/59/a7/s5F02WzU_o.png" alt="images"></p> 
<h5><a id="_serverxml_543"></a>第二步：配置 server.xml</h5> 
<p>指定全局 id 分片具体使用的 id 生成方式。</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!--设置全局序号生成方式
   0：文件
   1：数据库
   2：时间戳
   3：zookeeper
  --&gt;</span>
<span class="token comment">&lt;!--必须带有MYCATSEQ_或者 mycatseq_进入序列匹配流程 注意MYCATSEQ_有空格的情况--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sequenceHandlerType<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h5><a id="_560"></a>第三步：测试</h5> 
<p>别忘记重启 MyCat。</p> 
<pre><code class="prism language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> virtual_t_emp<span class="token punctuation">(</span>emp_id<span class="token punctuation">,</span> emp_name<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'next value for MYCATSEQ_EMP'</span><span class="token punctuation">,</span> <span class="token string">'jerry01'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> virtual_t_emp<span class="token punctuation">(</span>emp_id<span class="token punctuation">,</span> emp_name<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'next value for MYCATSEQ_EMP'</span><span class="token punctuation">,</span> <span class="token string">'jerry02'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> virtual_t_emp<span class="token punctuation">(</span>emp_id<span class="token punctuation">,</span> emp_name<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'next value for MYCATSEQ_EMP'</span><span class="token punctuation">,</span> <span class="token string">'jerry03'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> virtual_t_emp<span class="token punctuation">(</span>emp_id<span class="token punctuation">,</span> emp_name<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'next value for MYCATSEQ_EMP'</span><span class="token punctuation">,</span> <span class="token string">'jerry04'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> virtual_t_emp<span class="token punctuation">(</span>emp_id<span class="token punctuation">,</span> emp_name<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'next value for MYCATSEQ_EMP'</span><span class="token punctuation">,</span> <span class="token string">'jerry05'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_574"></a>②基于数据库</h4> 
<h5><a id="_576"></a>第一步：在物理库建表</h5> 
<p>使用 MyCat 提供的一个 SQL 文件：</p> 
<p><img src="https://images2.imgbox.com/fa/90/cErDDL8H_o.png" alt="images"></p> 
<p>执行的效果：</p> 
<p><img src="https://images2.imgbox.com/6a/73/uptamWth_o.png" alt="images"></p> 
<h5><a id="_MYCAT_SEQUENCE__586"></a>第二步：在 MYCAT_SEQUENCE 表中增加一条记录</h5> 
<p><img src="https://images2.imgbox.com/41/95/K276rpWO_o.png" alt="images"></p> 
<h5><a id="_sequence_db_confproperties_590"></a>第三步：配置 sequence_db_conf.properties</h5> 
<p>文件位置：</p> 
<p><img src="https://images2.imgbox.com/34/54/LWVdfP6R_o.png" alt="images"></p> 
<p>配置内容：</p> 
<pre><code class="prism language-properties">EMP_INCR=data-node-hello
</code></pre> 
<p>属性名和其他配置的关系：</p> 
<p><img src="https://images2.imgbox.com/9a/aa/AJNGO8mc_o.png" alt="images"></p> 
<h5><a id="_serverxml_608"></a>第四步：配置 server.xml</h5> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!-- 指定全局 id 分片方式 --&gt;</span>
<span class="token comment">&lt;!-- 	0 表示基于文件 --&gt;</span>
<span class="token comment">&lt;!-- 	1 表示基于数据库 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sequenceHandlerType<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h5><a id="_MyCat_619"></a>第五步：重启 MyCat</h5> 
<p>略。</p> 
<h5><a id="_623"></a>第六步：测试</h5> 
<pre><code class="prism language-sql"><span class="token keyword">USE</span> virtual<span class="token operator">-</span>db<span class="token operator">-</span>hello<span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> virtual_t_emp<span class="token punctuation">(</span>emp_id<span class="token punctuation">,</span> emp_name<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'next value for MYCATSEQ_EMP_INCR'</span><span class="token punctuation">,</span> <span class="token string">'kate01'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> virtual_t_emp<span class="token punctuation">(</span>emp_id<span class="token punctuation">,</span> emp_name<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'next value for MYCATSEQ_EMP_INCR'</span><span class="token punctuation">,</span> <span class="token string">'kate02'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> virtual_t_emp<span class="token punctuation">(</span>emp_id<span class="token punctuation">,</span> emp_name<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'next value for MYCATSEQ_EMP_INCR'</span><span class="token punctuation">,</span> <span class="token string">'kate03'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> virtual_t_emp<span class="token punctuation">(</span>emp_id<span class="token punctuation">,</span> emp_name<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'next value for MYCATSEQ_EMP_INCR'</span><span class="token punctuation">,</span> <span class="token string">'kate04'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> virtual_t_emp<span class="token punctuation">(</span>emp_id<span class="token punctuation">,</span> emp_name<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'next value for MYCATSEQ_EMP_INCR'</span><span class="token punctuation">,</span> <span class="token string">'kate05'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> emp_id<span class="token punctuation">,</span>emp_name <span class="token keyword">FROM</span> virtual_t_emp<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_639"></a>③基于时间戳</h4> 
<h5><a id="_serverxml_641"></a>第一步：配置 server.xml</h5> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!-- 指定全局 id 分片方式 --&gt;</span>
<span class="token comment">&lt;!-- 	0 表示基于文件 --&gt;</span>
<span class="token comment">&lt;!-- 	1 表示基于数据库 --&gt;</span>
<span class="token comment">&lt;!-- 	2 表示基于时间戳 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sequenceHandlerType<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h5><a id="_sequence_time_confproperties_653"></a>第二步：配置 sequence_time_conf.properties</h5> 
<p>WORKID 与 DATAACENTERID 都是 0-31 任意整数。多 mycat 节点下，每个节点的 WORKID、DATAACENTERID 不能重复，组成唯一标识，总共支持 32*32=1024 种组合。</p> 
<p><img src="https://images2.imgbox.com/55/9a/JrMG4AxV_o.png" alt="images"></p> 
<h5><a id="_emp_id__659"></a>第三步：修改物理表 emp_id 字段宽度</h5> 
<p>基于时间戳的方式将使用时间戳数值作为 emp_id 值，必须使用 bigint 类型。</p> 
<p><img src="https://images2.imgbox.com/78/91/AKmaZj6D_o.png" alt="images"></p> 
<h5><a id="_MyCat_665"></a>第四步：重启 MyCat</h5> 
<p>略。</p> 
<h5><a id="_669"></a>第五步：测试</h5> 
<p>next value for MYCATSEQ_ 后面可以随便写。</p> 
<pre><code class="prism language-sql"><span class="token keyword">USE</span> virtual<span class="token operator">-</span>db<span class="token operator">-</span>hello<span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> virtual_t_emp<span class="token punctuation">(</span>emp_id<span class="token punctuation">,</span> emp_name<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'next value for MYCATSEQ_FOO'</span><span class="token punctuation">,</span> <span class="token string">'BOB01'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> virtual_t_emp<span class="token punctuation">(</span>emp_id<span class="token punctuation">,</span> emp_name<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'next value for MYCATSEQ_FOO'</span><span class="token punctuation">,</span> <span class="token string">'BOB02'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> virtual_t_emp<span class="token punctuation">(</span>emp_id<span class="token punctuation">,</span> emp_name<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'next value for MYCATSEQ_FOO'</span><span class="token punctuation">,</span> <span class="token string">'BOB03'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> virtual_t_emp<span class="token punctuation">(</span>emp_id<span class="token punctuation">,</span> emp_name<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'next value for MYCATSEQ_FOO'</span><span class="token punctuation">,</span> <span class="token string">'BOB04'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> virtual_t_emp<span class="token punctuation">(</span>emp_id<span class="token punctuation">,</span> emp_name<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'next value for MYCATSEQ_FOO'</span><span class="token punctuation">,</span> <span class="token string">'BOB05'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> emp_id<span class="token punctuation">,</span>emp_name <span class="token keyword">FROM</span> virtual_t_emp<span class="token punctuation">;</span>
</code></pre> 
<h2><a id="_687"></a>③枚举分片</h2> 
<p>[点击返回](# 2、数据分片的具体算法)</p> 
<h3><a id="1_691"></a>1、理解</h3> 
<p><img src="https://images2.imgbox.com/fa/b7/cirXBmWD_o.png" alt="images"></p> 
<h3><a id="2_695"></a>2、操作</h3> 
<h4><a id="_697"></a>第一步：创建数据库和表</h4> 
<p>在物理库所在的服务器上执行下面的 SQL 语句：</p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token identifier"><span class="token punctuation">`</span>db_hr_male<span class="token punctuation">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token identifier"><span class="token punctuation">`</span>db_hr_female<span class="token punctuation">`</span></span><span class="token punctuation">;</span> 
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>db_hr_female<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>t_emp<span class="token punctuation">`</span></span> <span class="token punctuation">(</span> <span class="token identifier"><span class="token punctuation">`</span>emp_id<span class="token punctuation">`</span></span> <span class="token keyword">INT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>emp_name<span class="token punctuation">`</span></span> <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>emp_gender<span class="token punctuation">`</span></span> <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>emp_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>db_hr_male<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>t_emp<span class="token punctuation">`</span></span> <span class="token punctuation">(</span> <span class="token identifier"><span class="token punctuation">`</span>emp_id<span class="token punctuation">`</span></span> <span class="token keyword">INT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>emp_name<span class="token punctuation">`</span></span> <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>emp_gender<span class="token punctuation">`</span></span> <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>emp_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_dataNode_710"></a>第二步：创建新的 dataNode</h4> 
<p>在 schema.xml 配置文件中增加配置：</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dataNode</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>data-node-male<span class="token punctuation">"</span></span> <span class="token attr-name">dataHost</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>virtual-host-hello<span class="token punctuation">"</span></span> <span class="token attr-name">database</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>db_hr_male<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dataNode</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>data-node-female<span class="token punctuation">"</span></span> <span class="token attr-name">dataHost</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>virtual-host-hello<span class="token punctuation">"</span></span> <span class="token attr-name">database</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>db_hr_female<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre> 
<h4><a id="_table__721"></a>第三步：配置 table 标签</h4> 
<p>在 schema.xml 配置文件中修改配置：</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!-- 枚举分片 --&gt;</span>
<span class="token comment">&lt;!-- 配置 1：将虚拟表名称设置为和物理表一样（物理表是分别放在不同物理库中的同名的表）。 --&gt;</span>
<span class="token comment">&lt;!-- 配置 2：让 dataNode 属性指向枚举分片涉及到的多个数据节点 --&gt;</span>
<span class="token comment">&lt;!-- 配置 3：去掉 subTables 属性 --&gt;</span>
<span class="token comment">&lt;!-- 配置 4：拆分规则改成 sharding-by-intfile --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>t_emp<span class="token punctuation">"</span></span>
	   <span class="token attr-name">primaryKey</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>emp_id<span class="token punctuation">"</span></span>
	   <span class="token attr-name">dataNode</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>data-node-male,data-node-female<span class="token punctuation">"</span></span>
	   <span class="token attr-name">autoIncrement</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
	   <span class="token attr-name">fetchStoreNodeByJdbc</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
	   <span class="token attr-name">rule</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sharding-by-intfile<span class="token punctuation">"</span></span>
<span class="token punctuation">/&gt;</span></span>
</code></pre> 
<h4><a id="_rulexml_742"></a>第四步：配置 rule.xml</h4> 
<ul><li>先配置 tableRule 标签</li></ul> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tableRule</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sharding-by-intfile<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span><span class="token punctuation">&gt;</span></span>
		<span class="token comment">&lt;!-- 指定提供枚举值的字段 --&gt;</span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>columns</span><span class="token punctuation">&gt;</span></span>emp_gender<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>columns</span><span class="token punctuation">&gt;</span></span>
		
		<span class="token comment">&lt;!-- 具体算法 --&gt;</span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>algorithm</span><span class="token punctuation">&gt;</span></span>hash-int<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>algorithm</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tableRule</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<ul><li>再配置 function 标签</li></ul> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>function</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hash-int<span class="token punctuation">"</span></span>
		  <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>io.mycat.route.function.PartitionByFileMap<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

	<span class="token comment">&lt;!-- 指定另外一个配置文件，配置枚举值和数据节点之间的对应关系 --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mapFile<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>partition-hash-int.txt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>

	<span class="token comment">&lt;!--type 属性：指定枚举值类型。默认值为0，0表示Integer，非零表示String --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>type<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>

	<span class="token comment">&lt;!--defaultNode 当有一些特殊数据信息可以存放于默认节点中，如即不是male也不是female。默认节点：小于0表示不设置默认节点，大于等于0表示设置默认节点,不能解析的枚举就存到默认节点--&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>defaultNode<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>function</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h4><a id="_partitionhashinttxt_779"></a>第五步：配置 partition-hash-int.txt</h4> 
<pre><code class="prism language-txt">#代表第一个datanode
male=0

#代表第二个datanode
female=1
</code></pre> 
<h3><a id="3_789"></a>3、测试</h3> 
<pre><code class="prism language-SQL">USE virtualDB;

INSERT INTO t_emp(emp_id, emp_name,emp_gender) VALUES (1, 'tom','male');
INSERT INTO t_emp(emp_id, emp_name,emp_gender) VALUES (2, 'kate','female');
</code></pre> 
<h3><a id="4_798"></a>4、注意点</h3> 
<ul><li>table 标签中不写 subTables 属性，原因是对照枚举规则之后，不同的数据进入了不同数据库中。在各自数据库中的表名是相同的。</li><li>在 partition-hash-int.txt 文件中，0 和 1 这些值表示序号，这个序号对应 table 标签中 dataNode 属性值中 dataNode 名称的顺序。比如：dataNode=“dn-docker-female,dn-docker-male” 这个例子中，dn-docker-female 的序号是 0，dn-docker-male 的序号是 1。</li></ul> 
<h2><a id="_hash__803"></a>④固定 hash 分片</h2> 
<p>[点击返回](# 2、数据分片的具体算法)</p> 
<h3><a id="1_807"></a>1、理解</h3> 
<p><img src="https://images2.imgbox.com/7a/c7/uchJRkIv_o.png" alt="images"></p> 
<h3><a id="2_811"></a>2、操作</h3> 
<h4><a id="_schemaxml_813"></a>第一步：配置 schema.xml</h4> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!-- 固定 hash 分配 --&gt;</span>
<span class="token comment">&lt;!-- 配置 rule 属性：partition-by-fixed-hash --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>t_emp<span class="token punctuation">"</span></span>
	   <span class="token attr-name">primaryKey</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>emp_id<span class="token punctuation">"</span></span>
	   <span class="token attr-name">dataNode</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>data-node-male,data-node-female<span class="token punctuation">"</span></span>
	   <span class="token attr-name">autoIncrement</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
	   <span class="token attr-name">fetchStoreNodeByJdbc</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
	   <span class="token attr-name">rule</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>partition-by-fixed-hash<span class="token punctuation">"</span></span>
<span class="token punctuation">/&gt;</span></span>
</code></pre> 
<h4><a id="_rulexml_829"></a>第二步：配置 rule.xml</h4> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tableRule</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>partition-by-fixed-hash<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span><span class="token punctuation">&gt;</span></span>
		<span class="token comment">&lt;!-- 指定执行 hash 运算的字段 --&gt;</span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>columns</span><span class="token punctuation">&gt;</span></span>emp_id<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>columns</span><span class="token punctuation">&gt;</span></span>
		
		<span class="token comment">&lt;!-- 具体算法 --&gt;</span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>algorithm</span><span class="token punctuation">&gt;</span></span>partition-by-fixed-hash<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>algorithm</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tableRule</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!--
  partitionCount: 各分片空间中节点的数量。格式是：m,n
  partitionLength: 每个分片空间中分配的范围大小。格式是：x,y
	计算公式是：m * x + n * y = 1024
	当前配置：1 * 256 + 1 * 768 = 1024
 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>function</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>partition-by-fixed-hash<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>io.mycat.route.function.PartitionByLong<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>partitionCount<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>1,1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>partitionLength<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>256,768<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>function</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h3><a id="3_856"></a>3、测试</h3> 
<pre><code class="prism language-sql"><span class="token keyword">USE</span> virtual<span class="token operator">-</span>db<span class="token operator">-</span>hello<span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_emp<span class="token punctuation">(</span>emp_id<span class="token punctuation">,</span>emp_name<span class="token punctuation">,</span>emp_gender<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token string">'harry07'</span><span class="token punctuation">,</span><span class="token string">'male'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_emp<span class="token punctuation">(</span>emp_id<span class="token punctuation">,</span>emp_name<span class="token punctuation">,</span>emp_gender<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span><span class="token string">'harry08'</span><span class="token punctuation">,</span><span class="token string">'male'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_emp<span class="token punctuation">(</span>emp_id<span class="token punctuation">,</span>emp_name<span class="token punctuation">,</span>emp_gender<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">120</span><span class="token punctuation">,</span><span class="token string">'harry09'</span><span class="token punctuation">,</span><span class="token string">'male'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_emp<span class="token punctuation">(</span>emp_id<span class="token punctuation">,</span>emp_name<span class="token punctuation">,</span>emp_gender<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">360</span><span class="token punctuation">,</span><span class="token string">'rose05'</span><span class="token punctuation">,</span><span class="token string">'female'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_emp<span class="token punctuation">(</span>emp_id<span class="token punctuation">,</span>emp_name<span class="token punctuation">,</span>emp_gender<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">1780</span><span class="token punctuation">,</span><span class="token string">'rose06'</span><span class="token punctuation">,</span><span class="token string">'female'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h2><a id="_870"></a>⑤固定范围分片</h2> 
<p>[点击返回](# 2、数据分片的具体算法)</p> 
<h3><a id="1_874"></a>1、理解</h3> 
<p><img src="https://images2.imgbox.com/b3/19/U1i9OBmq_o.png" alt="images"></p> 
<h3><a id="2_878"></a>2、操作</h3> 
<h4><a id="_schemaxml_880"></a>①配置 schema.xml</h4> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!-- 固定范围分片 --&gt;</span>
<span class="token comment">&lt;!-- 配置 rule 属性：auto-sharding-long --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>t_emp<span class="token punctuation">"</span></span>
	   <span class="token attr-name">primaryKey</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>emp_id<span class="token punctuation">"</span></span>
	   <span class="token attr-name">dataNode</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>data-node-male,data-node-female<span class="token punctuation">"</span></span>
	   <span class="token attr-name">autoIncrement</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
	   <span class="token attr-name">fetchStoreNodeByJdbc</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
	   <span class="token attr-name">rule</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>auto-sharding-long<span class="token punctuation">"</span></span>
<span class="token punctuation">/&gt;</span></span>
</code></pre> 
<h4><a id="_rulexml_896"></a>②配置 rule.xml</h4> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tableRule</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>auto-sharding-long<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span><span class="token punctuation">&gt;</span></span>
		<span class="token comment">&lt;!-- 指定用于做 hash 运算的字段 --&gt;</span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>columns</span><span class="token punctuation">&gt;</span></span>emp_id<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>columns</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>algorithm</span><span class="token punctuation">&gt;</span></span>rang-long<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>algorithm</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tableRule</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h4><a id="_autopartitionlongtxt_910"></a>③配置 autopartition-long.txt</h4> 
<p><img src="https://images2.imgbox.com/68/74/ok2Mx1dP_o.png" alt="images"></p> 
<pre><code class="prism language-txt"># range start-end ,data node index
# K=1000,M=10000.
# 0-500M=0
# 500M-1000M=1
# 1000M-1500M=2

0-20=0
21-50=1
</code></pre> 
<h3><a id="3_927"></a>3、测试</h3> 
<pre><code class="prism language-sql"><span class="token keyword">USE</span> virtual<span class="token operator">-</span>db<span class="token operator">-</span>hello<span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_emp<span class="token punctuation">(</span>emp_id<span class="token punctuation">,</span>emp_name<span class="token punctuation">,</span>emp_gender<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'jack13'</span><span class="token punctuation">,</span><span class="token string">'male'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_emp<span class="token punctuation">(</span>emp_id<span class="token punctuation">,</span>emp_name<span class="token punctuation">,</span>emp_gender<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">'jack14'</span><span class="token punctuation">,</span><span class="token string">'male'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_emp<span class="token punctuation">(</span>emp_id<span class="token punctuation">,</span>emp_name<span class="token punctuation">,</span>emp_gender<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token string">'jack15'</span><span class="token punctuation">,</span><span class="token string">'male'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_emp<span class="token punctuation">(</span>emp_id<span class="token punctuation">,</span>emp_name<span class="token punctuation">,</span>emp_gender<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">35</span><span class="token punctuation">,</span><span class="token string">'rose09'</span><span class="token punctuation">,</span><span class="token string">'female'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_emp<span class="token punctuation">(</span>emp_id<span class="token punctuation">,</span>emp_name<span class="token punctuation">,</span>emp_gender<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">44</span><span class="token punctuation">,</span><span class="token string">'rose10'</span><span class="token punctuation">,</span><span class="token string">'female'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> emp_id<span class="token punctuation">,</span>emp_name<span class="token punctuation">,</span>emp_gender <span class="token keyword">FROM</span> t_emp<span class="token punctuation">;</span>
</code></pre> 
<h2><a id="_943"></a>⑥取模范围分片</h2> 
<p>[点击返回](# 2、数据分片的具体算法)</p> 
<h3><a id="1_947"></a>1、理解</h3> 
<p>取模后，根据范围决定数据节点。</p> 
<h3><a id="2_951"></a>2、操作</h3> 
<h4><a id="_schemaxml_953"></a>①配置 schema.xml</h4> 
<p>指定分片规则：sharding-by-partition</p> 
<h4><a id="_rulexml_957"></a>②配置 rule.xml</h4> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tableRule</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sharding-by-partition<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 指定用于取模的字段 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>columns</span><span class="token punctuation">&gt;</span></span>emp_id<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>columns</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>algorithm</span><span class="token punctuation">&gt;</span></span>sharding-by-partition<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>algorithm</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tableRule</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>function</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sharding-by-partition<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>io.mycat.route.function.PartitionByPattern<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 求模基数 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>patternValue<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>256<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    
    <span class="token comment">&lt;!-- 默认节点 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>defaultNode<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    
    <span class="token comment">&lt;!-- 指定规则配置文件 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mapFile<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>partition-pattern.txt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>function</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h4><a id="_partitionpatterntxt_980"></a>③配置 partition-pattern.txt</h4> 
<p>这个文件没有，需要我们自己建：</p> 
<pre><code class="prism language-txt">#0-128表示id%256后的数据范围。
0-128=0
129-256=1
</code></pre> 
<h3><a id="3_990"></a>3、测试</h3> 
<pre><code class="prism language-sql"><span class="token keyword">USE</span> virtual<span class="token operator">-</span>db<span class="token operator">-</span>hello<span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_emp<span class="token punctuation">(</span>emp_id<span class="token punctuation">,</span>emp_name<span class="token punctuation">,</span>emp_gender<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">,</span><span class="token string">'peter01'</span><span class="token punctuation">,</span><span class="token string">'male'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_emp<span class="token punctuation">(</span>emp_id<span class="token punctuation">,</span>emp_name<span class="token punctuation">,</span>emp_gender<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">,</span><span class="token string">'peter02'</span><span class="token punctuation">,</span><span class="token string">'male'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h2><a id="_hash__1001"></a>⑦字符串 hash 分片</h2> 
<p>[点击返回](# 2、数据分片的具体算法)</p> 
<h3><a id="1_1005"></a>1、理解</h3> 
<p>在业务场景下，有时可能会根据某个分片字段的前几个值来进行取模。如地址信息只取省份、姓名只取前一个字的姓等。此时则可以使用该种方式。</p> 
<p>其工作方式与取模范围分片类似，该分片方式支持数值、符号、字母取模。</p> 
<p>执行流程大致是：字符串截取→hash操作→取模→根据指定范围选择 DataNode</p> 
<h3><a id="2_1013"></a>2、操作</h3> 
<h5><a id="1_schemaxml_1015"></a>[1]配置 schema.xml</h5> 
<p>指定分片规则：sharding-by-string-hash</p> 
<h5><a id="2_rulexml_1019"></a>[2]配置 rule.xml</h5> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tableRule</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sharding-by-string-hash<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>columns</span><span class="token punctuation">&gt;</span></span>emp_name<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>columns</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>algorithm</span><span class="token punctuation">&gt;</span></span>sharding-by-string-hash-function<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>algorithm</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tableRule</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>function</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sharding-by-string-hash-function<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>io.mycat.route.function.PartitionByPrefixPattern<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 求模基数 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>patternValue<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>256<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    
    <span class="token comment">&lt;!-- 截取的位数 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>prefixLength<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    
    <span class="token comment">&lt;!-- 细节配置文件 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mapFile<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>partition-pattern-string-hash.txt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>function</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h5><a id="3_partitionpatternstringhashtxt_1043"></a>[3]配置 partition-pattern-string-hash.txt</h5> 
<pre><code class="prism language-txt">0-128=0
129-256=1
</code></pre> 
<h3><a id="3_1052"></a>3、测试</h3> 
<pre><code class="prism language-sql"><span class="token keyword">USE</span> virtual<span class="token operator">-</span>db<span class="token operator">-</span>hello<span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_emp<span class="token punctuation">(</span>emp_id<span class="token punctuation">,</span>emp_name<span class="token punctuation">,</span>emp_gender<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">88</span><span class="token punctuation">,</span><span class="token string">'ccccccc'</span><span class="token punctuation">,</span><span class="token string">'male'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_emp<span class="token punctuation">(</span>emp_id<span class="token punctuation">,</span>emp_name<span class="token punctuation">,</span>emp_gender<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">99</span><span class="token punctuation">,</span><span class="token string">'uvwxyz'</span><span class="token punctuation">,</span><span class="token string">'male'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h2><a id="_1063"></a>⑧时间分片</h2> 
<p>[点击返回](# 2、数据分片的具体算法)</p> 
<h3><a id="1_1067"></a>1、理解</h3> 
<p>根据时间、日期信息分片。</p> 
<h3><a id="2_1071"></a>2、操作</h3> 
<h4><a id="_1073"></a>①修改数据库表</h4> 
<p>给 t_emp 表增加 emp_birthday 字段。</p> 
<pre><code class="prism language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>db_hr_male<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>t_emp<span class="token punctuation">`</span></span> <span class="token keyword">ADD</span> <span class="token keyword">COLUMN</span> <span class="token identifier"><span class="token punctuation">`</span>emp_birthday<span class="token punctuation">`</span></span> <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">AFTER</span> <span class="token identifier"><span class="token punctuation">`</span>emp_gender<span class="token punctuation">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>db_hr_female<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>t_emp<span class="token punctuation">`</span></span> <span class="token keyword">ADD</span> <span class="token keyword">COLUMN</span> <span class="token identifier"><span class="token punctuation">`</span>emp_birthday<span class="token punctuation">`</span></span> <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">AFTER</span> <span class="token identifier"><span class="token punctuation">`</span>emp_gender<span class="token punctuation">`</span></span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_schemaxml_1082"></a>②配置 schema.xml</h4> 
<p>指定拆分规则：sharding-by-date</p> 
<h4><a id="_rulexml_1086"></a>③配置 rule.xml</h4> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tableRule</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sharding-by-date<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 指定用于分片的字段 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>columns</span><span class="token punctuation">&gt;</span></span>emp_birthday<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>columns</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>algorithm</span><span class="token punctuation">&gt;</span></span>partbyday<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>algorithm</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tableRule</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>function</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>partbyday<span class="token punctuation">"</span></span>
          <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>io.mycat.route.function.PartitionByDate<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- 日期格式 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dateFormat<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>yyyy-MM-dd<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- 支持自然日分区属性 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sNaturalDay<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>

	<span class="token comment">&lt;!-- 开始日期 --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sBeginDate<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>2014-06-01<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>

	<span class="token comment">&lt;!-- 结束日期 --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sEndDate<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>2014-06-30<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>

	<span class="token comment">&lt;!-- 每隔几天算一个分片 --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sPartionDay<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>15<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>function</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h3><a id="3_1119"></a>3、测试</h3> 
<pre><code class="prism language-sql"><span class="token keyword">USE</span> virtual<span class="token operator">-</span>db<span class="token operator">-</span>hello<span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_emp<span class="token punctuation">(</span>emp_id<span class="token punctuation">,</span>emp_birthday<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">666</span><span class="token punctuation">,</span> <span class="token string">'2014-06-10'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_emp<span class="token punctuation">(</span>emp_id<span class="token punctuation">,</span>emp_birthday<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">777</span><span class="token punctuation">,</span> <span class="token string">'2014-06-25'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h2><a id="_hash__1128"></a>⑨一致性 hash 分片</h2> 
<p>[点击返回](# 2、数据分片的具体算法)</p> 
<h3><a id="1_1132"></a>1、理解</h3> 
<h4><a id="_1134"></a>①目的</h4> 
<p>最大限度的让数据均匀分布</p> 
<h4><a id="_1138"></a>②原理</h4> 
<p>一致性 hash 算法引入了 hash 环的概念。环的大小是 0~2^32-1。首先通过 crc16 算法计算出数据节点在 hash 环中的位置。</p> 
<p><img src="https://images2.imgbox.com/40/7b/ML0ibRWw_o.png" alt="images"></p> 
<p>当存储数据时，也会采用同样的算法，计算出数据key的hash值，映射到hash环上。</p> 
<p><img src="https://images2.imgbox.com/c9/8b/NJdJIcCt_o.png" alt="images"></p> 
<p>然后从数据映射的位置开始，以顺时针的方式找出距离最近的数据节点，接着将数据存入到该节点中。</p> 
<p><img src="https://images2.imgbox.com/e0/c7/UJnKbl92_o.png" alt="images"></p> 
<p>此时可以发现，数据并没有达到预期的数据均匀，可以发现如果两个数据节点在环上的距离，决定有大量数据存入了dataNode2，而仅有少量数据存入dataNode1。</p> 
<p>为了解决数据不均匀的问题，在mycat中可以设置<strong>虚拟数据映射节点</strong>。同时这些虚拟节点会映射到实际数据节点。</p> 
<p><img src="https://images2.imgbox.com/e6/e7/W1JbHyX7_o.png" alt="images"></p> 
<p>数据仍然以顺时针方式寻找数据节点，当找到最近的数据节点无论是实际还是虚拟，都会进行存储，如果是虚拟数据节点的话，最终会将数据保存到实际数据节点中。 从而尽量的使数据均匀分布。</p> 
<h3><a id="2_1160"></a>2、操作</h3> 
<h4><a id="_schemaxml_1162"></a>①配置 schema.xml</h4> 
<p>指定拆分规则：sharding-by-murmur</p> 
<h4><a id="_rulexml_1166"></a>②配置 rule.xml</h4> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tableRule</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sharding-by-murmur<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>columns</span><span class="token punctuation">&gt;</span></span>emp_id<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>columns</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>algorithm</span><span class="token punctuation">&gt;</span></span>murmur<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>algorithm</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tableRule</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>function</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>murmur<span class="token punctuation">"</span></span>
          <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>io.mycat.route.function.PartitionByMurmurHash<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!-- 默认是0即可 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>seed<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    
    <span class="token comment">&lt;!-- 要分片的数据库节点数量，必须指定，否则没法分片 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>count<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    
    <span class="token comment">&lt;!-- 一个实际的数据库节点被映射为这么多虚拟节点，默认是160倍，也就是虚拟节点数是物理节点数的160倍 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>virtualBucketTimes<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>160<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>function</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h3><a id="3_1191"></a>3、测试</h3> 
<pre><code class="prism language-sql"><span class="token keyword">USE</span> virtual<span class="token operator">-</span>db<span class="token operator">-</span>hello<span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_emp<span class="token punctuation">(</span>emp_id<span class="token punctuation">,</span>emp_name<span class="token punctuation">,</span>emp_gender<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">,</span><span class="token string">'eeeeeeeeeee'</span><span class="token punctuation">,</span><span class="token string">'male'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_emp<span class="token punctuation">(</span>emp_id<span class="token punctuation">,</span>emp_name<span class="token punctuation">,</span>emp_gender<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">888</span><span class="token punctuation">,</span><span class="token string">'ttttttttttt'</span><span class="token punctuation">,</span><span class="token string">'male'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7fd001a671004adb6aca21eff8bbe09c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">前端常用网址汇总（不断更新哦）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d8f1c83045392fdfa3164ee12be586f3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">索引和事务</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>