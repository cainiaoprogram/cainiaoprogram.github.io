<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux并发控制 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Linux并发控制" />
<meta property="og:description" content="为了解决多核心竞争临界资源问题，Linux提高多种方式用于处理竞态问题。
1. 整型原子操作 头文件：&lt;linux/atomic-fallback.h&gt;
设置原子变量的值 //设置原子变量的值为i void atomic_set(atomic_t *v, int i); //定义原子变量，并初始化为0 atomic_t v = ATOMIC_INIT(0); 获取原子变量的值 atomic_read(atomic_t *v); 原子变量加、减 void atomic_add(int i, atomic_t *v); void atomic_sub(int i, atomic_t *v); 原子变量自增、自减 void atomic_inc(atomic_t *v); void atomic_dec(atomic_t *v); 操作并测试
操作原子变量后，测试原子变量的值是否为0，为0返回true，否则返回false
int atomic_inc_and_test(atomic_t *v); int atomic_dec_and_test(atomic_t *c); int atomic_add_and_test(int i, atomic_t *v); int atomic_sub_and_test(int i, atomic_t *v); 操作并返回
操作原子变量后，返回原子变量的值
int atomic_add_return(int i, atomic_t *v); int atomic_sub_return(int i, atomic_t *v); int atomic_inc_return(atomic_t *v); int atomic_dec_return(atomic_t *v); 示例：一个设备文件同时只能被一个进程打开，使用整形原子操作实现" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/165713bc658a66bba7e8757029a26165/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-09-16T14:42:28+08:00" />
<meta property="article:modified_time" content="2021-09-16T14:42:28+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux并发控制</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>为了解决多核心竞争临界资源问题，Linux提高多种方式用于处理竞态问题。</p> 
<h4><a id="1__2"></a>1. 整型原子操作</h4> 
<blockquote> 
 <p>头文件：&lt;linux/atomic-fallback.h&gt;</p> 
</blockquote> 
<ol><li>设置原子变量的值</li></ol> 
<pre><code class="prism language-c">   <span class="token comment">//设置原子变量的值为i</span>
   <span class="token keyword">void</span> <span class="token function">atomic_set</span><span class="token punctuation">(</span><span class="token class-name">atomic_t</span> <span class="token operator">*</span>v<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//定义原子变量，并初始化为0</span>
   <span class="token class-name">atomic_t</span> v <span class="token operator">=</span> <span class="token function">ATOMIC_INIT</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="2"><li>获取原子变量的值</li></ol> 
<pre><code class="prism language-c"><span class="token function">atomic_read</span><span class="token punctuation">(</span><span class="token class-name">atomic_t</span> <span class="token operator">*</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="3"><li>原子变量加、减</li></ol> 
<pre><code class="prism language-c">   <span class="token keyword">void</span> <span class="token function">atomic_add</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token class-name">atomic_t</span> <span class="token operator">*</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">void</span> <span class="token function">atomic_sub</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token class-name">atomic_t</span> <span class="token operator">*</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="4"><li>原子变量自增、自减</li></ol> 
<pre><code class="prism language-c">   <span class="token keyword">void</span> <span class="token function">atomic_inc</span><span class="token punctuation">(</span><span class="token class-name">atomic_t</span> <span class="token operator">*</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">void</span> <span class="token function">atomic_dec</span><span class="token punctuation">(</span><span class="token class-name">atomic_t</span> <span class="token operator">*</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="5"><li> <p>操作并测试</p> <p>操作原子变量后，测试原子变量的值是否为0，为0返回true，否则返回false</p> </li></ol> 
<pre><code class="prism language-c">   <span class="token keyword">int</span> <span class="token function">atomic_inc_and_test</span><span class="token punctuation">(</span><span class="token class-name">atomic_t</span> <span class="token operator">*</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> <span class="token function">atomic_dec_and_test</span><span class="token punctuation">(</span><span class="token class-name">atomic_t</span> <span class="token operator">*</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> <span class="token function">atomic_add_and_test</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token class-name">atomic_t</span> <span class="token operator">*</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> <span class="token function">atomic_sub_and_test</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token class-name">atomic_t</span> <span class="token operator">*</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="6"><li> <p>操作并返回</p> <p>操作原子变量后，返回原子变量的值</p> </li></ol> 
<pre><code class="prism language-c">   <span class="token keyword">int</span> <span class="token function">atomic_add_return</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token class-name">atomic_t</span> <span class="token operator">*</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> <span class="token function">atomic_sub_return</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token class-name">atomic_t</span> <span class="token operator">*</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> <span class="token function">atomic_inc_return</span><span class="token punctuation">(</span><span class="token class-name">atomic_t</span> <span class="token operator">*</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> <span class="token function">atomic_dec_return</span><span class="token punctuation">(</span><span class="token class-name">atomic_t</span> <span class="token operator">*</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>示例：一个设备文件同时只能被一个进程打开，使用整形原子操作实现</p> 
<pre><code class="prism language-c"><span class="token comment">//能被多个进程同时打开的数量</span>
<span class="token keyword">static</span> <span class="token class-name">atomic_t</span> open_available <span class="token operator">=</span> <span class="token function">ATOMIC_INIT</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">xxx_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>flip<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">atomic_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>open_available<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">//可用数为0</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EBUSY<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//可被打开，可用数减1</span>
    <span class="token function">atomic_dec</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>open_available<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">xxx_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">//释放文件，可用数加1</span>
    <span class="token function">stomic_inc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>open_available<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="2__78"></a>2. 位原子操作</h4> 
<ol><li>设置位</li></ol> 
<pre><code class="prism language-c">   <span class="token comment">//设置addr地址的第nr位为1</span>
   <span class="token keyword">void</span> <span class="token function">set_bit</span><span class="token punctuation">(</span>nr<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="2"><li>清除位</li></ol> 
<pre><code class="prism language-c">  <span class="token comment">//清除addr地址的第nr位为0</span>
  <span class="token keyword">void</span> <span class="token function">clear_bit</span><span class="token punctuation">(</span>nr<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="3"><li>改变位</li></ol> 
<pre><code class="prism language-c">   <span class="token comment">//addr地址的第nr位取反</span>
   <span class="token keyword">void</span> <span class="token function">change_bit</span><span class="token punctuation">(</span>nr<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="4"><li>测试位</li></ol> 
<pre><code class="prism language-c">   <span class="token comment">//返回第nr位的值</span>
   <span class="token keyword">int</span> <span class="token function">test_bit</span><span class="token punctuation">(</span>nr<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="5"><li>测试并操作位</li></ol> 
<pre><code class="prism language-c">   <span class="token keyword">int</span> <span class="token function">test_and_set_bit</span><span class="token punctuation">(</span>nr<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> <span class="token function">test_and_clear_bit</span><span class="token punctuation">(</span>nr<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> <span class="token function">test_and_change_bit</span><span class="token punctuation">(</span>nr<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="3__116"></a>3. 自旋锁</h4> 
<p>自旋锁基础功能</p> 
<pre><code class="prism language-c"><span class="token comment">//定义自旋锁</span>
<span class="token class-name">spinlock_t</span> lock<span class="token punctuation">;</span>
<span class="token comment">//初始化自旋锁</span>
<span class="token function">spin_lock_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//获得自旋锁，获取成功立即返回，否则一直自选直到获取成功返回</span>
<span class="token function">spin_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//尝试获得自旋锁，获取成功返回true，否则返回false，不进行自旋</span>
<span class="token function">spin_trylock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//释放自旋锁</span>
<span class="token function">spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>以上自旋锁基本功能可以解决的临界资源使用的问题</p> 
<ol><li>多核CPU</li><li>抢占式任务调度单核CPU</li></ol> 
<p>但是还可能受到中断和底半部中断的影响，以下是中断和底半部中断相关的操作</p> 
<pre><code class="prism language-c"><span class="token comment">//开中断</span>
<span class="token function">local_irq_enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//关中断</span>
<span class="token function">local_irq_disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//关底半部</span>
<span class="token function">local_bh_disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//开底半部</span>
<span class="token function">local_bh_enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//关中断保存状态字</span>
<span class="token function">local_irq_save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//开中断保存状态字</span>
<span class="token function">local_irq_restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>从而衍生了自旋锁的整套机制</p> 
<pre><code class="prism language-c"><span class="token comment">//spin_lock() + local_irq_disable()</span>
<span class="token function">spin_lock_irq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//spin_unlock() + local_irq_enable()</span>
<span class="token function">spin_unlock_irq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//spin_lock() + local_irq_save()</span>
<span class="token function">spin_lock_irqsave</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//spin_unlock() + local_irq_restore()</span>
<span class="token function">spin_unlock_irqrestore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//spin_lock() + local_bh_disable()</span>
<span class="token function">spin_lock_bh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//spin_unlock() + local_bh_enable()</span>
<span class="token function">spin_unlock_bh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>在多核编程中，如果进程或中断可能访问同一片临界资源</p> 
<ol><li>在进程上下文中调用</li></ol> 
<pre><code class="prism language-c">   <span class="token function">spin_lock_irqsave</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">spin_unlock_irqrestore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="2"><li> <p>在中断上下文中调用</p> <p>linux2.6后取消了中断嵌套，所以在中断上下文只需要spin_lock即可</p> </li></ol> 
<pre><code class="prism language-c">   <span class="token function">spin_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">spin_unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>自旋锁应谨慎使用</p> 
<ol><li>自旋过程很消耗CPU资源</li><li>可能发生死锁</li></ol> 
<h4><a id="4__195"></a>4. 读写自旋锁</h4> 
<p>比自旋锁粒度更小，可分别对读和写进行锁定</p> 
<ol><li>定义和初始化</li></ol> 
<pre><code class="prism language-c">   <span class="token comment">//定义一个读写自旋锁</span>
   <span class="token class-name">rwlock_t</span> lock<span class="token punctuation">;</span>
   <span class="token comment">//初始化锁</span>
   <span class="token function">rwlock_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="2"><li>读锁定</li></ol> 
<pre><code class="prism language-c">   <span class="token keyword">void</span> <span class="token function">read_lock</span><span class="token punctuation">(</span><span class="token class-name">rwlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">void</span> <span class="token function">read_lock_irqsave</span><span class="token punctuation">(</span><span class="token class-name">rwlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">void</span> <span class="token function">read_lock_irq</span><span class="token punctuation">(</span><span class="token class-name">rwlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">void</span> <span class="token function">read_lock_bh</span><span class="token punctuation">(</span><span class="token class-name">rwlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="3"><li>读解锁</li></ol> 
<pre><code class="prism language-c">   <span class="token keyword">void</span> <span class="token function">read_unlock</span><span class="token punctuation">(</span><span class="token class-name">rwlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">void</span> <span class="token function">read_unlock_irqrestore</span><span class="token punctuation">(</span><span class="token class-name">rwlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">void</span> <span class="token function">read_unlock_irq</span><span class="token punctuation">(</span><span class="token class-name">rwlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">void</span> <span class="token function">read_unlock_bh</span><span class="token punctuation">(</span><span class="token class-name">rwlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>对共享资源进行读取之前，应先调用读锁定，完成后再调用读解锁</p> 
<ol start="4"><li>写锁定</li></ol> 
<pre><code class="prism language-c">   <span class="token keyword">void</span> <span class="token function">write_lock</span><span class="token punctuation">(</span><span class="token class-name">rwlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">void</span> <span class="token function">write_lock_irqsave</span><span class="token punctuation">(</span><span class="token class-name">rwlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">void</span> <span class="token function">write_lock_irq</span><span class="token punctuation">(</span><span class="token class-name">rwlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">void</span> <span class="token function">write_lock_bh</span><span class="token punctuation">(</span><span class="token class-name">rwlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="5"><li>写解锁</li></ol> 
<pre><code class="prism language-c">   <span class="token keyword">void</span> <span class="token function">write_unlock</span><span class="token punctuation">(</span><span class="token class-name">rwlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">void</span> <span class="token function">write_unlock_irqrestore</span><span class="token punctuation">(</span><span class="token class-name">rwlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">void</span> <span class="token function">write_unlock_irq</span><span class="token punctuation">(</span><span class="token class-name">rwlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">void</span> <span class="token function">write_unlock_bh</span><span class="token punctuation">(</span><span class="token class-name">rwlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>对共享资源进行写之前，应先调用写锁定，完成后再调用写解锁</p> 
<h4><a id="5__248"></a>5. 顺序锁</h4> 
<blockquote> 
 <ol><li>顺序锁是对读写锁的一种优化</li><li>顺序锁的读执行单元不会写执行单元阻塞</li><li>但是若读过程中，进行了写，则需要重复读，重复读可能执行多次</li><li>其实现方式是，把数据存为一个副本用于读，同时增加一个标志位用于标志读过程中是否进行了写操作</li></ol> 
</blockquote> 
<ol><li>获得顺序锁</li></ol> 
<pre><code class="prism language-c">   <span class="token keyword">void</span> <span class="token function">write_seqlock</span><span class="token punctuation">(</span><span class="token class-name">seqlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> <span class="token function">write_tryseqlock</span><span class="token punctuation">(</span><span class="token class-name">seqlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">write_seqlock_irqsave</span><span class="token punctuation">(</span><span class="token class-name">seqlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">write_seqlock_irq</span><span class="token punctuation">(</span><span class="token class-name">seqlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">write_seqlock_bh</span><span class="token punctuation">(</span><span class="token class-name">seqlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="2"><li>释放顺序锁</li></ol> 
<pre><code class="prism language-c">   <span class="token keyword">void</span> <span class="token function">write_sequnlock</span><span class="token punctuation">(</span><span class="token class-name">seqlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">write_sequnlock_irqrestore</span><span class="token punctuation">(</span><span class="token class-name">seqlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">write_sequnlock_irq</span><span class="token punctuation">(</span><span class="token class-name">seqlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">write_sequnlock_bh</span><span class="token punctuation">(</span><span class="token class-name">seqlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="3"><li>读开始</li></ol> 
<pre><code class="prism language-c">   <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">read_seqbegin</span><span class="token punctuation">(</span><span class="token class-name">seqlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">read_seqbegin_irqsave</span><span class="token punctuation">(</span><span class="token class-name">seqlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="4"><li>重读</li></ol> 
<pre><code class="prism language-c">   <span class="token keyword">int</span> <span class="token function">read_seqretry</span><span class="token punctuation">(</span><span class="token class-name">seqlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> iv<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">read_seqrettr_irqrestore</span><span class="token punctuation">(</span><span class="token class-name">seqlock_t</span> <span class="token operator">*</span>lock<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="6_RCU_290"></a>6. 读-复制-更新（RCU）</h4> 
<blockquote> 
 <p>Read-Copy-Update</p> 
 <p>读没有锁</p> 
 <p>写操作时，先复制一个副本，对这个副本进行写操作，最后把数据的指针指向这个写操作后的副本，这样所有CPU都能获取到最新的数据</p> 
 <p>适用于大量读，少量写的场景</p> 
 <p>写操作多进程同步开销较大，读几乎无额外的开销</p> 
</blockquote> 
<ol><li>读锁定</li></ol> 
<pre><code class="prism language-c">   <span class="token function">rcu_read_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">rcu_read_lock_bh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="2"><li>读解锁</li></ol> 
<pre><code class="prism language-c">   <span class="token function">rcu_read_unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">rcu_read_unlock_bh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="3"><li>同步RCU</li></ol> 
<pre><code class="prism language-c">   <span class="token function">synchronize_rcu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="7__326"></a>7. 信号量</h4> 
<p>信号量与进程的PV操作相对应</p> 
<pre><code class="prism language-c"><span class="token comment">//定义信号量</span>
<span class="token keyword">struct</span> <span class="token class-name">semaphore</span> sem<span class="token punctuation">;</span>
<span class="token comment">//初始化信号量，设置初值</span>
<span class="token keyword">void</span> <span class="token function">sema_init</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">semaphore</span> <span class="token operator">*</span>sem<span class="token punctuation">,</span> <span class="token keyword">int</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//获得信号量,阻塞直到获取成功</span>
<span class="token keyword">void</span> <span class="token function">down</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">semaphore</span> <span class="token operator">*</span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//获得信号量，阻塞直到获取成功，阻塞过程进程不会进入休眠,可以在中断中使用</span>
<span class="token keyword">int</span> <span class="token function">down_interrucptible</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//释放信号量</span>
<span class="token keyword">void</span> <span class="token function">up</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">semaphore</span> <span class="token operator">*</span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="8__343"></a>8. 互斥体</h4> 
<p>互斥体几乎和信号量一样</p> 
<pre><code class="prism language-c"><span class="token comment">//定义互斥体</span>
<span class="token keyword">struct</span> <span class="token class-name">mutex</span> mtx<span class="token punctuation">;</span>
<span class="token comment">//初始化</span>
<span class="token function">mutex_init</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mutex</span> <span class="token operator">*</span>mtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//获取互斥体</span>
<span class="token keyword">void</span> <span class="token function">metex_lock</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mutex</span> <span class="token operator">*</span>mtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">mutex_lock_interruptible</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mutex</span> <span class="token operator">*</span>mtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">mutex_trylock</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mutex</span> <span class="token operator">*</span>mtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//释放互斥体</span>
<span class="token keyword">void</span> <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mutex</span> <span class="token operator">*</span>mtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="9__360"></a>9. 完成量</h4> 
<p>Linux提高的完成量（Completion），用于一个执行单元等待另一个执行单元完成某件事情。</p> 
<pre><code class="prism language-c"><span class="token comment">//定义完成量</span>
<span class="token keyword">struct</span> <span class="token class-name">completion</span> cmp<span class="token punctuation">;</span>
<span class="token comment">//初始化</span>
<span class="token keyword">void</span> <span class="token function">init_completion</span><span class="token punctuation">(</span>completion <span class="token operator">*</span>cmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">reinit_completion</span><span class="token punctuation">(</span>completion <span class="token operator">*</span>cmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//等待完成量</span>
<span class="token keyword">void</span> <span class="token function">wait_for_completion</span><span class="token punctuation">(</span>completion <span class="token operator">*</span>cmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//唤醒完成量</span>
<span class="token keyword">void</span> <span class="token function">complete</span><span class="token punctuation">(</span>completion <span class="token operator">*</span>cmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">complete_all</span><span class="token punctuation">(</span>completion <span class="token operator">*</span>cmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2be3b8ef2bbad4c3f947a95d8fd9deeb/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">golang目录分层规范</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/cb986aa14fdecf278f77ce3f6eb709f9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">汇编语言：将AX中的数以无符号十进制形式输出显示。</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>