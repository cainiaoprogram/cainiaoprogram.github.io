<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>k8s中将flannel网络切换calico网络 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="k8s中将flannel网络切换calico网络" />
<meta property="og:description" content="注意事项： 1、kubelet 配置必须增加 --network-plugin=cni 选项
2、kubec-proxy 组件不能采用 --masquerade-all 启动，因为会与 Calico policy 冲突，并且需要加上–proxy-mode=ipvs（ipvs模式），–masquerade-all=true（表示ipvs proxier将伪装访问服务群集IP的所有流量,）
1、停止flanneld服务 yaml形式安装的flanneld切换calico 1、利用之前部署的flanneld文件删除掉flanneld网络
kubectl delete -f kube-flanneld.yaml 2、删除路由
我们删除网卡会自动删除这两个网卡的路由
ip link delete cnio ip link delete flannel.1 删掉其他路由
ip route delete 10.244.0.0/24 via 192.168.25.61 dev eth0 ip route delete 10.244.1.0/24 via 192.168.25.61 dev eth0 ip route 172.17.92.0/24 dev docker0 proto kernel scope link src 172.17.92.1 3、清除网络规则
iptables -F &amp;&amp; iptables -t nat -F &amp;&amp; iptables -t mangle -F &amp;&amp; iptables -X 二进制安装的flanneld切换calico 1、关闭flanneld服务" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/49c57585180508d5749bf8bd183b7f36/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-03-07T15:33:00+08:00" />
<meta property="article:modified_time" content="2021-03-07T15:33:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">k8s中将flannel网络切换calico网络</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_2"></a>注意事项：</h3> 
<p>1、kubelet 配置必须增加 --network-plugin=cni 选项<br> 2、kubec-proxy 组件不能采用 --masquerade-all 启动，因为会与 Calico policy 冲突，并且需要加上–proxy-mode=ipvs（ipvs模式），–masquerade-all=true（表示ipvs proxier将伪装访问服务群集IP的所有流量,）</p> 
<h2><a id="1flanneld_9"></a>1、停止flanneld服务</h2> 
<h3><a id="yamlflanneldcalico_10"></a>yaml形式安装的flanneld切换calico</h3> 
<p>1、利用之前部署的flanneld文件删除掉flanneld网络</p> 
<pre><code class="prism language-bash">kubectl delete -f kube-flanneld.yaml
</code></pre> 
<p>2、删除路由<br> 我们删除网卡会自动删除这两个网卡的路由</p> 
<pre><code class="prism language-bash">ip <span class="token function">link</span> delete cnio
ip <span class="token function">link</span> delete flannel.1
</code></pre> 
<p>删掉其他路由</p> 
<pre><code class="prism language-bash">ip route delete 10.244.0.0/24 via 192.168.25.61 dev eth0 
ip route delete 10.244.1.0/24 via 192.168.25.61 dev eth0 
ip route 172.17.92.0/24 dev docker0 proto kernel scope <span class="token function">link</span> src 172.17.92.1
</code></pre> 
<p>3、清除网络规则</p> 
<pre><code class="prism language-bash">iptables -F <span class="token operator">&amp;&amp;</span> iptables -t nat -F <span class="token operator">&amp;&amp;</span> iptables -t mangle -F <span class="token operator">&amp;&amp;</span> iptables -X
</code></pre> 
<h3><a id="flanneldcalico_39"></a>二进制安装的flanneld切换calico</h3> 
<p>1、关闭flanneld服务</p> 
<pre><code class="prism language-bash">systemctl stop flanneld.service
systemctl disable flanneld.service
</code></pre> 
<p>2、执行上面的删除路由和网络规则的动作</p> 
<p>3、修改docker.service文件</p> 
<pre><code class="prism language-bash"><span class="token function">vi</span> /usr/lib/systemd/system/docker.service
<span class="token comment">##删掉该行与flanneld相关的配置</span>
    EnvironmentFile<span class="token operator">=</span>/run/flannel/subnet.env
</code></pre> 
<p>重载并且重启</p> 
<pre><code class="prism language-bash">systemctl daemon-reload
systemctl restart docker
systemctl status docker
</code></pre> 
<p>此时k8s集群中已无网络规则</p> 
<h2><a id="2calico_68"></a>2、部署calico</h2> 
<p>参考与官网：https://docs.projectcalico.org/getting-started/kubernetes/self-managed-onprem/onpremises<br> 镜像由于在国外很难下载，这里提前在别处准备好并且打包过来在节点上用，<br> cdsn的calico离线镜像下载地址：https://download.csdn.net/download/qq_25611295/15633642<br> 下载部署文件：</p> 
<pre><code class="prism language-bash"><span class="token function">curl</span> https://docs.projectcalico.org/v3.9/manifests/calico-etcd.yaml -o calico.yaml
</code></pre> 
<p>镜像打包命令：</p> 
<pre><code class="prism language-bash">docker image save docker.io/calico/kube-controllers:v3.9.6 <span class="token operator">|</span><span class="token function">gzip</span> -9 <span class="token operator">&gt;</span>calico_kube-controllers.tar.gz
docker image save docker.io/calico/cni:v3.9.6<span class="token operator">|</span><span class="token function">gzip</span> -9 <span class="token operator">&gt;</span>calico_cni.tar.gz
docker image save docker.io/calico/pod2daemon-flexvol:v3.9.6<span class="token operator">|</span><span class="token function">gzip</span> -9 <span class="token operator">&gt;</span>pod2daemon-flexvol.tar.gz
docker image save docker.io/calico/node:v3.9.6<span class="token operator">|</span><span class="token function">gzip</span> -9 <span class="token operator">&gt;</span>calico_node.tar.gz
</code></pre> 
<p>具体步骤如下：<br> 配置连接etcd地址，如果使用https，还需要配置证书。（ConfigMap，Secret）<br> 根据实际网络规划修改Pod CIDR（CALICO_IPV4POOL_CIDR）<br> 选择工作模式（CALICO_IPV4POOL_IPIP），支持BGP，IPIP</p> 
<p>vi calico.yaml,找到下面行并修改<br> 1、calico.yaml中添加etd的ssl<br> etcd-key: (cat /opt/etcd/ssl/server-key.pem |base64 -w 0)<br> etcd-cert: (cat /opt/etcd/ssl/server.pem |base64 -w 0)<br> etcd-ca: (cat /opt/etcd/ssl/ca.pem |base64 -w 0)<br> 将对应的都添进去，将注释去掉:</p> 
<pre><code class="prism language-bash"><span class="token comment"># etcd-key: null     将对应ssl下的证书转换成base64编码放进来，并去掉注释</span>
<span class="token comment"># etcd-cert: null</span>
<span class="token comment"># etcd-ca: null</span>
</code></pre> 
<p>2、calico.yaml中指定secert的配置落地的位置，直接去掉注释就可以</p> 
<pre><code class="prism language-bash">  <span class="token comment"># You must also populate the Secret below with these files.</span>
  etcd_ca: <span class="token string">"/calico-secrets/etcd-ca"</span>
  etcd_cert: <span class="token string">"/calico-secrets/etcd-cert"</span>
  etcd_key: <span class="token string">"/calico-secrets/etcd-key"</span>
</code></pre> 
<p>3、calico.yaml中修改pod网段</p> 
<pre><code class="prism language-bash">name: CALICO_IPV4POOL_CIDR
           value: <span class="token string">"172.17.0.0/16"</span>
</code></pre> 
<p>4、calico.yaml中增加网卡匹配规则，防止calico默认找到错误的网卡，并更改calico的工作模式。</p> 
<pre><code>- name: IP_AUTODETECTION_METHOD
  value: "interface=ens.*"
# Auto-detect the BGP IP address.
- name: IP
  value: "autodetect"
# Enable IPIP
- name: CALICO_IPV4POOL_IPIP
  value: "Never"
</code></pre> 
<p>interface=ens.*表示匹配ens开头的网卡，这里我们用“Never”禁用掉IPIP模式则会用BGP模式，<br> 5、calico.yaml中指定etcd的地址字符串</p> 
<pre><code class="prism language-bash">etcd_endpoints: <span class="token string">"https://192.168.25.135:2379,https://192.168.25.136:2379,https://192.168.25.137:2379"</span>
</code></pre> 
<p>6、修改k8s组件相关的服务配置<br> kube-controller-manager：<br> CALICO_IPV4POOL_CIDR需要跟kube-controller-manager里面的配置一致，如果里面没有配置，需要添加。</p> 
<pre><code class="prism language-bash">--allocate-node-cidrs<span class="token operator">=</span>true \
--cluster-cidr<span class="token operator">=</span>172.17.0.0/16 \
</code></pre> 
<p>–allocate-node-cidrs表示是否应在云提供商上分配和设置Pod的CIDR<br> –cluster-cidr表示群集中Pod的CIDR范围。 要求–allocate-node-cidrs为true</p> 
<p>kube-apiserver</p> 
<pre><code class="prism language-bash">--allow-privileged<span class="token operator">=</span>true
</code></pre> 
<p>因为calico-node需要以特权模式运行在各Node上<br> kubelet</p> 
<pre><code class="prism language-bash">--network-plugin<span class="token operator">=</span>cni
</code></pre> 
<p>使用CNI网络插件</p> 
<p>7、部署calico</p> 
<pre><code class="prism language-bash">kubectl apply -f calico.yaml
</code></pre> 
<p>查看pod状态</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master yaml_file<span class="token punctuation">]</span><span class="token comment"># kubectl get pod  -n kube-system</span>
NAME                                       READY   STATUS    RESTARTS   AGE
calico-kube-controllers-6569d6fff8-77vw7   1/1     Running   0          12m
calico-node-58n68                          1/1     Running   0          12m
calico-node-r7plw                          1/1     Running   0          6m27s
calico-node-rttdk                          1/1     Running   0          12m
</code></pre> 
<p>此时路由表里面还不会有更新，需要把所有的pod全部重建才会生成新的路由规则，使用calico网络,<br> 所以更换网络是大事件，需要在夜深人静的时候操作。<br> 如果发现日志中出现：<br> E0306 15:38:19.830911 1 reflector.go:125] pkg/mod/k8s.io/client-go@v12.0.0+incompatible/tools/cache/reflector.go:98: Failed to list *v1.ServiceAccount: serviceaccounts is forbidden: User “system:serviceaccount:kube-system:calico-kube-controllers” cannot list resource “serviceaccounts” in API group “” at the cluster scope<br> 我们直接授权就行。</p> 
<pre><code class="prism language-bash">kubectl create clusterrolebinding add-on-cluster-admin --clusterrole<span class="token operator">=</span>cluster-admin --serviceaccount<span class="token operator">=</span>kube-system:calico-kube-controllers
</code></pre> 
<h2><a id="3Calico__196"></a>3、Calico 管理工具</h2> 
<p>下载工具：https://github.com/projectcalico/calicoctl/releases</p> 
<pre><code class="prism language-bash"><span class="token function">wget</span> -o /usr/bin/calicoctl https://github.com/projectcalico/calicoctl/releases/download/v3.9.6/calicoctl
<span class="token function">chmod</span> +x /usr/bin/calicoctl
</code></pre> 
<p>创建配置文件</p> 
<pre><code class="prism language-bash"><span class="token function">mkdir</span> /etc/calico
<span class="token punctuation">[</span>root@master calico<span class="token punctuation">]</span><span class="token comment"># cat /etc/calico/calicoctl.cfg</span>
apiVersion: projectcalico.org/v3
kind: CalicoAPIConfig
metadata:
spec:
  datastoreType: <span class="token string">"etcdv3"</span>
  etcdEndpoints: <span class="token string">"https://192.168.25.135:2379,https://192.168.25.136:2379,https://192.168.25.137:2379"</span>
  etcdKeyFile: <span class="token string">"/opt/etcd/ssl/server-key.pem"</span>
  etcdCertFile: <span class="token string">"/opt/etcd/ssl/server.pem"</span>
  etcdCACertFile: <span class="token string">"/opt/etcd/ssl/ca.pem"</span>
</code></pre> 
<p>常用命令<br> run命令可用于在该服务器上运行一个calico实例；<br> status命令可检查整个calico网络的状态；<br> diags用于手机calico节点的诊断信息；<br> checksystem命令用于检查改服务器是否可以运行一个calico实例。<br> 查询calico状态</p> 
<pre><code class="prism language-bash">calicoctl node status
<span class="token punctuation">[</span>root@master yaml_file<span class="token punctuation">]</span><span class="token comment"># calicoctl node status</span>
Calico process is running.

IPv4 BGP status
+----------------+-------------------+-------+----------+-------------+
<span class="token operator">|</span>  PEER ADDRESS  <span class="token operator">|</span>     PEER TYPE     <span class="token operator">|</span> STATE <span class="token operator">|</span>  SINCE   <span class="token operator">|</span>    INFO     <span class="token operator">|</span>
+----------------+-------------------+-------+----------+-------------+
<span class="token operator">|</span> 192.168.25.135 <span class="token operator">|</span> node-to-node mesh <span class="token operator">|</span> up    <span class="token operator">|</span> 06:38:41 <span class="token operator">|</span> Established <span class="token operator">|</span>
<span class="token operator">|</span> 192.168.25.136 <span class="token operator">|</span> node-to-node mesh <span class="token operator">|</span> up    <span class="token operator">|</span> 06:38:42 <span class="token operator">|</span> Established <span class="token operator">|</span>
<span class="token operator">|</span> 192.168.25.137 <span class="token operator">|</span> node-to-node mesh <span class="token operator">|</span> up    <span class="token operator">|</span> 06:38:44 <span class="token operator">|</span> Established 
</code></pre> 
<p>如果查询不到状态则尝试启动calico节点</p> 
<pre><code class="prism language-bash"> calicoctl node run
</code></pre> 
<p>如果是针对某个节点启动</p> 
<pre><code class="prism language-bash"> calicoctl node run --ip<span class="token operator">=</span>192.168.25.135
</code></pre> 
<p>其他的一些命令：<br> 查看节点：calicoctl get node<br> 查看ip池：calicoctl get ippool -o wide<br> 切换网络过程中总会出现各种奇葩的问题，网上很难找到解决方案，一般都是重启，删除node节点重新加入node节点，删除网络规则，重新安装calico 就解决了，所以非必要，还是不要切换网络，以免造成故障。</p> 
<p>calico常见排障地址：<br> https://docs.projectcalico.org/maintenance/troubleshoot/troubleshooting#configure-networkmanager</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c9ce097be4b394a66a6bb9de640811e3/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Cobalt Strike从入门到精通之Web Drive-By web钓鱼攻击</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2214e88c53e1d03de8aaa0aa8594615c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【CheatSheets】AI速查表集合 一图胜千言</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>