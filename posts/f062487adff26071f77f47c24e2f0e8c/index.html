<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>新年烟花代码-html版 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="新年烟花代码-html版" />
<meta property="og:description" content="新年烟花代码 效果展示 代码 &lt;!DOCTYPE html&gt; &lt;html lang=&#34;en&#34; &gt; &lt;head&gt; &lt;meta charset=&#34;UTF-8&#34;&gt; &lt;title&gt;2024新年快乐！万事如意！&lt;/title&gt; &lt;meta name=&#34;viewport&#34; content=&#34;width=device-width, initial-scale=1, user-scalable=no&#34;&gt; &lt;meta name=&#34;mobile-web-app-capable&#34; content=&#34;yes&#34;&gt; &lt;meta name=&#34;apple-mobile-web-app-capable&#34; content=&#34;yes&#34;&gt; &lt;meta name=&#34;theme-color&#34; content=&#34;#000000&#34;&gt; &lt;link rel=&#34;shortcut icon&#34; type=&#34;image/png&#34; href=&#34;https://s3-us-west-2.amazonaws.com/s.cdpn.io/329180/firework-burst-icon.png&#34;&gt; &lt;link rel=&#34;icon&#34; type=&#34;image/png&#34; href=&#34;https://s3-us-west-2.amazonaws.com/s.cdpn.io/329180/firework-burst-icon.png&#34;&gt; &lt;link rel=&#34;apple-touch-icon-precomposed&#34; href=&#34;https://s3-us-west-2.amazonaws.com/s.cdpn.io/329180/firework-burst-icon.png&#34;&gt; &lt;meta name=&#34;msapplication-TileColor&#34; content=&#34;#000000&#34;&gt; &lt;meta name=&#34;msapplication-TileImage&#34; content=&#34;https://s3-us-west-2.amazonaws.com/s.cdpn.io/329180/firework-burst-icon.png&#34;&gt; &lt;link href=&#34;https://fonts.googleapis.com/css?family=Russo&#43;One&#34; rel=&#34;stylesheet&#34;&gt;&lt;link rel=&#34;stylesheet&#34; href=&#34;https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css&#34;&gt; &lt;link rel=&#34;stylesheet&#34; href=&#34;./style.css&#34;&gt; &lt;style&gt; * { position: relative; box-sizing: border-box; } html, body { height: 100%; } html { background-color: #000; } body { overflow: hidden; color: rgba(255, 255, 255, 0." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/f062487adff26071f77f47c24e2f0e8c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-11T16:15:23+08:00" />
<meta property="article:modified_time" content="2024-01-11T16:15:23+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">新年烟花代码-html版</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>新年烟花代码</h2> 
<h3><a id="_1"></a>效果展示</h3> 
<p><img src="https://images2.imgbox.com/61/91/QgUemsAg_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_4"></a>代码</h3> 
<pre><code class="prism language-javascript"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token constant">DOCTYPE</span> html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">"en"</span> <span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">"UTF-8"</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span><span class="token number">2024</span>新年快乐！万事如意！<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string">"viewport"</span> content<span class="token operator">=</span><span class="token string">"width=device-width, initial-scale=1, user-scalable=no"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string">"mobile-web-app-capable"</span> content<span class="token operator">=</span><span class="token string">"yes"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string">"apple-mobile-web-app-capable"</span> content<span class="token operator">=</span><span class="token string">"yes"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string">"theme-color"</span> content<span class="token operator">=</span><span class="token string">"#000000"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>link rel<span class="token operator">=</span><span class="token string">"shortcut icon"</span> type<span class="token operator">=</span><span class="token string">"image/png"</span> href<span class="token operator">=</span><span class="token string">"https://s3-us-west-2.amazonaws.com/s.cdpn.io/329180/firework-burst-icon.png"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>link rel<span class="token operator">=</span><span class="token string">"icon"</span> type<span class="token operator">=</span><span class="token string">"image/png"</span> href<span class="token operator">=</span><span class="token string">"https://s3-us-west-2.amazonaws.com/s.cdpn.io/329180/firework-burst-icon.png"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>link rel<span class="token operator">=</span><span class="token string">"apple-touch-icon-precomposed"</span> href<span class="token operator">=</span><span class="token string">"https://s3-us-west-2.amazonaws.com/s.cdpn.io/329180/firework-burst-icon.png"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string">"msapplication-TileColor"</span> content<span class="token operator">=</span><span class="token string">"#000000"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string">"msapplication-TileImage"</span> content<span class="token operator">=</span><span class="token string">"https://s3-us-west-2.amazonaws.com/s.cdpn.io/329180/firework-burst-icon.png"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>link href<span class="token operator">=</span><span class="token string">"https://fonts.googleapis.com/css?family=Russo+One"</span> rel<span class="token operator">=</span><span class="token string">"stylesheet"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>link rel<span class="token operator">=</span><span class="token string">"stylesheet"</span> href<span class="token operator">=</span><span class="token string">"https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>link rel<span class="token operator">=</span><span class="token string">"stylesheet"</span> href<span class="token operator">=</span><span class="token string">"./style.css"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>style<span class="token operator">&gt;</span>
<span class="token operator">*</span> <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">position</span><span class="token operator">:</span> relative<span class="token punctuation">;</span>
  box<span class="token operator">-</span>sizing<span class="token operator">:</span> border<span class="token operator">-</span>box<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

html<span class="token punctuation">,</span>
body <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">100</span><span class="token operator">%</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

html <span class="token punctuation">{<!-- --></span>
  background<span class="token operator">-</span>color<span class="token operator">:</span> #<span class="token number">000</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

body <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">overflow</span><span class="token operator">:</span> hidden<span class="token punctuation">;</span>
  <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token function">rgba</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  font<span class="token operator">-</span>family<span class="token operator">:</span> <span class="token string">"Russo One"</span><span class="token punctuation">,</span> arial<span class="token punctuation">,</span> sans<span class="token operator">-</span>serif<span class="token punctuation">;</span>
  line<span class="token operator">-</span>height<span class="token operator">:</span> <span class="token number">1.25</span><span class="token punctuation">;</span>
  letter<span class="token operator">-</span>spacing<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">.</span>06em<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span>hide <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">opacity</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token literal-property property">visibility</span><span class="token operator">:</span> hidden<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span>remove <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">display</span><span class="token operator">:</span> none<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span>blur <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">filter</span><span class="token operator">:</span> <span class="token function">blur</span><span class="token punctuation">(</span>12px<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span>container <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">100</span><span class="token operator">%</span><span class="token punctuation">;</span>
  <span class="token literal-property property">display</span><span class="token operator">:</span> flex<span class="token punctuation">;</span>
  justify<span class="token operator">-</span>content<span class="token operator">:</span> center<span class="token punctuation">;</span>
  align<span class="token operator">-</span>items<span class="token operator">:</span> center<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

#loading<span class="token operator">-</span>init <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token number">100</span><span class="token operator">%</span><span class="token punctuation">;</span>
  align<span class="token operator">-</span>self<span class="token operator">:</span> center<span class="token punctuation">;</span>
  text<span class="token operator">-</span>align<span class="token operator">:</span> center<span class="token punctuation">;</span>
  font<span class="token operator">-</span>size<span class="token operator">:</span> 2em<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

#stage<span class="token operator">-</span>container <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">overflow</span><span class="token operator">:</span> hidden<span class="token punctuation">;</span>
  box<span class="token operator">-</span>sizing<span class="token operator">:</span> initial<span class="token punctuation">;</span>
  <span class="token literal-property property">border</span><span class="token operator">:</span> 1px solid #<span class="token number">222</span><span class="token punctuation">;</span>
  <span class="token literal-property property">margin</span><span class="token operator">:</span> <span class="token operator">-</span>1px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

#canvas<span class="token operator">-</span>container <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token number">100</span><span class="token operator">%</span><span class="token punctuation">;</span>
  <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">100</span><span class="token operator">%</span><span class="token punctuation">;</span>
  <span class="token literal-property property">transition</span><span class="token operator">:</span> filter <span class="token number">0</span><span class="token punctuation">.</span>3s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
#canvas<span class="token operator">-</span>container canvas <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">position</span><span class="token operator">:</span> absolute<span class="token punctuation">;</span>
  mix<span class="token operator">-</span>blend<span class="token operator">-</span>mode<span class="token operator">:</span> lighten<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

#controls <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">position</span><span class="token operator">:</span> absolute<span class="token punctuation">;</span>
  <span class="token literal-property property">top</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token number">100</span><span class="token operator">%</span><span class="token punctuation">;</span>
  padding<span class="token operator">-</span>bottom<span class="token operator">:</span> 50px<span class="token punctuation">;</span>
  <span class="token literal-property property">display</span><span class="token operator">:</span> flex<span class="token punctuation">;</span>
  justify<span class="token operator">-</span>content<span class="token operator">:</span> space<span class="token operator">-</span>between<span class="token punctuation">;</span>
  <span class="token literal-property property">transition</span><span class="token operator">:</span> opacity <span class="token number">0</span><span class="token punctuation">.</span>3s<span class="token punctuation">,</span> visibility <span class="token number">0</span><span class="token punctuation">.</span>3s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
@<span class="token function">media</span> <span class="token punctuation">(</span><span class="token parameter">min<span class="token operator">-</span>width<span class="token operator">:</span> 800px</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  #controls <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">visibility</span><span class="token operator">:</span> visible<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  #controls<span class="token punctuation">.</span>hide<span class="token operator">:</span>hover <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">opacity</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

#menu <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">display</span><span class="token operator">:</span> flex<span class="token punctuation">;</span>
  flex<span class="token operator">-</span>direction<span class="token operator">:</span> column<span class="token punctuation">;</span>
  justify<span class="token operator">-</span>content<span class="token operator">:</span> center<span class="token punctuation">;</span>
  align<span class="token operator">-</span>items<span class="token operator">:</span> center<span class="token punctuation">;</span>
  <span class="token literal-property property">position</span><span class="token operator">:</span> absolute<span class="token punctuation">;</span>
  <span class="token literal-property property">top</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token literal-property property">bottom</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token number">100</span><span class="token operator">%</span><span class="token punctuation">;</span>
  background<span class="token operator">-</span>color<span class="token operator">:</span> <span class="token function">rgba</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token literal-property property">transition</span><span class="token operator">:</span> opacity <span class="token number">0</span><span class="token punctuation">.</span>3s<span class="token punctuation">,</span> visibility <span class="token number">0</span><span class="token punctuation">.</span>3s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
#menu__header <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">padding</span><span class="token operator">:</span> 20px <span class="token number">0</span> 44px<span class="token punctuation">;</span>
  font<span class="token operator">-</span>size<span class="token operator">:</span> 2em<span class="token punctuation">;</span>
  text<span class="token operator">-</span>transform<span class="token operator">:</span> uppercase<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
#menu form <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">width</span><span class="token operator">:</span> 240px<span class="token punctuation">;</span>
  <span class="token literal-property property">padding</span><span class="token operator">:</span> <span class="token number">0</span> 20px<span class="token punctuation">;</span>
  <span class="token literal-property property">overflow</span><span class="token operator">:</span> auto<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
#menu <span class="token punctuation">.</span>form<span class="token operator">-</span>option <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">margin</span><span class="token operator">:</span> 20px <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
#menu <span class="token punctuation">.</span>form<span class="token operator">-</span>option label <span class="token punctuation">{<!-- --></span>
  text<span class="token operator">-</span>transform<span class="token operator">:</span> uppercase<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
#menu <span class="token punctuation">.</span>form<span class="token operator">-</span>option<span class="token operator">--</span>select label <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">display</span><span class="token operator">:</span> block<span class="token punctuation">;</span>
  margin<span class="token operator">-</span>bottom<span class="token operator">:</span> 6px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
#menu <span class="token punctuation">.</span>form<span class="token operator">-</span>option<span class="token operator">--</span>select select <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">display</span><span class="token operator">:</span> block<span class="token punctuation">;</span>
  <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token number">100</span><span class="token operator">%</span><span class="token punctuation">;</span>
  <span class="token literal-property property">height</span><span class="token operator">:</span> 30px<span class="token punctuation">;</span>
  font<span class="token operator">-</span>size<span class="token operator">:</span> 1rem<span class="token punctuation">;</span>
  font<span class="token operator">-</span>family<span class="token operator">:</span> <span class="token string">"Russo One"</span><span class="token punctuation">,</span> arial<span class="token punctuation">,</span> sans<span class="token operator">-</span>serif<span class="token punctuation">;</span>
  <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token function">rgba</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  letter<span class="token operator">-</span>spacing<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">.</span>06em<span class="token punctuation">;</span>
  background<span class="token operator">-</span>color<span class="token operator">:</span> transparent<span class="token punctuation">;</span>
  <span class="token literal-property property">border</span><span class="token operator">:</span> 1px solid <span class="token function">rgba</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
#menu <span class="token punctuation">.</span>form<span class="token operator">-</span>option<span class="token operator">--</span>select select option <span class="token punctuation">{<!-- --></span>
  background<span class="token operator">-</span>color<span class="token operator">:</span> black<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
#menu <span class="token punctuation">.</span>form<span class="token operator">-</span>option<span class="token operator">--</span>checkbox label <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">display</span><span class="token operator">:</span> flex<span class="token punctuation">;</span>
  align<span class="token operator">-</span>items<span class="token operator">:</span> center<span class="token punctuation">;</span>
  <span class="token literal-property property">transition</span><span class="token operator">:</span> opacity <span class="token number">0</span><span class="token punctuation">.</span>3s<span class="token punctuation">;</span>
  <span class="token operator">-</span>webkit<span class="token operator">-</span>user<span class="token operator">-</span>select<span class="token operator">:</span> none<span class="token punctuation">;</span>
     <span class="token operator">-</span>moz<span class="token operator">-</span>user<span class="token operator">-</span>select<span class="token operator">:</span> none<span class="token punctuation">;</span>
      <span class="token operator">-</span>ms<span class="token operator">-</span>user<span class="token operator">-</span>select<span class="token operator">:</span> none<span class="token punctuation">;</span>
          user<span class="token operator">-</span>select<span class="token operator">:</span> none<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
#menu <span class="token punctuation">.</span>form<span class="token operator">-</span>option<span class="token operator">--</span>checkbox input <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">display</span><span class="token operator">:</span> block<span class="token punctuation">;</span>
  <span class="token literal-property property">width</span><span class="token operator">:</span> 20px<span class="token punctuation">;</span>
  <span class="token literal-property property">height</span><span class="token operator">:</span> 20px<span class="token punctuation">;</span>
  margin<span class="token operator">-</span>right<span class="token operator">:</span> 8px<span class="token punctuation">;</span>
  <span class="token literal-property property">opacity</span><span class="token operator">:</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
@<span class="token function">media</span> <span class="token punctuation">(</span><span class="token parameter">max<span class="token operator">-</span>width<span class="token operator">:</span> 800px</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  #menu <span class="token punctuation">.</span>form<span class="token operator">-</span>option select<span class="token punctuation">,</span> #menu <span class="token punctuation">.</span>form<span class="token operator">-</span>option input <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">outline</span><span class="token operator">:</span> none<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

#close<span class="token operator">-</span>menu<span class="token operator">-</span>btn <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">position</span><span class="token operator">:</span> absolute<span class="token punctuation">;</span>
  <span class="token literal-property property">top</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token literal-property property">right</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span>btn <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">opacity</span><span class="token operator">:</span> <span class="token number">0.16</span><span class="token punctuation">;</span>
  <span class="token literal-property property">width</span><span class="token operator">:</span> 44px<span class="token punctuation">;</span>
  <span class="token literal-property property">height</span><span class="token operator">:</span> 44px<span class="token punctuation">;</span>
  <span class="token literal-property property">display</span><span class="token operator">:</span> flex<span class="token punctuation">;</span>
  <span class="token operator">-</span>webkit<span class="token operator">-</span>user<span class="token operator">-</span>select<span class="token operator">:</span> none<span class="token punctuation">;</span>
     <span class="token operator">-</span>moz<span class="token operator">-</span>user<span class="token operator">-</span>select<span class="token operator">:</span> none<span class="token punctuation">;</span>
      <span class="token operator">-</span>ms<span class="token operator">-</span>user<span class="token operator">-</span>select<span class="token operator">:</span> none<span class="token punctuation">;</span>
          user<span class="token operator">-</span>select<span class="token operator">:</span> none<span class="token punctuation">;</span>
  <span class="token literal-property property">cursor</span><span class="token operator">:</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
  <span class="token literal-property property">transition</span><span class="token operator">:</span> opacity <span class="token number">0</span><span class="token punctuation">.</span>3s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span>btn<span class="token operator">--</span>bright <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">opacity</span><span class="token operator">:</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
@<span class="token function">media</span> <span class="token punctuation">(</span><span class="token parameter">min<span class="token operator">-</span>width<span class="token operator">:</span> 800px</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token punctuation">.</span>btn<span class="token operator">:</span>hover <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">opacity</span><span class="token operator">:</span> <span class="token number">0.32</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">.</span>btn<span class="token operator">--</span>bright<span class="token operator">:</span>hover <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">opacity</span><span class="token operator">:</span> <span class="token number">0.75</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span>btn svg <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">display</span><span class="token operator">:</span> block<span class="token punctuation">;</span>
  <span class="token literal-property property">margin</span><span class="token operator">:</span> auto<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>style<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> partial<span class="token operator">:</span>index<span class="token punctuation">.</span>partial<span class="token punctuation">.</span>html <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> <span class="token constant">SVG</span> Spritesheet <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>div style<span class="token operator">=</span><span class="token string">"height: 0; width: 0; position: absolute; visibility: hidden;"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>svg xmlns<span class="token operator">=</span><span class="token string">"http://www.w3.org/2000/svg"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>symbol id<span class="token operator">=</span><span class="token string">"icon-play"</span> viewBox<span class="token operator">=</span><span class="token string">"0 0 24 24"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>path d<span class="token operator">=</span><span class="token string">"M8 5v14l11-7z"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>symbol<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>symbol id<span class="token operator">=</span><span class="token string">"icon-pause"</span> viewBox<span class="token operator">=</span><span class="token string">"0 0 24 24"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>path d<span class="token operator">=</span><span class="token string">"M6 19h4V5H6v14zm8-14v14h4V5h-4z"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>symbol<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>symbol id<span class="token operator">=</span><span class="token string">"icon-close"</span> viewBox<span class="token operator">=</span><span class="token string">"0 0 24 24"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>path d<span class="token operator">=</span><span class="token string">"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>symbol<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>symbol id<span class="token operator">=</span><span class="token string">"icon-settings"</span> viewBox<span class="token operator">=</span><span class="token string">"0 0 24 24"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>path d<span class="token operator">=</span><span class="token string">"M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>symbol<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>symbol id<span class="token operator">=</span><span class="token string">"icon-shutter-fast"</span> viewBox<span class="token operator">=</span><span class="token string">"0 0 24 24"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>path d<span class="token operator">=</span><span class="token string">"M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>symbol<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>symbol id<span class="token operator">=</span><span class="token string">"icon-shutter-slow"</span> viewBox<span class="token operator">=</span><span class="token string">"0 0 24 24"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>path d<span class="token operator">=</span><span class="token string">"M1 5h2v14H1zm4 0h2v14H5zm17 0H10c-.55 0-1 .45-1 1v12c0 .55.45 1 1 1h12c.55 0 1-.45 1-1V6c0-.55-.45-1-1-1zM11 17l2.5-3.15L15.29 16l2.5-3.22L21 17H11z"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>symbol<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>svg<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> App <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"container"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">"loading-init"</span><span class="token operator">&gt;</span>Loading<span class="token operator">...</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">"stage-container"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"remove"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">"canvas-container"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>canvas id<span class="token operator">=</span><span class="token string">"trails-canvas"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>canvas<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>canvas id<span class="token operator">=</span><span class="token string">"main-canvas"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>canvas<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">"controls"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">"pause-btn"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"btn"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>svg fill<span class="token operator">=</span><span class="token string">"white"</span> width<span class="token operator">=</span><span class="token string">"24"</span> height<span class="token operator">=</span><span class="token string">"24"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>use href<span class="token operator">=</span><span class="token string">"#icon-pause"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>use<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>svg<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">"shutter-btn"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"btn"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>svg fill<span class="token operator">=</span><span class="token string">"white"</span> width<span class="token operator">=</span><span class="token string">"24"</span> height<span class="token operator">=</span><span class="token string">"24"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>use href<span class="token operator">=</span><span class="token string">"#icon-shutter-slow"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>use<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>svg<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">"settings-btn"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"btn"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>svg fill<span class="token operator">=</span><span class="token string">"white"</span> width<span class="token operator">=</span><span class="token string">"24"</span> height<span class="token operator">=</span><span class="token string">"24"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>use href<span class="token operator">=</span><span class="token string">"#icon-settings"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>use<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>svg<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">"menu"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"hide"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">"close-menu-btn"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"btn btn--bright"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>svg fill<span class="token operator">=</span><span class="token string">"white"</span> width<span class="token operator">=</span><span class="token string">"24"</span> height<span class="token operator">=</span><span class="token string">"24"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>use href<span class="token operator">=</span><span class="token string">"#icon-close"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>use<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>svg<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">"menu__header"</span><span class="token operator">&gt;</span>Settings<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>form<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-option form-option--select"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>label<span class="token operator">&gt;</span>Shell Type<span class="token operator">&lt;</span><span class="token operator">/</span>label<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>select id<span class="token operator">=</span><span class="token string">"shell-type"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>select<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-option form-option--select"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>label<span class="token operator">&gt;</span>Shell Size<span class="token operator">&lt;</span><span class="token operator">/</span>label<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>select id<span class="token operator">=</span><span class="token string">"shell-size"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>select<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-option form-option--checkbox"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>label id<span class="token operator">=</span><span class="token string">"auto-launch-label"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>input id<span class="token operator">=</span><span class="token string">"auto-launch"</span> type<span class="token operator">=</span><span class="token string">"checkbox"</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>span<span class="token operator">&gt;</span>Auto Fire<span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>label<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-option form-option--checkbox"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>label id<span class="token operator">=</span><span class="token string">"finale-mode-label"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>input id<span class="token operator">=</span><span class="token string">"finale-mode"</span> type<span class="token operator">=</span><span class="token string">"checkbox"</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>span<span class="token operator">&gt;</span>Finale Mode<span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>label<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-option form-option--checkbox"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>label id<span class="token operator">=</span><span class="token string">"hide-controls-label"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>input id<span class="token operator">=</span><span class="token string">"hide-controls"</span> type<span class="token operator">=</span><span class="token string">"checkbox"</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>span<span class="token operator">&gt;</span>Hide Controls<span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>label<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> partial <span class="token operator">--</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">'https://s3-us-west-2.amazonaws.com/s.cdpn.io/329180/fscreen%401.0.1.js'</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">'https://s3-us-west-2.amazonaws.com/s.cdpn.io/329180/Stage%400.1.4.js'</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">'https://s3-us-west-2.amazonaws.com/s.cdpn.io/329180/MyMath.js'</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">const</span> <span class="token constant">IS_MOBILE</span> <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth <span class="token operator">&lt;=</span> <span class="token number">640</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">IS_DESKTOP</span> <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth <span class="token operator">&gt;</span> <span class="token number">800</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">IS_HEADER</span> <span class="token operator">=</span> <span class="token constant">IS_DESKTOP</span> <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span>innerHeight <span class="token operator">&lt;</span> <span class="token number">300</span><span class="token punctuation">;</span>
<span class="token comment">// 8K - can restrict this if needed</span>
<span class="token keyword">const</span> <span class="token constant">MAX_WIDTH</span> <span class="token operator">=</span> <span class="token number">7680</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">MAX_HEIGHT</span> <span class="token operator">=</span> <span class="token number">4320</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">GRAVITY</span> <span class="token operator">=</span> <span class="token number">0.9</span><span class="token punctuation">;</span> <span class="token comment">// Acceleration in px/s</span>
<span class="token keyword">let</span> simSpeed <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">COLOR</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
<span class="token literal-property property">Red</span><span class="token operator">:</span> <span class="token string">'#ff0043'</span><span class="token punctuation">,</span>
<span class="token literal-property property">Green</span><span class="token operator">:</span> <span class="token string">'#14fc56'</span><span class="token punctuation">,</span>
<span class="token literal-property property">Blue</span><span class="token operator">:</span> <span class="token string">'#1e7fff'</span><span class="token punctuation">,</span>
<span class="token literal-property property">Purple</span><span class="token operator">:</span> <span class="token string">'#e60aff'</span><span class="token punctuation">,</span>
<span class="token literal-property property">Gold</span><span class="token operator">:</span> <span class="token string">'#ffae00'</span><span class="token punctuation">,</span>
<span class="token literal-property property">White</span><span class="token operator">:</span> <span class="token string">'#ffffff'</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Special invisible color (not rendered, and therefore not in COLOR map)</span>
<span class="token keyword">const</span> <span class="token constant">INVISIBLE</span> <span class="token operator">=</span> <span class="token string">'_INVISIBLE_'</span><span class="token punctuation">;</span>


<span class="token comment">// Interactive state management</span>
<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
<span class="token literal-property property">_listeners</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token function">_dispatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">this</span><span class="token punctuation">.</span>_listeners<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">listener</span> <span class="token operator">=&gt;</span> <span class="token function">listener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
<span class="token literal-property property">paused</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token literal-property property">longExposure</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token literal-property property">menuOpen</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token literal-property property">config</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
<span class="token literal-property property">shell</span><span class="token operator">:</span> <span class="token string">'Random'</span><span class="token punctuation">,</span>
<span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token constant">IS_DESKTOP</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token constant">IS_HEADER</span> <span class="token operator">?</span> <span class="token string">'3'</span> <span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
<span class="token literal-property property">autoLaunch</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token literal-property property">finale</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token literal-property property">hideControls</span><span class="token operator">:</span> <span class="token constant">IS_HEADER</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">nextState</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">,</span> nextState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_dispatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">persist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">listener</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">this</span><span class="token punctuation">.</span>_listeners<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_listeners<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token comment">// Load / persist select state to localStorage</span>
<span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'schemaVersion'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'1'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>config<span class="token punctuation">.</span>size <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'configSize'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>config<span class="token punctuation">.</span>hideControls <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'hideControls'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token function">persist</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'schemaVersion'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'configSize'</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>config<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'hideControls'</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>config<span class="token punctuation">.</span>hideControls<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token constant">IS_HEADER</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
store<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Actions</span>
<span class="token comment">// ---------</span>

<span class="token keyword">function</span> <span class="token function">togglePause</span><span class="token punctuation">(</span><span class="token parameter">toggle</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> toggle <span class="token operator">===</span> <span class="token string">'boolean'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
store<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">paused</span><span class="token operator">:</span> toggle <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
store<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">paused</span><span class="token operator">:</span> <span class="token operator">!</span>store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>paused <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">toggleLongExposure</span><span class="token punctuation">(</span><span class="token parameter">toggle</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> toggle <span class="token operator">===</span> <span class="token string">'boolean'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
store<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">longExposure</span><span class="token operator">:</span> toggle <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
store<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">longExposure</span><span class="token operator">:</span> <span class="token operator">!</span>store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>longExposure <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">toggleMenu</span><span class="token punctuation">(</span><span class="token parameter">toggle</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> toggle <span class="token operator">===</span> <span class="token string">'boolean'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
store<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">menuOpen</span><span class="token operator">:</span> toggle <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
store<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">menuOpen</span><span class="token operator">:</span> <span class="token operator">!</span>store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>menuOpen <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">updateConfig</span><span class="token punctuation">(</span><span class="token parameter">nextConfig</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
nextConfig <span class="token operator">=</span> nextConfig <span class="token operator">||</span> <span class="token function">getConfigFromDOM</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
store<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
<span class="token literal-property property">config</span><span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>config<span class="token punctuation">,</span> nextConfig<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Selectors</span>
<span class="token comment">// -----------</span>

<span class="token keyword">const</span> <span class="token function-variable function">canInteract</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span>store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>paused <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>menuOpen<span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">shellNameSelector</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>config<span class="token punctuation">.</span>shell<span class="token punctuation">;</span>
<span class="token comment">// Converts shell size to number.</span>
<span class="token keyword">const</span> <span class="token function-variable function">shellSizeSelector</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token operator">+</span>store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>config<span class="token punctuation">.</span>size<span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">finaleSelector</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>config<span class="token punctuation">.</span>finale<span class="token punctuation">;</span>


<span class="token comment">// Render app UI / keep in sync with state</span>
<span class="token keyword">const</span> appNodes <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
<span class="token literal-property property">stageContainer</span><span class="token operator">:</span> <span class="token string">'#stage-container'</span><span class="token punctuation">,</span>
<span class="token literal-property property">canvasContainer</span><span class="token operator">:</span> <span class="token string">'#canvas-container'</span><span class="token punctuation">,</span>
<span class="token literal-property property">controls</span><span class="token operator">:</span> <span class="token string">'#controls'</span><span class="token punctuation">,</span>
<span class="token literal-property property">menu</span><span class="token operator">:</span> <span class="token string">'#menu'</span><span class="token punctuation">,</span>
<span class="token literal-property property">pauseBtn</span><span class="token operator">:</span> <span class="token string">'#pause-btn'</span><span class="token punctuation">,</span>
<span class="token literal-property property">pauseBtnSVG</span><span class="token operator">:</span> <span class="token string">'#pause-btn use'</span><span class="token punctuation">,</span>
<span class="token literal-property property">shutterBtn</span><span class="token operator">:</span> <span class="token string">'#shutter-btn'</span><span class="token punctuation">,</span>
<span class="token literal-property property">shutterBtnSVG</span><span class="token operator">:</span> <span class="token string">'#shutter-btn use'</span><span class="token punctuation">,</span>
<span class="token literal-property property">shellType</span><span class="token operator">:</span> <span class="token string">'#shell-type'</span><span class="token punctuation">,</span>
<span class="token literal-property property">shellSize</span><span class="token operator">:</span> <span class="token string">'#shell-size'</span><span class="token punctuation">,</span>
<span class="token literal-property property">autoLaunch</span><span class="token operator">:</span> <span class="token string">'#auto-launch'</span><span class="token punctuation">,</span>
<span class="token literal-property property">autoLaunchLabel</span><span class="token operator">:</span> <span class="token string">'#auto-launch-label'</span><span class="token punctuation">,</span>
<span class="token literal-property property">finaleMode</span><span class="token operator">:</span> <span class="token string">'#finale-mode'</span><span class="token punctuation">,</span>
<span class="token literal-property property">finaleModeLabel</span><span class="token operator">:</span> <span class="token string">'#finale-mode-label'</span><span class="token punctuation">,</span>
<span class="token literal-property property">hideControls</span><span class="token operator">:</span> <span class="token string">'#hide-controls'</span><span class="token punctuation">,</span>
<span class="token literal-property property">hideControlsLabel</span><span class="token operator">:</span> <span class="token string">'#hide-controls-label'</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Convert appNodes selectors to dom nodes</span>
Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>appNodes<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
appNodes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>appNodes<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Remove loading state</span>
document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'loading-init'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
appNodes<span class="token punctuation">.</span>stageContainer<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">'remove'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// First render is called in init()</span>
<span class="token keyword">function</span> <span class="token function">renderApp</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
appNodes<span class="token punctuation">.</span>pauseBtnSVG<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'href'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">#icon-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>state<span class="token punctuation">.</span>paused <span class="token operator">?</span> <span class="token string">'play'</span> <span class="token operator">:</span> <span class="token string">'pause'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
appNodes<span class="token punctuation">.</span>shutterBtnSVG<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'href'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">#icon-shutter-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>state<span class="token punctuation">.</span>longExposure <span class="token operator">?</span> <span class="token string">'fast'</span> <span class="token operator">:</span> <span class="token string">'slow'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
appNodes<span class="token punctuation">.</span>controls<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">toggle</span><span class="token punctuation">(</span><span class="token string">'hide'</span><span class="token punctuation">,</span> state<span class="token punctuation">.</span>menuOpen <span class="token operator">||</span> state<span class="token punctuation">.</span>config<span class="token punctuation">.</span>hideControls<span class="token punctuation">)</span><span class="token punctuation">;</span>
appNodes<span class="token punctuation">.</span>canvasContainer<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">toggle</span><span class="token punctuation">(</span><span class="token string">'blur'</span><span class="token punctuation">,</span> state<span class="token punctuation">.</span>menuOpen<span class="token punctuation">)</span><span class="token punctuation">;</span>
appNodes<span class="token punctuation">.</span>menu<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">toggle</span><span class="token punctuation">(</span><span class="token string">'hide'</span><span class="token punctuation">,</span> <span class="token operator">!</span>state<span class="token punctuation">.</span>menuOpen<span class="token punctuation">)</span><span class="token punctuation">;</span>
appNodes<span class="token punctuation">.</span>finaleModeLabel<span class="token punctuation">.</span>style<span class="token punctuation">.</span>opacity <span class="token operator">=</span> state<span class="token punctuation">.</span>config<span class="token punctuation">.</span>autoLaunch <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0.32</span><span class="token punctuation">;</span>
appNodes<span class="token punctuation">.</span>shellType<span class="token punctuation">.</span>value <span class="token operator">=</span> state<span class="token punctuation">.</span>config<span class="token punctuation">.</span>shell<span class="token punctuation">;</span>
appNodes<span class="token punctuation">.</span>shellSize<span class="token punctuation">.</span>value <span class="token operator">=</span> state<span class="token punctuation">.</span>config<span class="token punctuation">.</span>size<span class="token punctuation">;</span>
appNodes<span class="token punctuation">.</span>autoLaunch<span class="token punctuation">.</span>checked <span class="token operator">=</span> state<span class="token punctuation">.</span>config<span class="token punctuation">.</span>autoLaunch<span class="token punctuation">;</span>
appNodes<span class="token punctuation">.</span>finaleMode<span class="token punctuation">.</span>checked <span class="token operator">=</span> state<span class="token punctuation">.</span>config<span class="token punctuation">.</span>finale<span class="token punctuation">;</span>
appNodes<span class="token punctuation">.</span>hideControls<span class="token punctuation">.</span>checked <span class="token operator">=</span> state<span class="token punctuation">.</span>config<span class="token punctuation">.</span>hideControls<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

store<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>renderApp<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">function</span> <span class="token function">getConfigFromDOM</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
<span class="token literal-property property">shell</span><span class="token operator">:</span> appNodes<span class="token punctuation">.</span>shellType<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
<span class="token literal-property property">size</span><span class="token operator">:</span> appNodes<span class="token punctuation">.</span>shellSize<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
<span class="token literal-property property">autoLaunch</span><span class="token operator">:</span> appNodes<span class="token punctuation">.</span>autoLaunch<span class="token punctuation">.</span>checked<span class="token punctuation">,</span>
<span class="token literal-property property">finale</span><span class="token operator">:</span> appNodes<span class="token punctuation">.</span>finaleMode<span class="token punctuation">.</span>checked<span class="token punctuation">,</span>
<span class="token literal-property property">hideControls</span><span class="token operator">:</span> appNodes<span class="token punctuation">.</span>hideControls<span class="token punctuation">.</span>checked
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">updateConfigNoEvent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">updateConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
appNodes<span class="token punctuation">.</span>shellType<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">,</span> updateConfigNoEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
appNodes<span class="token punctuation">.</span>shellSize<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">,</span> updateConfigNoEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
appNodes<span class="token punctuation">.</span>autoLaunchLabel<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>updateConfig<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
appNodes<span class="token punctuation">.</span>finaleModeLabel<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>updateConfig<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
appNodes<span class="token punctuation">.</span>hideControlsLabel<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>updateConfig<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// Constant derivations</span>
<span class="token keyword">const</span> <span class="token constant">COLOR_NAMES</span> <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token constant">COLOR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">COLOR_CODES</span> <span class="token operator">=</span> <span class="token constant">COLOR_NAMES</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">colorName</span> <span class="token operator">=&gt;</span> <span class="token constant">COLOR</span><span class="token punctuation">[</span>colorName<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Invisible stars need an indentifier, even through they won't be rendered - physics still apply.</span>
<span class="token keyword">const</span> <span class="token constant">COLOR_CODES_W_INVIS</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token constant">COLOR_CODES</span><span class="token punctuation">,</span> <span class="token constant">INVISIBLE</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// Tuples is a map keys by color codes (hex) with values of { r, g, b } tuples (still just objects).</span>
<span class="token keyword">const</span> <span class="token constant">COLOR_TUPLES</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token constant">COLOR_CODES</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">hex</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
<span class="token constant">COLOR_TUPLES</span><span class="token punctuation">[</span>hex<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
<span class="token literal-property property">r</span><span class="token operator">:</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>hex<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token literal-property property">g</span><span class="token operator">:</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>hex<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>hex<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Get a random color.</span>
<span class="token keyword">function</span> <span class="token function">randomColorSimple</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">return</span> <span class="token constant">COLOR_CODES</span><span class="token punctuation">[</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">COLOR_CODES</span><span class="token punctuation">.</span>length <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Get a random color, with some customization options available.</span>
<span class="token keyword">let</span> lastColor<span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">randomColor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> notSame <span class="token operator">=</span> options <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>notSame<span class="token punctuation">;</span>
<span class="token keyword">const</span> notColor <span class="token operator">=</span> options <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>notColor<span class="token punctuation">;</span>
<span class="token keyword">const</span> limitWhite <span class="token operator">=</span> options <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>limitWhite<span class="token punctuation">;</span>
<span class="token keyword">let</span> color <span class="token operator">=</span> <span class="token function">randomColorSimple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// limit the amount of white chosen randomly</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>limitWhite <span class="token operator">&amp;&amp;</span> color <span class="token operator">===</span> <span class="token constant">COLOR</span><span class="token punctuation">.</span>White <span class="token operator">&amp;&amp;</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.6</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
color <span class="token operator">=</span> <span class="token function">randomColorSimple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>notSame<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>color <span class="token operator">===</span> lastColor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
color <span class="token operator">=</span> <span class="token function">randomColorSimple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>notColor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>color <span class="token operator">===</span> notColor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
color <span class="token operator">=</span> <span class="token function">randomColorSimple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
lastColor <span class="token operator">=</span> color<span class="token punctuation">;</span>
<span class="token keyword">return</span> color<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">whiteOrGold</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.5</span> <span class="token operator">?</span> <span class="token constant">COLOR</span><span class="token punctuation">.</span>Gold <span class="token operator">:</span> <span class="token constant">COLOR</span><span class="token punctuation">.</span>White<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token constant">PI_2</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">PI_HALF</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> trailsStage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stage</span><span class="token punctuation">(</span><span class="token string">'trails-canvas'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mainStage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stage</span><span class="token punctuation">(</span><span class="token string">'main-canvas'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> stages <span class="token operator">=</span> <span class="token punctuation">[</span>
trailsStage<span class="token punctuation">,</span>
mainStage
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// Fill trails canvas with black to start.</span>
trailsStage<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">'#000'</span><span class="token punctuation">;</span>
trailsStage<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> trailsStage<span class="token punctuation">.</span>width<span class="token punctuation">,</span> trailsStage<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// Fullscreen helpers, using Fscreen for prefixes</span>
<span class="token keyword">function</span> <span class="token function">requestFullscreen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fullscreenEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isFullscreen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
fscreen<span class="token punctuation">.</span><span class="token function">requestFullscreen</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>documentElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">fullscreenEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">return</span> fscreen<span class="token punctuation">.</span>fullscreenEnabled<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">isFullscreen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span>fscreen<span class="token punctuation">.</span>fullscreenElement<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">// Shell helpers</span>
<span class="token keyword">function</span> <span class="token function">makePistilColor</span><span class="token punctuation">(</span><span class="token parameter">shellColor</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">return</span> <span class="token punctuation">(</span>shellColor <span class="token operator">===</span> <span class="token constant">COLOR</span><span class="token punctuation">.</span>White <span class="token operator">||</span> shellColor <span class="token operator">===</span> <span class="token constant">COLOR</span><span class="token punctuation">.</span>Gold<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">randomColor</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">notColor</span><span class="token operator">:</span> shellColor <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">whiteOrGold</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Unique shell types</span>
<span class="token keyword">const</span> <span class="token function-variable function">crysanthemumShell</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">size<span class="token operator">=</span><span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> glitter <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.25</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> singleColor <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.68</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> color <span class="token operator">=</span> singleColor <span class="token operator">?</span> <span class="token function">randomColor</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">limitWhite</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">randomColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">randomColor</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">notSame</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> pistil <span class="token operator">=</span> singleColor <span class="token operator">&amp;&amp;</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.42</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> pistilColor <span class="token operator">=</span> <span class="token function">makePistilColor</span><span class="token punctuation">(</span>color<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> streamers <span class="token operator">=</span> <span class="token operator">!</span>pistil <span class="token operator">&amp;&amp;</span> color <span class="token operator">!==</span> <span class="token constant">COLOR</span><span class="token punctuation">.</span>White <span class="token operator">&amp;&amp;</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.42</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
<span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">300</span> <span class="token operator">+</span> size <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">,</span>
<span class="token literal-property property">starLife</span><span class="token operator">:</span> <span class="token number">900</span> <span class="token operator">+</span> size <span class="token operator">*</span> <span class="token number">200</span><span class="token punctuation">,</span>
<span class="token literal-property property">starDensity</span><span class="token operator">:</span> glitter <span class="token operator">?</span> <span class="token number">1.1</span> <span class="token operator">:</span> <span class="token number">1.5</span><span class="token punctuation">,</span>
color<span class="token punctuation">,</span>
<span class="token literal-property property">glitter</span><span class="token operator">:</span> glitter <span class="token operator">?</span> <span class="token string">'light'</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
<span class="token literal-property property">glitterColor</span><span class="token operator">:</span> <span class="token function">whiteOrGold</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
pistil<span class="token punctuation">,</span>
pistilColor<span class="token punctuation">,</span>
streamers
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token keyword">const</span> <span class="token function-variable function">palmShell</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">size<span class="token operator">=</span><span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
<span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">250</span> <span class="token operator">+</span> size <span class="token operator">*</span> <span class="token number">75</span><span class="token punctuation">,</span>
<span class="token literal-property property">starDensity</span><span class="token operator">:</span> <span class="token number">0.6</span><span class="token punctuation">,</span>
<span class="token literal-property property">starLife</span><span class="token operator">:</span> <span class="token number">1800</span> <span class="token operator">+</span> size <span class="token operator">*</span> <span class="token number">200</span><span class="token punctuation">,</span>
<span class="token literal-property property">glitter</span><span class="token operator">:</span> <span class="token string">'heavy'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">ringShell</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">size<span class="token operator">=</span><span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> color <span class="token operator">=</span> <span class="token function">randomColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> pistil <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.75</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
<span class="token literal-property property">ring</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
color<span class="token punctuation">,</span>
<span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">300</span> <span class="token operator">+</span> size <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">,</span>
<span class="token literal-property property">starLife</span><span class="token operator">:</span> <span class="token number">900</span> <span class="token operator">+</span> size <span class="token operator">*</span> <span class="token number">200</span><span class="token punctuation">,</span>
<span class="token literal-property property">starCount</span><span class="token operator">:</span> <span class="token number">2.2</span> <span class="token operator">*</span> <span class="token constant">PI_2</span> <span class="token operator">*</span> <span class="token punctuation">(</span>size<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
pistil<span class="token punctuation">,</span>
<span class="token literal-property property">pistilColor</span><span class="token operator">:</span> <span class="token function">makePistilColor</span><span class="token punctuation">(</span>color<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token literal-property property">glitter</span><span class="token operator">:</span> <span class="token operator">!</span>pistil <span class="token operator">?</span> <span class="token string">'light'</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
<span class="token literal-property property">glitterColor</span><span class="token operator">:</span> color <span class="token operator">===</span> <span class="token constant">COLOR</span><span class="token punctuation">.</span>Gold <span class="token operator">?</span> <span class="token constant">COLOR</span><span class="token punctuation">.</span>Gold <span class="token operator">:</span> <span class="token constant">COLOR</span><span class="token punctuation">.</span>White
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">crossetteShell</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">size<span class="token operator">=</span><span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> color <span class="token operator">=</span> <span class="token function">randomColor</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">limitWhite</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
<span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">300</span> <span class="token operator">+</span> size <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">,</span>
<span class="token literal-property property">starLife</span><span class="token operator">:</span> <span class="token number">900</span> <span class="token operator">+</span> size <span class="token operator">*</span> <span class="token number">200</span><span class="token punctuation">,</span>
<span class="token literal-property property">starLifeVariation</span><span class="token operator">:</span> <span class="token number">0.22</span><span class="token punctuation">,</span>
color<span class="token punctuation">,</span>
<span class="token literal-property property">crossette</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token literal-property property">pistil</span><span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
<span class="token literal-property property">pistilColor</span><span class="token operator">:</span> <span class="token function">makePistilColor</span><span class="token punctuation">(</span>color<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">floralShell</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">size<span class="token operator">=</span><span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
<span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">300</span> <span class="token operator">+</span> size <span class="token operator">*</span> <span class="token number">120</span><span class="token punctuation">,</span>
<span class="token literal-property property">starDensity</span><span class="token operator">:</span> <span class="token number">0.38</span><span class="token punctuation">,</span>
<span class="token literal-property property">starLife</span><span class="token operator">:</span> <span class="token number">500</span> <span class="token operator">+</span> size <span class="token operator">*</span> <span class="token number">50</span><span class="token punctuation">,</span>
<span class="token literal-property property">starLifeVariation</span><span class="token operator">:</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
<span class="token literal-property property">color</span><span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.65</span> <span class="token operator">?</span> <span class="token string">'random'</span> <span class="token operator">:</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.15</span> <span class="token operator">?</span> <span class="token function">randomColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">randomColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">randomColor</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">notSame</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token literal-property property">floral</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">fallingLeavesShell</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">size<span class="token operator">=</span><span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
<span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token constant">INVISIBLE</span><span class="token punctuation">,</span>
<span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">300</span> <span class="token operator">+</span> size <span class="token operator">*</span> <span class="token number">120</span><span class="token punctuation">,</span>
<span class="token literal-property property">starDensity</span><span class="token operator">:</span> <span class="token number">0.38</span><span class="token punctuation">,</span>
<span class="token literal-property property">starLife</span><span class="token operator">:</span> <span class="token number">500</span> <span class="token operator">+</span> size <span class="token operator">*</span> <span class="token number">50</span><span class="token punctuation">,</span>
<span class="token literal-property property">starLifeVariation</span><span class="token operator">:</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
<span class="token literal-property property">glitter</span><span class="token operator">:</span> <span class="token string">'medium'</span><span class="token punctuation">,</span>
<span class="token literal-property property">glitterColor</span><span class="token operator">:</span> <span class="token constant">COLOR</span><span class="token punctuation">.</span>Gold<span class="token punctuation">,</span>
<span class="token literal-property property">fallingLeaves</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">willowShell</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">size<span class="token operator">=</span><span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
<span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">300</span> <span class="token operator">+</span> size <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">,</span>
<span class="token literal-property property">starDensity</span><span class="token operator">:</span> <span class="token number">0.7</span><span class="token punctuation">,</span>
<span class="token literal-property property">starLife</span><span class="token operator">:</span> <span class="token number">3000</span> <span class="token operator">+</span> size <span class="token operator">*</span> <span class="token number">300</span><span class="token punctuation">,</span>
<span class="token literal-property property">glitter</span><span class="token operator">:</span> <span class="token string">'willow'</span><span class="token punctuation">,</span>
<span class="token literal-property property">glitterColor</span><span class="token operator">:</span> <span class="token constant">COLOR</span><span class="token punctuation">.</span>Gold<span class="token punctuation">,</span>
<span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token constant">INVISIBLE</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">crackleShell</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">size<span class="token operator">=</span><span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">// favor gold</span>
<span class="token keyword">const</span> color <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.75</span> <span class="token operator">?</span> <span class="token constant">COLOR</span><span class="token punctuation">.</span>Gold <span class="token operator">:</span> <span class="token function">randomColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
<span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">380</span> <span class="token operator">+</span> size <span class="token operator">*</span> <span class="token number">75</span><span class="token punctuation">,</span>
<span class="token literal-property property">starDensity</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token literal-property property">starLife</span><span class="token operator">:</span> <span class="token number">600</span> <span class="token operator">+</span> size <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">,</span>
<span class="token literal-property property">starLifeVariation</span><span class="token operator">:</span> <span class="token number">0.32</span><span class="token punctuation">,</span>
<span class="token literal-property property">glitter</span><span class="token operator">:</span> <span class="token string">'light'</span><span class="token punctuation">,</span>
<span class="token literal-property property">glitterColor</span><span class="token operator">:</span> <span class="token constant">COLOR</span><span class="token punctuation">.</span>Gold<span class="token punctuation">,</span>
color<span class="token punctuation">,</span>
<span class="token literal-property property">crackle</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token literal-property property">pistil</span><span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.65</span><span class="token punctuation">,</span>
<span class="token literal-property property">pistilColor</span><span class="token operator">:</span> <span class="token function">makePistilColor</span><span class="token punctuation">(</span>color<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">horsetailShell</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">size<span class="token operator">=</span><span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> color <span class="token operator">=</span> <span class="token function">randomColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
<span class="token literal-property property">horsetail</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
color<span class="token punctuation">,</span>
<span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">250</span> <span class="token operator">+</span> size <span class="token operator">*</span> <span class="token number">38</span><span class="token punctuation">,</span>
<span class="token literal-property property">starDensity</span><span class="token operator">:</span> <span class="token number">0.85</span> <span class="token operator">+</span> size <span class="token operator">*</span> <span class="token number">0.1</span><span class="token punctuation">,</span>
<span class="token literal-property property">starLife</span><span class="token operator">:</span> <span class="token number">2500</span> <span class="token operator">+</span> size <span class="token operator">*</span> <span class="token number">300</span><span class="token punctuation">,</span>
<span class="token literal-property property">glitter</span><span class="token operator">:</span> <span class="token string">'medium'</span><span class="token punctuation">,</span>
<span class="token literal-property property">glitterColor</span><span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.5</span> <span class="token operator">?</span> <span class="token function">whiteOrGold</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> color
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">randomShellName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.6</span> <span class="token operator">?</span> <span class="token string">'Crysanthemum'</span> <span class="token operator">:</span> shellNames<span class="token punctuation">[</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>shellNames<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">randomShell</span><span class="token punctuation">(</span><span class="token parameter">size</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">return</span> shellTypes<span class="token punctuation">[</span><span class="token function">randomShellName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">shellFromConfig</span><span class="token punctuation">(</span><span class="token parameter">size</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">return</span> shellTypes<span class="token punctuation">[</span><span class="token function">shellNameSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Get a random shell, not including processing intensive varients</span>
<span class="token comment">// Note this is only random when "Random" shell is selected in config.</span>
<span class="token comment">// Also, this does not create the shell, only returns the factory function.</span>
<span class="token keyword">const</span> fastShellBlacklist <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'Falling Leaves'</span><span class="token punctuation">,</span> <span class="token string">'Floral'</span><span class="token punctuation">,</span> <span class="token string">'Willow'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">randomFastShell</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> isRandom <span class="token operator">=</span> <span class="token function">shellNameSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'Random'</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> shellName <span class="token operator">=</span> isRandom <span class="token operator">?</span> <span class="token function">randomShellName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">shellNameSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>isRandom<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>fastShellBlacklist<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>shellName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
shellName <span class="token operator">=</span> <span class="token function">randomShellName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">return</span> shellTypes<span class="token punctuation">[</span>shellName<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">const</span> shellTypes <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
<span class="token string-property property">'Random'</span><span class="token operator">:</span> randomShell<span class="token punctuation">,</span>
<span class="token string-property property">'Crackle'</span><span class="token operator">:</span> crackleShell<span class="token punctuation">,</span>
<span class="token string-property property">'Crossette'</span><span class="token operator">:</span> crossetteShell<span class="token punctuation">,</span>
<span class="token string-property property">'Crysanthemum'</span><span class="token operator">:</span> crysanthemumShell<span class="token punctuation">,</span>
<span class="token string-property property">'Falling Leaves'</span><span class="token operator">:</span> fallingLeavesShell<span class="token punctuation">,</span>
<span class="token string-property property">'Floral'</span><span class="token operator">:</span> floralShell<span class="token punctuation">,</span>
<span class="token string-property property">'Horse Tail'</span><span class="token operator">:</span> horsetailShell<span class="token punctuation">,</span>
<span class="token string-property property">'Palm'</span><span class="token operator">:</span> palmShell<span class="token punctuation">,</span>
<span class="token string-property property">'Ring'</span><span class="token operator">:</span> ringShell<span class="token punctuation">,</span>
<span class="token string-property property">'Willow'</span><span class="token operator">:</span> willowShell
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> shellNames <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>shellTypes<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">// Populate dropdowns</span>
<span class="token comment">// shell type</span>
<span class="token keyword">let</span> options <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
shellNames<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">opt</span> <span class="token operator">=&gt;</span> options <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;option value="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>opt<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>opt<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/option&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
appNodes<span class="token punctuation">.</span>shellType<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> options<span class="token punctuation">;</span>
<span class="token comment">// shell size</span>
options <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span><span class="token string">'3"'</span><span class="token punctuation">,</span> <span class="token string">'5"'</span><span class="token punctuation">,</span> <span class="token string">'6"'</span><span class="token punctuation">,</span> <span class="token string">'8"'</span><span class="token punctuation">,</span> <span class="token string">'12"'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">opt<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> options <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;option value="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>opt<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/option&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
appNodes<span class="token punctuation">.</span>shellSize<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> options<span class="token punctuation">;</span>
<span class="token comment">// initial render</span>
<span class="token function">renderApp</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">function</span> <span class="token function">fitShellPositionInBoundsH</span><span class="token punctuation">(</span><span class="token parameter">position</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> edge <span class="token operator">=</span> <span class="token number">0.18</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> edge<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> position <span class="token operator">+</span> edge<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">fitShellPositionInBoundsV</span><span class="token punctuation">(</span><span class="token parameter">position</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">return</span> position <span class="token operator">*</span> <span class="token number">0.75</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getRandomShellPositionH</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">return</span> <span class="token function">fitShellPositionInBoundsH</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getRandomShellPositionV</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">return</span> <span class="token function">fitShellPositionInBoundsV</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getRandomShellSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> baseSize <span class="token operator">=</span> <span class="token function">shellSizeSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> maxVariance <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">2.5</span><span class="token punctuation">,</span> baseSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> variance <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> maxVariance<span class="token punctuation">;</span>
<span class="token keyword">const</span> size <span class="token operator">=</span> baseSize <span class="token operator">-</span> variance<span class="token punctuation">;</span>
<span class="token keyword">const</span> height <span class="token operator">=</span> maxVariance <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">?</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">1</span> <span class="token operator">-</span> <span class="token punctuation">(</span>variance <span class="token operator">/</span> maxVariance<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> centerOffset <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> height <span class="token operator">*</span> <span class="token number">0.65</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> x <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.5</span> <span class="token operator">?</span> <span class="token number">0.5</span> <span class="token operator">-</span> centerOffset <span class="token operator">:</span> <span class="token number">0.5</span> <span class="token operator">+</span> centerOffset<span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
size<span class="token punctuation">,</span>
<span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token function">fitShellPositionInBoundsH</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token function">fitShellPositionInBoundsV</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">// Launches a shell from a user pointer event, based on state.config</span>
<span class="token keyword">function</span> <span class="token function">launchShellFromConfig</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> shell <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Shell</span><span class="token punctuation">(</span><span class="token function">shellFromConfig</span><span class="token punctuation">(</span><span class="token function">shellSizeSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> w <span class="token operator">=</span> mainStage<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
<span class="token keyword">const</span> h <span class="token operator">=</span> mainStage<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
shell<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span>
event <span class="token operator">?</span> event<span class="token punctuation">.</span>x <span class="token operator">/</span> w <span class="token operator">:</span> <span class="token function">getRandomShellPositionH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
event <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">-</span> event<span class="token punctuation">.</span>y <span class="token operator">/</span> h <span class="token operator">:</span> <span class="token function">getRandomShellPositionV</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">// Sequences</span>
<span class="token comment">// -----------</span>

<span class="token keyword">function</span> <span class="token function">seqRandomShell</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> size <span class="token operator">=</span> <span class="token function">getRandomShellSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> shell <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Shell</span><span class="token punctuation">(</span><span class="token function">shellFromConfig</span><span class="token punctuation">(</span>size<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
shell<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span>size<span class="token punctuation">.</span>x<span class="token punctuation">,</span> size<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> extraDelay <span class="token operator">=</span> shell<span class="token punctuation">.</span>starLife<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>shell<span class="token punctuation">.</span>fallingLeaves<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
extraDelay <span class="token operator">=</span> <span class="token number">4000</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">return</span> <span class="token number">900</span> <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">600</span> <span class="token operator">+</span> extraDelay<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">seqTwoRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> size1 <span class="token operator">=</span> <span class="token function">getRandomShellSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> size2 <span class="token operator">=</span> <span class="token function">getRandomShellSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> shell1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Shell</span><span class="token punctuation">(</span><span class="token function">shellFromConfig</span><span class="token punctuation">(</span>size1<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> shell2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Shell</span><span class="token punctuation">(</span><span class="token function">shellFromConfig</span><span class="token punctuation">(</span>size2<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> leftOffset <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.2</span> <span class="token operator">-</span> <span class="token number">0.1</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> rightOffset <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.2</span> <span class="token operator">-</span> <span class="token number">0.1</span><span class="token punctuation">;</span>
shell1<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token number">0.3</span> <span class="token operator">+</span> leftOffset<span class="token punctuation">,</span> size1<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
shell2<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token number">0.7</span> <span class="token operator">+</span> rightOffset<span class="token punctuation">,</span> size2<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> extraDelay <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>shell1<span class="token punctuation">.</span>starLife<span class="token punctuation">,</span> shell2<span class="token punctuation">.</span>starLife<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>shell1<span class="token punctuation">.</span>fallingLeaves <span class="token operator">||</span> shell2<span class="token punctuation">.</span>fallingLeaves<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
extraDelay <span class="token operator">=</span> <span class="token number">4000</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">return</span> <span class="token number">900</span> <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">600</span> <span class="token operator">+</span> extraDelay<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">seqTriple</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> shellType <span class="token operator">=</span> <span class="token function">randomFastShell</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> baseSize <span class="token operator">=</span> <span class="token function">shellSizeSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> smallSize <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> baseSize <span class="token operator">-</span> <span class="token number">1.25</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> offset <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.08</span> <span class="token operator">-</span> <span class="token number">0.04</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> shell1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Shell</span><span class="token punctuation">(</span><span class="token function">shellType</span><span class="token punctuation">(</span>baseSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
shell1<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token number">0.5</span> <span class="token operator">+</span> offset<span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> leftDelay <span class="token operator">=</span> <span class="token number">1000</span> <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">400</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> rightDelay <span class="token operator">=</span> <span class="token number">1000</span> <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">400</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> offset <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.08</span> <span class="token operator">-</span> <span class="token number">0.04</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> shell2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Shell</span><span class="token punctuation">(</span><span class="token function">shellType</span><span class="token punctuation">(</span>smallSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
shell2<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token number">0.2</span> <span class="token operator">+</span> offset<span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> leftDelay<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> offset <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.08</span> <span class="token operator">-</span> <span class="token number">0.04</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> shell3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Shell</span><span class="token punctuation">(</span><span class="token function">shellType</span><span class="token punctuation">(</span>smallSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
shell3<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token number">0.8</span> <span class="token operator">+</span> offset<span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> rightDelay<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token number">4000</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">seqSmallBarrage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
seqSmallBarrage<span class="token punctuation">.</span>lastCalled <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> barrageCount <span class="token operator">=</span> <span class="token constant">IS_DESKTOP</span> <span class="token operator">?</span> <span class="token number">11</span> <span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> shellSize <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">shellSizeSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> useCrysanthemum <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.7</span><span class="token punctuation">;</span>
<span class="token comment">// (cos(x*5π+0.5π)+1)/2 is a custom wave bounded by 0 and 1 used to set varying launch heights</span>
<span class="token keyword">function</span> <span class="token function">launchShell</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> isRandom <span class="token operator">=</span> <span class="token function">shellNameSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'Random'</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> shellType <span class="token operator">=</span> isRandom <span class="token operator">?</span> <span class="token punctuation">(</span>useCrysanthemum <span class="token operator">?</span> crysanthemumShell <span class="token operator">:</span> <span class="token function">randomFastShell</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> shellTypes<span class="token punctuation">[</span><span class="token function">shellNameSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> shell <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Shell</span><span class="token punctuation">(</span><span class="token function">shellType</span><span class="token punctuation">(</span>shellSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> height <span class="token operator">=</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>x<span class="token operator">*</span><span class="token number">5</span><span class="token operator">*</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">+</span> <span class="token constant">PI_HALF</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
shell<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> height <span class="token operator">*</span> <span class="token number">0.75</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> delay <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">while</span><span class="token punctuation">(</span>count <span class="token operator">&lt;</span> barrageCount<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token function">launchShell</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>
count <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> offset <span class="token operator">=</span> <span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> barrageCount <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
<span class="token function">launchShell</span><span class="token punctuation">(</span><span class="token number">0.5</span> <span class="token operator">+</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">launchShell</span><span class="token punctuation">(</span><span class="token number">0.5</span> <span class="token operator">-</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> delay<span class="token punctuation">)</span><span class="token punctuation">;</span>
count <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
delay <span class="token operator">+=</span> <span class="token number">200</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">return</span> <span class="token number">3400</span> <span class="token operator">+</span> barrageCount <span class="token operator">*</span> <span class="token number">120</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
seqSmallBarrage<span class="token punctuation">.</span>cooldown <span class="token operator">=</span> <span class="token number">15000</span><span class="token punctuation">;</span>
seqSmallBarrage<span class="token punctuation">.</span>lastCalled <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">const</span> sequences <span class="token operator">=</span> <span class="token punctuation">[</span>
seqRandomShell<span class="token punctuation">,</span>
seqTwoRandom<span class="token punctuation">,</span>
seqTriple<span class="token punctuation">,</span>
seqSmallBarrage
<span class="token punctuation">]</span><span class="token punctuation">;</span>


<span class="token keyword">let</span> isFirstSeq <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> finaleCount <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> currentFinaleCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">startSequence</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>isFirstSeq<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
isFirstSeq <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> shell <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Shell</span><span class="token punctuation">(</span><span class="token function">crysanthemumShell</span><span class="token punctuation">(</span><span class="token function">shellSizeSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
shell<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token number">2400</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">finaleSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token function">seqRandomShell</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>currentFinaleCount <span class="token operator">&lt;</span> finaleCount<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
currentFinaleCount<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token number">170</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
currentFinaleCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token number">6000</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> rand <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>rand <span class="token operator">&lt;</span> <span class="token number">0.2</span> <span class="token operator">&amp;&amp;</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> seqSmallBarrage<span class="token punctuation">.</span>lastCalled <span class="token operator">&gt;</span> seqSmallBarrage<span class="token punctuation">.</span>cooldown<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">return</span> <span class="token function">seqSmallBarrage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>rand <span class="token operator">&lt;</span> <span class="token number">0.6</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">return</span> <span class="token function">seqRandomShell</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rand <span class="token operator">&lt;</span> <span class="token number">0.8</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">return</span> <span class="token function">seqTwoRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rand <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">return</span> <span class="token function">seqTriple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">let</span> activePointerCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> isUpdatingSpeed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">handlePointerStart</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
activePointerCount<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> btnSize <span class="token operator">=</span> <span class="token number">44</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> btnSize<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>x <span class="token operator">&lt;</span> btnSize<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token function">togglePause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>x <span class="token operator">&gt;</span> mainStage<span class="token punctuation">.</span>width<span class="token operator">/</span><span class="token number">2</span> <span class="token operator">-</span> btnSize<span class="token operator">/</span><span class="token number">2</span> <span class="token operator">&amp;&amp;</span> event<span class="token punctuation">.</span>x <span class="token operator">&lt;</span> mainStage<span class="token punctuation">.</span>width<span class="token operator">/</span><span class="token number">2</span> <span class="token operator">+</span> btnSize<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token function">toggleLongExposure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>x <span class="token operator">&gt;</span> mainStage<span class="token punctuation">.</span>width <span class="token operator">-</span> btnSize<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token function">toggleMenu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">canInteract</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">updateSpeedFromEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
isUpdatingSpeed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>onCanvas<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token function">launchShellFromConfig</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">handlePointerEnd</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
activePointerCount<span class="token operator">--</span><span class="token punctuation">;</span>
isUpdatingSpeed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">handlePointerMove</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">canInteract</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>isUpdatingSpeed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token function">updateSpeedFromEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">handleKeydown</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">// P</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>keyCode <span class="token operator">===</span> <span class="token number">80</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token function">togglePause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// O</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>keyCode <span class="token operator">===</span> <span class="token number">79</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token function">toggleMenu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// Esc</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>keyCode <span class="token operator">===</span> <span class="token number">27</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token function">toggleMenu</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

mainStage<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'pointerstart'</span><span class="token punctuation">,</span> handlePointerStart<span class="token punctuation">)</span><span class="token punctuation">;</span>
mainStage<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'pointerend'</span><span class="token punctuation">,</span> handlePointerEnd<span class="token punctuation">)</span><span class="token punctuation">;</span>
mainStage<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'pointermove'</span><span class="token punctuation">,</span> handlePointerMove<span class="token punctuation">)</span><span class="token punctuation">;</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'keydown'</span><span class="token punctuation">,</span> handleKeydown<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Try to go fullscreen upon a touch</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'touchend'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span><span class="token constant">IS_DESKTOP</span> <span class="token operator">&amp;&amp;</span> <span class="token function">requestFullscreen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">function</span> <span class="token function">handleResize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> w <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span>
<span class="token keyword">const</span> h <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>
<span class="token comment">// Try to adopt screen size, heeding maximum sizes specified</span>
<span class="token keyword">const</span> containerW <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token constant">MAX_WIDTH</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// On small screens, use full device height</span>
<span class="token keyword">const</span> containerH <span class="token operator">=</span> w <span class="token operator">&lt;=</span> <span class="token number">420</span> <span class="token operator">?</span> h <span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> <span class="token constant">MAX_HEIGHT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
appNodes<span class="token punctuation">.</span>stageContainer<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> containerW <span class="token operator">+</span> <span class="token string">'px'</span><span class="token punctuation">;</span>
appNodes<span class="token punctuation">.</span>stageContainer<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> containerH <span class="token operator">+</span> <span class="token string">'px'</span><span class="token punctuation">;</span>
stages<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">stage</span> <span class="token operator">=&gt;</span> stage<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>containerW<span class="token punctuation">,</span> containerH<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Compute initial dimensions</span>
<span class="token function">handleResize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'resize'</span><span class="token punctuation">,</span> handleResize<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// Dynamic globals</span>
<span class="token keyword">let</span> speedBarOpacity <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> autoLaunchTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">updateSpeedFromEvent</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>isUpdatingSpeed <span class="token operator">||</span> event<span class="token punctuation">.</span>y <span class="token operator">&gt;=</span> mainStage<span class="token punctuation">.</span>height <span class="token operator">-</span> <span class="token number">44</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">// On phones it's hard to hit the edge pixels in order to set speed at 0 or 1, so some padding is provided to make that easier.</span>
<span class="token keyword">const</span> edge <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> newSpeed <span class="token operator">=</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>x <span class="token operator">-</span> edge<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>mainStage<span class="token punctuation">.</span>width <span class="token operator">-</span> edge <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
simSpeed <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>newSpeed<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// show speed bar after an update</span>
speedBarOpacity <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">// If we updated the speed, return true</span>
<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// Return false if the speed wasn't updated</span>
<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">// Extracted function to keep `update()` optimized</span>
<span class="token keyword">function</span> <span class="token function">updateGlobals</span><span class="token punctuation">(</span><span class="token parameter">timeStep<span class="token punctuation">,</span> lag</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">// Always try to fade out speed bar</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isUpdatingSpeed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
speedBarOpacity <span class="token operator">-=</span> lag <span class="token operator">/</span> <span class="token number">30</span><span class="token punctuation">;</span> <span class="token comment">// half a second</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>speedBarOpacity <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
speedBarOpacity <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// auto launch shells</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>config<span class="token punctuation">.</span>autoLaunch<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
autoLaunchTime <span class="token operator">-=</span> timeStep<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>autoLaunchTime <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
autoLaunchTime <span class="token operator">=</span> <span class="token function">startSequence</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">frameTime<span class="token punctuation">,</span> lag</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">canInteract</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> width<span class="token punctuation">,</span> height <span class="token punctuation">}</span> <span class="token operator">=</span> mainStage<span class="token punctuation">;</span>
<span class="token keyword">const</span> timeStep <span class="token operator">=</span> frameTime <span class="token operator">*</span> simSpeed<span class="token punctuation">;</span>
<span class="token keyword">const</span> speed <span class="token operator">=</span> simSpeed <span class="token operator">*</span> lag<span class="token punctuation">;</span>
<span class="token function">updateGlobals</span><span class="token punctuation">(</span>timeStep<span class="token punctuation">,</span> lag<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> starDrag <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> Star<span class="token punctuation">.</span>airDrag<span class="token punctuation">)</span> <span class="token operator">*</span> speed<span class="token punctuation">;</span>
<span class="token keyword">const</span> starDragHeavy <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> Star<span class="token punctuation">.</span>airDragHeavy<span class="token punctuation">)</span> <span class="token operator">*</span> speed<span class="token punctuation">;</span>
<span class="token keyword">const</span> sparkDrag <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> Spark<span class="token punctuation">.</span>airDrag<span class="token punctuation">)</span> <span class="token operator">*</span> speed<span class="token punctuation">;</span>
<span class="token keyword">const</span> gAcc <span class="token operator">=</span> timeStep <span class="token operator">/</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token constant">GRAVITY</span><span class="token punctuation">;</span>
<span class="token constant">COLOR_CODES_W_INVIS</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">color</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">// Stars</span>
Star<span class="token punctuation">.</span>active<span class="token punctuation">[</span>color<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">star<span class="token punctuation">,</span> i<span class="token punctuation">,</span> stars</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
star<span class="token punctuation">.</span>life <span class="token operator">-=</span> timeStep<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>star<span class="token punctuation">.</span>life <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
stars<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Star<span class="token punctuation">.</span><span class="token function">returnInstance</span><span class="token punctuation">(</span>star<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
star<span class="token punctuation">.</span>prevX <span class="token operator">=</span> star<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
star<span class="token punctuation">.</span>prevY <span class="token operator">=</span> star<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
star<span class="token punctuation">.</span>x <span class="token operator">+=</span> star<span class="token punctuation">.</span>speedX <span class="token operator">*</span> speed<span class="token punctuation">;</span>
star<span class="token punctuation">.</span>y <span class="token operator">+=</span> star<span class="token punctuation">.</span>speedY <span class="token operator">*</span> speed<span class="token punctuation">;</span>
<span class="token comment">// Apply air drag if star isn't "heavy". The heavy property is used for the shell comets.</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>star<span class="token punctuation">.</span>heavy<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
star<span class="token punctuation">.</span>speedX <span class="token operator">*=</span> starDrag<span class="token punctuation">;</span>
star<span class="token punctuation">.</span>speedY <span class="token operator">*=</span> starDrag<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
star<span class="token punctuation">.</span>speedX <span class="token operator">*=</span> starDragHeavy<span class="token punctuation">;</span>
star<span class="token punctuation">.</span>speedY <span class="token operator">*=</span> starDragHeavy<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
star<span class="token punctuation">.</span>speedY <span class="token operator">+=</span> gAcc<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>star<span class="token punctuation">.</span>spinRadius<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
star<span class="token punctuation">.</span>spinAngle <span class="token operator">+=</span> star<span class="token punctuation">.</span>spinSpeed <span class="token operator">*</span> speed<span class="token punctuation">;</span>
star<span class="token punctuation">.</span>x <span class="token operator">+=</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>star<span class="token punctuation">.</span>spinAngle<span class="token punctuation">)</span> <span class="token operator">*</span> star<span class="token punctuation">.</span>spinRadius <span class="token operator">*</span> speed<span class="token punctuation">;</span>
star<span class="token punctuation">.</span>y <span class="token operator">+=</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>star<span class="token punctuation">.</span>spinAngle<span class="token punctuation">)</span> <span class="token operator">*</span> star<span class="token punctuation">.</span>spinRadius <span class="token operator">*</span> speed<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>star<span class="token punctuation">.</span>sparkFreq<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
star<span class="token punctuation">.</span>sparkTimer <span class="token operator">-=</span> timeStep<span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>star<span class="token punctuation">.</span>sparkTimer <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
star<span class="token punctuation">.</span>sparkTimer <span class="token operator">+=</span> star<span class="token punctuation">.</span>sparkFreq<span class="token punctuation">;</span>
Spark<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>
star<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
star<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
star<span class="token punctuation">.</span>sparkColor<span class="token punctuation">,</span>
Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">PI_2</span><span class="token punctuation">,</span>
Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> star<span class="token punctuation">.</span>sparkSpeed<span class="token punctuation">,</span>
star<span class="token punctuation">.</span>sparkLife <span class="token operator">*</span> <span class="token number">0.8</span> <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> star<span class="token punctuation">.</span>sparkLifeVariation <span class="token operator">*</span> star<span class="token punctuation">.</span>sparkLife
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Sparks</span>
Spark<span class="token punctuation">.</span>active<span class="token punctuation">[</span>color<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">spark<span class="token punctuation">,</span> i<span class="token punctuation">,</span> sparks</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
spark<span class="token punctuation">.</span>life <span class="token operator">-=</span> timeStep<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>spark<span class="token punctuation">.</span>life <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
sparks<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Spark<span class="token punctuation">.</span><span class="token function">returnInstance</span><span class="token punctuation">(</span>spark<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
spark<span class="token punctuation">.</span>prevX <span class="token operator">=</span> spark<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
spark<span class="token punctuation">.</span>prevY <span class="token operator">=</span> spark<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
spark<span class="token punctuation">.</span>x <span class="token operator">+=</span> spark<span class="token punctuation">.</span>speedX <span class="token operator">*</span> speed<span class="token punctuation">;</span>
spark<span class="token punctuation">.</span>y <span class="token operator">+=</span> spark<span class="token punctuation">.</span>speedY <span class="token operator">*</span> speed<span class="token punctuation">;</span>
spark<span class="token punctuation">.</span>speedX <span class="token operator">*=</span> sparkDrag<span class="token punctuation">;</span>
spark<span class="token punctuation">.</span>speedY <span class="token operator">*=</span> sparkDrag<span class="token punctuation">;</span>
spark<span class="token punctuation">.</span>speedY <span class="token operator">+=</span> gAcc<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">render</span><span class="token punctuation">(</span>speed<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">speed</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> dpr<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height <span class="token punctuation">}</span> <span class="token operator">=</span> mainStage<span class="token punctuation">;</span>
<span class="token keyword">const</span> trailsCtx <span class="token operator">=</span> trailsStage<span class="token punctuation">.</span>ctx<span class="token punctuation">;</span>
<span class="token keyword">const</span> mainCtx <span class="token operator">=</span> mainStage<span class="token punctuation">.</span>ctx<span class="token punctuation">;</span>
<span class="token function">colorSky</span><span class="token punctuation">(</span>speed<span class="token punctuation">)</span><span class="token punctuation">;</span>
trailsCtx<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span>dpr<span class="token punctuation">,</span> dpr<span class="token punctuation">)</span><span class="token punctuation">;</span>
mainCtx<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span>dpr<span class="token punctuation">,</span> dpr<span class="token punctuation">)</span><span class="token punctuation">;</span>
trailsCtx<span class="token punctuation">.</span>globalCompositeOperation <span class="token operator">=</span> <span class="token string">'source-over'</span><span class="token punctuation">;</span>
trailsCtx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">rgba(0, 0, 0, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>longExposure <span class="token operator">?</span> <span class="token number">0.0025</span> <span class="token operator">:</span> <span class="token number">0.1</span> <span class="token operator">*</span> speed<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
trailsCtx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Remaining drawing on trails canvas will use 'lighten' blend mode</span>
trailsCtx<span class="token punctuation">.</span>globalCompositeOperation <span class="token operator">=</span> <span class="token string">'lighten'</span><span class="token punctuation">;</span>
mainCtx<span class="token punctuation">.</span><span class="token function">clearRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Draw queued burst flashes</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>BurstFlash<span class="token punctuation">.</span>active<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> bf <span class="token operator">=</span> BurstFlash<span class="token punctuation">.</span>active<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> burstGradient <span class="token operator">=</span> trailsCtx<span class="token punctuation">.</span><span class="token function">createRadialGradient</span><span class="token punctuation">(</span>bf<span class="token punctuation">.</span>x<span class="token punctuation">,</span> bf<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> bf<span class="token punctuation">.</span>x<span class="token punctuation">,</span> bf<span class="token punctuation">.</span>y<span class="token punctuation">,</span> bf<span class="token punctuation">.</span>radius<span class="token punctuation">)</span><span class="token punctuation">;</span>
burstGradient<span class="token punctuation">.</span><span class="token function">addColorStop</span><span class="token punctuation">(</span><span class="token number">0.05</span><span class="token punctuation">,</span> <span class="token string">'white'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
burstGradient<span class="token punctuation">.</span><span class="token function">addColorStop</span><span class="token punctuation">(</span><span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token string">'rgba(255, 160, 20, 0.2)'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
burstGradient<span class="token punctuation">.</span><span class="token function">addColorStop</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'rgba(255, 160, 20, 0)'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
trailsCtx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> burstGradient<span class="token punctuation">;</span>
trailsCtx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span>bf<span class="token punctuation">.</span>x <span class="token operator">-</span> bf<span class="token punctuation">.</span>radius<span class="token punctuation">,</span> bf<span class="token punctuation">.</span>y <span class="token operator">-</span> bf<span class="token punctuation">.</span>radius<span class="token punctuation">,</span> bf<span class="token punctuation">.</span>radius <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> bf<span class="token punctuation">.</span>radius <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
BurstFlash<span class="token punctuation">.</span><span class="token function">returnInstance</span><span class="token punctuation">(</span>bf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// Draw stars</span>
trailsCtx<span class="token punctuation">.</span>lineWidth <span class="token operator">=</span> Star<span class="token punctuation">.</span>drawWidth<span class="token punctuation">;</span>
trailsCtx<span class="token punctuation">.</span>lineCap <span class="token operator">=</span> <span class="token string">'round'</span><span class="token punctuation">;</span>
mainCtx<span class="token punctuation">.</span>strokeStyle <span class="token operator">=</span> <span class="token string">'#fff'</span><span class="token punctuation">;</span>
  mainCtx<span class="token punctuation">.</span>lineWidth <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
mainCtx<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">COLOR_CODES</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">color</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> stars <span class="token operator">=</span> Star<span class="token punctuation">.</span>active<span class="token punctuation">[</span>color<span class="token punctuation">]</span><span class="token punctuation">;</span>
trailsCtx<span class="token punctuation">.</span>strokeStyle <span class="token operator">=</span> color<span class="token punctuation">;</span>
trailsCtx<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stars<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">star</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
trailsCtx<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span>star<span class="token punctuation">.</span>x<span class="token punctuation">,</span> star<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
trailsCtx<span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span>star<span class="token punctuation">.</span>prevX<span class="token punctuation">,</span> star<span class="token punctuation">.</span>prevY<span class="token punctuation">)</span><span class="token punctuation">;</span>
mainCtx<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span>star<span class="token punctuation">.</span>x<span class="token punctuation">,</span> star<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
mainCtx<span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span>star<span class="token punctuation">.</span>x <span class="token operator">-</span> star<span class="token punctuation">.</span>speedX <span class="token operator">*</span> <span class="token number">1.6</span><span class="token punctuation">,</span> star<span class="token punctuation">.</span>y <span class="token operator">-</span> star<span class="token punctuation">.</span>speedY <span class="token operator">*</span> <span class="token number">1.6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
trailsCtx<span class="token punctuation">.</span><span class="token function">stroke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mainCtx<span class="token punctuation">.</span><span class="token function">stroke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Draw sparks</span>
trailsCtx<span class="token punctuation">.</span>lineWidth <span class="token operator">=</span> Spark<span class="token punctuation">.</span>drawWidth<span class="token punctuation">;</span>
trailsCtx<span class="token punctuation">.</span>lineCap <span class="token operator">=</span> <span class="token string">'butt'</span><span class="token punctuation">;</span>
<span class="token constant">COLOR_CODES</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">color</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> sparks <span class="token operator">=</span> Spark<span class="token punctuation">.</span>active<span class="token punctuation">[</span>color<span class="token punctuation">]</span><span class="token punctuation">;</span>
trailsCtx<span class="token punctuation">.</span>strokeStyle <span class="token operator">=</span> color<span class="token punctuation">;</span>
trailsCtx<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
sparks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">spark</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
trailsCtx<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span>spark<span class="token punctuation">.</span>x<span class="token punctuation">,</span> spark<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
trailsCtx<span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span>spark<span class="token punctuation">.</span>prevX<span class="token punctuation">,</span> spark<span class="token punctuation">.</span>prevY<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
trailsCtx<span class="token punctuation">.</span><span class="token function">stroke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Render speed bar if visible</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>speedBarOpacity<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> speedBarHeight <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
mainCtx<span class="token punctuation">.</span>globalAlpha <span class="token operator">=</span> speedBarOpacity<span class="token punctuation">;</span>
mainCtx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token constant">COLOR</span><span class="token punctuation">.</span>Blue<span class="token punctuation">;</span>
mainCtx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> height <span class="token operator">-</span> speedBarHeight<span class="token punctuation">,</span> width <span class="token operator">*</span> simSpeed<span class="token punctuation">,</span> speedBarHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
mainCtx<span class="token punctuation">.</span>globalAlpha <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
trailsCtx<span class="token punctuation">.</span><span class="token function">resetTransform</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mainCtx<span class="token punctuation">.</span><span class="token function">resetTransform</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">// Draw colored overlay based on combined brightness of stars (light up the sky!)</span>
<span class="token comment">// Note: this is applied to the canvas container's background-color, so it's behind the particles</span>
<span class="token keyword">const</span> currentSkyColor <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">r</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">g</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> targetSkyColor <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">r</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">g</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">colorSky</span><span class="token punctuation">(</span><span class="token parameter">speed</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">// The maximum r, g, or b value that will be used (255 would represent no maximum)</span>
<span class="token keyword">const</span> maxSkySaturation <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>
<span class="token comment">// How many stars are required in total to reach maximum sky brightness</span>
<span class="token keyword">const</span> maxStarCount <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> totalStarCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">// Initialize sky as black</span>
targetSkyColor<span class="token punctuation">.</span>r <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
targetSkyColor<span class="token punctuation">.</span>g <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
targetSkyColor<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">// Add each known color to sky, multiplied by particle count of that color. This will put RGB values wildly out of bounds, but we'll scale them back later.</span>
<span class="token comment">// Also add up total star count.</span>
<span class="token constant">COLOR_CODES</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">color</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> tuple <span class="token operator">=</span> <span class="token constant">COLOR_TUPLES</span><span class="token punctuation">[</span>color<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> count <span class="token operator">=</span>  Star<span class="token punctuation">.</span>active<span class="token punctuation">[</span>color<span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
totalStarCount <span class="token operator">+=</span> count<span class="token punctuation">;</span>
targetSkyColor<span class="token punctuation">.</span>r <span class="token operator">+=</span> tuple<span class="token punctuation">.</span>r <span class="token operator">*</span> count<span class="token punctuation">;</span>
targetSkyColor<span class="token punctuation">.</span>g <span class="token operator">+=</span> tuple<span class="token punctuation">.</span>g <span class="token operator">*</span> count<span class="token punctuation">;</span>
targetSkyColor<span class="token punctuation">.</span>b <span class="token operator">+=</span> tuple<span class="token punctuation">.</span>b <span class="token operator">*</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Clamp intensity at 1.0, and map to a custom non-linear curve. This allows few stars to perceivably light up the sky, while more stars continue to increase the brightness but at a lesser rate. This is more inline with humans' non-linear brightness perception.</span>
<span class="token keyword">const</span> intensity <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> totalStarCount <span class="token operator">/</span> maxStarCount<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Figure out which color component has the highest value, so we can scale them without affecting the ratios.</span>
<span class="token comment">// Prevent 0 from being used, so we don't divide by zero in the next step.</span>
<span class="token keyword">const</span> maxColorComponent <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> targetSkyColor<span class="token punctuation">.</span>r<span class="token punctuation">,</span> targetSkyColor<span class="token punctuation">.</span>g<span class="token punctuation">,</span> targetSkyColor<span class="token punctuation">.</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Scale all color components to a max of `maxSkySaturation`, and apply intensity.</span>
targetSkyColor<span class="token punctuation">.</span>r <span class="token operator">=</span> targetSkyColor<span class="token punctuation">.</span>r <span class="token operator">/</span> maxColorComponent <span class="token operator">*</span> maxSkySaturation <span class="token operator">*</span> intensity<span class="token punctuation">;</span>
targetSkyColor<span class="token punctuation">.</span>g <span class="token operator">=</span> targetSkyColor<span class="token punctuation">.</span>g <span class="token operator">/</span> maxColorComponent <span class="token operator">*</span> maxSkySaturation <span class="token operator">*</span> intensity<span class="token punctuation">;</span>
targetSkyColor<span class="token punctuation">.</span>b <span class="token operator">=</span> targetSkyColor<span class="token punctuation">.</span>b <span class="token operator">/</span> maxColorComponent <span class="token operator">*</span> maxSkySaturation <span class="token operator">*</span> intensity<span class="token punctuation">;</span>
<span class="token comment">// Animate changes to color to smooth out transitions.</span>
<span class="token keyword">const</span> colorChange <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
currentSkyColor<span class="token punctuation">.</span>r <span class="token operator">+=</span> <span class="token punctuation">(</span>targetSkyColor<span class="token punctuation">.</span>r <span class="token operator">-</span> currentSkyColor<span class="token punctuation">.</span>r<span class="token punctuation">)</span> <span class="token operator">/</span> colorChange <span class="token operator">*</span> speed<span class="token punctuation">;</span>
currentSkyColor<span class="token punctuation">.</span>g <span class="token operator">+=</span> <span class="token punctuation">(</span>targetSkyColor<span class="token punctuation">.</span>g <span class="token operator">-</span> currentSkyColor<span class="token punctuation">.</span>g<span class="token punctuation">)</span> <span class="token operator">/</span> colorChange <span class="token operator">*</span> speed<span class="token punctuation">;</span>
currentSkyColor<span class="token punctuation">.</span>b <span class="token operator">+=</span> <span class="token punctuation">(</span>targetSkyColor<span class="token punctuation">.</span>b <span class="token operator">-</span> currentSkyColor<span class="token punctuation">.</span>b<span class="token punctuation">)</span> <span class="token operator">/</span> colorChange <span class="token operator">*</span> speed<span class="token punctuation">;</span>
appNodes<span class="token punctuation">.</span>canvasContainer<span class="token punctuation">.</span>style<span class="token punctuation">.</span>backgroundColor <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">rgb(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>currentSkyColor<span class="token punctuation">.</span>r <span class="token operator">|</span> <span class="token number">0</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>currentSkyColor<span class="token punctuation">.</span>g <span class="token operator">|</span> <span class="token number">0</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>currentSkyColor<span class="token punctuation">.</span>b <span class="token operator">|</span> <span class="token number">0</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

mainStage<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'ticker'</span><span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// Helper used to semi-randomly spread particles over an arc</span>
<span class="token comment">// Values are flexible - `start` and `arcLength` can be negative, and `randomness` is simply a multiplier for random addition.</span>
<span class="token keyword">function</span> <span class="token function">createParticleArc</span><span class="token punctuation">(</span><span class="token parameter">start<span class="token punctuation">,</span> arcLength<span class="token punctuation">,</span> count<span class="token punctuation">,</span> randomness<span class="token punctuation">,</span> particleFactory</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> angleDelta <span class="token operator">=</span> arcLength <span class="token operator">/</span> count<span class="token punctuation">;</span>
<span class="token comment">// Sometimes there is an extra particle at the end, too close to the start. Subtracting half the angleDelta ensures that is skipped.</span>
<span class="token comment">// Would be nice to fix this a better way.</span>
<span class="token keyword">const</span> end <span class="token operator">=</span> start <span class="token operator">+</span> arcLength <span class="token operator">-</span> <span class="token punctuation">(</span>angleDelta <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>end <span class="token operator">&gt;</span> start<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">// Optimization: `angle=angle+angleDelta` vs. angle+=angleDelta</span>
<span class="token comment">// V8 deoptimises with let compound assignment</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> angle<span class="token operator">=</span>start<span class="token punctuation">;</span> angle<span class="token operator">&lt;</span>end<span class="token punctuation">;</span> angle<span class="token operator">=</span>angle<span class="token operator">+</span>angleDelta<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token function">particleFactory</span><span class="token punctuation">(</span>angle <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> angleDelta <span class="token operator">*</span> randomness<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> angle<span class="token operator">=</span>start<span class="token punctuation">;</span> angle<span class="token operator">&gt;</span>end<span class="token punctuation">;</span> angle<span class="token operator">=</span>angle<span class="token operator">+</span>angleDelta<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token function">particleFactory</span><span class="token punctuation">(</span>angle <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> angleDelta <span class="token operator">*</span> randomness<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">// Various star effects.</span>
<span class="token comment">// These are designed to be attached to a star's `onDeath` event.</span>

<span class="token comment">// Crossette breaks star into four same-color pieces which branch in a cross-like shape.</span>
<span class="token keyword">function</span> <span class="token function">crossetteEffect</span><span class="token punctuation">(</span><span class="token parameter">star</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> startAngle <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">PI_HALF</span><span class="token punctuation">;</span>
<span class="token function">createParticleArc</span><span class="token punctuation">(</span>startAngle<span class="token punctuation">,</span> <span class="token constant">PI_2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">angle</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
Star<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>
star<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
star<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
star<span class="token punctuation">.</span>color<span class="token punctuation">,</span>
angle<span class="token punctuation">,</span>
Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.6</span> <span class="token operator">+</span> <span class="token number">0.75</span><span class="token punctuation">,</span>
<span class="token number">600</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Flower is like a mini shell</span>
<span class="token keyword">function</span> <span class="token function">floralEffect</span><span class="token punctuation">(</span><span class="token parameter">star</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> startAngle <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">PI_HALF</span><span class="token punctuation">;</span>
<span class="token function">createParticleArc</span><span class="token punctuation">(</span>startAngle<span class="token punctuation">,</span> <span class="token constant">PI_2</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">angle</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
Star<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>
star<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
star<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
star<span class="token punctuation">.</span>color<span class="token punctuation">,</span>
angle<span class="token punctuation">,</span>
<span class="token comment">// apply near cubic falloff to speed (places more particles towards outside)</span>
Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.45</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2.4</span><span class="token punctuation">,</span>
<span class="token number">1000</span> <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">300</span><span class="token punctuation">,</span>
star<span class="token punctuation">.</span>speedX<span class="token punctuation">,</span>
star<span class="token punctuation">.</span>speedY
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Queue burst flash render</span>
BurstFlash<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>star<span class="token punctuation">.</span>x<span class="token punctuation">,</span> star<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Floral burst with willow stars</span>
<span class="token keyword">function</span> <span class="token function">fallingLeavesEffect</span><span class="token punctuation">(</span><span class="token parameter">star</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> startAngle <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">PI_HALF</span><span class="token punctuation">;</span>
<span class="token function">createParticleArc</span><span class="token punctuation">(</span>startAngle<span class="token punctuation">,</span> <span class="token constant">PI_2</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">angle</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> newStar <span class="token operator">=</span> Star<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>
star<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
star<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
<span class="token constant">INVISIBLE</span><span class="token punctuation">,</span>
angle<span class="token punctuation">,</span>
<span class="token comment">// apply near cubic falloff to speed (places more particles towards outside)</span>
Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.45</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2.4</span><span class="token punctuation">,</span>
<span class="token number">2400</span> <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">600</span><span class="token punctuation">,</span>
star<span class="token punctuation">.</span>speedX<span class="token punctuation">,</span>
star<span class="token punctuation">.</span>speedY
<span class="token punctuation">)</span><span class="token punctuation">;</span>
newStar<span class="token punctuation">.</span>sparkColor <span class="token operator">=</span> <span class="token constant">COLOR</span><span class="token punctuation">.</span>Gold<span class="token punctuation">;</span>
newStar<span class="token punctuation">.</span>sparkFreq <span class="token operator">=</span> <span class="token number">72</span><span class="token punctuation">;</span>
newStar<span class="token punctuation">.</span>sparkSpeed <span class="token operator">=</span> <span class="token number">0.28</span><span class="token punctuation">;</span>
newStar<span class="token punctuation">.</span>sparkLife <span class="token operator">=</span> <span class="token number">750</span><span class="token punctuation">;</span>
newStar<span class="token punctuation">.</span>sparkLifeVariation <span class="token operator">=</span> <span class="token number">3.2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Queue burst flash render</span>
BurstFlash<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>star<span class="token punctuation">.</span>x<span class="token punctuation">,</span> star<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Crackle pops into a small cloud of golden sparks.</span>
<span class="token keyword">function</span> <span class="token function">crackleEffect</span><span class="token punctuation">(</span><span class="token parameter">star</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token function">createParticleArc</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">PI_2</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1.8</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">angle</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
Spark<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>
star<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
star<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
<span class="token constant">COLOR</span><span class="token punctuation">.</span>Gold<span class="token punctuation">,</span>
angle<span class="token punctuation">,</span>
<span class="token comment">// apply near cubic falloff to speed (places more particles towards outside)</span>
Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.45</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2.4</span><span class="token punctuation">,</span>
<span class="token number">300</span> <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">200</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>



<span class="token comment">/**
 * Shell can be constructed with options:
 *
 * size:      Size of the burst.
 * starCount: Number of stars to create. This is optional, and will be set to a reasonable quantity for size if omitted.
 * starLife:
 * starLifeVariation:
 * color:
 * glitterColor:
 * glitter: One of: 'light', 'medium', 'heavy', 'streamer', 'willow'
 * pistil:
 * pistilColor:
 * streamers:
 * crossette:
 * floral:
 * crackle:
 */</span>

<span class="token keyword">class</span> <span class="token class-name">Shell</span> <span class="token punctuation">{<!-- --></span>
<span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>starLifeVariation <span class="token operator">=</span> options<span class="token punctuation">.</span>starLifeVariation <span class="token operator">||</span> <span class="token number">0.125</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>color <span class="token operator">=</span> options<span class="token punctuation">.</span>color <span class="token operator">||</span> <span class="token function">randomColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>glitterColor <span class="token operator">=</span> options<span class="token punctuation">.</span>glitterColor <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>color<span class="token punctuation">;</span>
<span class="token comment">// Set default starCount if needed, will be based on shell size and scale exponentially, like a sphere's surface area.</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>starCount<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> density <span class="token operator">=</span> options<span class="token punctuation">.</span>starDensity <span class="token operator">||</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> scaledSize <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>size <span class="token operator">/</span> <span class="token number">50</span> <span class="token operator">*</span> density<span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>starCount <span class="token operator">=</span> scaledSize <span class="token operator">*</span> scaledSize<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">launch</span><span class="token punctuation">(</span><span class="token parameter">position<span class="token punctuation">,</span> launchHeight</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> width<span class="token punctuation">,</span> height <span class="token punctuation">}</span> <span class="token operator">=</span> mainStage<span class="token punctuation">;</span>
<span class="token comment">// Distance from sides of screen to keep shells.</span>
<span class="token keyword">const</span> hpad <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">;</span>
<span class="token comment">// Distance from top of screen to keep shell bursts.</span>
<span class="token keyword">const</span> vpad <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>
<span class="token comment">// Minimum burst height, as a percentage of stage height</span>
<span class="token keyword">const</span> minHeightPercent <span class="token operator">=</span> <span class="token number">0.45</span><span class="token punctuation">;</span>
<span class="token comment">// Minimum burst height in px</span>
<span class="token keyword">const</span> minHeight <span class="token operator">=</span> height <span class="token operator">-</span> height <span class="token operator">*</span> minHeightPercent<span class="token punctuation">;</span>
<span class="token keyword">const</span> launchX <span class="token operator">=</span> position <span class="token operator">*</span> <span class="token punctuation">(</span>width <span class="token operator">-</span> hpad <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> hpad<span class="token punctuation">;</span>
<span class="token keyword">const</span> launchY <span class="token operator">=</span> height<span class="token punctuation">;</span>
<span class="token keyword">const</span> burstY <span class="token operator">=</span> minHeight <span class="token operator">-</span> <span class="token punctuation">(</span>launchHeight <span class="token operator">*</span> <span class="token punctuation">(</span>minHeight <span class="token operator">-</span> vpad<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> launchDistance <span class="token operator">=</span> launchY <span class="token operator">-</span> burstY<span class="token punctuation">;</span>
<span class="token comment">// Using a custom power curve to approximate Vi needed to reach launchDistance under gravity and air drag.</span>
<span class="token comment">// Magic numbers came from testing.</span>
<span class="token keyword">const</span> launchVelocity <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span>launchDistance <span class="token operator">*</span> <span class="token number">0.04</span><span class="token punctuation">,</span> <span class="token number">0.64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> comet <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>comet <span class="token operator">=</span> Star<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>
launchX<span class="token punctuation">,</span>
launchY<span class="token punctuation">,</span>
<span class="token keyword">typeof</span> <span class="token keyword">this</span><span class="token punctuation">.</span>color <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>color <span class="token operator">!==</span> <span class="token string">'random'</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>color <span class="token operator">:</span> <span class="token constant">COLOR</span><span class="token punctuation">.</span>White<span class="token punctuation">,</span>
Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">,</span>
launchVelocity <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>horsetail <span class="token operator">?</span> <span class="token number">1.2</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token comment">// Hang time is derived linearly from Vi; exact number came from testing</span>
launchVelocity <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>horsetail <span class="token operator">?</span> <span class="token number">100</span> <span class="token operator">:</span> <span class="token number">400</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// making comet "heavy" limits air drag</span>
comet<span class="token punctuation">.</span>heavy <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token comment">// comet spark trail</span>
comet<span class="token punctuation">.</span>spinRadius <span class="token operator">=</span> <span class="token number">0.78</span><span class="token punctuation">;</span>
comet<span class="token punctuation">.</span>sparkFreq <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>glitter <span class="token operator">===</span> <span class="token string">'willow'</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fallingLeaves<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
comet<span class="token punctuation">.</span>sparkFreq <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
comet<span class="token punctuation">.</span>sparkSpeed <span class="token operator">=</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
comet<span class="token punctuation">.</span>sparkLife <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>
comet<span class="token punctuation">.</span>sparkLifeVariation <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>color <span class="token operator">===</span> <span class="token constant">INVISIBLE</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
comet<span class="token punctuation">.</span>sparkColor <span class="token operator">=</span> <span class="token constant">COLOR</span><span class="token punctuation">.</span>Gold<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
comet<span class="token punctuation">.</span><span class="token function-variable function">onDeath</span> <span class="token operator">=</span> <span class="token parameter">comet</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">burst</span><span class="token punctuation">(</span>comet<span class="token punctuation">.</span>x<span class="token punctuation">,</span> comet<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// comet.onDeath = () =&gt; this.burst(launchX, burstY);</span>
<span class="token punctuation">}</span>
<span class="token function">burst</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">// Set burst speed so overall burst grows to set size. This specific formula was derived from testing, and is affected by simulated air drag.</span>
<span class="token keyword">const</span> speed <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>size <span class="token operator">/</span> <span class="token number">96</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> color<span class="token punctuation">,</span> onDeath<span class="token punctuation">,</span> sparkFreq<span class="token punctuation">,</span> sparkSpeed<span class="token punctuation">,</span> sparkLife<span class="token punctuation">;</span>
<span class="token keyword">let</span> sparkLifeVariation <span class="token operator">=</span> <span class="token number">0.25</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>crossette<span class="token punctuation">)</span> onDeath <span class="token operator">=</span> crossetteEffect<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>floral<span class="token punctuation">)</span> onDeath <span class="token operator">=</span> floralEffect<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>crackle<span class="token punctuation">)</span> onDeath <span class="token operator">=</span> crackleEffect<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fallingLeaves<span class="token punctuation">)</span> onDeath <span class="token operator">=</span> fallingLeavesEffect<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>glitter <span class="token operator">===</span> <span class="token string">'light'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
sparkFreq <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
sparkSpeed <span class="token operator">=</span> <span class="token number">0.25</span><span class="token punctuation">;</span>
sparkLife <span class="token operator">=</span> <span class="token number">600</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>glitter <span class="token operator">===</span> <span class="token string">'medium'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
sparkFreq <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
sparkSpeed <span class="token operator">=</span> <span class="token number">0.36</span><span class="token punctuation">;</span>
sparkLife <span class="token operator">=</span> <span class="token number">1400</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>glitter <span class="token operator">===</span> <span class="token string">'heavy'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
sparkFreq <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span>
sparkSpeed <span class="token operator">=</span> <span class="token number">0.62</span><span class="token punctuation">;</span>
sparkLife <span class="token operator">=</span> <span class="token number">2800</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>glitter <span class="token operator">===</span> <span class="token string">'streamer'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
sparkFreq <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
sparkSpeed <span class="token operator">=</span> <span class="token number">0.75</span><span class="token punctuation">;</span>
sparkLife <span class="token operator">=</span> <span class="token number">800</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>glitter <span class="token operator">===</span> <span class="token string">'willow'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
sparkFreq <span class="token operator">=</span> <span class="token number">72</span><span class="token punctuation">;</span>
sparkSpeed <span class="token operator">=</span> <span class="token number">0.28</span><span class="token punctuation">;</span>
sparkLife <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>
sparkLifeVariation <span class="token operator">=</span> <span class="token number">3.4</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">starFactory</span> <span class="token operator">=</span> <span class="token parameter">angle</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> star <span class="token operator">=</span> Star<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>
x<span class="token punctuation">,</span>
y<span class="token punctuation">,</span>
color <span class="token operator">||</span> <span class="token function">randomColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
angle<span class="token punctuation">,</span>
<span class="token comment">// apply near cubic falloff to speed (places more particles towards outside)</span>
Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.45</span><span class="token punctuation">)</span> <span class="token operator">*</span> speed<span class="token punctuation">,</span>
<span class="token comment">// add minor variation to star life</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>starLife <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>starLife <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>starLifeVariation<span class="token punctuation">,</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>horsetail <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>comet <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>comet<span class="token punctuation">.</span>speedX<span class="token punctuation">,</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>horsetail <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>comet <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>comet<span class="token punctuation">.</span>speedY
<span class="token punctuation">)</span><span class="token punctuation">;</span>

star<span class="token punctuation">.</span>onDeath <span class="token operator">=</span> onDeath<span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>glitter<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
star<span class="token punctuation">.</span>sparkFreq <span class="token operator">=</span> sparkFreq<span class="token punctuation">;</span>
star<span class="token punctuation">.</span>sparkSpeed <span class="token operator">=</span> sparkSpeed<span class="token punctuation">;</span>
star<span class="token punctuation">.</span>sparkLife <span class="token operator">=</span> sparkLife<span class="token punctuation">;</span>
star<span class="token punctuation">.</span>sparkLifeVariation <span class="token operator">=</span> sparkLifeVariation<span class="token punctuation">;</span>
star<span class="token punctuation">.</span>sparkColor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>glitterColor<span class="token punctuation">;</span>
star<span class="token punctuation">.</span>sparkTimer <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> star<span class="token punctuation">.</span>sparkFreq<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token keyword">this</span><span class="token punctuation">.</span>color <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>color <span class="token operator">===</span> <span class="token string">'random'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
color <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// falsey value creates random color in starFactory</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
color <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>color<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// Rings have positional randomness, but are rotated randomly</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ring<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> ringStartAngle <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> ringSquash <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.45</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.992</span> <span class="token operator">+</span> <span class="token number">0.008</span><span class="token punctuation">;</span>
<span class="token function">createParticleArc</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">PI_2</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>starCount<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token parameter">angle</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">// Create a ring, squashed horizontally</span>
<span class="token keyword">const</span> initSpeedX <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span> <span class="token operator">*</span> speed <span class="token operator">*</span> ringSquash<span class="token punctuation">;</span>
<span class="token keyword">const</span> initSpeedY <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span> <span class="token operator">*</span> speed<span class="token punctuation">;</span>
<span class="token comment">// Rotate ring</span>
<span class="token keyword">const</span> newSpeed <span class="token operator">=</span> MyMath<span class="token punctuation">.</span><span class="token function">pointDist</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> initSpeedX<span class="token punctuation">,</span> initSpeedY<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> newAngle <span class="token operator">=</span> MyMath<span class="token punctuation">.</span><span class="token function">pointAngle</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> initSpeedX<span class="token punctuation">,</span> initSpeedY<span class="token punctuation">)</span> <span class="token operator">+</span> ringStartAngle<span class="token punctuation">;</span>
<span class="token keyword">const</span> star <span class="token operator">=</span> Star<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>
x<span class="token punctuation">,</span>
y<span class="token punctuation">,</span>
color<span class="token punctuation">,</span>
newAngle<span class="token punctuation">,</span>
<span class="token comment">// apply near cubic falloff to speed (places more particles towards outside)</span>
newSpeed<span class="token punctuation">,</span><span class="token comment">//speed,</span>
<span class="token comment">// add minor variation to star life</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>starLife <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>starLife <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>starLifeVariation
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>glitter<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
star<span class="token punctuation">.</span>sparkFreq <span class="token operator">=</span> sparkFreq<span class="token punctuation">;</span>
star<span class="token punctuation">.</span>sparkSpeed <span class="token operator">=</span> sparkSpeed<span class="token punctuation">;</span>
star<span class="token punctuation">.</span>sparkLife <span class="token operator">=</span> sparkLife<span class="token punctuation">;</span>
star<span class="token punctuation">.</span>sparkLifeVariation <span class="token operator">=</span> sparkLifeVariation<span class="token punctuation">;</span>
star<span class="token punctuation">.</span>sparkColor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>glitterColor<span class="token punctuation">;</span>
star<span class="token punctuation">.</span>sparkTimer <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> star<span class="token punctuation">.</span>sparkFreq<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// "Normal burst</span>
<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
<span class="token function">createParticleArc</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">PI_2</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>starCount<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> starFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>color<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">let</span> start<span class="token punctuation">,</span> start2<span class="token punctuation">,</span> arc<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
start <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">;</span>
start2 <span class="token operator">=</span> start <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">;</span>
arc <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
start <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
start2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
arc <span class="token operator">=</span> <span class="token constant">PI_2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
color <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>color<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">createParticleArc</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> arc<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>starCount<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> starFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
color <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>color<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">createParticleArc</span><span class="token punctuation">(</span>start2<span class="token punctuation">,</span> arc<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>starCount<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> starFactory<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pistil<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> innerShell <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Shell</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
<span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>size <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
<span class="token literal-property property">starLife</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>starLife <span class="token operator">*</span> <span class="token number">0.7</span><span class="token punctuation">,</span>
<span class="token literal-property property">starLifeVariation</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>starLifeVariation<span class="token punctuation">,</span>
<span class="token literal-property property">starDensity</span><span class="token operator">:</span> <span class="token number">1.65</span><span class="token punctuation">,</span>
<span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pistilColor<span class="token punctuation">,</span>
<span class="token literal-property property">glitter</span><span class="token operator">:</span> <span class="token string">'light'</span><span class="token punctuation">,</span>
<span class="token literal-property property">glitterColor</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pistilColor <span class="token operator">===</span> <span class="token constant">COLOR</span><span class="token punctuation">.</span>Gold <span class="token operator">?</span> <span class="token constant">COLOR</span><span class="token punctuation">.</span>Gold <span class="token operator">:</span> <span class="token constant">COLOR</span><span class="token punctuation">.</span>White
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
innerShell<span class="token punctuation">.</span><span class="token function">burst</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>streamers<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> innerShell <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Shell</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
<span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>size<span class="token punctuation">,</span>
<span class="token literal-property property">starLife</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>starLife <span class="token operator">*</span> <span class="token number">0.8</span><span class="token punctuation">,</span>
<span class="token literal-property property">starLifeVariation</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>starLifeVariation<span class="token punctuation">,</span>
<span class="token literal-property property">starCount</span><span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>size <span class="token operator">/</span> <span class="token number">45</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">,</span>
<span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token constant">COLOR</span><span class="token punctuation">.</span>White<span class="token punctuation">,</span>
<span class="token literal-property property">glitter</span><span class="token operator">:</span> <span class="token string">'streamer'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
innerShell<span class="token punctuation">.</span><span class="token function">burst</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// Queue burst flash render</span>
BurstFlash<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>size <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>



<span class="token keyword">const</span> BurstFlash <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
<span class="token literal-property property">active</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token literal-property property">_pool</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token function">_new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> radius</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_pool<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
instance<span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>
instance<span class="token punctuation">.</span>y <span class="token operator">=</span> y<span class="token punctuation">;</span>
instance<span class="token punctuation">.</span>radius <span class="token operator">=</span> radius<span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>active<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> instance<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token function">returnInstance</span><span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">this</span><span class="token punctuation">.</span>_pool<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>



<span class="token comment">// Helper to generate objects for storing active particles.</span>
<span class="token comment">// Particles are stored in arrays keyed by color (code, not name) for improved rendering performance.</span>
<span class="token keyword">function</span> <span class="token function">createParticleCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> collection <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token constant">COLOR_CODES_W_INVIS</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">color</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
collection<span class="token punctuation">[</span>color<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> collection<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> Star <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">// Visual properties</span>
<span class="token literal-property property">drawWidth</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
<span class="token literal-property property">airDrag</span><span class="token operator">:</span> <span class="token number">0.98</span><span class="token punctuation">,</span>
<span class="token literal-property property">airDragHeavy</span><span class="token operator">:</span> <span class="token number">0.992</span><span class="token punctuation">,</span>
<span class="token comment">// Star particles will be keyed by color</span>
<span class="token literal-property property">active</span><span class="token operator">:</span> <span class="token function">createParticleCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token literal-property property">_pool</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token function">_new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>

<span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> color<span class="token punctuation">,</span> angle<span class="token punctuation">,</span> speed<span class="token punctuation">,</span> life<span class="token punctuation">,</span> speedOffX<span class="token punctuation">,</span> speedOffY</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_pool<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
instance<span class="token punctuation">.</span>heavy <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
instance<span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>
instance<span class="token punctuation">.</span>y <span class="token operator">=</span> y<span class="token punctuation">;</span>
instance<span class="token punctuation">.</span>prevX <span class="token operator">=</span> x<span class="token punctuation">;</span>
instance<span class="token punctuation">.</span>prevY <span class="token operator">=</span> y<span class="token punctuation">;</span>
instance<span class="token punctuation">.</span>color <span class="token operator">=</span> color<span class="token punctuation">;</span>
instance<span class="token punctuation">.</span>speedX <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span> <span class="token operator">*</span> speed <span class="token operator">+</span> <span class="token punctuation">(</span>speedOffX <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
instance<span class="token punctuation">.</span>speedY <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span> <span class="token operator">*</span> speed <span class="token operator">+</span> <span class="token punctuation">(</span>speedOffY <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
instance<span class="token punctuation">.</span>life <span class="token operator">=</span> life<span class="token punctuation">;</span>
instance<span class="token punctuation">.</span>spinAngle <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">PI_2</span><span class="token punctuation">;</span>
instance<span class="token punctuation">.</span>spinSpeed <span class="token operator">=</span> <span class="token number">0.8</span><span class="token punctuation">;</span>
instance<span class="token punctuation">.</span>spinRadius <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
instance<span class="token punctuation">.</span>sparkFreq <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// ms between spark emissions</span>
instance<span class="token punctuation">.</span>sparkSpeed <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
instance<span class="token punctuation">.</span>sparkTimer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
instance<span class="token punctuation">.</span>sparkColor <span class="token operator">=</span> color<span class="token punctuation">;</span>
instance<span class="token punctuation">.</span>sparkLife <span class="token operator">=</span> <span class="token number">750</span><span class="token punctuation">;</span>
instance<span class="token punctuation">.</span>sparkLifeVariation <span class="token operator">=</span> <span class="token number">0.25</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>active<span class="token punctuation">[</span>color<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> instance<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>

<span class="token comment">// Public method for cleaning up and returning an instance back to the pool.</span>
<span class="token function">returnInstance</span><span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">// Call onDeath handler if available (and pass it current star instance)</span>
instance<span class="token punctuation">.</span>onDeath <span class="token operator">&amp;&amp;</span> instance<span class="token punctuation">.</span><span class="token function">onDeath</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Clean up</span>
instance<span class="token punctuation">.</span>onDeath <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token comment">// Add back to the pool.</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>_pool<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token keyword">const</span> Spark <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">// Visual properties</span>
<span class="token literal-property property">drawWidth</span><span class="token operator">:</span> <span class="token number">0.75</span><span class="token punctuation">,</span>
<span class="token literal-property property">airDrag</span><span class="token operator">:</span> <span class="token number">0.9</span><span class="token punctuation">,</span>
<span class="token comment">// Star particles will be keyed by color</span>
<span class="token literal-property property">active</span><span class="token operator">:</span> <span class="token function">createParticleCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token literal-property property">_pool</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token function">_new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>

<span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> color<span class="token punctuation">,</span> angle<span class="token punctuation">,</span> speed<span class="token punctuation">,</span> life</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_pool<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
instance<span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>
instance<span class="token punctuation">.</span>y <span class="token operator">=</span> y<span class="token punctuation">;</span>
instance<span class="token punctuation">.</span>prevX <span class="token operator">=</span> x<span class="token punctuation">;</span>
instance<span class="token punctuation">.</span>prevY <span class="token operator">=</span> y<span class="token punctuation">;</span>
instance<span class="token punctuation">.</span>color <span class="token operator">=</span> color<span class="token punctuation">;</span>
instance<span class="token punctuation">.</span>speedX <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span> <span class="token operator">*</span> speed<span class="token punctuation">;</span>
instance<span class="token punctuation">.</span>speedY <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span> <span class="token operator">*</span> speed<span class="token punctuation">;</span>
instance<span class="token punctuation">.</span>life <span class="token operator">=</span> life<span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>active<span class="token punctuation">[</span>color<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> instance<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>

<span class="token comment">// Public method for cleaning up and returning an instance back to the pool.</span>
<span class="token function">returnInstance</span><span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">// Add back to the pool.</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>_pool<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>



<span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e6e84d00a6afd96195cb0d31f70c159c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">世微大功率 内置2.5A宽电压降压恒流 LED电源驱动车灯IC AP5193</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/de3a479747bdeb24a897a4e368cc6dbc/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">在激光 SLAM 中特别处理第一个雷达数据是为什么？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>