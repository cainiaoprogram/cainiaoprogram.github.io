<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【SuperSocket 2.0】SuperSocket 2.0从入门到懵逼 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【SuperSocket 2.0】SuperSocket 2.0从入门到懵逼" />
<meta property="og:description" content="SuperSocket 2.0从入门到懵逼 SuperSocket 2.0从入门到懵逼 1 使用SuperSocket 2.0在AspNetCore项目中搭建一个Socket服务器 1.1 引入SuperSocket 2.01.2 在AspNetCore中搭建一个Socket服务器 2 基本的协议概念 2.1 基本协议种类 2.1.1 固定头格式协议2.1.2 固定头尾标识协议2.1.3 固定包大小协议2.1.4 命令行协议2.1.5 一些其它协议PS: 关于协议的一些硬件厂商的私有协议比较奇葩, 他们的协议五花八门的…不过我们这里不做阐述, 有时间我会再讲 3 SuperSocket中的几个基本概念 3.1 Package Type3.2 PipelineFilter Type3.3 使用PackageType和PipelineFilter Type创建SuperSocket 4 SuperSocket中的PipelineFilter, 实现自己的PipelineFilter 4.1 内置的PipelineFilter模板4.2 基于内置模板实现PipelineFilter 4.2.1 FixedHeaderPipelineFilter-头部格式固定并且包含内容长度的协议 4.2.3 另一种挂载解析器的方式 7 扩展AppSession和SuperSocketService 7.1 扩展AppSession 7.2 如何自己实现SuperSocketService?8 扩展SuperSocket的功能 8.1 多协议切换 9 搭建WebSocket服务器 9.1 番外: WebSocket传参 10 多服务器以及不同服务间的协同More 1 协议的编解码器开发预览More 2 DotNetty 附带实现, 讲解, 与部分源代码解读
1 使用SuperSocket 2.0在AspNetCore项目中搭建一个Socket服务器 1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/79c6924b9b03edf5e383940e98a40839/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-02-26T10:02:11+08:00" />
<meta property="article:modified_time" content="2022-02-26T10:02:11+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【SuperSocket 2.0】SuperSocket 2.0从入门到懵逼</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="SuperSocket_20_0"></a>SuperSocket 2.0从入门到懵逼</h2> 
<ul><li><a href="#supersocket-20%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%87%B5%E9%80%BC" rel="nofollow">SuperSocket 2.0从入门到懵逼</a> 
  <ul><li><a href="#1-%E4%BD%BF%E7%94%A8supersocket-20%E5%9C%A8aspnetcore%E9%A1%B9%E7%9B%AE%E4%B8%AD%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AAsocket%E6%9C%8D%E5%8A%A1%E5%99%A8" rel="nofollow">1 使用SuperSocket 2.0在AspNetCore项目中搭建一个Socket服务器</a> 
    <ul><li><a href="#11-%E5%BC%95%E5%85%A5supersocket-20" rel="nofollow">1.1 引入SuperSocket 2.0</a></li><li><a href="#12-%E5%9C%A8aspnetcore%E4%B8%AD%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AAsocket%E6%9C%8D%E5%8A%A1%E5%99%A8" rel="nofollow">1.2 在AspNetCore中搭建一个Socket服务器</a></li></ul> </li><li><a href="#2-%E5%9F%BA%E6%9C%AC%E7%9A%84%E5%8D%8F%E8%AE%AE%E6%A6%82%E5%BF%B5" rel="nofollow">2 基本的协议概念</a> 
    <ul><li><a href="#21-%E5%9F%BA%E6%9C%AC%E5%8D%8F%E8%AE%AE%E7%A7%8D%E7%B1%BB" rel="nofollow">2.1 基本协议种类</a> 
      <ul><li><a href="#211-%E5%9B%BA%E5%AE%9A%E5%A4%B4%E6%A0%BC%E5%BC%8F%E5%8D%8F%E8%AE%AE" rel="nofollow">2.1.1 固定头格式协议</a></li><li><a href="#212-%E5%9B%BA%E5%AE%9A%E5%A4%B4%E5%B0%BE%E6%A0%87%E8%AF%86%E5%8D%8F%E8%AE%AE" rel="nofollow">2.1.2 固定头尾标识协议</a></li><li><a href="#213-%E5%9B%BA%E5%AE%9A%E5%8C%85%E5%A4%A7%E5%B0%8F%E5%8D%8F%E8%AE%AE" rel="nofollow">2.1.3 固定包大小协议</a></li><li><a href="#214-%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8D%8F%E8%AE%AE" rel="nofollow">2.1.4 命令行协议</a></li><li><a href="#215-%E4%B8%80%E4%BA%9B%E5%85%B6%E5%AE%83%E5%8D%8F%E8%AE%AE" rel="nofollow">2.1.5 一些其它协议</a></li><li><a href="#ps-%E5%85%B3%E4%BA%8E%E5%8D%8F%E8%AE%AE%E7%9A%84%E4%B8%80%E4%BA%9B%E7%A1%AC%E4%BB%B6%E5%8E%82%E5%95%86%E7%9A%84%E7%A7%81%E6%9C%89%E5%8D%8F%E8%AE%AE%E6%AF%94%E8%BE%83%E5%A5%87%E8%91%A9-%E4%BB%96%E4%BB%AC%E7%9A%84%E5%8D%8F%E8%AE%AE%E4%BA%94%E8%8A%B1%E5%85%AB%E9%97%A8%E7%9A%84%E4%B8%8D%E8%BF%87%E6%88%91%E4%BB%AC%E8%BF%99%E9%87%8C%E4%B8%8D%E5%81%9A%E9%98%90%E8%BF%B0-%E6%9C%89%E6%97%B6%E9%97%B4%E6%88%91%E4%BC%9A%E5%86%8D%E8%AE%B2" rel="nofollow">PS: 关于协议的一些硬件厂商的私有协议比较奇葩, 他们的协议五花八门的…不过我们这里不做阐述, 有时间我会再讲</a></li></ul> </li></ul> </li><li><a href="#3-supersocket%E4%B8%AD%E7%9A%84%E5%87%A0%E4%B8%AA%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5" rel="nofollow">3 SuperSocket中的几个基本概念</a> 
    <ul><li><a href="#31-package-type" rel="nofollow">3.1 Package Type</a></li><li><a href="#32-pipelinefilter-type" rel="nofollow">3.2 PipelineFilter Type</a></li><li><a href="#33-%E4%BD%BF%E7%94%A8packagetype%E5%92%8Cpipelinefilter-type%E5%88%9B%E5%BB%BAsupersocket" rel="nofollow">3.3 使用PackageType和PipelineFilter Type创建SuperSocket</a></li></ul> </li><li><a href="#4-supersocket%E4%B8%AD%E7%9A%84pipelinefilter-%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%B7%B1%E7%9A%84pipelinefilter" rel="nofollow">4 SuperSocket中的PipelineFilter, 实现自己的PipelineFilter</a> 
    <ul><li><a href="#41-%E5%86%85%E7%BD%AE%E7%9A%84pipelinefilter%E6%A8%A1%E6%9D%BF" rel="nofollow">4.1 内置的PipelineFilter模板</a></li><li><a href="#42-%E5%9F%BA%E4%BA%8E%E5%86%85%E7%BD%AE%E6%A8%A1%E6%9D%BF%E5%AE%9E%E7%8E%B0pipelinefilter" rel="nofollow">4.2 基于内置模板实现PipelineFilter</a> 
      <ul><li><a href="#421-fixedheaderpipelinefilter-%E5%A4%B4%E9%83%A8%E6%A0%BC%E5%BC%8F%E5%9B%BA%E5%AE%9A%E5%B9%B6%E4%B8%94%E5%8C%85%E5%90%AB%E5%86%85%E5%AE%B9%E9%95%BF%E5%BA%A6%E7%9A%84%E5%8D%8F%E8%AE%AE" rel="nofollow">4.2.1 FixedHeaderPipelineFilter-头部格式固定并且包含内容长度的协议</a></li></ul> </li><li><a href="#423-%E5%8F%A6%E4%B8%80%E7%A7%8D%E6%8C%82%E8%BD%BD%E8%A7%A3%E6%9E%90%E5%99%A8%E7%9A%84%E6%96%B9%E5%BC%8F" rel="nofollow">4.2.3 另一种挂载解析器的方式</a></li></ul> </li><li><a href="#7-%E6%89%A9%E5%B1%95appsession%E5%92%8Csupersocketservice" rel="nofollow">7 扩展AppSession和SuperSocketService</a> 
    <ul><li><a href="#71-%E6%89%A9%E5%B1%95appsession" rel="nofollow">7.1 扩展AppSession</a></li></ul> </li><li><a href="#72-%E5%A6%82%E4%BD%95%E8%87%AA%E5%B7%B1%E5%AE%9E%E7%8E%B0supersocketservice" rel="nofollow">7.2 如何自己实现SuperSocketService?</a></li><li><a href="#8-%E6%89%A9%E5%B1%95supersocket%E7%9A%84%E5%8A%9F%E8%83%BD" rel="nofollow">8 扩展SuperSocket的功能</a> 
    <ul><li><a href="#81-%E5%A4%9A%E5%8D%8F%E8%AE%AE%E5%88%87%E6%8D%A2" rel="nofollow">8.1 多协议切换</a></li></ul> </li><li><a href="#9-%E6%90%AD%E5%BB%BAwebsocket%E6%9C%8D%E5%8A%A1%E5%99%A8" rel="nofollow">9 搭建WebSocket服务器</a> 
    <ul><li><a href="#91-%E7%95%AA%E5%A4%96-websocket%E4%BC%A0%E5%8F%82" rel="nofollow">9.1 番外: WebSocket传参</a></li></ul> </li><li><a href="#10-%E5%A4%9A%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BB%A5%E5%8F%8A%E4%B8%8D%E5%90%8C%E6%9C%8D%E5%8A%A1%E9%97%B4%E7%9A%84%E5%8D%8F%E5%90%8C" rel="nofollow">10 多服务器以及不同服务间的协同</a></li><li><a href="#more-1-%E5%8D%8F%E8%AE%AE%E7%9A%84%E7%BC%96%E8%A7%A3%E7%A0%81%E5%99%A8%E5%BC%80%E5%8F%91%E9%A2%84%E8%A7%88" rel="nofollow">More 1 协议的编解码器开发预览</a></li><li><a href="#more-2-dotnetty" rel="nofollow">More 2 DotNetty</a></li></ul> </li></ul> 
<blockquote> 
 <p>附带实现, 讲解, 与部分源代码解读</p> 
</blockquote> 
<h3><a id="1_SuperSocket_20AspNetCoreSocket_36"></a>1 使用SuperSocket 2.0在AspNetCore项目中搭建一个Socket服务器</h3> 
<h4><a id="11_SuperSocket_20_38"></a>1.1 引入SuperSocket 2.0</h4> 
<p>SuperSocket 2.0目前仍然处于Beta阶段, 但是功能基本可靠, 可以用于生产环境.</p> 
<p>可以从<a href="https://github.com/kerryjiang/SuperSocket">Github源地址</a>自行fork代码进行其它修改, 如需直接引用, 在默认的Nuget服务器是没有的, 需要添加作者自己的Nuget服务器<code>https://www.myget.org/F/supersocket/api/v3/index.json</code>, 获取预览版本.</p> 
<h4><a id="12_AspNetCoreSocket_44"></a>1.2 在AspNetCore中搭建一个Socket服务器</h4> 
<p>使用SuperSocket 2.0快速搭建一个Socket服务器非常简单, 在框架中, 作者实现了一个<code>SuperSocketHostBuilder</code>进行构建, 我们要做的只是简单的配置一些参数和业务逻辑.</p> 
<p>此外, <code>SuperSocketHostBuilder</code>是可以直接嵌入到AspNetCore项目的<code>CreateHostBuilder</code>上的, 但是并不推荐这么做…</p> 
<ol><li>配置数据包和过滤器/选择器 
  <ul><li>数据包, 即我们进行Socket通信时的数据包, 可以是包对象, 也可以是<code>byte[]</code>, 如果是包对象, 则需要在过滤器中配置解码器.</li><li>过滤器, 作用是对数据包进行筛选然后截取一包数据, 可以将解码器挂载进来, 直接将二进制数据映射为对象.</li><li>选择器, 我们可以使用选择器, 来实现一个端口服务于多种协议的情况, 此时, 一个选择器则会搭配多个过滤器进行使用.</li></ul> </li><li>配置IP和端口 
  <ul><li>配置IP和端口可以选择两种方式, 一种方式是从程序写入, 另一种是从配置文件中写入.</li><li>在本系列的介绍中, 我们大多数采用程序写入的方式, 从配置文件写入的方式, 后续会采用其它方式实现, 来扩展业务.</li></ul> </li><li>配置Session 
  <ul><li> <p>在程序中作者内置了<code>IAppSession</code>和<code>AppSession</code>供我们使用, 如果我们需要自定义Session, 则需要继承<code>AppSession</code>并且在程序中进行引用, 即可切换为我们定义的Session.</p> </li><li> <p>自定义Session时, 由于在程序中大多数提供的参数都为<code>IAppSession</code>, 所以, 需要实现SuperSocket的更多其它接口进行重写, 来维持程序运转.</p> </li><li> <p>自定义Session大多数时候是为了添加更多自定义属性, 作者在设计中提供了另外的方式提供我们选择：</p> <pre><code class="prism language-csharp"><span class="token comment">// AppSession源码</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppSession</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IAppSession</span><span class="token punctuation">,</span> <span class="token class-name">ILogger</span><span class="token punctuation">,</span> <span class="token class-name">ILoggerAccessor</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//......</span>

    <span class="token keyword">private</span> <span class="token class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">object</span><span class="token punctuation">,</span> <span class="token keyword">object</span><span class="token punctuation">&gt;</span></span> _items<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token class-name"><span class="token keyword">object</span></span> name<span class="token punctuation">]</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">get</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name"><span class="token keyword">var</span></span> items <span class="token operator">=</span> _items<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>items <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">object</span></span> <span class="token keyword">value</span><span class="token punctuation">;</span>
            
            <span class="token keyword">if</span> <span class="token punctuation">(</span>items<span class="token punctuation">.</span><span class="token function">TryGetValue</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token keyword">value</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">set</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">lock</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token class-name"><span class="token keyword">var</span></span> items <span class="token operator">=</span> _items<span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>items <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    items <span class="token operator">=</span> _items <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">object</span><span class="token punctuation">,</span> <span class="token keyword">object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                items<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">value</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//......</span>
<span class="token punctuation">}</span>
</code></pre> <p>可以看到, 其中内置了一个字典, 我们可以将属性的<code>Key-Value</code>值直接存在字典中, 即<code>session["prop"] = value;</code>的形式.</p> </li></ul> </li><li>配置SessionHandler 
  <ul><li>SessionHandler会在建立和断开Socket连接时触发, 用于处理连接和断开时的业务, 可以在<code>SuperSocketHostBuilder</code>中直接配置, 也可以通过重写相应的接口实现.</li><li>连接时, 会将创建好的Session传入该方法.</li><li>断开时, 会将断开的Session以及触发断开的事件传入该方法.</li></ul> </li><li>配置PackageHandler 
  <ul><li>PackageHandler会在接收到数据包时触发.</li><li>该方法自动触发时我们将获取两个参数, 一个是Session, 一个是Package. <strong>但是要注意的是, 这里的Session是<code>IAppSession</code>类型, 并不是我们自定义的Session</strong>. 
    <ul><li>Session即为当前Socket连接, 里面附带了各种连接信息以及状态等.</li><li>Package是通过过滤器后得到的数据包, 不过要注意的是, <strong>例如：如果数据包为头尾标识符的数据包, 如果采用的是<code>byte[]</code>的形式, 得到的可能不是原包, 而是去除了包头尾标识后的数据体. 即：<code>7E 01 02 03 7E</code>, 去掉头尾的<code>7E</code>标识得到的是<code>01 02 03</code></strong>.</li></ul> </li></ul> </li><li>Build &amp; Run 
  <ul><li>构建这里同时提供了几种方式, 推荐采用<code>BuildAsServer()</code>, 然后通过<code>StartAsync()</code>进行启用.</li></ul> </li></ol> 
<p>此时, 一个Socket服务器就搭建完成了. 具体实现：</p> 
<pre><code class="prism language-csharp"><span class="token comment">// SampleSession</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SampleSession</span><span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">AppSession</span></span>
<span class="token punctuation">{<!-- --></span>
    
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-csharp"><span class="token comment">// Socket Server代码</span>
<span class="token class-name"><span class="token keyword">var</span></span> tcpHost <span class="token operator">=</span> SuperSocketHostBuilder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Create</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> PipelineFilter<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">ConfigureSuperSocket</span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span>
    <span class="token punctuation">{<!-- --></span>
        options<span class="token punctuation">.</span><span class="token function">AddListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">ListenOptions</span>
        <span class="token punctuation">{<!-- --></span>
            Ip <span class="token operator">=</span> <span class="token string">"Any"</span><span class="token punctuation">,</span>
            Port <span class="token operator">=</span> <span class="token number">4040</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">AddListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">ListenOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Ip <span class="token operator">=</span> <span class="token string">"Any"</span><span class="token punctuation">,</span>
            Port <span class="token operator">=</span> <span class="token number">8888</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">UseSession</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>JT808TcpSession<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">UseClearIdleSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">UseSessionHandler</span><span class="token punctuation">(</span>s <span class="token operator">=&gt;</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">UsePackageHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//解包/应答/转发</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">ConfigureErrorHandler</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> v<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">UseMiddleware</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>InProcSessionContainerMiddleware<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">UseInProcSessionContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">BuildAsServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token keyword">await</span> tcpHost<span class="token punctuation">.</span><span class="token function">RunAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong><code>.UseClearIdleSession()</code>请务必调用, 在使用各类Socket框架时, 不可避免的我们的应用程序都会维持大量的僵尸连接, SuperSocket中提供了<code>UseClearIdleSession()</code>来自动复用已经闲置或者失去连接的资源.</strong></p> 
<h3><a id="2__164"></a>2 基本的协议概念</h3> 
<h4><a id="21__166"></a>2.1 基本协议种类</h4> 
<h5><a id="211__168"></a>2.1.1 固定头格式协议</h5> 
<p>顾名思义, 这类协议的Header是固定的, 并且一般Header的长度是固定的, 但是也有例外情况, 此外, Header中也会包含数据体的长度等信息. 然后可以根据长度来截取一包数据.</p> 
<h5><a id="212__172"></a>2.1.2 固定头尾标识协议</h5> 
<p>这类协议的数据包, 前几字节和后几字节是固定的, 这样就可以通过头尾的标识来截取一包数据.</p> 
<p>通常, 这类协议的数据包, 为了避免数据内容和协议头、尾的标识冲突, 通常会设置转义, 即将数据包中出现头尾标识的地方, 转义为其它数据, 避免识别时出现错误.</p> 
<h5><a id="213__178"></a>2.1.3 固定包大小协议</h5> 
<p>这类协议每一包数据的大小都是固定的, 所以可以直接根据长度进行读取.</p> 
<h5><a id="214__182"></a>2.1.4 命令行协议</h5> 
<p>这类协议通常以<code>\r\n</code>结尾, 采用字符串转为二进制流进行传输.</p> 
<h5><a id="215__186"></a>2.1.5 一些其它协议</h5> 
<h5><a id="PS____188"></a>PS: 关于协议的一些硬件厂商的私有协议比较奇葩, 他们的协议五花八门的…不过我们这里不做阐述, 有时间我会再讲</h5> 
<h3><a id="3_SuperSocket_190"></a>3 SuperSocket中的几个基本概念</h3> 
<h4><a id="31_Package_Type_192"></a>3.1 Package Type</h4> 
<p><code>Package Type</code>即包类型, 这里描述的是数据包的结构, 例如SuperSocket中就提供了一些基础的包类型<code>TextPackageInfo</code>等.</p> 
<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TextPackageInfo</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Text<span class="token punctuation">{<!-- --></span><span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这里的<code>TextPackageInfo</code>标识了这类类型的数据包中, 仅包含了一个字符串, 当然, 我们通常会有更复杂的网络数据包结构.例如, 我将在下列展示一个包含首尾标识的通信包, 它包含了首尾标识, 消息号, 终端Id, 以及消息体:</p> 
<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SamplePackage</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">byte</span></span> Begin<span class="token punctuation">{<!-- --></span><span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">MessageId</span> MessageId<span class="token punctuation">{<!-- --></span><span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> TerminalId<span class="token punctuation">{<!-- --></span><span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">SampleBody</span> Body<span class="token punctuation">{<!-- --></span><span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">byte</span></span> End<span class="token punctuation">{<!-- --></span><span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>当然, 在SuperSocket中也提供了一些接口供我们实现一些类似格式的包, 不过个人不太喜欢这种方式, 官方文档也举了一些例子, 例如,有的包会有一个特殊的字段来代表此包内容的类型. 我们将此字段命名为 “Key”. 此字段也告诉我们用何种逻辑处理此类型的包. 这是在网络应用程序中非常常见的一种设计. 例如，你的 Key 字段是整数类型，你的包类型需要实现接口<code>IKeyedPackageInfo</code>：</p> 
<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyPackage</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IKeyedPackageInfo<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Key <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">short</span></span> Sequence <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Body <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="32_PipelineFilter_Type_233"></a>3.2 PipelineFilter Type</h4> 
<p>这种类型在网络协议解析中作用重要. 它定义了如何将 IO 数据流解码成可以被应用程序理解的数据包. 换句话说, 就是把你的二进制流数据, 能够一包一包的识别出来, 同时可以解析成你构建的Package对象. 当然, 你也可以选择不构建, 然后将源数据直接返回.</p> 
<p>这些是 PipelineFilter 的基本接口. 你的系统中至少需要一个实现这个接口的 PipelineFilter 类型.</p> 
<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IPipelineFilter</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name"><span class="token keyword">object</span></span> Context <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>        
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IPipelineFilter<span class="token punctuation">&lt;</span>TPackageInfo<span class="token punctuation">&gt;</span></span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IPipelineFilter</span></span>
    <span class="token keyword">where</span> <span class="token class-name">TPackageInfo</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span>
<span class="token punctuation">{<!-- --></span>

    <span class="token return-type class-name">IPackageDecoder<span class="token punctuation">&lt;</span>TPackageInfo<span class="token punctuation">&gt;</span></span> Decoder <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token return-type class-name">TPackageInfo</span> <span class="token function">Filter</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">SequenceReader<span class="token punctuation">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">&gt;</span></span> reader<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token return-type class-name">IPipelineFilter<span class="token punctuation">&lt;</span>TPackageInfo<span class="token punctuation">&gt;</span></span> NextFilter <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>事实上，由于 SuperSocket 已经提供了一些内置的 PipelineFilter 模版，这些几乎可以覆盖 90% 的场景的模版极大的简化了你的开发工作. 所以你不需要完全从头开始实现 PipelineFilter. 即使这些内置的模版无法满足你的需求，完全自己实现PipelineFilter也不是难事.</p> 
<h4><a id="33_PackageTypePipelineFilter_TypeSuperSocket_262"></a>3.3 使用PackageType和PipelineFilter Type创建SuperSocket</h4> 
<p>你定义好 Package 类型和 PipelineFilter 类型之后，你就可以使用 SuperSocketHostBuilder 创建 SuperSocket 宿主了。</p> 
<pre><code class="prism language-csharp"><span class="token class-name"><span class="token keyword">var</span></span> host <span class="token operator">=</span> SuperSocketHostBuilder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Create</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>StringPackageInfo<span class="token punctuation">,</span> CommandLinePipelineFilter<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>在某些情况下，你可能需要实现接口 IPipelineFilterFactory 来完全控制 PipelineFilter 的创建。</p> 
<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyFilterFactory</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">PipelineFilterFactoryBase<span class="token punctuation">&lt;</span>TextPackageInfo<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name">IPipelineFilter<span class="token punctuation">&lt;</span>TPackageInfo<span class="token punctuation">&gt;</span></span> <span class="token function">CreateCore</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> client<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">FixedSizePipelineFilter</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>然后在 SuperSocket 宿主被创建出来之后启用这个 PipelineFilterFactory:</p> 
<pre><code class="prism language-csharp"><span class="token class-name"><span class="token keyword">var</span></span> host <span class="token operator">=</span> SuperSocketHostBuilder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Create</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>StringPackageInfo<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
host<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">UsePipelineFilterFactory</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>MyFilterFactory<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="4_SuperSocketPipelineFilter_PipelineFilter_290"></a>4 SuperSocket中的PipelineFilter, 实现自己的PipelineFilter</h3> 
<h4><a id="41_PipelineFilter_292"></a>4.1 内置的PipelineFilter模板</h4> 
<p>SuperSocket中内置了一些PipelineFilter模板, 这些模板几乎可以覆盖到90%的应用场景, 极大简化了开发工作, 所以不需要完全从头开始实现PipelineFilter. 即使这些内置的模板无法满足你的需求, 完全自己实现PipelineFilter.</p> 
<p>SuperSocket提供了这些PipelineFilter模板:</p> 
<ul><li><strong>TerminatorPipelineFilter</strong> (SuperSocket.ProtoBase.TerminatorPipelineFilter, SuperSocket.ProtoBase)</li><li><strong>TerminatorTextPipelineFilter</strong> (SuperSocket.ProtoBase.TerminatorTextPipelineFilter, SuperSocket.ProtoBase)</li><li><strong>LinePipelineFilter</strong> (SuperSocket.ProtoBase.LinePipelineFilter, SuperSocket.ProtoBase)</li><li><strong>CommandLinePipelineFilter</strong> (SuperSocket.ProtoBase.CommandLinePipelineFilter, SuperSocket.ProtoBase)</li><li><strong>BeginEndMarkPipelineFilter</strong> (SuperSocket.ProtoBase.BeginEndMarkPipelineFilter, SuperSocket.ProtoBase)</li><li><strong>FixedSizePipelineFilter</strong> (SuperSocket.ProtoBase.FixedSizePipelineFilter, SuperSocket.ProtoBase)</li><li><strong>FixedHeaderPipelineFilter</strong> (SuperSocket.ProtoBase.FixedHeaderPipelineFilter, SuperSocket.ProtoBase)</li></ul> 
<h4><a id="42_PipelineFilter_306"></a>4.2 基于内置模板实现PipelineFilter</h4> 
<h5><a id="421_FixedHeaderPipelineFilter_308"></a>4.2.1 FixedHeaderPipelineFilter-头部格式固定并且包含内容长度的协议</h5> 
<p>这种协议讲请求定义为两大部分, 第一部分定义了包含第二部分长度等等基础信息, 我们通常称第一部分为头部.</p> 
<p>例如, 我们有一个这样的协议: 头部包含 3 个字节, 第 1 个字节用于存储请求的类型, 后两个字节用于代表请求体的长度:</p> 
<pre><code class="prism language-csharp"><span class="token comment">/// +-------+---+-------------------------------+</span>
<span class="token comment">/// |request| l |                               |</span>
<span class="token comment">/// | type  | e |    request body               |</span>
<span class="token comment">/// |  (1)  | n |                               |</span>
<span class="token comment">/// |       |(2)|                               |</span>
<span class="token comment">/// +-------+---+-------------------------------+</span>
</code></pre> 
<p>根据此协议的规范, 我们可以使用如下代码定义包的类型:</p> 
<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyPackage</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">byte</span></span> Key <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Body <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>下一个是设计PipelineFilter:</p> 
<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyPipelineFilter</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">FixedHeaderPipelineFilter<span class="token punctuation">&lt;</span>MyPackage<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token function">MyPipelineFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">// 包头的大小是3字节，所以将3传如基类的构造方法中去</span>
    <span class="token punctuation">{<!-- --></span>

    <span class="token punctuation">}</span>

    <span class="token comment">// 从数据包的头部返回包体的大小</span>
    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">GetBodyLengthFromHeader</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">ReadOnlySequence<span class="token punctuation">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">&gt;</span></span> buffer<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name"><span class="token keyword">var</span></span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SequenceReader<span class="token punctuation">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        reader<span class="token punctuation">.</span><span class="token function">Advance</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// skip the first byte</span>
        reader<span class="token punctuation">.</span><span class="token function">TryReadBigEndian</span><span class="token punctuation">(</span><span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">short</span></span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> len<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 将数据包解析成 MyPackage 的实例</span>
    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name">MyPackage</span> <span class="token function">DecodePackage</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">ReadOnlySequence<span class="token punctuation">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">&gt;</span></span> buffer<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name"><span class="token keyword">var</span></span> package <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MyPackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SequenceReader<span class="token punctuation">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

        reader<span class="token punctuation">.</span><span class="token function">TryRead</span><span class="token punctuation">(</span><span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">byte</span></span> packageKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        package<span class="token punctuation">.</span>Key <span class="token operator">=</span> packageKey<span class="token punctuation">;</span>            
        reader<span class="token punctuation">.</span><span class="token function">Advance</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// skip the length             </span>
        package<span class="token punctuation">.</span>Body <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">ReadString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> package<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>最后，你可通过数据包的类型和 PipelineFilter 的类型来创建宿主:</p> 
<pre><code class="prism language-csharp"><span class="token class-name"><span class="token keyword">var</span></span> host <span class="token operator">=</span> SuperSocketHostBuilder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Create</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>MyPackage<span class="token punctuation">,</span> MyPipelineFilter<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">UsePackageHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// handle your package over here</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>你也可以通过将解析包的代码从 PipelineFilter 移到 你的包解码器中来获得更大的灵活性：</p> 
<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyPackageDecoder</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IPackageDecoder<span class="token punctuation">&lt;</span>MyPackage<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token return-type class-name">MyPackage</span> <span class="token function">Decode</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">ReadOnlySequence<span class="token punctuation">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">&gt;</span></span> buffer<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">object</span></span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name"><span class="token keyword">var</span></span> package <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MyPackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SequenceReader<span class="token punctuation">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

        reader<span class="token punctuation">.</span><span class="token function">TryRead</span><span class="token punctuation">(</span><span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">byte</span></span> packageKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        package<span class="token punctuation">.</span>Key <span class="token operator">=</span> packageKey<span class="token punctuation">;</span>            
        reader<span class="token punctuation">.</span><span class="token function">Advance</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// skip the length             </span>
        package<span class="token punctuation">.</span>Body <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">ReadString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> package<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>通过 host builder 的 UsePackageDecoder 方法来在SuperSocket中启用它:</p> 
<pre><code class="prism language-csharp">builder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">UsePackageDecoder</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>MyPackageDecoder<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="423__408"></a>4.2.3 另一种挂载解析器的方式</h4> 
<p>在Asp.Net Core Application我们可以new(), 直接注入或者采用工厂模式等方式, 向Host中注入协议解析器, 然后在过滤波器中进行使用.</p> 
<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyPipelineFilter</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">FixedHeaderPipelineFilter<span class="token punctuation">&lt;</span>MyPackage<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">readonly</span> <span class="token class-name">PacketConvert</span> _packageConvert<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token function">MyPipelineFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">// 包头的大小是3字节，所以将3传如基类的构造方法中去</span>
    <span class="token punctuation">{<!-- --></span>
        _packageConvert <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">PackageConvert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 从数据包的头部返回包体的大小</span>
    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">GetBodyLengthFromHeader</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">ReadOnlySequence<span class="token punctuation">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">&gt;</span></span> buffer<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name"><span class="token keyword">var</span></span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SequenceReader<span class="token punctuation">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        reader<span class="token punctuation">.</span><span class="token function">Advance</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// skip the first byte</span>
        reader<span class="token punctuation">.</span><span class="token function">TryReadBigEndian</span><span class="token punctuation">(</span><span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">short</span></span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> len<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 将数据包解析成 MyPackage 的实例</span>
    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name">MyPackage</span> <span class="token function">DecodePackage</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">ReadOnlySequence<span class="token punctuation">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">&gt;</span></span> buffer<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name"><span class="token keyword">var</span></span> package <span class="token operator">=</span> _packageConvert<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Deserialize</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Package<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> package<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>PS: 过滤器中<code>DecodePackage</code>返回的buffer可能不是完整的包, 例如固定头尾结构的包中， 返回的buffer可能是去掉头尾的格式</strong></p> 
<blockquote> 
 <p>例如固定头尾的包<code>0x7E 0x7E xxxxxxx 0x7E 0x7E</code>, 返回的buffer中头尾的<code>0x7E 0x7E</code>会被去除, 只留下中间<code>xxxxxxx</code>的部分，所以在实现解码器部分的时候需要注意.</p> 
</blockquote> 
<h3><a id="7_AppSessionSuperSocketService_445"></a>7 扩展AppSession和SuperSocketService</h3> 
<h4><a id="71_AppSession_447"></a>7.1 扩展AppSession</h4> 
<p>在SuperSocket关于Socket的管理提供了<code>SessionContainer</code>供大家获取程序中的Session实例, 只需在构建中调用<code>.UseMiddleware&lt;InProcSessionContainerMiddleware&gt;()</code>和<code>UseInProcSessionContainer()</code>即可通过<code>AppSession.Server.SessionContainer()</code>获取.</p> 
<p>但是为了方便管理, 个人角色还是实现一个另外的<code>SessionManager</code>比较好, 这样可以更方便的集成到我们的Asp.Net Core Application中. 使用<code>ConcurrentDictionary</code>原子字典来存储, 可以避免一些读写上的死锁问题.</p> 
<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SessionManager<span class="token punctuation">&lt;</span>TSession<span class="token punctuation">&gt;</span></span> <span class="token keyword">where</span> <span class="token class-name">TSession</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IAppSession</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 存储的Session</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">ConcurrentDictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> TSession<span class="token punctuation">&gt;</span></span> Sessions <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// Session的数量</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Count <span class="token operator">=&gt;</span> Sessions<span class="token punctuation">.</span>Count<span class="token punctuation">;</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token keyword">public</span> <span class="token function">SessionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">ConcurrentDictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> TSession<span class="token punctuation">&gt;</span></span> <span class="token function">GetAllSessions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> Sessions<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 获取一个Session</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;param name="key"&gt; &lt;/param&gt;</span>
    <span class="token comment">/// &lt;returns&gt; &lt;/returns&gt;</span>
    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>TSession<span class="token punctuation">&gt;</span></span> <span class="token function">TryGet</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> key<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
        <span class="token punctuation">{<!-- --></span>
            Sessions<span class="token punctuation">.</span><span class="token function">TryGetValue</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">var</span></span> session<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> session<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 添加或者更新一个Session</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;param name="key"&gt;     &lt;/param&gt;</span>
    <span class="token comment">/// &lt;param name="session"&gt; &lt;/param&gt;</span>
    <span class="token comment">/// &lt;returns&gt; &lt;/returns&gt;</span>
    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">TryAddOrUpdate</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> key<span class="token punctuation">,</span> <span class="token class-name">TSession</span> session<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>Sessions<span class="token punctuation">.</span><span class="token function">TryGetValue</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">var</span></span> oldSession<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                Sessions<span class="token punctuation">.</span><span class="token function">TryUpdate</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> session<span class="token punctuation">,</span> oldSession<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{<!-- --></span>
                Sessions<span class="token punctuation">.</span><span class="token function">TryAdd</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> session<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 移除一个Session</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;param name="key"&gt; &lt;/param&gt;</span>
    <span class="token comment">/// &lt;returns&gt; &lt;/returns&gt;</span>
    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">TryRemove</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> key<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>Sessions<span class="token punctuation">.</span><span class="token function">TryRemove</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">var</span></span> session<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 通过Session移除Session</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;param name="sessionId"&gt; &lt;/param&gt;</span>
    <span class="token comment">/// &lt;returns&gt; &lt;/returns&gt;</span>
    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">TryRemoveBySessionId</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> sessionId<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> session <span class="token keyword">in</span> Sessions<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>session<span class="token punctuation">.</span>Value<span class="token punctuation">.</span>SessionID <span class="token operator">==</span> sessionId<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    Sessions<span class="token punctuation">.</span><span class="token function">TryRemove</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 删除僵尸链接</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;returns&gt; &lt;/returns&gt;</span>
    <span class="token punctuation">[</span><span class="token function">Obsolete</span><span class="token punctuation">(</span><span class="token string">"该方法丢弃"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">TryRemoveZombieSessions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
        <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 移除所有Session</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;returns&gt; &lt;/returns&gt;</span>
    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">TryRemoveAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
        <span class="token punctuation">{<!-- --></span>
            Sessions<span class="token punctuation">.</span><span class="token function">Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;param name="session"&gt; &lt;/param&gt;</span>
    <span class="token comment">/// &lt;param name="buffer"&gt;  &lt;/param&gt;</span>
    <span class="token comment">/// &lt;returns&gt; &lt;/returns&gt;</span>
    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">SendAsync</span><span class="token punctuation">(</span><span class="token class-name">TSession</span> session<span class="token punctuation">,</span> <span class="token class-name">ReadOnlyMemory<span class="token punctuation">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">&gt;</span></span> buffer<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>session <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token keyword">nameof</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">await</span> session<span class="token punctuation">.</span><span class="token function">SendAsync</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;param name="session"&gt; &lt;/param&gt;</span>
    <span class="token comment">/// &lt;param name="message"&gt; &lt;/param&gt;</span>
    <span class="token comment">/// &lt;returns&gt; &lt;/returns&gt;</span>
    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">SendAsync</span><span class="token punctuation">(</span><span class="token class-name">ClientSession</span> session<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> message<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>session <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token keyword">nameof</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// ReSharper disable once PossibleNullReferenceException</span>
        <span class="token keyword">await</span> session<span class="token punctuation">.</span><span class="token function">SendAsync</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;param name="session"&gt; &lt;/param&gt;</span>
    <span class="token comment">/// &lt;returns&gt; &lt;/returns&gt;</span>
    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>Guid<span class="token punctuation">&gt;</span></span> <span class="token function">FindIdBySession</span><span class="token punctuation">(</span><span class="token class-name">TSession</span> session<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> Guid<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>Sessions<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>Value<span class="token punctuation">.</span>SessionID<span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span>SessionID<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="72_SuperSocketService_617"></a>7.2 如何自己实现SuperSocketService?</h3> 
<p>我们在使用SuperSocket时需要在<code>Program.cs</code>中来构建, 这样会导致一个问题, 这样我们的SuperSocket服务就会变得难以控制, 那么有没有一种写法来将这部分代码抽离出来呢？</p> 
<p>答案是有的, 我们可以采用.Net Core中的<code>BackgroundService</code>或者<code>IHostedService</code>来实现后台服务, 甚至将这些服务管理起来, 根据需要随时创建, 随时启动, 随时停止. 这样做的好处还有, 我们可以随时获取依赖注入的服务来做一些更多的操作, 例如读取配置, 管理Session, 配置编解码器, 日志, 应答器, MQ等等.</p> 
<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TcpSocketServerHostedService</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IHostedService</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IOptions<span class="token punctuation">&lt;</span>ServerOption<span class="token punctuation">&gt;</span></span> _serverOptions<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IOptions<span class="token punctuation">&lt;</span>KafkaOption<span class="token punctuation">&gt;</span></span> _kafkaOptions<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ClientSessionManagers</span> _clientSessionManager<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">TerminalSessionManager</span> _gpsTrackerSessionManager<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>TcpSocketServerHostedService<span class="token punctuation">&gt;</span></span> _logger<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IGeneralRepository</span> _generalRepository<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">NbazhGpsSerializer</span> _nbazhGpsSerializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">NbazhGpsSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">EV26MsgIdProducer</span> _provider <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// Tcp Server服务</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;param name="serverOptions"&gt;            &lt;/param&gt;</span>
    <span class="token comment">/// &lt;param name="kafkaOptions"&gt;             &lt;/param&gt;</span>
    <span class="token comment">/// &lt;param name="clientSessionManager"&gt;     &lt;/param&gt;</span>
    <span class="token comment">/// &lt;param name="gpsTrackerSessionManager"&gt; &lt;/param&gt;</span>
    <span class="token comment">/// &lt;param name="logger"&gt;                   &lt;/param&gt;</span>
    <span class="token comment">/// &lt;param name="factory"&gt;                  &lt;/param&gt;</span>
    <span class="token keyword">public</span> <span class="token function">TcpSocketServerHostedService</span><span class="token punctuation">(</span>
        <span class="token class-name">IOptions<span class="token punctuation">&lt;</span>ServerOption<span class="token punctuation">&gt;</span></span> serverOptions<span class="token punctuation">,</span>
        <span class="token class-name">IOptions<span class="token punctuation">&lt;</span>KafkaOption<span class="token punctuation">&gt;</span></span> kafkaOptions<span class="token punctuation">,</span>
        <span class="token class-name">ClientSessionManagers</span> clientSessionManager<span class="token punctuation">,</span>
        <span class="token class-name">TerminalSessionManager</span> gpsTrackerSessionManager<span class="token punctuation">,</span>
        <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>TcpSocketServerHostedService<span class="token punctuation">&gt;</span></span> logger<span class="token punctuation">,</span>
        <span class="token class-name">IServiceScopeFactory</span> factory<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        _serverOptions <span class="token operator">=</span> serverOptions <span class="token operator">??</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token keyword">nameof</span><span class="token punctuation">(</span>serverOptions<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _kafkaOptions <span class="token operator">=</span> kafkaOptions<span class="token punctuation">;</span>
        _clientSessionManager <span class="token operator">=</span> clientSessionManager <span class="token operator">??</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token keyword">nameof</span><span class="token punctuation">(</span>clientSessionManager<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _gpsTrackerSessionManager <span class="token operator">=</span> gpsTrackerSessionManager <span class="token operator">??</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token keyword">nameof</span><span class="token punctuation">(</span>gpsTrackerSessionManager<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _logger <span class="token operator">=</span> logger <span class="token operator">??</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token keyword">nameof</span><span class="token punctuation">(</span>logger<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _generalRepository <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">CreateScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ServiceProvider<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRequiredService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IGeneralRepository<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;param name="cancellationToken"&gt; &lt;/param&gt;</span>
    <span class="token comment">/// &lt;returns&gt; &lt;/returns&gt;</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">StartAsync</span><span class="token punctuation">(</span><span class="token class-name">CancellationToken</span> cancellationToken<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name"><span class="token keyword">var</span></span> host <span class="token operator">=</span> SuperSocketHostBuilder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Create</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>NbazhGpsPackage<span class="token punctuation">,</span> ProtocolPipelineSwitcher<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">ConfigureSuperSocket</span><span class="token punctuation">(</span>opts <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> listener <span class="token keyword">in</span> _serverOptions<span class="token punctuation">.</span>Value<span class="token punctuation">.</span>TcpListeners<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    opts<span class="token punctuation">.</span><span class="token function">AddListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">ListenOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        Ip <span class="token operator">=</span> listener<span class="token punctuation">.</span>Ip<span class="token punctuation">,</span>
                        Port <span class="token operator">=</span> listener<span class="token punctuation">.</span>Port
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">UseSession</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>GpsTrackerSession<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">UseClearIdleSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">UseSessionHandler</span><span class="token punctuation">(</span><span class="token named-parameter punctuation">onClosed</span><span class="token punctuation">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span> v<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">try</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// Session管理</span>
                        <span class="token keyword">await</span> _gpsTrackerSessionManager<span class="token punctuation">.</span><span class="token function">TryRemoveBySessionId</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>SessionID<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">catch</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// ignored</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">UsePackageHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span> packet<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 处理包</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">UseInProcSessionContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">BuildAsServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">await</span> host<span class="token punctuation">.</span><span class="token function">StartAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">await</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;param name="cancellationToken"&gt; &lt;/param&gt;</span>
    <span class="token comment">/// &lt;returns&gt; &lt;/returns&gt;</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">StopAsync</span><span class="token punctuation">(</span><span class="token class-name">CancellationToken</span> cancellationToken<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">await</span> _gpsTrackerSessionManager<span class="token punctuation">.</span><span class="token function">TryRemoveAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// ignored</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">await</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>实现服务后, 我们可以写扩展方法将服务注入.</p> 
<pre><code class="prism language-csharp"><span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">/// 服务器扩展</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ServerBuilderExtensions</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 添加Tcp服务器</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;param name="services"&gt; &lt;/param&gt;</span>
    <span class="token comment">/// &lt;returns&gt; &lt;/returns&gt;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IServiceCollection</span> <span class="token function">AddTcpServer</span><span class="token punctuation">(</span>
        <span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TerminalSessionManager<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddHostedService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TcpSocketServerHostedService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> services<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 添加Ws服务器</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;param name="services"&gt; &lt;/param&gt;</span>
    <span class="token comment">/// &lt;returns&gt; &lt;/returns&gt;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IServiceCollection</span> <span class="token function">AddWsServer</span><span class="token punctuation">(</span>
        <span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ClientSessionManagers<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddHostedService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>WebSocketServerHostedService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> services<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="8_SuperSocket_761"></a>8 扩展SuperSocket的功能</h3> 
<h4><a id="81__763"></a>8.1 多协议切换</h4> 
<p>我们有时候会面对一种需求, 就是同一个接口, 需要接收不同的终端的协议包, 这样我们通常会根据协议的不同点来区分协议. <strong>PS: 协议最好是同类型协议, 并且有明显不同的特征!</strong></p> 
<p>具体的实现方式就是实现一个特殊的<code>PipelineFilter</code>, 在下列代码中, 我们将读取该包数据的第一个字节来分辨该协议为<code>0x78 0x78</code>类型开头的协议还是<code>0x79 0x79</code>开头的协议, 然后将标记移回改包开头, 然后将这一包数据交给对应的过滤器来进行解析:</p> 
<pre><code class="prism language-csharp"><span class="token comment">// NbazhGpsPackage: 包编解码器</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProtocolPipelineSwitcher</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">PipelineFilterBase<span class="token punctuation">&lt;</span>NbazhGpsPackage<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">IPipelineFilter<span class="token punctuation">&lt;</span>NbazhGpsPackage<span class="token punctuation">&gt;</span></span> _filter7878<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">byte</span></span> _beginMarkA <span class="token operator">=</span> <span class="token number">0x78</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">IPipelineFilter<span class="token punctuation">&lt;</span>NbazhGpsPackage<span class="token punctuation">&gt;</span></span> _filter7979<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">byte</span></span> _beginMarkB <span class="token operator">=</span> <span class="token number">0x79</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">ProtocolPipelineSwitcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        _filter7878 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">EV26PipelineFilter7878</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _filter7979 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">EV26PipelineFilter7979</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name">NbazhGpsPackage</span> <span class="token function">Filter</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">SequenceReader<span class="token punctuation">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">&gt;</span></span> reader<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>reader<span class="token punctuation">.</span><span class="token function">TryRead</span><span class="token punctuation">(</span><span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">byte</span></span> flag<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ProtocolException</span><span class="token punctuation">(</span><span class="token string">@"flag byte cannot be read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>flag <span class="token operator">==</span> _beginMarkA<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            NextFilter <span class="token operator">=</span> _filter7878<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>flag <span class="token operator">==</span> _beginMarkB<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            NextFilter <span class="token operator">=</span> _filter7979<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token comment">//throw new ProtocolException($"首字节未知 {flag}");</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 将标记移回开头</span>
        reader<span class="token punctuation">.</span><span class="token function">Rewind</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="9_WebSocket_813"></a>9 搭建WebSocket服务器</h3> 
<p>WebSocket Server的实现方式与之前的Socket Server实现方式大致相同, 其中不同的地方主要为: WebSocket Server不需要配置编解码器, 采用String作为消息格式等.</p> 
<pre><code class="prism language-csharp"><span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSocketServerHostedService</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IHostedService</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IOptions<span class="token punctuation">&lt;</span>ServerOption<span class="token punctuation">&gt;</span></span> _serverOptions<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ClientSessionManagers</span> _clientSessionManager<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">TerminalSessionManager</span> _gpsTrackerSessionManager<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IGeneralRepository</span> _generalRepository<span class="token punctuation">;</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;param name="serverOptions"&gt;            &lt;/param&gt;</span>
    <span class="token comment">/// &lt;param name="clientSessionManager"&gt;     &lt;/param&gt;</span>
    <span class="token comment">/// &lt;param name="gpsTrackerSessionManager"&gt; &lt;/param&gt;</span>
    <span class="token comment">/// &lt;param name="factory"&gt;                  &lt;/param&gt;</span>
    <span class="token keyword">public</span> <span class="token function">WebSocketServerHostedService</span><span class="token punctuation">(</span>
        <span class="token class-name">IOptions<span class="token punctuation">&lt;</span>ServerOption<span class="token punctuation">&gt;</span></span> serverOptions<span class="token punctuation">,</span>
        <span class="token class-name">ClientSessionManagers</span> clientSessionManager<span class="token punctuation">,</span>
        <span class="token class-name">TerminalSessionManager</span> gpsTrackerSessionManager<span class="token punctuation">,</span>
        <span class="token class-name">IServiceScopeFactory</span> factory<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        _serverOptions <span class="token operator">=</span> serverOptions <span class="token operator">??</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token keyword">nameof</span><span class="token punctuation">(</span>_serverOptions<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _clientSessionManager <span class="token operator">=</span> clientSessionManager <span class="token operator">??</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token keyword">nameof</span><span class="token punctuation">(</span>clientSessionManager<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _gpsTrackerSessionManager <span class="token operator">=</span> gpsTrackerSessionManager <span class="token operator">??</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token keyword">nameof</span><span class="token punctuation">(</span>gpsTrackerSessionManager<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _generalRepository <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">CreateScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ServiceProvider<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRequiredService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IGeneralRepository<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// WebSocketServer</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;param name="cancellationToken"&gt; &lt;/param&gt;</span>
    <span class="token comment">/// &lt;returns&gt; &lt;/returns&gt;</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">StartAsync</span><span class="token punctuation">(</span><span class="token class-name">CancellationToken</span> cancellationToken<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name"><span class="token keyword">var</span></span> host <span class="token operator">=</span> WebSocketHostBuilder<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">ConfigureSuperSocket</span><span class="token punctuation">(</span>opts <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> listener <span class="token keyword">in</span> _serverOptions<span class="token punctuation">.</span>Value<span class="token punctuation">.</span>WsListeners<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    opts<span class="token punctuation">.</span><span class="token function">AddListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">ListenOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        Ip <span class="token operator">=</span> listener<span class="token punctuation">.</span>Ip<span class="token punctuation">,</span>
                        Port <span class="token operator">=</span> listener<span class="token punctuation">.</span>Port
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">UseSession</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ClientSession<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">UseClearIdleSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">UseSessionHandler</span><span class="token punctuation">(</span><span class="token named-parameter punctuation">onClosed</span><span class="token punctuation">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span> v<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">await</span> _clientSessionManager<span class="token punctuation">.</span><span class="token function">TryRemoveBySessionId</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>SessionID<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">UseWebSocketMessageHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token class-name"><span class="token keyword">var</span></span> package <span class="token operator">=</span> p<span class="token punctuation">.</span>Message<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ToObject</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ClientPackage<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>package<span class="token punctuation">.</span>PackageType <span class="token operator">==</span> PackageType<span class="token punctuation">.</span>Heart<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>package<span class="token punctuation">.</span>PackageType <span class="token operator">==</span> PackageType<span class="token punctuation">.</span>Login<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name"><span class="token keyword">var</span></span> client <span class="token operator">=</span> _generalRepository<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">FindAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>Id<span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span>Guid<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>package<span class="token punctuation">.</span>ClientId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>client <span class="token keyword">is</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">await</span> s<span class="token punctuation">.</span><span class="token function">CloseAsync</span><span class="token punctuation">(</span>CloseReason<span class="token punctuation">.</span>ProtocolError<span class="token punctuation">,</span> <span class="token string">"ClientId不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token class-name"><span class="token keyword">var</span></span> verifyCode <span class="token operator">=</span> Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name"><span class="token keyword">var</span></span> loginPacket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ClientPackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        PackageType <span class="token operator">=</span> PackageType<span class="token punctuation">.</span>Login<span class="token punctuation">,</span>
                        ClientId <span class="token operator">=</span> package<span class="token punctuation">.</span>ClientId<span class="token punctuation">,</span>
                        VerifyCode <span class="token operator">=</span> verifyCode<span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">;</span>
                    s<span class="token punctuation">[</span><span class="token string">"VerifyCode"</span><span class="token punctuation">]</span> <span class="token operator">=</span> verifyCode<span class="token punctuation">;</span>

                    <span class="token class-name"><span class="token keyword">var</span></span> msg <span class="token operator">=</span> loginPacket<span class="token punctuation">.</span><span class="token function">ToJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">await</span> s<span class="token punctuation">.</span><span class="token function">SendAsync</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// 追踪</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>package<span class="token punctuation">.</span>PackageType <span class="token operator">==</span> PackageType<span class="token punctuation">.</span>Trace<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">UseInProcSessionContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">BuildAsServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">await</span> host<span class="token punctuation">.</span><span class="token function">StartAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">await</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;param name="cancellationToken"&gt; &lt;/param&gt;</span>
    <span class="token comment">/// &lt;returns&gt; &lt;/returns&gt;</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">StopAsync</span><span class="token punctuation">(</span><span class="token class-name">CancellationToken</span> cancellationToken<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">await</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="91__WebSocket_927"></a>9.1 番外: WebSocket传参</h4> 
<p>WebSocket的第一次请求是基于Http进行建立链接的, 所以WebSocket是可以在url中或者请求体中携带token等参数的. 当然后端并不像写Api时那么简单的就可以获取, 需要截取当前请求的Url或者携带的信息, 然后进行读取, 进而进行验证等操作. 这部分的代码之后再补充…</p> 
<pre><code class="prism language-csharp"><span class="token comment">//.Net Core从Url中读取参数</span>
</code></pre> 
<h3><a id="10__935"></a>10 多服务器以及不同服务间的协同</h3> 
<p>得益于我们实现的<code>SessionManager</code>, 我们将不用<code>Server</code>的<code>SessionManger</code>注入DI后, 我们可以在任意<code>Server</code>的<code>Service</code>中做到跨<code>Service</code>进行消息传递, 验证等等操作.</p> 
<h3><a id="More_1__939"></a>More 1 协议的编解码器开发预览</h3> 
<p>协议编解码器样例:</p> 
<p>EV26 Gps通信协议(使用方法在xUnit测试中):</p> 
<ol><li><a href="https://github.com/DonPangPang/NbazhGPS">Github</a></li><li><a href="https://gitee.com/DonPangPang/NbazhGPS" rel="nofollow">Gitee</a></li></ol> 
<p>简单样例:</p> 
<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Nbazh0X01Test</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ITestOutputHelper</span> _testOutputHelper<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">NbazhGpsSerializer</span> NbazhGpsSerializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">NbazhGpsSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">Nbazh0X01Test</span><span class="token punctuation">(</span><span class="token class-name">ITestOutputHelper</span> testOutputHelper<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        _testOutputHelper <span class="token operator">=</span> testOutputHelper<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Fact</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//78 78 11 01 07 52 53 36 78 90 02 42 70 00 32 01 00 05 12 79 0D 0A</span>

        <span class="token class-name"><span class="token keyword">var</span></span> hex <span class="token operator">=</span> <span class="token string">"7878 11 01 07 52 53 36 78 90 02 42 7000 3201 0005 1279 0D0A"</span><span class="token punctuation">.</span><span class="token function">ToHexBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ----协议解析部分----//</span>
        <span class="token class-name"><span class="token keyword">var</span></span> packet <span class="token operator">=</span> NbazhGpsSerializer<span class="token punctuation">.</span><span class="token function">Deserialize</span><span class="token punctuation">(</span>hex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Nbazh0X01</span> body <span class="token operator">=</span> <span class="token punctuation">(</span>Nbazh0X01<span class="token punctuation">)</span>packet<span class="token punctuation">.</span>Bodies<span class="token punctuation">;</span>
        <span class="token comment">// ----协议解析部分----//</span>

        Assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span><span class="token number">0x11</span><span class="token punctuation">,</span> packet<span class="token punctuation">.</span>Header<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token punctuation">,</span> packet<span class="token punctuation">.</span>Header<span class="token punctuation">.</span>MsgId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        Assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span><span class="token string">"7 52 53 36 78 90 02 42"</span><span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span> body<span class="token punctuation">.</span>TerminalId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span><span class="token number">0x7000</span><span class="token punctuation">,</span> body<span class="token punctuation">.</span>TerminalType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//Assert.Equal(0x3201, body.TimeZoneLanguage.Serialize());</span>

        Assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span><span class="token number">0x0005</span><span class="token punctuation">,</span> packet<span class="token punctuation">.</span>Header<span class="token punctuation">.</span>MsgNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span><span class="token number">0x1279</span><span class="token punctuation">,</span> packet<span class="token punctuation">.</span>Header<span class="token punctuation">.</span>Crc<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 时区 0011 001000000001</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="More_2_DotNetty_988"></a>More 2 DotNetty</h3> 
<p>以后我们会探究DotNetty与SuperSocket的异同.</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ec0de17bfdb9fd3043ad8af5a5683feb/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">mysql-installer安装教程（详细图文）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3e5b0167c7054c3ad487fdd47753ba32/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">使用ConfigurationProperties提示错误解决</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>