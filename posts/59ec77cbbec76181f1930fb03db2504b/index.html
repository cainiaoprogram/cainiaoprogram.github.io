<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SpringBoot实现动态数据国际化 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="SpringBoot实现动态数据国际化" />
<meta property="og:description" content="文章目录 说在前面方案一：单库单表多字段数据表设计代码实现方式一：查询时根据语言标识进行字段过滤方式二：拦截响应数据结合JsonNode树模型统一处理 开始测试总结一下 方案二：单库单表多记录数据表设计代码实现开始测试总结一下 方案三：多库结合动态数据源切换数据表设计代码实现代码测试总结一下 大家好，我是Bivin，最近项目中遇到了动态数据多语言切换的需求,平台的动态数据需要支持中文简体、中文繁体、英语三种语言的自由切换，也就是所谓的国际化，我也是头一次接到这样的需求，去网上搜了搜发现对应的方案寥寥无几，算了，自己干吧，就这样总结出了三种我觉得可行的方案，凑合看吧！ 说在前面 本文只讲解动态数据的国际化，且只做中文简体、中文繁体、英文三种语言的动态数据切换，加其他语言也是一样的思路，所有方案均采用文章类型表(article_type)作为例子。
方案一：单库单表多字段 此方案的思路是在一个表中使用不同的字段存储不同语言的数据，比如我们的文章类型名称需要支持的语言是中文简体(CN)、中文繁体(TC)和英文(EN)，那么就设计三个不同语言的name字段，来分别存储这三种语言下的类型名称，代码层面通过统一响应处理器结合JackSon的树模型递归遍历移除和替换字段，返回用户所指定语言对应的数据。
关键词：单表、多字段、统一响应处理、JackSon树模型
数据表设计 列名类型备注aidint(11)自增aidcn_namevarchar(20)名称（中文简体）tc_namevarchar(20)名称（中文繁体）en_namevarchar(20)名称（英文）create_timedatatime创建时间update_timedatatime更新时间 如果还有其他字段需要支持多种语言，也可以这么来设计数据表的结构。
代码实现 此方案代码实现的思路是首先前后端统一约定好语言标识，中文简体：CN、中文繁体：TC、英文：EN，用户在页面上选择什么语言就在请求头中将该语言对应的标识携带到后端，后端获取到语言标识后再对其进行处理，这里我梳理了两种可实现的方案供各位参考，尤其是第二种方案。
方式一：查询时根据语言标识进行字段过滤 后端在每个需要实现动态数据国际化的接口中获取到请求头中的语言前缀language，在查询时过滤掉带其他语言标识的字段，只查询将当前语言标识作为前缀的字段和公用的字段，比如当前用户选择的是中文简体，那么从请求头中获取到的语言标识就是CN，所以在查询字段时就只查询含有CN前缀的字段和业务上需要使用到的公共字段即可，这样展示在用户面前的就是中文简体的数据，如果用户选择的是英文也是一样的方法。
此方案的缺点：冗余代码会特别多，很多跟业务无关的代码会直接侵入业务代码中，维护困难且开发成本高，开发者不仅要关注业务逻辑本身，还得关注语言的切换。优点就是实现起来相对简单一些，总之不是很推荐这种方案。
方式二：拦截响应数据结合JsonNode树模型统一处理 新建一个ResponseAdvice类，实现ResponseBodyAdvice接口拦截响应数据，在其beforeBodyWrite方法中对所有需要进行国际化处理的数据进行统一解析处理，这其中使用到了JackSon的JsonNode树模型，递归遍历响应结构。
1. 在代码中维护一个语言前缀列表，使用时将其转换为小写，用于后面过滤带有语言前缀的字段，使用HttpServletRequest获取到请求头中的语言前缀language，将其从语言前缀列表中移除，再将body转换为JsonNode，递归调用自定义的方法responseDataParseAndRemove()进行字段移除和重组。
@SneakyThrows @Override public Object beforeBodyWrite(Object body, MethodParameter returnType, MediaType selectedContentType, Class selectedConverterType, ServerHttpRequest request, ServerHttpResponse response) { // 通过HttpServletRequest获取到用户当前的语言环境 ServletRequestAttributes servletRequestAttributes = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()); if (servletRequestAttributes != null) { HttpServletRequest httpServletRequest = servletRequestAttributes.getRequest(); // 本地维护一个语言前缀列表 List&lt;String&gt; languageList = new ArrayList&lt;&gt;(); languageList.add(&#34;CN&#34;); languageList.add(&#34;TC&#34;); languageList.add(&#34;EN&#34;); // 将响应数据body序列化为JsonNode ObjectMapper objectMapper = new ObjectMapper(); JsonNode node = objectMapper." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/59ec77cbbec76181f1930fb03db2504b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-09T18:30:28+08:00" />
<meta property="article:modified_time" content="2023-08-09T18:30:28+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SpringBoot实现动态数据国际化</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#_2" rel="nofollow">说在前面</a></li><li><a href="#_5" rel="nofollow">方案一：单库单表多字段</a></li><li><ul><li><a href="#_8" rel="nofollow">数据表设计</a></li><li><a href="#_21" rel="nofollow">代码实现</a></li><li><ul><li><a href="#_24" rel="nofollow">方式一：查询时根据语言标识进行字段过滤</a></li><li><a href="#JsonNode_30" rel="nofollow">方式二：拦截响应数据结合JsonNode树模型统一处理</a></li></ul> 
    </li><li><a href="#_241" rel="nofollow">开始测试</a></li><li><a href="#_300" rel="nofollow">总结一下</a></li></ul> 
   </li><li><a href="#_307" rel="nofollow">方案二：单库单表多记录</a></li><li><ul><li><a href="#_312" rel="nofollow">数据表设计</a></li><li><a href="#_320" rel="nofollow">代码实现</a></li><li><a href="#_372" rel="nofollow">开始测试</a></li><li><a href="#_395" rel="nofollow">总结一下</a></li></ul> 
   </li><li><a href="#_401" rel="nofollow">方案三：多库结合动态数据源切换</a></li><li><ul><li><a href="#_406" rel="nofollow">数据表设计</a></li><li><a href="#_415" rel="nofollow">代码实现</a></li><li><a href="#_588" rel="nofollow">代码测试</a></li><li><a href="#_607" rel="nofollow">总结一下</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<br> 大家好，我是Bivin，最近项目中遇到了动态数据多语言切换的需求,平台的动态数据需要支持中文简体、中文繁体、英语三种语言的自由切换，也就是所谓的国际化，我也是头一次接到这样的需求，去网上搜了搜发现对应的方案寥寥无几，算了，自己干吧，就这样总结出了三种我觉得可行的方案，凑合看吧！ 
<p></p> 
<h3><a id="_2"></a>说在前面</h3> 
<p>本文只讲解动态数据的国际化，且只做中文简体、中文繁体、英文三种语言的动态数据切换，加其他语言也是一样的思路，所有方案均采用文章类型表(article_type)作为例子。</p> 
<h3><a id="_5"></a>方案一：单库单表多字段</h3> 
<p>此方案的思路是在一个表中使用不同的字段存储不同语言的数据，比如我们的文章类型名称需要支持的语言是中文简体(CN)、中文繁体(TC)和英文(EN)，那么就设计三个不同语言的name字段，来分别存储这三种语言下的类型名称，代码层面通过统一响应处理器结合JackSon的树模型递归遍历移除和替换字段，返回用户所指定语言对应的数据。</p> 
<blockquote> 
 <p><strong>关键词</strong>：单表、多字段、统一响应处理、JackSon树模型</p> 
</blockquote> 
<h4><a id="_8"></a>数据表设计</h4> 
<table><thead><tr><th>列名</th><th>类型</th><th>备注</th></tr></thead><tbody><tr><td>aid</td><td>int(11)</td><td>自增aid</td></tr><tr><td>cn_name</td><td>varchar(20)</td><td>名称（中文简体）</td></tr><tr><td>tc_name</td><td>varchar(20)</td><td>名称（中文繁体）</td></tr><tr><td>en_name</td><td>varchar(20)</td><td>名称（英文）</td></tr><tr><td>create_time</td><td>datatime</td><td>创建时间</td></tr><tr><td>update_time</td><td>datatime</td><td>更新时间</td></tr></tbody></table> 
<blockquote> 
 <p>如果还有其他字段需要支持多种语言，也可以这么来设计数据表的结构。</p> 
</blockquote> 
<h4><a id="_21"></a>代码实现</h4> 
<p>此方案代码实现的思路是首先前后端统一约定好语言标识，中文简体：CN、中文繁体：TC、英文：EN，用户在页面上选择什么语言就在请求头中将该语言对应的标识携带到后端，后端获取到语言标识后再对其进行处理，这里我梳理了两种可实现的方案供各位参考，尤其是第二种方案。</p> 
<h5><a id="_24"></a>方式一：查询时根据语言标识进行字段过滤</h5> 
<p>后端在每个需要实现动态数据国际化的接口中获取到请求头中的语言前缀language，在查询时过滤掉带其他语言标识的字段，只查询将当前语言标识作为前缀的字段和公用的字段，比如当前用户选择的是中文简体，那么从请求头中获取到的语言标识就是CN，所以在查询字段时就只查询含有CN前缀的字段和业务上需要使用到的公共字段即可，这样展示在用户面前的就是中文简体的数据，如果用户选择的是英文也是一样的方法。</p> 
<blockquote> 
 <p>此方案的缺点：冗余代码会特别多，很多跟业务无关的代码会直接侵入业务代码中，维护困难且开发成本高，开发者不仅要关注业务逻辑本身，还得关注语言的切换。优点就是实现起来相对简单一些，总之不是很推荐这种方案。</p> 
</blockquote> 
<h5><a id="JsonNode_30"></a>方式二：拦截响应数据结合JsonNode树模型统一处理</h5> 
<p>新建一个ResponseAdvice类，实现ResponseBodyAdvice接口拦截响应数据，在其beforeBodyWrite方法中对所有需要进行国际化处理的数据进行统一解析处理，这其中使用到了JackSon的JsonNode树模型，递归遍历响应结构。</p> 
<p><strong>1. 在代码中维护一个语言前缀列表，使用时将其转换为小写，用于后面过滤带有语言前缀的字段，使用HttpServletRequest获取到请求头中的语言前缀language，将其从语言前缀列表中移除，再将body转换为JsonNode，递归调用自定义的方法responseDataParseAndRemove()进行字段移除和重组。</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@SneakyThrows</span>  
<span class="token annotation punctuation">@Override</span>  
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">beforeBodyWrite</span><span class="token punctuation">(</span><span class="token class-name">Object</span> body<span class="token punctuation">,</span> <span class="token class-name">MethodParameter</span> returnType<span class="token punctuation">,</span> <span class="token class-name">MediaType</span> selectedContentType<span class="token punctuation">,</span> <span class="token class-name">Class</span> selectedConverterType<span class="token punctuation">,</span> <span class="token class-name">ServerHttpRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServerHttpResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
    <span class="token comment">// 通过HttpServletRequest获取到用户当前的语言环境  </span>
    <span class="token class-name">ServletRequestAttributes</span> servletRequestAttributes <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ServletRequestAttributes</span><span class="token punctuation">)</span> <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">getRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span>servletRequestAttributes <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
    <span class="token class-name">HttpServletRequest</span> httpServletRequest <span class="token operator">=</span> servletRequestAttributes<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">// 本地维护一个语言前缀列表  </span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> languageList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    languageList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"CN"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    languageList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"TC"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    languageList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"EN"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">// 将响应数据body序列化为JsonNode  </span>
    <span class="token class-name">ObjectMapper</span> objectMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token class-name">JsonNode</span> node <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">readTree</span><span class="token punctuation">(</span>objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token class-name">String</span> language <span class="token operator">=</span> httpServletRequest<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"language"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    languageList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>language<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token function">responseDataParseAndRemove</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> languageList<span class="token punctuation">,</span> language<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">return</span> node<span class="token punctuation">;</span>  
 <span class="token punctuation">}</span>  
<span class="token keyword">return</span> body<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>2. 在自定义方法responseDataParseAndRemove()中递归遍历所有字段，移除带有指定语言前缀的字段并新建目标字段，将当前语言标识的字段对应的值赋值给目标字段，方便前端处理。</strong></p> 
<pre><code class="prism language-java"><span class="token comment">/**  
* &lt;p&gt; 指定前缀字段移除&lt;/p&gt;  
*  
* @param node 响应数据节点  
* @param toRemoveFieldPrefixList 待移除的字段前缀数组  
* @description: 通过解析Json结构的响应数据、移除指定前缀字段、以达到动态数据在不同语言环境下的动态切换  
**/</span>  
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">responseDataParseAndRemove</span><span class="token punctuation">(</span><span class="token class-name">JsonNode</span> node<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> toRemoveFieldPrefixList<span class="token punctuation">,</span> <span class="token class-name">String</span> language<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
<span class="token comment">// 节点只有两种：容器节点和非容器节点  </span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">isContainerNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
    <span class="token comment">// 判断该节点是对象还是数组  </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">isObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> currentLanguageFieldNameList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">// 如果JsonNode是对象  </span>
    <span class="token class-name">ObjectNode</span> objectNode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ObjectNode</span><span class="token punctuation">)</span> node<span class="token punctuation">;</span>  
    <span class="token comment">// 待移除的字段列表初始化，本列表的作用是暂存所有满足条件待移除的字段  </span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> toRemoveFieldList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">JsonNode</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> nodeFieldList <span class="token operator">=</span> objectNode<span class="token punctuation">.</span><span class="token function">fields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">while</span> <span class="token punctuation">(</span>nodeFieldList<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
    <span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">JsonNode</span><span class="token punctuation">&gt;</span></span> nodeField <span class="token operator">=</span> nodeFieldList<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token class-name">String</span> fieldName <span class="token operator">=</span> nodeField<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token class-name">JsonNode</span> fieldValue <span class="token operator">=</span> nodeField<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">// 如果当前字段名的前缀属于待移除前缀列表中的任何一个元素，说明当前这个字段需要移除，加入到toRemoveFieldList  </span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> toRemoveFieldPrefix <span class="token operator">:</span> toRemoveFieldPrefixList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fieldName<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>toRemoveFieldPrefix<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
         toRemoveFieldList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>fieldName<span class="token punctuation">)</span><span class="token punctuation">;</span>  
      <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>  
    <span class="token comment">// 继续判断字段值是不是一个对象，如果是则递归调用当前方法进行处理;如果是数组则循环递归调用当前方法进行处理  </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fieldValue<span class="token punctuation">.</span><span class="token function">isObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
       <span class="token function">responseDataParseAndRemove</span><span class="token punctuation">(</span>fieldValue<span class="token punctuation">,</span> toRemoveFieldPrefixList<span class="token punctuation">,</span> language<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fieldValue<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
       <span class="token class-name">ArrayNode</span> arrayNode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ArrayNode</span><span class="token punctuation">)</span> fieldValue<span class="token punctuation">;</span>  
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">JsonNode</span> element <span class="token operator">:</span> arrayNode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
       <span class="token function">responseDataParseAndRemove</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> toRemoveFieldPrefixList<span class="token punctuation">,</span> language<span class="token punctuation">)</span><span class="token punctuation">;</span>  
     <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>  
    <span class="token comment">// 需要将当前语言的值替换到目标字段，所以维护一个含有当前语言前缀的字段和目标字段的  </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fieldName<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>language<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
       currentLanguageFieldNameList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>fieldName<span class="token punctuation">)</span><span class="token punctuation">;</span>  
      <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>  
    <span class="token comment">// 一次性移除所有待移除的字段  </span>
    objectNode<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>toRemoveFieldList<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">// 一次性替换所有字段  </span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> fieldName <span class="token operator">:</span> currentLanguageFieldNameList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
    <span class="token comment">// 新建一个目标字段：规则为原字段去掉当前语言前缀再转换为小驼峰，比如当前语言是cn，原字段是cnName,去掉前缀后就是再将首字母转换为小写就可以得到name  </span>
    <span class="token class-name">String</span> targetFiledName <span class="token operator">=</span> fieldName<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>language<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    targetFiledName <span class="token operator">=</span> targetFiledName<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> targetFiledName<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">// 获取到原字段的值  </span>
    <span class="token class-name">JsonNode</span> fieldValue <span class="token operator">=</span> objectNode<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>fieldName<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">// 将目标字段添加到树模型中，原字段的值作为目标字段的值  </span>
    objectNode<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>targetFiledName<span class="token punctuation">,</span> fieldValue<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">// 移除原字段  </span>
    objectNode<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>fieldName<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
    <span class="token comment">// 如果JsonNode是数组  </span>
    <span class="token class-name">ArrayNode</span> arrayNode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ArrayNode</span><span class="token punctuation">)</span> node<span class="token punctuation">;</span>  
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">JsonNode</span> element <span class="token operator">:</span> arrayNode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
    <span class="token function">responseDataParseAndRemove</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> toRemoveFieldPrefixList<span class="token punctuation">,</span> language<span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>  
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>  
    <span class="token comment">// 非容器节点  </span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"非容器节点，不需要任何处理"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token punctuation">}</span>  
 <span class="token punctuation">}</span>  
</code></pre> 
<p><strong>下面是完整代码，仔细阅读才能搞明白</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Slf4j</span>  
<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"all"</span><span class="token punctuation">)</span>  
<span class="token annotation punctuation">@RestControllerAdvice</span>  
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ResponseAdvice</span> <span class="token keyword">implements</span> <span class="token class-name">ResponseBodyAdvice</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>  
  
<span class="token annotation punctuation">@Override</span>  
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">supports</span><span class="token punctuation">(</span><span class="token class-name">MethodParameter</span> returnType<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">HttpMessageConverter</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> converterType<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
  
<span class="token annotation punctuation">@SneakyThrows</span>  
<span class="token annotation punctuation">@Override</span>  
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">beforeBodyWrite</span><span class="token punctuation">(</span><span class="token class-name">Object</span> body<span class="token punctuation">,</span> <span class="token class-name">MethodParameter</span> returnType<span class="token punctuation">,</span> <span class="token class-name">MediaType</span> selectedContentType<span class="token punctuation">,</span> <span class="token class-name">Class</span> selectedConverterType<span class="token punctuation">,</span> <span class="token class-name">ServerHttpRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServerHttpResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
    <span class="token comment">// 通过HttpServletRequest获取到用户当前的语言环境  </span>
    <span class="token class-name">ServletRequestAttributes</span> servletRequestAttributes <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ServletRequestAttributes</span><span class="token punctuation">)</span> <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">getRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span>servletRequestAttributes <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
    <span class="token class-name">HttpServletRequest</span> httpServletRequest <span class="token operator">=</span> servletRequestAttributes<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">// 本地维护一个语言前缀列表  </span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> languageList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    languageList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"CN"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    languageList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"TC"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    languageList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"EN"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">// 将响应数据body序列化为JsonNode  </span>
    <span class="token class-name">ObjectMapper</span> objectMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token class-name">JsonNode</span> node <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">readTree</span><span class="token punctuation">(</span>objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token class-name">String</span> language <span class="token operator">=</span> httpServletRequest<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"language"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    languageList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>language<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token function">responseDataParseAndRemove</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> languageList<span class="token punctuation">,</span> language<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">return</span> node<span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
    <span class="token keyword">return</span> body<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
  
  
<span class="token comment">/**  
* &lt;p&gt; 响应数据解析和指定前缀字段移除&lt;/p&gt;  
*  
* @param node 响应数据节点  
* @param toRemoveFieldPrefixList 待移除的字段前缀数组  
* @description: 通过解析Json结构的响应数据、移除指定前缀字段、以达到动态数据在不同语言环境下的动态切换  
**/</span>  
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">responseDataParseAndRemove</span><span class="token punctuation">(</span><span class="token class-name">JsonNode</span> node<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> toRemoveFieldPrefixList<span class="token punctuation">,</span> <span class="token class-name">String</span> language<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
    <span class="token comment">// 节点只有两种：容器节点和非容器节点  </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">isContainerNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
    <span class="token comment">// 判断该节点是对象还是数组  </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">isObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> currentLanguageFieldNameList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">// 如果JsonNode是对象  </span>
    <span class="token class-name">ObjectNode</span> objectNode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ObjectNode</span><span class="token punctuation">)</span> node<span class="token punctuation">;</span>  
    <span class="token comment">// 待移除的字段列表初始化，本列表的作用是暂存所有满足条件待移除的字段  </span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> toRemoveFieldList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">JsonNode</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> nodeFieldList <span class="token operator">=</span> objectNode<span class="token punctuation">.</span><span class="token function">fields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">while</span> <span class="token punctuation">(</span>nodeFieldList<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
    <span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">JsonNode</span><span class="token punctuation">&gt;</span></span> nodeField <span class="token operator">=</span> nodeFieldList<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token class-name">String</span> fieldName <span class="token operator">=</span> nodeField<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token class-name">JsonNode</span> fieldValue <span class="token operator">=</span> nodeField<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">// 如果当前字段名的前缀属于待移除前缀列表中的任何一个元素，说明当前这个字段需要移除，加入到toRemoveFieldList  </span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> toRemoveFieldPrefix <span class="token operator">:</span> toRemoveFieldPrefixList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fieldName<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>toRemoveFieldPrefix<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
       toRemoveFieldList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>fieldName<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>  
    <span class="token comment">// 继续判断字段值是不是一个对象，如果是则递归调用当前方法进行处理;如果是数组则循环递归调用当前方法进行处理  </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fieldValue<span class="token punctuation">.</span><span class="token function">isObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
    <span class="token function">responseDataParseAndRemove</span><span class="token punctuation">(</span>fieldValue<span class="token punctuation">,</span> toRemoveFieldPrefixList<span class="token punctuation">,</span> language<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fieldValue<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
    <span class="token class-name">ArrayNode</span> arrayNode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ArrayNode</span><span class="token punctuation">)</span> fieldValue<span class="token punctuation">;</span>  
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">JsonNode</span> element <span class="token operator">:</span> arrayNode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
      <span class="token function">responseDataParseAndRemove</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> toRemoveFieldPrefixList<span class="token punctuation">,</span> language<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>  
    <span class="token comment">// 需要将当前语言的值替换到目标字段，所以维护一个含有当前语言前缀的字段和目标字段的  </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fieldName<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>language<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
    currentLanguageFieldNameList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>fieldName<span class="token punctuation">)</span><span class="token punctuation">;</span>  
     <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>  
    <span class="token comment">// 一次性移除所有待移除的字段  </span>
    objectNode<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>toRemoveFieldList<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">// 一次性替换所有字段  </span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> fieldName <span class="token operator">:</span> currentLanguageFieldNameList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
    <span class="token comment">// 新建一个目标字段：规则为原字段去掉当前语言前缀再转换为小驼峰，比如当前语言是cn，原字段是cnName,去掉前缀后就是再将首字母转换为小写就可以得到name  </span>
    <span class="token class-name">String</span> targetFiledName <span class="token operator">=</span> fieldName<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>language<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    targetFiledName <span class="token operator">=</span> targetFiledName<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> targetFiledName<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">// 获取到原字段的值  </span>
    <span class="token class-name">JsonNode</span> fieldValue <span class="token operator">=</span> objectNode<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>fieldName<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">// 将目标字段添加到树模型中，原字段的值作为目标字段的值  </span>
    objectNode<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>targetFiledName<span class="token punctuation">,</span> fieldValue<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">// 移除原字段  </span>
    objectNode<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>fieldName<span class="token punctuation">)</span><span class="token punctuation">;</span>  
     <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
    <span class="token comment">// 如果JsonNode是数组  </span>
    <span class="token class-name">ArrayNode</span> arrayNode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ArrayNode</span><span class="token punctuation">)</span> node<span class="token punctuation">;</span>  
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">JsonNode</span> element <span class="token operator">:</span> arrayNode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
    <span class="token function">responseDataParseAndRemove</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> toRemoveFieldPrefixList<span class="token punctuation">,</span> language<span class="token punctuation">)</span><span class="token punctuation">;</span>  
     <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>  
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>  
    <span class="token comment">// 非容器节点  </span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"非容器节点，不需要任何处理"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
   <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_241"></a>开始测试</h4> 
<p><strong>新建一个响应实体类，代码如下所示</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>  
<span class="token annotation punctuation">@Accessors</span><span class="token punctuation">(</span>chain <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>  
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GetArticleTypeListResponse</span> <span class="token punctuation">{<!-- --></span>  
    <span class="token comment">/**  
    * 自增aid  
    */</span>  
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> id<span class="token punctuation">;</span>  
    <span class="token comment">/**  
    * 中文简体名称  
    */</span>  
    <span class="token keyword">private</span> <span class="token class-name">String</span> cnName<span class="token punctuation">;</span>  
    <span class="token comment">/**  
    * 中文繁体名称  
    */</span>  
    <span class="token keyword">private</span> <span class="token class-name">String</span> tcName<span class="token punctuation">;</span>  
    <span class="token comment">/**  
    * 英文名称  
    */</span>  
    <span class="token keyword">private</span> <span class="token class-name">String</span> enName<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
</code></pre> 
<p>我这里为了测试方便，直接在controller中写一个方法进行测试，我的响应类中有cnName(中文简体名称)、tcName(中文繁体名称)和enName(英文名称)，经过统一响应处理，返回到前端就只会是一个name，其它不带有语言前缀的字段，会正常返回。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/get-article-type-list"</span><span class="token punctuation">)</span>  
<span class="token keyword">public</span> <span class="token class-name">CommonResponse</span> <span class="token function">getArticleTypeList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GetArticleTypeListResponse</span><span class="token punctuation">&gt;</span></span> responseList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token class-name">GetArticleTypeListResponse</span> responseOriginal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetArticleTypeListResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    responseOriginal<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    responseOriginal<span class="token punctuation">.</span><span class="token function">setCnName</span><span class="token punctuation">(</span><span class="token string">"原创"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    responseOriginal<span class="token punctuation">.</span><span class="token function">setTcName</span><span class="token punctuation">(</span><span class="token string">"原創"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    responseOriginal<span class="token punctuation">.</span><span class="token function">setEnName</span><span class="token punctuation">(</span><span class="token string">"original"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    responseList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>responseOriginal<span class="token punctuation">)</span><span class="token punctuation">;</span>  


    <span class="token class-name">GetArticleTypeListResponse</span> responseForward <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetArticleTypeListResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    responseForward<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    responseForward<span class="token punctuation">.</span><span class="token function">setCnName</span><span class="token punctuation">(</span><span class="token string">"转发"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    responseForward<span class="token punctuation">.</span><span class="token function">setTcName</span><span class="token punctuation">(</span><span class="token string">"轉發"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    responseForward<span class="token punctuation">.</span><span class="token function">setEnName</span><span class="token punctuation">(</span><span class="token string">"forward"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    responseList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>responseForward<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">return</span> <span class="token class-name">CommonResponse</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>responseList<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
</code></pre> 
<p>当language等于CN(中文简体)时，结果如下所示</p> 
<p><img src="https://images2.imgbox.com/d5/93/FleIAsjU_o.png" alt="image.png"></p> 
<p>当language等于TC(中文繁体)时，结果如下所示</p> 
<p><img src="https://images2.imgbox.com/47/39/70sBuQ0M_o.png" alt="image.png"></p> 
<p>当language等于EN(英文)时，结果如下所示</p> 
<p><img src="https://images2.imgbox.com/8b/57/YLb5WzV4_o.png" alt="image.png"></p> 
<h4><a id="_300"></a>总结一下</h4> 
<blockquote> 
 <p><strong>此方案的优点</strong>：设计简单、实现也不算复杂、单表数据量不会因为语言的增加而增加。 <br><br> <strong>此方案的缺点</strong>：可扩展性差、增加一种语言就需要去修改一次表结构，维护困难。 <br><br> <strong>适用的场景</strong>：系统数据量小、团队规模小、支持的语言基本固定</p> 
</blockquote> 
<p></p> 
<h3><a id="_307"></a>方案二：单库单表多记录</h3> 
<p>此方案的思路是在一个表中存储不同语言的记录，比如我们需要支持的语言是中文简体(CN)、中文繁体(TC)和英文(EN)，那么就在article_type表中存储三条不同语言的数据数据并标识出每条数据所属语言，再给这三条语言一个唯一标识，方便其他表引用。查询时将用户所选择的语言作为查询条件即可。</p> 
<blockquote> 
 <p><strong>关键词</strong>：单表、多记录、唯一标识</p> 
</blockquote> 
<h4><a id="_312"></a>数据表设计</h4> 
<table><thead><tr><th>列名</th><th>类型</th><th>备注</th></tr></thead><tbody><tr><td>aid</td><td>int(11)</td><td>自增aid</td></tr><tr><td>uuid</td><td>char(32)</td><td>唯一标识</td></tr><tr><td>name</td><td>varchar(20)</td><td>名称</td></tr><tr><td>language</td><td>char(2)</td><td>所属语言</td></tr></tbody></table> 
<h4><a id="_320"></a>代码实现</h4> 
<p><strong>实现思路</strong>：定义一个LanguageUtil类，在拦截器中拦截所有请求，将前端通过Header携带过来的language获取到并通过LanguageUtil存储到ThreadLocal中，在需要使用的地方取出来作为条件即可。<br></p> 
<p><strong>创建LanguageUtil类,用于临时存储用户选择的语言</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LanguageUtil</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token constant">LANGUAGE_THREAD_LOCAL</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setLanguage</span><span class="token punctuation">(</span><span class="token class-name">String</span> language<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token constant">LANGUAGE_THREAD_LOCAL</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>language<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getLanguage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token constant">LANGUAGE_THREAD_LOCAL</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">cleanLanguage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token constant">LANGUAGE_THREAD_LOCAL</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>创建RequestInterceptor类作为拦截器,用于拦截请求并获取language</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RequestInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 获取请求头中的language</span>
        <span class="token class-name">String</span> language <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"language"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LanguageUtil</span><span class="token punctuation">.</span><span class="token function">setLanguage</span><span class="token punctuation">(</span>language<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>创建InterceptorConfig类用于注册拦截器</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InterceptorConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RequestInterceptor</span> requestInterceptor<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span><span class="token class-name">InterceptorRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">InterceptorRegistration</span> interceptorRegistration <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span>requestInterceptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定拦截匹配模式</span>
        interceptorRegistration<span class="token punctuation">.</span><span class="token function">addPathPatterns</span><span class="token punctuation">(</span><span class="token string">"/**"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_372"></a>开始测试</h4> 
<p><strong>数据表里面模拟了三条不同语言的数据</strong><br><br> <img src="https://images2.imgbox.com/fe/49/CeXVmEwN_o.png" alt="image.png"><br><br> <strong>创建一个ExampleController类用于测试</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExampleController</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">ArticleTypeMapper</span> articleTypeMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/get-article-type-list"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ArticleType</span><span class="token punctuation">&gt;</span></span> <span class="token function">getArticleTypeList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 通过LanguageUtil获取到语言</span>
        <span class="token class-name">String</span> language <span class="token operator">=</span> <span class="token class-name">LanguageUtil</span><span class="token punctuation">.</span><span class="token function">getLanguage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ArticleType</span><span class="token punctuation">&gt;</span></span> lambdaQueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        lambdaQueryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">ArticleType</span><span class="token operator">::</span><span class="token function">getLanguage</span><span class="token punctuation">,</span> language<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> articleTypeMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>lambdaQueryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>使用ApiFox发起请求</strong><br>当language等于CN时得到的结果如下所示<br><img src="https://images2.imgbox.com/46/f6/vAAdhRSq_o.png" alt="image.png"><br>当language等于TC时得到的结果如下所示<br><img src="https://images2.imgbox.com/5a/72/HoJfuOJL_o.png" alt="image.png"><br>当language等于EN时得到的结果如下所示<br><img src="https://images2.imgbox.com/b6/dd/dLSwQwPe_o.png" alt="image.png"><br></p> 
<h4><a id="_395"></a>总结一下</h4> 
<blockquote> 
 <p><strong>此方案的优点</strong>：实现简单、具有可扩展性、如果后期增加其他语言，则只需要添加对应的记录即可。<br><br> <strong>此方案的缺点</strong>：单表数据量会很大、维护困难、随着业务增长数据量变大，查询性能会降低，使用UUID作为唯一标识，存储空间占用大、查询性能也受影响。<br><br> <strong>适用的场景</strong>：数据量小、支持的语言相对稳定的系统。</p> 
</blockquote> 
<h3><a id="_401"></a>方案三：多库结合动态数据源切换</h3> 
<p>此方案的思路是根据语言的种类建立多个库，比如我们需要支持的语言是中文简体(CN)、中文繁体(TC)和英文(EN)，那么就需要建立三个数据库，一个数据库存储一种语言的数据，三个库的表结构完全一样，查询时通过动态数据源切换来操作指定的库即可。</p> 
<blockquote> 
 <p>关键词：多个库、动态数据源切换</p> 
</blockquote> 
<h4><a id="_406"></a>数据表设计</h4> 
<p>三个数据库分别为中文简体数据库(cn_db)、中文繁体数据库(tc_db)、英文数据库(en_db)，每个库里面都设计文章类型表(article_type)，结构如下所示：</p> 
<table><thead><tr><th>列名</th><th>类型</th><th>备注</th></tr></thead><tbody><tr><td>aid</td><td>int(11)</td><td>自增aid</td></tr><tr><td>name</td><td>varchar(20)</td><td>名称</td></tr></tbody></table> 
<h4><a id="_415"></a>代码实现</h4> 
<p><strong>实现思路</strong>：配置多个数据源，在拦截器中获取用户所选择的language将其拼接为数据源名称，再通过DataSourceUtil存储到ThreadLocal中实现动态切换数据源。<br></p> 
<p><strong>多数据源application.yml文件配置</strong></p> 
<pre><code class="prism language-java">server<span class="token operator">:</span>
  port<span class="token operator">:</span> <span class="token number">8090</span>
spring<span class="token operator">:</span>
  datasource<span class="token operator">:</span>
    driver<span class="token operator">-</span><span class="token keyword">class</span><span class="token operator">-</span>name<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>cj<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span>Driver</span>
    # 简体中文数据库 cn_db
    cn_db<span class="token operator">:</span>
      jdbc<span class="token operator">-</span>url<span class="token operator">:</span> jdbc<span class="token operator">:</span>mysql<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">3306</span><span class="token operator">/</span>cn_db<span class="token operator">?</span>useSLL<span class="token operator">=</span><span class="token boolean">false</span><span class="token operator">&amp;</span>createDatabaseIfNotExist<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>useSSL<span class="token operator">=</span><span class="token boolean">false</span><span class="token operator">&amp;</span>characterEncoding<span class="token operator">=</span><span class="token constant">UTF</span><span class="token operator">-</span><span class="token number">8</span><span class="token operator">&amp;</span>allowMultiQueries<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>serverTimezone<span class="token operator">=</span><span class="token constant">GMT</span><span class="token operator">%</span><span class="token number">2</span><span class="token constant">B8</span><span class="token operator">&amp;</span>allowPublicKeyRetrieval<span class="token operator">=</span><span class="token boolean">true</span>
      password<span class="token operator">:</span> 密码
      username<span class="token operator">:</span> root
      driver<span class="token operator">-</span><span class="token keyword">class</span><span class="token operator">-</span>name<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>cj<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span>Driver</span>
    # 英文数据库 en_db
    en_db<span class="token operator">:</span>
      jdbc<span class="token operator">-</span>url<span class="token operator">:</span> jdbc<span class="token operator">:</span>mysql<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">3306</span><span class="token operator">/</span>en_db<span class="token operator">?</span>useSLL<span class="token operator">=</span><span class="token boolean">false</span><span class="token operator">&amp;</span>createDatabaseIfNotExist<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>useSSL<span class="token operator">=</span><span class="token boolean">false</span><span class="token operator">&amp;</span>characterEncoding<span class="token operator">=</span><span class="token constant">UTF</span><span class="token operator">-</span><span class="token number">8</span><span class="token operator">&amp;</span>allowMultiQueries<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>serverTimezone<span class="token operator">=</span><span class="token constant">GMT</span><span class="token operator">%</span><span class="token number">2</span><span class="token constant">B8</span><span class="token operator">&amp;</span>allowPublicKeyRetrieval<span class="token operator">=</span><span class="token boolean">true</span>
      password<span class="token operator">:</span> 密码
      username<span class="token operator">:</span> root
      driver<span class="token operator">-</span><span class="token keyword">class</span><span class="token operator">-</span>name<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>cj<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span>Driver</span>
    #中文繁体数据库 tc_db
    tc_db<span class="token operator">:</span>
      jdbc<span class="token operator">-</span>url<span class="token operator">:</span> jdbc<span class="token operator">:</span>mysql<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">3306</span><span class="token operator">/</span>en_db<span class="token operator">?</span>useSLL<span class="token operator">=</span><span class="token boolean">false</span><span class="token operator">&amp;</span>createDatabaseIfNotExist<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>useSSL<span class="token operator">=</span><span class="token boolean">false</span><span class="token operator">&amp;</span>characterEncoding<span class="token operator">=</span><span class="token constant">UTF</span><span class="token operator">-</span><span class="token number">8</span><span class="token operator">&amp;</span>allowMultiQueries<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>serverTimezone<span class="token operator">=</span><span class="token constant">GMT</span><span class="token operator">%</span><span class="token number">2</span><span class="token constant">B8</span><span class="token operator">&amp;</span>allowPublicKeyRetrieval<span class="token operator">=</span><span class="token boolean">true</span>
      password<span class="token operator">:</span> 密码
      username<span class="token operator">:</span> root
      driver<span class="token operator">-</span><span class="token keyword">class</span><span class="token operator">-</span>name<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>cj<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span>Driver</span>

</code></pre> 
<p><strong>创建一个数据库配置类DataSourceConfig</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataSourceConfig</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">/**
     * &lt;p&gt; 中文简体数据源cn_db &lt;/p&gt;
     **/</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"cn-db"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"spring.datasource.cn-db"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">dataSourceCn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">DataSourceBuilder</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * &lt;p&gt; 中文繁体数据源tc-db &lt;/p&gt;
     **/</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"tc-db"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"spring.datasource.tc-db"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">dataSourceTc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">DataSourceBuilder</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * &lt;p&gt; 英文数据库en_db &lt;/p&gt;
     **/</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"en-db"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"spring.datasource.en-db"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">dataSourceEn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">DataSourceBuilder</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Primary</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"dynamicDataSource"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">dynamicDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">DynamicDataSource</span> dynamicDataSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DynamicDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置默认数据源</span>
        dynamicDataSource<span class="token punctuation">.</span><span class="token function">setDefaultTargetDataSource</span><span class="token punctuation">(</span><span class="token function">dataSourceCn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 配置多数据源</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> dbMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dbMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"cn-db"</span><span class="token punctuation">,</span> <span class="token function">dataSourceCn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dbMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"tc-db"</span><span class="token punctuation">,</span> <span class="token function">dataSourceTc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dbMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"en-db"</span><span class="token punctuation">,</span> <span class="token function">dataSourceEn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dynamicDataSource<span class="token punctuation">.</span><span class="token function">setTargetDataSources</span><span class="token punctuation">(</span>dbMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> dynamicDataSource<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * &lt;p&gt; 重新配置事务管理器 &lt;/p&gt;
     **/</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">PlatformTransactionManager</span> <span class="token function">transactionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DataSourceTransactionManager</span><span class="token punctuation">(</span><span class="token function">dynamicDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>创建一个DynamicDataSource类并继承AbstractRoutingDataSource类</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DynamicDataSource</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractRoutingDataSource</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">determineCurrentLookupKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">DataSourceUtil</span><span class="token punctuation">.</span><span class="token function">getDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>关键点在于<strong>determineCurrentLookupKey</strong>方法，该方法返回需要使用的DataSource的key值，然后我们根据这个Key从resolvedDataSources这个map里面取出对应的DataSource，如果找不到就使用默认的数据源。<br></p> 
</blockquote> 
<p><strong>创建一个DataSourceUtil类，使用ThreadLocal存储请求需要使用的数据源</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataSourceUtil</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> threadLocal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setDb</span><span class="token punctuation">(</span><span class="token class-name">String</span> db<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        threadLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> threadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">cleanDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        threadLocal<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>至此动态数据源切换的功能就实现了</p> 
</blockquote> 
<p></p> 
<p><strong>拦截器统一切换数据源</strong></p> 
<p>假设我们的语言前缀是前端从Header携带到后端的，名称为language，对于需要指定语言环境的查询我们有两种实现方案<br><br> <strong>方式一</strong>：在每个查询controller方法中都通过HttpServletRequest获取到请求头中的language,指定对应的数据源<br></p> 
<blockquote> 
 <p><strong>优点</strong>：实现简单<br><br> <strong>缺点</strong>：代码冗余、侵入性比较高且维护困难，开发人员不仅要关注业务本身，还得关注语言切换问题</p> 
</blockquote> 
<p><strong>方式二</strong>：拦截器拦截所有请求统一指定数据源</p> 
<blockquote> 
 <p><strong>优点</strong>：不侵入业务代码、统一处理、方便维护、可扩展性强、开发人员关注业务本身即可<br><br> <strong>缺点</strong>：实现相对要复杂一些</p> 
</blockquote> 
<p><strong>创建RequestInterceptor类作为拦截器拦截请求并根据language切换数据源</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RequestInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 获取请求头中的language</span>
        <span class="token class-name">String</span> language <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"language"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 拼接成数据源名称</span>
        <span class="token class-name">String</span> db <span class="token operator">=</span> language<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"-db"</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定本次请求需要的数据源</span>
        <span class="token class-name">DataSourceUtil</span><span class="token punctuation">.</span><span class="token function">setDb</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>创建InterceptorConfig类用于注册拦截器并配置拦截路径</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InterceptorConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RequestInterceptor</span> requestInterceptor<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span><span class="token class-name">InterceptorRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">InterceptorRegistration</span> interceptorRegistration <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span>requestInterceptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定拦截匹配模式</span>
        interceptorRegistration<span class="token punctuation">.</span><span class="token function">addPathPatterns</span><span class="token punctuation">(</span><span class="token string">"/**"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p></p> 
<h4><a id="_588"></a>代码测试</h4> 
<p><strong>我往三个库的文章类型信息表中都加入了一条数据用于测试</strong><br><img src="https://images2.imgbox.com/cb/27/WDbWivwC_o.png" alt="image.png"><br><img src="https://images2.imgbox.com/ca/4c/egmsnbGK_o.png" alt="image.png"><br><img src="https://images2.imgbox.com/fb/7f/2VFLl6og_o.png" alt="image.png"><br><strong>创建一个用于测试的ExampleController类,使用MyBatisPlus查询数据</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExampleController</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">ArticleTypeMapper</span> articleTypeMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/get-article-type-list"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ArticleType</span><span class="token punctuation">&gt;</span></span> <span class="token function">getArticleTypeList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> articleTypeMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>使用ApiFox进行测试</strong><br>当language等于CN时结果如下所示<br><img src="https://images2.imgbox.com/04/41/WSNgmaVP_o.png" alt="image.png"><br>当language等于EN时结果如下所示<br><img src="https://images2.imgbox.com/6b/cd/dVDcloTv_o.png" alt="image.png"><br>当language等于TC时结果如下所示<br><img src="https://images2.imgbox.com/e6/c1/lgNDAXQf_o.png" alt="image.png"><br></p> 
<h4><a id="_607"></a>总结一下</h4> 
<blockquote> 
 <p><strong>此方案的优点</strong>：扩展性很强、业务后期如果有新增的语言只需要加一个对应的库即可，且有利于不同语言数据的维护，从性能的角度来说这种方式将数据库的压力分散开来，使得单个数据库的负载降低，从而提升性能。<br><br> <strong>此方案的缺点</strong>：代价大、维护成本高、系统整体的稳定性会降低、高并发场景下动态切换数据源可能会成为性能瓶颈。<br><br> <strong>适用的场景</strong>：随着业务的发展有可能不断增加新语言的场景。</p> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3088b059424dbff16c86e5d2b4d153be/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">4 Cesium鼠标事件</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2a812817df6e397844f26237e7ddccaf/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">8月11日|CSA研讨会：国标要点解读《信息安全技术 个人信息处理中告知和同意实施指南》</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>