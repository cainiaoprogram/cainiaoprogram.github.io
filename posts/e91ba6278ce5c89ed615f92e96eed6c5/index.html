<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【go微服务】gRPC - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【go微服务】gRPC" />
<meta property="og:description" content="gRPC教程 RPC算是近些年比较火热的概念了，随着微服务架构的兴起，RPC的应用越来越广泛。本文介绍了RPC和gRPC的相关概念，并且通过详细的代码示例介绍了gRPC的基本使用。
gRPC是什么 gRPC是一种现代化开源的高性能RPC框架，能够运行于任意环境之中。最初由谷歌进行开发。它使用HTTP/2作为传输协议。
快速了解HTTP/2就戳HTTP/2相比HTTP/1.x有哪些重大改进？
在gRPC里，客户端可以像调用本地方法一样直接调用其他机器上的服务端应用程序的方法，帮助你更容易创建分布式应用程序和服务。与许多RPC系统一样，gRPC是基于定义一个服务，指定一个可以远程调用的带有参数和返回类型的的方法。在服务端程序中实现这个接口并且运行gRPC服务处理客户端调用。在客户端，有一个stub提供和服务端相同的方法。[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-6hAz9z0t-1668140783539)(https://www.liwenzhou.com/images/Go/grpc/grpc.svg)]
为什么要用gRPC 使用gRPC， 我们可以一次性的在一个.proto文件中定义服务并使用任何支持它的语言去实现客户端和服务端，反过来，它们可以应用在各种场景中，从Google的服务器到你自己的平板电脑—— gRPC帮你解决了不同语言及环境间通信的复杂性。使用protocol buffers还能获得其他好处，包括高效的序列化，简单的IDL以及容易进行接口更新。总之一句话，使用gRPC能让我们更容易编写跨语言的分布式代码。
IDL（Interface description language）是指接口描述语言，是用来描述软件组件接口的一种计算机语言，是跨平台开发的基础。IDL通过一种中立的方式来描述接口，使得在不同平台上运行的对象和用不同语言编写的程序可以相互通信交流；比如，一个组件用C&#43;&#43;写成，另一个组件用Go写成。
安装gRPC 安装gRPC 在你的项目目录下执行以下命令，获取 gRPC 作为项目依赖。
go get google.golang.org/grpc@latest 安装Protocol Buffers v3 安装用于生成gRPC服务代码的协议编译器，最简单的方法是从下面的链接：https://github.com/google/protobuf/releases下载适合你平台的预编译好的二进制文件（protoc-&lt;version&gt;-&lt;platform&gt;.zip）。
适用Windows 64位protoc-3.20.1-win64.zip适用于Mac Intel 64位protoc-3.20.1-osx-x86_64.zip适用于Mac ARM 64位protoc-3.20.1-osx-aarch_64.zip适用于Linux 64位protoc-3.20.1-linux-x86_64.zip 例如，我使用 Intel 芯片的 Mac 系统则下载 protoc-3.20.1-osx-x86_64.zip 文件，解压之后得到如下内容。
其中：
bin 目录下的 protoc 是可执行文件。include 目录下的是 google 定义的.proto文件，我们import &#34;google/protobuf/timestamp.proto&#34;就是从此处导入。 我们需要将下载得到的可执行文件protoc所在的 bin 目录加到我们电脑的环境变量中。
安装插件 因为本文我们是使用Go语言做开发，接下来执行下面的命令安装protoc的Go插件：
安装go语言插件：
go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.28 该插件会根据.proto文件生成一个后缀为.pb.go的文件，包含所有.proto文件中定义的类型及其序列化方法。
安装grpc插件：
go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@v1.2 该插件会生成一个后缀为_grpc.pb.go的文件，其中包含：
一种接口类型(或存根) ，供客户端调用的服务方法。服务器要实现的接口类型。 上述命令会默认将插件安装到$GOPATH/bin，为了protoc编译器能找到这些插件，请确保你的$GOPATH/bin在环境变量中。
protocol-buffers 官方Go教程" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/e91ba6278ce5c89ed615f92e96eed6c5/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-11T12:28:07+08:00" />
<meta property="article:modified_time" content="2022-11-11T12:28:07+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【go微服务】gRPC</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="gRPC_0"></a>gRPC教程</h2> 
<p>RPC算是近些年比较火热的概念了，随着微服务架构的兴起，RPC的应用越来越广泛。本文介绍了RPC和gRPC的相关概念，并且通过详细的代码示例介绍了gRPC的基本使用。</p> 
<h3><a id="gRPC_4"></a>gRPC是什么</h3> 
<p><code>gRPC</code>是一种现代化开源的高性能RPC框架，能够运行于任意环境之中。最初由谷歌进行开发。它使用HTTP/2作为传输协议。</p> 
<blockquote> 
 <p>快速了解HTTP/2就戳<a href="https://www.zhihu.com/question/34074946" rel="nofollow">HTTP/2相比HTTP/1.x有哪些重大改进？</a></p> 
</blockquote> 
<p>在gRPC里，客户端可以像调用本地方法一样直接调用其他机器上的服务端应用程序的方法，帮助你更容易创建分布式应用程序和服务。与许多RPC系统一样，gRPC是基于定义一个服务，指定一个可以远程调用的带有参数和返回类型的的方法。在服务端程序中实现这个接口并且运行gRPC服务处理客户端调用。在客户端，有一个stub提供和服务端相同的方法。[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-6hAz9z0t-1668140783539)(https://www.liwenzhou.com/images/Go/grpc/grpc.svg)]</p> 
<h3><a id="gRPC_12"></a>为什么要用gRPC</h3> 
<p>使用gRPC， 我们可以一次性的在一个<code>.proto</code>文件中定义服务并使用任何支持它的语言去实现客户端和服务端，反过来，它们可以应用在各种场景中，从Google的服务器到你自己的平板电脑—— gRPC帮你解决了不同语言及环境间通信的复杂性。使用<code>protocol buffers</code>还能获得其他好处，包括高效的序列化，简单的IDL以及容易进行接口更新。总之一句话，使用gRPC能让我们更容易编写跨语言的分布式代码。</p> 
<blockquote> 
 <p>IDL（Interface description language）是指接口描述语言，是用来描述软件组件接口的一种计算机语言，是跨平台开发的基础。IDL通过一种中立的方式来描述接口，使得在不同平台上运行的对象和用不同语言编写的程序可以相互通信交流；比如，一个组件用C++写成，另一个组件用Go写成。</p> 
</blockquote> 
<h3><a id="gRPC_18"></a>安装gRPC</h3> 
<h4><a id="gRPC_20"></a>安装gRPC</h4> 
<p>在你的项目目录下执行以下命令，获取 gRPC 作为项目依赖。</p> 
<pre><code class="prism language-bash">go get google.golang.org/grpc@latest
</code></pre> 
<h4><a id="Protocol_Buffers_v3_28"></a>安装Protocol Buffers v3</h4> 
<p>安装用于生成gRPC服务代码的协议编译器，最简单的方法是从下面的链接：https://github.com/google/protobuf/releases下载适合你平台的预编译好的二进制文件（<code>protoc-&lt;version&gt;-&lt;platform&gt;.zip</code>）。</p> 
<ul><li>适用Windows 64位<a href="https://github.com/protocolbuffers/protobuf/releases/download/v3.20.1/protoc-3.20.1-win64.zip">protoc-3.20.1-win64.zip</a></li><li>适用于Mac Intel 64位<a href="https://github.com/protocolbuffers/protobuf/releases/download/v3.20.1/protoc-3.20.1-osx-x86_64.zip">protoc-3.20.1-osx-x86_64.zip</a></li><li>适用于Mac ARM 64位<a href="https://github.com/protocolbuffers/protobuf/releases/download/v3.20.1/protoc-3.20.1-osx-aarch_64.zip">protoc-3.20.1-osx-aarch_64.zip</a></li><li>适用于Linux 64位<a href="https://github.com/protocolbuffers/protobuf/releases/download/v3.20.1/protoc-3.20.1-linux-x86_64.zip">protoc-3.20.1-linux-x86_64.zip</a></li></ul> 
<p>例如，我使用 Intel 芯片的 Mac 系统则下载 <code>protoc-3.20.1-osx-x86_64.zip</code> 文件，解压之后得到如下内容。</p> 
<p><img src="https://images2.imgbox.com/a7/37/eef2ciGb_o.png" alt="protoc"></p> 
<p>其中：</p> 
<ul><li>bin 目录下的 protoc 是可执行文件。</li><li>include 目录下的是 google 定义的<code>.proto</code>文件，我们<code>import "google/protobuf/timestamp.proto"</code>就是从此处导入。</li></ul> 
<p>我们需要将下载得到的可执行文件<code>protoc</code>所在的 bin 目录加到我们电脑的环境变量中。</p> 
<h4><a id="_48"></a>安装插件</h4> 
<p>因为本文我们是使用Go语言做开发，接下来执行下面的命令安装<code>protoc</code>的Go插件：</p> 
<p>安装go语言插件：</p> 
<pre><code class="prism language-bash">go <span class="token function">install</span> google.golang.org/protobuf/cmd/protoc-gen-go@v1.28
</code></pre> 
<p>该插件会根据<code>.proto</code>文件生成一个后缀为<code>.pb.go</code>的文件，包含所有<code>.proto</code>文件中定义的类型及其序列化方法。</p> 
<p>安装grpc插件：</p> 
<pre><code class="prism language-bash">go <span class="token function">install</span> google.golang.org/grpc/cmd/protoc-gen-go-grpc@v1.2
</code></pre> 
<p>该插件会生成一个后缀为<code>_grpc.pb.go</code>的文件，其中包含：</p> 
<ul><li>一种接口类型(或存根) ，供客户端调用的服务方法。</li><li>服务器要实现的接口类型。</li></ul> 
<p>上述命令会默认将插件安装到<code>$GOPATH/bin</code>，为了<code>protoc</code>编译器能找到这些插件，请确保你的<code>$GOPATH/bin</code>在环境变量中。</p> 
<p><a href="https://developers.google.com/protocol-buffers/docs/gotutorial" rel="nofollow">protocol-buffers 官方Go教程</a></p> 
<h4><a id="_75"></a>检查</h4> 
<p>依次执行以下命令检查一下是否开发环境都准备完毕。</p> 
<ol><li> <p>确认 protoc 安装完成。</p> <pre><code class="prism language-bash">❯ protoc <span class="token parameter variable">--version</span>
libprotoc <span class="token number">3.20</span>.1
</code></pre> </li><li> <p>确认 protoc-gen-go 安装完成。</p> <pre><code class="prism language-bash">❯ protoc-gen-go <span class="token parameter variable">--version</span>
protoc-gen-go v1.28.0
</code></pre> <p>如果这里提示<code>protoc-gen-go</code>不是可执行的程序，请确保你的 GOPATH 下的 bin 目录在你电脑的环境变量中。</p> </li><li> <p>确认 protoc-gen-go-grpc 安装完成。</p> <pre><code class="prism language-bash">❯ protoc-gen-go-grpc <span class="token parameter variable">--version</span>
protoc-gen-go-grpc <span class="token number">1.2</span>.0
</code></pre> <p>如果这里提示<code>protoc-gen-go-grpc</code>不是可执行的程序，请确保你的 GOPATH 下的 bin 目录在你电脑的环境变量中。</p> </li></ol> 
<h3><a id="gRPC_104"></a>gRPC的开发方式</h3> 
<p>把大象放进冰箱分几步？</p> 
<ol><li>把冰箱门打开。</li><li>把大象放进去。</li><li>把冰箱门带上。</li></ol> 
<p>gRPC开发同样分三步：</p> 
<h4><a id="proto_114"></a>编写<code>.proto</code>文件定义服务</h4> 
<p>像许多 RPC 系统一样，gRPC 基于定义服务的思想，指定可以通过参数和返回类型远程调用的方法。默认情况下，gRPC 使用 <a href="https://developers.google.com/protocol-buffers" rel="nofollow">protocol buffers</a>作为接口定义语言(IDL)来描述服务接口和有效负载消息的结构。可以根据需要使用其他的IDL代替。</p> 
<p>例如，下面使用 protocol buffers 定义了一个<code>HelloService</code>服务。</p> 
<pre><code class="prism language-protobuf">service HelloService {
  rpc SayHello (HelloRequest) returns (HelloResponse);
}

message HelloRequest {
  string greeting = 1;
}

message HelloResponse {
  string reply = 1;
}
</code></pre> 
<p>在gRPC中你可以定义四种类型的服务方法。</p> 
<ul><li>普通 rpc，客户端向服务器发送一个请求，然后得到一个响应，就像普通的函数调用一样。</li></ul> 
<pre><code class="prism language-protobuf">  rpc SayHello(HelloRequest) returns (HelloResponse);
</code></pre> 
<ul><li>服务器流式 rpc，其中客户端向服务器发送请求，并获得一个流来读取一系列消息。客户端从返回的流中读取，直到没有更多的消息。gRPC 保证在单个 RPC 调用中的消息是有序的。</li></ul> 
<pre><code class="prism language-protobuf">  rpc LotsOfReplies(HelloRequest) returns (stream HelloResponse);
</code></pre> 
<ul><li>客户端流式 rpc，其中客户端写入一系列消息并将其发送到服务器，同样使用提供的流。一旦客户端完成了消息的写入，它就等待服务器读取消息并返回响应。同样，gRPC 保证在单个 RPC 调用中对消息进行排序。</li></ul> 
<pre><code class="prism language-protobuf">  rpc LotsOfGreetings(stream HelloRequest) returns (HelloResponse);
</code></pre> 
<ul><li>双向流式 rpc，其中双方使用读写流发送一系列消息。这两个流独立运行，因此客户端和服务器可以按照自己喜欢的顺序读写: 例如，服务器可以等待接收所有客户端消息后再写响应，或者可以交替读取消息然后写入消息，或者其他读写组合。每个流中的消息是有序的。</li></ul> 
<h4><a id="_156"></a>生成指定语言的代码</h4> 
<p>在 <code>.proto</code> 文件中的定义好服务之后，gRPC 提供了生成客户端和服务器端代码的 protocol buffers 编译器插件。</p> 
<p>我们使用这些插件可以根据需要生成<code>Java</code>、<code>Go</code>、<code>C++</code>、<code>Python</code>等语言的代码。我们通常会在客户端调用这些 API，并在服务器端实现相应的 API。</p> 
<ul><li>在服务器端，服务器实现服务声明的方法，并运行一个 gRPC 服务器来处理客户端发来的调用请求。gRPC 底层会对传入的请求进行解码，执行被调用的服务方法，并对服务响应进行编码。</li><li>在客户端，客户端有一个称为存根（stub）的本地对象，它实现了与服务相同的方法。然后，客户端可以在本地对象上调用这些方法，将调用的参数包装在适当的 protocol buffers 消息类型中—— gRPC 在向服务器发送请求并返回服务器的 protocol buffers 响应之后进行处理。</li></ul> 
<h4><a id="_165"></a>编写业务逻辑代码</h4> 
<p>gRPC 帮我们解决了 RPC 中的服务调用、数据传输以及消息编解码，我们剩下的工作就是要编写业务逻辑代码。</p> 
<p>在服务端编写业务代码实现具体的服务方法，在客户端按需调用这些方法。</p> 
<h3><a id="gRPC_171"></a>gRPC入门示例</h3> 
<h4><a id="proto_173"></a>编写proto代码</h4> 
<p><code>Protocol Buffers</code>是一种与语言无关，平台无关的可扩展机制，用于序列化结构化数据。使用<code>Protocol Buffers</code>可以一次定义结构化的数据，然后可以使用特殊生成的源代码轻松地在各种数据流中使用各种语言编写和读取结构化数据。</p> 
<p>关于<code>Protocol Buffers</code>的教程可以查看<a href="https://www.liwenzhou.com/posts/Go/Protobuf3-language-guide-zh/" rel="nofollow">Protocol Buffers V3中文指南</a>，本文后续内容默认读者熟悉<code>Protocol Buffers</code>。</p> 
<pre><code class="prism language-protobuf">syntax = "proto3"; // 版本声明，使用Protocol Buffers v3版本

option go_package = "xx";  // 指定生成的Go代码在你项目中的导入路径

package pb; // 包名


// 定义服务
service Greeter {
    // SayHello 方法
    rpc SayHello (HelloRequest) returns (HelloResponse) {}
}

// 请求消息
message HelloRequest {
    string name = 1;
}

// 响应消息
message HelloResponse {
    string reply = 1;
}
</code></pre> 
<h4><a id="ServerGo_204"></a>编写Server端Go代码</h4> 
<p>我们新建一个<code>hello_server</code>项目，在项目根目录下执行<code>go mod init hello_server</code>。</p> 
<p>再新建一个<code>pb</code>文件夹，将上面的 proto 文件保存为<code>hello.proto</code>，将<code>go_package</code>按如下方式修改。</p> 
<pre><code class="prism language-protobuf">// ...

option go_package = "hello_server/pb";

// ...
</code></pre> 
<p>此时，项目的目录结构为：</p> 
<pre><code class="prism language-bash">hello_server
├── go.mod
├── go.sum
├── main.go
└── pb
    └── hello.proto
</code></pre> 
<p>在项目根目录下执行以下命令，根据<code>hello.proto</code>生成 go 源码文件。</p> 
<pre><code class="prism language-bash">protoc <span class="token parameter variable">--go_out</span><span class="token operator">=</span>. <span class="token parameter variable">--go_opt</span><span class="token operator">=</span>paths<span class="token operator">=</span>source_relative <span class="token punctuation">\</span>
--go-grpc_out<span class="token operator">=</span>. --go-grpc_opt<span class="token operator">=</span>paths<span class="token operator">=</span>source_relative <span class="token punctuation">\</span>
pb/hello.proto
</code></pre> 
<p><strong>注意</strong> 如果你的终端不支持<code>\</code>符（例如某些同学的Windows），那么你就复制粘贴下面不带<code>\</code>的命令执行。</p> 
<pre><code class="prism language-bash">protoc <span class="token parameter variable">--go_out</span><span class="token operator">=</span>. <span class="token parameter variable">--go_opt</span><span class="token operator">=</span>paths<span class="token operator">=</span>source_relative --go-grpc_out<span class="token operator">=</span>. --go-grpc_opt<span class="token operator">=</span>paths<span class="token operator">=</span>source_relative pb/hello.proto
</code></pre> 
<p>生成后的go源码文件会保存在pb文件夹下。</p> 
<pre><code class="prism language-bash">hello_server
├── go.mod
├── go.sum
├── main.go
└── pb
    ├── hello.pb.go
    ├── hello.proto
    └── hello_grpc.pb.go
</code></pre> 
<p>将下面的内容添加到<code>hello_server/main.go</code>中。</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"context"</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"hello_server/pb"</span>
	<span class="token string">"net"</span>

	<span class="token string">"google.golang.org/grpc"</span>
<span class="token punctuation">)</span>

<span class="token comment">// hello server</span>

<span class="token keyword">type</span> server <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	pb<span class="token punctuation">.</span>UnimplementedGreeterServer
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>server<span class="token punctuation">)</span> <span class="token function">SayHello</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> in <span class="token operator">*</span>pb<span class="token punctuation">.</span>HelloRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>pb<span class="token punctuation">.</span>HelloResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>HelloResponse<span class="token punctuation">{<!-- --></span>Reply<span class="token punctuation">:</span> <span class="token string">"Hello "</span> <span class="token operator">+</span> in<span class="token punctuation">.</span>Name<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 监听本地的8972端口</span>
	lis<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">"tcp"</span><span class="token punctuation">,</span> <span class="token string">":8972"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"failed to listen: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	s <span class="token operator">:=</span> grpc<span class="token punctuation">.</span><span class="token function">NewServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                  <span class="token comment">// 创建gRPC服务器</span>
	pb<span class="token punctuation">.</span><span class="token function">RegisterGreeterServer</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token operator">&amp;</span>server<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 在gRPC服务端注册服务</span>
	<span class="token comment">// 启动服务</span>
	err <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">Serve</span><span class="token punctuation">(</span>lis<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"failed to serve: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>编译并执行 <code>http_server</code>：</p> 
<pre><code class="prism language-bash">go build
./server
</code></pre> 
<h4><a id="ClientGo_305"></a>编写Client端Go代码</h4> 
<p>我们新建一个<code>hello_client</code>项目，在项目根目录下执行<code>go mod init hello_client</code>。</p> 
<p>再新建一个<code>pb</code>文件夹，将上面的 proto 文件保存为<code>hello.proto</code>，将<code>go_package</code>按如下方式修改。</p> 
<pre><code class="prism language-protobuf">// ...

option go_package = "hello_client/pb";

// ...
</code></pre> 
<p>在项目根目录下执行以下命令，根据<code>hello.proto</code>在<code>http_client</code>项目下生成 go 源码文件。</p> 
<pre><code class="prism language-bash">protoc <span class="token parameter variable">--go_out</span><span class="token operator">=</span>. <span class="token parameter variable">--go_opt</span><span class="token operator">=</span>paths<span class="token operator">=</span>source_relative <span class="token punctuation">\</span>
--go-grpc_out<span class="token operator">=</span>. --go-grpc_opt<span class="token operator">=</span>paths<span class="token operator">=</span>source_relative <span class="token punctuation">\</span>
pb/hello.proto
</code></pre> 
<p><strong>注意</strong> 如果你的终端不支持<code>\</code>符（例如某些同学的Windows），那么你就复制粘贴下面不带<code>\</code>的命令执行。</p> 
<pre><code class="prism language-bash">protoc <span class="token parameter variable">--go_out</span><span class="token operator">=</span>. <span class="token parameter variable">--go_opt</span><span class="token operator">=</span>paths<span class="token operator">=</span>source_relative --go-grpc_out<span class="token operator">=</span>. --go-grpc_opt<span class="token operator">=</span>paths<span class="token operator">=</span>source_relative pb/hello.proto
</code></pre> 
<p>此时，项目的目录结构为：</p> 
<pre><code class="prism language-bash">http_client
├── go.mod
├── go.sum
├── main.go
└── pb
    ├── hello.pb.go
    ├── hello.proto
    └── hello_grpc.pb.go
</code></pre> 
<p>在<code>http_client/main.go</code>文件中按下面的代码调用<code>http_server</code>提供的 <code>SayHello</code> RPC服务。</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"context"</span>
	<span class="token string">"flag"</span>
	<span class="token string">"log"</span>
	<span class="token string">"time"</span>

	<span class="token string">"hello_client/pb"</span>

	<span class="token string">"google.golang.org/grpc"</span>
	<span class="token string">"google.golang.org/grpc/credentials/insecure"</span>
<span class="token punctuation">)</span>

<span class="token comment">// hello_client</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
	defaultName <span class="token operator">=</span> <span class="token string">"world"</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	addr <span class="token operator">=</span> flag<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"addr"</span><span class="token punctuation">,</span> <span class="token string">"127.0.0.1:8972"</span><span class="token punctuation">,</span> <span class="token string">"the address to connect to"</span><span class="token punctuation">)</span>
	name <span class="token operator">=</span> flag<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> defaultName<span class="token punctuation">,</span> <span class="token string">"Name to greet"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 连接到server端，此处禁用安全传输</span>
	conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> grpc<span class="token punctuation">.</span><span class="token function">Dial</span><span class="token punctuation">(</span><span class="token operator">*</span>addr<span class="token punctuation">,</span> grpc<span class="token punctuation">.</span><span class="token function">WithTransportCredentials</span><span class="token punctuation">(</span>insecure<span class="token punctuation">.</span><span class="token function">NewCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"did not connect: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> conn<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	c <span class="token operator">:=</span> pb<span class="token punctuation">.</span><span class="token function">NewGreeterClient</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span>

	<span class="token comment">// 执行RPC调用并打印收到的响应数据</span>
	ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	r<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">SayHello</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>HelloRequest<span class="token punctuation">{<!-- --></span>Name<span class="token punctuation">:</span> <span class="token operator">*</span>name<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"could not greet: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Greeting: %s"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span><span class="token function">GetReply</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>保存后将<code>http_client</code>编译并执行：</p> 
<pre><code class="prism language-bash">go build
./hello_client <span class="token parameter variable">-name</span><span class="token operator">=</span>七米
</code></pre> 
<p>得到以下输出结果，说明RPC调用成功。</p> 
<pre><code class="prism language-bash"><span class="token number">2022</span>/05/15 00:31:52 Greeting: Hello 七米
</code></pre> 
<h4><a id="gRPC_408"></a>gRPC跨语言调用</h4> 
<p>接下来，我们演示一下如何使用gRPC实现跨语言的RPC调用。</p> 
<p>我们使用<code>Python</code>语言编写<code>Client</code>，然后向上面使用<code>go</code>语言编写的<code>server</code>发送RPC请求。</p> 
<p>python下安装 grpc：</p> 
<pre><code class="prism language-bash">python <span class="token parameter variable">-m</span> pip <span class="token function">install</span> grpcio
</code></pre> 
<p>安装gRPC tools：</p> 
<pre><code class="prism language-bash">python <span class="token parameter variable">-m</span> pip <span class="token function">install</span> grpcio-tools
</code></pre> 
<h4><a id="Python_426"></a>生成Python代码</h4> 
<p>新建一个<code>py_client</code>目录，将<code>hello.proto</code>文件保存到<code>py_client/pb/</code>目录下。 在<code>py_client</code>目录下执行以下命令，生成python源码文件。</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">cd</span> py_cleint
python3 <span class="token parameter variable">-m</span> grpc_tools.protoc <span class="token parameter variable">-Ipb</span> <span class="token parameter variable">--python_out</span><span class="token operator">=</span>. <span class="token parameter variable">--grpc_python_out</span><span class="token operator">=</span>. pb/hello.proto
</code></pre> 
<h4><a id="PythonRPC_435"></a>编写Python版RPC客户端</h4> 
<p>将下面的代码保存到<code>py_client/client.py</code>文件中。</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> __future__ <span class="token keyword">import</span> print_function

<span class="token keyword">import</span> logging

<span class="token keyword">import</span> grpc
<span class="token keyword">import</span> hello_pb2
<span class="token keyword">import</span> hello_pb2_grpc


<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># NOTE(gRPC Python Team): .close() is possible on a channel and should be</span>
    <span class="token comment"># used in circumstances in which the with statement does not fit the needs</span>
    <span class="token comment"># of the code.</span>
    <span class="token keyword">with</span> grpc<span class="token punctuation">.</span>insecure_channel<span class="token punctuation">(</span><span class="token string">'127.0.0.1:8972'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> channel<span class="token punctuation">:</span>
        stub <span class="token operator">=</span> hello_pb2_grpc<span class="token punctuation">.</span>GreeterStub<span class="token punctuation">(</span>channel<span class="token punctuation">)</span>
        resp <span class="token operator">=</span> stub<span class="token punctuation">.</span>SayHello<span class="token punctuation">(</span>hello_pb2<span class="token punctuation">.</span>HelloRequest<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'q1mi'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Greeter client received: "</span> <span class="token operator">+</span> resp<span class="token punctuation">.</span>reply<span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span><span class="token punctuation">)</span>
    run<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>此时项目的目录结构图如下：</p> 
<pre><code class="prism language-bash">py_client
├── client.py
├── hello_pb2.py
├── hello_pb2_grpc.py
└── pb
    └── hello.proto
</code></pre> 
<h4><a id="Python_RPC__475"></a>Python RPC 调用</h4> 
<p>执行<code>client.py</code>调用go语言的<code>SayHello</code>RPC服务。</p> 
<pre><code class="prism language-bash">❯ python3 client.py
Greeter client received: Hello q1mi
</code></pre> 
<p>这里我们就实现了，使用 Python 代码编写的client去调用Go语言版本的server了。</p> 
<p>点击右边的链接查看完整代码：<a href="https://github.com/Q1mi/gRPC_demo">gRPC_demo完整代码</a></p> 
<h3><a id="gRPC_488"></a>gRPC流式示例</h3> 
<p>在上面的示例中，客户端发起了一个RPC请求到服务端，服务端进行业务处理并返回响应给客户端，这是gRPC最基本的一种工作方式（Unary RPC）。除此之外，依托于HTTP2，gRPC还支持流式RPC（Streaming RPC）。</p> 
<h4><a id="RPC_492"></a>服务端流式RPC</h4> 
<p>客户端发出一个RPC请求，服务端与客户端之间建立一个单向的流，服务端可以向流中写入多个响应消息，最后主动关闭流；而客户端需要监听这个流，不断获取响应直到流关闭。应用场景举例：客户端向服务端发送一个股票代码，服务端就把该股票的实时数据源源不断的返回给客户端。</p> 
<p>我们在此编写一个使用多种语言打招呼的方法，客户端发来一个用户名，服务端分多次返回打招呼的信息。</p> 
<p>1.定义服务</p> 
<pre><code class="prism language-protobuf">// 服务端返回流式数据
rpc LotsOfReplies(HelloRequest) returns (stream HelloResponse);
</code></pre> 
<p>修改<code>.proto</code>文件后，需要重新使用 protocol buffers编译器生成客户端和服务端代码。</p> 
<p>2.服务端需要实现 <code>LotsOfReplies</code> 方法。</p> 
<pre><code class="prism language-go"><span class="token comment">// LotsOfReplies 返回使用多种语言打招呼</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>server<span class="token punctuation">)</span> <span class="token function">LotsOfReplies</span><span class="token punctuation">(</span>in <span class="token operator">*</span>pb<span class="token punctuation">.</span>HelloRequest<span class="token punctuation">,</span> stream pb<span class="token punctuation">.</span>Greeter_LotsOfRepliesServer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
	words <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span>
		<span class="token string">"你好"</span><span class="token punctuation">,</span>
		<span class="token string">"hello"</span><span class="token punctuation">,</span>
		<span class="token string">"こんにちは"</span><span class="token punctuation">,</span>
		<span class="token string">"안녕하세요"</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> word <span class="token operator">:=</span> <span class="token keyword">range</span> words <span class="token punctuation">{<!-- --></span>
		data <span class="token operator">:=</span> <span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>HelloResponse<span class="token punctuation">{<!-- --></span>
			Reply<span class="token punctuation">:</span> word <span class="token operator">+</span> in<span class="token punctuation">.</span><span class="token function">GetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 使用Send方法返回多个数据</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>3.客户端调用<code>LotsOfReplies</code> 并将收到的数据依次打印出来。</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">runLotsOfReplies</span><span class="token punctuation">(</span>c pb<span class="token punctuation">.</span>GreeterClient<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// server端流式RPC</span>
	ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	stream<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">LotsOfReplies</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>HelloRequest<span class="token punctuation">{<!-- --></span>Name<span class="token punctuation">:</span> <span class="token operator">*</span>name<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"c.LotsOfReplies failed, err: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 接收服务端返回的流式数据，当收到io.EOF或错误时退出</span>
		res<span class="token punctuation">,</span> err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">Recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">==</span> io<span class="token punctuation">.</span>EOF <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"c.LotsOfReplies failed, err: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"got reply: %q\n"</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span><span class="token function">GetReply</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>执行程序后会得到如下输出结果。</p> 
<pre><code class="prism language-bash"><span class="token number">2022</span>/05/21 <span class="token number">14</span>:36:20 got reply: <span class="token string">"你好七米"</span>
<span class="token number">2022</span>/05/21 <span class="token number">14</span>:36:20 got reply: <span class="token string">"hello七米"</span>
<span class="token number">2022</span>/05/21 <span class="token number">14</span>:36:20 got reply: <span class="token string">"こんにちは七米"</span>
<span class="token number">2022</span>/05/21 <span class="token number">14</span>:36:20 got reply: <span class="token string">"안녕하세요七米"</span>
</code></pre> 
<h4><a id="RPC_566"></a>客户端流式RPC</h4> 
<p>客户端传入多个请求对象，服务端返回一个响应结果。典型的应用场景举例：物联网终端向服务器上报数据、大数据流式计算等。</p> 
<p>在这个示例中，我们编写一个多次发送人名，服务端统一返回一个打招呼消息的程序。</p> 
<p>1.定义服务</p> 
<pre><code class="prism language-protobuf">// 客户端发送流式数据
rpc LotsOfGreetings(stream HelloRequest) returns (HelloResponse);
</code></pre> 
<p>修改<code>.proto</code>文件后，需要重新使用 protocol buffers编译器生成客户端和服务端代码。</p> 
<p>2.服务端实现<code>LotsOfGreetings</code>方法。</p> 
<pre><code class="prism language-go"><span class="token comment">// LotsOfGreetings 接收流式数据</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>server<span class="token punctuation">)</span> <span class="token function">LotsOfGreetings</span><span class="token punctuation">(</span>stream pb<span class="token punctuation">.</span>Greeter_LotsOfGreetingsServer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
	reply <span class="token operator">:=</span> <span class="token string">"你好："</span>
	<span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 接收客户端发来的流式数据</span>
		res<span class="token punctuation">,</span> err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">Recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">==</span> io<span class="token punctuation">.</span>EOF <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 最终统一回复</span>
			<span class="token keyword">return</span> stream<span class="token punctuation">.</span><span class="token function">SendAndClose</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>HelloResponse<span class="token punctuation">{<!-- --></span>
				Reply<span class="token punctuation">:</span> reply<span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">}</span>
		reply <span class="token operator">+=</span> res<span class="token punctuation">.</span><span class="token function">GetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>  
</code></pre> 
<p>3.客户端调用<code>LotsOfGreetings</code>方法，向服务端发送流式请求数据，接收返回值并打印。</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">runLotsOfGreeting</span><span class="token punctuation">(</span>c pb<span class="token punctuation">.</span>GreeterClient<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 客户端流式RPC</span>
	stream<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">LotsOfGreetings</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"c.LotsOfGreetings failed, err: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	names <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span><span class="token string">"七米"</span><span class="token punctuation">,</span> <span class="token string">"q1mi"</span><span class="token punctuation">,</span> <span class="token string">"沙河娜扎"</span><span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> name <span class="token operator">:=</span> <span class="token keyword">range</span> names <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 发送流式数据</span>
		err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>HelloRequest<span class="token punctuation">{<!-- --></span>Name<span class="token punctuation">:</span> name<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"c.LotsOfGreetings stream.Send(%v) failed, err: %v"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	res<span class="token punctuation">,</span> err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">CloseAndRecv</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"c.LotsOfGreetings failed: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"got reply: %v"</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span><span class="token function">GetReply</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>执行上述函数将得到如下数据结果。</p> 
<pre><code class="prism language-bash"><span class="token number">2022</span>/05/21 <span class="token number">14</span>:57:31 got reply: 你好：七米q1mi沙河娜扎
</code></pre> 
<h4><a id="RPC_637"></a>双向流式RPC</h4> 
<p>双向流式RPC即客户端和服务端均为流式的RPC，能发送多个请求对象也能接收到多个响应对象。典型应用示例：聊天应用等。</p> 
<p>我们这里还是编写一个客户端和服务端进行人机对话的双向流式RPC示例。</p> 
<p>1.定义服务</p> 
<pre><code class="prism language-protobuf">// 双向流式数据
rpc BidiHello(stream HelloRequest) returns (stream HelloResponse);
</code></pre> 
<p>修改<code>.proto</code>文件后，需要重新使用 protocol buffers编译器生成客户端和服务端代码。</p> 
<p>2.服务端实现<code>BidiHello</code>方法。</p> 
<pre><code class="prism language-go"><span class="token comment">// BidiHello 双向流式打招呼</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>server<span class="token punctuation">)</span> <span class="token function">BidiHello</span><span class="token punctuation">(</span>stream pb<span class="token punctuation">.</span>Greeter_BidiHelloServer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 接收流式请求</span>
		in<span class="token punctuation">,</span> err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">Recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">==</span> io<span class="token punctuation">.</span>EOF <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">}</span>

		reply <span class="token operator">:=</span> <span class="token function">magic</span><span class="token punctuation">(</span>in<span class="token punctuation">.</span><span class="token function">GetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 对收到的数据做些处理</span>

		<span class="token comment">// 返回流式响应</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>HelloResponse<span class="token punctuation">{<!-- --></span>Reply<span class="token punctuation">:</span> reply<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这里我们还定义了一个处理数据的<code>magic</code>函数，其内容如下。</p> 
<pre><code class="prism language-go"><span class="token comment">// magic 一段价值连城的“人工智能”代码</span>
<span class="token keyword">func</span> <span class="token function">magic</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
	s <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">ReplaceAll</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"吗"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
	s <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">ReplaceAll</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"吧"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
	s <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">ReplaceAll</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"你"</span><span class="token punctuation">,</span> <span class="token string">"我"</span><span class="token punctuation">)</span>
	s <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">ReplaceAll</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"？"</span><span class="token punctuation">,</span> <span class="token string">"!"</span><span class="token punctuation">)</span>
	s <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">ReplaceAll</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"?"</span><span class="token punctuation">,</span> <span class="token string">"!"</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> s
<span class="token punctuation">}</span>
</code></pre> 
<p>3.客户端调用<code>BidiHello</code>方法，一边从终端获取输入的请求数据发送至服务端，一边从服务端接收流式响应。</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">runBidiHello</span><span class="token punctuation">(</span>c pb<span class="token punctuation">.</span>GreeterClient<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Minute<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 双向流模式</span>
	stream<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">BidiHello</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"c.BidiHello failed, err: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	waitc <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 接收服务端返回的响应</span>
			in<span class="token punctuation">,</span> err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">Recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">==</span> io<span class="token punctuation">.</span>EOF <span class="token punctuation">{<!-- --></span>
				<span class="token comment">// read done.</span>
				<span class="token function">close</span><span class="token punctuation">(</span>waitc<span class="token punctuation">)</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
				log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"c.BidiHello stream.Recv() failed, err: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"AI：%s\n"</span><span class="token punctuation">,</span> in<span class="token punctuation">.</span><span class="token function">GetReply</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 从标准输入获取用户输入</span>
	reader <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdin<span class="token punctuation">)</span> <span class="token comment">// 从标准输入生成读对象</span>
	<span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
		cmd<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> reader<span class="token punctuation">.</span><span class="token function">ReadString</span><span class="token punctuation">(</span><span class="token char">'\n'</span><span class="token punctuation">)</span> <span class="token comment">// 读到换行</span>
		cmd <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">TrimSpace</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">ToUpper</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"QUIT"</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 将获取到的数据发送至服务端</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>HelloRequest<span class="token punctuation">{<!-- --></span>Name<span class="token punctuation">:</span> cmd<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"c.BidiHello stream.Send(%v) failed: %v"</span><span class="token punctuation">,</span> cmd<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	stream<span class="token punctuation">.</span><span class="token function">CloseSend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token operator">&lt;-</span>waitc
<span class="token punctuation">}</span>
</code></pre> 
<p>将服务端和客户端的代码都运行起来，就可以实现简单的对话程序了。</p> 
<pre><code class="prism language-bash">hello
AI：hello
你吃饭了吗?
AI：我吃饭了<span class="token operator">!</span>
你会写代码吗
AI：我会写代码
可以和你约会吗?
AI：可以和我约会<span class="token operator">!</span>
现在可以吗?
AI：现在可以<span class="token operator">!</span>
走吧?
AI：走<span class="token operator">!</span>
</code></pre> 
<h3><a id="metadata_756"></a>metadata</h3> 
<p>元数据（<a href="https://pkg.go.dev/google.golang.org/grpc/metadata" rel="nofollow">metadata</a>）是指在处理RPC请求和响应过程中需要但又不属于具体业务（例如身份验证详细信息）的信息，采用键值对列表的形式，其中键是<code>string</code>类型，值通常是<code>[]string</code>类型，但也可以是二进制数据。gRPC中的 metadata 类似于我们在 HTTP headers中的键值对，元数据可以包含认证token、请求标识和监控标签等。</p> 
<p>metadata中的键是大小写不敏感的，由字母、数字和特殊字符<code>-</code>、<code>_</code>、<code>.</code>组成并且不能以<code>grpc-</code>开头（gRPC保留自用），二进制值的键名必须以<code>-bin</code>结尾。</p> 
<p>元数据对 gRPC 本身是不可见的，我们通常是在应用程序代码或中间件中处理元数据，我们不需要在<code>.proto</code>文件中指定元数据。</p> 
<p>如何访问元数据取决于具体使用的编程语言。 在Go语言中我们是用<a href="https://pkg.go.dev/google.golang.org/grpc/metadata" rel="nofollow">google.golang.org/grpc/metadata</a>这个库来操作metadata。</p> 
<p>metadata 类型定义如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> MD <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
</code></pre> 
<p>元数据可以像普通map一样读取。注意，这个 map 的值类型是<code>[]string</code>，因此用户可以使用一个键附加多个值。</p> 
<h4><a id="metadata_774"></a>创建新的metadata</h4> 
<p>常用的创建MD的方法有以下两种。</p> 
<p>第一种方法是使用函数 <code>New</code> 基于<code>map[string]string</code> 创建元数据:</p> 
<pre><code class="prism language-go">md <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span><span class="token string">"key1"</span><span class="token punctuation">:</span> <span class="token string">"val1"</span><span class="token punctuation">,</span> <span class="token string">"key2"</span><span class="token punctuation">:</span> <span class="token string">"val2"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p>另一种方法是使用<code>Pairs</code>。具有相同键的值将合并到一个列表中:</p> 
<pre><code class="prism language-go">md <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">Pairs</span><span class="token punctuation">(</span>
    <span class="token string">"key1"</span><span class="token punctuation">,</span> <span class="token string">"val1"</span><span class="token punctuation">,</span>
    <span class="token string">"key1"</span><span class="token punctuation">,</span> <span class="token string">"val1-2"</span><span class="token punctuation">,</span> <span class="token comment">// "key1"的值将会是 []string{"val1", "val1-2"}</span>
    <span class="token string">"key2"</span><span class="token punctuation">,</span> <span class="token string">"val2"</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
</code></pre> 
<p>注意: 所有的键将自动转换为小写，因此“ kEy1”和“ Key1”将是相同的键，它们的值将合并到相同的列表中。这种情况适用于 <code>New</code> 和 <code>Pair</code>。</p> 
<h4><a id="_796"></a>元数据中存储二进制数据</h4> 
<p>在元数据中，键始终是字符串。但是值可以是字符串或二进制数据。要在元数据中存储二进制数据值，只需在密钥中添加“-bin”后缀。在创建元数据时，将对带有“-bin”后缀键的值进行编码:</p> 
<pre><code class="prism language-go">md <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">Pairs</span><span class="token punctuation">(</span>
    <span class="token string">"key"</span><span class="token punctuation">,</span> <span class="token string">"string value"</span><span class="token punctuation">,</span>
    <span class="token string">"key-bin"</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{<!-- --></span><span class="token number">96</span><span class="token punctuation">,</span> <span class="token number">102</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 二进制数据在发送前会进行(base64) 编码</span>
                                        <span class="token comment">// 收到后会进行解码</span>
<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="_808"></a>从请求上下文中获取元数据</h4> 
<p>可以使用 <code>FromIncomingContext</code> 可以从RPC请求的上下文中获取元数据:</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>server<span class="token punctuation">)</span> <span class="token function">SomeRPC</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> in <span class="token operator">*</span>pb<span class="token punctuation">.</span>SomeRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>pb<span class="token punctuation">.</span>SomeResponse<span class="token punctuation">,</span> err<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    md<span class="token punctuation">,</span> ok <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">FromIncomingContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
    <span class="token comment">// do something with metadata</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_819"></a>发送和接收元数据-客户端</h4> 
<h5><a id="metadata_821"></a>发送metadata</h5> 
<p>有两种方法可以将元数据发送到服务端。推荐的方法是使用 <code>AppendToOutgoingContext</code> 将 kv 对附加到context。无论context中是否已经有元数据都可以使用这个方法。如果先前没有元数据，则添加元数据; 如果context中已经存在元数据，则将 kv 对合并进去。</p> 
<pre><code class="prism language-go"><span class="token comment">// 创建带有metadata的context</span>
ctx <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">AppendToOutgoingContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"k1"</span><span class="token punctuation">,</span> <span class="token string">"v1"</span><span class="token punctuation">,</span> <span class="token string">"k1"</span><span class="token punctuation">,</span> <span class="token string">"v2"</span><span class="token punctuation">,</span> <span class="token string">"k2"</span><span class="token punctuation">,</span> <span class="token string">"v3"</span><span class="token punctuation">)</span>

<span class="token comment">// 添加一些 metadata 到 context (e.g. in an interceptor)</span>
ctx <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">AppendToOutgoingContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"k3"</span><span class="token punctuation">,</span> <span class="token string">"v4"</span><span class="token punctuation">)</span>

<span class="token comment">// 发起普通RPC请求</span>
response<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">SomeRPC</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> someRequest<span class="token punctuation">)</span>

<span class="token comment">// 或者发起流式RPC请求</span>
stream<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">SomeStreamingRPC</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
</code></pre> 
<p>或者，可以使用 <code>NewOutgoingContext</code> 将元数据附加到context。但是，这将替换context中的任何已有的元数据，因此必须注意保留现有元数据(如果需要的话)。这个方法比使用 <code>AppendToOutgoingContext</code> 要慢。这方面的一个例子如下:</p> 
<pre><code class="prism language-go"><span class="token comment">// 创建带有metadata的context</span>
md <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">Pairs</span><span class="token punctuation">(</span><span class="token string">"k1"</span><span class="token punctuation">,</span> <span class="token string">"v1"</span><span class="token punctuation">,</span> <span class="token string">"k1"</span><span class="token punctuation">,</span> <span class="token string">"v2"</span><span class="token punctuation">,</span> <span class="token string">"k2"</span><span class="token punctuation">,</span> <span class="token string">"v3"</span><span class="token punctuation">)</span>
ctx <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">NewOutgoingContext</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> md<span class="token punctuation">)</span>

<span class="token comment">// 添加一些metadata到context (e.g. in an interceptor)</span>
send<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">FromOutgoingContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
newMD <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">Pairs</span><span class="token punctuation">(</span><span class="token string">"k3"</span><span class="token punctuation">,</span> <span class="token string">"v3"</span><span class="token punctuation">)</span>
ctx <span class="token operator">=</span> metadata<span class="token punctuation">.</span><span class="token function">NewOutgoingContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> metadata<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>send<span class="token punctuation">,</span> newMD<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// 发起普通RPC请求</span>
response<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">SomeRPC</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> someRequest<span class="token punctuation">)</span>

<span class="token comment">// 或者发起流式RPC请求</span>
stream<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">SomeStreamingRPC</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
</code></pre> 
<h5><a id="metadata_858"></a>接收metadata</h5> 
<p>客户端可以接收的元数据包括header和trailer。</p> 
<blockquote> 
 <p>trailer可以用于服务器希望在处理请求后给客户端发送任何内容，例如在流式RPC中只有等所有结果都流到客户端后才能计算出负载信息，这时候就不能使用headers（header在数据之前，trailer在数据之后）。</p> 
</blockquote> 
<p>引申：<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Trailer" rel="nofollow">HTTP trailer</a></p> 
<h6><a id="_866"></a>普通调用</h6> 
<p>可以使用 <a href="https://godoc.org/google.golang.org/grpc#CallOption" rel="nofollow">CallOption</a> 中的 <a href="https://godoc.org/google.golang.org/grpc#Header" rel="nofollow">Header</a> 和 <a href="https://godoc.org/google.golang.org/grpc#Trailer" rel="nofollow">Trailer</a> 函数来获取普通RPC调用发送的header和trailer:</p> 
<pre><code class="prism language-go"><span class="token keyword">var</span> header<span class="token punctuation">,</span> trailer metadata<span class="token punctuation">.</span>MD <span class="token comment">// 声明存储header和trailer的变量</span>
r<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">SomeRPC</span><span class="token punctuation">(</span>
    ctx<span class="token punctuation">,</span>
    someRequest<span class="token punctuation">,</span>
    grpc<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>header<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment">// 将会接收header</span>
    grpc<span class="token punctuation">.</span><span class="token function">Trailer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>trailer<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// 将会接收trailer</span>
<span class="token punctuation">)</span>

<span class="token comment">// do something with header and trailer</span>
</code></pre> 
<h6><a id="_882"></a>流式调用</h6> 
<p>流式调用包括：</p> 
<ul><li>客户端流式</li><li>服务端流式</li><li>双向流式</li></ul> 
<p>使用接口 <a href="https://godoc.org/google.golang.org/grpc#ClientStream" rel="nofollow">ClientStream</a> 中的 <code>Header</code> 和 <code>Trailer</code> 函数，可以从返回的流中接收 Header 和 Trailer:</p> 
<pre><code class="prism language-go">stream<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">SomeStreamingRPC</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>

<span class="token comment">// 接收 header</span>
header<span class="token punctuation">,</span> err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 接收 trailer</span>
trailer <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">Trailer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="_902"></a>发送和接收元数据-服务器端</h4> 
<h5><a id="metadata_904"></a>接收metadata</h5> 
<p>要读取客户端发送的元数据，服务器需要从 RPC 上下文检索它。如果是普通RPC调用，则可以使用 RPC 处理程序的上下文。对于流调用，服务器需要从流中获取上下文。</p> 
<h6><a id="_908"></a>普通调用</h6> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>server<span class="token punctuation">)</span> <span class="token function">SomeRPC</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> in <span class="token operator">*</span>pb<span class="token punctuation">.</span>someRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>pb<span class="token punctuation">.</span>someResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    md<span class="token punctuation">,</span> ok <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">FromIncomingContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
    <span class="token comment">// do something with metadata</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="_917"></a>流式调用</h6> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>server<span class="token punctuation">)</span> <span class="token function">SomeStreamingRPC</span><span class="token punctuation">(</span>stream pb<span class="token punctuation">.</span>Service_SomeStreamingRPCServer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
    md<span class="token punctuation">,</span> ok <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">FromIncomingContext</span><span class="token punctuation">(</span>stream<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// get context from stream</span>
    <span class="token comment">// do something with metadata</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="metadata_926"></a>发送metadata</h5> 
<h6><a id="_928"></a>普通调用</h6> 
<p>在普通调用中，服务器可以调用 <a href="https://godoc.org/google.golang.org/grpc" rel="nofollow">grpc</a> 模块中的 <a href="https://godoc.org/google.golang.org/grpc#SendHeader" rel="nofollow">SendHeader</a> 和 <a href="https://godoc.org/google.golang.org/grpc#SetTrailer" rel="nofollow">SetTrailer</a> 函数向客户端发送header和trailer。这两个函数将context作为第一个参数。它应该是 RPC 处理程序的上下文或从中派生的上下文：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>server<span class="token punctuation">)</span> <span class="token function">SomeRPC</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> in <span class="token operator">*</span>pb<span class="token punctuation">.</span>someRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>pb<span class="token punctuation">.</span>someResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 创建和发送 header</span>
    header <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">Pairs</span><span class="token punctuation">(</span><span class="token string">"header-key"</span><span class="token punctuation">,</span> <span class="token string">"val"</span><span class="token punctuation">)</span>
    grpc<span class="token punctuation">.</span><span class="token function">SendHeader</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> header<span class="token punctuation">)</span>
    <span class="token comment">// 创建和发送 trailer</span>
    trailer <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">Pairs</span><span class="token punctuation">(</span><span class="token string">"trailer-key"</span><span class="token punctuation">,</span> <span class="token string">"val"</span><span class="token punctuation">)</span>
    grpc<span class="token punctuation">.</span><span class="token function">SetTrailer</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> trailer<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="_943"></a>流式调用</h6> 
<p>对于流式调用，可以使用接口 <a href="https://godoc.org/google.golang.org/grpc#ServerStream" rel="nofollow">ServerStream</a> 中的 <code>SendHeader</code> 和 <code>SetTrailer</code> 函数发送header和trailer:</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>server<span class="token punctuation">)</span> <span class="token function">SomeStreamingRPC</span><span class="token punctuation">(</span>stream pb<span class="token punctuation">.</span>Service_SomeStreamingRPCServer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 创建和发送 header</span>
    header <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">Pairs</span><span class="token punctuation">(</span><span class="token string">"header-key"</span><span class="token punctuation">,</span> <span class="token string">"val"</span><span class="token punctuation">)</span>
    stream<span class="token punctuation">.</span><span class="token function">SendHeader</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span>
    <span class="token comment">// 创建和发送 trailer</span>
    trailer <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">Pairs</span><span class="token punctuation">(</span><span class="token string">"trailer-key"</span><span class="token punctuation">,</span> <span class="token string">"val"</span><span class="token punctuation">)</span>
    stream<span class="token punctuation">.</span><span class="token function">SetTrailer</span><span class="token punctuation">(</span>trailer<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="RPCmetadata_958"></a>普通RPC调用metadata示例</h4> 
<h5><a id="clientmetadata_960"></a>client端的metadata操作</h5> 
<p>下面的代码片段演示了client端如何设置和获取metadata。</p> 
<pre><code class="prism language-go"><span class="token comment">// unaryCallWithMetadata 普通RPC调用客户端metadata操作</span>
<span class="token keyword">func</span> <span class="token function">unaryCallWithMetadata</span><span class="token punctuation">(</span>c pb<span class="token punctuation">.</span>GreeterClient<span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"--- UnarySayHello client---"</span><span class="token punctuation">)</span>
	<span class="token comment">// 创建metadata</span>
	md <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">Pairs</span><span class="token punctuation">(</span>
		<span class="token string">"token"</span><span class="token punctuation">,</span> <span class="token string">"app-test-q1mi"</span><span class="token punctuation">,</span>
		<span class="token string">"request_id"</span><span class="token punctuation">,</span> <span class="token string">"1234567"</span><span class="token punctuation">,</span>
	<span class="token punctuation">)</span>
	<span class="token comment">// 基于metadata创建context.</span>
	ctx <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">NewOutgoingContext</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> md<span class="token punctuation">)</span>
	<span class="token comment">// RPC调用</span>
	<span class="token keyword">var</span> header<span class="token punctuation">,</span> trailer metadata<span class="token punctuation">.</span>MD
	r<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">SayHello</span><span class="token punctuation">(</span>
		ctx<span class="token punctuation">,</span>
		<span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>HelloRequest<span class="token punctuation">{<!-- --></span>Name<span class="token punctuation">:</span> name<span class="token punctuation">}</span><span class="token punctuation">,</span>
		grpc<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>header<span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">// 接收服务端发来的header</span>
		grpc<span class="token punctuation">.</span><span class="token function">Trailer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>trailer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 接收服务端发来的trailer</span>
	<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"failed to call SayHello: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 从header中取location</span>
	<span class="token keyword">if</span> t<span class="token punctuation">,</span> ok <span class="token operator">:=</span> header<span class="token punctuation">[</span><span class="token string">"location"</span><span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"location from header:\n"</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> i<span class="token punctuation">,</span> e <span class="token operator">:=</span> <span class="token keyword">range</span> t <span class="token punctuation">{<!-- --></span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">" %d. %s\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> e<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"location expected but doesn't exist in header"</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
   <span class="token comment">// 获取响应结果</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"got response: %s\n"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Reply<span class="token punctuation">)</span>
	<span class="token comment">// 从trailer中取timestamp</span>
	<span class="token keyword">if</span> t<span class="token punctuation">,</span> ok <span class="token operator">:=</span> trailer<span class="token punctuation">[</span><span class="token string">"timestamp"</span><span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"timestamp from trailer:\n"</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> i<span class="token punctuation">,</span> e <span class="token operator">:=</span> <span class="token keyword">range</span> t <span class="token punctuation">{<!-- --></span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">" %d. %s\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> e<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"timestamp expected but doesn't exist in trailer"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="servermetadata_1011"></a>server端metadata操作</h5> 
<p>下面的代码片段演示了server端如何设置和获取metadata。</p> 
<pre><code class="prism language-go"><span class="token comment">// UnarySayHello 普通RPC调用服务端metadata操作</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>server<span class="token punctuation">)</span> <span class="token function">UnarySayHello</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> in <span class="token operator">*</span>pb<span class="token punctuation">.</span>HelloRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>pb<span class="token punctuation">.</span>HelloResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 通过defer中设置trailer.</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		trailer <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">Pairs</span><span class="token punctuation">(</span><span class="token string">"timestamp"</span><span class="token punctuation">,</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		grpc<span class="token punctuation">.</span><span class="token function">SetTrailer</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> trailer<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// 从客户端请求上下文中读取metadata.</span>
	md<span class="token punctuation">,</span> ok <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">FromIncomingContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>DataLoss<span class="token punctuation">,</span> <span class="token string">"UnarySayHello: failed to get metadata"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> t<span class="token punctuation">,</span> ok <span class="token operator">:=</span> md<span class="token punctuation">[</span><span class="token string">"token"</span><span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"token from metadata:\n"</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token operator">||</span> t<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">"app-test-q1mi"</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Unauthenticated<span class="token punctuation">,</span> <span class="token string">"认证失败"</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 创建和发送header.</span>
	header <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span><span class="token string">"location"</span><span class="token punctuation">:</span> <span class="token string">"BeiJing"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	grpc<span class="token punctuation">.</span><span class="token function">SendHeader</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> header<span class="token punctuation">)</span>

	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"request received: %v, say hello...\n"</span><span class="token punctuation">,</span> in<span class="token punctuation">)</span>

	<span class="token keyword">return</span> <span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>HelloResponse<span class="token punctuation">{<!-- --></span>Reply<span class="token punctuation">:</span> in<span class="token punctuation">.</span>Name<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="RPCmetadata_1046"></a>流式RPC调用metadata示例</h4> 
<p>这里以双向流式RPC为例演示客户端和服务端如何进行metadata操作。</p> 
<h5><a id="clientmetadata_1050"></a>client端的metadata操作</h5> 
<p>下面的代码片段演示了client端在服务端流式RPC模式下如何设置和获取metadata。</p> 
<pre><code class="prism language-go"><span class="token comment">// bidirectionalWithMetadata 流式RPC调用客户端metadata操作</span>
<span class="token keyword">func</span> <span class="token function">bidirectionalWithMetadata</span><span class="token punctuation">(</span>c pb<span class="token punctuation">.</span>GreeterClient<span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 创建metadata和context.</span>
	md <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">Pairs</span><span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">,</span> <span class="token string">"app-test-q1mi"</span><span class="token punctuation">)</span>
	ctx <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">NewOutgoingContext</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> md<span class="token punctuation">)</span>

	<span class="token comment">// 使用带有metadata的context执行RPC调用.</span>
	stream<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">BidiHello</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"failed to call BidiHello: %v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 当header到达时读取header.</span>
		header<span class="token punctuation">,</span> err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"failed to get header from stream: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 从返回响应的header中读取数据.</span>
		<span class="token keyword">if</span> l<span class="token punctuation">,</span> ok <span class="token operator">:=</span> header<span class="token punctuation">[</span><span class="token string">"location"</span><span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{<!-- --></span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"location from header:\n"</span><span class="token punctuation">)</span>
			<span class="token keyword">for</span> i<span class="token punctuation">,</span> e <span class="token operator">:=</span> <span class="token keyword">range</span> l <span class="token punctuation">{<!-- --></span>
				fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">" %d. %s\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> e<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"location expected but doesn't exist in header"</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 发送所有的请求数据到server.</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>HelloRequest<span class="token punctuation">{<!-- --></span>Name<span class="token punctuation">:</span> name<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
				log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"failed to send streaming: %v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		stream<span class="token punctuation">.</span><span class="token function">CloseSend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// 读取所有的响应.</span>
	<span class="token keyword">var</span> rpcStatus <span class="token builtin">error</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"got response:\n"</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
		r<span class="token punctuation">,</span> err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">Recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			rpcStatus <span class="token operator">=</span> err
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">" - %s\n"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Reply<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> rpcStatus <span class="token operator">!=</span> io<span class="token punctuation">.</span>EOF <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"failed to finish server streaming: %v"</span><span class="token punctuation">,</span> rpcStatus<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 当RPC结束时读取trailer</span>
	trailer <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">Trailer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 从返回响应的trailer中读取metadata.</span>
	<span class="token keyword">if</span> t<span class="token punctuation">,</span> ok <span class="token operator">:=</span> trailer<span class="token punctuation">[</span><span class="token string">"timestamp"</span><span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"timestamp from trailer:\n"</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> i<span class="token punctuation">,</span> e <span class="token operator">:=</span> <span class="token keyword">range</span> t <span class="token punctuation">{<!-- --></span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">" %d. %s\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> e<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"timestamp expected but doesn't exist in trailer"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="servermetadata_1123"></a>server端的metadata操作</h5> 
<p>下面的代码片段演示了server端在服务端流式RPC模式下设置和操作metadata。</p> 
<pre><code class="prism language-go"><span class="token comment">// BidirectionalStreamingSayHello 流式RPC调用客户端metadata操作</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>server<span class="token punctuation">)</span> <span class="token function">BidirectionalStreamingSayHello</span><span class="token punctuation">(</span>stream pb<span class="token punctuation">.</span>Greeter_BidiHelloServer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 在defer中创建trailer记录函数的返回时间.</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		trailer <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">Pairs</span><span class="token punctuation">(</span><span class="token string">"timestamp"</span><span class="token punctuation">,</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		stream<span class="token punctuation">.</span><span class="token function">SetTrailer</span><span class="token punctuation">(</span>trailer<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// 从client读取metadata.</span>
	md<span class="token punctuation">,</span> ok <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">FromIncomingContext</span><span class="token punctuation">(</span>stream<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>DataLoss<span class="token punctuation">,</span> <span class="token string">"BidirectionalStreamingSayHello: failed to get metadata"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> t<span class="token punctuation">,</span> ok <span class="token operator">:=</span> md<span class="token punctuation">[</span><span class="token string">"token"</span><span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"token from metadata:\n"</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> i<span class="token punctuation">,</span> e <span class="token operator">:=</span> <span class="token keyword">range</span> t <span class="token punctuation">{<!-- --></span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">" %d. %s\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> e<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 创建和发送header.</span>
	header <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span><span class="token string">"location"</span><span class="token punctuation">:</span> <span class="token string">"X2Q"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	stream<span class="token punctuation">.</span><span class="token function">SendHeader</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span>

	<span class="token comment">// 读取请求数据发送响应数据.</span>
	<span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
		in<span class="token punctuation">,</span> err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">Recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">==</span> io<span class="token punctuation">.</span>EOF <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">}</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"request received %v, sending reply\n"</span><span class="token punctuation">,</span> in<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>HelloResponse<span class="token punctuation">{<!-- --></span>Reply<span class="token punctuation">:</span> in<span class="token punctuation">.</span>Name<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_1170"></a>错误处理</h3> 
<h4><a id="gRPC_code_1172"></a>gRPC code</h4> 
<p>类似于HTTP定义了一套响应状态码，gRPC也定义有一些状态码。Go语言中此状态码由<a href="https://pkg.go.dev/google.golang.org/grpc/codes" rel="nofollow">codes</a>定义，本质上是一个uint32。</p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> Code <span class="token builtin">uint32</span>
</code></pre> 
<p>使用时需导入<code>google.golang.org/grpc/codes</code>包。</p> 
<pre><code class="prism language-go"><span class="token keyword">import</span> <span class="token string">"google.golang.org/grpc/codes"</span>
</code></pre> 
<p>目前已经定义的状态码有如下几种。</p> 
<table><thead><tr><th align="center">Code</th><th align="center">值</th><th align="center">含义</th></tr></thead><tbody><tr><td align="center">OK</td><td align="center">0</td><td align="center">请求成功</td></tr><tr><td align="center">Canceled</td><td align="center">1</td><td align="center">操作已取消</td></tr><tr><td align="center">Unknown</td><td align="center">2</td><td align="center">未知错误。如果从另一个地址空间接收到的状态值属 于在该地址空间中未知的错误空间，则可以返回此错误的示例。 没有返回足够的错误信息的API引发的错误也可能会转换为此错误</td></tr><tr><td align="center">InvalidArgument</td><td align="center">3</td><td align="center">表示客户端指定的参数无效。 请注意，这与 FailedPrecondition 不同。 它表示无论系统状态如何都有问题的参数（例如，格式错误的文件名）。</td></tr><tr><td align="center">DeadlineExceeded</td><td align="center">4</td><td align="center">表示操作在完成之前已过期。对于改变系统状态的操作，即使操作成功完成，也可能会返回此错误。 例如，来自服务器的成功响应可能已延迟足够长的时间以使截止日期到期。</td></tr><tr><td align="center">NotFound</td><td align="center">5</td><td align="center">表示未找到某些请求的实体（例如，文件或目录）。</td></tr><tr><td align="center">AlreadyExists</td><td align="center">6</td><td align="center">创建实体的尝试失败，因为实体已经存在。</td></tr><tr><td align="center">PermissionDenied</td><td align="center">7</td><td align="center">表示调用者没有权限执行指定的操作。 它不能用于拒绝由耗尽某些资源引起的（使用 ResourceExhausted ）。 如果无法识别调用者，也不能使用它（使用 Unauthenticated ）。</td></tr><tr><td align="center">ResourceExhausted</td><td align="center">8</td><td align="center">表示某些资源已耗尽，可能是每个用户的配额，或者整个文件系统空间不足</td></tr><tr><td align="center">FailedPrecondition</td><td align="center">9</td><td align="center">指示操作被拒绝，因为系统未处于操作执行所需的状态。 例如，要删除的目录可能是非空的，rmdir 操作应用于非目录等。</td></tr><tr><td align="center">Aborted</td><td align="center">10</td><td align="center">表示操作被中止，通常是由于并发问题，如排序器检查失败、事务中止等。</td></tr><tr><td align="center">OutOfRange</td><td align="center">11</td><td align="center">表示尝试超出有效范围的操作。</td></tr><tr><td align="center">Unimplemented</td><td align="center">12</td><td align="center">表示此服务中未实施或不支持/启用操作。</td></tr><tr><td align="center">Internal</td><td align="center">13</td><td align="center">意味着底层系统预期的一些不变量已被破坏。 如果你看到这个错误，则说明问题很严重。</td></tr><tr><td align="center">Unavailable</td><td align="center">14</td><td align="center">表示服务当前不可用。这很可能是暂时的情况，可以通过回退重试来纠正。 请注意，重试非幂等操作并不总是安全的。</td></tr><tr><td align="center">DataLoss</td><td align="center">15</td><td align="center">表示不可恢复的数据丢失或损坏</td></tr><tr><td align="center">Unauthenticated</td><td align="center">16</td><td align="center">表示请求没有用于操作的有效身份验证凭据</td></tr><tr><td align="center">_maxCode</td><td align="center">17</td><td align="center">-</td></tr></tbody></table> 
<h4><a id="gRPC_Status_1209"></a>gRPC Status</h4> 
<p>Go语言使用的gRPC Status 定义在<a href="https://pkg.go.dev/google.golang.org/grpc/status" rel="nofollow">google.golang.org/grpc/status</a>，使用时需导入。</p> 
<pre><code class="prism language-go"><span class="token keyword">import</span> <span class="token string">"google.golang.org/grpc/status"</span>
</code></pre> 
<p>RPC服务的方法应该返回 <code>nil</code> 或来自<code>status.Status</code>类型的错误。客户端可以直接访问错误。</p> 
<h5><a id="_1219"></a>创建错误</h5> 
<p>当遇到错误时，gRPC服务的方法函数应该创建一个 <code>status.Status</code>。通常我们会使用 <code>status.New</code>函数并传入适当的<code>status.Code</code>和错误描述来生成一个<code>status.Status</code>。调用<code>status.Err</code>方法便能将一个<code>status.Status</code>转为<code>error</code>类型。也存在一个简单的<code>status.Error</code>方法直接生成<code>error</code>。下面是两种方式的比较。</p> 
<pre><code class="prism language-go"><span class="token comment">// 创建status.Status</span>
st <span class="token operator">:=</span> status<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>NotFound<span class="token punctuation">,</span> <span class="token string">"some description"</span><span class="token punctuation">)</span>
err <span class="token operator">:=</span> st<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 转为error类型</span>

<span class="token comment">// vs.</span>

err <span class="token operator">:=</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>NotFound<span class="token punctuation">,</span> <span class="token string">"some description"</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="_1233"></a>为错误添加其他详细信息</h5> 
<p>在某些情况下，可能需要为服务器端的特定错误添加详细信息。<code>status.WithDetails</code>就是为此而存在的，它可以添加任意多个<code>proto.Message</code>，我们可以使用<code>google.golang.org/genproto/googleapis/rpc/errdetails</code>中的定义或自定义的错误详情。</p> 
<pre><code class="prism language-go">st <span class="token operator">:=</span> status<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>ResourceExhausted<span class="token punctuation">,</span> <span class="token string">"Request limit exceeded."</span><span class="token punctuation">)</span>
ds<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> st<span class="token punctuation">.</span><span class="token function">WithDetails</span><span class="token punctuation">(</span>
	<span class="token comment">// proto.Message</span>
<span class="token punctuation">)</span>
<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> ds<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>然后，客户端可以通过首先将普通<code>error</code>类型转换回<code>status.Status</code>，然后使用<code>status.Details</code>来读取这些详细信息。</p> 
<pre><code class="prism language-go">s <span class="token operator">:=</span> status<span class="token punctuation">.</span><span class="token function">Convert</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> d <span class="token operator">:=</span> <span class="token keyword">range</span> s<span class="token punctuation">.</span><span class="token function">Details</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_1254"></a>代码示例</h4> 
<p>我们现在要为<code>hello</code>服务设置访问限制，每个<code>name</code>只能调用一次<code>SayHello</code>方法，超过此限制就返回一个请求超过限制的错误。</p> 
<h5><a id="_1258"></a>服务端</h5> 
<p>使用map存储每个name的请求次数，超过1次则返回错误，并且记录错误详情。</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"context"</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"hello_server/pb"</span>
	<span class="token string">"net"</span>
	<span class="token string">"sync"</span>

	<span class="token string">"google.golang.org/genproto/googleapis/rpc/errdetails"</span>
	<span class="token string">"google.golang.org/grpc"</span>
	<span class="token string">"google.golang.org/grpc/codes"</span>
	<span class="token string">"google.golang.org/grpc/status"</span>
<span class="token punctuation">)</span>

<span class="token comment">// grpc server</span>

<span class="token keyword">type</span> server <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	pb<span class="token punctuation">.</span>UnimplementedGreeterServer
	mu    sync<span class="token punctuation">.</span>Mutex     <span class="token comment">// count的并发锁</span>
	count <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span> <span class="token comment">// 记录每个name的请求次数</span>
<span class="token punctuation">}</span>

<span class="token comment">// SayHello 是我们需要实现的方法</span>
<span class="token comment">// 这个方法是我们对外提供的服务</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>server<span class="token punctuation">)</span> <span class="token function">SayHello</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> in <span class="token operator">*</span>pb<span class="token punctuation">.</span>HelloRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>pb<span class="token punctuation">.</span>HelloResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	s<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> s<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	s<span class="token punctuation">.</span>count<span class="token punctuation">[</span>in<span class="token punctuation">.</span>Name<span class="token punctuation">]</span><span class="token operator">++</span> <span class="token comment">// 记录用户的请求次数</span>
	<span class="token comment">// 超过1次就返回错误</span>
	<span class="token keyword">if</span> s<span class="token punctuation">.</span>count<span class="token punctuation">[</span>in<span class="token punctuation">.</span>Name<span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token punctuation">{<!-- --></span>
		st <span class="token operator">:=</span> status<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>ResourceExhausted<span class="token punctuation">,</span> <span class="token string">"Request limit exceeded."</span><span class="token punctuation">)</span>
		ds<span class="token punctuation">,</span> err <span class="token operator">:=</span> st<span class="token punctuation">.</span><span class="token function">WithDetails</span><span class="token punctuation">(</span>
			<span class="token operator">&amp;</span>errdetails<span class="token punctuation">.</span>QuotaFailure<span class="token punctuation">{<!-- --></span>
				Violations<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>errdetails<span class="token punctuation">.</span>QuotaFailure_Violation<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>
					Subject<span class="token punctuation">:</span>     fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"name:%s"</span><span class="token punctuation">,</span> in<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">,</span>
					Description<span class="token punctuation">:</span> <span class="token string">"限制每个name调用一次"</span><span class="token punctuation">,</span>
				<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> st<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> ds<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 正常返回响应</span>
	reply <span class="token operator">:=</span> <span class="token string">"hello "</span> <span class="token operator">+</span> in<span class="token punctuation">.</span><span class="token function">GetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>HelloResponse<span class="token punctuation">{<!-- --></span>Reply<span class="token punctuation">:</span> reply<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 启动服务</span>
	l<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">"tcp"</span><span class="token punctuation">,</span> <span class="token string">":8972"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"failed to listen, err:%v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	s <span class="token operator">:=</span> grpc<span class="token punctuation">.</span><span class="token function">NewServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 创建grpc服务</span>
	<span class="token comment">// 注册服务，注意初始化count</span>
	pb<span class="token punctuation">.</span><span class="token function">RegisterGreeterServer</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token operator">&amp;</span>server<span class="token punctuation">{<!-- --></span>count<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token comment">// 启动服务</span>
	err <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">Serve</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"failed to serve,err:%v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_1332"></a>客户端</h5> 
<p>当服务端返回错误时，尝试从错误中获取detail信息。</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"context"</span>
	<span class="token string">"flag"</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"google.golang.org/grpc/status"</span>
	<span class="token string">"hello_client/pb"</span>
	<span class="token string">"log"</span>
	<span class="token string">"time"</span>

	<span class="token string">"google.golang.org/genproto/googleapis/rpc/errdetails"</span>
	<span class="token string">"google.golang.org/grpc"</span>
	<span class="token string">"google.golang.org/grpc/credentials/insecure"</span>
<span class="token punctuation">)</span>

<span class="token comment">// grpc 客户端</span>
<span class="token comment">// 调用server端的 SayHello 方法</span>

<span class="token keyword">var</span> name <span class="token operator">=</span> flag<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"七米"</span><span class="token punctuation">,</span> <span class="token string">"通过-name告诉server你是谁"</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 解析命令行参数</span>

	<span class="token comment">// 连接server</span>
	conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> grpc<span class="token punctuation">.</span><span class="token function">Dial</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1:8972"</span><span class="token punctuation">,</span> grpc<span class="token punctuation">.</span><span class="token function">WithTransportCredentials</span><span class="token punctuation">(</span>insecure<span class="token punctuation">.</span><span class="token function">NewCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"grpc.Dial failed,err:%v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> conn<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 创建客户端</span>
	c <span class="token operator">:=</span> pb<span class="token punctuation">.</span><span class="token function">NewGreeterClient</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span> <span class="token comment">// 使用生成的Go代码</span>
	<span class="token comment">// 调用RPC方法</span>
	ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">SayHello</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>HelloRequest<span class="token punctuation">{<!-- --></span>Name<span class="token punctuation">:</span> <span class="token operator">*</span>name<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		s <span class="token operator">:=</span> status<span class="token punctuation">.</span><span class="token function">Convert</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>        <span class="token comment">// 将err转为status</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> d <span class="token operator">:=</span> <span class="token keyword">range</span> s<span class="token punctuation">.</span><span class="token function">Details</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 获取details</span>
			<span class="token keyword">switch</span> info <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">case</span> <span class="token operator">*</span>errdetails<span class="token punctuation">.</span>QuotaFailure<span class="token punctuation">:</span>
				fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Quota failure: %s\n"</span><span class="token punctuation">,</span> info<span class="token punctuation">)</span>
			<span class="token keyword">default</span><span class="token punctuation">:</span>
				fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Unexpected type: %s\n"</span><span class="token punctuation">,</span> info<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"c.SayHello failed, err:%v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 拿到了RPC响应</span>
	log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"resp:%v\n"</span><span class="token punctuation">,</span> resp<span class="token punctuation">.</span><span class="token function">GetReply</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_1392"></a>加密或认证</h3> 
<h4><a id="_1394"></a>无加密认证</h4> 
<p>在上面的示例中，我们都没有为我们的 gRPC 配置加密或认证，属于不安全的连接（insecure connection）。</p> 
<p>Client端：</p> 
<pre><code class="prism language-go">conn<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> grpc<span class="token punctuation">.</span><span class="token function">Dial</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1:8972"</span><span class="token punctuation">,</span> grpc<span class="token punctuation">.</span><span class="token function">WithTransportCredentials</span><span class="token punctuation">(</span>insecure<span class="token punctuation">.</span><span class="token function">NewCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
client <span class="token operator">:=</span> pb<span class="token punctuation">.</span><span class="token function">NewGreeterClient</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span>
</code></pre> 
<p>Server端：</p> 
<pre><code class="prism language-go">s <span class="token operator">:=</span> grpc<span class="token punctuation">.</span><span class="token function">NewServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
lis<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">"tcp"</span><span class="token punctuation">,</span> <span class="token string">"127.0.0.1:8972"</span><span class="token punctuation">)</span>
<span class="token comment">// error handling omitted</span>
s<span class="token punctuation">.</span><span class="token function">Serve</span><span class="token punctuation">(</span>lis<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="_SSLTLS_1414"></a>使用服务器身份验证 SSL/TLS</h4> 
<p>gRPC 内置支持 SSL/TLS，可以通过 SSL/TLS 证书建立安全连接，对传输的数据进行加密处理。</p> 
<p>这里我们演示如何使用自签名证书进行server端加密。</p> 
<h5><a id="_1420"></a>生成证书</h5> 
<h6><a id="_1422"></a>生成私钥</h6> 
<p>执行下面的命令生成私钥文件——<code>server.key</code>。</p> 
<pre><code class="prism language-bash">openssl ecparam <span class="token parameter variable">-genkey</span> <span class="token parameter variable">-name</span> secp384r1 <span class="token parameter variable">-out</span> server.key
</code></pre> 
<p>这里生成的是ECC私钥，当然你也可以使用RSA。</p> 
<h6><a id="_1432"></a>生成自签名的证书</h6> 
<blockquote> 
 <p>Go1.15之后x509弃用Common Name改用SANs。</p> 
</blockquote> 
<p>当出现如下错误时，需要提供SANs信息。</p> 
<pre><code class="prism language-bash">transport: authentication handshake failed: x509: certificate relies on legacy Common Name field, use SANs or temporarily <span class="token builtin class-name">enable</span> Common Name matching with <span class="token assign-left variable">GODEBUG</span><span class="token operator">=</span>x509ignoreCN<span class="token operator">=</span><span class="token number">0</span>
</code></pre> 
<p>为了在证书中添加SANs信息，我们将下面自定义配置保存到<code>server.cnf</code>文件中。</p> 
<pre><code class="prism language-conf">[ req ]
default_bits       = 4096
default_md		= sha256
distinguished_name = req_distinguished_name
req_extensions     = req_ext

[ req_distinguished_name ]
countryName                 = Country Name (2 letter code)
countryName_default         = CN
stateOrProvinceName         = State or Province Name (full name)
stateOrProvinceName_default = BEIJING
localityName                = Locality Name (eg, city)
localityName_default        = BEIJING
organizationName            = Organization Name (eg, company)
organizationName_default    = DEV
commonName                  = Common Name (e.g. server FQDN or YOUR name)
commonName_max              = 64
commonName_default          = liwenzhou.com

[ req_ext ]
subjectAltName = @alt_names

[alt_names]
DNS.1   = localhost
DNS.2   = liwenzhou.com
IP      = 127.0.0.1
</code></pre> 
<p>执行下面的命令生成自签名证书——<code>server.crt</code>。</p> 
<pre><code class="prism language-bash">openssl req <span class="token parameter variable">-nodes</span> <span class="token parameter variable">-new</span> <span class="token parameter variable">-x509</span> <span class="token parameter variable">-sha256</span> <span class="token parameter variable">-days</span> <span class="token number">3650</span> <span class="token parameter variable">-config</span> server.cnf <span class="token parameter variable">-extensions</span> <span class="token string">'req_ext'</span> <span class="token parameter variable">-key</span> server.key <span class="token parameter variable">-out</span> server.crt
</code></pre> 
<h5><a id="_1479"></a>建立安全连接</h5> 
<p>Server端使用<code>credentials.NewServerTLSFromFile</code>函数分别加载证书<code>server.cert</code>和秘钥<code>server.key</code>。</p> 
<pre><code class="prism language-go">creds<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> credentials<span class="token punctuation">.</span><span class="token function">NewServerTLSFromFile</span><span class="token punctuation">(</span>certFile<span class="token punctuation">,</span> keyFile<span class="token punctuation">)</span>
s <span class="token operator">:=</span> grpc<span class="token punctuation">.</span><span class="token function">NewServer</span><span class="token punctuation">(</span>grpc<span class="token punctuation">.</span><span class="token function">Creds</span><span class="token punctuation">(</span>creds<span class="token punctuation">)</span><span class="token punctuation">)</span>
lis<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">"tcp"</span><span class="token punctuation">,</span> <span class="token string">"127.0.0.1:8972"</span><span class="token punctuation">)</span>
<span class="token comment">// error handling omitted</span>
s<span class="token punctuation">.</span><span class="token function">Serve</span><span class="token punctuation">(</span>lis<span class="token punctuation">)</span>
</code></pre> 
<p>而client端使用上一步生成的证书文件——<code>server.cert</code>建立安全连接。</p> 
<pre><code class="prism language-go">creds<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> credentials<span class="token punctuation">.</span><span class="token function">NewClientTLSFromFile</span><span class="token punctuation">(</span>certFile<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
conn<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> grpc<span class="token punctuation">.</span><span class="token function">Dial</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1:8972"</span><span class="token punctuation">,</span> grpc<span class="token punctuation">.</span><span class="token function">WithTransportCredentials</span><span class="token punctuation">(</span>creds<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// error handling omitted</span>
client <span class="token operator">:=</span> pb<span class="token punctuation">.</span><span class="token function">NewGreeterClient</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span>
<span class="token comment">// ...</span>
</code></pre> 
<p>除了这种自签名证书的方式外，生产环境对外通信时通常需要使用受信任的CA证书。</p> 
<h3><a id="_1503"></a>拦截器（中间件）</h3> 
<p>gRPC 为在每个 ClientConn/Server 基础上实现和安装拦截器提供了一些简单的 API。 拦截器拦截每个 RPC 调用的执行。用户可以使用拦截器进行日志记录、身份验证/授权、指标收集以及许多其他可以跨 RPC 共享的功能。</p> 
<p>在 gRPC 中，拦截器根据拦截的 RPC 调用类型可以分为两类。第一个是普通拦截器（一元拦截器），它拦截普通RPC 调用。另一个是流拦截器，它处理流式 RPC 调用。而客户端和服务端都有自己的普通拦截器和流拦截器类型。因此，在 gRPC 中总共有四种不同类型的拦截器。</p> 
<h4><a id="_1509"></a>客户端端拦截器</h4> 
<h5><a id="_1511"></a>普通拦截器/一元拦截器</h5> 
<p><a href="https://godoc.org/google.golang.org/grpc#UnaryClientInterceptor" rel="nofollow">UnaryClientInterceptor</a> 是客户端一元拦截器的类型，它的函数前面如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> method <span class="token builtin">string</span><span class="token punctuation">,</span> req<span class="token punctuation">,</span> reply <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> cc <span class="token operator">*</span>ClientConn<span class="token punctuation">,</span> invoker UnaryInvoker<span class="token punctuation">,</span> opts <span class="token operator">...</span>CallOption<span class="token punctuation">)</span> <span class="token builtin">error</span>
</code></pre> 
<p>一元拦截器的实现通常可以分为三个部分: 调用 RPC 方法之前（预处理）、调用 RPC 方法（RPC调用）和调用 RPC 方法之后（调用后）。</p> 
<ul><li>预处理：用户可以通过检查传入的参数(如 RPC 上下文、方法字符串、要发送的请求和 CallOptions 配置)来获得有关当前 RPC 调用的信息。</li><li>RPC调用：预处理完成后，可以通过执行<code>invoker</code>执行 RPC 调用。</li><li>调用后：一旦调用者返回应答和错误，用户就可以对 RPC 调用进行后处理。通常，它是关于处理返回的响应和错误的。 若要在 <code>ClientConn</code> 上安装一元拦截器，请使用<code>DialOptionWithUnaryInterceptor</code>的<code>DialOption</code>配置 Dial 。</li></ul> 
<h5><a id="_1525"></a>流拦截器</h5> 
<p><a href="https://godoc.org/google.golang.org/grpc#StreamClientInterceptor" rel="nofollow">StreamClientInterceptor</a>是客户端流拦截器的类型。它的函数签名是</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> desc <span class="token operator">*</span>StreamDesc<span class="token punctuation">,</span> cc <span class="token operator">*</span>ClientConn<span class="token punctuation">,</span> method <span class="token builtin">string</span><span class="token punctuation">,</span> streamer Streamer<span class="token punctuation">,</span> opts <span class="token operator">...</span>CallOption<span class="token punctuation">)</span> <span class="token punctuation">(</span>ClientStream<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
</code></pre> 
<p>流拦截器的实现通常包括预处理和流操作拦截。</p> 
<ul><li>预处理：类似于上面的一元拦截器。</li><li>流操作拦截：流拦截器并没有事后进行 RPC 方法调用和后处理，而是拦截了用户在流上的操作。首先，拦截器调用传入的<code>streamer</code>以获取 <code>ClientStream</code>，然后包装 <code>ClientStream</code> 并用拦截逻辑重载其方法。最后，拦截器将包装好的 <code>ClientStream</code> 返回给用户进行操作。</li></ul> 
<p>若要为 <code>ClientConn</code> 安装流拦截器，请使用<code>WithStreamInterceptor</code>的 DialOption 配置 Dial。</p> 
<h4><a id="server_1540"></a>server端拦截器</h4> 
<p>服务器端拦截器与客户端类似，但提供的信息略有不同。</p> 
<h5><a id="_1544"></a>普通拦截器/一元拦截器</h5> 
<p><a href="https://godoc.org/google.golang.org/grpc#UnaryServerInterceptor" rel="nofollow">UnaryServerInterceptor</a>是服务端的一元拦截器类型，它的函数签名是</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> info <span class="token operator">*</span>UnaryServerInfo<span class="token punctuation">,</span> handler UnaryHandler<span class="token punctuation">)</span> <span class="token punctuation">(</span>resp <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>
</code></pre> 
<p>服务端一元拦截器具体实现细节和客户端版本的类似。</p> 
<p>若要为服务端安装一元拦截器，请使用 <code>UnaryInterceptor</code> 的<code>ServerOption</code>配置 <code>NewServer</code>。</p> 
<h5><a id="_1556"></a>流拦截器</h5> 
<p><a href="https://godoc.org/google.golang.org/grpc#StreamServerInterceptor" rel="nofollow">StreamServerInterceptor</a>是服务端流式拦截器的类型，它的签名如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span><span class="token punctuation">(</span>srv <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> ss ServerStream<span class="token punctuation">,</span> info <span class="token operator">*</span>StreamServerInfo<span class="token punctuation">,</span> handler StreamHandler<span class="token punctuation">)</span> <span class="token builtin">error</span>
</code></pre> 
<p>实现细节类似于客户端流拦截器部分。</p> 
<p>若要为服务端安装流拦截器，请使用 <code>StreamInterceptor</code> 的<code>ServerOption</code>来配置 <code>NewServer</code>。</p> 
<h4><a id="_1568"></a>拦截器示例</h4> 
<p>下面将演示一个完整的拦截器示例，我们为一元RPC和流式RPC服务都添加上拦截器。</p> 
<p>我们首先定义一个名为<code>valid</code>的校验函数。</p> 
<pre><code class="prism language-go"><span class="token comment">// valid 校验认证信息.</span>
<span class="token keyword">func</span> <span class="token function">valid</span><span class="token punctuation">(</span>authorization <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>authorization<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token boolean">false</span>
	<span class="token punctuation">}</span>
	token <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">TrimPrefix</span><span class="token punctuation">(</span>authorization<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"Bearer "</span><span class="token punctuation">)</span>
	<span class="token comment">// 执行token认证的逻辑</span>
	<span class="token comment">// 这里是为了演示方便简单判断token是否与"some-secret-token"相等</span>
	<span class="token keyword">return</span> token <span class="token operator">==</span> <span class="token string">"some-secret-token"</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_1587"></a>客户端拦截器定义</h5> 
<h6><a id="_1589"></a>一元拦截器</h6> 
<pre><code class="prism language-go"><span class="token comment">// unaryInterceptor 客户端一元拦截器</span>
<span class="token keyword">func</span> <span class="token function">unaryInterceptor</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> method <span class="token builtin">string</span><span class="token punctuation">,</span> req<span class="token punctuation">,</span> reply <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> cc <span class="token operator">*</span>grpc<span class="token punctuation">.</span>ClientConn<span class="token punctuation">,</span> invoker grpc<span class="token punctuation">.</span>UnaryInvoker<span class="token punctuation">,</span> opts <span class="token operator">...</span>grpc<span class="token punctuation">.</span>CallOption<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">var</span> credsConfigured <span class="token builtin">bool</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> o <span class="token operator">:=</span> <span class="token keyword">range</span> opts <span class="token punctuation">{<!-- --></span>
		<span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> o<span class="token punctuation">.</span><span class="token punctuation">(</span>grpc<span class="token punctuation">.</span>PerRPCCredsCallOption<span class="token punctuation">)</span>
		<span class="token keyword">if</span> ok <span class="token punctuation">{<!-- --></span>
			credsConfigured <span class="token operator">=</span> <span class="token boolean">true</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>credsConfigured <span class="token punctuation">{<!-- --></span>
		opts <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> grpc<span class="token punctuation">.</span><span class="token function">PerRPCCredentials</span><span class="token punctuation">(</span>oauth<span class="token punctuation">.</span><span class="token function">NewOauthAccess</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>oauth2<span class="token punctuation">.</span>Token<span class="token punctuation">{<!-- --></span>
			AccessToken<span class="token punctuation">:</span> <span class="token string">"some-secret-token"</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	start <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	err <span class="token operator">:=</span> <span class="token function">invoker</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> method<span class="token punctuation">,</span> req<span class="token punctuation">,</span> reply<span class="token punctuation">,</span> cc<span class="token punctuation">,</span> opts<span class="token operator">...</span><span class="token punctuation">)</span>
	end <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"RPC: %s, start time: %s, end time: %s, err: %v\n"</span><span class="token punctuation">,</span> method<span class="token punctuation">,</span> start<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"Basic"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> end<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>RFC3339<span class="token punctuation">)</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token keyword">return</span> err
<span class="token punctuation">}</span>
</code></pre> 
<p>其中，<code>grpc.PerRPCCredentials()</code>函数指明每个 RPC 请求使用的凭据，它接收一个<code>credentials.PerRPCCredentials</code>接口类型的参数。<code>credentials.PerRPCCredentials</code>接口的定义如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> PerRPCCredentials <span class="token keyword">interface</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// GetRequestMetadata 获取当前请求的元数据,如果需要则会设置token。</span>
	<span class="token comment">// 传输层在每个请求上调用，并且数据会被填充到headers或其他context。</span>
	<span class="token function">GetRequestMetadata</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> uri <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
	<span class="token comment">// RequireTransportSecurity 指示该 Credentials 的传输是否需要需要 TLS 加密</span>
	<span class="token function">RequireTransportSecurity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>而示例代码中使用的<code>oauth.NewOauthAccess()</code>是内置oauth包提供的一个函数，用来返回包含给定token的<code>PerRPCCredentials</code>。</p> 
<pre><code class="prism language-go"><span class="token comment">// NewOauthAccess constructs the PerRPCCredentials using a given token.</span>
<span class="token keyword">func</span> <span class="token function">NewOauthAccess</span><span class="token punctuation">(</span>token <span class="token operator">*</span>oauth2<span class="token punctuation">.</span>Token<span class="token punctuation">)</span> credentials<span class="token punctuation">.</span>PerRPCCredentials <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> oauthAccess<span class="token punctuation">{<!-- --></span>token<span class="token punctuation">:</span> <span class="token operator">*</span>token<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>oa oauthAccess<span class="token punctuation">)</span> <span class="token function">GetRequestMetadata</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> uri <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	ri<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> credentials<span class="token punctuation">.</span><span class="token function">RequestInfoFromContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> credentials<span class="token punctuation">.</span><span class="token function">CheckSecurityLevel</span><span class="token punctuation">(</span>ri<span class="token punctuation">.</span>AuthInfo<span class="token punctuation">,</span> credentials<span class="token punctuation">.</span>PrivacyAndIntegrity<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"unable to transfer oauthAccess PerRPCCredentials: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span>
		<span class="token string">"authorization"</span><span class="token punctuation">:</span> oa<span class="token punctuation">.</span>token<span class="token punctuation">.</span><span class="token function">Type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> oa<span class="token punctuation">.</span>token<span class="token punctuation">.</span>AccessToken<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>oa oauthAccess<span class="token punctuation">)</span> <span class="token function">RequireTransportSecurity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="_1650"></a>流式拦截器</h6> 
<p>自定义一个<code>ClientStream</code>类型。</p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> wrappedStream <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	grpc<span class="token punctuation">.</span>ClientStream
<span class="token punctuation">}</span>
</code></pre> 
<p><code>wrappedStream</code>重写<code>grpc.ClientStream</code>接口的<code>RecvMsg</code>和<code>SendMsg</code>方法。</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>w <span class="token operator">*</span>wrappedStream<span class="token punctuation">)</span> <span class="token function">RecvMsg</span><span class="token punctuation">(</span>m <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
	<span class="token function">logger</span><span class="token punctuation">(</span><span class="token string">"Receive a message (Type: %T) at %v"</span><span class="token punctuation">,</span> m<span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>RFC3339<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> w<span class="token punctuation">.</span>ClientStream<span class="token punctuation">.</span><span class="token function">RecvMsg</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>w <span class="token operator">*</span>wrappedStream<span class="token punctuation">)</span> <span class="token function">SendMsg</span><span class="token punctuation">(</span>m <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
	<span class="token function">logger</span><span class="token punctuation">(</span><span class="token string">"Send a message (Type: %T) at %v"</span><span class="token punctuation">,</span> m<span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>RFC3339<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> w<span class="token punctuation">.</span>ClientStream<span class="token punctuation">.</span><span class="token function">SendMsg</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">newWrappedStream</span><span class="token punctuation">(</span>s grpc<span class="token punctuation">.</span>ClientStream<span class="token punctuation">)</span> grpc<span class="token punctuation">.</span>ClientStream <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>wrappedStream<span class="token punctuation">{<!-- --></span>s<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>这里的<code>wrappedStream</code>嵌入了<code>grpc.ClientStream</code>接口类型，然后又重新实现了一遍<code>grpc.ClientStream</code>接口的方法。</p> 
</blockquote> 
<p>下面就定义一个流式拦截器，最后返回上面定义的<code>wrappedStream</code>。</p> 
<pre><code class="prism language-go"><span class="token comment">// streamInterceptor 客户端流式拦截器</span>
<span class="token keyword">func</span> <span class="token function">streamInterceptor</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> desc <span class="token operator">*</span>grpc<span class="token punctuation">.</span>StreamDesc<span class="token punctuation">,</span> cc <span class="token operator">*</span>grpc<span class="token punctuation">.</span>ClientConn<span class="token punctuation">,</span> method <span class="token builtin">string</span><span class="token punctuation">,</span> streamer grpc<span class="token punctuation">.</span>Streamer<span class="token punctuation">,</span> opts <span class="token operator">...</span>grpc<span class="token punctuation">.</span>CallOption<span class="token punctuation">)</span> <span class="token punctuation">(</span>grpc<span class="token punctuation">.</span>ClientStream<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">var</span> credsConfigured <span class="token builtin">bool</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> o <span class="token operator">:=</span> <span class="token keyword">range</span> opts <span class="token punctuation">{<!-- --></span>
		<span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> o<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>grpc<span class="token punctuation">.</span>PerRPCCredsCallOption<span class="token punctuation">)</span>
		<span class="token keyword">if</span> ok <span class="token punctuation">{<!-- --></span>
			credsConfigured <span class="token operator">=</span> <span class="token boolean">true</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>credsConfigured <span class="token punctuation">{<!-- --></span>
		opts <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> grpc<span class="token punctuation">.</span><span class="token function">PerRPCCredentials</span><span class="token punctuation">(</span>oauth<span class="token punctuation">.</span><span class="token function">NewOauthAccess</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>oauth2<span class="token punctuation">.</span>Token<span class="token punctuation">{<!-- --></span>
			AccessToken<span class="token punctuation">:</span> <span class="token string">"some-secret-token"</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	s<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">streamer</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> desc<span class="token punctuation">,</span> cc<span class="token punctuation">,</span> method<span class="token punctuation">,</span> opts<span class="token operator">...</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token function">newWrappedStream</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_1706"></a>服务端拦截器定义</h5> 
<h6><a id="_1708"></a>一元拦截器</h6> 
<p>服务端定义一个一元拦截器，对从请求元数据中获取的<code>authorization</code>进行校验。</p> 
<pre><code class="prism language-go"><span class="token comment">// unaryInterceptor 服务端一元拦截器</span>
<span class="token keyword">func</span> <span class="token function">unaryInterceptor</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> info <span class="token operator">*</span>grpc<span class="token punctuation">.</span>UnaryServerInfo<span class="token punctuation">,</span> handler grpc<span class="token punctuation">.</span>UnaryHandler<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// authentication (token verification)</span>
	md<span class="token punctuation">,</span> ok <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">FromIncomingContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> <span class="token string">"missing metadata"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">valid</span><span class="token punctuation">(</span>md<span class="token punctuation">[</span><span class="token string">"authorization"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Unauthenticated<span class="token punctuation">,</span> <span class="token string">"invalid token"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	m<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">handler</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> req<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"RPC failed with error %v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> m<span class="token punctuation">,</span> err
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_1731"></a>流拦截器</h5> 
<p>同样为流RPC也定义一个从元数据中获取认证信息的流式拦截器。</p> 
<pre><code class="prism language-go"><span class="token comment">// streamInterceptor 服务端流拦截器</span>
<span class="token keyword">func</span> <span class="token function">streamInterceptor</span><span class="token punctuation">(</span>srv <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> ss grpc<span class="token punctuation">.</span>ServerStream<span class="token punctuation">,</span> info <span class="token operator">*</span>grpc<span class="token punctuation">.</span>StreamServerInfo<span class="token punctuation">,</span> handler grpc<span class="token punctuation">.</span>StreamHandler<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// authentication (token verification)</span>
	md<span class="token punctuation">,</span> ok <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">FromIncomingContext</span><span class="token punctuation">(</span>ss<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> <span class="token string">"missing metadata"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">valid</span><span class="token punctuation">(</span>md<span class="token punctuation">[</span><span class="token string">"authorization"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Unauthenticated<span class="token punctuation">,</span> <span class="token string">"invalid token"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	err <span class="token operator">:=</span> <span class="token function">handler</span><span class="token punctuation">(</span>srv<span class="token punctuation">,</span> <span class="token function">newWrappedStream</span><span class="token punctuation">(</span>ss<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"RPC failed with error %v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> err
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_1755"></a>注册拦截器</h5> 
<p>客户端注册拦截器</p> 
<pre><code class="prism language-go">conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> grpc<span class="token punctuation">.</span><span class="token function">Dial</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1:8972"</span><span class="token punctuation">,</span>
	grpc<span class="token punctuation">.</span><span class="token function">WithTransportCredentials</span><span class="token punctuation">(</span>creds<span class="token punctuation">)</span><span class="token punctuation">,</span>
	grpc<span class="token punctuation">.</span><span class="token function">WithUnaryInterceptor</span><span class="token punctuation">(</span>unaryInterceptor<span class="token punctuation">)</span><span class="token punctuation">,</span>
	grpc<span class="token punctuation">.</span><span class="token function">WithStreamInterceptor</span><span class="token punctuation">(</span>streamInterceptor<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
</code></pre> 
<p>服务端注册拦截器</p> 
<pre><code class="prism language-go">s <span class="token operator">:=</span> grpc<span class="token punctuation">.</span><span class="token function">NewServer</span><span class="token punctuation">(</span>
	grpc<span class="token punctuation">.</span><span class="token function">Creds</span><span class="token punctuation">(</span>creds<span class="token punctuation">)</span><span class="token punctuation">,</span>
	grpc<span class="token punctuation">.</span><span class="token function">UnaryInterceptor</span><span class="token punctuation">(</span>unaryInterceptor<span class="token punctuation">)</span><span class="token punctuation">,</span>
	grpc<span class="token punctuation">.</span><span class="token function">StreamInterceptor</span><span class="token punctuation">(</span>streamInterceptor<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="gogrpcmiddleware_1777"></a>go-grpc-middleware</h4> 
<p>社区中有很多开源的常用的grpc中间件——<a href="https://github.com/grpc-ecosystem/go-grpc-middleware">go-grpc-middleware</a>，大家可以根据需要选择使用。</p> 
<p><strong>qq qun：1007576722</strong></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/bafd056bc2b29a403684517fd591de9f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Centos非ROOT(普通用户)环境安装/启动/运行 MySQL</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9bc90e670636fa2d802679d0ec830b34/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Spring中的循环依赖问题</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>