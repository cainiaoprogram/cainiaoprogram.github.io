<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>AlarmManager的使用以及该注意的一些坑 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="AlarmManager的使用以及该注意的一些坑" />
<meta property="og:description" content="不积跬步，无以至千里
说起我为什么要写这篇文章？就是因为我入坑了，所以我写下这篇来提醒有可能也入坑的人（废了2天时间啊）！
先说下AlarmManager的使用吧（我这里使用的AlarmManager的repeating方法），再说说入坑的事。 首先我先把最终要用的方法贴到这里，再让你们看下接下来的其中方法中参数等的由来。
一、设置闹钟
alarmManager.setRepeating(AlarmManager.ELAPSED_REALTIME_WAKEUP, firstTime, AlarmManager.INTERVAL_DAY, uploadIntent); 1、先获取到AlarmManager对象
AlarmManager alarmManager = (AlarmManager) context.getSystemService( Context.ALARM_SERVICE); 2、获取到PendingIntent的意图对象，即方法中的最后一个参数（你打算用这个intent去干什么，开启服务还是发送广播，打开Activity等等） Intent intent2 = new Intent(context, LauncherService.class).setAction(Constants.PENDING_START_ALARM_ACTION&#43;&#34;&#34;); PendingIntent uploadIntent = PendingIntent.getService(context, 0, intent2, PendingIntent.FLAG_UPDATE_CURRENT); 3、获取使用repeating方法时，需要填入的第二个参数，即你第一次触发这个重复闹钟的时间，其中注意的是，因为我下面seRepeating方法第一个参数ELAPSED_REALTIME ，所以我在获取时间的时候是用systemTime = System.elapsedRealtime()其中这个包括了手机系统的睡眠时间，现对于比较准确。AlarmManager的方法时注意中一些参数的上下的一致性。否则会出现定时的错误！
long firstTime = SystemClock.elapsedRealtime();//boot from begin to now runnig time ,it includes sleep time long systemTime = System.currentTimeMillis(); Calendar calendar = Calendar.getInstance(); //calendar.setTimeInMillis(systemTime); //setting the TimeZone,or else will have the time mistakes(8 hours) // calendar.setTimeZone(TimeZone.getTimeZone(&#34;GMT&#43;8&#34;)); calendar." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/d58805bdb815a049afcf77bf805caa5d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2017-06-20T13:22:55+08:00" />
<meta property="article:modified_time" content="2017-06-20T13:22:55+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">AlarmManager的使用以及该注意的一些坑</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p><span style="color:#FF0000">不积跬步，无以至千里</span></p> 
<p>   说起我为什么要写这篇文章？就是因为我入坑了，所以我写下这篇来提醒有可能也入坑的人（废了2天时间啊）！</p> 
<p>   先说下AlarmManager的使用吧（我这里使用的AlarmManager的repeating方法），再说说入坑的事。 <br> </p> 
<p>   首先我先把最终要用的方法贴到这里，再让你们看下接下来的其中方法中参数等的由来。</p> 
<p>一、设置闹钟<br> </p> 
<p></p> 
<pre style="background-color:#2b2b2b; color:#a9b7c6; font-family:'宋体'; font-size:9.6pt">alarmManager.setRepeating(AlarmManager.<span style="color:#9876aa"><em>ELAPSED_REALTIME_WAKEUP</em></span><span style="color:#cc7832">, </span>firstTime<span style="color:#cc7832">, </span>AlarmManager.<span style="color:#9876aa"><em>INTERVAL_DAY</em></span><span style="color:#cc7832">, </span>uploadIntent)<span style="color:#cc7832">;</span></pre> 
<p></p> 
<p>1、先获取到AlarmManager对象<br> </p> 
<pre style="background-color:#2b2b2b; color:#a9b7c6; font-family:'宋体'; font-size:9.6pt">AlarmManager alarmManager = (AlarmManager) context.getSystemService(
        Context.<span style="color:#9876aa"><em>ALARM_SERVICE</em></span>)<span style="color:#cc7832">;</span></pre> 2、获取到PendingIntent的意图对象，即方法中的最后一个参数（你打算用这个intent去干什么，开启服务还是发送广播，打开Activity等等） 
<p></p> 
<p></p> 
<pre style="background-color:#2b2b2b; color:#a9b7c6; font-family:'宋体'; font-size:9.6pt">Intent intent2 = <span style="color:#cc7832">new </span>Intent(context<span style="color:#cc7832">, </span>LauncherService.<span style="color:#cc7832">class</span>).setAction(Constants.<span style="color:#9876aa"><em>PENDING_START_ALARM_ACTION</em></span>+<span style="color:#6a8759">""</span>)<span style="color:#cc7832">;
</span>PendingIntent uploadIntent = PendingIntent.<span style="font-style:italic">getService</span>(context<span style="color:#cc7832">, </span><span style="color:#6897bb">0</span><span style="color:#cc7832">, </span>intent2<span style="color:#cc7832">, </span>PendingIntent.<span style="color:#9876aa"><em>FLAG_UPDATE_CURRENT</em></span>)<span style="color:#cc7832">;</span></pre> 3、获取使用repeating方法时，需要填入的第二个参数，即你第一次触发这个重复闹钟的时间，其中注意的是，因为我下面seRepeating方法第一个参数ELAPSED_REALTIME 
<p></p> 
<p>，所以我在获取时间的时候是用systemTime = System.elapsedRealtime()其中这个包括了手机系统的睡眠时间，现对于比较准确。AlarmManager的方法时注意中一些参数的上下的一致性。否则会出现定时的错误！<br> </p> 
<p></p> 
<pre style="background-color:#2b2b2b; color:#a9b7c6; font-family:'宋体'; font-size:9.6pt"> <span style="color:#cc7832">long </span>firstTime = SystemClock.<span style="font-style:italic">elapsedRealtime</span>()<span style="color:#cc7832">;</span><span style="color:#808080">//boot from begin to now runnig time ,it includes sleep time
</span><span style="color:#808080">  </span><span style="color:#cc7832">long </span>systemTime = System.<span style="font-style:italic">currentTimeMillis</span>()<span style="color:#cc7832">;
</span><span style="color:#cc7832">  </span>Calendar calendar = Calendar.<span style="font-style:italic">getInstance</span>()<span style="color:#cc7832">;
</span><span style="color:#808080">  //calendar.setTimeInMillis(systemTime);
</span><span style="color:#808080">  //setting the TimeZone,or else will have the time mistakes(8 hours)
</span><span style="color:#808080">  // calendar.setTimeZone(TimeZone.getTimeZone("GMT+8"));
</span><span style="color:#808080">  </span>calendar.set(Calendar.<span style="color:#9876aa"><em>HOUR_OF_DAY</em></span><span style="color:#cc7832">, </span>Constants.<span style="color:#9876aa"><em>ALARM_HOUR</em></span>)<span style="color:#cc7832">;
</span><span style="color:#cc7832">  </span>calendar.set(Calendar.<span style="color:#9876aa"><em>MINUTE</em></span><span style="color:#cc7832">, </span>Constants.<span style="color:#9876aa"><em>ALARM_MINUTE</em></span>)<span style="color:#cc7832">;
</span><span style="color:#cc7832">  </span>calendar.set(Calendar.<span style="color:#9876aa"><em>SECOND</em></span><span style="color:#cc7832">, </span>Constants.<span style="color:#9876aa"><em>ALARM_SECOND</em></span>)<span style="color:#cc7832">;
</span><span style="color:#cc7832">  </span>calendar.set(Calendar.<span style="color:#9876aa"><em>MILLISECOND</em></span><span style="color:#cc7832">, </span>Constants.<span style="color:#9876aa"><em>ALARM_MILLISECOND</em></span>)<span style="color:#cc7832">;
</span><span style="color:#cc7832">  </span><span style="color:#808080">//obtain the timevalues
</span><span style="color:#808080">  </span><span style="color:#cc7832">long </span>alarmTime = calendar.getTimeInMillis()<span style="color:#cc7832">;
</span><span style="color:#cc7832">  if </span>(systemTime &gt; alarmTime) {
      calendar.add(Calendar.<span style="color:#9876aa"><em>DAY_OF_YEAR</em></span><span style="color:#cc7832">, </span><span style="color:#6897bb">1</span>)<span style="color:#cc7832">;</span><span style="color:#808080">//if set the time is smailer than the current time,it will add one day,tomorrow it will ring
</span><span style="color:#808080">      </span>alarmTime = calendar.getTimeInMillis()<span style="color:#cc7832">;
</span><span style="color:#cc7832">  </span>}
  <span style="color:#cc7832">long </span>time = alarmTime - systemTime<span style="color:#cc7832">;
</span><span style="color:#cc7832">  </span>firstTime += time<span style="color:#cc7832">;</span></pre> 
<p></p> 
<p>4、设置重复闹钟</p> 
<p></p> 
<pre style="background-color:#2b2b2b; color:#a9b7c6; font-family:'宋体'; font-size:9.6pt">alarmManager.setRepeating(AlarmManager.<span style="color:#9876aa"><em>ELAPSED_REALTIME_WAKEUP</em></span><span style="color:#cc7832">, </span>firstTime<span style="color:#cc7832">, </span>AlarmManager.<span style="color:#9876aa"><em>INTERVAL_DAY</em></span><span style="color:#cc7832">, </span>uploadIntent)<span style="color:#cc7832">;
</span></pre> 
<p>其中的第一个参数是设置你定时的通过哪种模式ELAPSED还是RTC，第二个是第一次触发闹钟的时间，第三个就是触发闹钟以后多长时间重复一次，第四个就是PendingIntent意图，你打算通过定时去做什么。其中第一个参数有的后边会添加WAKEUP，那个是在系统睡眠的时候也会触发这个闹钟的意思。</p> 
<p>第一个参数会如下几种情况的值：</p> 
<p><span style="color:rgb(51,51,51); font-family:Simsun; font-size:14px; text-indent:28px; background-color:rgb(249,249,249)"> AlarmManager.ELAPSED_REALTIME表示闹钟在手机睡眠状态下不可用，该状态下闹钟使用相对时间（相对于系统启动开始），状态值为3；</span><br style="color:rgb(51,51,51); font-family:Simsun; font-size:14px; text-indent:28px; background-color:rgb(249,249,249)"> <span style="color:rgb(51,51,51); font-family:Simsun; font-size:14px; text-indent:28px; background-color:rgb(249,249,249)"> AlarmManager.ELAPSED_REALTIME_WAKEUP表示闹钟在睡眠状态下会唤醒系统并执行提示功能，该状态下闹钟也使用相对时间，状态值为2；</span><br style="color:rgb(51,51,51); font-family:Simsun; font-size:14px; text-indent:28px; background-color:rgb(249,249,249)"> <span style="color:rgb(51,51,51); font-family:Simsun; font-size:14px; text-indent:28px; background-color:rgb(249,249,249)"> AlarmManager.RTC表示闹钟在睡眠状态下不可用，该状态下闹钟使用绝对时间，即当前系统时间，状态值为1；</span><br style="color:rgb(51,51,51); font-family:Simsun; font-size:14px; text-indent:28px; background-color:rgb(249,249,249)"> <span style="color:rgb(51,51,51); font-family:Simsun; font-size:14px; text-indent:28px; background-color:rgb(249,249,249)"> AlarmManager.RTC_WAKEUP表示闹钟在睡眠状态下会唤醒系统并执行提示功能，该状态下闹钟使用绝对时间，状态值为0；</span><br style="color:rgb(51,51,51); font-family:Simsun; font-size:14px; text-indent:28px; background-color:rgb(249,249,249)"> <span style="color:rgb(51,51,51); font-family:Simsun; font-size:14px; text-indent:28px; background-color:rgb(249,249,249)"> AlarmManager.POWER_OFF_WAKEUP表示闹钟在手机关机状态下也能正常进行提示功能，所以是5个状态中用的最多的状态之一，该状态下闹钟也是用绝对时间，状态值为4；不过本状态好像受SDK版本影响，某些版本并不支持；</span><br> </p> 
<p>二、取消闹钟</p> 
<p>相对于设置闹钟的就是取消闹钟</p> 
<p>1、也是先获取AlarmManager对象</p> 
<p></p> 
<pre style="background-color:#2b2b2b; color:#a9b7c6; font-family:'宋体'; font-size:9.6pt">alarmManager.setRepeating(AlarmManager.<span style="color:#9876aa"><em>ELAPSED_REALTIME_WAKEUP</em></span><span style="color:#cc7832">, </span>firstTime<span style="color:#cc7832">, </span>AlarmManager.<span style="color:#9876aa"><em>INTERVAL_DAY</em></span><span style="color:#cc7832">, </span>uploadIntent)<span style="color:#cc7832">;</span></pre> 2、获取PendingIntent对象，注意这里的PendingIntent要和你上边的设置闹钟的保持一致其中Service、BroadCast、Activity等，还有它设置的Action 
<p></p> 
<p></p> 
<pre style="background-color:#2b2b2b; color:#a9b7c6; font-family:'宋体'; font-size:9.6pt">Intent intent2 = <span style="color:#cc7832">new </span>Intent(context<span style="color:#cc7832">, </span>LauncherService.<span style="color:#cc7832">class</span>).setAction(Constants.<span style="color:#9876aa"><em>PENDING_START_ALARM_ACTION</em></span>+<span style="color:#6a8759">""</span>)<span style="color:#cc7832">;
</span>PendingIntent uploadIntent = PendingIntent.<span style="font-style:italic">getService</span>(context<span style="color:#cc7832">, </span><span style="color:#6897bb">0</span><span style="color:#cc7832">, </span>intent2<span style="color:#cc7832">, </span>PendingIntent.<span style="color:#9876aa"><em>FLAG_UPDATE_CURRENT</em></span>)<span style="color:#cc7832">;</span></pre> 3、取消方法 
<p></p> 
<p></p> 
<pre style="background-color:#2b2b2b; color:#a9b7c6; font-family:'宋体'; font-size:9.6pt">alarmManager.cancel(uploadIntent)<span style="color:#cc7832">;</span></pre> 
<p></p> 
<p>总结：</p> 
<p>其实我本次代码出问题就是在这一块造成的，其实这块获取这个时间这块我是在网上查的，结果就粘贴复制上去的，结果就出了大问题，加上我第一次使用AlarmManager来进行定时操作，结果出现了定时不准的状况，也查看了网上好多种说法，有的说是版本问题会造成定时不准等等，都没有成功。<br> </p> 
<p>后来在排查代码时候，我看到了其中注释的代码setTimeZone方法，你这样手动的添加了你现在显示时间的时区了（设置在北京），结果就导致了你这次获取时间的不管你手机上设置的是哪个时区，你获取的第一次闹钟的时间，就是北京时间规定的那个时间，这样就导致了我的定时每当设置上时间，就会直接出发那个闹钟，因为你的时区并不是北京时间，所以这块使我测试出现了大问题，后来找到了，豁然开朗，十分悔恨自己当时直接粘贴复制大意马虎，所以你们当遇见问题时候也要分析好问题出现的关键，不要分析问题出现方向性的失误。</p> 
<p>其中还有一点我想提醒的就是，这个方法在Android4.4中当你关机的之前设置Alarm，你重启后不会生效，所以你重启后要重新定时！<br> </p> 
<p>另外一点：你们你知道为什么要用AlarmManager实现定时吗？因为平常的Handler.postDelay、Timer等方法当屏幕关闭手机睡眠后不会生效，当长时间定时、有后台等操作来使用AlarmManager。<br> </p> 
<p><br> </p> 
<p><br> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8daf9947a228e80aebae5493544794f0/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">mysql中去重 distinct用法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c13b13511cba22143dd2c75b069840a4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">&#34;Your device isn&#39;t compatible with this version&#34; 部分设备无法从google play下载</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>