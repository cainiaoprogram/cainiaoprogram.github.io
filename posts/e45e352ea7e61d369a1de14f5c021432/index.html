<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>prometheus自定义监控项（no） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="prometheus自定义监控项（no）" />
<meta property="og:description" content="Prometheus Operator默认的监控指标并不能完全满足实际的监控需求，这时候就需要我们自己根据业务添加自定义监控。添加一个自定义监控的步骤如下：
1、创建一个ServiceMonitor对象，用于Prometheus添加监控项
2、为ServiceMonitor对象关联metrics数据接口的Service对象
3、确保Services对象可以正确获取到metrics数据
演示如何添加etcd集群的监控
1.etcd证书
对于etcd集群一般情况下，为了安全都是开启https认证方式，所以要想让prometheus访问etcd集群的监控数据，就需要提供相应的证书校验
cd -
就是通过静态pod的方式在集群当中运行的一个etcd的pod.
查看etcd pod的运行方式. 输出到yaml文件中
方便使用ip直接访问到2379端口，因为只要有节点的ip或者修改成0.0.0.0:2379都可以。不然通过ip:2379访问不到metrics数据
存活探针
使用证书就可以访问到etcd集群
通过hostpath形式挂载进去的
现在想要在etcd集群中访问到该证书
通过secert对象吧证书添加到对象当中
通过文件创建。就是genetric
kubectl -n monitoring create secret generic etcd-certs --from-file=/etc/kubernetes/pki/etcd/healthcheck-client.key --from-file=/etc/kubernetes/pki/etcd/healthcheck-client.crt --from-file=/etc/kubernetes/pki/etcd/ca.crt
secret/etcd-certs created
etcd-certs的secert创建成功
创建的etcd证书的secert的一个对象。在对象里面的值都是做了一个编码
然后吧证书注入到prometheus的pod中去，因为想要在prometheus的一个pod中能访问到这个证书，通过更改文件
为什么要把etcd-certs添加到monitoring命名空间下？
因为这样在prometheus下面就能识别到了
这个k8s是部署在集群当中的prometheus的一个资源对象
可以看到刚才添加的证书
可以看到这两个pod已经更新成功
可以到该pod中查看etcd证书是否已经注入进来
看到该pod中已经注入证书了
也就是pod中已经有了访问etcd的证书
开始创建service monitoring文件
监控名字name:etcd-k8s
标签： lables :
jobLabel: 就是取对应的lable的标签的名称去作为监控项的名字
就是jobLable的值是k8s-app,而k8s-app对应的值就是etcd-k8s
endpoints指定抓取etcd集群的endpoints
interval 30秒抓去一次
etcd通过https。所以添加证书
insecureSkipVerify: true. 不加校验证书可能会失败
加seletor匹配service
想要去匹配一个service具有k8s-app=etcd的service。在xx命名空间下
创建
创建service
spec:
因为吧etcd看作是集群外部的一个应用，所以不能通过selector去匹配集群中的pod,而是手动创建一个endpoints去指定etcd集群的访问地址，要手动创建endpoints就需要clusIP设置为none,
ports: 就是service的端口
name: port就是刚才在service monitoring中定义了的 接着endpoints需要自己手动创建一个" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/e45e352ea7e61d369a1de14f5c021432/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-08-01T15:19:11+08:00" />
<meta property="article:modified_time" content="2021-08-01T15:19:11+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">prometheus自定义监控项（no）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>Prometheus Operator默认的监控指标并不能完全满足实际的监控需求，这时候就需要我们自己根据业务添加自定义监控。添加一个自定义监控的步骤如下：</p> 
<blockquote> 
 <p>1、创建一个ServiceMonitor对象，用于Prometheus添加监控项<br> 2、为ServiceMonitor对象关联metrics数据接口的Service对象<br> 3、确保Services对象可以正确获取到metrics数据</p> 
</blockquote> 
<p>演示如何添加etcd集群的监控<br> 1.etcd证书</p> 
<p>对于etcd集群一般情况下，为了安全都是开启https认证方式，所以要想让prometheus访问etcd集群的监控数据，就需要提供相应的证书校验</p> 
<p>cd -</p> 
<p><img src="https://images2.imgbox.com/92/45/oEkFNhln_o.png" alt="在这里插入图片描述"><br> 就是通过静态pod的方式在集群当中运行的一个etcd的pod.</p> 
<p>查看etcd pod的运行方式. 输出到yaml文件中<br> <img src="https://images2.imgbox.com/ed/28/J48ouRvU_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/d5/1c/6sS73Le3_o.png" alt="在这里插入图片描述"><br> 方便使用ip直接访问到2379端口，因为只要有节点的ip或者修改成0.0.0.0:2379都可以。不然通过ip:2379访问不到metrics数据</p> 
<p>存活探针</p> 
<p><img src="https://images2.imgbox.com/9b/fb/SxpZoZs8_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/aa/b1/4KTfKH9Y_o.png" alt="在这里插入图片描述"><br> 使用证书就可以访问到etcd集群<br> <img src="https://images2.imgbox.com/cb/13/HpKX6OgH_o.png" alt="在这里插入图片描述"><br> 通过hostpath形式挂载进去的</p> 
<p>现在想要在etcd集群中访问到该证书<br> <img src="https://images2.imgbox.com/3b/d7/jubbsMrc_o.png" alt="在这里插入图片描述"></p> 
<p>通过secert对象吧证书添加到对象当中</p> 
<p>通过文件创建。就是genetric</p> 
<blockquote> 
 <p>kubectl -n monitoring create secret generic etcd-certs --from-file=/etc/kubernetes/pki/etcd/healthcheck-client.key --from-file=/etc/kubernetes/pki/etcd/healthcheck-client.crt --from-file=/etc/kubernetes/pki/etcd/ca.crt<br> secret/etcd-certs created<br> <img src="https://images2.imgbox.com/7b/a0/vQhwmx1p_o.png" alt="在这里插入图片描述"></p> 
</blockquote> 
<p>etcd-certs的secert创建成功<br> <img src="https://images2.imgbox.com/99/33/lOPWf5C3_o.png" alt="在这里插入图片描述"><br> 创建的etcd证书的secert的一个对象。在对象里面的值都是做了一个编码</p> 
<p>然后吧证书注入到prometheus的pod中去，因为想要在prometheus的一个pod中能访问到这个证书，通过更改文件<br> <img src="https://images2.imgbox.com/f6/9b/PI2PTIPt_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/b8/56/hg8VdRoq_o.png" alt="在这里插入图片描述"><br> 为什么要把etcd-certs添加到monitoring命名空间下？<br> 因为这样在prometheus下面就能识别到了<br> <img src="https://images2.imgbox.com/99/16/msfiH2g8_o.png" alt="在这里插入图片描述"><br> 这个k8s是部署在集群当中的prometheus的一个资源对象<br> <img src="https://images2.imgbox.com/a1/e8/KYFb1R1f_o.png" alt="在这里插入图片描述"><br> 可以看到刚才添加的证书<br> <img src="https://images2.imgbox.com/4c/ab/3aurctuq_o.png" alt="在这里插入图片描述"><br> 可以看到这两个pod已经更新成功<br> <img src="https://images2.imgbox.com/be/11/hnEUHewe_o.png" alt="在这里插入图片描述"><br> 可以到该pod中查看etcd证书是否已经注入进来<br> <img src="https://images2.imgbox.com/20/69/scgm40hb_o.png" alt="在这里插入图片描述"><br> 看到该pod中已经注入证书了<br> 也就是pod中已经有了访问etcd的证书</p> 
<p>开始创建service monitoring文件<br> <img src="https://images2.imgbox.com/92/cb/Ujl0rNJT_o.png" alt="在这里插入图片描述"><br> 监控名字name:etcd-k8s<br> 标签： lables :<br> jobLabel: 就是取对应的lable的标签的名称去作为监控项的名字<br> <img src="https://images2.imgbox.com/b9/d2/8XKzizph_o.png" alt="在这里插入图片描述"><br> 就是jobLable的值是k8s-app,而k8s-app对应的值就是etcd-k8s<br> endpoints指定抓取etcd集群的endpoints<br> interval 30秒抓去一次<br> etcd通过https。所以添加证书<br> insecureSkipVerify: true. 不加校验证书可能会失败</p> 
<p>加seletor匹配service</p> 
<p>想要去匹配一个service具有k8s-app=etcd的service。在xx命名空间下<br> <img src="https://images2.imgbox.com/70/52/gJFiQ9Ky_o.png" alt="在这里插入图片描述"><br> 创建<br> <img src="https://images2.imgbox.com/52/d2/DNFpP2tA_o.png" alt="在这里插入图片描述"><br> 创建service<br> <img src="https://images2.imgbox.com/5f/a8/hMdR1vfT_o.png" alt="在这里插入图片描述"></p> 
<p>spec:<br> 因为吧etcd看作是集群外部的一个应用，所以不能通过selector去匹配集群中的pod,而是手动创建一个endpoints去指定etcd集群的访问地址，要手动创建endpoints就需要clusIP设置为none,<br> ports: 就是service的端口</p> 
<ul><li>name: port就是刚才在service monitoring中定义了的</li><li></ul> 
<p>接着endpoints需要自己手动创建一个</p> 
<p>metadata部分要和service的保持一致<br> <img src="https://images2.imgbox.com/90/f0/F3udTfTt_o.png" alt="在这里插入图片描述"></p> 
<p>这样endpoints就能和上面的service匹配了</p> 
<p>subsets 指定endpoints的地址<br> <img src="https://images2.imgbox.com/35/78/Klp6dPvS_o.png" alt="在这里插入图片描述"><br> 修改啊！！！！<br> <img src="https://images2.imgbox.com/ba/0c/5r5U3QAf_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/e8/6d/4pfBtVPx_o.png" alt="在这里插入图片描述"><br> https://www.cnblogs.com/fsckzy/p/12053604.html<br> Prometheus 监控Redis的正确姿势(redis集群)</p> 
<p>Prometheus 监控 Redis cluster，其实套路都是一样的，使用 exporter。<br> exporter 负责采集指标，通过 http 暴露给 Prometheus 拉取。granafa 则通过这些指标绘图展示数据。Prometheus 收集的数据还会根据你设置的告警规则判断是否要发送给 Alertmanager， Alertmanager 则要判断是否要发出告警。</p> 
<p>Alertmanager 告警分为三个阶段</p> 
<p>Inactive 触发告警的规则会被发送到这来。<br> Pending 你设置的等待时间，即规则里面的 for<br> Firing 发送告警到邮件、钉钉之类的<br> 扯远了，开始监控 Redis cluster</p> 
<p>redis_exporter 监控 Redis cluster<br> 监控什么应用，使用的相应的 exporter，可以在官网查到。EXPORTERS AND INTEGRATIONS</p> 
<p>Redis 使用 redis_exporter ，链接：redis_exporter</p> 
<hr> 
<p>现在 Prometheus 访问redis，接下来创建 ServiceMonitor 对象即可<br> prometheus-serviceMonitorRedis.yaml</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/04538d8456e1be2c28fb8a254a395501/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">[NOIP模拟题] 新台阶问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d837b85cde634725255d340fc945d15b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【JS从入门到精通】13-正则表达式</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>