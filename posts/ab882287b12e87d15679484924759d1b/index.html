<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>docker安装RocketMQ(附填坑经验connect to ＜172.17.0.3:10909＞ failed) - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="docker安装RocketMQ(附填坑经验connect to ＜172.17.0.3:10909＞ failed)" />
<meta property="og:description" content="目录 一、docker部署RocketMQ1、简易说明2、docker拉取RocketMQ镜像\RocketMQ控制台3、获取RocketMQ配置文件4、RocketMQ配置文件描述5、docker启动RocketMQ6、进入RocketMQ控制台 二、填坑经验错误一: connect to &lt;172.17.0.3:10909&gt; failed错误二: maybe your broker machine memory too small 本人安装版本：最新版(rocketmq-4.4.0),以下均对应4.4.0版本 一、docker部署RocketMQ 1、简易说明 在RocketMQ中，有三个关键组件：Namesrv（Name Server）、Broker和Console-ng（管理控制台）。
Namesrv（Name Server）：Namesrv是RocketMQ的命名服务，负责管理整个RocketMQ集群的路由信息。每个RocketMQ集群中都至少需要一个Namesrv实例。它维护了Broker的网络信息、Topic的路由规则以及Consumer的消费进度等元数据，并提供给Producer和Consumer使用。
Broker：Broker是RocketMQ的消息存储和处理节点，负责存储消息、处理消息的读写请求和转发消息等功能。在RocketMQ集群中，可以有多个Broker实例，各个Broker通过与Namesrv交互来维护消息的元数据和路由信息，以实现高可用、负载均衡的消息传输。
Console-ng（管理控制台）：Console-ng是RocketMQ官方提供的管理控制台，用于管理和监控RocketMQ集群。它提供了图形化界面，可以进行Topic、Consumer等的配置管理、消息查询与追踪、监控指标展示等操作。Console-ng对于集群的监控和运维非常有用。
这三个组件共同构成了RocketMQ的核心架构，并协同工作以实现高可用、高性能的消息传输和数据管理。您可以通过启动Namesrv、Broker来搭建一个RocketMQ集群，并使用Console-ng进行集群的管理与监控。
2、docker拉取RocketMQ镜像\RocketMQ控制台 拉取最新的RocketMQ，如果下载指定版本可以去docker官网查看
注：Namesrv、Broker均采用rocketmqinc/rocketmq同一个镜像
# 最新(rocketmq) docker pull rocketmqinc/rocketmq # 指定版本号(rocketmq) docker pull rocketmqinc/rocketmq:&lt;版本号&gt; # 最新(RocketMQ控制台) docker pull pangliang/rocketmq-console-ng 3、获取RocketMQ配置文件 可以启动RocketMQ，然后从docker容器中拷贝出配置文件，拷出配置文件后启动的容器就可以删除了
docker run -d --name rmqnamesrv -p 9876:9876 rocketmqinc/rocketmq:latest sh mqnamesrv # 进入容器(用于进入容器找到broker.conf 的位置) docker exec -it 容器ID /bin/bash # 从容器中下载文件到虚拟机 docker cp 容器ID:/opt/rocketmq-4.4.0/conf/broker.conf 虚拟机路径 4、RocketMQ配置文件描述 ongPollingEnable=true offsetCheckInSlave=false # nameServer地址，分号分割 namesrvAddr=172." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/ab882287b12e87d15679484924759d1b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-04T12:08:25+08:00" />
<meta property="article:modified_time" content="2023-07-04T12:08:25+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">docker安装RocketMQ(附填坑经验connect to ＜172.17.0.3:10909＞ failed)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#dockerRocketMQ_4" rel="nofollow">一、docker部署RocketMQ</a></li><li><ul><li><a href="#1_5" rel="nofollow">1、简易说明</a></li><li><a href="#2dockerRocketMQRocketMQ_15" rel="nofollow">2、docker拉取RocketMQ镜像\RocketMQ控制台</a></li><li><a href="#3RocketMQ_27" rel="nofollow">3、获取RocketMQ配置文件</a></li><li><a href="#4RocketMQ_36" rel="nofollow">4、RocketMQ配置文件描述</a></li><li><a href="#5dockerRocketMQ_152" rel="nofollow">5、docker启动RocketMQ</a></li><li><a href="#6RocketMQ_182" rel="nofollow">6、进入RocketMQ控制台</a></li></ul> 
  </li><li><a href="#_186" rel="nofollow">二、填坑经验</a></li><li><ul><li><a href="#_connect_to_172170310909_failed_187" rel="nofollow">错误一: connect to &lt;172.17.0.3:10909&gt; failed</a></li><li><a href="#_maybe_your_broker_machine_memory_too_small_215" rel="nofollow">错误二: maybe your broker machine memory too small</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<pre><code>本人安装版本：最新版(rocketmq-4.4.0),以下均对应4.4.0版本
</code></pre> 
<h2><a id="dockerRocketMQ_4"></a>一、docker部署RocketMQ</h2> 
<h3><a id="1_5"></a>1、简易说明</h3> 
<p>在RocketMQ中，有三个关键组件：Namesrv（Name Server）、Broker和Console-ng（管理控制台）。</p> 
<ol><li> <p>Namesrv（Name Server）：Namesrv是RocketMQ的命名服务，负责管理整个RocketMQ集群的路由信息。每个RocketMQ集群中都至少需要一个Namesrv实例。它维护了Broker的网络信息、Topic的路由规则以及Consumer的消费进度等元数据，并提供给Producer和Consumer使用。</p> </li><li> <p>Broker：Broker是RocketMQ的消息存储和处理节点，负责存储消息、处理消息的读写请求和转发消息等功能。在RocketMQ集群中，可以有多个Broker实例，各个Broker通过与Namesrv交互来维护消息的元数据和路由信息，以实现高可用、负载均衡的消息传输。</p> </li><li> <p>Console-ng（管理控制台）：Console-ng是RocketMQ官方提供的管理控制台，用于管理和监控RocketMQ集群。它提供了图形化界面，可以进行Topic、Consumer等的配置管理、消息查询与追踪、监控指标展示等操作。Console-ng对于集群的监控和运维非常有用。</p> </li></ol> 
<p>这三个组件共同构成了RocketMQ的核心架构，并协同工作以实现高可用、高性能的消息传输和数据管理。您可以通过启动Namesrv、Broker来搭建一个RocketMQ集群，并使用Console-ng进行集群的管理与监控。</p> 
<h3><a id="2dockerRocketMQRocketMQ_15"></a>2、docker拉取RocketMQ镜像\RocketMQ控制台</h3> 
<p>拉取最新的RocketMQ，如果下载指定版本可以去docker官网查看<br> 注：Namesrv、Broker均采用rocketmqinc/rocketmq同一个镜像</p> 
<pre><code># 最新(rocketmq)
docker pull rocketmqinc/rocketmq
# 指定版本号(rocketmq)
docker pull rocketmqinc/rocketmq:&lt;版本号&gt;

# 最新(RocketMQ控制台)
docker pull  pangliang/rocketmq-console-ng
</code></pre> 
<h3><a id="3RocketMQ_27"></a>3、获取RocketMQ配置文件</h3> 
<p>可以启动RocketMQ，然后从docker容器中拷贝出配置文件，拷出配置文件后启动的容器就可以删除了</p> 
<pre><code>docker run -d --name rmqnamesrv -p 9876:9876 rocketmqinc/rocketmq:latest sh mqnamesrv
# 进入容器(用于进入容器找到broker.conf 的位置)
docker exec -it 容器ID /bin/bash
# 从容器中下载文件到虚拟机
docker cp 容器ID:/opt/rocketmq-4.4.0/conf/broker.conf 虚拟机路径
</code></pre> 
<h3><a id="4RocketMQ_36"></a>4、RocketMQ配置文件描述</h3> 
<pre><code>ongPollingEnable=true
offsetCheckInSlave=false
# nameServer地址，分号分割
namesrvAddr=172.16.234.150:9876
fetchNamesrvAddrByAddressServer=false
#是否允许 Broker 自动创建订阅组，建议线下开启，线上关闭
autoCreateSubscriptionGroup=true
#是否允许 Broker 自动创建Topic，建议线下开启，线上关闭
autoCreateTopicEnable=true
sendThreadPoolQueueCapacity=100000
clusterTopicEnable=true
filterServerNums=1
pullMessageThreadPoolNums=20
# broker名字，名字可重复,为了管理,每个master起一个名字,他的slave同他,eg:Amaster叫broker-a,他的slave也叫broker-a
brokerName=knBroker
#rocketmqHome=/usr/local/alibaba-rocketmq/
sendMessageThreadPoolNums=24
# 0 表示 Master，&gt;0 表示 Slave
brokerId=0
brokerIP1=172.16.234.150
brokerTopicEnable=true
brokerPermission=6
shortPollingTimeMills=1000
clientManageThreadPoolNums=16
adminBrokerThreadPoolNums=16
flushConsumerOffsetInterval=5000
flushConsumerOffsetHistoryInterval=60000
# 在发送消息时，自动创建服务器不存在的topic，默认创建的队列数
defaultTopicQueueNums=8
rejectTransactionMessage=false
notifyConsumerIdsChangedEnable=true
pullThreadPoolQueueCapacity=100000
# # 所属集群名字
brokerClusterName=DefaultCluster
putMsgIndexHightWater=600000
maxTransferBytesOnMessageInDisk=65536
#检测物理文件磁盘空间
diskMaxUsedSpaceRatio=75
checkCRCOnRecover=true
haSlaveFallbehindMax=268435
deleteConsumeQueueFilesInterval=100
cleanResourceInterval=10000
maxMsgsNumBatch=64
flushConsumeQueueLeastPages=2
syncFlushTimeout=5000
#删除文件时间点，默认凌晨 4点
deleteWhen=04
#Broker 的角色
brokerRole=ASYNC_MASTER
destroyMapedFileIntervalForcibly=120000
#commitLog每个文件的大小默认1G
mapedFileSizeCommitLog=1073741824
haSendHeartbeatInterval=5000
#刷盘方式
flushDiskType=ASYNC_FLUSH
cleanFileForciblyEnable=true
haHousekeepingInterval=20000
redeleteHangedFileInterval=120000
#限制的消息大小
maxMessageSize=524288
flushCommitLogTimed=false
haMasterAddress=
maxTransferCountOnMessageInDisk=4
flushIntervalCommitLog=1000
#文件保留时间，默认 48 小时
fileReservedTime=72
flushCommitLogThoroughInterval=10000
maxHashSlotNum=5000
maxIndexNum=20000
messageIndexEnable=true
#存储路径
storePathRootDir=/root/store
#commitLog 存储路径
storePathCommitLog=/root/store/commitlog
#消费队列存储路径存储路径
storePathConsumeQueue=/root/store/consumequeue
#消息索引存储路径
storePathIndex=/root/store/index
haListenPort=10912
flushDelayOffsetInterval=10000
haTransferBatchSize=32768
deleteCommitLogFilesInterval=100
maxTransferBytesOnMessageInMemory=262144
accessMessageInMemoryMaxRatio=40
flushConsumeQueueThoroughInterval=60000
flushIntervalConsumeQueue=1000
maxTransferCountOnMessageInMemory=32
messageIndexSafe=false
#ConsumeQueue每个文件默认存30W条，根据业务情况调整
mapedFileSizeConsumeQueue=6000000
messageDelayLevel=1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h
flushCommitLogLeastPages=4
serverChannelMaxIdleTimeSeconds=120
#Broker 对外服务的监听端口
listenPort=10911
serverCallbackExecutorThreads=0
serverAsyncSemaphoreValue=64
serverSocketSndBufSize=131072
serverSelectorThreads=3
serverPooledByteBufAllocatorEnable=false
serverWorkerThreads=8
serverSocketRcvBufSize=131072
serverOnewaySemaphoreValue=256
clientWorkerThreads=4
connectTimeoutMillis=3000
clientSocketRcvBufSize=131072
clientOnewaySemaphoreValue=2048
clientChannelMaxIdleTimeSeconds=120
clientPooledByteBufAllocatorEnable=false
clientAsyncSemaphoreValue=2048
channelNotActiveInterval=60000
clientCallbackExecutorThreads=2
clientSocketSndBufSize=131072
</code></pre> 
<h3><a id="5dockerRocketMQ_152"></a>5、docker启动RocketMQ</h3> 
<p>以下将配置文件、日志、存储均挂载在本地</p> 
<pre><code class="prism language-bash"><span class="token comment"># 1、namesrv</span>
<span class="token function">docker</span> run -d -p <span class="token number">9876</span>:9876 <span class="token punctuation">\</span>
-v /mydata/rocketmq/namesrv/logs:/root/logs <span class="token punctuation">\</span>
-v /mydata/rocketmq/namesrv/store:/root/store <span class="token punctuation">\</span>
-v /mydata/rocketmq/conf/broker.conf:/opt/rocketmq-4.4.0/conf/broker.conf <span class="token punctuation">\</span>
--name rmqnamesrv <span class="token punctuation">\</span>
rocketmqinc/rocketmq:latest <span class="token function">sh</span> mqnamesrv


<span class="token comment"># 2、broker</span>
<span class="token function">docker</span> run -d  -p <span class="token number">10911</span>:10911 -p <span class="token number">10909</span>:10909 <span class="token punctuation">\</span>
-v /mydata/rocketmq/broker/logs:/root/logs <span class="token punctuation">\</span>
-v /mydata/rocketmq/broker/store:/root/store <span class="token punctuation">\</span>
-v /mydata/rocketmq/conf/broker.conf:/opt/rocketmq-4.4.0/conf/broker.conf <span class="token punctuation">\</span>
--name rmqbroker <span class="token punctuation">\</span>
--add-host namesrv:172.16.234.150 <span class="token punctuation">\</span>
-e <span class="token string">"NAMESRV_ADDR=namesrv:9876"</span> <span class="token punctuation">\</span>
rocketmqinc/rocketmq:latest <span class="token punctuation">\</span>
<span class="token function">sh</span> mqbroker -n namesrv:9876 <span class="token punctuation">\</span>
-c /opt/rocketmq-4.4.0/conf/broker.conf <span class="token assign-left variable">autoCreateTopicEnable</span><span class="token operator">=</span>true

<span class="token comment"># 3、Console-ng</span>
<span class="token function">docker</span> run --name rocketmq-console <span class="token punctuation">\</span>
-e <span class="token string">"JAVA_OPTS=-Drocketmq.namesrv.addr=172.16.234.150:9876 \
-Dcom.rocketmq.sendMessageWithVIPChannel=false"</span> <span class="token punctuation">\</span>
-p <span class="token number">8080</span>:8080 -t styletang/rocketmq-console-ng
</code></pre> 
<h3><a id="6RocketMQ_182"></a>6、进入RocketMQ控制台</h3> 
<p>地址(IP+rocketmq-console端口)：http://172.16.234.150:8080/#/<br> <img src="https://images2.imgbox.com/9d/fe/ySnFiUJU_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_186"></a>二、填坑经验</h2> 
<h3><a id="_connect_to_172170310909_failed_187"></a>错误一: connect to &lt;172.17.0.3:10909&gt; failed</h3> 
<p>1、在启动Java项目后，发送MQ消息是报以下错误<br> 2、RocketMQ控制台，集群地址显示为docker分配的IP</p> 
<p>进入RocketMQ控制台，控制台显示的集群地址为172.17.0.3:10909，并非172.16.234.150:10909，172.17.0.3实际为docker内部分配的ID，需要此IP修改为虚拟机的IP</p> 
<p>为了解决以上问题使用docker创建了一个网格【docker network create rocketmq-net + docker run -d --network rocketmq-net …】，但是没有解决此问题，实际导致此问题的是RocketMQ配置文件，请核查RocketMQ配置文件，或者采用上方提供的配置文件</p> 
<pre><code>com.himyidea.framework.mq.MQRuntimeException: EC = 900101: MSG = 900101 | msg=MQ Client Failure
	at com.himyidea.framework.mq.producer.impl.GeneralMQProducer.doSend(GeneralMQProducer.java:130)
	at com.himyidea.framework.mq.producer.impl.GeneralMQProducer.sendMessage(GeneralMQProducer.java:105)
	at java.lang.Thread.run(Thread.java:748)
Caused by: com.alibaba.rocketmq.client.exception.MQClientException: Send [3] times, still failed, cost [9073]ms, Topic: report_data_topic, BrokersSent: [broker-a, broker-a, broker-a]
See http://docs.aliyun.com/cn#/pub/ons/faq/exceptions&amp;send_msg_failed for further details.
	at com.alibaba.rocketmq.client.impl.producer.DefaultMQProducerImpl.sendDefaultImpl(DefaultMQProducerImpl.java:522)
	at com.alibaba.rocketmq.client.impl.producer.DefaultMQProducerImpl.send(DefaultMQProducerImpl.java:1030)
	at com.alibaba.rocketmq.client.impl.producer.DefaultMQProducerImpl.send(DefaultMQProducerImpl.java:989)
	at com.alibaba.rocketmq.client.producer.DefaultMQProducer.send(DefaultMQProducer.java:90)
	at com.himyidea.framework.mq.producer.impl.GeneralMQProducer.doSend(GeneralMQProducer.java:126)
	... 85 more
Caused by: com.alibaba.rocketmq.remoting.exception.RemotingConnectException: connect to &lt;172.17.0.3:10909&gt; failed
	at com.alibaba.rocketmq.remoting.netty.NettyRemotingClient.invokeSync(NettyRemotingClient.java:360)
	at com.alibaba.rocketmq.client.impl.MQClientAPIImpl.sendMessageSync(MQClientAPIImpl.java:267)
	at com.alibaba.rocketmq.client.impl.MQClientAPIImpl.sendMessage(MQClientAPIImpl.java:251)
	at com.alibaba.rocketmq.client.impl.MQClientAPIImpl.sendMessage(MQClientAPIImpl.java:214)
	at com.alibaba.rocketmq.client.impl.producer.DefaultMQProducerImpl.sendKernelImpl(DefaultMQProducerImpl.java:671)
	at com.alibaba.rocketmq.client.impl.producer.DefaultMQProducerImpl.sendDefaultImpl(DefaultMQProducerImpl.java:440)
</code></pre> 
<h3><a id="_maybe_your_broker_machine_memory_too_small_215"></a>错误二: maybe your broker machine memory too small</h3> 
<p>内存不足，以为是docker启动命令中未传内存信息，实际是虚拟机可用内存空间不足</p> 
<pre><code>Caused by: com.alibaba.rocketmq.client.exception.MQBrokerException: CODE: 14  DESC: service not available now, maybe disk full, CL:  0.99 CQ: -1.00 INDEX: -1.00, maybe your broker machine memory too small.

</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e5c71aa29c0d548062d8be39e3f01c69/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">速下载｜2023上半年网络与数据安全法规政策、国标、报告合集</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/17acceaf832a4baa250ef8236b0e3aeb/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">2023同济大学非全日制085400电子信息在职考研历程</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>