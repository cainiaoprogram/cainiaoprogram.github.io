<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>go-zero 2—并发处理数据包 mr(mapReduce) 的原理讲解 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="go-zero 2—并发处理数据包 mr(mapReduce) 的原理讲解" />
<meta property="og:description" content="自己实现的代码地址 https://github.com/wanmei002/goutil/blob/master/mr/mapreduce.go
如果觉的自己golang 功底不强的话，可以先看我的实现代码：汉字注释，省略了一些go-zero的相互依赖，没有像go-zero兼容那么多的需求，相对简单
原理 这里用到了一个概念mapReduce, 那什么是 mapReduce 呢？这里简单的说下我的理解：
mapReduce 是一种分布式处理数据并合并数据的概念，如果你想并发处理大量数据，你需要把很多数据分成很多份，让不同的机器或线程执行这些数据，并合并处理的结果；而mapReduce 的理念就是你把数据给它, 它自己切分数据分给不同的机器执行，并自动合并结果(自己的理解，如果是片面的不正确的请留言，再此不胜感激)。
当然了在这里实现的比较简单，简单介绍下这里的实现逻辑:
要处理的数据放到一个无缓冲的管道里，再来一个协程从这个无缓冲的管道里读取要处理的数据，然后把读取出来的数据开一个协程用 传入的方法处理;创建一个无缓冲的管道, 用来保存执行的结果, 让合并结果的协程从这个管道里读取数据, 然后合并数据, 写入合并数据的管道里创建一个用来停止其它协程的管道, 如果执行中有什么错误就关闭这个管道里，同时停止执行其它协程，返回失败最后要把没有关闭的管道关闭了 需要传入的参数 这里需要传入三个参数(方法) :
发送要处理的数据每条数据要怎么处理，并把处理结果写入到指定的channel里，如果遇到执行错误是否停止执行把处理数据的结果按需求合并到一起 逻辑图如下 贴上 go-zero mr包的主要实现代码 下面贴的代码是 go-zero mr包的代码；这里说的比较简单，实际实现上还是比较复杂的；有时间的话可以看看源码；
传递要处理的数据 创建一个无缓冲的channel，执行用户传递数据的逻辑
func buildSource(generate GenerateFunc) chan interface{} { source := make(chan interface{}) threading.GoSafe(func() { defer close(source) generate(source)// generate 是用户传入的方法 }) return source } 创建中断channel和数据传递channel output 是传递合并结果的channel，collector 用于传递 并发处理数据得到的结果，done 用于执行异样的时候通知其它goroutine退出执行
output := make(chan interface{}) collector := make(chan interface{}, options." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/164a4675bf58667cd32e6f755988c39c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-07-30T19:07:02+08:00" />
<meta property="article:modified_time" content="2021-07-30T19:07:02+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">go-zero 2—并发处理数据包 mr(mapReduce) 的原理讲解</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>自己实现的代码地址</h3> 
<p><a href="https://github.com/wanmei002/goutil/blob/master/mr/mapreduce.go">https://github.com/wanmei002/goutil/blob/master/mr/mapreduce.go</a></p> 
<blockquote> 
 <p>如果觉的自己golang 功底不强的话，可以先看我的实现代码：汉字注释，省略了一些go-zero的相互依赖，没有像go-zero兼容那么多的需求，相对简单</p> 
</blockquote> 
<h3><a id="_4"></a>原理</h3> 
<p>这里用到了一个概念<code>mapReduce</code>, 那什么是 <code>mapReduce</code> 呢？这里简单的说下我的理解：</p> 
<p>mapReduce 是一种分布式处理数据并合并数据的概念，如果你想并发处理大量数据，你需要把很多数据分成很多份，让不同的机器或线程执行这些数据，并合并处理的结果；而mapReduce 的理念就是你把数据给它, 它自己切分数据分给不同的机器执行，并自动合并结果(自己的理解，如果是片面的不正确的请留言，再此不胜感激)。</p> 
<p>当然了在这里实现的比较简单，简单介绍下这里的实现逻辑:</p> 
<ol><li>要处理的数据放到一个无缓冲的管道里，再来一个协程从这个无缓冲的管道里读取要处理的数据，然后把读取出来的数据开一个协程用 传入的方法处理;</li><li>创建一个无缓冲的管道, 用来保存执行的结果, 让合并结果的协程从这个管道里读取数据, 然后合并数据, 写入合并数据的管道里</li><li>创建一个用来停止其它协程的管道, 如果执行中有什么错误就关闭这个管道里，同时停止执行其它协程，返回失败</li><li>最后要把没有关闭的管道关闭了</li></ol> 
<h4><a id="_15"></a>需要传入的参数</h4> 
<p>这里需要传入三个参数(方法) :</p> 
<ol><li>发送要处理的数据</li><li>每条数据要怎么处理，并把处理结果写入到指定的channel里，如果遇到执行错误是否停止执行</li><li>把处理数据的结果按需求合并到一起</li></ol> 
<h4><a id="_21"></a>逻辑图如下</h4> 
<p><img src="https://images2.imgbox.com/38/9b/0T5vVfHS_o.png" alt="执行流程"></p> 
<h3><a id="_gozero_mr_23"></a>贴上 go-zero mr包的主要实现代码</h3> 
<blockquote> 
 <p>下面贴的代码是 <code>go-zero</code> <code>mr</code>包的代码；这里说的比较简单，实际实现上还是比较复杂的；有时间的话可以看看源码；</p> 
</blockquote> 
<h4><a id="_25"></a>传递要处理的数据</h4> 
<p>创建一个无缓冲的channel，执行用户传递数据的逻辑</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">buildSource</span><span class="token punctuation">(</span>generate GenerateFunc<span class="token punctuation">)</span> <span class="token keyword">chan</span> <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
	source <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	threading<span class="token punctuation">.</span><span class="token function">GoSafe</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span>
		<span class="token function">generate</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token comment">// generate 是用户传入的方法</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> source
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="channelchannel_37"></a>创建中断channel和数据传递channel</h4> 
<p><code>output</code> 是传递合并结果的channel，<code>collector</code> 用于传递 并发处理数据得到的结果，<code>done</code> 用于执行异样的时候通知其它goroutine退出执行</p> 
<pre><code class="prism language-go">output <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
collector <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>workers<span class="token punctuation">)</span>
done <span class="token operator">:=</span> syncx<span class="token punctuation">.</span><span class="token function">NewDoneChan</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="_44"></a>并发执行处理数据的逻辑</h4> 
<pre><code class="prism language-go"><span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>done<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span> 如果异常 这里通知停止执行
			<span class="token keyword">return</span>
		<span class="token keyword">case</span> pool <span class="token operator">&lt;-</span> lang<span class="token punctuation">.</span>Placeholder<span class="token punctuation">:</span>
			<span class="token comment">// 从channel中取出要处理的数据</span>
			item<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token operator">&lt;-</span>input
			<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{<!-- --></span>
				<span class="token operator">&lt;-</span>pool
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>

			wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token comment">// 开启协程 并发的执行处理数据的逻辑</span>
			threading<span class="token punctuation">.</span><span class="token function">GoSafe</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
					<span class="token operator">&lt;-</span>pool
				<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token comment">// 这个里面实际是调用用户传入的处理逻辑</span>
				<span class="token function">mapper</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> writer<span class="token punctuation">)</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_72"></a>调用示例</h4> 
<blockquote> 
 <p>这里用的是我自己实现的方法来运行的，实际上跟 go-zero 调用的方式是一样的</p> 
</blockquote> 
<pre><code class="prism language-go">	<span class="token comment">//要处理的数据</span>
    uid <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">}</span>
    <span class="token comment">//传递数据的逻辑</span>
    a <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>source <span class="token keyword">chan</span><span class="token operator">&lt;-</span> <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span>v <span class="token operator">:=</span> <span class="token keyword">range</span> uid <span class="token punctuation">{<!-- --></span>
            source <span class="token operator">&lt;-</span> v
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 处理数据的逻辑</span>
    b <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>item <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> writer mr<span class="token punctuation">.</span>Writer<span class="token punctuation">,</span> cancel <span class="token keyword">func</span><span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        tmp <span class="token operator">:=</span> item<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>
        writer<span class="token punctuation">.</span><span class="token function">Writer</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 合并的数据逻辑</span>
    c <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>pipe <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> writer mr<span class="token punctuation">.</span>Writer<span class="token punctuation">,</span> cancel <span class="token keyword">func</span><span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">var</span> uid <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>
        <span class="token keyword">for</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> pipe <span class="token punctuation">{<!-- --></span>
            uid <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>uid<span class="token punctuation">,</span> v<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span>
        writer<span class="token punctuation">.</span><span class="token function">Writer</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 开始并发处理数据</span>
    res<span class="token punctuation">,</span> err <span class="token operator">:=</span> mr<span class="token punctuation">.</span><span class="token function">MapReduce</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
</code></pre> 
<h5><a id="_105"></a>并发的执行多个方法</h5> 
<p>实际上 <code>Finish</code> 方法底层调用的也是 <code>mapReduce</code> 这个方法</p> 
<pre><code class="prism language-go">    a1 <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"aaaa"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    
    b1 <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"bbbb"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"err about bbbb"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    c1 <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"cccc"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    
    err <span class="token operator">:=</span> mr<span class="token punctuation">.</span><span class="token function">Finish</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> b1<span class="token punctuation">,</span> c1<span class="token punctuation">)</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/722eeafbbd15cdf5946fee24b3226df4/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">家庭宽带服务器有什么作用,服务器用的宽带和家用宽带有什么区别？</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8f49554700019d0ee59a32c1806c5692/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">pppoe服务器账号和密码是什么,路由器的PPPOE拨号宽带账号和密码是多少？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>