<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>人人都想了解的BGP，路由策略这样处理 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="人人都想了解的BGP，路由策略这样处理" />
<meta property="og:description" content="BGP路由策略处理流程 前言Routing Information Base（RIB）Route ProcessingBGP Adjacent in RIBInput PolicyBest path SelectionBGP Local RIBOutput PolicyBGP Adjacent out RIB 前言 路由协议，套用IT里面的术语，实际上就是分布式数据库系统，它包含了节点间的数据传递和节点内的数据处理。对于BGP来说，节点间基于TCP（端口179）的连接，在这个基础上，可以构建AS间的EBGP，AS内的IBGP，IBGP有full mesh，BGP路由反射器等，这些都是BGP节点之间的连接方式，这次看看BGP router内部是如何处理数据。
BGP是一种path vector路由协议，对比其他类的路由协议，path vector随路由携带的辅助信息更多，处理也稍微复杂一些。
Routing Information Base（RIB） RIB其实是设备商的术语。或许不太恰当，但是Global RIB可以对应操作系统里面的路由表。Global RIB和路由表都决定IP packet的三层转发的路径。RIB除了存放路由条目，还保存一些路由协议相关的辅助信息。除了Global RIB，每个路由协议都有自己的RIB，这样，路由协议可以将一些生（Raw）数据与真正应用的数据进行隔离。BGP维护几个RIB，包括了：
BGP Adjacent In RIB：保存所有接收到的BGP Message，这里可能存在多条BGP Message指向同一个目的IP prefixBGP Local RIB：保存经过处理和运算得到的最优BGP Message，对于同一个目的IP prefix，只存在一条最优的BGP MessageBGP Adjacent out RIB：保存将要发送给BGP Peer的BGP Message BGP协议收发的数据不会直接写到Global RIB里，而是放到了BGP自己的RIB里面，在适当的时候写入Global RIB，前面说过，这样可以实现数据隔离，有选择的将BGP数据写入主路由表。BGP的三个RIB保存着不同处理阶段的BGP Message，为不同阶段的操作提供数据。接下来过一下BGP路由处理过程。
Route Processing BGP Adjacent in RIB 这一步比较简单，来者不拒，所有收到的BGP Message都存到了BGP Adjacent in RIB
Input Policy input policy会完成两部分工作，filtering和manipulation。
Filtering会根据Path Attribute过滤BGP Message，这里需要注意两个内置的过滤，一个是判断当前的AS是否在BGP Message的AS_PATH中，如果在的话，那么这是一条之前已经经过当前AS的Message，这条Message会被过滤。另一个会判断BGP Message里的NEXT_HOP是否可达，如果不可达，那么这条Message会被标成Invalid，也会被过滤。除了内置的过滤，用户（对，就是网工）和控制程序也可以添加过滤规则，例如通过route-map，access-list，distribution-list等。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/f4b868aa84ca13a5563552af17663f7c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-03-11T17:06:51+08:00" />
<meta property="article:modified_time" content="2021-03-11T17:06:51+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">人人都想了解的BGP，路由策略这样处理</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>BGP路由策略处理流程</h4> 
 <ul><li><ul><li><ul><li><a href="#_2" rel="nofollow">前言</a></li><li><a href="#Routing_Information_BaseRIB_6" rel="nofollow">Routing Information Base（RIB）</a></li><li><a href="#Route_Processing_15" rel="nofollow">Route Processing</a></li><li><ul><li><a href="#BGP_Adjacent_in_RIB_16" rel="nofollow">BGP Adjacent in RIB</a></li><li><a href="#Input_Policy_21" rel="nofollow">Input Policy</a></li><li><a href="#Best_path_Selection_29" rel="nofollow">Best path Selection</a></li><li><a href="#BGP_Local_RIB_35" rel="nofollow">BGP Local RIB</a></li><li><a href="#Output_Policy_45" rel="nofollow">Output Policy</a></li><li><a href="#BGP_Adjacent_out_RIB_55" rel="nofollow">BGP Adjacent out RIB</a></li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h4><a id="_2"></a>前言</h4> 
<p>路由协议，套用IT里面的术语，实际上就是分布式数据库系统，它包含了节点间的数据传递和节点内的数据处理。对于BGP来说，节点间基于TCP（端口179）的连接，在这个基础上，可以构建AS间的EBGP，AS内的IBGP，IBGP有full mesh，BGP路由反射器等，这些都是BGP节点之间的连接方式，这次看看BGP router内部是如何处理数据。</p> 
<p>BGP是一种path vector路由协议，对比其他类的路由协议，path vector随路由携带的辅助信息更多，处理也稍微复杂一些。</p> 
<h4><a id="Routing_Information_BaseRIB_6"></a>Routing Information Base（RIB）</h4> 
<p>RIB其实是设备商的术语。或许不太恰当，但是Global RIB可以对应操作系统里面的路由表。Global RIB和路由表都决定IP packet的三层转发的路径。RIB除了存放路由条目，还保存一些路由协议相关的辅助信息。除了Global RIB，每个路由协议都有自己的RIB，这样，路由协议可以将一些生（Raw）数据与真正应用的数据进行隔离。BGP维护几个RIB，包括了：</p> 
<ul><li>BGP Adjacent In RIB：保存所有接收到的BGP Message，这里可能存在多条BGP Message指向同一个目的IP prefix</li><li>BGP Local RIB：保存经过处理和运算得到的最优BGP Message，对于同一个目的IP prefix，只存在一条最优的BGP Message</li><li>BGP Adjacent out RIB：保存将要发送给BGP Peer的BGP Message</li></ul> 
<p>BGP协议收发的数据不会直接写到Global RIB里，而是放到了BGP自己的RIB里面，在适当的时候写入Global RIB，前面说过，这样可以实现数据隔离，有选择的将BGP数据写入主路由表。BGP的三个RIB保存着不同处理阶段的BGP Message，为不同阶段的操作提供数据。接下来过一下BGP路由处理过程。</p> 
<h4><a id="Route_Processing_15"></a>Route Processing</h4> 
<h5><a id="BGP_Adjacent_in_RIB_16"></a>BGP Adjacent in RIB</h5> 
<p><img src="https://images2.imgbox.com/bb/b0/iWoAw4I5_o.png" alt="在这里插入图片描述"></p> 
<p>这一步比较简单，来者不拒，所有收到的BGP Message都存到了BGP Adjacent in RIB</p> 
<h5><a id="Input_Policy_21"></a>Input Policy</h5> 
<p><img src="https://images2.imgbox.com/6e/93/mb3mIRFq_o.png" alt="在这里插入图片描述"><br> input policy会完成两部分工作，filtering和manipulation。</p> 
<p>Filtering会根据Path Attribute过滤BGP Message，这里需要注意两个内置的过滤，一个是判断当前的AS是否在BGP Message的AS_PATH中，如果在的话，那么这是一条之前已经经过当前AS的Message，这条Message会被过滤。另一个会判断BGP Message里的NEXT_HOP是否可达，如果不可达，那么这条Message会被标成Invalid，也会被过滤。除了内置的过滤，用户（对，就是网工）和控制程序也可以添加过滤规则，例如通过route-map，access-list，distribution-list等。</p> 
<p>Manipulation会修改BGP Message的Path Attribute，这样可以控制后面的步骤，例如Best path selection。举个例子，BGP Router从两个邻居收到同一个IP Prefix的BGP Message，那么可以通过修改某一个邻居的BGP Message的PA，使得其中一条BGP Message在下一步中胜出。</p> 
<h5><a id="Best_path_Selection_29"></a>Best path Selection</h5> 
<p><img src="https://images2.imgbox.com/ee/61/idhyRPum_o.png" alt="在这里插入图片描述"><br> Local Route是本地的并且希望通过从BGP发布出去的路由。例如思科的设备，通过network命令可以发布本地路由，也可以通过redistribution，将IGP的路由重分布到BGP。这些Local Route都将转换成了BGP Message，和经过Input policy过滤和修改过的BGP Message，一起参与Best Path Selection。</p> 
<p>Best Path Selection是一个根据Path Attribute运算，从指向同一个目的IP prefix的，多条BGP Message中选出一条最优的过程。</p> 
<h5><a id="BGP_Local_RIB_35"></a>BGP Local RIB</h5> 
<p><img src="https://images2.imgbox.com/34/69/5PfdrGrJ_o.png" alt="在这里插入图片描述"><br> Best Path Selection能确保指向同一个IP prefix只有一条（其实也可以多条，取决于multipath）最优的BGP Message，这些BGP Message会存到BGP Local RIB。接下来的处理会分两条路径。</p> 
<p>第一个是写入到Global RIB，也就是全局路由表。当路由器中，没有其他的路由协议生成了指向相同目的IP prefix的路由，或者有的话，该路由协议的Administrative Distance（AD）大于BGP的AD值，那么这个时候BGP Local RIB的路由才会写入到Global RIB。EBGP的AD值是20，小于大部分路由协议，IBGP的AD值是200，大于大部分路由协议。</p> 
<p>第二个是输出到Output Policy，进而发往其他的BGP Peer。</p> 
<p>这两个路径互不影响，就算BGP没有竞争过其他路由协议，没有将路由写到全局路由表，也不影响路由传递给其他的BGP Peer。</p> 
<h5><a id="Output_Policy_45"></a>Output Policy</h5> 
<p><img src="https://images2.imgbox.com/5d/e3/u84i6MyR_o.png" alt="在这里插入图片描述"><br> 与Input Policy类似，这里也做filtering和manipulation。</p> 
<p>Filtering会根据Path Attribute过滤BGP Message，可以自己定义，也有BGP程序自带的过滤。还是以AS_PATH为例，如果目的BGP Peer的AS在BGP Message的AS_PATH中，那么这条BGP Message不会生成对应的发往该BGP Peer的BGP Message。</p> 
<p>Manipulation会修改BGP Message的Path Attribute，例如修改MED值，进而生成发往BGP Peer的BGP Message。</p> 
<p>经过Output Policy之后，一条BGP Message，会生成针对每一个可以送达的BGP Peer的，多条BGP Message。虽然来自同一个BGP Message，但是这里的每个BGP Message里面包含的Path Attribute可能因为定义策略不一样。</p> 
<h5><a id="BGP_Adjacent_out_RIB_55"></a>BGP Adjacent out RIB</h5> 
<p><img src="https://images2.imgbox.com/07/e8/Xlmo9Gpc_o.png" alt="在这里插入图片描述"><br> 类似于第一步，这部分也简单，生成好的BGP Message发往对端的BGP Peer。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c207d7ada264f244f5603336fa53fa6d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">http://caomaoav.top/index.php,hkfeed-dev/2014-11-04-passwords.txt at master · threatbot/hkfeed-dev ·...</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f344623d4aa9ef954e76af79546ef9e5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Sql server 2016 Always on 实现无域高可用</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>