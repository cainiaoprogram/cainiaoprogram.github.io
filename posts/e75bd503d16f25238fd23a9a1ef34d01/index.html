<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>kbengine属性同步分析 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="kbengine属性同步分析" />
<meta property="og:description" content="实体的属性是定义在def文件中
属性会有几个不同的flag来表示属性是如何更新的
entitydef/common.h
ALL_CLIENT 属性能被周围的客户端获得，包括自身。相当于同时设置了OWN_CLIENT和OTHER_CLIENT标志。ALL_CLIENTS 同ALL_CLIENTBASE 只能在Base上使用BASE_AND_CLIENT 属性在base和客户端都可见，相当于同时设置了OWN_CLIENT和BASE标志。CELL_PRIVATE entity的内部属性。 只在cell的entity内部可见，相当于私有属性。CELL_PUBLIC 可以被服务端的其它entity访问。在kbe中，现在暂时和CELL_PUBLIC是一样的。CELL_PUBLIC_AND_OWN 在cell上的其它entity可见，对客户端来说，仅自身客户端可见 在entity类中会有宏定义 ENTITY_HEADER
这里将其展开，主要是看其中的onScriptSetAttribute()函数。如果脚本层修改了属性值，会回调onScriptSetAttribute()。（object.__setattr__）
在815行，会调用onDefDataChanged()
679 到 682行 将属性值放到memorystream中去，然后发送
会根据propertyDescription里的flag（看三个if中的判断条件），即def文件中作用域的描述，形成发包，广播到关心这个数据的app里面。
其中同步客户端时会通过socket发送这个数据包到baseapp， baseapp中转到客户端， 客户端根据def描述解析并最终更新到对应实体数据中。
我们看其中广播给其他客户端的
在751行的宏定义展开之后
下面是forwardMessageToClientFromCellapp()的发送片段，会将信息发送给客户端
同时注意到baseapp的entity中也有onDefDataChanged()函数
128行的判断会将不具有ED_FLAG_BASE_AND_CLIENT 的属性数据类型才会发送到客户端。这些属性数据的定义如下
baseapp的属性改变只会发给自己的客户端，而不会广播
cellapp有广播的可能" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/e75bd503d16f25238fd23a9a1ef34d01/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-08-21T17:53:55+08:00" />
<meta property="article:modified_time" content="2020-08-21T17:53:55+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">kbengine属性同步分析</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>实体的属性是定义在def文件中</p> 
<p><img alt="" height="513" src="https://images2.imgbox.com/0f/c9/gUPNF67Y_o.png" width="686"></p> 
<p>属性会有几个不同的flag来表示属性是如何更新的</p> 
<p> </p> 
<p>entitydef/common.h</p> 
<p><img alt="" height="249" src="https://images2.imgbox.com/e0/83/9AYoDul8_o.png" width="1041"></p> 
<ul><li>ALL_CLIENT 属性能被周围的客户端获得，包括自身。相当于同时设置了OWN_CLIENT和OTHER_CLIENT标志。</li><li>ALL_CLIENTS 同ALL_CLIENT</li><li>BASE 只能在Base上使用</li><li>BASE_AND_CLIENT 属性在base和客户端都可见，相当于同时设置了OWN_CLIENT和BASE标志。</li><li>CELL_PRIVATE entity的内部属性。 只在cell的entity内部可见，相当于私有属性。</li><li>CELL_PUBLIC 可以被服务端的其它entity访问。在kbe中，现在暂时和CELL_PUBLIC是一样的。</li><li>CELL_PUBLIC_AND_OWN 在cell上的其它entity可见，对客户端来说，仅自身客户端可见</li></ul> 
<p> </p> 
<p>在entity类中会有宏定义 ENTITY_HEADER</p> 
<p style="margin-left:0cm;"><img alt="" height="193" src="https://images2.imgbox.com/d3/2e/y9wduSXg_o.png" width="771"></p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">这里将其展开，主要是看其中的onScriptSetAttribute()函数。如果脚本层修改了属性值，会回调onScriptSetAttribute()。（object.__setattr__）</p> 
<p style="margin-left:0cm;"><img alt="" height="285" src="https://images2.imgbox.com/da/46/jMpvqUxE_o.png" width="844"></p> 
<p style="margin-left:0cm;"><img alt="" height="863" src="https://images2.imgbox.com/0a/98/7kCv83f9_o.png" width="1047"></p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">在815行，会调用onDefDataChanged()</p> 
<p style="margin-left:0cm;"><img alt="" height="844" src="https://images2.imgbox.com/9b/64/xEb19JYQ_o.png" width="1200"></p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">679 到 682行 将属性值放到memorystream中去，然后发送</p> 
<p style="margin-left:0cm;"><span style="color:#444444;">会根据</span><span style="color:#444444;">propertyDescription</span><span style="color:#444444;">里的</span><span style="color:#444444;">flag（看三个if中的判断条件）</span><span style="color:#444444;">，即</span><span style="color:#444444;">def</span><span style="color:#444444;">文件中作用域的描述，形成发包，广播到关心这个数据的</span><span style="color:#444444;">app</span><span style="color:#444444;">里面。</span></p> 
<p style="margin-left:0cm;"><span style="color:#444444;">其中同步客户端时会通过</span><span style="color:#444444;">socket</span><span style="color:#444444;">发送这个数据包到</span><span style="color:#444444;">baseapp</span><span style="color:#444444;">，</span><span style="color:#444444;"> baseapp</span><span style="color:#444444;">中转到客户端，</span> <span style="color:#444444;">客户端根据</span><span style="color:#444444;">def</span><span style="color:#444444;">描述解析并最终更新到对应实体数据中。</span></p> 
<p style="margin-left:0cm;">我们看其中广播给其他客户端的</p> 
<p style="margin-left:0cm;"><img alt="" height="670" src="https://images2.imgbox.com/b9/09/IQ7X8YkI_o.png" width="1200"></p> 
<p style="margin-left:0cm;">在751行的宏定义展开之后</p> 
<p style="margin-left:0cm;"><img alt="" height="80" src="https://images2.imgbox.com/9f/75/z0xKJjZs_o.png" width="813"></p> 
<p style="margin-left:0cm;">下面是forwardMessageToClientFromCellapp()的发送片段，会将信息发送给客户端</p> 
<p style="margin-left:0cm;"><img alt="" height="236" src="https://images2.imgbox.com/fd/18/oNVju5pq_o.png" width="813"></p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;">同时注意到baseapp的entity中也有onDefDataChanged()函数</p> 
<p style="margin-left:0cm;"><img alt="" height="821" src="https://images2.imgbox.com/f4/c2/I8ZSqvz3_o.png" width="1160"></p> 
<p>128行的判断会将不具有ED_FLAG_BASE_AND_CLIENT 的属性数据类型才会发送到客户端。这些属性数据的定义如下</p> 
<p><img alt="" height="371" src="https://images2.imgbox.com/32/5d/nmll7a7N_o.png" width="1200"></p> 
<p> </p> 
<p>baseapp的属性改变只会发给自己的客户端，而不会广播</p> 
<p>cellapp有广播的可能</p> 
<p> </p> 
<p> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0c5580159b3ac01ace51fecc99a7c049/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">bios uefi 区别_UEFI vs BIOS：有何区别？</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5ee8acf0ea88392665e7cba088815de2/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">(转载)swift4 sqlite3 数据绑定（sqlite3_bind_text）的坑（逼）！</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>