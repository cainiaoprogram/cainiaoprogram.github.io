<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>前端js调取摄像头并实现拍照功能 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="前端js调取摄像头并实现拍照功能" />
<meta property="og:description" content="前言
最近接到的一个需求十分有意思，设计整体实现了前端仿 微信扫一扫 的功能。整理了一下思路，做一个分享。
tips: 如果想要实现完整扫一扫的功能，你需要掌握一些前置知识，这次我们先讲如何实现拍照并且保存的功能。
一. window.navigator 你想调取手机的摄像头，首先你得先检验当前设备是否有摄像设备，window 身上自带了一个 navigator 属性，这个对象有一个叫做 mediaDevices 的属性是我们即将用到的。
于是我们就可以先设计一个叫做 checkCamera 的函数，用来在页面刚开始加载的时候执行。。
我们先看一下这个对象有哪些方法，你也许会看到下面的场景，会发现这个属性身上只有一个值为 null 的 ondevicechange 属性，不要怕，真正要用的方法其实在它的原型身上。
让我们点开它的原型属性，注意下面这两个方法，这是我们本章节的主角。
我们到这一步只是需要判断当前设备是否有摄像头，我们先调取 enumerateDevices 函数来查看当前媒体设备是否存在。它的返回值是一个 promise 类型，我们直接用 async 和 await 来简化一下代码。
从上图可以看出，我的电脑有两个音频设备和一个视频设备，那么我们就可以放下进行下一步了。
二. 获取摄像头 接下来就需要用到上面提到的第二个函数，navigator.getUserMedia。这个函数接收一个对象作为参数，这个对象可以预设一些值，来作为我们请求摄像头的一些参数。
这里我们的重点是 facingMode 这个属性，因为我们扫一扫一般都是后置摄像头
当你执行了这个函数以后，你会看到浏览器有如下提示：
于是你高兴的点击了允许，却发现页面没有任何变化。
这里你需要知道，这个函数只是返回了一个媒体流信息给你，你可以这样简单理解刚刚我们干了什么，首先浏览器向手机申请我想用一下摄像头可以吗？在得到了你本人的确认以后，手机将摄像头的数据线递给了浏览器，：“诺，给你。”
但浏览器现在仅仅拿到了一根数据线，然而浏览器不知道需要将这个摄像头渲染到哪里，它不可能自动帮你接上这根线，你需要自己找地方接上这根数据线。
这里不卖关子，我们需要请到我们的 Video 标签。我没听错吧？那个播放视频的 video 标签？没错，就是原生的 video 标签。
这里创建一个 video 标签，然后打上 ref 来获取这个元素。
这里的关键点在于将流数据赋值给 video 标签的 srcObject 属性。就好像你拿到了数据线，插到了显示器上。
(tips: 这里需要特别注意，不是 video.src 而是 video.srcObject 请务必注意)
现在你应该会看到摄像头已经在屏幕上展示了。 三. 截取当前画面 当我按下按钮的时候，想办法将 video 标签当前的画面保存下来。在这个场景，我们需要用到 canvas 的一些能力。不要害怕，我目前对 canvas 的使用也不是特别熟练，今天也不会用到特别复杂的功能。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/27e86d90da08213fe02c4746699cb39a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-22T14:00:29+08:00" />
<meta property="article:modified_time" content="2023-11-22T14:00:29+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">前端js调取摄像头并实现拍照功能</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>前言</p> 
<p>最近接到的一个需求十分有意思，设计整体实现了前端仿 微信扫一扫 的功能。整理了一下思路，做一个分享。<br> <code>tips</code>: 如果想要实现完整扫一扫的功能，你需要掌握一些前置知识，这次我们先讲如何实现拍照并且保存的功能。</p> 
<h3><a id="_windownavigator_4"></a>一. window.navigator</h3> 
<ol><li> <p>你想调取手机的摄像头，首先你得先检验当前设备是否有摄像设备，window 身上自带了一个 navigator 属性，这个对象有一个叫做 mediaDevices 的属性是我们即将用到的。</p> </li><li> <p>于是我们就可以先设计一个叫做 checkCamera 的函数，用来在页面刚开始加载的时候执行。。<br> <img src="https://images2.imgbox.com/0a/09/MmqNRL9k_o.jpg" alt="请添加图片描述"></p> </li><li> <p>我们先看一下这个对象有哪些方法，你也许会看到下面的场景，会发现这个属性身上只有一个值为 null 的 ondevicechange 属性，不要怕，真正要用的方法其实在它的原型身上。<br> <img src="https://images2.imgbox.com/bd/59/WreynYpX_o.jpg" alt="请添加图片描述"></p> </li><li> <p>让我们点开它的原型属性，注意下面这两个方法，这是我们本章节的主角。<br> <img src="https://images2.imgbox.com/43/7e/D8IiL0ir_o.jpg" alt="请添加图片描述"></p> </li><li> <p>我们到这一步只是需要判断当前设备是否有摄像头，我们先调取 enumerateDevices 函数来查看当前媒体设备是否存在。它的返回值是一个 promise 类型，我们直接用 async 和 await 来简化一下代码。<br> <img src="https://images2.imgbox.com/d5/dd/T23gNbdw_o.jpg" alt="请添加图片描述"><br> <img src="https://images2.imgbox.com/c5/c8/PeOEozqP_o.jpg" alt="请添加图片描述"><br> 从上图可以看出，我的电脑有两个音频设备和一个视频设备，那么我们就可以放下进行下一步了。</p> </li></ol> 
<h3><a id="__19"></a>二. 获取摄像头</h3> 
<ol><li> <p>接下来就需要用到上面提到的第二个函数，navigator.getUserMedia。这个函数接收一个对象作为参数，这个对象可以预设一些值，来作为我们请求摄像头的一些参数。</p> </li><li> <p>这里我们的重点是 facingMode 这个属性，因为我们扫一扫一般都是后置摄像头<br> <img src="https://images2.imgbox.com/d9/2c/wiC6Z3ZA_o.jpg" alt="请添加图片描述"><br> 当你执行了这个函数以后，你会看到浏览器有如下提示：<br> <img src="https://images2.imgbox.com/5a/3f/7qyR5DpQ_o.jpg" alt="请添加图片描述"><br> 于是你高兴的点击了允许，却发现页面没有任何变化。<br> 这里你需要知道，这个函数只是返回了一个媒体流信息给你，你可以这样简单理解刚刚我们干了什么，首先浏览器向手机申请我想用一下摄像头可以吗？在得到了你本人的确认以后，手机将摄像头的数据线递给了浏览器，：“诺，给你。”</p> </li><li> <p>但浏览器现在仅仅拿到了一根数据线，然而浏览器不知道需要将这个摄像头渲染到哪里，它不可能自动帮你接上这根线，你需要自己找地方接上这根数据线。</p> </li></ol> 
<p>这里不卖关子，我们需要请到我们的 Video 标签。我没听错吧？那个播放视频的 video 标签？没错，就是原生的 video 标签。</p> 
<ol start="4"><li>这里创建一个 video 标签，然后打上 ref 来获取这个元素。<br> <img src="https://images2.imgbox.com/62/fa/gIiqPQq4_o.jpg" alt="请添加图片描述"></li><li>这里的关键点在于将流数据赋值给 video 标签的 srcObject 属性。就好像你拿到了数据线，插到了显示器上。<br> (tips: 这里需要特别注意，不是 video.src 而是 video.srcObject 请务必注意)<br> <img src="https://images2.imgbox.com/09/dc/dIC7xDXR_o.jpg" alt="请添加图片描述"></li><li>现在你应该会看到摄像头已经在屏幕上展示了。</li></ol> 
<h3><a id="__40"></a>三. 截取当前画面</h3> 
<p>当我按下按钮的时候，想办法将 video 标签当前的画面保存下来。在这个场景，我们需要用到 canvas 的一些能力。不要害怕，我目前对 canvas 的使用也不是特别熟练，今天也不会用到特别复杂的功能。</p> 
<ol><li> <p>首先创建一个空白的 canvas 元素，元素的宽高设置为和 video 标签一致。<br> <img src="https://images2.imgbox.com/71/28/GB9kcdVn_o.jpg" alt="请添加图片描述"></p> </li><li> <p>接下来是重点： 我们需要用到 canvas 的 getContext 方法，先别着急头晕，这里你只需要知道，它接受一个字符串 “2d” 作为参数就行了，它会把这个画布的上下文返回给你。<br> （ tips 如果这里还不清楚上下文的概念，也不用担心，这里你就简单理解为把这个 canvas 这个元素加工了一下，帮你在它身上添加了一些新的方法而已。)<br> <img src="https://images2.imgbox.com/2d/7f/SF6MM42e_o.jpg" alt="请添加图片描述"></p> </li><li> <p>在这个 ctx 对象身上，我们只需要用到一个 drawImage 方法即可，不需要关心其它属性。<br> <img src="https://images2.imgbox.com/63/d5/PDSxwov9_o.jpg" alt="请添加图片描述"></p> </li><li> <p>感觉参数有点多？没关系，我们再精简一下，我们只需要考虑第二个用法，也就是5参数的写法。(sx,sy 是做裁切用到的，本文用不到，感兴趣可以自行了解。)<br> <img src="https://images2.imgbox.com/1f/3d/bTen35YH_o.jpg" alt="请添加图片描述"></p> </li><li> <p>这里先简单解释一下 dx 和 dy 是什么意思。在 canvas 里也存在一个看不见的坐标系，起点也是左上角。设想你想在一个 HTML 的 body 元素里写一个距离左边距离 100px 距离顶部 100px的画面，是不是得写 margin-left:100px margin-top:100px 这样的代码？没错，这里的 dy 和 dx 也是同样的道理。</p> </li><li> <p>我们再看 dwidth，和 dheight，从这个名字你就能才出来，肯定和我们将要在画笔里画画的元素的宽度和高度有关，是的，你猜的没错，它就好像你设置一个 div 元素的高度和宽度一样，代表着你将在画布上画的截图的宽高属性。</p> </li><li> <p>现在只剩下第一个参数还没解释，这里直接说答案，我们可以直接将 video 标签填进去，ctx 会自动将当前 video 标签的这一帧画面填写进去。现在按钮的代码应该是这个样子。</p> </li></ol> 
<pre><code class="prism language-javascript"><span class="token keyword">function</span> <span class="token function">shoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>videoEl<span class="token punctuation">.</span>value <span class="token operator">||</span> <span class="token operator">!</span>wrapper<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"canvas"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> videoEl<span class="token punctuation">.</span>value<span class="token punctuation">.</span>videoWidth<span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> videoEl<span class="token punctuation">.</span>value<span class="token punctuation">.</span>videoHeight<span class="token punctuation">;</span>
  <span class="token comment">//拿到 canvas 上下文对象</span>
  <span class="token keyword">const</span> ctx <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">"2d"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      ctx<span class="token operator">?.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>videoEl<span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
  wrapper<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将 canvas 投到页面上</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="__68"></a>四. 源码</h3> 
<pre><code class="prism language-javascript">
<span class="token operator">&lt;</span>script lang<span class="token operator">=</span><span class="token string">"ts"</span> setup<span class="token operator">&gt;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> ref<span class="token punctuation">,</span> onMounted <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"vue"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> wrapper <span class="token operator">=</span> ref<span class="token operator">&lt;</span>HTMLDivElement<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> videoEl <span class="token operator">=</span> ref<span class="token operator">&lt;</span>HTMLVideoElement<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">checkCamera</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> navigator <span class="token operator">=</span> window<span class="token punctuation">.</span>navigator<span class="token punctuation">.</span>mediaDevices<span class="token punctuation">;</span>
  <span class="token keyword">const</span> devices <span class="token operator">=</span> <span class="token keyword">await</span> navigator<span class="token punctuation">.</span><span class="token function">enumerateDevices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>devices<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword">await</span> navigator<span class="token punctuation">.</span><span class="token function">getUserMedia</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">audio</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token literal-property property">video</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token number">300</span><span class="token punctuation">,</span>
        <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">300</span><span class="token punctuation">,</span>
        <span class="token comment">// facingMode: { exact: "environment" }, //强制后置摄像头</span>
        <span class="token literal-property property">facingMode</span><span class="token operator">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token comment">//前置摄像头</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>videoEl<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    videoEl<span class="token punctuation">.</span>value<span class="token punctuation">.</span>srcObject <span class="token operator">=</span> stream<span class="token punctuation">;</span>
    videoEl<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">shoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>videoEl<span class="token punctuation">.</span>value <span class="token operator">||</span> <span class="token operator">!</span>wrapper<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"canvas"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> videoEl<span class="token punctuation">.</span>value<span class="token punctuation">.</span>videoWidth<span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> videoEl<span class="token punctuation">.</span>value<span class="token punctuation">.</span>videoHeight<span class="token punctuation">;</span>
  <span class="token comment">//拿到 canvas 上下文对象</span>
  <span class="token keyword">const</span> ctx <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">"2d"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token operator">?.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>videoEl<span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
  wrapper<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">onMounted</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">checkCamera</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>div ref<span class="token operator">=</span><span class="token string">"wrapper"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"w-full h-full bg-red flex flex-col items-center"</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>video ref<span class="token operator">=</span><span class="token string">"videoEl"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>div
      @click<span class="token operator">=</span><span class="token string">"shoot"</span>
      <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"w-100px leading-100px text-center bg-black text-30px"</span>
    <span class="token operator">&gt;</span>
      拍摄
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>
</code></pre> 
<h3><a id="__125"></a>五. 总结</h3> 
<p>实现拍照的整体思路其实很简单，仅仅需要了解到视频其实也是一帧一帧画面构成的，而 canvas 恰好有捕捉当前帧的能力。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6b58e375fd1acc906767665e201258ab/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Elasticsearch7开启x-pack验证</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6a15f3b383b8f3714407901d67fc49ca/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Autoware.universe部署06：使用DBC文件进行UDP的CAN通信代码编写</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>