<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>基于websocket的跨平台通信——iPhone/iPad/Mac控制树莓派（二）：Swift控制端搭建，网络延迟显示 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="基于websocket的跨平台通信——iPhone/iPad/Mac控制树莓派（二）：Swift控制端搭建，网络延迟显示" />
<meta property="og:description" content="基于websocket的跨平台通信——iPhone/iPad/Mac控制树莓派（二）：Swift控制端搭建 瞎扯不想看我瞎扯直接跳到这思路/接口说明代码实现创建工程以及导入库创建工程导入库 网络延迟计算数据类定义发送（暂时用不上，因为暂时没有发送功能）接收工厂模型网络延迟工厂 WebSocket 说明 基于websocket的跨平台通信——iPhone/iPad/Mac控制树莓派
瞎扯 为什么你要用苹果平台不搞安卓/Windows呢？
主要是苹果生态比较完善，Swift直接跨所有设备，加上我手上没有安卓设备和Win的PC。（PC装的是Ubuntu）
那你跨平台为什么不写前端或者flutter之类的呢？
不会…
不想看我瞎扯直接跳到这 我们先来实现最基本的，网络延迟检测，也就是检测树莓派等设备的数据发送到控制端的网络延迟。
思路/接口说明 接口说明见：基于websocket的跨平台通信——iPhone/iPad/Mac控制树莓派（一）：后端搭建
由于后端只是单纯的做了一个数据转发的功能，控制端和设备端的代码量就要多许多（工厂模型）；而众所周知客户端的项目代码结构有很多种（我倾向于使用Redux），所以这里我只列出核心逻辑代码，UI实现等就省略了。
当然有一点还是要说明的：我的代码使用SwiftUI以及SwiftUI生命周期。
代码实现 创建工程以及导入库 创建工程 我打算在各种苹果设备上都能运行，所以这里选择Multiplatform App：
这里我倾向于勾上Core Data，虽然现在没用上，但万一以后要用也就省了步事。
（git选不选无所谓）
导入库 由于众所周知的网络原因，我无法使用Cocoapods等包管理工具导入；所以我选择用Xcode自带的导入工具本地导入。
打开gitclone，搜索starscream，这是Swift的一个websocket库；或者直接复制地址下载到本地：
git clone https://gitclone.com/github.com/daltoniam/Starscream
然后选择Xcode的File-&gt;Add Packages…
选择下方的Add Local…
选择克隆下来的Starscream文件夹，点击Add Packages：
然后在Xcode中点开.xcodeproj文件，找到图中的位置，点击左下方的&#43;号：
（稍后iOS下面的macOS也要进行相同的操作）
选择Starscream并点击Add：
就可以测试import starscream看看有没有报错了。
网络延迟计算 树莓派发送一个包含当前时间戳（单位：毫秒）的数据，控制端设备接收后用当前时间戳减去接收到的时间戳，即为网络延迟。
不过为了计算方便以及减少数据量，我们只发送毫秒时间戳的后五位，也就是只考虑百秒内的网络延迟，所以接收到的是一个Int值而不是Int64（Long）。
数据类定义 根据后端的接口定义，可以很快的写出发送和接收的数据类：
发送（暂时用不上，因为暂时没有发送功能） // BaseMsg.swift struct BaseMsg: Codable { var type: Int var toPlatform: [String] var msgType: String var msg: String } 接收 // Receive." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/2fb399c8b506390a91de07876e40ecd6/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-11-01T19:38:38+08:00" />
<meta property="article:modified_time" content="2021-11-01T19:38:38+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">基于websocket的跨平台通信——iPhone/iPad/Mac控制树莓派（二）：Swift控制端搭建，网络延迟显示</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>基于websocket的跨平台通信——iPhone/iPad/Mac控制树莓派（二）：Swift控制端搭建</h4> 
 <ul><li><a href="#_3" rel="nofollow">瞎扯</a></li><li><a href="#_10" rel="nofollow">不想看我瞎扯直接跳到这</a></li><li><a href="#_13" rel="nofollow">思路/接口说明</a></li><li><a href="#_21" rel="nofollow">代码实现</a></li><li><ul><li><a href="#_22" rel="nofollow">创建工程以及导入库</a></li><li><ul><li><a href="#_23" rel="nofollow">创建工程</a></li><li><a href="#_32" rel="nofollow">导入库</a></li></ul> 
   </li><li><a href="#_55" rel="nofollow">网络延迟计算</a></li><li><a href="#_60" rel="nofollow">数据类定义</a></li><li><ul><li><a href="#_63" rel="nofollow">发送（暂时用不上，因为暂时没有发送功能）</a></li><li><a href="#_76" rel="nofollow">接收</a></li><li><a href="#_100" rel="nofollow">工厂模型</a></li><li><a href="#_157" rel="nofollow">网络延迟工厂</a></li></ul> 
   </li><li><a href="#WebSocket_189" rel="nofollow">WebSocket</a></li></ul> 
  </li><li><a href="#_256" rel="nofollow">说明</a></li></ul> 
</div> 
<p></p> 
<p><a href="https://blog.csdn.net/weixin_46068920/article/details/121083318">基于websocket的跨平台通信——iPhone/iPad/Mac控制树莓派</a></p> 
<h2><a id="_3"></a>瞎扯</h2> 
<p>为什么你要用苹果平台不搞安卓/Windows呢？<br> 主要是苹果生态比较完善，Swift直接跨所有设备，加上我手上没有安卓设备和Win的PC。（PC装的是Ubuntu）</p> 
<p>那你跨平台为什么不写前端或者flutter之类的呢？<br> <strong>不会…</strong></p> 
<h2><a id="_10"></a>不想看我瞎扯直接跳到这</h2> 
<p>我们先来实现最基本的，网络延迟检测，也就是检测树莓派等设备的数据发送到控制端的网络延迟。</p> 
<h2><a id="_13"></a>思路/接口说明</h2> 
<p>接口说明见：<a href="https://wmiii.blog.csdn.net/article/details/121083917" rel="nofollow">基于websocket的跨平台通信——iPhone/iPad/Mac控制树莓派（一）：后端搭建</a></p> 
<p>由于后端只是单纯的做了一个数据转发的功能，控制端和设备端的代码量就要多许多（工厂模型）；而众所周知客户端的项目代码结构有很多种（我倾向于使用Redux），所以这里我只列出核心逻辑代码，UI实现等就省略了。</p> 
<p>当然有一点还是要说明的：<strong>我的代码使用SwiftUI以及SwiftUI生命周期。</strong></p> 
<h2><a id="_21"></a>代码实现</h2> 
<h3><a id="_22"></a>创建工程以及导入库</h3> 
<h4><a id="_23"></a>创建工程</h4> 
<p>我打算在各种苹果设备上都能运行，所以这里选择Multiplatform App：<br> <img src="https://images2.imgbox.com/76/e0/PsuTEZeD_o.png" alt="请添加图片描述"></p> 
<p>这里我倾向于勾上Core Data，虽然现在没用上，但万一以后要用也就省了步事。<br> <img src="https://images2.imgbox.com/4d/1b/aC9WcYWU_o.png" alt="请添加图片描述"></p> 
<p>（git选不选无所谓）</p> 
<h4><a id="_32"></a>导入库</h4> 
<p>由于众所周知的网络原因，我无法使用Cocoapods等包管理工具导入；所以我选择用Xcode自带的导入工具本地导入。</p> 
<p>打开gitclone，搜索starscream，这是Swift的一个websocket库；或者直接复制地址下载到本地：</p> 
<blockquote> 
 <p>git clone https://gitclone.com/github.com/daltoniam/Starscream</p> 
</blockquote> 
<p>然后选择Xcode的File-&gt;Add Packages…<br> <img src="https://images2.imgbox.com/cd/3c/p7iKbZE8_o.png" alt="请添加图片描述"></p> 
<p>选择下方的Add Local…<br> <img src="https://images2.imgbox.com/0c/3b/1r3KSAsk_o.png" alt="请添加图片描述"></p> 
<p>选择克隆下来的Starscream文件夹，点击Add Packages：<br> <img src="https://images2.imgbox.com/ec/b7/XMaZjAcf_o.png" alt="请添加图片描述"></p> 
<p>然后在Xcode中点开.xcodeproj文件，找到图中的位置，点击左下方的+号：<br> <img src="https://images2.imgbox.com/97/43/w87lLYYs_o.png" alt="在这里插入图片描述"><br> （稍后iOS下面的macOS也要进行相同的操作）</p> 
<p>选择Starscream并点击Add：<br> <img src="https://images2.imgbox.com/fc/22/kEesbfpO_o.png" alt="请添加图片描述"><br> 就可以测试import starscream看看有没有报错了。</p> 
<h3><a id="_55"></a>网络延迟计算</h3> 
<p>树莓派发送一个包含当前时间戳（单位：毫秒）的数据，控制端设备接收后用当前时间戳减去接收到的时间戳，即为网络延迟。</p> 
<p>不过为了计算方便以及减少数据量，我们只发送毫秒时间戳的后五位，也就是只考虑百秒内的网络延迟，所以接收到的是一个Int值而不是Int64（Long）。</p> 
<h3><a id="_60"></a>数据类定义</h3> 
<p>根据<a href="https://wmiii.blog.csdn.net/article/details/121083917" rel="nofollow">后端</a>的接口定义，可以很快的写出发送和接收的数据类：</p> 
<h4><a id="_63"></a>发送（暂时用不上，因为暂时没有发送功能）</h4> 
<pre><code class="prism language-swift"><span class="token comment">// BaseMsg.swift</span>

<span class="token keyword">struct</span> <span class="token builtin">BaseMsg</span><span class="token punctuation">:</span> <span class="token builtin">Codable</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> type<span class="token punctuation">:</span> <span class="token builtin">Int</span>
    <span class="token keyword">var</span> toPlatform<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span>
    <span class="token keyword">var</span> msgType<span class="token punctuation">:</span> <span class="token builtin">String</span>
    <span class="token keyword">var</span> msg<span class="token punctuation">:</span> <span class="token builtin">String</span>
<span class="token punctuation">}</span>

</code></pre> 
<h4><a id="_76"></a>接收</h4> 
<pre><code class="prism language-swift"><span class="token comment">// Receive.swift</span>

<span class="token keyword">struct</span> <span class="token builtin">Receive</span><span class="token punctuation">:</span> <span class="token builtin">Decodable</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> fromPlatform<span class="token punctuation">:</span> <span class="token builtin">String</span>
    <span class="token keyword">var</span> msgType<span class="token punctuation">:</span> <span class="token builtin">String</span>
    <span class="token keyword">var</span> msg<span class="token punctuation">:</span> <span class="token builtin">String</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>获取当前毫秒级时间戳可以写在Date的extension中，方便调用：</p> 
<pre><code class="prism language-swift"><span class="token comment">// 随便写哪</span>

<span class="token keyword">extension</span> <span class="token builtin">Date</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> milliStamp <span class="token punctuation">:</span> <span class="token builtin">Int64</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">let</span> timeInterval<span class="token punctuation">:</span> <span class="token builtin">TimeInterval</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>timeIntervalSince1970
            <span class="token keyword">let</span> millisecond <span class="token operator">=</span> <span class="token function">CLongLong</span><span class="token punctuation">(</span><span class="token function">round</span><span class="token punctuation">(</span>timeInterval<span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> millisecond
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_100"></a>工厂模型</h4> 
<p>由于之后我计划在树莓派上连接各种设备，同样由苹果设备控制，所以这里我们需要考虑整个项目的结构。我的思路是将不同的数据模块抽象成一个<strong>设备(Device)</strong>，例如在这个小窗中我要显示树莓派的CPU使用率、CPU温度、内存占用，那么我们就把这三个数据抽象成一个**“主控（MasterControl）”<strong>的类；在另外一个小窗中我要显示网络延迟，那么就把网络延迟这个数据抽象成</strong>“网络延迟（NetDelay）”**类，等等。</p> 
<p>那么我们的思路就明确了，定义一个名为Device的父类，所有的设备都继承这个父类：</p> 
<pre><code class="prism language-swift"><span class="token comment">// Device.swift</span>

<span class="token keyword">import</span> <span class="token builtin">Foundation</span>

<span class="token keyword">class</span> <span class="token class-name">Device</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> device<span class="token punctuation">:</span> <span class="token builtin">String</span>              <span class="token comment">// 设备名</span>
    <span class="token keyword">var</span> belonged<span class="token punctuation">:</span> <span class="token builtin">PlatformName</span>		<span class="token comment">// 属于哪个平台，暂时无需理会</span>
    <span class="token keyword">init</span><span class="token punctuation">(</span>device<span class="token punctuation">:</span> <span class="token builtin">DeviceName</span><span class="token punctuation">,</span> belonged<span class="token punctuation">:</span> <span class="token builtin">PlatformName</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>device <span class="token operator">=</span> device<span class="token punctuation">.</span>text
        <span class="token keyword">self</span><span class="token punctuation">.</span>belonged <span class="token operator">=</span> belonged
    <span class="token punctuation">}</span>
    
    <span class="token comment">// appState是Redux非常重要的一环，简单来说就是应用的所有数据状态；换成自己框架的数据更新方式即可；appState拥有@State标签，更新时驱动界面更新</span>
    <span class="token keyword">func</span> <span class="token function">DecodeAndUpdate</span><span class="token punctuation">(</span>msg<span class="token punctuation">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> appState<span class="token punctuation">:</span> <span class="token builtin">AppState</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">AppState</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> appState
    <span class="token punctuation">}</span>  <span class="token comment">// 解码数据并更新应用的数据状态</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>等等…为什么不用我们Swift大名鼎鼎的<strong>protocol协议</strong>呢？</p> 
<p>因为我想把这些工厂类放在一个字典内。（相对空间复杂度，我对时间复杂度敏感的多）<br> 就是通过接收到的msgType判断这个数据需要被解析成哪个类，msgType与对应的工厂类组成键值对保存在字典中。</p> 
<p>对了，为了应对之后设备越来越多的情况，我定义了一个枚举类型，表示设备的名称：</p> 
<pre><code class="prism language-swift"><span class="token comment">// DeviceName.swift</span>
<span class="token comment">// 这只是一个小小的例子</span>

<span class="token keyword">import</span> <span class="token builtin">Foundation</span>

<span class="token keyword">enum</span> <span class="token builtin">DeviceName</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">case</span> <span class="token builtin">Temperature</span>        <span class="token comment">// 温度；设备温度、环境温度等</span>
    <span class="token keyword">case</span> <span class="token builtin">NetDelay</span>           <span class="token comment">// 网络延迟</span>
    <span class="token keyword">case</span> <span class="token builtin">MasterControl</span>      <span class="token comment">// 主控</span>
<span class="token punctuation">}</span>

<span class="token keyword">extension</span> <span class="token builtin">DeviceName</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> text<span class="token punctuation">:</span> <span class="token builtin">String</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">switch</span> <span class="token keyword">self</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> <span class="token punctuation">.</span><span class="token builtin">Temperature</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">"Temperature"</span>
        <span class="token keyword">case</span> <span class="token punctuation">.</span><span class="token builtin">NetDelay</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">"NetDelay"</span>
        <span class="token keyword">case</span> <span class="token punctuation">.</span><span class="token builtin">MasterControl</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">"MasterControl"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>也是msgType的所有情况。（人为规定）</p> 
<h4><a id="_157"></a>网络延迟工厂</h4> 
<pre><code class="prism language-swift"><span class="token keyword">class</span> <span class="token class-name">NetDelay</span><span class="token punctuation">:</span> <span class="token builtin">Device</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token keyword">override</span> <span class="token keyword">init</span><span class="token punctuation">(</span>device<span class="token punctuation">:</span> <span class="token builtin">DeviceName</span><span class="token punctuation">,</span> belonged<span class="token punctuation">:</span> <span class="token builtin">PlatformName</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span>device<span class="token punctuation">:</span> device<span class="token punctuation">,</span> belonged<span class="token punctuation">:</span> belonged<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">override</span> <span class="token keyword">func</span> <span class="token function">DecodeAndUpdate</span><span class="token punctuation">(</span>msg<span class="token punctuation">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> appState<span class="token punctuation">:</span> <span class="token builtin">AppState</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">AppState</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">var</span> appState <span class="token operator">=</span> appState
        <span class="token keyword">if</span> <span class="token keyword">let</span> data <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span>using<span class="token punctuation">:</span> <span class="token punctuation">.</span>utf8<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token keyword">let</span> temp <span class="token operator">=</span> <span class="token keyword">try</span><span class="token operator">?</span> <span class="token function">JSONDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">,</span> from<span class="token punctuation">:</span> data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                appState<span class="token punctuation">.</span>macTerminal<span class="token punctuation">.</span>netDelay<span class="token punctuation">.</span>delay <span class="token operator">=</span> <span class="token function">Int</span><span class="token punctuation">(</span><span class="token function">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>milliStamp <span class="token operator">%</span> <span class="token number">100000</span><span class="token punctuation">)</span> <span class="token operator">-</span> temp
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"decode error."</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"error."</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> appState
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token builtin">NetDelayProperty</span><span class="token punctuation">:</span> <span class="token builtin">Decodable</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> delay<span class="token punctuation">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>NetDelayProperty结构体代表存储在应用状态（appState）中的网络延迟，用于在UI界面上显示；</p> 
<p>上面的工厂类里面有很多<strong>意义不明</strong>的变量，但是没有关系，这只是个案例，核心就是计算并更新appState中网络延迟的数据，从而驱动界面更新。</p> 
<h3><a id="WebSocket_189"></a>WebSocket</h3> 
<p>终于到了数据接收了。</p> 
<pre><code class="prism language-swift"><span class="token keyword">import</span> <span class="token builtin">Foundation</span>
<span class="token keyword">import</span> <span class="token builtin">SwiftUI</span>
<span class="token keyword">import</span> <span class="token builtin">Starscream</span>

<span class="token keyword">class</span> <span class="token class-name">WmSocket</span><span class="token punctuation">:</span> <span class="token builtin">WebSocketDelegate</span><span class="token punctuation">,</span> <span class="token builtin">ObservableObject</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// url最后一个路径就是你的设备名</span>
    <span class="token keyword">var</span> wsurl <span class="token operator">=</span> <span class="token string">"ws://localhost:8880/websocket/WMBP"</span>
    <span class="token keyword">var</span> request<span class="token punctuation">:</span> <span class="token builtin">URLRequest</span>
    <span class="token keyword">var</span> socket<span class="token punctuation">:</span> <span class="token builtin">WebSocket</span>
    <span class="token keyword">var</span> isConnected <span class="token operator">=</span> <span class="token boolean">false</span>
    
    <span class="token keyword">init</span><span class="token punctuation">(</span>store<span class="token punctuation">:</span> <span class="token builtin">Store</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        request <span class="token operator">=</span> <span class="token function">URLRequest</span><span class="token punctuation">(</span>url<span class="token punctuation">:</span> <span class="token function">URL</span><span class="token punctuation">(</span>string<span class="token punctuation">:</span> wsurl<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">)</span>
        request<span class="token punctuation">.</span>timeoutInterval <span class="token operator">=</span> <span class="token number">5</span>
        socket <span class="token operator">=</span> <span class="token function">WebSocket</span><span class="token punctuation">(</span>request<span class="token punctuation">:</span> request<span class="token punctuation">)</span>
        socket<span class="token punctuation">.</span>delegate <span class="token operator">=</span> <span class="token keyword">self</span>
        socket<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">func</span> <span class="token function">didReceive</span><span class="token punctuation">(</span>event<span class="token punctuation">:</span> <span class="token builtin">WebSocketEvent</span><span class="token punctuation">,</span> client<span class="token punctuation">:</span> <span class="token builtin">WebSocket</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// print("anal...")</span>
        <span class="token keyword">switch</span> event <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// websocket成功连接时调用</span>
        <span class="token keyword">case</span> <span class="token punctuation">.</span><span class="token function">connected</span><span class="token punctuation">(</span><span class="token keyword">let</span> headers<span class="token punctuation">)</span><span class="token punctuation">:</span>
            isConnected <span class="token operator">=</span> <span class="token boolean">true</span>
            <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"websocket is connected: <span class="token interpolation"><span class="token delimiter variable">\(</span>headers<span class="token delimiter variable">)</span></span>"</span><span class="token punctuation">)</span>
        
        <span class="token comment">// websocket断开时调用</span>
        <span class="token keyword">case</span> <span class="token punctuation">.</span><span class="token function">disconnected</span><span class="token punctuation">(</span><span class="token keyword">let</span> reason<span class="token punctuation">,</span> <span class="token keyword">let</span> code<span class="token punctuation">)</span><span class="token punctuation">:</span>
            isConnected <span class="token operator">=</span> <span class="token boolean">false</span>
            <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"websocket is disconnected: <span class="token interpolation"><span class="token delimiter variable">\(</span>reason<span class="token delimiter variable">)</span></span> with code: <span class="token interpolation"><span class="token delimiter variable">\(</span>code<span class="token delimiter variable">)</span></span>"</span><span class="token punctuation">)</span>
        
        <span class="token comment">// 接收到字符类型数据(包括json)时调用</span>
        <span class="token keyword">case</span> <span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token keyword">let</span> string<span class="token punctuation">)</span><span class="token punctuation">:</span>
        	<span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span>
        
        <span class="token comment">// 接收到二进制数据时调用</span>
        <span class="token keyword">case</span> <span class="token punctuation">.</span><span class="token function">binary</span><span class="token punctuation">(</span><span class="token keyword">let</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Received data: <span class="token interpolation"><span class="token delimiter variable">\(</span>data<span class="token punctuation">.</span><span class="token builtin">count</span><span class="token delimiter variable">)</span></span>"</span><span class="token punctuation">)</span>
        <span class="token keyword">case</span> <span class="token punctuation">.</span><span class="token function">ping</span><span class="token punctuation">(</span><span class="token number">_</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
        <span class="token keyword">case</span> <span class="token punctuation">.</span><span class="token function">pong</span><span class="token punctuation">(</span><span class="token number">_</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
        <span class="token keyword">case</span> <span class="token punctuation">.</span><span class="token function">viabilityChanged</span><span class="token punctuation">(</span><span class="token number">_</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
        <span class="token keyword">case</span> <span class="token punctuation">.</span><span class="token function">reconnectSuggested</span><span class="token punctuation">(</span><span class="token number">_</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
        <span class="token keyword">case</span> <span class="token punctuation">.</span>cancelled<span class="token punctuation">:</span>
            isConnected <span class="token operator">=</span> <span class="token boolean">false</span>
		
		<span class="token comment">// 发生错误时调用</span>
        <span class="token keyword">case</span> <span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token keyword">let</span> error<span class="token punctuation">)</span><span class="token punctuation">:</span>
            isConnected <span class="token operator">=</span> <span class="token boolean">false</span>
            <span class="token function">print</span><span class="token punctuation">(</span>error <span class="token operator">?</span><span class="token operator">?</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这里只需要关心didReceive()就可以了；很明显当接收到json数据时就会进入case .text(let string)中的代码；所以我们只要在这里适时的调用我们的工厂类的函数，解析数据更新状态以更新ui即可。</p> 
<h2><a id="_256"></a>说明</h2> 
<p>以上只是整个流程的思路说明；由于代码量比较大所以就不放这了。需要代码的可以评论或者私信。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7a6f12db773c88d2f7d408454d0308f2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">阿里云优化求解器mindopt安装配置教程</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f91fb3ddfcb644acdf232c23f66ab2f7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">day2笔记</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>