<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【游戏开发实战】手把手教你从零跑一个Skynet，详细教程，含案例讲解（服务端 | Skynet | Ubuntu） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【游戏开发实战】手把手教你从零跑一个Skynet，详细教程，含案例讲解（服务端 | Skynet | Ubuntu）" />
<meta property="og:description" content="文章目录 一、前言二、关于Skynet三、Ubuntu虚拟机1、Ubuntu系统镜像下载2、VirtualBox虚拟机软件2.1、VirtualBox下载2.2、VirtualBox安装2.3、创建虚拟机 3、载入Ubuntu iso镜像4、Ubuntu系统安装过程 四、安装必要的工具1、安装git2、安装autoconf3、安装gcc 五、下载Skynet源码六、编译Skynet源码七、运行Skynet案例八、写个Demo1、配置文件2、规范目录结构3、自己写个配置文件4、主服务5、写个打工服务6、在主服务中启动打工服务7、在主服务中给打工服务发消息8、封装服务类9、重写打工服务10、买猫粮服务 九、补充1、网络模块2、节点集群3、数据库模块3.1、安装MySQL3.2、启动MySQL3.3、关闭MySQL3.4、登录MySQL3.5、在skynet中操作数据库 十、完毕 一、前言 嗨，大家好，我是新发。
认识我的朋友都知道我是一名Unity游戏开发工程师，也就是我平时做的是客户端部分的开发，其实以前我是一名服务端开发工程师，后来因为工作原因，转岗做了Unity客户端开发，然后就一直干到现在。
最近，我在搞服务端的skynet框架，看看以后自己做些作品（skynet框架服务端&#43;Unity客户端）。今天呢，我就先把skynet环境搞一下，讲讲流程，也方便想学习的同学，话不多说，我们开始吧~
二、关于Skynet skynet是一个轻量级的网络游戏框架，也可用于许多其他领域。
建议大家看下云风的《Skynet设计综述》，这里我不过多赘述，主要讲讲操作流程~
三、Ubuntu虚拟机 skynet需要运行在linux或macos系统中，这里作为演示，我使用Ubuntu虚拟机。下面我讲下Ubuntu虚拟机的安装过程。
1、Ubuntu系统镜像下载 首先我们需要先下载Ubuntu系统的iso文件，下面这些地址都可以下载，大家选择一个即可：
网易开源镜像：http://mirrors.163.com/ubuntu-releases/
Ubuntu官方：http://releases.ubuntu.com/
Ubuntu中国官网：https://ubuntu.com/download/alternative-downloads
中科开源镜像：http://mirrors.ustc.edu.cn/ubuntu-releases/
阿里开源镜像：http://mirrors.aliyun.com/ubuntu-releases/
浙江大学开源镜像：http://mirrors.zju.edu.cn/ubuntu-releases/
我以Ubuntu 16.04.7版本为例，地址：http://mirrors.163.com/ubuntu-releases/16.04.7/
把iso文件下载到本地，
2、VirtualBox虚拟机软件 有了iso文件，需要将其安装到虚拟机中，而虚拟机需要运行在虚拟机软件上，所以，我们还需要先安装一个虚拟机软件。
虚拟机软件大家常用的是VMWare，这里我强烈推荐另一款虚拟机软件：VirtualBox，它轻量、开源免费，对于个人学习使用完全足够，五星推荐~
关于VirtualBox：
VirtualBox是一款开源虚拟机软件。VirtualBox是由德国Innotek公司开发，由Sun Microsystems公司出品的软件，使用Qt编写，在 Sun被 Oracle收购后正式更名成 Oracle VM VirtualBox。
VirtualBox号称是最强的免费虚拟机软件，它不仅具有丰富的特色，而且性能也很优异！它简单易用，可虚拟的系统包括Windows（从Windows 3.1到Windows 10、Windows Server 2012，所有的Windows系统都支持）、Mac OS X、Linux、OpenBSD、Solaris、IBM OS2甚至Android等操作系统！使用者可以在VirtualBox上安装并且运行上述的这些操作系统！
2.1、VirtualBox下载 VirtualBox我们可以从官网下载到，地址：https://www.virtualbox.org/
选择windows版本，点击下载，
下载完毕，
2.2、VirtualBox安装 双击安装包运行安装，过程没有什么特别的，这里不赘述~
安装成功后打开VirtualBox，界面如下：
2.3、创建虚拟机 点击菜单控制/新建，
填写虚拟机名称，设置虚拟机保存路径，如下，我设置为E:\ubuntu16，
设置内存大小，建议分配2G内存，
创建虚拟硬盘，
建议分配10G的虚拟硬盘空间，
虚拟机创建完成，如下
3、载入Ubuntu iso镜像 点击启动虚拟机，会提示选择启动盘，点击下面的小按钮，
点击注册，
选择我们刚刚下载的iso系统镜像文件，打开，可以看到列表中出现了我们的镜像，选中它，
点击启动，即可进入系统安装。
4、Ubuntu系统安装过程 点击Install Ubuntu，" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/31b8ac20d8016c4eddd17d06c63fe993/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-10-04T19:12:42+08:00" />
<meta property="article:modified_time" content="2021-10-04T19:12:42+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【游戏开发实战】手把手教你从零跑一个Skynet，详细教程，含案例讲解（服务端 | Skynet | Ubuntu）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><ul><li><a href="#_3" rel="nofollow">一、前言</a></li><li><a href="#Skynet_9" rel="nofollow">二、关于Skynet</a></li><li><a href="#Ubuntu_15" rel="nofollow">三、Ubuntu虚拟机</a></li><li><ul><li><a href="#1Ubuntu_17" rel="nofollow">1、Ubuntu系统镜像下载</a></li><li><a href="#2VirtualBox_31" rel="nofollow">2、VirtualBox虚拟机软件</a></li><li><ul><li><a href="#21VirtualBox_38" rel="nofollow">2.1、VirtualBox下载</a></li><li><a href="#22VirtualBox_46" rel="nofollow">2.2、VirtualBox安装</a></li><li><a href="#23_50" rel="nofollow">2.3、创建虚拟机</a></li></ul> 
     </li><li><a href="#3Ubuntu_iso_70" rel="nofollow">3、载入Ubuntu iso镜像</a></li><li><a href="#4Ubuntu_78" rel="nofollow">4、Ubuntu系统安装过程</a></li></ul> 
    </li><li><a href="#_103" rel="nofollow">四、安装必要的工具</a></li><li><ul><li><a href="#1git_104" rel="nofollow">1、安装git</a></li><li><a href="#2autoconf_118" rel="nofollow">2、安装autoconf</a></li><li><a href="#3gcc_128" rel="nofollow">3、安装gcc</a></li></ul> 
    </li><li><a href="#Skynet_133" rel="nofollow">五、下载Skynet源码</a></li><li><a href="#Skynet_144" rel="nofollow">六、编译Skynet源码</a></li><li><a href="#Skynet_161" rel="nofollow">七、运行Skynet案例</a></li><li><a href="#Demo_179" rel="nofollow">八、写个Demo</a></li><li><ul><li><a href="#1_181" rel="nofollow">1、配置文件</a></li><li><a href="#2_253" rel="nofollow">2、规范目录结构</a></li><li><a href="#3_268" rel="nofollow">3、自己写个配置文件</a></li><li><a href="#4_288" rel="nofollow">4、主服务</a></li><li><a href="#5_321" rel="nofollow">5、写个打工服务</a></li><li><a href="#6_410" rel="nofollow">6、在主服务中启动打工服务</a></li><li><a href="#7_467" rel="nofollow">7、在主服务中给打工服务发消息</a></li><li><a href="#8_494" rel="nofollow">8、封装服务类</a></li><li><a href="#9_561" rel="nofollow">9、重写打工服务</a></li><li><a href="#10_630" rel="nofollow">10、买猫粮服务</a></li></ul> 
    </li><li><a href="#_699" rel="nofollow">九、补充</a></li><li><ul><li><a href="#1_700" rel="nofollow">1、网络模块</a></li><li><a href="#2_761" rel="nofollow">2、节点集群</a></li><li><a href="#3_888" rel="nofollow">3、数据库模块</a></li><li><ul><li><a href="#31MySQL_889" rel="nofollow">3.1、安装MySQL</a></li><li><a href="#32MySQL_898" rel="nofollow">3.2、启动MySQL</a></li><li><a href="#33MySQL_911" rel="nofollow">3.3、关闭MySQL</a></li><li><a href="#34MySQL_922" rel="nofollow">3.4、登录MySQL</a></li><li><a href="#35skynet_931" rel="nofollow">3.5、在skynet中操作数据库</a></li></ul> 
    </li></ul> 
    </li><li><a href="#_982" rel="nofollow">十、完毕</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h4><a id="_3"></a>一、前言</h4> 
<p>嗨，大家好，我是新发。<br> 认识我的朋友都知道我是一名<code>Unity</code>游戏开发工程师，也就是我平时做的是客户端部分的开发，其实以前我是一名服务端开发工程师，后来因为工作原因，转岗做了<code>Unity</code>客户端开发，然后就一直干到现在。<br> 最近，我在搞服务端的<code>skynet</code>框架，看看以后自己做些作品（<code>skynet</code>框架服务端+<code>Unity</code>客户端）。今天呢，我就先把<code>skynet</code>环境搞一下，讲讲流程，也方便想学习的同学，话不多说，我们开始吧~</p> 
<h4><a id="Skynet_9"></a>二、关于Skynet</h4> 
<p><code>skynet</code>是一个轻量级的网络游戏框架，也可用于许多其他领域。<br> <img src="https://images2.imgbox.com/03/b9/lxp73U2H_o.png" alt="在这里插入图片描述"></p> 
<p>建议大家看下云风的《<a href="https://blog.codingnow.com/2012/09/the_design_of_skynet.html" rel="nofollow">Skynet设计综述</a>》，这里我不过多赘述，主要讲讲操作流程~</p> 
<h4><a id="Ubuntu_15"></a>三、Ubuntu虚拟机</h4> 
<p><code>skynet</code>需要运行在<code>linux</code>或<code>macos</code>系统中，这里作为演示，我使用<code>Ubuntu</code>虚拟机。下面我讲下<code>Ubuntu</code>虚拟机的安装过程。</p> 
<h5><a id="1Ubuntu_17"></a>1、Ubuntu系统镜像下载</h5> 
<p>首先我们需要先下载<code>Ubuntu</code>系统的<code>iso</code>文件，下面这些地址都可以下载，大家选择一个即可：</p> 
<blockquote> 
 <p>网易开源镜像：<a href="http://mirrors.163.com/ubuntu-releases/" rel="nofollow">http://mirrors.163.com/ubuntu-releases/</a><br> <code>Ubuntu</code>官方：<a href="http://releases.ubuntu.com/" rel="nofollow">http://releases.ubuntu.com/</a><br> <code>Ubuntu</code>中国官网：<a href="https://ubuntu.com/download/alternative-downloads" rel="nofollow">https://ubuntu.com/download/alternative-downloads</a><br> 中科开源镜像：<a href="http://mirrors.ustc.edu.cn/ubuntu-releases/" rel="nofollow">http://mirrors.ustc.edu.cn/ubuntu-releases/</a><br> 阿里开源镜像：<a href="http://mirrors.aliyun.com/ubuntu-releases/" rel="nofollow">http://mirrors.aliyun.com/ubuntu-releases/</a><br> 浙江大学开源镜像：<a href="http://mirrors.zju.edu.cn/ubuntu-releases/" rel="nofollow">http://mirrors.zju.edu.cn/ubuntu-releases/</a></p> 
</blockquote> 
<p>我以<code>Ubuntu 16.04.7</code>版本为例，地址：<a href="http://mirrors.163.com/ubuntu-releases/16.04.7/" rel="nofollow">http://mirrors.163.com/ubuntu-releases/16.04.7/</a><br> <img src="https://images2.imgbox.com/ea/dd/8wFULMDi_o.png" alt="在这里插入图片描述"><br> 把<code>iso</code>文件下载到本地，<br> <img src="https://images2.imgbox.com/8c/85/jIMZgNyG_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="2VirtualBox_31"></a>2、VirtualBox虚拟机软件</h5> 
<p>有了<code>iso</code>文件，需要将其安装到虚拟机中，而虚拟机需要运行在虚拟机软件上，所以，我们还需要先安装一个虚拟机软件。<br> 虚拟机软件大家常用的是<code>VMWare</code>，这里我强烈推荐另一款虚拟机软件：<code>VirtualBox</code>，它轻量、开源免费，对于个人学习使用完全足够，五星推荐~</p> 
<blockquote> 
 <p><strong>关于VirtualBox</strong>：<br> <code>VirtualBox</code>是一款开源虚拟机软件。<code>VirtualBox</code>是由德国<code>Innotek</code>公司开发，由<code>Sun Microsystems</code>公司出品的软件，使用<code>Qt</code>编写，在 <code>Sun</code>被 <code>Oracle</code>收购后正式更名成 <code>Oracle VM VirtualBox</code>。<br> <code>VirtualBox</code>号称是最强的免费虚拟机软件，它不仅具有丰富的特色，而且性能也很优异！它简单易用，可虚拟的系统包括<code>Windows</code>（从<code>Windows 3.1</code>到<code>Windows 10</code>、<code>Windows Server 2012</code>，所有的<code>Windows</code>系统都支持）、<code>Mac OS X</code>、<code>Linux</code>、<code>OpenBSD</code>、<code>Solaris</code>、<code>IBM OS2</code>甚至<code>Android</code>等操作系统！使用者可以在<code>VirtualBox</code>上安装并且运行上述的这些操作系统！</p> 
</blockquote> 
<h6><a id="21VirtualBox_38"></a>2.1、VirtualBox下载</h6> 
<p><code>VirtualBox</code>我们可以从官网下载到，地址：<a href="https://www.virtualbox.org/" rel="nofollow">https://www.virtualbox.org/</a><br> <img src="https://images2.imgbox.com/c9/4c/erEZxifV_o.png" alt="在这里插入图片描述"><br> 选择<code>windows</code>版本，点击下载，<br> <img src="https://images2.imgbox.com/58/41/sce1hV4o_o.png" alt="在这里插入图片描述"></p> 
<p>下载完毕，<br> <img src="https://images2.imgbox.com/7d/83/b8l37qzn_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="22VirtualBox_46"></a>2.2、VirtualBox安装</h6> 
<p>双击安装包运行安装，过程没有什么特别的，这里不赘述~<br> 安装成功后打开<code>VirtualBox</code>，界面如下：<br> <img src="https://images2.imgbox.com/fb/26/fQJnxYk0_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="23_50"></a>2.3、创建虚拟机</h6> 
<p>点击菜单<code>控制/新建</code>，<br> <img src="https://images2.imgbox.com/77/61/yM6nBT4H_o.png" alt="在这里插入图片描述"><br> 填写虚拟机名称，设置虚拟机保存路径，如下，我设置为<code>E:\ubuntu16</code>，<br> <img src="https://images2.imgbox.com/f6/83/VpAjIf1B_o.png" alt="在这里插入图片描述"></p> 
<p>设置内存大小，建议分配<code>2G</code>内存，<br> <img src="https://images2.imgbox.com/a3/46/BNLTb5As_o.png" alt="在这里插入图片描述"></p> 
<p>创建虚拟硬盘，<br> <img src="https://images2.imgbox.com/20/7f/MjRxTAjT_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/ed/cf/iZFtbeHu_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/2a/99/QHjwAQ0Z_o.png" alt="在这里插入图片描述"></p> 
<p>建议分配<code>10G</code>的虚拟硬盘空间，<br> <img src="https://images2.imgbox.com/27/f5/HKm0AbZg_o.png" alt="在这里插入图片描述"><br> 虚拟机创建完成，如下<br> <img src="https://images2.imgbox.com/bf/7c/7MIVFYI1_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="3Ubuntu_iso_70"></a>3、载入Ubuntu iso镜像</h5> 
<p>点击启动虚拟机，会提示选择启动盘，点击下面的小按钮，<br> <img src="https://images2.imgbox.com/79/80/duRfJXrS_o.png" alt="在这里插入图片描述"><br> 点击注册，<br> <img src="https://images2.imgbox.com/49/44/IK06bLJY_o.png" alt="在这里插入图片描述"><br> 选择我们刚刚下载的<code>iso</code>系统镜像文件，打开，可以看到列表中出现了我们的镜像，选中它，<br> <img src="https://images2.imgbox.com/46/f3/x82umrj1_o.png" alt="在这里插入图片描述"><br> 点击启动，即可进入系统安装。</p> 
<h5><a id="4Ubuntu_78"></a>4、Ubuntu系统安装过程</h5> 
<p>点击<code>Install Ubuntu</code>，<br> <img src="https://images2.imgbox.com/42/7e/lN8ByPIy_o.png" alt="在这里插入图片描述"><br> 点击<code>Continue</code>，<br> <img src="https://images2.imgbox.com/57/be/XtD9hhib_o.png" alt="在这里插入图片描述"><br> 点击<code>Install Now</code>，<br> <img src="https://images2.imgbox.com/97/ec/TGiYyJsa_o.png" alt="在这里插入图片描述"><br> 此时会弹个提示框，点击<code>Continue</code>，<br> <img src="https://images2.imgbox.com/b6/57/LAmpRR8K_o.png" alt="在这里插入图片描述"><br> 时区填写<code>China Time</code>，然后点击<code>Continue</code>，<br> <img src="https://images2.imgbox.com/c8/e1/8XIG8EFK_o.png" alt="在这里插入图片描述"><br> 语言默认<code>English</code>，点击<code>Continue</code>，<br> <img src="https://images2.imgbox.com/a2/2e/TL8x69Od_o.gif" alt="请添加图片描述"><br> 接着输入账号密码，后面进入系统的时候要用到，这里提示我的密码弱（<code>Weak password</code>），由于只是自己学习使用，密码弱也没什么关系，点击<code>Continue</code>，<br> <img src="https://images2.imgbox.com/89/54/xMxiPlqP_o.png" alt="在这里插入图片描述"><br> 接着就是耐心等待它安装，<br> <img src="https://images2.imgbox.com/80/fc/wBz2tX5R_o.png" alt="在这里插入图片描述"><br> 完成后，会提示需要重启，点击<code>Restart Now</code>，<br> <img src="https://images2.imgbox.com/03/df/aQhNNxTC_o.png" alt="在这里插入图片描述"><br> 进入下面这个界面时，按一下回车键，<br> <img src="https://images2.imgbox.com/ef/32/BO4kLJYD_o.png" alt="在这里插入图片描述"><br> 输入刚刚设置的密码，<br> <img src="https://images2.imgbox.com/45/5a/EYaNVGUj_o.png" alt="在这里插入图片描述"><br> 顺利进入系统，<br> <img src="https://images2.imgbox.com/5f/9f/7mQeLZyn_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_103"></a>四、安装必要的工具</h4> 
<h5><a id="1git_104"></a>1、安装git</h5> 
<p>我们需要通过<code>git</code>来下载<code>skynet</code>，所以必须先安装<code>git</code>，我们先打开终端，如下：<br> <img src="https://images2.imgbox.com/5a/58/uj8nDZ7r_o.gif" alt="请添加图片描述"><br> 在终端输入下面的命令：（注意按回车后需要输入一次密码，并且密码不会显示出来，不要怀疑你的键盘）</p> 
<pre><code class="prism language-c">sudo apt<span class="token operator">-</span>get install git
</code></pre> 
<p>如下：<img src="https://images2.imgbox.com/67/ca/5NgURrdT_o.gif" alt="请添加图片描述"><br> 安装完毕后，输入下面的命令检查下<code>git</code>是否安装成功了，</p> 
<pre><code class="prism language-c">git <span class="token operator">--</span>version
</code></pre> 
<p>如果输出了版本号，则说明<code>git</code>已经安装成功了，<br> <img src="https://images2.imgbox.com/61/cd/LE6V6M2w_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="2autoconf_118"></a>2、安装autoconf</h5> 
<p>编译<code>skynet</code>需要用到<code>autoconf</code>，在终端输入下面的命令来安装<code>autoconf</code>，</p> 
<pre><code class="prism language-c">sudo apt<span class="token operator">-</span>get install autoconf
</code></pre> 
<p>如下：<br> <img src="https://images2.imgbox.com/56/7d/7Ax4Rf3u_o.gif" alt="请添加图片描述"><br> 安装完毕后，输入<code>autoconf --version</code>按回车，如果能输出版本号，则说明安装成功了，<br> <img src="https://images2.imgbox.com/9c/d2/9CgSqEF3_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="3gcc_128"></a>3、安装gcc</h5> 
<p>编译<code>skynet</code>需要用到<code>gcc</code>，因为<code>Ubuntu</code>默认安装了<code>gcc</code>，所以我们这里就不用重复安装了，可以在终端中输入<code>gcc --version</code>，如果能输出版本号，则说明已经安装了<code>gcc</code>，<br> <img src="https://images2.imgbox.com/0b/e3/ssoo9lpq_o.png" alt="在这里插入图片描述"><br> 如果提示没有<code>gcc</code>，则执行<code>sudo apt-get install gcc</code>进行安装即可。</p> 
<h4><a id="Skynet_133"></a>五、下载Skynet源码</h4> 
<p>在终端中执行下面的命令，</p> 
<pre><code class="prism language-c">git clone https<span class="token operator">:</span><span class="token comment">//gitee.com/mirrors/skynet.git</span>
</code></pre> 
<p>如下：<br> <img src="https://images2.imgbox.com/30/f2/9yUY945g_o.gif" alt="请添加图片描述"><br> 下载完毕后，我们打开文件夹浏览器，可以在<code>Home</code>目录中看到多了一个<code>skynet</code>文件夹，<br> <img src="https://images2.imgbox.com/2f/43/UGtpDx5P_o.gif" alt="请添加图片描述"><br> 进入<code>skynet</code>文件夹，就可以看到框架源码啦，<br> <img src="https://images2.imgbox.com/fb/bc/70PKpUVc_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="Skynet_144"></a>六、编译Skynet源码</h4> 
<p>在终端中进入<code>skynet</code>目录，</p> 
<pre><code class="prism language-c">cd skynet
</code></pre> 
<p>如下：<br> <img src="https://images2.imgbox.com/54/29/GgZPH7dt_o.png" alt="在这里插入图片描述"><br> 然后执行下面的命令：</p> 
<pre><code class="prism language-c">make linux
</code></pre> 
<p>此处你可能会报错，如下：<br> <img src="https://images2.imgbox.com/78/96/nlH3VBfO_o.png" alt="在这里插入图片描述"><br> 这是因为过程中去<code>gitub</code>下载<code>jemalloc</code>失败了，可以多试几次，编译成功后显示的输出内容如下：<br> <img src="https://images2.imgbox.com/c8/50/uA41mMvh_o.png" alt="在这里插入图片描述"><br> 我们可以在<code>skynet</code>目录中看到生成了一个可执行文件：<code>skynet</code>，如下：<br> <img src="https://images2.imgbox.com/14/57/hq9sObJa_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="Skynet_161"></a>七、运行Skynet案例</h4> 
<p>在终端中进入<code>skynet</code>目录后，执行下面的命令，</p> 
<pre><code class="prism language-c"><span class="token punctuation">.</span><span class="token operator">/</span>skynet example<span class="token operator">/</span>config
</code></pre> 
<p>如下，可以看到服务启动成功了，<br> <img src="https://images2.imgbox.com/b1/02/zOj3PPyk_o.png" alt="在这里插入图片描述"><br> 接下来，我们开启一个新的终端，<br> <img src="https://images2.imgbox.com/d9/1d/390VcTun_o.png" alt="在这里插入图片描述"><br> 运行一个客户端来测试一下，先<code>cd skynet</code>进入目录，<br> 然后执行如下命令：</p> 
<pre><code class="prism language-string">./3rd/lua/lua example/client.lua
</code></pre> 
<p>如下，每隔5秒就会给服务端发送一个<code>heartbeat</code>心跳包，<br> <img src="https://images2.imgbox.com/87/52/GRvv3QOY_o.png" alt="在这里插入图片描述"><br> 我们可以输入<code>hello</code>，服务器会回应一个<code>world</code>，如下：<br> <img src="https://images2.imgbox.com/3d/e3/SmvgugNV_o.gif" alt="请添加图片描述"></p> 
<h4><a id="Demo_179"></a>八、写个Demo</h4> 
<p>想要自己写个<code>Demo</code>，得先知道<code>skynet</code>是如何工作的。</p> 
<h5><a id="1_181"></a>1、配置文件</h5> 
<p>运行<code>skynet</code>时，需要制定一个配置文件，例：</p> 
<pre><code class="prism language-c"><span class="token punctuation">.</span><span class="token operator">/</span>skynet example<span class="token operator">/</span>config
</code></pre> 
<p>我们先看看这个<code>config</code>文件里面是啥，进入<code>examples</code>目录，打开<code>config</code>文件，<br> <img src="https://images2.imgbox.com/61/d5/WOOD5qiy_o.png" alt="在这里插入图片描述"><br> <code>config</code>文件内容如下：</p> 
<pre><code class="prism language-c">include <span class="token string">"config.path"</span>

<span class="token operator">--</span> preload <span class="token operator">=</span> <span class="token string">"./examples/preload.lua"</span>	<span class="token operator">--</span> run preload<span class="token punctuation">.</span>lua before every lua service run
thread <span class="token operator">=</span> <span class="token number">8</span>
logger <span class="token operator">=</span> nil
logpath <span class="token operator">=</span> <span class="token string">"."</span>
harbor <span class="token operator">=</span> <span class="token number">1</span>
address <span class="token operator">=</span> <span class="token string">"127.0.0.1:2526"</span>
master <span class="token operator">=</span> <span class="token string">"127.0.0.1:2013"</span>
start <span class="token operator">=</span> <span class="token string">"main"</span>	<span class="token operator">--</span> main script
bootstrap <span class="token operator">=</span> <span class="token string">"snlua bootstrap"</span>	<span class="token operator">--</span> The service <span class="token keyword">for</span> bootstrap
standalone <span class="token operator">=</span> <span class="token string">"0.0.0.0:2013"</span>
<span class="token operator">--</span> snax_interface_g <span class="token operator">=</span> <span class="token string">"snax_g"</span>
cpath <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token string">"cservice/?.so"</span>
<span class="token operator">--</span> daemon <span class="token operator">=</span> <span class="token string">"./skynet.pid"</span>
</code></pre> 
<p>第一行引用了<code>config.path</code>文件，我们打开<code>config.path</code>文件，<br> <img src="https://images2.imgbox.com/77/14/VJYnuQ8X_o.png" alt="在这里插入图片描述"><br> 内容如下：</p> 
<pre><code class="prism language-c">root <span class="token operator">=</span> <span class="token string">"./"</span>
luaservice <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token string">"service/?.lua;"</span><span class="token punctuation">.</span><span class="token punctuation">.</span>root<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token string">"test/?.lua;"</span><span class="token punctuation">.</span><span class="token punctuation">.</span>root<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token string">"examples/?.lua;"</span><span class="token punctuation">.</span><span class="token punctuation">.</span>root<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token string">"test/?/init.lua"</span>
lualoader <span class="token operator">=</span> root <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token string">"lualib/loader.lua"</span>
lua_path <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token string">"lualib/?.lua;"</span><span class="token punctuation">.</span><span class="token punctuation">.</span>root<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token string">"lualib/?/init.lua"</span>
lua_cpath <span class="token operator">=</span> root <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token string">"luaclib/?.so"</span>
snax <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token string">"examples/?.lua;"</span><span class="token punctuation">.</span><span class="token punctuation">.</span>root<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token string">"test/?.lua"</span>
</code></pre> 
<p>现在，我们把两个文件合在一起看，如下：</p> 
<pre><code class="prism language-c">root <span class="token operator">=</span> <span class="token string">"./"</span>
luaservice <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token string">"service/?.lua;"</span><span class="token punctuation">.</span><span class="token punctuation">.</span>root<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token string">"test/?.lua;"</span><span class="token punctuation">.</span><span class="token punctuation">.</span>root<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token string">"examples/?.lua;"</span><span class="token punctuation">.</span><span class="token punctuation">.</span>root<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token string">"test/?/init.lua"</span>
lualoader <span class="token operator">=</span> root <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token string">"lualib/loader.lua"</span>
lua_path <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token string">"lualib/?.lua;"</span><span class="token punctuation">.</span><span class="token punctuation">.</span>root<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token string">"lualib/?/init.lua"</span>
lua_cpath <span class="token operator">=</span> root <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token string">"luaclib/?.so"</span>
snax <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token string">"examples/?.lua;"</span><span class="token punctuation">.</span><span class="token punctuation">.</span>root<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token string">"test/?.lua"</span>

<span class="token operator">--</span> preload <span class="token operator">=</span> <span class="token string">"./examples/preload.lua"</span>	<span class="token operator">--</span> run preload<span class="token punctuation">.</span>lua before every lua service run
thread <span class="token operator">=</span> <span class="token number">8</span>
logger <span class="token operator">=</span> nil
logpath <span class="token operator">=</span> <span class="token string">"."</span>
harbor <span class="token operator">=</span> <span class="token number">1</span>
address <span class="token operator">=</span> <span class="token string">"127.0.0.1:2526"</span>
master <span class="token operator">=</span> <span class="token string">"127.0.0.1:2013"</span>
start <span class="token operator">=</span> <span class="token string">"main"</span>	<span class="token operator">--</span> main script
bootstrap <span class="token operator">=</span> <span class="token string">"snlua bootstrap"</span>	<span class="token operator">--</span> The service <span class="token keyword">for</span> bootstrap
standalone <span class="token operator">=</span> <span class="token string">"0.0.0.0:2013"</span>
<span class="token operator">--</span> snax_interface_g <span class="token operator">=</span> <span class="token string">"snax_g"</span>
cpath <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token string">"cservice/?.so"</span>
<span class="token operator">--</span> daemon <span class="token operator">=</span> <span class="token string">"./skynet.pid"</span>
</code></pre> 
<p>我这里对几个重要的参数做一下说明：</p> 
<table><thead><tr><th align="left">参数</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left"><code>luaservice</code></td><td align="left">服务脚本路径，包括<code>skynet</code>框架自带的一些服务和自己写的服务</td></tr><tr><td align="left"><code>lualoader</code></td><td align="left"><code>lua</code>脚本加载器，指定<code>skynet</code>的<code>loader.lua</code></td></tr><tr><td align="left"><code>lua_path</code></td><td align="left">程序加载<code>lua</code>脚本时，会搜索这个<code>lua_path</code>配置的路径</td></tr><tr><td align="left"><code>lua_cpath</code></td><td align="left">用<code>C</code>语言编写的程序库（<code>.so</code>文件）的路径</td></tr><tr><td align="left"><code>thread</code></td><td align="left">启用的工作线程数量，一般配置为<code>CPU</code>核心数</td></tr><tr><td align="left"><code>harbor</code></td><td align="left">主从节点模式。<code>skynet</code>初期提供了<code>master/slave</code>集群模式，后来提供了更适用的<code>cluster</code>集群模式，建议使用<code>cluster</code>模式，配<code>0</code></td></tr><tr><td align="left"><code>start</code></td><td align="left">主服务入口</td></tr><tr><td align="left"><code>cpath</code></td><td align="left">用<code>C</code>语言编写的服务模块的路径</td></tr></tbody></table> 
<p>画个图，强化记忆：<br> <img src="https://images2.imgbox.com/db/b0/PaLajKRc_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="2_253"></a>2、规范目录结构</h5> 
<p>上面介绍了配置文件，现在我们可以自己写一个配置文件啦，不过，实际项目中，一般会先规范一下目录结构，我们把根目录重命名为<code>game</code>，新建一些子文件夹：</p> 
<table><thead><tr><th align="left">文件夹</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left"><code>etc</code></td><td align="left">存放配置文件</td></tr><tr><td align="left"><code>luaclib</code></td><td align="left">存放一些<code>C</code>模块（<code>.so</code>文件）</td></tr><tr><td align="left"><code>lualib</code></td><td align="left">存放<code>lua</code>模块</td></tr><tr><td align="left"><code>service</code></td><td align="left">存放各服务的<code>lua</code>代码</td></tr><tr><td align="left"><code>skynet</code></td><td align="left">存放<code>skynet</code>框架（存放我们刚刚下载的<code>skynet</code>框架源码）</td></tr></tbody></table> 
<p>最终如下：<br> <img src="https://images2.imgbox.com/97/bf/rE4xmmnJ_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="3_268"></a>3、自己写个配置文件</h5> 
<p>我们在<code>etc</code>目录中新建一个<code>config.node1</code>配置，如下：<br> <img src="https://images2.imgbox.com/ec/df/ObGGRqKF_o.png" alt="在这里插入图片描述"><br> 因为我们把<code>skynet</code>框架源码丢在了<code>skynet</code>子目录中，所以我们配置路径的时候需要加多一层<code>skynet</code>，最终<code>config.node1</code>配置如下：</p> 
<pre><code class="prism language-c">thread <span class="token operator">=</span> <span class="token number">8</span>
cpath <span class="token operator">=</span> <span class="token string">"./skynet/cservice/?.so"</span>
bootstrap <span class="token operator">=</span> <span class="token string">"snlua bootstrap"</span>

start <span class="token operator">=</span> <span class="token string">"main"</span>
harbor <span class="token operator">=</span> <span class="token number">0</span>

lualoader <span class="token operator">=</span> <span class="token string">"./skynet/lualib/loader.lua"</span>

luaservice <span class="token operator">=</span> <span class="token string">"./service/?.lua;"</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token string">"./service/?/init.lua;"</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token string">"./skynet/service/?.lua;"</span>

lua_path <span class="token operator">=</span> <span class="token string">"./etc/?.lua;"</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token string">"./lualib/?.lua;"</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token string">"./skynet/lualib/?.lua;"</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token string">"./skynet/lualib/?/init.lua;"</span>

lua_cpath <span class="token operator">=</span> <span class="token string">"./luaclib/?.so;"</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token string">"./skynet/luaclib/?.so"</span>
</code></pre> 
<h5><a id="4_288"></a>4、主服务</h5> 
<p>上面我们配置的主服务是<code>main</code>，</p> 
<pre><code class="prism language-c">start <span class="token operator">=</span> <span class="token string">"main"</span>
</code></pre> 
<p>它会去配置的<code>luaservice</code>路径中查找一个<code>main.lua</code>脚本，</p> 
<pre><code class="prism language-c">luaservice <span class="token operator">=</span> <span class="token string">"./service/?.lua;"</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token string">"./service/?/init.lua;"</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token string">"./skynet/service/?.lua;"</span>
</code></pre> 
<p>框架会去启动这个<code>main</code>服务，我们现在还没有这个<code>main.lua</code>脚本，现在我们就来写这个<code>main.lua</code>脚本吧~</p> 
<p>进入<code>service</code>目录，创建<code>main.lua</code>脚本，代码如下：</p> 
<pre><code class="prism language-lua"><span class="token keyword">local</span> skynet <span class="token operator">=</span> require <span class="token string">"skynet"</span>
skynet<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	skynet<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[start main] hello world"</span><span class="token punctuation">)</span>
	
	<span class="token comment">-- TODO 启动其他服务</span>
	
	skynet<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">end</span><span class="token punctuation">)</span>
</code></pre> 
<p>上面我们用到了<code>skynet</code>的三个<code>API</code>，如下：<br> <img src="https://images2.imgbox.com/23/69/HxAlR4RO_o.png" alt="在这里插入图片描述"><br> 有同学会问了，明明说三个<code>API</code>，怎么列了四个，那个<code>newservice(name, ...)</code>没看到呀！<br> 因为<code>main</code>是主服务，它是由框架来启动的，所以是框架帮我们调用了<code>newservice</code>，如果我们想在主服务中启动其他服务，就要自己调用<code>newservice</code>了。</p> 
<p>现在我们测试一下，打开终端，进入<code>game</code>目录，然后执行命令：</p> 
<pre><code class="prism language-c"><span class="token punctuation">.</span><span class="token operator">/</span>skynet<span class="token operator">/</span>skynet etc<span class="token operator">/</span>config<span class="token punctuation">.</span>node1
</code></pre> 
<p>运行效果如下，可以看到<code>main.lua</code>脚本被执行了，输出了<code>[start main] hello world</code>，<br> <img src="https://images2.imgbox.com/16/1c/fGSpr3aR_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="5_321"></a>5、写个打工服务</h5> 
<p>服务脚本统一放在<code>service</code>目录中，以服务名为文件夹名字创建子目录，打工服务我们取名为<code>worker</code>，所以，我们在<code>service</code>文件夹中新建一个<code>worker</code>目录，<br> <img src="https://images2.imgbox.com/3c/83/z6rMhWZg_o.png" alt="在这里插入图片描述"><br> 进入<code>worker</code>目录，新建一个<code>init.lua</code>脚本，<br> <img src="https://images2.imgbox.com/ef/39/m9unpYLG_o.png" alt="在这里插入图片描述"><br> <code>init.lua</code>脚本需要实现服务的逻辑，<br> <img src="https://images2.imgbox.com/53/63/Z0r1IYNw_o.png" alt="在这里插入图片描述"></p> 
<p><code>init.lua</code>代码如下，</p> 
<pre><code class="prism language-lua"><span class="token comment">-- service/worker/init.lua脚本</span>

<span class="token keyword">local</span> skynet <span class="token operator">=</span> require <span class="token string">"skynet"</span>

<span class="token comment">-- 消息响应函数表</span>
<span class="token keyword">local</span> CMD <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token comment">-- 服务名</span>
<span class="token keyword">local</span> worker_name <span class="token operator">=</span> <span class="token string">""</span>
<span class="token comment">-- 服务id</span>
<span class="token keyword">local</span> worker_id <span class="token operator">=</span> <span class="token string">""</span>
<span class="token comment">-- 工钱</span>
<span class="token keyword">local</span> money <span class="token operator">=</span> <span class="token number">0</span>
<span class="token comment">-- 是否在工作</span>
<span class="token keyword">local</span> isworking <span class="token operator">=</span> <span class="token keyword">false</span>

<span class="token comment">-- 每帧调用，一帧的时间是0.2秒</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span>
    <span class="token keyword">if</span> isworking <span class="token keyword">then</span>
        money <span class="token operator">=</span> money <span class="token operator">+</span> <span class="token number">1</span>
        skynet<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>worker_name <span class="token operator">..</span> <span class="token function">tostring</span><span class="token punctuation">(</span>worker_id<span class="token punctuation">)</span> <span class="token operator">..</span> <span class="token string">", money: "</span> <span class="token operator">..</span> <span class="token function">tostring</span><span class="token punctuation">(</span>money<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment">-- 定时器，每隔0.2秒调用一次update函数</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span> stime <span class="token operator">=</span> skynet<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span> frame <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">while</span> <span class="token keyword">true</span> <span class="token keyword">do</span>
        frame <span class="token operator">=</span> frame <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token keyword">local</span> isok<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">pcall</span><span class="token punctuation">(</span>update<span class="token punctuation">,</span> frame<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> isok <span class="token keyword">then</span>
            skynet<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token keyword">end</span>
        <span class="token keyword">local</span> etime <span class="token operator">=</span> skynet<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">-- 保证0.2秒</span>
        <span class="token keyword">local</span> waittime <span class="token operator">=</span> frame <span class="token operator">*</span> <span class="token number">20</span> <span class="token operator">-</span> <span class="token punctuation">(</span>etime <span class="token operator">-</span> stime<span class="token punctuation">)</span>
        <span class="token keyword">if</span> waittime <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token keyword">then</span>
            waittime <span class="token operator">=</span> <span class="token number">2</span>
        <span class="token keyword">end</span>
        skynet<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>waittime<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>


<span class="token comment">-- 初始化</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">init</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> id<span class="token punctuation">)</span>
    worker_name <span class="token operator">=</span> name
    worker_id <span class="token operator">=</span> id
<span class="token keyword">end</span>

<span class="token comment">-- 开始工作</span>
<span class="token keyword">function</span> CMD<span class="token punctuation">.</span><span class="token function">start_work</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span>
    isworking <span class="token operator">=</span> <span class="token keyword">true</span>
<span class="token keyword">end</span>

<span class="token comment">-- 停止工作</span>
<span class="token keyword">function</span> CMD<span class="token punctuation">.</span><span class="token function">stop_work</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span>
    isworking <span class="token operator">=</span> <span class="token keyword">false</span>
<span class="token keyword">end</span>

<span class="token comment">-- 调用初始化函数，...是不定参数，会从skynet.newservice的第二个参数开始透传过来</span>
<span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">...</span><span class="token punctuation">)</span>

skynet<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">-- 消息分发</span>
    skynet<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">"lua"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>session<span class="token punctuation">,</span> source<span class="token punctuation">,</span> cmd<span class="token punctuation">,</span> <span class="token punctuation">...</span><span class="token punctuation">)</span>
    	<span class="token comment">-- 从CMD这个表中查找是否有定义响应函数，如果有，则触发响应函数</span>
        <span class="token keyword">local</span> func <span class="token operator">=</span> CMD<span class="token punctuation">[</span>cmd<span class="token punctuation">]</span>
        <span class="token keyword">if</span> func <span class="token keyword">then</span>
            <span class="token function">func</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token punctuation">...</span><span class="token punctuation">)</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span><span class="token punctuation">)</span>

	<span class="token comment">-- 启动定时器</span>
    skynet<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span>
<span class="token keyword">end</span><span class="token punctuation">)</span>
</code></pre> 
<blockquote> 
 <p>注：这里对代码说明一下，<code>timer</code>定时器函数中，<code>waittime</code>代表每次循环等待的时间，由于程序有可能会卡住，我们很难保证 “每隔0.2秒调用一次<code>update</code>” 是精确的，<code>update</code>函数本身执行也需要时间，所以等待时间是<code>0.2</code>减去执行时间，执行时间就是<code>etime - stime</code>。</p> 
</blockquote> 
<h5><a id="6_410"></a>6、在主服务中启动打工服务</h5> 
<p>我们回到主服务<code>main.lua</code>脚本中，添加一句<code>skynet.newservice</code>调用，如下：</p> 
<pre><code class="prism language-lua"><span class="token comment">-- main.lua脚本</span>

<span class="token keyword">local</span> skynet <span class="token operator">=</span> require <span class="token string">"skynet"</span>

skynet<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
    skynet<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[start main] hello world"</span><span class="token punctuation">)</span>

	<span class="token comment">-- 启动打工服务，其中第二个参数和第三个参数会透传给service/worker/init.lua脚本</span>
    <span class="token keyword">local</span> worker1 <span class="token operator">=</span> skynet<span class="token punctuation">.</span><span class="token function">newservice</span><span class="token punctuation">(</span><span class="token string">"worker"</span><span class="token punctuation">,</span> <span class="token string">"worker"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

    skynet<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">end</span><span class="token punctuation">)</span>
</code></pre> 
<p>现在我们测试一下，在<code>game</code>目录中执行命令</p> 
<pre><code class="prism language-c"><span class="token punctuation">.</span><span class="token operator">/</span>skynet<span class="token operator">/</span>skynet etc<span class="token operator">/</span>config<span class="token punctuation">.</span>node1
</code></pre> 
<p>运行效果如下，可以看到启动了一个<code>worker</code>服务，<br> <img src="https://images2.imgbox.com/e1/eb/Fhe20MEH_o.png" alt="在这里插入图片描述"><br> 有同学可能会问了，我们调用<code>skynet.newservice</code>时第一个参数是<code>worker</code>，框架怎么知道会去执行<code>service/worker/init.lua</code>脚本呢？<br> 还记得我们的<code>config.node1</code>配置吗，里面的<code>luaservice</code>我们配置了<code>"./service/?/init.lua;"</code>，如下：</p> 
<pre><code class="prism language-lua"><span class="token comment">-- config.node1配置</span>

luaservice <span class="token operator">=</span> <span class="token string">"./service/?.lua;"</span> <span class="token operator">..</span> <span class="token string">"./service/?/init.lua;"</span> <span class="token operator">..</span> <span class="token string">"./skynet/service/?.lua;"</span>
</code></pre> 
<p>其中，<code>?</code>符号会匹配服务名，也就是说，当我们调用<code>skynet.newservice("worker")</code>时，框架先去检查<code>./service/worker.lua</code>脚本是否存在，发现不存在，于是接着检查<code>./service/worker/init.lua</code>脚本，发现存在，于是执行<code>./service/worker/init.lua</code>脚本作为<code>worker</code>服务，当然，如果找不到，它就会去检查<code>./skynet/service/worker.lua</code>是否存在了。</p> 
<p>另外，<code>newservice</code>的函数原型是<code>newservice(name, ...)</code>，我们调用<code>skynet.newservice</code>时可以透传一些参数给服务，比如我们上面的</p> 
<pre><code class="prism language-lua"><span class="token comment">-- main.lua脚本</span>

<span class="token keyword">local</span> worker1 <span class="token operator">=</span> skynet<span class="token punctuation">.</span><span class="token function">newservice</span><span class="token punctuation">(</span><span class="token string">"worker"</span><span class="token punctuation">,</span> <span class="token string">"worker"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> 
<p>第二个参数和第三个参数就会透传给<code>init.lua</code>脚本，我们在<code>init.lua</code>脚本中可以取出来缓存起来，如下：</p> 
<pre><code class="prism language-lua"><span class="token comment">-- service/worker/init.lua脚本</span>

<span class="token comment">-- 服务名</span>
<span class="token keyword">local</span> worker_name <span class="token operator">=</span> <span class="token string">""</span>
<span class="token comment">-- 服务id</span>
<span class="token keyword">local</span> worker_id <span class="token operator">=</span> <span class="token string">""</span>

<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">init</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> id<span class="token punctuation">)</span>
    worker_name <span class="token operator">=</span> name
    worker_id <span class="token operator">=</span> id
<span class="token keyword">end</span>

<span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">...</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="7_467"></a>7、在主服务中给打工服务发消息</h5> 
<p>打工服务中我们定义了两个消息：<code>start_work</code>和<code>stop_work</code>，现在我们在主服务中给打工服务发送消息，添加<code>skynet.send</code>调用，如下：</p> 
<pre><code class="prism language-lua"><span class="token keyword">local</span> skynet <span class="token operator">=</span> require <span class="token string">"skynet"</span>

skynet<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
    skynet<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[start main] hello world"</span><span class="token punctuation">)</span>
	<span class="token comment">-- 启动打工服务，其中第二个参数和第三个参数会透传给service/worker/init.lua脚本</span>
    <span class="token keyword">local</span> worker1 <span class="token operator">=</span> skynet<span class="token punctuation">.</span><span class="token function">newservice</span><span class="token punctuation">(</span><span class="token string">"worker"</span><span class="token punctuation">,</span> <span class="token string">"worker"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment">-- 开始工作</span>
    skynet<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>worker1<span class="token punctuation">,</span> <span class="token string">"lua"</span><span class="token punctuation">,</span> <span class="token string">"start_work"</span><span class="token punctuation">)</span>
	<span class="token comment">-- 主服务休息2秒，注意，这里是主服务休息2秒，并不会卡住worker服务</span>
    skynet<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
    <span class="token comment">-- 停止工作</span>
    skynet<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>worker1<span class="token punctuation">,</span> <span class="token string">"lua"</span><span class="token punctuation">,</span> <span class="token string">"stop_work"</span><span class="token punctuation">)</span>
    
    skynet<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">end</span><span class="token punctuation">)</span>
</code></pre> 
<p>我们再次执行命令</p> 
<pre><code class="prism language-c"><span class="token punctuation">.</span><span class="token operator">/</span>skynet<span class="token operator">/</span>skynet etc<span class="token operator">/</span>config<span class="token punctuation">.</span>node1
</code></pre> 
<p>运行效果如下，可以看到打工服务开始工作了，<code>2秒</code>赚了<code>10</code>块钱~<br> <img src="https://images2.imgbox.com/ad/cd/CLILfhtx_o.gif" alt="请添加图片描述"></p> 
<h5><a id="8_494"></a>8、封装服务类</h5> 
<p>假设我们现在要再写一个买猫粮的服务，这个时候，可以按照上面的打工服务写一个服务。事实上，每个服务都有一些通用的变量和方法，我们可以封装一个<code>service</code>类，方便复用减少代码量。<br> 我们在<code>lualib</code>目录中新建一个<code>service.lua</code>脚本，<br> <img src="https://images2.imgbox.com/75/bc/8poME0Yp_o.png" alt="在这里插入图片描述"><br> <code>service.lua</code>代码如下，</p> 
<pre><code class="prism language-lua"><span class="token keyword">local</span> skynet <span class="token operator">=</span> require <span class="token string">"skynet"</span>
<span class="token keyword">local</span> cluster <span class="token operator">=</span> require <span class="token string">"skynet.cluster"</span>

<span class="token comment">-- 封装服务类</span>
<span class="token keyword">local</span> M <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">-- 服务名</span>
    name <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token comment">-- 服务id</span>
    id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token comment">-- 退出</span>
    exit <span class="token operator">=</span> <span class="token keyword">nil</span><span class="token punctuation">,</span>
    <span class="token comment">-- 初始化</span>
    init <span class="token operator">=</span> <span class="token keyword">nil</span><span class="token punctuation">,</span>
    <span class="token comment">-- 消息响应函数表</span>
    resp <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">-- 输出堆栈</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">tracback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    skynet<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token function">tostring</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span>
    skynet<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>debug<span class="token punctuation">.</span><span class="token function">traceback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token comment">-- 消息分发</span>
<span class="token keyword">local</span> dispatch <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>session<span class="token punctuation">,</span> address<span class="token punctuation">,</span> cmd<span class="token punctuation">,</span> <span class="token punctuation">...</span><span class="token punctuation">)</span>
	<span class="token comment">-- 从resp表中查找是否存在消息的响应函数</span>
    <span class="token keyword">local</span> func <span class="token operator">=</span> M<span class="token punctuation">.</span>resp<span class="token punctuation">[</span>cmd<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> func <span class="token keyword">then</span>
        skynet<span class="token punctuation">.</span><span class="token function">ret</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token keyword">end</span>
	<span class="token comment">-- 调用响应函数</span>
    <span class="token keyword">local</span> ret <span class="token operator">=</span> table<span class="token punctuation">.</span><span class="token function">pack</span><span class="token punctuation">(</span><span class="token function">xpcall</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> tracback<span class="token punctuation">,</span> address<span class="token punctuation">,</span> <span class="token punctuation">...</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span> isok <span class="token operator">=</span> ret<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>

    <span class="token keyword">if</span> <span class="token keyword">not</span> isok <span class="token keyword">then</span>
        skynet<span class="token punctuation">.</span><span class="token function">ret</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token keyword">end</span>

    skynet<span class="token punctuation">.</span><span class="token function">retpack</span><span class="token punctuation">(</span>table<span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span>ret<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token comment">-- 初始化</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    skynet<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>M<span class="token punctuation">.</span>name <span class="token operator">..</span> <span class="token string">" "</span> <span class="token operator">..</span> M<span class="token punctuation">.</span>id <span class="token operator">..</span> <span class="token string">" init"</span><span class="token punctuation">)</span>
    skynet<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">"lua"</span><span class="token punctuation">,</span> dispatch<span class="token punctuation">)</span>
    <span class="token keyword">if</span> M<span class="token punctuation">.</span>init <span class="token keyword">then</span>
        M<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment">-- 启动服务</span>
<span class="token keyword">function</span> M<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> id<span class="token punctuation">,</span> <span class="token punctuation">...</span><span class="token punctuation">)</span>
    M<span class="token punctuation">.</span>name <span class="token operator">=</span> name
    M<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token function">tonumber</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
    skynet<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>init<span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token keyword">return</span> M
</code></pre> 
<h5><a id="9_561"></a>9、重写打工服务</h5> 
<p>有了<code>service</code>类，我们写服务的时候，只需要按下面这个模板写就可以了，</p> 
<pre><code class="prism language-lua"><span class="token keyword">local</span> skynet <span class="token operator">=</span> require <span class="token string">"skynet"</span>
<span class="token keyword">local</span> s <span class="token operator">=</span> require <span class="token string">"service"</span>

s<span class="token punctuation">.</span>init <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">-- 初始化</span>
<span class="token keyword">end</span>

s<span class="token punctuation">.</span>resp<span class="token punctuation">.</span>协议<span class="token number">1</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token punctuation">...</span><span class="token punctuation">)</span>
	<span class="token comment">-- TODO</span>
<span class="token keyword">end</span>

s<span class="token punctuation">.</span>resp<span class="token punctuation">.</span>协议<span class="token number">2</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token punctuation">...</span><span class="token punctuation">)</span>
	<span class="token comment">-- TODO</span>
<span class="token keyword">end</span>

s<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">...</span><span class="token punctuation">)</span>
</code></pre> 
<p>现在，我们重新写一下打工服务，改造后代码如下，我们后面新写服务也按照这个格式来写，统一，方便维护，</p> 
<pre><code class="prism language-lua"><span class="token keyword">local</span> skynet <span class="token operator">=</span> require <span class="token string">"skynet"</span>
<span class="token keyword">local</span> s <span class="token operator">=</span> require <span class="token string">"service"</span>

s<span class="token punctuation">.</span>money <span class="token operator">=</span> <span class="token number">0</span>
s<span class="token punctuation">.</span>isworking <span class="token operator">=</span> <span class="token keyword">false</span>

s<span class="token punctuation">.</span>update <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span>
    <span class="token keyword">if</span> s<span class="token punctuation">.</span>isworking <span class="token keyword">then</span>
        s<span class="token punctuation">.</span>money <span class="token operator">=</span> s<span class="token punctuation">.</span>money <span class="token operator">+</span> <span class="token number">1</span>
        skynet<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>name <span class="token operator">..</span> <span class="token function">tostring</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token operator">..</span> <span class="token string">", money: "</span> <span class="token operator">..</span> <span class="token function">tostring</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>money<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

s<span class="token punctuation">.</span>init <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
    skynet<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>timer<span class="token punctuation">)</span>
<span class="token keyword">end</span>

s<span class="token punctuation">.</span>timer <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span> stime <span class="token operator">=</span> skynet<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span> frame <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">while</span> <span class="token keyword">true</span> <span class="token keyword">do</span>
        frame <span class="token operator">=</span> frame <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token keyword">local</span> isok<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">pcall</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>update<span class="token punctuation">,</span> frame<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> isok <span class="token keyword">then</span>
            skynet<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token keyword">end</span>
        <span class="token keyword">local</span> etime <span class="token operator">=</span> skynet<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">local</span> waittime <span class="token operator">=</span> frame <span class="token operator">*</span> <span class="token number">20</span> <span class="token operator">-</span> <span class="token punctuation">(</span>etime <span class="token operator">-</span> stime<span class="token punctuation">)</span>
        <span class="token keyword">if</span> waittime <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token keyword">then</span>
            waittime <span class="token operator">=</span> <span class="token number">2</span>
        <span class="token keyword">end</span>
        skynet<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>waittime<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>


s<span class="token punctuation">.</span>resp<span class="token punctuation">.</span>start_work <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>isworking <span class="token operator">=</span> <span class="token keyword">true</span>
<span class="token keyword">end</span>

s<span class="token punctuation">.</span>resp<span class="token punctuation">.</span>stop_work <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>isworking <span class="token operator">=</span> <span class="token keyword">false</span>
<span class="token keyword">end</span>

s<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">...</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="10_630"></a>10、买猫粮服务</h5> 
<p>打工挣钱，有了钱我们就可以买猫粮啦，我们来写一个买猫粮的服务脚本。<br> 我们在<code>service</code>文件夹中新建一个<code>buy</code>文件夹，如下，<br> <img src="https://images2.imgbox.com/bd/4a/t5Ib0fWx_o.png" alt="在这里插入图片描述"><br> 进入<code>buy</code>目录，然后创建一个<code>init.lua</code>脚本，<br> <img src="https://images2.imgbox.com/85/45/jmfXBwv5_o.png" alt="在这里插入图片描述"><br> 代码如下：</p> 
<pre><code class="prism language-lua"><span class="token comment">-- service/buy/init.lua脚本</span>

<span class="token keyword">local</span> skynet <span class="token operator">=</span> require <span class="token string">"skynet"</span>
<span class="token keyword">local</span> s <span class="token operator">=</span> require <span class="token string">"service"</span>

s<span class="token punctuation">.</span>cat_food_price <span class="token operator">=</span> <span class="token number">5</span>
s<span class="token punctuation">.</span>cat_food_cnt <span class="token operator">=</span> <span class="token number">0</span>

s<span class="token punctuation">.</span>resp<span class="token punctuation">.</span>buy <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>source<span class="token punctuation">)</span>
	<span class="token comment">-- 先扣费</span>
	<span class="token keyword">local</span> left_money <span class="token operator">=</span> skynet<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">"worker1"</span><span class="token punctuation">,</span> <span class="token string">"lua"</span><span class="token punctuation">,</span> <span class="token string">"change_money"</span><span class="token punctuation">,</span> <span class="token operator">-</span>s<span class="token punctuation">.</span>cat_food_price<span class="token punctuation">)</span>
    <span class="token keyword">if</span> left_money <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token keyword">then</span>
        s<span class="token punctuation">.</span>cat_food_cnt <span class="token operator">=</span> s<span class="token punctuation">.</span>cat_food_cnt <span class="token operator">+</span> <span class="token number">1</span>
        skynet<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"buy cat food ok, current cnt: "</span> <span class="token operator">..</span> <span class="token function">tostring</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>cat_food_cnt<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">true</span>
    <span class="token keyword">end</span>
    <span class="token comment">-- 购买失败，把钱加回去</span>
    skynet<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"buy failed, money not enough"</span><span class="token punctuation">)</span>
    skynet<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">"worker1"</span><span class="token punctuation">,</span> <span class="token string">"lua"</span><span class="token punctuation">,</span> <span class="token string">"change_money"</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>cat_food_price<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">false</span>
<span class="token keyword">end</span>

s<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">...</span><span class="token punctuation">)</span>
</code></pre> 
<p>然后我们给打工服务加多一个消息，</p> 
<pre><code class="prism language-lua"><span class="token comment">-- service/worker/init.lua脚本</span>

s<span class="token punctuation">.</span>resp<span class="token punctuation">.</span>change_money <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> delta<span class="token punctuation">)</span>
	s<span class="token punctuation">.</span>money <span class="token operator">=</span> s<span class="token punctuation">.</span>money <span class="token operator">+</span> delta
	<span class="token keyword">return</span> s<span class="token punctuation">.</span>money
<span class="token keyword">end</span>
</code></pre> 
<p>最后，在主服务中加上买猫粮服务的启动和消息发送，如下：</p> 
<pre><code class="prism language-lua"><span class="token keyword">local</span> skynet <span class="token operator">=</span> require <span class="token string">"skynet"</span>

skynet<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
    skynet<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[start main] hello world"</span><span class="token punctuation">)</span>
	<span class="token comment">-- 启动打工服务</span>
    <span class="token keyword">local</span> worker1 <span class="token operator">=</span> skynet<span class="token punctuation">.</span><span class="token function">newservice</span><span class="token punctuation">(</span><span class="token string">"worker"</span><span class="token punctuation">,</span> <span class="token string">"worker"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment">-- 启动买猫粮服务</span>
    <span class="token keyword">local</span> buy1 <span class="token operator">=</span> skynet<span class="token punctuation">.</span><span class="token function">newservice</span><span class="token punctuation">(</span><span class="token string">"buy"</span><span class="token punctuation">,</span> <span class="token string">"buy"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

	<span class="token comment">-- 开始打工</span>
    skynet<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>worker1<span class="token punctuation">,</span> <span class="token string">"lua"</span><span class="token punctuation">,</span> <span class="token string">"start_work"</span><span class="token punctuation">)</span>
    skynet<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
    <span class="token comment">-- 结束打工</span>
    skynet<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>worker1<span class="token punctuation">,</span> <span class="token string">"lua"</span><span class="token punctuation">,</span> <span class="token string">"stop_work"</span><span class="token punctuation">)</span>

    <span class="token comment">-- 买猫粮</span>
    skynet<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>buy1<span class="token punctuation">,</span> <span class="token string">"lua"</span><span class="token punctuation">,</span> <span class="token string">"buy"</span><span class="token punctuation">)</span>
    
    <span class="token comment">-- 退出主服务</span>
    skynet<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">end</span><span class="token punctuation">)</span>
</code></pre> 
<p>好啦，现在我们测试一下，运行效果如下：<br> <img src="https://images2.imgbox.com/04/d9/F4MqFoY0_o.gif" alt="请添加图片描述"><br> 可以看到，最后买猫粮成功啦~<br> <img src="https://images2.imgbox.com/bc/56/xGM8Qqw6_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_699"></a>九、补充</h4> 
<h5><a id="1_700"></a>1、网络模块</h5> 
<p>写服务端，肯定需要涉及到网络模块，需要用到<code>skynet.socket</code>，案例：</p> 
<pre><code class="prism language-lua"><span class="token comment">-- main.lua</span>

<span class="token keyword">local</span> skynet <span class="token operator">=</span> require <span class="token string">"skynet"</span>
<span class="token keyword">local</span> socket <span class="token operator">=</span> require <span class="token string">"skynet.socket"</span>

<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">on_connect</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> addr<span class="token punctuation">)</span>
	socket<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span>
	<span class="token keyword">while</span> <span class="token keyword">true</span> <span class="token keyword">do</span>
		<span class="token keyword">local</span> readdata <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span>
		<span class="token keyword">if</span> readdata <span class="token keyword">then</span>
			<span class="token comment">-- TODO 处理消息</span>
			
			<span class="token comment">-- 回应客户端，把readdata返回给客户端</span>
			<span class="token comment">-- socket.write(fd, "server get data: " .. readdata)</span>
		<span class="token keyword">else</span>
			<span class="token comment">-- 连接断开了</span>
			socket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span>
		<span class="token keyword">end</span>
	<span class="token keyword">end</span>
<span class="token keyword">end</span>

skynet<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">local</span> listenfd <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span> <span class="token number">8888</span><span class="token punctuation">)</span>
	socket<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> on_connect<span class="token punctuation">)</span>
<span class="token keyword">end</span><span class="token punctuation">)</span>
</code></pre> 
<p>如果要写一个多人聊天功能的话，只需要把消息广播出去即可，例：</p> 
<pre><code class="prism language-lua"><span class="token comment">-- main.lua</span>

<span class="token keyword">local</span> skynet <span class="token operator">=</span> require <span class="token string">"skynet"</span>
<span class="token keyword">local</span> socket <span class="token operator">=</span> require <span class="token string">"skynet.socket"</span>

<span class="token keyword">local</span> clients <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">on_connect</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> addr<span class="token punctuation">)</span>
	clients<span class="token punctuation">[</span>fd<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
	socket<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span>
	<span class="token keyword">while</span> <span class="token keyword">true</span> <span class="token keyword">do</span>
		<span class="token keyword">local</span> readdata <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span>
		<span class="token keyword">if</span> readdata <span class="token keyword">then</span>
			<span class="token comment">-- 广播</span>
			<span class="token keyword">for</span> client_fd<span class="token punctuation">,</span> _ <span class="token keyword">in</span> <span class="token function">pairs</span><span class="token punctuation">(</span>clients<span class="token punctuation">)</span> <span class="token keyword">do</span>
				socket<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>client_fd<span class="token punctuation">,</span> readdata<span class="token punctuation">)</span>
			<span class="token keyword">end</span> 
		<span class="token keyword">else</span>
			<span class="token comment">-- 连接断开了</span>
			socket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span>
			clients<span class="token punctuation">[</span>fd<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">nil</span>
		<span class="token keyword">end</span>
	<span class="token keyword">end</span>
<span class="token keyword">end</span>

skynet<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">local</span> listenfd <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span> <span class="token number">8888</span><span class="token punctuation">)</span>
	socket<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> on_connect<span class="token punctuation">)</span>
<span class="token keyword">end</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="2_761"></a>2、节点集群</h5> 
<p>我上面写的打工赚钱买猫粮，都在同一个节点中，<br> <img src="https://images2.imgbox.com/b7/93/JkhIik2N_o.png" alt="在这里插入图片描述"></p> 
<p>实际项目中，可能会开启多个节点，两个服务如果在同一个节点中，则通过<code>skynet.send</code>或<code>skynet.call</code>来传递消息，</p> 
<blockquote> 
 <p>注：<code>send</code>是发送消息，不会阻塞调用方；<code>call</code>是阻塞调用。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/2b/10/VY7t2ct5_o.png" alt="在这里插入图片描述"></p> 
<p>如果在不同的节点中，则需要使用<code>cluster.send</code>或<code>cluster.call</code>，</p> 
<blockquote> 
 <p>注：<code>send</code>是发送消息，不会阻塞调用方；<code>call</code>是阻塞调用。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/6d/2c/nBu7rGsk_o.png" alt="在这里插入图片描述"></p> 
<p>对此，我们可以优化一下上文中的<code>service.lua</code>，封装<code>send</code>和<code>call</code>方法，</p> 
<pre><code class="prism language-lua"><span class="token comment">-- lualib/service.lua</span>

<span class="token keyword">local</span> cluster <span class="token operator">=</span> require <span class="token string">"skynet.cluster"</span>

<span class="token punctuation">...</span>

<span class="token keyword">function</span> M<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> srv<span class="token punctuation">,</span> <span class="token punctuation">...</span><span class="token punctuation">)</span>
	<span class="token keyword">local</span> mynode <span class="token operator">=</span> skynet<span class="token punctuation">.</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"node"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> node <span class="token operator">==</span> mynode <span class="token keyword">then</span>	
		<span class="token keyword">return</span> skynet<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>srv<span class="token punctuation">,</span> <span class="token string">"lua"</span><span class="token punctuation">,</span> <span class="token punctuation">...</span><span class="token punctuation">)</span>
	<span class="token keyword">else</span>
		<span class="token keyword">return</span> cluster<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> srv<span class="token punctuation">,</span> <span class="token punctuation">...</span><span class="token punctuation">)</span>
	<span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token keyword">function</span> M<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> srv<span class="token punctuation">,</span> <span class="token punctuation">...</span><span class="token punctuation">)</span>
	<span class="token keyword">local</span> mynode <span class="token operator">=</span> skynet<span class="token punctuation">.</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"node"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> node <span class="token operator">==</span> mynode <span class="token keyword">then</span>	
		<span class="token keyword">return</span> skynet<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>srv<span class="token punctuation">,</span> <span class="token string">"lua"</span><span class="token punctuation">,</span> <span class="token punctuation">...</span><span class="token punctuation">)</span>
	<span class="token keyword">else</span>
		<span class="token keyword">return</span> cluster<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> srv<span class="token punctuation">,</span> <span class="token punctuation">...</span><span class="token punctuation">)</span>
	<span class="token keyword">end</span>
<span class="token keyword">end</span>
</code></pre> 
<p>我们在<code>etc/config.node1</code>的末尾加多一行</p> 
<pre><code class="prism language-c">node <span class="token operator">=</span> <span class="token string">"node1"</span>
</code></pre> 
<p>拷贝一份，重命名为<code>config.node2</code>，把末尾一行改为</p> 
<pre><code class="prism language-c">node <span class="token operator">=</span> <span class="token string">"node2"</span>
</code></pre> 
<p>然后，我们改下<code>main.lua</code>脚本，让它在<code>node1</code>节点开启打工服务，在<code>node2</code>节点开启买猫粮节点，最终<code>main.lua</code>脚本如下：</p> 
<pre><code class="prism language-lua"><span class="token keyword">local</span> skynet <span class="token operator">=</span> require <span class="token string">"skynet"</span>
<span class="token keyword">local</span> cluster <span class="token operator">=</span> require <span class="token string">"skynet.cluster"</span>
require <span class="token string">"skynet.manager"</span>

skynet<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
    skynet<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[start main] hello world"</span><span class="token punctuation">)</span>

	<span class="token comment">-- 集群配置</span>
    cluster<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        node1 <span class="token operator">=</span> <span class="token string">"127.0.0.1:7001"</span><span class="token punctuation">,</span>
        node2 <span class="token operator">=</span> <span class="token string">"127.0.0.1:7002"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">local</span> mynode <span class="token operator">=</span> skynet<span class="token punctuation">.</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"node"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token string">"node1"</span> <span class="token operator">==</span> mynode <span class="token keyword">then</span>
    	<span class="token comment">-- 启动集群节点</span>
        cluster<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"node1"</span><span class="token punctuation">)</span>
        <span class="token comment">-- node1节点，开启打工服务</span>
        <span class="token keyword">local</span> worker1 <span class="token operator">=</span> skynet<span class="token punctuation">.</span><span class="token function">newservice</span><span class="token punctuation">(</span><span class="token string">"worker"</span><span class="token punctuation">,</span> <span class="token string">"worker"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        skynet<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">"worker1"</span><span class="token punctuation">,</span> worker1<span class="token punctuation">)</span>
        skynet<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>worker1<span class="token punctuation">,</span> <span class="token string">"lua"</span><span class="token punctuation">,</span> <span class="token string">"start_work"</span><span class="token punctuation">)</span>
        skynet<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
        skynet<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>worker1<span class="token punctuation">,</span> <span class="token string">"lua"</span><span class="token punctuation">,</span> <span class="token string">"stop_work"</span><span class="token punctuation">)</span>
    <span class="token keyword">elseif</span> <span class="token string">"node2"</span> <span class="token operator">==</span> mynode <span class="token keyword">then</span>
    	<span class="token comment">-- 启动集群节点</span>
        cluster<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"node2"</span><span class="token punctuation">)</span>
        <span class="token comment">-- node2节点，开启买猫粮服务</span>
        <span class="token keyword">local</span> buy1 <span class="token operator">=</span> skynet<span class="token punctuation">.</span><span class="token function">newservice</span><span class="token punctuation">(</span><span class="token string">"buy"</span><span class="token punctuation">,</span> <span class="token string">"buy"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment">-- 请求买猫粮，买三次</span>
        skynet<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>buy1<span class="token punctuation">,</span> <span class="token string">"lua"</span><span class="token punctuation">,</span> <span class="token string">"buy"</span><span class="token punctuation">)</span>
        skynet<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>buy1<span class="token punctuation">,</span> <span class="token string">"lua"</span><span class="token punctuation">,</span> <span class="token string">"buy"</span><span class="token punctuation">)</span>
        skynet<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>buy1<span class="token punctuation">,</span> <span class="token string">"lua"</span><span class="token punctuation">,</span> <span class="token string">"buy"</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>

    skynet<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">end</span><span class="token punctuation">)</span>
</code></pre> 
<p>最后，我们改下<code>buy/init.lua</code>脚本，把<code>skynet.call</code>改成<code>s.call</code>，如下：</p> 
<pre><code class="prism language-lua"><span class="token keyword">local</span> skynet <span class="token operator">=</span> require <span class="token string">"skynet"</span>
<span class="token keyword">local</span> s <span class="token operator">=</span> require <span class="token string">"service"</span>

s<span class="token punctuation">.</span>cat_food_price <span class="token operator">=</span> <span class="token number">5</span>
s<span class="token punctuation">.</span>cat_food_cnt <span class="token operator">=</span> <span class="token number">0</span>

s<span class="token punctuation">.</span>resp<span class="token punctuation">.</span>buy <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>source<span class="token punctuation">)</span>

    <span class="token keyword">local</span> left_money <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">"node1"</span><span class="token punctuation">,</span> <span class="token string">"worker1"</span><span class="token punctuation">,</span> <span class="token string">"change_money"</span><span class="token punctuation">,</span> <span class="token operator">-</span>s<span class="token punctuation">.</span>cat_food_price<span class="token punctuation">)</span>

    <span class="token keyword">if</span> left_money <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token keyword">then</span>
        s<span class="token punctuation">.</span>cat_food_cnt <span class="token operator">=</span> s<span class="token punctuation">.</span>cat_food_cnt <span class="token operator">+</span> <span class="token number">1</span>
        skynet<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"buy cat food ok, current cnt: "</span> <span class="token operator">..</span> <span class="token function">tostring</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>cat_food_cnt<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">true</span>
    <span class="token keyword">end</span>
    skynet<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"buy cat food failed, money not enough"</span><span class="token punctuation">)</span>
    s<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">"node1"</span><span class="token punctuation">,</span> <span class="token string">"worker1"</span><span class="token punctuation">,</span> <span class="token string">"change_money"</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>cat_food_price<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">false</span>
<span class="token keyword">end</span>

s<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">...</span><span class="token punctuation">)</span>

</code></pre> 
<p>好了，现在我们先开启<code>节点1</code>，在终端执行命令</p> 
<pre><code class="prism language-c"><span class="token punctuation">.</span><span class="token operator">/</span>skynet<span class="token operator">/</span>skynet etc<span class="token operator">/</span>config<span class="token punctuation">.</span>node1
</code></pre> 
<p>可以看到<code>节点1</code>开启了打工服务，赚了<code>10块钱</code>，</p> 
<p><img src="https://images2.imgbox.com/e6/aa/ZLR1P5lw_o.gif" alt="请添加图片描述"><br> 现在我们开启<code>节点2</code>，在终端执行命令</p> 
<pre><code class="prism language-c"><span class="token punctuation">.</span><span class="token operator">/</span>skynet<span class="token operator">/</span>skynet etc<span class="token operator">/</span>config<span class="token punctuation">.</span>node2
</code></pre> 
<p>因为猫粮价格是<code>5块钱</code>一包，所以只能买两次，执行结果如下，可以看到第三次买猫粮失败，因为钱不够了，<br> <img src="https://images2.imgbox.com/c8/91/YrEb03Pj_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="3_888"></a>3、数据库模块</h5> 
<h6><a id="31MySQL_889"></a>3.1、安装MySQL</h6> 
<p>在终端执行命令</p> 
<pre><code class="prism language-c">sudo apt<span class="token operator">-</span>get install mysql<span class="token operator">-</span>server
</code></pre> 
<p>执行过程中会弹出框让你输入<code>MySQL</code>的<code>root</code>账号的密码，如下，需要输入两次，<br> <img src="https://images2.imgbox.com/a4/e1/dXz7VEZ3_o.png" alt="在这里插入图片描述"><br> 安装完毕后，执行<code>mysql --version</code>，如果输出版本号，则说明安装成功了，<br> <img src="https://images2.imgbox.com/73/16/JjX6ElLu_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="32MySQL_898"></a>3.2、启动MySQL</h6> 
<p>在终端执行命令</p> 
<pre><code class="prism language-c">service mysql start
</code></pre> 
<p>此时会弹出一个框，注意此处输入<code>Ubuntu</code>的开机密码，而不是<code>MySQL</code>的<code>root</code>账号密码哦，点击<code>Authenticate</code>，<br> <img src="https://images2.imgbox.com/05/af/ZTexA72x_o.png" alt="在这里插入图片描述"><br> 启动成功后，我们可以通过下面的命令看是否有<code>mysql</code>的进程，</p> 
<pre><code class="prism language-c">ps <span class="token operator">-</span>axj <span class="token operator">|</span>grep mysql
</code></pre> 
<p>可以看到有<code>mysql</code>进程，说明<code>MySQL</code>服务已经成功启动了，<br> <img src="https://images2.imgbox.com/0a/1f/i2ZOy3Wz_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="33MySQL_911"></a>3.3、关闭MySQL</h6> 
<p>在终端执行命令</p> 
<pre><code class="prism language-c">service mysql stop
</code></pre> 
<p>此时会弹出一个框，此处输入<code>Ubuntu</code>的开机密码，点击<code>Authenticate</code>，<br> <img src="https://images2.imgbox.com/6c/70/bqEd74If_o.png" alt="在这里插入图片描述"><br> 执行完毕后，同理，我们可以通过下面的命令查看是否已经没有<code>mysql</code>进程了，</p> 
<pre><code class="prism language-c">ps <span class="token operator">-</span>axj <span class="token operator">|</span>grep mysql
</code></pre> 
<h6><a id="34MySQL_922"></a>3.4、登录MySQL</h6> 
<p>在终端执行命令</p> 
<pre><code class="prism language-c">mysql <span class="token operator">-</span>h127<span class="token punctuation">.</span><span class="token number">0.0</span><span class="token number">.1</span> <span class="token operator">-</span>uroot <span class="token operator">-</span>p你的密码
</code></pre> 
<p>如下，登录成功，<br> <img src="https://images2.imgbox.com/f1/c3/6iLLhvme_o.png" alt="在这里插入图片描述"><br> 现在我们可以愉快地使用<code>mysql</code>啦，执行<code>show databases;</code>，查看所有的数据库<br> <img src="https://images2.imgbox.com/66/75/tmXPSMno_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="35skynet_931"></a>3.5、在skynet中操作数据库</h6> 
<p>我们先在终端手动创建一个数据库，</p> 
<pre><code class="prism language-c">create database test_db<span class="token punctuation">;</span>
</code></pre> 
<p>如下,<br> <img src="https://images2.imgbox.com/83/9d/cHGrmJfx_o.png" alt="在这里插入图片描述"><br> 选择<code>test_db</code>，<br> <img src="https://images2.imgbox.com/a0/46/B46YV66x_o.png" alt="在这里插入图片描述"><br> 接着再创建一个表，</p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> users <span class="token punctuation">(</span>
	id <span class="token keyword">int</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
	name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	<span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>如下：<br> <img src="https://images2.imgbox.com/09/03/vNGYCgCZ_o.png" alt="在这里插入图片描述"><br> 好了，现在我们在<code>skynet</code>中来操作数据库吧，例：</p> 
<pre><code class="prism language-lua"><span class="token keyword">local</span> skynet <span class="token operator">=</span> require <span class="token string">"skynet"</span>
<span class="token keyword">local</span> mysql <span class="token operator">=</span> require <span class="token string">"skynet.db.mysql"</span>


skynet<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
    skynet<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[start main] hello world"</span><span class="token punctuation">)</span>

    <span class="token keyword">local</span> db <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>
        <span class="token punctuation">{<!-- --></span>
            host <span class="token operator">=</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span>
            port <span class="token operator">=</span> <span class="token number">3306</span><span class="token punctuation">,</span>
            database <span class="token operator">=</span> <span class="token string">"test_db"</span><span class="token punctuation">,</span>
            user <span class="token operator">=</span> <span class="token string">"root"</span><span class="token punctuation">,</span>
            password <span class="token operator">=</span> <span class="token string">"123456"</span><span class="token punctuation">,</span>
            max_packet_size <span class="token operator">=</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span>
            on_connect <span class="token operator">=</span> <span class="token keyword">nil</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
	<span class="token comment">-- 插入数据</span>
    <span class="token keyword">local</span> res <span class="token operator">=</span> db<span class="token punctuation">:</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"insert into users(name) values (\'linxinfa\')"</span><span class="token punctuation">)</span>
    <span class="token comment">-- 查询数据</span>
    res <span class="token operator">=</span> db<span class="token punctuation">:</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'select * from users'</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> v <span class="token keyword">in</span> <span class="token function">pairs</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token keyword">do</span>
        <span class="token function">print</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token string">" "</span> <span class="token operator">..</span> v<span class="token punctuation">.</span>id <span class="token operator">..</span> <span class="token string">" "</span> <span class="token operator">..</span> v<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token keyword">end</span>

    skynet<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">end</span><span class="token punctuation">)</span>
</code></pre> 
<p>我们执行两次，结果如下，可以看到，数据正常写入到数据库中了，成功~<br> <img src="https://images2.imgbox.com/ea/a1/ZkakjYpO_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_982"></a>十、完毕</h4> 
<p>好了，就先写这么多吧，关于<code>skynet</code>还有很多很多内容，本文只是一个入门，希望可以帮助到新手同学~<br> 我是林新发：<a href="https://blog.csdn.net/linxinfa">https://blog.csdn.net/linxinfa</a><br> 原创不易，若转载请注明出处，感谢大家~<br> 喜欢我的可以点赞、关注、收藏，如果有什么技术上的疑问，欢迎留言或私信~</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c35c93e99e7b35ef33a7a5bdf6b0b85a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Oracle第二章练习题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0e370cc76ee19aa11e828d71ff5cdf8d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Redis过期时间三种删除策略详解</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>