<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>基于Vue&#43;SpringCloudAlibaba微服务电商项目实战-聚合支付平台-019：基于模板方法模式重构异步回调 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="基于Vue&#43;SpringCloudAlibaba微服务电商项目实战-聚合支付平台-019：基于模板方法模式重构异步回调" />
<meta property="og:description" content="019：基于模板方法模式重构异步回调 1 基于策略&#43;模板方法实现异步回调重构2 异步回调通知实现的原理3 支付宝官方demo异步回调代码的实现4 聚合支付项目如何采用模板&#43;策略重构5 基于模板模式重构聚合支付平台6 异步回调重构验证签名代码7 基于策略模式id找到模板类8 异步回调更改订单状态的信息9 支付异步回调代码继续重构 1 基于策略&#43;模板方法实现异步回调重构 今日课程任务
第三方支付异步回调实现的原理基于模板&#43;策略模式实现异步回调基于ThreadLocal传递参数信息内容采用多线程/MQ异步写入支付的日志信息参数如何防止支付金额不一致的问题如何防止支付回调幂等性问题支付服务存在那些分布式事务难题 2 异步回调通知实现的原理 同步回调：以浏览器重定向方式跳转
异步回调：第三方支付以post请求格式通知给商户端 修改订单状态
支付宝官网文档：https://opendocs.alipay.com/open/270/105899
调用流程如下：
商户系统调用 alipay.trade.page.pay（统一收单下单并支付页面接口）向支付宝发起支付请求，支付宝对商户请求参数进行校验，而后重新定向至用户登录页面。用户确认支付后，支付宝通过 get 请求 returnUrl（商户入参传入），返回同步返回参数。交易成功后，支付宝通过 post 请求 notifyUrl（商户入参传入），返回异步通知参数。若由于网络等原因，导致商户系统没有收到异步通知，商户可自行调用alipay.trade.query（统一收单线下交易查询）接口查询交易以及支付信息（商户也可以直接调用该查询接口，不需要依赖异步通知）。 先触发异步回调，再触发同步回调。
注意：
由于同步返回的不可靠性，支付结果必须以异步通知或查询接口返回为准，不能依赖同步跳转。商户系统接收到异步通知以后，必须通过验签（验证通知中的sign参数）来确保支付通知是由支付宝发送的。详细验签规则请参见 异步通知验签。接收到异步通知并验签通过后，请务必核对通知中的app_id、out_trade_no、total_amount等参数值是否与请求中的一致，并根据trade_status进行后续业务处理。在支付宝端，partnerId与out_trade_no唯一对应一笔单据，商户端保证不同次支付out_trade_no不可重复；若重复，支付宝会关联到原单据，基本信息一致的情况下会以原单据为准进行支付。 3 支付宝官方demo异步回调代码的实现 异步回调中的商户订单号码与支付宝交易号码有哪些区别？
商户订单号码—支付的id
支付宝交易号码—支付宝流水号码 补偿
如果商户端没有及时返回success给支付宝的情况下，支付宝可能会触发重试策略，重试过程中可能会发生幂等性问题。
注意：同步回调以浏览器重定向形式返回，商户端只是解析报文验证签名成功，将支付结果告诉给用户，但是不能修改订单状态。
4 聚合支付项目如何采用模板&#43;策略重构 如何对聚合支付回调进行设计重构？
策略&#43;模板方法组合
策略模式：解决多重if判断的问题
模板方法模式：定义共同骨架（代码）统一都放入在父类，不同的代码让子类实现。
异步回调代码
1 记录日志
2 验证签名（不同）
3 修改订单状态为已支付
4 调用积分接口增加积分
5 基于模板模式重构聚合支付平台 模板方法骨架类
@Slf4j public abstract class AbstractPayCallbackTemplate { @Autowired private PayThreadInfoHolder payThreadInfoHolder; public String asyncCallBack() { // 1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/cc5abae1ca20f48e614456f7f918542f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-07-16T08:11:07+08:00" />
<meta property="article:modified_time" content="2021-07-16T08:11:07+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">基于Vue&#43;SpringCloudAlibaba微服务电商项目实战-聚合支付平台-019：基于模板方法模式重构异步回调</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>019：基于模板方法模式重构异步回调</h4> 
 <ul><li><ul><li><a href="#1__1" rel="nofollow">1 基于策略+模板方法实现异步回调重构</a></li><li><a href="#2__12" rel="nofollow">2 异步回调通知实现的原理</a></li><li><a href="#3_demo_32" rel="nofollow">3 支付宝官方demo异步回调代码的实现</a></li><li><a href="#4__40" rel="nofollow">4 聚合支付项目如何采用模板+策略重构</a></li><li><a href="#5__52" rel="nofollow">5 基于模板模式重构聚合支付平台</a></li><li><a href="#6__129" rel="nofollow">6 异步回调重构验证签名代码</a></li><li><a href="#7_id_216" rel="nofollow">7 基于策略模式id找到模板类</a></li><li><a href="#8__262" rel="nofollow">8 异步回调更改订单状态的信息</a></li><li><a href="#9__382" rel="nofollow">9 支付异步回调代码继续重构</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="1__1"></a>1 基于策略+模板方法实现异步回调重构</h3> 
<p><strong>今日课程任务</strong></p> 
<ol><li>第三方支付异步回调实现的原理</li><li>基于模板+策略模式实现异步回调</li><li>基于ThreadLocal传递参数信息内容</li><li>采用多线程/MQ异步写入支付的日志信息参数</li><li>如何防止支付金额不一致的问题</li><li>如何防止支付回调幂等性问题</li><li>支付服务存在那些分布式事务难题</li></ol> 
<h3><a id="2__12"></a>2 异步回调通知实现的原理</h3> 
<p>同步回调：以浏览器重定向方式跳转<br> 异步回调：第三方支付以post请求格式通知给商户端 修改订单状态</p> 
<p>支付宝官网文档：https://opendocs.alipay.com/open/270/105899<br> <img src="https://images2.imgbox.com/99/6b/YYbMnPJ3_o.png" alt="在这里插入图片描述"><br> <strong>调用流程如下：</strong></p> 
<ol><li>商户系统调用 alipay.trade.page.pay（统一收单下单并支付页面接口）向支付宝发起支付请求，支付宝对商户请求参数进行校验，而后重新定向至用户登录页面。</li><li>用户确认支付后，支付宝通过 get 请求 returnUrl（商户入参传入），返回同步返回参数。</li><li>交易成功后，支付宝通过 post 请求 notifyUrl（商户入参传入），返回异步通知参数。</li><li>若由于网络等原因，导致商户系统没有收到异步通知，商户可自行调用alipay.trade.query（统一收单线下交易查询）接口查询交易以及支付信息（商户也可以直接调用该查询接口，不需要依赖异步通知）。</li></ol> 
<p><strong>先触发异步回调，再触发同步回调。</strong></p> 
<p><strong>注意：</strong></p> 
<ol><li>由于同步返回的不可靠性，支付结果必须以异步通知或查询接口返回为准，不能依赖同步跳转。</li><li>商户系统接收到异步通知以后，必须通过验签（验证通知中的sign参数）来确保支付通知是由支付宝发送的。详细验签规则请参见 异步通知验签。</li><li>接收到异步通知并验签通过后，请务必核对通知中的app_id、out_trade_no、total_amount等参数值是否与请求中的一致，并根据trade_status进行后续业务处理。</li><li>在支付宝端，partnerId与out_trade_no唯一对应一笔单据，商户端保证不同次支付out_trade_no不可重复；若重复，支付宝会关联到原单据，基本信息一致的情况下会以原单据为准进行支付。</li></ol> 
<h3><a id="3_demo_32"></a>3 支付宝官方demo异步回调代码的实现</h3> 
<p>异步回调中的商户订单号码与支付宝交易号码有哪些区别？<br> 商户订单号码—支付的id<br> 支付宝交易号码—支付宝流水号码 补偿</p> 
<p>如果商户端没有及时返回success给支付宝的情况下，支付宝可能会触发重试策略，重试过程中可能会发生幂等性问题。<br> 注意：同步回调以浏览器重定向形式返回，商户端只是解析报文验证签名成功，将支付结果告诉给用户，但是不能修改订单状态。</p> 
<h3><a id="4__40"></a>4 聚合支付项目如何采用模板+策略重构</h3> 
<p><strong>如何对聚合支付回调进行设计重构？</strong><br> 策略+模板方法组合<br> 策略模式：解决多重if判断的问题<br> 模板方法模式：定义共同骨架（代码）统一都放入在父类，不同的代码让子类实现。</p> 
<p><strong>异步回调代码</strong><br> 1 记录日志<br> 2 验证签名（不同）<br> 3 修改订单状态为已支付<br> 4 调用积分接口增加积分</p> 
<h3><a id="5__52"></a>5 基于模板模式重构聚合支付平台</h3> 
<p><strong>模板方法骨架类</strong></p> 
<pre><code class="prism language-javascript">@Slf4j
<span class="token keyword">public</span> abstract <span class="token keyword">class</span> <span class="token class-name">AbstractPayCallbackTemplate</span> <span class="token punctuation">{<!-- --></span>

    @Autowired
    <span class="token keyword">private</span> PayThreadInfoHolder payThreadInfoHolder<span class="token punctuation">;</span>

    <span class="token keyword">public</span> String <span class="token function">asyncCallBack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1. 验证签名</span>
        boolean isSign <span class="token operator">=</span> <span class="token function">verifySignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 记录日志 注意问题：一定要异步处理（为了快速响应给支付宝避免重试造成的幂等性问题）</span>
        <span class="token function">addPayLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isSign<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 银联支付的时候 必须返回ok；支付宝必须返回success</span>
            <span class="token keyword">return</span> <span class="token function">resultFail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 更改订单状态</span>
        <span class="token keyword">return</span> <span class="token function">asyncService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 3.更改订单状态已经支付
     * 4.调用积分服务接口增加积分
     * @return
     */</span>
    <span class="token keyword">protected</span> abstract String <span class="token function">asyncService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 交给子类实现
     *
     * @return
     */</span>
    <span class="token keyword">protected</span> abstract String <span class="token function">resultFail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">/**
     * 返回成功
     *
     * @return
     */</span>
    <span class="token keyword">protected</span> abstract String <span class="token function">resultSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 定义成抽象方法让子类实现
     * 不管验证签名成功还是失败都会将参数放入到ThreadLocal中
     * @return
     */</span>
    <span class="token keyword">protected</span> abstract boolean <span class="token function">verifySignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 将该方法单独放入在一个类中调用，@Async不经过代理类不会生效
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addPayLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 从ThreadLocal中获取</span>
        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">&gt;</span> requestParams <span class="token operator">=</span> payThreadInfoHolder<span class="token punctuation">.</span><span class="token function">getRequestParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"&gt;&gt;&gt;记录支付的日志requestParams:&lt;&lt;&lt;"</span> <span class="token operator">+</span> requestParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p><strong>使用ThreadLocal存放参数</strong></p> 
<pre><code class="prism language-javascript">@Component
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PayThreadInfoHolder</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> ThreadLocal<span class="token operator">&lt;</span>Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">&gt;&gt;</span> payThreadLocal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setRequestParams</span><span class="token punctuation">(</span><span class="token parameter">Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">&gt;</span> requestParams</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        payThreadLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>requestParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">&gt;</span> <span class="token function">getRequestParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> payThreadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="6__129"></a>6 异步回调重构验证签名代码</h3> 
<p><strong>验证签名</strong></p> 
<pre><code class="prism language-javascript">@Component
@Slf4j
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AliPayCallbackTemplate</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractPayCallbackTemplate</span> <span class="token punctuation">{<!-- --></span>
    @Autowired
    <span class="token keyword">private</span> PayThreadInfoHolder payThreadInfoHolder<span class="token punctuation">;</span>

    @Override
    <span class="token keyword">protected</span> String <span class="token function">resultFail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"fail"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @Override
    <span class="token keyword">protected</span> String <span class="token function">resultSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"success"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @Override
    <span class="token keyword">protected</span> boolean <span class="token function">verifySignature</span><span class="token punctuation">(</span><span class="token parameter">PaymentChannelEntity pce</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 根据当前线程获取Request</span>
        HttpServletRequest request <span class="token operator">=</span> ServletUtils<span class="token punctuation">.</span><span class="token function">getCurrentRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        HttpServletResponse response <span class="token operator">=</span> ServletUtils<span class="token punctuation">.</span><span class="token function">getCurrentResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取支付宝POST过来反馈信息</span>
        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">&gt;</span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> requestParams <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ServletOutputStream out <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            out <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>Iterator<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> iter <span class="token operator">=</span> requestParams<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                String name <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span> iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                String<span class="token punctuation">[</span><span class="token punctuation">]</span> values <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> requestParams<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                String valueStr <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>int i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> values<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    valueStr <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> values<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> valueStr <span class="token operator">+</span> values<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                            <span class="token operator">:</span> valueStr <span class="token operator">+</span> values<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">","</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//乱码解决，这段代码在出现乱码时使用</span>
                valueStr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>valueStr<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"ISO-8859-1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> valueStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 防止验证签名失败</span>
                params<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">"channelId"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            boolean signVerified <span class="token operator">=</span> AlipaySignature<span class="token punctuation">.</span><span class="token function">rsaCheckV1</span><span class="token punctuation">(</span>
                    params<span class="token punctuation">,</span> pce<span class="token punctuation">.</span><span class="token function">getPublicKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> AlipayConfig<span class="token punctuation">.</span><span class="token constant">CHARSET</span><span class="token punctuation">,</span> AlipayConfig<span class="token punctuation">.</span><span class="token constant">SIGN_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//调用SDK验证签名</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>signVerified<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//验证成功</span>
                <span class="token comment">//商户订单号</span>
                String outTradeNo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"out_trade_no"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"ISO-8859-1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//支付宝交易号</span>
                String tradeNo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"trade_no"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"ISO-8859-1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//交易状态</span>
                String tradeStatus <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"trade_status"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"ISO-8859-1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>tradeStatus<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"TRADE_FINISHED"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tradeStatus<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"TRADE_SUCCESS"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

                <span class="token punctuation">}</span>
                out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//验证失败</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"verifySignature()&gt;&gt; errorMsg:"</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>out <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

            <span class="token punctuation">}</span>
            payThreadInfoHolder<span class="token punctuation">.</span><span class="token function">setRequestParams</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    @Override
    <span class="token keyword">protected</span> String <span class="token function">asyncService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="7_id_216"></a>7 基于策略模式id找到模板类</h3> 
<p>数据库payment_channel表新增字段callback_bean_id，aliPayCallbackTemplate对应支付回调模板子类AliPayCallbackTemplate。</p> 
<p><strong>异步回调方法</strong></p> 
<pre><code class="prism language-javascript"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">PayCallbackService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 异步回调
     *
     * @return
     */</span>
    @<span class="token function">RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/asynCallback"</span><span class="token punctuation">)</span>
    Object <span class="token function">asynCallback</span><span class="token punctuation">(</span>String channelId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-javascript">@RestController
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PayCallbackServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">BaseApiService</span> <span class="token keyword">implements</span> <span class="token class-name">PayCallbackService</span> <span class="token punctuation">{<!-- --></span>
    @Autowired
    <span class="token keyword">private</span> PaymentChannelMapper paymentChannelMapper<span class="token punctuation">;</span>

    @Override
    <span class="token keyword">public</span> Object <span class="token function">asynCallback</span><span class="token punctuation">(</span><span class="token parameter">String channelId</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>channelId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">setResultError</span><span class="token punctuation">(</span><span class="token string">"channelId不能为空"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 1.根据渠道id查询渠道信息</span>
        PaymentChannelEntity pce <span class="token operator">=</span> paymentChannelMapper<span class="token punctuation">.</span><span class="token function">selectBychannelId</span><span class="token punctuation">(</span>channelId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pce <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">setResultError</span><span class="token punctuation">(</span><span class="token string">"该渠道已关闭或不存在，请联系管理员"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//2.获取模板的baenid</span>
        String callbackBeanId <span class="token operator">=</span> pce<span class="token punctuation">.</span><span class="token function">getCallbackBeanId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>callbackBeanId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">setResultError</span><span class="token punctuation">(</span><span class="token string">"没有配置callbackBeanId"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//3.直接从Spring容器上下文获取</span>
        AbstractPayCallbackTemplate payCallbackTemplate <span class="token operator">=</span>
                SpringContextUtils<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>callbackBeanId<span class="token punctuation">,</span> AbstractPayCallbackTemplate<span class="token punctuation">.</span>class<span class="token punctuation">)</span><span class="token punctuation">;</span>
        String result <span class="token operator">=</span> payCallbackTemplate<span class="token punctuation">.</span><span class="token function">asyncCallBack</span><span class="token punctuation">(</span>pce<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="8__262"></a>8 异步回调更改订单状态的信息</h3> 
<p><strong>阿里支付回调模板实现类</strong></p> 
<pre><code class="prism language-javascript">@Component
@Slf4j
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AliPayCallbackTemplate</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractPayCallbackTemplate</span> <span class="token punctuation">{<!-- --></span>
    @Autowired
    <span class="token keyword">private</span> PayThreadInfoHolder payThreadInfoHolder<span class="token punctuation">;</span>
    @Autowired
    <span class="token keyword">private</span> PaymentTransactionMapper paymentTransactionMapper<span class="token punctuation">;</span>

    @Override
    <span class="token keyword">protected</span> String <span class="token function">resultFail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"fail"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @Override
    <span class="token keyword">protected</span> String <span class="token function">resultSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"success"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @Override
    <span class="token keyword">protected</span> boolean <span class="token function">verifySignature</span><span class="token punctuation">(</span><span class="token parameter">PaymentChannelEntity pce</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 根据当前线程获取Request</span>
        HttpServletRequest request <span class="token operator">=</span> ServletUtils<span class="token punctuation">.</span><span class="token function">getCurrentRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        HttpServletResponse response <span class="token operator">=</span> ServletUtils<span class="token punctuation">.</span><span class="token function">getCurrentResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取支付宝POST过来反馈信息</span>
        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">&gt;</span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> requestParams <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ServletOutputStream out <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            out <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>Iterator<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> iter <span class="token operator">=</span> requestParams<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                String name <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span> iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                String<span class="token punctuation">[</span><span class="token punctuation">]</span> values <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> requestParams<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                String valueStr <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>int i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> values<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    valueStr <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> values<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> valueStr <span class="token operator">+</span> values<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                            <span class="token operator">:</span> valueStr <span class="token operator">+</span> values<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">","</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//乱码解决，这段代码在出现乱码时使用</span>
                valueStr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>valueStr<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"ISO-8859-1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> valueStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 防止验证签名失败</span>
                params<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">"channelId"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            boolean signVerified <span class="token operator">=</span> AlipaySignature<span class="token punctuation">.</span><span class="token function">rsaCheckV1</span><span class="token punctuation">(</span>
                    params<span class="token punctuation">,</span> pce<span class="token punctuation">.</span><span class="token function">getPublicKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> AlipayConfig<span class="token punctuation">.</span><span class="token constant">CHARSET</span><span class="token punctuation">,</span> AlipayConfig<span class="token punctuation">.</span><span class="token constant">SIGN_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//调用SDK验证签名</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>signVerified<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//验证失败</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"verifySignature()&gt;&gt; errorMsg:"</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>out <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

            <span class="token punctuation">}</span>
            payThreadInfoHolder<span class="token punctuation">.</span><span class="token function">setRequestParams</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    @Override
    <span class="token keyword">protected</span> String <span class="token function">asyncService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1. 根据支付订单号码查询数据库 ，是否已经支付过</span>
        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">&gt;</span> requestParams <span class="token operator">=</span> <span class="token function">currentRequestParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 支付订单号码</span>
        String outTradeNo <span class="token operator">=</span> requestParams<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"out_trade_no"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        PaymentTransactionEntity pte <span class="token operator">=</span> paymentTransactionMapper<span class="token punctuation">.</span><span class="token function">selectByPaymentId</span><span class="token punctuation">(</span>outTradeNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 以下代码可以重构进入父类里面</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>pte<span class="token punctuation">.</span><span class="token function">getPaymentStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 返回成功告诉给支付不要再继续重试</span>
            <span class="token keyword">return</span> <span class="token function">resultSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 2.判断支付的金额 是否一致</span>
        Long payAmount <span class="token operator">=</span> pte<span class="token punctuation">.</span><span class="token function">getPayAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String totalAmount <span class="token operator">=</span> requestParams<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"total_amount"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Long aliPayAmount <span class="token operator">=</span> <span class="token function">yuanToFen</span><span class="token punctuation">(</span>totalAmount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>payAmount<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>aliPayAmount<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 返回success，后台将该订单状态修改为异常订单状态，然后分析异常原因用定时任务处理</span>
            <span class="token keyword">return</span> <span class="token function">resultSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 3. 在修改为已经支付</span>
        int result <span class="token operator">=</span> paymentTransactionMapper<span class="token punctuation">.</span><span class="token function">updatePaymentStatus</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">,</span> outTradeNo<span class="token punctuation">,</span> <span class="token string">"ali_pay"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 返回失败告诉支付宝重试</span>
            <span class="token keyword">return</span> <span class="token function">resultFail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 调用积分服务接口增加积分 存在分布式事务的问题</span>
        <span class="token keyword">return</span> <span class="token function">resultSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> Long <span class="token function">yuanToFen</span><span class="token punctuation">(</span><span class="token parameter">String amount</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        NumberFormat format <span class="token operator">=</span> NumberFormat<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            Number number <span class="token operator">=</span> format<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            double temp <span class="token operator">=</span> number<span class="token punctuation">.</span><span class="token function">doubleValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100.0</span><span class="token punctuation">;</span>
            format<span class="token punctuation">.</span><span class="token function">setGroupingUsed</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 设置返回数的小数部分所允许的最大位数</span>
            format<span class="token punctuation">.</span><span class="token function">setMaximumFractionDigits</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            amount <span class="token operator">=</span> format<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> Long<span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>ParseException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>测试效果：</strong><br> <img src="https://images2.imgbox.com/ff/2c/m92KszWB_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="9__382"></a>9 支付异步回调代码继续重构</h3> 
<p><strong>重构asyncService()方法</strong> -修改订单状态是通用的逻辑，可以放在父类中实现</p> 
<pre><code class="prism language-javascript">@Slf4j
<span class="token keyword">public</span> abstract <span class="token keyword">class</span> <span class="token class-name">AbstractPayCallbackTemplate</span> <span class="token punctuation">{<!-- --></span>

    @Autowired
    <span class="token keyword">private</span> PayThreadInfoHolder payThreadInfoHolder<span class="token punctuation">;</span>
    @Autowired
    <span class="token keyword">private</span> PaymentTransactionMapper paymentTransactionMapper<span class="token punctuation">;</span>

    <span class="token keyword">public</span> String <span class="token function">asyncCallBack</span><span class="token punctuation">(</span><span class="token parameter">PaymentChannelEntity pce</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1. 验证签名</span>
        boolean isSign <span class="token operator">=</span> <span class="token function">verifySignature</span><span class="token punctuation">(</span>pce<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 记录日志 注意问题：一定要异步处理（为了快速响应给支付宝避免重试造成的幂等性问题）</span>
        <span class="token function">addPayLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isSign<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 银联支付的时候 必须返回ok；支付宝必须返回success</span>
            <span class="token keyword">return</span> <span class="token function">resultFail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 更改订单状态 获取订单号码，支付金额</span>
        String orderNo <span class="token operator">=</span> <span class="token function">getPayOrderNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Long totalAmount <span class="token operator">=</span> <span class="token function">getTotalAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">asyncService</span><span class="token punctuation">(</span>orderNo<span class="token punctuation">,</span> totalAmount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 3.更改订单状态已经支付
     * 4.调用积分服务接口增加积分
     *
     * @return
     */</span>
    <span class="token keyword">private</span> String <span class="token function">asyncService</span><span class="token punctuation">(</span><span class="token parameter">String outTradeNo<span class="token punctuation">,</span> Long totalAmount</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 支付订单号码</span>
        PaymentTransactionEntity pte <span class="token operator">=</span> paymentTransactionMapper<span class="token punctuation">.</span><span class="token function">selectByPaymentId</span><span class="token punctuation">(</span>outTradeNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 以下代码可以重构进入父类里面</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>PayConstant<span class="token punctuation">.</span><span class="token constant">PAY_PAID_STATUS</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>pte<span class="token punctuation">.</span><span class="token function">getPaymentStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 返回成功告诉给支付不要再继续重试</span>
            <span class="token keyword">return</span> <span class="token function">resultSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 2.判断支付的金额 是否一致</span>
        Long payAmount <span class="token operator">=</span> pte<span class="token punctuation">.</span><span class="token function">getPayAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>payAmount<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>totalAmount<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 返回success，后台将该订单状态修改为异常订单状态，然后分析异常原因用定时任务处理</span>
            <span class="token keyword">return</span> <span class="token function">resultSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 3. 在修改为已经支付</span>
        int result <span class="token operator">=</span> paymentTransactionMapper<span class="token punctuation">.</span><span class="token function">updatePaymentStatus</span><span class="token punctuation">(</span>PayConstant<span class="token punctuation">.</span><span class="token constant">PAY_PAID_STATUS</span> <span class="token operator">+</span> <span class="token string">""</span><span class="token punctuation">,</span> outTradeNo<span class="token punctuation">,</span> <span class="token string">"ali_pay"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">&lt;</span> PayConstant<span class="token punctuation">.</span><span class="token constant">DB_FAIL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 返回失败告诉支付宝重试</span>
            <span class="token keyword">return</span> <span class="token function">resultFail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 调用积分服务接口增加积分 存在分布式事务的问题</span>
        <span class="token keyword">return</span> <span class="token function">resultSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取真实的支付订单号码
     *
     * @return
     */</span>
    <span class="token keyword">protected</span> abstract String <span class="token function">getPayOrderNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 获取真实的支付金额
     *
     * @return
     */</span>
    <span class="token keyword">protected</span> abstract Long <span class="token function">getTotalAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 交给子类实现
     *
     * @return
     */</span>
    <span class="token keyword">protected</span> abstract String <span class="token function">resultFail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">/**
     * 返回成功
     *
     * @return
     */</span>
    <span class="token keyword">protected</span> abstract String <span class="token function">resultSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 定义成抽象方法让子类实现
     * 不管验证签名成功还是失败都会将参数放入到ThreadLocal中
     *
     * @return
     */</span>
    <span class="token keyword">protected</span> abstract boolean <span class="token function">verifySignature</span><span class="token punctuation">(</span>PaymentChannelEntity pce<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 将该方法单独放入在一个类中调用，@Async不经过代理类不会生效
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addPayLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 从ThreadLocal中获取</span>
        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">&gt;</span> requestParams <span class="token operator">=</span> <span class="token function">currentRequestParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"&gt;&gt;&gt;记录支付的日志requestParams:&lt;&lt;&lt;"</span> <span class="token operator">+</span> requestParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">&gt;</span> <span class="token function">currentRequestParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> payThreadInfoHolder<span class="token punctuation">.</span><span class="token function">getRequestParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-javascript">@Component
@Slf4j
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AliPayCallbackTemplate</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractPayCallbackTemplate</span> <span class="token punctuation">{<!-- --></span>
    @Autowired
    <span class="token keyword">private</span> PayThreadInfoHolder payThreadInfoHolder<span class="token punctuation">;</span>


    @Override
    <span class="token keyword">protected</span> String <span class="token function">getPayOrderNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1. 根据支付订单号码查询数据库 ，是否已经支付过</span>
        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">&gt;</span> requestParams <span class="token operator">=</span> <span class="token function">currentRequestParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 支付订单号码</span>
        String outTradeNo <span class="token operator">=</span> requestParams<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"out_trade_no"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> outTradeNo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @Override
    <span class="token keyword">protected</span> Long <span class="token function">getTotalAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1. 根据支付订单号码查询数据库 ，是否已经支付过</span>
        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">&gt;</span> requestParams <span class="token operator">=</span> <span class="token function">currentRequestParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String totalAmount <span class="token operator">=</span> requestParams<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"total_amount"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Long aliPayAmount <span class="token operator">=</span> <span class="token function">yuanToFen</span><span class="token punctuation">(</span>totalAmount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> aliPayAmount<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @Override
    <span class="token keyword">protected</span> String <span class="token function">resultFail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"fail"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @Override
    <span class="token keyword">protected</span> String <span class="token function">resultSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"success"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @Override
    <span class="token keyword">protected</span> boolean <span class="token function">verifySignature</span><span class="token punctuation">(</span><span class="token parameter">PaymentChannelEntity pce</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 根据当前线程获取Request</span>
        HttpServletRequest request <span class="token operator">=</span> ServletUtils<span class="token punctuation">.</span><span class="token function">getCurrentRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        HttpServletResponse response <span class="token operator">=</span> ServletUtils<span class="token punctuation">.</span><span class="token function">getCurrentResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取支付宝POST过来反馈信息</span>
        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">&gt;</span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> requestParams <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ServletOutputStream out <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            out <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>Iterator<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> iter <span class="token operator">=</span> requestParams<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                String name <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span> iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                String<span class="token punctuation">[</span><span class="token punctuation">]</span> values <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> requestParams<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                String valueStr <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>int i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> values<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    valueStr <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> values<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> valueStr <span class="token operator">+</span> values<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                            <span class="token operator">:</span> valueStr <span class="token operator">+</span> values<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">","</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//乱码解决，这段代码在出现乱码时使用</span>
                valueStr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>valueStr<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"ISO-8859-1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> valueStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 防止验证签名失败</span>
                params<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">"channelId"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            boolean signVerified <span class="token operator">=</span> AlipaySignature<span class="token punctuation">.</span><span class="token function">rsaCheckV1</span><span class="token punctuation">(</span>
                    params<span class="token punctuation">,</span> pce<span class="token punctuation">.</span><span class="token function">getPublicKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> AlipayConfig<span class="token punctuation">.</span><span class="token constant">CHARSET</span><span class="token punctuation">,</span> AlipayConfig<span class="token punctuation">.</span><span class="token constant">SIGN_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//调用SDK验证签名</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>signVerified<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//验证失败</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"verifySignature()&gt;&gt; errorMsg:"</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>out <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

            <span class="token punctuation">}</span>
            payThreadInfoHolder<span class="token punctuation">.</span><span class="token function">setRequestParams</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> Long <span class="token function">yuanToFen</span><span class="token punctuation">(</span><span class="token parameter">String amount</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        NumberFormat format <span class="token operator">=</span> NumberFormat<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            Number number <span class="token operator">=</span> format<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            double temp <span class="token operator">=</span> number<span class="token punctuation">.</span><span class="token function">doubleValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100.0</span><span class="token punctuation">;</span>
            format<span class="token punctuation">.</span><span class="token function">setGroupingUsed</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 设置返回数的小数部分所允许的最大位数</span>
            format<span class="token punctuation">.</span><span class="token function">setMaximumFractionDigits</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            amount <span class="token operator">=</span> format<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> Long<span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>ParseException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/080393847769cb9bc423c485fd548368/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">计算机乘法怎么操作函数,教你三个excel乘法函数公式的用法，瞬间提高办公效率...</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1d296b27443c86153bbda84bc2798e01/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">基于Vue&#43;SpringCloudAlibaba微服务电商项目实战-聚合支付平台-020：基于seata解决分布式事务</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>