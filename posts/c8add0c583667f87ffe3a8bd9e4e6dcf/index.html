<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>JMeter websocket接口测试 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="JMeter websocket接口测试" />
<meta property="og:description" content="前言
在一个网站中，很多数据需要即时更新，比如期货交易类的用户资产。在以前，这种功能的实现一般使用http轮询，即客户端用定时任务每隔一段时间向服务器发送查询请求来获取最新值。这种方式的弊端显而易见：
有可能造成数据更新不及时，如果前端轮询频率为5s，也许数据在这5s内已经更新多次了。
有可能对数据库造成额外压力，例如一个用户资产长时间不变化，但客户端还是要定时去查询，这种无意义查询占比相当高，对服务器造成不必要的压力。
要经过请求和响应两次交互，增加了耗时，而且http请求可能携带大量的header信息，增加网络带宽占用
HTML5 开始提供的一种在单个 TCP 连接上进行全双工通讯的协议-WebSocket，很好地解决了http轮询的弊端。
在 WebSocket API 中，浏览器和服务器只需要做一个握手的动作，然后，浏览器和服务器之间就形成了一条快速通道。两者之间就直接可以数据互相传送。
也就是说，http轮询机制，主动权完全在客户端，而WebSocket机制中，主动权可以交给服务端，数据推送可以更精确，包括何时推送（定时推送还是更新即推送），推送什么数据。
准备工作
JMeter可以非常便利地进行WebSocket接口测试，但需要引入下列依赖：
jetty-http
jetty-io
jetty-util
websocket-api
websocket-client
websweocket-common
相关依赖下载：
https://pan.baidu.com/s/1PTOyTBzmOwLPNhxB-TxR7g ，提取码：uq25
下面内容基于JMeter5.1.1
将相关jar包放入JMeter安装目录的/lib/etc中，重启JMeter。在取样器中，可以看到比之前多了websweocket相关的取样器。
脚本编写
在编写脚本之前，先要搞清楚推送服务的逻辑，它的逻辑是这样的：
首先，客户端向服务端发送请求，建立连接
建立连接后，客户端需要定时向服务端发送ping-pong消息，维持心跳
客户端发送主动断开连接的请求，服务端断开该连接
建立连接，使用【WebSocket request-response Sampler】，顾名思义，这个取样器既能发送请求也能接收响应。
说明一下各项内容：
Connection：有use existing connection和setup new connection两种模式，前者是使用已有连接，即上一个websocket请求所建立的连接通道，选择后Server URL全置灰只读不可操作。后者指新建连接通道。
Server URL：ws协议和wss（加密的websocket）可选，sever name or IP（服务器地址）、Port（端口号）、Path（路径）、Connection timeout（连接超时时间）这些含义也很明了。
Data：发送数据，可以选择Text（文本，包括JSON）和Binary（二进制）形式，也可以通过勾选Read request data from file来从文件中获取data。
这个请求要与连接请求是同一个线程，并且要定时运行，因此设计脚本结构如下：
注意两点：
1.想要建立3000个连接的话，一定是将【线程数】设置为3000，循环次数设置为1，而不是相反，这是许多人容易弄混淆的。
2.【Ramp-up 时间】这个参数是全部线程启动的时间，如果想给服务器较大的瞬时压力，就把时间设置短一些。经过实测，这个时间太短的话，最终成功建立的连接会明显少于设置的【线程数】，所以一般设置长一点。
一般的websocket推送服务，会设计定时心跳检测机制，也就是客户端定时向服务端发送一条特定的消息，这样服务端就会保持这个连接，否则的话，这个客户端就被服务端判定为不活跃而被断掉连接。因此，为了让我们的脚本持续跑下去，就需要加入心跳检测请求。
因为线程循环次数是1次（多次的话，就是一个线程反复建立连接了），因此我们要把【心跳检测】放到一个循环控制器中。
而【固定定时器】的作用，就是控制【心跳检测】发送的频率：
心跳检测：
尤其要注意两点：
1.Connection项一定要选择 use existing connection，表示使用该线程已经建立的连接，否则就重新创建连接了。
2.Request data 根据服务端的实现而定。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/c8add0c583667f87ffe3a8bd9e4e6dcf/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-25T14:33:18+08:00" />
<meta property="article:modified_time" content="2022-07-25T14:33:18+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">JMeter websocket接口测试</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>前言</p> 
<p>在一个网站中，很多数据需要即时更新，比如期货交易类的用户资产。在以前，这种功能的实现一般使用http轮询，即客户端用定时任务每隔一段时间向服务器发送查询请求来获取最新值。这种方式的弊端显而易见：</p> 
<p>有可能造成数据更新不及时，如果前端轮询频率为5s，也许数据在这5s内已经更新多次了。</p> 
<p>有可能对数据库造成额外压力，例如一个用户资产长时间不变化，但客户端还是要定时去查询，这种无意义查询占比相当高，对服务器造成不必要的压力。</p> 
<p>要经过请求和响应两次交互，增加了耗时，而且http请求可能携带大量的header信息，增加网络带宽占用</p> 
<p>HTML5 开始提供的一种在单个 TCP 连接上进行全双工通讯的协议-WebSocket，很好地解决了http轮询的弊端。</p> 
<p>在 WebSocket API 中，浏览器和服务器只需要做一个握手的动作，然后，浏览器和服务器之间就形成了一条快速通道。两者之间就直接可以数据互相传送。</p> 
<p>也就是说，http轮询机制，主动权完全在客户端，而WebSocket机制中，主动权可以交给服务端，数据推送可以更精确，包括何时推送（定时推送还是更新即推送），推送什么数据。</p> 
<p>准备工作<br> JMeter可以非常便利地进行WebSocket接口测试，但需要引入下列依赖：</p> 
<p>jetty-http</p> 
<p>jetty-io</p> 
<p>jetty-util</p> 
<p>websocket-api</p> 
<p>websocket-client</p> 
<p>websweocket-common</p> 
<p>相关依赖下载：</p> 
<p>https://pan.baidu.com/s/1PTOyTBzmOwLPNhxB-TxR7g ，提取码：uq25</p> 
<p>下面内容基于JMeter5.1.1</p> 
<p>将相关jar包放入JMeter安装目录的/lib/etc中，重启JMeter。在取样器中，可以看到比之前多了websweocket相关的取样器。<br> <img src="https://images2.imgbox.com/35/33/TY3J4ZxP_o.png" alt="在这里插入图片描述"><br> 脚本编写<br> 在编写脚本之前，先要搞清楚推送服务的逻辑，它的逻辑是这样的：</p> 
<p>首先，客户端向服务端发送请求，建立连接</p> 
<p>建立连接后，客户端需要定时向服务端发送ping-pong消息，维持心跳</p> 
<p>客户端发送主动断开连接的请求，服务端断开该连接</p> 
<p>建立连接，使用【WebSocket request-response Sampler】，顾名思义，这个取样器既能发送请求也能接收响应。<br> <img src="https://images2.imgbox.com/22/86/u3PF5utX_o.png" alt="在这里插入图片描述"><br> 说明一下各项内容：</p> 
<p>Connection：有use existing connection和setup new connection两种模式，前者是使用已有连接，即上一个websocket请求所建立的连接通道，选择后Server URL全置灰只读不可操作。后者指新建连接通道。</p> 
<p>Server URL：ws协议和wss（加密的websocket）可选，sever name or IP（服务器地址）、Port（端口号）、Path（路径）、Connection timeout（连接超时时间）这些含义也很明了。</p> 
<p>Data：发送数据，可以选择Text（文本，包括JSON）和Binary（二进制）形式，也可以通过勾选Read request data from file来从文件中获取data。</p> 
<p>这个请求要与连接请求是同一个线程，并且要定时运行，因此设计脚本结构如下：<br> <img src="https://images2.imgbox.com/02/de/HVV3bIE8_o.png" alt="在这里插入图片描述"><br> 注意两点：</p> 
<p>1.想要建立3000个连接的话，一定是将【线程数】设置为3000，循环次数设置为1，而不是相反，这是许多人容易弄混淆的。</p> 
<p>2.【Ramp-up 时间】这个参数是全部线程启动的时间，如果想给服务器较大的瞬时压力，就把时间设置短一些。经过实测，这个时间太短的话，最终成功建立的连接会明显少于设置的【线程数】，所以一般设置长一点。</p> 
<p>一般的websocket推送服务，会设计定时心跳检测机制，也就是客户端定时向服务端发送一条特定的消息，这样服务端就会保持这个连接，否则的话，这个客户端就被服务端判定为不活跃而被断掉连接。因此，为了让我们的脚本持续跑下去，就需要加入心跳检测请求。</p> 
<p>因为线程循环次数是1次（多次的话，就是一个线程反复建立连接了），因此我们要把【心跳检测】放到一个循环控制器中。<img src="https://images2.imgbox.com/62/9c/OWT51x7Y_o.png" alt="在这里插入图片描述"><br> 而【固定定时器】的作用，就是控制【心跳检测】发送的频率：<br> <img src="https://images2.imgbox.com/43/46/CdA1FbnA_o.png" alt="在这里插入图片描述"><br> 心跳检测：<br> <img src="https://images2.imgbox.com/6b/3a/BIzjITZy_o.png" alt="在这里插入图片描述"><br> 尤其要注意两点：</p> 
<p>1.Connection项一定要选择 use existing connection，表示使用该线程已经建立的连接，否则就重新创建连接了。</p> 
<p>2.Request data 根据服务端的实现而定。</p> 
<p><strong>最后感谢每一个认真阅读我文章的人，下面这个网盘链接也是我费了几天时间整理的非常全面的，希望也能帮助到有需要的你！</strong></p> 
<p><img src="https://images2.imgbox.com/dd/0b/2No81XpX_o.png" alt="在这里插入图片描述"></p> 
<p>这些资料，<strong>对于想转行做【软件测试】的朋友来说应该是最全面最完整的备战仓库</strong>，这个仓库也陪伴我走过了最艰难的路程，希望也能帮助到你！凡事要趁早，特别是技术行业，一定要提升技术功底。希望对大家有所帮助……</p> 
<p><strong>如果你不想一个人野蛮生长，找不到系统的资料，问题得不到帮助，坚持几天便放弃的感受的话，可以点击下方小卡片加入我们群，大家可以一起讨论交流，里面会有各种软件测试资料和技术交流。</strong></p> 
<p>敲字不易，如果此文章对你有帮助的话，点个赞收个藏来个关注，给作者一个鼓励。也方便你下次能够快速查找。</p> 
<h3><a id="B_91"></a>自学推荐B站视频：</h3> 
<p>零基础转行软件测试：<a href="https://www.bilibili.com/video/BV1rL4y1J7re?spm_id_from=333.999.0.0" rel="nofollow">自学完软件测试，拿到了字节的测试岗offer，堪称B站最好的视频！</a></p> 
<p>自动化测试进阶：<a href="https://www.bilibili.com/video/BV1cW4y1r7iR?spm_id_from=333.999.0.0" rel="nofollow">已上岸华为，涨薪20K，2022最适合自学的python自动化测试教程，自己花16800买的,无偿分享</a></p> 
<p><img src="https://images2.imgbox.com/55/0b/FedY9QM1_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fe09393bdb099baf617cc27094955bc1/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Java日志简介及SpringBoot日志</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4f1ff1f29df1c3c1d9fff24922fc8b3e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Flutter图表库graphic,自定义TooltipGuide</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>