<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>基于客户端（浏览器）证书身份认证的方法 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="基于客户端（浏览器）证书身份认证的方法" />
<meta property="og:description" content="1、介绍 通过证书验证用户身份（浏览器），其核心是利用cookie实现http和https的信息共享（同域名）。如http://test.abc.com/app/index.html 发现未验证后，跳转到https://test.abc.com:443/app/checkCrt.html身份验证，要求出去证书，确认后将身份信息带入http请求头部，跳转到原请求页面（http://test.abc.com/app/index.html ），读取身份信息后进入页面(出于安全考虑Cookie需要加密)。 流程图 流程说明： 登录流程详细介绍： 1）. 未登录用户访问页面 如：http://test.abc.com/app/index.html 2）. 【CertAuthValve】判断是否访问受限制资源，如访问受限制的资源则判断用户身份是否已验证，未验证则将用户重定向到身份验证页面，原始请求的url做为 query的一部分，登录成功后可以跳转回来， 如：https://test.abc.com:443/app/checkCrt.htm?done=/index.html。 3）. 【CertAuthValve】对于https请求，apache读取请求提供的用户证书，获取证书中的邮件地址，并将该信息写入请求头中。 4）. 【GetUserInfoValve】读取请求头，获取刚刚设置的用户邮件地址信息，进一步获取用户的详细信息，然后将这些信息加密后放入cookie中。 5）. 登录完成，将用户外部重定向回原始页面。 2、具体实现 1）、安装apache、ssh、java、jboss等环境，略。 2）、生成服务证书和服务密码 openssl req - new -x509 -nodes -out /home/admin/app/conf/ssl.crt/server.crt -keyout /home/admin/app/conf/ssl.crt/server.key -days 3600 因为要和内网证书交互，所以需要一个内网证书公钥文件，可以通过以下方式获取: 获取方法：IE-&gt;工具-&gt;Internet选项-&gt;内容-&gt;证书-&gt;受信任的根证书颁发机构，找到intranet行，点击导出，选择下一步，选择Base64编码X.509,将证书文件保存为intranet-ca.crt，拷贝到目录/home/admin/app/conf/ssl.crt/。 3）、apache(httpd.conf)配置 应用和身份验证页面放在一起，所以需要同时配置两个虚拟主机，同时监听80（处理http请求）、443（处理https请求）端口。 #监听端口 Listen 80 Listen 443 #app的虚拟主机配置 NameVirtualHost *:80 &lt;VirtualHost *:80&gt; ServerAdmin sa@abc.com ServerName test.abc.com DocumentRoot /home/admin/app/target/app/htdocs/ &lt;/VirtualHost&gt; #身份验证的虚拟主机配置 NameVirtualHost *:443 &lt;VirtualHost *:443&gt; ServerAdmin sa@abc.com ServerName test.abc.com DocumentRoot /home/admin/app/target/app/htdocs/ SSLEngine on SSLCipherSuite ALL:!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/3db2e07334b1eb19f138fdbb5317e078/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2012-08-31T10:56:21+08:00" />
<meta property="article:modified_time" content="2012-08-31T10:56:21+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">基于客户端（浏览器）证书身份认证的方法</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <span style="color:rgb(75,75,75); font-family:georgia,verdana,Arial,helvetica,sans-seriff; font-size:13px; line-height:20px; text-align:left">1、介绍</span> 
<br style="color:rgb(75,75,75); font-family:georgia,verdana,Arial,helvetica,sans-seriff; font-size:13px; line-height:20px; text-align:left"> 
<div style="color:rgb(75,75,75); font-family:georgia,verdana,Arial,helvetica,sans-seriff; font-size:13px; line-height:20px; text-align:left">
  通过证书验证用户身份（浏览器），其核心是利用cookie实现http和https的信息共享（同域名）。如http://test.abc.com/app/index.html 发现未验证后，跳转到https://test.abc.com:443/app/checkCrt.html身份验证，要求出去证书，确认后将身份信息带入http请求头部，跳转到原请求页面（http://test.abc.com/app/index.html ），读取身份信息后进入页面(出于安全考虑Cookie需要加密)。 
</div> 
<br style="color:rgb(75,75,75); font-family:georgia,verdana,Arial,helvetica,sans-seriff; font-size:13px; line-height:20px; text-align:left"> 
<span style="color:rgb(75,75,75); font-family:georgia,verdana,Arial,helvetica,sans-seriff; font-size:13px; line-height:20px; text-align:left">流程图</span> 
<br style="color:rgb(75,75,75); font-family:georgia,verdana,Arial,helvetica,sans-seriff; font-size:13px; line-height:20px; text-align:left"> 
<img src="https://images2.imgbox.com/b8/66/G5cyfafh_o.png" border="0" alt="" width="666" height="589" style="color:rgb(75,75,75); font-family:georgia,verdana,Arial,helvetica,sans-seriff; font-size:13px; line-height:20px; text-align:left"> 
<br style="color:rgb(75,75,75); font-family:georgia,verdana,Arial,helvetica,sans-seriff; font-size:13px; line-height:20px; text-align:left"> 
<span style="color:rgb(75,75,75); font-family:georgia,verdana,Arial,helvetica,sans-seriff; font-size:13px; line-height:20px; text-align:left">流程说明：</span> 
<br style="color:rgb(75,75,75); font-family:georgia,verdana,Arial,helvetica,sans-seriff; font-size:13px; line-height:20px; text-align:left"> 
<div style="color:rgb(75,75,75); font-family:georgia,verdana,Arial,helvetica,sans-seriff; font-size:13px; line-height:20px; text-align:left"> 
 <div>
   登录流程详细介绍： 
 </div> 
 <div>
   1）. 未登录用户访问页面 如：http://test.abc.com/app/index.html 
 </div> 
 <div>
   2）. 【CertAuthValve】判断是否访问受限制资源，如访问受限制的资源则判断用户身份是否已验证，未验证则将用户重定向到身份验证页面，原始请求的url做为 
 </div> 
 <div>
   query的一部分，登录成功后可以跳转回来， 如：https://test.abc.com:443/app/checkCrt.htm?done=/index.html。 
 </div> 
 <div>
   3）. 【CertAuthValve】对于https请求，apache读取请求提供的用户证书，获取证书中的邮件地址，并将该信息写入请求头中。 
 </div> 
 <div>
   4）. 【GetUserInfoValve】读取请求头，获取刚刚设置的用户邮件地址信息，进一步获取用户的详细信息，然后将这些信息加密后放入cookie中。 
 </div> 
 <div>
   5）. 登录完成，将用户外部重定向回原始页面。 
 </div> 
</div> 
<span style="color:rgb(75,75,75); font-family:georgia,verdana,Arial,helvetica,sans-seriff; font-size:13px; line-height:20px; text-align:left">2、具体实现</span> 
<br style="color:rgb(75,75,75); font-family:georgia,verdana,Arial,helvetica,sans-seriff; font-size:13px; line-height:20px; text-align:left"> 
<span style="color:rgb(75,75,75); font-family:georgia,verdana,Arial,helvetica,sans-seriff; font-size:13px; line-height:20px; text-align:left">1）、安装apache、ssh、java、jboss等环境，略。</span> 
<br style="color:rgb(75,75,75); font-family:georgia,verdana,Arial,helvetica,sans-seriff; font-size:13px; line-height:20px; text-align:left"> 
<span style="color:rgb(75,75,75); font-family:georgia,verdana,Arial,helvetica,sans-seriff; font-size:13px; line-height:20px; text-align:left">2）、生成服务证书和服务密码</span> 
<div style="color:rgb(75,75,75); font-family:georgia,verdana,Arial,helvetica,sans-seriff; font-size:13px; line-height:20px; text-align:left"> 
 <div> 
  <div style="border-top-width:1px; border-right-width:1px; border-bottom-width:1px; border-left-width:1px; border-top-style:solid; border-right-style:solid; border-bottom-style:solid; border-left-style:solid; border-top-color:rgb(204,204,204); border-right-color:rgb(204,204,204); border-bottom-color:rgb(204,204,204); border-left-color:rgb(204,204,204); padding-right:5px; padding-bottom:4px; padding-left:4px; padding-top:4px; width:597px; word-break:break-all; background-color:rgb(238,238,238)">
    openssl req - 
   <span style="color:rgb(0,0,255)">new</span> -x509 -nodes -out /home/admin/app/conf/ssl.crt/server.crt -keyout /home/admin/app/conf/ssl.crt/server.key -days 3600 
  </div> 
 </div> 
 <div>
   因为要和内网证书交互，所以需要一个内网证书公钥文件，可以通过以下方式获取: 
 </div> 
 <div>
   获取方法：IE-&gt;工具-&gt;Internet选项-&gt;内容-&gt;证书-&gt;受信任的根证书颁发机构，找到intranet行，点击导出，选择下一步，选择Base64编码X.509,将证书文件保存为intranet-ca.crt，拷贝到目录/home/admin/app/conf/ssl.crt/。 
  <br> 3）、apache(httpd.conf)配置 
 </div> 
</div> 
<span style="color:rgb(75,75,75); font-family:georgia,verdana,Arial,helvetica,sans-seriff; font-size:13px; line-height:20px; text-align:left">应用和身份验证页面放在一起，所以需要同时配置两个虚拟主机，同时监听80（处理http请求）、443（处理https请求）端口。</span> 
<br style="color:rgb(75,75,75); font-family:georgia,verdana,Arial,helvetica,sans-seriff; font-size:13px; line-height:20px; text-align:left"> 
<div style="color:rgb(75,75,75); font-family:georgia,verdana,Arial,helvetica,sans-seriff; font-size:13px; line-height:20px; text-align:left; border-top-width:1px; border-right-width:1px; border-bottom-width:1px; border-left-width:1px; border-top-style:solid; border-right-style:solid; border-bottom-style:solid; border-left-style:solid; border-top-color:rgb(204,204,204); border-right-color:rgb(204,204,204); border-bottom-color:rgb(204,204,204); border-left-color:rgb(204,204,204); padding-right:5px; padding-bottom:4px; padding-left:4px; padding-top:4px; width:597px; word-break:break-all; background-color:rgb(238,238,238)"> 
 <span style="font-size:12px">#监听端口</span> 
 <br> 
 <span style="font-size:12px">Listen 80</span> 
 <br> 
 <span style="font-size:12px">Listen 443</span> 
 <br> 
 <br> 
 <span style="font-size:12px">#app的虚拟主机配置</span> 
 <br> 
 <div> 
  <div>
    NameVirtualHost *:80 
  </div> 
  <div>
    &lt;VirtualHost *:80&gt; 
  </div> 
  <div>
        ServerAdmin sa@abc.com 
  </div> 
  <div>
        ServerName test.abc.com 
  </div> 
  <div>
        DocumentRoot /home/admin/app/target/app/htdocs/ 
  </div> 
  <div> 
   <span style="font-size:12px">&lt;/VirtualHost&gt;</span> 
   <br> 
   <br> 
   <span style="font-size:12px">#身份验证的虚拟主机配置</span> 
   <br> 
   <div> 
    <div>
      NameVirtualHost *:443 
    </div> 
    <div>
      &lt;VirtualHost *:443&gt; 
    </div> 
    <div>
          ServerAdmin sa@abc.com 
    </div> 
    <div>
          ServerName test.abc.com 
    </div> 
    <div>
          DocumentRoot /home/admin/app/target/app/htdocs/ 
    </div> 
    <div></div> 
    <div>
          SSLEngine on 
    </div> 
    <div>
          SSLCipherSuite ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+SSLv3:+EXP:+eNULL 
     <br> 
     <br> 
     <div>
           #该指令为虚拟主机指定证书文件名。 
     </div> 
    </div> 
    <div>
          SSLCertificateFile /home/admin/app/conf/ssl.crt/server.crt 
     <br> 
     <br> 
     <div>
           #该指令为证书指定一个对应的私钥文件 
     </div> 
    </div> 
    <div>
          SSLCertificateKeyFile /home/admin/app/conf/ssl.crt/server.key 
     <br> 
     <br> 
     <div>
           #该指令为指定一个包含Certificate Authority证书的文件 
      <br> 
      <div>
            #证书公钥 
      </div> 
     </div> 
    </div> 
    <div>
          SSLCACertificateFile /home/admin/app/conf/ssl.crt/intranet-ca.cer 
    </div> 
    <div></div> 
    <div>
          SSLProxyEngine on 
    </div> 
    <div>
          RewriteEngine on 
    </div> 
    <div>
          #设置客户端证书验证为必须 
    </div> 
    <div>
          SSLVerifyClient require 
     <br> 
     <br> 
     <div> 
      <div>
            #因为一个CA证书能够被另一个CA证书验证，所以可以形成一个CA证书链.使用该指令可指定服务器验证用户证书时可以查找多少个CA证明。 
      </div> 
      <div>
            #设置认证深度：一般用默认10。 
      </div> 
     </div> 
    </div> 
    <div>
          SSLVerifyDepth  10 
     <br> 
     <br>     #把mod_ssl里的变量变为全局环境的变量 
    </div> 
    <div>
          SSLOptions +StdEnvVars 
     <br> 
     <br> 
     <div>
           #将证书中的邮件地址添加到请求头中 
     </div> 
    </div> 
    <div>
          RequestHeader unset SSL_CLIENT_S_DN_Email 
    </div> 
    <div>
          RequestHeader add SSL_CLIENT_S_DN_Email %{SSL_CLIENT_S_DN_Email}e 
    </div> 
    <div>
      &lt;/VirtualHost&gt; 
    </div> 
   </div> 
  </div> 
 </div> 
</div> 
<br style="color:rgb(75,75,75); font-family:georgia,verdana,Arial,helvetica,sans-seriff; font-size:13px; line-height:20px; text-align:left"> 
<span style="color:rgb(75,75,75); font-family:georgia,verdana,Arial,helvetica,sans-seriff; font-size:13px; line-height:20px; text-align:left">4)、代码片段</span> 
<br style="color:rgb(75,75,75); font-family:georgia,verdana,Arial,helvetica,sans-seriff; font-size:13px; line-height:20px; text-align:left"> 
<div style="color:rgb(75,75,75); font-family:georgia,verdana,Arial,helvetica,sans-seriff; font-size:13px; line-height:20px; text-align:left; border-top-width:1px; border-right-width:1px; border-bottom-width:1px; border-left-width:1px; border-top-style:solid; border-right-style:solid; border-bottom-style:solid; border-left-style:solid; border-top-color:rgb(204,204,204); border-right-color:rgb(204,204,204); border-bottom-color:rgb(204,204,204); border-left-color:rgb(204,204,204); padding-right:5px; padding-bottom:4px; padding-left:4px; padding-top:4px; width:597px; word-break:break-all; background-color:rgb(238,238,238)"> 
 <span style="color:rgb(0,128,0)">        //</span> 
 <span style="color:rgb(0,128,0)">CertAuthValve.java<br>         </span> 
 <span style="color:rgb(0,128,0)">//</span> 
 <span style="color:rgb(0,128,0)">判断session中是否有用户邮箱地址</span> 
 <span style="color:rgb(0,128,0)"><br> </span>        SessionValue session = SessionHelper.getSessionValue(rundata); 
 <br>          
 <span style="color:rgb(0,0,255)">if</span> (StringUtil.isNotEmpty(session.getCropEmail())) { 
 <br>              
 <span style="color:rgb(0,0,255)">return</span>  
 <span style="color:rgb(0,0,255)">null</span>; 
 <br>         } 
 <br>          
 <br>          
 <span style="color:rgb(0,128,0)">//</span> 
 <span style="color:rgb(0,128,0)"> 从内网证书中获取用户邮箱地址: </span>SSL_CLIENT_S_DN_Email 
 <span style="color:rgb(0,128,0)"><br> </span>        String cropEmail = rundata.getRequest().getHeader(SSL_CLIENT_HEADER_MAIL); 
 <br>          
 <span style="color:rgb(0,0,255)">if</span> (StringUtil.isNotEmpty(cropEmail)) { 
 <br>              
 <span style="color:rgb(0,128,0)">//</span> 
 <span style="color:rgb(0,128,0)">将邮箱地址保存到session</span> 
 <span style="color:rgb(0,128,0)"><br> </span>            session.setCropEmail(cropEmail); 
 <br>             SessionHelper.saveSessionValue(rundata, session); 
 <br>              
 <span style="color:rgb(0,0,255)">if</span> (log.isDebugEnabled()) { 
 <br>                 log.debug("用户" + session.getCropEmail() + "已经通过证书验证"); 
 <br>             } 
 <br>              
 <span style="color:rgb(0,0,255)">return</span>  
 <span style="color:rgb(0,0,255)">null</span>; 
 <br>         } 
 <br>          
 <br>         URIBrokerService uriBrokerService = (URIBrokerService) getWebxComponent().getService( 
 <br>                 URIBrokerService.SERVICE_NAME); 
 <br>         URIBroker noPermissionUriBroker = uriBrokerService.getURIBroker(CHECK_CRT_URL); 
 <br>          
 <span style="color:rgb(0,128,0)">//</span> 
 <span style="color:rgb(0,128,0)">请求的原始URL &amp; 验证的URL</span> 
 <span style="color:rgb(0,128,0)"><br> </span>        String requestPath = rundata.getPathInfo().replace("_", ""); 
 <br>         String checkCrtUrl = (String) noPermissionUriBroker.getPath().get( 
 <br>                 noPermissionUriBroker.getPath().size() - 1); 
 <br> 
 <br>          
 <span style="color:rgb(0,0,255)">try</span> { 
 <br>              
 <span style="color:rgb(0,128,0)">//</span> 
 <span style="color:rgb(0,128,0)">原始请求判断</span> 
 <span style="color:rgb(0,128,0)"><br> </span>             
 <span style="color:rgb(0,0,255)">if</span> (requestPath.equalsIgnoreCase(checkCrtUrl)) { 
 <br>                  
 <span style="color:rgb(0,128,0)">//</span> 
 <span style="color:rgb(0,128,0)">当前是https请求，但是依然不能得到证书信息,转到禁止页面<br>                 </span> 
 <span style="color:rgb(0,128,0)">//</span> 
 <span style="color:rgb(0,128,0)">(要将禁止页面加入到允许访问的配置文件中，不然会导致循环重定向)</span> 
 <span style="color:rgb(0,128,0)"><br> </span>                URIBroker uriBroker = uriBrokerService.getURIBroker("forbidden"); 
 <br>                 rundata.setRedirectLocation(uriBroker.render()); 
 <br>             }  
 <span style="color:rgb(0,0,255)">else</span> { 
 <br>                  
 <span style="color:rgb(0,128,0)">//</span> 
 <span style="color:rgb(0,128,0)">转到证书验证页面</span> 
 <span style="color:rgb(0,128,0)"><br> </span>                rundata.setRedirectLocation(noPermissionUriBroker.render() + "?done=" + rundata.getPathInfo()); 
 <br>             } 
 <br>         }  
 <span style="color:rgb(0,0,255)">catch</span> (IOException e) { 
 <br>             log.error("权限验证重定向出错", e); 
 <br>         } 
 <br>          
 <span style="color:rgb(0,0,255)">return</span>  
 <span style="color:rgb(0,0,255)">new</span> BreakPipeline(); 
</div> 
<br style="color:rgb(75,75,75); font-family:georgia,verdana,Arial,helvetica,sans-seriff; font-size:13px; line-height:20px; text-align:left"> 
<div style="color:rgb(75,75,75); font-family:georgia,verdana,Arial,helvetica,sans-seriff; font-size:13px; line-height:20px; text-align:left; background-color:rgb(238,238,238); border-top-width:1px; border-right-width:1px; border-bottom-width:1px; border-left-width:1px; border-top-style:solid; border-right-style:solid; border-bottom-style:solid; border-left-style:solid; border-top-color:rgb(204,204,204); border-right-color:rgb(204,204,204); border-bottom-color:rgb(204,204,204); border-left-color:rgb(204,204,204); padding-right:5px; padding-bottom:4px; padding-left:4px; padding-top:4px; width:597px; word-break:break-all"> 
 <span style="color:rgb(0,128,0)">        //</span> 
 <span style="color:rgb(0,128,0)">GetUserInfoValve.java</span> 
 <span style="color:rgb(0,128,0)"><br> </span>        Object user = rundata.getSession().getAttribute("userInfo"); 
 <br>          
 <span style="color:rgb(0,0,255)">if</span> (user ==  
 <span style="color:rgb(0,0,255)">null</span>) { 
 <br>             SessionValue session = SessionHelper.getSessionValue(rundata); 
 <br>             String email = session.getCropEmail(); 
 <br>             Employe employe = PersonInfoUtil.getPersonInfoByEmail(email); 
 <br> 
 <br>              
 <span style="color:rgb(0,128,0)">//</span> 
 <span style="color:rgb(0,128,0)"> 写入cookie</span> 
 <span style="color:rgb(0,128,0)"><br> </span>            session.setEmployeeId(employe.getEmployeId()); 
 <br>             session.setName(employe.getName()); 
 <br>             session.setCropEmail(employe.getEmail()); 
 <br>             SessionHelper.saveSessionValue(rundata, session); 
 <br>         } 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/99e09ba223dbd992e2de6e58d681b9ec/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">AStyle代码格式工具在source insight中的使用</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8eb5696cca507f8e96aaedc781fb13cf/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">java中Writer的线程安全性</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>