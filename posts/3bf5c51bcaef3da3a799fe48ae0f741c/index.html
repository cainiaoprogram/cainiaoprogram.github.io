<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Pytorch--3.使用CNN和LSTM对数据进行预测 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Pytorch--3.使用CNN和LSTM对数据进行预测" />
<meta property="og:description" content="这个系列前面的文章我们学会了使用全连接层来做简单的回归任务，但是在现实情况里，我们不仅需要做回归，可能还需要做预测工作。同时，我们的数据可能在时空上有着联系，但是简单的全连接层并不能满足我们的需求，所以我们在这篇文章里使用CNN和LSTM来对时间上有联系的数据来进行学习，同时来实现预测的功能。 1.数据集:使用的是kaggle上一个公开的气象数据集(CSV) 有需要的可以去kaggle下载，也可以在评论区留下mail，题主发送过去
2.导入我们所需要的库和完成前置工作 2.1导入相关的库 torch为人工智能的库，pandas用于数据读取，numpy为张量处理的库，matplotlib为画图库
import torch import pandas as pd import numpy as np import matplotlib.pyplot as plt import warnings import torch.nn as nn import torch.optim as optim import random 2.2设置相关配置 我们设置随机种子(方便代码的复现)和警告的忽律(防止出现太多警告看不到代码运行的效果)
warnings.filterwarnings(&#39;ignore&#39;) torch.backends.cudnn.deterministic = True torch.backends.cudnn.benchmark = False torch.manual_seed(99) np.random.seed(99) random.seed(99) print (&#34;随机种子&#34;) 2.3数据的读入 pd.read_csv里面的参数为相对位置，即代码和文件要在同一个文件夹下面。使用.head()函数来读一下数据的前几行，保证数据是存在的
train_data = pd.read_csv(&#34;LSTM-Multivariate_pollution.csv&#34;) train_data.head() 我们来看一下各个值的前2048个数据分布情况(方便挑选数据进行代码测试)
代码里面的pollution可以换成dew，temp等值(也就是上图里面的值)，用于观看分布情况。
train_use = train_data[&#34;pollution&#34;].values plt.plot([i for i in range(2048)], pollution[:2048]) pollution:
dew:
temp:
我们可以看到temp属性里面的数据整体呈现上升的趋势，所以我们使用属性为temp的值来进行学习和预测。
首先对数据进行归一化操作(因为值过大的话会导致神经网络损失不降低，同时神经网络难以达到收敛),我们使用minmax归一化后将其打印出来可以看到代码显示的效果
from sklearn." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/3bf5c51bcaef3da3a799fe48ae0f741c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-10-24T16:08:49+08:00" />
<meta property="article:modified_time" content="2023-10-24T16:08:49+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Pytorch--3.使用CNN和LSTM对数据进行预测</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="CNNLSTM_0"></a>这个系列前面的文章我们学会了使用全连接层来做简单的回归任务，但是在现实情况里，我们不仅需要做回归，可能还需要做预测工作。同时，我们的数据可能在时空上有着联系，但是简单的全连接层并不能满足我们的需求，所以我们在这篇文章里使用CNN和LSTM来对时间上有联系的数据来进行学习，同时来实现预测的功能。</h2> 
<h3><a id="1kaggleCSV_1"></a>1.数据集:使用的是kaggle上一个公开的气象数据集(CSV)</h3> 
<p>有需要的可以去kaggle下载，也可以在评论区留下mail，题主发送过去<br> <img src="https://images2.imgbox.com/d8/22/b1lqXjF4_o.jpg" alt="在这里插入图片描述"></p> 
<h3><a id="2_6"></a>2.导入我们所需要的库和完成前置工作</h3> 
<h4><a id="21_7"></a>2.1导入相关的库</h4> 
<p>torch为人工智能的库，pandas用于数据读取，numpy为张量处理的库，matplotlib为画图库</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> warnings
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>optim <span class="token keyword">as</span> optim
<span class="token keyword">import</span> random
</code></pre> 
<h4><a id="22_20"></a>2.2设置相关配置</h4> 
<p>我们设置随机种子(方便代码的复现)和警告的忽律(防止出现太多警告看不到代码运行的效果)</p> 
<pre><code class="prism language-python">warnings<span class="token punctuation">.</span>filterwarnings<span class="token punctuation">(</span><span class="token string">'ignore'</span><span class="token punctuation">)</span>
torch<span class="token punctuation">.</span>backends<span class="token punctuation">.</span>cudnn<span class="token punctuation">.</span>deterministic <span class="token operator">=</span> <span class="token boolean">True</span>
torch<span class="token punctuation">.</span>backends<span class="token punctuation">.</span>cudnn<span class="token punctuation">.</span>benchmark <span class="token operator">=</span> <span class="token boolean">False</span>
torch<span class="token punctuation">.</span>manual_seed<span class="token punctuation">(</span><span class="token number">99</span><span class="token punctuation">)</span>
np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">99</span><span class="token punctuation">)</span>
random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">99</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">"随机种子"</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="23_32"></a>2.3数据的读入</h4> 
<p>pd.read_csv里面的参数为相对位置，即代码和文件要在同一个文件夹下面。使用.head()函数来读一下数据的前几行，保证数据是存在的</p> 
<pre><code class="prism language-python">train_data <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">"LSTM-Multivariate_pollution.csv"</span><span class="token punctuation">)</span>
train_data<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/c3/34/kV2RK8Qm_o.jpg" alt="请添加图片描述"><br> 我们来看一下各个值的前2048个数据分布情况(方便挑选数据进行代码测试)<br> 代码里面的pollution可以换成dew，temp等值(也就是上图里面的值)，用于观看分布情况。</p> 
<pre><code class="prism language-python">train_use <span class="token operator">=</span> train_data<span class="token punctuation">[</span><span class="token string">"pollution"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token punctuation">[</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2048</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pollution<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2048</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>pollution:</strong><br> <img src="https://images2.imgbox.com/4b/df/f1yiEjx9_o.jpg" alt="请添加图片描述"><br> <strong>dew:</strong><br> <img src="https://images2.imgbox.com/28/6a/Dpb9SisE_o.jpg" alt="请添加图片描述"><br> <strong>temp:</strong><br> <img src="https://images2.imgbox.com/2e/f2/XubmfjI7_o.jpg" alt="请添加图片描述"><br> 我们可以看到temp属性里面的数据整体呈现上升的趋势，所以我们使用属性为temp的值来进行学习和预测。<br> 首先对数据进行归一化操作(因为值过大的话会导致神经网络损失不降低，同时神经网络难以达到收敛),我们使用minmax归一化后将其打印出来可以看到代码显示的效果</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>preprocessing <span class="token keyword">import</span> MinMaxScaler
scaler <span class="token operator">=</span> MinMaxScaler<span class="token punctuation">(</span><span class="token punctuation">)</span>
train_use <span class="token operator">=</span> scaler<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>train_use<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>train_use<span class="token punctuation">)</span><span class="token punctuation">)</span>                                                                     
<span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">"归一化处理"</span><span class="token punctuation">)</span>
</code></pre> 
<p>可以看到归一化后的结果如下图所示:<br> <img src="https://images2.imgbox.com/88/6a/oU28Dhd6_o.jpg" alt="在这里插入图片描述"><br> 我们将数据进行处理，默认使用30天的数据对第31天的数据进行预测，同时将数据进行升维处理，使得输入的训练数据为3维度，分别为batchsize，每次所需要的数据(30个数据)，和数据的输入维度(1维度)</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">split_data</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> time_step <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    dataX <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    dataY <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">-</span> time_step<span class="token punctuation">)</span><span class="token punctuation">:</span>
        dataX<span class="token punctuation">.</span>append<span class="token punctuation">(</span>data<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i <span class="token operator">+</span> time_step<span class="token punctuation">]</span><span class="token punctuation">)</span>
        dataY<span class="token punctuation">.</span>append<span class="token punctuation">(</span>data<span class="token punctuation">[</span>i <span class="token operator">+</span> time_step<span class="token punctuation">]</span><span class="token punctuation">)</span>
    dataX <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>dataX<span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>dataX<span class="token punctuation">)</span><span class="token punctuation">,</span> time_step<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    dataY <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>dataY<span class="token punctuation">)</span>
    <span class="token keyword">return</span> dataX<span class="token punctuation">,</span> dataY
</code></pre> 
<p>进行数据处理后，获得了可以训练的数据和标签</p> 
<pre><code class="prism language-python">datax<span class="token punctuation">,</span>datay <span class="token operator">=</span> split_data<span class="token punctuation">(</span>train_use<span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>datay<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>结果如下:<br> <img src="https://images2.imgbox.com/b6/02/4IcDgTrv_o.jpg" alt="请添加图片描述"></p> 
<p>紧接着我们划分训练集和测试集，默认为80%的数据用于做训练集，20%的数据用于做测试集，shuffle表示是否要将数据进行打乱，以此来测试训练效果</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">train_test_split</span><span class="token punctuation">(</span>dataX<span class="token punctuation">,</span>datay<span class="token punctuation">,</span>shuffle <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span>percentage <span class="token operator">=</span> <span class="token number">0.8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> shuffle<span class="token punctuation">:</span>
        random_num <span class="token operator">=</span> <span class="token punctuation">[</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>dataX<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>shuffle<span class="token punctuation">(</span>random_num<span class="token punctuation">)</span>
        dataX <span class="token operator">=</span> dataX<span class="token punctuation">[</span>random_num<span class="token punctuation">]</span>
        datay <span class="token operator">=</span> datay<span class="token punctuation">[</span>random_num<span class="token punctuation">]</span>
    split_num <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>dataX<span class="token punctuation">)</span><span class="token operator">*</span>percentage<span class="token punctuation">)</span>
    train_X <span class="token operator">=</span> dataX<span class="token punctuation">[</span><span class="token punctuation">:</span>split_num<span class="token punctuation">]</span>
    train_y <span class="token operator">=</span> datay<span class="token punctuation">[</span><span class="token punctuation">:</span>split_num<span class="token punctuation">]</span>
    testX <span class="token operator">=</span> dataX<span class="token punctuation">[</span>split_num<span class="token punctuation">:</span><span class="token punctuation">]</span>
    testy <span class="token operator">=</span> datay<span class="token punctuation">[</span>split_num<span class="token punctuation">:</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> train_X<span class="token punctuation">,</span> train_y<span class="token punctuation">,</span> testX<span class="token punctuation">,</span> testy
</code></pre> 
<p>获取我们的训练数据和测试数据，同时把源数据保存到X_train和y_train里面，方便以后对网络的性能进行评比。</p> 
<pre><code class="prism language-python">train_X<span class="token punctuation">,</span> train_y<span class="token punctuation">,</span> testx<span class="token punctuation">,</span>testy <span class="token operator">=</span> train_test_split<span class="token punctuation">(</span>datax<span class="token punctuation">,</span>datay<span class="token punctuation">,</span><span class="token boolean">False</span><span class="token punctuation">,</span><span class="token number">0.8</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>testx<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"datax的形状为{},dataY的形状为{}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>train_X<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> train_y<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">)</span>
X_train <span class="token operator">=</span> train_X
y_train <span class="token operator">=</span> train_y
</code></pre> 
<p>定义我们的自定义网络</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">CNN_LSTM</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> conv_input<span class="token punctuation">,</span> input_size<span class="token punctuation">,</span> hidden_size<span class="token punctuation">,</span> num_layers<span class="token punctuation">,</span> output_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>CNN_LSTM<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>hidden_size <span class="token operator">=</span> hidden_size
        self<span class="token punctuation">.</span>num_layers <span class="token operator">=</span> num_layers
        self<span class="token punctuation">.</span>conv <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv1d<span class="token punctuation">(</span>conv_input<span class="token punctuation">,</span> conv_input<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>lstm <span class="token operator">=</span> nn<span class="token punctuation">.</span>LSTM<span class="token punctuation">(</span>input_size<span class="token punctuation">,</span> hidden_size<span class="token punctuation">,</span> num_layers<span class="token punctuation">,</span> batch_first <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>hidden_size<span class="token punctuation">,</span> output_size<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        h0 <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>self<span class="token punctuation">.</span>num_layers<span class="token punctuation">,</span> x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>hidden_size<span class="token punctuation">)</span>
        c0 <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>self<span class="token punctuation">.</span>num_layers<span class="token punctuation">,</span> x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>hidden_size<span class="token punctuation">)</span>
        out<span class="token punctuation">,</span> _<span class="token operator">=</span> self<span class="token punctuation">.</span>lstm<span class="token punctuation">(</span>x<span class="token punctuation">,</span><span class="token punctuation">(</span>h0<span class="token punctuation">,</span>c0<span class="token punctuation">)</span><span class="token punctuation">)</span>
        out <span class="token operator">=</span> self<span class="token punctuation">.</span>fc<span class="token punctuation">(</span>out<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> out
</code></pre> 
<p>设置我们网络训练所需要的参数</p> 
<pre><code class="prism language-python">test_X1 <span class="token operator">=</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>testx<span class="token punctuation">)</span>
test_y1 <span class="token operator">=</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>testy<span class="token punctuation">)</span>

input_size <span class="token operator">=</span> <span class="token number">1</span>
conv_input <span class="token operator">=</span> <span class="token number">30</span>
hidden_size <span class="token operator">=</span> <span class="token number">64</span>
num_layers <span class="token operator">=</span> <span class="token number">2</span>

output_size <span class="token operator">=</span> <span class="token number">1</span>

model <span class="token operator">=</span> CNN_LSTM<span class="token punctuation">(</span>conv_input<span class="token punctuation">,</span> input_size<span class="token punctuation">,</span> hidden_size<span class="token punctuation">,</span> num_layers<span class="token punctuation">,</span>output_size<span class="token punctuation">)</span>


num_epoch <span class="token operator">=</span> <span class="token number">1000</span>
batch_size <span class="token operator">=</span> <span class="token number">4</span>

optimizer <span class="token operator">=</span> optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr <span class="token operator">=</span> <span class="token number">0.0001</span><span class="token punctuation">,</span> betas<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.999</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


criterion <span class="token operator">=</span> nn<span class="token punctuation">.</span>MSELoss<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#print ((torch.Tensor(train_X[:batch_size])))</span>
</code></pre> 
<p>开始运行代码：</p> 
<pre><code class="prism language-python">train_losses <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
test_losses <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_epoch<span class="token punctuation">)</span><span class="token punctuation">:</span>
    random_num <span class="token operator">=</span> <span class="token punctuation">[</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>train_X<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>shuffle<span class="token punctuation">(</span>random_num<span class="token punctuation">)</span>

    train_X <span class="token operator">=</span> train_X<span class="token punctuation">[</span>random_num<span class="token punctuation">]</span>
    train_y <span class="token operator">=</span> train_y<span class="token punctuation">[</span>random_num<span class="token punctuation">]</span>

    train_x1 <span class="token operator">=</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>train_X<span class="token punctuation">[</span><span class="token punctuation">:</span>batch_size<span class="token punctuation">]</span><span class="token punctuation">)</span>
    train_y1 <span class="token operator">=</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>train_y<span class="token punctuation">[</span><span class="token punctuation">:</span>batch_size<span class="token punctuation">]</span><span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>

    optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
    output <span class="token operator">=</span> model<span class="token punctuation">(</span>train_x1<span class="token punctuation">)</span>

    train_loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>output<span class="token punctuation">,</span> train_y1<span class="token punctuation">)</span>

    train_loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
    optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> epoch<span class="token operator">%</span><span class="token number">50</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">:</span>
        model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            output <span class="token operator">=</span> model<span class="token punctuation">(</span>test_X1<span class="token punctuation">)</span>
            test_loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>output<span class="token punctuation">,</span> test_y1<span class="token punctuation">)</span>
        train_losses<span class="token punctuation">.</span>append<span class="token punctuation">(</span>train_loss<span class="token punctuation">)</span>
        test_losses<span class="token punctuation">.</span>append<span class="token punctuation">(</span>test_loss<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"epoch{},train_loss:{},test_loss:{}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>epoch<span class="token punctuation">,</span> train_loss<span class="token punctuation">,</span> test_loss<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/e0/cf/TSntgUi4_o.jpg" alt="在这里插入图片描述"></p> 
<p>自己手写一个mse计算函数(直接调库也可以)，什么是mse？(均方误差，均方误差越小说明模型拟合的越好)</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">mse</span><span class="token punctuation">(</span>pred_y<span class="token punctuation">,</span> true_y<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">(</span>pred_y <span class="token operator">-</span> true_y<span class="token punctuation">)</span> <span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre> 
<p>然后我们对模型进行测试，观察mse的值</p> 
<pre><code class="prism language-python">train_X1 <span class="token operator">=</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>X_train<span class="token punctuation">)</span>
train_pred <span class="token operator">=</span> model<span class="token punctuation">(</span>train_X1<span class="token punctuation">)</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
test_pred <span class="token operator">=</span> model<span class="token punctuation">(</span>test_X1<span class="token punctuation">)</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>

pred_y <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">(</span>train_pred<span class="token punctuation">,</span> test_pred<span class="token punctuation">)</span><span class="token punctuation">)</span>
pred_y <span class="token operator">=</span> scaler<span class="token punctuation">.</span>inverse_transform<span class="token punctuation">(</span>pred_y<span class="token punctuation">)</span><span class="token punctuation">.</span>T<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

true_y <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">(</span>y_train<span class="token punctuation">,</span> testy<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">#print (true_y)</span>
true_y <span class="token operator">=</span> scaler<span class="token punctuation">.</span>inverse_transform<span class="token punctuation">(</span>true_y<span class="token punctuation">)</span><span class="token punctuation">.</span>T<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token comment">#print (true_y)</span>
<span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"mse(pred_y, true_y):</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>mse<span class="token punctuation">(</span>pred_y<span class="token punctuation">,</span> true_y<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
<span class="token comment">##print (pred_y)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/7a/8c/sC0gck2E_o.jpg" alt="在这里插入图片描述"></p> 
<p>我们取前2048个值来看我们的预测的情况(因为数据有几万条，为了避免图形太过密集难以看出效果，所以我们只采用前2048个值来进行展示)</p> 
<pre><code class="prism language-python">plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"CNN_LSTM"</span><span class="token punctuation">)</span>
x <span class="token operator">=</span> <span class="token punctuation">[</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2048</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> pred_y<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2048</span><span class="token punctuation">]</span><span class="token punctuation">,</span> marker <span class="token operator">=</span> <span class="token string">"o"</span><span class="token punctuation">,</span> markersize <span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"pred_y"</span><span class="token punctuation">,</span>color<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> true_y<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2048</span><span class="token punctuation">]</span><span class="token punctuation">,</span> marker <span class="token operator">=</span> <span class="token string">"x"</span><span class="token punctuation">,</span> markersize<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"true_y"</span><span class="token punctuation">,</span>color<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>可以看出来，已经学习到了基本的上升趋势的<br> <img src="https://images2.imgbox.com/11/d5/LAfbJhKp_o.jpg" alt="在这里插入图片描述"><br> 我们将两个图拆开来看，看到前8192个点的值，可以看到已经获得到了相对应的趋势。<br> <img src="https://images2.imgbox.com/66/b9/0O1JRaRn_o.jpg" alt="请添加图片描述"><br> <img src="https://images2.imgbox.com/ed/f9/Ppg2YVIf_o.jpg" alt="在这里插入图片描述"></p> 
<h2><a id="_222"></a>码字不易，写代码不易，点个赞再走把</h2>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/699a4e99bf02db19b49f82453f0685c1/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Excel经验分享-单元格字符统计</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ddeec5c188aecc90f4cc0497cc04c5fe/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">shell实时记录磁盘读写超过指定大小的进程</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>