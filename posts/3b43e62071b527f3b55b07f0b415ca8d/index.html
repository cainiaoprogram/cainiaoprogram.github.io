<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>docker方式安装gitlab - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="docker方式安装gitlab" />
<meta property="og:description" content="一：docker 方式安装gitlab 用docker来安装比较方便简单，包括版本升级也会变得更简单。
1、拉取gitlab镜像
gitlab-ce表示的是社区免费版本
docker pull gitlab/gitlab-ce:latest 2、创建映射文件
mkdir -p /data/docker/gitlab/etc mkdir -p /data/docker/gitlab/log mkdir -p /data/docker/gitlab/data etc映射保存配置文件，log 存储日志，data存储数据文件
3、运行gitlab容器
docker run \ --detach \ --privileged=true \ --hostname 125.74.48.123 \ --publish 443:443 --publish 8080:8080 --publish 5000:22 \ --name mygitlab \ --restart unless-stopped \ --volume /data/docker/gitlab/etc:/etc/gitlab \ --volume /data/docker/gitlab/log:/var/log/gitlab \ --volume /data/docker/gitlab/data:/var/opt/gitlab \ gitlab/gitlab-ce:latest hostname : 安装服务的ippublish 443:443 https的端口，左边是宿主机对外端口，右边是容器内端口publish 8080:8080 http访问的端口。左边是宿主机对外端口，右边是容器内端口publish 5000:22 ssh方式下载对应的端口，左边是宿主机对外端口，右边是容器内端口
注意，要用http方式连接，publish 8080:8080 前后两个端口需要一样。 容器启动后，还需要做配置调整
二、gitlab相关配置 1、配置容器中/etc/gitlab/gitlab.rb的配置文件 因为我们已经把容器的/etc目录映射到了本机的/data/docker/gitlab/etc 这个目录，我们打开" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/3b43e62071b527f3b55b07f0b415ca8d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-01T08:51:16+08:00" />
<meta property="article:modified_time" content="2023-12-01T08:51:16+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">docker方式安装gitlab</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="docker_gitlab_0"></a>一：docker 方式安装gitlab</h2> 
<p>用docker来安装比较方便简单，包括版本升级也会变得更简单。</p> 
<p>1、拉取gitlab镜像<br> gitlab-ce表示的是社区免费版本</p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> pull gitlab/gitlab-ce:latest
</code></pre> 
<p>2、创建映射文件</p> 
<pre><code class="prism language-bash"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /data/docker/gitlab/etc
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /data/docker/gitlab/log
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /data/docker/gitlab/data

</code></pre> 
<p>etc映射保存配置文件，log 存储日志，data存储数据文件</p> 
<p>3、运行gitlab容器</p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> run <span class="token punctuation">\</span>
    <span class="token parameter variable">--detach</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--privileged</span><span class="token operator">=</span>true <span class="token punctuation">\</span>
    <span class="token parameter variable">--hostname</span> <span class="token number">125.74</span>.48.123 <span class="token punctuation">\</span>
    <span class="token parameter variable">--publish</span> <span class="token number">443</span>:443 <span class="token parameter variable">--publish</span> <span class="token number">8080</span>:8080 <span class="token parameter variable">--publish</span> <span class="token number">5000</span>:22 <span class="token punctuation">\</span>
    <span class="token parameter variable">--name</span> mygitlab <span class="token punctuation">\</span>
    <span class="token parameter variable">--restart</span> unless-stopped <span class="token punctuation">\</span>
    <span class="token parameter variable">--volume</span> /data/docker/gitlab/etc:/etc/gitlab <span class="token punctuation">\</span>
    <span class="token parameter variable">--volume</span> /data/docker/gitlab/log:/var/log/gitlab <span class="token punctuation">\</span>
    <span class="token parameter variable">--volume</span> /data/docker/gitlab/data:/var/opt/gitlab <span class="token punctuation">\</span>
    gitlab/gitlab-ce:latest
</code></pre> 
<ul><li>hostname : 安装服务的ip</li><li>publish 443:443 https的端口，左边是宿主机对外端口，右边是容器内端口</li><li>publish 8080:8080 http访问的端口。左边是宿主机对外端口，右边是容器内端口</li><li>publish 5000:22 ssh方式下载对应的端口，左边是宿主机对外端口，右边是容器内端口<br> 注意，要用http方式连接，publish 8080:8080 前后两个端口需要一样。</li></ul> 
<p>容器启动后，还需要做配置调整</p> 
<h2><a id="gitlab_42"></a>二、gitlab相关配置</h2> 
<h3><a id="1etcgitlabgitlabrb_43"></a>1、配置容器中/etc/gitlab/gitlab.rb的配置文件</h3> 
<p>因为我们已经把容器的/etc目录映射到了本机的/data/docker/gitlab/etc 这个目录，我们打开<br> /data/docker/gitlab/etc//gitlab/gitlab.rb 这个文件就可以修改<br> 修改的内容如下：</p> 
<pre><code class="prism language-bash">external_url <span class="token string">'http://125.74.48.123'</span>
<span class="token comment">#ssh连接的端口</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'gitlab_shell_ssh_port'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">5000</span>
<span class="token comment">#http 访问的端口</span>
nginx<span class="token punctuation">[</span><span class="token string">'listen_port'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">8080</span>
<span class="token comment">#备份文件保留的时长，单位是秒</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'backup_keep_time'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">604800</span>
</code></pre> 
<p>修改配置后重启容器</p> 
<p>访问http://125.74.48.123:8080/users/sign_in 就可以打开页面了<br> 初始账户: root 密码:5iveL!fe，进入就会让你修改密码<br> <img src="https://images2.imgbox.com/61/07/WOrtxB2z_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="2varoptgitlabgitlabrailsetcgitlabyml__62"></a>2、/var/opt/gitlab/gitlab-rails/etc/gitlab.yml 文件配置</h3> 
<p>当时我已经创建了项目，在项目详情页复制了项目地址，一直下载不下来，发现详情页显示的没有带端口号，实际克隆的时候需要端口号的，如：http://125.74.48.123:8080/root/test_project.git .<br> 这个是要我们要/var/opt/gitlab/gitlab-rails/etc/gitlab.yml的端口<br> 首先进入容器：</p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> gitlab的容器id /bin/bash
</code></pre> 
<pre><code class="prism language-bash"><span class="token function">vim</span> /var/opt/gitlab/gitlab-rails/etc/gitlab.yml
</code></pre> 
<p>将文件中的port改成8080</p> 
<pre><code class="prism language-bash">host: localhost
port: <span class="token number">8080</span>
https: <span class="token boolean">false</span>

</code></pre> 
<p>在容器中执行：</p> 
<pre><code class="prism language-bash">gitlab-ctl restart

</code></pre> 
<p>注意这里的命令是restart不是 reconfigure(根据配置文件/etc/gitlab/gitlab.rb 重新生成配置) ，否则还会恢复原来的配置。只要执行了gitlab-ctl reconfigure,gitlab.yml中的端口配置就会被还原。<br> 所以如果你重启了容器之后，那这里的端口就又需要改一遍。<br> 重启后退出容器<br> ●先按，ctrl+p<br> ●再按，ctrl+q</p> 
<h2><a id="_94"></a>三、做定时备份</h2> 
<p>docker方式安装的执行备份的命令：</p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> mygitlab gitlab-backup create     <span class="token comment">#mygitlab是容器名称</span>
</code></pre> 
<p>添加定时任务：<br> crontab -e 在文本中添加下面内容：</p> 
<pre><code class="prism language-bash"><span class="token number">0</span> <span class="token number">23</span> <span class="token number">1</span> * *  <span class="token function">docker</span> <span class="token builtin class-name">exec</span> mygitlab gitlab-backup create
</code></pre> 
<p>比如我这个是每个月1号的23点开始备份，这个多久备份一次根据自己的需求来设置。</p> 
<h2><a id="_108"></a>四、还原备份</h2> 
<p>1、进入到备份目录：/data/docker/gitlab/data/backups<br> 备份发文如下：<br> <img src="https://images2.imgbox.com/b0/23/dwI1PFBZ_o.png" alt="在这里插入图片描述"><br> 执行备份命令：</p> 
<pre><code class="prism language-bash">gitlab-rake gitlab:backup:restore <span class="token assign-left variable">BACKUP</span><span class="token operator">=</span>1685631631_2023_06_01_14.10.4
</code></pre> 
<p>注意这里不要带_gitlab_backup.tar后缀，还原的时候版本需要是一致的</p> 
<h2><a id="_119"></a>五、版本升级</h2> 
<p>版本升级是有路线的，要按照对应的版本升级，查看网站 https://docs.gitlab.com/ee/update/#upgrade-paths<br> <img src="https://images2.imgbox.com/a9/f5/rmVppIf1_o.png" alt="在这里插入图片描述"><br> 下载到对应的版本镜像，比如我现在的是14.0.12 我要升级到14.3.6<br> 1、下载14.3.6的镜像</p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> pull gitlab/gitlab-ce:14.3.6-ce.0
</code></pre> 
<p>2、将现在的运行的容器停止</p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> stop  gitlab的容器id
</code></pre> 
<p>3、删除现在的容器</p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> <span class="token function">rm</span> gitlab的容器id
</code></pre> 
<p>4、重新运行14.3.6镜像的容器</p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> run <span class="token punctuation">\</span>
    <span class="token parameter variable">--detach</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--privileged</span><span class="token operator">=</span>true <span class="token punctuation">\</span>
    <span class="token parameter variable">--hostname</span> <span class="token number">125.74</span>.48.123 <span class="token punctuation">\</span>
    <span class="token parameter variable">--publish</span> <span class="token number">443</span>:443 <span class="token parameter variable">--publish</span> <span class="token number">8080</span>:8080 <span class="token parameter variable">--publish</span> <span class="token number">5000</span>:22 <span class="token punctuation">\</span>
    <span class="token parameter variable">--name</span> mygitlab <span class="token punctuation">\</span>
    <span class="token parameter variable">--restart</span> unless-stopped <span class="token punctuation">\</span>
    <span class="token parameter variable">--volume</span> /data/docker/gitlab/etc:/etc/gitlab <span class="token punctuation">\</span>
    <span class="token parameter variable">--volume</span> /data/docker/gitlab/log:/var/log/gitlab <span class="token punctuation">\</span>
    <span class="token parameter variable">--volume</span> /data/docker/gitlab/data:/var/opt/gitlab <span class="token punctuation">\</span>
    gitlab/gitlab-ce:14.3.6-ce.0
</code></pre> 
<p>5、容器启动后验证登录是否正常。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5261f5e157b586a51dc0d440995e288c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">AUTOSAR专栏——总目录</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/26531634abba08a16c39362e0d79224f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【开源】基于Vue.js的停车场收费系统</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>