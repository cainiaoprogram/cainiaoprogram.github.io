<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>一个有趣的问题---java.lang.String的&#43;到底做了什么 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="一个有趣的问题---java.lang.String的&#43;到底做了什么" />
<meta property="og:description" content="前段时间同学问了我一个有趣的问题：
String str3 = &#34;what&#34;; String str4 = str3 &#43; &#34; a nice day&#34;; //运行时， &#43; 相当于 new，所以堆中会有 &#34;what a nice day&#34;对象，常量池中会有&#34;what&#34;,&#34; a nice day&#34;两个对象，而不会有 &#34;what a nice day&#34;对象。 //这句话大佬们看看对不对啊，我怎么感觉不对啊 //常量池不会有&#34;what a nice day&#34; 对象吗？ 看完这个问题，说实话我也是有点懵的，我只是知道 &#34;what a nice day&#34;不会在常量池，但是不知道具体的原因，后来问了同事说 &#43; 号是调用了 StringBuffer 的append 方法。
我去证实了，发现确实调用了 append 方法，但是当时没有调用toString()方法，我很疑惑。（最后经过证实，是StringBuilder的append 方法，不是StringBuffer）。
代码验证：
public static void main(String[] args) { //#1 String str1 = &#34;what&#34;; //#2 String str2 = str1 &#43; &#34; a nice day&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/b876bcf683388b9738ffaba4d2b7931f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-01-18T15:36:10+08:00" />
<meta property="article:modified_time" content="2020-01-18T15:36:10+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">一个有趣的问题---java.lang.String的&#43;到底做了什么</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>前段时间同学问了我一个有趣的问题：</p> 
<pre><code>String str3 = "what";
String str4 = str3 + " a nice day";
//运行时， + 相当于 new，所以堆中会有 "what a nice day"对象，常量池中会有"what"," a nice day"两个对象，而不会有 "what a nice day"对象。
//这句话大佬们看看对不对啊，我怎么感觉不对啊
//常量池不会有"what a nice day" 对象吗？
</code></pre> 
<p>看完这个问题，说实话我也是有点懵的，我只是知道 "what a nice day"不会在常量池，但是不知道具体的原因，后来问了同事说 + 号是调用了 StringBuffer 的append 方法。</p> 
<p>我去证实了，发现确实调用了 append 方法，但是当时没有调用toString()方法，我很疑惑。（最后经过证实，是StringBuilder的append 方法，不是StringBuffer）。</p> 
<p>代码验证：</p> 
<pre><code>public static void main(String[] args) {
    //#1
    String str1 = "what";
    //#2
    String str2 = str1 + " a nice day";
    //#3
    System.out.println("what a nice day".equals(str2));
    //#4
    System.out.println("what a nice day" == str2);
}
</code></pre> 
<p>现在有以下几个问题，小伙伴们看看是否能答出来，即使答出来了，你知道为什么吗？</p> 
<ol><li>str1存放位置？</li><li>str2存放位置？</li><li>#3的结果是true还是false？</li><li>#4的结果是true还是false？</li><li>“what a nice day” 存放在哪个位置？</li></ol> 
<h5><a id="_34"></a>直接看生成的字节码：</h5> 
<pre><code>public class com.qwx.string.test.Main
  minor version: 0
  major version: 52
  flags: ACC_PUBLIC, ACC_SUPER
Constant pool:
   #1 = Methodref          #13.#34        // java/lang/Object."&lt;init&gt;":()V
   #2 = String             #35            // what
   #3 = Class              #36            // java/lang/StringBuilder
   #4 = Methodref          #3.#34         // java/lang/StringBuilder."&lt;init&gt;":()V
   #5 = Methodref          #3.#37         // java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
   #6 = String             #38            //  a nice day
   #7 = Methodref          #3.#39         // java/lang/StringBuilder.toString:()Ljava/lang/String;
   #8 = Fieldref           #40.#41        // java/lang/System.out:Ljava/io/PrintStream;
   #9 = String             #42            // what a nice day
  #10 = Methodref          #43.#44        // java/lang/String.equals:(Ljava/lang/Object;)Z
  #11 = Methodref          #45.#46        // java/io/PrintStream.println:(Z)V
  #12 = Class              #47            // com/fanpan26/string/test/Main
  #13 = Class              #48            // java/lang/Object
  #14 = Utf8               &lt;init&gt;
  #15 = Utf8               ()V
  #16 = Utf8               Code
  #17 = Utf8               LineNumberTable
  #18 = Utf8               LocalVariableTable
  #19 = Utf8               this
  #20 = Utf8               Lcom/qwx/string/test/Main;
  #21 = Utf8               main
  #22 = Utf8               ([Ljava/lang/String;)V
  #23 = Utf8               args
  #24 = Utf8               [Ljava/lang/String;
  #25 = Utf8               str1
  #26 = Utf8               Ljava/lang/String;
  #27 = Utf8               str2
  #28 = Utf8               StackMapTable
  #29 = Class              #24            // "[Ljava/lang/String;"
  #30 = Class              #49            // java/lang/String
  #31 = Class              #50            // java/io/PrintStream
  #32 = Utf8               SourceFile
  #33 = Utf8               Main.java
  #34 = NameAndType        #14:#15        // "&lt;init&gt;":()V
  #35 = Utf8               what
  #36 = Utf8               java/lang/StringBuilder
  #37 = NameAndType        #51:#52        // append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
  #38 = Utf8                a nice day
  #39 = NameAndType        #53:#54        // toString:()Ljava/lang/String;
  #40 = Class              #55            // java/lang/System
  #41 = NameAndType        #56:#57        // out:Ljava/io/PrintStream;
  #42 = Utf8               what a nice day
  #43 = Class              #49            // java/lang/String
  #44 = NameAndType        #58:#59        // equals:(Ljava/lang/Object;)Z
  #45 = Class              #50            // java/io/PrintStream
  #46 = NameAndType        #60:#61        // println:(Z)V
  #47 = Utf8               com/qwx/string/test/Main
  #48 = Utf8               java/lang/Object
  #49 = Utf8               java/lang/String
  #50 = Utf8               java/io/PrintStream
  #51 = Utf8               append
  #52 = Utf8               (Ljava/lang/String;)Ljava/lang/StringBuilder;
  #53 = Utf8               toString
  #54 = Utf8               ()Ljava/lang/String;
  #55 = Utf8               java/lang/System
  #56 = Utf8               out
  #57 = Utf8               Ljava/io/PrintStream;
  #58 = Utf8               equals
  #59 = Utf8               (Ljava/lang/Object;)Z
  #60 = Utf8               println
  #61 = Utf8               (Z)V
{
  public com.qwx.string.test.Main();
    descriptor: ()V
    flags: ACC_PUBLIC
    Code:
      stack=1, locals=1, args_size=1
         0: aload_0
         1: invokespecial #1                  // Method java/lang/Object."&lt;init&gt;":()V
         4: return
      LineNumberTable:
        line 6: 0
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0       5     0  this   Lcom/qwx/string/test/Main;

  public static void main(java.lang.String[]);
    descriptor: ([Ljava/lang/String;)V
    flags: ACC_PUBLIC, ACC_STATIC
    Code:
      stack=3, locals=3, args_size=1
         0: ldc           #2                  // String what
         2: astore_1
         3: new           #3                  // class java/lang/StringBuilder
         6: dup
         7: invokespecial #4                  // Method java/lang/StringBuilder."&lt;init&gt;":()V
        10: aload_1
        11: invokevirtual #5                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
        14: ldc           #6                  // String  a nice day
        16: invokevirtual #5                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
        19: invokevirtual #7                  // Method java/lang/StringBuilder.toString:()Ljava/lang/String;
        22: astore_2
        23: getstatic     #8                  // Field java/lang/System.out:Ljava/io/PrintStream;
        26: ldc           #9                  // String what a nice day
        28: aload_2
        29: invokevirtual #10                 // Method java/lang/String.equals:(Ljava/lang/Object;)Z
        32: invokevirtual #11                 // Method java/io/PrintStream.println:(Z)V
        35: getstatic     #8                  // Field java/lang/System.out:Ljava/io/PrintStream;
        38: ldc           #9                  // String what a nice day
        40: aload_2
        41: if_acmpne     48
        44: iconst_1
        45: goto          49
        48: iconst_0
        49: invokevirtual #11                 // Method java/io/PrintStream.println:(Z)V
        52: return
      LineNumberTable:
        line 9: 0
        line 11: 3
        line 13: 23
        line 15: 35
        line 16: 52
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0      53     0  args   [Ljava/lang/String;
            3      50     1  str1   Ljava/lang/String;
           23      30     2  str2   Ljava/lang/String;
      StackMapTable: number_of_entries = 2
        frame_type = 255 /* full_frame */
          offset_delta = 48
          locals = [ class "[Ljava/lang/String;", class java/lang/String, class java/lang/String ]
          stack = [ class java/io/PrintStream ]
        frame_type = 255 /* full_frame */
          offset_delta = 0
          locals = [ class "[Ljava/lang/String;", class java/lang/String, class java/lang/String ]
          stack = [ class java/io/PrintStream, int ]
}
SourceFile: "Main.java"
</code></pre> 
<p>从Constant pool: 中的信息可以看到，#2 、#6、#9 可以解答上文中的1,5两个问题。</p> 
<ul><li>str1 是存放在常量池的</li><li>“what a nice day” （非str2）也是存放在常量池的</li></ul> 
<p>下面我们看一下 + 操作做了什么事情，可以在Code中看到，该操作调用了 StringBuilder.append 方法:</p> 
<pre><code>11: invokevirtual #5                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
14: ldc           #6                  // String  a nice day
16: invokevirtual #5                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
19: invokevirtual #7                  // Method java/lang/StringBuilder.toString:()Ljava/lang/String;
</code></pre> 
<p>那么到这里一切都答案都出来了:</p> 
<ul><li>str2 是存放在堆中</li><li>equals 为 true</li><li>== 为 false</li></ul> 
<p>所以说其实 str1 + " a nice day" 就相当于 new StringBuilder().append(str1).append(" a nice day");</p> 
<pre><code>//这两种写法生成的字节码是一样的。
//String str2 = str1 + " a nice day";
String str2 = new StringBuilder().append(str1).append(" a nice day").toString();
</code></pre> 
<p>而StringBuffer的toString 方法如下：</p> 
<pre><code>@Override
public String toString() {
    // 所以说 str2 其实是一个 new String，是不在常量池里面的。
    return new String(value, 0, count);
}
</code></pre> 
<p>还有，遇到一个问题，不能死记答案，有些人告诉你，+ 操作就是 new 对象，但是具体到底是不是或者为什么是有没有思考过呢？上文中如有错误，欢迎指出。</p> 
<p>试一试：</p> 
<pre><code>/**
 * 以下程序输出的结果是什么？
 * */
public static void main(String[] args) {
    String str1 = "what";
    String str2 = str1 + " a nice day";
    System.out.println("what a nice day".equals(str2));
    System.out.println("what a nice day" == str2);
}
/**
 * 以下程序输出的结果是什么？
 * */
public static void main(String[] args) {
    String str1 = "what a nice day";
    String str2 = new String("what a nice day");
    System.out.println(str1.equals(str2));
    System.out.println(str1 == str2);
}
/**
 * 以下程序输出的结果是什么？
 * */
public static void main(String[] args) {
    String str1 = "what";
    String str2 = str1.concat(" a nice day");
    System.out.println("what a nice day".equals(str2));
    System.out.println("what a nice day" == str2);
    System.out.println("what a nice day"==str2.intern());
}

</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5dc98a934e17aa6bc0b3dcd3a9f3350b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Opencv之特征匹配</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/059192c85ba3c0767c0773d1d5254a93/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">JDK8时间类</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>