<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android资源管理框架-------之资源管理的基本数据结构和Bag资源（四） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android资源管理框架-------之资源管理的基本数据结构和Bag资源（四）" />
<meta property="og:description" content="资源管理的基本数据结构 上一篇我们介绍了resources.arsc以及与之相关的主要数据结构，这些数据结构大多以ResTable_开头，主要是用来描述resources.arsc非常方便。不过，要用这些数据结构来对Android资源进行管理，还是有些吃力，Android为了更加方便地管理资源，还有另外一套数据结构，它们主要是ResTable和ResTable的内部类。
与resources.arsc相关的数据结构当中，最主要的是ResTable_package、ResTable_type、ResTable_entry这三级架构，也和资源id形式0xpptteeee（pp表示最高的一个字节表示包id，第二高的一个字节表示type id，最后两个字节表示entry id）相一致。但是，要对实现对这三级资源架构的管理，要依靠的绝对不仅仅是这三级。确切地说，Android资源管理中用到，但是resources.arsc中没有用到数据结构，主要是ResTable、ResTable::PackageGroup、ResTable::Package、ResTable::TypeList、ResTable::Type、ResTable::Entry。其中，ResTable::Package、ResTable::Entry和ResTable_package、ResTable_entry对应；ResTable::Type和ResTable_type的意义完全不一样；ResTable、ResTable::PackageGroup、ResTable::TypeList是resources.arsc中没有类似的数据结构与之对应。我们这里再着重说一下，ResTable_开头的数据结构偏重于对resources.arsc的描述，而ResTable::系列的数据结构是用来对资源信息进行管理的，AssetManager中的许多接口功能的实现都要依赖它们。
ResTable Android资源管理框架-------之Android中的资源包（二）中，我们知道一个AssetManager可能会加载许多资源包，包括Android系统资源包也就是framework-res.apk、Soc厂商资源包、手机厂商资源包以及App本身，甚至还有可能存在overlay包、资源共享库等等。那么这些资源包中的resources.arsc加载后被存到了哪里呢？最终它们都会被存放到一个ResTable的对象中，并且这个对象是native层AssetManager的一个成员。也就是说，一个ResTable对象会存储它所在的AssetManager加载的所有资源包中的resources.arsc，并且对这些resources.arsc做统一的管理，这一点我们一定要注意。
//frameworks/base/include/androidfw/ResourceTypes.h class ResTable { //......省略无关代码 private: /** * 当前设备配置信息，我们去获取资源时，要根据它来选择合适的资源 * 我们给AssetManager设置或者更新配置信息时，最终也会存在这里 */ ResTable_config mParams; /** * 存放我们加载的所有资源包中的resources.arsc * 当然它不会把整个resources.arsc都放进来，只是放入了每个resources.arsc的header信息 * 这样通过header我们可以访问整个resources.arsc */ Vector&lt;Header*&gt; mHeaders; //我们加载过来的资源包相关的信息都会放到这个数据结构中 Vector&lt;PackageGroup*&gt; mPackageGroups; /** * 这是一个Map，key为下标，具体为加载的package的id， * value为，这个package在mPackageGroups中的索引 &#43; 1 */ uint8_t mPackageMap[256]; //分配给下一个资源共享库的临时PackageId uint8_t mNextPackageId; } 我们看到一个内部，存储的关键信息就三个：mParams存储配置信息、mHeaders存储加载的resources.arsc、mPackageGroups存储加载的资源包相关的信息。如果不考虑Runtime Resources Overlay，一个id为packageId的资源包的信息为mPackageGroups[mPackageMap[packageId] - 1]。另外，在resources.arsc中，资源共享库的packageId都是0，所以加载的时候要为它们动态分配一个id，mNextPackageId就是做这个用的。
ResTable::PackageGroup 按照一般的逻辑，一个ResTable对象中直接存放一个ResTable::Package的集合就可以了，为什么我们看到的却是存放了一个ResTable::PackageGroup的集合呢？并且从ResTable::PackageGroup的实现来看它的内部确确实实又是存在多个ResTable::Package的，这个怎么理解呢？
//frameworks/base/lib/androidfw/ResourceTypes.cpp struct ResTable::PackageGroup { //......省略无关代码 //这个PackageGroup所属的ResTable const ResTable* const owner; /** * 这个PackageGroup的name，为这个PackageGroup中第一个Package的name */ String16 const name; uint32_t const id; //这个PackageGroup内的所有Package Vector&lt;Package*&gt; packages; /** * 每一个元素都代表一种类型的资源 * 当我们访问资源时，是通过PackageGroup到TypeList，再到Type，再到Entry * 中间并不会经过上面的packages变量 */ ByteBucketArray&lt;TypeList&gt; types; //最大typeId uint8_t largestTypeId; //这个PackageGroup所有的bag资源，这个后面会单讲，现在可以先无视之 ByteBucketArray&lt;bag_set**&gt;* bags; //资源共享库相关的数据结构 DynamicRefTable dynamicRefTable; } 其实，ResTable::PackageGroup的存在，是为了Runtime Resources Overlay（简称RRO），一般情况下一个ResTable::PackageGroup里只会有一个ResTable::Package，包括我们的应用包（id：0x7f）、系统资源包（id：0x01）、Soc厂商资源包、手机厂商资源包以及资源共享库包等等。但是有RRO时，系统会把target包和overlay包放到同一个ResTable::PackageGroup中，以便获取资源时可以快速地定位overlay包中的资源。并且target包会被放到packages[0]，overlay包则会放到后面，这个ResTable::PackageGroup的包名和id都会以target包为准。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/82566d2a2916fdc18a93920d7ae94296/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-09-30T16:35:29+08:00" />
<meta property="article:modified_time" content="2019-09-30T16:35:29+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android资源管理框架-------之资源管理的基本数据结构和Bag资源（四）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>资源管理的基本数据结构</h3> 
<p>        上一篇我们介绍了resources.arsc以及与之相关的主要数据结构，这些数据结构大多以ResTable_开头，主要是用来描述resources.arsc非常方便。不过，要用这些数据结构来对Android资源进行管理，还是有些吃力，Android为了更加方便地管理资源，还有另外一套数据结构，它们主要是<code>ResTable</code>和<code>ResTable</code>的内部类。</p> 
<p>        与resources.arsc相关的数据结构当中，最主要的是<code>ResTable_package</code>、<code>ResTable_type</code>、<code>ResTable_entry</code>这三级架构，也和资源id形式0xpptteeee（pp表示最高的一个字节表示包id，第二高的一个字节表示type id，最后两个字节表示entry id）相一致。但是，要对实现对这三级资源架构的管理，要依靠的绝对不仅仅是这三级。确切地说，Android资源管理中用到，但是resources.arsc中没有用到数据结构，主要是<code>ResTable</code>、<code>ResTable::PackageGroup</code>、<code>ResTable::Package</code>、<code>ResTable::TypeList</code>、<code>ResTable::Type</code>、<code>ResTable::Entry</code>。其中，<code>ResTable::Package</code>、<code>ResTable::Entry</code>和<code>ResTable_package</code>、<code>ResTable_entry</code>对应；<code>ResTable::Type</code>和<code>ResTable_type</code>的意义完全不一样；<code>ResTable</code>、<code>ResTable::PackageGroup</code>、<code>ResTable::TypeList</code>是resources.arsc中没有类似的数据结构与之对应。我们这里再着重说一下，<code>ResTable_</code>开头的数据结构偏重于对resources.arsc的描述，而<code>ResTable::</code>系列的数据结构是用来对资源信息进行管理的，AssetManager中的许多接口功能的实现都要依赖它们。</p> 
<h5><a id="ResTable_5"></a>ResTable</h5> 
<p>        <a href="https://blog.csdn.net/dayong198866/article/details/100153033">Android资源管理框架-------之Android中的资源包（二）</a>中，我们知道一个AssetManager可能会加载许多资源包，包括Android系统资源包也就是framework-res.apk、Soc厂商资源包、手机厂商资源包以及App本身，甚至还有可能存在<a href="https://blog.csdn.net/dayong198866/article/details/96107063">overlay包</a>、<a href="https://blog.csdn.net/dayong198866/article/details/95226237">资源共享库</a>等等。那么这些资源包中的resources.arsc加载后被存到了哪里呢？最终它们都会被存放到一个<code>ResTable</code>的对象中，并且这个对象是native层<code>AssetManager</code>的一个成员。也就是说，一个<code>ResTable</code>对象会存储它所在的AssetManager加载的所有资源包中的resources.arsc，并且对这些resources.arsc做统一的管理，这一点我们一定要注意。</p> 
<pre><code class="prism language-cpp"><span class="token comment">//frameworks/base/include/androidfw/ResourceTypes.h</span>
<span class="token keyword">class</span> <span class="token class-name">ResTable</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//......省略无关代码</span>
    
    <span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token comment">/**
    * 当前设备配置信息，我们去获取资源时，要根据它来选择合适的资源
    * 我们给AssetManager设置或者更新配置信息时，最终也会存在这里
    */</span>
    ResTable_config             mParams<span class="token punctuation">;</span>
    <span class="token comment">/**
    * 存放我们加载的所有资源包中的resources.arsc
    * 当然它不会把整个resources.arsc都放进来，只是放入了每个resources.arsc的header信息
    * 这样通过header我们可以访问整个resources.arsc
    */</span>
    Vector<span class="token operator">&lt;</span>Header<span class="token operator">*</span><span class="token operator">&gt;</span>             mHeaders<span class="token punctuation">;</span>
    
    <span class="token comment">//我们加载过来的资源包相关的信息都会放到这个数据结构中</span>
    Vector<span class="token operator">&lt;</span>PackageGroup<span class="token operator">*</span><span class="token operator">&gt;</span>       mPackageGroups<span class="token punctuation">;</span>
    <span class="token comment">/**
    * 这是一个Map，key为下标，具体为加载的package的id，
    * value为，这个package在mPackageGroups中的索引 + 1
    */</span>
    <span class="token keyword">uint8_t</span>                     mPackageMap<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token comment">//分配给下一个资源共享库的临时PackageId</span>
    <span class="token keyword">uint8_t</span>                     mNextPackageId<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>        我们看到一个内部，存储的关键信息就三个：<code>mParams</code>存储配置信息、<code>mHeaders</code>存储加载的resources.arsc、mPackageGroups存储加载的资源包相关的信息。如果不考虑<a href="https://blog.csdn.net/dayong198866/article/details/96107063">Runtime Resources Overlay</a>，一个id为<code>packageId</code>的资源包的信息为<code>mPackageGroups[mPackageMap[packageId] - 1]</code>。另外，在resources.arsc中，<a href="https://blog.csdn.net/dayong198866/article/details/95226237">资源共享库</a>的packageId都是0，所以加载的时候要为它们动态分配一个id，mNextPackageId就是做这个用的。</p> 
<h5><a id="ResTablePackageGroup_40"></a>ResTable::PackageGroup</h5> 
<p>        按照一般的逻辑，一个<code>ResTable</code>对象中直接存放一个<code>ResTable::Package</code>的集合就可以了，为什么我们看到的却是存放了一个<code>ResTable::PackageGroup</code>的集合呢？并且从<code>ResTable::PackageGroup</code>的实现来看它的内部确确实实又是存在多个<code>ResTable::Package</code>的，这个怎么理解呢？</p> 
<pre><code class="prism language-cpp"><span class="token comment">//frameworks/base/lib/androidfw/ResourceTypes.cpp</span>
<span class="token keyword">struct</span> ResTable<span class="token operator">::</span>PackageGroup
<span class="token punctuation">{<!-- --></span>

    <span class="token comment">//......省略无关代码</span>

    <span class="token comment">//这个PackageGroup所属的ResTable</span>
    <span class="token keyword">const</span> ResTable<span class="token operator">*</span> <span class="token keyword">const</span>           owner<span class="token punctuation">;</span>

    <span class="token comment">/**
    * 这个PackageGroup的name，为这个PackageGroup中第一个Package的name
    */</span>
    String16 <span class="token keyword">const</span>                  name<span class="token punctuation">;</span>
    <span class="token keyword">uint32_t</span> <span class="token keyword">const</span>                  id<span class="token punctuation">;</span>

    <span class="token comment">//这个PackageGroup内的所有Package</span>
    Vector<span class="token operator">&lt;</span>Package<span class="token operator">*</span><span class="token operator">&gt;</span>                packages<span class="token punctuation">;</span>
    <span class="token comment">/**
    * 每一个元素都代表一种类型的资源
    * 当我们访问资源时，是通过PackageGroup到TypeList，再到Type，再到Entry
    * 中间并不会经过上面的packages变量
    */</span>
    ByteBucketArray<span class="token operator">&lt;</span>TypeList<span class="token operator">&gt;</span>       types<span class="token punctuation">;</span>

    <span class="token comment">//最大typeId</span>
    <span class="token keyword">uint8_t</span>                         largestTypeId<span class="token punctuation">;</span>

    <span class="token comment">//这个PackageGroup所有的bag资源，这个后面会单讲，现在可以先无视之</span>
    ByteBucketArray<span class="token operator">&lt;</span>bag_set<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token operator">*</span>     bags<span class="token punctuation">;</span>

    <span class="token comment">//资源共享库相关的数据结构</span>
    DynamicRefTable                 dynamicRefTable<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>        其实，<code>ResTable::PackageGroup</code>的存在，是为了<a href="https://blog.csdn.net/dayong198866/article/details/96107063">Runtime Resources Overlay</a>（简称RRO），一般情况下一个<code>ResTable::PackageGroup</code>里只会有一个<code>ResTable::Package</code>，包括我们的应用包（id：0x7f）、系统资源包（id：0x01）、Soc厂商资源包、手机厂商资源包以及<a href="https://blog.csdn.net/dayong198866/article/details/95226237">资源共享库</a>包等等。但是有RRO时，系统会把target包和overlay包放到同一个<code>ResTable::PackageGroup</code>中，以便获取资源时可以快速地定位overlay包中的资源。并且target包会被放到<code>packages[0]</code>，overlay包则会放到后面，这个<code>ResTable::PackageGroup</code>的包名和id都会以target包为准。</p> 
<h5><a id="ResTableTypeList_78"></a>ResTable::TypeList</h5> 
<pre><code class="prism language-cpp"><span class="token comment">//frameworks/base/include/androidfw/ResourceTypes.h</span>

<span class="token keyword">typedef</span> Vector<span class="token operator">&lt;</span>Type<span class="token operator">*</span><span class="token operator">&gt;</span> TypeList<span class="token punctuation">;</span>
</code></pre> 
<p>        <code>ResTable::TypeList</code>的定义非常简单。我们前面说过，访问资源时，通过<code>ResTable::PackageGroup</code>，到<code>ResTable::TypeList</code>，再到<code>ResTable::Type</code>，再到<code>ResTable::Entry</code>。我们看到，<code>ResTable::PackageGroup</code>的<code>types</code>成员是一个数组，这个数组中的每一个元素也就是<code>ResTable::TypeList</code>代表一种特定类型的资源，比如drawable、string等。但是，<code>ResTable::TypeList</code>本身又是一个<code>ResTable::Type</code>类型的数组，这个我们又该怎么理解呢？<code>ResTable::TypeList</code>里的每一个<code>ResTable::Type</code>对应一个不同的配置吗？ No！实际情况是这样的：<code>ResTable::TypeList</code>和<code>ResTable::PackageGroup</code>类似，也是为了处理<a href="https://blog.csdn.net/dayong198866/article/details/96107063">Runtime Resources Overlay</a>。一般情况下，它的里面也是只有一个元素的，当有RRO的时候，我们可以通过下面的例子来理解：</p> 
<pre><code class="prism language-xml">//target package
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resources</span><span class="token punctuation">&gt;</span></span>
     ......
    
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>string</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>app_greeting<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Goog Morning<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>string</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>string</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>app_appologize<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Sorry<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>string</span><span class="token punctuation">&gt;</span></span>
     
      ......
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resources</span><span class="token punctuation">&gt;</span></span>

// overlay package
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resources</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>string</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>app_greeting<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Goog Night<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>string</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resources</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>        在这个例子中，我们试图通过overlay package来改变字符串<code>app_greeting</code>的值。那么，在加载完target package后，overlay package也会被加载到 target package所在的ResTable中，并且会和target package放到同一个<code>ResTable::PackageGroup</code>中。并且，overlay package中的所有string类型的资源都会被系统放到target package中的string类型的资源所在的<code>ResTable::TypeList</code>中。也就是说 overlay package和target package中相同类型的资源，会被放到同一个<code>ResTable::TypeList</code>中，只不过，target package中的资源会放在头一个元素的位置，overlay package的放到后面。这样做，可以很方便地把target package和overlay package中的资源组织到一起，访问也方便。</p> 
<h5><a id="ResTablePackage_103"></a>ResTable::Package</h5> 
<pre><code class="prism language-cpp"><span class="token comment">//frameworks/base/lib/androidfw/ResourceTypes.cpp</span>
<span class="token keyword">struct</span> ResTable<span class="token operator">::</span>Package
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//......省略无关代码</span>

    <span class="token comment">//所属的ResTable</span>
    <span class="token keyword">const</span> ResTable<span class="token operator">*</span> <span class="token keyword">const</span>           owner<span class="token punctuation">;</span>
    <span class="token comment">//对应的resources.arsc</span>
    <span class="token keyword">const</span> Header<span class="token operator">*</span> <span class="token keyword">const</span>             header<span class="token punctuation">;</span>
    <span class="token comment">//对应的resources.arsc中的ResTable_package</span>
    <span class="token keyword">const</span> ResTable_package<span class="token operator">*</span> <span class="token keyword">const</span>   package<span class="token punctuation">;</span>
    <span class="token comment">// Type String Pool</span>
    ResStringPool                   typeStrings<span class="token punctuation">;</span>
    <span class="token comment">// Key String Pool</span>
    ResStringPool                   keyStrings<span class="token punctuation">;</span>
    <span class="token comment">//......省略无关代码</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>        通常一个ResTable::Package就会对应一个resources.arsc了。并且它里面还会记录这个resources.arsc中关键的数据块，比如 <code>ResTable_package</code>、Type String Pool、Key String Pool等。</p> 
<h5><a id="ResTableType_126"></a>ResTable::Type</h5> 
<p>        <code>ResTable::Type</code>的意义和<code>ResTable_type</code>完全不同。我们前文讲过<code>ResTable_type</code>表示resources.arsc中某种配置下的某类型的所有资源，而<code>ResTable::Type</code>则表示一个包中某种类型的所有资源。注意，是某种类型的所有资源，包括所有配置！其实从这个角度来讲，它倒是更像<code>ResTable_typeSpec</code>，我们看看<code>ResTable::Type</code>的实现：</p> 
<pre><code class="prism language-cpp"><span class="token comment">//frameworks/base/lib/androidfw/ResourceTypes.cpp</span>

<span class="token keyword">struct</span> ResTable<span class="token operator">::</span>Type
<span class="token punctuation">{<!-- --></span>
    <span class="token function">Type</span><span class="token punctuation">(</span><span class="token keyword">const</span> Header<span class="token operator">*</span> _header<span class="token punctuation">,</span> <span class="token keyword">const</span> Package<span class="token operator">*</span> _package<span class="token punctuation">,</span> size_t count<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">header</span><span class="token punctuation">(</span>_header<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">package</span><span class="token punctuation">(</span>_package<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">entryCount</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function">typeSpec</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">typeSpecFlags</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>
    <span class="token comment">//所属的resources.arsc</span>
    <span class="token keyword">const</span> Header<span class="token operator">*</span> <span class="token keyword">const</span>             header<span class="token punctuation">;</span>
    <span class="token comment">//所属的资源包</span>
    <span class="token keyword">const</span> Package<span class="token operator">*</span> <span class="token keyword">const</span>            package<span class="token punctuation">;</span>
    <span class="token comment">//资源项的个数</span>
    <span class="token keyword">const</span> size_t                    entryCount<span class="token punctuation">;</span>
    <span class="token comment">//资源对应的ResTable_typeSpec</span>
    <span class="token keyword">const</span> ResTable_typeSpec<span class="token operator">*</span>        typeSpec<span class="token punctuation">;</span>
    <span class="token comment">//flags</span>
    <span class="token keyword">const</span> <span class="token keyword">uint32_t</span><span class="token operator">*</span>                 typeSpecFlags<span class="token punctuation">;</span>
    <span class="token comment">//RRO相关的数据结构</span>
    IdmapEntries                    idmapEntries<span class="token punctuation">;</span>
    <span class="token comment">//表示不同配置下的所有资源了</span>
    Vector<span class="token operator">&lt;</span><span class="token keyword">const</span> ResTable_type<span class="token operator">*</span><span class="token operator">&gt;</span>    configs<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>        我们看到，一个<code>ResTable::Type</code>中包含多个<code>ResTable_type</code>，并且对于这个<code>ResTable_type</code>集合对象的命名也叫configs。自然，它里面的每一个元素就对应一种配置了。</p> 
<h5><a id="ResTableEntry_154"></a>ResTable::Entry</h5> 
<p>        <code>ResTable::Entry</code>和<code>ResTable_entry</code>的区别倒不大，只不过是对后者又做了进一步的封装，添加了它所属的类型、Package等信息。</p> 
<pre><code class="prism language-cpp"><span class="token comment">//frameworks/base/lib/androidfw/ResourceTypes.cpp</span>

<span class="token keyword">struct</span> ResTable<span class="token operator">::</span>Entry <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//所属ResTable_type的配置</span>
    ResTable_config config<span class="token punctuation">;</span>
    <span class="token comment">//对应的ResTable_entry</span>
    <span class="token keyword">const</span> ResTable_entry<span class="token operator">*</span> entry<span class="token punctuation">;</span>
    <span class="token comment">//所属的ResTable_type</span>
    <span class="token keyword">const</span> ResTable_type<span class="token operator">*</span> type<span class="token punctuation">;</span>
    <span class="token keyword">uint32_t</span> specFlags<span class="token punctuation">;</span>
    <span class="token comment">//所属的Package</span>
    <span class="token keyword">const</span> Package<span class="token operator">*</span> package<span class="token punctuation">;</span>
 
    <span class="token comment">//所属的类型的名字在Type String Pool中的索引 </span>
    StringPoolRef typeStr<span class="token punctuation">;</span>
    <span class="token comment">//该资源项的名字在Key String Pool中的索引</span>
    StringPoolRef keyStr<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>        另外，还有几个数据结构也值得一说，先看<code>ResTable::Header</code>：</p> 
<pre><code class="prism language-cpp"><span class="token comment">//frameworks/base/lib/androidfw/ResourceTypes.cpp</span>

<span class="token keyword">struct</span> ResTable<span class="token operator">::</span>Header
<span class="token punctuation">{<!-- --></span>
    <span class="token function">Header</span><span class="token punctuation">(</span>ResTable<span class="token operator">*</span> _owner<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">owner</span><span class="token punctuation">(</span>_owner<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ownedData</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">header</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">resourceIDMap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">resourceIDMapSize</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>

    <span class="token operator">~</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">free</span><span class="token punctuation">(</span>resourceIDMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//所属的ResTable对象</span>
    <span class="token keyword">const</span> ResTable<span class="token operator">*</span> <span class="token keyword">const</span>           owner<span class="token punctuation">;</span>
    <span class="token comment">//用来存储整个resources.arsc,默认情况下这个是NULL，不会使用</span>
    <span class="token keyword">void</span><span class="token operator">*</span>                           ownedData<span class="token punctuation">;</span>
    <span class="token comment">//用来存储整个resources.arsc的头部</span>
    <span class="token keyword">const</span> ResTable_header<span class="token operator">*</span>          header<span class="token punctuation">;</span>
    <span class="token comment">//整个resources.arsc中数据的大小</span>
    <span class="token comment">//size = header-&gt;size</span>
    size_t                          size<span class="token punctuation">;</span>
    <span class="token comment">//整个resources.arsc的结尾地址</span>
    <span class="token keyword">const</span> <span class="token keyword">uint8_t</span><span class="token operator">*</span>                  dataEnd<span class="token punctuation">;</span>
    <span class="token comment">/**
    * 该resources.arsc或者说该资源包在owner对象中的索引
    * 或者说是该header对象在ResTable::mHeaders中的索引
    * 都是一会事儿
    */</span>
    size_t                          index<span class="token punctuation">;</span>
    <span class="token comment">/**
    * 该资源包是owner对象加载的第几个资源包，从1开始
    * 一般cookie = index + 1
    */</span>
    <span class="token keyword">int32_t</span>                         cookie<span class="token punctuation">;</span>
    <span class="token comment">//resources.arsc的Key String Pool</span>
    ResStringPool                   values<span class="token punctuation">;</span>
    <span class="token comment">//资源共享库相关</span>
    <span class="token keyword">uint32_t</span><span class="token operator">*</span>                       resourceIDMap<span class="token punctuation">;</span>
    <span class="token comment">//资源共享库相关</span>
    size_t                          resourceIDMapSize<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>        我们看到<code>ResTable::Header</code>内部的数据结构，大都是resources.arsc相关的，也就是说，它主要用来在资源管理的过程中来描述一个resources.arsc，而通常一个资源包对应一个resources.arsc，所以也可以理解为它和一个资源包是一一对应的。这里的index成员好理解，cookie我们简单说明以下。在Android的资源管理框架中cookie的出现频率极高，不过它们的含义基本一致，都是代表一个资源包或者说一个resources.arsc或者说一个Key String Pool（它们三个是一一对应的）在它所属的<code>ResTable</code>中的索引值（从1开始计数）。毕竟一个AssetManager也好，一个<code>ResTable</code>也好，它的内部都会存在多个资源包，当我们返回一个资源信息时，少不了要返回这个资源所属的资源包，这个就是cookie值了。</p> 
<p>        再看下面两个数据结构：</p> 
<pre><code class="prism language-cpp"><span class="token comment">//frameworks/base/include/androidfw/ResourceTypes.h</span>
<span class="token keyword">struct</span> ResTable_ref
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">uint32_t</span> ident<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> ResStringPool_ref
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">uint32_t</span> index<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>        首先这两个数据结构不仅在进行资源管理的时候会用到，在resources.arsc中也会用到。其中<code>ResTable_ref</code>，表示一项资源的引用，32位整型值就是形如0xpptteeee的一个id，跟R文件中的id一模一样，也就是说，它实际上指向了另一个资源的id。从这里我们也可以看到，android的资源管理是支持资源引用的，这在我们使用资源的时候将会非常非常方便，但缺点是，当我们获取资源时，如果结果的类型是TYPE_REFERENCE，我们获取到的将不会是最终的结果，如果想得到最终的具体值，则需要增加对引用的解析这个步骤。而<code>ResStringPool_ref</code>则是一个字符串在<code>ResStringPool</code>中的索引。通常当我们要访问的资源是一个字符串的时候，Android资源管理框架的native层不会直接返回一个字符串，而是返回一个<code>ResStringPool_ref</code>和一个cookie值，前者表示索引，后者表示结果字符串哪个<code>ResStringPool</code>中，然后我们根据索引到对应的<code>ResStringPool</code>中就可以拿到具体的结果了。</p> 
<p>        我们画一张图来描述相关的数据结构：</p> 
<p><img src="https://images2.imgbox.com/f7/bd/czuh8SrG_o.png" alt="在这里插入图片描述"><br>         我们看到，这张图中少了<code>Restable::Entry</code>，因为它可以看做是对<code>Restable:_entry</code>的封装，它的存在是为了我们从上层更加方便地get资源。不过，它却是是游离于<code>ResTable</code>、<code>ResTable::PackageGroup</code>、<code>ResTable::Package</code>、<code>ResTable::TypeList</code>、<code>ResTable::Type</code>之外的，它们都没用引用<code>Restable::Entry</code>。</p> 
<h5><a id="AssetManager_242"></a>AssetManager</h5> 
<p>        <code>AssetManager</code>是native层资源管理的接口，它实际上是对<code>ResTable的封装</code>，我们可以粗略地认为，<code>AssetManager</code>负责加载资源包，并从中解压出各种资源文件，特别是resources.arsc，然后将它丢给<code>ResTable</code>，后面的事儿就由<code>ResTable</code>负责了。<code>AssetManager</code>在管理资源包的过程中用到的<code>AssetDir</code>、<code>Asset</code>、<code>_FileAsset</code>、<code>_CompressedAsset</code>等数据结构，我们可以看做是对一般目录、文件、压缩包的封装；<code>AssetManager::SharedZip</code>、<code>AssetManager::ZipSet</code>，则是为了方便我们对APK包的访问以及缓存。这些数据结构算是资源管理的工具吧，它们和资源管理本身关系不大，我们这里一句带过了。</p> 
<pre><code class="prism language-cpp"><span class="token comment">//frameworks/base/include/androidfw/AssetManager.h</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> __cplusplus</span>
<span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token punctuation">{<!-- --></span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token keyword">struct</span> AAssetManager <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> __cplusplus</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token keyword">class</span> <span class="token class-name">AssetManager</span> <span class="token operator">:</span> <span class="token keyword">public</span> AAssetManager <span class="token punctuation">{<!-- --></span>

     <span class="token comment">//.....省略次要代码</span>

     <span class="token comment">//加载的资源包的路径</span>
     Vector<span class="token operator">&lt;</span>asset_path<span class="token operator">&gt;</span> mAssetPaths<span class="token punctuation">;</span>
     <span class="token comment">//ResTable</span>
     <span class="token keyword">mutable</span> ResTable<span class="token operator">*</span> mResources<span class="token punctuation">;</span>
     <span class="token comment">//配置信息</span>
     ResTable_config<span class="token operator">*</span> mConfig<span class="token punctuation">;</span>
     
     <span class="token comment">//.....省略次要代码</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>        到这里，Android资源管理相关的底层的主要数据结构我们已经介绍的差不多了，当然<a href="https://blog.csdn.net/dayong198866/article/details/96107063">Runtime Resources Overlay</a>、<a href="https://blog.csdn.net/dayong198866/article/details/95226237">资源共享库</a>相关的数据结构我们没有介绍，如果大家有兴趣，点开连接可以详细了解它们的实现和原理。还有就是XML相关的数据结构，它们比较独立，和Android资源管理关系不是那么不可分割，有机会我们可以搞个专题。在这里我们注意区分开<code>ResTable_</code>和<code>ResTable::</code>打头的资源即可：前者大多用来描述resources.arsc；后者用于资源管理的逻辑的实现。当然<code>ResTable_config</code>、<code>ResTable_ref</code>、ResStringPool等，在描述resources.arsc和管理资源时都会用到。</p> 
<h3><a id="Bag_275"></a>Bag资源</h3> 
<p>        我们前面讲资源项的时候说到，一般情况下，一个资源项其实是一个键值对儿：键表示资源项的名字，用<code>ResTable_entry</code>表示；值表示资源项的相关信息（具体值或者资源的路径等等），用<code>Res_value</code>表示。但是还有二般情况，有一些资源我们仅仅用一个键值对儿是描述不清的，比如style类型的资源：</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resources</span><span class="token punctuation">&gt;</span></span>

    .......
    
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>WorkspaceIcon<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token style language-css">
        &lt;item name=<span class="token string">"android:layout_width"</span>&gt;match_parent&lt;/item&gt;
        &lt;item name=<span class="token string">"android:layout_height"</span>&gt;match_parent&lt;/item&gt;
        &lt;item name=<span class="token string">"android:layout_gravity"</span>&gt;center&lt;/item&gt;
        &lt;item name=<span class="token string">"android:gravity"</span>&gt;center_horizontal&lt;/item&gt;
        &lt;item name=<span class="token string">"android:singleLine"</span>&gt;true&lt;/item&gt;
        &lt;item name=<span class="token string">"android:ellipsize"</span>&gt;end&lt;/item&gt;
        &lt;item name=<span class="token string">"android:textSize"</span>&gt;@dimen/workspace_icon_text_size&lt;/item&gt;
        &lt;item name=<span class="token string">"android:textColor"</span>&gt;@color/workspace_icon_text_color&lt;/item&gt;
        &lt;item name=<span class="token string">"android:shadowRadius"</span>&gt;2.0&lt;/item&gt;
        &lt;item name=<span class="token string">"android:shadowColor"</span>&gt;#B0000000&lt;/item&gt;
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>WorkspaceIcon.Portrait<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token style language-css">
        &lt;item name=<span class="token string">"android:drawablePadding"</span>&gt;@dimen/app_icon_drawable_padding&lt;/item&gt;
        &lt;item name=<span class="token string">"android:paddingStart"</span>&gt;4dp&lt;/item&gt;
        &lt;item name=<span class="token string">"android:paddingEnd"</span>&gt;4dp&lt;/item&gt;
        &lt;item name=<span class="token string">"android:paddingTop"</span>&gt;@dimen/app_icon_padding_top&lt;/item&gt;
        &lt;item name=<span class="token string">"android:paddingBottom"</span>&gt;4dp&lt;/item&gt;
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>

    ......

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resources</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>        我们看style<code>WorkspaceIcon.Portrait</code>，抛开它的parent style <code>WorkspaceIcon</code>不谈，它的名称似乎可以用一个<code>ResTable_entry</code>来表示，但是它的值我们可以用一个<code>Res_value</code>表示吗？显然不能！！！</p> 
<p>        这个style的值不是一个简单的值，而是由5个键值对儿组成：</p> 
<pre><code class="prism language-xml"> android:drawablePadding   ---&gt;  @dimen/app_icon_drawable_padding
 android:paddingStart   ---&gt;  4dp
 android:paddingEnd   ---&gt;  4dp
 android:paddingTop   ---&gt; @dimen/app_icon_padding_top
 android:paddingBottom   ---&gt; 4dp
</code></pre> 
<p>        对于类似style的这种资源，既然不能使用<code>ResTable_entry</code> + <code>Res _value</code>来表示，那就只能使用新的数据结构了，也就是<code>ResTable_map_entry</code>和<code>ResTable_map</code>：</p> 
<pre><code class="prism language-cpp"><span class="token comment">//frameworks/base/include/androidfw/ResourceTypes.h</span>
<span class="token keyword">struct</span> ResTable_map_entry <span class="token operator">:</span> <span class="token keyword">public</span> ResTable_entry
<span class="token punctuation">{<!-- --></span>
   <span class="token comment">// Resource identifier of the parent mapping, or 0 if there is none.</span>
   <span class="token comment">// This is always treated as a TYPE_DYNAMIC_REFERENCE.</span>
   ResTable_ref parent<span class="token punctuation">;</span>
   <span class="token comment">// Number of name/value pairs that follow for FLAG_COMPLEX.</span>
   <span class="token keyword">uint32_t</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>        我们看到<code>ResTable_map_entry</code>继承了<code>ResTable_entry</code>，并且添加了两个新的字段，分别来表示它的父style和item的个数。</p> 
<pre><code class="prism language-cpp"> <span class="token comment">//frameworks/base/include/androidfw/ResourceTypes.h</span>
<span class="token keyword">struct</span> ResTable_map
<span class="token punctuation">{<!-- --></span>
     <span class="token comment">//表示键值对儿中的键</span>
     ResTable_ref name<span class="token punctuation">;</span>

     <span class="token comment">//......省略次要代码</span>
     
     <span class="token comment">//表示键值对儿中的值</span>
     Res_value value<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>        在一个resources.arsc中，一个<code>ResTable_map_entry</code>后面会跟<code>ResTable_map_entry::count</code>个<code>ResTable_map</code>。具体到这个例子当中：</p> 
<pre><code>ResTable_map_entry::size = 16		/*16个字节*/

//FLAG_COMPLEX表示这个结构体后面跟的不再是简单的Res_value，而是一个个的mapping
ResTable_map_entry::flags = FLAG_COMPLEX

//key 是我们这个style的名字，当然这里是WorkspaceIcon.Portrait在key string pool中的索引
ResTable_map_entry::key = "WorkspaceIcon.Portrait"在key string pool中的索引

//parent 当然是WorkspaceIcon这个style了
ResTable_map_entry::parent = WorkspaceIcon这个style的id

//后面跟的键值对儿的个数，也就是style的item的个数
ResTable_map_entry::count = 5

//后面会有5个ResTable_map，它们的值分别为：

/*ResTable_map::value的类型是Res_value, 我们为了方便，在这里只写出了其data字段，没有列出其data_type等其它字段*/
ResTable_map::name = android:drawablePadding的id        ResTable_map::value = dimen/app_icon_drawable_padding的id
ResTable_map::name = android:paddingStart的id        ResTable_map::value = 4dp
ResTable_map::name = android:paddingEnd的id        ResTable_map::value = 4dp
ResTable_map::name = android:paddingTop的id        ResTable_map::value = dimen/app_icon_padding_top的id
ResTable_map::name = android:paddingBottom的id        ResTable_map::value = 4dp
</code></pre> 
<p>         以上的结构非常好理解，我们用一个一个的键值对儿来描述一项比较复杂的资源，这每一个键值对儿就叫该资源的一个Bag。也就是说，style的每一个item都是style的Bag。我们的style <code>WorkspaceIcon.Portrait</code>自身有5个Bag，它的parent style <code>WorkspaceIcon</code>有10个Bag，并且不存在覆盖的情况，所以style <code>WorkspaceIcon.Portrait</code>总共有15个Bag。</p> 
<p>         当然，拥有Bag的资源不只style一种，除此之外，还有bag、plurals、array、string-array、integer-array、attr共7种。</p> 
<p>         bag类型的资源只在aapt中有定义，无论是Android 系统源码还是一般应用当中都还没有发现使用，这里就不说了。<br>          array、string-array、integer-array这三种资源差不多可以看成一种。一个array同样会包含多个item，比如：</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>array</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sim_colors<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>item</span><span class="token punctuation">&gt;</span></span>@color/Teal_700<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>item</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>item</span><span class="token punctuation">&gt;</span></span>@color/Blue_700<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>item</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>item</span><span class="token punctuation">&gt;</span></span>@color/Indigo_700<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>item</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>item</span><span class="token punctuation">&gt;</span></span>@color/Purple_700<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>item</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>item</span><span class="token punctuation">&gt;</span></span>@color/Pink_700<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>item</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>item</span><span class="token punctuation">&gt;</span></span>@color/Red_700<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>item</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>array</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>        大家有没有发现和style不一样的地方？style的每一个item都是一个键值对儿，但是array的每一个item都只有值，并没有键！！！array的item表面上确实没有键，但其实它是有的，那就是索引，也就是每一个item在array中的位置或者说顺序。并且aapt在编译array（包括string-array和integer-array）的时候，会同时记录其索引的，并且这个索引用^index_%d来表示，其中%d表示索引值，比如0、 1 、2…<br>         plurals大家应该也经常接触，它主要用来处理多语言环境下，字符串的单复数形式：</p> 
<pre><code class="prism language-xml">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plurals</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>copy_begin<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>item</span> <span class="token attr-name">quantity</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>one<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Copying <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">xliff:</span>g</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>count<span class="token punctuation">"</span></span> <span class="token attr-name">example</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>%1$d<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">xliff:</span>g</span><span class="token punctuation">&gt;</span></span> file.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>item</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>item</span> <span class="token attr-name">quantity</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>other<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Copying <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">xliff:</span>g</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>count<span class="token punctuation">"</span></span> <span class="token attr-name">example</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>3<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>%1$d<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">xliff:</span>g</span><span class="token punctuation">&gt;</span></span> files.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>item</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plurals</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>        比如这个，<code>quantity</code>的值自然就是key了，android中<code>quantity</code>的值总共可以取：^zero、 ^one、^two、^few、^many、^other六种。当然，不同的语言环境可能只用其中的某一些，比如英语，只有单复数，所以只用^one、^other两种，这个和具体的语言相关，这里就不多说了。</p> 
<p>        attr我们大家都非常熟悉了，它也有Bag资源？一个形如<code>&lt;attr name="textAppearance" format="reference" /&gt;</code>的attr，一个<code>ResTable_entry</code>和一个<code>Res_value</code>似乎是够了的。我们不急，先来看看这个attr：</p> 
<pre><code class="prism language-xml">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>attr</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>orientation<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- Defines an horizontal widget. --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>enum</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>horizontal<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token comment">&lt;!-- Defines a vertical widget. --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>enum</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>vertical<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>attr</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>        这个就是Android源生的orientation属性的定义，它是一个枚举类型，这时候一个<code>ResTable_entry</code> + 一个<code>Res_value</code>显然是不行的。其实，形如<code>&lt;attr name="textAppearance" format="reference" /&gt;</code>的attr，用一个<code>ResTable_entry</code> + 一个<code>Res_value</code>也是不行的，因为它的键值可以是这个属性的名字textAppearance，但是值呢？显然是某个资源的id，而不能是<code>reference</code>。事实上，format=“reference” 这一句，我们可以看作是对<code>textAppearance</code>这个attr的描述。当然，<code>&lt;enum name="horizontal" value="0" /&gt;</code>和也一样是对<code>orientation</code>这个attr的描述，表示它只的值只能是二者之一，而不能随意去取。aapt在编译的时候，会把format也作为一个Bag记录下来，表示这个attr的类型，并用^type来表示。我们再来看看另外完整版的<code>ResTable_map</code>：</p> 
<pre><code class="prism language-cpp"><span class="token comment">//frameworks/base/include/androidfw/ResourceTypes.h</span>
<span class="token keyword">struct</span> ResTable_map
<span class="token punctuation">{<!-- --></span>
    ResTable_ref name<span class="token punctuation">;</span>
    
    <span class="token keyword">enum</span> <span class="token punctuation">{<!-- --></span>
        ATTR_TYPE <span class="token operator">=</span> <span class="token function">Res_MAKEINTERNAL</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        ATTR_MIN <span class="token operator">=</span> <span class="token function">Res_MAKEINTERNAL</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        ATTR_MAX <span class="token operator">=</span> <span class="token function">Res_MAKEINTERNAL</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        ATTR_L10N <span class="token operator">=</span> <span class="token function">Res_MAKEINTERNAL</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        ATTR_OTHER <span class="token operator">=</span> <span class="token function">Res_MAKEINTERNAL</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        ATTR_ZERO <span class="token operator">=</span> <span class="token function">Res_MAKEINTERNAL</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        ATTR_ONE <span class="token operator">=</span> <span class="token function">Res_MAKEINTERNAL</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        ATTR_TWO <span class="token operator">=</span> <span class="token function">Res_MAKEINTERNAL</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        ATTR_FEW <span class="token operator">=</span> <span class="token function">Res_MAKEINTERNAL</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        ATTR_MANY <span class="token operator">=</span> <span class="token function">Res_MAKEINTERNAL</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    <span class="token keyword">enum</span> <span class="token punctuation">{<!-- --></span>
        TYPE_ANY <span class="token operator">=</span> <span class="token number">0x0000FFFF</span><span class="token punctuation">,</span>
        TYPE_REFERENCE <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">,</span>
        TYPE_STRING <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">,</span>
        TYPE_INTEGER <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">,</span>
        TYPE_BOOLEAN <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">,</span>
        TYPE_COLOR <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">,</span>
        TYPE_FLOAT <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">,</span>
        TYPE_DIMENSION <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">,</span>
        TYPE_FRACTION <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">7</span><span class="token punctuation">,</span>
        TYPE_ENUM <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">16</span><span class="token punctuation">,</span>
        TYPE_FLAGS <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">17</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">enum</span> <span class="token punctuation">{<!-- --></span>
        L10N_NOT_REQUIRED <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
        L10N_SUGGESTED    <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    Res_value value<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>        我们看到，它里面有三个枚举类型的数据，它们是做什么的呢？最后一个显然是本地化相关的，我们不做讨论。我们先说第一个，当我们的资源是attr的时候，它们可以作为<code>ResTable_map::name</code>的值，用来描述这个attr相关的元信息。比如，这个属性的类型、最大取值、最取小值等等，当<code>ResTable_map::name</code>的值为<code>ATTR_TYPE</code>的时候，Res_value::data的值该是什么呢？答案就是第二个enum中的值；当我们的资源是plurals的时候，它的Bag的key只能是^zero、 ^one、^two、^few、^many、^other，值就是item当中的字符串；当我们的资源是array（包括string-array和integer-array）的时候，它的Bag的key只能是^index_%d.</p> 
<p>        Bag资源相关的东西我们就先介绍到这里，后面讲aapt的时候我们还会详细讲Bag资源的编译。这里我们只需要知道什么是Bag资源就可以了。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d2e960ca700311998da969bf63bad509/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">L3-Day28</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1f76f01f2012128a29ebe462e58d4166/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">nuxt.js项目部署到linux服务器，并使用域名访问（说明遇上的大坑，首页静态资源可以访问，但是接口全部失效）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>