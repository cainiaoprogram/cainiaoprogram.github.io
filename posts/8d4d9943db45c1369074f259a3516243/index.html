<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Docker笔记：Docker Swarm 结合 Docker Compose 来部署集群 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Docker笔记：Docker Swarm 结合 Docker Compose 来部署集群" />
<meta property="og:description" content="docker swarm 结合 docker-compose.yml 部署集群 1 ）准备 docker-compose.yml的文件, 示例 demo 如下
version: &#34;3&#34; services: mysql_c: image: mysql environment: MYSQL_ROOT_PASSWORD: 123456 restart: always ports: - 3306:3306 volumes: - /root/mysql/conf.d:/etc/mysql/conf.d - /root/mysql/data:/var/lib/mysql goweb1: image: gowebimg restart: always deploy: replicas: 6 # 副本数量 resources: # 资源 limits: # 配置cpu cpus: &#34;0.3&#34; # 设置该容器最多只能使用 30% 的 CPU memory: 500M # 设置该容器最多只能使用 500M内存 restart_policy: # 定义容器重启策略, 用于代替 restart 参数 condition: on-failure # 只有当容器内部应用程序出现问题才会重启 depends_on: - mysql_c nginx: image: nginx restart: always ports: - 80:80 depends_on: - goweb1 volumes: - /root/nginx/conf." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/8d4d9943db45c1369074f259a3516243/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-14T21:10:40+08:00" />
<meta property="article:modified_time" content="2023-12-14T21:10:40+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Docker笔记：Docker Swarm 结合 Docker Compose 来部署集群</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h4><a id="docker_swarm__dockercomposeyml__0"></a>docker swarm 结合 docker-compose.yml 部署集群</h4> 
<p>1 ）准备 docker-compose.yml的文件, 示例 demo 如下</p> 
<pre><code class="prism language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"3"</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">mysql_c</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">MYSQL_ROOT_PASSWORD</span><span class="token punctuation">:</span> <span class="token number">123456</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 3306<span class="token punctuation">:</span><span class="token number">3306</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /root/mysql/conf.d<span class="token punctuation">:</span>/etc/mysql/conf.d
      <span class="token punctuation">-</span> /root/mysql/data<span class="token punctuation">:</span>/var/lib/mysql
  <span class="token key atrule">goweb1</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> gowebimg
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">deploy</span><span class="token punctuation">:</span>
      <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">6</span> <span class="token comment"># 副本数量</span>
      <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token comment"># 资源</span>
        <span class="token key atrule">limits</span><span class="token punctuation">:</span> <span class="token comment"># 配置cpu</span>
          <span class="token key atrule">cpus</span><span class="token punctuation">:</span> <span class="token string">"0.3"</span> <span class="token comment"># 设置该容器最多只能使用 30% 的 CPU</span>
          <span class="token key atrule">memory</span><span class="token punctuation">:</span> 500M <span class="token comment"># 设置该容器最多只能使用 500M内存</span>
      <span class="token key atrule">restart_policy</span><span class="token punctuation">:</span> <span class="token comment"># 定义容器重启策略, 用于代替 restart 参数</span>
        <span class="token key atrule">condition</span><span class="token punctuation">:</span> on<span class="token punctuation">-</span>failure <span class="token comment"># 只有当容器内部应用程序出现问题才会重启</span>
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> mysql_c
  <span class="token key atrule">nginx</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token datetime number">80:80</span>
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> goweb1
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /root/nginx/conf.d/<span class="token punctuation">:</span>/etc/nginx/conf.d
    <span class="token key atrule">deploy</span><span class="token punctuation">:</span>
      <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">6</span> <span class="token comment">#副本数量</span>
      <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token comment">#资源</span>
        <span class="token key atrule">limits</span><span class="token punctuation">:</span> <span class="token comment">#配置cpu</span>
          <span class="token key atrule">cpus</span><span class="token punctuation">:</span> <span class="token string">"0.3"</span> <span class="token comment"># 设置该容器最多只能使用 30% 的 CPU</span>
          <span class="token key atrule">memory</span><span class="token punctuation">:</span> 500M <span class="token comment"># 设置该容器最多只能使用 500M内存</span>
      <span class="token key atrule">restart_policy</span><span class="token punctuation">:</span> <span class="token comment"># 定义容器重启策略, 用于代替 restart 参数</span>
        <span class="token key atrule">condition</span><span class="token punctuation">:</span> on<span class="token punctuation">-</span>failure <span class="token comment">#只有当容器内部应用程序出现问题才会重启</span>
</code></pre> 
<ul><li>基于 docker-compose可以在一台服务器上创建多个容器</li><li>想在多台服务器上一次创建多个容器, 需要结合 Swarm 
  <ul><li>$ <code>docker stack deploy --compose-file docker-compose.yml swarmName</code> 
    <ul><li>swarmName是我们的swarm对应的名称，可以自行随意配置, 比如 goWebSwarm</li></ul> </li></ul> </li><li>以上配置的问题是 mysql 没有进行集群 
  <ul><li>mysql 需要单独搭建集群，这里涉及到主从数据库</li><li>为了方便起见，直接配置到了 yml 文件里</li><li>这里mysql的副本数量不能配置多个</li><li>如果多个，就会运行在多台服务器上，会出现数据异常和不一致的问题</li></ul> </li></ul> 
<p>2 ）搭建集群</p> 
<ul><li>$ <code>docker swarm init --advertise-addr 192.168.1.10</code> 初始化集群并创建管理节点(当前指定的ip为管理节点) 
  <ul><li>填入自己主机的ip</li></ul> </li><li>$ <code>docker swarm join --token SWMTKN-1-52tr219htvsg1volky2tej7pj8bjs2j78q4b6wc9fnt72kkchd-29ohn4mgz191f6oznldvjiw47 192.168.1.10:2377</code> 
  <ul><li>其他主机加入集群</li></ul> </li><li>根据 yml 文件，这里的集群是 nginx 和 goweb的集群，它们都有6个副本，mysql 服务只有一个副本</li></ul> 
<p>3 ）部署和验证</p> 
<ul><li>$ <code>docker stack deploy --compose-file docker-compose.yml goWebSwarm</code> 开始部署服务 
  <ul><li>调用这个命令的时候，首先创建了网络</li><li>接着创建3个服务</li><li>这3个服务使用了同一个网络，默认这三个服务可以直接连通</li></ul> </li><li>$ <code>docker service ls</code> 可查看当前运行起来的服务</li><li>$ <code>docker service ps goWebSwarm</code> 查看当前某个服务</li><li>通过 docker-compose 部署，可见生成了3个服务，这三个服务，使用了同一个网络</li><li>这里同样存在之前的，mysql服务启动了，接着goWeb服务也启动，但是mysql服务并没有完全可用的状态 
  <ul><li>可以用之前的脚本解决</li><li>可以重启 goWeb项目 (或扩容，缩容来重启)</li><li>可以先单独部署 mysql的集群，之后再部署 goWeb 和 Nginx 服务 
    <ul><li>这种就不属于这里的集群了，mysql集群作为一项单独的集群</li><li>goWeb应用的配置文件也要对应同步修改</li></ul> </li></ul> </li></ul> 
<p>4 ）配置部署额外的一台Nginx服务器(非集群内)</p> 
<ul><li>额外的NG服务器，用于做路由和转发到集群内的nginx服务器</li><li>在集群内的各个主机磁盘上都有 /root/nginx/conf.d/ 目录中都有一个 default.conf 文件<pre><code class="prism language-conf">upstream backend {
  ip_hash;
  server goweb1:8080; # 这里是 goweb1 容器服务的host别名
}

server {
        listen       80;
        server_name  localhost; # 你的域名地址
        location / {
              # 设置主机头和客户端真实地址，以便服务器获取客户端真实IP         
              # 禁用缓存
              proxy_buffering off; 
              # 反向代理的地址
              proxy_pass http://backend;     
        }
        #error_page  404              /404.html;
        # redirect server error pages to the static page /50x.html
        #
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root  html;
        }
}
</code></pre> 
  <ul><li>当访问这个时，nginx将 80 转发到 8080</li></ul> </li><li>现在，我们要配置nginx的主机，也就是转发到集群内，进行负载均衡的配置<pre><code class="prism language-conf">upstream backend {
  ip_hash;
  server 192.168.1.10 weight=1; # 集群内的服务 ip 这里有一台 nginx服务器
  server 192.168.1.11 weight=1;
  server 192.168.1.12 weight=1;
  server 192.168.1.13 weight=1;
}

server {
        listen       80;
        server_name  goweb.xxxx.com; # 你的域名地址 这里本机可以配置 host, 如果在服务器配置 域名解析
        add_header backendCode $upstream_status;
        add_header BackendIP "$upstream_addr;" always;
        location / {
              # 设置主机头和客户端真实地址，以便服务器获取客户端真实 IP
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              # nginx服务器与被代理服务连接超时时间，代理超时，请求一台超过1s就会转发到其他ip
              proxy_connect_timeout 1s;
              # 禁用缓存
              proxy_buffering off;
              # 反向代理的地址
              proxy_pass http://backend;
        }
        #error_page  404              /404.html;
        # redirect server error pages to the static page /50x.html
        #
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root  html;
        }
}
</code></pre> </li></ul> 
<ul><li>上面用于查看nginx服务器转发节点的配置 
  <ul><li><code>proxy_set_header X-Real-IP $remote_addr;</code></li><li><code>proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</code></li><li>加上这个，在浏览器中可以看到转发的服务器，在响应表头，会有一个 <code>BackendIP</code> 的字段</li></ul> </li></ul> 
<ul><li>启动 nginx 主机 
  <ul><li>$ <code>docker run -itd --name nginxweb -p 80:80 -v /root/nginx/conf.d:/etc/nginx/conf.d nginx</code></li></ul> </li></ul> 
<p>5 ）整体架构如下</p> 
<ul><li> <p><strong>第一层</strong> ）nginx 服务器接收到请求后转发到集群中的各台主机上</p> 
  <ul><li>这里是最外面的一层 nginx 作为负载均衡</li><li>这台nginx服务器是一台高性能服务器，只负责转发，没有其他处理任务</li></ul> </li><li> <p><strong>第二层</strong> ）集群里面有各类服务</p> 
  <ul><li>nginx goWeb 
    <ul><li>goWeb 连接到 mysql 或 mysql集群服务</li></ul> </li><li>nginx goWeb 
    <ul><li>同上</li></ul> </li><li>nginx goWeb 
    <ul><li>同上</li></ul> </li><li>…</li><li>这个集群内部的nginx服务会动态负载均衡到各个goWeb服务</li></ul> </li><li> <p><strong>第三层</strong> ）mysql 或 mysql集群</p> 
  <ul><li>目前我们的mysql 只有一台服务，并且配置在compose文件里</li></ul> </li><li> <p>以上三个层，是我们服务端一般的设计方案，当然上面没用到 mysql 集群</p> </li><li> <p>以上架构可支持 100W 的访问量 (使用mysql集群)</p> </li><li> <p>如果需要负载更多, 可把这套架构复制到多个城市地区</p> 
  <ul><li>一般情况下，域名解析只能配置到一台服务器</li><li>当然，有个动态域名解析，可以支持多台</li><li>这样就可以根据请求判断转发到那些服务器</li></ul> </li></ul> 
<h4><a id="_Docker_Swarm__Raft__179"></a>关于 Docker Swarm 的 Raft 一致性算法</h4> 
<ul><li>Raft：一致性算法，在保证大多数管理节点存活的情况下，集群才能使用</li><li>所以就要求如果集群的话，manager节点必须 &gt;=3 台 
  <ul><li>manager： 管理节点，用于管理工作节点</li></ul> </li><li>如果是两个台，其中一台宕机，剩余的一台也将不可用，以致整个集群不可用</li><li>为了利用 swarm 模式的容错特性，Docker 建议您根据组织的高可用性要求实现<strong>奇数</strong>个节点</li><li>当您有多个管理器时，您可以从管理器节点的故障中恢复而无需停机 
  <ul><li>一个3管理器群最多可以容忍1名管理器的损失</li><li>一个5管理器群最多可以同时丢失2个管理器节点</li><li>一个N管理器集群最多可以容忍丢失 (N - 1) / 2 管理器</li><li>Docker 建议一个Swarm集群最多使用7个管理器节点</li></ul> </li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ba73e10d19fb58f354c1b160b933a1b2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">基于Docker-Compose实现ELK&#43;Kafka搭建分布式日志采集系统</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9f58bc8a00d0721a53bbca122ca185e2/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">根据 csv文件 快速生成自定义 mysql 语句</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>