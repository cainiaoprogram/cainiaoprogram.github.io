<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android SharedPreferences工具类，可设置缓存时间 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android SharedPreferences工具类，可设置缓存时间" />
<meta property="og:description" content="使用ACache也可以设置缓存时间，但ACache在清缓存的时候会被清空。 SharedPreferences存储默认都是无时间限制的。 大概思路是，存储的时候记录当前时间，要存多久。取数据的时候判断这个数据已经存储了多久，如果超过设置的存储时间，就获取默认值。 首先，我们需要一个存储的model——SpSaveModel
public class SpSaveModel&lt;T&gt; implements Serializable{ private int saveTime; private T value; private long currentTime; public SpSaveModel() { } public SpSaveModel(int saveTime, T value,long currentTime) { this.saveTime = saveTime; this.value = value; this.currentTime=currentTime; } public long getCurrentTime() { return currentTime; } public void setCurrentTime(long currentTime) { this.currentTime = currentTime; } public int getSaveTime() { return saveTime; } public void setSaveTime(int saveTime) { this.saveTime = saveTime; } public T getValue() { return value; } public void setValue(T value) { this." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/f24db105d81296388bd5919427e19914/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-05-03T16:54:36+08:00" />
<meta property="article:modified_time" content="2018-05-03T16:54:36+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android SharedPreferences工具类，可设置缓存时间</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>使用ACache也可以设置缓存时间，但ACache在清缓存的时候会被清空。 <br> SharedPreferences存储默认都是无时间限制的。 <br> 大概思路是，存储的时候记录当前时间，要存多久。取数据的时候判断这个数据已经存储了多久，如果超过设置的存储时间，就获取默认值。 <br> 首先，我们需要一个存储的model——SpSaveModel</p> 
<pre class="prettyprint"><code class=" hljs cs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> SpSaveModel&lt;T&gt; implements Serializable{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> saveTime;
    <span class="hljs-keyword">private</span> T <span class="hljs-keyword">value</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">long</span> currentTime;

    <span class="hljs-keyword">public</span> <span class="hljs-title">SpSaveModel</span>() {
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title">SpSaveModel</span>(<span class="hljs-keyword">int</span> saveTime, T <span class="hljs-keyword">value</span>,<span class="hljs-keyword">long</span> currentTime) {
        <span class="hljs-keyword">this</span>.saveTime = saveTime;
        <span class="hljs-keyword">this</span>.<span class="hljs-keyword">value</span> = <span class="hljs-keyword">value</span>;
        <span class="hljs-keyword">this</span>.currentTime=currentTime;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> <span class="hljs-title">getCurrentTime</span>() {
        <span class="hljs-keyword">return</span> currentTime;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCurrentTime</span>(<span class="hljs-keyword">long</span> currentTime) {
        <span class="hljs-keyword">this</span>.currentTime = currentTime;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getSaveTime</span>() {
        <span class="hljs-keyword">return</span> saveTime;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setSaveTime</span>(<span class="hljs-keyword">int</span> saveTime) {
        <span class="hljs-keyword">this</span>.saveTime = saveTime;
    }

    <span class="hljs-keyword">public</span> T <span class="hljs-title">getValue</span>() {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">value</span>;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setValue</span>(T <span class="hljs-keyword">value</span>) {
        <span class="hljs-keyword">this</span>.<span class="hljs-keyword">value</span> = <span class="hljs-keyword">value</span>;
    }
}</code></pre> 
<p>需要一个object和json字符串转换的工具，这里用fastJson，添加依赖</p> 
<pre class="prettyprint"><code class=" hljs bash">    compile <span class="hljs-string">'com.alibaba:fastjson:1.1.26'</span></code></pre> 
<pre class="prettyprint"><code class=" hljs java"><span class="hljs-keyword">import</span> android.content.Context;
<span class="hljs-keyword">import</span> android.content.SharedPreferences;
<span class="hljs-keyword">import</span> android.content.SharedPreferences.Editor;
<span class="hljs-keyword">import</span> android.text.TextUtils;

<span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;
<span class="hljs-keyword">import</span> com.alibaba.fastjson.TypeReference;

<span class="hljs-javadoc">/**
 * Created by KID on 2018/5/3.
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SpUtils</span> {<!-- --></span>
    <span class="hljs-comment">//保存时间单位</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> TIME_SECOND=<span class="hljs-number">1</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> TIME_MINUTES=<span class="hljs-number">60</span>*TIME_SECOND;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> TIME_HOUR = <span class="hljs-number">60</span> *TIME_MINUTES;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> TIME_DAY = TIME_HOUR * <span class="hljs-number">24</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> TIME_MAX = Integer.MAX_VALUE; <span class="hljs-comment">// 不限制存放数据的数量</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> DURATION_UNIT=<span class="hljs-number">1000</span>;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String fileName = <span class="hljs-string">"config"</span>;
    <span class="hljs-keyword">private</span> SharedPreferences sp;
    <span class="hljs-keyword">private</span> Editor editor;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SpUtils INSTANCE = <span class="hljs-keyword">null</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SpUtils <span class="hljs-title">getInstance</span>(Context context) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">null</span> == INSTANCE) {
            INSTANCE = <span class="hljs-keyword">new</span> SpUtils(context);
        }
        <span class="hljs-keyword">return</span> INSTANCE;
    }
    <span class="hljs-keyword">private</span> <span class="hljs-title">SpUtils</span>(Context context) {
        sp = context.getSharedPreferences(fileName, Context.MODE_PRIVATE);
        editor = sp.edit();
    }


    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setString</span>(String e, String value) {
        SpSaveModel&lt;String&gt;spSaveModel=<span class="hljs-keyword">new</span> SpSaveModel&lt;&gt;(TIME_MAX,value,System.currentTimeMillis());
        String json=JSON.toJSONString(spSaveModel);
        editor.putString(e, json);
        editor.commit();
    }

    <span class="hljs-javadoc">/**
     *
     *<span class="hljs-javadoctag"> @param</span> e  存放的key
     *<span class="hljs-javadoctag"> @param</span> value 存放的value
     *<span class="hljs-javadoctag"> @param</span> saveTime 缓存时间
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setString</span>(String e, String value,<span class="hljs-keyword">int</span> saveTime) {
        SpSaveModel&lt;String&gt;spSaveModel=<span class="hljs-keyword">new</span> SpSaveModel&lt;&gt;(saveTime,value,System.currentTimeMillis());
        String json=JSON.toJSONString(spSaveModel);
        editor.putString(e, json);
        editor.commit();
    }

    <span class="hljs-javadoc">/**
     *
     *<span class="hljs-javadoctag"> @param</span> e 存放的key
     *<span class="hljs-javadoctag"> @param</span> defValue 该key不存在或者过期时，返回的默认值
     *<span class="hljs-javadoctag"> @return</span>
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title">getString</span>(String e, String defValue){
        String json=sp.getString(e,<span class="hljs-string">""</span>);
        <span class="hljs-keyword">if</span>(!TextUtils.isEmpty(json)){
            SpSaveModel&lt;String&gt;spSaveModel= JSON.parseObject(json, <span class="hljs-keyword">new</span> TypeReference&lt;SpSaveModel&lt;String&gt;&gt;(){});
            <span class="hljs-keyword">if</span>(isTimeOut(spSaveModel.getCurrentTime(),spSaveModel.getSaveTime())){
                <span class="hljs-keyword">return</span> spSaveModel.getValue();
            }
        }
        <span class="hljs-keyword">return</span> defValue;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setInt</span>(String e, <span class="hljs-keyword">int</span> value) {
        SpSaveModel&lt;Integer&gt;spSaveModel=<span class="hljs-keyword">new</span> SpSaveModel&lt;&gt;(TIME_MAX,value,System.currentTimeMillis());
        String json=JSON.toJSONString(spSaveModel);
        editor.putString(e, json);
        editor.commit();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setInt</span>(String e, <span class="hljs-keyword">int</span> value,<span class="hljs-keyword">int</span> saveTime) {
        SpSaveModel&lt;Integer&gt;spSaveModel=<span class="hljs-keyword">new</span> SpSaveModel&lt;&gt;(saveTime,value,System.currentTimeMillis());
        String json=JSON.toJSONString(spSaveModel);
        editor.putString(e, json);
        editor.commit();
    }

    <span class="hljs-keyword">public</span> Integer <span class="hljs-title">getInt</span>(String e, <span class="hljs-keyword">int</span> defValue){
        String json=sp.getString(e,<span class="hljs-string">""</span>);
        <span class="hljs-keyword">if</span>(!TextUtils.isEmpty(json)){
            SpSaveModel&lt;Integer&gt;spSaveModel= JSON.parseObject(json, <span class="hljs-keyword">new</span> TypeReference&lt;SpSaveModel&lt;Integer&gt;&gt;(){});
            <span class="hljs-keyword">if</span>(isTimeOut(spSaveModel.getCurrentTime(),spSaveModel.getSaveTime())){
                <span class="hljs-keyword">return</span> spSaveModel.getValue();
            }
        }
        <span class="hljs-keyword">return</span> defValue;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setBoolean</span>(String e, <span class="hljs-keyword">boolean</span> value) {
        SpSaveModel&lt;Boolean&gt;spSaveModel=<span class="hljs-keyword">new</span> SpSaveModel&lt;&gt;(TIME_MAX,value,System.currentTimeMillis());
        String json=JSON.toJSONString(spSaveModel);
        editor.putString(e, json);
        editor.commit();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setBoolean</span>(String e, <span class="hljs-keyword">boolean</span> value,<span class="hljs-keyword">int</span> saveTime) {
        SpSaveModel&lt;Boolean&gt;spSaveModel=<span class="hljs-keyword">new</span> SpSaveModel&lt;&gt;(saveTime,value,System.currentTimeMillis());
        String json=JSON.toJSONString(spSaveModel);
        editor.putString(e, json);
        editor.commit();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">getBoolean</span>(String e, <span class="hljs-keyword">boolean</span> defValue){
        String json=sp.getString(e,<span class="hljs-string">""</span>);
        <span class="hljs-keyword">if</span>(!TextUtils.isEmpty(json)){
            SpSaveModel&lt;Boolean&gt;spSaveModel= JSON.parseObject(json, <span class="hljs-keyword">new</span> TypeReference&lt;SpSaveModel&lt;Boolean&gt;&gt;(){});
            <span class="hljs-keyword">if</span>(isTimeOut(spSaveModel.getCurrentTime(),spSaveModel.getSaveTime())){
                <span class="hljs-keyword">return</span> spSaveModel.getValue();
            }
        }
        <span class="hljs-keyword">return</span> defValue;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setLong</span>(String e, <span class="hljs-keyword">long</span> value) {
        SpSaveModel&lt;Long&gt;spSaveModel=<span class="hljs-keyword">new</span> SpSaveModel&lt;&gt;(TIME_MAX,value,System.currentTimeMillis());
        String json=JSON.toJSONString(spSaveModel);
        editor.putString(e, json);
        editor.commit();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setLong</span>(String e, <span class="hljs-keyword">long</span> value,<span class="hljs-keyword">int</span> saveTime) {
        SpSaveModel&lt;Long&gt;spSaveModel=<span class="hljs-keyword">new</span> SpSaveModel&lt;&gt;(saveTime,value,System.currentTimeMillis());
        String json=JSON.toJSONString(spSaveModel);
        editor.putString(e, json);
        editor.commit();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> <span class="hljs-title">getLong</span>(String e, <span class="hljs-keyword">long</span> defValue){
        String json=sp.getString(e,<span class="hljs-string">""</span>);
        <span class="hljs-keyword">if</span>(!TextUtils.isEmpty(json)){
            SpSaveModel&lt;Long&gt;spSaveModel= JSON.parseObject(json, <span class="hljs-keyword">new</span> TypeReference&lt;SpSaveModel&lt;Long&gt;&gt;(){});
            <span class="hljs-keyword">if</span>(isTimeOut(spSaveModel.getCurrentTime(),spSaveModel.getSaveTime())){
                <span class="hljs-keyword">return</span> spSaveModel.getValue();
            }
        }
        <span class="hljs-keyword">return</span> defValue;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isTimeOut</span>(<span class="hljs-keyword">long</span> saveCurrentTime,<span class="hljs-keyword">int</span> saveTime){
        <span class="hljs-keyword">return</span>  (System.currentTimeMillis()-saveCurrentTime)/DURATION_UNIT&lt;saveTime;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">set</span>(String e, Object value,<span class="hljs-keyword">int</span> saveTime) {
        SpSaveModel&lt;Object&gt;spSaveModel=<span class="hljs-keyword">new</span> SpSaveModel&lt;&gt;(saveTime,value,System.currentTimeMillis());
        String json=JSON.toJSONString(spSaveModel);
        editor.putString(e, json);
        editor.commit();
    }


}</code></pre> 
<p>使用</p> 
<pre class="prettyprint"><code class=" hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AppCompatActivity</span> {<!-- --></span>
    <span class="hljs-annotation">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCreate</span>(Bundle savedInstanceState) {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        findViewById(R.id.btn_save).setOnClickListener(<span class="hljs-keyword">new</span> View.OnClickListener() {
            <span class="hljs-annotation">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onClick</span>(View v) {
                save();
            }
        });
        findViewById(R.id.btn_get).setOnClickListener(<span class="hljs-keyword">new</span> View.OnClickListener() {
            <span class="hljs-annotation">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onClick</span>(View v) {
                get();
            }
        });

    }
    <span class="hljs-comment">//保存</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">save</span>() {
        <span class="hljs-comment">//保存10秒</span>
<span class="hljs-comment">//        SpUtils.getInstance(this).set("text","我的世界",10);</span>
        SpUtils.getInstance(<span class="hljs-keyword">this</span>).setString(<span class="hljs-string">"text"</span>,<span class="hljs-string">"我的世界"</span>,<span class="hljs-number">10</span>);
        SpUtils.getInstance(<span class="hljs-keyword">this</span>).setInt(<span class="hljs-string">"num"</span>,<span class="hljs-number">123456</span>,<span class="hljs-number">10</span>);
        SpUtils.getInstance(<span class="hljs-keyword">this</span>).setBoolean(<span class="hljs-string">"isBu"</span>,<span class="hljs-keyword">true</span>,<span class="hljs-number">10</span>);

    }
    <span class="hljs-comment">//获取</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">get</span>() {
        String text=SpUtils.getInstance(<span class="hljs-keyword">this</span>).getString(<span class="hljs-string">"text"</span>,<span class="hljs-string">"超时了"</span>);
        <span class="hljs-keyword">int</span> num=SpUtils.getInstance(<span class="hljs-keyword">this</span>).getInt(<span class="hljs-string">"num"</span>,-<span class="hljs-number">100</span>);
        <span class="hljs-keyword">boolean</span> isBu=SpUtils.getInstance(<span class="hljs-keyword">this</span>).getBoolean(<span class="hljs-string">"isBu"</span>,<span class="hljs-keyword">false</span>);
        Log.e(<span class="hljs-string">"kid"</span>,<span class="hljs-string">"text======="</span>+text);
        Log.e(<span class="hljs-string">"kid"</span>,<span class="hljs-string">"num======="</span>+num);
        Log.e(<span class="hljs-string">"kid"</span>,<span class="hljs-string">"isBu======="</span>+isBu);
    }


}</code></pre> 
<p>存储的时候，调用 SpUtils.getInstance(this).set(键,值,存储多少秒);在工具里拆成setString，setInt，setBoolean，setLong只是方便阅读。因为取的时候，必须指明取出的类型，如果存的时候是存boolean，取的时候用int去取，就会报类型转换异常。 <br> PS：存的时候，不加存储时间，默认是永久。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1a812f81f58f3537f6597a83aeb8e4c0/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">VUE中常用的几种import（模块、文件）引入方式</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/fb188fd8742e8f9cd3b4fdab38ca792f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">新手菜鸟学习VBA—如何录制一个简单的宏</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>