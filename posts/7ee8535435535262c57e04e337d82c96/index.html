<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>dockercompose搭建elk - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="dockercompose搭建elk" />
<meta property="og:description" content="Elastic Stack简介 如果你没有听说过Elastic Stack，那你一定听说过ELK，实际上ELK是三款软件的简称，分别是Elasticsearch、 Logstash、Kibana组成，在发展的过程中，又有新成员Beats的加入，所以就形成了Elastic Stack。所以说，ELK是旧的称呼，Elastic Stack是新的名字。
全系的Elastic Stack技术栈包括：
Elasticsearch ElasticSearch是一个基于Lucene的搜索服务器。它提供了一个分布式多用户能力的全文搜索引擎，基于RESTful web接口。Elasticsearch是用Java开发的，并作为Apache许可条款下的开放源码发布，是当前流行的企业级搜索引擎。设计用于云计算中，能够达到实时搜索，稳定，可靠，快速，安装使用方便。
我们建立一个网站或应用程序，并要添加搜索功能，但是想要完成搜索工作的创建是非常困难的。我们希望搜索解决方案要运行速度快，我们希望能有一个零配置和一个完全免费的搜索模式，我们希望能够简单地使用JSON通过HTTP来索引数据，我们希望我们的搜索服务器始终可用，我们希望能够从一台开始并扩展到数百台，我们要实时搜索，我们要简单的多租户，我们希望建立一个云的解决方案。因此我们利用Elasticsearch来解决所有这些问题及可能出现的更多其它问题。
ElasticSearch是Elastic Stack的核心，同时Elasticsearch 是一个分布式、RESTful风格的搜索和数据分析引擎，能够解决不断涌现出的各种用例。作为Elastic Stack的核心，它集中存储您的数据，帮助您发现意料之中以及意料之外的情况。
Elasticsearch的发展是非常快速的，所以在ES5.0之前，ELK的各个版本都不统一，出现了版本号混乱的状态，所以从5.0开始，所有Elastic Stack中的项目全部统一版本号。（elk版本号必须要统一）
Kibana Kibana 是一款开源的数据分析和可视化平台，它是 Elastic Stack 成员之一，设计用于和 Elasticsearch 协作。您可以使用 Kibana 对 Elasticsearch 索引中的数据进行搜索、查看、交互操作。您可以很方便的利用图表、表格及地图对数据进行多元化的分析和呈现。
官网：https://www.elastic.co/cn/kibana
Beats Beats是elastic公司开源的一款采集系统监控数据的代理agent，是在被监控服务器上以客户端形式运行的数据收集器的统称，可以直接把数据发送给Elasticsearch或者通过Logstash发送给Elasticsearch，然后进行后续的数据分析活动。Beats由如下组成:
Packetbeat：是一个网络数据包分析器，用于监控、收集网络流量信息，Packetbeat嗅探服务器之间的流量，解析应用层协议，并关联到消息的处理，其支 持ICMP (v4 and v6)、DNS、HTTP、Mysql、PostgreSQL、Redis、MongoDB、Memcache等协议；Filebeat：用于监控、收集服务器日志文件，其已取代 logstash forwarder；Metricbeat：可定期获取外部系统的监控指标信息，其可以监控、收集 Apache、HAProxy、MongoDB MySQL、Nginx、PostgreSQL、Redis、System、Zookeeper等服务； Beats和Logstash其实都可以进行数据的采集，但是目前主流的是使用Beats进行数据采集，然后使用 Logstash进行数据的分割处理等，早期没有Beats的时候，使用的就是Logstash进行数据的采集。
Beats平台其实是一个轻量性数据采集器，通过集合多种单一用途的采集器，从成百上千台机器中向Logstash或ElasticSearch中发送数据。
通过Beats包含以下的数据采集功能
Filebeat：采集日志文件Metricbeat：采集指标Packetbeat：采集网络数据 如果我们的数据不需要任何处理，那么就可以直接发送到ElasticSearch中
如果们的数据需要经过一些处理的话，那么就可以发送到Logstash中，然后处理完成后，在发送到ElasticSearch
最后在通过Kibana对我们的数据进行一系列的可视化展示
Filebeat 介绍 Filebeat是一个轻量级的日志采集器
为什么要用Filebeat？ 当你面对成百上千、甚至成千上万的服务器、虚拟机和溶气气生成的日志时，请告别SSH吧！Filebeat将为你提供一种轻量型方法，用于转发和汇总日志与文件，让简单的事情不再繁华，关于Filebeat的记住以下两点：
轻量级日志采集器输送至ElasticSearch或者Logstash，在Kibana中实现可视化 架构 用于监控、收集服务器日志文件.
流程如下：
首先是input输入，我们可以指定多个数据输入源，然后通过通配符进行日志文件的匹配匹配到日志后，就会使用Harvester（收割机），将日志源源不断的读取到来然后收割机收割到的日志，就传递到Spooler（卷轴），然后卷轴就在将他们传到对应的地方 Logstash Logstash是一个开源的服务器端数据处理管道，能够同时从多个来源采集数据，转换数据，然后将数据发送到最喜欢的存储库中（我们的存储库当然是ElasticSearch）
我们回到我们ElasticStack的架构图，可以看到Logstash是充当数据处理的需求的，当我们的数据需要处理的时候，会将它发送到Logstash进行处理，否则直接送到ElasticSearch中
Logstash可以处理各种各样的输入，从文档，图表中=，数据库中，然后处理完后，发送到
Logstash主要是将数据源的数据进行一行一行的处理，同时还直接过滤切割等功能。
部署安装 要准备的： 1、2核4g或以上的服务器" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/7ee8535435535262c57e04e337d82c96/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-08-02T15:11:50+08:00" />
<meta property="article:modified_time" content="2021-08-02T15:11:50+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">dockercompose搭建elk</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="Elastic_Stack_0"></a>Elastic Stack简介</h3> 
<p>如果你没有听说过Elastic Stack，那你一定听说过ELK，实际上ELK是三款软件的简称，分别是Elasticsearch、 Logstash、Kibana组成，在发展的过程中，又有新成员Beats的加入，所以就形成了Elastic Stack。所以说，ELK是旧的称呼，Elastic Stack是新的名字。</p> 
<p><img src="https://images2.imgbox.com/75/c9/gs9hIMrS_o.png" alt="image-20200922092403279"></p> 
<p>全系的Elastic Stack技术栈包括：</p> 
<p><img src="https://images2.imgbox.com/55/5d/DJrADeaB_o.png" alt="image-20200922092505011"></p> 
<h4><a id="Elasticsearch_10"></a>Elasticsearch</h4> 
<p>ElasticSearch是一个基于Lucene的搜索服务器。它提供了一个分布式多用户能力的全文搜索引擎，基于RESTful web接口。Elasticsearch是用Java开发的，并作为Apache许可条款下的开放源码发布，是当前流行的企业级搜索引擎。设计用于云计算中，能够达到实时搜索，稳定，可靠，快速，安装使用方便。</p> 
<p>我们建立一个网站或应用程序，并要添加搜索功能，但是想要完成搜索工作的创建是非常困难的。我们希望搜索解决方案要运行速度快，我们希望能有一个零配置和一个完全免费的搜索模式，我们希望能够简单地使用JSON通过HTTP来索引数据，我们希望我们的搜索服务器始终可用，我们希望能够从一台开始并扩展到数百台，我们要实时搜索，我们要简单的多租户，我们希望建立一个云的解决方案。因此我们利用Elasticsearch来解决所有这些问题及可能出现的更多其它问题。</p> 
<p>ElasticSearch是Elastic Stack的核心，同时Elasticsearch 是一个分布式、RESTful风格的搜索和数据分析引擎，能够解决不断涌现出的各种用例。作为Elastic Stack的核心，它集中存储您的数据，帮助您发现意料之中以及意料之外的情况。</p> 
<p>Elasticsearch的发展是非常快速的，所以在ES5.0之前，ELK的各个版本都不统一，出现了版本号混乱的状态，所以从5.0开始，所有Elastic Stack中的项目全部统一版本号。<strong>（elk版本号必须要统一）</strong></p> 
<h4><a id="Kibana_22"></a>Kibana</h4> 
<p>Kibana 是一款开源的数据分析和可视化平台，它是 Elastic Stack 成员之一，设计用于和 Elasticsearch 协作。您可以使用 Kibana 对 Elasticsearch 索引中的数据进行搜索、查看、交互操作。您可以很方便的利用图表、表格及地图对数据进行多元化的分析和呈现。</p> 
<p>官网：https://www.elastic.co/cn/kibana</p> 
<p><img src="https://images2.imgbox.com/13/ba/HLryPE9Y_o.png" alt="image-20200924193926486"></p> 
<h4><a id="Beats_32"></a>Beats</h4> 
<p>Beats是elastic公司开源的一款采集系统监控数据的代理agent，是在被监控服务器上以客户端形式运行的数据收集器的统称，可以直接把数据发送给Elasticsearch或者通过Logstash发送给Elasticsearch，然后进行后续的数据分析活动。Beats由如下组成:</p> 
<ul><li>Packetbeat：是一个网络数据包分析器，用于监控、收集网络流量信息，Packetbeat嗅探服务器之间的流量，解析应用层协议，并关联到消息的处理，其支 持ICMP (v4 and v6)、DNS、HTTP、Mysql、PostgreSQL、Redis、MongoDB、Memcache等协议；</li><li>Filebeat：用于监控、收集服务器日志文件，其已取代 logstash forwarder；</li><li>Metricbeat：可定期获取外部系统的监控指标信息，其可以监控、收集 Apache、HAProxy、MongoDB MySQL、Nginx、PostgreSQL、Redis、System、Zookeeper等服务；</li></ul> 
<blockquote> 
 <p>Beats和Logstash其实都可以进行数据的采集，但是目前主流的是使用Beats进行数据采集，然后使用 Logstash进行数据的分割处理等，早期没有Beats的时候，使用的就是Logstash进行数据的采集。</p> 
</blockquote> 
<p>Beats平台其实是一个轻量性数据采集器，通过集合多种单一用途的采集器，从成百上千台机器中向Logstash或ElasticSearch中发送数据。</p> 
<p><img src="https://images2.imgbox.com/35/65/GgpYYI9a_o.png" alt="image-20200924091716757"></p> 
<p>通过Beats包含以下的数据采集功能</p> 
<ul><li>Filebeat：采集日志文件</li><li>Metricbeat：采集指标</li><li>Packetbeat：采集网络数据</li></ul> 
<p><img src="https://images2.imgbox.com/53/6f/YRQZSe3N_o.png" alt="image-20200924092015934"></p> 
<p>如果我们的数据不需要任何处理，那么就可以直接发送到ElasticSearch中</p> 
<p>如果们的数据需要经过一些处理的话，那么就可以发送到Logstash中，然后处理完成后，在发送到ElasticSearch</p> 
<p>最后在通过Kibana对我们的数据进行一系列的可视化展示</p> 
<p><img src="https://images2.imgbox.com/53/3e/kS5koB7w_o.png" alt="image-20200924092348121"></p> 
<h3><a id="Filebeat_62"></a>Filebeat</h3> 
<h4><a id="_64"></a>介绍</h4> 
<p>Filebeat是一个轻量级的日志采集器</p> 
<p><img src="https://images2.imgbox.com/a3/69/94uQTjcb_o.png" alt="image-20200924092551044"></p> 
<h4><a id="Filebeat_70"></a>为什么要用Filebeat？</h4> 
<p>当你面对成百上千、甚至成千上万的服务器、虚拟机和溶气气生成的日志时，请告别SSH吧！Filebeat将为你提供一种轻量型方法，用于转发和汇总日志与文件，让简单的事情不再繁华，关于Filebeat的记住以下两点：</p> 
<ul><li>轻量级日志采集器</li><li>输送至ElasticSearch或者Logstash，在Kibana中实现可视化</li></ul> 
<h4><a id="_77"></a>架构</h4> 
<p>用于监控、收集服务器日志文件.</p> 
<p><img src="https://images2.imgbox.com/1d/40/BY7FeBvC_o.png" alt="image-20200924092749077"></p> 
<p>流程如下：</p> 
<ul><li>首先是input输入，我们可以指定多个数据输入源，然后通过通配符进行日志文件的匹配</li><li>匹配到日志后，就会使用Harvester（收割机），将日志源源不断的读取到来</li><li>然后收割机收割到的日志，就传递到Spooler（卷轴），然后卷轴就在将他们传到对应的地方</li></ul> 
<h4><a id="Logstash_89"></a>Logstash</h4> 
<p>Logstash是一个开源的服务器端数据处理管道，能够同时从多个来源采集数据，转换数据，然后将数据发送到最喜欢的存储库中（我们的存储库当然是ElasticSearch）</p> 
<p><img src="https://images2.imgbox.com/88/ef/cjVLmCGH_o.png" alt="image-20200924213006328"></p> 
<p>我们回到我们ElasticStack的架构图，可以看到Logstash是充当数据处理的需求的，当我们的数据需要处理的时候，会将它发送到Logstash进行处理，否则直接送到ElasticSearch中</p> 
<p>Logstash可以处理各种各样的输入，从文档，图表中=，数据库中，然后处理完后，发送到</p> 
<p><img src="https://images2.imgbox.com/08/b5/dgIxzql2_o.png" alt="image-20200924213350345"></p> 
<p>Logstash主要是将数据源的数据进行一行一行的处理，同时还直接过滤切割等功能。</p> 
<p><img src="https://images2.imgbox.com/e1/07/wbFJpX6d_o.png" alt="image-20200924214152859"></p> 
<h3><a id="_109"></a>部署安装</h3> 
<h5><a id="_111"></a>要准备的：</h5> 
<p>1、2核4g或以上的服务器</p> 
<p>2、docker</p> 
<p>3、docker-compose</p> 
<h4><a id="1docker_121"></a>1、安装docker</h4> 
<p>首先到docker官网查看文档(docker的安装需要centos7.x以上)：https://docs.docker.com/engine/install/centos/</p> 
<p>1、卸载旧版本的docker</p> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> yum remove docker <span class="token punctuation">\</span>
                  docker-client <span class="token punctuation">\</span>
                  docker-client-latest <span class="token punctuation">\</span>
                  docker-common <span class="token punctuation">\</span>
                  docker-latest <span class="token punctuation">\</span>
                  docker-latest-logrotate <span class="token punctuation">\</span>
                  docker-logrotate <span class="token punctuation">\</span>
                  docker-engine
</code></pre> 
<p>2、设置镜像仓库</p> 
<pre><code class="prism language-shell"> <span class="token function">sudo</span> yum <span class="token function">install</span> -y yum-utils
 <span class="token function">sudo</span> yum-config-manager <span class="token punctuation">\</span>
    --add-repo <span class="token punctuation">\</span>
    https://download.docker.com/linux/centos/docker-ce.repo
    
    <span class="token comment"># 换成国内阿里云的docker仓库</span>
    yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
</code></pre> 
<p>3、安装docker引擎</p> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> yum <span class="token function">install</span> docker-ce docker-ce-cli containerd.io
</code></pre> 
<p>4、docker版本检查</p> 
<pre><code class="prism language-shell">docker version

<span class="token comment">#启动docker</span>
<span class="token function">service</span> docker start

<span class="token comment"># 设置开机自启动</span>
systemctl <span class="token builtin class-name">enable</span> docker
</code></pre> 
<h4><a id="2dockercompose_170"></a>2、安装docker-compose</h4> 
<p>找到官网地址：https://docs.docker.com/compose/install/</p> 
<p>1、安装</p> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> <span class="token function">curl</span> -L <span class="token string">"https://github.com/docker/compose/releases/download/1.29.2/docker-compose-<span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> -s<span class="token variable">)</span></span>-<span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> -m<span class="token variable">)</span></span>"</span> -o /usr/local/bin/docker-compose
</code></pre> 
<p>2、授权</p> 
<pre><code>sudo chmod +x /usr/local/bin/docker-compose
</code></pre> 
<h4><a id="3_186"></a>3、准备镜像</h4> 
<pre><code class="prism language-shell">docker pull logstash:7.9.3
docker pull kibana:7.9.3
docker pull elasticsearch:7.9.3
docker pull elastic/filebeat:7.9.3
</code></pre> 
<h4><a id="4efk_197"></a>4、搭建efk（注意文件挂载的位置）</h4> 
<p>1、docker-compose.yml</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"3.9"</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">elasticsearch</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> elasticsearch<span class="token punctuation">:</span>7.9.3
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> elasticsearch
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 9200<span class="token punctuation">:</span><span class="token number">9200</span>
      <span class="token punctuation">-</span> 9300<span class="token punctuation">:</span><span class="token number">9300</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> discovery.type=single<span class="token punctuation">-</span>node
      <span class="token punctuation">-</span> ES_JAVA_OPTS=<span class="token punctuation">-</span>Xms64m <span class="token punctuation">-</span>Xmx128m
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./elasticsearch/data<span class="token punctuation">:</span>/usr/share/elasticsearch/data
      <span class="token punctuation">-</span> ./elasticsearch/download<span class="token punctuation">:</span>/usr/share/elasticsearch/download

  <span class="token key atrule">kibana</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> kibana<span class="token punctuation">:</span>7.9.3
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> kibana
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 5601<span class="token punctuation">:</span><span class="token number">5601</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> elasticsearch_url=elasricsearch<span class="token punctuation">:</span><span class="token number">9200</span>
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> elasticsearch

  <span class="token key atrule">filebeat</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> elastic/filebeat<span class="token punctuation">:</span>7.9.3
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> filebeat
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./filebeat/filebeat.yml<span class="token punctuation">:</span>/usr/share/filebeat/filebeat.yml
      <span class="token punctuation">-</span> ./filebeat/logs<span class="token punctuation">:</span>/var/log/filebeat/logs
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> elasticsearch
      <span class="token punctuation">-</span> kibana
</code></pre> 
<p>需要注意的地方：</p> 
<pre><code>1、es设置成单节点模式

2、设置es的占用内存

3、 容器卷挂载:
	1)是方便在容器外面编辑容器配置文件，还有比如es安装ik分词插件什么的
	2)可以防止删除容器之后所有数据就没有（持久化）
	
	
4、容器间内部通讯:
    1)docker-compose 默认会创建一个桥接模式的网络 ，这些容器间可以直接通过服务（service）名字建立通讯，而不用写ip地址
    2)docker network ls 查看 网络  
    3)docker network inspect 网络名字查看网络配置
    
</code></pre> 
<p>2、filebeat.yml</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">filebeat</span><span class="token punctuation">:</span>
  <span class="token key atrule">inputs</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> /var/log/filebeat/logs/<span class="token important">*.log</span>

<span class="token key atrule">setup</span><span class="token punctuation">:</span>
  <span class="token key atrule">ilm</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">settings</span><span class="token punctuation">:</span>
      <span class="token key atrule">index</span><span class="token punctuation">:</span>
        <span class="token key atrule">number_of_shards</span><span class="token punctuation">:</span> <span class="token number">1</span>
        <span class="token key atrule">number_of_replicas</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"filebeat"</span>
    <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token string">"filebeat-*"</span>
  <span class="token key atrule">kibana</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> <span class="token string">"kibana:5601"</span>

<span class="token key atrule">output</span><span class="token punctuation">:</span>
<span class="token comment">#  logstash:</span>
<span class="token comment">#    hosts: ["logstash:5044"]</span>
  <span class="token key atrule">elasticsearch</span><span class="token punctuation">:</span>
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"elasticsearch:9200"</span><span class="token punctuation">]</span>
    <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"filebeat-%{+yyyy.MM.dd}"</span>


</code></pre> 
<p>docker-compose命令：</p> 
<pre><code class="prism language-shell"><span class="token comment">#启动服务</span>
docker-compose up -d 
<span class="token comment">#启动并编译</span>
docker-compose up -d --build
<span class="token comment">#停止并删除容器</span>
docker-compose down
<span class="token comment">#查看容器日志</span>
docker-compose logs 
docker logs 容器id
</code></pre> 
<h4><a id="5elk_314"></a>5、搭建elk</h4> 
<h3><a id="_316"></a>流程说明</h3> 
<p><img src="https://images2.imgbox.com/be/d1/LZ1W9yb6_o.png" alt="image-20200925083514711"></p> 
<ul><li>应用APP生产日志，用来记录用户的操作 
  <ul><li>[INFO] 2019-03-15 22:55:20 [Main] - DAU|5206|使用优惠券|2019-03-15 03:37:20</li><li>[INFO] 2019-03-15 22:55:21 [Main] - DAU|3880|浏览页面|2019-03-15 07:25:09</li></ul> </li><li>通过Filebeat读取日志文件中的内容，并且将内容发送给Logstash，原因是需要对内容做处理</li><li>Logstash接收到内容后，进行处理，如分割操作，然后将内容发送到Elasticsearch中</li><li>Kibana会读取Elasticsearch中的数据，并且在Kibana中进行设计Dashboard，最后进行展示</li></ul> 
<p>1、docker-compose.yml</p> 
<pre><code class="prism language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"3.9"</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">elasticsearch</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> elasticsearch<span class="token punctuation">:</span>7.9.3
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> elasticsearch
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 9200<span class="token punctuation">:</span><span class="token number">9200</span>
      <span class="token punctuation">-</span> 9300<span class="token punctuation">:</span><span class="token number">9300</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> discovery.type=single<span class="token punctuation">-</span>node
      <span class="token punctuation">-</span> ES_JAVA_OPTS=<span class="token punctuation">-</span>Xms64m <span class="token punctuation">-</span>Xmx128m
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./elasticsearch/data<span class="token punctuation">:</span>/usr/share/elasticsearch/data
      <span class="token punctuation">-</span> ./elasticsearch/download<span class="token punctuation">:</span>/usr/share/elasticsearch/download

  <span class="token key atrule">kibana</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> kibana<span class="token punctuation">:</span>7.9.3
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> kibana
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 5601<span class="token punctuation">:</span><span class="token number">5601</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> elasticsearch_url=elasricsearch<span class="token punctuation">:</span><span class="token number">9200</span>
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> elasticsearch

  <span class="token key atrule">filebeat</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> elastic/filebeat<span class="token punctuation">:</span>7.9.3
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> filebeat
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./filebeat/filebeat.yml<span class="token punctuation">:</span>/usr/share/filebeat/filebeat.yml
      <span class="token punctuation">-</span> ./filebeat/logs<span class="token punctuation">:</span>/var/log/filebeat/logs
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> elasticsearch
      <span class="token punctuation">-</span> kibana
      
  <span class="token key atrule">logstash</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> logstash<span class="token punctuation">:</span>7.9.3
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> logstash
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./logstash/pipeline/logstash.conf<span class="token punctuation">:</span>/usr/share/logstash/pipeline/logstash.conf
      <span class="token punctuation">-</span> ./logstash/template.json<span class="token punctuation">:</span>/etc/logstash/template.json
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"5044:5044"</span>
      <span class="token punctuation">-</span> <span class="token string">"9600:9600"</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">LS_JAVA_OPTS</span><span class="token punctuation">:</span> <span class="token string">"-Xms512m -Xmx512m"</span>
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> elasticsearch
</code></pre> 
<p>2、filebeat.yml</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">filebeat</span><span class="token punctuation">:</span>
  <span class="token key atrule">inputs</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> /var/log/filebeat/logs/<span class="token important">*.log</span>

<span class="token key atrule">setup</span><span class="token punctuation">:</span>
  <span class="token key atrule">ilm</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">settings</span><span class="token punctuation">:</span>
      <span class="token key atrule">index</span><span class="token punctuation">:</span>
        <span class="token key atrule">number_of_shards</span><span class="token punctuation">:</span> <span class="token number">1</span>
        <span class="token key atrule">number_of_replicas</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"filebeat"</span>
    <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token string">"filebeat-*"</span>
  <span class="token key atrule">kibana</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> <span class="token string">"kibana:5601"</span>

<span class="token key atrule">output</span><span class="token punctuation">:</span>
  <span class="token key atrule">logstash</span><span class="token punctuation">:</span>
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"logstash:5044"</span><span class="token punctuation">]</span>
<span class="token comment">#  elasticsearch:</span>
<span class="token comment">#    hosts: ["elasticsearch:9200"]</span>
<span class="token comment">#    index: "filebeat-%{+yyyy.MM.dd}"</span>
</code></pre> 
<p>3、logstash.conf</p> 
<pre><code>input {
    beats {
       port =&gt; 5044
    }
}

filter {
    grok {
        pattern_definitions =&gt; {
            "QUALIFIED" =&gt; "[a-zA-Z0-9$_.]+"
        }

        match =&gt; {
            "message" =&gt; "%{TIMESTAMP_ISO8601:logdate}%{SPACE}\[%{USERNAME:logthread}\]%{SPACE}%{WORD:loglevel}%{SPACE}%{QUALIFIED:logclass:text}%{SPACE}-%{SPACE}%{GREEDYDATA:logmsg:text}"

        }

    }
}


output {
    elasticsearch {
        hosts =&gt;["elasticsearch:9200"]
        index =&gt; "logstash-%{+yyyy.MM.dd}"
        template =&gt; "/etc/logstash/template.json"
        template_name =&gt; "logstash"
    }

}
</code></pre> 
<p>4、template.json</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string">"template"</span><span class="token operator">:</span> <span class="token string">"logstash-*"</span><span class="token punctuation">,</span>
  <span class="token string">"settings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"number_of_shards"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string">"number_of_replicas"</span><span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"logclass"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">"logdate"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"date"</span><span class="token punctuation">,</span>
        <span class="token string">"format"</span><span class="token operator">:</span> <span class="token string">"yyyy-MM-dd HH:mm:ss.SSS"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">"loglevel"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">"logthread"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">"logmsg"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="6grok_485"></a>6.grok表达式</h4> 
<p>参考地址：https://github.com/logstash-plugins/logstash-patterns-core/blob/master/patterns/ecs-v1/grok-patterns</p> 
<p>正则表达式：https://www.runoob.com/regexp/regexp-rule.html</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/60c50f7b1688e544a4917a2c6a653d78/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">中科大计算机学太多数学物理,中科大外号“中国物理大学”，那么“中国数学物理大学”是谁？...</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8f7ad9d6afeedfd9ba0c91c7702f3443/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">前端vue集成金格科技 iwebPdf 2018中间件</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>