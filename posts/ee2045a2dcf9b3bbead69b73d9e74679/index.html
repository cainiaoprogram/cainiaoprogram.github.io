<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MindSpore GPU异构算子全流程开发指导 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="MindSpore GPU异构算子全流程开发指导" />
<meta property="og:description" content="Tips ① 此文档详细介绍了MindSpore GPU异构算子开发流程，与官方文档相比本文档更加侧重于开发文件的解读以及常用开发方法的讲解。同时本文档用词相对简单，主要帮助大家了解GPU算子开发需要写什么，各种文件的作用是什么以及应该怎么写这些文件，而官方文档中则更偏向于基础概念和框架的介绍，建议大家将两个文档结合起来阅读，这样更能够加深理解。 ② 本文篇幅较长，如果有自己熟悉的内容可以直接跳过，但是建议大家能够仔细阅读第三章，充分了解GPU算子需要开发哪些文件、每个开发文件的作用以及常用的方法，这样可以更快的入门，开始开发算子。 ③ MindSpore GPU异构算子调用流程如下 ④ 此文档也有网页版：GPU异构算子全流程开发指导-云社区-华为云，大家愿意的话可以支持一下，刷一刷阅读量。 ⑤ 本文主要为前期准备和开发流程，附加了两个关于接口文档测试的内容，后续进入测试阶段我也会写一个GPU算子测试指导。 ⑥ 如有遗漏或错误，欢迎指出与修改。 常用网址 ① GPU 算子全流程开发指导录屏 ② BartlettWindow 算子 PR ③ MindSpore 算子 Issue 查询网址 ④ MindSpore 官方安装网址 ⑤ MindSpore 官方算子查询网址 ⑥ 谭升 -GPU 编程 一、 环境配置 1. 连接服务器 （1） ssh跳转连接 使用服务器链接软件在同一个连接会话中，依次连续输入以下命令：
① 跳转服务器1：
ssh jump@xxx.xxx.xxx.xxx passwd: xxxxxxxx
② 跳转服务器2：
ssh test@xxx.xxx.xxx.xxx passwd: xxxxxxxx
③ GPU算子服务器：
ssh user14@xxx.xxx.xxx.xxx -p xxxx pwd:xxxxxxxx
输入ls，到达此界面即为连接成功！
（2） VPN连接方法 ① 点击右下角网络（WiFi那个标识），点击网络和Internet设置。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/ee2045a2dcf9b3bbead69b73d9e74679/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-09T15:57:01+08:00" />
<meta property="article:modified_time" content="2022-08-09T15:57:01+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">MindSpore GPU异构算子全流程开发指导</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2><strong>Tips</strong></h2> 
<h3>① 此文档详细介绍了MindSpore GPU异构算子开发流程，与官方文档相比本文档更加侧重于开发文件的解读以及常用开发方法的讲解。同时本文档用词相对简单，主要帮助大家了解GPU算子开发需要写什么，各种文件的作用是什么以及应该怎么写这些文件，而官方文档中则更偏向于基础概念和框架的介绍，建议大家将两个文档结合起来阅读，这样更能够加深理解。</h3> 
<h3>② 本文篇幅较长，如果有自己熟悉的内容可以直接跳过，但是建议大家能够仔细阅读第三章，充分了解GPU算子需要开发哪些文件、每个开发文件的作用以及常用的方法，这样可以更快的入门，开始开发算子。</h3> 
<h3>③ MindSpore GPU异构算子调用流程如下</h3> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/c5/63/7IneE7xv_o.png"></p> 
<h3>④ 此文档也有网页版：<a href="https://bbs.huaweicloud.com/blogs/364623" rel="nofollow" title="GPU异构算子全流程开发指导-云社区-华为云">GPU异构算子全流程开发指导-云社区-华为云</a>，大家愿意的话可以支持一下，刷一刷阅读量。</h3> 
<h3>⑤ 本文主要为前期准备和开发流程，附加了两个关于接口文档测试的内容，后续进入测试阶段我也会写一个GPU算子测试指导。</h3> 
<h3>⑥ 如有遗漏或错误，欢迎指出与修改。</h3> 
<h2>常用网址</h2> 
<h3>① <strong>GPU</strong> <strong>算子全流程开发指导录屏</strong> </h3> 
<h3>② <a href="https://gitee.com/mindspore/mindspore/pulls/35601" rel="nofollow" title="BartlettWindow ">BartlettWindow </a><a href="https://gitee.com/mindspore/mindspore/pulls/35601" rel="nofollow" title="算子 ">算子 </a><a href="https://gitee.com/mindspore/mindspore/pulls/35601" rel="nofollow" title="PR ">PR </a></h3> 
<h3>③ <a href="https://gitee.com/mindspore/mindspore/issues" rel="nofollow" title="MindSpore ">MindSpore </a><a href="https://gitee.com/mindspore/mindspore/issues" rel="nofollow" title="算子 ">算子 </a><a href="https://gitee.com/mindspore/mindspore/issues" rel="nofollow" title="Issue ">Issue </a><a href="https://gitee.com/mindspore/mindspore/issues" rel="nofollow" title="查询网址 ">查询网址 </a></h3> 
<h3>④ <strong>MindSpore</strong> <strong>官方安装网址</strong> </h3> 
<h3>⑤ <strong>MindSpore</strong> <strong>官方算子查询网址</strong> </h3> 
<h3>⑥ <strong>谭升</strong> <strong>-GPU</strong> <strong>编程</strong></h3> 
<p></p> 
<h2>一、 环境配置</h2> 
<h3>1. 连接服务器</h3> 
<h4>（1） ssh跳转连接</h4> 
<p>使用服务器链接软件在<strong>同一个连接会话</strong>中，<strong>依次</strong><strong>连续</strong>输入以下命令：</p> 
<p><strong>① 跳转服务器1：</strong></p> 
<p>ssh jump@xxx.xxx.xxx.xxx  passwd: xxxxxxxx</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/0f/7b/UaDW1YUU_o.png"></p> 
<p><strong>② </strong><strong>跳转服务器2：</strong></p> 
<p>ssh test@xxx.xxx.xxx.xxx  passwd: xxxxxxxx</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/64/fb/38BW8zhv_o.png"></p> 
<p><strong>③ </strong><strong>GPU算子服务器：</strong></p> 
<p>ssh user14@xxx.xxx.xxx.xxx -p xxxx pwd:xxxxxxxx</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/ea/56/4usJFbgi_o.png"></p> 
<p>输入ls，到达此界面即为连接成功！</p> 
<h4>（2） VPN连接方法</h4> 
<p><strong>① </strong><strong>点击右下角网络（WiFi那个标识），点击网络和Internet设置。</strong></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/bb/1e/MxHYMCKF_o.png"></p> 
<p><strong>② </strong><strong>点击VPN，添加VPN（我已经设置过一个，请忽略）。</strong></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/4a/05/3egGb4e2_o.png"></p> 
<p><strong>③ 设置GPU算子开发网络连接，输入如下用户名和密码，点击保存。</strong></p> 
<p>VPN信息：</p> 
<p>服务器地址：xxx.xxx.xxx.xxx</p> 
<p>用户名：xxxxxxxx</p> 
<p>密码：xxxxxxxx</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/d3/2e/BPpNP9Zo_o.png"></p> 
<p><strong>④ 打开控制面板-网络连接，并选择刚创建的vpn右键属性</strong></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/07/b3/Bvbtqsyz_o.png"></p> 
<p><strong>⑤ 选择网络-IPV4-属性-高级，取消勾选“在远程网络上使用默认网关”</strong></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/47/a0/tgTI5Hl4_o.png"></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/af/2e/eWKFS6AI_o.png"></p> 
<p><strong>⑥ 选择安全，选择允许使用这些协议，点击确定</strong></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/2a/ff/UJBLEboS_o.png"></p> 
<p><strong>⑦ 连接VPN后直接连接服务器</strong></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/37/44/MWVijzQg_o.png"></p> 
<p>ssh user14@xxx.xxx.xxx.xxx -p xxx pwd:xxxxxxxx</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/34/13/TMEGL3W0_o.png"></p> 
<p>输入ls，到达此界面即为连接成功！</p> 
<h3>2. 下载mindspore包</h3> 
<h4>（1） 注册gitee账号</h4> 
<p>在官网注册自己的gitee账号用于后续加入团队开发仓库和提交代码。</p> 
<p><a href="https://gitee.com" rel="nofollow" title="https://gitee.com ">https://gitee.com </a></p> 
<h4>（2） 加入Owner仓库</h4> 
<p>创建好gitee账户后联系团队owner，让他在自己的账户上邀请团队成员成为仓库开发者，这样成员的账号才有权限往owner仓库直接提交代码。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/eb/3d/YZJVz8M0_o.png"></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/68/80/qAYeSdlM_o.png"></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/b5/20/yLZA5bPV_o.png"></p> 
<p>将邀请链接或二维码发送给团队成员邀请其加入仓库：</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/fb/a8/M6aXFTBl_o.png"></p> 
<p>成员接收邀请后，owner可以在私信栏找到成员的申请，进入后点击同意即可。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/c5/d4/vOQQxjbb_o.png"></p> 
<h4>（3） 创建分支</h4> 
<p>成员加入团队后登录自己的账号可以看到owner的主仓，点击进入</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/b7/46/cYmZkTZ4_o.png"></p> 
<p>点击分支</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/25/b6/ITsG2rus_o.png"></p> 
<p>点击新建分支，输入自己想取的分支名（一个算子使用一个单独的分支名）：</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/07/1a/6mXOQl9g_o.png"></p> 
<p>创建完成后回到owner的mindspore仓库，可以查询到自己的分支：</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/84/12/8gMpm50k_o.png"></p> 
<h4>（4） 下载mindspore</h4> 
<p>连接服务器后创建自己的文件夹：</p> 
<p>mkdier wzb_SSSqG</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/86/8b/6GSw1rcY_o.png"></p> 
<p>激活公共环境ci3.7</p> 
<p>source /home/Public/env.sh</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/2d/23/7TDHsnWm_o.png"></p> 
<p>创建个人conda环境</p> 
<p>conda create -n wzb_SSSqG --clone ci3.7</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/91/ef/vyMReall_o.png"></p> 
<p>复制测试环境脚本</p> 
<p>cp /home/Public/env.sh wzb_SSSqG/</p> 
<p>cd wzb_SSSqG/</p> 
<p>sed -i 's/ci3.7/wzb_SSSqG/g' env.sh</p> 
<p>每次登陆后都需要执行以下脚本，开启测试环境</p> 
<p>source env.sh</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/c7/38/9zAFePD0_o.png"></p> 
<p>下载团队owner的mindspore仓库</p> 
<p>git clone <a href="https://gitee.com/EJaven/mindspore.git" rel="nofollow" title="https://gitee.com/EJaven/mindspore.git ">https://gitee.com/EJaven/mindspore.git </a></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/9c/ed/awIyWsi5_o.png"></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/bd/4e/y0mcfw3u_o.png"></p> 
<p>进入mindspore文件夹，切换到自己创建的分支</p> 
<p>cd mindspore</p> 
<p>git checkout SSSqG</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/57/0a/C2cx4FfN_o.png"></p> 
<h2>二、 开发流程</h2> 
<p>本章将大致介绍本次GPU异构算子开发的整体流程，并对需要开发的文件进行简要介绍。大家最好能够先详细阅读一遍华为官方GPU算子开发指南，了解一些基本概念后结合此文档进行学习和理解。</p> 
<p><a href="https://gitee.com/david-he91/mindspore/wikis/MindSpore%E7%AE%97%E5%AD%90%E4%BC%97%E6%99%BA/GPU%E7%AE%97%E5%AD%90/GPU%E7%AE%97%E5%AD%90%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/01.%20%E4%BD%BF%E7%94%A8%E5%89%8D%E5%BF%85%E8%AF%BB" rel="nofollow" title="华为 ">华为 </a><a href="https://gitee.com/david-he91/mindspore/wikis/MindSpore%E7%AE%97%E5%AD%90%E4%BC%97%E6%99%BA/GPU%E7%AE%97%E5%AD%90/GPU%E7%AE%97%E5%AD%90%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/01.%20%E4%BD%BF%E7%94%A8%E5%89%8D%E5%BF%85%E8%AF%BB" rel="nofollow" title="GPU ">GPU </a><a href="https://gitee.com/david-he91/mindspore/wikis/MindSpore%E7%AE%97%E5%AD%90%E4%BC%97%E6%99%BA/GPU%E7%AE%97%E5%AD%90/GPU%E7%AE%97%E5%AD%90%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/01.%20%E4%BD%BF%E7%94%A8%E5%89%8D%E5%BF%85%E8%AF%BB" rel="nofollow" title="算子开发指南 ">算子开发指南 </a></p> 
<h3>1. MindSpore GPU异构算子调用流程</h3> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/27/e8/sGlUMEIz_o.png"></p> 
<h3>2. 开发文件清单</h3> 
<p>依据以上GPU异构算子调用流程，我们可以总结本次GPU异构算子开发所需开发文件以及文件功能如下：</p> 
<table><tbody><tr><td> <p><strong>算子</strong><strong>Python</strong><strong>侧前端定义文件</strong></p> </td></tr><tr><td> <p><strong>正向单算子：</strong></p> <p>mindspore/python/mindspore/ops/operations/yyy_ops.py</p> <p>(yyy为算子所属类别：[array、math、other、random、sparse]等)</p> <p><strong>反向单算子：</strong></p> <p>mindspore/python/mindspore/ops/operations/_grad_ops.py</p> <p><strong>功能描述：</strong></p> <p>编写算子Python侧前端接口，包括算子声明、校验可写性、注册算子属性</p> </td></tr><tr><td> <p><strong>算子</strong><strong>C++</strong><strong>侧前端</strong><strong>推理</strong><strong>文件</strong></p> </td></tr><tr><td> <p><strong>正向单算子：</strong></p> <p>mindspore/core/ops/xxx.h</p> <p>mindspore/core/ops/xxx.cc</p> <p><strong>反向单算子：</strong></p> <p>mindspore/core/ops/grad/xxx_grad.h</p> <p>mindspore/core/ops/grad/xxx_grad.cc</p> <p>（xxx为算子名）</p> <p><strong>算子</strong><strong>PrimitivePtr</strong><strong>定义：</strong></p> <p>mindspore/core/ops/core_ops.h</p> <p><strong>算子</strong><strong>infer</strong><strong>推理实际值注册：</strong></p> <p>mindspore/core/abstract/ops/primitive_infer_map.cc</p> <p><strong>功能描述：</strong></p> <p>编写算子C++侧前端接口以及推理函数，包括算子类声明、输入shape/type校验、输出shape/type的infer推理</p> </td></tr><tr><td> <p><strong>算子</strong><strong>C++</strong><strong>侧后端适配文件</strong></p> </td></tr><tr><td> <p><strong>正向单算子：</strong></p> <p>mindspore/ccsrc/plugin/device/gpu/kernel/yyy/xxx_gpu_kernel.h</p> <p>mindspore/ccsrc/plugin/device/gpu/kernel/yyy/xxx_gpu_kernel.cc</p> <p><strong>反向单算子：</strong></p> <p>mindspore/ccsrc/plugin/device/gpu/kernel/yyy/xxx_grad_gpu_kernel.h</p> <p>mindspore/ccsrc/plugin/device/gpu/kernel/yyy/xxx_grad_gpu_kernel.cc</p> <p>(yyy为算子所属类别：[array、math、other、random、sparse], xxx为算子名)</p> <p><strong>功能描述：</strong></p> <p>编写算子C++侧后端接口以及适配函数，包括算子注册、初始化参数校验、内存计算、调用cuda核函数、数据类型注册</p> </td></tr><tr><td> <p><strong>算子</strong><strong>cuda</strong><strong>核函数开发</strong></p> </td></tr><tr><td> <p><strong>正向单算子：</strong></p> <p>mindspore/ccsrc/plugin/device/gpu/kernel/cuda_impl/cuda_ops/xxx_impl.cuh</p> <p>mindspore/ccsrc/plugin/device/gpu/kernel/cuda_impl/cuda_ops/xxx_impl.cu</p> <p><em>mindspore/ccsrc/plugin/device/gpu/kernel/cuda_impl/cuda_</em><em>class</em><em>/xxx_helper.h</em></p> <p><strong>反向单算子：</strong></p> <p>mindspore/ccsrc/plugin/device/gpu/kernel/cuda_impl/cuda_ops/xxx_grad_impl.cuh</p> <p>mindspore/ccsrc/plugin/device/gpu/kernel/cuda_impl/cuda_ops/xxx_grad_impl.cu</p> <p><em>mindspore/ccsrc/plugin/device/gpu/kernel/cuda_impl/cuda_</em><em>class</em><em>/xxx_grad_helper.h</em></p> <p>(xxx_helper.h和xxx_grad_helper.h文件为<strong>可选文件</strong>，如果算子逻辑复杂就写，不复杂可以不用写)</p> <p><strong>功能描述：</strong></p> <p>编写算子cuda核函数，包括核函数模板声明、函数模板定义、函数模板实例化、实现多线程核函数</p> </td></tr><tr><td> <p><strong>算子</strong><strong>Python</strong><strong>反向实现文件</strong></p> </td></tr><tr><td> <p><strong>正向单算子：</strong></p> <p>mindspore/python/mindspore/ops/_grad_experimental/grad_yyy_ops.py</p> <p>(yyy为算子所属类别：[array、math、other、random、sparse]等)</p> <p><strong>反向单算子：</strong></p> <p>反向算子一般无反向，所以不用写</p> <p><strong>功能描述：</strong></p> <p>编写算子反向实现函数，包括算子反向注册、实现算子反向逻辑</p> </td></tr><tr><td> <p><strong>算子</strong><strong>ST</strong><strong>测试文件</strong></p> </td></tr><tr><td> <p><strong>正向单算子：</strong></p> <p>tests/st/ops/gpu/test_xxx_op.py</p> <p><strong>反向单算子：</strong></p> <p>tests/st/ops/gpu/test_xxx_grad_op.py</p> <p>(xxx为算子名，反向单算子视作正向单算子来测试)</p> <p><strong>功能描述：</strong></p> <p>测试算子在PYNATIVE_MODE和GRAPH_MODE两种模式下的功能和精度是否符合标准</p> </td></tr></tbody></table> 
<h3>3. 算子分类介绍</h3> 
<h4>（1） 正向单算子</h4> 
<p>平常大家使用的基本上都是正向算子，比如pow算子、mean算子、max算子等等，这些算子的功能就是其数学推导，也即正向计算过程。</p> 
<h4>（2） 正向算子的反向实现</h4> 
<p>正向单算子的反向实现逻辑，往往只需要在</p> 
<p>mindspore/python/mindspore/ops/_grad_experimental/grad_yyy_ops.py文件中使用反向单算子或其他一些正向单算子的组合来实现求算子反向的逻辑即可。</p> 
<p>反向单算子样例：</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/93/e0/sm5DR96B_o.png"></p> 
<p>正向算子组合样例：</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/69/c8/bFcup08h_o.png"></p> 
<h4>（3） 反向单算子</h4> 
<p>反向单算子实际上就是把正向单算子求反向的逻辑单独封装成一个算子，这样在实现“正向单算子的反向实现时”就可以直接调用这个算子的反向单算子。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/db/74/bvHGvxlM_o.png"></p> 
<p>在测试的时候反向单算子可以按照正向单算子的方式来调用算子进行输出的校验，但是在确保没问题之后，正常情况下必须通过mindspore的自动求导来隐式调用反向单算子，<strong>不可显示调用</strong>。</p> 
<h4>（4） 动态shape算子</h4> 
<p>动态shape算子指的是算子输出y的shape会依据输入x的数值的变化而变化，比如BartlettWindow算子需要实现BartlettWindow函数：</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/5f/44/ymuoYCKM_o.png"></p> 
<p>该算子其中一个输入为window_length，公式中表示为N，即输出y的元素个数。这时，我们输出y的shape = [N]，即输入window_length发生变化时，输出y的shape会随之变化，这种算子就称为动态shape算子。</p> 
<p>一定要注意是输出y的shape会依据输入x的<strong>“数值”</strong>的变化而变化，如果是输入x的shape变化导致输出y的shape变化，这种不算动态shape算子。</p> 
<h4>（5） 支持动态shape测试</h4> 
<p>大家依据第（4）条判断完自己的算子是否为动态shape算子之后，无论结果，GPU异构算子验收时要求<strong>所有算子支持</strong><strong>“动态</strong><strong>shape</strong><strong>输入”</strong>测试，动态shape输入和动态shape算子不是一个概念，实际上动态shape输入就是对原先静态的输入添加一步gather，只需要参照模板编写测试用例和网络即可，动态shape输入和普通静态输入差别如下：</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/2f/90/5iwORC6C_o.png"></p> 
<h2>三、 算子开发</h2> 
<p>阅读完第二章，大家应该已经了解本次GPU异构算子的调用流程以及需要开发的文件，即已经知道这个项目是要做什么。因此本章将依据第二章中罗列的需要开发的文件进行逐一讲解，主要介绍每个需要开发的文件中需要写哪些方法，这些方法的作用是什么。另外本章仅讲解正向单算子的开发过程，反向单算子的开发过程实际上一样的，仅仅是把原先正向单算子的输出y以及其对应的梯度dy也作为输入来依据逻辑进行计算罢了。</p> 
<p>为了便于理解，我将以之前开发过的一个BartlettWindow算子为例，分析该算子中各个文件中编写的代码的含义，但为了保证阅读的连贯性和排版的美观。我不会在本章节直接放出该算子的代码截图，而是将该算子的详细解析放在附录中并以超链接的方式链接到文中。除此之外大家还可以直接前往BartlettWindow算子的PR：<a href="https://gitee.com/mindspore/mindspore/pulls/35601" rel="nofollow" title="https://gitee.com/mindspore/mindspore/pulls/35601 ">https://gitee.com/mindspore/mindspore/pulls/35601 </a>查看全部完整代码。</p> 
<h3>1. 算子Python侧前端定义</h3> 
<h4>（1） mindspore/python/mindspore/ops/operations/yyy_ops.py</h4> 
<p>文件名中的yyy代表算子所属类型[array、math、other、random、sparse]，此文件功能为编写算子python侧前端接口，之后我们调用算子的时候实际上就是从这个地方开始执行的。其主要需要编写的内容和方法如下：</p> 
<p><strong>① 算子接口注释</strong></p> 
<p>编写关于算子的描述，包括：功能、数学表达式、参数、输入、输出、异常处理、支持的平台和算子样例等信息。这一部分<strong>很容易出现遗漏</strong>，同时还需要注意异常处理的<strong>报</strong><strong>错信息</strong><strong>要清晰明确</strong>，要让测试人员<strong>读得懂</strong>，不能模棱两可，否则很大概率会被直接打回。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/ce/86/HTNPdEA5_o.png"></p> 
<p>算子接口注释编写完之后需要按照如何做 doctest 和如何做接口网页自验证 进行注释文档的校验以及接口网页的自验证，以确保所写注释是正确并且符合规范的。</p> 
<p>BartlettWindow 算子接口注释 </p> 
<p>BartlettWindow 算子接口网页 </p> 
<p><strong>② Init()函数</strong></p> 
<p>编写算子的初始化函数，主要进行算子参数的校验，包括属性类型的校验、输入类型的校验、数据类型的校验等。常见方法及其作用如下：</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/38/73/1GQFq4iM_o.png"></p> 
<p>• self.add_prim_attr("xxx", 1000)</p> 
<p>给算子添加一个属性xxx，其数值为1000</p> 
<p>• validator.check_value_type("xxx", xxx, [a,b,c], self.name)：</p> 
<p>检验xxx参数的类型是否为a,b,c，如果都不是则报错。</p> 
<p>• validator.check_type_name("xxx", xxx, [float16，float32] self.name)</p> 
<p>检验xxx参数的数据类型是否为float16，float32，如果都不是则报错</p> 
<p>其他还有很多检验的方法，这些方法的命名都非常的清晰，大家看一下方法名就能大概猜出来它的作用，所以如果大家有想要校验的参数可以在库里现有的代码中搜一下用法。</p> 
<p>BartlettWindow 算子 接口 i nit() 函数 </p> 
<p><strong>③ 推理函数</strong></p> 
<p>现有MindSpore算子库中的部分算子同时有Python侧与C++侧的推理函数，包括InferType()和InferShape()。为了更好地性能以及其他一些功能上的需求，默认优先加载C++层的推理函数。我们只需要定义C++侧的推理函数即可。因此如见到<strong>Python</strong><strong>侧的推理函数</strong>，包括infer_dtype(), infer_shape(), infer()等函数时<strong>请直接忽略</strong>。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/ce/13/kxf8OReB_o.png"></p> 
<h3>2. 算子C++侧前端推理</h3> 
<h4>（1） mindspore/core/ops/xxx.h</h4> 
<p>此文件用于声明C++侧算子类、前端接口函数以及用于输入shape/type校验以及输出shape/type推理的infer函数，另外如果后续需要用到算子的某个属性值则需要增加该属性的set和get函数。</p> 
<p>此文件开发难度不大，参照一下模板和库中其他算子写就行了：</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/e7/b8/t2jBx3Bm_o.png"></p> 
<p>BartlettWindow 算子 bartlett_window.h 文件 </p> 
<h4>（2） mindspore/core/ops/xxx.cc</h4> 
<p>此文件用于实现xxx.h文件中声明的接口函数、输入type校验和输出type推导的infertype函数、输入shape校验和输出shape推导的infershape函数和属性相关的初始化、set和get函数。</p> 
<p><strong>① MyOpsInferType函数</strong></p> 
<p>校验输入的type（是否为tuple、tensor等等）、dtype（是否为float32、int32等等）以及存在约束关系的变量数据类型是否相同，并最终推理出输出的dtype，编码模板如下：</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/72/3c/8QmWD5Sd_o.png"></p> 
<p>图例外的其余校验请自行查找相应函数的用法。</p> 
<p><strong>② MyOpsInferShape函数</strong></p> 
<p>校验输入的shape是否满足要求（维度要求，大小要求）、存在约束关系的变量之间shape是否满足要求（相等、更大、更小），并最终推理出输出的shape，编码模板如下：</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/6e/e4/sudSQhI0_o.png"></p> 
<p>Infershape部分代码需要开发者针对自己的算子进行完整仔细的分析，考虑到每个参数自身shape的限制，更要考虑到不同参数之间的相互约束，最后需要通过逻辑推理计算出输出的shape值。</p> 
<p><strong>③ 属性init()、set()、get()函数</strong></p> 
<p>如果在之后的后端适配和核函数实现部分需要用到算子的某些属性数值的话就需要在此处编写这三个函数，用来给该属性初始化，赋值和取值，以MyOps的属性myattr为例，代码模板如下：</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/fb/bf/eyOtd0EL_o.png"></p> 
<p>大家在编写完编译的时候，可能会发现自己的kMyAttr这个变量没有声明，此时我们只需要在mindspore/core/ops/op_name.h文件中新增一个kMyAttr变量的声明即可，代码模板如下：</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/6e/36/QEBmlHD7_o.png"></p> 
<p><strong>④ </strong><strong>MyOpsInfer函数</strong></p> 
<p>此函数为整个InferShape和InferType的组合函数，作用为判断空值、调用InferShape和InferType函数，写法也相对固定，代码模板如下：</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/2f/e4/Im9AuoUT_o.png"></p> 
<p><strong>⑤ 宏定义</strong></p> 
<p>此处代码形式完全固定，调用MIND_API_BASE_IMPL用于注册算子继承关系，REGISTER_PRIMITI VE_EVAL_IMPL 用于注册算子推理函数，依据以下代码模板编写即可：</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/94/97/zRvhRq7p_o.png"></p> 
<p>BartlettWindow 算子 bartlett_window.cc 文件 </p> 
<h4>（3） mindspore/core/ops/core_ops.h</h4> 
<p>此文件用于添加算子PrimitivePtr定义，对算子进行注册，使得算子可以调用C++侧接口，此处代码形式也是固定的，参考以下模板即可：</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/c2/6f/YyBKjDk9_o.png"></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/88/cf/hm0BhTsJ_o.png"></p> 
<p>BartlettWindow 算子 core_ops.h 文件 </p> 
<h4>（4） mindspore/core/abstract/ops/primitive_infer_map.cc</h4> 
<p>首先我们需要了解如下信息：</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/51/54/DxnM1yFw_o.png"></p> 
<p>这一块简单来说就是我们的算子在动态shape测试时会调用两次infershape函数，而第一次调用的时候处于图编译状态，此时输出的shape无法确定，并且输入参数BuildValue得到的是AnyValue，无法获取真实值，而第二次调用的时候是出于运行时，这时可以获取到输入参数的真实数值。</p> 
<p>而想要获取到输入参数的真实数值，我们就需要在mindspore/core/abstract/</p> 
<p>ops/primitive_infer_map.cc文件中对算子infershape阶段需要获取真实数值的输入参数进行注册，注册代码也是固定形式的，参考以下模板即可：</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/f6/63/iLNvxV6p_o.png"></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/e0/be/d5jU0Npi_o.png"></p> 
<p>ShapeSet{0，2}的含义就是MyOps算子在推理时，需要用到第1、3两个输入的真实值。</p> 
<p>BartlettWindow 算子 primitive_infer_map.cc 文件 </p> 
<h3>3. 算子C++侧后端适配</h3> 
<h4>（1） mindspore/ccsrc/plugin/device/gpu/kernel/yyy/xxx_gpu_kernel.h</h4> 
<p>此处用于适配框架接口，由于对mindspore框架适配的需要， 在定义算子类时，都需要继承自NativeGpuKernelMod基类。根据最新框架要求，<strong>不可以继承</strong><strong>DeprecatedNativeGpuKernelMod</strong><strong>基类</strong>。否则算子打回重新适配 。而根据 NativeGpuKernelMod基类定义，所有算子都必须实现如下几个虚函数接口 ：Init()、Resize()、GetOpSupport()、Launch()，除此之外为了适配动态shape测试，我们还需要编写内存清理ResetResource()函数以及定义一些类私有变量。</p> 
<p>此部分代码形式固定，大部分只需要参照模板编写即可：</p> 
<p><strong>① Init()函数声明</strong></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/7d/16/NS7wWWDY_o.png"></p> 
<p><strong>② Resize()函数声明</strong></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/3c/b8/bdK8E8L4_o.png"></p> 
<p><strong>③ GetOpSupport()函数声明</strong></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/02/6c/gwa8LYCj_o.png"></p> 
<p><strong>④ Launch()函数声明</strong></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/30/12/5uOwl1BC_o.png"></p> 
<p><strong>⑤ RestResource()函数实现</strong></p> 
<p>此函数用于在动态shape过程中清除之前输入、输出以及工作空间所申请的内存，避免之前的计算结果影响新一轮计算，代码模板如下：</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/13/76/BURHxLw4_o.png"></p> 
<p><strong>⑥ 类私有变量声明</strong></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/eb/4f/2yJARmdi_o.png"></p> 
<p>BartlettWindow 算子 bartlett_window_gpu_kernel.h 文件 </p> 
<h4>（2） mindspore/ccsrc/plugin/device/gpu/kernel/yyy/xxx_gpu_kernel.cc</h4> 
<p>此文件主要需要实现xxx_gpu_kernel.cc中声明的各种方法，用于校验输入、初始化参数、重计算并更新内存空间、核函数调用以及数据类型注册。</p> 
<p><strong>① Init()函数实现</strong></p> 
<p>此函数需要完成对于输入的一些简单校验、依据输入的数据类型选择正确的类模板、最后初始化一些参数并计算与内存相关的一些变量值，代码模板如下：</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/ef/6a/gcs9LZkD_o.png"></p> 
<p><strong>② Resize()函数实现</strong></p> 
<p>此函数用于判断是否为动态shape测试、清空内存、判断输出是否为空并申请新内存，代码模板如下：</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/d1/a7/BXIR1LMR_o.png"></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/a6/83/i3C7zqtS_o.png"></p> 
<p><strong>③ 核函数调用</strong></p> 
<p>此函数获取输入、输出和工作空间的内存地址并传入核函数接口即可，代码模板如下：</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/bf/6c/ojIFmXTB_o.png"></p> 
<p><strong>④ 数据类型注册</strong></p> 
<p>此函数进行数据类型注册，参照代码模板编写即可：</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/b7/b0/XakIP2NM_o.png"></p> 
<p><strong>⑤ GetOpSupport()函数声明</strong></p> 
<p>直接复制库里现有代码即可：</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/d9/55/ILtvoDAq_o.png"></p> 
<p>BartlettWindow 算子 bartlett_window_gpu_kernel.cc 文件 </p> 
<h3>4. 算子cuda核函数开发</h3> 
<h4>（1） mindspore/ccsrc/plugin/device/gpu/kernel/cuda_impl/cuda_ops/xxx_impl.cuh</h4> 
<p>此文件用于函数模板声明，确定好自己需要用到的输入参数后参照库中已有代码进行修改即可：</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/e4/f0/AZ3Jtgkg_o.png"></p> 
<p>B artlettWindow 算子 b artlett_window_impl.cuh 文件 </p> 
<h4>（2） mindspore/ccsrc/plugin/device/gpu/kernel/cuda_impl/cuda_ops/xxx_impl.cu</h4> 
<p>此文件包含三大部分，第一部分是函数模板定义、第二部分为函数模板显示实例化、第三部分为多线程核函数实现。</p> 
<p><strong>① 函数模板定义</strong></p> 
<p>依据xxx_impl.cuh文件中声明的函数写相应的定义即可，形式固定，参照模板写即可：</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/01/4b/zWF9syoN_o.png"></p> 
<p><strong>② 函数模板显示实例化</strong></p> 
<p>依据算子支持的数据类型将函数模板进行实例化，其目的是为了加快实际计算时的运行速率，代码形式固定，参照模板写即可：</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/c9/9e/rlXjMgEs_o.png"></p> 
<p><strong>③ 多线程核函数实现</strong></p> 
<p>这一块才是真正用来实现算子计算逻辑的地方，也是整个GPU异构算子开发中最重要的部分，想要写好这一块的代码，大家首先需要了解自己算子的功能、计算逻辑，同时还需要有一定的Cuda编程基础，这边推荐大家看一下华为官网上推荐的cuda编程教程：cuda 编程（谭升） </p> 
<p>大家主要了解一下host、device、grid、block和thread的概念就可以大致理解cuda是如何进行多线程计算的，之后就可以参照友商或者自己构建多线程计算逻辑，实现算子在GPU上的并行计算。</p> 
<p>以加法算子Add为例，假设有一个输入x和一个输入y，我们需要求z = Add(x, y)，其线性计算和并行计算逻辑如下：</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/2d/49/yRc9Ek0H_o.png"></p> 
<p>BartlettWindow 算子 bartlett_window_impl.cu 文件 </p> 
<h4>（3） mindspore/ccsrc/plugin/device/gpu/kernel/cuda_impl/cuda_class/xxx_helper.h</h4> 
<p>BartlettWindow算子逻辑不复杂，因此没有写helper.h文件，故此处无法给出解析，大家可以参考官方开发文档中关于<a href="https://gitee.com/david-he91/mindspore/wikis/MindSpore%E7%AE%97%E5%AD%90%E4%BC%97%E6%99%BA/GPU%E7%AE%97%E5%AD%90/GPU%E7%AE%97%E5%AD%90%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/04.%20%E7%AE%97%E5%AD%90%E5%BC%80%E5%8F%91%E8%BF%87%E7%A8%8B" rel="nofollow" title="cudaKernel ">cudaKernel </a><a href="https://gitee.com/david-he91/mindspore/wikis/MindSpore%E7%AE%97%E5%AD%90%E4%BC%97%E6%99%BA/GPU%E7%AE%97%E5%AD%90/GPU%E7%AE%97%E5%AD%90%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/04.%20%E7%AE%97%E5%AD%90%E5%BC%80%E5%8F%91%E8%BF%87%E7%A8%8B" rel="nofollow" title="封装 ">封装 </a>的介绍，也可以参考库中其他算子该文件的写法。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/5a/77/Er8DaE3e_o.png"></p> 
<h3>5. 算子Python反向实现文件</h3> 
<h4>（1） mindspore/python/mindspore/ops/_grad_experimental/grad_yyy_ops.py</h4> 
<p>BartlettWindow算子无反向，故无需修改此文件。大家可以参考华为官方文档中关于<a href="https://gitee.com/david-he91/mindspore/wikis/MindSpore%E7%AE%97%E5%AD%90%E4%BC%97%E6%99%BA/GPU%E7%AE%97%E5%AD%90/GPU%E7%AE%97%E5%AD%90%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/05.%20%E6%B3%A8%E5%86%8C%E7%AE%97%E5%AD%90%E5%8F%8D%E5%90%91" rel="nofollow" title="注册 ">注册 </a><a href="https://gitee.com/david-he91/mindspore/wikis/MindSpore%E7%AE%97%E5%AD%90%E4%BC%97%E6%99%BA/GPU%E7%AE%97%E5%AD%90/GPU%E7%AE%97%E5%AD%90%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/05.%20%E6%B3%A8%E5%86%8C%E7%AE%97%E5%AD%90%E5%8F%8D%E5%90%91" rel="nofollow" title="算子反向 ">算子反向 </a>的描述以及正向算子的反向实现 。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/77/1a/AyguzP3l_o.png"></p> 
<p>算子反向实现的模板如下图所示，而实际计算逻辑则需要大家自己进行求导推理或者参照友商反向实现逻辑进行实现：</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/8a/f2/owlWnHSj_o.png"></p> 
<h3>6. 算子ST测试文件</h3> 
<h4>（1） tests/st/ops/gpu/test_xxx_op.py</h4> 
<p>此文件用于门禁ST测试的用例，需要包括GRAPH_MODE和PYNATIVE_MODE两种模式的测试用例，同时需要注意这里的输入必须使用固定值，不可以随机生成，具体写法参照库中已有代码即可。</p> 
<p>BartlettWindow 算子 test_bartlett_window_op.py 文件 </p> 
<h2>四、 如何做doctest</h2> 
<p>用于检查接口注释是否规范</p> 
<h3>1、进入GPU服务器中自己conda环境中的mindspore包：</h3> 
<p>cd /disk1/user14/.conda/envs/xxx/lib/python3.7/site-packages/mindspore</p> 
<h3>2、在当前路径传入conftest.py文件（见附件）</h3> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/a3/a8/tcGzhAwb_o.png"></p> 
<h3>3、修改conftest.py文件中导入的operation类型：</h3> 
<p>我的是array，改成自己对应的</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/54/a0/widnsqEM_o.png"></p> 
<h3>4、进入算子python侧前端接口定义目录：</h3> 
<p>cd /disk1/user14/.conda/envs/xxx/lib/python3.7/site -packages/mindspore/ops/operations</p> 
<h3>5、在当前目录下传入需要doctest的算子接口文件array_ops_xxx.py：</h3> 
<p>前面的array改成自己的算子类型，后面的xxx为算子名称</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/4e/c3/s2psdxud_o.png"></p> 
<h3>6、增添算子接口</h3> 
<p>将自己算子的前端定义复制粘贴到上面创建的array_ops_xx.py文件中，并且要增加支持的平台类型，就是在目前已经支持的平台前加上GPU，不仅要在此mindspore包中修改，自己提交的代码中也需要加上：</p> 
<p>从哪里复制？从原本算子对应的前端接口处复制，就是在此路径下的array_ops.py（array换成自己算子的类型）文件中搜自己的算子前端定义。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/28/d9/2Yblw71Y_o.png"></p> 
<h3>7、在此路径下执行doctest命令（array换成自己的算子类型）：</h3> 
<p>pytest --disable-warnings -vra --doctest-modules -o doctest_optionflags=NORMALIZE_WHITESPACE --tb=long array_ops_xxx.py</p> 
<h3>8、如果通过结果如下图，如果报错根据报错信息修改注释</h3> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/ec/93/UNmrMGxn_o.png"></p> 
<p></p> 
<h2>五、如何做接口网页自验证</h2> 
<p>用于检查网页前端接口是否正确，主要依照官方文档接口注释网页自验部分：<a href="https://gitee.com/david-he91/mindspore/wikis/MindSpore%E7%AE%97%E5%AD%90%E4%BC%97%E6%99%BA/Ascend%E8%AE%A1%E7%AE%97%E7%AE%97%E5%AD%90/Ascend%E8%AE%A1%E7%AE%97%E7%AE%97%E5%AD%90%E6%8E%A5%E5%85%A5%E6%8C%87%E5%8D%97/04.%20%E7%AE%97%E5%AD%90%E5%89%8D%E7%AB%AF%E5%AE%9A%E4%B9%89" rel="nofollow" title="算子前端定义 ">算子前端定义 </a><a href="https://gitee.com/david-he91/mindspore/wikis/MindSpore%E7%AE%97%E5%AD%90%E4%BC%97%E6%99%BA/Ascend%E8%AE%A1%E7%AE%97%E7%AE%97%E5%AD%90/Ascend%E8%AE%A1%E7%AE%97%E7%AE%97%E5%AD%90%E6%8E%A5%E5%85%A5%E6%8C%87%E5%8D%97/04.%20%E7%AE%97%E5%AD%90%E5%89%8D%E7%AB%AF%E5%AE%9A%E4%B9%89" rel="nofollow" title="wiki ">wiki </a></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/96/7a/hH5CeM2s_o.png"></p> 
<p>需要注意四点：</p> 
<p><strong>① clone docs代码时选择老的分支：</strong></p> 
<p>git clone -b r1.6 <a href="https://gitee.com/mindspore/docs.git" rel="nofollow" title="https://gitee.com/mindspore/docs.git ">https://gitee.com/mindspore/docs.git </a></p> 
<p><strong>② 编辑operation.rst</strong></p> 
<p>operation.rst文件可以用电脑的记事本打开，并且注意添加到自己算子所属类型下面</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/91/26/gdvmL56r_o.png"></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/89/7d/GvE6MNoC_o.png"></p> 
<p><strong>③ 报错信息</strong></p> 
<p>生成网页过程中会报一些没有图片的错误，不需要管。生成完毕后需要将/disk1/user14/wzb/docs/docs/mindspore/api/build_zh_cn路径下的整个html文件夹下载下来</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/f2/7d/WZnu2Bh1_o.png"></p> 
<p><strong>④ </strong><strong>网页截图</strong></p> 
<p>html文件夹全部下载之后，打开index.html文件，在其中找自己算子的前端接口网页截图即可。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/89/b4/AxzXOQcB_o.png"></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/9c/1f/lKhOPd7u_o.png"></p> 
<h2>附录1：BartlettWindow算子开发详解</h2> 
<p>本文采取代码+注释方式解析BartlettWindow算子的开发过程。</p> 
<h3>1. 算子Python侧前端定义</h3> 
<h4>（1） mindspore/python/mindspore/ops/operations/other_ops.py</h4> 
<p><strong>① 算子接口注释</strong></p> 
<p><img alt="" height="1154" src="https://images2.imgbox.com/47/e0/Q7VwuNJS_o.png" width="1002"></p> 
<p>写完算子接口注释后可以通过（）接口网页自验证生成如下网页文件：</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/85/d0/UtDHN6gl_o.png"></p> 
<p><strong>② </strong><strong>Init()函数</strong></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/54/1a/g7sCKapk_o.png"></p> 
<p><strong>③ 推理函数</strong></p> 
<p>BartlettWindow算子无Python侧Infer推理函数</p> 
<h3>2. 算子C++侧前端推理</h3> 
<h4>（1） mindspore/core/ops/bartlett_window.h</h4> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/a1/18/s3TW3SPw_o.png"></p> 
<h4>（2） mindspore/core/ops/bartlett_window.cc</h4> 
<p><strong>① BartlettWindowInferType函数</strong></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/b9/12/LVhbUQbd_o.png"></p> 
<p>图例外的其余校验请自行查找相应函数的用法。</p> 
<p><strong>② BartlettWindowInferShape函数</strong></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/d3/7c/y6IUwI8w_o.png"></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/87/ad/4oAlZLoF_o.png"></p> 
<p><strong>③ 属性init()、set()、get()函数</strong></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/1d/25/MBS7cjJ2_o.png"></p> 
<p>mindspore/core/ops/op_name.h</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/dc/f7/GBvdklgs_o.png"></p> 
<p><strong>④ BartlettWindowInfer函数</strong></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/49/11/d4hngqcv_o.png"></p> 
<p><strong>⑤ 宏定义</strong></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/18/a6/WvUgFbEf_o.png"></p> 
<h4>（3） mindspore/core/ops/core_ops.h</h4> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/70/db/7DYVlPXl_o.png"></p> 
<h4>（4） mindspore/core/abstract/ops/primitive_infer_map.cc</h4> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/ce/96/L3HlTsgj_o.png"></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/02/e3/sYYzcI70_o.png"></p> 
<h3>3. 算子C++侧后端适配</h3> 
<h4>（1） mindspore/ccsrc/plugin/device/gpu/kernel/other/bartlett_window _gpu_kernel.h</h4> 
<p><strong>① Init()函数声明</strong></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/b7/6a/GHHu8zv4_o.png"></p> 
<p><strong>② Resize()函数声明</strong></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/d0/51/ESRhvtPy_o.png"></p> 
<p><strong>③ GetOpSupport()函数声明</strong></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/07/36/vWXLVrx4_o.png"></p> 
<p><strong>④ Launch()函数声明</strong></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/8a/1d/wYaQUYBM_o.png"></p> 
<p><strong>⑤ RestResource()函数实现</strong></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/71/b7/0aBBMEZL_o.png"></p> 
<p><strong>⑥ 类私有变量声明</strong></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/4f/18/oaPrFzpB_o.png"></p> 
<h4>（2） mindspore/ccsrc/plugin/device/gpu/kernel/other/bartlett_window _gpu_kernel.cc</h4> 
<p><strong>① Init()函数实现</strong></p> 
<p><img alt="" height="709" src="https://images2.imgbox.com/0e/60/nCYpACfN_o.png" width="932"></p> 
<p><strong>② Resize()函数实现</strong></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/cd/5c/pJ7aq4JF_o.png"></p> 
<p><strong>③ 核函数调用</strong></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/1a/65/RGIxDWKm_o.png"></p> 
<p><strong>④ </strong><strong>数据类型注册</strong></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/bd/59/tQUUebg3_o.png"></p> 
<p>⑤ GetOpSupport()函数声明</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/8f/47/RPz589Ex_o.png"></p> 
<h3>4. 算子cuda核函数开发</h3> 
<h4>（1） mindspore/ccsrc/plugin/device/gpu/kernel/cuda_impl/cuda_ops/bartlett_window _impl.cuh</h4> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/2b/13/sRQkkRzp_o.png"></p> 
<h4>（2） mindspore/ccsrc/plugin/device/gpu/kernel/cuda_impl/cuda_ops/bartlett_window _impl.cu</h4> 
<p><strong>① 函数模板定义</strong></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/62/f2/VL09bueW_o.png"></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/8a/1a/TW2wZpMY_o.png"></p> 
<p><strong>② 函数模板显示实例化</strong></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/b3/e1/WG54itn1_o.png"></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/fd/2f/Oh8nxLNl_o.png"></p> 
<p><strong>③ 多线程核函数实现</strong></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/57/2f/TesyU5Sx_o.png"></p> 
<h4>（3） mindspore/ccsrc/plugin/device/gpu/kernel/cuda_impl/cuda_class/bartlett_window _helper.h</h4> 
<p>BartlettWindow算子无需编写helper.h文件</p> 
<h3>5. 算子Python反向实现文件</h3> 
<h4>（1） mindspore/python/mindspore/ops/_grad_experimental/grad_other_ops.py</h4> 
<p>BartlettWindow算子无反向</p> 
<h3>6. 算子ST测试文件</h3> 
<h4>（1） tests/st/ops/gpu/test_ bartlett_window _op.py</h4> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/f7/dc/462JGVvu_o.png"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3adb7bcb3deb724c8d13f0ad22992cc8/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Flutter个推推送Android端,退出应用后收到消息报错</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/88c5352c6e8650dd647cfb29b5db829a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">ceres错误 (Jets)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>