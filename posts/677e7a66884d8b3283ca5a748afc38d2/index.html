<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【FFMPEG源码分析】通过ffmpeg截图命令分析ffmpeg.c源码流程 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【FFMPEG源码分析】通过ffmpeg截图命令分析ffmpeg.c源码流程" />
<meta property="og:description" content="环境搭建 Ubuntu 20.04开启外设摄像头截图命令:
ffmpeg -f video4linux2 -s 640x480 -i /dev/video0 -ss 0:0:2 -frames 1 /data/ffmpeg-4.2.7/exe_cmd/tmp/out2.jpg 参数解析 int main(int argc, char **argv) { .................................; #if CONFIG_AVDEVICE avdevice_register_all(); #endif avformat_network_init(); show_banner(argc, argv, options); //1. 重点看下参数解析 ffmpeg_parse_options(argc, argv); //2. 这里面进行具体的数据处理 if (transcode() &lt; 0) exit_program(1); } .................................; } int ffmpeg_parse_options(int argc, char **argv) { OptionParseContext octx; uint8_t error[128]; int ret; memset(&amp;octx, 0, sizeof(octx)); /* split the commandline into an internal representation */ split_commandline(&amp;octx, argc, argv, options, groups, FF_ARRAY_ELEMS(groups)); /* apply global options */ parse_optgroup(NULL, &amp;octx." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/677e7a66884d8b3283ca5a748afc38d2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-01T10:31:18+08:00" />
<meta property="article:modified_time" content="2023-03-01T10:31:18+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【FFMPEG源码分析】通过ffmpeg截图命令分析ffmpeg.c源码流程</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>环境搭建</h3> 
<ol><li>Ubuntu 20.04</li><li>开启外设摄像头</li><li>截图命令:<br> ffmpeg -f video4linux2 -s 640x480 -i /dev/video0 -ss 0:0:2 -frames 1 /data/ffmpeg-4.2.7/exe_cmd/tmp/out2.jpg</li></ol> 
<h3><a id="_6"></a>参数解析</h3> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">CONFIG_AVDEVICE</span></span>
    <span class="token function">avdevice_register_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token function">avformat_network_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">show_banner</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//1. 重点看下参数解析</span>
    <span class="token function">ffmpeg_parse_options</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//2. 这里面进行具体的数据处理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">transcode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">exit_program</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">ffmpeg_parse_options</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    OptionParseContext octx<span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> error<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>octx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>octx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* split the commandline into an internal representation */</span>
    <span class="token function">split_commandline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>octx<span class="token punctuation">,</span> argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> options<span class="token punctuation">,</span> groups<span class="token punctuation">,</span>
                            <span class="token function">FF_ARRAY_ELEMS</span><span class="token punctuation">(</span>groups<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* apply global options */</span>
    <span class="token function">parse_optgroup</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>octx<span class="token punctuation">.</span>global_opts<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* configure terminal and setup signal handlers */</span>
    <span class="token function">term_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* open input files */</span>
    <span class="token function">open_files</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>octx<span class="token punctuation">.</span>groups<span class="token punctuation">[</span>GROUP_INFILE<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"input"</span><span class="token punctuation">,</span> open_input_file<span class="token punctuation">)</span><span class="token punctuation">;</span>
   
    <span class="token function">init_complex_filters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* open output files */</span>
    <span class="token function">open_files</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>octx<span class="token punctuation">.</span>groups<span class="token punctuation">[</span>GROUP_OUTFILE<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"output"</span><span class="token punctuation">,</span> open_output_file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
    <span class="token function">check_filter_outputs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="split_commandline_56"></a>split_commandline</h4> 
<pre><code class="prism language-c"><span class="token comment">//全局变量 设置给split_commandline</span>
<span class="token keyword">const</span> OptionDef options<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* main options */</span>
    CMDUTILS_COMMON_OPTIONS
    <span class="token punctuation">{<!-- --></span> <span class="token string">"f"</span><span class="token punctuation">,</span>              HAS_ARG <span class="token operator">|</span> OPT_STRING <span class="token operator">|</span> OPT_OFFSET <span class="token operator">|</span>
                        OPT_INPUT <span class="token operator">|</span> OPT_OUTPUT<span class="token punctuation">,</span>                      <span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>off       <span class="token operator">=</span> <span class="token function">OFFSET</span><span class="token punctuation">(</span>format<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"force format"</span><span class="token punctuation">,</span> <span class="token string">"fmt"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span> <span class="token string">"y"</span><span class="token punctuation">,</span>              OPT_BOOL<span class="token punctuation">,</span>                                    <span class="token punctuation">{<!-- --></span>              <span class="token operator">&amp;</span>file_overwrite <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"overwrite output files"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">enum</span> <span class="token class-name">OptGroup</span> <span class="token punctuation">{<!-- --></span>
    GROUP_OUTFILE<span class="token punctuation">,</span>
    GROUP_INFILE<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//全局变量 设置给split_commandline</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> OptionGroupDef groups<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">[</span>GROUP_OUTFILE<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"output url"</span><span class="token punctuation">,</span>  <span class="token constant">NULL</span><span class="token punctuation">,</span> OPT_OUTPUT <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>GROUP_INFILE<span class="token punctuation">]</span>  <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"input url"</span><span class="token punctuation">,</span>   <span class="token string">"i"</span><span class="token punctuation">,</span>  OPT_INPUT <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token keyword">int</span> <span class="token function">split_commandline</span><span class="token punctuation">(</span>OptionParseContext <span class="token operator">*</span>octx<span class="token punctuation">,</span> <span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                      <span class="token keyword">const</span> OptionDef <span class="token operator">*</span>options<span class="token punctuation">,</span>
                      <span class="token keyword">const</span> OptionGroupDef <span class="token operator">*</span>groups<span class="token punctuation">,</span> <span class="token keyword">int</span> nb_groups<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> optindex <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> dashdash <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>

    <span class="token comment">//针对windows上输入参数字符集的转换如:utf-8等，不必深入。</span>
    <span class="token function">prepare_app_arguments</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>argc<span class="token punctuation">,</span> <span class="token operator">&amp;</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">init_parse_context</span><span class="token punctuation">(</span>octx<span class="token punctuation">,</span> groups<span class="token punctuation">,</span> nb_groups<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_DEBUG<span class="token punctuation">,</span> <span class="token string">"Splitting the commandline.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>optindex <span class="token operator">&lt;</span> argc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>opt <span class="token operator">=</span> argv<span class="token punctuation">[</span>optindex<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">*</span>arg<span class="token punctuation">;</span>
        <span class="token keyword">const</span> OptionDef <span class="token operator">*</span>po<span class="token punctuation">;</span>
        <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>opt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'-'</span> <span class="token operator">&amp;&amp;</span> opt<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'-'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>opt<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            dashdash <span class="token operator">=</span> optindex<span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// -i之后的作为output的一个group，即全局变量groups中的GROUP_OUTFILE</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>opt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token char">'-'</span> <span class="token operator">||</span> <span class="token operator">!</span>opt<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">||</span> dashdash<span class="token operator">+</span><span class="token number">1</span> <span class="token operator">==</span> optindex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">finish_group</span><span class="token punctuation">(</span>octx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> opt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_DEBUG<span class="token punctuation">,</span> <span class="token string">" matched as %s.\n"</span><span class="token punctuation">,</span> groups<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        opt<span class="token operator">++</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">GET_ARG</span><span class="token expression"><span class="token punctuation">(</span>arg<span class="token punctuation">)</span>                                                           </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>                                                                           </span><span class="token punctuation">\</span>
    <span class="token expression">arg <span class="token operator">=</span> argv<span class="token punctuation">[</span>optindex<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                                                    </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>                                                                </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_ERROR<span class="token punctuation">,</span> </span><span class="token string">"Missing argument for option '%s'.\n"</span><span class="token expression"><span class="token punctuation">,</span> opt<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token keyword">return</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>EINVAL<span class="token punctuation">)</span><span class="token punctuation">;</span>                                                </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">}</span>                                                                          </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span>
       <span class="token comment">//-i 以及-i 之前的参数全部存入全局变量groups中的GROUP_INFILE</span>
        <span class="token comment">/* named group separators, e.g. -i */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">match_group_separator</span><span class="token punctuation">(</span>groups<span class="token punctuation">,</span> nb_groups<span class="token punctuation">,</span> opt<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">GET_ARG</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">finish_group</span><span class="token punctuation">(</span>octx<span class="token punctuation">,</span> ret<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_DEBUG<span class="token punctuation">,</span> <span class="token string">" matched as %s with argument '%s'.\n"</span><span class="token punctuation">,</span>
                   groups<span class="token punctuation">[</span>ret<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* normal options */</span>
        po <span class="token operator">=</span> <span class="token function">find_option</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> opt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>po<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>po<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> OPT_EXIT<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">/* optional argument, e.g. -h */</span>
                arg <span class="token operator">=</span> argv<span class="token punctuation">[</span>optindex<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>po<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> HAS_ARG<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">GET_ARG</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                arg <span class="token operator">=</span> <span class="token string">"1"</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token function">add_opt</span><span class="token punctuation">(</span>octx<span class="token punctuation">,</span> po<span class="token punctuation">,</span> opt<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_DEBUG<span class="token punctuation">,</span> <span class="token string">" matched as option '%s' (%s) with "</span>
                   <span class="token string">"argument '%s'.\n"</span><span class="token punctuation">,</span> po<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> po<span class="token operator">-&gt;</span>help<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* AVOptions */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>argv<span class="token punctuation">[</span>optindex<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ret <span class="token operator">=</span> <span class="token function">opt_default</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> opt<span class="token punctuation">,</span> argv<span class="token punctuation">[</span>optindex<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_DEBUG<span class="token punctuation">,</span> <span class="token string">" matched as AVOption '%s' with "</span>
                       <span class="token string">"argument '%s'.\n"</span><span class="token punctuation">,</span> opt<span class="token punctuation">,</span> argv<span class="token punctuation">[</span>optindex<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                optindex<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> AVERROR_OPTION_NOT_FOUND<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_ERROR<span class="token punctuation">,</span> <span class="token string">"Error parsing option '%s' "</span>
                       <span class="token string">"with argument '%s'.\n"</span><span class="token punctuation">,</span> opt<span class="token punctuation">,</span> argv<span class="token punctuation">[</span>optindex<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* boolean -nofoo options */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>opt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'n'</span> <span class="token operator">&amp;&amp;</span> opt<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'o'</span> <span class="token operator">&amp;&amp;</span>
            <span class="token punctuation">(</span>po <span class="token operator">=</span> <span class="token function">find_option</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> opt <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            po<span class="token operator">-&gt;</span>name <span class="token operator">&amp;&amp;</span> po<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> OPT_BOOL<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">add_opt</span><span class="token punctuation">(</span>octx<span class="token punctuation">,</span> po<span class="token punctuation">,</span> opt<span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_DEBUG<span class="token punctuation">,</span> <span class="token string">" matched as option '%s' (%s) with "</span>
                   <span class="token string">"argument 0.\n"</span><span class="token punctuation">,</span> po<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> po<span class="token operator">-&gt;</span>help<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_ERROR<span class="token punctuation">,</span> <span class="token string">"Unrecognized option '%s'.\n"</span><span class="token punctuation">,</span> opt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> AVERROR_OPTION_NOT_FOUND<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>octx<span class="token operator">-&gt;</span>cur_group<span class="token punctuation">.</span>nb_opts <span class="token operator">||</span> codec_opts <span class="token operator">||</span> format_opts <span class="token operator">||</span> resample_opts<span class="token punctuation">)</span>
        <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_WARNING<span class="token punctuation">,</span> <span class="token string">"Trailing options were found on the "</span>
               <span class="token string">"commandline.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_DEBUG<span class="token punctuation">,</span> <span class="token string">"Finished splitting the commandline.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上述代码主要是将ffmpeg命令行参数解析到OptionParseContext中。OptionParseContext的成员变量OptionGroupList *groups由两个，一个为input OptionGroupList另一个为output OptionGroupList。一个OptionGroupList中由多个OptionGroup组成，而一个OptionGroup由多个Option组成。具体关系如下图:<br> <img src="https://images2.imgbox.com/70/b9/lMvpWkBK_o.png" alt="option_args"><br> OptionGroupList输入/输出参数以及option的遍历代码如下:</p> 
<pre><code class="prism language-c">OptionParseContext octx<span class="token punctuation">;</span>
 <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> octx<span class="token punctuation">.</span>nb_groups<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    OptionGroupList <span class="token operator">*</span>ll <span class="token operator">=</span> <span class="token operator">&amp;</span>octx<span class="token punctuation">.</span>groups<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>AV_LOG_ERROR<span class="token punctuation">,</span> <span class="token string">"OptionGroupList[%d] def:%s\n"</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span> ll<span class="token operator">-&gt;</span>group_def<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> ll<span class="token operator">-&gt;</span>nb_groups<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        OptionGroup <span class="token operator">*</span>g <span class="token operator">=</span> <span class="token operator">&amp;</span>ll<span class="token operator">-&gt;</span>groups<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>AV_LOG_ERROR<span class="token punctuation">,</span><span class="token string">"g[%d][%d],arg:%s, def: %s \n"</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span> g<span class="token operator">-&gt;</span>arg<span class="token punctuation">,</span> g<span class="token operator">-&gt;</span>group_def<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> g<span class="token operator">-&gt;</span>nb_opts<span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Option <span class="token operator">*</span>opt <span class="token operator">=</span> <span class="token operator">&amp;</span>g<span class="token operator">-&gt;</span>opts<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>AV_LOG_ERROR<span class="token punctuation">,</span><span class="token string">"g[%d][%d], opts[%d],key:%s, value:%s, def: %s \n"</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>x<span class="token punctuation">,</span> opt<span class="token operator">-&gt;</span>key<span class="token punctuation">,</span> opt<span class="token operator">-&gt;</span>val<span class="token punctuation">,</span> opt<span class="token operator">-&gt;</span>opt<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
</code></pre> 
<p>如命令行: <strong>ffmpeg -f video4linux2 -s 640x480 -i /dev/video0 -ss 0:0:2 -frames 1 /data/ffmpeg-4.2.7/exe_cmd/tmp/out2.jpg</strong> 解析后遍历结果如下:</p> 
<blockquote> 
 <p>OptionGroupList[0] def:output url<br> g[0][0],arg:/data/ffmpeg-4.2.7/exe_cmd/tmp/out2.jpg, def: output url<br> g[0][0], opts[0],key:ss, value:0:0:2, def: ss<br> g[0][0], opts[1],key:frames, value:1, def: frames<br> OptionGroupList[1] def:input url<br> g[1][0],arg:/dev/video0, def: input url<br> g[1][0], opts[0],key:f, value:video4linux2, def: f<br> g[1][0], opts[1],key:s, value:640x480, def: s</p> 
</blockquote> 
<h4><a id="parse_optgroup_217"></a>parse_optgroup</h4> 
<p>这个函数的作中是存储全局的option，如: -v debug 对所有模块都适用</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">parse_optgroup</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>optctx<span class="token punctuation">,</span> OptionGroup <span class="token operator">*</span>g<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> i<span class="token punctuation">,</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> g<span class="token operator">-&gt;</span>nb_opts<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Option <span class="token operator">*</span>o <span class="token operator">=</span> <span class="token operator">&amp;</span>g<span class="token operator">-&gt;</span>opts<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">write_option</span><span class="token punctuation">(</span>optctx<span class="token punctuation">,</span> o<span class="token operator">-&gt;</span>opt<span class="token punctuation">,</span> o<span class="token operator">-&gt;</span>key<span class="token punctuation">,</span> o<span class="token operator">-&gt;</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="open_files_232"></a>open_files</h3> 
<p>参数解析完成之后，就是通过input url和output url找到对应的AVInputFormat和AVOutputFormat。</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">ffmpeg_parse_options</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
    <span class="token comment">//将input arg group传入进去</span>
    <span class="token function">open_files</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>octx<span class="token punctuation">.</span>groups<span class="token punctuation">[</span>GROUP_INFILE<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"input"</span><span class="token punctuation">,</span> open_input_file<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">open_files</span><span class="token punctuation">(</span>OptionGroupList <span class="token operator">*</span>l<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>inout<span class="token punctuation">,</span>
                      <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>open_file<span class="token punctuation">)</span><span class="token punctuation">(</span>OptionsContext<span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> i<span class="token punctuation">,</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token operator">-&gt;</span>nb_groups<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        OptionGroup <span class="token operator">*</span>g <span class="token operator">=</span> <span class="token operator">&amp;</span>l<span class="token operator">-&gt;</span>groups<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        OptionsContext o<span class="token punctuation">;</span>
        <span class="token function">init_options</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
        o<span class="token punctuation">.</span>g <span class="token operator">=</span> g<span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">parse_optgroup</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>o<span class="token punctuation">,</span> g<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_DEBUG<span class="token punctuation">,</span> <span class="token string">"Opening an %s file: %s.\n"</span><span class="token punctuation">,</span> inout<span class="token punctuation">,</span> g<span class="token operator">-&gt;</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//将input arg option group赋值到OptionsContext后调用open_input_file</span>
        ret <span class="token operator">=</span> <span class="token function">open_file</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>o<span class="token punctuation">,</span> g<span class="token operator">-&gt;</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">uninit_options</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="open_input_file_261"></a>open_input_file</h4> 
<pre><code class="prism language-c">
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">open_input_file</span><span class="token punctuation">(</span>OptionsContext <span class="token operator">*</span>o<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    InputFile <span class="token operator">*</span>f<span class="token punctuation">;</span>
    AVFormatContext <span class="token operator">*</span>ic<span class="token punctuation">;</span>
    AVInputFormat <span class="token operator">*</span>file_iformat <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> err<span class="token punctuation">,</span> i<span class="token punctuation">,</span> ret<span class="token punctuation">;</span>
    <span class="token class-name">int64_t</span> timestamp<span class="token punctuation">;</span>
    AVDictionary <span class="token operator">*</span>unused_opts <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    AVDictionaryEntry <span class="token operator">*</span>e <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>   video_codec_name <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>   audio_codec_name <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>subtitle_codec_name <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>    data_codec_name <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> scan_all_pmts_set <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token operator">-&gt;</span>format<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//在本例中通过video4linux2 找到ff_v4l2_demuxer</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>file_iformat <span class="token operator">=</span> <span class="token function">av_find_input_format</span><span class="token punctuation">(</span>o<span class="token operator">-&gt;</span>format<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_FATAL<span class="token punctuation">,</span> <span class="token string">"Unknown input format: '%s'\n"</span><span class="token punctuation">,</span> o<span class="token operator">-&gt;</span>format<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit_program</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
    <span class="token comment">//分配AVFormatContext</span>
    ic <span class="token operator">=</span> <span class="token function">avformat_alloc_context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
    <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_ERROR<span class="token punctuation">,</span> <span class="token string">"[yxy]use AVInputFormat:%s for file:%s \n"</span><span class="token punctuation">,</span> file_iformat<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    err <span class="token operator">=</span> <span class="token function">avformat_open_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ic<span class="token punctuation">,</span> filename<span class="token punctuation">,</span> file_iformat<span class="token punctuation">,</span> <span class="token operator">&amp;</span>o<span class="token operator">-&gt;</span>g<span class="token operator">-&gt;</span>format_opts<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* apply forced codec ids */</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ic<span class="token operator">-&gt;</span>nb_streams<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token function">choose_decoder</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> ic<span class="token punctuation">,</span> ic<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>find_stream_info<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        AVDictionary <span class="token operator">*</span><span class="token operator">*</span>opts <span class="token operator">=</span> <span class="token function">setup_find_stream_info_opts</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> o<span class="token operator">-&gt;</span>g<span class="token operator">-&gt;</span>codec_opts<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> orig_nb_streams <span class="token operator">=</span> ic<span class="token operator">-&gt;</span>nb_streams<span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">avformat_find_stream_info</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
    <span class="token comment">/* update the current parameters so that they match the one of the input stream */</span>
    <span class="token function">add_input_streams</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> ic<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* dump the file content */</span>
    <span class="token function">av_dump_format</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> nb_input_files<span class="token punctuation">,</span> filename<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">GROW_ARRAY</span><span class="token punctuation">(</span>input_files<span class="token punctuation">,</span> nb_input_files<span class="token punctuation">)</span><span class="token punctuation">;</span>
    f <span class="token operator">=</span> <span class="token function">av_mallocz</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//存入全局变量input_files</span>
    input_files<span class="token punctuation">[</span>nb_input_files <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> f<span class="token punctuation">;</span>
    f<span class="token operator">-&gt;</span>ctx        <span class="token operator">=</span> ic<span class="token punctuation">;</span>
    f<span class="token operator">-&gt;</span>ist_index  <span class="token operator">=</span> nb_input_streams <span class="token operator">-</span> ic<span class="token operator">-&gt;</span>nb_streams<span class="token punctuation">;</span>
    f<span class="token operator">-&gt;</span>start_time <span class="token operator">=</span> o<span class="token operator">-&gt;</span>start_time<span class="token punctuation">;</span>
    f<span class="token operator">-&gt;</span>recording_time <span class="token operator">=</span> o<span class="token operator">-&gt;</span>recording_time<span class="token punctuation">;</span>
    f<span class="token operator">-&gt;</span>input_ts_offset <span class="token operator">=</span> o<span class="token operator">-&gt;</span>input_ts_offset<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上面open_input的代码主要作用是通过input args options new一个AVFormatContext以及AVFormatContext.AVInputFormat 即ff_v4l2_demuxer， 并将AVFormatContext存入全局变量InputFile *input_files中。另外new出来了InputStream存放在全局变量InputStream **input_streams中。</p> 
<h4><a id="open_output_file_323"></a>open_output_file</h4> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">open_output_file</span><span class="token punctuation">(</span>OptionsContext <span class="token operator">*</span>o<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    AVFormatContext <span class="token operator">*</span>oc<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> err<span class="token punctuation">;</span>
    OutputFile <span class="token operator">*</span>of<span class="token punctuation">;</span>
    OutputStream <span class="token operator">*</span>ost<span class="token punctuation">;</span>
    InputStream  <span class="token operator">*</span>ist<span class="token punctuation">;</span>
    AVDictionary <span class="token operator">*</span>unused_opts <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    AVDictionaryEntry <span class="token operator">*</span>e <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> format_flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
    <span class="token function">GROW_ARRAY</span><span class="token punctuation">(</span>output_files<span class="token punctuation">,</span> nb_output_files<span class="token punctuation">)</span><span class="token punctuation">;</span>
    of <span class="token operator">=</span> <span class="token function">av_mallocz</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>of<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    output_files<span class="token punctuation">[</span>nb_output_files <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> of<span class="token punctuation">;</span>
    of<span class="token operator">-&gt;</span>ost_index      <span class="token operator">=</span> nb_output_streams<span class="token punctuation">;</span>
    of<span class="token operator">-&gt;</span>recording_time <span class="token operator">=</span> o<span class="token operator">-&gt;</span>recording_time<span class="token punctuation">;</span>
    of<span class="token operator">-&gt;</span>start_time     <span class="token operator">=</span> o<span class="token operator">-&gt;</span>start_time<span class="token punctuation">;</span>
    of<span class="token operator">-&gt;</span>limit_filesize <span class="token operator">=</span> o<span class="token operator">-&gt;</span>limit_filesize<span class="token punctuation">;</span>
    of<span class="token operator">-&gt;</span>shortest       <span class="token operator">=</span> o<span class="token operator">-&gt;</span>shortest<span class="token punctuation">;</span>
    <span class="token function">av_dict_copy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>of<span class="token operator">-&gt;</span>opts<span class="token punctuation">,</span> o<span class="token operator">-&gt;</span>g<span class="token operator">-&gt;</span>format_opts<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_ERROR<span class="token punctuation">,</span> <span class="token string">"[yxy]call avformat_alloc_output_context2 for file:%s \n"</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    err <span class="token operator">=</span> <span class="token function">avformat_alloc_output_context2</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>oc<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> o<span class="token operator">-&gt;</span>format<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
   
    of<span class="token operator">-&gt;</span>ctx <span class="token operator">=</span> oc<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token operator">-&gt;</span>recording_time <span class="token operator">!=</span> INT64_MAX<span class="token punctuation">)</span>
        oc<span class="token operator">-&gt;</span>duration <span class="token operator">=</span> o<span class="token operator">-&gt;</span>recording_time<span class="token punctuation">;</span>

    oc<span class="token operator">-&gt;</span>interrupt_callback <span class="token operator">=</span> int_cb<span class="token punctuation">;</span>

    e <span class="token operator">=</span> <span class="token function">av_dict_get</span><span class="token punctuation">(</span>o<span class="token operator">-&gt;</span>g<span class="token operator">-&gt;</span>format_opts<span class="token punctuation">,</span> <span class="token string">"fflags"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">const</span> AVOption <span class="token operator">*</span>o <span class="token operator">=</span> <span class="token function">av_opt_find</span><span class="token punctuation">(</span>oc<span class="token punctuation">,</span> <span class="token string">"fflags"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">av_opt_eval_flags</span><span class="token punctuation">(</span>oc<span class="token punctuation">,</span> o<span class="token punctuation">,</span> e<span class="token operator">-&gt;</span>value<span class="token punctuation">,</span> <span class="token operator">&amp;</span>format_flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token operator">-&gt;</span>bitexact<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        format_flags <span class="token operator">|=</span> AVFMT_FLAG_BITEXACT<span class="token punctuation">;</span>
        oc<span class="token operator">-&gt;</span>flags    <span class="token operator">|=</span> AVFMT_FLAG_BITEXACT<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* create streams for all unlabeled output pads */</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nb_filtergraphs<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        FilterGraph <span class="token operator">*</span>fg <span class="token operator">=</span> filtergraphs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> fg<span class="token operator">-&gt;</span>nb_outputs<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            OutputFilter <span class="token operator">*</span>ofilter <span class="token operator">=</span> fg<span class="token operator">-&gt;</span>outputs<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ofilter<span class="token operator">-&gt;</span>out_tmp <span class="token operator">||</span> ofilter<span class="token operator">-&gt;</span>out_tmp<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>

            <span class="token keyword">switch</span> <span class="token punctuation">(</span>ofilter<span class="token operator">-&gt;</span>type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> AVMEDIA_TYPE_VIDEO<span class="token operator">:</span>    o<span class="token operator">-&gt;</span>video_disable    <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> AVMEDIA_TYPE_AUDIO<span class="token operator">:</span>    o<span class="token operator">-&gt;</span>audio_disable    <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> AVMEDIA_TYPE_SUBTITLE<span class="token operator">:</span> o<span class="token operator">-&gt;</span>subtitle_disable <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">init_output_filter</span><span class="token punctuation">(</span>ofilter<span class="token punctuation">,</span> o<span class="token punctuation">,</span> oc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>o<span class="token operator">-&gt;</span>nb_stream_maps<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">char</span> <span class="token operator">*</span>subtitle_codec_name <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token comment">/* pick the "best" stream of each type */</span>

        <span class="token comment">/* video: highest resolution */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>o<span class="token operator">-&gt;</span>video_disable <span class="token operator">&amp;&amp;</span> <span class="token function">av_guess_codec</span><span class="token punctuation">(</span>oc<span class="token operator">-&gt;</span>oformat<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> filename<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> AVMEDIA_TYPE_VIDEO<span class="token punctuation">)</span> <span class="token operator">!=</span> AV_CODEC_ID_NONE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> area <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> idx <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> qcr <span class="token operator">=</span> <span class="token function">avformat_query_codec</span><span class="token punctuation">(</span>oc<span class="token operator">-&gt;</span>oformat<span class="token punctuation">,</span> oc<span class="token operator">-&gt;</span>oformat<span class="token operator">-&gt;</span>video_codec<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nb_input_streams<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">int</span> new_area<span class="token punctuation">;</span>
                ist <span class="token operator">=</span> input_streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                new_area <span class="token operator">=</span> ist<span class="token operator">-&gt;</span>st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>width <span class="token operator">*</span> ist<span class="token operator">-&gt;</span>st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>height <span class="token operator">+</span> <span class="token number">100000000</span><span class="token operator">*</span><span class="token operator">!</span><span class="token operator">!</span>ist<span class="token operator">-&gt;</span>st<span class="token operator">-&gt;</span>codec_info_nb_frames
                           <span class="token operator">+</span> <span class="token number">5000000</span><span class="token operator">*</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>ist<span class="token operator">-&gt;</span>st<span class="token operator">-&gt;</span>disposition <span class="token operator">&amp;</span> AV_DISPOSITION_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ist<span class="token operator">-&gt;</span>user_set_discard <span class="token operator">==</span> AVDISCARD_ALL<span class="token punctuation">)</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>qcr<span class="token operator">!=</span><span class="token function">MKTAG</span><span class="token punctuation">(</span><span class="token char">'A'</span><span class="token punctuation">,</span> <span class="token char">'P'</span><span class="token punctuation">,</span> <span class="token char">'I'</span><span class="token punctuation">,</span> <span class="token char">'C'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ist<span class="token operator">-&gt;</span>st<span class="token operator">-&gt;</span>disposition <span class="token operator">&amp;</span> AV_DISPOSITION_ATTACHED_PIC<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    new_area <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ist<span class="token operator">-&gt;</span>st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_type <span class="token operator">==</span> AVMEDIA_TYPE_VIDEO <span class="token operator">&amp;&amp;</span>
                    new_area <span class="token operator">&gt;</span> area<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>qcr<span class="token operator">==</span><span class="token function">MKTAG</span><span class="token punctuation">(</span><span class="token char">'A'</span><span class="token punctuation">,</span> <span class="token char">'P'</span><span class="token punctuation">,</span> <span class="token char">'I'</span><span class="token punctuation">,</span> <span class="token char">'C'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>ist<span class="token operator">-&gt;</span>st<span class="token operator">-&gt;</span>disposition <span class="token operator">&amp;</span> AV_DISPOSITION_ATTACHED_PIC<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    area <span class="token operator">=</span> new_area<span class="token punctuation">;</span>
                    idx <span class="token operator">=</span> i<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token function">new_video_stream</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> oc<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* audio: most channels */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>o<span class="token operator">-&gt;</span>audio_disable <span class="token operator">&amp;&amp;</span> <span class="token function">av_guess_codec</span><span class="token punctuation">(</span>oc<span class="token operator">-&gt;</span>oformat<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> filename<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> AVMEDIA_TYPE_AUDIO<span class="token punctuation">)</span> <span class="token operator">!=</span> AV_CODEC_ID_NONE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> best_score <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> idx <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nb_input_streams<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">int</span> score<span class="token punctuation">;</span>
                ist <span class="token operator">=</span> input_streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                score <span class="token operator">=</span> ist<span class="token operator">-&gt;</span>st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>channels <span class="token operator">+</span> <span class="token number">100000000</span><span class="token operator">*</span><span class="token operator">!</span><span class="token operator">!</span>ist<span class="token operator">-&gt;</span>st<span class="token operator">-&gt;</span>codec_info_nb_frames
                        <span class="token operator">+</span> <span class="token number">5000000</span><span class="token operator">*</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>ist<span class="token operator">-&gt;</span>st<span class="token operator">-&gt;</span>disposition <span class="token operator">&amp;</span> AV_DISPOSITION_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ist<span class="token operator">-&gt;</span>user_set_discard <span class="token operator">==</span> AVDISCARD_ALL<span class="token punctuation">)</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ist<span class="token operator">-&gt;</span>st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_type <span class="token operator">==</span> AVMEDIA_TYPE_AUDIO <span class="token operator">&amp;&amp;</span>
                    score <span class="token operator">&gt;</span> best_score<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    best_score <span class="token operator">=</span> score<span class="token punctuation">;</span>
                    idx <span class="token operator">=</span> i<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token function">new_audio_stream</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> oc<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* subtitles: pick first */</span>
        <span class="token function">MATCH_PER_TYPE_OPT</span><span class="token punctuation">(</span>codec_names<span class="token punctuation">,</span> str<span class="token punctuation">,</span> subtitle_codec_name<span class="token punctuation">,</span> oc<span class="token punctuation">,</span> <span class="token string">"s"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>o<span class="token operator">-&gt;</span>subtitle_disable <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">avcodec_find_encoder</span><span class="token punctuation">(</span>oc<span class="token operator">-&gt;</span>oformat<span class="token operator">-&gt;</span>subtitle_codec<span class="token punctuation">)</span> <span class="token operator">||</span> subtitle_codec_name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nb_input_streams<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>input_streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_type <span class="token operator">==</span> AVMEDIA_TYPE_SUBTITLE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    AVCodecDescriptor <span class="token keyword">const</span> <span class="token operator">*</span>input_descriptor <span class="token operator">=</span>
                        <span class="token function">avcodec_descriptor_get</span><span class="token punctuation">(</span>input_streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    AVCodecDescriptor <span class="token keyword">const</span> <span class="token operator">*</span>output_descriptor <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                    AVCodec <span class="token keyword">const</span> <span class="token operator">*</span>output_codec <span class="token operator">=</span>
                        <span class="token function">avcodec_find_encoder</span><span class="token punctuation">(</span>oc<span class="token operator">-&gt;</span>oformat<span class="token operator">-&gt;</span>subtitle_codec<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">int</span> input_props <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> output_props <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>input_streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>user_set_discard <span class="token operator">==</span> AVDISCARD_ALL<span class="token punctuation">)</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>output_codec<span class="token punctuation">)</span>
                        output_descriptor <span class="token operator">=</span> <span class="token function">avcodec_descriptor_get</span><span class="token punctuation">(</span>output_codec<span class="token operator">-&gt;</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>input_descriptor<span class="token punctuation">)</span>
                        input_props <span class="token operator">=</span> input_descriptor<span class="token operator">-&gt;</span>props <span class="token operator">&amp;</span> <span class="token punctuation">(</span>AV_CODEC_PROP_TEXT_SUB <span class="token operator">|</span> AV_CODEC_PROP_BITMAP_SUB<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>output_descriptor<span class="token punctuation">)</span>
                        output_props <span class="token operator">=</span> output_descriptor<span class="token operator">-&gt;</span>props <span class="token operator">&amp;</span> <span class="token punctuation">(</span>AV_CODEC_PROP_TEXT_SUB <span class="token operator">|</span> AV_CODEC_PROP_BITMAP_SUB<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>subtitle_codec_name <span class="token operator">||</span>
                        input_props <span class="token operator">&amp;</span> output_props <span class="token operator">||</span>
                        <span class="token comment">// Map dvb teletext which has neither property to any output subtitle encoder</span>
                        input_descriptor <span class="token operator">&amp;&amp;</span> output_descriptor <span class="token operator">&amp;&amp;</span>
                        <span class="token punctuation">(</span><span class="token operator">!</span>input_descriptor<span class="token operator">-&gt;</span>props <span class="token operator">||</span>
                         <span class="token operator">!</span>output_descriptor<span class="token operator">-&gt;</span>props<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token function">new_subtitle_stream</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> oc<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">/* Data only if codec id match */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>o<span class="token operator">-&gt;</span>data_disable <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">enum</span> <span class="token class-name">AVCodecID</span> codec_id <span class="token operator">=</span> <span class="token function">av_guess_codec</span><span class="token punctuation">(</span>oc<span class="token operator">-&gt;</span>oformat<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> filename<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> AVMEDIA_TYPE_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> codec_id <span class="token operator">!=</span> AV_CODEC_ID_NONE <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> nb_input_streams<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>input_streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>user_set_discard <span class="token operator">==</span> AVDISCARD_ALL<span class="token punctuation">)</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>input_streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_type <span class="token operator">==</span> AVMEDIA_TYPE_DATA
                    <span class="token operator">&amp;&amp;</span> input_streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_id <span class="token operator">==</span> codec_id <span class="token punctuation">)</span>
                    <span class="token function">new_data_stream</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> oc<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> o<span class="token operator">-&gt;</span>nb_stream_maps<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            StreamMap <span class="token operator">*</span>map <span class="token operator">=</span> <span class="token operator">&amp;</span>o<span class="token operator">-&gt;</span>stream_maps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token operator">-&gt;</span>disabled<span class="token punctuation">)</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token operator">-&gt;</span>linklabel<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                FilterGraph <span class="token operator">*</span>fg<span class="token punctuation">;</span>
                OutputFilter <span class="token operator">*</span>ofilter <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> j<span class="token punctuation">,</span> k<span class="token punctuation">;</span>

                <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> nb_filtergraphs<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    fg <span class="token operator">=</span> filtergraphs<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span>k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> fg<span class="token operator">-&gt;</span>nb_outputs<span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        AVFilterInOut <span class="token operator">*</span>out <span class="token operator">=</span> fg<span class="token operator">-&gt;</span>outputs<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token operator">-&gt;</span>out_tmp<span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>out <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>out<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> map<span class="token operator">-&gt;</span>linklabel<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            ofilter <span class="token operator">=</span> fg<span class="token operator">-&gt;</span>outputs<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>
                            <span class="token keyword">goto</span> loop_end<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
loop_end<span class="token operator">:</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ofilter<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_FATAL<span class="token punctuation">,</span> <span class="token string">"Output with label '%s' does not exist "</span>
                           <span class="token string">"in any defined filter graph, or was already used elsewhere.\n"</span><span class="token punctuation">,</span> map<span class="token operator">-&gt;</span>linklabel<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">exit_program</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">init_output_filter</span><span class="token punctuation">(</span>ofilter<span class="token punctuation">,</span> o<span class="token punctuation">,</span> oc<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">int</span> src_idx <span class="token operator">=</span> input_files<span class="token punctuation">[</span>map<span class="token operator">-&gt;</span>file_index<span class="token punctuation">]</span><span class="token operator">-&gt;</span>ist_index <span class="token operator">+</span> map<span class="token operator">-&gt;</span>stream_index<span class="token punctuation">;</span>

                ist <span class="token operator">=</span> input_streams<span class="token punctuation">[</span>input_files<span class="token punctuation">[</span>map<span class="token operator">-&gt;</span>file_index<span class="token punctuation">]</span><span class="token operator">-&gt;</span>ist_index <span class="token operator">+</span> map<span class="token operator">-&gt;</span>stream_index<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ist<span class="token operator">-&gt;</span>user_set_discard <span class="token operator">==</span> AVDISCARD_ALL<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_FATAL<span class="token punctuation">,</span> <span class="token string">"Stream #%d:%d is disabled and cannot be mapped.\n"</span><span class="token punctuation">,</span>
                           map<span class="token operator">-&gt;</span>file_index<span class="token punctuation">,</span> map<span class="token operator">-&gt;</span>stream_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">exit_program</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>o<span class="token operator">-&gt;</span>subtitle_disable <span class="token operator">&amp;&amp;</span> ist<span class="token operator">-&gt;</span>st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_type <span class="token operator">==</span> AVMEDIA_TYPE_SUBTITLE<span class="token punctuation">)</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>o<span class="token operator">-&gt;</span>   audio_disable <span class="token operator">&amp;&amp;</span> ist<span class="token operator">-&gt;</span>st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_type <span class="token operator">==</span> AVMEDIA_TYPE_AUDIO<span class="token punctuation">)</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>o<span class="token operator">-&gt;</span>   video_disable <span class="token operator">&amp;&amp;</span> ist<span class="token operator">-&gt;</span>st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_type <span class="token operator">==</span> AVMEDIA_TYPE_VIDEO<span class="token punctuation">)</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>o<span class="token operator">-&gt;</span>    data_disable <span class="token operator">&amp;&amp;</span> ist<span class="token operator">-&gt;</span>st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_type <span class="token operator">==</span> AVMEDIA_TYPE_DATA<span class="token punctuation">)</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>

                ost <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                <span class="token keyword">switch</span> <span class="token punctuation">(</span>ist<span class="token operator">-&gt;</span>st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">case</span> AVMEDIA_TYPE_VIDEO<span class="token operator">:</span>      ost <span class="token operator">=</span> <span class="token function">new_video_stream</span>     <span class="token punctuation">(</span>o<span class="token punctuation">,</span> oc<span class="token punctuation">,</span> src_idx<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> AVMEDIA_TYPE_AUDIO<span class="token operator">:</span>      ost <span class="token operator">=</span> <span class="token function">new_audio_stream</span>     <span class="token punctuation">(</span>o<span class="token punctuation">,</span> oc<span class="token punctuation">,</span> src_idx<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> AVMEDIA_TYPE_SUBTITLE<span class="token operator">:</span>   ost <span class="token operator">=</span> <span class="token function">new_subtitle_stream</span>  <span class="token punctuation">(</span>o<span class="token punctuation">,</span> oc<span class="token punctuation">,</span> src_idx<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> AVMEDIA_TYPE_DATA<span class="token operator">:</span>       ost <span class="token operator">=</span> <span class="token function">new_data_stream</span>      <span class="token punctuation">(</span>o<span class="token punctuation">,</span> oc<span class="token punctuation">,</span> src_idx<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> AVMEDIA_TYPE_ATTACHMENT<span class="token operator">:</span> ost <span class="token operator">=</span> <span class="token function">new_attachment_stream</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> oc<span class="token punctuation">,</span> src_idx<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> AVMEDIA_TYPE_UNKNOWN<span class="token operator">:</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>copy_unknown_streams<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        ost <span class="token operator">=</span> <span class="token function">new_unknown_stream</span>   <span class="token punctuation">(</span>o<span class="token punctuation">,</span> oc<span class="token punctuation">,</span> src_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> ignore_unknown_streams <span class="token operator">?</span> AV_LOG_WARNING <span class="token operator">:</span> AV_LOG_FATAL<span class="token punctuation">,</span>
                           <span class="token string">"Cannot map stream #%d:%d - unsupported type.\n"</span><span class="token punctuation">,</span>
                           map<span class="token operator">-&gt;</span>file_index<span class="token punctuation">,</span> map<span class="token operator">-&gt;</span>stream_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ignore_unknown_streams<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_FATAL<span class="token punctuation">,</span>
                               <span class="token string">"If you want unsupported types ignored instead "</span>
                               <span class="token string">"of failing, please use the -ignore_unknown option\n"</span>
                               <span class="token string">"If you want them copied, please use -copy_unknown\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">exit_program</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ost<span class="token punctuation">)</span>
                    ost<span class="token operator">-&gt;</span>sync_ist <span class="token operator">=</span> input_streams<span class="token punctuation">[</span>  input_files<span class="token punctuation">[</span>map<span class="token operator">-&gt;</span>sync_file_index<span class="token punctuation">]</span><span class="token operator">-&gt;</span>ist_index
                                                  <span class="token operator">+</span> map<span class="token operator">-&gt;</span>sync_stream_index<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上面代码主要是AVFormatContext以及AVFormatContext.AVFormatContext即ff_image2_muxer并将AVFormatContext存入全局变量 OutputFile **output_files中，以及new出来各个OutputStream存放在全局变量OutputStream **output_streams。</p> 
<h4><a id="_555"></a>总结图</h4> 
<p>将args解析完成和open动作做完之后，所有的信息都放在了四个全局变量中，具体如下图:<br> <img src="https://images2.imgbox.com/00/e5/8Vqyq5QE_o.png" alt="ffmpeg_open"></p> 
<h3><a id="transcode_558"></a>transcode</h3> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">transcode</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ret<span class="token punctuation">,</span> i<span class="token punctuation">;</span>
    AVFormatContext <span class="token operator">*</span>os<span class="token punctuation">;</span>
    OutputStream <span class="token operator">*</span>ost<span class="token punctuation">;</span>
    InputStream <span class="token operator">*</span>ist<span class="token punctuation">;</span>
    <span class="token class-name">int64_t</span> timer_start<span class="token punctuation">;</span>
    <span class="token class-name">int64_t</span> total_packets_written <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">//重点看下transcode_init 和transcode_step</span>
    ret <span class="token operator">=</span> <span class="token function">transcode_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>received_sigterm<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">int64_t</span> cur_time<span class="token operator">=</span> <span class="token function">av_gettime_relative</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">transcode_step</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> ret <span class="token operator">!=</span> AVERROR_EOF<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_ERROR<span class="token punctuation">,</span> <span class="token string">"Error while filtering: %s\n"</span><span class="token punctuation">,</span> <span class="token function">av_err2str</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">/* dump report by using the output first video and audio streams */</span>
        <span class="token function">print_report</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> timer_start<span class="token punctuation">,</span> cur_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
    <span class="token comment">/* at the end of stream, we must flush the decoder buffers */</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nb_input_streams<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ist <span class="token operator">=</span> input_streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>input_files<span class="token punctuation">[</span>ist<span class="token operator">-&gt;</span>file_index<span class="token punctuation">]</span><span class="token operator">-&gt;</span>eof_reached<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">process_input_packet</span><span class="token punctuation">(</span>ist<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">flush_encoders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">term_exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="transcode_init_597"></a>transcode_init</h4> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">transcode_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">;</span>
    AVFormatContext <span class="token operator">*</span>oc<span class="token punctuation">;</span>
    OutputStream <span class="token operator">*</span>ost<span class="token punctuation">;</span>
    InputStream <span class="token operator">*</span>ist<span class="token punctuation">;</span>
    <span class="token keyword">char</span> error<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nb_filtergraphs<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        FilterGraph <span class="token operator">*</span>fg <span class="token operator">=</span> filtergraphs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> fg<span class="token operator">-&gt;</span>nb_outputs<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            OutputFilter <span class="token operator">*</span>ofilter <span class="token operator">=</span> fg<span class="token operator">-&gt;</span>outputs<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ofilter<span class="token operator">-&gt;</span>ost <span class="token operator">||</span> ofilter<span class="token operator">-&gt;</span>ost<span class="token operator">-&gt;</span>source_index <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>fg<span class="token operator">-&gt;</span>nb_inputs <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>k <span class="token operator">=</span> nb_input_streams<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> k <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token punctuation">;</span> k<span class="token operator">--</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>fg<span class="token operator">-&gt;</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>ist <span class="token operator">==</span> input_streams<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            ofilter<span class="token operator">-&gt;</span>ost<span class="token operator">-&gt;</span>source_index <span class="token operator">=</span> k<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* init framerate emulation */</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nb_input_files<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        InputFile <span class="token operator">*</span>ifile <span class="token operator">=</span> input_files<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ifile<span class="token operator">-&gt;</span>rate_emu<span class="token punctuation">)</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> ifile<span class="token operator">-&gt;</span>nb_streams<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
                input_streams<span class="token punctuation">[</span>j <span class="token operator">+</span> ifile<span class="token operator">-&gt;</span>ist_index<span class="token punctuation">]</span><span class="token operator">-&gt;</span>start <span class="token operator">=</span> <span class="token function">av_gettime_relative</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* init input streams, open decoder */</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nb_input_streams<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">init_input_stream</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> error<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nb_output_streams<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                ost <span class="token operator">=</span> output_streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token function">avcodec_close</span><span class="token punctuation">(</span>ost<span class="token operator">-&gt;</span>enc_ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">goto</span> dump_format<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token comment">/* open each encoder */</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nb_output_streams<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// skip streams fed from filtergraphs until we have a frame for them</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>output_streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>filter<span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>

        ret <span class="token operator">=</span> <span class="token function">init_output_stream</span><span class="token punctuation">(</span>output_streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> error<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">goto</span> dump_format<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* discard unused programs */</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nb_input_files<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        InputFile <span class="token operator">*</span>ifile <span class="token operator">=</span> input_files<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> ifile<span class="token operator">-&gt;</span>ctx<span class="token operator">-&gt;</span>nb_programs<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            AVProgram <span class="token operator">*</span>p <span class="token operator">=</span> ifile<span class="token operator">-&gt;</span>ctx<span class="token operator">-&gt;</span>programs<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> discard  <span class="token operator">=</span> AVDISCARD_ALL<span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span>k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> p<span class="token operator">-&gt;</span>nb_stream_indexes<span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>input_streams<span class="token punctuation">[</span>ifile<span class="token operator">-&gt;</span>ist_index <span class="token operator">+</span> p<span class="token operator">-&gt;</span>stream_index<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>discard<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    discard <span class="token operator">=</span> AVDISCARD_DEFAULT<span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            p<span class="token operator">-&gt;</span>discard <span class="token operator">=</span> discard<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* write headers for files with no streams */</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nb_output_files<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        oc <span class="token operator">=</span> output_files<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>ctx<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oc<span class="token operator">-&gt;</span>oformat<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AVFMT_NOSTREAMS <span class="token operator">&amp;&amp;</span> oc<span class="token operator">-&gt;</span>nb_streams <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ret <span class="token operator">=</span> <span class="token function">check_init_output_file</span><span class="token punctuation">(</span>output_files<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">goto</span> dump_format<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="transcode_step_680"></a>transcode_step</h4> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">transcode_step</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    OutputStream <span class="token operator">*</span>ost<span class="token punctuation">;</span>
    InputStream  <span class="token operator">*</span>ist <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    ost <span class="token operator">=</span> <span class="token function">choose_output</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
    <span class="token comment">//处理output filters</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ost<span class="token operator">-&gt;</span>filter <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>ost<span class="token operator">-&gt;</span>filter<span class="token operator">-&gt;</span>graph<span class="token operator">-&gt;</span>graph<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ifilter_has_all_input_formats</span><span class="token punctuation">(</span>ost<span class="token operator">-&gt;</span>filter<span class="token operator">-&gt;</span>graph<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ret <span class="token operator">=</span> <span class="token function">configure_filtergraph</span><span class="token punctuation">(</span>ost<span class="token operator">-&gt;</span>filter<span class="token operator">-&gt;</span>graph<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_ERROR<span class="token punctuation">,</span> <span class="token string">"Error reinitializing filters!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ost<span class="token operator">-&gt;</span>filter <span class="token operator">&amp;&amp;</span> ost<span class="token operator">-&gt;</span>filter<span class="token operator">-&gt;</span>graph<span class="token operator">-&gt;</span>graph<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ost<span class="token operator">-&gt;</span>initialized<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">char</span> error<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            ret <span class="token operator">=</span> <span class="token function">init_output_stream</span><span class="token punctuation">(</span>ost<span class="token punctuation">,</span> error<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_ERROR<span class="token punctuation">,</span> <span class="token string">"Error initializing output stream %d:%d -- %s\n"</span><span class="token punctuation">,</span>
                       ost<span class="token operator">-&gt;</span>file_index<span class="token punctuation">,</span> ost<span class="token operator">-&gt;</span>index<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">exit_program</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">transcode_from_filter</span><span class="token punctuation">(</span>ost<span class="token operator">-&gt;</span>filter<span class="token operator">-&gt;</span>graph<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ist<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ist<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ost<span class="token operator">-&gt;</span>filter<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> i<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ost<span class="token operator">-&gt;</span>filter<span class="token operator">-&gt;</span>graph<span class="token operator">-&gt;</span>nb_inputs<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            InputFilter <span class="token operator">*</span>ifilter <span class="token operator">=</span> ost<span class="token operator">-&gt;</span>filter<span class="token operator">-&gt;</span>graph<span class="token operator">-&gt;</span>inputs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ifilter<span class="token operator">-&gt;</span>ist<span class="token operator">-&gt;</span>got_output <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>input_files<span class="token punctuation">[</span>ifilter<span class="token operator">-&gt;</span>ist<span class="token operator">-&gt;</span>file_index<span class="token punctuation">]</span><span class="token operator">-&gt;</span>eof_reached<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                ist <span class="token operator">=</span> ifilter<span class="token operator">-&gt;</span>ist<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ist<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ost<span class="token operator">-&gt;</span>inputs_done <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">av_assert0</span><span class="token punctuation">(</span>ost<span class="token operator">-&gt;</span>source_index <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ist <span class="token operator">=</span> input_streams<span class="token punctuation">[</span>ost<span class="token operator">-&gt;</span>source_index<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//重点看下process_input</span>
    ret <span class="token operator">=</span> <span class="token function">process_input</span><span class="token punctuation">(</span>ist<span class="token operator">-&gt;</span>file_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>EAGAIN<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>input_files<span class="token punctuation">[</span>ist<span class="token operator">-&gt;</span>file_index<span class="token punctuation">]</span><span class="token operator">-&gt;</span>eagain<span class="token punctuation">)</span>
            ost<span class="token operator">-&gt;</span>unavailable <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> ret <span class="token operator">==</span> AVERROR_EOF <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> ret<span class="token punctuation">;</span>
    <span class="token comment">//在这里面实现output处理</span>
    <span class="token keyword">return</span> <span class="token function">reap_filters</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">process_input</span><span class="token punctuation">(</span><span class="token keyword">int</span> file_index<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    InputFile <span class="token operator">*</span>ifile <span class="token operator">=</span> input_files<span class="token punctuation">[</span>file_index<span class="token punctuation">]</span><span class="token punctuation">;</span>
    AVFormatContext <span class="token operator">*</span>is<span class="token punctuation">;</span>
    InputStream <span class="token operator">*</span>ist<span class="token punctuation">;</span>
    AVPacket pkt<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">,</span> thread_ret<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
    <span class="token class-name">int64_t</span> duration<span class="token punctuation">;</span>
    <span class="token class-name">int64_t</span> pkt_dts<span class="token punctuation">;</span>

    is  <span class="token operator">=</span> ifile<span class="token operator">-&gt;</span>ctx<span class="token punctuation">;</span>
    <span class="token comment">//从demuxer中读取数据出来</span>
    ret <span class="token operator">=</span> <span class="token function">get_input_packet</span><span class="token punctuation">(</span>ifile<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
    <span class="token comment">//如果需要decoder， decoder完之后写入filter context buffer， 有input filters则filters先处理</span>
    <span class="token function">process_input_packet</span><span class="token punctuation">(</span>ist<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pkt<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   
discard_packet<span class="token operator">:</span>
    <span class="token function">av_packet_unref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">process_input_packet</span><span class="token punctuation">(</span>InputStream <span class="token operator">*</span>ist<span class="token punctuation">,</span> <span class="token keyword">const</span> AVPacket <span class="token operator">*</span>pkt<span class="token punctuation">,</span> <span class="token keyword">int</span> no_eof<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">;</span>
    <span class="token keyword">int</span> repeating <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> eof_reached <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    AVPacket avpkt<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ist<span class="token operator">-&gt;</span>saw_first_ts<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ist<span class="token operator">-&gt;</span>dts <span class="token operator">=</span> ist<span class="token operator">-&gt;</span>st<span class="token operator">-&gt;</span>avg_frame_rate<span class="token punctuation">.</span>num <span class="token operator">?</span> <span class="token operator">-</span> ist<span class="token operator">-&gt;</span>dec_ctx<span class="token operator">-&gt;</span>has_b_frames <span class="token operator">*</span> AV_TIME_BASE <span class="token operator">/</span> <span class="token function">av_q2d</span><span class="token punctuation">(</span>ist<span class="token operator">-&gt;</span>st<span class="token operator">-&gt;</span>avg_frame_rate<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
        ist<span class="token operator">-&gt;</span>pts <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pkt <span class="token operator">&amp;&amp;</span> pkt<span class="token operator">-&gt;</span>pts <span class="token operator">!=</span> AV_NOPTS_VALUE <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>ist<span class="token operator">-&gt;</span>decoding_needed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ist<span class="token operator">-&gt;</span>dts <span class="token operator">+=</span> <span class="token function">av_rescale_q</span><span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>pts<span class="token punctuation">,</span> ist<span class="token operator">-&gt;</span>st<span class="token operator">-&gt;</span>time_base<span class="token punctuation">,</span> AV_TIME_BASE_Q<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ist<span class="token operator">-&gt;</span>pts <span class="token operator">=</span> ist<span class="token operator">-&gt;</span>dts<span class="token punctuation">;</span> <span class="token comment">//unused but better to set it to a value thats not totally wrong</span>
        <span class="token punctuation">}</span>
        ist<span class="token operator">-&gt;</span>saw_first_ts <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ist<span class="token operator">-&gt;</span>next_dts <span class="token operator">==</span> AV_NOPTS_VALUE<span class="token punctuation">)</span>
        ist<span class="token operator">-&gt;</span>next_dts <span class="token operator">=</span> ist<span class="token operator">-&gt;</span>dts<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ist<span class="token operator">-&gt;</span>next_pts <span class="token operator">==</span> AV_NOPTS_VALUE<span class="token punctuation">)</span>
        ist<span class="token operator">-&gt;</span>next_pts <span class="token operator">=</span> ist<span class="token operator">-&gt;</span>pts<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pkt<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* EOF handling */</span>
        <span class="token function">av_init_packet</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>avpkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        avpkt<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        avpkt<span class="token punctuation">.</span>size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        avpkt <span class="token operator">=</span> <span class="token operator">*</span>pkt<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>pkt <span class="token operator">&amp;&amp;</span> pkt<span class="token operator">-&gt;</span>dts <span class="token operator">!=</span> AV_NOPTS_VALUE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ist<span class="token operator">-&gt;</span>next_dts <span class="token operator">=</span> ist<span class="token operator">-&gt;</span>dts <span class="token operator">=</span> <span class="token function">av_rescale_q</span><span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>dts<span class="token punctuation">,</span> ist<span class="token operator">-&gt;</span>st<span class="token operator">-&gt;</span>time_base<span class="token punctuation">,</span> AV_TIME_BASE_Q<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ist<span class="token operator">-&gt;</span>dec_ctx<span class="token operator">-&gt;</span>codec_type <span class="token operator">!=</span> AVMEDIA_TYPE_VIDEO <span class="token operator">||</span> <span class="token operator">!</span>ist<span class="token operator">-&gt;</span>decoding_needed<span class="token punctuation">)</span>
            ist<span class="token operator">-&gt;</span>next_pts <span class="token operator">=</span> ist<span class="token operator">-&gt;</span>pts <span class="token operator">=</span> ist<span class="token operator">-&gt;</span>dts<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// while we have more to decode or while the decoder did output something on EOF</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>ist<span class="token operator">-&gt;</span>decoding_needed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">int64_t</span> duration_dts <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token class-name">int64_t</span> duration_pts <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> got_output <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> decode_failed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        ist<span class="token operator">-&gt;</span>pts <span class="token operator">=</span> ist<span class="token operator">-&gt;</span>next_pts<span class="token punctuation">;</span>
        ist<span class="token operator">-&gt;</span>dts <span class="token operator">=</span> ist<span class="token operator">-&gt;</span>next_dts<span class="token punctuation">;</span>

        <span class="token keyword">switch</span> <span class="token punctuation">(</span>ist<span class="token operator">-&gt;</span>dec_ctx<span class="token operator">-&gt;</span>codec_type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> AVMEDIA_TYPE_AUDIO<span class="token operator">:</span>
            ret <span class="token operator">=</span> <span class="token function">decode_audio</span>    <span class="token punctuation">(</span>ist<span class="token punctuation">,</span> repeating <span class="token operator">?</span> <span class="token constant">NULL</span> <span class="token operator">:</span> <span class="token operator">&amp;</span>avpkt<span class="token punctuation">,</span> <span class="token operator">&amp;</span>got_output<span class="token punctuation">,</span>
                                   <span class="token operator">&amp;</span>decode_failed<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> AVMEDIA_TYPE_VIDEO<span class="token operator">:</span>
            ret <span class="token operator">=</span> <span class="token function">decode_video</span>    <span class="token punctuation">(</span>ist<span class="token punctuation">,</span> repeating <span class="token operator">?</span> <span class="token constant">NULL</span> <span class="token operator">:</span> <span class="token operator">&amp;</span>avpkt<span class="token punctuation">,</span> <span class="token operator">&amp;</span>got_output<span class="token punctuation">,</span> <span class="token operator">&amp;</span>duration_pts<span class="token punctuation">,</span> <span class="token operator">!</span>pkt<span class="token punctuation">,</span>
                                   <span class="token operator">&amp;</span>decode_failed<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> AVMEDIA_TYPE_SUBTITLE<span class="token operator">:</span>
            ret <span class="token operator">=</span> <span class="token function">transcode_subtitles</span><span class="token punctuation">(</span>ist<span class="token punctuation">,</span> <span class="token operator">&amp;</span>avpkt<span class="token punctuation">,</span> <span class="token operator">&amp;</span>got_output<span class="token punctuation">,</span> <span class="token operator">&amp;</span>decode_failed<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">!</span>eof_reached<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">decode_video</span><span class="token punctuation">(</span>InputStream <span class="token operator">*</span>ist<span class="token punctuation">,</span> AVPacket <span class="token operator">*</span>pkt<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>got_output<span class="token punctuation">,</span> <span class="token class-name">int64_t</span> <span class="token operator">*</span>duration_pts<span class="token punctuation">,</span> <span class="token keyword">int</span> eof<span class="token punctuation">,</span>
                        <span class="token keyword">int</span> <span class="token operator">*</span>decode_failed<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    AVFrame <span class="token operator">*</span>decoded_frame<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">decode</span><span class="token punctuation">(</span>ist<span class="token operator">-&gt;</span>dec_ctx<span class="token punctuation">,</span> decoded_frame<span class="token punctuation">,</span> got_output<span class="token punctuation">,</span> pkt <span class="token operator">?</span> <span class="token operator">&amp;</span>avpkt <span class="token operator">:</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
    err <span class="token operator">=</span> <span class="token function">send_frame_to_filters</span><span class="token punctuation">(</span>ist<span class="token punctuation">,</span> decoded_frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> err <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> err <span class="token operator">:</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">send_frame_to_filters</span><span class="token punctuation">(</span>InputStream <span class="token operator">*</span>ist<span class="token punctuation">,</span> AVFrame <span class="token operator">*</span>decoded_frame<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> i<span class="token punctuation">,</span> ret<span class="token punctuation">;</span>
    AVFrame <span class="token operator">*</span>f<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">ifilter_send_frame</span><span class="token punctuation">(</span>ist<span class="token operator">-&gt;</span>filters<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ifilter_send_frame</span><span class="token punctuation">(</span>InputFilter <span class="token operator">*</span>ifilter<span class="token punctuation">,</span> AVFrame <span class="token operator">*</span>frame<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    FilterGraph <span class="token operator">*</span>fg <span class="token operator">=</span> ifilter<span class="token operator">-&gt;</span>graph<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">av_buffersrc_add_frame_flags</span><span class="token punctuation">(</span>ifilter<span class="token operator">-&gt;</span>filter<span class="token punctuation">,</span> frame<span class="token punctuation">,</span> AV_BUFFERSRC_FLAG_PUSH<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">reap_filters</span><span class="token punctuation">(</span><span class="token keyword">int</span> flush<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    AVFrame <span class="token operator">*</span>filtered_frame <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
    filtered_frame <span class="token operator">=</span> ost<span class="token operator">-&gt;</span>filtered_frame<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">double</span> float_pts <span class="token operator">=</span> AV_NOPTS_VALUE<span class="token punctuation">;</span> <span class="token comment">// this is identical to filtered_frame.pts but with higher precision</span>
            <span class="token comment">//从filter input graph中读取filtered_frame</span>
            ret <span class="token operator">=</span> <span class="token function">av_buffersink_get_frame_flags</span><span class="token punctuation">(</span>filter<span class="token punctuation">,</span> filtered_frame<span class="token punctuation">,</span>
                                               AV_BUFFERSINK_FLAG_NO_REQUEST<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">av_buffersink_get_type</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> AVMEDIA_TYPE_VIDEO<span class="token operator">:</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
                <span class="token comment">//重点看下video out</span>
                <span class="token function">do_video_out</span><span class="token punctuation">(</span>of<span class="token punctuation">,</span> ost<span class="token punctuation">,</span> filtered_frame<span class="token punctuation">,</span> float_pts<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> AVMEDIA_TYPE_AUDIO<span class="token operator">:</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
                <span class="token function">do_audio_out</span><span class="token punctuation">(</span>of<span class="token punctuation">,</span> ost<span class="token punctuation">,</span> filtered_frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>  
                <span class="token function">av_assert0</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">av_frame_unref</span><span class="token punctuation">(</span>filtered_frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">do_video_out</span><span class="token punctuation">(</span>OutputFile <span class="token operator">*</span>of<span class="token punctuation">,</span>
                         OutputStream <span class="token operator">*</span>ost<span class="token punctuation">,</span>
                         AVFrame <span class="token operator">*</span>next_picture<span class="token punctuation">,</span>
                         <span class="token keyword">double</span> sync_ipts<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
      <span class="token comment">//将数据送入encoder</span>
        ret <span class="token operator">=</span> <span class="token function">avcodec_send_frame</span><span class="token punctuation">(</span>enc<span class="token punctuation">,</span> in_picture<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Make sure Closed Captions will not be duplicated</span>
        <span class="token function">av_frame_remove_side_data</span><span class="token punctuation">(</span>in_picture<span class="token punctuation">,</span> AV_FRAME_DATA_A53_CC<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//从endcoder读取数据</span>
            ret <span class="token operator">=</span> <span class="token function">avcodec_receive_packet</span><span class="token punctuation">(</span>enc<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
            frame_size <span class="token operator">=</span> pkt<span class="token punctuation">.</span>size<span class="token punctuation">;</span>
            <span class="token comment">//将数据送到muxer</span>
            <span class="token function">output_packet</span><span class="token punctuation">(</span>of<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pkt<span class="token punctuation">,</span> ost<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">output_packet</span><span class="token punctuation">(</span>OutputFile <span class="token operator">*</span>of<span class="token punctuation">,</span> AVPacket <span class="token operator">*</span>pkt<span class="token punctuation">,</span>
                          OutputStream <span class="token operator">*</span>ost<span class="token punctuation">,</span> <span class="token keyword">int</span> eof<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
     <span class="token function">write_packet</span><span class="token punctuation">(</span>of<span class="token punctuation">,</span> pkt<span class="token punctuation">,</span> ost<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">write_packet</span><span class="token punctuation">(</span>OutputFile <span class="token operator">*</span>of<span class="token punctuation">,</span> AVPacket <span class="token operator">*</span>pkt<span class="token punctuation">,</span> OutputStream <span class="token operator">*</span>ost<span class="token punctuation">,</span> <span class="token keyword">int</span> unqueue<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    AVFormatContext <span class="token operator">*</span>s <span class="token operator">=</span> of<span class="token operator">-&gt;</span>ctx<span class="token punctuation">;</span>
    AVStream <span class="token operator">*</span>st <span class="token operator">=</span> ost<span class="token operator">-&gt;</span>st<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">av_interleaved_write_frame</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// mux.c</span>
<span class="token keyword">int</span> <span class="token function">av_interleaved_write_frame</span><span class="token punctuation">(</span>AVFormatContext <span class="token operator">*</span>s<span class="token punctuation">,</span> AVPacket <span class="token operator">*</span>pkt<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ret<span class="token punctuation">,</span> flush <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">prepare_input_packet</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        AVPacket opkt<span class="token punctuation">;</span>
        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">interleave_packet</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token operator">&amp;</span>opkt<span class="token punctuation">,</span> pkt<span class="token punctuation">,</span> flush<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">write_packet</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token operator">&amp;</span>opkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>    
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">write_packet</span><span class="token punctuation">(</span>AVFormatContext <span class="token operator">*</span>s<span class="token punctuation">,</span> AVPacket <span class="token operator">*</span>pkt<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token class-name">int64_t</span> pts_backup<span class="token punctuation">,</span> dts_backup<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AV_PKT_FLAG_UNCODED_FRAME<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        AVFrame <span class="token operator">*</span>frame <span class="token operator">=</span> <span class="token punctuation">(</span>AVFrame <span class="token operator">*</span><span class="token punctuation">)</span>pkt<span class="token operator">-&gt;</span>data<span class="token punctuation">;</span>
        <span class="token function">av_assert0</span><span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>size <span class="token operator">==</span> UNCODED_FRAME_PACKET_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> s<span class="token operator">-&gt;</span>oformat<span class="token operator">-&gt;</span><span class="token function">write_uncoded_frame</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> pkt<span class="token operator">-&gt;</span>stream_index<span class="token punctuation">,</span> <span class="token operator">&amp;</span>frame<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">av_frame_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//向具体的muxer中写数据， 比如本例中为ff_image2_muxer</span>
        ret <span class="token operator">=</span> s<span class="token operator">-&gt;</span>oformat<span class="token operator">-&gt;</span><span class="token function">write_packet</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_976"></a>总结</h3> 
<p><img src="https://images2.imgbox.com/81/c0/xrhwR7cx_o.png" alt="总计图"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6f96dbc4ba9deb9d7336d059e6449ab2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">LINUX网络流量限速控制</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4d0dce7b682d22bed60cb08e7665e911/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">CUDA编程：tensorrt plugin实战 中</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>