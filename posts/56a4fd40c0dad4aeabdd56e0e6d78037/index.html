<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>HappyOnvif - ONVIF协议摄像机接入平台 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="HappyOnvif - ONVIF协议摄像机接入平台" />
<meta property="og:description" content="平台功能：在平台上录入相机后台设置的onvif信息，对外提供webapi接口，如获取播放地址，ptz控制，预置点控制等功能
开发环境：NetCore 6.0 &#43; Sqlite
一、相机管理
1. 添加相机
2. 控制面板
2.1 获取播放地址，并播放rtsp流
2.2 PTZ控制
2.3 预置点管理（获取，前往，添加，删除）
rtsp转webrtc程序，用于html页面播放rtsp地址流
二、日志信息
三、 Swagger
四、程序结构
五、部分接口代码
using HappyOnvif.Utility; using HappyOnvif.Utilty; using HappyOnvif.Utilty.db; using HappyOnvif.Utilty.db.model; using Microsoft.AspNetCore.Http.Extensions; using Microsoft.AspNetCore.Mvc; using Newtonsoft.Json; using System; namespace HappyOnvif.Controllers { [Route(&#34;api/onvif/[action]&#34;)] [ApiController] public class OnvifController : ControllerBase { /// &lt;summary&gt; /// 设备初始化 /// &lt;/summary&gt; /// &lt;param name=&#34;model&#34;&gt;&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; [HttpPost] public ResponseExtend init([FromBody] Camera model) { string ip = model." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/56a4fd40c0dad4aeabdd56e0e6d78037/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-10-18T09:39:26+08:00" />
<meta property="article:modified_time" content="2022-10-18T09:39:26+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">HappyOnvif - ONVIF协议摄像机接入平台</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>平台功能：在平台上录入相机后台设置的onvif信息，对外提供webapi接口，如获取播放地址，ptz控制，预置点控制等功能</p> 
<p>开发环境：NetCore 6.0 + Sqlite</p> 
<p></p> 
<p>一、相机管理</p> 
<p>1. 添加相机</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/8f/4b/XnfrlXAH_o.png"></p> 
<p>2. 控制面板<br> 2.1 获取播放地址，并播放rtsp流<br> 2.2 PTZ控制<br> 2.3 预置点管理（获取，前往，添加，删除）</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/7c/73/AB7vuoHS_o.png"></p> 
<p> rtsp转webrtc程序，用于html页面播放rtsp地址流</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/4c/4c/IyGbHle2_o.png"></p> 
<p>二、日志信息</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/ca/f5/UVcCtN8D_o.png"></p> 
<p>三、 Swagger</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/92/13/dUcEDo80_o.png"></p> 
<p> 四、程序结构</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/b5/f8/9g8qcsT0_o.png"></p> 
<p> 五、部分接口代码</p> 
<pre>using HappyOnvif.Utility;
using HappyOnvif.Utilty;
using HappyOnvif.Utilty.db;
using HappyOnvif.Utilty.db.model;
using Microsoft.AspNetCore.Http.Extensions;
using Microsoft.AspNetCore.Mvc;
using Newtonsoft.Json;
using System;

namespace HappyOnvif.Controllers
{
    [Route("api/onvif/[action]")]
    [ApiController]
    public class OnvifController : ControllerBase
    {
        /// &lt;summary&gt;
        /// 设备初始化
        /// &lt;/summary&gt;
        /// &lt;param name="model"&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpPost]
        public ResponseExtend init([FromBody] Camera model)
        {
            string ip = model.Ip;

            var result = new ResponseExtend&lt;bool&gt;();

            try
            {
                var onvif = DataMgr.GetOnvif(ip);

                if (null == onvif)
                {
                    onvif = new OnvifWsdl();

                    bool status = onvif.Init(ip, model.Port, model.Name, model.Pwd);
                    if (status)
                    {
                        DataMgr.AddOnvif(ip, onvif);
                    } 
                    result.data = status;
                }
                else
                {
                    result.data = true;
                } 
            }
            catch (Exception ex)
            {
                result.code = 10000;
                result.msg = ex.Message;
                Logger.Error($"系统调用接口/onvif/init 发生内部错误:{ex.Message}");
            }

            FreeSqlHelper.InsterApiLog(HttpContext.Request.GetDisplayUrl(), JsonConvert.SerializeObject(result));

            return result;
        }

        /// &lt;summary&gt;
        /// 获取播放地址
        /// &lt;/summary&gt;
        /// &lt;param name="ip"&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpGet]
        public ResponseExtend geturi(string ip = "192.168.0.13")
        {
            var result = new ResponseExtend&lt;string&gt;();

            try
            {
                var onvif = DataMgr.GetOnvif(ip);

                if (null != onvif)
                { 
                    result.data = JsonConvert.SerializeObject(onvif.GetUri());
                }
                else
                {
                    result.code = 10001;
                    result.msg = "设备尚未初始化";
                }

            }
            catch (Exception ex)
            {
                result.code = 10000;
                result.msg = ex.Message;
                Logger.Error($"系统调用接口/onvif/geturi 发生内部错误:{ex.Message}");
            }

            FreeSqlHelper.InsterApiLog(HttpContext.Request.GetDisplayUrl(), JsonConvert.SerializeObject(result));

            return result;
        }

        /// &lt;summary&gt;
        /// 获取预置点
        /// &lt;/summary&gt;
        /// &lt;param name="ip"&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpGet]
        public ResponseExtend getpresets(string ip = "192.168.0.13")
        {
            var result = new ResponseExtend&lt;string&gt;();

            try
            {
                var onvif = DataMgr.GetOnvif(ip);

                if (null != onvif)
                {
                    // 获取预置点
                    onvif.PTZControl(ECommandType.GetPreset);

                    result.data = JsonConvert.SerializeObject(onvif.Presets); 
                }
                else
                {
                    result.code = 10001;
                    result.msg = "设备尚未初始化";
                } 
            }
            catch (Exception ex)
            {
                result.code = 10000;
                result.msg = ex.Message;
                Logger.Error($"系统调用接口/onvif/gettpresets 发生内部错误:{ex.Message}");
            }

            FreeSqlHelper.InsterApiLog(HttpContext.Request.GetDisplayUrl(), JsonConvert.SerializeObject(result));

            return result;
        }

        /// &lt;summary&gt;
        /// ptz控制
        /// &lt;/summary&gt;
        /// &lt;param name="ip"&gt;&lt;/param&gt;
        /// &lt;param name="cmd"&gt;0:停止;1:上;2:左上;3:右上;4:下;5:左下;6:右下;7:左;8:右;9:聚焦+;10:聚焦-;11:变倍+;12:变倍-;13:光圈开;14:光圈关;15:调用预置位;16:前往预置点;17:设置预置位;18:删除预置位&lt;/param&gt;
        /// &lt;param name="presetname"&gt;&lt;/param&gt;
        /// &lt;param name="presettoken"&gt;通过gettpresets获取到value&lt;/param&gt;
        /// &lt;param name="speed"&gt;步长 0-10&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpGet]
        public ResponseExtend ptz(string ip = "192.168.0.13", int cmd = 0, int speed = 5, string presetname = "", string presettoken = "")
        {
            var result = new ResponseExtend&lt;string&gt;();

            try
            {
                var onvif = DataMgr.GetOnvif(ip);

                if (null != onvif)
                {
                    result.data = onvif.PTZControl((ECommandType)cmd, speed, presetname, presettoken);
                }
                else
                {
                    result.code = 10001;
                    result.msg = "设备尚未初始化";
                }
            }
            catch (Exception ex)
            {
                result.code = 10000;
                result.msg = ex.Message;
                Logger.Error($"系统调用接口/onvif/ptz 发生内部错误:{ex.Message}");
            }

            FreeSqlHelper.InsterApiLog(HttpContext.Request.GetDisplayUrl(), JsonConvert.SerializeObject(result));

            return result;
        }
    }
}</pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/78cc577185ebf0aa7d52953d5956942a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">PowerShell脚本学习</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c918be1b172ea835b1f4f2e4c8d8a91a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Data truncation异常</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>