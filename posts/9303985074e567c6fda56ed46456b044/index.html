<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>关于LINUX操作系统异常宕机重启的分析思路 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="关于LINUX操作系统异常宕机重启的分析思路" />
<meta property="og:description" content="一、先搞清楚现状 当收到系统宕机告警或者故障反馈时，需要先对情况进行核实。比如检查系统启动时间，是不是真实发生了重启？如果重启了，什么时间点发生的重启？重启了几次？重启之前有无变更操作？主机上运行的是哪一类应用？重启的主机是物理机还是虚拟机？等等情况，有助于对于故障的分析处理。
可以如下检查：
1、last查看机器最近重启时间，以及重启次数
2、确认重启后，查看主机是物理机还是虚拟机
dmidecode -t 1
3、检查看看是否有人为重启的动作，如果配置了命令审计，可以从message日志中看是否有人敲过reboot命令。或者用history命令也可以看到一些，但有时不一定会有记录下来。
主机命令审计配置和查看可参考这篇文章《LINUX加固之命令审计》
LINUX加固之命令审计-CSDN博客
4、检查看看主机上都跑了些啥？例如oracle、mysql、ha、vcs等高可用集群软件相关的 。
二、硬件故障排查 在第一步做了相关检查后，确认是发生重启了，并且还是物理机，可以考虑是否硬件故障导致（硬件类内存、cpu故障频率高）。系统内可以通过ipmitool工具检查如下:
--安装工具
yum install OpenIPMI ipmitool -y
modprobe ipmi_watchdog
modprobe ipmi_poweroff
modprobe ipmi_devintf
modprobe ipmi_si
modprobe ipmi_msghandler
--查看日志
ipmitool sel list
如果看到类似CPU或内存异常日志，同时时间点和机器重启时间对应上，那就是重启原因。
PS：硬件类问题机房值守人员可以现场查看和报修厂家检查，系统内ipmitool工具是个补充手段，方便远程轻松查看。如果ipmitool查看未有明显报错，也未必硬件一定都正常，建议还需要进行报修原厂，再进一步深度检查。
三、系统内dump日志检查 如果硬件类排查没什么问题或者是个虚拟机，可以进行系统内的日志分析，首先应该看看是否有产生dump日志。参考如下：
cd /var/crash目录下，看是否有生成crash日志目录产生，如下图有个127.0.0.1开头的目录
进到目录里就会有vmcore的dump日志，重启的原因就可以从dump日志找到蛛丝马迹。
crash日志分析可参考这篇《LINUX常用工具之kdump》
LINUX常用工具之kdump分析-CSDN博客
四、系统日志及性能检查 如果硬件日志和crash日志检查了都还没有收获，接下来要对系统日志及相关性能进行复盘检查，检查分析看看故障重启前，主机负载有没有突增，日志中有无异常类报错。可参照如下：
1、性能检查 这部分大部分系统应该都会接入到监控网管中心，可从监控中心去找下历史指标趋势，重点关注CPU、内存、磁盘IO、网络等指标是否有突增情况。
如果不具备监控中心的，或者故障前相关指标没采集到（监控采集有个时间差，瞬间的问题可能未必会捕捉到）；可以从系统sar日志取查找相关信息
cd /var/log/sa,每天的系统监控会写到当天日期的sa文件中，例如11号的性能日志，可以查看sa11或者sar11文件。(注：sar文件可以直接读取，sa文件需要用sar命令加上-f参数指定具体sa文件读取内容)
关于sa文件的查看可以man 下sar去看看参数，例如
-A：所有报告的总和
-u：输出CPU使用情况的统计信息
-v：输出inode、文件和其他内核表的统计信息
-d：输出每一个块设备的活动信息
-r：输出内存和交换空间的统计信息
-b：显示I/O和传送速率的统计信息
-a：文件读写情况
-c：输出进程统计信息，每秒创建的进程数
-R：输出内存页面的统计信息
-y：终端设备活动情况
-w：输出系统交换活动信息
示例：查看11号当天故障某个时间点cpu情况，就可以用
sar -u -f sa11" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/9303985074e567c6fda56ed46456b044/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-11T14:39:38+08:00" />
<meta property="article:modified_time" content="2024-01-11T14:39:38+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">关于LINUX操作系统异常宕机重启的分析思路</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>一、先搞清楚现状</h2> 
<p>当收到系统宕机告警或者故障反馈时，需要先对情况进行核实。比如检查系统启动时间，是不是真实发生了重启？如果重启了，什么时间点发生的重启？重启了几次？重启之前有无变更操作？主机上运行的是哪一类应用？重启的主机是物理机还是虚拟机？等等情况，有助于对于故障的分析处理。</p> 
<p>可以如下检查：</p> 
<p>1、last查看机器最近重启时间，以及重启次数</p> 
<p><img alt="" height="215" src="https://images2.imgbox.com/a7/4d/Y55OZjq4_o.png" width="759"></p> 
<p>2、确认重启后，查看主机是物理机还是虚拟机</p> 
<p>dmidecode -t 1</p> 
<p><img alt="" height="270" src="https://images2.imgbox.com/a9/80/nv1j9g02_o.png" width="977"></p> 
<p>3、检查看看是否有人为重启的动作，如果配置了命令审计，可以从message日志中看是否有人敲过reboot命令。或者用history命令也可以看到一些，但有时不一定会有记录下来。</p> 
<p>主机命令审计配置和查看可参考这篇文章《LINUX加固之命令审计》</p> 
<p><a href="https://blog.csdn.net/vincent0920/article/details/135284212?spm=1001.2014.3001.5501" title="LINUX加固之命令审计-CSDN博客">LINUX加固之命令审计-CSDN博客</a></p> 
<p>4、检查看看主机上都跑了些啥？例如oracle、mysql、ha、vcs等高可用集群软件相关的 。</p> 
<p></p> 
<h2>二、硬件故障排查</h2> 
<p>在第一步做了相关检查后，确认是发生重启了，并且还是物理机，可以考虑是否硬件故障导致（硬件类内存、cpu故障频率高）。系统内可以通过ipmitool工具检查如下:</p> 
<p><br> --安装工具<br> yum install OpenIPMI ipmitool -y<br> modprobe ipmi_watchdog<br> modprobe ipmi_poweroff<br> modprobe ipmi_devintf<br> modprobe ipmi_si<br> modprobe ipmi_msghandler<br> --查看日志<br> ipmitool sel list</p> 
<p><img alt="" height="280" src="https://images2.imgbox.com/f5/6d/Dz6YGh9k_o.png" width="826"></p> 
<p>如果看到类似CPU或内存异常日志，同时时间点和机器重启时间对应上，那就是重启原因。</p> 
<p>PS：硬件类问题机房值守人员可以现场查看和报修厂家检查，系统内ipmitool工具是个补充手段，方便远程轻松查看。如果ipmitool查看未有明显报错，也未必硬件一定都正常，建议还需要进行报修原厂，再进一步深度检查。</p> 
<h2>三、系统内dump日志检查</h2> 
<p>如果硬件类排查没什么问题或者是个虚拟机，可以进行系统内的日志分析，首先应该看看是否有产生dump日志。参考如下：</p> 
<p>cd /var/crash目录下，看是否有生成crash日志目录产生，如下图有个127.0.0.1开头的目录</p> 
<p><img alt="" height="101" src="https://images2.imgbox.com/e7/20/hpzCvZfG_o.png" width="958"></p> 
<p>进到目录里就会有vmcore的dump日志，重启的原因就可以从dump日志找到蛛丝马迹。</p> 
<p>crash日志分析可参考这篇《LINUX常用工具之kdump》</p> 
<p><a href="https://blog.csdn.net/vincent0920/article/details/135520062?spm=1001.2014.3001.5501" title="LINUX常用工具之kdump分析-CSDN博客">LINUX常用工具之kdump分析-CSDN博客</a></p> 
<h2>四、系统日志及性能检查</h2> 
<p>如果硬件日志和crash日志检查了都还没有收获，接下来要对系统日志及相关性能进行复盘检查，检查分析看看故障重启前，主机负载有没有突增，日志中有无异常类报错。可参照如下：</p> 
<h3>1、性能检查</h3> 
<p>这部分大部分系统应该都会接入到监控网管中心，可从监控中心去找下历史指标趋势，<span style="color:#fe2c24;"><strong>重点关注CPU、内存、磁盘IO、网络</strong></span>等指标是否有突增情况。</p> 
<p>如果不具备监控中心的，或者故障前相关指标没采集到（监控采集有个时间差，瞬间的问题可能未必会捕捉到）；可以从系统sar日志取查找相关信息</p> 
<p>cd /var/log/sa,每天的系统监控会写到当天日期的sa文件中，例如11号的性能日志，可以查看sa11或者sar11文件。(注：sar文件可以直接读取，sa文件需要用sar命令加上-f参数指定具体sa文件读取内容)</p> 
<p><img alt="" height="45" src="https://images2.imgbox.com/6b/3a/Vi0c3IMj_o.png" width="1200"></p> 
<p>关于sa文件的查看可以man 下sar去看看参数，例如</p> 
<blockquote> 
 <p>-A：所有报告的总和</p> 
 <p>-u：输出CPU使用情况的统计信息</p> 
 <p>-v：输出inode、文件和其他内核表的统计信息</p> 
 <p>-d：输出每一个块设备的活动信息</p> 
 <p>-r：输出内存和交换空间的统计信息</p> 
 <p>-b：显示I/O和传送速率的统计信息</p> 
 <p>-a：文件读写情况</p> 
 <p>-c：输出进程统计信息，每秒创建的进程数</p> 
 <p>-R：输出内存页面的统计信息</p> 
 <p>-y：终端设备活动情况</p> 
 <p>-w：输出系统交换活动信息</p> 
</blockquote> 
<p>示例：查看11号当天故障某个时间点cpu情况，就可以用</p> 
<p>sar -u -f sa11</p> 
<p><img alt="" height="392" src="https://images2.imgbox.com/73/a6/U5h89p2r_o.png" width="829"></p> 
<h3> 2、日志检查</h3> 
<p>/var/log/message 系统启动后的信息和错误日志，是Red Hat Linux中最常用的日志之一，其他软件日志有时也会打印输出到里面。<br> /var/log/secure 与安全相关的日志信息<br> /var/log/maillog 与邮件相关的日志信息<br> /var/log/cron 与定时任务相关的日志信息<br> /var/log/spooler 与UUCP和news设备相关的日志信息<br> /var/log/boot.log 守护进程启动和停止相关的日志消息<br> /var/log/wtmp 该日志文件永久记录每个用户登录、注销及系统的启动、停机的事件</p> 
<p>重点检查/var/log/message、dmesg日志、/var/log/secure等日志查看是否有error、fail、critical等关键报错信息。</p> 
<h2>五、ha等高可用集群相关软件日志检查</h2> 
<p>如果以上步骤都排查了一通，还是没找到重启的原因，那么从ha高可用的方向去查查看，如果有部署相关的软件，则去排查这些集群的日志，因为高可用集群通常会有一些驱逐、脑裂、重启节点等异常机制，也会触发机器发生重启。这块遇到了可以反馈让集群专业同事去协助排查，或者你也可以试着自己动手去检查相关日志，从不会到会，就是从每一次动手开始，后面也会去分享一些集群软件故障触发的主机重启案例。</p> 
<h2>六、其他排查方向及建议</h2> 
<p>1、如果是虚拟机故障，也建议虚拟化平台层去看看底层服务是否有异常。</p> 
<p>2、各类日志不光是检查里面有没有异常内容，还需要关注是否日志在之前有正常输出，比如kdump是否做了配置，配置是否生效，如果不生效crash日志不会生成。其他日志也是一样。</p> 
<p>3、操作系统一次重启可能涉及多多方面，不妨多去请教和咨询，有时是需要各专业同事共同诊断，才能把问题彻底搞清楚。</p> 
<p>   </p> 
<p> There are many things that can not be broken！</p> 
<p> 如果觉得本文对你有帮助，欢迎点赞、收藏、评论！</p> 
<p></p> 
<p></p> 
<p></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7262be0b22b54fffb8bb0ca8a602ad83/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">一小时掌握：使用ScrapySharp和C#打造新闻下载器</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f2a5564ff510437f4995499e93288624/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">java将word转换成pdf，并去除水印</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>