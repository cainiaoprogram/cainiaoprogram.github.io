<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>定时任务使用指南 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="定时任务使用指南" />
<meta property="og:description" content="目录 定时任务常见的使用场景定时任务常见组件jdk自带的Timerjdk自带的ScheduledExecutorServicespringboot自带的定时任务Quartzquartz的体系结构springboot整合quartz Elastic Job（推荐）springboot整合elasticjob lite邮件预警（可选）web控制台的部署常见操作说明 xxl-jobweb控制台的部署编写定时任务策略说明 分批处理数据 定时任务常见的使用场景 指定时间点执行
铁路定时放票，美团定时发放优惠券、红包商品定时上下架（开售/结束），活动定时开始/结束定时推送营销信息修复历史数据
间隔指定时间自动执行
同步数据：从第三方拉取信息，同步到我们自己的库中，比如定时查询合作银行的转账进度、合作快递的物流进度。更新状态：超过三十分钟未支付自动取消订单，到期自动解冻账号。消息通知：扫描即将过期的优惠券，即将开始的车票、机票、电影票，通知用户；备份数据、统计账单流水、更新缓存检测节点心跳，确定节点状态、是否可用 定时任务常见组件 1、jdk自带的 java.util.Timer
使用简单、功能单一，对复杂任务、多任务并发执行支持差，适用于简单的单个任务，eg. 间隔指定时间清除本地缓存。
2、jdk自带的 java.util.concurrent.ScheduledExecutorService
支持线程池，对多任务支持好，适合执行多个单机任务。
3、springboot自带的Schedule
使用简单，与springboot无缝接入，适合用于springboot项目的简单单机任务。
4、Quartz
专业的定时任务框架，功能强大，使用略微麻烦，适合用于复杂的单机任务。
以上三个对分布式的支持都差，集群部署服务时容易出现多个节点重复执行定时任务的问题，通常只用于实现单机定时任务。可以自行实现分布式（eg.使用zk做分布式协调）、将任务状态持久化（db），但比较麻烦。
5、elastic-job（推荐）
当当网开源的弹性分布式任务调度框架，已成为apache ShardingSphere的子项目；功能丰富强大，提供web管理界面，新版界面使用 Vue &#43; ElementUI 编写，漂亮美观，文档齐全，接入、使用都十分简便；但需要引入zk实现分布式协调，部署略微麻烦。
6、xxl-job
大众点评开源的弹性分布式任务调度框架，功能丰富强大，轻量，提供web管理界面，springboot &#43; freemarker 界面一般，文档丰富，使用db持久化任务状态，无需额外引入组件。
elastic job、xxl-job 二者相比，不看github star的话，elastic job 的优势在于使用体验，管理界面比 xxl-job 漂亮、好用，接入也比 xxl-job 简便；xxl-job 的优势在于无需额外引入组件。如果项目本身要引入zk，更推荐使用 elastic-job lite实现分布式定时任务。
jdk自带的Timer 1、编写定时任务：继承抽象类TimerTask，实现run()方法
public class MyTask extends TimerTask { @Override public void run() { try { //... } catch (Exception e) { //必须catch异常 } } } 2、调度、执行" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/ab5c5134bab61903f871e9fce959cee3/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-10-24T14:14:29+08:00" />
<meta property="article:modified_time" content="2023-10-24T14:14:29+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">定时任务使用指南</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><ul><li><ul><li><a href="#_3" rel="nofollow">定时任务常见的使用场景</a></li><li><a href="#_20" rel="nofollow">定时任务常见组件</a></li><li><a href="#jdkTimer_52" rel="nofollow">jdk自带的Timer</a></li><li><a href="#jdkScheduledExecutorService_102" rel="nofollow">jdk自带的ScheduledExecutorService</a></li><li><a href="#springboot_154" rel="nofollow">springboot自带的定时任务</a></li><li><a href="#Quartz_159" rel="nofollow">Quartz</a></li><li><ul><li><a href="#quartz_160" rel="nofollow">quartz的体系结构</a></li><li><a href="#springbootquartz_176" rel="nofollow">springboot整合quartz</a></li></ul> 
    </li><li><a href="#Elastic_Job_248" rel="nofollow">Elastic Job（推荐）</a></li><li><ul><li><a href="#springbootelasticjob_lite_260" rel="nofollow">springboot整合elasticjob lite</a></li><li><a href="#_335" rel="nofollow">邮件预警（可选）</a></li><li><a href="#web_369" rel="nofollow">web控制台的部署</a></li><li><a href="#_402" rel="nofollow">常见操作说明</a></li></ul> 
    </li><li><a href="#xxljob_479" rel="nofollow">xxl-job</a></li><li><ul><li><a href="#web_484" rel="nofollow">web控制台的部署</a></li><li><a href="#_513" rel="nofollow">编写定时任务</a></li><li><a href="#_683" rel="nofollow">策略说明</a></li></ul> 
    </li><li><a href="#_705" rel="nofollow">分批处理数据</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<br>   
<p></p> 
<h4><a id="_3"></a>定时任务常见的使用场景</h4> 
<p>指定时间点执行</p> 
<ul><li>铁路定时放票，美团定时发放优惠券、红包</li><li>商品定时上下架（开售/结束），活动定时开始/结束</li><li>定时推送营销信息</li><li>修复历史数据<br>  </li></ul> 
<p>间隔指定时间自动执行</p> 
<ul><li>同步数据：从第三方拉取信息，同步到我们自己的库中，比如定时查询合作银行的转账进度、合作快递的物流进度。</li><li>更新状态：超过三十分钟未支付自动取消订单，到期自动解冻账号。</li><li>消息通知：扫描即将过期的优惠券，即将开始的车票、机票、电影票，通知用户；</li><li>备份数据、统计账单流水、更新缓存</li><li>检测节点心跳，确定节点状态、是否可用</li></ul> 
<p> </p> 
<h4><a id="_20"></a>定时任务常见组件</h4> 
<p>1、jdk自带的 java.util.Timer<br> 使用简单、功能单一，对复杂任务、多任务并发执行支持差，适用于简单的单个任务，eg. 间隔指定时间清除本地缓存。<br>  </p> 
<p>2、jdk自带的 java.util.concurrent.ScheduledExecutorService<br> 支持线程池，对多任务支持好，适合执行多个单机任务。</p> 
<p> </p> 
<p>3、springboot自带的Schedule<br> 使用简单，与springboot无缝接入，适合用于springboot项目的简单单机任务。<br>  </p> 
<p>4、Quartz<br> 专业的定时任务框架，功能强大，使用略微麻烦，适合用于复杂的单机任务。<br>  </p> 
<p>以上三个对分布式的支持都差，集群部署服务时容易出现多个节点重复执行定时任务的问题，通常只用于实现单机定时任务。可以自行实现分布式（eg.使用zk做分布式协调）、将任务状态持久化（db），但比较麻烦。<br>  </p> 
<p>5、elastic-job（推荐）<br> 当当网开源的弹性分布式任务调度框架，已成为apache ShardingSphere的子项目；功能丰富强大，提供web管理界面，新版界面使用 Vue + ElementUI 编写，漂亮美观，文档齐全，接入、使用都十分简便；但需要引入zk实现分布式协调，部署略微麻烦。<br>  </p> 
<p>6、xxl-job<br> 大众点评开源的弹性分布式任务调度框架，功能丰富强大，轻量，提供web管理界面，springboot + freemarker 界面一般，文档丰富，使用db持久化任务状态，无需额外引入组件。</p> 
<p>elastic job、xxl-job 二者相比，不看github star的话，elastic job 的优势在于使用体验，管理界面比 xxl-job 漂亮、好用，接入也比 xxl-job 简便；xxl-job 的优势在于无需额外引入组件。如果项目本身要引入zk，更推荐使用 elastic-job lite实现分布式定时任务。</p> 
<p> </p> 
<h4><a id="jdkTimer_52"></a>jdk自带的Timer</h4> 
<p>1、编写定时任务：继承抽象类TimerTask，实现run()方法</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyTask</span> <span class="token keyword">extends</span> <span class="token class-name">TimerTask</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">//...</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>   <span class="token comment">//必须catch异常</span>

		<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p> </p> 
<p>2、调度、执行</p> 
<pre><code class="prism language-java"><span class="token comment">//创建time实例：会创建 TimerThread、TaskQueue 实例，并调用 thread.start(); 启动线程</span>
<span class="token class-name">Timer</span> timer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">MyTask</span> myTask1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">MyTask</span> myTask2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//第2个参数指定多少ms后开始初次执行，第3个参数执行间隔周期</span>
timer<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span>myTask1<span class="token punctuation">,</span> <span class="token number">10000L</span><span class="token punctuation">,</span> <span class="token number">60000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
timer<span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span>myTask2<span class="token punctuation">,</span> <span class="token number">5000L</span><span class="token punctuation">,</span> <span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//当前线程继续往下执行</span>
</code></pre> 
<p>Timer内部有2个成员变量：Thread、Queue，一个Time实例对应一个线程、队列，此Time实例所有的任务都会添加到队列中，由一个线程负责执行。如果某个任务执行时抛出异常，会造成线程执行中断，不会再执行后续批次的任务，所以实现 TimerTask#run 方法时，一定要catch异常。</p> 
<p>schedule()、scheduleAtFixedRate()的区别</p> 
<ul><li>schedule：间隔周期从上次执行完毕时开始算，如果期间有任务执行耗时较长，耽搁了其它任务的执行，其它任务的执行时间会推迟、顺延。</li><li>scheduleAtFixedRate：间隔周期从上次执行开始时算，执行时间点是可预知的、固定的，如果期间有任务执行耗时较长，耽搁了其它任务的执行，其它任务会补上之前未执行的场次（连续执行多次）。</li></ul> 
<p>通常使用 schedule，不使用 scheduleAtFixedRate。</p> 
<pre><code class="prism language-java"><span class="token comment">//取消指定的定时任务</span>
myTask<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//取消此timer中所有的定时任务</span>
timer<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p> </p> 
<h4><a id="jdkScheduledExecutorService_102"></a>jdk自带的ScheduledExecutorService</h4> 
<p>Timer位于 java.util 包下，使用单线程执行所有任务，多任务并发执行支持差，可靠性低，使用Timer时会提示“使用ScheduledExecutorService 替代Timer”。</p> 
<p>ScheduledExecutorService 位于 java.util.concurrent 包下，支持线程池、多种时间单位，对多任务并发执行支持好。</p> 
<pre><code class="prism language-java"><span class="token comment">//虽然ScheduledThreadPoolExecutor继承了ThreadPoolExecutor，但继承的线程池调优参数不会生效，指定核心线程数即可</span>
<span class="token class-name">ScheduledThreadPoolExecutor</span> scheduledThreadPoolExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScheduledThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//还可以指定 ThreadFactory、任务拒绝策略（默认AbortPolicy 直接抛异常）</span>
<span class="token class-name">ScheduledExecutorService</span> scheduledThreadPoolExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScheduledThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">BasicThreadFactory<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">namingPattern</span><span class="token punctuation">(</span><span class="token string">"task-thread-pool-%d"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">daemon</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>AbortPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">//从ThreadPoolExecutor继承的方法</span>
scheduledThreadPoolExecutor<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
scheduledThreadPoolExecutor<span class="token punctuation">.</span><span class="token function">shutdownNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token comment">//schedule系列方法返回值都是ScheduledFuture，可用于任务的取消、状态判断、返回值获取</span>


<span class="token comment">//schedule只执行1次，指定延迟执行时间。支持Runnable（无返回值）、Callable（有返回值）</span>
<span class="token class-name">ScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> scheduledFuture <span class="token operator">=</span> scheduledThreadPoolExecutor<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyRunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> scheduledFuture <span class="token operator">=</span> scheduledThreadPoolExecutor<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyCallable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//实质是调用 schedule(command, 0, NANOSECONDS) 立刻执行1次，无返回值，只支持 Runnable</span>
scheduledThreadPoolExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyRunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">//固定频率执行：距上次执行开始时 固定时间后执行下一次。如果执行时间较长，超过了间隔时间，则会在执行完毕后立刻执行下一次，不会出现多次并发执行</span>
<span class="token class-name">ScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> scheduledFuture <span class="token operator">=</span> scheduledThreadPoolExecutor<span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyRunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//固定延迟执行：距上次执行完毕时 固定时间后执行下一次</span>
<span class="token class-name">ScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> scheduledFuture <span class="token operator">=</span> scheduledThreadPoolExecutor<span class="token punctuation">.</span><span class="token function">scheduleWithFixedDelay</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyRunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//需要多次执行的任务，通常使用 scheduleWithFixedDelay</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token comment">//任务是执行完毕，正常执行完毕、异常终止、已取消 都算执行完毕</span>
<span class="token keyword">boolean</span> isDone <span class="token operator">=</span> scheduledFuture<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//取消任务，参数指定如果任务正在执行是否尝试中断，返回取消结果</span>
<span class="token comment">//如果任务已经执行完毕、已经取消、或由于其它原因无法取消，返回false</span>
<span class="token keyword">boolean</span> cancel <span class="token operator">=</span> scheduledFuture<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">boolean</span> cancelled <span class="token operator">=</span> scheduledFuture<span class="token punctuation">.</span><span class="token function">isCancelled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p> </p> 
<h4><a id="springboot_154"></a>springboot自带的定时任务</h4> 
<p>参考：<a href="https://blog.csdn.net/chy_18883701161/article/details/120387438">https://blog.csdn.net/chy_18883701161/article/details/120387438</a></p> 
<p> </p> 
<h4><a id="Quartz_159"></a>Quartz</h4> 
<h5><a id="quartz_160"></a>quartz的体系结构</h5> 
<p>3个核心概念</p> 
<ul><li>任务 Job</li><li>触发器 Trigger</li><li>调度器 Scheduler<br>  </li></ul> 
<p><img src="https://images2.imgbox.com/b5/0b/fE7qywAn_o.png" alt="在这里插入图片描述"><br>  <br> quartz提供了2种作业存储类型</p> 
<ul><li>RAMJobStore ：默认使用的作业存储类型，将任务调度状态保存在内存中，性能好但不具备持久性，发生故障时会丢失所有的任务状态信息。</li><li>JDBC作业存储：将任务调度保存到数据库中，需要自行建一些表，表名、字段名都是固定的，quartz会自动持久化任务数据到数据库中，发生故障时也能恢复调度现场，性能略差。</li></ul> 
<p> </p> 
<h5><a id="springbootquartz_176"></a>springboot整合quartz</h5> 
<p>1、依赖<br> 创建项目时勾选 I/O -&gt; Quartz Scheduler，也可以手动添加依赖</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-quartz<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>在yml中输入quartz即可查看quartz的配置项，一般使用默认配置即可。<br>  </p> 
<p>2、编写定时任务，一个类对应一个定时任务</p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>quartz<span class="token punctuation">.</span></span><span class="token class-name">JobExecutionContext</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>quartz<span class="token punctuation">.</span></span><span class="token class-name">JobExecutionException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>scheduling<span class="token punctuation">.</span>quartz<span class="token punctuation">.</span></span><span class="token class-name">QuartzJobBean</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
  * 继承QuartzJobBean，重写executeInternal()，无需要放到spring容器中
  */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">XxxJob</span> <span class="token keyword">extends</span> <span class="token class-name">QuartzJobBean</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">executeInternal</span><span class="token punctuation">(</span><span class="token class-name">JobExecutionContext</span> jobExecutionContext<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JobExecutionException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//...</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p> </p> 
<p>3、配置定时任务，一个定时任务对应一个配置类</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">XxxJobConfig</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 创建JobDetail实例，放到spring容器中，一个job对应一个JobDetail实例
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">JobDetail</span> <span class="token function">xxxJobDetail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//绑定Job</span>
        <span class="token keyword">return</span> <span class="token class-name">JobBuilder</span><span class="token punctuation">.</span><span class="token function">newJob</span><span class="token punctuation">(</span><span class="token class-name">XxxJob</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                <span class="token comment">//设置此job实例的唯一标识(name、所属分组)</span>
                <span class="token punctuation">.</span><span class="token function">withIdentity</span><span class="token punctuation">(</span><span class="token string">"xxxJob"</span><span class="token punctuation">,</span> <span class="token string">"defaultJobGroup"</span><span class="token punctuation">)</span>
                <span class="token comment">//如果此JobDetail实例没有关联Trigger，也不删除此JobDetail实例</span>
                <span class="token punctuation">.</span><span class="token function">storeDurably</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 创建trigger实例，放到spring容器中，一个job对应一个trigger实例
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Trigger</span> <span class="token function">xxxTrigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">TriggerBuilder</span><span class="token punctuation">.</span><span class="token function">newTrigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">//设置此trigger实例的唯一标识(name、所属分组)</span>
                <span class="token punctuation">.</span><span class="token function">withIdentity</span><span class="token punctuation">(</span><span class="token string">"xxxTrigger"</span><span class="token punctuation">,</span> <span class="token string">"defaultTriggerGroup"</span><span class="token punctuation">)</span>
                <span class="token comment">//绑定要调度的job</span>
                <span class="token punctuation">.</span><span class="token function">forJob</span><span class="token punctuation">(</span><span class="token string">"xxxJob"</span><span class="token punctuation">,</span> <span class="token string">"defaultJobGroup"</span><span class="token punctuation">)</span>
                <span class="token comment">//调度计划</span>
                <span class="token punctuation">.</span><span class="token function">withSchedule</span><span class="token punctuation">(</span><span class="token class-name">CronScheduleBuilder</span><span class="token punctuation">.</span><span class="token function">cronSchedule</span><span class="token punctuation">(</span><span class="token string">"*/10 * * * * ?"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">startNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p> </p> 
<h4><a id="Elastic_Job_248"></a>Elastic Job（推荐）</h4> 
<p>官网：<a href="https://shardingsphere.apache.org/elasticjob/" rel="nofollow">https://shardingsphere.apache.org/elasticjob/</a><br> github：<a href="https://github.com/apache/shardingsphere-elasticjob">https://github.com/apache/shardingsphere-elasticjob</a></p> 
<p>ElasticJob包含2个子项目</p> 
<ul><li>ElasticJob-Lite：轻量级无中心化解决方案，只需要引入ZK，；</li><li>ElasticJob-Cloud：使用 ZK + Mesos + Docker 的解决方案，额外提供资源治理、应用分发以及进程隔离等服务，跟 Lite 的区别只是部署方式不同，它们使用相同的 API，只要开发一次。</li></ul> 
<p>通常使用 Lite 即可，下文只介绍 Lite 的使用方式</p> 
<p> </p> 
<h5><a id="springbootelasticjob_lite_260"></a>springboot整合elasticjob lite</h5> 
<p>1、添加依赖</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.shardingsphere.elasticjob<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>elasticjob-lite-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p> </p> 
<p>2、编写定时任务<br> elastic job提供了2种类型的定时任务：SimpleJob、DataflowJob，根据需要实现即可，都需要放到spring容器中</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MySimpleJob</span> <span class="token keyword">implements</span> <span class="token class-name">SimpleJob</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">ShardingContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//...</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyDataflowJob</span> <span class="token keyword">implements</span> <span class="token class-name">DataflowJob</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token class-name">ShardingContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//...</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processData</span><span class="token punctuation">(</span><span class="token class-name">ShardingContext</span> shardingContext<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> orders<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p> </p> 
<p>3、yml</p> 
<p>建议 elastic-job 的配置放在单独的 elastic-job.yml 文件中，然后在 application.yml 中引入</p> 
<pre><code class="prism language-yml"><span class="token key atrule">elasticjob</span><span class="token punctuation">:</span>
  <span class="token comment">#注册中心配置</span>
  <span class="token key atrule">regCenter</span><span class="token punctuation">:</span>
    <span class="token comment">#zk节点</span>
    <span class="token key atrule">serverLists</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">2181</span>
    <span class="token comment">#命名空间，即存储elastic job数据要zk node</span>
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> elasticjob<span class="token punctuation">-</span>task
  <span class="token comment">#定时任务配置</span>
  <span class="token key atrule">jobs</span><span class="token punctuation">:</span>
    <span class="token comment">#自定义的任务名称</span>
    <span class="token key atrule">mySimpleJob</span><span class="token punctuation">:</span>
      <span class="token comment">#对应的类</span>
      <span class="token key atrule">elasticJobClass</span><span class="token punctuation">:</span> com.chy.mall.job.MySimpleJob
      <span class="token key atrule">cron</span><span class="token punctuation">:</span> 0/10 * * * * <span class="token punctuation">?</span>
      <span class="token comment">#自定义参数</span>
      <span class="token key atrule">jobParameter</span><span class="token punctuation">:</span> xxx
      <span class="token comment">#分片总数</span>
      <span class="token key atrule">shardingTotalCount</span><span class="token punctuation">:</span> <span class="token number">3</span>
      <span class="token comment">#自定义的分片参数</span>
      <span class="token key atrule">shardingItemParameters</span><span class="token punctuation">:</span> 0=Beijing<span class="token punctuation">,</span>1=Shanghai<span class="token punctuation">,</span>2=Guangzhou
    <span class="token key atrule">myDataFlowJob</span><span class="token punctuation">:</span>
      <span class="token key atrule">elasticJobClass</span><span class="token punctuation">:</span> com.chy.mall.job.MyDataflowJob
      <span class="token key atrule">cron</span><span class="token punctuation">:</span> 0/10 * * * * <span class="token punctuation">?</span>
      <span class="token key atrule">shardingTotalCount</span><span class="token punctuation">:</span> <span class="token number">3</span>
</code></pre> 
<p>如果定时任务已经注册到zk，后续在yml中修改cron表达式、自定义参数、分片总数这些任务配置项是不会生效的，需要到web控制台修改，来更新zk保存的任务信息。</p> 
<p> </p> 
<h5><a id="_335"></a>邮件预警（可选）</h5> 
<p>定时任务执行出错时，自动发送邮件通知指定人员</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.shardingsphere.elasticjob<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>elasticjob-error-handler-email<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<pre><code class="prism language-yml"><span class="token key atrule">elasticjob</span><span class="token punctuation">:</span>
  <span class="token key atrule">regCenter</span><span class="token punctuation">:</span>
    <span class="token punctuation">...</span>
  <span class="token key atrule">jobs</span><span class="token punctuation">:</span>
    <span class="token punctuation">...</span>
    <span class="token key atrule">jobErrorHandlerType</span><span class="token punctuation">:</span> EMAIL 
  <span class="token key atrule">props</span><span class="token punctuation">:</span>
    <span class="token key atrule">email</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> host
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">465</span>
      <span class="token key atrule">username</span><span class="token punctuation">:</span> username
      <span class="token key atrule">password</span><span class="token punctuation">:</span> password
      <span class="token key atrule">useSsl</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">subject</span><span class="token punctuation">:</span> ElasticJob error message
      <span class="token key atrule">from</span><span class="token punctuation">:</span> from@xxx.xx
      <span class="token key atrule">to</span><span class="token punctuation">:</span> to1@xxx.xx<span class="token punctuation">,</span>to2@xxx.xx
      <span class="token key atrule">cc</span><span class="token punctuation">:</span> cc@xxx.xx
      <span class="token key atrule">bcc</span><span class="token punctuation">:</span> bcc@xxx.xx
      <span class="token key atrule">debug</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
</code></pre> 
<p> </p> 
<h5><a id="web_369"></a>web控制台的部署</h5> 
<p>1、下载 lite ui 的二进制tar包（不是源码包），版本尽量与 maven 引入的 lite 版本保持一致<br> <img src="https://images2.imgbox.com/e4/97/Xrt9Sehh_o.png" alt="在这里插入图片描述"><br>  </p> 
<p>2、解压，根据需要修改 conf/application.properties</p> 
<pre><code class="prism language-bash"><span class="token comment">#使用的端口</span>
<span class="token assign-left variable">server.port</span><span class="token operator">=</span><span class="token number">8088</span>

<span class="token comment">#账号、密码，root账号可修改配置，guest游客账号只能看、不能修改</span>
<span class="token assign-left variable">auth.root_username</span><span class="token operator">=</span>root
<span class="token assign-left variable">auth.root_password</span><span class="token operator">=</span>root
<span class="token assign-left variable">auth.guest_username</span><span class="token operator">=</span>guest
<span class="token assign-left variable">auth.guest_password</span><span class="token operator">=</span>guest

<span class="token comment">#事件追踪数据源配置，这个不是必需的，数据库连接后续可以在web界面配置</span>
<span class="token comment">#配置了elastic job会自动创建几张表，用于记录任务执行的历史记录、结果、总结摘要，便于分析，建议配上</span>
<span class="token comment">#默认值引入了h2、postgresql的数据库驱动，如果要配置为mysql等其它数据库，可以把对应的驱动jar包放到 ext-lib目录下</span>
spring.datasource.default.driver-class-name<span class="token operator">=</span>com.mysql.cj.jdbc.Driver
<span class="token assign-left variable">spring.datasource.default.url</span><span class="token operator">=</span>jdbc:mysql://localhost:3306/mall?serverTimezone<span class="token operator">=</span>UTC
<span class="token assign-left variable">spring.datasource.default.username</span><span class="token operator">=</span>root
<span class="token assign-left variable">spring.datasource.default.password</span><span class="token operator">=</span>root
spring.jpa.show-sql<span class="token operator">=</span>false
</code></pre> 
<p> </p> 
<p>3、执行bin下的start脚本启动应用，浏览器访问 127.0.0.1:8088，输入账号、密码</p> 
<p>4、添加注册中心，信息与yml配置的注册中心保持一致</p> 
<p> </p> 
<h5><a id="_402"></a>常见操作说明</h5> 
<p>1、状态</p> 
<ul><li>分片待调整：新的定时任务注册上去，尚未触发过即为此状态，到cron表达式指定周期时自动触发过1次，状态就正常了。</li><li>失效：暂时下线该定时任务，后续还可以上线。</li><li>终止：永久下线该定时任务，不能再上线。<br>  </li></ul> 
<p>2、分片总数、参数<br> 这些配置参数都可以从上下文中获取到，用于向定时任务传递额外的配置，均可以在web控制台进行配置</p> 
<pre><code class="prism language-yml"><span class="token comment">#自定义参数</span>
<span class="token key atrule">jobParameter</span><span class="token punctuation">:</span> xxx
<span class="token comment">#分片总数，此定时任务每次触发时使用几个分片来执行</span>
<span class="token key atrule">shardingTotalCount</span><span class="token punctuation">:</span> <span class="token number">3</span>
<span class="token comment">#自定义的分片参数，index=value，数量与分片总数保持一致</span>
<span class="token key atrule">shardingItemParameters</span><span class="token punctuation">:</span> 0=Beijing<span class="token punctuation">,</span>1=Shanghai<span class="token punctuation">,</span>2=Guangzhou
</code></pre> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MySimpleJob</span> <span class="token keyword">implements</span> <span class="token class-name">SimpleJob</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">ShardingContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//自定义参数</span>
        <span class="token class-name">String</span> jobParameter <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getJobParameter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//分片总数</span>
        <span class="token keyword">int</span> shardingTotalCount <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getShardingTotalCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//当前分片的index</span>
        <span class="token keyword">int</span> shardingItem <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getShardingItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//当前分片项对应的值</span>
        <span class="token class-name">String</span> shardingParameter <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getShardingParameter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//...</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/e5/ed/bJMcYDSB_o.png" alt="在这里插入图片描述"><br> 分片总数：指定该定时任务触发1次时，需要分配给几个副本执行。假设分片总数设置为3，定时任务所在服务</p> 
<ul><li>部署了5个实例，分片分散情况往往是 1+1+1 ，触发1次时这3个实例会分别执行1次；</li><li>部署了2个实例，分片分散情况往往时 1+2，触发1次时1个实例执行1次，另一个实例执行2个；</li><li>部署了1个实例，这个定时任务的所有分片都集中在这个实例上，触发1次时这个实例会执行3次；</li></ul> 
<p>分片总数通常设置为1，避免触发时重复执行。</p> 
<p> </p> 
<p>如果定时任务要处理的数据量级很大，可以将数据分配给多个分片共同处理，shardingItemParameters 指定分段（id分段、状态划分等），定时任务中判断当前分片对应的 shardingItemParameters，做相应处理</p> 
<pre><code class="prism language-yml"><span class="token key atrule">shardingTotalCount</span><span class="token punctuation">:</span> <span class="token number">3</span>
<span class="token key atrule">shardingItemParameters</span><span class="token punctuation">:</span> 0=待付款<span class="token punctuation">,</span>1=待发货<span class="token punctuation">,</span>2=待退款
</code></pre> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MySimpleJob</span> <span class="token keyword">implements</span> <span class="token class-name">SimpleJob</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">ShardingContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getShardingParameter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> <span class="token string">"待付款"</span><span class="token operator">:</span>
                <span class="token comment">//...</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">"待发货"</span><span class="token operator">:</span>
                <span class="token comment">//...</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">"待退款"</span><span class="token operator">:</span>
                <span class="token comment">//...</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p> </p> 
<h4><a id="xxljob_479"></a>xxl-job</h4> 
<p>官网：<a href="https://www.xuxueli.com/xxl-job" rel="nofollow">https://www.xuxueli.com/xxl-job</a><br> github：<a href="https://github.com/xuxueli/xxl-job">https://github.com/xuxueli/xxl-job</a><br>  </p> 
<h5><a id="web_484"></a>web控制台的部署</h5> 
<p>1、下载最新稳定版的压缩包，解压，在IDEA中导入</p> 
<p>父项目 xxl-job包含3个子项目</p> 
<ul><li>xxl-job-core：核心模块，提供公共依赖</li><li>xxl-job-admin：调度中心，提供web界面的控制台</li><li>xxl-job-executor-samples：执行器（定时任务）示例，不需要的可以删除这个模块。包含2个子项目，一个是springboot版本的示例，一个是frameless无框架版本的示例。<br>  </li></ul> 
<p>2、执行doc/db下的初始化sql脚本<br>  </p> 
<p>3、修改 xxl-job-admin 的配置文件</p> 
<ul><li>application.properties：根据需要调整应用使用的端口、访问路径、数据库配置、报警邮箱配置。邮箱配置可以不管，但不能注释掉。</li><li>logback.xml 日志配置</li></ul> 
<p>xxl-job-admin 集群部署时，各 xxl-job-admin 节点务必连接同一个mysql数据库、节点机器的时钟务必保持一致；如果 mysql 做主从，xxl-job-admin 各节点务必强制走主库。<br>  </p> 
<p>4、打包部署，访问 http://localhost:8080/xxl-job-admin 登录系统，默认账号密码 admin/123456<br>  </p> 
<p>5、初始化系统数据</p> 
<ul><li>在用户管理中修改密码、增删用户</li><li>在任务管理中删除示例任务</li><li>在执行器管理中增删、修改执行器</li></ul> 
<p> </p> 
<h5><a id="_513"></a>编写定时任务</h5> 
<p>从springboot版本的示例中copy所需内容</p> 
<p>1、添加依赖，最好与控制台的版本保持一致</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.xuxueli<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>xxl-job-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.3.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p> </p> 
<p>2、复制 application.properties 的相关配置项</p> 
<pre><code class="prism language-bash"><span class="token comment">### 调度中心部署根地址 [选填]：如调度中心集群部署存在多个地址则用逗号分隔。执行器将会使用该地址进行"执行器心跳注册"和"任务结果回调"；为空则关闭自动注册；</span>
<span class="token assign-left variable">xxl.job.admin.addresses</span><span class="token operator">=</span>http://127.0.0.1:8080/xxl-job-admin

<span class="token comment">### 执行器通讯TOKEN [选填]：非空时启用；</span>
<span class="token assign-left variable">xxl.job.accessToken</span><span class="token operator">=</span>

<span class="token comment">### 执行器AppName [选填]：执行器心跳注册分组依据；为空则关闭自动注册</span>
<span class="token assign-left variable">xxl.job.executor.appname</span><span class="token operator">=</span>xxl-job-executor-sample

<span class="token comment">### 执行器注册 [选填]：优先使用该配置作为注册地址，为空时使用内嵌服务 ”IP:PORT“ 作为注册地址。从而更灵活的支持容器类型执行器动态IP和动态映射端口问题。</span>
<span class="token assign-left variable">xxl.job.executor.address</span><span class="token operator">=</span>

<span class="token comment">### 执行器IP [选填]：默认为空表示自动获取IP，多网卡时可手动设置指定IP，该IP不会绑定Host仅作为通讯实用；地址信息用于 "执行器注册" 和 "调度中心请求并触发任务"；</span>
<span class="token assign-left variable">xxl.job.executor.ip</span><span class="token operator">=</span>

<span class="token comment">### 执行器端口号 [选填]：小于等于0则自动获取；默认端口为9999，单机部署多个执行器时，注意要配置不同执行器端口；</span>
<span class="token assign-left variable">xxl.job.executor.port</span><span class="token operator">=</span><span class="token number">9999</span>

<span class="token comment">### 执行器运行日志文件存储磁盘路径 [选填] ：需要对该路径拥有读写权限；为空则使用默认路径；</span>
<span class="token assign-left variable">xxl.job.executor.logpath</span><span class="token operator">=</span>/data/applogs/xxl-job/jobhandler

<span class="token comment">### 执行器日志文件保存天数 [选填] ： 过期日志自动清理, 限制值大于等于3时生效; 否则, 如-1, 关闭自动清理功能；</span>
<span class="token assign-left variable">xxl.job.executor.logretentiondays</span><span class="token operator">=</span><span class="token number">30</span>
</code></pre> 
<p> </p> 
<p>3、复制配置类</p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xxl<span class="token punctuation">.</span>job<span class="token punctuation">.</span>core<span class="token punctuation">.</span>executor<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span><span class="token class-name">XxlJobSpringExecutor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Value</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * xxl-job config
 *
 * @author xuxueli 2017-04-28
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">XxlJobConfig</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">XxlJobConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${xxl.job.admin.addresses}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> adminAddresses<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${xxl.job.accessToken}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> accessToken<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${xxl.job.executor.appname}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> appname<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${xxl.job.executor.address}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> address<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${xxl.job.executor.ip}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> ip<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${xxl.job.executor.port}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> port<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${xxl.job.executor.logpath}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> logPath<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${xxl.job.executor.logretentiondays}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> logRetentionDays<span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">XxlJobSpringExecutor</span> <span class="token function">xxlJobExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job config init."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">XxlJobSpringExecutor</span> xxlJobSpringExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XxlJobSpringExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        xxlJobSpringExecutor<span class="token punctuation">.</span><span class="token function">setAdminAddresses</span><span class="token punctuation">(</span>adminAddresses<span class="token punctuation">)</span><span class="token punctuation">;</span>
        xxlJobSpringExecutor<span class="token punctuation">.</span><span class="token function">setAppname</span><span class="token punctuation">(</span>appname<span class="token punctuation">)</span><span class="token punctuation">;</span>
        xxlJobSpringExecutor<span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
        xxlJobSpringExecutor<span class="token punctuation">.</span><span class="token function">setIp</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
        xxlJobSpringExecutor<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
        xxlJobSpringExecutor<span class="token punctuation">.</span><span class="token function">setAccessToken</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
        xxlJobSpringExecutor<span class="token punctuation">.</span><span class="token function">setLogPath</span><span class="token punctuation">(</span>logPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        xxlJobSpringExecutor<span class="token punctuation">.</span><span class="token function">setLogRetentionDays</span><span class="token punctuation">(</span>logRetentionDays<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> xxlJobSpringExecutor<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 针对多网卡、容器内部署等情况，可借助 "spring-cloud-commons" 提供的 "InetUtils" 组件灵活定制注册IP；
     *
     *      1、引入依赖：
     *          &lt;dependency&gt;
     *             &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
     *             &lt;artifactId&gt;spring-cloud-commons&lt;/artifactId&gt;
     *             &lt;version&gt;${version}&lt;/version&gt;
     *         &lt;/dependency&gt;
     *
     *      2、配置文件，或者容器启动变量
     *          spring.cloud.inetutils.preferred-networks: 'xxx.xxx.xxx.'
     *
     *      3、获取IP
     *          String ip_ = inetUtils.findFirstNonLoopbackHostInfo().getIpAddress();
     */</span>


<span class="token punctuation">}</span>
</code></pre> 
<p> <br> 4、仿照 service.jobhandler.SampleXxlJob 写定时任务</p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xxl<span class="token punctuation">.</span>job<span class="token punctuation">.</span>core<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">XxlJobHelper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xxl<span class="token punctuation">.</span>job<span class="token punctuation">.</span>core<span class="token punctuation">.</span>handler<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">XxlJob</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>  <span class="token comment">//放到容器中</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">XxxJob</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 简单任务示例
     */</span>
    <span class="token annotation punctuation">@XxlJob</span><span class="token punctuation">(</span><span class="token string">"sampleJobHandler"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sampleJobHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//执行日志：需要通过 "XxlJobHelper.log" 打印执行日志；</span>
        <span class="token class-name">XxlJobHelper</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"sampleJobHandler start"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//可通过 XxlJobHelper.handleFail()/handleSuccess() 指定任务执行结果，未设置时默认默认为 handleSuccess() 成功</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">XxlJobHelper</span><span class="token punctuation">.</span><span class="token function">handleFail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 分片广播任务示例
     */</span>
    <span class="token annotation punctuation">@XxlJob</span><span class="token punctuation">(</span><span class="token string">"shardingJobHandler"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shardingJobHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 分片参数</span>
        <span class="token keyword">int</span> shardIndex <span class="token operator">=</span> <span class="token class-name">XxlJobHelper</span><span class="token punctuation">.</span><span class="token function">getShardIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> shardTotal <span class="token operator">=</span> <span class="token class-name">XxlJobHelper</span><span class="token punctuation">.</span><span class="token function">getShardTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">XxlJobHelper</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"分片参数：当前分片序号 = {}, 总分片数 = {}"</span><span class="token punctuation">,</span> shardIndex<span class="token punctuation">,</span> shardTotal<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//...</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p> </p> 
<p>5、启动应用，调度中心 -&gt; 任务管理 -&gt; 增删、修改任务实例</p> 
<p><img src="https://images2.imgbox.com/10/d7/w7s6uXB5_o.png" alt="在这里插入图片描述"><br> 运行模式使用 BEAN，JobHandler 与 @XxlJob 指定的 jobName 保持一致。</p> 
<p> </p> 
<h5><a id="_683"></a>策略说明</h5> 
<p>执行器集群部署时，调度中心支持的路由策略如下</p> 
<ul><li>ROUND（轮询）</li><li>FIRST（第一个）：固定选择第一个节点</li><li>LAST（最后一个）：固定选择最后一个节点</li><li>RANDOM（随机）：随机选择在线的节点</li><li>CONSISTENT_HASH（一致性HASH）：每个任务按照Hash算法固定选择某个节点，且所有任务均匀散列在不同节点上。</li><li>LEAST_FREQUENTLY_USED（最不经常使用）：优先选择使用频率最低的节点。</li><li>LEAST_RECENTLY_USED（最近最久未使用）：优先选择最久未使用的节点。</li><li>FAILOVER（故障转移）：按照顺序依次进行心跳检测，第一个心跳检测成功的节点选定为目标执行器并发起调度。</li><li>BUSYOVER（忙碌转移）：按照顺序依次进行空闲检测，第一个空闲检测成功的节点选定为目标执行器并发起调度。</li><li>SHARDING_BROADCAST(分片广播)：广播触发对应集群中所有节点执行一次任务，同时系统自动传递分片参数；可根据分片参数开发分片任务。</li></ul> 
<p> </p> 
<p>调度过于密集，执行器来不及处理任务实例时，调度中心提供的阻塞处理策略如下</p> 
<ul><li>单机串行（默认）：调度请求进入单机执行器后，调度请求进入FIFO队列并以串行方式运行。</li><li>丢弃后续调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，本次请求将会被丢弃并标记为失败。</li><li>覆盖之前调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，将会终止运行中的调度任务并清空队列，然后运行本地调度任务。</li></ul> 
<p> </p> 
<h4><a id="_705"></a>分批处理数据</h4> 
<p>前提：id有序递增</p> 
<p>1、直接 limit 分页，where… order by id asc limit 1000<br> 数据量大时可能存在深分页性能问题。</p> 
<p>2、select min(id), max(id) where… 先查出待处理记录的id区间，再根据id分批处理 where… and id &gt; #{minId} and id &lt; #{minId} + 1000。<br> 由于物理删除记录、使用雪花算法等非自增id，id可能是不连续的、存在很大的跳跃，难以确定每批次处理的记录数，可能出现大量无效批次。</p> 
<p>3、起始id + limit，where id &gt; #{startId} order by id asc limit 1000，推荐。示例</p> 
<pre><code class="prism language-java"><span class="token keyword">final</span> <span class="token keyword">int</span> limitSize <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>
<span class="token keyword">long</span> startId <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//查询需要处理的记录</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserPo</span><span class="token punctuation">&gt;</span></span> userPos <span class="token operator">=</span> userDao<span class="token punctuation">.</span><span class="token function">listByQo</span><span class="token punctuation">(</span><span class="token class-name">GoldCardQuery</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">startId</span><span class="token punctuation">(</span>startId<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">"id asc"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">limitSize</span><span class="token punctuation">(</span>limitSize<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//批量处理</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">UserPo</span> userPo <span class="token operator">:</span> userPos<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//...</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"xxx执行异常，userPo={}"</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>userPo<span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//判断循环条件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>userPos<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> limitSize<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    startId <span class="token operator">=</span> userPos<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>userPos<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f0c07406a6b7bb9dcbbc6773eacb88f8/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">小知识(6) el-table表格选中行和回显行（vue3）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/49b94d2a2237f228b1964037ca8d9f22/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">spring cache (ehcache方式)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>