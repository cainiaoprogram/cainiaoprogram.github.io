<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux应用编程---8.共享内存 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Linux应用编程---8.共享内存" />
<meta property="og:description" content="Linux应用编程—8.共享内存 ​ 共享内存是进程之间通讯的方式。大概原理是先申请一块共享内存，然后通过“映射”，映射到进程中。进程中读写这块被映射过来的内存，共享内存也会随之改变，同理其它进程也能做相同的操作。所以，两个不同的进程通过共享内存实现了通讯。
8.1 创建共享内存 ​ 创建共享内存，使用到的库函数是：shmget(),是：share memory get的缩写。在Linux编程手册中查看这个函数。
NAME shmget - allocates a System V shared memory segment SYNOPSIS #include &lt;sys/ipc.h&gt; #include &lt;sys/shm.h&gt; int shmget(key_t key, size_t size, int shmflg); ​ shmge()函数，用来分配一个“System v”的共享内存段。使用时需要包含头文件：sys/ipc.h与sys/shm.h。函数原型是：int shmget(key_t key, size_t size, int shmflg);需要传入3个参数，返回值是int类型的。
DESCRIPTION shmget() returns the identifier of the System V shared memory segment associated with the value of the argument key. It may be used either to obtain the identifier of a previously created shared memory segment(when shmflg is zero and key does not have the value IPC_PRIVATE), or to create a new set." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/de5678f3860bf0b88f1b72368a051803/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-01-08T17:04:03+08:00" />
<meta property="article:modified_time" content="2023-01-08T17:04:03+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux应用编程---8.共享内存</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Linux8_0"></a>Linux应用编程—8.共享内存</h2> 
<p>​ 共享内存是进程之间通讯的方式。大概原理是先申请一块共享内存，然后通过“映射”，映射到进程中。进程中读写这块被映射过来的内存，共享内存也会随之改变，同理其它进程也能做相同的操作。所以，两个不同的进程通过共享内存实现了通讯。</p> 
<h3><a id="81__4"></a>8.1 创建共享内存</h3> 
<p>​ 创建共享内存，使用到的库函数是：shmget(),是：share memory get的缩写。在Linux编程手册中查看这个函数。</p> 
<pre><code class="prism language-c">NAME
       shmget <span class="token operator">-</span> allocates a System V shared memory segment

SYNOPSIS
       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/shm.h&gt;</span></span>

       <span class="token keyword">int</span> <span class="token function">shmget</span><span class="token punctuation">(</span><span class="token class-name">key_t</span> key<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">,</span> <span class="token keyword">int</span> shmflg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>​ shmge()函数，用来分配一个“System v”的共享内存段。使用时需要包含头文件：sys/ipc.h与sys/shm.h。函数原型是：int shmget(key_t key, size_t size, int shmflg);需要传入3个参数，返回值是int类型的。</p> 
<pre><code class="prism language-c">DESCRIPTION
<span class="token function">shmget</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  returns  the identifier of the System V shared memory segment associated with the value of the argument key<span class="token punctuation">.</span>  It may be  used  either to  obtain the identifier of a previously created shared memory <span class="token function">segment</span><span class="token punctuation">(</span>when shmflg is zero and key does not have the value  IPC_PRIVATE<span class="token punctuation">)</span><span class="token punctuation">,</span> or to create a new set<span class="token punctuation">.</span>
</code></pre> 
<p>​ shmget()函数返回与参数key的值相关联的System v共享内存段的标识符。它即可用于获取先前创建的共享内存段的标识符，当shmflg为0且key没有值IPC_PRIVATE时，也可以用于创建一个新的共享内存段。</p> 
<pre><code class="prism language-c">A  new  shared  memory  segment<span class="token punctuation">,</span>  with  size equal to the value of size rounded up to a multiple of PAGE_SIZE<span class="token punctuation">,</span> is created <span class="token keyword">if</span> key has the  value IPC_PRIVATE  or  key isn't IPC_PRIVATE<span class="token punctuation">,</span> no shared memory segment corre‐sponding to key exists<span class="token punctuation">,</span> and IPC_CREAT is specified in shmflg<span class="token punctuation">.</span>
</code></pre> 
<p>​ 如果key的值为IPC_PRIVATE或key不是IPC_PRIVATE，不存在与key对应的共享内存段，并且在shmflg中指定了IPC_CREAT，则创建一个新的共享内存段，其大小等于size的值的四舍五入到PAGE_SIZE的整数倍。</p> 
<pre><code class="prism language-c">If shmflg specifies both IPC_CREAT and IPC_EXCL  and  a  shared  memory segment  already  exists <span class="token keyword">for</span> key<span class="token punctuation">,</span> then <span class="token function">shmget</span><span class="token punctuation">(</span><span class="token punctuation">)</span> fails with errno set to EEXIST<span class="token punctuation">.</span>  <span class="token punctuation">(</span>This is analogous to the effect of the combination O_CREAT <span class="token operator">|</span> O_EXCL <span class="token keyword">for</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
</code></pre> 
<p>​ 如果shmflg同时指定了IPC_CREAT和IPC_EXCL，并且key的共享内存段已经存在，那么shmget()将失败，errno设置为EEXIST。(这类似于open(2)的组合O_CREAT | O_EXCL的效果。)</p> 
<p>​ shmflg的取值可以是以下几种：</p> 
<pre><code class="prism language-c">IPC_CREAT   Create  a  new  segment<span class="token punctuation">.</span>   If  this  flag is not used<span class="token punctuation">,</span> then <span class="token function">shmget</span><span class="token punctuation">(</span><span class="token punctuation">)</span> will find the  segment  associated  with  key  and check  to see <span class="token keyword">if</span> the user has permission to access the segment<span class="token punctuation">.</span>
IPC_EXCL    This flag is used with IPC_CREAT to ensure that  this  call creates  the  segment<span class="token punctuation">.</span>   If the segment already exists<span class="token punctuation">,</span> the call fails<span class="token punctuation">.</span>
<span class="token function">SHM_HUGETLB</span>  <span class="token punctuation">(</span>since Linux <span class="token number">2.6</span><span class="token punctuation">)</span> Allocate the segment using <span class="token string">"huge  pages."</span>   See  the  Linux kernel  source  file  Documentation<span class="token operator">/</span>admin<span class="token operator">-</span>guide<span class="token operator">/</span>mm<span class="token operator">/</span>hugetlbpage<span class="token punctuation">.</span>rst <span class="token keyword">for</span> further information<span class="token punctuation">.</span>
</code></pre> 
<p>​ 创建一个新的段。如果没有使用此标志，那么shmget()将查找与key相关联的段并检查用户是否有访问该段的权限。此标志与IPC_CREAT一起使用，以确保该调用创建了段。如果该段已经存在，则调用失败。使用“大页面”分配段。参见Linux内核源文件Documentation/admin-guide/mm/hugetlbpage。RST查询进一步信息。</p> 
<p>​ shmget()函数返回值：</p> 
<pre><code class="prism language-c">RETURN VALUE
On success<span class="token punctuation">,</span> a valid shared memory identifier is returned<span class="token punctuation">.</span>  On error<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span> is returned<span class="token punctuation">,</span> and errno is set to indicate the error<span class="token punctuation">.</span>
</code></pre> 
<p>​ 函数调用成功，返回一个有效的共享内存标识符，失败则返回-1。</p> 
<h3><a id="82_shmatshmdt_59"></a>8.2 shmat()、shmdt()函数详情</h3> 
<pre><code class="prism language-c">NAME
       shmat<span class="token punctuation">,</span> shmdt <span class="token operator">-</span> System V shared memory operations
SYNOPSIS
       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/shm.h&gt;</span></span>

       <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">shmat</span><span class="token punctuation">(</span><span class="token keyword">int</span> shmid<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>shmaddr<span class="token punctuation">,</span> <span class="token keyword">int</span> shmflg<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token keyword">int</span> <span class="token function">shmdt</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>shmaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">shmat</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
       <span class="token function">shmat</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  attaches the System V shared memory segment identified by shmid to
       the address space of the calling process<span class="token punctuation">.</span>  The attaching address is  speci‐
       fied by shmaddr with one of the following criteria<span class="token operator">:</span>

       <span class="token operator">*</span>  If  shmaddr is <span class="token constant">NULL</span><span class="token punctuation">,</span> the system chooses a <span class="token function">suitable</span> <span class="token punctuation">(</span>unused<span class="token punctuation">)</span> page<span class="token operator">-</span>aligned
          address to attach the segment<span class="token punctuation">.</span>

       <span class="token operator">*</span>  If shmaddr isn't <span class="token constant">NULL</span> and SHM_RND is specified in shmflg<span class="token punctuation">,</span> the attach oc‐
          curs  at the address equal to shmaddr rounded down to the nearest multi‐
          ple of SHMLBA<span class="token punctuation">.</span>

       <span class="token operator">*</span>  Otherwise<span class="token punctuation">,</span> shmaddr must be a page<span class="token operator">-</span>aligned address at  which  the  attach
          occurs<span class="token punctuation">.</span>

       In  addition to SHM_RND<span class="token punctuation">,</span> the following flags may be specified in the shmflg
       bit<span class="token operator">-</span>mask argument<span class="token operator">:</span>
</code></pre> 
<p>​ shmat()函数与shmdt()函数是对System v下的共享内存的操作。</p> 
<p>​ shmat()函数：</p> 
<pre><code class="prism language-c"><span class="token function">shmat</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  attaches the System V shared memory segment identified by shmid to the address space of the calling process<span class="token punctuation">.</span>  The attaching address is  specified by shmaddr with one of the following criteria<span class="token operator">:</span>
If  shmaddr is <span class="token constant">NULL</span><span class="token punctuation">,</span> the system chooses a <span class="token function">suitable</span> <span class="token punctuation">(</span>unused<span class="token punctuation">)</span> page<span class="token operator">-</span>aligned address to attach the segment<span class="token punctuation">.</span>If shmaddr isn't <span class="token constant">NULL</span> and SHM_RND is specified in shmflg<span class="token punctuation">,</span> the attach occurs  at the address equal to shmaddr rounded down to the nearest multiple of SHMLBA<span class="token punctuation">.</span> Otherwise<span class="token punctuation">,</span> shmaddr must be a page<span class="token operator">-</span>aligned address at  which  the  attachoccurs<span class="token punctuation">.</span>

</code></pre> 
<p>​ 该函数通过shmid标识的System v下的共享内存段附加到调用进程的地址空间。附加地址由shmadr指定，使用以下条件之一：如果shmaddr地址为空，系统选择一个合适的页对其地址附加到段。如果地址不为空并且shmflg标志位被指定，则在等于shmaddr四舍五入到SHMLBA最接近倍数的地址处进行附加。否则，shmaddr地址必须是一个与页面对其的地址，在该地址上执行附加操作。</p> 
<p>​ shmat()函数返回值：</p> 
<pre><code class="prism language-c">On success<span class="token punctuation">,</span> <span class="token function">shmat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> returns the address of the attached shared memory  segment<span class="token punctuation">;</span>  on  error<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token number">1</span> is returned<span class="token punctuation">,</span> and errno is set to indicate the cause of the error<span class="token punctuation">.</span>
</code></pre> 
<p>​ 函数调用成功，返回附加共享内存段的首地址，失败，则返回-1.</p> 
<p>​ shmdt()函数：</p> 
<pre><code class="prism language-c"><span class="token function">shmdt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> detaches the shared memory segment located at the address specified
       by shmaddr from the address space of the calling  process<span class="token punctuation">.</span>   The  to<span class="token operator">-</span>be<span class="token operator">-</span>de‐
       tached  segment  must be currently attached with shmaddr equal to the value
       returned by the attaching <span class="token function">shmat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> call<span class="token punctuation">.</span>

       On a successful <span class="token function">shmdt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  call<span class="token punctuation">,</span>  the  system  updates  the  members  of  the
       shmid_ds structure associated with the shared memory segment as follows<span class="token operator">:</span>

              shm_dtime is set to the current time<span class="token punctuation">.</span>

              shm_lpid is set to the process<span class="token operator">-</span>ID of the calling process<span class="token punctuation">.</span>

              shm_nattch  is  decremented by one<span class="token punctuation">.</span>  If it becomes <span class="token number">0</span> and the segment
              is marked <span class="token keyword">for</span> deletion<span class="token punctuation">,</span> the segment is deleted<span class="token punctuation">.</span>
</code></pre> 
<p>​ shmdt()用来断开当前进程与共享内存的连接。分Shmdt()离位于指定地址的共享内存段通过shmaddr从调用进程的地址空间。限于检测所连接的段当前必须附加shmadr等于该值由附加的shmat()调用返回。在成功调用shmdt()时，系统更新Shmid_ds结构与共享内存段关联如下:Shm_dtime设置为当前时间。shm_lpid设置为调用进程的进程id。Shm_nattch减1。如果它变成0，这个线段标记为删除，则删除该段。</p> 
<p>​ shmdt()函数返回值：</p> 
<pre><code class="prism language-c">On success<span class="token punctuation">,</span> <span class="token function">shmdt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> returns <span class="token number">0</span><span class="token punctuation">;</span> on error <span class="token operator">-</span><span class="token number">1</span> is returned<span class="token punctuation">,</span> and errno is set to
       indicate the cause of the error<span class="token punctuation">.</span>
</code></pre> 
<p>​ 函数调用成功，返回0，失败，则返回-1.</p> 
<h3><a id="82__140"></a>8.2 使用共享内存在父子进程之间进行通讯</h3> 
<p>​ 父进程往共享内存映射到自己进程中的内存写入一串字符串，子进程访问共享内存映射到自己进程中的内存，将该字符串打印出来。</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/shm.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token keyword">char</span> msg<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"I love VAE!"</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
        <span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>
        <span class="token keyword">int</span> shmid<span class="token punctuation">;</span>

        shmid <span class="token operator">=</span> <span class="token function">shmget</span><span class="token punctuation">(</span>IPC_PRIVATE<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span> IPC_CREAT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> shmid<span class="token punctuation">)</span>
                <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"shmget"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>			<span class="token comment">// Parent process</span>
        <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">char</span> <span class="token operator">*</span> p_addr<span class="token punctuation">;</span>

                p_addr <span class="token operator">=</span> <span class="token function">shmat</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token function">memset</span><span class="token punctuation">(</span>p_addr<span class="token punctuation">,</span> <span class="token char">'\0'</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">memcpy</span><span class="token punctuation">(</span>p_addr<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token function">shmdt</span><span class="token punctuation">(</span>p_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token function">waitpid</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">char</span> <span class="token operator">*</span> c_addr<span class="token punctuation">;</span>

                c_addr <span class="token operator">=</span> <span class="token function">shmat</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Waits 3 seconds:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Data from parent process by shm is %s.\n"</span><span class="token punctuation">,</span> c_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
                <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>​ 运行结果：</p> 
<pre><code class="prism language-c">root@ubuntu<span class="token operator">:</span><span class="token operator">/</span>home<span class="token operator">/</span>sgk<span class="token operator">/</span>Documents<span class="token operator">/</span>Linux_Program<span class="token operator">/</span>shared_memory# gcc shared_memory_0<span class="token punctuation">.</span>c 
root@ubuntu<span class="token operator">:</span><span class="token operator">/</span>home<span class="token operator">/</span>sgk<span class="token operator">/</span>Documents<span class="token operator">/</span>Linux_Program<span class="token operator">/</span>shared_memory# <span class="token punctuation">.</span><span class="token operator">/</span>a<span class="token punctuation">.</span>out
Waits <span class="token number">3</span> seconds<span class="token operator">:</span>
Data from parent process by shm is I love VAE<span class="token operator">!</span><span class="token punctuation">.</span>
</code></pre> 
<h3><a id="83__209"></a>8.3 共享内存用于非亲缘关系进程之间通讯</h3> 
<p>​ 共享内存创建函数shmget()的原型是：int shmget(key_t key, size_t size, int shmflag),其中参数key的值是相关联的System v共享内存段的标识符。如果已经创建了key值对应的共享内存段它们则对应了起来。非亲缘关系的进程之间通过共享内存通讯，最重要的一点是：这个共享内存段的标识符是相同的 ！！！</p> 
<p>​ 建立两个.c文件，分别是：write_shm.c与read_shm.c，在write_shm.c中，使用shmget()创建一个指定key值的共享内存段，然后使用函数shmat()与进程建立连接，并得到该进程下被映射内存的首地址，然后写入数据，最后调用shmdt()断开与共享内存的连接。在read_shm.c中，先同样使用shmget()函数创建共享内存，但是此时传入的key值是之前已经创建好的key值，如果该键值对应的共享内存段已经存在，则联系到一起。同样调用shmat()函数将该key值下的共享内存段映射到本进程，读取出里面的数据并打印，最后使用shmdt()断开共享内存连接。</p> 
<p>​ write_shm.c：</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/shm.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_0</span> <span class="token expression"><span class="token number">0514</span></span></span>

<span class="token keyword">char</span> msg<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"I love vae!"</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> shmid<span class="token punctuation">;</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>p1_addr<span class="token punctuation">;</span>

        shmid <span class="token operator">=</span> <span class="token function">shmget</span><span class="token punctuation">(</span>KEY_0<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span> IPC_CREAT<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> shmid<span class="token punctuation">)</span>
                <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"shmget."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        p1_addr <span class="token operator">=</span> <span class="token function">shmat</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">memset</span><span class="token punctuation">(</span>p1_addr<span class="token punctuation">,</span> <span class="token char">'\0'</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>p1_addr<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Wrote data to shared memory done.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">shmdt</span><span class="token punctuation">(</span>p1_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>​ read_shm.c：</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/shm.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_0</span> <span class="token expression"><span class="token number">0514</span></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> shmid<span class="token punctuation">;</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>p2_addr<span class="token punctuation">;</span>

        shmid <span class="token operator">=</span> <span class="token function">shmget</span><span class="token punctuation">(</span>KEY_0<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span> IPC_CREAT<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> shmid<span class="token punctuation">)</span>
                <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"shmget."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        p2_addr <span class="token operator">=</span> <span class="token function">shmat</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Shared memory's data is: %s\n"</span><span class="token punctuation">,</span> p2_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">shmdt</span><span class="token punctuation">(</span>p2_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>​ 分别编译出可执行文件read与write。</p> 
<p>​ 运行结果：</p> 
<p><img src="https://images2.imgbox.com/f1/5d/7FJcdP4m_o.png" alt="image-20221127104824504"></p> 
<center>
  图1 运行结果 
 <center> 
 </center> 
</center> 
<p>​ 如果共享内存的标识符KEY_0不相同，将write_shm.c中的KEY_0保持0514，将read_shm.c中的KEY_0改写为0528。运行结果如下：</p> 
<p><img src="https://images2.imgbox.com/f3/71/2yo7kYel_o.png" alt="image-20221127105537131"></p> 
<center>
  图2 运行结果 
 <center> 
 </center> 
</center> 
<p>​ 根据结果可知：这两个进程通讯失败。如果共享内存标识符不同，内核分别在两个进程下创建了新的共享内存。</p> 
<h3><a id="84_shmctl_299"></a>8.4 shmctl()函数详情</h3> 
<pre><code>	查看Linux编程手册下关于shmctl()函数定义与使用方法。
</code></pre> 
<pre><code class="prism language-c">NAME
       shmctl <span class="token operator">-</span> System V shared memory control

SYNOPSIS
       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/shm.h&gt;</span></span>

       <span class="token keyword">int</span> <span class="token function">shmctl</span><span class="token punctuation">(</span><span class="token keyword">int</span> shmid<span class="token punctuation">,</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">shmid_ds</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>​ shmctl()控制System v共享内存段。需要包含两个头文件，函数原型是：int shmctl(int shmid, int cmd, struct shmid_ds *buf);</p> 
<pre><code class="prism language-c">DESCRIPTION
<span class="token function">shmctl</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  performs  the control operation specified by cmd on the System V shared memory segment whose identifier is given in shmid<span class="token punctuation">.</span>
</code></pre> 
<p>​ shmctl()函数在shmid中给出标识符的System v共享内存段上执行由cmd指定的控制操作。</p> 
<p>​ cmd有效参数如下：</p> 
<pre><code class="prism language-c">Valid values <span class="token keyword">for</span> cmd are<span class="token operator">:</span>

       IPC_STAT  Copy information from the kernel data  structure  associated
                 with  shmid  into  the shmid_ds structure pointed to by buf<span class="token punctuation">.</span>
                 The caller must have read permission on  the  shared  memory
                 segment<span class="token punctuation">.</span>

       IPC_SET   Write  the  values of some members of the shmid_ds structure
                 pointed to by buf to the kernel  data  structure  associated
                 with this shared memory segment<span class="token punctuation">,</span> updating also its shm_ctime
                 member<span class="token punctuation">.</span>  The following fields can be changed<span class="token operator">:</span>  shm_perm<span class="token punctuation">.</span>uid<span class="token punctuation">,</span>
                 shm_perm<span class="token punctuation">.</span>gid<span class="token punctuation">,</span>   <span class="token function">and</span>   <span class="token punctuation">(</span>the  least  significant  <span class="token number">9</span>  bits  of<span class="token punctuation">)</span>
                 shm_perm<span class="token punctuation">.</span>mode<span class="token punctuation">.</span>  The effective UID  of  the  calling  process
                 must    match    the   <span class="token function">owner</span>   <span class="token punctuation">(</span>shm_perm<span class="token punctuation">.</span>uid<span class="token punctuation">)</span>   or   <span class="token function">creator</span>
                 <span class="token punctuation">(</span>shm_perm<span class="token punctuation">.</span>cuid<span class="token punctuation">)</span> of the shared memory segment<span class="token punctuation">,</span> or the  caller
                 must be privileged<span class="token punctuation">.</span>

       IPC_RMID  Mark the segment to be destroyed<span class="token punctuation">.</span>  The segment will actually
                 be destroyed only after the last process detaches <span class="token function">it</span>  <span class="token punctuation">(</span>i<span class="token punctuation">.</span>e<span class="token punctuation">.</span><span class="token punctuation">,</span>
                 when  the  shm_nattch  member  of  the  associated structure
                 shmid_ds is zero<span class="token punctuation">)</span><span class="token punctuation">.</span>  The caller must be the owner or  creator
                 of  the  segment<span class="token punctuation">,</span> or be privileged<span class="token punctuation">.</span>  The buf argument is ig‐
                 nored<span class="token punctuation">.</span>

                 If a segment has been marked <span class="token keyword">for</span> destruction<span class="token punctuation">,</span> then <span class="token function">the</span> <span class="token punctuation">(</span>non‐
                 standard<span class="token punctuation">)</span>  SHM_DEST  flag  of the shm_perm<span class="token punctuation">.</span>mode field in the
                 associated data structure retrieved by IPC_STAT will be set<span class="token punctuation">.</span>

                 The caller must ensure that  a  segment  is  eventually  de‐
                 stroyed<span class="token punctuation">;</span>  otherwise  its pages that were faulted in will re‐
                 main in memory or swap<span class="token punctuation">.</span>

                 See also the description of <span class="token operator">/</span>proc<span class="token operator">/</span>sys<span class="token operator">/</span>kernel<span class="token operator">/</span>shm_rmid_forced
                 in <span class="token function">proc</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
</code></pre> 
<p>​ cmd的有效值为:</p> 
<p>IPC_STAT从相关的内核数据结构中复制信息将shmid放入buf所指向的shmid_ds结构中。调用者必须对共享内存具有读权限段。</p> 
<p>写shmid_ds结构的一些成员的值由buf指向相关的内核数据结构使用这个共享内存段，也更新它的shm_ctime成员。以下字段可以更改:shm_perm.uid，shm_perm。Gid，和(最小有效9位)shm_perm.mode。调用进程的有效UID必须匹配所有者(shm_perm.uid)或创建者(shm_perm.cuid)的共享内存段，或调用者必须有特权。</p> 
<p>ipc_rmd标识要销毁的段。这部分实际上只有在最后一个进程分离它(即，当关联结构的shm_nattch成员Shmid_ds为零)。调用者必须是所有者或创建者的部分，或享有特权。buf的论点很重要也没有。</p> 
<p>如果一段已被标记为要销毁，则(非‐shm_perm的SHM_DEST标志。的模式字段将设置由IPC_STAT检索的关联数据结构。</p> 
<p>呼叫者必须确保一个区段最终被解除毁掉了;否则，有错误的页面将重新制作主内存或交换区。</p> 
<p>参见/proc/sys/kernel/shm_rmid_forced的描述在proc(5)。</p> 
<p>​ 修改write_shm.c代码，在写结束后，使用shmctl()函数，使用IPC_RMID指令销毁，查看效果。</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/shm.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_0</span> <span class="token expression"><span class="token number">0514</span></span></span>

<span class="token keyword">char</span> msg<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"I love vae!"</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> shmid<span class="token punctuation">;</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>p1_addr<span class="token punctuation">;</span>

        shmid <span class="token operator">=</span> <span class="token function">shmget</span><span class="token punctuation">(</span>KEY_0<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span> IPC_CREAT<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> shmid<span class="token punctuation">)</span>
                <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"shmget."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        p1_addr <span class="token operator">=</span> <span class="token function">shmat</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">memset</span><span class="token punctuation">(</span>p1_addr<span class="token punctuation">,</span> <span class="token char">'\0'</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>p1_addr<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Wrote data to shared memory done.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">shmdt</span><span class="token punctuation">(</span>p1_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">shmctl</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span> IPC_RMID<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>​ 分别编译出可执行文件：read与write，然后执行。</p> 
<p>运行结果：</p> 
<p><img src="https://images2.imgbox.com/84/86/iauYykNI_o.png" alt="image-20221127112006397"></p> 
<center>
  图3 运行结果 
 <center> 
 </center> 
</center> 
<p>​ 当调用shmctl()销毁共享内存段后，是彻底销毁了。其它进程读取失败。</p> 
<h3><a id="85__424"></a>8.5 总结</h3> 
<p>​ 共享内存是进程之间通讯的方式之一，建立共享内存大概分为几步：(1)使用shmget()创建共享内存段；(2)使用shmat()将共享内存段与当前进程绑定；(3)使用shmdt()函数将共享内存与进程断开连接；(4)如需彻底销毁共享内存段，调用shmctl(),传入IPC_RMID。<br> <img src="https://images2.imgbox.com/8d/44/hCRw5c4G_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/36d55934da4880366255e4628ef78e6f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">C#文件操作集合四（文件复制和移动）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d126ea062aafa4232b1d0b3aa0f8497e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Java 解决 ERROR StatusLogger No log4j2 configuration file found 异常</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>