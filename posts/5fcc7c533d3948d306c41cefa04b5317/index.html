<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>mediasoup-demo server源码分析 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="mediasoup-demo server源码分析" />
<meta property="og:description" content="mediasoup-demo server源码分析 0. 目录 mediasoup-demo是什么？mediasoup-demo代码结构mediasoup-demo server代码分析 config.js代码解析server.js主要逻辑Room.js具体代码解析 相关文章：
mediasoup基本介绍及Ubuntu/Docker环境下部署mediasoupmediasoup-demo server源码分析 1. mediasoup-demo是什么？ mediasoup-demo是一个使用mediasoup库实现的视频会议应用程序的示例代码。mediasoup-demo示例应用程序提供了一个基于WebRTC的视频会议解决方案，包括房间管理、媒体流管理、网络传输和音视频编解码等功能，同时提供了前端和后端代码示例，方便进行学习和参考。其中mediasoup是一个开源的WebRTC信令和媒体服务器，用于构建实时音视频通信应用程序。
2. mediasoup-demo代码结构 mediasoup-demo代码结构图如下： 其中各目录或文件作用如下： 目录下一级目录或文件作用app客户端代码broadcasters广播，推流或者拉流server服务端Demoserver.js服务端Demo主程序config.js配置文件cert证书及秘钥connect.js对后面的interactiveClient.js文件进行封装libserver.js使用的库文件Logger.js打印日志Room.js房间管理及信令处理interactiveClient.js运行时内部信息查询客户端interactiveServer.js运行时内部信息查询服务端 重点关注server目录文件内容。
3. mediasoup-demo server代码分析 mediasoup-demo项目中server目录实现了视频会议应用程序的后端功能，包括与mediasoup的集成、WebSocket通信、房间管理、日志记录等功能。 1. config.js代码解析 config.js是配置文件，用于定义mediasoup的配置和服务器的端口等参数。配置文件如下： /** * IMPORTANT (PLEASE READ THIS): * * This is not the &#34;configuration file&#34; of mediasoup. This is the configuration * file of the mediasoup-demo app. mediasoup itself is a server-side library, it * does not read any &#34;configuration file&#34;. Instead it exposes an API." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/5fcc7c533d3948d306c41cefa04b5317/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-27T00:44:02+08:00" />
<meta property="article:modified_time" content="2023-09-27T00:44:02+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">mediasoup-demo server源码分析</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="mediasoupdemo_server_0"></a>mediasoup-demo server源码分析</h2> 
<h3><a id="0__1"></a>0. 目录</h3> 
<ol><li>mediasoup-demo是什么？</li><li>mediasoup-demo代码结构</li><li>mediasoup-demo server代码分析 
  <ol><li>config.js代码解析</li><li>server.js主要逻辑</li><li>Room.js具体代码解析</li></ol> </li></ol> 
<blockquote> 
 <p>相关文章：</p> 
 <ol><li><a href="https://blog.csdn.net/weixin_41910694/article/details/129203264?spm=1001.2014.3001.5501">mediasoup基本介绍及Ubuntu/Docker环境下部署mediasoup</a></li><li><a href="" rel="nofollow">mediasoup-demo server源码分析</a></li></ol> 
</blockquote> 
<p></p> 
<h3><a id="1_mediasoupdemo_14"></a>1. mediasoup-demo是什么？</h3> 
<ol><li>mediasoup-demo是一个使用mediasoup库实现的视频会议应用程序的示例代码。</li><li>mediasoup-demo示例应用程序提供了一个基于WebRTC的视频会议解决方案，包括房间管理、媒体流管理、网络传输和音视频编解码等功能，同时提供了前端和后端代码示例，方便进行学习和参考。</li><li>其中mediasoup是一个开源的WebRTC信令和媒体服务器，用于构建实时音视频通信应用程序。<br> </li></ol> 
<h3><a id="2_mediasoupdemo_19"></a>2. mediasoup-demo代码结构</h3> 
<ol><li>mediasoup-demo代码结构图如下：</li></ol> 
<p><img src="https://images2.imgbox.com/fd/41/OZxIpKTL_o.png" alt="image.png" width="700"><br><img src="https://images2.imgbox.com/26/50/uP8fpxPb_o.png" alt="image.png"></p> 
<ol start="2"><li>其中各目录或文件作用如下：</li></ol> 
<table><thead><tr><th>目录</th><th>下一级目录或文件</th><th>作用</th></tr></thead><tbody><tr><td>app</td><td></td><td>客户端代码</td></tr><tr><td>broadcasters</td><td></td><td>广播，推流或者拉流</td></tr><tr><td>server</td><td></td><td>服务端Demo</td></tr><tr><td></td><td>server.js</td><td>服务端Demo主程序</td></tr><tr><td></td><td>config.js</td><td>配置文件</td></tr><tr><td></td><td>cert</td><td>证书及秘钥</td></tr><tr><td></td><td>connect.js</td><td>对后面的interactiveClient.js文件进行封装</td></tr><tr><td>lib</td><td></td><td>server.js使用的库文件</td></tr><tr><td></td><td>Logger.js</td><td>打印日志</td></tr><tr><td></td><td>Room.js</td><td>房间管理及信令处理</td></tr><tr><td></td><td>interactiveClient.js</td><td>运行时内部信息查询客户端</td></tr><tr><td></td><td>interactiveServer.js</td><td>运行时内部信息查询服务端</td></tr></tbody></table> 
<ol start="4"><li>重点关注server目录文件内容。<br> </li></ol> 
<h3><a id="3_mediasoupdemo_server_44"></a>3. mediasoup-demo server代码分析</h3> 
<ol><li>mediasoup-demo项目中server目录实现了视频会议应用程序的后端功能，包括与mediasoup的集成、WebSocket通信、房间管理、日志记录等功能。</li></ol> 
<p><img src="https://images2.imgbox.com/77/74/K4dsAtX3_o.png" alt="image.png"><br> </p> 
<h4><a id="1_configjs_50"></a>1. config.js代码解析</h4> 
<ol><li>config.js是配置文件，用于定义mediasoup的配置和服务器的端口等参数。</li><li>配置文件如下：</li></ol> 
<pre><code class="prism language-javascript"><span class="token comment">/**
 * IMPORTANT (PLEASE READ THIS):
 *
 * This is not the "configuration file" of mediasoup. This is the configuration
 * file of the mediasoup-demo app. mediasoup itself is a server-side library, it
 * does not read any "configuration file". Instead it exposes an API. This demo
 * application just reads settings from this file (once copied to config.js) and
 * calls the mediasoup API with those settings when appropriate.
 */</span>

<span class="token keyword">const</span> os <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">// Listening hostname (just for `gulp live` task).</span>
	<span class="token literal-property property">domain</span> <span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DOMAIN</span> <span class="token operator">||</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
	<span class="token comment">// Signaling settings (protoo WebSocket server and HTTP API server).</span>
	<span class="token literal-property property">https</span>  <span class="token operator">:</span> <span class="token comment">//</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token literal-property property">listenIp</span>   <span class="token operator">:</span> <span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span>
		<span class="token comment">// NOTE: Don't change listenPort (client app assumes 4443).</span>
		<span class="token literal-property property">listenPort</span> <span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PROTOO_LISTEN_PORT</span> <span class="token operator">||</span> <span class="token number">4443</span><span class="token punctuation">,</span>
		<span class="token comment">// NOTE: Set your own valid certificate files.</span>
		<span class="token literal-property property">tls</span>        <span class="token operator">:</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token literal-property property">cert</span> <span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">HTTPS_CERT_FULLCHAIN</span> <span class="token operator">||</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>__dirname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/certs/fullchain.pem</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
			<span class="token literal-property property">key</span>  <span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">HTTPS_CERT_PRIVKEY</span> <span class="token operator">||</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>__dirname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/certs/privkey.pem</span><span class="token template-punctuation string">`</span></span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token comment">// mediasoup settings.</span>
	<span class="token literal-property property">mediasoup</span> <span class="token operator">:</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">// Number of mediasoup workers to launch.</span>
		<span class="token literal-property property">numWorkers</span>     <span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">,</span>
		<span class="token comment">// mediasoup WorkerSettings.</span>
		<span class="token comment">// See https://mediasoup.org/documentation/v3/mediasoup/api/#WorkerSettings</span>
		<span class="token literal-property property">workerSettings</span> <span class="token operator">:</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token literal-property property">logLevel</span> <span class="token operator">:</span> <span class="token string">'warn'</span><span class="token punctuation">,</span>
			<span class="token literal-property property">logTags</span>  <span class="token operator">:</span>
			<span class="token punctuation">[</span>
				<span class="token string">'info'</span><span class="token punctuation">,</span>
				<span class="token string">'ice'</span><span class="token punctuation">,</span>
				<span class="token string">'dtls'</span><span class="token punctuation">,</span>
				<span class="token string">'rtp'</span><span class="token punctuation">,</span>
				<span class="token string">'srtp'</span><span class="token punctuation">,</span>
				<span class="token string">'rtcp'</span><span class="token punctuation">,</span>
				<span class="token string">'rtx'</span><span class="token punctuation">,</span>
				<span class="token string">'bwe'</span><span class="token punctuation">,</span>
				<span class="token string">'score'</span><span class="token punctuation">,</span>
				<span class="token string">'simulcast'</span><span class="token punctuation">,</span>
				<span class="token string">'svc'</span><span class="token punctuation">,</span>
				<span class="token string">'sctp'</span>
			<span class="token punctuation">]</span><span class="token punctuation">,</span>
			<span class="token literal-property property">rtcMinPort</span> <span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MEDIASOUP_MIN_PORT</span> <span class="token operator">||</span> <span class="token number">40000</span><span class="token punctuation">,</span>
			<span class="token literal-property property">rtcMaxPort</span> <span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MEDIASOUP_MAX_PORT</span> <span class="token operator">||</span> <span class="token number">49999</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token comment">// mediasoup Router options.</span>
		<span class="token comment">// See https://mediasoup.org/documentation/v3/mediasoup/api/#RouterOptions</span>
		<span class="token literal-property property">routerOptions</span> <span class="token operator">:</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token literal-property property">mediaCodecs</span> <span class="token operator">:</span>
			<span class="token punctuation">[</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token literal-property property">kind</span>      <span class="token operator">:</span> <span class="token string">'audio'</span><span class="token punctuation">,</span>
					<span class="token literal-property property">mimeType</span>  <span class="token operator">:</span> <span class="token string">'audio/opus'</span><span class="token punctuation">,</span>
					<span class="token literal-property property">clockRate</span> <span class="token operator">:</span> <span class="token number">48000</span><span class="token punctuation">,</span>
					<span class="token literal-property property">channels</span>  <span class="token operator">:</span> <span class="token number">2</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token literal-property property">kind</span>       <span class="token operator">:</span> <span class="token string">'video'</span><span class="token punctuation">,</span>
					<span class="token literal-property property">mimeType</span>   <span class="token operator">:</span> <span class="token string">'video/VP8'</span><span class="token punctuation">,</span>
					<span class="token literal-property property">clockRate</span>  <span class="token operator">:</span> <span class="token number">90000</span><span class="token punctuation">,</span>
					<span class="token literal-property property">parameters</span> <span class="token operator">:</span>
					<span class="token punctuation">{<!-- --></span>
						<span class="token string-property property">'x-google-start-bitrate'</span> <span class="token operator">:</span> <span class="token number">1000</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token literal-property property">kind</span>       <span class="token operator">:</span> <span class="token string">'video'</span><span class="token punctuation">,</span>
					<span class="token literal-property property">mimeType</span>   <span class="token operator">:</span> <span class="token string">'video/VP9'</span><span class="token punctuation">,</span>
					<span class="token literal-property property">clockRate</span>  <span class="token operator">:</span> <span class="token number">90000</span><span class="token punctuation">,</span>
					<span class="token literal-property property">parameters</span> <span class="token operator">:</span>
					<span class="token punctuation">{<!-- --></span>
						<span class="token string-property property">'profile-id'</span>             <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
						<span class="token string-property property">'x-google-start-bitrate'</span> <span class="token operator">:</span> <span class="token number">1000</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token literal-property property">kind</span>       <span class="token operator">:</span> <span class="token string">'video'</span><span class="token punctuation">,</span>
					<span class="token literal-property property">mimeType</span>   <span class="token operator">:</span> <span class="token string">'video/h264'</span><span class="token punctuation">,</span>
					<span class="token literal-property property">clockRate</span>  <span class="token operator">:</span> <span class="token number">90000</span><span class="token punctuation">,</span>
					<span class="token literal-property property">parameters</span> <span class="token operator">:</span>
					<span class="token punctuation">{<!-- --></span>
						<span class="token string-property property">'packetization-mode'</span>      <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
						<span class="token string-property property">'profile-level-id'</span>        <span class="token operator">:</span> <span class="token string">'4d0032'</span><span class="token punctuation">,</span>
						<span class="token string-property property">'level-asymmetry-allowed'</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
						<span class="token string-property property">'x-google-start-bitrate'</span>  <span class="token operator">:</span> <span class="token number">1000</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token literal-property property">kind</span>       <span class="token operator">:</span> <span class="token string">'video'</span><span class="token punctuation">,</span>
					<span class="token literal-property property">mimeType</span>   <span class="token operator">:</span> <span class="token string">'video/h264'</span><span class="token punctuation">,</span>
					<span class="token literal-property property">clockRate</span>  <span class="token operator">:</span> <span class="token number">90000</span><span class="token punctuation">,</span>
					<span class="token literal-property property">parameters</span> <span class="token operator">:</span>
					<span class="token punctuation">{<!-- --></span>
						<span class="token string-property property">'packetization-mode'</span>      <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
						<span class="token string-property property">'profile-level-id'</span>        <span class="token operator">:</span> <span class="token string">'42e01f'</span><span class="token punctuation">,</span>
						<span class="token string-property property">'level-asymmetry-allowed'</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
						<span class="token string-property property">'x-google-start-bitrate'</span>  <span class="token operator">:</span> <span class="token number">1000</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">]</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token comment">// mediasoup WebRtcServer options for WebRTC endpoints (mediasoup-client,</span>
		<span class="token comment">// libmediasoupclient).</span>
		<span class="token comment">// See https://mediasoup.org/documentation/v3/mediasoup/api/#WebRtcServerOptions</span>
		<span class="token comment">// NOTE: mediasoup-demo/server/lib/Room.js will increase this port for</span>
		<span class="token comment">// each mediasoup Worker since each Worker is a separate process.</span>
		<span class="token literal-property property">webRtcServerOptions</span> <span class="token operator">:</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token literal-property property">listenInfos</span> <span class="token operator">:</span>
			<span class="token punctuation">[</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token literal-property property">protocol</span>    <span class="token operator">:</span> <span class="token string">'udp'</span><span class="token punctuation">,</span>
					<span class="token literal-property property">ip</span>          <span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MEDIASOUP_LISTEN_IP</span> <span class="token operator">||</span> <span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span>
					<span class="token literal-property property">announcedIp</span> <span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MEDIASOUP_ANNOUNCED_IP</span><span class="token punctuation">,</span>
					<span class="token literal-property property">port</span>        <span class="token operator">:</span> <span class="token number">44444</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token literal-property property">protocol</span>    <span class="token operator">:</span> <span class="token string">'tcp'</span><span class="token punctuation">,</span>
					<span class="token literal-property property">ip</span>          <span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MEDIASOUP_LISTEN_IP</span> <span class="token operator">||</span> <span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span>
					<span class="token literal-property property">announcedIp</span> <span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MEDIASOUP_ANNOUNCED_IP</span><span class="token punctuation">,</span>
					<span class="token literal-property property">port</span>        <span class="token operator">:</span> <span class="token number">44444</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">]</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token comment">// mediasoup WebRtcTransport options for WebRTC endpoints (mediasoup-client,</span>
		<span class="token comment">// libmediasoupclient).</span>
		<span class="token comment">// See https://mediasoup.org/documentation/v3/mediasoup/api/#WebRtcTransportOptions</span>
		<span class="token literal-property property">webRtcTransportOptions</span> <span class="token operator">:</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token comment">// listenIps is not needed since webRtcServer is used.</span>
			<span class="token comment">// However passing MEDIASOUP_USE_WEBRTC_SERVER=false will change it.</span>
			<span class="token literal-property property">listenIps</span> <span class="token operator">:</span>
			<span class="token punctuation">[</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token literal-property property">ip</span>          <span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MEDIASOUP_LISTEN_IP</span> <span class="token operator">||</span> <span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span>
					<span class="token literal-property property">announcedIp</span> <span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MEDIASOUP_ANNOUNCED_IP</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">]</span><span class="token punctuation">,</span>
			<span class="token literal-property property">initialAvailableOutgoingBitrate</span> <span class="token operator">:</span> <span class="token number">1000000</span><span class="token punctuation">,</span>
			<span class="token literal-property property">minimumAvailableOutgoingBitrate</span> <span class="token operator">:</span> <span class="token number">600000</span><span class="token punctuation">,</span>
			<span class="token literal-property property">maxSctpMessageSize</span>              <span class="token operator">:</span> <span class="token number">262144</span><span class="token punctuation">,</span>
			<span class="token comment">// Additional options that are not part of WebRtcTransportOptions.</span>
			<span class="token literal-property property">maxIncomingBitrate</span>              <span class="token operator">:</span> <span class="token number">1500000</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token comment">// mediasoup PlainTransport options for legacy RTP endpoints (FFmpeg,</span>
		<span class="token comment">// GStreamer).</span>
		<span class="token comment">// See https://mediasoup.org/documentation/v3/mediasoup/api/#PlainTransportOptions</span>
		<span class="token literal-property property">plainTransportOptions</span> <span class="token operator">:</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token literal-property property">listenIp</span> <span class="token operator">:</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token literal-property property">ip</span>          <span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MEDIASOUP_LISTEN_IP</span> <span class="token operator">||</span> <span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span>
				<span class="token literal-property property">announcedIp</span> <span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MEDIASOUP_ANNOUNCED_IP</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token literal-property property">maxSctpMessageSize</span> <span class="token operator">:</span> <span class="token number">262144</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> 
<ol start="3"><li>config.js配置信息注释：</li></ol> 
<table><thead><tr><th>父字段</th><th>子字段</th><th>作用</th></tr></thead><tbody><tr><td>https</td><td><br></td><td><br></td></tr><tr><td></td><td>listenIp</td><td>服务器监听的IP地址</td></tr><tr><td></td><td>listenPort</td><td>服务器监听的端口</td></tr><tr><td>mediasoup</td><td></td><td></td></tr><tr><td></td><td>workerSettings</td><td>mediasoup的Worker配置参数，包括worker的数量、Worker进程的文件路径、logLevel等</td></tr><tr><td></td><td>routerOptions</td><td>mediasoup的Router配置参数，包括媒体编解码器配置参数</td></tr><tr><td></td><td>webRtcServerOptions</td><td>mediasoup的WebRtcServer配置参数，包括监听协议、IP和端口</td></tr><tr><td></td><td>webRtcTransportOptions</td><td>mediasoup的WebRtcTransport配置参数，包括UDP/TCP转发的监听端口、最大带宽、最大数据包等</td></tr><tr><td></td><td>plainTransportOptions</td><td>mediasoup的PlainTransport配置参数，包括UDP/TCP转发的监听端口、最大带宽、最大数据包等</td></tr></tbody></table> 
<ol start="5"><li>详细字段含义见官方文档：<a href="https://mediasoup.org/documentation/v3/mediasoup/api" rel="nofollow">https://mediasoup.org/documentation/v3/mediasoup/api</a><br> </li></ol> 
<h4><a id="2_serverjs_245"></a>2. server.js代码解析</h4> 
<ol><li>server.js是mediasoup-demo应用程序的核心部分，负责启动和管理各个组件，以及处理音视频数据的传输和处理。<br> </li></ol> 
<h5><a id="1_serverjs_249"></a>1. server.js主要逻辑</h5> 
<ol><li>加载配置文件：读取config.js文件中的配置参数，包括HTTP和WebSocket服务器的端口号、mediasoup Worker进程的数量等等。</li><li>启动HTTP服务器：创建一个HTTP服务器，并在指定端口上监听请求。 
  <ol><li>HTTP服务器主要用于提供静态资源，例如前端页面、CSS和JS文件等。</li></ol> </li><li>启动WebSocket服务器：创建一个WebSocket服务器，并在指定端口上监听连接请求。 
  <ol><li>WebSocket服务器用于处理实时音视频数据的传输。</li></ol> </li><li>启动mediasoup Worker进程：根据配置文件中的worker.numWorkers参数，创建指定数量的mediasoup Worker进程。 
  <ol><li>每个Worker进程负责管理mediasoup Router对象和Transport对象，以及处理音视频流的转发和处理。</li></ol> </li><li>处理WebSocket连接：当有新的WebSocket连接建立时，server.js会创建一个新的mediasoup Router对象，并将其绑定到一个指定的mediasoup Worker进程上。 
  <ol><li>同时，server.js会为该WebSocket连接创建一个Transport对象，并将其绑定到相应的mediasoup Router对象上。</li><li>这样，WebSocket客户端就可以通过Transport对象和mediasoup Router对象进行音视频流的传输和处理。</li></ol> </li><li>处理HTTP请求：当有HTTP请求到达时，server.js会根据请求路径返回相应的静态资源。 
  <ol><li>例如，请求"/"路径时返回index.html页面。</li></ol> </li><li>错误处理：server.js还负责处理各种错误，包括HTTP和WebSocket服务器的错误、mediasoup Worker进程的错误以及WebSocket客户端的错误等等。 
  <ol><li>当出现错误时，server.js会将错误信息记录到日志文件中，并尝试恢复或重新启动相关的服务或进程。<br> </li></ol> </li></ol> 
<h5><a id="2_serverjs_266"></a>2. server.js具体代码解析</h5> 
<ol><li>server目录中server.js是服务端应用程序的入口文件，负责启动应用程序、创建HTTP和WebSocket服务器以及管理mediasoup Worker进程。</li><li>其中run()函数是server.js入口函数：</li></ol> 
<pre><code class="prism language-javascript"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 开启交互式服务器</span>
	<span class="token keyword">await</span> <span class="token function">interactiveServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 如果设置了环境变量 INTERACTIVE 为 true 或 1，则开启交互式客户端</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">INTERACTIVE</span> <span class="token operator">===</span> <span class="token string">'true'</span> <span class="token operator">||</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">INTERACTIVE</span> <span class="token operator">===</span> <span class="token string">'1'</span><span class="token punctuation">)</span>
		<span class="token keyword">await</span> <span class="token function">interactiveClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 运行 mediasoup worker</span>
	<span class="token keyword">await</span> <span class="token function">runMediasoupWorkers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 创建 Express 应用</span>
	<span class="token keyword">await</span> <span class="token function">createExpressApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 运行 HTTPS 服务器</span>
	<span class="token keyword">await</span> <span class="token function">runHttpsServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 运行 protoo WebSocket 服务器</span>
	<span class="token keyword">await</span> <span class="token function">runProtooWebSocketServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 每 X 秒记录一次房间的状态</span>
	<span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> room <span class="token keyword">of</span> rooms<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			room<span class="token punctuation">.</span><span class="token function">logStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">120000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p></p> 
<h6><a id="1_runMediasoupWorkers__303"></a>1. runMediasoupWorkers() 函数解析</h6> 
<ol><li>mediasoup-demo中，mediasoup Worker是mediasoup的核心部分，它们负责处理音视频流并管理mediasoup的底层资源。</li><li>由于mediasoup Worker的创建和销毁比较耗时，因此在mediasoup-demo中会创建多个mediasoup Worker来提高系统的处理能力。</li><li>在runMediasoupWorkers() 函数中，可以创建多个mediasoup Worker，并对其进行管理和监控，从而保证mediasoup-demo的正常运行。</li><li>具体代码和注释如下：</li></ol> 
<pre><code class="prism language-javascript"><span class="token comment">/**
 * Launch as many mediasoup Workers as given in the configuration file.
 */</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">runMediasoupWorkers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 从配置文件中获取mediasoup的配置项numWorkers，即需要启动的mediasoup Worker数量。</span>
	<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> numWorkers <span class="token punctuation">}</span> <span class="token operator">=</span> config<span class="token punctuation">.</span>mediasoup<span class="token punctuation">;</span>

	logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'running %d mediasoup Workers...'</span><span class="token punctuation">,</span> numWorkers<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 使用mediasoup.createWorker()创建指定数量的mediasoup Worker，并将其存储到全局数组mediasoupWorkers中。</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numWorkers<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">await</span> mediasoup<span class="token punctuation">.</span><span class="token function">createWorker</span><span class="token punctuation">(</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token literal-property property">logLevel</span>   <span class="token operator">:</span> config<span class="token punctuation">.</span>mediasoup<span class="token punctuation">.</span>workerSettings<span class="token punctuation">.</span>logLevel<span class="token punctuation">,</span>
				<span class="token literal-property property">logTags</span>    <span class="token operator">:</span> config<span class="token punctuation">.</span>mediasoup<span class="token punctuation">.</span>workerSettings<span class="token punctuation">.</span>logTags<span class="token punctuation">,</span>
				<span class="token literal-property property">rtcMinPort</span> <span class="token operator">:</span> <span class="token function">Number</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>mediasoup<span class="token punctuation">.</span>workerSettings<span class="token punctuation">.</span>rtcMinPort<span class="token punctuation">)</span><span class="token punctuation">,</span>
				<span class="token literal-property property">rtcMaxPort</span> <span class="token operator">:</span> <span class="token function">Number</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>mediasoup<span class="token punctuation">.</span>workerSettings<span class="token punctuation">.</span>rtcMaxPort<span class="token punctuation">)</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 每个mediasoup Worker创建成功后，为其添加一个died事件监听器，当Worker死亡时自动退出进程。</span>
		<span class="token comment">// 该事件监听器通过setTimeout()设置了一个2秒的定时器，定时器到期后退出进程。</span>
		worker<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'died'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
		<span class="token punctuation">{<!-- --></span>
			logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>
				<span class="token string">'mediasoup Worker died, exiting  in 2 seconds... [pid:%d]'</span><span class="token punctuation">,</span> worker<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		mediasoupWorkers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>worker<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 对于每个mediasoup Worker，如果配置文件中的MEDIASOUP_USE_WEBRTC_SERVER环境变量的值不为false，则在其中创建一个WebRtcServer。</span>
		<span class="token comment">// Create a WebRtcServer in this Worker.</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MEDIASOUP_USE_WEBRTC_SERVER</span> <span class="token operator">!==</span> <span class="token string">'false'</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token comment">// Each mediasoup Worker will run its own WebRtcServer, so those cannot</span>
			<span class="token comment">// share the same listening ports. Hence we increase the value in config.js</span>
			<span class="token comment">// for each Worker.</span>
			<span class="token comment">// 为了避免多个mediasoup Worker之间端口冲突，配置文件中WebRtcServer的监听端口需要逐个增加，这样每个mediasoup Worker创建的</span>
			<span class="token comment">// WebRtcServer监听端口才不会相同。因此，在为每个mediasoup Worker创建WebRtcServer时，会逐个增加WebRtcServer配置中的端口号。</span>
			<span class="token keyword">const</span> webRtcServerOptions <span class="token operator">=</span> utils<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>mediasoup<span class="token punctuation">.</span>webRtcServerOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">const</span> portIncrement <span class="token operator">=</span> mediasoupWorkers<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>

			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> listenInfo <span class="token keyword">of</span> webRtcServerOptions<span class="token punctuation">.</span>listenInfos<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				listenInfo<span class="token punctuation">.</span>port <span class="token operator">+=</span> portIncrement<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">const</span> webRtcServer <span class="token operator">=</span> <span class="token keyword">await</span> worker<span class="token punctuation">.</span><span class="token function">createWebRtcServer</span><span class="token punctuation">(</span>webRtcServerOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">//每个mediasoup Worker创建的WebRtcServer将被存储到其appData属性中。</span>
			worker<span class="token punctuation">.</span>appData<span class="token punctuation">.</span>webRtcServer <span class="token operator">=</span> webRtcServer<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// Log worker resource usage every X seconds.</span>
		<span class="token comment">// 每个mediasoup Worker将会定时记录其资源使用情况，并使用setInterval()函数设置一个时间间隔，</span>
		<span class="token comment">// 即每隔一段时间输出一次mediasoup Worker的资源使用情况。</span>
		<span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">const</span> usage <span class="token operator">=</span> <span class="token keyword">await</span> worker<span class="token punctuation">.</span><span class="token function">getResourceUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'mediasoup Worker resource usage [pid:%d]: %o'</span><span class="token punctuation">,</span> worker<span class="token punctuation">.</span>pid<span class="token punctuation">,</span> usage<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">120000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p></p> 
<h6><a id="2_mediasoupcreateWorker__379"></a>2. mediasoup.createWorker() 函数解析</h6> 
<ol><li>runMediasoupWorkers() 函数中mediasoup.createWorker()方法是mediasoup库提供的一个异步方法，用于创建mediasoup Worker实例，其具体实现是在mediasoup项目的node/src/index.ts代码中。</li><li>在mediasoup-demo v3版本中，mediasoup.createWorker()方法被调用多次，每次调用都会创建一个Worker实例，并把该实例推入全局变量mediasoupWorkers数组中。 
  <ol><li>在v3版本的实现中，每个Worker实例将拥有自己的独立的mediasoup Router实例，从而保证不同的房间使用独立的Router实例进行媒体处理，提高系统的可扩展性和稳定性。</li><li>同时，每个Worker实例都会在其对应的端口上创建一个WebRtcServer实例，用于管理WebRTC客户端的连接。</li></ol> </li><li>下面是mediasoup.createWorker() 方法的详细解析： 
  <ol><li>options: Object类型，表示创建Worker实例的选项。该选项包括： 
    <ol><li>logLevel: String类型，表示Worker实例的日志级别。默认值为warn。</li><li>logTags: Array类型，表示Worker实例的日志标签。默认值为[‘info’, ‘ice’, ‘dtls’, ‘rtp’, ‘srtp’, ‘rtcp’, ‘rtx’, ‘bwe’, ‘score’, ‘simulcast’, ‘svc’]。</li><li>rtcMinPort: Number类型，表示Worker实例使用的最小UDP端口。默认值为10000。</li><li>rtcMaxPort: Number类型，表示Worker实例使用的最大UDP端口。默认值为59999。</li><li>dtlsCertificateFile 和 dtlsPrivateKeyFile 是 DTLS 的证书和私钥文件的路径。 
      <ol><li>如果未设置这些文件的路径，则 mediasoup 将使用默认的证书和私钥。</li></ol> </li><li>libwebrtcFieldTrials 是 Google WebRTC 库中的实验性功能。</li><li>appData 可以用于存储与 worker 实例相关的应用程序数据。 
      <ol><li>如果设置了 appData，则其必须是一个对象。默认情况下，appData 为 undefined。</li></ol> </li></ol> </li><li>返回值: Promise类型，表示创建的Worker实例对象。</li></ol> </li></ol> 
<pre><code class="prism language-javascript"><span class="token comment">/**
 * Create a Worker.
 */</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">createWorker</span><span class="token punctuation">(</span>
	<span class="token punctuation">{<!-- --></span>
		logLevel <span class="token operator">=</span> <span class="token string">'error'</span><span class="token punctuation">,</span>
		logTags<span class="token punctuation">,</span>
		rtcMinPort <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">,</span>
		rtcMaxPort <span class="token operator">=</span> <span class="token number">59999</span><span class="token punctuation">,</span>
		dtlsCertificateFile<span class="token punctuation">,</span>
		dtlsPrivateKeyFile<span class="token punctuation">,</span>
		libwebrtcFieldTrials<span class="token punctuation">,</span>
		appData
	<span class="token punctuation">}</span><span class="token operator">:</span> WorkerSettings <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>Worker<span class="token operator">&gt;</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 在函数中打印了一个调试信息，表示正在创建一个 Worker 实例。</span>
	logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'createWorker()'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 函数检查了 appData 是否是一个对象。如果 appData 存在但不是对象，则抛出 TypeError 异常。</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>appData <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> appData <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'if given, appData must be an object'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 创建了一个新的 Worker 实例，将配置对象作为参数传递给该实例的构造函数。</span>
	<span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span>
		<span class="token punctuation">{<!-- --></span>
			logLevel<span class="token punctuation">,</span>
			logTags<span class="token punctuation">,</span>
			rtcMinPort<span class="token punctuation">,</span>
			rtcMaxPort<span class="token punctuation">,</span>
			dtlsCertificateFile<span class="token punctuation">,</span>
			dtlsPrivateKeyFile<span class="token punctuation">,</span>
			libwebrtcFieldTrials<span class="token punctuation">,</span>
			appData
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// createWorker 函数返回一个 Promise，当 worker 进程启动成功时会调用 resolve 回调函数，并将创建的 Worker 实例作为参数传递进去；</span>
	<span class="token comment">// 如果 worker 进程启动失败，则会调用 reject 回调函数。</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
	<span class="token punctuation">{<!-- --></span>
		worker<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'@success'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token comment">// Emit observer event.</span>
			<span class="token comment">// 在 resolve 回调函数中，会发射一个 newworker 事件，通知 mediasoup 监听该事件的观察者，表示创建了一个新的 worker 进程。</span>
			observer<span class="token punctuation">.</span><span class="token function">safeEmit</span><span class="token punctuation">(</span><span class="token string">'newworker'</span><span class="token punctuation">,</span> worker<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token function">resolve</span><span class="token punctuation">(</span>worker<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		worker<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'@failure'</span><span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="4"><li>其中，new Worker会创建一个 Worker 工作进程，并在工作进程与主进程之间建立IPC通道，从而实现进程间通信。 
  <ol><li>Worker 用于处理mediasoup的核心功能，如RTP流传输，房间管理等。<br> </li></ol> </li></ol> 
<h6><a id="3_runHttpsServer__455"></a>3. runHttpsServer() 函数解析</h6> 
<ol><li>runHttpsServer() 函数的主要功能是创建和运行一个基于 HTTPS 的 Web 服务器，并监听配置文件中指定的IP地址和端口。</li><li>具体代码和注释如下：</li></ol> 
<pre><code class="prism language-javascript"><span class="token comment">/**
 * Create a Node.js HTTPS server. It listens in the IP and port given in the
 * configuration file and reuses the Express application as request listener.
 */</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">runHttpsServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'running an HTTPS server...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// HTTPS server for the protoo WebSocket server.</span>
	<span class="token comment">// 定义了tls的对象，用于存储HTTPS服务器所需的TLS证书和密钥</span>
	<span class="token keyword">const</span> tls <span class="token operator">=</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token literal-property property">cert</span> <span class="token operator">:</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>https<span class="token punctuation">.</span>tls<span class="token punctuation">.</span>cert<span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token literal-property property">key</span>  <span class="token operator">:</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>https<span class="token punctuation">.</span>tls<span class="token punctuation">.</span>key<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>

	<span class="token comment">// 创建一个HTTPS服务器实例，并将tls对象和expressApp作为参数传递进去。</span>
	httpsServer <span class="token operator">=</span> https<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>tls<span class="token punctuation">,</span> expressApp<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 监听HTTPS服务器的端口和IP地址，并返回一个Promise。</span>
	<span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
	<span class="token punctuation">{<!-- --></span>
		httpsServer<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>
			<span class="token function">Number</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>https<span class="token punctuation">.</span>listenPort<span class="token punctuation">)</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span>https<span class="token punctuation">.</span>listenIp<span class="token punctuation">,</span> resolve<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p></p> 
<h6><a id="4_runProtooWebSocketServer__488"></a>4. runProtooWebSocketServer() 函数解析</h6> 
<ol><li>runProtooWebSocketServer() 函数主要用于启动一个 WebSocket 服务器，来允许浏览器通过WebSocket连接到服务器。</li></ol> 
<pre><code class="prism language-javascript"><span class="token comment">/**
 * Create a protoo WebSocketServer to allow WebSocket connections from browsers.
 */</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">runProtooWebSocketServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'running protoo WebSocketServer...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Create the protoo WebSocket server.</span>
	<span class="token comment">// 创建一个 WebSocket 服务器 protooWebSocketServer</span>
	protooWebSocketServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">protoo<span class="token punctuation">.</span>WebSocketServer</span><span class="token punctuation">(</span>httpsServer<span class="token punctuation">,</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token literal-property property">maxReceivedFrameSize</span>     <span class="token operator">:</span> <span class="token number">960000</span><span class="token punctuation">,</span> <span class="token comment">// 960 KBytes.</span>
			<span class="token literal-property property">maxReceivedMessageSize</span>   <span class="token operator">:</span> <span class="token number">960000</span><span class="token punctuation">,</span>
			<span class="token literal-property property">fragmentOutgoingMessages</span> <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
			<span class="token literal-property property">fragmentationThreshold</span>   <span class="token operator">:</span> <span class="token number">960000</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Handle connections from clients.</span>
	<span class="token comment">// 注册 connectionrequest 事件的监听器，有新的 WebSocket 连接请求时被触发。</span>
	protooWebSocketServer<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connectionrequest'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">info<span class="token punctuation">,</span> accept<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">// The client indicates the roomId and peerId in the URL query.</span>
		<span class="token comment">// 在监听器中，从连接请求的 URL 中解析出房间 ID 和 peer ID，如果解析失败或者没有这些参数，就拒绝连接请求。</span>
		<span class="token keyword">const</span> u <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> roomId <span class="token operator">=</span> u<span class="token punctuation">.</span>query<span class="token punctuation">[</span><span class="token string">'roomId'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> peerId <span class="token operator">=</span> u<span class="token punctuation">.</span>query<span class="token punctuation">[</span><span class="token string">'peerId'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>roomId <span class="token operator">||</span> <span class="token operator">!</span>peerId<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token string">'Connection request without roomId and/or peerId'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 从URL中解析出消费者实例的数量 consumerReplicas，如果解析失败则将其设置为默认值 0。</span>
		<span class="token keyword">let</span> consumerReplicas <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span>query<span class="token punctuation">[</span><span class="token string">'consumerReplicas'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isNaN</span><span class="token punctuation">(</span>consumerReplicas<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			consumerReplicas <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>
			<span class="token string">'protoo connection request [roomId:%s, peerId:%s, address:%s, origin:%s]'</span><span class="token punctuation">,</span>
			roomId<span class="token punctuation">,</span> peerId<span class="token punctuation">,</span> info<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>remoteAddress<span class="token punctuation">,</span> info<span class="token punctuation">.</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Serialize this code into the queue to avoid that two peers connecting at</span>
		<span class="token comment">// the same time with the same roomId create two separate rooms with same</span>
		<span class="token comment">// roomId.</span>
    <span class="token comment">// 为了避免同时有两个连接请求使用相同的roomId创建两个不同的房间，使用了一个queue队列将代码序列化。</span>
		<span class="token comment">// 在队列中，调用 getOrCreateRoom() 函数获取或创建一个房间，并返回一个 Room 实例。</span>
		<span class="token comment">// 如果房间创建或加入失败，就会在 catch 代码块中将错误信息返回给客户端，并拒绝连接请求。</span>
		queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">const</span> room <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getOrCreateRoom</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> roomId<span class="token punctuation">,</span> consumerReplicas <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// Accept the protoo WebSocket connection.</span>
			<span class="token comment">// 如果任务执行成功，使用 accept() 接受 WebSocket 连接</span>
			<span class="token keyword">const</span> protooWebSocketTransport <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			room<span class="token punctuation">.</span><span class="token function">handleProtooConnection</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> peerId<span class="token punctuation">,</span> protooWebSocketTransport <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
			<span class="token punctuation">{<!-- --></span>
				logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'room creation or room joining failed:%o'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p></p> 
<h4><a id="3_Roomjs_564"></a>3. Room.js代码解析</h4> 
<ol><li>Room.js实现了应用程序中单个房间的管理逻辑，负责管理房间成员的加入/离开、生产者/消费者的创建和管理等一系列操作。<br> </li></ol> 
<h5><a id="1_Roomjs_568"></a>1. Room.js具体代码解析</h5> 
<p></p> 
<h6><a id="1_create__570"></a>1. create() 函数解析</h6> 
<ol><li>create() 函数创建一个新的Room实例。</li><li>具体代码和注释如下：</li></ol> 
<pre><code class="prism language-javascript">	<span class="token comment">/**
	 * Factory function that creates and returns Room instance.
	 *
	 * @async
	 *
	 * @param {mediasoup.Worker} mediasoupWorker - The mediasoup Worker in which a new
	 *   mediasoup Router must be created.
	 * @param {String} roomId - Id of the Room instance.
	 */</span>
	<span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{<!-- --></span> mediasoupWorker<span class="token punctuation">,</span> roomId<span class="token punctuation">,</span> consumerReplicas <span class="token punctuation">}</span></span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'create() [roomId:%s]'</span><span class="token punctuation">,</span> roomId<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Create a protoo Room instance.</span>
		<span class="token comment">// 创建了一个新的protoo Room实例，protoo是一种基于WebSocket的信令协议，用于在客户端和服务端之间传递信令消息。</span>
		<span class="token keyword">const</span> protooRoom <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">protoo<span class="token punctuation">.</span>Room</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Router media codecs.</span>
		<span class="token comment">//根据配置文件中的mediasoup router选项，使用mediasoup worker创建一个mediasoup Router实例</span>
		<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> mediaCodecs <span class="token punctuation">}</span> <span class="token operator">=</span> config<span class="token punctuation">.</span>mediasoup<span class="token punctuation">.</span>routerOptions<span class="token punctuation">;</span>

		<span class="token comment">// Create a mediasoup Router.</span>
		<span class="token keyword">const</span> mediasoupRouter <span class="token operator">=</span> <span class="token keyword">await</span> mediasoupWorker<span class="token punctuation">.</span><span class="token function">createRouter</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> mediaCodecs <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Create a mediasoup AudioLevelObserver.</span>
		<span class="token comment">// 使用mediasoup Router实例，创建一个mediasoup AudioLevelObserver实例，用于观察媒体流中的音频级别。</span>
		<span class="token comment">// 这个观察者的作用是用来检测房间中正在说话的用户，以便对其进行相关操作，如推送媒体流等。</span>
		<span class="token keyword">const</span> audioLevelObserver <span class="token operator">=</span> <span class="token keyword">await</span> mediasoupRouter<span class="token punctuation">.</span><span class="token function">createAudioLevelObserver</span><span class="token punctuation">(</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token literal-property property">maxEntries</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
				<span class="token literal-property property">threshold</span>  <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">80</span><span class="token punctuation">,</span>
				<span class="token literal-property property">interval</span>   <span class="token operator">:</span> <span class="token number">800</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Create a mediasoup ActiveSpeakerObserver.</span>
		<span class="token comment">// 使用mediasoup Router实例上，创建一个mediasoup ActiveSpeakerObserver实例，用于观察房间中当前发言者的情况。</span>
		<span class="token comment">// 这个观察者的作用是用来检测房间中的活跃发言者，以便在客户端中实时显示。</span>
		<span class="token keyword">const</span> activeSpeakerObserver <span class="token operator">=</span> <span class="token keyword">await</span> mediasoupRouter<span class="token punctuation">.</span><span class="token function">createActiveSpeakerObserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 最后，使用同样的mediasoup Router实例，创建一个Bot实例，Bot是一个虚拟的用户，用于在房间中扮演一个音频流的源。</span>
		<span class="token comment">// 它的主要作用是在测试和演示中使用，例如在没有实际用户的情况下测试房间的性能等。</span>
		<span class="token keyword">const</span> bot <span class="token operator">=</span> <span class="token keyword">await</span> Bot<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> mediasoupRouter <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 最终返回一个新的Room实例，包含上述创建的protoo Room实例、mediasoup Router实例、以及用于观察音频级别和活跃发言者的mediasoup观察者实例等信息。</span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Room</span><span class="token punctuation">(</span>
			<span class="token punctuation">{<!-- --></span>
				roomId<span class="token punctuation">,</span>
				protooRoom<span class="token punctuation">,</span>
				<span class="token literal-property property">webRtcServer</span> <span class="token operator">:</span> mediasoupWorker<span class="token punctuation">.</span>appData<span class="token punctuation">.</span>webRtcServer<span class="token punctuation">,</span>
				mediasoupRouter<span class="token punctuation">,</span>
				audioLevelObserver<span class="token punctuation">,</span>
				activeSpeakerObserver<span class="token punctuation">,</span>
				consumerReplicas<span class="token punctuation">,</span>
				bot
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p></p> 
<h6><a id="2_handleProtooConnection__633"></a>2. handleProtooConnection() 函数解析</h6> 
<ol><li>handleProtooConnection() 函数用于管理与客户端之间的连接，确保每个连接都是唯一的，并且能够处理客户端发送的请求并返回相应的结果。</li><li>在server.js中runProtooWebSocketServer() 函数创建一个 WebSocket 服务器后，这个服务器会注册 connectionrequest 事件的监听器，有新的 WebSocket 连接请求时被触发，最终会调用到handleProtooConnection() 函数。</li><li>具体代码和注释如下：</li></ol> 
<pre><code class="prism language-javascript">	<span class="token comment">/**
	 * Called from server.js upon a protoo WebSocket connection request from a
	 * browser.
	 *
	 * @param {String} peerId - The id of the protoo peer to be created.
	 * @param {Boolean} consume - Whether this peer wants to consume from others.
	 * @param {protoo.WebSocketTransport} protooWebSocketTransport - The associated
	 *   protoo WebSocket transport.
	 */</span>
	<span class="token function">handleProtooConnection</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{<!-- --></span> peerId<span class="token punctuation">,</span> consume<span class="token punctuation">,</span> protooWebSocketTransport <span class="token punctuation">}</span></span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 为了确保每个连接都是唯一的，根据peerId查找是否已经存在同名的protoo Peer对象，如果存在，则关闭该protoo Peer对象。</span>
		<span class="token keyword">const</span> existingPeer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_protooRoom<span class="token punctuation">.</span><span class="token function">getPeer</span><span class="token punctuation">(</span>peerId<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>existingPeer<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>
				<span class="token string">'handleProtooConnection() | there is already a protoo Peer with same peerId, closing it [peerId:%s]'</span><span class="token punctuation">,</span>
				peerId<span class="token punctuation">)</span><span class="token punctuation">;</span>

			existingPeer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 如果不存在同名的protoo Peer对象，则创建一个新的protoo Peer对象。</span>
		<span class="token comment">// 并通过peer.data对象存储相关数据，如是否已经加入房间、用户名称等等。</span>
		<span class="token comment">// 同时，也创建了几个map对象，用于存储房间中的生产者、消费者、数据生产者和数据消费者对象。</span>
		<span class="token keyword">let</span> peer<span class="token punctuation">;</span>

		<span class="token comment">// Create a new protoo Peer with the given peerId.</span>
		<span class="token keyword">try</span>
		<span class="token punctuation">{<!-- --></span>
			peer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_protooRoom<span class="token punctuation">.</span><span class="token function">createPeer</span><span class="token punctuation">(</span>peerId<span class="token punctuation">,</span> protooWebSocketTransport<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'protooRoom.createPeer() failed:%o'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// Use the peer.data object to store mediasoup related objects.</span>

		<span class="token comment">// Not joined after a custom protoo 'join' request is later received.</span>
		peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>consume <span class="token operator">=</span> consume<span class="token punctuation">;</span>
		peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>joined <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>displayName <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
		peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>device <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
		peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>rtpCapabilities <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
		peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>sctpCapabilities <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>

		<span class="token comment">// Have mediasoup related maps ready even before the Peer joins since we</span>
		<span class="token comment">// allow creating Transports before joining.</span>
		peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>transports <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>producers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>consumers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>dataProducers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>dataConsumers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 监听protoo Peer对象的request事件，当有请求到达时，执行_handleProtooRequest函数来处理请求，并返回相应的结果。</span>
		<span class="token comment">// 如果出现异常，则通过reject函数返回错误信息。</span>
		peer<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> accept<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
		<span class="token punctuation">{<!-- --></span>
			logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>
				<span class="token string">'protoo Peer "request" event [method:%s, peerId:%s]'</span><span class="token punctuation">,</span>
				request<span class="token punctuation">.</span>method<span class="token punctuation">,</span> peer<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_handleProtooRequest</span><span class="token punctuation">(</span>peer<span class="token punctuation">,</span> request<span class="token punctuation">,</span> accept<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
				<span class="token punctuation">{<!-- --></span>
					logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'request failed:%o'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>

					<span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 当一个protoo连接关闭时，触发protoo Peer对象的close事件。</span>
		peer<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 首先判断房间是否已经关闭，如果已经关闭则直接返回，避免重复关闭。</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_closed<span class="token punctuation">)</span>
				<span class="token keyword">return</span><span class="token punctuation">;</span>

			logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'protoo Peer "close" event [peerId:%s]'</span><span class="token punctuation">,</span> peer<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// If the Peer was joined, notify all Peers.</span>
			<span class="token comment">// 如果该Peer已经加入房间，通知所有其他Peers该Peer已经关闭。</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>joined<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> otherPeer <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getJoinedPeers</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">excludePeer</span><span class="token operator">:</span> peer <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>
					otherPeer<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token string">'peerClosed'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">peerId</span><span class="token operator">:</span> peer<span class="token punctuation">.</span>id <span class="token punctuation">}</span><span class="token punctuation">)</span>
						<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>

			<span class="token comment">// Iterate and close all mediasoup Transport associated to this Peer, so all</span>
			<span class="token comment">// its Producers and Consumers will also be closed.</span>
			<span class="token comment">// 遍历所有该Peer创建的Transport并关闭，这样该Peer创建的所有Producers和Consumers都将被关闭。</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> transport <span class="token keyword">of</span> peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>transports<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				transport<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token comment">// If this is the latest Peer in the room, close the room.</span>
			<span class="token comment">// 判断该Peer是否是房间中的最后一个Peer，如果是，则关闭整个房间。</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_protooRoom<span class="token punctuation">.</span>peers<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>
					<span class="token string">'last Peer in the room left, closing the room [roomId:%s]'</span><span class="token punctuation">,</span>
					<span class="token keyword">this</span><span class="token punctuation">.</span>_roomId<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p></p> 
<h6><a id="3__handleProtooRequest__754"></a>3. _handleProtooRequest() 函数解析</h6> 
<ol><li>_handleProtooRequest 函数是处理客户端通过 WebSocket 连接发送的消息。</li><li>_handleProtooRequest 函数定义如下：</li></ol> 
<pre><code class="prism language-javascript"><span class="token keyword">async</span> <span class="token function">_handleProtooRequest</span><span class="token punctuation">(</span>peer<span class="token punctuation">,</span> request<span class="token punctuation">,</span> accept<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
</code></pre> 
<ol start="3"><li>参数说明： 
  <ol><li>peer：发送消息的客户端连接。</li><li>request：客户端发送的消息内容。</li><li>accept：回调函数，用于向客户端发送响应消息。</li><li>reject：回调函数，用于向客户端发送错误响应消息。</li></ol> </li><li>request 参数是客户端发送的消息内容，其包含了 request.method 和 request.data 两个字段。 
  <ol><li>其中 request.method 表示消息类型，request.data 表示消息携带的数据。</li><li>根据 request.method 的不同，将消息分配到不同的处理函数中。</li></ol> </li><li>消息类型总有有22种，分别的含义为：</li></ol> 
<table><thead><tr><th>信令</th><th>说明</th></tr></thead><tbody><tr><td>getRouterRtpCapabilities</td><td>客户端请求获取 mediasoupRouter 的 rtpCapabilities，即媒体流传输的相关能力参数。</td></tr><tr><td>join</td><td>客户端加入房间</td></tr><tr><td>createWebRtcTransport</td><td>创建 WebRTC 传输对象并将其存储到 peer.data.transports 中，以供后续的音视频传输使用。</td></tr><tr><td>connectWebRtcTransport</td><td>在建立 WebRtcTransport 之后，客户端使用本地生成的 DTLS 参数连接 WebRtcTransport 时发送</td></tr><tr><td>restartIce</td><td>重新启动WebRtcTransport中的ICE Agent，从而获取新的ICE Candidates并更新连接</td></tr><tr><td>produce</td><td>创建一个新的音频或视频的 Producer 并与客户端关联</td></tr><tr><td>closeProducer</td><td>关闭一个指定的生产者，并从 peer.data.producers Map 中删除该生产者</td></tr><tr><td>pauseProducer</td><td>尝试暂停一个指定的生产者</td></tr><tr><td>resumeProducer</td><td>尝试恢复一个指定的生产者</td></tr><tr><td>pauseConsumer</td><td>尝试暂停一个指定的消费者</td></tr><tr><td>resumeConsumer</td><td>尝试恢复一个指定的消费者</td></tr><tr><td>setConsumerPreferredLayers</td><td>尝试设置指定消费者的首选图层</td></tr><tr><td>setConsumerPriority</td><td>尝试设置消费者优先级（priority）</td></tr><tr><td>requestConsumerKeyFrame</td><td>尝试获取某个消费者的关键帧（Key Frame）</td></tr><tr><td>produceData</td><td>创建数据生产者，并存储在 peer.data.dataProducers Map的数据对象中</td></tr><tr><td>changeDisplayName</td><td>处理客户端请求更改显示名称</td></tr><tr><td>getTransportStats</td><td>获取某个transport的统计信息</td></tr><tr><td>getProducerStats</td><td>获取某个消费者的统计信息</td></tr><tr><td>getDataProducerStats</td><td>获取某个数据生产者的统计信息</td></tr><tr><td>getDataConsumerStats</td><td>获取某个数据消费者的统计信息</td></tr><tr><td>applyNetworkThrottle</td><td>修改网络带宽和延迟模拟网络限制</td></tr><tr><td>resetNetworkThrottle</td><td>重置网络限制</td></tr></tbody></table> 
<ol start="7"><li>具体代码解析和注释如下：</li></ol> 
<pre><code class="prism language-javascript">	<span class="token comment">/**
	 * Handle protoo requests from browsers.
	 *
	 * @async
	 */</span>
	<span class="token keyword">async</span> <span class="token function">_handleProtooRequest</span><span class="token punctuation">(</span><span class="token parameter">peer<span class="token punctuation">,</span> request<span class="token punctuation">,</span> accept<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">switch</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>method<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 客户端请求获取 mediasoupRouter 的 rtpCapabilities，即媒体流传输的相关能力参数。</span>
			<span class="token keyword">case</span> <span class="token string">'getRouterRtpCapabilities'</span><span class="token operator">:</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_mediasoupRouter<span class="token punctuation">.</span>rtpCapabilities<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">case</span> <span class="token string">'join'</span><span class="token operator">:</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token comment">// Ensure the Peer is not already joined.</span>
				<span class="token comment">// 检查该客户端是否已经加入了房间。如果已经加入了，就抛出异常。</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>joined<span class="token punctuation">)</span>
					<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Peer already joined'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 从 request.data 中获取客户端传入的 displayName，device，rtpCapabilities 和 sctpCapabilities 参数，</span>
				<span class="token comment">// 并将这些参数保存到该客户端对象的 data 属性中。</span>
				<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span>
					displayName<span class="token punctuation">,</span>
					device<span class="token punctuation">,</span>
					rtpCapabilities<span class="token punctuation">,</span>
					sctpCapabilities
				<span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>data<span class="token punctuation">;</span>

				<span class="token comment">// Store client data into the protoo Peer data object.</span>
				peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>joined <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
				peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>displayName <span class="token operator">=</span> displayName<span class="token punctuation">;</span>
				peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>device <span class="token operator">=</span> device<span class="token punctuation">;</span>
				peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>rtpCapabilities <span class="token operator">=</span> rtpCapabilities<span class="token punctuation">;</span>
				peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>sctpCapabilities <span class="token operator">=</span> sctpCapabilities<span class="token punctuation">;</span>

				<span class="token comment">// Tell the new Peer about already joined Peers.</span>
				<span class="token comment">// And also create Consumers for existing Producers.</span>
				<span class="token comment">// 告诉新 Peer 关于已加入房间的 Peer, 并为现有的 Producer 创建 Consumer。</span>
				<span class="token keyword">const</span> joinedPeers <span class="token operator">=</span>
				<span class="token punctuation">[</span>
					<span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getJoinedPeers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
					<span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>_broadcasters<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">]</span><span class="token punctuation">;</span>

				<span class="token comment">// Reply now the request with the list of joined peers (all but the new one).</span>
				<span class="token comment">// 回复请求并返回除了新加入的 Peer 外的所有已加入的 Peer 列表。</span>
				<span class="token comment">// 即获取已经加入房间的其他客户端对象和广播者对象，然后将这些对象的信息打包成一个列表，</span>
				<span class="token comment">// 发送给新加入的客户端，告诉他有哪些其他客户端和广播者已经在房间中。</span>
				<span class="token keyword">const</span> peerInfos <span class="token operator">=</span> joinedPeers
					<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">joinedPeer</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> joinedPeer<span class="token punctuation">.</span>id <span class="token operator">!==</span> peer<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
					<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">joinedPeer</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
						<span class="token literal-property property">id</span>          <span class="token operator">:</span> joinedPeer<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
						<span class="token literal-property property">displayName</span> <span class="token operator">:</span> joinedPeer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>displayName<span class="token punctuation">,</span>
						<span class="token literal-property property">device</span>      <span class="token operator">:</span> joinedPeer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>device
					<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">peers</span><span class="token operator">:</span> peerInfos <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// Mark the new Peer as joined.</span>
				<span class="token comment">// 将该客户端对象标记为已经加入房间。</span>
				peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>joined <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

				<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> joinedPeer <span class="token keyword">of</span> joinedPeers<span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token comment">// Create Consumers for existing Producers.</span>
					<span class="token comment">// 为现有的 Producer 创建 Consumer。</span>
					<span class="token comment">// 即对于已经加入房间的其他客户端对象，为其创建对应的消费者对象，并将新加入的客户端对象标记为其对应的消费者。</span>
					<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> producer <span class="token keyword">of</span> joinedPeer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>producers<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
					<span class="token punctuation">{<!-- --></span>
						<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createConsumer</span><span class="token punctuation">(</span>
							<span class="token punctuation">{<!-- --></span>
								<span class="token literal-property property">consumerPeer</span> <span class="token operator">:</span> peer<span class="token punctuation">,</span>
								<span class="token literal-property property">producerPeer</span> <span class="token operator">:</span> joinedPeer<span class="token punctuation">,</span>
								producer
							<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>

					<span class="token comment">// Create DataConsumers for existing DataProducers.</span>
					<span class="token comment">// 为现有的 DataProducer 创建 DataConsumer。</span>
					<span class="token comment">// 即对于已经加入房间的其他客户端对象，为其创建对应的数据消费者对象，并将新加入的客户端对象标记为其对应的数据消费者。</span>
					<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> dataProducer <span class="token keyword">of</span> joinedPeer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>dataProducers<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
					<span class="token punctuation">{<!-- --></span>
						<span class="token comment">// 排除 bot DataProducer，即如果数据生产者的标签是 'bot'，则不会创建数据消费者。</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>dataProducer<span class="token punctuation">.</span>label <span class="token operator">===</span> <span class="token string">'bot'</span><span class="token punctuation">)</span>
							<span class="token keyword">continue</span><span class="token punctuation">;</span>

						<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createDataConsumer</span><span class="token punctuation">(</span>
							<span class="token punctuation">{<!-- --></span>
								<span class="token literal-property property">dataConsumerPeer</span> <span class="token operator">:</span> peer<span class="token punctuation">,</span>
								<span class="token literal-property property">dataProducerPeer</span> <span class="token operator">:</span> joinedPeer<span class="token punctuation">,</span>
								dataProducer
							<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>

				<span class="token comment">// Create DataConsumers for bot DataProducer.</span>
				<span class="token comment">// 为 bot DataProducer 创建 DataConsumer。</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createDataConsumer</span><span class="token punctuation">(</span>
					<span class="token punctuation">{<!-- --></span>
						<span class="token literal-property property">dataConsumerPeer</span> <span class="token operator">:</span> peer<span class="token punctuation">,</span>
						<span class="token literal-property property">dataProducerPeer</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
						<span class="token literal-property property">dataProducer</span>     <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_bot<span class="token punctuation">.</span>dataProducer
					<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// Notify the new Peer to all other Peers.</span>
				<span class="token comment">// 将新加入的客户端对象的信息通知给其他已经加入房间的客户端对象，告诉它们新客户端的信息。</span>
				<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> otherPeer <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getJoinedPeers</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">excludePeer</span><span class="token operator">:</span> peer <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>
					otherPeer<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span>
						<span class="token string">'newPeer'</span><span class="token punctuation">,</span>
						<span class="token punctuation">{<!-- --></span>
							<span class="token literal-property property">id</span>          <span class="token operator">:</span> peer<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
							<span class="token literal-property property">displayName</span> <span class="token operator">:</span> peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>displayName<span class="token punctuation">,</span>
							<span class="token literal-property property">device</span>      <span class="token operator">:</span> peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>device
						<span class="token punctuation">}</span><span class="token punctuation">)</span>
						<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>

				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">case</span> <span class="token string">'createWebRtcTransport'</span><span class="token operator">:</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token comment">// NOTE: Don't require that the Peer is joined here, so the client can</span>
				<span class="token comment">// initiate mediasoup Transports and be ready when he later joins.</span>

				<span class="token comment">// 从请求数据中解析出所需的参数</span>
				<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span>
					forceTcp<span class="token punctuation">,</span>
					producing<span class="token punctuation">,</span>
					consuming<span class="token punctuation">,</span>
					sctpCapabilities
				<span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>data<span class="token punctuation">;</span>

				<span class="token comment">// 设置 WebRtcTransport 的选项</span>
				<span class="token keyword">const</span> webRtcTransportOptions <span class="token operator">=</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token operator">...</span>config<span class="token punctuation">.</span>mediasoup<span class="token punctuation">.</span>webRtcTransportOptions<span class="token punctuation">,</span>
					<span class="token literal-property property">enableSctp</span>     <span class="token operator">:</span> <span class="token function">Boolean</span><span class="token punctuation">(</span>sctpCapabilities<span class="token punctuation">)</span><span class="token punctuation">,</span>
					<span class="token literal-property property">numSctpStreams</span> <span class="token operator">:</span> <span class="token punctuation">(</span>sctpCapabilities <span class="token operator">||</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numStreams<span class="token punctuation">,</span>
					<span class="token literal-property property">appData</span>        <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> producing<span class="token punctuation">,</span> consuming <span class="token punctuation">}</span>
				<span class="token punctuation">}</span><span class="token punctuation">;</span>

				<span class="token comment">// 如果设置了 forceTcp，则使用 TCP 连接，否则使用 UDP 连接</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>forceTcp<span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>
					webRtcTransportOptions<span class="token punctuation">.</span>enableUdp <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
					webRtcTransportOptions<span class="token punctuation">.</span>enableTcp <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>

				<span class="token comment">// 创建 WebRtcTransport 对象</span>
				<span class="token keyword">const</span> transport <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_mediasoupRouter<span class="token punctuation">.</span><span class="token function">createWebRtcTransport</span><span class="token punctuation">(</span>
					<span class="token punctuation">{<!-- --></span>
						<span class="token operator">...</span>webRtcTransportOptions<span class="token punctuation">,</span>
						<span class="token literal-property property">webRtcServer</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_webRtcServer
					<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 监听一些事件，用于处理异常情况和跟踪传输状态</span>
				transport<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'sctpstatechange'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">sctpState</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
				<span class="token punctuation">{<!-- --></span>
					logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'WebRtcTransport "sctpstatechange" event [sctpState:%s]'</span><span class="token punctuation">,</span> sctpState<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				transport<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'dtlsstatechange'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">dtlsState</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>dtlsState <span class="token operator">===</span> <span class="token string">'failed'</span> <span class="token operator">||</span> dtlsState <span class="token operator">===</span> <span class="token string">'closed'</span><span class="token punctuation">)</span>
						logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'WebRtcTransport "dtlsstatechange" event [dtlsState:%s]'</span><span class="token punctuation">,</span> dtlsState<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// NOTE: For testing.</span>
				<span class="token comment">// await transport.enableTraceEvent([ 'probation', 'bwe' ]);</span>
				<span class="token comment">// 启用一些跟踪事件</span>
				<span class="token keyword">await</span> transport<span class="token punctuation">.</span><span class="token function">enableTraceEvent</span><span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token string">'bwe'</span> <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				transport<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'trace'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">trace</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
				<span class="token punctuation">{<!-- --></span>
					logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>
						<span class="token string">'transport "trace" event [transportId:%s, trace.type:%s, trace:%o]'</span><span class="token punctuation">,</span>
						transport<span class="token punctuation">.</span>id<span class="token punctuation">,</span> trace<span class="token punctuation">.</span>type<span class="token punctuation">,</span> trace<span class="token punctuation">)</span><span class="token punctuation">;</span>

					<span class="token keyword">if</span> <span class="token punctuation">(</span>trace<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'bwe'</span> <span class="token operator">&amp;&amp;</span> trace<span class="token punctuation">.</span>direction <span class="token operator">===</span> <span class="token string">'out'</span><span class="token punctuation">)</span>
					<span class="token punctuation">{<!-- --></span>
						peer<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span>
							<span class="token string">'downlinkBwe'</span><span class="token punctuation">,</span>
							<span class="token punctuation">{<!-- --></span>
								<span class="token literal-property property">desiredBitrate</span>          <span class="token operator">:</span> trace<span class="token punctuation">.</span>info<span class="token punctuation">.</span>desiredBitrate<span class="token punctuation">,</span>
								<span class="token literal-property property">effectiveDesiredBitrate</span> <span class="token operator">:</span> trace<span class="token punctuation">.</span>info<span class="token punctuation">.</span>effectiveDesiredBitrate<span class="token punctuation">,</span>
								<span class="token literal-property property">availableBitrate</span>        <span class="token operator">:</span> trace<span class="token punctuation">.</span>info<span class="token punctuation">.</span>availableBitrate
							<span class="token punctuation">}</span><span class="token punctuation">)</span>
							<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// Store the WebRtcTransport into the protoo Peer data Object.</span>
				<span class="token comment">// 将创建的 WebRtcTransport 对象存储到 peer.data.transports 中</span>
				peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>transports<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>transport<span class="token punctuation">.</span>id<span class="token punctuation">,</span> transport<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 发送响应消息，包含一些重要参数</span>
				<span class="token function">accept</span><span class="token punctuation">(</span>
					<span class="token punctuation">{<!-- --></span>
						<span class="token literal-property property">id</span>             <span class="token operator">:</span> transport<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
						<span class="token literal-property property">iceParameters</span>  <span class="token operator">:</span> transport<span class="token punctuation">.</span>iceParameters<span class="token punctuation">,</span>
						<span class="token literal-property property">iceCandidates</span>  <span class="token operator">:</span> transport<span class="token punctuation">.</span>iceCandidates<span class="token punctuation">,</span>
						<span class="token literal-property property">dtlsParameters</span> <span class="token operator">:</span> transport<span class="token punctuation">.</span>dtlsParameters<span class="token punctuation">,</span>
						<span class="token literal-property property">sctpParameters</span> <span class="token operator">:</span> transport<span class="token punctuation">.</span>sctpParameters
					<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> maxIncomingBitrate <span class="token punctuation">}</span> <span class="token operator">=</span> config<span class="token punctuation">.</span>mediasoup<span class="token punctuation">.</span>webRtcTransportOptions<span class="token punctuation">;</span>

				<span class="token comment">// If set, apply max incoming bitrate limit.</span>
				<span class="token comment">// 如果设置了 maxIncomingBitrate，则将其应用于创建的 WebRtcTransport 对象</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>maxIncomingBitrate<span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">await</span> transport<span class="token punctuation">.</span><span class="token function">setMaxIncomingBitrate</span><span class="token punctuation">(</span>maxIncomingBitrate<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
					<span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
				<span class="token punctuation">}</span>

				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">case</span> <span class="token string">'connectWebRtcTransport'</span><span class="token operator">:</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token comment">// 从请求中获取 transportId 和 dtlsParameters。</span>
				<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> transportId<span class="token punctuation">,</span> dtlsParameters <span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
				<span class="token comment">// 从 Peer 数据对象中获取 ID 为 transportId 的 WebRtcTransport 对象。</span>
				<span class="token keyword">const</span> transport <span class="token operator">=</span> peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>transports<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>transportId<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 如果没有找到对应的 WebRtcTransport，则抛出一个错误。</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>transport<span class="token punctuation">)</span>
					<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">transport with id "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>transportId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" not found</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 调用 transport.connect() 建立一个 DTLS 连接。</span>
				<span class="token keyword">await</span> transport<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> dtlsParameters <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 发送 accept 消息给客户端，表明连接建立成功。</span>
				<span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">case</span> <span class="token string">'restartIce'</span><span class="token operator">:</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token comment">// 从请求中获取transportId，并通过该id从peer.data.transports中获取transport对象。</span>
				<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> transportId <span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
				<span class="token keyword">const</span> transport <span class="token operator">=</span> peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>transports<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>transportId<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 如果找不到该transport对象，则抛出错误。</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>transport<span class="token punctuation">)</span>
					<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">transport with id "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>transportId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" not found</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 否则，调用transport的restartIce方法重新启动ICE Agent，并返回新的ICE Parameters。</span>
				<span class="token keyword">const</span> iceParameters <span class="token operator">=</span> <span class="token keyword">await</span> transport<span class="token punctuation">.</span><span class="token function">restartIce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 将新的ICE Parameters传递给accept方法返回给客户端。</span>
				<span class="token function">accept</span><span class="token punctuation">(</span>iceParameters<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">case</span> <span class="token string">'produce'</span><span class="token operator">:</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token comment">// Ensure the Peer is joined.</span>
				<span class="token comment">// 首先需要检查客户端是否已经加入到 Room 中，如果没有加入则抛出异常。</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>joined<span class="token punctuation">)</span>
					<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Peer not yet joined'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 解析客户端传来的请求数据，包括 transportId（传输 ID）、kind（音频还是视频）、</span>
				<span class="token comment">// rtpParameters（RTP 参数）和 appData（应用数据）。</span>
				<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> transportId<span class="token punctuation">,</span> kind<span class="token punctuation">,</span> rtpParameters <span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
				<span class="token keyword">let</span> <span class="token punctuation">{<!-- --></span> appData <span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>data<span class="token punctuation">;</span>

				<span class="token comment">// 从 peer 对象中获取传输对象，如果不存在则抛出异常。</span>
				<span class="token keyword">const</span> transport <span class="token operator">=</span> peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>transports<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>transportId<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>transport<span class="token punctuation">)</span>
					<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">transport with id "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>transportId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" not found</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// Add peerId into appData to later get the associated Peer during</span>
				<span class="token comment">// the 'loudest' event of the audioLevelObserver.</span>
				<span class="token comment">// 将 peerId 加入到 appData 中以便稍后在 audioLevelObserver（音频级别观察器）的“loudest”的事件中获取关联的 Peer。</span>
				appData <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token operator">...</span>appData<span class="token punctuation">,</span> <span class="token literal-property property">peerId</span><span class="token operator">:</span> peer<span class="token punctuation">.</span>id <span class="token punctuation">}</span><span class="token punctuation">;</span>

				<span class="token comment">// 使用 transport.produce() 方法创建一个新的 Producer 对象。并将 Producer 存储到 peer.data.producers 中以便稍后使用。</span>
				<span class="token keyword">const</span> producer <span class="token operator">=</span> <span class="token keyword">await</span> transport<span class="token punctuation">.</span><span class="token function">produce</span><span class="token punctuation">(</span>
					<span class="token punctuation">{<!-- --></span>
						kind<span class="token punctuation">,</span>
						rtpParameters<span class="token punctuation">,</span>
						appData
						<span class="token comment">// keyFrameRequestDelay: 5000</span>
					<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// Store the Producer into the protoo Peer data Object.</span>
				peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>producers<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>producer<span class="token punctuation">.</span>id<span class="token punctuation">,</span> producer<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// Set Producer events.</span>
				<span class="token comment">// 设置 Producer 的事件监听器，包括 score、videoorientationchange 和 trace 事件。</span>
				<span class="token comment">// 其中，score 事件在 Producer 的“质量”改变时触发，通常用于在客户端中显示相关信息；</span>
				producer<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'score'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">score</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token comment">// logger.debug(</span>
					<span class="token comment">// 	'producer "score" event [producerId:%s, score:%o]',</span>
					<span class="token comment">// 	producer.id, score);</span>

					peer<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token string">'producerScore'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">producerId</span><span class="token operator">:</span> producer<span class="token punctuation">.</span>id<span class="token punctuation">,</span> score <span class="token punctuation">}</span><span class="token punctuation">)</span>
						<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// videoorientationchange 事件在视频流的方向改变时触发；</span>
				producer<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'videoorientationchange'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">videoOrientation</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
				<span class="token punctuation">{<!-- --></span>
					logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>
						<span class="token string">'producer "videoorientationchange" event [producerId:%s, videoOrientation:%o]'</span><span class="token punctuation">,</span>
						producer<span class="token punctuation">.</span>id<span class="token punctuation">,</span> videoOrientation<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// NOTE: For testing.</span>
				<span class="token comment">// await producer.enableTraceEvent([ 'rtp', 'keyframe', 'nack', 'pli', 'fir' ]);</span>
				<span class="token comment">// await producer.enableTraceEvent([ 'pli', 'fir' ]);</span>
				<span class="token comment">// await producer.enableTraceEvent([ 'keyframe' ]);</span>

				<span class="token comment">// trace 事件用于记录调试信息。</span>
				producer<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'trace'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">trace</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
				<span class="token punctuation">{<!-- --></span>
					logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>
						<span class="token string">'producer "trace" event [producerId:%s, trace.type:%s, trace:%o]'</span><span class="token punctuation">,</span>
						producer<span class="token punctuation">.</span>id<span class="token punctuation">,</span> trace<span class="token punctuation">.</span>type<span class="token punctuation">,</span> trace<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 向客户端发送 accept 响应，携带创建的 Producer 对象的 id。</span>
				<span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">id</span><span class="token operator">:</span> producer<span class="token punctuation">.</span>id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// Optimization: Create a server-side Consumer for each Peer.</span>
				<span class="token comment">// 为每个已经加入 Room 的 Peer 创建一个新的 Consumer 对象。这是为了让每个客户端都能接收到新创建的 Producer 产生的音视频流。</span>
				<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> otherPeer <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getJoinedPeers</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">excludePeer</span><span class="token operator">:</span> peer <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createConsumer</span><span class="token punctuation">(</span>
						<span class="token punctuation">{<!-- --></span>
							<span class="token literal-property property">consumerPeer</span> <span class="token operator">:</span> otherPeer<span class="token punctuation">,</span>
							<span class="token literal-property property">producerPeer</span> <span class="token operator">:</span> peer<span class="token punctuation">,</span>
							producer
						<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>

				<span class="token comment">// Add into the AudioLevelObserver and ActiveSpeakerObserver.</span>
				<span class="token comment">// 如果创建的 Producer 是音频流，则还会将其添加到 _audioLevelObserver 和 _activeSpeakerObserver 中，</span>
				<span class="token comment">// 这两个对象都是用来监控音频流的。_audioLevelObserver 用于监测音频的音量级别，_activeSpeakerObserver</span>
				<span class="token comment">// 用于监测当前说话人的身份。当有新的音频流加入时，需要将其添加到这两个对象中以进行监控。</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>producer<span class="token punctuation">.</span>kind <span class="token operator">===</span> <span class="token string">'audio'</span><span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token keyword">this</span><span class="token punctuation">.</span>_audioLevelObserver<span class="token punctuation">.</span><span class="token function">addProducer</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">producerId</span><span class="token operator">:</span> producer<span class="token punctuation">.</span>id <span class="token punctuation">}</span><span class="token punctuation">)</span>
						<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

					<span class="token keyword">this</span><span class="token punctuation">.</span>_activeSpeakerObserver<span class="token punctuation">.</span><span class="token function">addProducer</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">producerId</span><span class="token operator">:</span> producer<span class="token punctuation">.</span>id <span class="token punctuation">}</span><span class="token punctuation">)</span>
						<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>

				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">case</span> <span class="token string">'closeProducer'</span><span class="token operator">:</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token comment">// Ensure the Peer is joined.</span>
				<span class="token comment">// 确保对等端已经加入房间，如果对等端未加入房间，则会抛出错误。这是为了确保对等端具有足够的权限来关闭生产者。</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>joined<span class="token punctuation">)</span>
					<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Peer not yet joined'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 从 peer.data.producers Map 中查找具有相应 producerId 的生产者对象。如果没有找到该生产者对象，则会抛出错误。</span>
				<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> producerId <span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
				<span class="token keyword">const</span> producer <span class="token operator">=</span> peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>producers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>producerId<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>producer<span class="token punctuation">)</span>
					<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">producer with id "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>producerId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" not found</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 关闭生产者。</span>
				producer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// Remove from its map.</span>
				<span class="token comment">// 从 peer.data.producers Map 中删除该生产者对象，以确保不再使用该生产者对象。</span>
				peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>producers<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>producer<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 向客户端发送成功响应</span>
				<span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">case</span> <span class="token string">'pauseProducer'</span><span class="token operator">:</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token comment">// Ensure the Peer is joined.</span>
				<span class="token comment">// 确保对等端已经加入房间，如果对等端未加入房间，则会抛出错误。这是为了确保对等端具有足够的权限来暂停生产者。</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>joined<span class="token punctuation">)</span>
					<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Peer not yet joined'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 从 peer.data.producers Map 中查找具有相应 producerId 的生产者对象。如果没有找到该生产者对象，则会抛出错误。</span>
				<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> producerId <span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
				<span class="token keyword">const</span> producer <span class="token operator">=</span> peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>producers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>producerId<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>producer<span class="token punctuation">)</span>
					<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">producer with id "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>producerId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" not found</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 暂停生产者，此时，生产者将停止发送媒体流，但不会关闭生产者对象。</span>
				<span class="token comment">// await 关键字来等待 producer.pause() 方法完成后再继续执行。</span>
				<span class="token keyword">await</span> producer<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 向客户端发送成功响应。</span>
				<span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">case</span> <span class="token string">'resumeProducer'</span><span class="token operator">:</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token comment">// Ensure the Peer is joined.</span>
				<span class="token comment">// 保对等端已经加入房间，如果对等端未加入房间，则会抛出错误。这是为了确保对等端具有足够的权限来恢复生产者。</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>joined<span class="token punctuation">)</span>
					<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Peer not yet joined'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 从 peer.data.producers Map 中查找具有相应 producerId 的生产者对象。如果没有找到该生产者对象，则会抛出错误。</span>
				<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> producerId <span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
				<span class="token keyword">const</span> producer <span class="token operator">=</span> peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>producers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>producerId<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>producer<span class="token punctuation">)</span>
					<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">producer with id "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>producerId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" not found</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 恢复生产者，此时，生产者将重新开始发送媒体流。</span>
				<span class="token keyword">await</span> producer<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 向客户端发送成功响应。</span>
				<span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">case</span> <span class="token string">'pauseConsumer'</span><span class="token operator">:</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token comment">// Ensure the Peer is joined.</span>
				<span class="token comment">// 确保对等端已经加入房间，如果对等端未加入房间，则会抛出错误。这是为了确保对等端具有足够的权限来暂停消费者。</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>joined<span class="token punctuation">)</span>
					<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Peer not yet joined'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 从 peer.data.consumers Map 中查找具有相应 consumerId 的消费者对象。如果没有找到该消费者对象，则会抛出错误。</span>
				<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> consumerId <span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
				<span class="token keyword">const</span> consumer <span class="token operator">=</span> peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>consumers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>consumerId<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>consumer<span class="token punctuation">)</span>
					<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">consumer with id "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>consumerId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" not found</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 暂停消费者，此时，消费者将停止接收媒体流。</span>
				<span class="token keyword">await</span> consumer<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 向客户端发送成功响应。</span>
				<span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">case</span> <span class="token string">'resumeConsumer'</span><span class="token operator">:</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token comment">// Ensure the Peer is joined.</span>
				<span class="token comment">// 确保对等端已经加入房间，如果对等端未加入房间，则会抛出错误。这是为了确保对等端具有足够的权限来恢复消费者。</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>joined<span class="token punctuation">)</span>
					<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Peer not yet joined'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 从 peer.data.consumers Map 中查找具有相应 consumerId 的消费者对象。如果没有找到该消费者对象，则会抛出错误。</span>
				<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> consumerId <span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
				<span class="token keyword">const</span> consumer <span class="token operator">=</span> peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>consumers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>consumerId<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>consumer<span class="token punctuation">)</span>
					<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">consumer with id "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>consumerId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" not found</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 找到了该消费者对象，则调用其 resume() 方法来恢复消费者。此时，消费者将重新开始接收媒体流。</span>
				<span class="token keyword">await</span> consumer<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 向客户端发送成功响应。</span>
				<span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">case</span> <span class="token string">'setConsumerPreferredLayers'</span><span class="token operator">:</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token comment">// Ensure the Peer is joined.</span>
				<span class="token comment">// 确保对等端已经加入房间，如果对等端未加入房间，则会抛出错误。这是为了确保对等端具有足够的权限来设置消费者的首选图层。</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>joined<span class="token punctuation">)</span>
					<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Peer not yet joined'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 检查传入的请求中是否包含消费者的 consumerId、spatialLayer 和 temporalLayer。</span>
				<span class="token comment">// 然后，函数会从 peer.data.consumers Map 中查找具有相应 consumerId 的消费者对象。如果没有找到该消费者对象，则会抛出错误。</span>
				<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> consumerId<span class="token punctuation">,</span> spatialLayer<span class="token punctuation">,</span> temporalLayer <span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
				<span class="token keyword">const</span> consumer <span class="token operator">=</span> peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>consumers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>consumerId<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>consumer<span class="token punctuation">)</span>
					<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">consumer with id "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>consumerId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" not found</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 设置消费者的首选图层，此时，消费者将会尝试根据指定的首选图层来选择合适的媒体流。</span>
				<span class="token keyword">await</span> consumer<span class="token punctuation">.</span><span class="token function">setPreferredLayers</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> spatialLayer<span class="token punctuation">,</span> temporalLayer <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 向客户端发送成功响应。</span>
				<span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">case</span> <span class="token string">'setConsumerPriority'</span><span class="token operator">:</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token comment">// Ensure the Peer is joined.</span>
				<span class="token comment">// 判断该 Peer 是否已经加入了房间，如果没有加入，则抛出异常</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>joined<span class="token punctuation">)</span>
					<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Peer not yet joined'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 检查传入的请求中是否包含消费者的 consumerId、priority。</span>
				<span class="token comment">// 然后，函数会从 peer.data.consumers Map 中查找具有相应 consumerId 的消费者对象。如果没有找到该消费者对象，则会抛出错误。</span>
				<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> consumerId<span class="token punctuation">,</span> priority <span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
				<span class="token keyword">const</span> consumer <span class="token operator">=</span> peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>consumers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>consumerId<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>consumer<span class="token punctuation">)</span>
					<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">consumer with id "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>consumerId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" not found</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 设置优先级，参数 priority，表示优先级，其取值范围为 1~10。</span>
				<span class="token comment">// 该方法会向消费者所在的生产者（Producer）发送一个 RTCP feedback message，以通知生产者当前消费者的优先级已发生变化。</span>
				<span class="token keyword">await</span> consumer<span class="token punctuation">.</span><span class="token function">setPriority</span><span class="token punctuation">(</span>priority<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 向客户端发送成功响应。</span>
				<span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">case</span> <span class="token string">'requestConsumerKeyFrame'</span><span class="token operator">:</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token comment">// Ensure the Peer is joined.</span>
				<span class="token comment">// 确保 Peer 已经加入房间，否则抛出异常。</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>joined<span class="token punctuation">)</span>
					<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Peer not yet joined'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 检查传入的请求中是否包含消费者的 consumerId。</span>
				<span class="token comment">// 然后，函数会从 peer.data.consumers Map 中查找具有相应 consumerId 的消费者对象。如果没有找到该消费者对象，则会抛出错误。</span>
				<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> consumerId <span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
				<span class="token keyword">const</span> consumer <span class="token operator">=</span> peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>consumers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>consumerId<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>consumer<span class="token punctuation">)</span>
					<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">consumer with id "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>consumerId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" not found</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 向生产者（Producer）发送请求，要求它在当前视频流中生成关键帧。</span>
				<span class="token keyword">await</span> consumer<span class="token punctuation">.</span><span class="token function">requestKeyFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 向客户端发送成功响应。</span>
				<span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">case</span> <span class="token string">'produceData'</span><span class="token operator">:</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token comment">// Ensure the Peer is joined.</span>
				<span class="token comment">// 首先判断Peer是否已经加入房间，如果没有加入则抛出错误。</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>joined<span class="token punctuation">)</span>
					<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Peer not yet joined'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 从请求中获取所需参数，包括transportId、sctpStreamParameters、label、protocol和appData。</span>
				<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span>
					transportId<span class="token punctuation">,</span>
					sctpStreamParameters<span class="token punctuation">,</span>
					label<span class="token punctuation">,</span>
					protocol<span class="token punctuation">,</span>
					appData
				<span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>data<span class="token punctuation">;</span>

				<span class="token comment">// 根据transportId获取Transport对象，如果不存在则抛出错误。</span>
				<span class="token keyword">const</span> transport <span class="token operator">=</span> peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>transports<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>transportId<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>transport<span class="token punctuation">)</span>
					<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">transport with id "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>transportId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" not found</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 调用transport对象的produceData方法创建数据生产者，传入sctpStreamParameters、label、protocol和appData等参数。</span>
				<span class="token keyword">const</span> dataProducer <span class="token operator">=</span> <span class="token keyword">await</span> transport<span class="token punctuation">.</span><span class="token function">produceData</span><span class="token punctuation">(</span>
					<span class="token punctuation">{<!-- --></span>
						sctpStreamParameters<span class="token punctuation">,</span>
						label<span class="token punctuation">,</span>
						protocol<span class="token punctuation">,</span>
						appData
					<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// Store the Producer into the protoo Peer data Object.</span>
				<span class="token comment">// 将创建的数据生产者存储在Peer对象的dataProducers属性中，使用dataProducer.id作为key。</span>
				peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>dataProducers<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>dataProducer<span class="token punctuation">.</span>id<span class="token punctuation">,</span> dataProducer<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 使用accept方法向客户端返回数据生产者的id。</span>
				<span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">id</span><span class="token operator">:</span> dataProducer<span class="token punctuation">.</span>id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 根据数据生产者的label值进行相应的处理：</span>
				<span class="token keyword">switch</span> <span class="token punctuation">(</span>dataProducer<span class="token punctuation">.</span>label<span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token comment">// 如果是"chat"，则为每个已加入的Peer创建一个数据消费者。</span>
					<span class="token keyword">case</span> <span class="token string">'chat'</span><span class="token operator">:</span>
					<span class="token punctuation">{<!-- --></span>
						<span class="token comment">// Create a server-side DataConsumer for each Peer.</span>
						<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> otherPeer <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getJoinedPeers</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">excludePeer</span><span class="token operator">:</span> peer <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
						<span class="token punctuation">{<!-- --></span>
							<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createDataConsumer</span><span class="token punctuation">(</span>
								<span class="token punctuation">{<!-- --></span>
									<span class="token literal-property property">dataConsumerPeer</span> <span class="token operator">:</span> otherPeer<span class="token punctuation">,</span>
									<span class="token literal-property property">dataProducerPeer</span> <span class="token operator">:</span> peer<span class="token punctuation">,</span>
									dataProducer
								<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>

						<span class="token keyword">break</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>

					<span class="token comment">// 如果是"bot"，则将数据生产者传递给bot进行处理。</span>
					<span class="token keyword">case</span> <span class="token string">'bot'</span><span class="token operator">:</span>
					<span class="token punctuation">{<!-- --></span>
						<span class="token comment">// Pass it to the bot.</span>
						<span class="token keyword">this</span><span class="token punctuation">.</span>_bot<span class="token punctuation">.</span><span class="token function">handlePeerDataProducer</span><span class="token punctuation">(</span>
							<span class="token punctuation">{<!-- --></span>
								<span class="token literal-property property">dataProducerId</span> <span class="token operator">:</span> dataProducer<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
								peer
							<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

						<span class="token keyword">break</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>

				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">case</span> <span class="token string">'changeDisplayName'</span><span class="token operator">:</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token comment">// Ensure the Peer is joined.</span>
				<span class="token comment">// 首先判断Peer是否已经加入房间，如果没有加入则抛出错误。</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>joined<span class="token punctuation">)</span>
					<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Peer not yet joined'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 从请求数据中获取新的显示名称，并保存到protoo Peer的自定义数据对象中。同时，获取旧的显示名称。</span>
				<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> displayName <span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
				<span class="token keyword">const</span> oldDisplayName <span class="token operator">=</span> peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>displayName<span class="token punctuation">;</span>

				<span class="token comment">// Store the display name into the custom data Object of the protoo</span>
				<span class="token comment">// Peer.</span>
				<span class="token comment">// 更新peer对象中的displayName字段为新的显示名称。</span>
				peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>displayName <span class="token operator">=</span> displayName<span class="token punctuation">;</span>

				<span class="token comment">// Notify other joined Peers.</span>
				<span class="token comment">// 通知其他已加入房间的用户，该用户的显示名称已经更改。遍历其他加入的用户并使用notify函数发送通知。</span>
				<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> otherPeer <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getJoinedPeers</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">excludePeer</span><span class="token operator">:</span> peer <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>
					otherPeer<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span>
						<span class="token string">'peerDisplayNameChanged'</span><span class="token punctuation">,</span>
						<span class="token punctuation">{<!-- --></span>
							<span class="token literal-property property">peerId</span> <span class="token operator">:</span> peer<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
							displayName<span class="token punctuation">,</span>
							oldDisplayName
						<span class="token punctuation">}</span><span class="token punctuation">)</span>
						<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>

				<span class="token comment">// 向客户端发送成功响应。</span>
				<span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">case</span> <span class="token string">'getTransportStats'</span><span class="token operator">:</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token comment">// 从request.data中获取transportId，然后从peer.data.transports中查找对应的transport对象。如果找不到，将会抛出一个异常。</span>
				<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> transportId <span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
				<span class="token keyword">const</span> transport <span class="token operator">=</span> peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>transports<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>transportId<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>transport<span class="token punctuation">)</span>
					<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">transport with id "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>transportId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" not found</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 获取统计信息，并将返回的结果作为accept函数的参数进行回复给客户端。</span>
				<span class="token keyword">const</span> stats <span class="token operator">=</span> <span class="token keyword">await</span> transport<span class="token punctuation">.</span><span class="token function">getStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token function">accept</span><span class="token punctuation">(</span>stats<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">case</span> <span class="token string">'getProducerStats'</span><span class="token operator">:</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> producerId <span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
				<span class="token keyword">const</span> producer <span class="token operator">=</span> peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>producers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>producerId<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>producer<span class="token punctuation">)</span>
					<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">producer with id "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>producerId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" not found</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">const</span> stats <span class="token operator">=</span> <span class="token keyword">await</span> producer<span class="token punctuation">.</span><span class="token function">getStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token function">accept</span><span class="token punctuation">(</span>stats<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">case</span> <span class="token string">'getConsumerStats'</span><span class="token operator">:</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token comment">// 从请求数据中获取要获取统计信息的消费者的ID。然后，使用该ID从peer对象的data属性中获取消费者实例。</span>
				<span class="token comment">// 如果没有找到该ID对应的消费者实例，则抛出异常。</span>
				<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> consumerId <span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
				<span class="token keyword">const</span> consumer <span class="token operator">=</span> peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>consumers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>consumerId<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>consumer<span class="token punctuation">)</span>
					<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">consumer with id "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>consumerId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" not found</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 获取该消费者的统计信息。</span>
				<span class="token keyword">const</span> stats <span class="token operator">=</span> <span class="token keyword">await</span> consumer<span class="token punctuation">.</span><span class="token function">getStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 使用accept方法将获取到的统计信息作为参数返回给客户端。</span>
				<span class="token function">accept</span><span class="token punctuation">(</span>stats<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">case</span> <span class="token string">'getDataProducerStats'</span><span class="token operator">:</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token comment">// 从请求的数据中获取dataProducerId。</span>
				<span class="token comment">// 通过查找peer.data.dataProducers Map中的数据，找到对应的DataProducer。如果没有找到，则抛出异常。</span>
				<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> dataProducerId <span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
				<span class="token keyword">const</span> dataProducer <span class="token operator">=</span> peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>dataProducers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>dataProducerId<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dataProducer<span class="token punctuation">)</span>
					<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">dataProducer with id "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>dataProducerId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" not found</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 获取该DataProducer的统计信息。</span>
				<span class="token keyword">const</span> stats <span class="token operator">=</span> <span class="token keyword">await</span> dataProducer<span class="token punctuation">.</span><span class="token function">getStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 将获取到的统计信息作为参数调用accept函数，向请求的Peer返回获取到的数据。</span>
				<span class="token function">accept</span><span class="token punctuation">(</span>stats<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">case</span> <span class="token string">'getDataConsumerStats'</span><span class="token operator">:</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token comment">// 从请求中获取DataConsumer的ID，然后通过该ID从客户端对应的Peer对象的dataConsumers Map中获取对应的DataConsumer对象。</span>
				<span class="token comment">// 如果没有找到该对象，则抛出一个错误。</span>
				<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> dataConsumerId <span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
				<span class="token keyword">const</span> dataConsumer <span class="token operator">=</span> peer<span class="token punctuation">.</span>data<span class="token punctuation">.</span>dataConsumers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>dataConsumerId<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dataConsumer<span class="token punctuation">)</span>
					<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">dataConsumer with id "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>dataConsumerId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" not found</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 使用获取到的DataConsumer对象调用getStats方法获取统计数据，并将结果通过accept方法返回给客户端。</span>
				<span class="token comment">// 统计数据包括：包的数量、字节数、丢失的包数量等等。</span>
				<span class="token keyword">const</span> stats <span class="token operator">=</span> <span class="token keyword">await</span> dataConsumer<span class="token punctuation">.</span><span class="token function">getStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token function">accept</span><span class="token punctuation">(</span>stats<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">case</span> <span class="token string">'applyNetworkThrottle'</span><span class="token operator">:</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">const</span> DefaultUplink <span class="token operator">=</span> <span class="token number">1000000</span><span class="token punctuation">;</span>
				<span class="token keyword">const</span> DefaultDownlink <span class="token operator">=</span> <span class="token number">1000000</span><span class="token punctuation">;</span>
				<span class="token keyword">const</span> DefaultRtt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

				<span class="token comment">// 检查请求是否包含正确的“secret”值。如果未提供或与预期值不匹配，则服务器将拒绝该请求并返回一个403 Forbidden错误。</span>
				<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> uplink<span class="token punctuation">,</span> downlink<span class="token punctuation">,</span> rtt<span class="token punctuation">,</span> secret <span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>data<span class="token punctuation">;</span>

				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>secret <span class="token operator">||</span> secret <span class="token operator">!==</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NETWORK_THROTTLE_SECRET</span><span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">,</span> <span class="token string">'operation NOT allowed, modda fuckaa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

					<span class="token keyword">return</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>

				<span class="token keyword">try</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token comment">// 解析请求中提供的上行、下行带宽和往返延迟等参数，并将它们传递给一个名为“throttle”的模块。</span>
					<span class="token comment">// 该模块的作用是模拟网络限制的效果。</span>
					<span class="token keyword">await</span> throttle<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>
						<span class="token punctuation">{<!-- --></span>
							<span class="token literal-property property">up</span>   <span class="token operator">:</span> uplink <span class="token operator">||</span> DefaultUplink<span class="token punctuation">,</span>
							<span class="token literal-property property">down</span> <span class="token operator">:</span> downlink <span class="token operator">||</span> DefaultDownlink<span class="token punctuation">,</span>
							<span class="token literal-property property">rtt</span>  <span class="token operator">:</span> rtt <span class="token operator">||</span> DefaultRtt
						<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

					<span class="token comment">// 在成功应用网络限制后，服务器会将新的带宽和延迟值记录在日志中，并返回一个成功响应给客户端。</span>
					logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>
						<span class="token string">'network throttle set [uplink:%s, downlink:%s, rtt:%s]'</span><span class="token punctuation">,</span>
						uplink <span class="token operator">||</span> DefaultUplink<span class="token punctuation">,</span>
						downlink <span class="token operator">||</span> DefaultDownlink<span class="token punctuation">,</span>
						rtt <span class="token operator">||</span> DefaultRtt<span class="token punctuation">)</span><span class="token punctuation">;</span>

					<span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token comment">// 在发生任何错误时，服务器将记录错误并返回一个500 Internal Server Error响应给客户端。</span>
					logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'network throttle apply failed: %o'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>

					<span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> error<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>

				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">case</span> <span class="token string">'resetNetworkThrottle'</span><span class="token operator">:</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> secret <span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>data<span class="token punctuation">;</span>

				<span class="token comment">// 如果 secret 值不存在或者不等于环境变量 NETWORK_THROTTLE_SECRET 的值，则拒绝请求并返回 403 错误状态码和相应的错误信息</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>secret <span class="token operator">||</span> secret <span class="token operator">!==</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NETWORK_THROTTLE_SECRET</span><span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">,</span> <span class="token string">'operation NOT allowed, modda fuckaa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

					<span class="token keyword">return</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>

				<span class="token keyword">try</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token comment">// 调用 throttle.stop() 方法停止网络限制</span>
					<span class="token keyword">await</span> throttle<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

					<span class="token comment">// 记录日志，表示网络限制已停止</span>
					logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'network throttle stopped'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

					<span class="token comment">// 返回成功状态和空的数据对象</span>
					<span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token comment">// 如果停止网络限制失败，则记录错误日志并返回 500 错误状态码和相应的错误信息</span>
					logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'network throttle stop failed: %o'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>

					<span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> error<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>

				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">default</span><span class="token operator">:</span>
			<span class="token punctuation">{<!-- --></span>
				logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'unknown request.method "%s"'</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">unknown request.method "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>request<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f08de7f09882f17be7b4a29c718ffaff/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Ubuntu/Docker环境下调试mediasoup-demo</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4238b609b43c50ebab4a85982ce2708b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">mediasoup基本介绍及Ubuntu/Docker环境下部署mediasoup</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>