<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>2022科大讯飞商品销量智能预测挑战赛—参赛总结 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="2022科大讯飞商品销量智能预测挑战赛—参赛总结" />
<meta property="og:description" content="2022科大讯飞商品销量智能预测挑战赛—参赛总结 目录 2022科大讯飞商品销量智能预测挑战赛—参赛总结摘要赛题任务特征构建训练方案模型融合赛题得分 写在最后 摘要 比赛网址：https://challenge.xfyun.cn/topic/info?type=product-sales赛题任务：本次大赛提供了商品销量历史数据作为训练样本，参赛选手需基于提供的样本构建模型，预测商品未来三个月的销售量。初赛提供了2018年2月1日至2020年12月31日的若干商品历史销量数据和订单数据，预测其2021年1月至3月的销量数据。决赛提供了2018年2月1日至2021年3月31日的若干商品历史销量数据和订单数据，预测其2021年4月至6月的销量数据。相当于复赛时提供了初赛测试集的标签，这一点在复赛时可以利用起来，能够节省不少提交次数。而且赛后也可以继续研究。数据分析：提供的数据集的销量是细分到每一天的，但预测是要细分到月份的，因此，可以有两种角度去预测销量。第一是按天进行预测，但是有些特征是没有提供细分到天的数据的，特征相对按月预测会少一点；第二种是按月预测，这就需要先将销量按月汇总起来构建标签。最后我是选择了第二种。特征构建：主要用到了lag和rolling聚合的mean、std、median特征。模型选择：采用比赛常用模型：lightgbm、xgboost和catboost分别构建回归模型，最后并用TPE搜索最优参数组合。训练方案：每个模型均使用5折交叉验证，以product_id均衡划分训练集和验证集，对测试集的预测值取平均即得到该模型最终的预测值。模型融合：对三个5折交叉验证后的模型结果，采用stacking进行模型融合。赛题得分：初赛最终成绩：0.70854分，排名：第71名；复赛最终成绩：0.74399分，排名：第46名。总结结论：这是我参加比赛以来第二次进入复赛阶段的比赛，很有纪念意义，虽然跟前排大佬还有很大的差距，但是从中也学习到了很多知识，有机会下次再来~ 赛题任务 特征构建 并没有构建过多的特征，因为我发现即使构建更多的lag或者rolling特征，也不会有提升，甚至是降分的。期间有通过根据特征重要性、shap、与标签的相关性来筛选特征，但筛选后的效果也不是很好。一直都没有找到比较强的特征。下面是部分代码：
feats_cols=[] for i in range(1, 17): for f in [&#39;label&#39;, &#39;order&#39;, &#39;start_stock&#39;, &#39;end_stock&#39;]: data[f&#43;&#39;_shift_%d&#39;%i] = data.groupby(&#39;product_id&#39;)[f].shift(i&#43;2) if i &lt;= 12: feats_cols.append(f&#43;&#39;_shift_%d&#39;%i) for i in [3, 6, 12]: for f in [&#39;label&#39;, &#39;order&#39;, &#39;start_stock&#39;, &#39;end_stock&#39;]: data[f&#43;&#39;_mean_%d&#39;%i] = data[[f&#43;&#39;_shift_%d&#39;%i for i in range(1, i&#43;1)]].mean(axis=1) data[f&#43;&#39;_std_%d&#39;%i] = data[[f&#43;&#39;_shift_%d&#39;%i for i in range(1, i&#43;1)]].std(axis=1) data[f&#43;&#39;_median_%d&#39;%i] = data[[f&#43;&#39;_shift_%d&#39;%i for i in range(1, i&#43;1)]].median(axis=1) feats_cols.extend([f&#43;&#39;_mean_%d&#39;%i,f&#43;&#39;_std_%d&#39;%i,f&#43;&#39;_median_%d&#39;%i]) 训练方案 使用StratifiedKFold按product_id均衡划分训练集和验证集进行5折交叉验证，期间对比过使用KFold来划分，实验验证StratifiedKFold要更胜一筹，分别训练lightgbm、xgboost和catboost三个模型。训练代码如下：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/5e397f65e36dcac39feb0f9306bcfca9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-10T09:00:00+08:00" />
<meta property="article:modified_time" content="2022-09-10T09:00:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">2022科大讯飞商品销量智能预测挑战赛—参赛总结</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="2022_0"></a>2022科大讯飞商品销量智能预测挑战赛—参赛总结</h2> 
<p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#2022_0" rel="nofollow">2022科大讯飞商品销量智能预测挑战赛—参赛总结</a></li><li><ul><li><a href="#_3" rel="nofollow">摘要</a></li><li><ul><li><a href="#_13" rel="nofollow">赛题任务</a></li><li><a href="#_15" rel="nofollow">特征构建</a></li><li><a href="#_35" rel="nofollow">训练方案</a></li><li><a href="#_123" rel="nofollow">模型融合</a></li><li><a href="#_155" rel="nofollow">赛题得分</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_171" rel="nofollow">写在最后</a></li></ul> 
</div> 
<p></p> 
<h3><a id="_3"></a>摘要</h3> 
<ul><li><code>比赛网址</code>：<a href="https://challenge.xfyun.cn/topic/info?type=product-sales" rel="nofollow">https://challenge.xfyun.cn/topic/info?type=product-sales</a></li><li><code>赛题任务</code>：本次大赛提供了商品销量历史数据作为训练样本，参赛选手需基于提供的样本构建模型，预测商品未来三个月的销售量。初赛提供了2018年2月1日至2020年12月31日的若干商品历史销量数据和订单数据，预测其2021年1月至3月的销量数据。决赛提供了2018年2月1日至2021年3月31日的若干商品历史销量数据和订单数据，预测其2021年4月至6月的销量数据。<strong>相当于复赛时提供了初赛测试集的标签，这一点在复赛时可以利用起来，能够节省不少提交次数。而且赛后也可以继续研究。</strong></li><li><code>数据分析</code>：提供的数据集的销量是细分到每一天的，但预测是要细分到月份的，因此，可以有两种角度去预测销量。第一是按天进行预测，但是有些特征是没有提供细分到天的数据的，特征相对按月预测会少一点；第二种是按月预测，这就需要先将销量按月汇总起来构建标签。最后我是选择了第二种。</li><li><code>特征构建</code>：主要用到了lag和rolling聚合的mean、std、median特征。</li><li><code>模型选择</code>：采用比赛常用模型：lightgbm、xgboost和catboost分别构建回归模型，最后并用TPE搜索最优参数组合。</li><li><code>训练方案</code>：每个模型均使用5折交叉验证，以product_id均衡划分训练集和验证集，对测试集的预测值取平均即得到该模型最终的预测值。</li><li><code>模型融合</code>：对三个5折交叉验证后的模型结果，采用stacking进行模型融合。</li><li><code>赛题得分</code>：初赛最终成绩：0.70854分，排名：第71名；复赛最终成绩：0.74399分，排名：第46名。</li><li><code>总结结论</code>：这是我参加比赛以来第二次进入复赛阶段的比赛，很有纪念意义，虽然跟前排大佬还有很大的差距，但是从中也学习到了很多知识，有机会下次再来~</li></ul> 
<h4><a id="_13"></a>赛题任务</h4> 
<p><img src="https://images2.imgbox.com/0f/fb/jipuCaGx_o.png" alt=""></p> 
<h4><a id="_15"></a>特征构建</h4> 
<p>并没有构建过多的特征，因为我发现即使构建更多的lag或者rolling特征，也不会有提升，甚至是降分的。期间有通过根据特征重要性、shap、与标签的相关性来筛选特征，但筛选后的效果也不是很好。一直都没有找到比较强的特征。下面是部分代码：</p> 
<pre><code class="prism language-python">feats_cols<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> f <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">,</span> <span class="token string">'order'</span><span class="token punctuation">,</span> <span class="token string">'start_stock'</span><span class="token punctuation">,</span> <span class="token string">'end_stock'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        data<span class="token punctuation">[</span>f<span class="token operator">+</span><span class="token string">'_shift_%d'</span><span class="token operator">%</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'product_id'</span><span class="token punctuation">)</span><span class="token punctuation">[</span>f<span class="token punctuation">]</span><span class="token punctuation">.</span>shift<span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> i <span class="token operator">&lt;=</span> <span class="token number">12</span><span class="token punctuation">:</span>
            feats_cols<span class="token punctuation">.</span>append<span class="token punctuation">(</span>f<span class="token operator">+</span><span class="token string">'_shift_%d'</span><span class="token operator">%</span>i<span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> f <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">,</span> <span class="token string">'order'</span><span class="token punctuation">,</span> <span class="token string">'start_stock'</span><span class="token punctuation">,</span> <span class="token string">'end_stock'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        data<span class="token punctuation">[</span>f<span class="token operator">+</span><span class="token string">'_mean_%d'</span><span class="token operator">%</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token punctuation">[</span>f<span class="token operator">+</span><span class="token string">'_shift_%d'</span><span class="token operator">%</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        data<span class="token punctuation">[</span>f<span class="token operator">+</span><span class="token string">'_std_%d'</span><span class="token operator">%</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token punctuation">[</span>f<span class="token operator">+</span><span class="token string">'_shift_%d'</span><span class="token operator">%</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>std<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        data<span class="token punctuation">[</span>f<span class="token operator">+</span><span class="token string">'_median_%d'</span><span class="token operator">%</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token punctuation">[</span>f<span class="token operator">+</span><span class="token string">'_shift_%d'</span><span class="token operator">%</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>median<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        feats_cols<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token punctuation">[</span>f<span class="token operator">+</span><span class="token string">'_mean_%d'</span><span class="token operator">%</span>i<span class="token punctuation">,</span>f<span class="token operator">+</span><span class="token string">'_std_%d'</span><span class="token operator">%</span>i<span class="token punctuation">,</span>f<span class="token operator">+</span><span class="token string">'_median_%d'</span><span class="token operator">%</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="_35"></a>训练方案</h4> 
<p>使用StratifiedKFold按product_id均衡划分训练集和验证集进行5折交叉验证，期间对比过使用KFold来划分，实验验证StratifiedKFold要更胜一筹，分别训练lightgbm、xgboost和catboost三个模型。训练代码如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">train_model_with_nfold</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span>train<span class="token punctuation">,</span>test<span class="token punctuation">,</span>feat_cols<span class="token punctuation">,</span>feats_cols<span class="token punctuation">,</span>category_cols<span class="token punctuation">,</span>
    lgb_params<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>xgb_params<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>cat_params<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>model_types<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'lgb'</span><span class="token punctuation">,</span><span class="token string">'xgb'</span><span class="token punctuation">,</span><span class="token string">'cat'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>fold_num<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span>
    seeds<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">2022</span><span class="token punctuation">]</span><span class="token punctuation">,</span>stratified<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>num_boost_round<span class="token operator">=</span><span class="token number">10000</span><span class="token punctuation">,</span>early_stopping_rounds<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">,</span>verbose<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">,</span>
    un_select_cols<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span><span class="token punctuation">:</span>

    score_lgb <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>fold_num<span class="token punctuation">)</span>
    score_xgb <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>fold_num<span class="token punctuation">)</span>
    score_cat <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>fold_num<span class="token punctuation">)</span>
    score <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>fold_num<span class="token punctuation">)</span>
    oof_lgb <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>train<span class="token punctuation">)</span><span class="token punctuation">)</span>
    oof_xgb <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>train<span class="token punctuation">)</span><span class="token punctuation">)</span>
    oof_cat <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>train<span class="token punctuation">)</span><span class="token punctuation">)</span>
    oof <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>train<span class="token punctuation">)</span><span class="token punctuation">)</span>
    pred_y <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> seed <span class="token keyword">in</span> seeds<span class="token punctuation">:</span>
        <span class="token keyword">for</span> model_type <span class="token keyword">in</span> model_types<span class="token punctuation">:</span>
            <span class="token keyword">if</span> stratified<span class="token punctuation">:</span>
                kf <span class="token operator">=</span> StratifiedKFold<span class="token punctuation">(</span>n_splits<span class="token operator">=</span>fold_num<span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span>seed<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                kf <span class="token operator">=</span> KFold<span class="token punctuation">(</span>n_splits<span class="token operator">=</span>fold_num<span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span>seed<span class="token punctuation">)</span>
            <span class="token keyword">if</span> model_type <span class="token operator">==</span> <span class="token string">'cat'</span><span class="token punctuation">:</span>
                feat_cols <span class="token operator">=</span> <span class="token punctuation">[</span>col <span class="token keyword">for</span> col <span class="token keyword">in</span> feats_cols <span class="token keyword">if</span> col <span class="token keyword">not</span> <span class="token keyword">in</span> un_select_cols<span class="token operator">+</span><span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
                np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>shuffle<span class="token punctuation">(</span>feat_cols<span class="token punctuation">)</span>
            <span class="token keyword">if</span> model_type <span class="token operator">==</span> <span class="token string">'xgb'</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> <span class="token number">1001</span> <span class="token keyword">in</span> train<span class="token punctuation">[</span><span class="token string">'product_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">:</span>
                    LE<span class="token operator">=</span>LabelEncoder<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token keyword">for</span> col <span class="token keyword">in</span> category_cols<span class="token punctuation">:</span>
                        LE<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>data<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        train<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token operator">=</span>LE<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>train<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        test<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token operator">=</span>LE<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>test<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                train <span class="token operator">=</span> data<span class="token punctuation">[</span>data<span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>notna<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span>drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
                test <span class="token operator">=</span> data<span class="token punctuation">[</span>data<span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isna<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span>drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> fold<span class="token punctuation">,</span> <span class="token punctuation">(</span>train_idx<span class="token punctuation">,</span> val_idx<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>kf<span class="token punctuation">.</span>split<span class="token punctuation">(</span>train<span class="token punctuation">[</span>feat_cols<span class="token punctuation">]</span><span class="token punctuation">,</span> train<span class="token punctuation">[</span><span class="token string">'product_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'-----------------fold：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>fold<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string"> -----------------seed：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>seed<span class="token punctuation">}</span></span><span class="token string"> -----------------model_type：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>model_type<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> model_type <span class="token operator">==</span> <span class="token string">'lgb'</span><span class="token punctuation">:</span>
                    lgb_params<span class="token punctuation">[</span><span class="token string">'seed'</span><span class="token punctuation">]</span><span class="token operator">=</span>seed
                    tra <span class="token operator">=</span> lgb<span class="token punctuation">.</span>Dataset<span class="token punctuation">(</span>train<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>train_idx<span class="token punctuation">,</span> feat_cols<span class="token punctuation">]</span><span class="token punctuation">,</span>train<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>train_idx<span class="token punctuation">,</span> <span class="token string">'label'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                    val <span class="token operator">=</span> lgb<span class="token punctuation">.</span>Dataset<span class="token punctuation">(</span>train<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>val_idx<span class="token punctuation">,</span> feat_cols<span class="token punctuation">]</span><span class="token punctuation">,</span>train<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>val_idx<span class="token punctuation">,</span> <span class="token string">'label'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                    model <span class="token operator">=</span> lgb<span class="token punctuation">.</span>train<span class="token punctuation">(</span>lgb_params<span class="token punctuation">,</span> tra<span class="token punctuation">,</span> valid_sets<span class="token operator">=</span><span class="token punctuation">[</span>val<span class="token punctuation">]</span><span class="token punctuation">,</span> num_boost_round<span class="token operator">=</span>num_boost_round<span class="token punctuation">,</span>categorical_feature<span class="token operator">=</span>category_cols<span class="token punctuation">,</span>
                                    callbacks<span class="token operator">=</span><span class="token punctuation">[</span>lgb<span class="token punctuation">.</span>early_stopping<span class="token punctuation">(</span>early_stopping_rounds<span class="token punctuation">)</span><span class="token punctuation">,</span> lgb<span class="token punctuation">.</span>log_evaluation<span class="token punctuation">(</span>verbose<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

                    score_lgb<span class="token punctuation">[</span>fold<span class="token punctuation">]</span><span class="token operator">=</span>model<span class="token punctuation">.</span>best_score<span class="token punctuation">[</span><span class="token string">'valid_0'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'rmse'</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>seeds<span class="token punctuation">)</span>
                    score<span class="token punctuation">[</span>fold<span class="token punctuation">]</span><span class="token operator">=</span>model<span class="token punctuation">.</span>best_score<span class="token punctuation">[</span><span class="token string">'valid_0'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'rmse'</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>seeds<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>model_types<span class="token punctuation">)</span>
                    oof_lgb<span class="token punctuation">[</span>val_idx<span class="token punctuation">]</span> <span class="token operator">+=</span> model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>train<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>val_idx<span class="token punctuation">,</span> feat_cols<span class="token punctuation">]</span><span class="token punctuation">,</span> num_iteration<span class="token operator">=</span>model<span class="token punctuation">.</span>best_iteration<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>seeds<span class="token punctuation">)</span>
                    oof<span class="token punctuation">[</span>val_idx<span class="token punctuation">]</span> <span class="token operator">+=</span> model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>train<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>val_idx<span class="token punctuation">,</span> feat_cols<span class="token punctuation">]</span><span class="token punctuation">,</span> num_iteration<span class="token operator">=</span>model<span class="token punctuation">.</span>best_iteration<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>seeds<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>model_types<span class="token punctuation">)</span>
                    pred_y<span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'fold</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>fold<span class="token punctuation">}</span></span><span class="token string">_seed</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>seed<span class="token punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>model_type<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>test<span class="token punctuation">[</span>feat_cols<span class="token punctuation">]</span><span class="token punctuation">,</span> num_iteration<span class="token operator">=</span>model<span class="token punctuation">.</span>best_iteration<span class="token punctuation">)</span>
                <span class="token keyword">elif</span> model_type <span class="token operator">==</span> <span class="token string">'xgb'</span><span class="token punctuation">:</span>
                    xgb_params<span class="token punctuation">[</span><span class="token string">'seed'</span><span class="token punctuation">]</span><span class="token operator">=</span>seed
                    train_matrix <span class="token operator">=</span> xgb<span class="token punctuation">.</span>DMatrix<span class="token punctuation">(</span>train<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>train_idx<span class="token punctuation">,</span> feat_cols<span class="token punctuation">]</span> <span class="token punctuation">,</span> label<span class="token operator">=</span>train<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>train_idx<span class="token punctuation">,</span> <span class="token string">'label'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                    valid_matrix <span class="token operator">=</span> xgb<span class="token punctuation">.</span>DMatrix<span class="token punctuation">(</span>train<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>val_idx<span class="token punctuation">,</span> feat_cols<span class="token punctuation">]</span> <span class="token punctuation">,</span> label<span class="token operator">=</span>train<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>val_idx<span class="token punctuation">,</span> <span class="token string">'label'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                    watchlist <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>train_matrix<span class="token punctuation">,</span> <span class="token string">'train'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>valid_matrix<span class="token punctuation">,</span> <span class="token string">'eval'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
                    model <span class="token operator">=</span> xgb<span class="token punctuation">.</span>train<span class="token punctuation">(</span>xgb_params<span class="token punctuation">,</span> train_matrix<span class="token punctuation">,</span> num_boost_round<span class="token operator">=</span>num_boost_round<span class="token punctuation">,</span> evals<span class="token operator">=</span>watchlist<span class="token punctuation">,</span> verbose_eval<span class="token operator">=</span>verbose<span class="token punctuation">,</span> early_stopping_rounds<span class="token operator">=</span>early_stopping_rounds<span class="token punctuation">)</span>

                    score_xgb<span class="token punctuation">[</span>fold<span class="token punctuation">]</span><span class="token operator">=</span>model<span class="token punctuation">.</span>best_score <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>seeds<span class="token punctuation">)</span>
                    score<span class="token punctuation">[</span>fold<span class="token punctuation">]</span><span class="token operator">=</span>model<span class="token punctuation">.</span>best_score <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>seeds<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>model_types<span class="token punctuation">)</span>
                    oof_xgb<span class="token punctuation">[</span>val_idx<span class="token punctuation">]</span> <span class="token operator">+=</span> model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>valid_matrix<span class="token punctuation">,</span>iteration_range<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>model<span class="token punctuation">.</span>best_iteration<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>seeds<span class="token punctuation">)</span>
                    oof<span class="token punctuation">[</span>val_idx<span class="token punctuation">]</span> <span class="token operator">+=</span> model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>valid_matrix<span class="token punctuation">,</span>iteration_range<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>model<span class="token punctuation">.</span>best_iteration<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>seeds<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>model_types<span class="token punctuation">)</span>
                    pred_y<span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'fold</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>fold<span class="token punctuation">}</span></span><span class="token string">_seed</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>seed<span class="token punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>model_type<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>xgb<span class="token punctuation">.</span>DMatrix<span class="token punctuation">(</span>test<span class="token punctuation">[</span>feat_cols<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>iteration_range<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>model<span class="token punctuation">.</span>best_iteration<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    cat_params<span class="token punctuation">[</span><span class="token string">'random_seed'</span><span class="token punctuation">]</span><span class="token operator">=</span>seed
                    model <span class="token operator">=</span> cat<span class="token punctuation">.</span>CatBoostRegressor<span class="token punctuation">(</span>num_boost_round<span class="token operator">=</span>num_boost_round<span class="token punctuation">,</span> <span class="token operator">**</span>cat_params<span class="token punctuation">)</span>
                    trn_x <span class="token operator">=</span> train<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>train_idx<span class="token punctuation">,</span> feat_cols<span class="token punctuation">]</span>
                    trn_y <span class="token operator">=</span> train<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>train_idx<span class="token punctuation">,</span> <span class="token string">'label'</span><span class="token punctuation">]</span>
                    val_x <span class="token operator">=</span> train<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>val_idx<span class="token punctuation">,</span> feat_cols<span class="token punctuation">]</span>
                    val_y <span class="token operator">=</span> train<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>val_idx<span class="token punctuation">,</span> <span class="token string">'label'</span><span class="token punctuation">]</span>
                    model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>trn_x<span class="token punctuation">,</span> trn_y<span class="token punctuation">,</span> eval_set<span class="token operator">=</span><span class="token punctuation">(</span>val_x<span class="token punctuation">,</span> val_y<span class="token punctuation">)</span><span class="token punctuation">,</span>cat_features<span class="token operator">=</span>category_cols<span class="token punctuation">,</span> use_best_model<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span>verbose<span class="token punctuation">)</span>
                    
                    score_cat<span class="token punctuation">[</span>fold<span class="token punctuation">]</span> <span class="token operator">=</span> model<span class="token punctuation">.</span>best_score_<span class="token punctuation">[</span><span class="token string">'validation'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'RMSE'</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>seeds<span class="token punctuation">)</span>
                    score<span class="token punctuation">[</span>fold<span class="token punctuation">]</span> <span class="token operator">=</span> model<span class="token punctuation">.</span>best_score_<span class="token punctuation">[</span><span class="token string">'validation'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'RMSE'</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>seeds<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>model_types<span class="token punctuation">)</span>
                    oof_cat<span class="token punctuation">[</span>val_idx<span class="token punctuation">]</span> <span class="token operator">+=</span> model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>val_x<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>seeds<span class="token punctuation">)</span>
                    oof<span class="token punctuation">[</span>val_idx<span class="token punctuation">]</span> <span class="token operator">+=</span> model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>val_x<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>seeds<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>model_types<span class="token punctuation">)</span>
                    pred_y<span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'fold</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>fold<span class="token punctuation">}</span></span><span class="token string">_seed</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>seed<span class="token punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>model_type<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>test<span class="token punctuation">[</span>feat_cols<span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'score_lgb=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>score_lgb<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">\nscore_xgb=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>score_xgb<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">\nscore_cat=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>score_cat<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">\nscore=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>score<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> oof_lgb<span class="token punctuation">,</span>oof_xgb<span class="token punctuation">,</span>oof_cat<span class="token punctuation">,</span>oof<span class="token punctuation">,</span>pred_y
</code></pre> 
<ul><li>可以看到，加入了随机数种子seed的循环，但其实只用了一个2022，因为试验过多个seed的情况，效果不升反降，所以就没采用了；</li><li>还有，针对xgboost模型，如果是类别特征，最好是将它们进行LabelEncoder编码之后再输入到模型中训练，因为xgboost不支持处理类别特征，并且，在我的试验当中，即使是像本赛题中的product_id等数值型类别特征，编码与不编码，分数分别是0.654与0.577，相差还是很大的；</li><li>还有，针对catboost模型，发现输入特征的排列顺序对结果的预测有非常大的影响（对lgb和xgb的影响相对较小），所以用shuffle对特征进行随机排序，并对排序后所预测出的结果是否与其他两个模型的预测结果相当，而选择合适的shuffle次数后的特征顺序，作为catboost模型的特征输入。</li></ul> 
<h4><a id="_123"></a>模型融合</h4> 
<p>一开始的模型融合都是采用简单的算术平均融合，后来试了下stacking融合，确实效果要更好一点点（好4个千分点左右）。模型融合可谓是竞赛中最后的杀手锏，初赛中，lightgbm、xgboost和catboost三个模型最优的线上分数分别为：0.68144，0.69092，0.66796。采用stacking融合后，分数为0.70854，融合代码如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">RidgeCV</span><span class="token punctuation">(</span>train<span class="token punctuation">,</span>oof_lgb<span class="token punctuation">,</span>oof_xgb<span class="token punctuation">,</span>oof_cat<span class="token punctuation">,</span>pred_y<span class="token punctuation">,</span>fold_num<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span>seed<span class="token operator">=</span><span class="token number">2022</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    oof<span class="token operator">=</span>pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token punctuation">[</span>oof_lgb<span class="token punctuation">,</span>oof_xgb<span class="token punctuation">,</span>oof_cat<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>T
    oof<span class="token punctuation">.</span>columns<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'lgb'</span><span class="token punctuation">,</span><span class="token string">'xgb'</span><span class="token punctuation">,</span><span class="token string">'cat'</span><span class="token punctuation">]</span>
    oof<span class="token punctuation">[</span><span class="token string">'product_id'</span><span class="token punctuation">]</span><span class="token operator">=</span>train<span class="token punctuation">[</span><span class="token string">'product_id'</span><span class="token punctuation">]</span>
    oof<span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span><span class="token operator">=</span>train<span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span>

    y<span class="token operator">=</span>pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token punctuation">[</span>pred_y<span class="token punctuation">[</span><span class="token punctuation">[</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> pred_y<span class="token punctuation">.</span>columns <span class="token keyword">if</span> <span class="token string">'lgb'</span> <span class="token keyword">in</span> i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>pred_y<span class="token punctuation">[</span><span class="token punctuation">[</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> pred_y<span class="token punctuation">.</span>columns <span class="token keyword">if</span> <span class="token string">'xgb'</span> <span class="token keyword">in</span> i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>pred_y<span class="token punctuation">[</span><span class="token punctuation">[</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> pred_y<span class="token punctuation">.</span>columns <span class="token keyword">if</span> <span class="token string">'cat'</span> <span class="token keyword">in</span> i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>T
    y<span class="token punctuation">.</span>columns<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'lgb'</span><span class="token punctuation">,</span><span class="token string">'xgb'</span><span class="token punctuation">,</span><span class="token string">'cat'</span><span class="token punctuation">]</span>

    kf <span class="token operator">=</span> StratifiedKFold<span class="token punctuation">(</span>n_splits<span class="token operator">=</span>fold_num<span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span>seed<span class="token punctuation">)</span>
    oof_res<span class="token operator">=</span>np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>oof<span class="token punctuation">)</span><span class="token punctuation">)</span>
    prediction<span class="token operator">=</span>np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> fold<span class="token punctuation">,</span> <span class="token punctuation">(</span>train_idx<span class="token punctuation">,</span> val_idx<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>kf<span class="token punctuation">.</span>split<span class="token punctuation">(</span>oof<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'lgb'</span><span class="token punctuation">,</span><span class="token string">'xgb'</span><span class="token punctuation">,</span><span class="token string">'cat'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> oof<span class="token punctuation">[</span><span class="token string">'product_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        train_x<span class="token operator">=</span>oof<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>train_idx<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string">'lgb'</span><span class="token punctuation">,</span><span class="token string">'xgb'</span><span class="token punctuation">,</span><span class="token string">'cat'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        train_y<span class="token operator">=</span>oof<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>train_idx<span class="token punctuation">,</span><span class="token string">'label'</span><span class="token punctuation">]</span>
        
        valid_x<span class="token operator">=</span>oof<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>val_idx<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string">'lgb'</span><span class="token punctuation">,</span><span class="token string">'xgb'</span><span class="token punctuation">,</span><span class="token string">'cat'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        valid_y<span class="token operator">=</span>oof<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>val_idx<span class="token punctuation">,</span><span class="token string">'label'</span><span class="token punctuation">]</span>
        
        model <span class="token operator">=</span> Ridge<span class="token punctuation">(</span>random_state<span class="token operator">=</span><span class="token number">2022</span><span class="token punctuation">)</span>
        model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>train_x<span class="token punctuation">,</span>train_y<span class="token punctuation">)</span>
        
        oof_res<span class="token punctuation">[</span>val_idx<span class="token punctuation">]</span><span class="token operator">=</span>model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>valid_x<span class="token punctuation">)</span>
        prediction<span class="token operator">+=</span>model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token operator">/</span>fold_num

    <span class="token keyword">return</span> oof_res<span class="token punctuation">,</span>prediction
</code></pre> 
<h4><a id="_155"></a>赛题得分</h4> 
<p><strong>初赛</strong></p> 
<ul><li>baseline：<a href="https://github.com/datawhalechina/competition-baseline/blob/master/competition/%E7%A7%91%E5%A4%A7%E8%AE%AF%E9%A3%9EAI%E5%BC%80%E5%8F%91%E8%80%85%E5%A4%A7%E8%B5%9B2022/%E5%95%86%E5%93%81%E9%94%80%E9%87%8F%E6%99%BA%E8%83%BD%E9%A2%84%E6%B5%8B%E6%8C%91%E6%88%98%E8%B5%9B_baseline.ipynb">https://github.com/datawhalechina/competition-baseline/blob/master/competition/%E7%A7%91%E5%A4%A7%E8%AE%AF%E9%A3%9EAI%E5%BC%80%E5%8F%91%E8%80%85%E5%A4%A7%E8%B5%9B2022/%E5%95%86%E5%93%81%E9%94%80%E9%87%8F%E6%99%BA%E8%83%BD%E9%A2%84%E6%B5%8B%E6%8C%91%E6%88%98%E8%B5%9B_baseline.ipynb</a> 线上得分为：0.41662</li><li><code>lightgbm</code>：将baseline的特征采用我上述的代码构建之后，线上分数为0.65769；然后随机一次特征顺序后，为0.66355；再经过TPE参数搜索之后，为0.68144。</li><li><code>xgboost</code>：将baseline的特征采用我上述的代码构建之后，线上分数为0.57729；然后将类别特征经过编码后，为0.65408；再经过TPE参数搜索之后，为0.69092，上分显著！</li><li><code>catboost</code>：将baseline的特征采用我上述的代码构建之后，并且再随机一次特征顺序即两次后，线上分数为0.66796。期间也尝试了TPE参数搜索，并没有找到且很难找到最优的参数组合，原因可能是特征顺序对其影响本来就很大，所以不确定的因素太多了，参数的搜索也就更加困难了。</li><li><strong>最后将三个模型最优的线上分数的结果，采用stacking融合，得到初赛最后的分数为：0.70854，排名：71/507（再一次成功晋级复赛~）</strong><br> <img src="https://images2.imgbox.com/1c/9a/u58hfbwV_o.png" alt=""><br> <img src="https://images2.imgbox.com/36/1c/zRw2zm02_o.png" alt=""></li></ul> 
<p><strong>复赛</strong><br> 由于种种原因，复赛并没有认真在打（主要还是太菜了，上不动了-_-!!），于是复赛只是沿用了初赛时的训练方案，只是测试集更换了一下，以及训练集多出了3个月的数据。复赛分数为：0.74399，排名：48/62<br> <img src="https://images2.imgbox.com/a4/92/aFPh7zl2_o.png" alt=""></p> 
<hr> 
<p>以上即为本文的全部内容，若需要全部源代码的，请关注公众号《Python王者之路》，回复关键词：<code>20220910</code>，即可获取。</p> 
<hr> 
<h2><a id="_171"></a>写在最后</h2> 
<p><strong>好久没有完整地打一次数据挖掘类的比赛了，之前大部分都是参加CV类型的比赛，挖掘类比赛最重要的一环应该是特征的构建了，好的特征可以实现质的飞跃。</strong></p> 
<p><strong>这次比赛中我构建的特征还是过于简单了，这也是跟前排差距大的主要原因，因为缺乏对赛题背后具体业务的理解，也就很难挖掘出比较强的特征。</strong></p> 
<p><strong>预见到这个瓶颈之后，我干脆放弃去寻找强的特征，而是更加专注于模型的方面，于是从一开始只用一个lightgbm模型，到后来直接把其他两个树模型也都考虑进来。</strong></p> 
<p><strong>虽然，我为了上分也做了很多努力，研究基于规则的方案；特征的筛选方面；及在baseline的基础上扩充了多个随机数种子和特征顺序随机排列等训练方案，即使最终效果也没提升多少，但是我从中也学习到了一些知识。</strong></p> 
<p><strong>比如说：特征的排列顺序的影响、TPE最优参数搜索、stacking融合等。期待之后，前排大佬的分享，让我膜拜膜拜大佬们的上分技巧哈哈哈~</strong></p> 
<p><strong>今天，刚好是中秋节和教师节两个节日重叠的日子，那么，在此，</strong></p> 
<p><font color="red"><b>祝大家中秋节快乐、特别是老师们节日快乐！！！</b></font></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/659bb06ef4e661153e166f475d0ecc29/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">pytorch的安装--测试</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4933790c857c5fa2685f928dccb0d1b4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">基于Python实现的手写数字图像识别</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>