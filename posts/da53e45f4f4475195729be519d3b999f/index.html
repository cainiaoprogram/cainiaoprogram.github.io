<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>鸿蒙原生应用/元服务开发-长时任务 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="鸿蒙原生应用/元服务开发-长时任务" />
<meta property="og:description" content="概述
功能介绍
应用退至后台后，对于在后台需要长时间运行用户可感知的任务，例如播放音乐、导航等。为防止应用进程被挂起，导致对应功能异常，可以申请长时任务，使应用在后台长时间运行。申请长时任务后，系统会做相应的校验，确保应用在执行相应的长时任务。同时，系统有与长时任务相关联的通知栏消息，用户删除通知栏消息时，系统会自动停止长时任务。
使用场景
下表给出了当前长时任务支持的类型，包含数据传输、音频播放、录音、定位导航、蓝牙相关、多设备互联和计算任务。可以参考下表中的场景举例，选择合适的长时任务类型。
长时任务类型
·申请了DATA_TRANSFER（数据传输）的长时任务，系统仅会提升应用进程的优先级，降低系统终止应用进程的概率，但仍然会挂起对应的应用进程。对于上传下载对应的功能，需要调用系统上传下载代理接口托管给系统执行。
约束与限制
申请限制：Stage模型中，长时任务仅支持UIAbility申请；FA模型中，长时任务仅支持ServiceAbility申请。
数量限制：一个UIAbility（FA模型则为ServiceAbility）同一时刻仅支持申请一个长时任务，即在一个长时任务结束后才可能继续申请。如果一个应用同时需要申请多个长时任务，需要创建多个UIAbility；一个应用的一个UIAbility申请长时任务后，整个应用下的所有进程均不会被挂起。
运行限制：系统会进行长时任务校验。若应用申请了长时任务，但未真正执行申请类型的长时任务或申请类型的任务已结束，系统会对应用进行管控。例如系统检测到应用申请了AUDIO_PLAYBACK（音频播放），但实际未播放音乐，系统则会终止对应的进程。
接口说明：
主要接口：
代码开发：stage模型下
1.申请ohos.permission.KEEP_BACKGROUND_RUNNING权限，配置方式请参见配置文件权限声明。
2.声明后台模式类型。
在module.json5配置文件中为需要使用长时任务的UIAbility声明相应的长时任务类型。
{ &#34;module&#34;: { ... &#34;abilities&#34;: [ { ... // 后台模式类型 &#34;backgroundModes&#34;: [ &#34;audioRecording&#34; ], } ] } } 3.导入模块
import backgroundTaskManager from &#39;@ohos.resourceschedule.backgroundTaskManager&#39;; import wantAgent from &#39;@ohos.app.ability.wantAgent&#39;; 4.申请和取消长时任务。
设备本应用申请长时任务示例代码如下：
import common from &#39;@ohos.app.ability.common&#39;; @Entry @Component struct Index { @State message: string = &#39;ContinuousTask&#39;; // 获取UIAbilityContext private context = getContext(this) as common.UIAbilityContext; startContinuousTask() { let wantAgentInfo = { // 点击通知后，将要执行的动作列表 wants: [ { bundleName: &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/da53e45f4f4475195729be519d3b999f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-09T10:57:08+08:00" />
<meta property="article:modified_time" content="2024-01-09T10:57:08+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">鸿蒙原生应用/元服务开发-长时任务</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>概述<br> 功能介绍<br> 应用退至后台后，对于在后台需要长时间运行用户可感知的任务，例如播放音乐、导航等。为防止应用进程被挂起，导致对应功能异常，可以申请长时任务，使应用在后台长时间运行。申请长时任务后，系统会做相应的校验，确保应用在执行相应的长时任务。同时，系统有与长时任务相关联的通知栏消息，用户删除通知栏消息时，系统会自动停止长时任务。</p> 
<p><strong>使用场景</strong><br> 下表给出了当前长时任务支持的类型，包含数据传输、音频播放、录音、定位导航、蓝牙相关、多设备互联和计算任务。可以参考下表中的场景举例，选择合适的长时任务类型。</p> 
<p> 长时任务类型<br>  </p> 
<p class="img-center"><img alt="鸿蒙原生应用/元服务开发-长时任务-鸿蒙开发者社区" height="448" src="https://images2.imgbox.com/ec/70/k9pXwoPu_o.png" width="631"></p> 
<p><br> ·申请了DATA_TRANSFER（数据传输）的长时任务，系统仅会提升应用进程的优先级，降低系统终止应用进程的概率，但仍然会挂起对应的应用进程。对于上传下载对应的功能，需要调用系统上传下载代理接口托管给系统执行。</p> 
<p><strong>约束与限制</strong><br> 申请限制：Stage模型中，长时任务仅支持UIAbility申请；FA模型中，长时任务仅支持ServiceAbility申请。<br> 数量限制：一个UIAbility（FA模型则为ServiceAbility）同一时刻仅支持申请一个长时任务，即在一个长时任务结束后才可能继续申请。如果一个应用同时需要申请多个长时任务，需要创建多个UIAbility；一个应用的一个UIAbility申请长时任务后，整个应用下的所有进程均不会被挂起。<br> 运行限制：系统会进行长时任务校验。若应用申请了长时任务，但未真正执行申请类型的长时任务或申请类型的任务已结束，系统会对应用进行管控。例如系统检测到应用申请了AUDIO_PLAYBACK（音频播放），但实际未播放音乐，系统则会终止对应的进程。<br> 接口说明：<br><strong>主要接口：</strong><br>  </p> 
<p class="img-center"><img alt="鸿蒙原生应用/元服务开发-长时任务-鸿蒙开发者社区" height="208" src="https://images2.imgbox.com/55/47/wKdFwlvg_o.png" width="692"></p> 
<p><br><strong>代码开发：stage模型下</strong><br> 1.申请ohos.permission.KEEP_BACKGROUND_RUNNING权限，配置方式请参见配置文件权限声明。<br> 2.声明后台模式类型。<br> 在module.json5配置文件中为需要使用长时任务的UIAbility声明相应的长时任务类型。</p> 
<pre><code> {
  "module": {
    ...
    "abilities": [
      {
        ...
        // 后台模式类型
        "backgroundModes": [
          "audioRecording"
        ],
      }
    ]
  }
}

</code></pre> 
<p>3.导入模块</p> 
<pre><code>import backgroundTaskManager from '@ohos.resourceschedule.backgroundTaskManager';
import wantAgent from '@ohos.app.ability.wantAgent';

</code></pre> 
<p>4.申请和取消长时任务。<br> 设备本应用申请长时任务示例代码如下：</p> 
<pre><code>import common from '@ohos.app.ability.common';

@Entry
@Component
struct Index {
  @State message: string = 'ContinuousTask';
  // 获取UIAbilityContext
  private context = getContext(this) as common.UIAbilityContext;
  startContinuousTask() {
    let wantAgentInfo = {
      // 点击通知后，将要执行的动作列表
      wants: [
        {
          bundleName: "com.example.myapplication",
          abilityName: "EntryAbility"
        }
],
// 点击通知后，动作类型
operationType: wantAgent.OperationType.START_ABILITY,
// 使用者自定义的一个私有值
requestCode: 0,
// 点击通知后，动作执行属性
wantAgentFlags: [wantAgent.WantAgentFlags.UPDATE_PRESENT_FLAG]
};

// 通过wantAgent模块下getWantAgent方法获取WantAgent对象
wantAgent.getWantAgent(wantAgentInfo).then((wantAgentObj) =&gt; {
  try {
    backgroundTaskManager.startBackgroundRunning(this.context,
      backgroundTaskManager.BackgroundMode.AUDIO_RECORDING, wantAgentObj).then(() =&gt; {
      console.info(`Succeeded in operationing startBackgroundRunning.`);
    }).catch((err) =&gt; {
      console.error(`Failed to operation startBackgroundRunning. Code is ${err.code}, message is ${err.message}`);
    });
  } catch (error) {
    console.error(`Failed to start background running. Code is ${error.code} message is ${error.message}`);
  }
});
}

stopContinuousTask() {
  try {
    backgroundTaskManager.stopBackgroundRunning(this.context).then(() =&gt; {
      console.info(`Succeeded in operationing stopBackgroundRunning.`);
    }).catch((err) =&gt; {
      console.error(`Failed to operation stopBackgroundRunning. Code is ${err.code}, message is ${err.message}`);
    });
  } catch (error) {
    console.error(`Failed to stop background running. Code is ${error.code} message is ${error.message}`);
  }
}

build() {
    Row() {
      Column() {
        Text("Index")
          .fontSize(50)
          .fontWeight(FontWeight.Bold)

        Button() {
          Text('申请长时任务').fontSize(25).fontWeight(FontWeight.Bold)
        }
.type(ButtonType.Capsule)
  .margin({ top: 10 })
  .backgroundColor('#0D9FFB')
  .width(250)
  .height(40)
  .onClick(() =&gt; {
    // 通过按钮申请长时任务
    this.startContinuousTask();

    // 此处执行具体的长时任务逻辑，如放音等。
  })

Button() {
  Text('取消长时任务').fontSize(25).fontWeight(FontWeight.Bold)
}
.type(ButtonType.Capsule)
  .margin({ top: 10 })
  .backgroundColor('#0D9FFB')
  .width(250)
  .height(40)
  .onClick(() =&gt; {
    // 此处结束具体的长时任务的执行

    // 通过按钮取消长时任务
    this.stopContinuousTask();
  })
}
.width('100%')
}
.height('100%')
}
}</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d5aecce5406154f42a21171e8f511b16/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">VirtualBox安装OpenEuler</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/89183a45970cb5ec8b8751dbaa6ef575/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">如何通过bat文件启动应用程序</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>