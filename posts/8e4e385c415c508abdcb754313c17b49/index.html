<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>如何在Milk-V duo的小核FreeRTOS中跑i2c - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="如何在Milk-V duo的小核FreeRTOS中跑i2c" />
<meta property="og:description" content="前言 （1）PLCT实验室实习生长期招聘：招聘信息链接
（2）如果有嵌入式企业需要招聘湖南区域日常实习生，任何区域的暑假嵌入式软件实习岗位，可C站直接私聊，或者邮件：zhangyixu02@gmail.com，此消息至2025年1月1日前均有效
（3）本来要尝试在RT-Thread中跑i2c，打算先Linux中测试i2c，再FreeRTOS，最后RT-Thread，最终发现卡在RT-Thread这一步了，因为移植一个文件就马上出现另外一个文件缺失缝缝补补搞了很久最终真的无能为力了。
在duo的小核FreeRTOS跑i2c的方法 修改部分 （1）因为duo的版本更新比较快，我就使用比较熟悉的Duo-V1.0.5版本进行讲解。
git clone -b Duo-V1.0.5 https://github.com/milkv-duo/duo-buildroot-sdk.git cd duo-buildroot-sdk cp freertos/cvitek/hal/cv180x/i2c/src/hal_dw_i2c.c freertos/cvitek/task/comm/src/riscv64/ cp freertos/cvitek/hal/cv180x/i2c/include/hal_dw_i2c.h freertos/cvitek/task/comm/include/ cp freertos/cvitek/driver/i2c/include/i2c.h freertos/cvitek/task/comm/include/ （2）进入FreeRTOSConfig.h文件，关闭configUSE_TICK_HOOK这个宏。
vim freertos/cvitek/kernel/include/riscv64/FreeRTOSConfig.h #define configUSE_TICK_HOOK 0 （3）进入的796行，将IC3_INTR修改为I2C3_INTR，这里有可能是官方写错了。
vim freertos/cvitek/task/comm/src/riscv64/hal_dw_i2c.c //修改前 request_irq(IC3_INTR, i2c_dw_isr, 0, &#34;IC2_INTR int&#34;, &amp;dw_i2c[i2c_id]); //修改后 request_irq(I2C3_INTR, i2c_dw_isr, 0, &#34;IC2_INTR int&#34;, &amp;dw_i2c[i2c_id]); （4）在comm_main.c中利用freertos的xTaskCreate()函数创建一个my_task_test()的任务函数。
vim freertos/cvitek/task/comm/src/riscv64/comm_main.c /**************************************************************************** * Function definitions ****************************************************************************/ DEFINE_CVI_SPINLOCK(mailbox_lock, SPIN_MBOX); #include &#34;hal_dw_i2c.h&#34; void my_task_test() { uint8_t data= 0,data_read; hal_i2c_init(I2C0); printf(&#34;hal_i2c_init after\n&#34;); uint8_t *data_write =&amp;data; for (;;) { //i2c端口，从机地址，寄存器地址，7位从机地址，写入的数据，写1个数据 hal_i2c_write(I2C0, 0x01, 0x28, 1, data_write, 1); hal_i2c_read(I2C0, 0x28, 0x17, 1, &amp;data_read, 1); printf(&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/8e4e385c415c508abdcb754313c17b49/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-03T12:27:26+08:00" />
<meta property="article:modified_time" content="2024-01-03T12:27:26+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">如何在Milk-V duo的小核FreeRTOS中跑i2c</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>前言</h2> 
<blockquote> 
 <p>（1）PLCT实验室实习生长期招聘：<a href="https://github.com/lazyparser/weloveinterns">招聘信息链接</a><br> （2）<mark>如果有嵌入式企业需要招聘湖南区域日常实习生，任何区域的暑假嵌入式软件实习岗位，可C站直接私聊，或者邮件：zhangyixu02@gmail.com，此消息至2025年1月1日前均有效</mark><br> （3）本来要尝试在<code>RT-Thread</code>中跑<code>i2c</code>，打算先<code>Linux</code>中测试<code>i2c</code>，再<code>FreeRTOS</code>，最后<code>RT-Thread</code>，最终发现卡在<code>RT-Thread</code>这一步了，因为移植一个文件就马上出现另外一个文件缺失缝缝补补搞了很久最终真的无能为力了。</p> 
</blockquote> 
<h2><a id="duoFreeRTOSi2c_5"></a>在duo的小核FreeRTOS跑i2c的方法</h2> 
<h3><a id="_6"></a>修改部分</h3> 
<blockquote> 
 <p>（1）因为<code>duo</code>的版本更新比较快，我就使用比较熟悉的<code>Duo-V1.0.5</code>版本进行讲解。</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token function">git</span> clone <span class="token parameter variable">-b</span> Duo-V1.0.5 https://github.com/milkv-duo/duo-buildroot-sdk.git
<span class="token builtin class-name">cd</span>  duo-buildroot-sdk
<span class="token function">cp</span> freertos/cvitek/hal/cv180x/i2c/src/hal_dw_i2c.c freertos/cvitek/task/comm/src/riscv64/
<span class="token function">cp</span> freertos/cvitek/hal/cv180x/i2c/include/hal_dw_i2c.h freertos/cvitek/task/comm/include/
<span class="token function">cp</span> freertos/cvitek/driver/i2c/include/i2c.h freertos/cvitek/task/comm/include/
</code></pre> 
<p><img src="https://images2.imgbox.com/25/ea/AAILPvQh_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>（2）进入<code>FreeRTOSConfig.h</code>文件，关闭<code>configUSE_TICK_HOOK</code>这个宏。</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token function">vim</span> freertos/cvitek/kernel/include/riscv64/FreeRTOSConfig.h
</code></pre> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">configUSE_TICK_HOOK</span>             <span class="token expression"><span class="token number">0</span></span></span>
</code></pre> 
<blockquote> 
 <p>（3）进入的796行，将<code>IC3_INTR</code>修改为<code>I2C3_INTR</code>，这里有可能是官方写错了。</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token function">vim</span> freertos/cvitek/task/comm/src/riscv64/hal_dw_i2c.c
</code></pre> 
<pre><code class="prism language-c"><span class="token comment">//修改前</span>
<span class="token function">request_irq</span><span class="token punctuation">(</span>IC3_INTR<span class="token punctuation">,</span> i2c_dw_isr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"IC2_INTR int"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>dw_i2c<span class="token punctuation">[</span>i2c_id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//修改后</span>
<span class="token function">request_irq</span><span class="token punctuation">(</span>I2C3_INTR<span class="token punctuation">,</span> i2c_dw_isr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"IC2_INTR int"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>dw_i2c<span class="token punctuation">[</span>i2c_id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>（4）在<code>comm_main.c</code>中利用<code>freertos</code>的<code>xTaskCreate()</code>函数创建一个<code>my_task_test()</code>的任务函数。</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token function">vim</span> freertos/cvitek/task/comm/src/riscv64/comm_main.c
</code></pre> 
<pre><code class="prism language-c"><span class="token comment">/****************************************************************************
 * Function definitions
 ****************************************************************************/</span>




<span class="token function">DEFINE_CVI_SPINLOCK</span><span class="token punctuation">(</span>mailbox_lock<span class="token punctuation">,</span> SPIN_MBOX<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"hal_dw_i2c.h"</span></span>

<span class="token keyword">void</span> <span class="token function">my_task_test</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token class-name">uint8_t</span> data<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>data_read<span class="token punctuation">;</span>
  <span class="token function">hal_i2c_init</span><span class="token punctuation">(</span>I2C0<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"hal_i2c_init after\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">uint8_t</span> <span class="token operator">*</span>data_write <span class="token operator">=</span><span class="token operator">&amp;</span>data<span class="token punctuation">;</span>
	
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{<!-- --></span>
		<span class="token comment">//i2c端口，从机地址，寄存器地址，7位从机地址，写入的数据，写1个数据</span>
		<span class="token function">hal_i2c_write</span><span class="token punctuation">(</span>I2C0<span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0x28</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> data_write<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">hal_i2c_read</span><span class="token punctuation">(</span>I2C0<span class="token punctuation">,</span> <span class="token number">0x28</span><span class="token punctuation">,</span> <span class="token number">0x17</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>data_read<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"test the RTOS: %d\r\n"</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">vTaskDelay</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    data<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">main_cvirtos</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"create cvi task\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


	<span class="token comment">/* Start the tasks and timer running. */</span>
  <span class="token function">xTaskCreate</span><span class="token punctuation">(</span>my_task_test<span class="token punctuation">,</span> <span class="token string">"my_task"</span><span class="token punctuation">,</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">vTaskStartScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">/* If all is well, the scheduler will now be running, and the following
    line will never be reached.  If the following line does execute, then
    there was either insufficient FreeRTOS heap memory available for the idle
    and/or timer tasks to be created, or vTaskStartScheduler() was called from
    User mode.  See the memory management section on the FreeRTOS web site for
    more details on the FreeRTOS heap http://www.freertos.org/a00111.html.  The
    mode from which main() is called is set in the C start up code and must be
    a privileged mode (not user mode). */</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"cvi task end\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
        <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_93"></a>接线说明</h3> 
<blockquote> 
 <p>（1）这里需要准备的材料有，一个<code>Typec</code>数据线，一个USB转TTL模块，一个逻辑分析仪。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/5e/af/FFdcXurm_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/b8/13/VCA4LnRX_o.jpg" alt="在这里插入图片描述"></p> 
<h3><a id="_99"></a>上机测试结果</h3> 
<blockquote> 
 <p>（1）对于逻辑分析仪的采样率必须达到被测信号最高频率的 5 倍以上，推荐 10 倍以上。<br> （2）通过阅读代码我们可以知道，<code>I2C</code>的频率应该是<code>400KHZ</code>，5倍以上，那么就是<code>2MHZ</code>。因此逻辑分析仪的采样率设置为<code>2MHZ</code>。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/91/76/ctsF2kiJ_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>（3）然后我这里每隔<code>100ms</code>进行一次，所以采样深度尽量设置在<code>200k samples</code>以上。我这里为了保险，设置的采样深度为<code>1M samples</code>。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/ac/26/ObJfKi41_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>（4）最终发现，成功进行了<code>I2C</code>通讯。因为我们这里<code>I2C</code>接口是连接的逻辑分析仪，主机给<code>0x01</code>地址发送写和<code>0x28</code>地址发送读信息的时候，发现找不到从机的应答信号，因此停止了通讯。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/f9/10/8nVcrZWF_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>（5）细心的人肯定发现了一个问题，第二个我们明明是向0x28地址读取数据，怎么抓取到的是写指令。讲实话，这个地方我也比较懵，但是从代码中来看，似乎又应该是这样的，因为代码的<code>i2c_xfer_init()</code>函数其实就是调用的<code>i2c_write_cmd_data()</code>，所以应该是写指令没有问题。再深入的具体细节我也不太想分析了，毕竟我不是他们芯片原厂的人。走到这一步已经尽力了。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/2c/00/B7G6jPMj_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>（6）个人认为，他的读时序应该是采用的方式3。所以一开始是主机写数据。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/36/34/jlBP3Xpd_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_121"></a>测试流程</h2> 
<blockquote> 
 <p>（1）这里我将会介绍我是如何测试出在<code>Milk-V duo</code>的小核<code>FreeRTOS</code>中跑<code>I2C</code>，方便各位学习，如果有错也欢迎各位大佬指出更正。</p> 
</blockquote> 
<h3><a id="_123"></a>前期猜测和测试</h3> 
<blockquote> 
 <p>（1）刚开始的时候，我看到<code>Milk-V duo</code>的<code>FreeRTOS</code>中存在<code>i2c.c</code>，打算直接在<code>comm_main.c</code>中包含<code>i2c.h</code>文件，然后引用相关的<code>API</code>函数。执行编译指令，发现他说找不到对应的函数。</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token builtin class-name">export</span> <span class="token assign-left variable">MILKV_BOARD</span><span class="token operator">=</span>milkv-duo
<span class="token builtin class-name">source</span> milkv/boardconfig-milkv-duo.sh
<span class="token builtin class-name">source</span> build/milkvsetup.sh
defconfig cv1800b_milkv_duo_sd
build_all
</code></pre> 
<blockquote> 
 <p>（2）当时我是比较纳闷的，怎么会找不到<code>i2c.c</code>的源代码呢？执行<code>find</code>指令后发现，<code>i2c.c</code>是在<code>freertos/cvitek/driver/i2c/src/</code>路径中，按理说是有这个文件的呀。</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token function">find</span> <span class="token parameter variable">-name</span> *i2c*.c
</code></pre> 
<p><img src="https://images2.imgbox.com/a2/6e/ziSICkAO_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>（3）后面就想，那就看看编译过程中产生的日志信息吧。因为编译过程一般都是先将所以c文件编译，但是不链接，最后都编译完成之后，再进行链接的。所以说，我这里只需要关注 <strong>-c 文件路径</strong> 就可以知道编译了那些.c文件了。但是，不幸的是，我发现<code>freertos/cvitek/driver/i2c/</code>并不在编译路径中。</p> 
</blockquote> 
<pre><code class="prism language-shell">build_all <span class="token operator">|</span> <span class="token function">tee</span> build_all_log.txt
</code></pre> 
<p><img src="https://images2.imgbox.com/9c/0c/Bi7Chxhq_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>（4）之后尝试阅读<code>i2c.c</code>的源码，发现其实就是对<code>hal_dw_i2c.c</code>中的函数进行了一次封装。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/40/0f/bHhrSy0W_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>（5）因为如上原因，我打算直接将<code>duo</code>的<code>hal</code>层代码复制到编译路径里面。那么就不再需要写我不那么熟悉的<code>CMake</code>来添加编译路径了，哈哈哈哈。</p> 
</blockquote> 
<h3><a id="i2c_150"></a>找到官方i2c代码</h3> 
<blockquote> 
 <p>（1）依旧是先执行find指令，查找到官方的<code>i2c</code>代码。我们知道<code>Milk-V duo</code>是<code>cv1800</code>芯片，但是从下面查找发现，只有<code>cv181x</code>和<code>cv1835</code>这两款芯片的<code>hal</code>层<code>i2c</code>代码，那么怎么办呢？</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token function">find</span> <span class="token parameter variable">-name</span> *i2c*.c
</code></pre> 
<p><img src="https://images2.imgbox.com/73/c1/6f2zbHeC_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>（2）之后我翻阅了一下<code>GitHub</code>，发现是有<code>cv180x</code>的<code>i2c</code>库的，只不过他这里写的是<code>../cv181x/i2c</code>，意思说<code>cv180x</code>和<code>cv181x</code>的<code>i2c</code>库函数是一样的。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/79/37/xauRWdxG_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="i2c_162"></a>官方i2c代码可能存在的问题</h3> 
<blockquote> 
 <p>（1）当我尝试将<code>hal_dw_i2c.c</code>和<code>hal_dw_i2c.h</code>文件移植进编译路径的时候，发现<code>hal_dw_i2c.c</code>文件的796行<code>IC3_INTR</code>报错，说没有被定义。<br> （2）之后我看了一下，<code>IC3_INTR</code>其实就是一个宏定义，然后我尝试将<code>IC3_INTR</code>修改为71，编译进入芯片，发现会卡死。</p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IC3_INTR</span> <span class="token expression"><span class="token number">71</span></span></span>
</code></pre> 
<blockquote> 
 <p>（2）最后我发现还有一个<code>I2C3_INTR</code>，之后修改成<code>I2C3_INTR</code>就没有问题了。所以说我猜测<code>i2c</code> <code>hal</code>层代码这个地方也许写错了。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/7d/1a/Gn3yfyhA_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_172"></a>编译路径查找</h3> 
<blockquote> 
 <p>（1）依旧是将编译过程中的打印信息导出来。 <strong>-c 文件路径</strong>就是编译录， <strong>-I 文件路径</strong>就是头文件包含路径。</p> 
</blockquote> 
<pre><code class="prism language-shell">build_all <span class="token operator">|</span> <span class="token function">tee</span> build_all_log.txt
</code></pre> 
<h3><a id="API_177"></a>API接口的使用</h3> 
<blockquote> 
 <p>（1）一般<code>I2C</code>只会进行读写操作，所以我只关注了这三个函数。因为找不到官方的相关<code>API</code>接口介绍函数，所以这三个函数的使用完全是我看代码猜的。（其实只要是对<code>I2C</code>协议稍微熟悉一点，猜这个还是不算太难。）</p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">hal_i2c_init</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i2c_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">hal_i2c_write</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i2c_id<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> dev<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> alen<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>buffer<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">hal_i2c_read</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i2c_id<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> dev<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> alen<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>buffer<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="hal_i2c_init_184"></a>hal_i2c_init()函数使用</h4> 
<blockquote> 
 <p>（1）这个从名字上，就很清楚是干嘛的的。明显就是<code>I2C</code>的初始化函数，那么传入的<code>i2c_id</code>是什么呢？<br> （2）那我们就看看源码，从源码一路追溯，就很容易发现如果要初始化<code>I2Cx</code>，那么就传入<code>I2Cx</code>。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/2a/ac/Cn9js9jX_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="I2C_189"></a>I2C时序简单讲解</h4> 
<blockquote> 
 <p>（1）后面几个参数就设计<code>I2C</code>时序知识了，为了防止有朋友不了解，或者说不太熟悉了。先介绍一下：<br> &lt;1&gt;<code>I2C</code>在通讯的时候，先发送一个起始信号（<code>SCL</code>高电平，<code>SDA</code>下降沿），然后主机广播一个从机地址。<code>I2C</code>的从机地址有两种，一种是7位地址，一种是10地址的。<br> &lt;2&gt;找到从机地址之后，从机发送<code>ACK</code>回应信号。<code>I2C</code>有两种策略，你可以自己选择，第一种是主机等待从机的<code>ACK</code>回应信号，第二种是不等待，自顾自的发数据。测试结果发现<code>Milk-V duo</code>的<code>I2C</code>通讯似乎只能是第一种，必须等待<code>ACK</code>回应信号，否则会终止通讯过程。<br> （这也很好的介绍了，明明代码中写了那么多数据，最终逻辑分析仪抓到的数据那么短）<br> &lt;3&gt;然后主机发送这里需要分成读写两种情况讨论，加粗部分表示主机发送的信号，没加粗部分是从机的信号<br> （注：Milk-V duo的手册的I2C章节时序图感觉有问题，是经典的I2C时序没错。但是Milk-V duo的代码中读时序应该是采用的第三种，主机先发数据，然后再读数据）</p> 
 <ul><li><strong>写</strong>： <em><strong>起始信号</strong></em> —&gt; <em><strong>从机地址+写</strong></em> —&gt; 应答信号 —&gt; <em><strong>要写入从机的寄存器地址</strong></em> —&gt; 应答信号 —&gt; <em><strong>写入的数据</strong></em> —&gt; 应答信号 —&gt; <em><strong>停止信号</strong></em></li><li><strong>读</strong>： <em><strong>起始信号</strong></em> —&gt; <em><strong>从机地址+写</strong></em> —&gt; 应答信号 —&gt; <em><strong>要读取从机的寄存器地址</strong></em> —&gt; 应答信号 —&gt; <em><strong>起始信号</strong></em> —&gt; <em><strong>从机地址+读</strong></em> —&gt; 应答信号 —&gt; 从机发送数据 —&gt; <em><strong>回应信号</strong></em> —&gt; <em><strong>停止信号</strong></em></li></ul> 
</blockquote> 
<p><img src="https://images2.imgbox.com/4b/2d/6nQuk2Rv_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/27/6b/2rZwliNl_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="hal_i2c_write_203"></a>hal_i2c_write()函数使用</h4> 
<blockquote> 
 <p>（1）如果明白了上述所说的I2C时序，那么这个函数的传参就很好猜了。</p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token comment">/**
 * @brief   主机I2C写入数据
 *
 * @param   i2c_id           i2c端口，传入I2Cx(x为1，2，3...)
 *         -dev              从机地址
 *         -addr             寄存器地址
 *         -alen             如果是7bit从机，传入1。10bit从机传入2
 *         -buffer           写入数据缓冲区
 *         -len              要写入几个字节数据
 *
 * @return  成功写入数据，返回0
 */</span>
<span class="token keyword">int</span> <span class="token function">hal_i2c_write</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i2c_id<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> dev<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> alen<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>buffer<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="hal_i2c_read_221"></a>hal_i2c_read()函数使用</h4> 
<blockquote> 
 <p>（1）同理</p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token comment">/**
 * @brief   主机I2C写入数据
 *
 * @param   i2c_id           i2c端口，传入I2Cx(x为1，2，3...)
 *         -dev              从机地址
 *         -addr             寄存器地址
 *         -alen             如果是7bit从机，传入1。10bit从机传入2
 *         -buffer           读取数据缓冲区
 *         -len              要读取几个字节数据
 *
 * @return  成功写入数据，返回0
 */</span>
<span class="token keyword">int</span> <span class="token function">hal_i2c_read</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i2c_id<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> dev<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> alen<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>buffer<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h2><a id="_239"></a>参考文章</h2> 
<blockquote> 
 <p>（1）<a href="https://blog.csdn.net/qq_63922192/article/details/134498481">如何自己生成fip.bin在Milkv-duo上跑freertos</a><br> （2）<a href="https://blog.csdn.net/zhuimeng_ruili/article/details/117196623">逻辑分析仪采样率和采样深度</a><br> （3）<a href="https://blog.csdn.net/zhangduang_KHKW/article/details/121953275">I2C总线协议详解（特点、通信过程、典型I2C时序）</a></p> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/198d7b1e3f09e48f444788f03d3c98b2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">松松2023年工作汇报</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b1323ef73315f2572f0451c8114b168d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">工程中uint8变量文件比uint32变量文件大4字节的问题排查</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>