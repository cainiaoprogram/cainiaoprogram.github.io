<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>pytest &#43; yaml 框架 -13.多环境配置切换 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="pytest &#43; yaml 框架 -13.多环境配置切换" />
<meta property="og:description" content="前言 当我们在测试环境写好自动化的代码，领导说你把代码部署到联调环境再测一测，这时候去改用例里面的配置是很痛苦的。
所以我们在设计自动化用例的时候，就先要想到多环境的配置与切换。
多环境配置 如果需用到多套环境 test/uat 等，那么应该在用例的根目录(pytest.ini 同级文件)创建一个config.py 文件
pip 安装插件
pip install pytest-yaml-yoyo 多套环境切换功能在 v1.1.0 版本上实现
class Config: &#34;&#34;&#34;多套环境的公共配置&#34;&#34;&#34; version = &#34;v1.0&#34; class TestConfig(Config): &#34;&#34;&#34;测试环境&#34;&#34;&#34; BASE_URL = &#39;http://192.168.1.1:8000&#39; MYSQL_HOST = &#34;192.168.1.1&#34; MYSQL_USER = &#34;root&#34; MYSQL_PASSWORD = &#34;123456&#34; MYSQL_PORT = 3306 MYSQL_DATABASE = &#34;xxx&#34; # 连接数据的库名 class UatConfig(Config): &#34;&#34;&#34;联调环境&#34;&#34;&#34; BASE_URL = &#39;http://192.168.1.3:8080&#39; MYSQL_HOST = &#34;http://192.168.1.3&#34; MYSQL_USER = &#34;root&#34; MYSQL_PASSWORD = &#34;654321&#34; MYSQL_PORT = 3306 MYSQL_DATABASE = &#34;xxx&#34; # 连接数据的库名 # 环境关系映射，方便切换多环境配置 env = { &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/b86afa54667f85be5aeea7bdbbf1d9e0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-16T15:43:40+08:00" />
<meta property="article:modified_time" content="2022-12-16T15:43:40+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">pytest &#43; yaml 框架 -13.多环境配置切换</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>前言</h2> 
<p>当我们在测试环境写好自动化的代码，领导说你把代码部署到联调环境再测一测，这时候去改用例里面的配置是很痛苦的。<br> 所以我们在设计自动化用例的时候，就先要想到多环境的配置与切换。</p> 
<h2><a id="_5"></a>多环境配置</h2> 
<p>如果需用到多套环境 test/uat 等，那么应该在用例的根目录(pytest.ini 同级文件)创建一个config.py 文件<br> pip 安装插件</p> 
<pre><code>pip install pytest-yaml-yoyo
</code></pre> 
<p>多套环境切换功能在 v1.1.0 版本上实现</p> 
<pre><code>
class Config:
    """多套环境的公共配置"""
    version = "v1.0"


class TestConfig(Config):
    """测试环境"""
    BASE_URL = 'http://192.168.1.1:8000'
    MYSQL_HOST = "192.168.1.1"
    MYSQL_USER = "root"
    MYSQL_PASSWORD = "123456"
    MYSQL_PORT = 3306
    MYSQL_DATABASE = "xxx"   # 连接数据的库名


class UatConfig(Config):
    """联调环境"""
    BASE_URL = 'http://192.168.1.3:8080'
    MYSQL_HOST = "http://192.168.1.3"
    MYSQL_USER = "root"
    MYSQL_PASSWORD = "654321"
    MYSQL_PORT = 3306
    MYSQL_DATABASE = "xxx"  # 连接数据的库名


# 环境关系映射，方便切换多环境配置
env = {
    "test": TestConfig,
    "uat": UatConfig
}
</code></pre> 
<p>按以上的配置格式，配置不同的环境，最后做一个环境名称和配置的映射关系，必须是 env 命名，格式如下</p> 
<pre><code>env = {
    "test": TestConfig,
    "uat": UatConfig
}
</code></pre> 
<p>那么在执行用例的时候，可以选择执行test 环境还是uat 环境，有 2 种方式可以配置待执行的环境</p> 
<p>方法一: 在pytest.ini 中配置</p> 
<pre><code>[pytest]


env = test
</code></pre> 
<p>方法二: 执行 pytest 命令的时候设置</p> 
<pre><code>pytest --env test
</code></pre> 
<p>如果2个地方都有设置，那么优先级是：命令行参数<code> --env test</code> 大于 pytest.ini 中配置<code>env = test</code>.</p> 
<h2><a id="_BASE_URL_74"></a>测试环境的 BASE_URL</h2> 
<p>在上一篇中讲到 <a href="https://www.cnblogs.com/yoyoketang/p/16970491.html" rel="nofollow">pytest + yaml 框架 -11.全局 base_url 配置</a></p> 
<pre><code>环境地址优先级使用如下：
1.全局配置命令行参数--base-url优先级大于 pytest.ini 文件中的base_url 配置。
2.yaml 文件 config 中的base_url 优先级大于全局配置
3.request 请求的url 如果是绝对地址，那么base_url 无效
总的来说 : url 绝对地址 &gt; config 中的base_url &gt; 命令行参数--base-url &gt; pytest.ini 文件中的base_url
</code></pre> 
<p>这里我们新增了一个在config.py 中也可以配置全局的base_url （config.py 中的配置用大写命名 BASE_URL）</p> 
<p>如果在 config.py 中配置全局的 BASE_URL ，那么也会生效。优先级会低于命令行和 pytest.ini 的配置</p> 
<p>总的来说：url 绝对地址 &gt; config 中的base_url &gt; 命令行参数–base-url &gt; pytest.ini 文件中的 base_url &gt; config.py 的 BASE_URL</p> 
<h2><a id="base_url__91"></a>多个base_url 切换</h2> 
<p>有同学提到说，如果一个用例中有多个base_url 需要切换，该如何解决？</p> 
<p>我们在配置项中BASE_URL 项是设置默认的全局base_url地址，如果有多个地址，我们还可以用其它的配置参数，比如 <code>BLOG_URL</code> 和 <code>DEMO_URL</code></p> 
<pre><code>
class TestConfig(Config):
    """测试环境"""
    BASE_URL = 'http://192.168.1.1:8000'
    BLOG_URL = 'https://www.cnblogs.com'
    DEMO_URL = 'http://httpbin.org'
    MYSQL_HOST = "192.168.1.1"
    MYSQL_USER = "root"
    MYSQL_PASSWORD = "123456"
    MYSQL_PORT = 3306
    MYSQL_DATABASE = "xxx"   # 连接数据的库名
</code></pre> 
<p>上面的配置中，我们就配置了3个环境地址</p> 
<pre><code>    BASE_URL = 'http://192.168.1.1:8000'
    BLOG_URL = 'https://www.cnblogs.com'
    DEMO_URL = 'http://httpbin.org'
</code></pre> 
<p>在yaml 用例中，如果没有传base_url, 那么会用默认的 <code>BASE_URL = 'http://192.168.1.1:8000'</code></p> 
<p>使用示例</p> 
<pre><code>config:
  name: 示例

用例:
-
  name: GET
  request:
    method: GET
    url: /get
  validate:
    - eq: [status_code, 200]
</code></pre> 
<p>当一个接口中同时用到3个测试地址 <code>BASE_URL</code>、<code>BLOG_URL</code>、<code>DEMO_URL</code> 时，可以通过 env 变量取值，如: <code>${env.BLOG_URL}</code></p> 
<pre><code>config:
  name: 示例

用例:

-
  name: GET
  request:
    method: GET
    url: ${env.BLOG_URL}/yoyoketang
  validate:
    - eq: [status_code, 200]

-
  name: GET
  request:
    method: GET
    url: ${env.DEMO_URL}/get
  validate:
    - eq: [status_code, 200]

-
  name: GET
  request:
    method: GET
    url: /get
  validate:
    - eq: [status_code, 200]
</code></pre> 
<h2><a id="_168"></a>其它配置参数</h2> 
<p>如果配置中需要加其它配置参数</p> 
<pre><code>class TestConfig(Config):
    """测试环境"""
    BASE_URL = 'http://192.168.1.1:8000'
    USER = 'test'
    TEL = '100860000'

</code></pre> 
<p>那么在用例中引用配置参数可以用 <code>${env.配置参数}</code> 取到配置中的值。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2cbcc89eb9df4b290a20d4c857be7acb/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">新征程-猿如意试用一波！</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f9460929b44572dd36ec81867509799d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">超微A&#43; Server 4124GS-TNR做主板集成RAID</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>