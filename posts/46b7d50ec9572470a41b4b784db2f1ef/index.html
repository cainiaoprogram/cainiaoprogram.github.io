<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SpringBooté›†æˆ SpringSecurityå®‰å…¨æ¡†æ¶ - èœé¸Ÿç¨‹åºå‘˜åšå®¢</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="SpringBooté›†æˆ SpringSecurityå®‰å…¨æ¡†æ¶" />
<meta property="og:description" content="æ–‡ç« ç›®å½• ä¸€ã€CSRFè·¨ç«™è¯·æ±‚ä¼ªé€ æ”»å‡»äºŒã€é¡¹ç›®å‡†å¤‡ä¸‰ã€è®¤è¯† SpringSecurity3.1 è®¤è¯ğŸ€â‘ ç›´æ¥è®¤è¯ğŸ€â‘¡ä½¿ç”¨æ•°æ®åº“è®¤è¯ 3.2 æˆæƒğŸ¡â‘ åŸºäºè§’è‰²æˆæƒğŸ¡â‘¡åŸºäºæƒé™çš„æˆæƒğŸ¡â‘¢ä½¿ç”¨æ³¨è§£åˆ¤æ–­æƒé™ 3.3 &#34;è®°ä½æˆ‘&#34;3.4 ç™»å½•å’Œæ³¨é”€ğŸ’¥â‘ åŸç”Ÿç™»å½•ç•Œé¢ğŸ’¥â‘¡è‡ªå®šä¹‰ç™»å½•ç•Œé¢ğŸ’¥æ³¨é”€ 3.4 SecurityContext æç¤ºï¼šä»¥ä¸‹æ˜¯æœ¬ç¯‡æ–‡ç« æ­£æ–‡å†…å®¹ï¼ŒJava ç³»åˆ—å­¦ä¹ å°†ä¼šæŒç»­æ›´æ–° ä¸€ã€CSRFè·¨ç«™è¯·æ±‚ä¼ªé€ æ”»å‡» æˆ‘ä»¬æ—¶å¸¸ä¼šåœ¨ QQ ä¸Šæ”¶åˆ°åˆ«äººå‘é€çš„é’“é±¼ç½‘ç«™é“¾æ¥ï¼Œåªè¦ä½ åœ¨ç™»å½•QQè´¦å·çš„æƒ…å†µä¸‹ç‚¹å‡»é“¾æ¥ï¼Œé‚£ä¹ˆä¸å‡ºæ„å¤–ï¼Œä½ çš„å·å·²ç»åœ¨åˆ«äººæ‰‹ä¸­äº†ã€‚å®é™…ä¸Šè¿™ä¸€ç±»ç½‘ç«™éƒ½å±äºæ¶æ„ç½‘ç«™ï¼Œä¸“é—¨ç”¨äºç›—å–ä»–äººä¿¡æ¯ï¼Œæ‰§è¡Œéæ³•æ“ä½œï¼Œç”šè‡³è·å–ä»–äººè´¦æˆ·ä¸­çš„è´¢äº§ï¼Œéæ³•è½¬è´¦ç­‰ã€‚
æˆ‘ä»¬åœ¨ JavaWeb é˜¶æ®µå·²ç»äº†è§£äº† Session å’Œ Cookie çš„æœºåˆ¶ï¼Œåœ¨ä¸€å¼€å§‹çš„æ—¶å€™ï¼ŒæœåŠ¡ç«¯ä¼šç»™æµè§ˆå™¨ä¸€ä¸ªåä¸º JSESSION çš„ Cookie ä¿¡æ¯ä½œä¸ºä¼šè¯çš„å”¯ä¸€å‡­æ®ï¼Œåªè¦ç”¨æˆ·æºå¸¦æ­¤ Cookie è®¿é—®æˆ‘ä»¬çš„ç½‘ç«™ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥è®¤å®šæ­¤ä¼šè¯å±äºå“ªä¸ªæµè§ˆå™¨ã€‚å› æ­¤ï¼Œåªè¦æ­¤ä¼šè¯çš„ç”¨æˆ·æ‰§è¡Œäº†ç™»å½•æ“ä½œï¼Œé‚£ä¹ˆå°±å¯ä»¥éšæ„è®¿é—®ä¸ªäººä¿¡æ¯ç­‰å†…å®¹ã€‚
è¦å®Œæˆä¸€æ¬¡CSRFæ”»å‡»ï¼Œå—å®³è€…å¿…é¡»ä¾æ¬¡å®Œæˆä¸¤ä¸ªæ­¥éª¤ï¼š
ç™»å½•å—ä¿¡ä»»ç½‘ç«™Aï¼Œå¹¶åœ¨æœ¬åœ°ç”Ÿæˆ Cookieã€‚åœ¨ä¸ç™»å‡ºAçš„æƒ…å†µä¸‹ï¼Œè®¿é—®å±é™©ç½‘ç«™Bã€‚ ç¡®å®å¦‚æ­¤ï¼Œæˆ‘ä»¬æ— æ³•ä¿è¯ä»¥ä¸‹æƒ…å†µä¸ä¼šå‘ç”Ÿï¼š
ä½ ä¸èƒ½ä¿è¯ä½ ç™»å½•äº†ä¸€ä¸ªç½‘ç«™åï¼Œä¸å†æ‰“å¼€ä¸€ä¸ªwebé¡µé¢å¹¶è®¿é—®å¦å¤–çš„ç½‘ç«™ã€‚ä½ ä¸èƒ½ä¿è¯ä½ å…³é—­æµè§ˆå™¨äº†åï¼Œä½ æœ¬åœ°çš„Cookieç«‹åˆ»è¿‡æœŸï¼Œä½ ä¸Šæ¬¡çš„ä¼šè¯å·²ç»ç»“æŸã€‚ä¸Šå›¾ä¸­æ‰€è°“çš„æ”»å‡»ç½‘ç«™ï¼Œå¯èƒ½æ˜¯ä¸€ä¸ªå­˜åœ¨å…¶ä»–æ¼æ´çš„å¯ä¿¡ä»»çš„ç»å¸¸è¢«äººè®¿é—®çš„ç½‘ç«™ã€‚ æ˜¾ç„¶ï¼Œæˆ‘ä»¬ä¹‹å‰ç¼–å†™çš„å›¾ä¹¦ç®¡ç†ç³»ç»Ÿå°±å­˜åœ¨è¿™æ ·çš„å®‰å…¨æ¼æ´ï¼Œè€ŒSpringSecurityå°±å¾ˆå¥½åœ°è§£å†³äº†è¿™æ ·çš„é—®é¢˜ã€‚
äºŒã€é¡¹ç›®å‡†å¤‡ æˆ‘ä»¬è¿˜æ˜¯åŸºäºä¹‹å‰çš„ SpringBoot é¡¹ç›® - å›¾ä¹¦ç®¡ç†ç³»ç»Ÿè¿›è¡Œæ”¹é€ ï¼Œéœ€è¦å®ç°ä»¥ä¸‹ï¼š
http://localhost:8080/index.html - ä»»ä½•äººéƒ½å¯ä»¥è®¿é—®ï¼Œä¸éœ€è¦ç™»å½•http://localhost:8080/book/{bid} - ä»»ä½•äººéƒ½å¯ä»¥è®¿é—®ï¼Œä¸éœ€è¦ç™»å½•http://localhost:8080/user/{bid} - åªæœ‰ç”¨æˆ·å¯ä»¥è®¿é—®ï¼Œå¿…é¡»ç™»å½•http://localhost:8080/borrow/{uid} - åªæœ‰ç®¡ç†å‘˜å¯ä»¥è®¿é—®ï¼Œå¿…é¡»ç™»å½• å›åˆ°ç›®å½•â€¦
ä¸‰ã€è®¤è¯† SpringSecurity Spring Security æ˜¯é’ˆå¯¹Springé¡¹ç›®çš„å®‰å…¨æ¡†æ¶ï¼Œä¹Ÿæ˜¯Spring Bootåº•å±‚å®‰å…¨æ¨¡å—é»˜è®¤çš„æŠ€æœ¯é€‰å‹ï¼Œä»–å¯ä»¥å®ç°å¼ºå¤§çš„Webå®‰å…¨æ§åˆ¶ï¼Œå¯¹äºå®‰å…¨æ§åˆ¶ï¼Œæˆ‘ä»¬ä»…éœ€è¦å¼•å…¥ spring-boot-starter-security æ¨¡å—ï¼Œè¿›è¡Œå°‘é‡çš„é…ç½®ï¼Œå³å¯å®ç°å¼ºå¤§çš„å®‰å…¨ç®¡ç†ï¼
è®°ä½å‡ ä¸ªç±»ï¼š
WebSecurityConfigurerAdapterï¼šè‡ªå®šä¹‰ Security ç­–ç•¥AuthenticationManagerBuilderï¼šè‡ªå®šä¹‰è®¤è¯ç­–ç•¥@EnableWebSecurityï¼šå¼€å¯ WebSecurity æ¨¡å¼ Spring Security çš„ä¸¤ä¸ªä¸»è¦ç›®æ ‡æ˜¯ â€œè®¤è¯â€ å’Œ â€œæˆæƒâ€ï¼ˆè®¿é—®æ§åˆ¶ï¼‰ã€‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/46b7d50ec9572470a41b4b784db2f1ef/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-19T18:58:12+08:00" />
<meta property="article:modified_time" content="2023-03-19T18:58:12+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="èœé¸Ÿç¨‹åºå‘˜åšå®¢" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">èœé¸Ÿç¨‹åºå‘˜åšå®¢</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SpringBooté›†æˆ SpringSecurityå®‰å…¨æ¡†æ¶</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atelier-sulphurpool-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3 id="mulu"> </h3> 
<p></p> 
<div class="toc"> 
 <h4>æ–‡ç« ç›®å½•</h4> 
 <ul><li><a href="#CSRF_8" rel="nofollow">ä¸€ã€CSRFè·¨ç«™è¯·æ±‚ä¼ªé€ æ”»å‡»</a></li><li><a href="#_28" rel="nofollow">äºŒã€é¡¹ç›®å‡†å¤‡</a></li><li><a href="#_SpringSecurity_38" rel="nofollow">ä¸‰ã€è®¤è¯† SpringSecurity</a></li><li><ul><li><a href="#31__79" rel="nofollow">3.1 è®¤è¯</a></li><li><ul><li><a href="#_80" rel="nofollow">ğŸ€â‘ ç›´æ¥è®¤è¯</a></li><li><a href="#_106" rel="nofollow">ğŸ€â‘¡ä½¿ç”¨æ•°æ®åº“è®¤è¯</a></li></ul> 
   </li><li><a href="#32__164" rel="nofollow">3.2 æˆæƒ</a></li><li><ul><li><a href="#_165" rel="nofollow">ğŸ¡â‘ åŸºäºè§’è‰²æˆæƒ</a></li><li><a href="#_176" rel="nofollow">ğŸ¡â‘¡åŸºäºæƒé™çš„æˆæƒ</a></li><li><a href="#_195" rel="nofollow">ğŸ¡â‘¢ä½¿ç”¨æ³¨è§£åˆ¤æ–­æƒé™</a></li></ul> 
   </li><li><a href="#33__220" rel="nofollow">3.3 "è®°ä½æˆ‘"</a></li><li><a href="#34__238" rel="nofollow">3.4 ç™»å½•å’Œæ³¨é”€</a></li><li><ul><li><a href="#_239" rel="nofollow">ğŸ’¥â‘ åŸç”Ÿç™»å½•ç•Œé¢</a></li><li><a href="#_270" rel="nofollow">ğŸ’¥â‘¡è‡ªå®šä¹‰ç™»å½•ç•Œé¢</a></li><li><a href="#_325" rel="nofollow">ğŸ’¥æ³¨é”€</a></li></ul> 
   </li><li><a href="#34_SecurityContext_332" rel="nofollow">3.4 SecurityContext</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<hr> 
<font color="#999AAA">æç¤ºï¼šä»¥ä¸‹æ˜¯æœ¬ç¯‡æ–‡ç« æ­£æ–‡å†…å®¹ï¼ŒJava ç³»åˆ—å­¦ä¹ å°†ä¼šæŒç»­æ›´æ–° </font> 
<p></p> 
<h2><a id="CSRF_8"></a>ä¸€ã€CSRFè·¨ç«™è¯·æ±‚ä¼ªé€ æ”»å‡»</h2> 
<p>æˆ‘ä»¬æ—¶å¸¸ä¼šåœ¨ QQ ä¸Šæ”¶åˆ°åˆ«äººå‘é€çš„é’“é±¼ç½‘ç«™é“¾æ¥ï¼Œåªè¦ä½ åœ¨ç™»å½•QQè´¦å·çš„æƒ…å†µä¸‹ç‚¹å‡»é“¾æ¥ï¼Œé‚£ä¹ˆä¸å‡ºæ„å¤–ï¼Œä½ çš„å·å·²ç»åœ¨åˆ«äººæ‰‹ä¸­äº†ã€‚å®é™…ä¸Šè¿™ä¸€ç±»ç½‘ç«™éƒ½å±äº<strong>æ¶æ„ç½‘ç«™</strong>ï¼Œä¸“é—¨ç”¨äºç›—å–ä»–äººä¿¡æ¯ï¼Œæ‰§è¡Œéæ³•æ“ä½œï¼Œç”šè‡³è·å–ä»–äººè´¦æˆ·ä¸­çš„è´¢äº§ï¼Œéæ³•è½¬è´¦ç­‰ã€‚</p> 
<p>æˆ‘ä»¬åœ¨ JavaWeb é˜¶æ®µå·²ç»äº†è§£äº† Session å’Œ Cookie çš„æœºåˆ¶ï¼Œåœ¨ä¸€å¼€å§‹çš„æ—¶å€™ï¼ŒæœåŠ¡ç«¯ä¼šç»™æµè§ˆå™¨ä¸€ä¸ªåä¸º <code>JSESSION</code> çš„ Cookie ä¿¡æ¯ä½œä¸ºä¼šè¯çš„å”¯ä¸€å‡­æ®ï¼Œåªè¦ç”¨æˆ·æºå¸¦æ­¤ Cookie è®¿é—®æˆ‘ä»¬çš„ç½‘ç«™ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥è®¤å®šæ­¤ä¼šè¯å±äºå“ªä¸ªæµè§ˆå™¨ã€‚å› æ­¤ï¼Œåªè¦æ­¤ä¼šè¯çš„ç”¨æˆ·æ‰§è¡Œäº†ç™»å½•æ“ä½œï¼Œé‚£ä¹ˆå°±å¯ä»¥éšæ„è®¿é—®ä¸ªäººä¿¡æ¯ç­‰å†…å®¹ã€‚</p> 
<p><img src="https://images2.imgbox.com/5d/9a/wN2MiLG4_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<p><strong>è¦å®Œæˆä¸€æ¬¡CSRFæ”»å‡»ï¼Œå—å®³è€…å¿…é¡»ä¾æ¬¡å®Œæˆä¸¤ä¸ªæ­¥éª¤ï¼š</strong></p> 
<ol><li>ç™»å½•å—ä¿¡ä»»ç½‘ç«™Aï¼Œå¹¶åœ¨æœ¬åœ°ç”Ÿæˆ Cookieã€‚</li><li>åœ¨ä¸ç™»å‡ºAçš„æƒ…å†µä¸‹ï¼Œè®¿é—®å±é™©ç½‘ç«™Bã€‚</li></ol> 
<p><strong>ç¡®å®å¦‚æ­¤ï¼Œæˆ‘ä»¬æ— æ³•ä¿è¯ä»¥ä¸‹æƒ…å†µä¸ä¼šå‘ç”Ÿï¼š</strong></p> 
<ol><li>ä½ ä¸èƒ½ä¿è¯ä½ ç™»å½•äº†ä¸€ä¸ªç½‘ç«™åï¼Œä¸å†æ‰“å¼€ä¸€ä¸ªwebé¡µé¢å¹¶è®¿é—®å¦å¤–çš„ç½‘ç«™ã€‚</li><li>ä½ ä¸èƒ½ä¿è¯ä½ å…³é—­æµè§ˆå™¨äº†åï¼Œä½ æœ¬åœ°çš„Cookieç«‹åˆ»è¿‡æœŸï¼Œä½ ä¸Šæ¬¡çš„ä¼šè¯å·²ç»ç»“æŸã€‚</li><li>ä¸Šå›¾ä¸­æ‰€è°“çš„æ”»å‡»ç½‘ç«™ï¼Œå¯èƒ½æ˜¯ä¸€ä¸ªå­˜åœ¨å…¶ä»–æ¼æ´çš„å¯ä¿¡ä»»çš„ç»å¸¸è¢«äººè®¿é—®çš„ç½‘ç«™ã€‚</li></ol> 
<p>æ˜¾ç„¶ï¼Œæˆ‘ä»¬ä¹‹å‰ç¼–å†™çš„å›¾ä¹¦ç®¡ç†ç³»ç»Ÿå°±å­˜åœ¨è¿™æ ·çš„å®‰å…¨æ¼æ´ï¼Œè€Œ<code>SpringSecurity</code>å°±å¾ˆå¥½åœ°è§£å†³äº†è¿™æ ·çš„é—®é¢˜ã€‚</p> 
<h2><a id="_28"></a>äºŒã€é¡¹ç›®å‡†å¤‡</h2> 
<p>æˆ‘ä»¬è¿˜æ˜¯åŸºäºä¹‹å‰çš„ SpringBoot é¡¹ç›® - å›¾ä¹¦ç®¡ç†ç³»ç»Ÿè¿›è¡Œæ”¹é€ ï¼Œéœ€è¦å®ç°ä»¥ä¸‹ï¼š</p> 
<ul><li><code>http://localhost:8080/index.html</code> - ä»»ä½•äººéƒ½å¯ä»¥è®¿é—®ï¼Œä¸éœ€è¦ç™»å½•</li><li><code>http://localhost:8080/book/{bid}</code> - ä»»ä½•äººéƒ½å¯ä»¥è®¿é—®ï¼Œä¸éœ€è¦ç™»å½•</li><li><code>http://localhost:8080/user/{bid}</code> - åªæœ‰ç”¨æˆ·å¯ä»¥è®¿é—®ï¼Œå¿…é¡»ç™»å½•</li><li><code>http://localhost:8080/borrow/{uid}</code> - åªæœ‰ç®¡ç†å‘˜å¯ä»¥è®¿é—®ï¼Œå¿…é¡»ç™»å½•</li></ul> 
<p><a href="#mulu" rel="nofollow">å›åˆ°ç›®å½•â€¦</a></p> 
<h2><a id="_SpringSecurity_38"></a>ä¸‰ã€è®¤è¯† SpringSecurity</h2> 
<p>Spring Security æ˜¯é’ˆå¯¹Springé¡¹ç›®çš„å®‰å…¨æ¡†æ¶ï¼Œä¹Ÿæ˜¯Spring Bootåº•å±‚å®‰å…¨æ¨¡å—é»˜è®¤çš„æŠ€æœ¯é€‰å‹ï¼Œä»–å¯ä»¥å®ç°å¼ºå¤§çš„Webå®‰å…¨æ§åˆ¶ï¼Œå¯¹äºå®‰å…¨æ§åˆ¶ï¼Œæˆ‘ä»¬ä»…éœ€è¦å¼•å…¥ spring-boot-starter-security æ¨¡å—ï¼Œè¿›è¡Œå°‘é‡çš„é…ç½®ï¼Œå³å¯å®ç°å¼ºå¤§çš„å®‰å…¨ç®¡ç†ï¼</p> 
<p>è®°ä½å‡ ä¸ªç±»ï¼š</p> 
<ul><li><code>WebSecurityConfigurerAdapter</code>ï¼šè‡ªå®šä¹‰ Security ç­–ç•¥</li><li><code>AuthenticationManagerBuilder</code>ï¼šè‡ªå®šä¹‰è®¤è¯ç­–ç•¥</li><li><code>@EnableWebSecurity</code>ï¼šå¼€å¯ WebSecurity æ¨¡å¼</li></ul> 
<p>Spring Security çš„ä¸¤ä¸ªä¸»è¦ç›®æ ‡æ˜¯ â€œè®¤è¯â€ å’Œ â€œæˆæƒâ€ï¼ˆè®¿é—®æ§åˆ¶ï¼‰ã€‚</p> 
<ul><li><strong>â€œè®¤è¯â€ï¼ˆAuthenticationï¼‰</strong><br> èº«ä»½éªŒè¯æ˜¯å…³äºéªŒè¯æ‚¨çš„å‡­æ®ï¼Œå¦‚ç”¨æˆ·å/ç”¨æˆ·IDå’Œå¯†ç ï¼Œä»¥éªŒè¯æ‚¨çš„èº«ä»½ã€‚<br> èº«ä»½éªŒè¯é€šå¸¸é€šè¿‡ç”¨æˆ·åå’Œå¯†ç å®Œæˆï¼Œæœ‰æ—¶ä¸èº«ä»½éªŒè¯å› ç´ ç»“åˆä½¿ç”¨ã€‚</li><li><strong>â€œæˆæƒâ€ ï¼ˆAuthorizationï¼‰</strong><br> æˆæƒå‘ç”Ÿåœ¨ç³»ç»ŸæˆåŠŸéªŒè¯æ‚¨çš„èº«ä»½åï¼Œæœ€ç»ˆä¼šæˆäºˆæ‚¨è®¿é—®èµ„æºï¼ˆå¦‚ä¿¡æ¯ï¼Œæ–‡ä»¶ï¼Œæ•°æ®åº“ï¼Œèµ„é‡‘ï¼Œä½ç½®ï¼Œå‡ ä¹ä»»ä½•å†…å®¹ï¼‰çš„å®Œå…¨æƒé™ã€‚<br> è¿™ä¸ªæ¦‚å¿µæ˜¯é€šç”¨çš„ï¼Œè€Œä¸æ˜¯åªåœ¨Spring Security ä¸­å­˜åœ¨ã€‚</li></ul> 
<p><font color="red"><strong>å‚è€ƒå®˜ç½‘</strong>ï¼š<a href="https://spring.io/projects/spring-security" rel="nofollow">https://spring.io/projects/spring-security</a></font></p> 
<p><font color="red"><strong>ç›¸å…³å¸®åŠ©æ–‡æ¡£</strong>ï¼š<a href="https://docs.spring.io/spring-security/site/docs/3.0.7.RELEASE/reference/" rel="nofollow">https://docs.spring.io/spring-security/site/docs/3.0.7.RELEASE/reference</a></font></p> 
<p><font color="blue"><strong>â‘ å…ˆå¼•å…¥ SpringSecurity ä¾èµ–</strong>ï¼š</font></p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p><font color="orange"><strong>â‘¡å®ç° SpringSecurity é…ç½®ç±»ï¼š</strong> æˆ‘ä»¬å¯ä»¥åœ¨é…ç½®ç±»ä¸­è®¤è¯å’Œæˆæƒ</font></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@EnableWebSecurity</span> <span class="token comment">// å¼€å¯WebSecurityæ¨¡å¼</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span>
</code></pre> 
<p><a href="#mulu" rel="nofollow">å›åˆ°ç›®å½•â€¦</a></p> 
<h3><a id="31__79"></a>3.1 è®¤è¯</h3> 
<h4><a id="_80"></a>ğŸ€â‘ ç›´æ¥è®¤è¯</h4> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>

    <span class="token class-name">BCryptPasswordEncoder</span> encoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// å¿…é¡»åŠ å¯†ï¼Œä½¿ç”¨SpringSecurityæä¾›çš„BCryptPasswordEncoder</span>
    <span class="token comment">// åœ¨å†…å­˜ä¸­å®šä¹‰è®¤è¯ç”¨æˆ·</span>
    auth<span class="token punctuation">.</span><span class="token function">inMemoryAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span>encoder<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">withUser</span><span class="token punctuation">(</span><span class="token string">"aaa"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span>encoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"666"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">"currentUser"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">withUser</span><span class="token punctuation">(</span><span class="token string">"bbb"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span>encoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"666"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">"currentUser"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">withUser</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span>encoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>SpringSecurity çš„å¯†ç æ ¡éªŒå¹¶ä¸æ˜¯ç›´æ¥ä½¿ç”¨åŸæ–‡è¿›è¡Œæ¯”è¾ƒï¼Œè€Œæ˜¯ä½¿ç”¨åŠ å¯†ç®—æ³•å°†å¯†ç è¿›è¡ŒåŠ å¯†ï¼ˆæ›´å‡†ç¡®åœ°è¯´åº”è¯¥è¿›è¡ŒHashå¤„ç†ï¼Œæ­¤è¿‡ç¨‹æ˜¯ä¸å¯é€†çš„ï¼Œæ— æ³•è§£å¯†ï¼‰ï¼Œæœ€åå°†ç”¨æˆ·æä¾›çš„å¯†ç ä»¥åŒæ ·çš„æ–¹å¼åŠ å¯†åä¸å¯†æ–‡è¿›è¡Œæ¯”è¾ƒã€‚<br> å¯¹äºæˆ‘ä»¬æ¥è¯´ï¼Œç”¨æˆ·æä¾›çš„å¯†ç å±äºéšç§ä¿¡æ¯ï¼Œç›´æ¥æ˜æ–‡å­˜å‚¨å¹¶ä¸å¥½ï¼Œè€Œä¸”å¦‚æœæ•°æ®åº“å†…å®¹è¢«çªƒå–ï¼Œé‚£ä¹ˆæ‰€æœ‰ç”¨æˆ·çš„å¯†ç å°†å…¨éƒ¨æ³„éœ²ï¼Œè¿™æ˜¯æˆ‘ä»¬ä¸å¸Œæœ›çœ‹åˆ°çš„ç»“æœï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§æ—¢èƒ½éšè—ç”¨æˆ·å¯†ç ä¹Ÿèƒ½å®Œæˆè®¤è¯çš„æœºåˆ¶ï¼Œè€ŒHashå¤„ç†å°±æ˜¯ä¸€ç§å¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆï¼Œé€šè¿‡å°†ç”¨æˆ·çš„å¯†ç è¿›è¡ŒHashå€¼è®¡ç®—ï¼Œè®¡ç®—å‡ºæ¥çš„ç»“æœæ— æ³•è¿˜åŸä¸ºåŸæ–‡ï¼Œå¦‚æœéœ€è¦éªŒè¯æ˜¯å¦ä¸æ­¤å¯†ç ä¸€è‡´ï¼Œé‚£ä¹ˆéœ€è¦ä»¥åŒæ ·çš„æ–¹å¼åŠ å¯†å†æ¯”è¾ƒä¸¤ä¸ªHashå€¼æ˜¯å¦ä¸€è‡´ï¼Œè¿™æ ·å°±å¾ˆå¥½çš„ä¿è¯äº†ç”¨æˆ·å¯†ç çš„å®‰å…¨æ€§ã€‚</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/1e/61/pb1sMsGl_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> æ­¤æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥æˆåŠŸç™»å½•äº†ï¼</p> 
<p><a href="#mulu" rel="nofollow">å›åˆ°ç›®å½•â€¦</a></p> 
<h4><a id="_106"></a>ğŸ€â‘¡ä½¿ç”¨æ•°æ®åº“è®¤è¯</h4> 
<p>a. é¦–å…ˆï¼Œæˆ‘ä»¬å¿…é¡»ä¿è¯æ•°æ®åº“ä¸­çš„ <code>user.password</code> æ˜¯é€šè¿‡ <code>BCryptPasswordEncoder</code> åŠ å¯†è¿‡çš„ï¼Œå¦åˆ™éªŒè¯ä¸é€šè¿‡ã€‚æˆ‘ä»¬å¯ä»¥å°†åŠ å¯†åçš„å¯†ç æ’å…¥åˆ°æ•°æ®åº“ä¸­ï¼š</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">toEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">BCryptPasswordEncoder</span> encoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>encoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>b. ç¼–å†™ UserMapper ä¸­è·å–ç”¨æˆ·å¯†ç çš„ SQL</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">"select password from user where name = #{name}"</span><span class="token punctuation">)</span>
<span class="token class-name">String</span> <span class="token function">getPasswordByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>c. ç„¶åæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª Service å®ç°ï¼Œå®ç°çš„æ˜¯ <code>UserDetailsService</code>ï¼Œå®ƒæ”¯æŒæˆ‘ä»¬è‡ªå·±è¿”å›ä¸€ä¸ª <code>UserDetails</code> å¯¹è±¡ï¼Œæˆ‘ä»¬åªéœ€ç›´æ¥è¿”å›ä¸€ä¸ªåŒ…å«æ•°æ®åº“ä¸­çš„ç”¨æˆ·åã€å¯†ç ç­‰ä¿¡æ¯çš„ UserDetails å³å¯ï¼Œ <code>SpringSecurity</code> ä¼šè‡ªåŠ¨è¿›è¡Œæ¯”å¯¹ã€‚</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserDetailsServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token class-name">UserMapper</span> userMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> password <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">getPasswordByUsername</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//ä»æ•°æ®åº“æ ¹æ®ç”¨æˆ·åè·å–å¯†ç </span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>password <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UsernameNotFoundException</span><span class="token punctuation">(</span><span class="token string">"ç™»å½•å¤±è´¥ï¼Œç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">User</span>   <span class="token comment">// è¿™é‡Œéœ€è¦è¿”å› UserDetailsï¼ŒSpringSecurity ä¼šæ ¹æ®ç»™å®šçš„ä¿¡æ¯è¿›è¡Œæ¯”å¯¹</span>
                <span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span>   <span class="token comment">// ç›´æ¥ä»æ•°æ®åº“å–çš„å¯†ç </span>
                <span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">"currentUser"</span><span class="token punctuation">)</span>   <span class="token comment">// ç”¨æˆ·è§’è‰²</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>d. ä¿®æ”¹ä¸€ä¸‹ Security é…ç½®ç±»ï¼š</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">UserDetailsServiceImpl</span> userDetailsService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// ä»æ•°æ®åº“ä¸­è®¤è¯</span>
        auth
                <span class="token punctuation">.</span><span class="token function">userDetailsService</span><span class="token punctuation">(</span>userDetailsService<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/4d/26/KFgNNNRg_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> æ­¤æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨æ•°æ®åº“ä¿¡æ¯ç™»å½•æˆåŠŸäº†ï¼</p> 
<p><a href="#mulu" rel="nofollow">å›åˆ°ç›®å½•â€¦</a></p> 
<h3><a id="32__164"></a>3.2 æˆæƒ</h3> 
<h4><a id="_165"></a>ğŸ¡â‘ åŸºäºè§’è‰²æˆæƒ</h4> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// å®šåˆ¶è¯·æ±‚çš„æˆæƒè§„åˆ™</span>
    http<span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   	        <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/index.html"</span><span class="token punctuation">,</span> <span class="token string">"/book/*"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// æ‰€æœ‰äººéƒ½å¯ä»¥è®¿é—®</span>
  		    <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/user/*"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token string">"currentUser"</span><span class="token punctuation">)</span> <span class="token comment">// æŸä¸ªè§’è‰²å¯ä»¥è®¿é—®çš„é¡µé¢</span>
  		    <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/borrow/*"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_176"></a>ğŸ¡â‘¡åŸºäºæƒé™çš„æˆæƒ</h4> 
<p>åŸºäºæƒé™çš„æˆæƒä¸è§’è‰²ç±»ä¼¼ï¼Œéœ€è¦ä»¥ <code>hasAnyAuthority</code> æˆ– <code>hasAuthority</code> è¿›è¡Œåˆ¤æ–­ï¼š</p> 
<pre><code class="prism language-java"><span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasAnyAuthority</span><span class="token punctuation">(</span><span class="token string">"page:index"</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> password <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">getPasswordByUsername</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>password <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UsernameNotFoundException</span><span class="token punctuation">(</span><span class="token string">"ç™»å½•å¤±è´¥ï¼Œç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">User</span>
            <span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">authorities</span><span class="token punctuation">(</span><span class="token string">"page:index"</span><span class="token punctuation">)</span> <span class="token comment">// æƒé™</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_195"></a>ğŸ¡â‘¢ä½¿ç”¨æ³¨è§£åˆ¤æ–­æƒé™</h4> 
<p>æˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨éœ€è¦æ·»åŠ æƒé™éªŒè¯çš„è¯·æ±‚æ˜ å°„ä¸Šæ·»åŠ æ³¨è§£ï¼š</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">"hasRole('currentUser')"</span><span class="token punctuation">)</span>   <span class="token comment">//åˆ¤æ–­æ˜¯å¦ä¸º currentUser è§’è‰²ï¼Œåªæœ‰æ­¤è§’è‰²æ‰å¯ä»¥è®¿é—®</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/hello"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token string">"hello,world"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>é€šè¿‡æ·»åŠ  <code>@PreAuthorize</code> æ³¨è§£ï¼Œåœ¨æ‰§è¡Œä¹‹å‰åˆ¤æ–­åˆ¤æ–­æƒé™ï¼Œå¦‚æœæ²¡æœ‰å¯¹åº”çš„æƒé™æˆ–æ˜¯å¯¹åº”çš„è§’è‰²ï¼Œå°†æ— æ³•è®¿é—®é¡µé¢ã€‚</p> 
<p>åŒæ ·çš„è¿˜æœ‰ <code>@PostAuthorize</code> æ³¨è§£ï¼Œä½†æ˜¯å®ƒæ˜¯åœ¨æ–¹æ³•æ‰§è¡Œä¹‹åå†è¿›è¡Œæ‹¦æˆªï¼š</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@PostAuthorize</span><span class="token punctuation">(</span><span class="token string">"hasRole('currentUser')"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/test"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>"å…ˆæ‰§è¡Œï¼Œå†æ‹¦æˆª<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">"test"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><a href="#mulu" rel="nofollow">å›åˆ°ç›®å½•â€¦</a></p> 
<h3><a id="33__220"></a>3.3 â€œè®°ä½æˆ‘â€</h3> 
<pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>checkbox<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>remember<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span> è®°ä½æˆ‘
</code></pre> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// ........................</span>
    http<span class="token punctuation">.</span><span class="token function">rememberMe</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// è®°ä½æˆ‘</span>
    	<span class="token punctuation">.</span><span class="token function">rememberMeParameter</span><span class="token punctuation">(</span><span class="token string">"remember"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è‡ªå®šä¹‰é¡µé¢çš„å‚æ•°ï¼</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>ç™»å½•æˆåŠŸåï¼Œå°† cookie å‘é€ç»™æµè§ˆå™¨ä¿å­˜ï¼Œä»¥åç™»å½•å¸¦ä¸Šè¿™ä¸ª cookieï¼Œåªè¦é€šè¿‡æ£€æŸ¥å°±å¯ä»¥å…ç™»å½•äº†ã€‚å¦‚æœç‚¹å‡»æ³¨é”€ï¼Œspringsecurity å¸®æˆ‘ä»¬è‡ªåŠ¨åˆ é™¤äº†è¿™ä¸ª cookieã€‚</p> 
<h3><a id="34__238"></a>3.4 ç™»å½•å’Œæ³¨é”€</h3> 
<h4><a id="_239"></a>ğŸ’¥â‘ åŸç”Ÿç™»å½•ç•Œé¢</h4> 
<p><img src="https://images2.imgbox.com/ae/94/uaOI9xMD_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> é¦–å…ˆæˆ‘ä»¬è¦äº†è§£ä¸€ä¸‹ SpringSecurity æ˜¯å¦‚ä½•è¿›è¡Œç™»é™†éªŒè¯çš„ï¼Œæˆ‘ä»¬å¯ä»¥è§‚å¯Ÿä¸€ä¸‹é»˜è®¤çš„ç™»é™†ç•Œé¢ä¸­ï¼Œè¡¨å•å†…æœ‰å“ªäº›å†…å®¹ï¼š</p> 
<pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-signin<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/book_manager/login<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-signin-heading<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Please sign in<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sr-only<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Username<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Username<span class="token punctuation">"</span></span> <span class="token attr-name">required</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token attr-name">autofocus</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sr-only<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Password<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Password<span class="token punctuation">"</span></span> <span class="token attr-name">required</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>_csrf<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hidden<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>83421936-b84b-44e3-be47-58bb2c14571a<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-lg btn-primary btn-block<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Sign in<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>æˆ‘ä»¬å‘ç°ï¼Œé¦–å…ˆæœ‰ä¸€ä¸ªç”¨æˆ·åçš„è¾“å…¥æ¡†å’Œä¸€ä¸ªå¯†ç çš„è¾“å…¥æ¡†ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å…¶ä¸­å¡«å†™ç”¨æˆ·åå’Œå¯†ç ï¼Œä½†æ˜¯æˆ‘ä»¬å‘ç°ï¼Œé™¤äº†è¿™ä¸¤ä¸ªè¾“å…¥æ¡†ä»¥å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ª <code>input</code> æ ‡ç­¾ï¼Œå®ƒæ˜¯<strong>éšè—</strong>çš„ï¼Œå¹¶ä¸”å®ƒå­˜å‚¨äº†ä¸€ä¸²ç±»ä¼¼äº <code>Hash</code> å€¼çš„ä¸œè¥¿ï¼Œåç§°ä¸º <code>"_csrf"</code>ï¼Œå…¶å®çœ‹åå­—å°±çŸ¥é“ï¼Œè¿™ç©æ„å…«æˆéƒ½æ˜¯<strong>ä¸ºäº†é˜²æ­¢ CSRF æ”»å‡»è€Œå­˜åœ¨çš„</strong>ã€‚</p> 
<ul><li>ä» Spring Security 4.0 å¼€å§‹ï¼Œ<strong>é»˜è®¤æƒ…å†µä¸‹ä¼šå¯ç”¨ CSRF ä¿æŠ¤</strong>ï¼Œä»¥é˜²æ­¢ CSRF æ”»å‡»åº”ç”¨ç¨‹åºï¼ŒSpring Security CSRF ä¼šé’ˆå¯¹ PATCHï¼ŒPOSTï¼ŒPUT å’Œ DELETE æ–¹æ³•çš„è¯·æ±‚<font color="#999AAA">ï¼ˆä¸ä»…ä»…åªæ˜¯ç™»å½•è¯·æ±‚ï¼Œè¿™é‡ŒæŒ‡çš„æ˜¯ä»»ä½•è¯·æ±‚è·¯å¾„ï¼‰</font>è¿›è¡Œé˜²æŠ¤ã€‚</li><li>è€Œè¿™é‡Œçš„ç™»å½•è¡¨å•æ­£å¥½æ˜¯ä¸€ä¸ª <code>POST</code> ç±»å‹çš„è¯·æ±‚ã€‚<strong>åœ¨é»˜è®¤é…ç½®ä¸‹</strong>ï¼Œæ— è®ºæ˜¯å¦ç™»å½•ï¼Œé¡µé¢ä¸­åªè¦å‘èµ·äº† PATCHï¼ŒPOSTï¼ŒPUT å’Œ DELETE è¯·æ±‚ <strong>ä¸€å®šä¼šè¢«æ‹’ç»ï¼Œå¹¶è¿”å› 403 é”™è¯¯</strong> <font color="red">(æ³¨æ„ï¼Œè¿™é‡Œæ˜¯ä¸ªç©¶æå¤§å‘)</font></li><li><strong>æ–¹æ¡ˆä¸€</strong>ï¼šæˆ‘ä»¬å¯ä»¥åœ¨é…ç½®ç±»ä¸­åŠ å…¥ <code>http.csrf().disable(); // å…³é—­csrfåŠŸèƒ½</code>ï¼Œæˆ‘ä»¬é‡‡å–æ­¤æ–¹æ¡ˆã€‚</li><li><strong>æ–¹æ¡ˆäºŒ</strong>ï¼šéœ€è¦åœ¨è¯·æ±‚çš„æ—¶å€™åŠ å…¥ <code>csrfToken</code> æ‰è¡Œï¼Œä¹Ÿå°±æ˜¯<code>"83421936-b84b-44e3-be47-58bb2c14571a"</code>ã€‚å¦‚æœæäº¤çš„æ˜¯<strong>è¡¨å•ç±»å‹</strong>çš„æ•°æ®ï¼Œé‚£ä¹ˆè¡¨å•ä¸­å¿…é¡»åŒ…å«æ­¤ Token å­—ç¬¦ä¸²ï¼Œé”®åç§°ä¸º <code>"_csrf"</code>ï¼›å¦‚æœæ˜¯ <strong>JSON æ•°æ®æ ¼å¼</strong>å‘é€çš„ï¼Œé‚£ä¹ˆå°±éœ€è¦åœ¨è¯·æ±‚å¤´ä¸­åŒ…å«æ­¤ Token å­—ç¬¦ä¸²ã€‚</li></ul> 
<p>ç»¼ä¸Šæ‰€è¿°ï¼Œæˆ‘ä»¬æœ€åæäº¤çš„ç™»å½•è¡¨å•ï¼Œé™¤äº†å¿…é¡»çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œè¿˜åŒ…å«äº†ä¸€ä¸ª <code>csrfToken</code> å­—ç¬¦ä¸²ç”¨äºéªŒè¯ï¼Œé˜²æ­¢æ”»å‡»ã€‚</p> 
<p><a href="#mulu" rel="nofollow">å›åˆ°ç›®å½•â€¦</a></p> 
<h4><a id="_270"></a>ğŸ’¥â‘¡è‡ªå®šä¹‰ç™»å½•ç•Œé¢</h4> 
<p>a. å…ˆå†™ä¸€ä¸ªç™»å½•é¡µé¢ï¼š<code>index.html</code></p> 
<pre><code class="prism language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>ç™»å½•<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>ç”¨æˆ·ç™»å½•<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/doLogin<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        ç”¨æˆ·å: <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>
        å¯†ç : <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>checkbox<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>remember<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span> è®°ä½æˆ‘<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span><span class="token punctuation">&gt;</span></span>ç™»å½•<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>b. ç¼–å†™ <code>LoginController</code> ç™»å½•ç›¸å…³çš„æ¥å£ï¼š</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginController</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/success"</span><span class="token punctuation">)</span> <span class="token comment">// ç™»å½•æˆåŠŸåè·³è½¬çš„é¡µé¢</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">loginSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"redirect:/user/1"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/failure"</span><span class="token punctuation">)</span> <span class="token comment">// ç™»å½•å¤±è´¥åè·³è½¬çš„é¡µé¢</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">loginFailure</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"redirect:/index.html"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>c. åœ¨é…ç½®ç±»ä¸­è®¾ç½®ï¼š</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// .............................</span>
    http<span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    http
            <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token string">"/index.html"</span><span class="token punctuation">)</span>  <span class="token comment">// å½“ç”¨æˆ·æœªç™»å½•æ—¶ï¼Œè·³è½¬åˆ°è¯¥è‡ªå®šä¹‰ç™»å½•é¡µé¢</span>
            <span class="token punctuation">.</span><span class="token function">loginProcessingUrl</span><span class="token punctuation">(</span><span class="token string">"/doLogin"</span><span class="token punctuation">)</span> <span class="token comment">// formè¡¨å•æäº¤åœ°å€ï¼ˆPOSTï¼‰,ä¸éœ€è¦åœ¨æ§åˆ¶å±‚å†™ /doLogin</span>
            <span class="token punctuation">.</span><span class="token function">defaultSuccessUrl</span><span class="token punctuation">(</span><span class="token string">"/success"</span><span class="token punctuation">)</span>  <span class="token comment">// ç™»å½•æˆåŠŸåçš„é¡µé¢</span>
            <span class="token punctuation">.</span><span class="token function">failureUrl</span><span class="token punctuation">(</span><span class="token string">"/failure"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç™»å½•å¤±è´¥åçš„é¡µé¢</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>é‡å¯æœåŠ¡å™¨å°±å¯ä»¥å‘ç°ï¼Œä½¿ç”¨äº†æˆ‘ä»¬çš„è‡ªå®šä¹‰ç™»å½•é¡µé¢ï¼š<br> <img src="https://images2.imgbox.com/18/f2/q0TT2OGJ_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<h4><a id="_325"></a>ğŸ’¥æ³¨é”€</h4> 
<p>æ³¨é”€æ¥å£ï¼š<code>http://localhost:8080/logout</code> ï¼ŒåŒæ ·å¯ä»¥è‡ªå®šä¹‰æ³¨é”€é¡µé¢ï¼Œè¿™é‡Œå°±ä¸åšæ¼”ç¤ºäº†ã€‚</p> 
<pre><code class="prism language-java">http<span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">logoutSuccessUrl</span><span class="token punctuation">(</span><span class="token string">"/index.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><a href="#mulu" rel="nofollow">å›åˆ°ç›®å½•â€¦</a></p> 
<h3><a id="34_SecurityContext_332"></a>3.4 SecurityContext</h3> 
<p><strong>ç”¨æˆ·ç™»å½•ä¹‹åï¼Œæ€ä¹ˆè·å–å½“å‰å·²ç»ç™»å½•ç”¨æˆ·çš„ä¿¡æ¯å‘¢ï¼Ÿ</strong></p> 
<p><strong>æ–¹æ³•ä¸€</strong>ï¼šé€šè¿‡ä½¿ç”¨ <code>SecurityContextHolder</code> å°±å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å¾—åˆ° <code>SecurityContext</code> å¯¹è±¡äº†ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ SecurityContext å¯¹è±¡æ¥è·å–å½“å‰çš„è®¤è¯ä¿¡æ¯ï¼š</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/index"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">SecurityContext</span> context <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Authentication</span> authentication <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// org.springframework.security.core.userdetails.User</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">)</span> authentication<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">"index"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>æ–¹æ³•äºŒ</strong>ï¼šé™¤äº†è¿™ç§æ–¹å¼ä»¥å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ç›´æ¥é€šè¿‡ <code>@SessionAttribute</code> ä» Session ä¸­è·å–ï¼š</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/index"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token annotation punctuation">@SessionAttribute</span><span class="token punctuation">(</span><span class="token string">"SPRING_SECURITY_CONTEXT"</span><span class="token punctuation">)</span> <span class="token class-name">SecurityContext</span> context<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Authentication</span> authentication <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">)</span> authentication<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">"index"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<hr> 
<p><font color="orang"><strong>æ³¨æ„</strong>ï¼šSecurityContextHolder é»˜è®¤çš„å­˜å‚¨ç­–ç•¥æ˜¯ <code>MODE_THREADLOCAL</code>ï¼Œå®ƒæ˜¯åŸºäº ThreadLocal å®ç°çš„ï¼Œ<code>getContext()</code> æ–¹æ³•æœ¬è´¨ä¸Šè°ƒç”¨çš„æ˜¯å¯¹åº”çš„å­˜å‚¨ç­–ç•¥å®ç°çš„æ–¹æ³•ã€‚å¦‚æœæˆ‘ä»¬è¿™æ ·ç¼–å†™ï¼Œé‚£ä¹ˆåœ¨é»˜è®¤æƒ…å†µä¸‹æ˜¯æ— æ³•è·å–åˆ°è®¤è¯ä¿¡æ¯çš„ï¼š</font></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/index"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>   <span class="token comment">//åˆ›å»ºä¸€ä¸ªå­çº¿ç¨‹å»è·å–</span>
        <span class="token class-name">SecurityContext</span> context <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Authentication</span> authentication <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">)</span> authentication<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// å¤±è´¥ï¼Œæ— æ³•è·å–è®¤è¯ä¿¡æ¯</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">"index"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>SecurityContextHolderStrategy æœ‰ä¸‰ä¸ªå®ç°ç±»ï¼š</p> 
<ul><li>GlobalSecurityContextHolderStrategyï¼šå…¨å±€æ¨¡å¼ï¼Œä¸å¸¸ç”¨</li><li>ThreadLocalSecurityContextHolderStrategyï¼šåŸºäºThreadLocalå®ç°ï¼Œçº¿ç¨‹å†…å¯è§</li><li>InheritableThreadLocalSecurityContextHolderStrategyï¼šåŸºäºInheritableThreadLocalå®ç°ï¼Œçº¿ç¨‹å’Œå­çº¿ç¨‹å¯è§</li></ul> 
<p>å› æ­¤ï¼Œå¦‚æœä¸Šè¿°æƒ…å†µéœ€è¦åœ¨å­çº¿ç¨‹ä¸­è·å–ï¼Œé‚£ä¹ˆéœ€è¦ä¿®æ”¹ SecurityContextHolder çš„å­˜å‚¨ç­–ç•¥ï¼Œåœ¨åˆå§‹åŒ–çš„æ—¶å€™è®¾ç½®ï¼š</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@PostConstruct</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">setStrategyName</span><span class="token punctuation">(</span><span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span>MODE_INHERITABLETHREADLOCAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>è¿™æ ·åœ¨å­çº¿ç¨‹ä¸­ä¹Ÿå¯ä»¥è·å–è®¤è¯ä¿¡æ¯äº†ã€‚</p> 
<hr> 
<p>å› ä¸ºç”¨æˆ·çš„éªŒè¯ä¿¡æ¯æ˜¯åŸºäº SecurityContext è¿›è¡Œåˆ¤æ–­çš„ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä¿®æ”¹ SecurityContext çš„å†…å®¹ï¼Œæ¥<strong>æ‰‹åŠ¨ä¸ºç”¨æˆ·è¿›è¡Œç™»å½•ï¼š</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/auth"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	<span class="token comment">// è·å–SecurityContextå¯¹è±¡ï¼ˆå½“å‰ä¼šè¯è‚¯å®šæ˜¯æ²¡æœ‰ç™»é™†çš„ï¼‰</span>
    <span class="token class-name">SecurityContext</span> context <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªUsernamePasswordAuthenticationTokenå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·çš„è®¤è¯ä¿¡æ¯ï¼Œè§’è‰²éœ€è¦æ·»åŠ ROLE_å‰ç¼€ï¼Œæƒé™ç›´æ¥å†™</span>
    <span class="token class-name">UsernamePasswordAuthenticationToken</span> token <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span><span class="token string">"Test"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
            <span class="token class-name">AuthorityUtils</span><span class="token punctuation">.</span><span class="token function">commaSeparatedStringToAuthorityList</span><span class="token punctuation">(</span><span class="token string">"ROLE_user"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    		context<span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// æ‰‹åŠ¨ä¸ºSecurityContextè®¾å®šè®¤è¯ä¿¡æ¯</span>
    <span class="token keyword">return</span> <span class="token string">"Login successï¼"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>åœ¨æœªç™»å½•çš„æƒ…å†µä¸‹ï¼Œè®¿é—®æ­¤åœ°å€å°†ç›´æ¥è¿›è¡Œæ‰‹åŠ¨ç™»å½•ï¼Œå†æ¬¡è®¿é—® <code>/index</code> é¡µé¢ï¼Œå¯ä»¥ç›´æ¥è®¿é—®ï¼Œè¯´æ˜æ‰‹åŠ¨è®¾ç½®è®¤è¯ä¿¡æ¯æˆåŠŸã€‚</p> 
<p><strong>ç–‘æƒ‘</strong>ï¼šSecurityContext è¿™ç©æ„ä¸æ˜¯é»˜è®¤çº¿ç¨‹ç‹¬å å—ï¼Œé‚£æ¯æ¬¡è¯·æ±‚éƒ½æ˜¯ä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼ŒæŒ‰ç†è¯´ä¸Šä¸€æ¬¡çš„ SecurityContext å¯¹è±¡åº”è¯¥æ²¡äº†æ‰å¯¹å•Šï¼Œä¸ºä»€ä¹ˆå†æ¬¡è¯·æ±‚ä¾ç„¶èƒ½å¤Ÿç»§ç»­ä½¿ç”¨ä¸Šä¸€æ¬¡ SecurityContext ä¸­çš„è®¤è¯ä¿¡æ¯å‘¢ï¼Ÿ</p> 
<p><strong>SecurityContext çš„ç”Ÿå‘½å‘¨æœŸ</strong>ï¼šè¯·æ±‚åˆ°æ¥æ—¶ä» Session ä¸­å–å‡ºï¼Œæ”¾å…¥ SecurityContextHolder ä¸­ï¼Œè¯·æ±‚ç»“æŸæ—¶ä» SecurityContextHolder å–å‡ºï¼Œå¹¶æ”¾åˆ° Session ä¸­ï¼Œå®é™…ä¸Šå°±æ˜¯ä¾é  Session æ¥å­˜å‚¨çš„ï¼Œä¸€æ—¦ä¼šè¯è¿‡æœŸéªŒè¯ä¿¡æ¯ä¹Ÿè·Ÿç€æ¶ˆå¤±ã€‚</p> 
<p><a href="#mulu" rel="nofollow">å›åˆ°ç›®å½•â€¦</a></p> 
<hr> 
<p><strong>æ€»ç»“</strong>:<br> <font color="#999AAA">æç¤ºï¼šè¿™é‡Œå¯¹æ–‡ç« è¿›è¡Œæ€»ç»“ï¼š<br> æœ¬æ–‡æ˜¯å¯¹SpringSecurityçš„å­¦ä¹ ï¼Œå­¦ä¹ äº†å®ƒçš„ä¸¤å¤§åŠŸèƒ½ï¼šè®¤è¯å’Œæˆæƒï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨æ•°æ®åº“è¿›è¡Œè®¤è¯ï¼Œå¦‚ä½•ä½¿ç”¨è‡ªå®šä¹‰çš„ç™»å½•é¡µé¢ï¼Œæœ€åä¹Ÿå­¦ä¹ äº†ä½¿ç”¨SecurityContextè·å–è®¤è¯ç”¨æˆ·çš„ä¿¡æ¯ã€‚ä¹‹åçš„å­¦ä¹ å†…å®¹å°†æŒç»­æ›´æ–°ï¼ï¼ï¼</font></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/34e5b66357b40b31c55da9bd03cdabb9/" rel="prev">
			<span class="pager__subtitle">Â«&thinsp;Previous</span>
			<p class="pager__title">æ–‡çŒ®é˜…è¯»ï¼ˆ11ï¼‰ï¼šåŒæ­¥æ•°æ®æµSDF</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ded94d681f800c4615dd3e3b6f941abd/" rel="next">
			<span class="pager__subtitle">Next&thinsp;Â»</span>
			<p class="pager__title">C&#43;&#43; å­¦ä¹ ç¬”è®° 4 â€” é«˜çº§ä¸»é¢˜</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 èœé¸Ÿç¨‹åºå‘˜åšå®¢.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>