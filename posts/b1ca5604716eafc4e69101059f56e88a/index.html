<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>k8s1.26安装（kubeadm containerd） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="k8s1.26安装（kubeadm containerd）" />
<meta property="og:description" content="环境背景： k8s-1、k8s-2、k8s3三台主机,1台master节点 ，2台node节点
准备环境 修改主机名(3台分别修改主机名) hostnamectl set-hostname k8s-1 hostnamectl set-hostname k8s-2 hostnamectl set-hostname k8s-3 防火墙关闭 systemctl stop firewalld systemctl disable firewalld 关闭selinux setenforce 0 # 临时关闭 sed -i &#39;s/SELINUX=enforcing/SELINUX=disabled/g&#39; /etc/selinux/config # 永久关闭 关闭swap swapoff -a # 临时关闭；关闭swap主要是为了性能考虑 sed -ri &#39;s/.*swap.*/#&amp;/&#39; /etc/fstab free # 可以通过这个命令查看swap是否关闭了
添加主机名与IP对应的关系 vim /etc/hosts
192.168.2.250 k8s-1 192.168.2.251 k8s-2 192.168.2.251 k8s-3 时间同步 timedatectl set-timezone Asia/Shanghai yum install ntpdate -y ntpdate time.windows.com 将桥接的IPv4流量传递到iptables的链 cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOF net." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/b1ca5604716eafc4e69101059f56e88a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-19T11:04:50+08:00" />
<meta property="article:modified_time" content="2023-04-19T11:04:50+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">k8s1.26安装（kubeadm containerd）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"></p> 
<h3 id="%E7%8E%AF%E5%A2%83%E8%83%8C%E6%99%AF%EF%BC%9A">环境背景：</h3> 
<p>k8s-1、k8s-2、k8s3三台主机,1台master节点 ，2台node节点</p> 
<h3 id="%E5%87%86%E5%A4%87%E7%8E%AF%E5%A2%83">准备环境</h3> 
<h4 id="%E4%BF%AE%E6%94%B9%E4%B8%BB%E6%9C%BA%E5%90%8D">修改主机名(3台分别修改主机名)</h4> 
<pre>hostnamectl set-hostname k8s-1
hostnamectl set-hostname k8s-2
hostnamectl set-hostname k8s-3
</pre> 
<h4 id="%E9%98%B2%E7%81%AB%E5%A2%99%E5%85%B3%E9%97%AD">防火墙关闭</h4> 
<pre>systemctl stop firewalld
systemctl disable firewalld</pre> 
<h4>关闭selinux</h4> 
<pre>setenforce 0 # 临时关闭
sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config # 永久关闭</pre> 
<h4>关闭swap</h4> 
<pre>swapoff -a # 临时关闭；关闭swap主要是为了性能考虑
sed -ri 's/.*swap.*/#&amp;/' /etc/fstab</pre> 
<p><code>free # 可以通过这个命令查看swap是否关闭了</code></p> 
<h4>添加主机名与IP对应的关系</h4> 
<p><code>vim /etc/hosts</code></p> 
<pre>192.168.2.250 k8s-1
192.168.2.251 k8s-2
192.168.2.251 k8s-3
</pre> 
<h4>时间同步</h4> 
<pre>timedatectl set-timezone Asia/Shanghai
yum install ntpdate -y
ntpdate time.windows.com</pre> 
<h4>将桥接的IPv4流量传递到iptables的链</h4> 
<pre><code class="language-bash">cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOF
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF</code></pre> 
<pre>sysctl --systm</pre> 
<h4>安装Contained</h4> 
<p>1、Contained、runc下载</p> 
<pre><code class="language-bash">wget https://github.com/containerd/containerd/releases/download/v1.7.0/cri-containerd-cni-1.7.0-linux-amd64.tar.gz

tar xvf cri-containerd-cni-1.7.0-linux-amd64.tar.gz -C /

wget https://github.com/opencontainers/runc/releases/download/v1.1.5/runc.amd64
scp runc.amd64 192.168.2.251:/usr/local/sbin/runc
scp runc.amd64 192.168.2.252:/usr/local/sbin/runc

mkdir -p /etc/containerd
containerd config default &gt; /etc/containerd/config.toml</code></pre> 
<p>    修改前面生成的配置文件/etc/containerd/config.toml：   </p> 
<pre><code class="language-bash"> [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
          ...
          [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options]
            SystemdCgroup = true</code></pre> 
<p><br>         再修改/etc/containerd/config.toml中的</p> 
<pre><code class="language-bash">        [plugins."io.containerd.grpc.v1.cri"]
          ...
          # sandbox_image = "k8s.gcr.io/pause:3.6"
          sandbox_image = "registry.aliyuncs.com/google_containers/pause:3.9"</code></pre> 
<p><br>     配置containerd开机启动，并启动containerd</p> 
<p>    </p> 
<pre><code class="language-bash">systemctl enable containerd --now</code></pre> 
<p><br>     使用crictl测试一下，确保可以打印出版本信息并且没有错误信息输出:</p> 
<pre><code class="language-bash">    crictl version

    Version:  0.1.0
    RuntimeName:  containerd
    RuntimeVersion:  v1.7.0
    RuntimeApiVersion:  v1</code></pre> 
<h4>安装kubeadm、kubelet、kubectl</h4> 
<p>配置kubernetes的yum源</p> 
<pre><code class="language-bash">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=1
repo_gpgcheck=0
gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
        http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF</code></pre> 
<p>[root@k8s-1 ~]# yum install -y kubeadm kubelet kubectl</p> 
<p>[root@k8s-1 ~]# kubeadm config print init-defaults --component-configs KubeletConfiguration &gt; init.yaml</p> 
<p>[root@k8s-1 ~]# cat init.yaml <br>  </p> 
<pre><code class="language-bash">apiVersion: kubeadm.k8s.io/v1beta3
bootstrapTokens:
- groups:
  - system:bootstrappers:kubeadm:default-node-token
  token: abcdef.0123456789abcdef
  ttl: 24h0m0s
  usages:
  - signing
  - authentication
kind: InitConfiguration
localAPIEndpoint:
  advertiseAddress: 192.168.2.250  #master节点IP地址
  bindPort: 6443
nodeRegistration:
  criSocket: unix:///var/run/containerd/containerd.sock   #containerd sock文件位置
  imagePullPolicy: IfNotPresent
  name: k8s-1             #master节点主机名
  taints: null
---
apiServer:
  timeoutForControlPlane: 4m0s
apiVersion: kubeadm.k8s.io/v1beta3
certificatesDir: /etc/kubernetes/pki
clusterName: kubernetes
controllerManager: {}
dns: {}
etcd:
  local:
    dataDir: /var/lib/etcd
imageRepository: registry.aliyuncs.com/google_containers
kind: ClusterConfiguration
kubernetesVersion: 1.26.3
networking:
  dnsDomain: cluster.local
  serviceSubnet: 10.96.0.0/12   #配置service地址网段
  podSubnet: 10.244.0.0/16      #配置pod地址网段
scheduler: {}
---
apiVersion: kubelet.config.k8s.io/v1beta1
authentication:
  anonymous:
    enabled: false
  webhook:
    cacheTTL: 0s
    enabled: true
  x509:
    clientCAFile: /etc/kubernetes/pki/ca.crt
authorization:
  mode: Webhook
  webhook:
    cacheAuthorizedTTL: 0s
    cacheUnauthorizedTTL: 0s
cgroupDriver: systemd
clusterDNS:
- 10.96.0.10
clusterDomain: cluster.local            #配置域名
cpuManagerReconcilePeriod: 0s
evictionPressureTransitionPeriod: 0s
fileCheckFrequency: 0s
healthzBindAddress: 127.0.0.1
healthzPort: 10248
httpCheckFrequency: 0s
imageMinimumGCAge: 0s
kind: KubeletConfiguration
logging:
  flushFrequency: 0
  options:
    json:
      infoBufferSize: "0"
  verbosity: 0
memorySwap: {}
nodeStatusReportFrequency: 0s
nodeStatusUpdateFrequency: 0s
rotateCertificates: true
runtimeRequestTimeout: 0s
shutdownGracePeriod: 0s
shutdownGracePeriodCriticalPods: 0s
staticPodPath: /etc/kubernetes/manifests
streamingConnectionIdleTimeout: 0s
syncFrequency: 0s
volumeStatsAggPeriod: 0s</code></pre> 
<h4>正安装kubernetes</h4> 
<p>kubeadm init --config init.yaml</p> 
<p><br> 修改ipvs</p> 
<pre><code class="language-bash">yum -y install ipvsadm ipset
cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt; EOF
#!/bin/bash
modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack_ipv4
EOF
 
chmod 755 /etc/sysconfig/modules/ipvs.modules
source /etc/sysconfig/modules/ipvs.modules


kubectl edit -n kube-system cm kube-proxy
将mode: " "修改为mode: “ipvs”，:wq保存退出

重启kube-proxy pod 后生效
kubectl get pod -n kube-system |grep kube-proxy |awk '{system("kubectl delete pod "$1" -n kube-system")}'</code></pre> 
<h4>calico网络插件安装<br>  </h4> 
<pre><code class="language-bash">wget https://docs.projectcalico.org/v3.25/manifests/calico.yaml --no-check-certificate
kubectl apply -f  calico.yaml 


kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.7.0/deploy/static/provider/cloud/deploy.yaml</code></pre> 
<h3>metrics-server安装</h3> 
<pre><code class="language-bash">wget https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml

- --kubelet-insecure-tls

 image: registry.cn-hangzhou.aliyuncs.com/google_containers/metrics-server:v0.6.2</code></pre> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/86cd1ee746afe1d6d2ea1d4141cb8b8c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">基于DeepSpeed训练ChatGPT</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f9dbcfbb67a4f384fa2abea414fc9392/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">EF（EFCore）性能优化与高级用法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>