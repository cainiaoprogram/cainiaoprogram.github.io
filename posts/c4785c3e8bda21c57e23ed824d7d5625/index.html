<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>PTA是什么？BT-WIFI共存 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="PTA是什么？BT-WIFI共存" />
<meta property="og:description" content="参考自：《PTA是什么？BT-WIFI共存》
《WiFi 与BT 共存机制》
在2.4G频段，WIFI和BT共用天线，两者之间是如何控制？是否无法同时用WIFI和BT？
蓝牙和WIFI共存设计
蓝牙和802.11b/g/n都可能工作在2.4GISM，可能互相干扰。干扰的典型应用之一是VOIP，用手机的WLAN打VOIP电话，用蓝牙耳机来通话。互相干扰的后果是用户能感觉到通话质量的下降。
设计上有些方法能够减少相互干扰，尽量维持蓝牙和wifi的throughput（吞吐量），使得用户的使用体验不受影响。方法主要是AFH和分时。
是否存在相互干扰和相互干扰是否严重受以下条件影响：
1．共用天线还是单独用自己天线2．干扰是噪音还是阻塞3．蓝牙通信频率是否落在wifi带内4．蓝牙和wifi是接收还是发射5．蓝牙和wifi的具体应用的通信特点 1. 共用天线还是单独用自己天线
如果蓝牙和wifi使用单独的天线，蓝牙天线和wifi天线之间的隔离大小会影响干扰的程度。如果认为有一定的隔离度，蓝牙和wifi是可以同时发射或者接收的。
如果蓝牙和wifi共用天线，蓝牙和wifi不可以同时工作。（如果不考虑相互干扰，可以同时接收。）
2. 干扰是噪音还是阻塞
干扰分为两种。一种是噪音，主要发生在频率冲突时；另一种是大信号阻塞，和频率是否冲突没有关系，和具体射频设计及天线间隔离有关系。
3. 蓝牙通信频率是否落在wifi带内
如果蓝牙通信频率落在wifi频带内，噪音干扰和阻塞干扰都会有。如果蓝牙通信频率落在wifi频带外，只有阻塞干扰。
AFH是针对噪音干扰最好的方法，蓝牙和wifi的性能都能维持100％。唯一问题是无法解决阻塞干扰。
4. 蓝牙和wifi是接收还是发射
假设蓝牙和wifi使用自己单独的天线，蓝牙和wifi是能够同时发射和同时接收的。如果一个发射，一个接收，在频率冲突时会有相互干扰。另外，同时发射可能会对另一侧设备带来干扰。
5. 蓝牙和wifi的具体应用的通信特点
共存时相互干扰是否严重还和具体应用时通信特点有关。比如数据量是否大，是否是数据流，是否是timecritical的。所以有的设计是host可以根据不同应用配置不同的优先级，以达到最好的tradeoff。
主要设计方法简单介绍：
AFH
AFH：auto freq. hopping自适应调频机制，当蓝牙设备发现在某些信道上有较强干扰时，会自动跳到其他干扰小的信道。现在的蓝牙一般都具备此项功能。
AFH是解决噪音干扰的最好方法。通过在跳频频率中避开wifi的频带，既可以避免频率冲突带来的干扰，也丝毫不损失蓝牙和wifi的性能。另外，AFH不只针对wifi干扰，道理上其它干扰源也可以避开。
AFH功能包括两个方面，一是channel的好坏区分；二是使用新的channellist跳频。
Channel的好坏区分有三种来源，一是自己通过scanRSSI或者检查PER等方式自己区分channel；二是通过另侧设备的区分信息，如master取slave的区分结果，或slave依照master的区分结果；三是依靠host通过HCI命令set_AFH_host_channel_classification传下来。
蓝牙和wifi共存设计中，host通过HCI命令告诉蓝牙哪些channel不可用是很有效的。如果蓝牙自己区分，应该既自己检查channel，也需要读另侧设备的区分信息，因为两者如果距离稍远，可能看见的badchannel是不同的。
分时（TDM，PTA）
分时是利用蓝牙和wifi间的握手信号，使蓝牙和wifi分时在2.4G工作，这样可以避免噪音干扰和阻塞干扰。问题是会降低蓝牙和wifi的throughput。所以这个机制应该只在AFH不能提供良好效果时使用。
802.15.2中有规定仲裁方式和信号（PTA，packet traffic arbitration）的框架，很多蓝牙芯片厂商也有自己专有的握手信号定义。道理上来讲我们的设计还需要了解主流wifi芯片的握手信号定义。
这些握手信号都差不多。简单说明如下：
2－wire
Wifi给蓝牙信号wl_active，表示wifi有通信，如果这个信号asserted，蓝牙应该只接收/发射highpriority的包，其它包delay。
蓝牙给wifi信号bt_priority，表示蓝牙要发highpriority的包，wifi必须停止当前通信。
可以看出，这两根信号分别是保护wifi和蓝牙通信的。所以assert的多与少会影响2.4G带宽在两者间的分配。
从蓝牙芯片设计的角度，蓝牙芯片必须支持对于包优先级的区分和delay包的处理。一般来说，定时同步，inquiry，page，SCO等是高优先级，传送数据的包则是普通优先级。如果处理得细致和灵活，很多参数是需要可以配置和可调的，因为可能需要host根据具体应用来配置。
如果蓝牙芯片知道wifi的频带，bt_priority也可以只在频率冲突时拉起。
3－wire
三线方案和两线方案相似。多加一根蓝牙输出的bt_active，这样和bt_priority一起可以表示两种优先级的蓝牙通信。
4－wire
四线方案和三线方案相似，再多加一根蓝牙输出的bt_freq，指示蓝牙通信是否和wifi频带冲突。
PTA
PTA：package traffic arbitration数据传输仲裁（或 数据包流量仲裁），通常有1wire，2wire，3wire等制式。当wifi和BT同时工作时，BT和Wifi通过PTA了解彼此的工作状态，频率等信息，来防止频率等的冲突带来的互扰。比如，Wifi占用了ISM（Industrial Scientific Medical）频段前20M频带，蓝牙可调频到其他频段工作；当蓝牙通话时，为保证通话不断线，可能又会调整wifi的工作状态。各家的PTA算法不尽相同。
802.15.2中没有规定PTA具体的硬件接口和仲裁判定，是依赖实现的。也有类似上述的2/3/4线方案。但PTA的基本思想是蓝牙和wifi提交申请给PTAcontroller，（一般PTAcontroller集成在wifi中），由PTAcontroller来许可。所以PTA中的相关信号都是指将要的操作，不同于上面的是指已经发生的操作。
下文介绍数据包流量仲裁 (Packet Traffic Arbitration，PTA)
.
数据包流量仲裁使用仲裁器来决定 WLAN 或蓝牙是否使用射频RF。如果蓝牙需要使用RF，它会请求仲裁服务器进行访问，仲裁者做出决定。性能取决于仲裁服务器的实现方式以及从蓝牙和 Wi-Fi 设备可获得多少信息。IEEE 802." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/c4785c3e8bda21c57e23ed824d7d5625/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-08T13:39:55+08:00" />
<meta property="article:modified_time" content="2024-01-08T13:39:55+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">PTA是什么？BT-WIFI共存</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>参考自：<a href="https://www.cnblogs.com/yakin/archive/2010/01/25/1656138.html" rel="nofollow">《PTA是什么？BT-WIFI共存》</a><br> 　　　　<a href="https://zhuanlan.zhihu.com/p/552868176" rel="nofollow">《WiFi 与BT 共存机制》</a></p> 
<p>在2.4G频段，WIFI和BT共用天线，两者之间是如何控制？是否无法同时用WIFI和BT？</p> 
<p><strong>蓝牙和WIFI共存设计</strong></p> 
<p>蓝牙和802.11b/g/n都可能工作在2.4GISM，可能互相干扰。干扰的典型应用之一是VOIP，用手机的WLAN打VOIP电话，用蓝牙耳机来通话。互相干扰的后果是用户能感觉到通话质量的下降。</p> 
<p>设计上有些方法能够减少相互干扰，尽量维持蓝牙和wifi的throughput（吞吐量），使得用户的使用体验不受影响。方法主要是AFH和分时。</p> 
<p><strong>是否存在相互干扰和相互干扰是否严重受以下条件影响：</strong></p> 
<ul><li>1．共用天线还是单独用自己天线</li><li>2．干扰是噪音还是阻塞</li><li>3．蓝牙通信频率是否落在wifi带内</li><li>4．蓝牙和wifi是接收还是发射</li><li>5．蓝牙和wifi的具体应用的通信特点</li></ul> 
<p><strong>1. 共用天线还是单独用自己天线</strong></p> 
<p>如果蓝牙和wifi使用单独的天线，蓝牙天线和wifi天线之间的隔离大小会影响干扰的程度。如果认为有一定的隔离度，蓝牙和wifi是可以同时发射或者接收的。<br> 如果蓝牙和wifi共用天线，蓝牙和wifi不可以同时工作。（如果不考虑相互干扰，可以同时接收。）</p> 
<p><strong>2. 干扰是噪音还是阻塞</strong></p> 
<p>干扰分为两种。一种是噪音，主要发生在频率冲突时；另一种是大信号阻塞，和频率是否冲突没有关系，和具体射频设计及天线间隔离有关系。</p> 
<p><strong>3. 蓝牙通信频率是否落在wifi带内</strong></p> 
<p>如果蓝牙通信频率落在wifi频带内，噪音干扰和阻塞干扰都会有。如果蓝牙通信频率落在wifi频带外，只有阻塞干扰。<br> AFH是针对噪音干扰最好的方法，蓝牙和wifi的性能都能维持100％。唯一问题是无法解决阻塞干扰。</p> 
<p><strong>4. 蓝牙和wifi是接收还是发射</strong></p> 
<p>假设蓝牙和wifi使用自己单独的天线，蓝牙和wifi是能够同时发射和同时接收的。如果一个发射，一个接收，在频率冲突时会有相互干扰。另外，同时发射可能会对另一侧设备带来干扰。</p> 
<p><strong>5. 蓝牙和wifi的具体应用的通信特点</strong></p> 
<p>共存时相互干扰是否严重还和具体应用时通信特点有关。比如数据量是否大，是否是数据流，是否是timecritical的。所以有的设计是host可以根据不同应用配置不同的优先级，以达到最好的tradeoff。<br> 　　<br> <strong>主要设计方法简单介绍：</strong></p> 
<p><strong>AFH</strong></p> 
<p><strong><code>AFH：auto freq. hopping自适应调频机制</code></strong>，当蓝牙设备发现在某些信道上有较强干扰时，会自动跳到其他干扰小的信道。现在的蓝牙一般都具备此项功能。</p> 
<p>AFH是解决噪音干扰的最好方法。通过在跳频频率中避开wifi的频带，既可以避免频率冲突带来的干扰，也丝毫不损失蓝牙和wifi的性能。另外，AFH不只针对wifi干扰，道理上其它干扰源也可以避开。</p> 
<p>AFH功能包括两个方面，一是channel的好坏区分；二是使用新的channellist跳频。</p> 
<p>Channel的好坏区分有三种来源，一是自己通过scanRSSI或者检查PER等方式自己区分channel；二是通过另侧设备的区分信息，如master取slave的区分结果，或slave依照master的区分结果；三是依靠host通过HCI命令set_AFH_host_channel_classification传下来。</p> 
<p>蓝牙和wifi共存设计中，host通过HCI命令告诉蓝牙哪些channel不可用是很有效的。如果蓝牙自己区分，应该既自己检查channel，也需要读另侧设备的区分信息，因为两者如果距离稍远，可能看见的badchannel是不同的。</p> 
<p><strong>分时（TDM，PTA）</strong></p> 
<p>分时是利用蓝牙和wifi间的握手信号，使蓝牙和wifi分时在2.4G工作，这样可以避免噪音干扰和阻塞干扰。问题是会降低蓝牙和wifi的throughput。所以这个机制应该只在AFH不能提供良好效果时使用。</p> 
<p>802.15.2中有规定仲裁方式和信号（PTA，packet traffic arbitration）的框架，很多蓝牙芯片厂商也有自己专有的握手信号定义。道理上来讲我们的设计还需要了解主流wifi芯片的握手信号定义。<br> 这些握手信号都差不多。简单说明如下：</p> 
<p><strong>2－wire</strong></p> 
<p>Wifi给蓝牙信号wl_active，表示wifi有通信，如果这个信号asserted，蓝牙应该只接收/发射highpriority的包，其它包delay。<br> 蓝牙给wifi信号bt_priority，表示蓝牙要发highpriority的包，wifi必须停止当前通信。<br> 可以看出，这两根信号分别是保护wifi和蓝牙通信的。所以assert的多与少会影响2.4G带宽在两者间的分配。<br> 从蓝牙芯片设计的角度，蓝牙芯片必须支持对于包优先级的区分和delay包的处理。一般来说，定时同步，inquiry，page，SCO等是高优先级，传送数据的包则是普通优先级。如果处理得细致和灵活，很多参数是需要可以配置和可调的，因为可能需要host根据具体应用来配置。<br> 如果蓝牙芯片知道wifi的频带，bt_priority也可以只在频率冲突时拉起。</p> 
<p><strong>3－wire</strong></p> 
<p>三线方案和两线方案相似。多加一根蓝牙输出的bt_active，这样和bt_priority一起可以表示两种优先级的蓝牙通信。</p> 
<p><strong>4－wire</strong></p> 
<p>四线方案和三线方案相似，再多加一根蓝牙输出的bt_freq，指示蓝牙通信是否和wifi频带冲突。</p> 
<p><strong>PTA</strong></p> 
<p><strong><code>PTA：package traffic arbitration数据传输仲裁（或 数据包流量仲裁）</code></strong>，通常有1wire，2wire，3wire等制式。当wifi和BT同时工作时，BT和Wifi通过PTA了解彼此的工作状态，频率等信息，来防止频率等的冲突带来的互扰。比如，Wifi占用了ISM（Industrial Scientific Medical）频段前20M频带，蓝牙可调频到其他频段工作；当蓝牙通话时，为保证通话不断线，可能又会调整wifi的工作状态。各家的PTA算法不尽相同。</p> 
<p>802.15.2中没有规定PTA具体的硬件接口和仲裁判定，是依赖实现的。也有类似上述的2/3/4线方案。但PTA的基本思想是蓝牙和wifi提交申请给PTAcontroller，（一般PTAcontroller集成在wifi中），由PTAcontroller来许可。所以PTA中的相关信号都是指将要的操作，不同于上面的是指已经发生的操作。</p> 
<blockquote> 
 <p>下文介绍<strong>数据包流量仲裁 (Packet Traffic Arbitration，PTA)</strong><br> .<br> 数据包流量仲裁使用仲裁器来决定 WLAN 或蓝牙是否使用射频RF。如果蓝牙需要使用RF，它会请求仲裁服务器进行访问，仲裁者做出决定。性能取决于仲裁服务器的实现方式以及从蓝牙和 Wi-Fi 设备可获得多少信息。IEEE 802.15.2 建议采用三线式 PTA 架构，也有两线和四线。<br> .<br> <strong>三线协同共存</strong><br> .<img src="https://images2.imgbox.com/15/60/9mH48XFi_o.png" alt="在这里插入图片描述"><br> 图1三线PTA的共存机制<br> .<br> 蓝牙和Wi-Fi使用三个信号来实现共存（图1），因此得名三线共存接口。PTA 驻留在 Wi-Fi 设备内部，芯片接口上显示三个信号以连接到蓝牙设备。三个接口引脚/信号是：</p> 
 <ol><li>BT_PRIORITY_AND_STATUS</li><li>BT_ACTIVITY</li><li>WLAN_ACTIVITY</li></ol> 
 <p>.<br> 蓝牙链路管理器负责向 PTA 提供状态信息。蓝牙链路管理器驱动BT_PRIORITY_AND_STATUS信号以指示优先级和 RX/TX 插槽。蓝牙设备断言BT_ACTIVITY，以便在需要完成蓝牙事务时请求中等访问。每次蓝牙设备想要访问媒体时，它都会断言此信号。根据请求，PTA 使用WLAN_ACTIVITY信号来指示蓝牙设备是否可以继续传输。<br> .<br> BT_ACTIVITY和WLAN_ACTIVITY在每次数据包传输尝试之前进行交换（图2）。计时要求可能因设备和供应商而异。<br> .<br> <img src="https://images2.imgbox.com/2a/9f/umv75LVu_o.png" alt="在这里插入图片描述"><br> 图2 三线并存的信号时序图</p> 
</blockquote> 
<p><strong>WCS</strong></p> 
<p>WCS是intel的wireless coexistence system缩写，是intel wifi的握手定义，两根线，ch_data和ch_clk/bt_priority，完成握手和频带信号传递功能。具体时序定义没有看到，要签intel的NDA才有，估计笔记本上用得较多。</p> 
<p>只要把握分时和优先级的tradeoff原则，握手接口和分时机制还可以有很多变化和配置，以求对用户最好的使用体验。</p> 
<p>RDA5868+，RDA5870都支持蓝牙WIFI共存分时设计，在原理图连接时，连接如下:</p> 
<p>RDA5870：<br> Pin37：WL_ACTIVE<br> Pin27：BT_PRIORITY</p> 
<p>RDA5868＋：<br> Pin28：WL_ACTIVE<br> Pin27：BT_PRIORITY</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7be56a4b6907675bbe72866e41021f1b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Gstreamer常用指令</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ef0971609a8a086fc67cf7a7129477f4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">K8S--安装MySQL8（单机）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>