<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>达梦数据库搭建 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="达梦数据库搭建" />
<meta property="og:description" content="数据守护搭建
1.备份还原
1.1脱机备份，脱机还原
正常关库
脱机备份
./dmrman
BACKUP DATABASE ‘/home/dmdba/dmdbms/data/dmdb/dm.ini’ FULL TO BACKUP_FILE1 BACKUPSET ‘/home/dmdba/dmdbms/data/BACKUP_FILE_01’
拷贝备份文件到所在机器dm.ini dm.ctl
scp /home/dmdba/dmdbms/data/dmdb/dm.ini dmdba@192.168.6.67/home/dmdba/dmdbms/data/dmdb/dm.ini
脱机还原恢复
./dmrman
RESTORE DATABASE ‘/home/dmdba/dmdbms/data/dmdb/dm.ini’ FROM BACKUPSET ‘/home/dmdba/dmdbms/data/BACKUP_FILE_01’
RECOVER DATABASE ‘/home/dmdba/dmdbms/data/dmdb/dm.ini’ FROM BACKUPSET ‘/home/dmdba/dmdbms/data/BACKUP_FILE_01’
RECOVER DATABASE ‘/home/dmdba/dmdbms/data/dmdb/dm.ini’ UPDATE DB_MAGIC
1.2联机备份，脱机还原
对主库进行联机备份操作
SQL&gt;BACKUP DATABASE BACKUPSET ‘/home/dmdba/dmdbms/data/BACKUP_FILE_01’
拷贝备份文件到所在机器dm.ini dm.ctl
scp /home/dmdba/dmdbms/data/dmdb/dm.ini dmdba@192.168.6.67/home/dmdba/dmdbms/data/dmdb/dm.ini
./dmrman
BACKUP DATABASE ‘/home/dmdba/dmdbms/data/dmdb/dm.ini’ FULL TO BACKUP_FILE1 BACKUPSET ‘/home/dmdba/dmdbms/data/BACKUP_FILE_01’
拷贝备份文件到所在机器dm.ini dm.ctl
scp /home/dmdba/dmdbms/data/dmdb/dm.ini dmdba@192.168.6.67/home/dmdba/dmdbms/data/dmdb/dm.ini
恢复
./dmrman
2.环境规划
两个机器事先安装DM和实例
安装路径为/home/dmdba/dmdbms/
数据库名字为/home/dmdba/dmdbms/dmdb" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/e4bde1d0afccf1281bdd59056b98ab3f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-09-27T16:00:17+08:00" />
<meta property="article:modified_time" content="2020-09-27T16:00:17+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">达梦数据库搭建</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>数据守护搭建<br> 1.备份还原<br> 1.1脱机备份，脱机还原<br> 正常关库<br> 脱机备份<br> ./dmrman<br> BACKUP DATABASE ‘/home/dmdba/dmdbms/data/dmdb/dm.ini’ FULL TO BACKUP_FILE1 BACKUPSET ‘/home/dmdba/dmdbms/data/BACKUP_FILE_01’<br> 拷贝备份文件到所在机器dm.ini dm.ctl<br> scp /home/dmdba/dmdbms/data/dmdb/dm.ini dmdba@192.168.6.67/home/dmdba/dmdbms/data/dmdb/dm.ini<br> 脱机还原恢复<br> ./dmrman<br> RESTORE DATABASE ‘/home/dmdba/dmdbms/data/dmdb/dm.ini’ FROM BACKUPSET ‘/home/dmdba/dmdbms/data/BACKUP_FILE_01’<br> RECOVER DATABASE ‘/home/dmdba/dmdbms/data/dmdb/dm.ini’ FROM BACKUPSET ‘/home/dmdba/dmdbms/data/BACKUP_FILE_01’<br> RECOVER DATABASE ‘/home/dmdba/dmdbms/data/dmdb/dm.ini’ UPDATE DB_MAGIC</p> 
<p>1.2联机备份，脱机还原<br> 对主库进行联机备份操作<br> SQL&gt;BACKUP DATABASE BACKUPSET ‘/home/dmdba/dmdbms/data/BACKUP_FILE_01’<br> 拷贝备份文件到所在机器dm.ini dm.ctl<br> scp /home/dmdba/dmdbms/data/dmdb/dm.ini dmdba@192.168.6.67/home/dmdba/dmdbms/data/dmdb/dm.ini<br> ./dmrman<br> BACKUP DATABASE ‘/home/dmdba/dmdbms/data/dmdb/dm.ini’ FULL TO BACKUP_FILE1 BACKUPSET ‘/home/dmdba/dmdbms/data/BACKUP_FILE_01’<br> 拷贝备份文件到所在机器dm.ini dm.ctl<br> scp /home/dmdba/dmdbms/data/dmdb/dm.ini dmdba@192.168.6.67/home/dmdba/dmdbms/data/dmdb/dm.ini<br> 恢复<br> ./dmrman</p> 
<p>2.环境规划<br> 两个机器事先安装DM和实例<br> 安装路径为/home/dmdba/dmdbms/<br> 数据库名字为/home/dmdba/dmdbms/dmdb<br> 数据路径data/<br> 归档路径 /home/dmdba/dmdbms/data/dmdb/arch<br> 数据库实例名字dmdbserver1<br> 主库192.168.6.68<br> 备库192.168.6.69<br> PORT_NUM 5236 5236<br> MAL_HOST 192.168.6.68 192.168.6.69<br> MAL_INST_DW_PORT 33141 33142<br> MAL_DW_PORT 52141 52142</p> 
<p>3.配置主库<br> 3.1配置dm.ini<br> INSTANCE_NAME = dmserver1<br> PORT_NUM = 32141 #数据库实例监听端口<br> DW_INACTIVE_INTERVAL = 60 #接收守护进程消息超时时间<br> ALTER_MODE_STATUS = 0 #不允许手工方式修改实例模式/状态/OGUID<br> ENABLE_OFFLINE_TS = 2 #不允许备库 OFFLINE 表空间<br> MAL_INI = 1 #打开 MAL 系统<br> ARCH_INI = 1 #打开归档配置<br> RLOG_SEND_APPLY_MON = 64 #统计最近 64 次的日志发送信息</p> 
<p>3.2配置dmmal.ini<br> MAL_CHECK_INTERVAL = 5 #MAL 链路检测时间间隔<br> MAL_CONN_FAIL_INTERVAL = 5 #判定 MAL 链路断开的时间<br> [MAL_INST1]<br> MAL_INST_NAME = dmserver1 #实例名，和 dm.ini 中的 INSTANCE_NAME 一致<br> MAL_HOST = 192.168.6.68 #MAL 系统监听 TCP 连接的 IP 地址<br> MAL_PORT = 61141 #MAL 系统监听 TCP 连接的端口<br> MAL_INST_HOST = 192.168.6.68 #实例的对外服务 IP 地址<br> MAL_INST_PORT = 5236 #实例的对外服务端口，和 dm.ini 中的 PORT_NUM 一致<br> MAL_DW_PORT = 52141 #实例本地的守护进程监听 TCP 连接的端口<br> MAL_INST_DW_PORT = 33141 #实例监听守护进程 TCP 连接的端口<br> [MAL_INST2]<br> MAL_INST_NAME = dmserver2<br> MAL_HOST = 192.168.6.69<br> MAL_PORT = 61142<br> MAL_INST_HOST = 192.168.6.69<br> MAL_INST_PORT = 5237<br> MAL_DW_PORT = 52142<br> MAL_INST_DW_PORT = 33142</p> 
<p>3.3配置dmarch.ini<br> [ARCHIVE_REALTIME]<br> ARCH_TYPE = REALTIME #实时归档类型<br> ARCH_DEST = dmserver2 #实时归档目标实例名<br> [ARCHIVE_LOCAL1]<br> ARCH_TYPE = LOCAL #本地归档类型<br> ARCH_DEST = /home/dmdba/dmdbms/data/dmdb/arch #本地归档文件存放路径<br> ARCH_FILE_SIZE = 128 #单位 Mb，本地单个归档文件最大值<br> ARCH_SPACE_LIMIT = 0 #单位 Mb， 0 表示无限制，范围 1024~4294967294M<br> #确认实际情况设置arch_space_limit=2048</p> 
<p>3.4配置dmwatcher.ini<br> [GRP1]<br> DW_TYPE = GLOBAL #全局守护类型<br> DW_MODE = AUTO #自动切换模式<br> DW_ERROR_TIME = 10 #远程守护进程故障认定时间<br> INST_RECOVER_TIME = 60 #主库守护进程启动恢复的间隔时间<br> INST_ERROR_TIME = 10 #本地实例故障认定时间<br> INST_OGUID = 453331 #守护系统唯一 OGUID 值<br> INST_INI = /home/dmdba/dmdbms/data/dmdb/dm.ini #dm.ini 配置文件路径<br> INST_AUTO_RESTART = 1 #打开实例的自动启动功能<br> INST_STARTUP_CMD = /home/dmdba/dmdbms/bin/dmserver #命令行方式启动<br> RLOG_SEND_THRESHOLD = 0 #指定主库发送日志到备库的时间阀值，默认关闭<br> RLOG_APPLY_THRESHOLD = 0 #指定备库重演日志的时间阀值，默认关闭</p> 
<p>3.5启动主库(安装期间先前台起库mount)<br> ./dmserver /home/dmdba/dmdbms/data/dmdb/dm.ini mount<br> 3.6设置OGUID<br> SQL&gt;<br> SP_SET_PARA_VALUE(1, ‘ALTER_MODE_STATUS’, 1);<br> sp_set_oguid(453331);<br> SP_SET_PARA_VALUE(1, ‘ALTER_MODE_STATUS’, 0);<br> 3.7修改数据库模式<br> ./disql<br> SQL&gt;<br> alter database primary;</p> 
<p>4.配置备库<br> scp /home/dmdba/dmdbms/data/dmdb/dm*.ini dmdba@192.168.6.69:/home/dmdba/dmdbms/data/dmdb/<br> 4.1配置dm.ini<br> 4.2配置dmmal.ini<br> 4.3配置dmarch.ini<br> 4.4配置dmwatcher.ini</p> 
<p>4.5启动备库<br> ./dmserver /home/dmdba/dmdbms/data/dmdb/dm.ini mount<br> 4.6设置OGUID<br> ./disql SYSDBA/SYSDBA@localhost:5237<br> SQL&gt;<br> SP_SET_PARA_VALUE(1, ‘ALTER_MODE_STATUS’, 1);<br> sp_set_oguid(453331);<br> SP_SET_PARA_VALUE(1, ‘ALTER_MODE_STATUS’, 0);<br> 4.7修改数据库模式<br> SQL&gt;<br> SP_SET_PARA_VALUE(1, ‘ALTER_MODE_STATUS’, 1);<br> alter database standby;<br> SP_SET_PARA_VALUE(1, ‘ALTER_MODE_STATUS’, 0);</p> 
<p>5.配置监视器dmmonitor.ini–确认网络。防火墙<br> MON_DW_CONFIRM = 1 #确认监视器模式<br> MON_LOG_PATH = /home/dmdba/dmdbms/data/dmdb/log #监视器日志文件存放路径<br> MON_LOG_INTERVAL = 60 #每隔 60s 定时记录系统信息到日志文件<br> MON_LOG_FILE_SIZE = 32 #每个日志文件最大 32M<br> MON_LOG_SPACE_LIMIT = 0 #不限定日志文件总占用空间<br> [GRP1]<br> MON_INST_OGUID = 453331 #组 GRP1 的唯一 OGUID 值<br> #以下配置为监视器到组 GRP1 的守护进程的连接信息，以“IP:PORT”的形式配置<br> #IP 对应 dmmal.ini 中的 MAL_HOST， PORT 对应 dmmal.ini 中的 MAL_DW_PORT<br> MON_DW_IP = 192.168.6.68:52141<br> MON_DW_IP = 192.168.6.69:52142<br> 6.启动守护进程<br> 启动主库实例 :./dmserver /home/dmdba/dmdbms/data/dmdb/dm.ini<br> 启动备库实例<br> 启动主库dmwatcher :./dmwatcher /home/dmdba/dmdbms/data/dmdb/dmwatcher.ini<br> 启动备库dmwatcher</p> 
<p>7.启动监视器<br> ./dmmonitor /home/dmdba/dmdbms/data/dmdb/dmmonitor.ini</p> 
<p>8.注册<br> root:<br> ./dm_service_installer.sh -dm_ini /home/dmdba/dmdbms/data/dmdb/dm.ini -t dmserver -p dm1<br> ./dm_service_installer.sh -watcher_ini /home/dmdba/dmdbms/data/dmdb/dmwatcher.ini -t dmwatcher -p dmwatcher1<br> dmdba:<br> ./DmServicedm1 start<br> ./DmWatcherServicedmwatcher1 start</p> 
<p>./dmmonitor /home/dmdba/dmdbms/data/dmdb/dmmonitor.ini<br> login<br> 用户名:SYSDBA<br> 密码:</p> 
<p>database grp1.dmserver1 显示指定库的详细信息<br> open database 强制起库<br> switchover<br> tip显示系统当前运行状态<br> stop group grp1<br> stop dmwatcher grp1</p> 
<p>startup dmwatcher grp1<br> startup group grp1</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d7258e45a56e404f7ea3588114a393b5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">springboot Json序列化时如何忽略部分字段</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e792831c44dc5202620645a2f0c6ffff/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">快手Kafka集群演进之路学习笔记</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>