<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>基于Docker-Compose实现ELK&#43;Kafka搭建分布式日志采集系统 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="基于Docker-Compose实现ELK&#43;Kafka搭建分布式日志采集系统" />
<meta property="og:description" content="ELK&#43;Kafka搭建日志采集系统 ELK概述搭建与配置docker-compose.yml配置日志采集规则启动服务 模拟发送日志消息日志发送队列日志切面配置application.yaml发送日志消息 Kibana的使用创建索引模式Discovery搜索数据可视化数据 ELK&#43;RabbitMQ发送日志消息配置日志采集规则 ELK概述 ELK是指Elasticsearch、Logstash和Kibana这三个主要的开源软件工具，它们通常一起被用于实时日志分析和数据可视化。另外，在日志采集系统中，ELK通常结合Kafkka一起使用。
1、Elasticsearch
Elasticsearch是一个开源的分布式搜索和分析引擎，基于Lucene库构建。它设计用于处理大规模数据集，能够快速地进行全文搜索、结构化搜索、分析和实时数据处理。Elasticsearch具有高可扩展性和高可靠性，可以自动处理数据的分片和复制，支持分布式搜索和聚合操作。
2.Logstash：
Logstash是一个开源的数据收集和处理引擎，用于将各种类型的数据（如日志、事件、度量等）从多个来源采集、处理和传输到Elasticsearch或其他存储和分析工具。Logstash支持多种数据输入源和输出目的地，可以进行数据转换、标准化、过滤和增强，使数据具备一致性和结构性。
3.Kibana：
Kibana是一个开源的数据可视化平台，用于在Elasticsearch上创建和共享实时的数据可视化仪表盘。它提供了丰富的图表、表格、地图和仪表盘等可视化组件，使用户能够以直观的方式探索和分析数据。Kibana还支持交互式查询和过滤，能够快速演示和共享数据的见解。
4.Kafka
Kafka是数据缓冲队列。作为消息队列解耦了处理过程，同时提高了可扩展性。具有峰值处理能力，使用消息队列能够使关键组件顶住突发的访问压力，而不会因为突发的超负荷的请求而完全崩溃。
搭建与配置 使用Docker Compose实现ELK（Elasticsearch、Logstash、Kibana）和Kafka日志采集
docker-compose.yml 创建docker-compose.yml文件，使用以下服务：
ZooKeeper：用于Kafka的依赖服务，监听在2181端口 Kafka：用于消息队列和日志采集，监听在9092端口，并连接到ZooKeeper Elasticsearch：用于存储和索引日志数据，监听在9200端口 Logstash：用于从Kafka接收日志数据并转发到Elasticsearch Kibana：用于可视化和检索日志数据，监听在5601端口，并连接到Elasticsearch vim docker-compose.yml
version: &#39;3.7&#39; services: zookeeper: image: zookeeper:3.8 container_name: zookeeper ports: - &#34;2181:2181&#34; environment: - ALLOW_ANONYMOUS_LOGIN=yes restart: always kafka: image: bitnami/kafka:3.3.2 container_name: kafka1 hostname: kafka volumes: - ./kafka_data:/bitnami/kafka # 赋予kafka_data目前权限：chmod 777 kafka_data ports: - &#34;9092:9092&#34; depends_on: - zookeeper environment: KAFKA_CFG_ZOOKEEPER_CONNECT: zookeeper:2181 #kafka链接的zookeeper地址 KAFKA_ENABLE_KRAFT: no # 是否使用kraft，默认值：是,即Kafka替代Zookeeper KAFKA_CFG_LISTENERS: PLAINTEXT://:9092 # 定义kafka服务端socket监听端口,默认值：PLAINTEXT://:9092,CONTROLLER://:9093 KAFKA_CFG_ADVERTISED_LISTENERS: PLAINTEXT://192." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/ba73e10d19fb58f354c1b160b933a1b2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-14T21:02:20+08:00" />
<meta property="article:modified_time" content="2023-12-14T21:02:20+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">基于Docker-Compose实现ELK&#43;Kafka搭建分布式日志采集系统</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>ELK+Kafka搭建日志采集系统</h4> 
 <ul><li><a href="#ELK_1" rel="nofollow">ELK概述</a></li><li><a href="#_15" rel="nofollow">搭建与配置</a></li><li><ul><li><a href="#dockercomposeyml_17" rel="nofollow">docker-compose.yml</a></li><li><a href="#_97" rel="nofollow">配置日志采集规则</a></li><li><a href="#_133" rel="nofollow">启动服务</a></li></ul> 
  </li><li><a href="#_140" rel="nofollow">模拟发送日志消息</a></li><li><ul><li><a href="#_142" rel="nofollow">日志发送队列</a></li><li><a href="#_185" rel="nofollow">日志切面</a></li><li><a href="#applicationyaml_229" rel="nofollow">配置application.yaml</a></li><li><a href="#_260" rel="nofollow">发送日志消息</a></li></ul> 
  </li><li><a href="#Kibana_272" rel="nofollow">Kibana的使用</a></li><li><ul><li><a href="#_274" rel="nofollow">创建索引模式</a></li><li><a href="#Discovery_283" rel="nofollow">Discovery搜索数据</a></li><li><a href="#_286" rel="nofollow">可视化数据</a></li></ul> 
  </li><li><a href="#ELKRabbitMQ_291" rel="nofollow">ELK+RabbitMQ</a></li><li><ul><li><a href="#_294" rel="nofollow">发送日志消息</a></li><li><a href="#_311" rel="nofollow">配置日志采集规则</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="ELK_1"></a>ELK概述</h2> 
<p>ELK是指Elasticsearch、Logstash和Kibana这三个主要的开源软件工具，它们通常一起被用于实时日志分析和数据可视化。另外，在日志采集系统中，ELK通常结合Kafkka一起使用。</p> 
<p>1、Elasticsearch</p> 
<blockquote> 
 <p>Elasticsearch是一个开源的分布式搜索和分析引擎，基于Lucene库构建。它设计用于处理大规模数据集，能够快速地进行全文搜索、结构化搜索、分析和实时数据处理。Elasticsearch具有高可扩展性和高可靠性，可以自动处理数据的分片和复制，支持分布式搜索和聚合操作。</p> 
</blockquote> 
<p>2.Logstash：</p> 
<blockquote> 
 <p>Logstash是一个开源的数据收集和处理引擎，用于将各种类型的数据（如日志、事件、度量等）从多个来源采集、处理和传输到Elasticsearch或其他存储和分析工具。Logstash支持多种数据输入源和输出目的地，可以进行数据转换、标准化、过滤和增强，使数据具备一致性和结构性。</p> 
</blockquote> 
<p>3.Kibana：</p> 
<blockquote> 
 <p>Kibana是一个开源的数据可视化平台，用于在Elasticsearch上创建和共享实时的数据可视化仪表盘。它提供了丰富的图表、表格、地图和仪表盘等可视化组件，使用户能够以直观的方式探索和分析数据。Kibana还支持交互式查询和过滤，能够快速演示和共享数据的见解。</p> 
</blockquote> 
<p>4.Kafka</p> 
<blockquote> 
 <p>Kafka是数据缓冲队列。作为消息队列解耦了处理过程，同时提高了可扩展性。具有峰值处理能力，使用消息队列能够使关键组件顶住突发的访问压力，而不会因为突发的超负荷的请求而完全崩溃。</p> 
</blockquote> 
<h2><a id="_15"></a>搭建与配置</h2> 
<blockquote> 
 <p>使用Docker Compose实现ELK（Elasticsearch、Logstash、Kibana）和Kafka日志采集</p> 
</blockquote> 
<h3><a id="dockercomposeyml_17"></a>docker-compose.yml</h3> 
<p>创建docker-compose.yml文件，使用以下服务：</p> 
<pre><code class="prism language-python">ZooKeeper：用于Kafka的依赖服务，监听在<span class="token number">2181</span>端口

Kafka：用于消息队列和日志采集，监听在<span class="token number">9092</span>端口，并连接到ZooKeeper

Elasticsearch：用于存储和索引日志数据，监听在<span class="token number">9200</span>端口

Logstash：用于从Kafka接收日志数据并转发到Elasticsearch

Kibana：用于可视化和检索日志数据，监听在<span class="token number">5601</span>端口，并连接到Elasticsearch
</code></pre> 
<p><code>vim docker-compose.yml</code></p> 
<pre><code class="prism language-java">version<span class="token operator">:</span> <span class="token char">'3.7'</span>
services<span class="token operator">:</span>
  zookeeper<span class="token operator">:</span>
    image<span class="token operator">:</span> zookeeper<span class="token operator">:</span><span class="token number">3.8</span>
    container_name<span class="token operator">:</span> zookeeper
    ports<span class="token operator">:</span>
      <span class="token operator">-</span> <span class="token string">"2181:2181"</span>
    environment<span class="token operator">:</span>
      <span class="token operator">-</span> <span class="token constant">ALLOW_ANONYMOUS_LOGIN</span><span class="token operator">=</span>yes  
    restart<span class="token operator">:</span> always
  kafka<span class="token operator">:</span>
    image<span class="token operator">:</span> bitnami<span class="token operator">/</span>kafka<span class="token operator">:</span><span class="token number">3.3</span><span class="token number">.2</span>
    container_name<span class="token operator">:</span> kafka1
    hostname<span class="token operator">:</span> kafka
    volumes<span class="token operator">:</span>
      <span class="token operator">-</span> <span class="token punctuation">.</span>/kafka_data<span class="token operator">:</span><span class="token operator">/</span>bitnami<span class="token operator">/</span>kafka  # 赋予kafka_data目前权限：chmod <span class="token number">777</span> kafka_data
    ports<span class="token operator">:</span>
      <span class="token operator">-</span> <span class="token string">"9092:9092"</span>
    depends_on<span class="token operator">:</span>
      <span class="token operator">-</span> zookeeper  
    environment<span class="token operator">:</span>
        <span class="token constant">KAFKA_CFG_ZOOKEEPER_CONNECT</span><span class="token operator">:</span> zookeeper<span class="token operator">:</span><span class="token number">2181</span> #kafka链接的zookeeper地址
        <span class="token constant">KAFKA_ENABLE_KRAFT</span><span class="token operator">:</span> no # 是否使用kraft，默认值：是<span class="token punctuation">,</span>即<span class="token class-name">Kafka</span>替代<span class="token class-name">Zookeeper</span>
        <span class="token constant">KAFKA_CFG_LISTENERS</span><span class="token operator">:</span> <span class="token constant">PLAINTEXT</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token operator">:</span><span class="token number">9092</span> # 定义kafka服务端socket监听端口<span class="token punctuation">,</span>默认值：<span class="token constant">PLAINTEXT</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token operator">:</span><span class="token number">9092</span><span class="token punctuation">,</span><span class="token constant">CONTROLLER</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token operator">:</span><span class="token number">9093</span>
        <span class="token constant">KAFKA_CFG_ADVERTISED_LISTENERS</span><span class="token operator">:</span> <span class="token constant">PLAINTEXT</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.30</span><span class="token number">.30</span><span class="token operator">:</span><span class="token number">9092</span> # 定义外网访问地址（宿主机ip地址和端口）<span class="token punctuation">,</span>默认值：<span class="token constant">PLAINTEXT</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token operator">:</span><span class="token number">9092</span>
        <span class="token constant">KAFKA_KRAFT_CLUSTER_ID</span><span class="token operator">:</span> <span class="token constant">FDAF211E728140229F6FCDF4ADDC0B32</span> # 使用<span class="token class-name">Kafka</span>时的集群id，集群内的<span class="token class-name">Kafka</span>都要用这个id做初始化，生成一个<span class="token constant">UUID</span>即可
        <span class="token constant">ALLOW_PLAINTEXT_LISTENER</span><span class="token operator">:</span> yes # 允许使用<span class="token constant">PLAINTEXT</span>监听器，默认<span class="token boolean">false</span>，不建议在生产环境使用
        <span class="token constant">KAFKA_HEAP_OPTS</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token class-name">Xmx512M</span> <span class="token operator">-</span><span class="token class-name">Xms256M</span> # 设置broker最大内存，和初始内存
        <span class="token constant">KAFKA_BROKER_ID</span><span class="token operator">:</span> <span class="token number">1</span> # broker<span class="token punctuation">.</span>id，必须唯一
    restart<span class="token operator">:</span> always
  elasticsearch<span class="token operator">:</span>
    image<span class="token operator">:</span> elasticsearch<span class="token operator">:</span><span class="token number">7.4</span><span class="token number">.2</span>
    container_name<span class="token operator">:</span> elasticsearch
    hostname<span class="token operator">:</span> elasticsearch
    volumes<span class="token operator">:</span>
      <span class="token operator">-</span> <span class="token punctuation">.</span>/es_data<span class="token operator">:</span><span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>elasticsearch<span class="token operator">/</span>data # 赋予es_data目前权限：chmod <span class="token number">777</span> es_data
    restart<span class="token operator">:</span> always
    environment<span class="token operator">:</span>
       <span class="token operator">-</span> <span class="token string">"discovery.type=single-node"</span>
       <span class="token operator">-</span> <span class="token string">"ES_JAVA_OPTS=-Xms512m -Xmx512m"</span>
    ports<span class="token operator">:</span>
    <span class="token operator">-</span> <span class="token string">"9200:9200"</span>
  logstash<span class="token operator">:</span>
    image<span class="token operator">:</span> logstash<span class="token operator">:</span><span class="token number">7.4</span><span class="token number">.2</span>
    container_name<span class="token operator">:</span> logstash
    volumes<span class="token operator">:</span>
      <span class="token operator">-</span> <span class="token punctuation">.</span>/logstash<span class="token punctuation">.</span>conf<span class="token operator">:</span><span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>logstash<span class="token operator">/</span>pipeline<span class="token operator">/</span>logstash<span class="token punctuation">.</span>conf
      <span class="token operator">-</span> <span class="token punctuation">.</span>/logstash<span class="token punctuation">.</span>yml<span class="token operator">:</span><span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>logstash<span class="token operator">/</span>config<span class="token operator">/</span>logstash<span class="token punctuation">.</span>yml
    depends_on<span class="token operator">:</span>
      <span class="token operator">-</span> elasticsearch
    environment<span class="token operator">:</span>
      <span class="token constant">LS_JAVA_OPTS</span><span class="token operator">:</span> <span class="token string">"-Xmx256m -Xms128m"</span>
      <span class="token constant">ELASTICSEARCH_HOST</span><span class="token operator">:</span> <span class="token string">"http://192.168.30.30:9200"</span>
  kibana<span class="token operator">:</span>
    image<span class="token operator">:</span> kibana<span class="token operator">:</span><span class="token number">7.4</span><span class="token number">.2</span>
    restart<span class="token operator">:</span> always
    container_name<span class="token operator">:</span> kibana1
    ports<span class="token operator">:</span>
    <span class="token operator">-</span> <span class="token number">5601</span><span class="token operator">:</span><span class="token number">5601</span>
    environment<span class="token operator">:</span>
      <span class="token constant">ELASTICSEARCH_URL</span><span class="token operator">:</span> <span class="token string">"http://192.168.30.30:9200"</span>
    depends_on<span class="token operator">:</span>
      <span class="token operator">-</span> elasticsearch  
</code></pre> 
<h3><a id="_97"></a>配置日志采集规则</h3> 
<p>创建kafka的数据存储目录，并赋予目前权限：</p> 
<pre><code class="prism language-java">chmod <span class="token number">777</span> kafka_data
</code></pre> 
<p>创建ES的数据存储目录，并赋予目前权限：</p> 
<pre><code class="prism language-java">chmod <span class="token number">777</span> es_data
</code></pre> 
<p>创建logstash.yml配置文件，修改ES连接地址</p> 
<pre><code class="prism language-python">http<span class="token punctuation">.</span>host<span class="token punctuation">:</span> <span class="token string">"0.0.0.0"</span>
xpack<span class="token punctuation">.</span>monitoring<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>hosts<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">"http://192.168.30.30:9200"</span> <span class="token punctuation">]</span>
</code></pre> 
<p>创建logstash.conf配置文件，定义日志采集规则</p> 
<pre><code class="prism language-java">input <span class="token punctuation">{<!-- --></span>
   kafka <span class="token punctuation">{<!-- --></span>
     bootstrap_servers <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"192.168.30.30:9092"</span>
     topics <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"user_logs"</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
filter <span class="token punctuation">{<!-- --></span>
  
<span class="token punctuation">}</span>

output <span class="token punctuation">{<!-- --></span>
  elasticsearch <span class="token punctuation">{<!-- --></span>
    hosts  <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"192.168.30.30:9200"</span>
    index  <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"user_logs"</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span> 
</code></pre> 
<h3><a id="_133"></a>启动服务</h3> 
<p>在docker-compose.yml文件目录，运行以下命令来启动服务：</p> 
<pre><code class="prism language-python">docker<span class="token operator">-</span>compose up <span class="token operator">-</span>d
</code></pre> 
<p>所有容器都启动完毕后，可以通过访问<code>http://192.168.30.30:5601/</code>来访问Kibana，开始对日志数据进行可视化和查询分析<br> <img src="https://images2.imgbox.com/46/e7/XxT2J7p0_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_140"></a>模拟发送日志消息</h2> 
<blockquote> 
 <p>创建一个日志发送队列，配合线程，从队列中获取日志内容，然后以异步的形式发送消息到MQ</p> 
</blockquote> 
<h3><a id="_142"></a>日志发送队列</h3> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LogDeque</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * 本地队列
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">LinkedBlockingDeque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> logMsgs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingDeque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">KafkaTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> kafkaTemplate<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        logMsgs<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">LogDeque</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">new</span> <span class="token class-name">LogThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 创建线程,从队列中获取日志内容,然后以异步的形式发送消息到MQ
     */</span>
    <span class="token keyword">class</span> <span class="token class-name">LogThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">String</span> msgLog <span class="token operator">=</span> logMsgs<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>msgLog<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 发送消息</span>
                    kafkaTemplate<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"user_logs"</span><span class="token punctuation">,</span> msgLog<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 避免cpu飙高的问题</span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_185"></a>日志切面</h3> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Aspect</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AopLogAspect</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">LogDeque</span> logDeque<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 申明一个切点 execution表达式
     */</span>
    <span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">"execution(* cn.ybzy.demo.controller.*.*(..))"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">logAspect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 请求method前打印内容
     *
     * @param joinPoint
     */</span>
    <span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"logAspect()"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">methodBefore</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> joinPoint<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ServletRequestAttributes</span> requestAttributes <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ServletRequestAttributes</span><span class="token punctuation">)</span> <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">getRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> requestAttributes<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">JSONObject</span> jsonObject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置日期格式</span>
        <span class="token class-name">SimpleDateFormat</span> df <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">"yyyy-MM-dd HH:mm:ss"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jsonObject<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"request_time"</span><span class="token punctuation">,</span> df<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jsonObject<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"request_url"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getRequestURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jsonObject<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"request_ip"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getRemoteAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jsonObject<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"request_method"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jsonObject<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"request_args"</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>joinPoint<span class="token punctuation">.</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 将日志信息投递到MQ</span>
        <span class="token class-name">String</span> logMsg <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"&lt;AOP日志 ===》 MQ投递消息：{}&gt;"</span><span class="token punctuation">,</span> logMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 投递msg</span>
        logDeque<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>logMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="applicationyaml_229"></a>配置application.yaml</h3> 
<pre><code class="prism language-java">server<span class="token operator">:</span>
  port<span class="token operator">:</span> <span class="token number">8888</span>

spring<span class="token operator">:</span>
  datasource<span class="token operator">:</span>
    driver<span class="token operator">-</span><span class="token keyword">class</span><span class="token operator">-</span>name<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span>Driver</span>
    url<span class="token operator">:</span> jdbc<span class="token operator">:</span>mysql<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">3306</span><span class="token operator">/</span>demo<span class="token operator">?</span>useUnicode<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>characterEncoding<span class="token operator">=</span>utf<span class="token operator">-</span><span class="token number">8</span><span class="token operator">&amp;</span>useSSL<span class="token operator">=</span><span class="token boolean">false</span><span class="token operator">&amp;</span>allowMultiQueries<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>serverTimezone<span class="token operator">=</span><span class="token constant">UTC</span>
    username<span class="token operator">:</span> root
    password<span class="token operator">:</span> <span class="token number">123456</span>



  application<span class="token operator">:</span>
    # 服务的名称
    name<span class="token operator">:</span> elkk
  jackson<span class="token operator">:</span>
    date<span class="token operator">-</span>format<span class="token operator">:</span> yyyy<span class="token operator">-</span><span class="token constant">MM</span><span class="token operator">-</span>dd <span class="token constant">HH</span><span class="token operator">:</span>mm<span class="token operator">:</span>ss
  kafka<span class="token operator">:</span>
    bootstrap<span class="token operator">-</span>servers<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.30</span><span class="token number">.30</span><span class="token operator">:</span><span class="token number">9092</span> # 指定kafka server的地址，集群配多个，中间，逗号隔开
    producer<span class="token operator">:</span>
      key<span class="token operator">-</span>serializer<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span>StringSerializer</span>
      value<span class="token operator">-</span>serializer<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span>StringSerializer</span>
    consumer<span class="token operator">:</span>
      group<span class="token operator">-</span>id<span class="token operator">:</span> default_consumer_group # 群组<span class="token constant">ID</span>
      enable<span class="token operator">-</span>auto<span class="token operator">-</span>commit<span class="token operator">:</span> <span class="token boolean">true</span>
      auto<span class="token operator">-</span>commit<span class="token operator">-</span>interval<span class="token operator">:</span> <span class="token number">1000</span>
      key<span class="token operator">-</span>deserializer<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span>StringDeserializer</span>
      value<span class="token operator">-</span>deserializer<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span>StringDeserializer</span>
</code></pre> 
<h3><a id="_260"></a>发送日志消息</h3> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestController</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/test"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"OK"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="Kibana_272"></a>Kibana的使用</h2> 
<blockquote> 
 <p>要使用Kibana，需要通过配置一个或多个索引模式来告诉它你想探索的Elasticsearch索引，索引模式(index pattern)是kibana可视化的前提。它相当于告诉kibana要使用哪些索引作为数据进行可视化展示。</p> 
</blockquote> 
<h3><a id="_274"></a>创建索引模式</h3> 
<blockquote> 
 <p>一个索引模式标识一个或者多个你想要通过kiabna探索的Elasticsearch索引。Kibana会查找与指定模式匹配的索引名称。模式中的星号 (*) 匹配0个或者多个字符。</p> 
</blockquote> 
<p>在左侧菜单找到<code>management</code>，然后点击<code>index patterns</code> --&gt; <code>create index pattern</code>。通过输入<code>index pattern</code>的名称，kibana会自动显示匹配的索引，然后点击<code>next</code></p> 
<p><img src="https://images2.imgbox.com/75/67/cu5vGKVF_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>在配置设置Configure settings中， 选择索引中的时间维度的字段，这个时间字段是用来方便基于时间过滤数据用的。这里下拉菜单中选择<code>@timestamp</code>，单击创建索引模式</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/07/d2/jGhwV8cl_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="Discovery_283"></a>Discovery搜索数据</h3> 
<p>点击<code>Discovery</code>，可以查看到日志相关数据，也可以进行日志搜索<br> <img src="https://images2.imgbox.com/c3/76/FScWKrg5_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_286"></a>可视化数据</h3> 
<blockquote> 
 <p>kibana自带了很多可视化的组件，方便对聚合后的结果进行可视化的展示。</p> 
</blockquote> 
<p>左侧菜单选择<code>Visualize</code>，然后点击右边的<code>+</code>号<br> <img src="https://images2.imgbox.com/07/ba/EiGC2Iup_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="ELKRabbitMQ_291"></a>ELK+RabbitMQ</h2> 
<blockquote> 
 <p>搭建ELK+Kafka日志采集系统后，同理可搭建ELK+RabbitMQ日志采集系统，他们实现方式类似，以下为参考：</p> 
</blockquote> 
<h3><a id="_294"></a>发送日志消息</h3> 
<pre><code class="prism language-python">	<span class="token decorator annotation punctuation">@Autowired</span>
	private RabbitTemplate rabbitTemplate<span class="token punctuation">;</span>
	
	<span class="token decorator annotation punctuation">@Test</span>
    public void logs<span class="token punctuation">(</span>String logMsg<span class="token punctuation">)</span>  <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token builtin">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">500000</span><span class="token punctuation">;</span> i<span class="token operator">+</span><span class="token operator">+</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            rabbitTemplate<span class="token punctuation">.</span>convertAndSend<span class="token punctuation">(</span><span class="token string">"elk_logs_exchange"</span><span class="token punctuation">,</span> <span class="token string">"user_logs"</span><span class="token punctuation">,</span>logMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                Thread<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> catch <span class="token punctuation">(</span>InterruptedException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                throw new RuntimeException<span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_311"></a>配置日志采集规则</h3> 
<p>创建logstash.conf配置文件，定义日志采集规则</p> 
<pre><code class="prism language-python"><span class="token builtin">input</span> <span class="token punctuation">{<!-- --></span>
  rabbitmq <span class="token punctuation">{<!-- --></span>
    host <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"192.168.30.30:5672"</span>
    user <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"work"</span>
    password <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"12345678"</span>
    vhost <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"/"</span>
    queue <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"user_logs"</span>
    durable <span class="token operator">=</span><span class="token operator">&gt;</span> true
    exchange <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"elk_logs_exchange"</span>
    key <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"user.logs"</span>
    codec <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"json"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

output <span class="token punctuation">{<!-- --></span>
  elasticsearch <span class="token punctuation">{<!-- --></span>
    hosts <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token string">"192.168.30.30:9200"</span><span class="token punctuation">]</span>
    index <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"base_logs"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/035e5e49a5041ad677b8de97f73e0813/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">青龙面板仓库合集（不断更新）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8d4d9943db45c1369074f259a3516243/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Docker笔记：Docker Swarm 结合 Docker Compose 来部署集群</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>