<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>CentOS7.2 安装L2TP/IPSec 服务端/客户端 和部分心得 ( libreswan&#43;xl2tpd ） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="CentOS7.2 安装L2TP/IPSec 服务端/客户端 和部分心得 ( libreswan&#43;xl2tpd ）" />
<meta property="og:description" content="整体基于CentOS7.2实现。方案为“使用预共享密钥的L2TP/IPSec”
下载地址：http://download.csdn.net/download/gogoytgo/10266198 参考资料：https://teddysun.com/448.html
在此一键安装脚本上，删除了部分功能： 1）不配置防火墙，因为我们的业务不需要也不希望通过VPN直接转接到其他网络，而是通过程序实现。 2）仅保留CentOS相关的配置修改。
1.基本安装组件方法 ： yum -y install ppp libreswan rpm -i xl2tpd-1.3.8-2.el7.x86_64.rpm 同时，建议不使用原装的libreswan, 新版本的兼容性更好，如果是CentOS7，可以直接使用我的编译结果 否则请按下面的方法自行编译
yum install nss-devel libevent-devel unbound unbound-devel systemd-devel libcap-ng-devel make base USE_DNSSEC=false #如果想要直接安装，make install make install USE_DNSSEC=false #如果想要移植，make tarpkg make tarpkg USE_DNSSEC=false 2.关于Android设备的兼容问题 ： 在测试时，发现华为手机无法接入，而使用IOS/PC/其他安卓手机均能接入。 查询了网络资料，看到了是Android 6.0和早期Linux内核的程序，使用了一个坏的SHA2-256算法。
有很多资料会建议你（上面的脚本也是）在/etc/ipsec.conf 中增加
sha2-truncbug=yes 这句话的意思就是让你使用坏的SHA2-256算法。那么，当正确的SHA2-256（例如华为手机）来连接时，就挂了。因此需要根据实际情况取舍。 IOS和WIN不使用SHA2-256，所以没影响。
2.关于如果把VPN服务端部署在局域网内，通过端口映射方式映射，Windows设备的兼容问题 ： 1）需要映射服务端端口1701到公网。 2）如果是Windows客户端，会出现拨号失败的情况。 参考微软的官方说明：https://support.microsoft.com/en-us/help/926179/how-to-configure-an-l2tp-ipsec-server-behind-a-nat-t-device-in-windows
需要设置注册表。
VISTA以上（WIN7/WIN10）
Windows Registry Editor Version 5.00 [HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\PolicyAgent] &#34;AssumeUDPEncapsulationContextOnSendRule&#34;=dword:00000002 XP SP2以上
Windows Registry Editor Version 5." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/f418bb0bc3af05e63fa2250ed7932b76/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-03-02T11:23:42+08:00" />
<meta property="article:modified_time" content="2018-03-02T11:23:42+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">CentOS7.2 安装L2TP/IPSec 服务端/客户端 和部分心得 ( libreswan&#43;xl2tpd ）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>整体基于CentOS7.2实现。方案为“使用预共享密钥的L2TP/IPSec”</p> 
<p>下载地址：<a href="http://download.csdn.net/download/gogoytgo/10266198">http://download.csdn.net/download/gogoytgo/10266198</a> <br> 参考资料：<a href="https://teddysun.com/448.html" rel="nofollow">https://teddysun.com/448.html</a></p> 
<p>在此一键安装脚本上，删除了部分功能： <br> 1）不配置防火墙，因为我们的业务不需要也不希望通过VPN直接转接到其他网络，而是通过程序实现。 <br> 2）仅保留CentOS相关的配置修改。</p> 
<h3 id="1基本安装组件方法">1.基本安装组件方法 ：</h3> 
<pre class="prettyprint"><code class=" hljs avrasm"> yum -<span class="hljs-built_in">y</span> install ppp libreswan 
 rpm -i xl2tpd-<span class="hljs-number">1.3</span><span class="hljs-number">.8</span>-<span class="hljs-number">2.</span>el7<span class="hljs-preprocessor">.x</span>86_64<span class="hljs-preprocessor">.rpm</span>
</code></pre> 
<p>同时，建议不使用原装的libreswan, 新版本的兼容性更好，如果是CentOS7，可以直接使用我的编译结果 <br> 否则请按下面的方法自行编译</p> 
<pre class="prettyprint"><code class=" hljs go">yum install nss-devel libevent-devel unbound unbound-devel systemd-devel libcap-ng-devel
<span class="hljs-built_in">make</span> base USE_DNSSEC=<span class="hljs-constant">false</span>
#如果想要直接安装，<span class="hljs-built_in">make</span> install
<span class="hljs-built_in">make</span> install USE_DNSSEC=<span class="hljs-constant">false</span>
#如果想要移植，<span class="hljs-built_in">make</span> tarpkg
<span class="hljs-built_in">make</span> tarpkg USE_DNSSEC=<span class="hljs-constant">false</span></code></pre> 
<h3 id="2关于android设备的兼容问题">2.关于Android设备的兼容问题 ：</h3> 
<p>在测试时，发现华为手机无法接入，而使用IOS/PC/其他安卓手机均能接入。 <br> 查询了网络资料，看到了是Android 6.0和早期Linux内核的程序，使用了一个坏的SHA2-256算法。</p> 
<p>有很多资料会建议你（上面的脚本也是）在/etc/ipsec.conf 中增加</p> 
<pre class="prettyprint"><code class=" hljs ini"><span class="hljs-setting">sha2-truncbug=<span class="hljs-value"><span class="hljs-keyword">yes</span></span></span></code></pre> 
<p>这句话的意思就是让你使用坏的SHA2-256算法。那么，当正确的SHA2-256（例如华为手机）来连接时，就挂了。因此需要根据实际情况取舍。 <br> IOS和WIN不使用SHA2-256，所以没影响。</p> 
<h3 id="2关于如果把vpn服务端部署在局域网内通过端口映射方式映射windows设备的兼容问题">2.关于如果把VPN服务端部署在局域网内，通过端口映射方式映射，Windows设备的兼容问题 ：</h3> 
<p>1）需要映射服务端端口1701到公网。 <br> 2）如果是Windows客户端，会出现拨号失败的情况。 <br> 参考微软的官方说明：<a href="https://support.microsoft.com/en-us/help/926179/how-to-configure-an-l2tp-ipsec-server-behind-a-nat-t-device-in-windows" rel="nofollow">https://support.microsoft.com/en-us/help/926179/how-to-configure-an-l2tp-ipsec-server-behind-a-nat-t-device-in-windows</a></p> 
<p>需要设置注册表。</p> 
<p>VISTA以上（WIN7/WIN10）</p> 
<pre class="prettyprint"><code class=" hljs tex">Windows Registry Editor Version 5.00

<span class="hljs-special">[</span>HKEY_LOCAL_MACHINE<span class="hljs-command">\SYSTEM</span><span class="hljs-command">\CurrentControlSet</span><span class="hljs-command">\Services</span><span class="hljs-command">\PolicyAgent</span><span class="hljs-special">]</span>
"AssumeUDPEncapsulationContextOnSendRule"=dword:00000002
</code></pre> 
<p>XP SP2以上</p> 
<pre class="prettyprint"><code class=" hljs tex">Windows Registry Editor Version 5.00

<span class="hljs-special">[</span>HKEY_LOCAL_MACHINE<span class="hljs-command">\SYSTEM</span><span class="hljs-command">\CurrentControlSet</span><span class="hljs-command">\Services</span><span class="hljs-command">\IPSec</span><span class="hljs-special">]</span>
"AssumeUDPEncapsulationContextOnSendRule"=dword:00000002
</code></pre> 
<p>设置后重启计算机生效。</p> 
<h3 id="3日志诊断">3.日志诊断 ：</h3> 
<p>1）服务端的鉴权日志在 /var/log/secure <br> 2）客户端连接的日志在 /var/log/messages</p> 
<h3 id="4文件说明">4.文件说明 ：</h3> 
<h5 id="configvpnserversh">config_vpn_server.sh</h5> 
<pre class="prettyprint"><code class=" hljs css">#服务端配置脚本，配置完毕后自动启动
<span class="hljs-tag">config_vpn_server</span><span class="hljs-class">.sh</span> <span class="hljs-attr_selector">[你的公网IP]</span> <span class="hljs-attr_selector">[PSK]</span> <span class="hljs-attr_selector">[用户名]</span> <span class="hljs-attr_selector">[密码]</span></code></pre> 
<h5 id="configvpnclientsh">config_vpn_client.sh</h5> 
<pre class="prettyprint"><code class=" hljs vala"><span class="hljs-preprocessor">#服务端客户端配置脚本</span>
config_vpn_client.sh [对端的公网IP] [PSK] [用户名] [密码]
<span class="hljs-preprocessor">#客户端配置完毕后，通过start_vpn.sh和stop_vpn.sh 启动/停止</span></code></pre> 
<h5 id="startvpnsh">start_vpn.sh</h5> 
<p>客户端启动脚本</p> 
<h5 id="stopvpnsh">stop_vpn.sh</h5> 
<p>客户端停止脚本</p> 
<h5 id="libreswansrc-323targz">libreswan_src-3.23.tar.gz</h5> 
<p>libreswan最新版本源码</p> 
<h5 id="libreswandst-323tgz">libreswan_dst-3.23.tgz</h5> 
<p>libreswan我基于CentOS7.2的编译结果包</p> 
<p>部署方法：</p> 
<pre class="prettyprint"><code class=" hljs avrasm">cd /
tar xvf libreswan-<span class="hljs-number">3.23</span><span class="hljs-preprocessor">.tgz</span>
systemctl enable ipsec<span class="hljs-preprocessor">.service</span></code></pre> 
<h5 id="xl2tpd-138-2el7x8664">xl2tpd-1.3.8-2.el7.x86_64</h5> 
<p>前面提到的安装文件</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ffefa1b4bfbcb593e191e4bda319b51b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">$.ajax 传到后台的参数获取不到</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/446aa5dc816c79380a89d6e8d131284e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Swift_UI：（五）、UIWebView、WKWebView</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>