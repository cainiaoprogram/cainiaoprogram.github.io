<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>USB2.0 通信协议 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="USB2.0 通信协议" />
<meta property="og:description" content="USB通信协议深入理解 1.基本概念 一个【传输】(控制、批量、中断、等时)：由多个【事务】组成； 一个【事务】(IN、OUT、SETUP)：由一多个【Packet】组成。
USB数据在【主机软件】与【USB设备特定的端点】间被传输。【主机软件】与【USB设备特定的端点】间的关联叫做【pipes】。一个USB设备可以有多个管道(pipes)。
2.包(Packet) 包（Packet）是USB系统中信息传输的基本单元，所有数据都是经过打包后在总线上传输的。数据在 USB总线上的传输以包为单位，包只能在帧内传输。高速USB 总线的帧周期为125us，全速以及低速 USB 总线的帧周期为 1ms。帧的起始由一个特定的包（SOF 包）表示，帧尾为 EOF。EOF不是一个包，而是一种电平状态，EOF期间不允许有数据传输。
注意：虽然高速USB总线和全速/低速USB总线的帧周期不一样，但是SOF包中帧编号的增加速度是一样的，因为在高速USB系统中，SOF包中帧编号实际上取得是计数器的高11位，最低三位作为微帧编号没有使用，因此其帧编号的增加周期也为 1mS。
• USB总线上的情形是怎样的？
• 包是USB总线上数据传输的最小单位，不能被打断或干扰，否则会引发错误。若干个数据包组成一次事务传输，一次事务传输也不能打断，属于一次事务传输的几个包必须连续，不能跨帧完成。一次传输由一次到多次事务传输构成，可以跨帧完成。
USB包由五部分组成，即同步字段（SYNC）、包标识符字段（PID）、数据字段、循环冗余校验字段（CRC）和包结尾字段（EOP），包的基本格式如下图：
2.1 PID类型(即包类型)
2.2 Token Packets
此格式适用于IN、OUT、SETUP、PING。
PID数据传输方向INDevice-&gt;HostOUTHost-&gt;DeviceSETUPHost-&gt;DevicePINGDevice-&gt;Host 2.3 Start-of-Frame(SOF) Packets
SOF包由Host发送给Device。
1) 对于full-speed总线，每隔1.00 ms ±0.0005 ms发送一次；
2) 对于high-speed总线，每隔125 μs ±0.0625 μs发送一次；
12 SOF包构成如下图所示： 2.4 Data Packets
有四种类类型的数据包：DATA0, DATA1, DATA2,and MDATA，且由PID来区分。DATA0和DATA1被定义为支持数据切换同步(data toggle synchronization)。
2.5 Handshake Packets
• ACK: 对于IN事务，它将由host发出；对于OUT、SETUP和PING事务，它将由device发出。 • NAK: 在数据阶段，对于IN事务，它将由device发出；在握手阶段，对于OUT和PING事务，它也将由device发出；host从不发送NAK包
3.事务(Transaction) 在USB上数据信息的一次接收或发送的处理过程称为事务处理（Transaction）即：The delivery of service to an endpoint。一个事务由一系统packet组成，具体由哪些packet组成，它取决于具体的事务。可能由如下包组成： • 一个token packet • 可选的data pcket • 可选的handshake packet • 可选的special packet" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/f32eed9c1d8a056a517496604f900869/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-10-31T13:51:11+08:00" />
<meta property="article:modified_time" content="2020-10-31T13:51:11+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">USB2.0 通信协议</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>USB通信协议深入理解</h2> 
<h3 id="1基本概念"><a name="t1"></a><a name="t0"></a><strong>1.基本概念</strong></h3> 
<p>一个【<strong>传输</strong>】(控制、批量、中断、等时)：由多个【事务】组成； <br> 一个【<strong>事务</strong>】(IN、OUT、SETUP)：由一多个【Packet】组成。</p> 
<p>USB数据在【主机软件】与【USB设备特定的<strong>端点</strong>】间被传输。【主机软件】与【USB设备特定的端点】间的关联叫做【pipes】。一个USB设备可以有多个管道(pipes)。</p> 
<h3 id="2包packet"><a name="t2"></a><strong>2.包(Packet)</strong></h3> 
<p><strong>包（Packet）是USB系统中信息传输的基本单元，所有数据都是经过打包后在总线上传输的。</strong>数据在 USB总线上的传输<strong>以包为单位</strong>，<strong>包只能在帧内传输</strong>。<strong>高速USB 总线的帧周期为125us</strong>，<strong>全速以及低速 USB 总线的帧周期为 1ms</strong>。帧的<strong>起始</strong>由一个特定的包（<strong>SOF 包</strong>）表示，<strong>帧尾为 EOF</strong>。EOF不是一个包，而是一种电平状态，EOF期间不允许有数据传输。</p> 
<p>注意：虽然高速USB总线和全速/低速USB总线的<strong>帧周期不一样</strong>，但是<strong>SOF包中帧编号的增加速度是一样的</strong>，因为在高速USB系统中，SOF包中帧编号实际上取得是计数器的高11位，最低三位作为微帧编号没有使用，因此其帧编号的增加周期也为 1mS。</p> 
<p>• USB总线上的情形是怎样的？</p> 
<p><img alt="这里写图片描述" src="https://images2.imgbox.com/c9/d5/V2GzKNyB_o.png"></p> 
<p>• 包是USB总线上数据传输的最小单位，不能被打断或干扰，否则会引发错误。<strong>若干个数据包组成一次事务传输</strong>，一次事务传输也不能打断，属于<strong>一次事务传输的几个包必须连续，不能跨帧完成</strong>。<strong>一次传输由一次到多次事务传输构成，可以跨帧完成。</strong></p> 
<p><strong>USB包</strong>由五部分组成，即<strong>同步字段（SYNC）</strong>、<strong>包标识符字段（PID）</strong>、<strong>数据字段</strong>、<strong>循环冗余校验字段（CRC）</strong>和<strong>包结尾字段（EOP）</strong>，包的基本格式如下图：</p> 
<p><img alt="这里写图片描述" src="https://images2.imgbox.com/e3/65/NE0Mak6i_o.png"></p> 
<p><strong>2.1 PID类型(即包类型)</strong></p> 
<p><img alt="这里写图片描述" src="https://images2.imgbox.com/2c/b8/1ghUpqW1_o.png"></p> 
<p><img alt="这里写图片描述" src="https://images2.imgbox.com/e7/2c/h1bHafhC_o.png"></p> 
<p><strong>2.2 Token Packets</strong></p> 
<p><img alt="这里写图片描述" src="https://images2.imgbox.com/e7/98/FQUP4GIf_o.png"></p> 
<p><strong>此格式适用于IN、OUT、SETUP、PING。</strong></p> 
<table><thead><tr><th>PID</th><th>数据传输方向</th></tr></thead><tbody><tr><td>IN</td><td>Device-&gt;Host</td></tr><tr><td>OUT</td><td>Host-&gt;Device</td></tr><tr><td>SETUP</td><td>Host-&gt;Device</td></tr><tr><td>PING</td><td>Device-&gt;Host</td></tr></tbody></table> 
<p><strong>2.3 Start-of-Frame(SOF) Packets</strong></p> 
<p>SOF包由Host发送给Device。</p> 
<pre> </pre> 
<ol><li> <p><code>1) 对于full-speed总线，每隔1.00 ms ±0.0005 ms发送一次；</code></p> </li><li> <p><code>2) 对于high-speed总线，每隔125 μs ±0.0625 μs发送一次；</code></p> </li></ol> 
<ul><li>1</li><li>2</li></ul> 
<p>SOF包构成如下图所示： <br><img alt="这里写图片描述" src="https://images2.imgbox.com/56/bf/1g3UmJVV_o.png"></p> 
<p><img alt="这里写图片描述" src="https://images2.imgbox.com/f7/ef/cKU5wlOp_o.png"></p> 
<p><strong>2.4 Data Packets</strong></p> 
<p><img alt="这里写图片描述" src="https://images2.imgbox.com/9c/a4/RneHFqab_o.png"></p> 
<p><strong>有四种类类型的数据包：DATA0, DATA1, DATA2,and MDATA，且由PID来区分</strong>。DATA0和DATA1被定义为支持数据切换同步(data toggle synchronization)。</p> 
<p><strong>2.5 Handshake Packets</strong></p> 
<p><img alt="这里写图片描述" src="https://images2.imgbox.com/46/7c/p7qwNMbY_o.png"></p> 
<p>• ACK: 对于IN事务，它将由host发出；对于OUT、SETUP和PING事务，它将由device发出。 <br> • NAK: 在数据阶段，对于IN事务，它将由device发出；在握手阶段，对于OUT和PING事务，它也将由device发出；host从不发送NAK包</p> 
<h3 id="3事务transaction"><a name="t3"></a><strong>3.事务(Transaction)</strong></h3> 
<p><strong>在USB上数据信息的一次接收或发送的处理过程称为事务处理</strong>（Transaction）即：The delivery of service to an endpoint。<strong>一个事务由一系统packet组成</strong>，具体由哪些packet组成，它取决于具体的事务。可能由如下包组成： <br> • 一个token packet <br> • 可选的data pcket <br> • 可选的handshake packet <br> • 可选的special packet</p> 
<p><strong>3.1 输入（IN）事务处理</strong></p> 
<p><strong>输入事务处理：表示USB主机从总线上的某个USB设备接收一个数据包的过程。</strong></p> 
<p>•【正常】的输入事务处理</p> 
<p><img alt="这里写图片描述" src="https://images2.imgbox.com/dd/e2/hoYUY3f7_o.png"></p> 
<p>•【设备忙】时的输入事务处理</p> 
<p><img alt="这里写图片描述" src="https://images2.imgbox.com/bf/c5/ZgoBWMDf_o.png"></p> 
<p>•【设备出错】时的输入事务处理</p> 
<p><img alt="这里写图片描述" src="https://images2.imgbox.com/c0/6c/zOTGRrnm_o.png"></p> 
<p><strong>3.2. 输出（OUT）事务处理</strong></p> 
<p><strong>输出事务处理：表示USB主机把一个数据包输出到总线上的某个USB设备接收的过程。</strong></p> 
<p>•【正常】的输出事务处理</p> 
<p><img alt="这里写图片描述" src="https://images2.imgbox.com/90/e2/bFiPSq3I_o.png"></p> 
<p>•【设备忙时】的输出事务处理</p> 
<p><img alt="这里写图片描述" src="https://images2.imgbox.com/85/f0/8Lpjk3F0_o.png"></p> 
<p>•【设备出错】的输出事务处理</p> 
<p><img alt="这里写图片描述" src="https://images2.imgbox.com/6f/af/gyAIpNg7_o.png"></p> 
<p><strong>3.3.设置（SETUP）事务处理</strong></p> 
<p>•【正常】的设置事务处理</p> 
<p><img alt="这里写图片描述" src="https://images2.imgbox.com/26/bb/quF61aCu_o.png"></p> 
<p>•【设备忙时】的设置事务处理</p> 
<p><img alt="这里写图片描述" src="https://images2.imgbox.com/ca/94/QZ0WGF2o_o.png"></p> 
<p>•【设备出错】的设置事务处理 <br><img alt="这里写图片描述" src="https://images2.imgbox.com/2f/7d/zzVaXq3d_o.png"></p> 
<h3 id="4-usb传输类型"><a name="t4"></a><strong>4. USB传输类型</strong></h3> 
<p>在USB的传输中，定义了4种传输类型： <br> • 控制传输 (Control Transfer) <br> • 中断传输 (Interrupt Transfer) <br> • 批量传输 (Bulk Transfer) <br> • 同步传输 (Isochronous)</p> 
<p><strong>4.1 控制传输 (Control Transfer)</strong></p> 
<p>控制传输由2～3个阶段组成： <br> 1) 建立阶段(Setup) <br> 2) 数据阶段（无数据控制没有此阶段）(DATA) <br> 3) 状态阶段(Status) <br> •每个阶段都由一次或多次（数据阶段）事务传输组成（Transaction）。 <br> 控制数据由USB系统软件用于配置设备(在枚举时)，其它的驱动软件可以选择使用control transfer实现具体的功能，数据传输是不可丢失的。</p> 
<p><strong>4.1.1 建立阶段</strong></p> 
<p><strong>主机从USB设备获取配置信息，并设置设备的配置值。</strong>建立阶段的数据交换包含了SETUP令牌封包、紧随其后的DATA0数据封包以及ACK握手封包。它的作用是执行一个设置（概念含糊）的数据交换，并定义此控制传输的内容(即：在Data Stage中IN或OUT的data包个数，及发送方向，在Setup Stage已经被设定)。</p> 
<p><img alt="这里写图片描述" src="https://images2.imgbox.com/fc/15/cTEDsNxh_o.png"></p> 
<p><strong>4.1.2 数据阶段</strong></p> 
<p>根据<strong>数据阶段的数据传输的方向</strong>，控制传输又可分为3种类型： <br> 1) 控制读取（读取USB描述符） <br> 2) 控制写入（配置USB设备） <br> 3) 无数据控制</p> 
<p>数据传输阶段：用来传输主机与设备之间的数据。 <br><strong>• 控制读取</strong> <br> 是将数据从设备读到主机上，读取的数据USB设备描述符。该过程如下图的【Control Read】所示。对每一个数据信息包而言，首先，主机会发送一个IN令牌信息包，表示要读数据进来。然后，设备将数据通过DATA1/DATA0数据信息包回传给主机。最后，主机将以下列的方式加以响应：当数据已经正确接收时，主机送出ACK令牌信息包；当主机正在忙碌时，发出NAK握手信息包；当发生了错误时，主机发出STALL握手信息包。</p> 
<p><strong>• 控制写入</strong> <br> 是将数据从主机传到设备上，所传的数据即为对USB设备的配置信息，该过程如下的图【Control Wirte】所示。对每一个数据信息包而言，主机将会送出一个OUT令牌信息包，表示数据要送出去。紧接着，主机将数据通过DATA1/DATA0数据信息包传递至设备。最后，设备将以下列方式加以响应：当数据已经正确接收时，设备送出ACK令牌信息包；当设备正在忙碌时，设备发出NAK握手信息包；当发生了错误时，设备发出STALL握手信息包。</p> 
<p><img alt="这里写图片描述" src="https://images2.imgbox.com/25/5f/Ox0FJyUg_o.png"></p> 
<p><strong>4.1.3 状态阶段</strong></p> 
<p><strong>状态阶段：用来表示整个传输的过程已完全结束。</strong></p> 
<p><strong>状态阶段传输的方向必须与数据阶段的方向相反</strong>，即原来是IN令牌封包，这个阶段应为OUT令牌封包；反之，原来是OUT令牌封包，这个阶段应为IN令牌封包。</p> 
<p>对于【控制读取】而言，主机会送出OUT令牌封包，其后再跟着0长度的DATA1封包。而此时，设备也会做出相对应的动作，送ACK握手封包、NAK握手封包或STALL握手封包。</p> 
<p>相对地对于【控制写入】传输，主机会送出IN令牌封包，然后设备送出表示完成状态阶段的0长度的DATA1封包，主机再做出相对应的动作：送ACK握手封包、NAK握手封包或STALL握手封包。</p> 
<p><strong>4.2 批量传输 (Bulk Transfer)</strong></p> 
<p>•<strong>用于传输大量数据</strong>，要求传输不能出错，但对时间没有要求，适用于打印机、存储设备等。 <br> •<strong>批量传输是可靠的传输，需要握手包来表明传输的结果</strong>。若数据量比较大，将采用多次批量事务传输来完成全部数据的传输，传输过程中数据包的PID 按照 DATA0-DATA1-DATA0-…的方式翻转，以保证发送端和接收端的同步。 <br> • <strong>USB 允许连续 3次以下的传输错误</strong>，会重试该传输，若成功则将错误次数计数器清零，否则累加该计数器。超过三次后，HOST 认为该端点功能错误（STALL），放弃该端点的传输任务。 <br> • <strong>一次批量传输（Transfer）由 1 次到多次批量事务传输（Transaction）组成。</strong> <br> • 翻转同步：发送端按照 DATA0-DATA1-DATA0-…的顺序发送数据包，只有成功的事务传输才会导致 PID 翻转，也就是说发送端只有在接收到 ACK 后才会翻转 PID，发送下一个数据包，否则会重试本次事务传输。同样，若在接收端发现接收到到的数据包不是按照此顺序翻转的，比如连续收到两个 DATA0，那么接收端认为第二个 DATA0 是前一个 DATA0 的重传。</p> 
<p>它通过在硬件级执行“错误检测”和“重传”来确保host与device之间“准确无误”地传输数据，即可靠传输。它由三种包组成(即IN事务或OUT事务)： <br> 1) token <br> 2) data <br> 3) handshake</p> 
<p><img alt="这里写图片描述" src="https://images2.imgbox.com/36/b3/LArTjVfv_o.png"></p> 
<p>1) For IN Token (即：IN Transaction)</p> 
<p>• ACK: 表示host正确无误地接收到数据 <br> • NAK: 指示设备暂时不能返回或接收数据 (如：设备忙) <br> • STALL:指示设备永远停止，需要host软件的干预 (如：设备出错)</p> 
<p>2) For OUT Token (即：OUT Transaction)</p> 
<p>如果接收到的数据包有误，如：CRC错误，Device不发送任何handshake包</p> 
<p>• ACK: Device已经正确无误地接收到数据包，且通知Host可以按顺序发送下一个数据包 <br> • NAK: Device 已经正确无误地接收到数据包，且通知Host重传数据，由于Device临时状况(如buffer满) <br> • STALL: 指示Device endpoint已经停止，且通知Host不再重传</p> 
<p>3) Bulk读写序列</p> 
<p><img alt="这里写图片描述" src="https://images2.imgbox.com/1e/62/6PMNVlzT_o.png"></p> 
<p>即由一系统IN事务或OUT事务组成。</p> 
<p><strong>4.3 中断传输(Interrupt Transfer)</strong></p> 
<p><strong>中断传输由IN或OUT事务组成。</strong></p> 
<p>中断传输在流程上除<strong>不支持PING</strong> 之外，其他的跟批量传输是一样的。他们之间的区别也仅在于事务传输发生的<strong>端点不一样、支持的最大包长度不一样、优先级不一样</strong>等这样一些对用户来说透明的东西。 <br> 主机在排定中断传输任务时，会根据对应中断端点描述符中指定的查询间隔发起中断传输。中断传输有较高的优先级，仅次于同步传输。 <br> 同样中断传输也采用PID翻转的机制来保证收发端数据同步。下图为中断传输的流程图。 <br> 中断传输方式总是用于对设备的查询，以确定是否有数据需要传输。因此中断传输的方向总是从USB设备到主机。</p> 
<p><img alt="这里写图片描述" src="https://images2.imgbox.com/94/f6/p8JpaQk6_o.png"></p> 
<p>DATA0或DATA1中的包含的是中断信息，而不是中断数据。</p> 
<p><strong>4.4 同步传输(Isochronous Transfer)</strong></p> 
<p>1) 它由两种包组成： <br> 1) token <br> 2) data <br><strong>同步传输不支持“handshake”和“重传能力”，所以它是不可靠传输。</strong></p> 
<p>同步传输是不可靠的传输，所以它没有握手包，也不支持PID翻转。主机在排定事务传输时，同步传输有最高的优先级。</p> 
<p>同步传输适用于必须以固定速率抵达或在指定时刻抵达，可以容忍偶尔错误的数据上。实时传输一般用于麦克风、喇叭、UVC Camera等设备。实时传输只需令牌与数据两个信息包阶段，没有握手包，故数据传错时不会重传。</p> 
<p><img alt="这里写图片描述" src="https://images2.imgbox.com/d2/93/OZhH4NWY_o.png"></p> 
<h3 id="参考"><a name="t5"></a></h3> 
<p> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1f33e1e369d73b3559b81a0904e385ed/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">图像分割——meanshift算法（C&#43;&#43;&amp;GDAL库）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f3b31b542b7621890d01c66b7d4da501/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">leetcode_120_三角形最小路径和</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>