<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>2020电赛E题--非线性失真器程序设计--01--算法仿真与STM32FFT数据验证（附工程源码&#43;gitee链接） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="2020电赛E题--非线性失真器程序设计--01--算法仿真与STM32FFT数据验证（附工程源码&#43;gitee链接）" />
<meta property="og:description" content="写在前面 20电赛整体感觉难度比之前小，本次程序设计上也没有太多的难点。功能指标全部完成，程序实现了测量每种失真的情况下的THD的近似值。并且进行了程序拓展，实现了全自动的测量，以及显示测量波形的波形图，频谱图。根据题目要求，我们可以看出这次程序设计要用到FFT算法。
我们的程序设计有两个版本，一个版本是通过定时器进行采样得到特定采样率下的数据并保存在数组里，然后进行傅里叶变换，另外一种就是通过定时器产生PWM波生成ADC的采样时钟，直接通过DMA保存数据然后进行傅里叶变换。
在理论计算下，
所以本文主要介绍我们实现的FFT的功能测试验证的程序。
题目 比赛指标要求 为什么需要FFT? 任何连续测量的时域信号都可以表示为不同频率的正弦波信号的无限叠加。以累加的方式来计算该信号中不同信号的频率、振幅和相位。所以本次测量就必须要使用FFT算法。
原理部分就引用下别人的帖子大家自行查看：
超详细易懂FFT（快速傅里叶变换）及代码实现
知识科普：THD 总谐波失真表明功放工作时，由于电路不可避免的振荡或其他谐振产生的二次，三次谐波与实际输入信号叠加，在输出端输出的信号就不单纯是与输入信号完全相同的成分，而是包括了谐波成分的信号，这些多余出来的谐波成分与实际输入信号的对比，用百分比来表示就称为总谐波失真。一般来说，总谐波失真在500赫兹附近最小，所以大部分功放表明总谐波失真是用500赫兹信号做测试，但有些更严格的厂家也提供20－20000赫兹范围内的总谐波失真数据。总谐波失真在1%以下，一般耳朵分辨不出来，超过10%就可以明显听出失真的成分。这个总谐波失真的数值越小，音色就更加纯净。一般产品的总谐波失真都小于1%@500Hz，但这个数值越小，表明产品的品质越高。
所以在进行测试前我们就要先有个概念
对于信号源输出的1k的正弦信号，总谐波失真的近似值越小，表示程序更精准，基本在1.0%以内。
对于信号源输出的1k的方波信号，总谐波失真的近似值大约是0.3887（前5次谐波计算的近似值）
失真度测试仪测量的结果： 正弦波 方波 这里解释下为啥方波测量出来的是44.26%，这里先给出方波的傅里叶变换式子
因为对于近似值来说方波取前五次傅里叶变换的值就是0.3887
计算到前7次时候
MTLAB仿真测试 所以根据已有的知识，进行下MATLAB仿真测试
clf;fs=10240; %采样频率 Ndata=1024; %数据长度 N=1024; %FFT的数据长度 n=0:Ndata-1; t=n/fs; %数据对应的时间序列 x=0.5*sin(2*pi*1000*t)&#43;1; %时间域信号 %subplot(2,2,4),plot(t,x); subplot(2,2,2),plot(t,x,&#39;.--&#39;); y=fft(x,N); %信号的Fourier变换 mag=abs(y); %求取振幅 f=(0:N-1)*fs/N; %真实频率 subplot(2,2,1),plot(f(1:N/2),mag(1:N/2)*2/N); %绘出Nyquist频率之前的振幅 xlabel(&#39;频率/Hz&#39;);ylabel(&#39;振幅&#39;); title(&#39;Ndata=10240 Nfft=1024&#39;);grid on; 这里仿真显示的频谱图和我们的代码模拟给出的输入信号是相同的所以大致可以按照这个傅里叶变换的标准进行编写代码。之所以这里画出采样的波形图是因为后面我们程序要画波形图，所以这里就测试了下。理想波形的总谐波失真计算没有意义所以就不进行计算。
STM32测试程序： FFT.C 这里的FFT也是找到的别人写好的程序，所以就不做详细讲解了（能力有限）
#include &#34;math.h&#34; #include &#34;fft.h&#34; //精度0.0001弧度 //复数的交换 void conjugate_complex(int n,complex in[],complex out[]) { int i = 0; for(i=0;i&lt;n;i&#43;&#43;) { out[i]." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/c8ec925494f80518ebd2b4fcbd0b4ad1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-02T13:21:53+08:00" />
<meta property="article:modified_time" content="2022-07-02T13:21:53+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">2020电赛E题--非线性失真器程序设计--01--算法仿真与STM32FFT数据验证（附工程源码&#43;gitee链接）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>写在前面</h2> 
<p>20电赛整体感觉难度比之前小，本次程序设计上也没有太多的难点。功能指标全部完成，程序实现了测量每种失真的情况下的THD的近似值。并且进行了程序拓展，实现了全自动的测量，以及显示测量波形的波形图，频谱图。根据题目要求，我们可以看出这次程序设计要用到FFT算法。<br> 我们的程序设计有两个版本，一个版本是通过定时器进行采样得到特定采样率下的数据并保存在数组里，然后进行傅里叶变换，另外一种就是通过定时器产生PWM波生成ADC的采样时钟，直接通过DMA保存数据然后进行傅里叶变换。<br> 在理论计算下，<br> 所以本文主要介绍我们实现的FFT的功能测试验证的程序。</p> 
<h2><a id="_5"></a>题目</h2> 
<p><img src="https://images2.imgbox.com/d1/f5/VRvjH7jx_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_7"></a>比赛指标要求</h2> 
<p><img src="https://images2.imgbox.com/4b/0b/UqJzCC62_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="FFT_9"></a>为什么需要FFT?</h2> 
<p>任何连续测量的时域信号都可以表示为不同频率的正弦波信号的无限叠加。以累加的方式来计算该信号中不同信号的频率、振幅和相位。所以本次测量就必须要使用FFT算法。</p> 
<p>原理部分就引用下别人的帖子大家自行查看：<br> <a href="https://blog.csdn.net/Flag_z/article/details/99163939?utm_medium=distribute.pc_relevant_t0.none-task-blog-BlogCommendFromMachineLearnPai2-1.channel_param&amp;depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-BlogCommendFromMachineLearnPai2-1.channel_param">超详细易懂FFT（快速傅里叶变换）及代码实现</a></p> 
<h2><a id="THD_14"></a>知识科普：THD</h2> 
<p>总谐波失真表明功放工作时，由于电路不可避免的振荡或其他谐振产生的二次，三次谐波与实际输入信号叠加，在输出端输出的信号就不单纯是与输入信号完全相同的成分，而是包括了谐波成分的信号，这些多余出来的谐波成分与实际输入信号的对比，用百分比来表示就称为总谐波失真。一般来说，总谐波失真在500赫兹附近最小，所以大部分功放表明总谐波失真是用500赫兹信号做测试，但有些更严格的厂家也提供20－20000赫兹范围内的总谐波失真数据。总谐波失真在1%以下，一般耳朵分辨不出来，超过10%就可以明显听出失真的成分。这个总谐波失真的数值越小，音色就更加纯净。一般产品的总谐波失真都小于1%@500Hz，但这个数值越小，表明产品的品质越高。</p> 
<p><mark><strong>所以在进行测试前我们就要先有个概念<br> 对于信号源输出的1k的正弦信号，总谐波失真的近似值越小，表示程序更精准，基本在1.0%以内。<br> 对于信号源输出的1k的方波信号，总谐波失真的近似值大约是0.3887（前5次谐波计算的近似值）</strong></mark></p> 
<h3><a id="_20"></a>失真度测试仪测量的结果：</h3> 
<h4><a id="_21"></a>正弦波</h4> 
<p><img src="https://images2.imgbox.com/55/23/wP53MwdZ_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_24"></a>方波</h4> 
<p><img src="https://images2.imgbox.com/cf/ac/4iLyCBLh_o.png" alt="在这里插入图片描述"><br> 这里解释下为啥方波测量出来的是44.26%，这里先给出方波的傅里叶变换式子<br> <img src="https://images2.imgbox.com/39/a5/5AiuvmYb_o.png" alt="在这里插入图片描述"><br> 因为对于近似值来说方波取前五次傅里叶变换的值就是0.3887<br> <img src="https://images2.imgbox.com/5a/36/ZkVTnPJj_o.png" alt="在这里插入图片描述"><br> 计算到前7次时候<br> <img src="https://images2.imgbox.com/a4/6a/Mu78Y8xU_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="MTLAB_34"></a>MTLAB仿真测试</h2> 
<p>所以根据已有的知识，进行下MATLAB仿真测试</p> 
<pre><code class="prism language-python">clf<span class="token punctuation">;</span>fs<span class="token operator">=</span><span class="token number">10240</span><span class="token punctuation">;</span> <span class="token operator">%</span>采样频率
Ndata<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">;</span> <span class="token operator">%</span>数据长度
N<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">;</span> <span class="token operator">%</span>FFT的数据长度
n<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">:</span>Ndata<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
t<span class="token operator">=</span>n<span class="token operator">/</span>fs<span class="token punctuation">;</span>   <span class="token operator">%</span>数据对应的时间序列
x<span class="token operator">=</span><span class="token number">0.5</span><span class="token operator">*</span>sin<span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>pi<span class="token operator">*</span><span class="token number">1000</span><span class="token operator">*</span>t<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>   <span class="token operator">%</span>时间域信号

<span class="token operator">%</span>subplot<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>plot<span class="token punctuation">(</span>t<span class="token punctuation">,</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
subplot<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>plot<span class="token punctuation">(</span>t<span class="token punctuation">,</span>x<span class="token punctuation">,</span><span class="token string">'.--'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
y<span class="token operator">=</span>fft<span class="token punctuation">(</span>x<span class="token punctuation">,</span>N<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token operator">%</span>信号的Fourier变换
mag<span class="token operator">=</span><span class="token builtin">abs</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">%</span>求取振幅
f<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">:</span>N<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>fs<span class="token operator">/</span>N<span class="token punctuation">;</span> <span class="token operator">%</span>真实频率
subplot<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>plot<span class="token punctuation">(</span>f<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">:</span>N<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>mag<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">:</span>N<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token operator">/</span>N<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">%</span>绘出Nyquist频率之前的振幅
xlabel<span class="token punctuation">(</span><span class="token string">'频率/Hz'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ylabel<span class="token punctuation">(</span><span class="token string">'振幅'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
title<span class="token punctuation">(</span><span class="token string">'Ndata=10240 Nfft=1024'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>grid on<span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/04/28/ebJ5p4Pj_o.png" alt="在这里插入图片描述"><br> 这里仿真显示的频谱图和我们的代码模拟给出的输入信号是相同的所以大致可以按照这个傅里叶变换的标准进行编写代码。之所以这里画出采样的波形图是因为后面我们程序要画波形图，所以这里就测试了下。理想波形的总谐波失真计算没有意义所以就不进行计算。</p> 
<h2><a id="STM32_60"></a>STM32测试程序：</h2> 
<h3><a id="FFTC_61"></a>FFT.C</h3> 
<p>这里的FFT也是找到的别人写好的程序，所以就不做详细讲解了（能力有限）</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"math.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"fft.h"</span></span>
<span class="token comment">//精度0.0001弧度</span>
<span class="token comment">//复数的交换 </span>
<span class="token keyword">void</span> <span class="token function">conjugate_complex</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">,</span>complex in<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>complex out<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>n<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    out<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>imag <span class="token operator">=</span> <span class="token operator">-</span>in<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>imag<span class="token punctuation">;</span>
    out<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>real <span class="token operator">=</span> in<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>real<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>	
<span class="token punctuation">}</span>
<span class="token comment">//求所有复数的模</span>
<span class="token keyword">void</span> <span class="token function">c_abs</span><span class="token punctuation">(</span>complex f<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token keyword">float</span> out<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token keyword">int</span> n<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">float</span> t<span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>n<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    t <span class="token operator">=</span> f<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>real <span class="token operator">*</span> f<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>real <span class="token operator">+</span> f<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>imag <span class="token operator">*</span> f<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>imag<span class="token punctuation">;</span>
    out<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>	
<span class="token punctuation">}</span>
 
<span class="token comment">//求复数的和 </span>
<span class="token keyword">void</span> <span class="token function">c_plus</span><span class="token punctuation">(</span>complex a<span class="token punctuation">,</span>complex b<span class="token punctuation">,</span>complex <span class="token operator">*</span>c<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  c<span class="token operator">-&gt;</span>real <span class="token operator">=</span> a<span class="token punctuation">.</span>real <span class="token operator">+</span> b<span class="token punctuation">.</span>real<span class="token punctuation">;</span>
  c<span class="token operator">-&gt;</span>imag <span class="token operator">=</span> a<span class="token punctuation">.</span>imag <span class="token operator">+</span> b<span class="token punctuation">.</span>imag<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//求复数的差  </span>
<span class="token keyword">void</span> <span class="token function">c_sub</span><span class="token punctuation">(</span>complex a<span class="token punctuation">,</span>complex b<span class="token punctuation">,</span>complex <span class="token operator">*</span>c<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  c<span class="token operator">-&gt;</span>real <span class="token operator">=</span> a<span class="token punctuation">.</span>real <span class="token operator">-</span> b<span class="token punctuation">.</span>real<span class="token punctuation">;</span>
  c<span class="token operator">-&gt;</span>imag <span class="token operator">=</span> a<span class="token punctuation">.</span>imag <span class="token operator">-</span> b<span class="token punctuation">.</span>imag<span class="token punctuation">;</span>	
<span class="token punctuation">}</span>
<span class="token comment">//求复数的积</span>
<span class="token keyword">void</span> <span class="token function">c_mul</span><span class="token punctuation">(</span>complex a<span class="token punctuation">,</span>complex b<span class="token punctuation">,</span>complex <span class="token operator">*</span>c<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  c<span class="token operator">-&gt;</span>real <span class="token operator">=</span> a<span class="token punctuation">.</span>real <span class="token operator">*</span> b<span class="token punctuation">.</span>real <span class="token operator">-</span> a<span class="token punctuation">.</span>imag <span class="token operator">*</span> b<span class="token punctuation">.</span>imag<span class="token punctuation">;</span>
  c<span class="token operator">-&gt;</span>imag <span class="token operator">=</span> a<span class="token punctuation">.</span>real <span class="token operator">*</span> b<span class="token punctuation">.</span>imag <span class="token operator">+</span> a<span class="token punctuation">.</span>imag <span class="token operator">*</span> b<span class="token punctuation">.</span>real<span class="token punctuation">;</span>	
<span class="token punctuation">}</span>
<span class="token comment">//求复数的商 </span>
<span class="token keyword">void</span> <span class="token function">c_div</span><span class="token punctuation">(</span>complex a<span class="token punctuation">,</span>complex b<span class="token punctuation">,</span>complex <span class="token operator">*</span>c<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  c<span class="token operator">-&gt;</span>real <span class="token operator">=</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>real <span class="token operator">*</span> b<span class="token punctuation">.</span>real <span class="token operator">+</span> a<span class="token punctuation">.</span>imag <span class="token operator">*</span> b<span class="token punctuation">.</span>imag<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>real <span class="token operator">*</span> b<span class="token punctuation">.</span>real <span class="token operator">+</span>b<span class="token punctuation">.</span>imag <span class="token operator">*</span> b<span class="token punctuation">.</span>imag<span class="token punctuation">)</span><span class="token punctuation">;</span>
  c<span class="token operator">-&gt;</span>imag <span class="token operator">=</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>imag <span class="token operator">*</span> b<span class="token punctuation">.</span>real <span class="token operator">-</span> a<span class="token punctuation">.</span>real <span class="token operator">*</span> b<span class="token punctuation">.</span>imag<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>real <span class="token operator">*</span> b<span class="token punctuation">.</span>real <span class="token operator">+</span>b<span class="token punctuation">.</span>imag <span class="token operator">*</span> b<span class="token punctuation">.</span>imag<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SWAP</span><span class="token expression"><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span>  tempr<span class="token operator">=</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token operator">=</span>tempr</span></span>
<span class="token keyword">void</span> <span class="token function">Wn_i</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">,</span><span class="token keyword">int</span> i<span class="token punctuation">,</span>complex <span class="token operator">*</span>Wn<span class="token punctuation">,</span><span class="token keyword">char</span> flag<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  Wn<span class="token operator">-&gt;</span>real <span class="token operator">=</span> <span class="token function">cos</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>PI<span class="token operator">*</span>i<span class="token operator">/</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>flag <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
  Wn<span class="token operator">-&gt;</span>imag <span class="token operator">=</span> <span class="token operator">-</span><span class="token function">sin</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>PI<span class="token operator">*</span>i<span class="token operator">/</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>flag <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
  Wn<span class="token operator">-&gt;</span>imag <span class="token operator">=</span> <span class="token operator">-</span><span class="token function">sin</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>PI<span class="token operator">*</span>i<span class="token operator">/</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//傅里叶变化</span>
<span class="token keyword">void</span> <span class="token function">fft</span><span class="token punctuation">(</span><span class="token keyword">int</span> N<span class="token punctuation">,</span>complex f<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  complex t<span class="token punctuation">,</span>wn<span class="token punctuation">;</span><span class="token comment">//中间变量</span>
  <span class="token keyword">int</span> i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">,</span>m<span class="token punctuation">,</span>n<span class="token punctuation">,</span>l<span class="token punctuation">,</span>r<span class="token punctuation">,</span>M<span class="token punctuation">;</span>
  <span class="token keyword">int</span> la<span class="token punctuation">,</span>lb<span class="token punctuation">,</span>lc<span class="token punctuation">;</span>
  <span class="token comment">/*----计算分解的级数M=log2(N)----*/</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span>N<span class="token punctuation">,</span>M<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">(</span>i<span class="token operator">=</span>i<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">1</span><span class="token punctuation">;</span>M<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token comment">/*----按照倒位序重新排列原信号----*/</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>j<span class="token operator">=</span>N<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span>N<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">&lt;</span>j<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      t<span class="token operator">=</span>f<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
      f<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">=</span>f<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      f<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>t<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    k<span class="token operator">=</span>N<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>k<span class="token operator">&lt;=</span>j<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      j<span class="token operator">=</span>j<span class="token operator">-</span>k<span class="token punctuation">;</span>
      k<span class="token operator">=</span>k<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    j<span class="token operator">=</span>j<span class="token operator">+</span>k<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
 
  <span class="token comment">/*----FFT算法----*/</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span>m<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>m<span class="token operator">&lt;=</span>M<span class="token punctuation">;</span>m<span class="token operator">++</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    la<span class="token operator">=</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//la=2^m代表第m级每个分组所含节点数		</span>
    lb<span class="token operator">=</span>la<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>    <span class="token comment">//lb代表第m级每个分组所含碟形单元数</span>
                 <span class="token comment">//同时它也表示每个碟形单元上下节点之间的距离</span>
    <span class="token comment">/*----碟形运算----*/</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>l<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>l<span class="token operator">&lt;=</span>lb<span class="token punctuation">;</span>l<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      r<span class="token operator">=</span><span class="token punctuation">(</span>l<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>M<span class="token operator">-</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>	
      <span class="token keyword">for</span><span class="token punctuation">(</span>n<span class="token operator">=</span>l<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>n<span class="token operator">&lt;</span>N<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>n<span class="token operator">=</span>n<span class="token operator">+</span>la<span class="token punctuation">)</span> <span class="token comment">//遍历每个分组，分组总数为N/la</span>
      <span class="token punctuation">{<!-- --></span>
        lc<span class="token operator">=</span>n<span class="token operator">+</span>lb<span class="token punctuation">;</span>  <span class="token comment">//n,lc分别代表一个碟形单元的上、下节点编号     </span>
        <span class="token function">Wn_i</span><span class="token punctuation">(</span>N<span class="token punctuation">,</span>r<span class="token punctuation">,</span><span class="token operator">&amp;</span>wn<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//wn=Wnr</span>
        <span class="token function">c_mul</span><span class="token punctuation">(</span>f<span class="token punctuation">[</span>lc<span class="token punctuation">]</span><span class="token punctuation">,</span>wn<span class="token punctuation">,</span><span class="token operator">&amp;</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//t = f[lc] * wn复数运算</span>
        <span class="token function">c_sub</span><span class="token punctuation">(</span>f<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">,</span>t<span class="token punctuation">,</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>f<span class="token punctuation">[</span>lc<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//f[lc] = f[n] - f[lc] * Wnr</span>
        <span class="token function">c_plus</span><span class="token punctuation">(</span>f<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">,</span>t<span class="token punctuation">,</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>f<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//f[n] = f[n] + f[lc] * Wnr</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//傅里叶逆变换</span>
<span class="token keyword">void</span> <span class="token function">ifft</span><span class="token punctuation">(</span><span class="token keyword">int</span> N<span class="token punctuation">,</span>complex f<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">conjugate_complex</span><span class="token punctuation">(</span>N<span class="token punctuation">,</span>f<span class="token punctuation">,</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fft</span><span class="token punctuation">(</span>N<span class="token punctuation">,</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">conjugate_complex</span><span class="token punctuation">(</span>N<span class="token punctuation">,</span>f<span class="token punctuation">,</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>N<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    f<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>imag <span class="token operator">=</span> <span class="token punctuation">(</span>f<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>imag<span class="token punctuation">)</span><span class="token operator">/</span>N<span class="token punctuation">;</span>
    f<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>real <span class="token operator">=</span> <span class="token punctuation">(</span>f<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>real<span class="token punctuation">)</span><span class="token operator">/</span>N<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token class-name">compx</span> <span class="token function">EE</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">compx</span> b1<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">compx</span> b2<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">compx</span> b3<span class="token punctuation">;</span>
	b3<span class="token punctuation">.</span>real	<span class="token operator">=</span> b1<span class="token punctuation">.</span>real<span class="token operator">*</span>b2<span class="token punctuation">.</span>real<span class="token operator">-</span>b1<span class="token punctuation">.</span>imag<span class="token operator">*</span>b2<span class="token punctuation">.</span>imag<span class="token punctuation">;</span>
	b3<span class="token punctuation">.</span>imag <span class="token operator">=</span> b1<span class="token punctuation">.</span>real<span class="token operator">*</span>b2<span class="token punctuation">.</span>imag<span class="token operator">+</span>b1<span class="token punctuation">.</span>imag<span class="token operator">*</span>b2<span class="token punctuation">.</span>real<span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span>b3<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">FFT</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">compx</span> <span class="token operator">*</span>xin<span class="token punctuation">,</span><span class="token keyword">int</span> N<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">int</span> f<span class="token punctuation">,</span>m<span class="token punctuation">,</span>LH<span class="token punctuation">,</span>nm<span class="token punctuation">,</span>i<span class="token punctuation">,</span>k<span class="token punctuation">,</span>j<span class="token punctuation">,</span>L<span class="token punctuation">;</span>
<span class="token keyword">double</span> p <span class="token punctuation">,</span> ps <span class="token punctuation">;</span>
<span class="token keyword">int</span> le<span class="token punctuation">,</span>B<span class="token punctuation">,</span>ip<span class="token punctuation">;</span>
<span class="token keyword">float</span> pi<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">compx</span> w<span class="token punctuation">,</span>t<span class="token punctuation">;</span>
LH<span class="token operator">=</span>N<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span> 
f<span class="token operator">=</span>N<span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span>m<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">(</span>f<span class="token operator">=</span>f<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">1</span><span class="token punctuation">;</span>m<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">;</span><span class="token punctuation">}</span>  <span class="token comment">/*2^m=N*/</span>

<span class="token punctuation">{<!-- --></span>
<span class="token keyword">for</span><span class="token punctuation">(</span>L<span class="token operator">=</span>m<span class="token punctuation">;</span>L<span class="token operator">&gt;=</span><span class="token number">1</span><span class="token punctuation">;</span>L<span class="token operator">--</span><span class="token punctuation">)</span>    <span class="token comment">/*这里和时域的也有差别*/</span>
<span class="token punctuation">{<!-- --></span> 
le<span class="token operator">=</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>L<span class="token punctuation">)</span><span class="token punctuation">;</span>
B<span class="token operator">=</span>le<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">/*每一级碟形运算间隔的点数*/</span>
pi<span class="token operator">=</span><span class="token number">3.14159</span><span class="token punctuation">;</span>
 <span class="token keyword">for</span><span class="token punctuation">(</span>j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;=</span>B<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
   p<span class="token operator">=</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>m<span class="token operator">-</span>L<span class="token punctuation">)</span><span class="token operator">*</span>j<span class="token punctuation">;</span>
   ps<span class="token operator">=</span><span class="token number">2</span><span class="token operator">*</span>pi<span class="token operator">/</span>N<span class="token operator">*</span>p<span class="token punctuation">;</span>
   w<span class="token punctuation">.</span>real<span class="token operator">=</span><span class="token function">cos</span><span class="token punctuation">(</span>ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
   w<span class="token punctuation">.</span>imag<span class="token operator">=</span><span class="token operator">-</span><span class="token function">sin</span><span class="token punctuation">(</span>ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span>j<span class="token punctuation">;</span>i<span class="token operator">&lt;=</span>N<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">=</span>i<span class="token operator">+</span>le<span class="token punctuation">)</span>
     <span class="token punctuation">{<!-- --></span>
      ip<span class="token operator">=</span>i<span class="token operator">+</span>B<span class="token punctuation">;</span>  
      t<span class="token operator">=</span>xin<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      xin<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>real<span class="token operator">=</span>xin<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>real<span class="token operator">+</span>xin<span class="token punctuation">[</span>ip<span class="token punctuation">]</span><span class="token punctuation">.</span>real<span class="token punctuation">;</span>
      xin<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>imag<span class="token operator">=</span>xin<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>imag<span class="token operator">+</span>xin<span class="token punctuation">[</span>ip<span class="token punctuation">]</span><span class="token punctuation">.</span>imag<span class="token punctuation">;</span>  
      xin<span class="token punctuation">[</span>ip<span class="token punctuation">]</span><span class="token punctuation">.</span>real<span class="token operator">=</span>xin<span class="token punctuation">[</span>ip<span class="token punctuation">]</span><span class="token punctuation">.</span>real<span class="token operator">-</span>t<span class="token punctuation">.</span>real<span class="token punctuation">;</span>
      xin<span class="token punctuation">[</span>ip<span class="token punctuation">]</span><span class="token punctuation">.</span>imag<span class="token operator">=</span>xin<span class="token punctuation">[</span>ip<span class="token punctuation">]</span><span class="token punctuation">.</span>imag<span class="token operator">-</span>t<span class="token punctuation">.</span>imag<span class="token punctuation">;</span>     
      xin<span class="token punctuation">[</span>ip<span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">EE</span><span class="token punctuation">(</span>xin<span class="token punctuation">[</span>ip<span class="token punctuation">]</span><span class="token punctuation">,</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/*变址运算*/</span>

nm<span class="token operator">=</span>N<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>   
j<span class="token operator">=</span>N<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span>nm<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">&lt;</span>j<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>t<span class="token operator">=</span>xin<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>xin<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">=</span>xin<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>xin<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>t<span class="token punctuation">;</span><span class="token punctuation">}</span>
k<span class="token operator">=</span>LH<span class="token punctuation">;</span>
<span class="token keyword">while</span><span class="token punctuation">(</span>j<span class="token operator">&gt;=</span>k<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>j<span class="token operator">=</span>j<span class="token operator">-</span>k<span class="token punctuation">;</span>k<span class="token operator">=</span>k<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
j<span class="token operator">=</span>j<span class="token operator">+</span>k<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre> 
<h3><a id="FFTH_243"></a>FFT.H</h3> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__FFT_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__FFT_H__</span></span>
 
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">complex</span> <span class="token comment">//复数类型</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">float</span> real<span class="token punctuation">;</span>		<span class="token comment">//实部</span>
  <span class="token keyword">float</span> imag<span class="token punctuation">;</span>		<span class="token comment">//虚部</span>
<span class="token punctuation">}</span>complex<span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">compx</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">double</span> real<span class="token punctuation">;</span>
	<span class="token keyword">double</span> imag<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PI</span> <span class="token expression"><span class="token number">3.1415926535897932384626433832795028841971</span></span></span>
<span class="token comment">///</span>
<span class="token keyword">void</span> <span class="token function">conjugate_complex</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">,</span>complex in<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>complex out<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">c_plus</span><span class="token punctuation">(</span>complex a<span class="token punctuation">,</span>complex b<span class="token punctuation">,</span>complex <span class="token operator">*</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//复数加</span>
<span class="token keyword">void</span> <span class="token function">c_mul</span><span class="token punctuation">(</span>complex a<span class="token punctuation">,</span>complex b<span class="token punctuation">,</span>complex <span class="token operator">*</span>c<span class="token punctuation">)</span> <span class="token punctuation">;</span><span class="token comment">//复数乘</span>
<span class="token keyword">void</span> <span class="token function">c_sub</span><span class="token punctuation">(</span>complex a<span class="token punctuation">,</span>complex b<span class="token punctuation">,</span>complex <span class="token operator">*</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//复数减法</span>
<span class="token keyword">void</span> <span class="token function">c_div</span><span class="token punctuation">(</span>complex a<span class="token punctuation">,</span>complex b<span class="token punctuation">,</span>complex <span class="token operator">*</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//复数除法</span>
<span class="token keyword">void</span> <span class="token function">fft</span><span class="token punctuation">(</span><span class="token keyword">int</span> N<span class="token punctuation">,</span>complex f<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//傅立叶变换 输出也存在数组f中</span>
<span class="token keyword">void</span> <span class="token function">ifft</span><span class="token punctuation">(</span><span class="token keyword">int</span> N<span class="token punctuation">,</span>complex f<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 傅里叶逆变换</span>
<span class="token keyword">void</span> <span class="token function">c_abs</span><span class="token punctuation">(</span>complex f<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token keyword">float</span> out<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token keyword">int</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//复数数组取模</span>
 <span class="token keyword">void</span> <span class="token function">FFT</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">compx</span> <span class="token operator">*</span>xin<span class="token punctuation">,</span><span class="token keyword">int</span> N<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> 
<h3><a id="mainc_275"></a>main.c</h3> 
<p>程序是根据网上的程序更改参考的，用的是别人自己写的FFT，把两个人写的放到了一起，大家可以根据需要自己选择如何调用，后面会更新使用官方库版本的FFT的代码版本。串口部分就使用串口1就行，如果是正点的板子程序改写是默认打开了串口1的。</p> 
<pre><code class="prism language-c"><span class="token comment">/* Includes ------------------------------------------------------------------*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"main.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"usart.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"fft.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;math.h&gt;</span></span>
<span class="token comment">/* Private typedef -----------------------------------------------------------*/</span>
<span class="token comment">/* Private define ------------------------------------------------------------*/</span>
<span class="token comment">/* Private macro -------------------------------------------------------------*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name">N</span>    <span class="token expression"><span class="token number">1024</span>          </span><span class="token comment">//采样点数</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name">Fs</span>   <span class="token expression"><span class="token number">10240</span>        </span><span class="token comment">//采样频率</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name">F</span>    <span class="token expression"><span class="token number">10</span>          </span><span class="token comment">//分辨率</span></span>
<span class="token comment">/* Private variables ---------------------------------------------------------*/</span>
<span class="token comment">/* Private function prototypes -----------------------------------------------*/</span>
<span class="token comment">/* Private functions ---------------------------------------------------------*/</span>
<span class="token comment">//FFT测试数据集 输入数组</span>
complex  FFT_256PointIn<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">//FFT测试数据集 输出数组</span>
<span class="token keyword">float</span>   FFT_256PointOut<span class="token punctuation">[</span>N<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>										
<span class="token comment">//填入数组			</span>
<span class="token keyword">double</span> result<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">compx</span> s<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">InitBufInArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
 <span class="token keyword">unsigned</span> <span class="token keyword">short</span> i<span class="token punctuation">;</span>
 <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>    
	<span class="token punctuation">{<!-- --></span>
       FFT_256PointIn<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>real  <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">*</span> <span class="token function">sin</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>PI <span class="token operator">*</span> i <span class="token operator">*</span> <span class="token number">1000.0</span> <span class="token operator">/</span> Fs<span class="token punctuation">)</span> 
		                             <span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
		   FFT_256PointIn<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>imag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>	
<span class="token punctuation">}</span>
 
<span class="token comment">/******************************************************************
函数名称:GetPowerMag()
函数功能:计算各次谐波幅值
参数说明:
备　　注:先将FFT_256PointIn分解成实部(X)和虚部(Y)，
         然后计算幅值:(sqrt(X*X+Y*Y)*2/N
         然后计算相位:atan2(Y/X)
*******************************************************************/</span>
<span class="token keyword">void</span> <span class="token function">GetPowerMag</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> i<span class="token punctuation">;</span>
	  <span class="token keyword">float</span>  X<span class="token punctuation">,</span>Y<span class="token punctuation">,</span>P<span class="token punctuation">,</span>Mag<span class="token punctuation">;</span>
	 	<span class="token function">c_abs</span><span class="token punctuation">(</span>FFT_256PointIn<span class="token punctuation">,</span>FFT_256PointOut<span class="token punctuation">,</span>N<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>N<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
			  X <span class="token operator">=</span> FFT_256PointIn<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>real<span class="token operator">/</span>N<span class="token punctuation">;</span>    <span class="token comment">//计算实部</span>
			  Y <span class="token operator">=</span> FFT_256PointIn<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>imag<span class="token operator">/</span>N<span class="token punctuation">;</span>    <span class="token comment">//计算虚部</span>
			  Mag <span class="token operator">=</span> FFT_256PointOut<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">*</span><span class="token number">2</span><span class="token operator">/</span>N<span class="token punctuation">;</span>    <span class="token comment">//计算幅值</span>
			  P <span class="token operator">=</span> <span class="token function">atan2</span><span class="token punctuation">(</span>Y<span class="token punctuation">,</span>X<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">180</span><span class="token operator">/</span>PI<span class="token punctuation">;</span>           <span class="token comment">//计算相位</span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d      "</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d      "</span><span class="token punctuation">,</span>F<span class="token operator">*</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> 
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%f      \r\n"</span><span class="token punctuation">,</span>Mag<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//			  printf("%f      ",P);</span>
<span class="token comment">//				printf("%f      ",X);</span>
<span class="token comment">//				printf("%f      \r\n",Y);			</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">dsp_g2_test</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  u16 i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>N<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>real <span class="token operator">=</span> <span class="token number">32000</span> <span class="token operator">*</span> <span class="token function">sin</span><span class="token punctuation">(</span>PI<span class="token operator">*</span><span class="token number">2</span><span class="token operator">*</span>i<span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">50.0f</span><span class="token operator">/</span>Fs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>real<span class="token operator">+=</span> <span class="token number">16000</span> <span class="token operator">*</span> <span class="token function">sin</span><span class="token punctuation">(</span>PI<span class="token operator">*</span><span class="token number">2</span><span class="token operator">*</span>i<span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">550.0f</span><span class="token operator">/</span>Fs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>real<span class="token operator">+=</span> <span class="token number">9000</span> <span class="token operator">*</span> <span class="token function">sin</span><span class="token punctuation">(</span>PI<span class="token operator">*</span><span class="token number">2</span><span class="token operator">*</span>i<span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">1150.0f</span><span class="token operator">/</span>Fs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>real<span class="token operator">+=</span> <span class="token number">6000</span> <span class="token operator">*</span> <span class="token function">sin</span><span class="token punctuation">(</span>PI<span class="token operator">*</span><span class="token number">2</span><span class="token operator">*</span>i<span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">2100.0f</span><span class="token operator">/</span>Fs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>real<span class="token operator">+=</span> <span class="token number">4000</span> <span class="token operator">*</span> <span class="token function">sin</span><span class="token punctuation">(</span>PI<span class="token operator">*</span><span class="token number">2</span><span class="token operator">*</span>i<span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">5000.0f</span><span class="token operator">/</span>Fs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>imag<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">FFT</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span>N<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>N<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
			result<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>real <span class="token operator">*</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>real <span class="token operator">+</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>imag <span class="token operator">*</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>imag<span class="token punctuation">)</span><span class="token operator">/</span>N<span class="token punctuation">;</span>
		<span class="token keyword">else</span>
			result<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>real <span class="token operator">*</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>real <span class="token operator">+</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>imag <span class="token operator">*</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>imag<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token operator">/</span>N<span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d      "</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d      "</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token operator">*</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%f      \r\n"</span><span class="token punctuation">,</span>result<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//if(result[i] &gt; 10)</span>
    <span class="token comment">//printf("%4d,%4d,%ld\n",i,(u16)((double)i*Fs/NPT),(u32)result[i]);</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
  * @brief  串口打印输出
  * @param  None
  * @retval None
  */</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> i<span class="token punctuation">,</span>t<span class="token punctuation">;</span>
	<span class="token function">SystemInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//系统时钟初始化</span>
	<span class="token function">USART_Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//串口1初始化</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"这是一个FFT 测试实验\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  <span class="token function">InitBufInArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token function">fft</span><span class="token punctuation">(</span>N<span class="token punctuation">,</span>FFT_256PointIn<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"点数   频率  幅值   实部  虚部\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token comment">//GetPowerMag();</span>
	<span class="token function">dsp_g2_test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">//检查接收数据完成标志位是否置位	</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">USART_GetFlagStatus</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span> USART_IT_RXNE<span class="token punctuation">)</span> <span class="token operator">!=</span> RESET<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
		<span class="token comment">//将接收到的数据发送出去，对USART_DR的读操作可以将USART_IT_RXNE清零。</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%c"</span><span class="token punctuation">,</span><span class="token function">USART_ReceiveData</span><span class="token punctuation">(</span>USART1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/*********************************END OF FILE**********************************/</span>

</code></pre> 
<p>串口的截图结果是正确的。<br> <img src="https://images2.imgbox.com/2c/10/7X4zP5Mi_o.png" alt="在这里插入图片描述"><br> 免费开源，大家参考，不通过csdn骗积分了，如果有点收获希望能给个关注和点赞。<br> <a href="https://gitee.com/Williamwxh/question-2020-e" rel="nofollow">工程链接</a></p> 
<p><img src="https://images2.imgbox.com/48/76/xWEcBKVP_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e103388b2324a1f7261ad522bfc7496c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">[Linux](2)快速入门Linux基础指令</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a05f581741470a9b2e3564d4d88e9060/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">007-Idea-常用设置</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>