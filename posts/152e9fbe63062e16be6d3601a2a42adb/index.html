<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>linux的C/C&#43;&#43;线程池（VS2019开发） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="linux的C/C&#43;&#43;线程池（VS2019开发）" />
<meta property="og:description" content="文章目录 一、准备工作二、C语言threadpool实现三、C&#43;&#43; 11标准实现 代码看视频敲的，非原创 一、准备工作 创建项目
连接linux虚拟机
启动测试：VS2019运行Linux程序报错：无法启动gdb。系统中缺少gdb。sudo yum install -y gdb
线程池的组成主要分为3个部分，这三部分配合工作就可以得到一个完整的线程池：
任务队列，存储需要处理的任务，由工作的线程来处理这些任务
通过线程池提供的API函数，将一个待处理的任务添加到任务队列，或者从任务队列中删除
已处理的任务会被从任务队列中删除
线程池的使用者，也就是调用线程池函数往任务队列中添加任务的线程就是生产者线程工作的线程（任务队列任务的消费者） ，N个
线程池中维护了一定数量的工作线程, 他们的作用是是不停的读任务队列, 从里边取出任务并处理
工作的线程相当于是任务队列的消费者角色，
如果任务队列为空, 工作的线程将会被阻塞 (使用条件变量/信号量阻塞)
如果阻塞之后有了新的任务, 由生产者将阻塞解除, 工作线程开始工作管理者线程（不处理任务队列中的任务），1个
它的任务是周期性的对任务队列中的任务数量以及处于忙状态的工作线程个数进行检测
当任务过多的时候, 可以适当的创建一些新的工作线程
当任务过少的时候, 可以适当的销毁一些工作的线程 二、C语言threadpool实现 threadpool.h
#pragma once #ifndef _THREADPOOL_H #define _THREADPOOL_H #include &lt;pthread.h&gt; #include &lt;stdlib.h&gt; #include &lt;stdio.h&gt; #include &lt;string.h&gt; #include &lt;unistd.h&gt; // 任务结构体 typedef struct Task { void (*function)(void* arg); void* arg; }Task; // 线程池结构体 typedef struct ThreadPool { // 任务队列 Task* taskQ; int queueCapacity; // 容量 int queueSize; // 当前任务个数 int queueFront; // 队头 -&gt; 取数据 int queueRear; // 队尾 -&gt; 放数据 pthread_t managerID; // 管理者线程ID pthread_t* threadIDs; // 工作的线程ID int minNum; // 最小线程数量 int maxNum; // 最大线程数量 int busyNum; // 忙的线程的个数 int liveNum; // 存活的线程的个数 int exitNum; // 要销毁的线程个数 pthread_mutex_t mutexPool; // 锁整个的线程池 pthread_mutex_t mutexBusy; // 锁busyNum变量 pthread_cond_t notFull; // 任务队列是不是满了 pthread_cond_t notEmpty; // 任务队列是不是空了 int shutdown; // 是不是要销毁线程池, 销毁为1, 不销毁为0 }ThreadPool; // 创建线程池并初始化 ThreadPool* threadPoolCreate(int min, int max, int queueSize); // 销毁线程池 int threadPoolDestroy(ThreadPool* pool); // 给线程池添加任务 void threadPoolAdd(ThreadPool* pool, void(*func)(void*), void* arg); // 获取线程池中工作的线程的个数 int threadPoolBusyNum(ThreadPool* pool); // 获取线程池中活着的线程的个数 int threadPoolAliveNum(ThreadPool* pool); // // 工作的线程(消费者线程)任务函数 void* worker(void* arg); // 管理者线程任务函数 void* manager(void* arg); // 单个线程退出 void threadExit(ThreadPool* pool); #endif // _THREADPOOL_H threadpool." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/152e9fbe63062e16be6d3601a2a42adb/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-27T11:25:01+08:00" />
<meta property="article:modified_time" content="2023-07-27T11:25:01+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">linux的C/C&#43;&#43;线程池（VS2019开发）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><ul><li><a href="#_2" rel="nofollow">一、准备工作</a></li><li><a href="#Cthreadpool_27" rel="nofollow">二、C语言threadpool实现</a></li><li><a href="#C_11_424" rel="nofollow">三、C++ 11标准实现</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<br> 代码看视频敲的，非原创 
<p></p> 
<h4><a id="_2"></a>一、准备工作</h4> 
<p>创建项目<br> <img src="https://images2.imgbox.com/a6/88/NBnomklk_o.png" alt="在这里插入图片描述"><br> 连接linux虚拟机<br> <img src="https://images2.imgbox.com/92/85/fuXs9fiG_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/6d/31/bIRcja6c_o.png" alt="在这里插入图片描述"><br> 启动测试：VS2019运行Linux程序报错：无法启动gdb。系统中缺少gdb。<code>sudo yum install -y gdb</code></p> 
<p>线程池的组成主要分为3个部分，这三部分配合工作就可以得到一个完整的线程池：</p> 
<ol><li><font color="Blue">任务队列，存储需要处理的任务，由工作的线程来处理这些任务</font><br> 通过线程池提供的API函数，将一个待处理的任务添加到任务队列，或者从任务队列中删除<br> 已处理的任务会被从任务队列中删除<br> 线程池的使用者，也就是调用线程池函数往任务队列中添加任务的线程就是生产者线程</li><li><font color="Blue">工作的线程（任务队列任务的消费者） ，N个</font><br> 线程池中维护了一定数量的工作线程, 他们的作用是是不停的读任务队列, 从里边取出任务并处理<br> 工作的线程相当于是任务队列的消费者角色，<br> 如果任务队列为空, 工作的线程将会被阻塞 (使用条件变量/信号量阻塞)<br> 如果阻塞之后有了新的任务, 由生产者将阻塞解除, 工作线程开始工作</li><li><font color="Blue">管理者线程（不处理任务队列中的任务），1个</font><br> 它的任务是周期性的对任务队列中的任务数量以及处于忙状态的工作线程个数进行检测<br> 当任务过多的时候, 可以适当的创建一些新的工作线程<br> 当任务过少的时候, 可以适当的销毁一些工作的线程</li></ol> 
<h4><a id="Cthreadpool_27"></a>二、C语言threadpool实现</h4> 
<p><img src="https://images2.imgbox.com/90/fd/Kc7SNEzY_o.png" alt="在这里插入图片描述"></p> 
<p>threadpool.h</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_THREADPOOL_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_THREADPOOL_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>




<span class="token comment">// 任务结构体</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">Task</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>function<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">;</span>
<span class="token punctuation">}</span>Task<span class="token punctuation">;</span>


<span class="token comment">// 线程池结构体</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">ThreadPool</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 任务队列</span>
	Task<span class="token operator">*</span> taskQ<span class="token punctuation">;</span>
	<span class="token keyword">int</span> queueCapacity<span class="token punctuation">;</span>  <span class="token comment">// 容量</span>
	<span class="token keyword">int</span> queueSize<span class="token punctuation">;</span>      <span class="token comment">// 当前任务个数</span>
	<span class="token keyword">int</span> queueFront<span class="token punctuation">;</span>     <span class="token comment">// 队头 -&gt; 取数据</span>
	<span class="token keyword">int</span> queueRear<span class="token punctuation">;</span>      <span class="token comment">// 队尾 -&gt; 放数据</span>

	<span class="token class-name">pthread_t</span> managerID<span class="token punctuation">;</span>    <span class="token comment">// 管理者线程ID</span>
	<span class="token class-name">pthread_t</span><span class="token operator">*</span> threadIDs<span class="token punctuation">;</span>   <span class="token comment">// 工作的线程ID</span>
	<span class="token keyword">int</span> minNum<span class="token punctuation">;</span>             <span class="token comment">// 最小线程数量</span>
	<span class="token keyword">int</span> maxNum<span class="token punctuation">;</span>             <span class="token comment">// 最大线程数量</span>
	<span class="token keyword">int</span> busyNum<span class="token punctuation">;</span>            <span class="token comment">// 忙的线程的个数</span>
	<span class="token keyword">int</span> liveNum<span class="token punctuation">;</span>            <span class="token comment">// 存活的线程的个数</span>
	<span class="token keyword">int</span> exitNum<span class="token punctuation">;</span>            <span class="token comment">// 要销毁的线程个数</span>
	<span class="token class-name">pthread_mutex_t</span> mutexPool<span class="token punctuation">;</span>  <span class="token comment">// 锁整个的线程池</span>
	<span class="token class-name">pthread_mutex_t</span> mutexBusy<span class="token punctuation">;</span>  <span class="token comment">// 锁busyNum变量</span>
	<span class="token class-name">pthread_cond_t</span> notFull<span class="token punctuation">;</span>     <span class="token comment">// 任务队列是不是满了</span>
	<span class="token class-name">pthread_cond_t</span> notEmpty<span class="token punctuation">;</span>    <span class="token comment">// 任务队列是不是空了</span>

	<span class="token keyword">int</span> shutdown<span class="token punctuation">;</span>           <span class="token comment">// 是不是要销毁线程池, 销毁为1, 不销毁为0</span>
<span class="token punctuation">}</span>ThreadPool<span class="token punctuation">;</span>



<span class="token comment">// 创建线程池并初始化</span>
ThreadPool<span class="token operator">*</span> <span class="token function">threadPoolCreate</span><span class="token punctuation">(</span><span class="token keyword">int</span> min<span class="token punctuation">,</span> <span class="token keyword">int</span> max<span class="token punctuation">,</span> <span class="token keyword">int</span> queueSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 销毁线程池</span>
<span class="token keyword">int</span> <span class="token function">threadPoolDestroy</span><span class="token punctuation">(</span>ThreadPool<span class="token operator">*</span> pool<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 给线程池添加任务</span>
<span class="token keyword">void</span> <span class="token function">threadPoolAdd</span><span class="token punctuation">(</span>ThreadPool<span class="token operator">*</span> pool<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">*</span>func<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 获取线程池中工作的线程的个数</span>
<span class="token keyword">int</span> <span class="token function">threadPoolBusyNum</span><span class="token punctuation">(</span>ThreadPool<span class="token operator">*</span> pool<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 获取线程池中活着的线程的个数</span>
<span class="token keyword">int</span> <span class="token function">threadPoolAliveNum</span><span class="token punctuation">(</span>ThreadPool<span class="token operator">*</span> pool<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//</span>
<span class="token comment">// 工作的线程(消费者线程)任务函数</span>
<span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">worker</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 管理者线程任务函数</span>
<span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">manager</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 单个线程退出</span>
<span class="token keyword">void</span> <span class="token function">threadExit</span><span class="token punctuation">(</span>ThreadPool<span class="token operator">*</span> pool<span class="token punctuation">)</span><span class="token punctuation">;</span>



<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>  <span class="token comment">// _THREADPOOL_H</span></span>
</code></pre> 
<p>threadpool.c</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"threadpool.h"</span></span>

<span class="token keyword">const</span> <span class="token keyword">int</span> NUMBER <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

ThreadPool<span class="token operator">*</span> <span class="token function">threadPoolCreate</span><span class="token punctuation">(</span><span class="token keyword">int</span> min<span class="token punctuation">,</span> <span class="token keyword">int</span> max<span class="token punctuation">,</span> <span class="token keyword">int</span> queueSize<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	ThreadPool<span class="token operator">*</span> pool <span class="token operator">=</span> <span class="token punctuation">(</span>ThreadPool<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>ThreadPool<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">do</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>pool <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"malloc threadpool failed...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		pool<span class="token operator">-&gt;</span>threadIDs <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">pthread_t</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">pthread_t</span><span class="token punctuation">)</span> <span class="token operator">*</span> max<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>pool<span class="token operator">-&gt;</span>threadIDs <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"malloc threadIDs failed...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">memset</span><span class="token punctuation">(</span>pool<span class="token operator">-&gt;</span>threadIDs<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">pthread_t</span><span class="token punctuation">)</span> <span class="token operator">*</span> max<span class="token punctuation">)</span><span class="token punctuation">;</span>
		pool<span class="token operator">-&gt;</span>minNum <span class="token operator">=</span> min<span class="token punctuation">;</span>
		pool<span class="token operator">-&gt;</span>maxNum <span class="token operator">=</span> max<span class="token punctuation">;</span>
		pool<span class="token operator">-&gt;</span>busyNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		pool<span class="token operator">-&gt;</span>liveNum <span class="token operator">=</span> min<span class="token punctuation">;</span>    <span class="token comment">// 和最小个数相等</span>
		pool<span class="token operator">-&gt;</span>exitNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>mutexPool<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span>
			<span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>mutexBusy<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span>
			<span class="token function">pthread_cond_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>notEmpty<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span>
			<span class="token function">pthread_cond_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>notFull<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"mutex or condition init fail...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 任务队列</span>
		pool<span class="token operator">-&gt;</span>taskQ <span class="token operator">=</span> <span class="token punctuation">(</span>Task<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>Task<span class="token punctuation">)</span> <span class="token operator">*</span> queueSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
		pool<span class="token operator">-&gt;</span>queueCapacity <span class="token operator">=</span> queueSize<span class="token punctuation">;</span>
		pool<span class="token operator">-&gt;</span>queueSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		pool<span class="token operator">-&gt;</span>queueFront <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		pool<span class="token operator">-&gt;</span>queueRear <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		pool<span class="token operator">-&gt;</span>shutdown <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

		<span class="token comment">// 创建线程</span>
		<span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>managerID<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> manager<span class="token punctuation">,</span> pool<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> min<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>threadIDs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> worker<span class="token punctuation">,</span> pool<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> pool<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//释放资源</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>pool <span class="token operator">&amp;&amp;</span> pool<span class="token operator">-&gt;</span>threadIDs<span class="token punctuation">)</span> <span class="token function">free</span><span class="token punctuation">(</span>pool<span class="token operator">-&gt;</span>threadIDs<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>pool <span class="token operator">&amp;&amp;</span> pool<span class="token operator">-&gt;</span>taskQ<span class="token punctuation">)</span> <span class="token function">free</span><span class="token punctuation">(</span>pool<span class="token operator">-&gt;</span>taskQ<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>pool<span class="token punctuation">)</span> <span class="token function">free</span><span class="token punctuation">(</span>pool<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">int</span> <span class="token function">threadPoolDestroy</span><span class="token punctuation">(</span>ThreadPool<span class="token operator">*</span> pool<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>pool <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//关闭线程池</span>
	pool<span class="token operator">-&gt;</span>shutdown <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

	<span class="token comment">//阻塞回收管理者线程</span>
	<span class="token function">pthread_join</span><span class="token punctuation">(</span>pool<span class="token operator">-&gt;</span>managerID<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//唤醒阻塞消费者线程</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pool<span class="token operator">-&gt;</span>liveNum<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">pthread_cond_signal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>notEmpty<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//释放申请的堆内存</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>pool<span class="token operator">-&gt;</span>taskQ<span class="token punctuation">)</span> <span class="token function">free</span><span class="token punctuation">(</span>pool<span class="token operator">-&gt;</span>taskQ<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>pool<span class="token operator">-&gt;</span>threadIDs<span class="token punctuation">)</span> <span class="token function">free</span><span class="token punctuation">(</span>pool<span class="token operator">-&gt;</span>threadIDs<span class="token punctuation">)</span><span class="token punctuation">;</span>


	<span class="token comment">//释放互斥锁</span>
	<span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>mutexBusy<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>mutexPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>notEmpty<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>notFull<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">free</span><span class="token punctuation">(</span>pool<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span> <span class="token function">threadPoolAdd</span><span class="token punctuation">(</span>ThreadPool<span class="token operator">*</span> pool<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">*</span>func<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>mutexPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span>pool<span class="token operator">-&gt;</span>queueSize <span class="token operator">==</span> pool<span class="token operator">-&gt;</span>queueCapacity <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>pool<span class="token operator">-&gt;</span>shutdown<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">//阻塞生产者线程</span>
		<span class="token function">pthread_cond_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>notFull<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>mutexPool<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>pool<span class="token operator">-&gt;</span>shutdown<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>mutexPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//添加任务到队尾</span>
	pool<span class="token operator">-&gt;</span>taskQ<span class="token punctuation">[</span>pool<span class="token operator">-&gt;</span>queueRear<span class="token punctuation">]</span><span class="token punctuation">.</span>function <span class="token operator">=</span> func<span class="token punctuation">;</span>
	pool<span class="token operator">-&gt;</span>taskQ<span class="token punctuation">[</span>pool<span class="token operator">-&gt;</span>queueRear<span class="token punctuation">]</span><span class="token punctuation">.</span>arg <span class="token operator">=</span> arg<span class="token punctuation">;</span>
	pool<span class="token operator">-&gt;</span>queueRear <span class="token operator">=</span> <span class="token punctuation">(</span>pool<span class="token operator">-&gt;</span>queueRear <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> pool<span class="token operator">-&gt;</span>queueCapacity<span class="token punctuation">;</span>
	pool<span class="token operator">-&gt;</span>queueSize<span class="token operator">++</span><span class="token punctuation">;</span>

	<span class="token function">pthread_cond_signal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>notEmpty<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>mutexPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">int</span> <span class="token function">threadPoolBusyNum</span><span class="token punctuation">(</span>ThreadPool<span class="token operator">*</span> pool<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>mutexBusy<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> busyNum <span class="token operator">=</span> pool<span class="token operator">-&gt;</span>busyNum<span class="token punctuation">;</span>
	<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>mutexBusy<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> busyNum<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">int</span> <span class="token function">threadPoolAliveNum</span><span class="token punctuation">(</span>ThreadPool<span class="token operator">*</span> pool<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>mutexPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> Alive <span class="token operator">=</span> pool<span class="token operator">-&gt;</span>liveNum<span class="token punctuation">;</span>
	<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>mutexPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> Alive<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">worker</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	ThreadPool<span class="token operator">*</span> pool <span class="token operator">=</span> <span class="token punctuation">(</span>ThreadPool<span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>mutexPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//当前任务队列是否为空</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span>pool<span class="token operator">-&gt;</span>queueSize <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>pool<span class="token operator">-&gt;</span>shutdown<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token comment">//阻塞工作线程</span>
			<span class="token function">pthread_cond_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>notEmpty<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>mutexPool<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">//判断是不是要销毁线程</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>pool<span class="token operator">-&gt;</span>exitNum <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				pool<span class="token operator">-&gt;</span>exitNum<span class="token operator">--</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>pool<span class="token operator">-&gt;</span>liveNum <span class="token operator">&gt;</span> pool<span class="token operator">-&gt;</span>minNum<span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>
					pool<span class="token operator">-&gt;</span>liveNum<span class="token operator">--</span><span class="token punctuation">;</span>
					<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>mutexPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">threadExit</span><span class="token punctuation">(</span>pool<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token comment">//判断当前线程是否被关闭了</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>pool<span class="token operator">-&gt;</span>shutdown<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>mutexPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">threadExit</span><span class="token punctuation">(</span>pool<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">//从任务队列中取出一个任务</span>
		Task task<span class="token punctuation">;</span>
		task<span class="token punctuation">.</span>function <span class="token operator">=</span> pool<span class="token operator">-&gt;</span>taskQ<span class="token punctuation">[</span>pool<span class="token operator">-&gt;</span>queueFront<span class="token punctuation">]</span><span class="token punctuation">.</span>function<span class="token punctuation">;</span>
		task<span class="token punctuation">.</span>arg <span class="token operator">=</span> pool<span class="token operator">-&gt;</span>taskQ<span class="token punctuation">[</span>pool<span class="token operator">-&gt;</span>queueFront<span class="token punctuation">]</span><span class="token punctuation">.</span>arg<span class="token punctuation">;</span>
		<span class="token comment">//移动头部指针指向下一个节点</span>
		pool<span class="token operator">-&gt;</span>queueFront <span class="token operator">=</span> <span class="token punctuation">(</span>pool<span class="token operator">-&gt;</span>queueFront <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> pool<span class="token operator">-&gt;</span>queueCapacity<span class="token punctuation">;</span>
		pool<span class="token operator">-&gt;</span>queueSize<span class="token operator">--</span><span class="token punctuation">;</span>

		<span class="token comment">//唤醒生产者</span>
		<span class="token function">pthread_cond_signal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>notFull<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>mutexPool<span class="token punctuation">)</span><span class="token punctuation">;</span>


		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"thread %ld start working...\n"</span><span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>mutexBusy<span class="token punctuation">)</span><span class="token punctuation">;</span>
		pool<span class="token operator">-&gt;</span>busyNum<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>mutexBusy<span class="token punctuation">)</span><span class="token punctuation">;</span>
		task<span class="token punctuation">.</span><span class="token function">function</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">free</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
		task<span class="token punctuation">.</span>arg <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"thread %ld end worked...\n"</span><span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>mutexBusy<span class="token punctuation">)</span><span class="token punctuation">;</span>
		pool<span class="token operator">-&gt;</span>busyNum<span class="token operator">--</span><span class="token punctuation">;</span>
		<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>mutexBusy<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">manager</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	ThreadPool<span class="token operator">*</span> pool <span class="token operator">=</span> <span class="token punctuation">(</span>ThreadPool<span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>pool<span class="token operator">-&gt;</span>shutdown<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">//每3s检测一次</span>
		<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">//取出线程池中任务的数量和当前线程的个数</span>
		<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>mutexPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> queueSize <span class="token operator">=</span> pool<span class="token operator">-&gt;</span>queueSize<span class="token punctuation">;</span>
		<span class="token keyword">int</span> liveNum <span class="token operator">=</span> pool<span class="token operator">-&gt;</span>liveNum<span class="token punctuation">;</span>
		<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>mutexPool<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">//取出线程池中忙碌线程的个数</span>
		<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>mutexBusy<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> busyNum <span class="token operator">=</span> pool<span class="token operator">-&gt;</span>busyNum<span class="token punctuation">;</span>
		<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>mutexBusy<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token comment">// 添加线程（当前任务个数&gt;存活线程个数 &amp;&amp; 存活线程个数&lt; 最大线程数）</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>queueSize <span class="token operator">&gt;</span> liveNum <span class="token operator">&amp;&amp;</span> liveNum <span class="token operator">&lt;</span> pool<span class="token operator">-&gt;</span>maxNum<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>mutexPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">int</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pool<span class="token operator">-&gt;</span>maxNum 
				<span class="token operator">&amp;&amp;</span> counter <span class="token operator">&lt;</span> NUMBER
				<span class="token operator">&amp;&amp;</span> pool<span class="token operator">-&gt;</span>liveNum <span class="token operator">&lt;</span> pool<span class="token operator">-&gt;</span>maxNum<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> 
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>pool<span class="token operator">-&gt;</span>threadIDs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>threadIDs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> worker<span class="token punctuation">,</span> pool<span class="token punctuation">)</span><span class="token punctuation">;</span>
					counter<span class="token operator">++</span><span class="token punctuation">;</span>
					pool<span class="token operator">-&gt;</span>liveNum<span class="token operator">++</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>mutexPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
		<span class="token comment">// 销毁线程（忙的线程*2 &lt; 存活的线程数 &amp;&amp; 存活的线程数 &gt; 最小的线程数）</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>busyNum <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">&lt;</span> liveNum <span class="token operator">&amp;&amp;</span> liveNum <span class="token operator">&gt;</span> pool<span class="token operator">-&gt;</span>minNum<span class="token punctuation">)</span> 
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>mutexPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
			pool<span class="token operator">-&gt;</span>exitNum <span class="token operator">=</span> NUMBER<span class="token punctuation">;</span>
			<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>mutexPool<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">//让工作线程自杀</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NUMBER<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> 
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">pthread_cond_signal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pool<span class="token operator">-&gt;</span>notEmpty<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span> <span class="token function">threadExit</span><span class="token punctuation">(</span>ThreadPool<span class="token operator">*</span> pool<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token class-name">pthread_t</span> tid <span class="token operator">=</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pool<span class="token operator">-&gt;</span>maxNum<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>pool<span class="token operator">-&gt;</span>threadIDs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> tid<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			pool<span class="token operator">-&gt;</span>threadIDs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"threadExit  %ld exiting..."</span><span class="token punctuation">,</span> tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>main.c</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"threadpool.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>



<span class="token keyword">void</span> <span class="token function">taskFunc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"thread %ld is working, number = %d\n"</span><span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s 向你问好！\n"</span><span class="token punctuation">,</span> <span class="token string">"windows to linux"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


	<span class="token comment">// 创建线程池</span>
	ThreadPool<span class="token operator">*</span> pool <span class="token operator">=</span> <span class="token function">threadPoolCreate</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">int</span><span class="token operator">*</span> num <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token operator">*</span>num <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">100</span><span class="token punctuation">;</span>
		<span class="token function">threadPoolAdd</span><span class="token punctuation">(</span>pool<span class="token punctuation">,</span> taskFunc<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">threadPoolDestroy</span><span class="token punctuation">(</span>pool<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/c6/f3/n4iur9uZ_o.png" alt="在这里插入图片描述"><br> https://gitee.com/lc123/thread-pool</p> 
<h4><a id="C_11_424"></a>三、C++ 11标准实现</h4> 
<p>三个文件：TaskQueue.hpp， ThreadPool.hpp， main.cpp<br> <code>TaskQueue.hpp</code></p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;queue&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;mutex&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;functional&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>



<span class="token keyword">typedef</span> function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> callback<span class="token punctuation">;</span>


<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">class</span> <span class="token class-name">Task</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token function">Task</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		function <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
		arg <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">Task</span><span class="token punctuation">(</span>callback f<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		function <span class="token operator">=</span> f<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token operator">-&gt;</span>arg <span class="token operator">=</span> <span class="token punctuation">(</span>T <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	callback function<span class="token punctuation">;</span>
	T <span class="token operator">*</span>arg<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">class</span> <span class="token class-name">TaskQueue</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>

	<span class="token function">TaskQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token operator">~</span><span class="token function">TaskQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>

	<span class="token keyword">void</span> <span class="token function">addTask</span><span class="token punctuation">(</span><span class="token keyword">const</span> Task<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token operator">&amp;</span> task<span class="token punctuation">)</span> 
	<span class="token punctuation">{<!-- --></span>
		lock_guard<span class="token operator">&lt;</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>mtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
		taskQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>

	Task<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">takeTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		lock_guard<span class="token operator">&lt;</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>mtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
		Task<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> task<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>taskQueue<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			task <span class="token operator">=</span> taskQueue<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			taskQueue<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> task<span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>

	<span class="token keyword">inline</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">taskNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> taskQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
	queue<span class="token operator">&lt;</span>Task<span class="token operator">&lt;</span>T<span class="token operator">&gt;&gt;</span> taskQueue<span class="token punctuation">;</span>
	mutex mtx<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p><code>ThreadPool.hpp</code></p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;queue&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;mutex&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;thread&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;atomic&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;vector&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;condition_variable&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">"TaskQueue.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;signal.h&gt;</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>


<span class="token comment">//线程池结构体</span>
<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">class</span> <span class="token class-name">ThreadPool</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token function">ThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">explicit</span> <span class="token function">ThreadPool</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> min<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> max<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">~</span><span class="token function">ThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">void</span> <span class="token function">addTask</span><span class="token punctuation">(</span><span class="token keyword">const</span> Task<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token operator">&amp;</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">getBusyNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//忙的线程个数</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">getAliveNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//活的线程个数</span>
<span class="token keyword">private</span><span class="token operator">:</span>
	<span class="token keyword">void</span> <span class="token function">threadExit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//线程退出</span>
	<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token function">worker</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//工作线程调用的任务函数</span>
	<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token function">manager</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//管理者线程调用的任务函数</span>

	<span class="token keyword">const</span> <span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> NUMBER <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token comment">//一次加入的线程数</span>

	<span class="token comment">//任务队列</span>
	TaskQueue<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token operator">*</span>taskQueue<span class="token punctuation">;</span>

	thread <span class="token operator">*</span>managerThread<span class="token punctuation">;</span> <span class="token comment">//管理者线程</span>

	vector<span class="token operator">&lt;</span>thread<span class="token operator">&gt;</span> workGroup<span class="token punctuation">;</span> <span class="token comment">//工作线程组</span>

	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> minNum<span class="token punctuation">;</span> <span class="token comment">//最小线程数</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> maxNum<span class="token punctuation">;</span> <span class="token comment">//最大线程数</span>

	atomic<span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token operator">&gt;</span> busyNum<span class="token punctuation">;</span> <span class="token comment">//忙的线程的个数</span>
	atomic<span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token operator">&gt;</span> liveNum<span class="token punctuation">;</span> <span class="token comment">//存活的线程的个数</span>
	atomic<span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token operator">&gt;</span> exitNum<span class="token punctuation">;</span> <span class="token comment">//要销毁的线程个数</span>

	mutex mutexPool<span class="token punctuation">;</span> <span class="token comment">//锁整个线程池</span>
	condition_variable notEmpty<span class="token punctuation">;</span> <span class="token comment">//任务队列是不是空了 利用条件变量通知</span>

	<span class="token keyword">bool</span> isShutdown<span class="token punctuation">;</span> <span class="token comment">//线程池销毁 true </span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token class-name">ThreadPool</span><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">ThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token class-name">ThreadPool</span><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">ThreadPool</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> min<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> max<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	taskQueue <span class="token operator">=</span> <span class="token keyword">new</span> TaskQueue<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">nullptr</span> <span class="token operator">==</span> taskQueue<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"new taskQueue fail..."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	workGroup<span class="token punctuation">.</span><span class="token function">reserve</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//分配最大容量</span>

	minNum <span class="token operator">=</span> min<span class="token punctuation">;</span>
	maxNum <span class="token operator">=</span> max<span class="token punctuation">;</span>
	busyNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	liveNum <span class="token operator">=</span> min<span class="token punctuation">;</span>
	exitNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	isShutdown <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	
	<span class="token comment">//管理者线程</span>
	managerThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">thread</span><span class="token punctuation">(</span>manager<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">nullptr</span> <span class="token operator">==</span> managerThread<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"new managerThread fail..."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//工作线程</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> min<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		workGroup<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token function">thread</span><span class="token punctuation">(</span>worker<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
ThreadPool<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token operator">~</span><span class="token function">ThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	
	isShutdown <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
	<span class="token comment">//唤醒工作线程 主动关闭</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>liveNum <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		notEmpty<span class="token punctuation">.</span><span class="token function">notify_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>taskQueue<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">delete</span> taskQueue<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>managerThread <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">//设置managerThread为守护线程时</span>
		<span class="token comment">//c++运行库可以保证managerThread相关资源回收</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>managerThread<span class="token operator">-&gt;</span><span class="token function">joinable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			managerThread<span class="token operator">-&gt;</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">delete</span> managerThread<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>workGroup<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">threadExit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	cout <span class="token operator">&lt;&lt;</span> <span class="token string">"ThreadPool end!"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>



<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token operator">*</span> <span class="token class-name">ThreadPool</span><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">worker</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	cout <span class="token operator">&lt;&lt;</span> this_thread<span class="token double-colon punctuation">::</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" worker thread starting..."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

	ThreadPool <span class="token operator">*</span>pool <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>ThreadPool <span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		unique_lock<span class="token operator">&lt;</span>mutex<span class="token operator">&gt;</span> <span class="token function">poolLock</span><span class="token punctuation">(</span>pool<span class="token operator">-&gt;</span>mutexPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> pool<span class="token operator">-&gt;</span>taskQueue<span class="token operator">-&gt;</span><span class="token function">taskNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>pool<span class="token operator">-&gt;</span>isShutdown<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			cout <span class="token operator">&lt;&lt;</span> this_thread<span class="token double-colon punctuation">::</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" waiting task..."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
			pool<span class="token operator">-&gt;</span>notEmpty<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>poolLock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//阻塞等待任务，唤醒后自动上锁</span>
			<span class="token comment">//判断是否销毁线程</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>pool<span class="token operator">-&gt;</span>exitNum <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> pool<span class="token operator">-&gt;</span>liveNum <span class="token operator">&gt;</span> pool<span class="token operator">-&gt;</span>minNum<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				pool<span class="token operator">-&gt;</span>exitNum<span class="token operator">--</span><span class="token punctuation">;</span>
				pool<span class="token operator">-&gt;</span>liveNum<span class="token operator">--</span><span class="token punctuation">;</span>
				poolLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				cout <span class="token operator">&lt;&lt;</span> this_thread<span class="token double-colon punctuation">::</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" thread end work"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>pool<span class="token operator">-&gt;</span>isShutdown<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			poolLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			cout <span class="token operator">&lt;&lt;</span> this_thread<span class="token double-colon punctuation">::</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" thread end work"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//取出一个任务</span>
		Task<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> task <span class="token operator">=</span> pool<span class="token operator">-&gt;</span>taskQueue<span class="token operator">-&gt;</span><span class="token function">takeTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		poolLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		pool<span class="token operator">-&gt;</span>busyNum<span class="token operator">++</span><span class="token punctuation">;</span>
		task<span class="token punctuation">.</span><span class="token function">function</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//执行函数</span>
		<span class="token keyword">delete</span> task<span class="token punctuation">.</span>arg<span class="token punctuation">;</span>
		pool<span class="token operator">-&gt;</span>busyNum<span class="token operator">--</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token operator">*</span> <span class="token class-name">ThreadPool</span><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">manager</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	cout <span class="token operator">&lt;&lt;</span> this_thread<span class="token double-colon punctuation">::</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" manager thread starting..."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	ThreadPool <span class="token operator">*</span>pool <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>ThreadPool <span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">int</span> checkInterval <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>pool<span class="token operator">-&gt;</span>isShutdown<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		this_thread<span class="token double-colon punctuation">::</span><span class="token function">sleep_for</span><span class="token punctuation">(</span>chrono<span class="token double-colon punctuation">::</span><span class="token function">seconds</span><span class="token punctuation">(</span>checkInterval<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//每3秒检查</span>
		unique_lock<span class="token operator">&lt;</span>mutex<span class="token operator">&gt;</span> <span class="token function">poolLock</span><span class="token punctuation">(</span>pool<span class="token operator">-&gt;</span>mutexPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">unsigned</span> <span class="token keyword">int</span> queueSize <span class="token operator">=</span> pool<span class="token operator">-&gt;</span>taskQueue<span class="token operator">-&gt;</span><span class="token function">taskNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//唤醒等待任务的线程</span>
		<span class="token keyword">unsigned</span> <span class="token keyword">int</span> sleepThreadNum <span class="token operator">=</span> pool<span class="token operator">-&gt;</span>liveNum <span class="token operator">-</span> pool<span class="token operator">-&gt;</span>busyNum<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>pool<span class="token operator">-&gt;</span>busyNum <span class="token operator">&lt;</span> queueSize<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">while</span> <span class="token punctuation">(</span>sleepThreadNum <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				pool<span class="token operator">-&gt;</span>notEmpty<span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				sleepThreadNum<span class="token operator">--</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//添加线程</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>queueSize <span class="token operator">&gt;</span> pool<span class="token operator">-&gt;</span>liveNum <span class="token operator">&amp;&amp;</span> pool<span class="token operator">-&gt;</span>liveNum <span class="token operator">&lt;</span> pool<span class="token operator">-&gt;</span>maxNum<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> counter <span class="token operator">&lt;</span> NUMBER
				<span class="token operator">&amp;&amp;</span> pool<span class="token operator">-&gt;</span>liveNum <span class="token operator">&lt;</span> pool<span class="token operator">-&gt;</span>maxNum<span class="token punctuation">;</span> <span class="token operator">++</span>counter<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				pool<span class="token operator">-&gt;</span>workGroup<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token function">thread</span><span class="token punctuation">(</span>worker<span class="token punctuation">,</span> pool<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				pool<span class="token operator">-&gt;</span>liveNum<span class="token operator">++</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//检查时间自适应</span>
		<span class="token comment">//还需完善</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>queueSize <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">&lt;</span> pool<span class="token operator">-&gt;</span>liveNum <span class="token operator">||</span> queueSize <span class="token operator">&gt;</span> <span class="token number">2</span> <span class="token operator">*</span> pool<span class="token operator">-&gt;</span>liveNum<span class="token punctuation">)</span>
			<span class="token operator">&amp;&amp;</span> checkInterval <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			checkInterval<span class="token operator">--</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		poolLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//销毁线程</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>pool<span class="token operator">-&gt;</span>busyNum <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">&lt;</span> pool<span class="token operator">-&gt;</span>liveNum <span class="token operator">&amp;&amp;</span> pool<span class="token operator">-&gt;</span>liveNum <span class="token operator">&gt;</span> pool<span class="token operator">-&gt;</span>minNum<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			pool<span class="token operator">-&gt;</span>exitNum <span class="token operator">=</span> NUMBER<span class="token punctuation">;</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NUMBER<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				pool<span class="token operator">-&gt;</span>notEmpty<span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//代表有些线程以经结束了工作，需要从容器中删除，回收资源</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>pool<span class="token operator">-&gt;</span>workGroup<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> pool<span class="token operator">-&gt;</span>liveNum<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			pool<span class="token operator">-&gt;</span><span class="token function">threadExit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token class-name">ThreadPool</span><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">threadExit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">//清空容器里结束的线程</span>
	<span class="token comment">//thread::id tid = this_thread::get_id();</span>
	<span class="token keyword">auto</span> it <span class="token operator">=</span> workGroup<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span>it <span class="token operator">!=</span> workGroup<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">auto</span> correntTid <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>it<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">native_handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取线程pthread_id</span>
		<span class="token keyword">int</span> kill_rc <span class="token operator">=</span> <span class="token function">pthread_kill</span><span class="token punctuation">(</span>correntTid<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送信号0，探测线程是否存活</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>kill_rc <span class="token operator">==</span> ESRCH<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">//the specified thread did not exists or already quit</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>it<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">joinable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token punctuation">(</span><span class="token operator">*</span>it<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待线程结束 清理线程存储</span>
			<span class="token punctuation">}</span>
			it <span class="token operator">=</span> workGroup<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">;</span>
			cout <span class="token operator">&lt;&lt;</span> <span class="token string">"thread "</span> <span class="token operator">&lt;&lt;</span> correntTid <span class="token operator">&lt;&lt;</span> <span class="token string">" exit from group"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			<span class="token operator">++</span>it<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token class-name">ThreadPool</span><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">addTask</span><span class="token punctuation">(</span><span class="token keyword">const</span> Task<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token operator">&amp;</span>task<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	taskQueue<span class="token operator">-&gt;</span><span class="token function">addTask</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token class-name">ThreadPool</span><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">getBusyNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>busyNum<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token class-name">ThreadPool</span><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">getAliveNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>liveNum<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>main.cpp</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;future&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;thread&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"TaskQueue.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"ThreadPool.hpp"</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>


<span class="token keyword">void</span> <span class="token function">task</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>
	cout <span class="token operator">&lt;&lt;</span> <span class="token string">"corrent id is: "</span> <span class="token operator">&lt;&lt;</span> this_thread<span class="token double-colon punctuation">::</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" :"</span> <span class="token operator">&lt;&lt;</span> num <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	this_thread<span class="token double-colon punctuation">::</span><span class="token function">sleep_for</span><span class="token punctuation">(</span>chrono<span class="token double-colon punctuation">::</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	cout <span class="token operator">&lt;&lt;</span> <span class="token string">"start threadPool test"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	ThreadPool<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token function">pool</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">int</span> <span class="token operator">*</span>num <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		pool<span class="token punctuation">.</span><span class="token function">addTask</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">Task</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	this_thread<span class="token double-colon punctuation">::</span><span class="token function">sleep_for</span><span class="token punctuation">(</span>chrono<span class="token double-colon punctuation">::</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">int</span><span class="token operator">*</span> num <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		pool<span class="token punctuation">.</span><span class="token function">addTask</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">Task</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	this_thread<span class="token double-colon punctuation">::</span><span class="token function">sleep_for</span><span class="token punctuation">(</span>chrono<span class="token double-colon punctuation">::</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	cout <span class="token operator">&lt;&lt;</span> <span class="token string">"end threadPool test"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0d3b8045137579ee6f0d8115bd997c99/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">uniapp 实现多语言切换</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0f1c05c0fae3dbdce85ab1c3ceb2492b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Python数据处理入门教程（非常详细）从零基础入门到精通，看完这一篇就够了</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>