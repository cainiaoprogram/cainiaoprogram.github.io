<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>视频播放相关记录 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="视频播放相关记录" />
<meta property="og:description" content="一、场景
App应用测试在二次回归时，提出了安卓端视频定位不准的问题。
二、分析
代码层面使用了安卓原始的MediaPlayer中的seekTo接口来定位：
mp.setOnInfoListener(new MediaPlayer.OnInfoListener() { @Override public boolean onInfo(MediaPlayer mp, int what, int extra) { AFLog.d(TAG, &#34;视频播放信息监听what=&#34;&#43; what &#43;&#34; firstEnter=&#34;&#43;firstEnter); if (what == MediaPlayer.MEDIA_INFO_VIDEO_RENDERING_START){ //首次根据前端传递过来进行定位 if (firstEnter){ AFLog.d(TAG, &#34;--------seekValue &#34;&#43; seekValue ); if (seekValue != 0){ mp.seekTo(seekValue*1000); } firstEnter = false; } //视频准备渲染完成，隐藏进度框 // if (mLoadingDialog !=null &amp;&amp; mLoadingDialog.isShowing()){ // mLoadingDialog.dismiss(); // } hidGifLoading(); }else if (what == MediaPlayer.MEDIA_INFO_BUFFERING_START ){ //视频缓冲 // if (null != mLoadingDialog){ // mLoadingDialog." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/d29f6572d843e637f7f5ae9ee6ee1ac8/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-15T15:17:23+08:00" />
<meta property="article:modified_time" content="2023-08-15T15:17:23+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">视频播放相关记录</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>一、场景</p> 
<p>    App应用测试在二次回归时，提出了安卓端视频定位不准的问题。</p> 
<p></p> 
<p>二、分析</p> 
<p>   代码层面使用了安卓原始的MediaPlayer中的seekTo接口来定位：</p> 
<blockquote> 
 <pre> mp.setOnInfoListener(new MediaPlayer.OnInfoListener() {
                    @Override
                    public boolean onInfo(MediaPlayer mp, int what, int extra) {
                        AFLog.d(TAG, "视频播放信息监听what="+ what +" firstEnter="+firstEnter);
                        if (what == MediaPlayer.MEDIA_INFO_VIDEO_RENDERING_START){
                            //首次根据前端传递过来进行定位
                            if (firstEnter){
                                AFLog.d(TAG, "--------seekValue "+ seekValue );
                                if (seekValue != 0){
                                    mp.seekTo(seekValue*1000);
                                }
                                firstEnter = false;
                            }
                            //视频准备渲染完成，隐藏进度框
//                            if (mLoadingDialog !=null &amp;&amp; mLoadingDialog.isShowing()){
//                                mLoadingDialog.dismiss();
//                            }
                            hidGifLoading();
                        }else if (what == MediaPlayer.MEDIA_INFO_BUFFERING_START ){
                            //视频缓冲
//                            if (null != mLoadingDialog){
//                                mLoadingDialog.show();
//                            }
                            showGifLoading();
                        }else if (what == MediaPlayer.MEDIA_INFO_BUFFERING_END ){
                            //视频缓冲
//                            if (mLoadingDialog !=null &amp;&amp; mLoadingDialog.isShowing()){
//                                mLoadingDialog.dismiss();
//                            }
                            hidGifLoading();
                        }
                        return false;
                    }
                });</pre> 
</blockquote> 
<p><a href="https://www.xjx100.cn/news/452531.html?action=onClick" rel="nofollow" title="android seekto实现_关于Android VideoView seekTo不准确的解决方案">android seekto实现_关于Android VideoView seekTo不准确的解决方案</a></p> 
<p>根据网上查到信息说这个seek可能是异步返回需要将这个播放动作放到seek完成后进行，尝试了没有效果。</p> 
<p>然后看到了第二个可能得原因，关键帧。从ChatGpt的回答可能原因中也有这点。</p> 
<blockquote> 
 <p>在视频编码中，关键帧（Keyframe），也称为关键帧图像或I帧（Intra-frame），是视频序列中的特殊帧。关键帧是一种独立的图像，它不依赖于之前或之后的帧来进行解码，而可以独立地解码和显示。关键帧在视频编码中具有重要的作用，它影响着视频的压缩效率、快速随机访问以及编辑等方面。</p> 
 <p>视频编码通常使用压缩技术来减少文件大小和带宽占用。在视频序列中，连续的帧通常会共享一些相似的内容，这些相似之处可以通过引用之前的帧来进行压缩。然而，这种依赖性也会导致一些问题，比如：</p> 
 <ol><li> <p><strong>快速随机访问困难：</strong> 如果视频序列中的帧之间有依赖关系，那么要在视频中精确地跳转到某个时间点是比较困难的，因为你可能需要解码之前的帧才能显示目标帧。</p> </li><li> <p><strong>编辑困难：</strong> 如果你想在视频中进行编辑、剪切或插入其他内容，依赖关系可能会导致编辑变得复杂，需要重新编码整个片段。</p> </li><li> <p><strong>错误传播：</strong> 如果一个帧出现了错误，它可能会影响之后的帧的解码，导致错误在整个序列中传播。</p> </li></ol> 
 <p>关键帧解决了上述问题，它是独立的、不依赖于其他帧的帧。关键帧包含了完整的图像数据，通常是原始或未压缩的图像。在视频编码中，通常会周期性地插入关键帧，以便提供快速随机访问点和编辑的可能性。其余的帧通常是根据关键帧和之前的帧来进行预测和差异编码，以达到更高的压缩效率。</p> 
 <p>总之，关键帧在视频编码中扮演着重要的角色，它们提供了视频序列的重要参考点，有助于实现高效的压缩和解码，并提供了更好的随机访问和编辑能力。</p> 
</blockquote> 
<p></p> 
<p>于是使用了ffmpeg工具来分析视频中的关键帧是否足够：<br>  </p> 
<blockquote> 
 <p>ffmpeg -i input.mp4 -an -vf select='eq(pict_type\,I)' -vsync 2  -f image2 image-%03d.jpg</p> 
</blockquote> 
<p><img alt="" height="336" src="https://images2.imgbox.com/dd/5a/WBTPosRW_o.png" width="989"></p> 
<p> </p> 
<p>果然出问题的视频中总共才两个关键帧：</p> 
<p><img alt="" height="471" src="https://images2.imgbox.com/31/81/1KjwUEdl_o.png" width="980"></p> 
<p> </p> 
<p> </p> 
<p>于是继续使用ffmpeg添加关键帧：</p> 
<blockquote> 
 <p>ffmpeg.exe -i "D:\in.mp4" -c:v libx264 -preset superfast -x264opts keyint=25 -acodec copy -f mp4 "D:\out.mp4"</p> 
</blockquote> 
<p></p> 
<p>ffmpeg 工具下载地址：</p> 
<p><a href="https://github.com/BtbN/FFmpeg-Builds/releases" title="Releases · BtbN/FFmpeg-Builds · GitHub">Releases · BtbN/FFmpeg-Builds · GitHub</a></p> 
<p></p> 
<p>通过让chatGpt生成bat脚本如下，集聚转换视频编码为h.264格式和添加关键帧功能：</p> 
<blockquote> 
 <p>@echo off<br> setlocal enabledelayedexpansion</p> 
 <p>REM 获取当前脚本所在的目录<br> set "script_dir=%~dp0"</p> 
 <p>REM 设置输入目录为当前脚本所在的目录<br> set "input_dir=%script_dir%input"</p> 
 <p>REM 设置输出目录为当前脚本所在的目录下的 "output" 子目录<br> set "output_dir=%script_dir%output"</p> 
 <p>REM 遍历输入目录下的所有视频文件并进行转换<br> for %%F in ("%input_dir%\*.mp4") do (<br>     set "input_file=%%~nxF"<br>     set "output_file=!output_dir!\%%~nF_converted.mp4"<br>     <br>     ffmpeg -i "%%F" -c:v libx264 -x264-params keyint=25 -c:a copy "!output_file!"<br> )</p> 
 <p>echo Conversion completed.<br> pause<br>  </p> 
</blockquote> 
<p></p> 
<p> <img alt="" height="367" src="https://images2.imgbox.com/6a/38/fyQMxepl_o.png" width="1119"></p> 
<p> </p> 
<p></p> 
<p>来解决安卓端播放视频出现有声音无图像：<a href="https://www.jianshu.com/p/23927bf4b634" rel="nofollow" title="video标签播放黑屏，只有声音无图像 - 简书">video标签播放黑屏，只有声音无图像 - 简书</a></p> 
<p>以及定位不准的问题。</p> 
<p>苹果端使用avplayer却无此问题，不知为何。</p> 
<p> </p> 
<p> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2cb5f9bfd4a082e8c65e66fc0ff128c9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">OpenSSL 远程升级到 3.2.1</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4a2f5e285b835ed9b8380749ab631835/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">用命令行方式给kvm虚拟机扩容的操作过程</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>