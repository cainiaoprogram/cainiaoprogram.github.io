<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>HRNet代码及原理分析（一）-- 网络结构 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="HRNet代码及原理分析（一）-- 网络结构" />
<meta property="og:description" content="HRNet代码及原理分析（一）-- 网络结构 通常来说，目前市场上主流物体关键点的方法一般分两类：基于坐标回归，热力图。而后者主要是由高到低分辨率网络然后由低分辨率网络再转到高分辨率网络中（high-to-low resolution—&gt;low-to-high resolution）。但是微软提出的一种新型的网络结构–HRNet。
上图是high-to-low resolution—&gt;low-to-high resolution的一般的网络结构，下图就是HRNet的大概的网络结构。可以清楚的看到，HRNet在网络分辨率上是没有进行改变的，主网络的shape一直都是保持一样的，这种设计可以保护图片的局部信息，不会因为卷积而丢失过多的信息。
代码：HRNet
（因为官方是使用pytorch实现的，所以我单独在github找了个tf版本的）
下面，就是进行代码拆解：
input_images = tf.placeholder(tf.float32, [None, 256, 192, 3]) ...... net_output = HRNet(input=input_images, is_training=is_training) 进入HRNet的函数中可以发现一共有四个步骤，挨个进行~
在进行步骤解读之前，先搞清楚一下每个基本模块的作用~
Basic Module leaky_Relu（激活函数，HRNet中最常用的，这里没什么可说的）：
def leaky_Relu(input, name=&#39;&#39;): return tf.nn.leaky_relu(input, alpha=0.1, name=name &#43; &#39;_relu&#39;) conv_2d（卷积&#43;BN&#43;激活，注意这里没有用池化，因为HRNet中的主网络shape是保持不变的，不需要进行池化来改变其shape）：
def conv_2d(inputs, channels, kernel_size=3, strides=1, batch_normalization=True, activation=None, name=&#39;&#39;, padding=&#39;same&#39;, kernel_initializer=tf.random_normal_initializer(stddev=0.01), is_training=True): output = tf.layers.conv2d(inputs=inputs, filters=channels, kernel_size=kernel_size, strides=strides, padding=padding, name=name &#43; &#39;_conv&#39;, kernel_initializer=kernel_initializer) name = name &#43; &#39;_conv&#39; if batch_normalization: output = tf." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/ca219f936b6c14630b1644db3888dad7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-08T11:33:00+08:00" />
<meta property="article:modified_time" content="2022-04-08T11:33:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">HRNet代码及原理分析（一）-- 网络结构</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="HRNet__0"></a>HRNet代码及原理分析（一）-- 网络结构</h2> 
<p>通常来说，目前市场上主流物体关键点的方法一般分两类：基于坐标回归，热力图。而后者主要是由高到低分辨率网络然后由低分辨率网络再转到高分辨率网络中（high-to-low resolution—&gt;low-to-high resolution）。但是微软提出的一种新型的网络结构–HRNet。<br> <img src="https://images2.imgbox.com/62/bb/i7B4VHpQ_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/cf/f5/Xds4naN1_o.png" alt="在这里插入图片描述"><br> 上图是high-to-low resolution—&gt;low-to-high resolution的一般的网络结构，下图就是HRNet的大概的网络结构。可以清楚的看到，HRNet在网络分辨率上是没有进行改变的，主网络的shape一直都是保持一样的，这种设计可以保护图片的局部信息，不会因为卷积而丢失过多的信息。<br> 代码：<a href="https://github.com/VXallset/deep-high-resolution-net.TensorFlow">HRNet</a><br> （因为官方是使用pytorch实现的，所以我单独在github找了个tf版本的）<br> 下面，就是进行代码拆解：</p> 
<pre><code class="prism language-python">input_images <span class="token operator">=</span> tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">192</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
net_output <span class="token operator">=</span> HRNet<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token operator">=</span>input_images<span class="token punctuation">,</span> is_training<span class="token operator">=</span>is_training<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/13/38/R7rsj827_o.png" alt="在这里插入图片描述"><br> 进入HRNet的函数中可以发现一共有四个步骤，挨个进行~<br> 在进行步骤解读之前，先搞清楚一下每个基本模块的作用~</p> 
<h3><a id="Basic_Module_17"></a>Basic Module</h3> 
<p><strong>leaky_Relu</strong>（激活函数，HRNet中最常用的，这里没什么可说的）：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">leaky_Relu</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>leaky_relu<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span> name<span class="token operator">=</span>name <span class="token operator">+</span> <span class="token string">'_relu'</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>conv_2d</strong>（卷积+BN+激活，注意这里没有用池化，因为HRNet中的主网络shape是保持不变的，不需要进行池化来改变其shape）：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">conv_2d</span><span class="token punctuation">(</span>inputs<span class="token punctuation">,</span> channels<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> strides<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> batch_normalization<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
            name<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">'same'</span><span class="token punctuation">,</span> kernel_initializer<span class="token operator">=</span>tf<span class="token punctuation">.</span>random_normal_initializer<span class="token punctuation">(</span>stddev<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">)</span><span class="token punctuation">,</span> is_training<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    output <span class="token operator">=</span> tf<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>conv2d<span class="token punctuation">(</span>inputs<span class="token operator">=</span>inputs<span class="token punctuation">,</span> filters<span class="token operator">=</span>channels<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span>kernel_size<span class="token punctuation">,</span> strides<span class="token operator">=</span>strides<span class="token punctuation">,</span>
                              padding<span class="token operator">=</span>padding<span class="token punctuation">,</span> name<span class="token operator">=</span>name <span class="token operator">+</span> <span class="token string">'_conv'</span><span class="token punctuation">,</span> kernel_initializer<span class="token operator">=</span>kernel_initializer<span class="token punctuation">)</span>
    name <span class="token operator">=</span> name <span class="token operator">+</span> <span class="token string">'_conv'</span>

    <span class="token keyword">if</span> batch_normalization<span class="token punctuation">:</span>
        output <span class="token operator">=</span> tf<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>batch_normalization<span class="token punctuation">(</span>output<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> momentum<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">,</span> name<span class="token operator">=</span>name<span class="token operator">+</span><span class="token string">'_bn'</span><span class="token punctuation">,</span> training<span class="token operator">=</span>is_training<span class="token punctuation">)</span>
        name <span class="token operator">=</span> name <span class="token operator">+</span> <span class="token string">'_bn'</span>

    <span class="token keyword">if</span> activation<span class="token punctuation">:</span>
        output <span class="token operator">=</span> activation<span class="token punctuation">(</span>output<span class="token punctuation">,</span> name<span class="token operator">=</span>name<span class="token punctuation">)</span>

    <span class="token keyword">return</span> output
</code></pre> 
<p>ps：<br> 1.默认进行BN，但是不进行激活，同时默认的kernel_size等于3，步长等于1。由于在后续网络中，有需要改变其输入shape的也有不改变其输入的shape的，所以视情况而定。</p> 
<p><strong>down_sampling</strong>（下采样（卷积））</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">down_sampling</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token string">'strided_convolution'</span><span class="token punctuation">,</span> rate<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span> activation<span class="token operator">=</span>leaky_Relu<span class="token punctuation">,</span> is_training<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">assert</span> method <span class="token operator">==</span> <span class="token string">'max_pooling'</span> <span class="token keyword">or</span> method <span class="token operator">==</span> <span class="token string">'strided_convolution'</span><span class="token punctuation">,</span> \
        <span class="token string">'Unknown type of down_sample method! "strided_convolution" and "'</span> \
        <span class="token string">'max_pooling" are expected, but "'</span> <span class="token operator">+</span> method <span class="token operator">+</span> <span class="token string">'" is provided!'</span>
    output <span class="token operator">=</span> <span class="token builtin">input</span>

    <span class="token keyword">if</span> method <span class="token operator">==</span> <span class="token string">'strided_convolution'</span><span class="token punctuation">:</span>
        _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> channels <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">.</span>get_shape<span class="token punctuation">(</span><span class="token punctuation">)</span>
        channels <span class="token operator">=</span> channels<span class="token punctuation">.</span>value
        output <span class="token operator">=</span> <span class="token builtin">input</span>
        loop_index <span class="token operator">=</span> <span class="token number">1</span>
        new_rate <span class="token operator">=</span> rate
        <span class="token keyword">while</span> new_rate <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">assert</span> new_rate <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'The rate of down_sampling (using "strided_convolution") must be the power of '</span> \
                                      <span class="token string">'2, but "{}" is provided!'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>rate<span class="token punctuation">)</span>
            output <span class="token operator">=</span> conv_2d<span class="token punctuation">(</span>output<span class="token punctuation">,</span> channels<span class="token operator">=</span>channels <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">**</span> loop_index<span class="token punctuation">)</span><span class="token punctuation">,</span> strides<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> activation<span class="token operator">=</span>activation<span class="token punctuation">,</span>
                             name<span class="token operator">=</span>name <span class="token operator">+</span> <span class="token string">'down_sampling'</span> <span class="token operator">+</span> <span class="token string">'_x'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>loop_index <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> is_training<span class="token operator">=</span>is_training<span class="token punctuation">)</span>
            loop_index <span class="token operator">+=</span> <span class="token number">1</span>
            new_rate <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>new_rate <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>

    <span class="token keyword">elif</span> method <span class="token operator">==</span> <span class="token string">'max_pooling'</span><span class="token punctuation">:</span>
        output <span class="token operator">=</span> tf<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>max_pooling2d<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">,</span> pool_size<span class="token operator">=</span>rate<span class="token punctuation">,</span> strides<span class="token operator">=</span>rate<span class="token punctuation">,</span> name<span class="token operator">=</span>name<span class="token operator">+</span><span class="token string">'_max_pooling'</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> output
</code></pre> 
<p>ps：<br> 1.该函数的作用就是进行下采样，但是方式分两种：下卷积和下池化，默认为下卷积（即我们最常见的从conv2d），同时默认的下采样的rate为2，即shape缩小一半。<br> 2.如果为下卷积，这里rate代表下卷积的比例（第一次卷积就缩小一半，第二次卷积就缩小四分之一…），为了不让因为卷积所导致过多的信息丢失，所以随着卷积次数的增加，其输入的channels就相对应的提高倍数。举个栗子，输入的feature map的shape为（1,64,64,3），如果做第一次下卷积，那么wh的大小缩小一倍，即64-&gt;32，同时，channels由3-&gt;3*（2 ** 1）=6，所以最终输出的feature map大小为（1，32,32,6），如果第二次下卷积，那么wh缩小两倍，即64-&gt;16，同时channels由3-&gt;3*(2**2)=12,所以最终输出的feature map大小为（1,16,16,12）。<br> 3.如果为下池化，那么就没啥好说的了，这里采用的是最大池化。</p> 
<p><strong>up_sampling</strong>（上采样）</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">up_sampling</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">,</span> channels<span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token string">'nearest_neighbor'</span><span class="token punctuation">,</span> rate<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span> activation<span class="token operator">=</span>leaky_Relu<span class="token punctuation">,</span> is_training<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">assert</span> method <span class="token operator">==</span> <span class="token string">'nearest_neighbor'</span><span class="token punctuation">,</span> <span class="token string">'Only "nearest_neighbor" method is supported now! '</span> \
                                         <span class="token string">'However, "'</span> <span class="token operator">+</span> method <span class="token operator">+</span> <span class="token string">'" is provided.'</span>
    output <span class="token operator">=</span> <span class="token builtin">input</span>
    <span class="token keyword">if</span> method <span class="token operator">==</span> <span class="token string">'nearest_neighbor'</span><span class="token punctuation">:</span>
        _<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> _<span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">.</span>get_shape<span class="token punctuation">(</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> x<span class="token punctuation">.</span>value
        y <span class="token operator">=</span> y<span class="token punctuation">.</span>value

        output <span class="token operator">=</span> tf<span class="token punctuation">.</span>image<span class="token punctuation">.</span>resize_nearest_neighbor<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token punctuation">(</span>x<span class="token operator">*</span>rate<span class="token punctuation">,</span> y<span class="token operator">*</span>rate<span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span>name <span class="token operator">+</span> <span class="token string">'_upsampling'</span><span class="token punctuation">)</span>
        name <span class="token operator">+=</span> <span class="token string">'_upsampling'</span>
        output <span class="token operator">=</span> conv_2d<span class="token punctuation">(</span>output<span class="token punctuation">,</span> channels<span class="token operator">=</span>channels<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> activation<span class="token operator">=</span>activation<span class="token punctuation">,</span>
                         name<span class="token operator">=</span>name <span class="token operator">+</span> <span class="token string">'_align_channels'</span><span class="token punctuation">,</span> is_training<span class="token operator">=</span>is_training<span class="token punctuation">)</span>

    <span class="token keyword">return</span> output
</code></pre> 
<p>ps：<br> 这里上采样采用的是nearest_neighbor策略，没有采用simple baseline中上卷积的方法。这里先进行邻值插入，然后对其进行一次卷积。</p> 
<p><strong>residual_unit_bottleneck</strong>（resnet基础模块）</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">residual_unit_bottleneck</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'RU_bottleneck'</span><span class="token punctuation">,</span> channels<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> is_training<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Residual unit with bottleneck design, default width is 64.
    :param input:
    :param name:
    :return:
    """</span>
    _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> c <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">.</span>get_shape<span class="token punctuation">(</span><span class="token punctuation">)</span>
    conv_1x1_1 <span class="token operator">=</span> conv_2d<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">,</span> channels<span class="token operator">=</span>channels<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> activation<span class="token operator">=</span>leaky_Relu<span class="token punctuation">,</span> name<span class="token operator">=</span>name <span class="token operator">+</span> <span class="token string">'_conv1x1_1'</span><span class="token punctuation">,</span>
                         is_training <span class="token operator">=</span> is_training<span class="token punctuation">)</span>
    conv_3x3 <span class="token operator">=</span> conv_2d<span class="token punctuation">(</span>conv_1x1_1<span class="token punctuation">,</span> channels<span class="token operator">=</span>channels<span class="token punctuation">,</span> activation<span class="token operator">=</span>leaky_Relu<span class="token punctuation">,</span> name<span class="token operator">=</span>name <span class="token operator">+</span> <span class="token string">'_conv3x3'</span><span class="token punctuation">,</span>
                       is_training<span class="token operator">=</span>is_training<span class="token punctuation">)</span>
    conv_1x1_2 <span class="token operator">=</span> conv_2d<span class="token punctuation">(</span>conv_3x3<span class="token punctuation">,</span> channels<span class="token operator">=</span>c<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">=</span>name <span class="token operator">+</span> <span class="token string">'_conv1x1_2'</span><span class="token punctuation">,</span> is_training<span class="token operator">=</span>is_training<span class="token punctuation">)</span>
    _output <span class="token operator">=</span> tf<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">,</span> conv_1x1_2<span class="token punctuation">,</span> name<span class="token operator">=</span>name <span class="token operator">+</span> <span class="token string">'_add'</span><span class="token punctuation">)</span>
    output <span class="token operator">=</span> leaky_Relu<span class="token punctuation">(</span>_output<span class="token punctuation">,</span> name<span class="token operator">=</span>name <span class="token operator">+</span> <span class="token string">'_out'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> output
</code></pre> 
<p>ps：<br> 1.该基础模块的kernal_size为1，要与后续residual_unit函数区别开。<br> 2.假设输入的feature map的shape为（1,256,192,3），首先进行一次卷积（这里的卷积表示卷积+BN+激活（可有可无），后来不再赘述）将shape改变为（1,256,192,64），这里64是传入到该函数的超参数。然后再进行一次卷积，shape不变还是为（1,256,192,64），接着再接一次卷积，shape变回（1,256,192,3）。最后将输入的feature map和最后一次卷积得到的feature map进行融合，并做一次激活函数，最后得到的output的shape还是与输入保持一致，为（1,256,192,3）。</p> 
<p><strong>residual_unit</strong>（同上residual_unit_bottleneck，但是卷积核大小不同）</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">residual_unit</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'RU'</span><span class="token punctuation">,</span> is_training<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Residual unit with two 3 x 3 convolution layers.
    :param input:
    :param name:
    :return:
    """</span>
    _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> channels <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">.</span>get_shape<span class="token punctuation">(</span><span class="token punctuation">)</span>
    conv3x3_1 <span class="token operator">=</span> conv_2d<span class="token punctuation">(</span>inputs<span class="token operator">=</span><span class="token builtin">input</span><span class="token punctuation">,</span> channels<span class="token operator">=</span>channels<span class="token punctuation">,</span> activation<span class="token operator">=</span>leaky_Relu<span class="token punctuation">,</span> name<span class="token operator">=</span>name <span class="token operator">+</span> <span class="token string">'_conv3x3_1'</span><span class="token punctuation">,</span>
                        is_training<span class="token operator">=</span>is_training<span class="token punctuation">)</span>
    conv3x3_2 <span class="token operator">=</span> conv_2d<span class="token punctuation">(</span>inputs<span class="token operator">=</span>conv3x3_1<span class="token punctuation">,</span> channels<span class="token operator">=</span>channels<span class="token punctuation">,</span> name<span class="token operator">=</span>name <span class="token operator">+</span> <span class="token string">'_conv3x3_2'</span><span class="token punctuation">,</span> is_training<span class="token operator">=</span>is_training<span class="token punctuation">)</span>
    _output <span class="token operator">=</span> tf<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">,</span> conv3x3_2<span class="token punctuation">,</span> name<span class="token operator">=</span>name <span class="token operator">+</span> <span class="token string">'_add'</span><span class="token punctuation">)</span>
    output <span class="token operator">=</span> leaky_Relu<span class="token punctuation">(</span>_output<span class="token punctuation">,</span> name<span class="token operator">=</span>name <span class="token operator">+</span> <span class="token string">'_out'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> output
</code></pre> 
<p>ps：<br> 该函数与residual_unit_bottleneck函数的作用一致，但是唯一的区别就是卷积核大小不同，但是二者都不会对输入的feature map的大小发生改变。</p> 
<h3><a id="STAGE1_140"></a>STAGE1</h3> 
<p><img src="https://images2.imgbox.com/de/fe/6rzZxmDh_o.png" alt="在这里插入图片描述"><br> 这里做连续五次的resnet基础模块操作，前四次的shape大小不会发生改变，但是最后一次卷积生成的最终的output大小为(16,256,192,32)。</p> 
<h3><a id="STAGE2_144"></a>STAGE2</h3> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">stage2</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'stage2'</span><span class="token punctuation">,</span> is_training<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>variable_scope<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        sub_networks <span class="token operator">=</span> exchange_between_stage<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'between_stage'</span><span class="token punctuation">,</span> is_training<span class="token operator">=</span>is_training<span class="token punctuation">)</span>
        sub_networks <span class="token operator">=</span> exchange_block<span class="token punctuation">(</span>sub_networks<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'exchange_block'</span><span class="token punctuation">,</span> is_training<span class="token operator">=</span>is_training<span class="token punctuation">)</span>
    <span class="token keyword">return</span> sub_networks
</code></pre> 
<p>input是包含stage1生成的feature map(16,256,192,32)的列表。</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">exchange_within_stage</span><span class="token punctuation">(</span>inputs<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'exchange_within_stage'</span><span class="token punctuation">,</span> is_training<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>variable_scope<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        subnetworks_number <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>inputs<span class="token punctuation">)</span>
        outputs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

        <span class="token comment"># suppose i is the index of the input sub-network, o is the index of the output sub-network</span>
        <span class="token keyword">for</span> o <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>subnetworks_number<span class="token punctuation">)</span><span class="token punctuation">:</span>
            one_subnetwork <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>subnetworks_number<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> i <span class="token operator">==</span> o<span class="token punctuation">:</span>
                    <span class="token comment"># if in the same resolution</span>
                    temp_subnetwork <span class="token operator">=</span> inputs<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                <span class="token keyword">elif</span> i <span class="token operator">-</span> o <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
                    <span class="token comment"># if the input resolution is greater the output resolution, down-sampling with rate</span>
                    <span class="token comment"># of 2 ** (o - i)</span>
                    temp_subnetwork <span class="token operator">=</span> down_sampling<span class="token punctuation">(</span>inputs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> rate<span class="token operator">=</span><span class="token number">2</span> <span class="token operator">**</span> <span class="token punctuation">(</span>o <span class="token operator">-</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'i_{}_o_{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> o<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                    is_training<span class="token operator">=</span>is_training<span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token comment"># if the input resolution is smaller the output resolution, up-sampling with rate of</span>
                    <span class="token comment"># 2 ** (o - i)</span>
                    _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> c <span class="token operator">=</span> inputs<span class="token punctuation">[</span>o<span class="token punctuation">]</span><span class="token punctuation">.</span>get_shape<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    temp_subnetwork <span class="token operator">=</span> up_sampling<span class="token punctuation">(</span>inputs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> channels<span class="token operator">=</span>c<span class="token punctuation">,</span> rate<span class="token operator">=</span><span class="token number">2</span> <span class="token operator">**</span> <span class="token punctuation">(</span>i <span class="token operator">-</span> o<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                  name<span class="token operator">=</span><span class="token string">'i_{}_o_{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> o<span class="token punctuation">)</span><span class="token punctuation">,</span> is_training<span class="token operator">=</span>is_training<span class="token punctuation">)</span>
                one_subnetwork <span class="token operator">=</span> tf<span class="token punctuation">.</span>add<span class="token punctuation">(</span>temp_subnetwork<span class="token punctuation">,</span> one_subnetwork<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'add_i_{}_o_{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> o<span class="token punctuation">)</span><span class="token punctuation">)</span>
            outputs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>one_subnetwork<span class="token punctuation">)</span>
    <span class="token keyword">return</span> outputs
</code></pre> 
<p>这里，one_subnetwork的shape变成(1,128,96,64)。将其喂入exchange_block函数中。。。</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">exchange_block</span><span class="token punctuation">(</span>inputs<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'exchange_block'</span><span class="token punctuation">,</span> is_training<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>variable_scope<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        output <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        level <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">for</span> <span class="token builtin">input</span> <span class="token keyword">in</span> inputs<span class="token punctuation">:</span>
            sub_network <span class="token operator">=</span> residual_unit<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'level{}RU1'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span><span class="token punctuation">,</span> is_training<span class="token operator">=</span>is_training<span class="token punctuation">)</span>
            sub_network <span class="token operator">=</span> residual_unit<span class="token punctuation">(</span>sub_network<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'level{}RU2'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span><span class="token punctuation">,</span> is_training<span class="token operator">=</span>is_training<span class="token punctuation">)</span>
            sub_network <span class="token operator">=</span> residual_unit<span class="token punctuation">(</span>sub_network<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'level{}RU3'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span><span class="token punctuation">,</span> is_training<span class="token operator">=</span>is_training<span class="token punctuation">)</span>
            sub_network <span class="token operator">=</span> residual_unit<span class="token punctuation">(</span>sub_network<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'level{}RU4'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span><span class="token punctuation">,</span> is_training<span class="token operator">=</span>is_training<span class="token punctuation">)</span>
            output<span class="token punctuation">.</span>append<span class="token punctuation">(</span>sub_network<span class="token punctuation">)</span>
            level <span class="token operator">+=</span> <span class="token number">1</span>
        outputs <span class="token operator">=</span> exchange_within_stage<span class="token punctuation">(</span>output<span class="token punctuation">,</span> is_training<span class="token operator">=</span>is_training<span class="token punctuation">)</span>
    <span class="token keyword">return</span> outputs
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e3e7d354fcb4739b40d27588f286cb72/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">python数据分析基础知识(一)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9a73dae7355489d325eee434e310b550/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Hadoop分布式大数据平台</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>