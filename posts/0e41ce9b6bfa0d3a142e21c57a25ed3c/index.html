<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>mycat从0到成功进行分表操作 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="mycat从0到成功进行分表操作" />
<meta property="og:description" content="1.安装mysql，先检查集群中是否存在
mysql --version 或使用rpm -qa | grep mysql查看
如不存在，则参考mysql安装
启动mysql服务（systemctl start mysqld）时如果需要密码且始终提示不对如下图所示：
则可以使用 sudo systemctl restart mysqld.service启动mysql服务。
然后查看mysql服务是否真的启动了（systemctl status mysqld）
这样就启动了。
补充：修改mysql密码
如果是刚安装的，使用mysqladmin -u root password “这是密码”;创建密码
如果不是则连接到mysql后，set password for 用户名 @主机名（localhost）=password(…);
或使用mysqladmin -u root -p&#34;旧密码“ password “这是新密码”；
或直接更新update的user表 （mysql库下的user表）,
update mysql.user set authentication_string=password(&#39;新密码&#39;) where user=&#39;用户名&#39; and Host =&#39;localhost&#39;; 设置完之后需要将其刷新flush privileges
补充mysql：如果修改了mysql配置文件/etc/my.cnf,一定要重启mysql服务
2.使用mycat操作mysql时出现mysql的权限不足 ERROR 1105 (HY000): backend connect: java.lang.IllegalArgumentException: Invalid DataSource:0
在mysql中的mysql库（use mysql）下使用grant all privileges on *.* to root@&#34;%&#34; identified by &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/0e41ce9b6bfa0d3a142e21c57a25ed3c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-11-23T21:17:08+08:00" />
<meta property="article:modified_time" content="2021-11-23T21:17:08+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">mycat从0到成功进行分表操作</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><strong>1.安装mysql</strong>，先检查集群中是否存在<br> mysql --version 或使用rpm -qa | grep mysql查看<br> 如不存在，则参考<a href="https://www.runoob.com/mysql/mysql-install.html" rel="nofollow">mysql安装</a><br> 启动mysql服务（<code>systemctl start mysqld</code>）时如果需要密码且始终提示不对如下图所示：<br> <img src="https://images2.imgbox.com/1e/66/8a1r71zW_o.png" alt="在这里插入图片描述"><br> 则可以使用 <code>sudo systemctl restart mysqld.service</code>启动mysql服务。<br> 然后查看mysql服务是否真的启动了（<code>systemctl status mysqld</code>）<br> <img src="https://images2.imgbox.com/b2/41/kruhTM0V_o.png" alt="在这里插入图片描述"><br> 这样就启动了。<br> 补充：修改mysql密码<br> 如果是刚安装的，使用mysqladmin -u root password “这是密码”;创建密码<br> 如果不是则连接到mysql后，set password for 用户名 @主机名（localhost）=password(…);<br> 或使用mysqladmin -u root -p"旧密码“ password “这是新密码”；<br> 或直接更新update的user表 （mysql库下的user表）,</p> 
<pre><code class="prism language-cpp">update mysql<span class="token punctuation">.</span>user set authentication_string<span class="token operator">=</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">'新密码'</span><span class="token punctuation">)</span> where user<span class="token operator">=</span><span class="token string">'用户名'</span> <span class="token operator">and</span> Host <span class="token operator">=</span><span class="token string">'localhost'</span><span class="token punctuation">;</span>
</code></pre> 
<p>设置完之后需要将其刷新<code>flush privileges</code><br> 补充mysql：如果修改了mysql配置文件/etc/my.cnf,一定要重启mysql服务<br> <strong>2.使用mycat操作mysql时出现mysql的权限不足 ERROR 1105 (HY000): backend connect: java.lang.IllegalArgumentException: Invalid DataSource:0</strong><br> 在mysql中的mysql库（use mysql）下使用<code>grant all privileges on *.* to root@"%" identified by "password";</code>再将其刷新到表中flush privileges;从而得到所有权限<br> 查看权限：<code>select Host from user where user='root'</code>看是否存在%<br> 补充：mycat密码是在server.xml中设置的</p> 
<pre><code class="prism language-cpp"> <span class="token operator">&lt;</span>user name<span class="token operator">=</span><span class="token string">"root"</span> defaultAccount<span class="token operator">=</span><span class="token string">"true"</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"password"</span><span class="token operator">&gt;</span>这里设置密码<span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"schemas"</span><span class="token operator">&gt;</span>TESTDB<span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>

                <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 表级 DML 权限设置 <span class="token operator">--</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>            
                <span class="token operator">&lt;</span>privileges check<span class="token operator">=</span><span class="token string">"false"</span><span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span>schema name<span class="token operator">=</span><span class="token string">"TESTDB"</span> dml<span class="token operator">=</span><span class="token string">"0110"</span> <span class="token operator">&gt;</span>
                                <span class="token operator">&lt;</span>table name<span class="token operator">=</span><span class="token string">"tb01"</span> dml<span class="token operator">=</span><span class="token string">"0000"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>table<span class="token operator">&gt;</span>
                                <span class="token operator">&lt;</span>table name<span class="token operator">=</span><span class="token string">"tb02"</span> dml<span class="token operator">=</span><span class="token string">"1111"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>table<span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span><span class="token operator">/</span>schema<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>privileges<span class="token operator">&gt;</span>           
                 <span class="token operator">--</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>user<span class="token operator">&gt;</span>

</code></pre> 
<p><strong>3.mycat服务启动不了，或者启动后关闭</strong><br> 补充：无论有几个节点的mysql，实际需要的mycat只是一个。除非需要部署mycat的HA模式。<br> 这个需要查看mycat的log文件wrapper.log,看他内部是什么错误，一般是schema.xml配置错误，比如表不存在，拼写错误等问题。修改配置文件后重启mycat即可。<br> <strong>4.mycat主从节点复制（一般用于集群统一mysql表数据）：</strong><br> 需要设置/etc/my.cnf ,主节点设置</p> 
<pre><code class="prism language-cpp">server<span class="token operator">-</span>id<span class="token operator">=</span><span class="token number">1</span>
symbolic<span class="token operator">-</span>links<span class="token operator">=</span><span class="token number">0</span>
log<span class="token operator">-</span>bin<span class="token operator">=</span>mysql<span class="token operator">-</span>bin
binlog<span class="token operator">-</span><span class="token keyword">do</span><span class="token operator">-</span>db<span class="token operator">=</span>StudyTest<span class="token comment">//如果要同步复制多个数据库可以再加入</span>
binlog_format<span class="token operator">=</span>STATEMENT

</code></pre> 
<p>副节点设置：</p> 
<pre><code class="prism language-cpp">server<span class="token operator">-</span>id<span class="token operator">=</span><span class="token number">2</span>
relay<span class="token operator">-</span>log<span class="token operator">=</span>mysql<span class="token operator">-</span>relay
</code></pre> 
<p>重启mysql服务，主节点进入mysql界面后使用show master status;查看master状态记下其中的file编号和position端口号。副节点进入SQL界面<br> <img src="https://images2.imgbox.com/88/9d/7fCZEYEL_o.png" alt="在这里插入图片描述"></p> 
<ol><li></ol> 
<pre><code class="prism language-cpp">CHANGE MASTER TO MASTER_HOST<span class="token operator">=</span><span class="token string">'主机的IP地址'</span><span class="token punctuation">,</span>
MASTER_USER<span class="token operator">=</span><span class="token string">'slave'</span><span class="token punctuation">,</span>
MASTER_PASSWORD<span class="token operator">=</span><span class="token string">'主节点mysql密码'</span><span class="token punctuation">,</span>
MASTER_LOG_FILE<span class="token operator">=</span><span class="token string">'主节点file编号'</span><span class="token punctuation">,</span>MASTER_LOG_POS<span class="token operator">=</span>主节点position端口号<span class="token punctuation">;</span>
</code></pre> 
<p>2.启动副节点服务器 <code>start slave；</code><br> 3.查看副节点状态 <code>show slave status\G;</code>如果显示slave_io和sql_running为yes则成功了<br> <img src="https://images2.imgbox.com/77/c1/ItDLcpoO_o.png" alt="在这里插入图片描述"><br> 停止slave节点：stop slave<br> <strong>5.mycat分表</strong><br> schema.xml中对应的table表设置分片规则rule：<br> <img src="https://images2.imgbox.com/a2/fc/fpUusLDV_o.png" alt="在这里插入图片描述"><br> rule在rule.xml表中设置。（mycat配置文件的注解查看<a href="https://www.jianshu.com/p/6566fb8f0a1a" rel="nofollow">mycat</a>）<br> 设置连接表中的rule，是我们进行数据分区等操作的属性，其设置的值相当于一个函数，需要在mycat/conf/rule.xml文件中实现eg:<br> <img src="https://images2.imgbox.com/90/99/peyh70EP_o.png" alt="在这里插入图片描述"><br> 这里是指使用表中的Dno属性进行分片，分片函数为mod-long即取余操作实现分片<br> 取余的值在mod-long函数中设置</p> 
<pre><code class="prism language-cpp">	<span class="token operator">&lt;</span>function name<span class="token operator">=</span><span class="token string">"mod-long"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"io.mycat.route.function.PartitionByMod"</span><span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> how many data nodes <span class="token operator">--</span><span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"count"</span><span class="token operator">&gt;</span><span class="token number">3</span><span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>分片mod值取<span class="token number">3</span><span class="token operator">--</span><span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span><span class="token operator">/</span>function<span class="token operator">&gt;</span>
</code></pre> 
<p>遇到的问题<br> 1）.插入的数据仍然是只有单个表有数据<br> 1.考虑分片属性的值是否不同<br> 2.如果表非空并修改了表的分片属性，再插入数据也是不行的，必须要表数据清除之后，修改表分片属性，再插入数据<br> 2）.表查询或者插入数据时出现ERROR 1003 (HY000): Unsupported statement<br> 端口号使用错误，应该使用8066端口<br> 3）."Lost connection to MySQL server at ‘reading initial communication packet’, system error: 0<br> 权限不够，可以将 /etc/my.cnf 中的bind-address参数修改成0.0.0.0，表示允许任何ip主机访问此数据库<br> 添加防火墙，只允许我们的网络访问</p> 
<pre><code class="prism language-cpp"> iptables <span class="token operator">-</span>A INPUT <span class="token operator">-</span>p tcp <span class="token operator">-</span>s <span class="token number">192.168</span><span class="token punctuation">.</span><span class="token number">0.104</span>（可以使用的网络） <span class="token operator">--</span>dport <span class="token number">3306</span> <span class="token operator">-</span>j ACCEPT
 iptables <span class="token operator">-</span>A INPUT <span class="token operator">-</span>p tcp <span class="token operator">--</span>dport <span class="token number">3306</span> <span class="token operator">-</span>j DROP
 service iptables save
</code></pre> 
<p><strong>6.mycat join表</strong><br> parentKey是我们连接父表时参考父表的键属性，joinKey是子表用于连接父表使用的键属性，primaryKey是当前表的主键。默认要求joinKey是parentKey的外键，即子表中插入数据的joinKey字段的数据范围取决于parentKey的数据范围。<br> <img src="https://images2.imgbox.com/33/81/yq3UZFfe_o.png" alt="在这里插入图片描述"></p> 
<p>单独的dataNode标签是设置的逻辑节点，用于连接mycat和mysql（相当于一个映射关系）而dataHost和writeHost,readHost是设置连接的物理存储节点，和实际的读写操作节点。每一个映射关系都需要设置了这个之后才能真正的使用。否则就只是映射而无实际作用。<br> 一个dataHost代表一个机器，而一个机器可以有多个writeHost和readHost.我们要实现分片可以使用一个机器多个writeHost,也可以使用多个机器多个writeHost(一个机器一个writeHost)<br> 遇到的问题：<br> 1）.can’t find (root) parent sharding node for sql（最坑人的地方！！！！！）<br> 网上很多方法，有说是事务的问题（大致意思是子父表的数据不能在一个事务中插入，因为父表数据还没提交，子表找不到），也有说是mycat版本问题需要在schema.xml中插入fetchStoreNodeByJdbc（应该是错误的，查看了table表的各个属性是不存在该属性的，如果要硬添加，就会报当前属性没有申明的错误），至于事务保持中立，不能确定。因为底层原理还不确定。但是我根据这个解决先将父表的数据commit后再执行插入子表数据，仍然会报这个错误。有的说可以关闭mysql的事务，但是没尝试，所以也不能确定。网上的东西也不能全信，容易被带偏(T_T)。<br> 最后前前后后找了4,5个小时，终于发现了，应该是mycat的大小写敏感造成的，其实我们在mycat查看表时就可以发现，当表名是大写时show tables;查看表名所有都是小写。解决方法：法1.重新建表（都使用小写。先delete from数据，drop table ,再crate table）法2.将mysql设置为大小写不敏感。即将所有的大写都转换为小写格式。在/etc/my.cnf中添加<code>lower_case_table_names = 1</code>并重启mysql服务。<br> 另外注意在插入数据之前要保证表中数据为空，这样的插入才会使用新的规则。<br> <img src="https://images2.imgbox.com/4b/e4/a2lap18u_o.png" alt="在这里插入图片描述"><br> （实际表名为Student）<br> 1）一般来说只有当parentKey是非父表的分片属性时才会出现这种情况，因为其内部会执行一个查询语句如<br> 要插入的数据连接属性为id ， parentKey为l-id ，primaryKey为sno<br> insert into child (id,sname,sno)values(1,2,3) =&gt;底层执行select parent.l-id from parent where parent.l-id=1，<br> 之后将数据插入到parent表l-id属性=1的节点上的child表中。<br> 2）但是如果你使用的parentKey是父表的分片属性时，因为其是直接通过分片规则（如mod-long取余）反向计算得到插入语句要连接表在哪个节点上，然后将数据插入到这个节点的child表上。因为没有使用查询语句，也就不会出现表大小写导致子表数据插入不上的问题。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b5ad4ed530345391c84965ce7f97cbae/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">ACL访问控制列表</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/63fd2bfe1214572c7de9ed50c243f8a7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">一起实践神经网络INT8量化系列教程（一）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>