<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>03-Frida API - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="03-Frida API" />
<meta property="og:description" content="Java对象 无论是想对so层亦或java层进行拦截，都必须编写Java.perform(). Java.available() 用来判断当前进程是否加载了JavaVM，Dalvik或ART虚拟机. function frida_Java(){ Java.perform(function () { if(Java.available) { console.log(&#34;hello java vm&#34;); } else { console.log(&#34;error&#34;); } }); } setImmediate(frida_Java,0); 运行代码，效果如图：
Java.androidVersion 显示Android系统版本号 function frida_Java(){ Java.perform(function () { if(Java.available) { console.log(&#34;&#34;, Java.androidVersion); } else { console.log(&#34;error&#34;); } }); } setImmediate(frida_Java,0); 运行效果如图：
Java.enumerateLoadedClasses() 该API枚举当前加载的所有类信息，它有一个回调函数分别是onMatch、onComplete函数. function frida_Java(){ Java.perform(function () { if(Java.available) { Java.enumerateLoadedClasses({ onMatch:function (className) { console.log(&#34;&#34;,className) }, onComplete:function () { console.log(&#34;output complete!!!&#34;) } }); } else { console.log(&#34;error&#34;); } }); } setImmediate(frida_Java,0); 运行效果如图：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/e14394934c9303c16a55aca0b0f08d4c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-09-15T10:54:04+08:00" />
<meta property="article:modified_time" content="2021-09-15T10:54:04+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">03-Frida API</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="Java_0"></a>Java对象</h3> 
<ul><li>无论是想对so层亦或java层进行拦截，都必须编写Java.perform().</li></ul> 
<h4><a id="Javaavailable_2"></a>Java.available()</h4> 
<ul><li>用来判断当前进程是否加载了JavaVM，Dalvik或ART虚拟机.</li></ul> 
<pre><code class="prism language-js"><span class="token keyword">function</span> <span class="token function">frida_Java</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    Java<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>Java<span class="token punctuation">.</span>available<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hello java vm"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">setImmediate</span><span class="token punctuation">(</span>frida_Java<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>运行代码，效果如图：<br> <img src="https://images2.imgbox.com/85/c5/EJrhkFP2_o.png" alt="在这里插入图片描述"></li></ul> 
<h4><a id="JavaandroidVersion_21"></a>Java.androidVersion</h4> 
<ul><li>显示Android系统版本号</li></ul> 
<pre><code class="prism language-js"><span class="token keyword">function</span> <span class="token function">frida_Java</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    Java<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>Java<span class="token punctuation">.</span>available<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> Java<span class="token punctuation">.</span>androidVersion<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">setImmediate</span><span class="token punctuation">(</span>frida_Java<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>运行效果如图：<br> <img src="https://images2.imgbox.com/e5/4f/pyChB3Xw_o.png" alt="在这里插入图片描述"></li></ul> 
<h4><a id="JavaenumerateLoadedClasses_40"></a>Java.enumerateLoadedClasses()</h4> 
<ul><li>该API枚举当前加载的所有类信息，它有一个回调函数分别是onMatch、onComplete函数.</li></ul> 
<pre><code class="prism language-js"><span class="token keyword">function</span> <span class="token function">frida_Java</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    Java<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>Java<span class="token punctuation">.</span>available<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Java<span class="token punctuation">.</span><span class="token function">enumerateLoadedClasses</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
               <span class="token function-variable function">onMatch</span><span class="token operator">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">className</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span>className<span class="token punctuation">)</span>
               <span class="token punctuation">}</span><span class="token punctuation">,</span>
               <span class="token function-variable function">onComplete</span><span class="token operator">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"output complete!!!"</span><span class="token punctuation">)</span>
               <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">setImmediate</span><span class="token punctuation">(</span>frida_Java<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>运行效果如图：<br> <img src="https://images2.imgbox.com/81/ad/U0USVzUq_o.png" alt="在这里插入图片描述"></li></ul> 
<h4><a id="JavaenumerateClassLoaders_66"></a>Java.enumerateClassLoaders()</h4> 
<ul><li>该api枚举Java VM中存在的类加载器，其有一个回调函数，分别是onMatch: function (loader)与onComplete: function ().</li></ul> 
<pre><code class="prism language-js"><span class="token keyword">function</span> <span class="token function">frida_Java</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    Java<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>Java<span class="token punctuation">.</span>available<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Java<span class="token punctuation">.</span><span class="token function">enumerateClassLoaders</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
               <span class="token function-variable function">onMatch</span><span class="token operator">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">loader</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span>loader<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span><span class="token punctuation">,</span>
               <span class="token function-variable function">onComplete</span><span class="token operator">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"output complete!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">setImmediate</span><span class="token punctuation">(</span>frida_Java<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>运行效果显示：<br> <img src="https://images2.imgbox.com/cd/a7/2wBxxvAO_o.png" alt="在这里插入图片描述"></li></ul> 
<h4><a id="Javaperform_92"></a>Java.perform()</h4> 
<ul><li>Java.perform（fn）主要用于当前线程附加到Java VM并且调用fn方法。</li></ul> 
<pre><code class="prism language-js"><span class="token keyword">function</span> <span class="token function">frida_Java</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    Java<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>Java<span class="token punctuation">.</span>available<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">setImmediate</span><span class="token punctuation">(</span>frida_Java<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>执行效果如图：<br> <img src="https://images2.imgbox.com/98/c9/kE8XxFTn_o.png" alt="在这里插入图片描述"></li></ul> 
<h4><a id="Javause_111"></a>Java.use()</h4> 
<ul><li>Java.use(className)，动态获取className的类定义，通过对其调用$ new()来调用构造函数，可以从中实例化对象。当想要回收类时可以调$Dispose()方法显式释放，当然也可以等待JavaScript的垃圾回收机制，当实例化一个对象之后，可以通过其实例对象调用类中的静态或非静态的方法.</li></ul> 
<pre><code class="prism language-js"><span class="token keyword">function</span> <span class="token function">frida_Java</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    Java<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">var</span> Activity <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'android.app.Activity'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> Exception <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'java.lang.Exception'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">//调用onResume方法的时候，会在此处被拦截并且调用以下代码抛出异常！</span>
        Activity<span class="token punctuation">.</span>onResume<span class="token punctuation">.</span><span class="token function-variable function">implementation</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">throw</span> Exception<span class="token punctuation">.</span>$<span class="token keyword">new</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">setImmediate</span><span class="token punctuation">(</span>frida_Java<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="Javachoose_127"></a>Java.choose()</h4> 
<ul><li>在堆上查找已经实例化的对象。</li></ul> 
<pre><code class="prism language-js"><span class="token keyword">function</span> <span class="token function">frida_Java</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    Java<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Java<span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span><span class="token string">"android.view.View"</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span>
            <span class="token function-variable function">onMatch</span><span class="token operator">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function-variable function">onComplete</span><span class="token operator">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">setImmediate</span><span class="token punctuation">(</span>frida_Java<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>运行结果如图：<br> <img src="https://images2.imgbox.com/ca/3b/DE4xRyn2_o.png" alt="在这里插入图片描述"></li></ul> 
<h4><a id="Javacast_147"></a>Java.cast()</h4> 
<ul><li>Java.cast(handle, klass)，就是将指定变量或者数据强制转换成你所有需要的类型；</li></ul> 
<h4><a id="Javaarray_149"></a>Java.array</h4> 
<ul><li>frida提供了在js代码中定义java数组的api，该数组可以用于传递给java API.</li></ul> 
<pre><code class="prism language-js"><span class="token keyword">function</span> <span class="token function">frida_Java</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    Java<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">var</span> intarr <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token string">'int'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1003</span><span class="token punctuation">,</span> <span class="token number">1005</span><span class="token punctuation">,</span> <span class="token number">1007</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">var</span> bytearr <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token string">'byte'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0x65</span><span class="token punctuation">,</span> <span class="token number">0x69</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>bytearr<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
       <span class="token punctuation">{<!-- --></span>
           console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>bytearr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">setImmediate</span><span class="token punctuation">(</span>frida_Java<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>运行效果如图：<br> <img src="https://images2.imgbox.com/d5/5e/kEskGyGB_o.png" alt="在这里插入图片描述"></li></ul> 
<h4><a id="JavaregisterClassspec_167"></a>Java.registerClass(spec)</h4> 
<ul><li>Java.registerClass：用于注册一个类到内存，这个类可以是我们自己定义的，也就是说我们可以通过这个方式来自定义类加入到内存中，也可以是已经存在的类，其中规范是一个包含： 
  <ol><li>name：指定类名称的字符串。</li><li>superClass：（可选）父类。要从 java.lang.Object 继承的省略。</li><li>implements：（可选）由此类实现的接口数组。</li><li>fields：（可选）对象，指定要公开的每个字段的名称和类型。</li><li>methods：（可选）对象，指定要实现的方法。</li></ol> </li><li>注册一个类，返回类的实例。</li></ul> 
<pre><code class="prism language-js"><span class="token keyword">function</span> <span class="token function">frida_Java</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    Java<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> hellojni <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">registerClass</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            name<span class="token operator">:</span> <span class="token string">'com.example.demo01.hellojni'</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> instance <span class="token operator">=</span> hellojni<span class="token punctuation">.</span>$<span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">addInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">setImmediate</span><span class="token punctuation">(</span>frida_Java<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>运行结果如下图：<br> <img src="https://images2.imgbox.com/d9/8f/aF0qUkrs_o.png" alt="在这里插入图片描述"></li></ul> 
<h4><a id="Javavm_190"></a>Java.vm</h4> 
<ul><li>比如想要拿到JNI层的JNIEnv对象，可以使用Java.vm.getEnv()；</li></ul> 
<h3><a id="Interceptor_192"></a>Interceptor对象</h3> 
<ul><li>Interceptor.attach(target, callbacks):参数target是需要拦截的位置的函数地址，也就是填某个so层函数的地址即可对其拦截. 
  <ul><li>target是一个NativePointer参数，用来指定你想要拦截的函数的地址。</li></ul> </li></ul> 
<h4><a id="Interceptorattach_195"></a>Interceptor.attach</h4> 
<pre><code>- onEnter:function(args) :  在原方法被调用前触发.args 是一个可以用来读写原方法参数的 NativePointer 数组.
- onLeave:function(retral): 在原方法返回前触发. retval 是一个含有原返回值的 NativePointer 驱动的对象.可以调用 retval.replace（1337） 以整数 1337 替换返回值，或者调用 retval.replace（ptr（"0x1234"））以替换为指针。
- 示例代码如下：
</code></pre> 
<pre><code class="prism language-js"><span class="token keyword">function</span> <span class="token function">frida_Java</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    Java<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//使用Module对象getExportByNameAPI直接获取libc.so中的导出函数read的地址，对read函数进行附加拦截</span>
      Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>Module<span class="token punctuation">.</span><span class="token function">findExportByName</span><span class="token punctuation">(</span><span class="token string">'libc.so'</span><span class="token punctuation">,</span><span class="token string">'read'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span>
      <span class="token comment">//每次read函数调用的时候会执行onEnter回调函数</span>
            <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toInt32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token comment">//read函数执行完成之后会执行onLeave回调函数</span>
            <span class="token function-variable function">onLeave</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">retval</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>retval<span class="token punctuation">.</span><span class="token function">toInt32</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"do something"</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">setImmediate</span><span class="token punctuation">(</span>frida_Java<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>另外, 这个对象包含一些实用的属性:</p> 
<ul><li> <p>returnAddress: NativePointer 类型的返回地址</p> </li><li> <p>context: 带有键 pc 和 sp 的 NativePointer 对象, 分别为 ia32 / x64 / arm 指定 EIP / RIP / PC 和 ESP / RSP / SP. 也可以使用其他处理器特定的键, 例如 eax, rax, r0, x0等.</p> </li><li> <p>errno: (UNIX) 当前的 errno 值 (您可以替换它)</p> </li><li> <p>lastError: (Windows) 当前操作系统的 error 值 (您可以替换它)</p> </li><li> <p>threadId: 操作系统线程 ID</p> </li><li> <p>depth: 相对其他调用的调用深度.</p> </li><li> <p>代码示例如下：</p> </li></ul> 
<pre><code class="prism language-js"><span class="token keyword">function</span> <span class="token function">frida_Java</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    Java<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>Module<span class="token punctuation">.</span><span class="token function">getExportByName</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'read'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Context information:'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Context  : '</span> <span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Return   : '</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>returnAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ThreadId : '</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Depth    : '</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>depth<span class="token punctuation">)</span><span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Errornr  : '</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
            <span class="token comment">// Save arguments for processing in onLeave.</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toInt32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>buf <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toInt32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'----------'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Show argument 1 (buf), saved during onEnter.</span>
            <span class="token keyword">var</span> numBytes <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">toInt32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>numBytes <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">hexdump</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>buf<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> length<span class="token operator">:</span> numBytes<span class="token punctuation">,</span> ansi<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Result   : '</span> <span class="token operator">+</span> numBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">setImmediate</span><span class="token punctuation">(</span>frida_Java<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="InterceptordetachAll_267"></a>Interceptor.detachAll</h4> 
<ul><li>让之前所有的Interceptor.attach附加拦截的回调函数失效。</li></ul> 
<h4><a id="Interceptorreplace_269"></a>Interceptor.replace</h4> 
<ul><li>相当于替换掉原本的函数，用替换时的实现替换目标处的函数。</li><li>示例如下：</li></ul> 
<pre><code class="prism language-js"><span class="token keyword">function</span> <span class="token function">frida_Java</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    Java<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//这个getSum方法有两个int参数、返回结果为两个参数相加</span>
        <span class="token keyword">let</span> add_method <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NativeFunction</span><span class="token punctuation">(</span>Module<span class="token punctuation">.</span><span class="token function">findExportByName</span><span class="token punctuation">(</span><span class="token string">'libnative-lib.so'</span><span class="token punctuation">,</span><span class="token string">'Java_com_example_ndkdemo_MainActivity_getSum'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'int'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string">'int'</span><span class="token punctuation">,</span><span class="token string">'int'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"result:"</span><span class="token punctuation">,</span><span class="token function">add_method</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Interceptor<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>add_method<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">NativeCallback</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span>b</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//这里对原函数的功能进行替换实现</span>
            <span class="token keyword">return</span> <span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'int'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string">'int'</span><span class="token punctuation">,</span><span class="token string">'int'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"result:"</span><span class="token punctuation">,</span><span class="token function">add_method</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"------------------------------"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">setImmediate</span><span class="token punctuation">(</span>frida_Java<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="NativePointer_289"></a>NativePointer对象</h3> 
<ul><li>同等与C语言中的指针</li></ul> 
<h4><a id="new_NativePointers_291"></a>new NativePointer(s)</h4> 
<ul><li>声明定义NativePointer类型</li></ul> 
<pre><code class="prism language-js"><span class="token keyword">function</span> <span class="token function">frida_Java</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    Java<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">let</span> ptr1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NativePointer</span><span class="token punctuation">(</span><span class="token string">"100"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"ptr1 -&gt; "</span><span class="token punctuation">,</span> ptr1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> ptr2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NativePointer</span><span class="token punctuation">(</span><span class="token string">"0x64"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"ptr2 -&gt; "</span><span class="token punctuation">,</span> ptr2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> ptr3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NativePointer</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"ptr3 -&gt; "</span><span class="token punctuation">,</span>ptr3<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"---------------------"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">setImmediate</span><span class="token punctuation">(</span>frida_Java<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>上述三个指针都会自动转为十六进制的0x64</li></ul> 
<pre><code class="prism language-shell">ptr1 -<span class="token operator">&gt;</span>  0x64
ptr2 -<span class="token operator">&gt;</span>  0x64
ptr3 -<span class="token operator">&gt;</span>  0x64
---------------------
</code></pre> 
<h4><a id="API_315"></a>运算符以及指针读写API</h4> 
<p><img src="https://images2.imgbox.com/e1/ae/lOs7A8Bs_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/2e/b6/HmCjJcLv_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="readByteArray_318"></a>readByteArray()</h4> 
<pre><code class="prism language-js"><span class="token keyword">function</span> <span class="token function">frida_Java</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    Java<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">let</span> base_pointer <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">findModuleByName</span><span class="token punctuation">(</span><span class="token string">'libc.so'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>base<span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>base_pointer<span class="token punctuation">.</span><span class="token function">readByteArray</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">setImmediate</span><span class="token punctuation">(</span>frida_Java<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>运行效果如图：<br> <img src="https://images2.imgbox.com/89/71/ZlkxpALX_o.png" alt="在这里插入图片描述"></li></ul> 
<h4><a id="readPointer_331"></a>readPointer()</h4> 
<pre><code class="prism language-js"><span class="token keyword">function</span> <span class="token function">frida_Java</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    Java<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">let</span> base_pointer <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">findModuleByName</span><span class="token punctuation">(</span><span class="token string">'libc.so'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>base<span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>base_pointer<span class="token punctuation">.</span><span class="token function">readPointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">setImmediate</span><span class="token punctuation">(</span>frida_Java<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>readPointer的将前四个字节的内容转成地址产生一个新的NativePointer。<br> <img src="https://images2.imgbox.com/ae/fe/J3bo7IWs_o.png" alt="在这里插入图片描述"></li></ul> 
<h4><a id="writePointerptr_344"></a>writePointer(ptr)</h4> 
<pre><code class="prism language-js"><span class="token keyword">function</span> <span class="token function">frida_Java</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    Java<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">let</span> base_pointer <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">findModuleByName</span><span class="token punctuation">(</span><span class="token string">'libc.so'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>base<span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>base_pointer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> r <span class="token operator">=</span> Memory<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span><span class="token function">writePointer</span><span class="token punctuation">(</span>base_pointer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> readByteArray <span class="token operator">=</span> Memory<span class="token punctuation">.</span><span class="token function">readByteArray</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>readByteArray<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"----------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">setImmediate</span><span class="token punctuation">(</span>frida_Java<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/16/16/j8StiDPf_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="readS32readU32_361"></a>readS32()、readU32()</h4> 
<ul><li>从该内存位置读取有符号或无符号8/16/32/etc或浮点数/双精度值，并将其作为数字返回。</li></ul> 
<pre><code class="prism language-js"><span class="token keyword">function</span> <span class="token function">frida_Java</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    Java<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">let</span> base_pointer <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">findModuleByName</span><span class="token punctuation">(</span><span class="token string">'libc.so'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>base<span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>base_pointer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>base_pointer<span class="token punctuation">.</span><span class="token function">readS32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>base_pointer<span class="token punctuation">.</span><span class="token function">readU32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"------------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">setImmediate</span><span class="token punctuation">(</span>frida_Java<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="writeS32writeU32_376"></a>writeS32()、writeU32()</h4> 
<ul><li>将有符号或无符号8/16/32/等或浮点数/双精度值写入此内存位置。</li></ul> 
<pre><code class="prism language-js"><span class="token keyword">function</span> <span class="token function">frida_Java</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    Java<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">let</span> base_pointer <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">findModuleByName</span><span class="token punctuation">(</span><span class="token string">'libc.so'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>base<span class="token punctuation">;</span>
       <span class="token keyword">let</span> r <span class="token operator">=</span> Memory<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       r<span class="token punctuation">.</span><span class="token function">writeS32</span><span class="token punctuation">(</span><span class="token number">0x12345678</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">readByteArray</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">setImmediate</span><span class="token punctuation">(</span>frida_Java<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/66/87/WbBQHigP_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="readByteArraylengthwriteByteArraybytes_391"></a>readByteArray(length))、writeByteArray(bytes)</h4> 
<ul><li>readByteArray(length))连续读取内存length个字节，、writeByteArray连续写入内存bytes。</li></ul> 
<pre><code class="prism language-js"><span class="token keyword">function</span> <span class="token function">frida_Java</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    Java<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token number">0x72</span><span class="token punctuation">,</span> <span class="token number">0x6F</span><span class="token punctuation">,</span> <span class="token number">0x79</span><span class="token punctuation">,</span> <span class="token number">0x73</span><span class="token punctuation">,</span> <span class="token number">0x75</span><span class="token punctuation">,</span> <span class="token number">0x65</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> r <span class="token operator">=</span> Memory<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
      Memory<span class="token punctuation">.</span><span class="token function">writeByteArray</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> buffer <span class="token operator">=</span> Memory<span class="token punctuation">.</span><span class="token function">readByteArray</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">hexdump</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
            offset<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            length<span class="token operator">:</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
            header<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            ansi<span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"----------------------"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">setImmediate</span><span class="token punctuation">(</span>frida_Java<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/71/f4/p99ck7Nv_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="readCStringsize__1writeUtf8Stringstr_413"></a>readCString([size = -1])、writeUtf8String(str)</h4> 
<ul><li>readCString功能是读取指针地址位置的字节字符串，对应的writeUtf8String是写入指针地址位置的字符串处。</li></ul> 
<pre><code class="prism language-js"><span class="token keyword">function</span> <span class="token function">frida_Java</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    Java<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token number">0x72</span><span class="token punctuation">,</span> <span class="token number">0x6F</span><span class="token punctuation">,</span> <span class="token number">0x79</span><span class="token punctuation">,</span> <span class="token number">0x73</span><span class="token punctuation">,</span> <span class="token number">0x75</span><span class="token punctuation">,</span> <span class="token number">0x65</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> r <span class="token operator">=</span> Memory<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
      Memory<span class="token punctuation">.</span><span class="token function">writeByteArray</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> buffer <span class="token operator">=</span> Memory<span class="token punctuation">.</span><span class="token function">readByteArray</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">hexdump</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
            offset<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            length<span class="token operator">:</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
            header<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            ansi<span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"----------------------"</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"readCString():"</span> <span class="token operator">+</span> r<span class="token punctuation">.</span><span class="token function">readCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> newPtrstr <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">writeUtf8String</span><span class="token punctuation">(</span><span class="token string">"hhhhhhh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"readCString():"</span> <span class="token operator">+</span> newPtrstr<span class="token punctuation">.</span><span class="token function">readCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">setImmediate</span><span class="token punctuation">(</span>frida_Java<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="NativeFunction_437"></a>NativeFunction对象</h3> 
<ul><li>创建新的NativeFunction以调用address处的函数(用NativePointer指定)，其中rereturn Type指定返回类型，argTypes数组指定参数类型</li></ul> 
<pre><code class="prism language-js"><span class="token comment">//创建friendlyFunctionPtr地址的函数</span>
<span class="token keyword">var</span> friendlyFunctionName <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NativeFunction</span><span class="token punctuation">(</span>friendlyFunctionPtr<span class="token punctuation">,</span>
    <span class="token string">'void'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'pointer'</span><span class="token punctuation">,</span> <span class="token string">'pointer'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//申请内存空间    </span>
<span class="token keyword">var</span> returnValue <span class="token operator">=</span> Memory<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span>sizeOfLargeObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//调用friendlyFunctionName函数</span>
<span class="token function">friendlyFunctionName</span><span class="token punctuation">(</span>returnValue<span class="token punctuation">,</span> thisPtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>函数定义格式为new NativeFunction(address, returnType, argTypes[, options])，参照这个格式能够创建函数并且调用！returnType和argTypes[，]分别可以填void、pointer、int、uint、long、ulong、char、uchar、float、double、int8、uint8、int16、uint16、int32、uint32、int64、uint64这些类型，根据函数的所需要的type来定义即可</li><li>在定义的时候必须要将参数类型个数和参数类型以及返回值完全匹配，假设有三个参数都是int，则new NativeFunction(address, returnType, [‘int’, ‘int’, ‘int’])，而返回值是int则new NativeFunction(address, ‘int’, argTypes[, options])，必须要全部匹配，并且第一个参数一定要是函数地址指针。</li></ul> 
<h3><a id="NativeCallback_450"></a>NativeCallback对象</h3> 
<ul><li>new NativeCallback(func，rereturn Type，argTypes[，ABI])：创建一个由JavaScript函数func实现的新NativeCallback，其中rereturn Type指定返回类型，argTypes数组指定参数类型。</li><li>返回的对象也是一个NativePointer，因此可以传递给Interceptor#replace。当将产生的回调与Interceptor.replace()一起使用时，将调用func，并将其绑定到具有一些有用属性的对象，就像Interceptor.Attach()中的那样。</li><li>Example:</li></ul> 
<pre><code class="prism language-js">Java<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">var</span> add_method <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NativeFunction</span><span class="token punctuation">(</span>Module<span class="token punctuation">.</span><span class="token function">findExportByName</span><span class="token punctuation">(</span><span class="token string">'libhello.so'</span><span class="token punctuation">,</span> <span class="token string">'c_getSum'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
       <span class="token string">'int'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string">'int'</span><span class="token punctuation">,</span><span class="token string">'int'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"result:"</span><span class="token punctuation">,</span><span class="token function">add_method</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">//在这里new一个新的函数，但是参数的个数和返回值必须对应</span>
       Interceptor<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>add_method<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">NativeCallback</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token number">123</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'int'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'int'</span><span class="token punctuation">,</span> <span class="token string">'int'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"result:"</span><span class="token punctuation">,</span><span class="token function">add_method</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/aa51edfca0318847796e5b49ce89ea28/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">jsoncpp在window下的编译</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c7e111137819c50c486bd9ac964be8a6/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">深度学习中AP、mAP、recall、IoU、NMS的评价指标介绍</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>