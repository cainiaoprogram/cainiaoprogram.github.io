<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Qt：使用FFmpeg解码视频流 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Qt：使用FFmpeg解码视频流" />
<meta property="og:description" content="Debug和Release載入不同動態庫：
//將lib文件放到對應工程目錄下，在.pro添加存放lib的路徑 LIBPATH &#43;= $$PWD/Library/Lib //debug為active時處理LIBS &#43;= -L$$LIB_PATH -lOpengl32... CONFIG(debug, debug|release){ LIBS &#43;= -L$$LIBPATH -lOpengl32...} else{LIBS &#43;= -L$$LIBPATH -lOpengl32 -lavcodec...} 或 CONFIG(debug, debug|release)：LIBS &#43;= -L$$LIBPATH -lOpengl32... CONFIG(release, debug|release)：LIBS &#43;= -L$$LIBPATH -lOpengl32 -lavcodec.. //在對應的debug或release目錄下添加使用的.dll文件 //本例中用到的库文件： INCLUDEPATH &#43;= $$PWD/Dev/include LIBPATH &#43;= $$PWD/Dev/lib LIBS &#43;= -L$$LIBPATH -lavcodec -lavdevice -lavfilter -lavformat -lavutil -lpostproc -lswresample -lswscale 屏蔽QDebug()提示信息：在pro文件中添加：DEFINES&#43;=QT_NO_DEBUG_OUTPUT
FFmpeg：
靜態庫版本：Static，只包含三個應用程式，不依賴動態庫可單獨運行；
動態庫版本：Shared，除應用程式外還包含dll動態庫；
開發者版本：Dev，包含lib文件和.h文件，但不包含dll文件。
使用ffmpeg要注意對應版本（如編譯器32位則使用32位的FFmpeg版本），ffmpeg庫為C文件，導入需在頭文件添加關鍵詞extetn “C”。
可將dll拷貝進lib，發佈時再拷貝dll進運行目錄或將dll拷貝進運行目錄。
檢查環境配置是否搭建成功：
unsigned version = avcodec_version(); QString ch = QString::number(version,10); qDebug()&lt;&lt;&#34;version: &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/08ce972632bbf5ada6534d7bf3154005/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-29T09:48:23+08:00" />
<meta property="article:modified_time" content="2022-12-29T09:48:23+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Qt：使用FFmpeg解码视频流</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><strong>Debug和Release載入不同動態庫：</strong></p> 
<pre><code class="prism language-cpp"><span class="token comment">//將lib文件放到對應工程目錄下，在.pro添加存放lib的路徑</span>
LIBPATH <span class="token operator">+=</span> $$PWD<span class="token operator">/</span>Library<span class="token operator">/</span>Lib
<span class="token comment">//debug為active時處理LIBS += -L$$LIB_PATH -lOpengl32...</span>
<span class="token function">CONFIG</span><span class="token punctuation">(</span>debug<span class="token punctuation">,</span> debug<span class="token operator">|</span>release<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> LIBS <span class="token operator">+=</span> <span class="token operator">-</span>L$$LIBPATH <span class="token operator">-</span>lOpengl32<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
<span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>LIBS <span class="token operator">+=</span> <span class="token operator">-</span>L$$LIBPATH <span class="token operator">-</span>lOpengl32 <span class="token operator">-</span>lavcodec<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
或
<span class="token function">CONFIG</span><span class="token punctuation">(</span>debug<span class="token punctuation">,</span> debug<span class="token operator">|</span>release<span class="token punctuation">)</span>：LIBS <span class="token operator">+=</span> <span class="token operator">-</span>L$$LIBPATH <span class="token operator">-</span>lOpengl32<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token function">CONFIG</span><span class="token punctuation">(</span>release<span class="token punctuation">,</span> debug<span class="token operator">|</span>release<span class="token punctuation">)</span>：LIBS <span class="token operator">+=</span> <span class="token operator">-</span>L$$LIBPATH <span class="token operator">-</span>lOpengl32 <span class="token operator">-</span>lavcodec<span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment">//在對應的debug或release目錄下添加使用的.dll文件</span>

<span class="token comment">//本例中用到的库文件：</span>
INCLUDEPATH <span class="token operator">+=</span> $$PWD<span class="token operator">/</span>Dev<span class="token operator">/</span>include
LIBPATH <span class="token operator">+=</span> $$PWD<span class="token operator">/</span>Dev<span class="token operator">/</span>lib
LIBS <span class="token operator">+=</span> <span class="token operator">-</span>L$$LIBPATH <span class="token operator">-</span>lavcodec <span class="token operator">-</span>lavdevice <span class="token operator">-</span>lavfilter <span class="token operator">-</span>lavformat <span class="token operator">-</span>lavutil <span class="token operator">-</span>lpostproc <span class="token operator">-</span>lswresample <span class="token operator">-</span>lswscale
</code></pre> 
<p><strong>屏蔽QDebug()提示信息</strong>：在pro文件中添加：<code>DEFINES+=QT_NO_DEBUG_OUTPUT</code></p> 
<p><strong>FFmpeg：</strong><br> 靜態庫版本：<strong>Static</strong>，只包含三個應用程式，不依賴動態庫可單獨運行；<br> 動態庫版本：<strong>Shared</strong>，除應用程式外還包含dll動態庫；<br> 開發者版本：<strong>Dev</strong>，包含lib文件和.h文件，但不包含dll文件。<br> 使用ffmpeg要注意對應版本（如編譯器32位則使用32位的FFmpeg版本），ffmpeg庫為C文件，導入需在頭文件添加關鍵詞extetn “C”。</p> 
<p>可將dll拷貝進lib，發佈時再拷貝dll進運行目錄或將dll拷貝進運行目錄。<br> 檢查環境配置是否搭建成功：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">unsigned</span> version <span class="token operator">=</span> <span class="token function">avcodec_version</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
QString ch <span class="token operator">=</span> <span class="token class-name">QString</span><span class="token double-colon punctuation">::</span><span class="token function">number</span><span class="token punctuation">(</span>version<span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">"version: "</span><span class="token operator">&lt;&lt;</span>version<span class="token operator">&lt;&lt;</span><span class="token string">"\n配置信息："</span><span class="token operator">&lt;&lt;</span><span class="token function">avcodec_configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>注册FFmpeg组件：注册和初始化FFmpeg封装器和网络设备</p> 
<pre><code class="prism language-cpp"><span class="token function">av_register_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">avformat_network_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>QAudioOutput</strong><br> 是Qt中播放音频的类，要使用它，需要在pro中加入 <code>QT += multimedia</code></p> 
<p><strong>程序代码：</strong><br> (1)设置继承线程继承QThread</p> 
<p><strong>basicthread.h</strong></p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">BASICTHREAD_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BASICTHREAD_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QThread&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QDebug&gt;</span></span>
<span class="token keyword">extern</span> <span class="token string">"C"</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;libavcodec/avcodec.h&gt;</span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;libavformat/avformat.h&gt;</span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;libswscale/swscale.h&gt;</span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;libavdevice/avdevice.h&gt;</span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;libavformat/version.h&gt;</span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;libavutil/time.h&gt;</span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;libavutil/mathematics.h&gt;</span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"libswresample/swresample.h"</span></span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">basicthread</span><span class="token operator">:</span><span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">QThread</span></span>
<span class="token punctuation">{<!-- --></span>
    Q_OBJECT
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">basicthread</span><span class="token punctuation">(</span>QObject <span class="token operator">*</span> parent <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">~</span><span class="token function">basicthread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// BASICTHREAD_H</span></span>
</code></pre> 
<p><strong>basicthread.cpp</strong></p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"basicthread.h"</span></span>
basicthread<span class="token double-colon punctuation">::</span><span class="token function">basicthread</span><span class="token punctuation">(</span>QObject <span class="token operator">*</span> parent<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">QThread</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>
<span class="token class-name">basicthread</span><span class="token double-colon punctuation">::</span><span class="token operator">~</span><span class="token function">basicthread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token function">quit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">"~BasicThread"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>（2）初始化视频流线程：</p> 
<p><strong>initthread.h</strong></p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">INITTHREAD_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INITTHREAD_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"basicthread.h"</span></span>

<span class="token keyword">class</span> <span class="token class-name">initthread</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">basicthread</span></span>
<span class="token punctuation">{<!-- --></span>
    Q_OBJECT
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">initthread</span><span class="token punctuation">(</span>QObject<span class="token operator">*</span>parent<span class="token operator">=</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">closeinitthread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    SwrContext<span class="token operator">*</span>swrContext<span class="token punctuation">;</span>
    AVCodecContext<span class="token operator">*</span>audioCodecContext<span class="token punctuation">;</span>
signals<span class="token operator">:</span>
    <span class="token keyword">void</span> <span class="token function">sendcontext</span><span class="token punctuation">(</span>AVFormatContext<span class="token operator">*</span><span class="token punctuation">,</span>AVCodecContext<span class="token operator">*</span><span class="token punctuation">,</span>AVCodecContext<span class="token operator">*</span><span class="token punctuation">,</span>SwrContext<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">protected</span><span class="token operator">:</span>
    <span class="token comment">//重写虚函数run(),只有在此函数在新线程里，运行完毕后该线程生命周期结束</span>
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// INITTHREAD_H</span></span>
</code></pre> 
<p><strong>initthread.cpp</strong></p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"initthread.h"</span></span>

initthread<span class="token double-colon punctuation">::</span><span class="token function">initthread</span><span class="token punctuation">(</span>QObject<span class="token operator">*</span>parent<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">basicthread</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> initthread<span class="token double-colon punctuation">::</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> videoStreamIndex<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">int</span> audioStreamIndex<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>uint i<span class="token punctuation">;</span>
      <span class="token comment">//注册库中所有可用的文件格式和解码器</span>
      <span class="token function">av_register_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//初始化网络流格式,使用RTSP网络流时必须先执行</span>
      <span class="token function">avformat_network_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//申請一個AVFormatContext結構的内存，並進行簡單初始化</span>
      AVFormatContext<span class="token operator">*</span> avFormatContext <span class="token operator">=</span> <span class="token function">avformat_alloc_context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">//打開視頻流</span>
      <span class="token keyword">int</span> ret<span class="token operator">=</span><span class="token function">avformat_open_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>avFormatContext<span class="token punctuation">,</span><span class="token string">"C:\\Users\\shelly\\Desktop\\guitar.mp4"</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
          <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">"打開視頻流失敗"</span><span class="token punctuation">;</span>
           <span class="token function">avformat_free_context</span><span class="token punctuation">(</span>avFormatContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">//讀取流數據包並獲取相關信息</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">avformat_find_stream_info</span><span class="token punctuation">(</span>avFormatContext<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
           <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">"獲取視頻流信息失敗"</span><span class="token punctuation">;</span>
           <span class="token function">avformat_close_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>avFormatContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

      <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>avFormatContext<span class="token operator">-&gt;</span>nb_streams<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
          <span class="token comment">//確定流格式是否為視頻</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>avFormatContext<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_type<span class="token operator">==</span>AVMEDIA_TYPE_VIDEO<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
              videoStreamIndex<span class="token operator">=</span>i<span class="token punctuation">;</span> 
          <span class="token punctuation">}</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>videoStreamIndex<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
              <span class="token function">avformat_close_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>avFormatContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">"獲取視頻流索引失敗"</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token comment">//確定流格式是否為音頻</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>avFormatContext<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_type<span class="token operator">==</span>AVMEDIA_TYPE_AUDIO<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
              audioStreamIndex<span class="token operator">=</span>i<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">//视频部分处理</span>
      <span class="token comment">//根據編碼器ID獲取視頻劉解碼器</span>
      AVCodec<span class="token operator">*</span>videoCodec <span class="token operator">=</span> <span class="token function">avcodec_find_decoder</span><span class="token punctuation">(</span>avFormatContext<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>videoStreamIndex<span class="token punctuation">]</span><span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>videoCodec<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
          <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">"尋找视频解碼器失敗"</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">//获取视频编解码器上下文信息</span>
      AVCodecContext<span class="token operator">*</span>videoCodecContext <span class="token operator">=</span> <span class="token function">avcodec_alloc_context3</span><span class="token punctuation">(</span>videoCodec<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>videoCodecContext<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
          <span class="token function">avformat_close_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>avFormatContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">"获取上下文信息失败"</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">//拷贝视频上下文信息</span>
      <span class="token keyword">int</span> ret1<span class="token operator">=</span><span class="token function">avcodec_parameters_to_context</span><span class="token punctuation">(</span>videoCodecContext<span class="token punctuation">,</span>avFormatContext<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>videoStreamIndex<span class="token punctuation">]</span><span class="token operator">-&gt;</span>codecpar<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>ret1<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
          <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">"拷贝视频流成功"</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>ret1<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
          <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">"拷贝视频流失败！"</span><span class="token punctuation">;</span>
          <span class="token function">avformat_close_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>avFormatContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">//打開對應视频解碼器</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">avcodec_open2</span><span class="token punctuation">(</span>videoCodecContext<span class="token punctuation">,</span>videoCodec<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
         <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">"打開视频解碼器失敗"</span><span class="token punctuation">;</span>
         <span class="token function">avformat_close_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>avFormatContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">avcodec_free_context</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>videoCodecContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">//音频部分处理</span>
      <span class="token comment">//根據編碼器ID獲取音频劉解碼器</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>audioStreamIndex<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
          AVCodec<span class="token operator">*</span>audioCodec<span class="token punctuation">;</span>
          audioCodec<span class="token operator">=</span> <span class="token function">avcodec_find_decoder</span><span class="token punctuation">(</span>avFormatContext<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>audioStreamIndex<span class="token punctuation">]</span><span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>audioCodec<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
              <span class="token comment">//获取音频编解码器上下文信息</span>
              <span class="token comment">/*AVCodecContext**/</span>audioCodecContext <span class="token operator">=</span> <span class="token function">avcodec_alloc_context3</span><span class="token punctuation">(</span>audioCodec<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">if</span><span class="token punctuation">(</span>audioCodecContext<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                  <span class="token function">avformat_close_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>avFormatContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">"获取上下文信息失败"</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>

              <span class="token keyword">int</span> ret2<span class="token operator">=</span><span class="token function">avcodec_parameters_to_context</span><span class="token punctuation">(</span>audioCodecContext<span class="token punctuation">,</span>avFormatContext<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>audioStreamIndex<span class="token punctuation">]</span><span class="token operator">-&gt;</span>codecpar<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">if</span><span class="token punctuation">(</span>ret2<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                  <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">"拷贝音频流成功"</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
              <span class="token keyword">if</span><span class="token punctuation">(</span>ret2<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                  <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">"拷贝音频流失败！"</span><span class="token punctuation">;</span>
                  <span class="token function">avformat_close_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>avFormatContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>

              <span class="token comment">//打開對應音频解碼器</span>
              <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">avcodec_open2</span><span class="token punctuation">(</span>audioCodecContext<span class="token punctuation">,</span>audioCodec<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                 <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">"打開音频解碼器失敗"</span><span class="token punctuation">;</span>
                 <span class="token function">avformat_close_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>avFormatContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token function">avcodec_free_context</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>audioCodecContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>

              <span class="token comment">//音频流特殊处理部分</span>
              <span class="token comment">//音频转码配置</span>
              <span class="token comment">//ffmpeg中刚刚解码出的数据因为排列方式的原因，不能直接播放，必须要转换，首先根据音频解码上下文设置并初始化转换上下文：</span>
              <span class="token comment">/*SwrContext**/</span>swrContext <span class="token operator">=</span> <span class="token function">swr_alloc_set_opts</span><span class="token punctuation">(</span>
                          <span class="token keyword">nullptr</span><span class="token punctuation">,</span>
                          AV_CH_LAYOUT_STEREO<span class="token punctuation">,</span>
                          AV_SAMPLE_FMT_S16<span class="token punctuation">,</span>
                          <span class="token number">44100</span><span class="token punctuation">,</span>
                          audioCodecContext<span class="token operator">-&gt;</span>channel_layout<span class="token punctuation">,</span>
                          audioCodecContext<span class="token operator">-&gt;</span>sample_fmt<span class="token punctuation">,</span>
                          audioCodecContext<span class="token operator">-&gt;</span>sample_rate<span class="token punctuation">,</span>
                          <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">swr_init</span><span class="token punctuation">(</span>swrContext<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                  <span class="token function">avformat_close_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>avFormatContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token function">avcodec_free_context</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>videoCodecContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token function">avcodec_free_context</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>audioCodecContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
          <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">"尋找音频解碼器失敗"</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
          
      <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">"視頻流初始化成功"</span><span class="token punctuation">;</span>
      emit <span class="token function">sendcontext</span><span class="token punctuation">(</span>avFormatContext<span class="token punctuation">,</span>videoCodecContext<span class="token punctuation">,</span>audioCodecContext<span class="token punctuation">,</span>swrContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>（3）解码线程：</p> 
<p><strong>decodethread.h</strong></p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">DECODETHREAD_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DECODETHREAD_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"basicthread.h"</span></span>

<span class="token keyword">class</span> <span class="token class-name">DecodeThread</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">basicthread</span></span>
<span class="token punctuation">{<!-- --></span>
    Q_OBJECT
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">DecodeThread</span><span class="token punctuation">(</span>QObject<span class="token operator">*</span>parent<span class="token operator">=</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">closeThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    AVFrame <span class="token operator">*</span> <span class="token function">senddecode</span><span class="token punctuation">(</span>AVCodecContext <span class="token operator">*</span>avCodecContext<span class="token punctuation">,</span>AVPacket <span class="token operator">*</span>avpacket<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">decodeframe</span><span class="token punctuation">(</span>AVFrame <span class="token operator">*</span> avFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">decodeaudio</span><span class="token punctuation">(</span>AVFrame <span class="token operator">*</span> avFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">getcontext</span><span class="token punctuation">(</span>AVFormatContext<span class="token operator">*</span><span class="token punctuation">,</span>AVCodecContext<span class="token operator">*</span><span class="token punctuation">,</span>AVCodecContext<span class="token operator">*</span><span class="token punctuation">,</span>SwrContext<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
signals<span class="token operator">:</span>
    <span class="token keyword">void</span> <span class="token function">senddecodemsg</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span><span class="token operator">*</span><span class="token punctuation">,</span><span class="token keyword">int</span><span class="token punctuation">,</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">sendaudiomsg</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">,</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">volatile</span> <span class="token keyword">bool</span> isRun<span class="token punctuation">;</span>
    <span class="token keyword">uint8_t</span> <span class="token operator">*</span> buffer <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    AVFormatContext<span class="token operator">*</span>getavformatContext<span class="token punctuation">;</span>
    AVCodecContext<span class="token operator">*</span>getavcodecContext<span class="token punctuation">;</span>
    AVCodecContext<span class="token operator">*</span>getaudiocontext<span class="token punctuation">;</span>
    SwrContext<span class="token operator">*</span>getswrcontext<span class="token punctuation">;</span>
<span class="token keyword">protected</span><span class="token operator">:</span>
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// DECODETHREAD_H</span></span>
</code></pre> 
<p><strong>decodethread.cpp</strong></p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"decodethread.h"</span></span>

<span class="token class-name">DecodeThread</span><span class="token double-colon punctuation">::</span><span class="token function">DecodeThread</span><span class="token punctuation">(</span>QObject<span class="token operator">*</span>parent<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">basicthread</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
   isRun<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>   
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token class-name">DecodeThread</span><span class="token double-colon punctuation">::</span><span class="token function">closeThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    isRun<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">DecodeThread</span><span class="token double-colon punctuation">::</span><span class="token function">getcontext</span><span class="token punctuation">(</span>AVFormatContext<span class="token operator">*</span>avformatContext<span class="token punctuation">,</span>AVCodecContext<span class="token operator">*</span>videocontext<span class="token punctuation">,</span>AVCodecContext<span class="token operator">*</span>audiocontext<span class="token punctuation">,</span>SwrContext<span class="token operator">*</span>swrcontext<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    getavformatContext<span class="token operator">=</span>avformatContext<span class="token punctuation">;</span>
    getvideocontext<span class="token operator">=</span>videocontext<span class="token punctuation">;</span>
    getaudiocontext<span class="token operator">=</span>audiocontext<span class="token punctuation">;</span>
    getswrcontext<span class="token operator">=</span>swrcontext<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">DecodeThread</span><span class="token double-colon punctuation">::</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>isRun<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">msleep</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        AVPacket <span class="token operator">*</span> avpacket<span class="token operator">=</span><span class="token function">av_packet_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> a<span class="token operator">=</span><span class="token function">av_read_frame</span><span class="token punctuation">(</span>getavformatContext<span class="token punctuation">,</span>avpacket<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>a<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">av_packet_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>avpacket<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        AVFrame<span class="token operator">*</span> pavFrame<span class="token operator">=</span><span class="token function">av_frame_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>avpacket<span class="token operator">-&gt;</span>stream_index<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            pavFrame<span class="token operator">=</span><span class="token function">senddecode</span><span class="token punctuation">(</span>getaudiocontext<span class="token punctuation">,</span>avpacket<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>pavFrame<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
            <span class="token function">decodeaudio</span><span class="token punctuation">(</span>pavFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">av_frame_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pavFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">av_packet_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>avpacket<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>avpacket<span class="token operator">-&gt;</span>stream_index<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            pavFrame<span class="token operator">=</span><span class="token function">senddecode</span><span class="token punctuation">(</span>getvideocontext<span class="token punctuation">,</span>avpacket<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>pavFrame<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
            <span class="token function">decodeframe</span><span class="token punctuation">(</span>pavFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">av_frame_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pavFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">av_packet_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>avpacket<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token function">avcodec_close</span><span class="token punctuation">(</span>getvideocontext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">avformat_close_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>getavformatContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

AVFrame <span class="token operator">*</span> <span class="token class-name">DecodeThread</span><span class="token double-colon punctuation">::</span><span class="token function">senddecode</span><span class="token punctuation">(</span>AVCodecContext <span class="token operator">*</span> avCodecContext<span class="token punctuation">,</span>AVPacket <span class="token operator">*</span> avpacket<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">avcodec_send_packet</span><span class="token punctuation">(</span>avCodecContext<span class="token punctuation">,</span>avpacket<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">av_packet_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>avpacket<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    AVFrame<span class="token operator">*</span> avFrame<span class="token operator">=</span><span class="token function">av_frame_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> nret<span class="token operator">=</span><span class="token function">avcodec_receive_frame</span><span class="token punctuation">(</span>avCodecContext<span class="token punctuation">,</span>avFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>nret<span class="token operator">==</span><span class="token function">AVERROR</span><span class="token punctuation">(</span>EAGAIN<span class="token punctuation">)</span><span class="token operator">||</span>nret<span class="token operator">==</span>AVERROR_EOF<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">av_frame_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>avFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>nret<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">av_frame_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>avFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> avFrame<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">DecodeThread</span><span class="token double-colon punctuation">::</span><span class="token function">decodeframe</span><span class="token punctuation">(</span>AVFrame <span class="token operator">*</span> avFrame<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> nwidth<span class="token operator">=</span>avFrame<span class="token operator">-&gt;</span>width<span class="token punctuation">;</span>
    <span class="token keyword">int</span> nheight<span class="token operator">=</span>avFrame<span class="token operator">-&gt;</span>height<span class="token punctuation">;</span>
    videobuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">uint8_t</span><span class="token punctuation">[</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">long</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">1.5</span> <span class="token operator">*</span> nwidth <span class="token operator">*</span> nheight<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> nlen<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>i<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>nheight<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>videobuffer<span class="token operator">+</span>nlen<span class="token punctuation">,</span>avFrame<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span>i<span class="token operator">*</span>avFrame<span class="token operator">-&gt;</span>linesize<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>size_t<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>nwidth<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nlen<span class="token operator">+=</span>nwidth<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>nheight<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>videobuffer<span class="token operator">+</span>nlen<span class="token punctuation">,</span>avFrame<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">+</span>i<span class="token operator">*</span>avFrame<span class="token operator">-&gt;</span>linesize<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>size_t<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>nwidth<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nlen<span class="token operator">+=</span>nwidth<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>nheight<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>videobuffer<span class="token operator">+</span>nlen<span class="token punctuation">,</span>avFrame<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">+</span>i<span class="token operator">*</span>avFrame<span class="token operator">-&gt;</span>linesize<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>size_t<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>nwidth<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nlen<span class="token operator">+=</span>nwidth<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    emit <span class="token function">senddecodemsg</span><span class="token punctuation">(</span>videobuffer<span class="token punctuation">,</span>nwidth<span class="token punctuation">,</span>nheight<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">DecodeThread</span><span class="token double-colon punctuation">::</span><span class="token function">decodeaudio</span><span class="token punctuation">(</span>AVFrame <span class="token operator">*</span> avFrame<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

    <span class="token keyword">int64_t</span> out_nb_samples <span class="token operator">=</span> <span class="token function">av_rescale_rnd</span><span class="token punctuation">(</span>
                <span class="token function">swr_get_delay</span><span class="token punctuation">(</span>getswrcontext<span class="token punctuation">,</span> avFrame<span class="token operator">-&gt;</span>sample_rate<span class="token punctuation">)</span> <span class="token operator">+</span> avFrame<span class="token operator">-&gt;</span>nb_samples<span class="token punctuation">,</span>
                <span class="token number">44100</span><span class="token punctuation">,</span> avFrame<span class="token operator">-&gt;</span>sample_rate<span class="token punctuation">,</span> AV_ROUND_UP<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//重采样</span>
    <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token function">av_samples_get_buffer_size</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> avFrame<span class="token operator">-&gt;</span>channels<span class="token punctuation">,</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>out_nb_samples<span class="token punctuation">)</span><span class="token punctuation">,</span> AV_SAMPLE_FMT_S16<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    audiobuffer<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">uint8_t</span><span class="token punctuation">[</span>size<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">swr_convert</span><span class="token punctuation">(</span>
                getswrcontext<span class="token punctuation">,</span><span class="token operator">&amp;</span>audiobuffer<span class="token punctuation">,</span>
                <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>out_nb_samples<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>avFrame<span class="token operator">-&gt;</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>avFrame<span class="token operator">-&gt;</span>nb_samples<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">delete</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> audiobuffer<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> size1 <span class="token operator">=</span> <span class="token function">av_samples_get_buffer_size</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> avFrame<span class="token operator">-&gt;</span>channels<span class="token punctuation">,</span> len<span class="token punctuation">,</span> AV_SAMPLE_FMT_S16<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    emit <span class="token function">sendaudiomsg</span><span class="token punctuation">(</span>audiobuffer<span class="token punctuation">,</span>size1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>（4）显示窗口：</p> 
<p><strong>openglwidget.h</strong></p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">OPENGLWIDGET_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OPENGLWIDGET_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"decodethread.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"initthread.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QOpenGLWidget&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QOpenGLFunctions&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QOpenGLBuffer&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QOpenGLShader&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QOpenGLTexture&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QAudioFormat&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QAudioDeviceInfo&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QAudioOutput&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QFileInfo&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QTimer&gt;</span></span>
<span class="token keyword">class</span> <span class="token class-name">openglwidget</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">QOpenGLWidget</span><span class="token punctuation">,</span><span class="token keyword">protected</span> <span class="token class-name">QOpenGLFunctions</span></span>
<span class="token punctuation">{<!-- --></span>
    Q_OBJECT
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">openglwidget</span><span class="token punctuation">(</span>QWidget <span class="token operator">*</span>parent <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">~</span><span class="token function">openglwidget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">startdecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">startinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">initaudioplayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">protected</span><span class="token operator">:</span>
    <span class="token keyword">void</span> <span class="token function">initializeGL</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Q_DECL_OVERRIDE<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">paintGL</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Q_DECL_OVERRIDE<span class="token punctuation">;</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    QOpenGLShaderProgram <span class="token operator">*</span>program<span class="token punctuation">;</span>
    QOpenGLBuffer vbo<span class="token punctuation">;</span>
    GLuint textureUniformY<span class="token punctuation">,</span>textureUniformU<span class="token punctuation">,</span>textureUniformV<span class="token punctuation">;</span> <span class="token comment">//opengl中y、u、v分量位置</span>
    QOpenGLTexture <span class="token operator">*</span>textureY <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span><span class="token operator">*</span>textureU <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span><span class="token operator">*</span>textureV <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    GLuint idY<span class="token punctuation">,</span>idU<span class="token punctuation">,</span>idV<span class="token punctuation">;</span> <span class="token comment">//自己创建的纹理对象ID，创建错误返回0</span>
    uint videoW<span class="token punctuation">,</span>videoH<span class="token punctuation">;</span>
    <span class="token keyword">uint8_t</span> <span class="token operator">*</span>yuvPtr<span class="token punctuation">;</span>
    initthread<span class="token operator">*</span>init<span class="token punctuation">;</span>
    DecodeThread <span class="token operator">*</span>decode<span class="token punctuation">;</span>
    AVFormatContext<span class="token operator">*</span>formatc<span class="token punctuation">;</span>
    AVCodecContext<span class="token operator">*</span>codecc<span class="token punctuation">;</span>
    SwrContext<span class="token operator">*</span>swrc<span class="token punctuation">;</span>
    QIODevice <span class="token operator">*</span>outputDevice <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    QAudioOutput <span class="token operator">*</span>qOutput <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> slots<span class="token operator">:</span>
    <span class="token keyword">void</span> <span class="token function">updateFrame</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span> <span class="token operator">*</span>pSrc<span class="token punctuation">,</span><span class="token keyword">int</span><span class="token punctuation">,</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//显示一帧Yuv图像</span>
    <span class="token keyword">void</span> <span class="token function">get</span><span class="token punctuation">(</span>AVFormatContext<span class="token operator">*</span><span class="token punctuation">,</span>AVCodecContext<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">getaudiomsg</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span><span class="token operator">*</span><span class="token punctuation">,</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// OPENGLWIDGET_H</span></span>

</code></pre> 
<p><strong>openglwidget.cpp</strong></p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"openglwidget.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">VERTEXIN</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TEXTUREIN</span> <span class="token expression"><span class="token number">1</span></span></span>
openglwidget<span class="token double-colon punctuation">::</span><span class="token function">openglwidget</span><span class="token punctuation">(</span>QWidget <span class="token operator">*</span>parent<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token function">QOpenGLWidget</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">startinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">initaudioplayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">openglwidget</span><span class="token double-colon punctuation">::</span><span class="token operator">~</span><span class="token function">openglwidget</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">delete</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> yuvPtr<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> openglwidget<span class="token double-colon punctuation">::</span><span class="token function">startinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    init<span class="token operator">=</span><span class="token keyword">new</span> initthread<span class="token punctuation">;</span>
    <span class="token function">connect</span><span class="token punctuation">(</span>init<span class="token punctuation">,</span><span class="token function">SIGNAL</span><span class="token punctuation">(</span><span class="token function">sendcontext</span><span class="token punctuation">(</span>AVFormatContext<span class="token operator">*</span><span class="token punctuation">,</span>AVCodecContext<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token function">SLOT</span><span class="token punctuation">(</span><span class="token function">get</span><span class="token punctuation">(</span>AVFormatContext<span class="token operator">*</span><span class="token punctuation">,</span>AVCodecContext<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    init<span class="token operator">-&gt;</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">"初始化开始"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> openglwidget<span class="token double-colon punctuation">::</span><span class="token function">get</span><span class="token punctuation">(</span>AVFormatContext<span class="token operator">*</span>avf<span class="token punctuation">,</span>AVCodecContext<span class="token operator">*</span>video<span class="token punctuation">,</span>AVCodecContext<span class="token operator">*</span>audio<span class="token punctuation">,</span>SwrContext<span class="token operator">*</span>swr<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    formatc<span class="token operator">=</span>avf<span class="token punctuation">;</span>
    videocodecc<span class="token operator">=</span>video<span class="token punctuation">;</span>
    audiocodecc<span class="token operator">=</span>audio<span class="token punctuation">;</span>
    swrc<span class="token operator">=</span>swr<span class="token punctuation">;</span>
    <span class="token function">startdecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> openglwidget<span class="token double-colon punctuation">::</span><span class="token function">startdecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    decode<span class="token operator">=</span><span class="token keyword">new</span> DecodeThread<span class="token punctuation">;</span>
    <span class="token function">connect</span><span class="token punctuation">(</span>decode<span class="token punctuation">,</span><span class="token function">SIGNAL</span><span class="token punctuation">(</span><span class="token function">senddecodemsg</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span><span class="token operator">*</span><span class="token punctuation">,</span><span class="token keyword">int</span><span class="token punctuation">,</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token function">SLOT</span><span class="token punctuation">(</span><span class="token function">updateFrame</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span><span class="token operator">*</span><span class="token punctuation">,</span><span class="token keyword">int</span><span class="token punctuation">,</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">connect</span><span class="token punctuation">(</span>decode<span class="token punctuation">,</span><span class="token function">SIGNAL</span><span class="token punctuation">(</span><span class="token function">sendaudiomsg</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span><span class="token operator">*</span><span class="token punctuation">,</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token function">SLOT</span><span class="token punctuation">(</span><span class="token function">getaudiomsg</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span><span class="token operator">*</span><span class="token punctuation">,</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    decode<span class="token operator">-&gt;</span><span class="token function">getcontext</span><span class="token punctuation">(</span>formatc<span class="token punctuation">,</span>videocodecc<span class="token punctuation">,</span>audiocodecc<span class="token punctuation">,</span>swrc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    decode<span class="token operator">-&gt;</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">"解码开始"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> openglwidget<span class="token double-colon punctuation">::</span><span class="token function">initaudioplayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    QAudioFormat outformat<span class="token punctuation">;</span>
    outformat<span class="token punctuation">.</span><span class="token function">setSampleRate</span><span class="token punctuation">(</span><span class="token number">44100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    outformat<span class="token punctuation">.</span><span class="token function">setChannelCount</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    outformat<span class="token punctuation">.</span><span class="token function">setSampleSize</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    outformat<span class="token punctuation">.</span><span class="token function">setCodec</span><span class="token punctuation">(</span><span class="token string">"audio/pcm"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    outformat<span class="token punctuation">.</span><span class="token function">setSampleType</span><span class="token punctuation">(</span>QAudioFormat<span class="token double-colon punctuation">::</span>SignedInt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    outformat<span class="token punctuation">.</span><span class="token function">setByteOrder</span><span class="token punctuation">(</span>QAudioFormat<span class="token double-colon punctuation">::</span>LittleEndian<span class="token punctuation">)</span><span class="token punctuation">;</span>

    QAudioDeviceInfo <span class="token function">outDeviceInfo</span><span class="token punctuation">(</span><span class="token class-name">QAudioDeviceInfo</span><span class="token double-colon punctuation">::</span><span class="token function">defaultOutputDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>outDeviceInfo<span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>outDeviceInfo<span class="token punctuation">.</span><span class="token function">isFormatSupported</span><span class="token punctuation">(</span>outformat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        outformat <span class="token operator">=</span> outDeviceInfo<span class="token punctuation">.</span><span class="token function">nearestFormat</span><span class="token punctuation">(</span>outformat<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>qOutput <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        qOutput <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">QAudioOutput</span><span class="token punctuation">(</span>outformat<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    outputDevice <span class="token operator">=</span> qOutput<span class="token operator">-&gt;</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>outputDevice <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> openglwidget<span class="token double-colon punctuation">::</span><span class="token function">getaudiomsg</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span><span class="token operator">*</span>audiomsg<span class="token punctuation">,</span><span class="token keyword">int</span> size<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>audiomsg<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>outputDevice<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    outputDevice<span class="token operator">-&gt;</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>audiomsg<span class="token punctuation">)</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> openglwidget<span class="token double-colon punctuation">::</span><span class="token function">updateFrame</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span><span class="token operator">*</span>pSrc<span class="token punctuation">,</span><span class="token keyword">int</span> width<span class="token punctuation">,</span><span class="token keyword">int</span> height<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    yuvPtr<span class="token operator">=</span>pSrc<span class="token punctuation">;</span>
    videoW <span class="token operator">=</span> width<span class="token punctuation">;</span>
    videoH <span class="token operator">=</span> height<span class="token punctuation">;</span>
    <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> openglwidget<span class="token double-colon punctuation">::</span><span class="token function">initializeGL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token function">initializeOpenGLFunctions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glEnable</span><span class="token punctuation">(</span>GL_DEPTH_TEST<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">const</span> GLfloat vertices<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">//顶点坐标</span>
            <span class="token operator">-</span><span class="token number">1.0f</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.0f</span><span class="token punctuation">,</span>
            <span class="token operator">-</span><span class="token number">1.0f</span><span class="token punctuation">,</span><span class="token operator">+</span><span class="token number">1.0f</span><span class="token punctuation">,</span>
            <span class="token operator">+</span><span class="token number">1.0f</span><span class="token punctuation">,</span><span class="token operator">+</span><span class="token number">1.0f</span><span class="token punctuation">,</span>
            <span class="token operator">+</span><span class="token number">1.0f</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.0f</span><span class="token punctuation">,</span>
            <span class="token comment">//纹理坐标</span>
            <span class="token number">0.0f</span><span class="token punctuation">,</span><span class="token number">1.0f</span><span class="token punctuation">,</span>
            <span class="token number">0.0f</span><span class="token punctuation">,</span><span class="token number">0.0f</span><span class="token punctuation">,</span>
            <span class="token number">1.0f</span><span class="token punctuation">,</span><span class="token number">0.0f</span><span class="token punctuation">,</span>
            <span class="token number">1.0f</span><span class="token punctuation">,</span><span class="token number">1.0f</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    vbo<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vbo<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vbo<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>vertices<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>vertices<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    QOpenGLShader <span class="token operator">*</span>vshader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">QOpenGLShader</span><span class="token punctuation">(</span>QOpenGLShader<span class="token double-colon punctuation">::</span>Vertex<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>vsrc <span class="token operator">=</span>
    <span class="token string">"attribute vec4 vertexIn; \
    attribute vec2 textureIn; \
    varying vec2 textureOut;  \
    void main(void)           \
    {                         \
        gl_Position = vertexIn; \
        textureOut = textureIn; \
    }"</span><span class="token punctuation">;</span>
    vshader<span class="token operator">-&gt;</span><span class="token function">compileSourceCode</span><span class="token punctuation">(</span>vsrc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    QOpenGLShader <span class="token operator">*</span>fshader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">QOpenGLShader</span><span class="token punctuation">(</span>QOpenGLShader<span class="token double-colon punctuation">::</span>Fragment<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>fsrc <span class="token operator">=</span>
    <span class="token string">"varying vec2 textureOut; \
    uniform sampler2D tex_y; \
    uniform sampler2D tex_u; \
    uniform sampler2D tex_v; \
    void main(void) \
    { \
        vec3 yuv; \
        vec3 rgb; \
        yuv.x = texture2D(tex_y, textureOut).r; \
        yuv.y = texture2D(tex_u, textureOut).r - 0.5; \
        yuv.z = texture2D(tex_v, textureOut).r - 0.5; \
        rgb = mat3( 1,       1,         1, \
                    0,       -0.39465,  2.03211, \
                    1.13983, -0.58060,  0) * yuv; \
        gl_FragColor = vec4(rgb, 1); \
    }"</span><span class="token punctuation">;</span>
    fshader<span class="token operator">-&gt;</span><span class="token function">compileSourceCode</span><span class="token punctuation">(</span>fsrc<span class="token punctuation">)</span><span class="token punctuation">;</span>

    program <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">QOpenGLShaderProgram</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    program<span class="token operator">-&gt;</span><span class="token function">addShader</span><span class="token punctuation">(</span>vshader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    program<span class="token operator">-&gt;</span><span class="token function">addShader</span><span class="token punctuation">(</span>fshader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    program<span class="token operator">-&gt;</span><span class="token function">bindAttributeLocation</span><span class="token punctuation">(</span><span class="token string">"vertexIn"</span><span class="token punctuation">,</span>VERTEXIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    program<span class="token operator">-&gt;</span><span class="token function">bindAttributeLocation</span><span class="token punctuation">(</span><span class="token string">"textureIn"</span><span class="token punctuation">,</span>TEXTUREIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    program<span class="token operator">-&gt;</span><span class="token function">link</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    program<span class="token operator">-&gt;</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    program<span class="token operator">-&gt;</span><span class="token function">enableAttributeArray</span><span class="token punctuation">(</span>VERTEXIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    program<span class="token operator">-&gt;</span><span class="token function">enableAttributeArray</span><span class="token punctuation">(</span>TEXTUREIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    program<span class="token operator">-&gt;</span><span class="token function">setAttributeBuffer</span><span class="token punctuation">(</span>VERTEXIN<span class="token punctuation">,</span>GL_FLOAT<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>GLfloat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    program<span class="token operator">-&gt;</span><span class="token function">setAttributeBuffer</span><span class="token punctuation">(</span>TEXTUREIN<span class="token punctuation">,</span>GL_FLOAT<span class="token punctuation">,</span><span class="token number">8</span><span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>GLfloat<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>GLfloat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    textureUniformY <span class="token operator">=</span> program<span class="token operator">-&gt;</span><span class="token function">uniformLocation</span><span class="token punctuation">(</span><span class="token string">"tex_y"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    textureUniformU <span class="token operator">=</span> program<span class="token operator">-&gt;</span><span class="token function">uniformLocation</span><span class="token punctuation">(</span><span class="token string">"tex_u"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    textureUniformV <span class="token operator">=</span> program<span class="token operator">-&gt;</span><span class="token function">uniformLocation</span><span class="token punctuation">(</span><span class="token string">"tex_v"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    textureY <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">QOpenGLTexture</span><span class="token punctuation">(</span>QOpenGLTexture<span class="token double-colon punctuation">::</span>Target2D<span class="token punctuation">)</span><span class="token punctuation">;</span>
    textureU <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">QOpenGLTexture</span><span class="token punctuation">(</span>QOpenGLTexture<span class="token double-colon punctuation">::</span>Target2D<span class="token punctuation">)</span><span class="token punctuation">;</span>
    textureV <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">QOpenGLTexture</span><span class="token punctuation">(</span>QOpenGLTexture<span class="token double-colon punctuation">::</span>Target2D<span class="token punctuation">)</span><span class="token punctuation">;</span>
    textureY<span class="token operator">-&gt;</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    textureU<span class="token operator">-&gt;</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    textureV<span class="token operator">-&gt;</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    idY <span class="token operator">=</span> textureY<span class="token operator">-&gt;</span><span class="token function">textureId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    idU <span class="token operator">=</span> textureU<span class="token operator">-&gt;</span><span class="token function">textureId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    idV <span class="token operator">=</span> textureV<span class="token operator">-&gt;</span><span class="token function">textureId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glClearColor</span><span class="token punctuation">(</span><span class="token number">0.99f</span><span class="token punctuation">,</span><span class="token number">0.99f</span><span class="token punctuation">,</span><span class="token number">0.99f</span><span class="token punctuation">,</span><span class="token number">0.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> openglwidget<span class="token double-colon punctuation">::</span><span class="token function">paintGL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

    <span class="token function">glViewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glActiveTexture</span><span class="token punctuation">(</span>GL_TEXTURE0<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//激活纹理单元GL_TEXTURE0,系统里面的</span>
    <span class="token function">glBindTexture</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span>idY<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//绑定y分量纹理对象id到激活的纹理单元</span>
    <span class="token comment">//使用内存中的数据创建真正的y分量纹理数据</span>
    <span class="token function">glTexImage2D</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>GL_RED<span class="token punctuation">,</span>videoW<span class="token punctuation">,</span>videoH<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>GL_RED<span class="token punctuation">,</span>GL_UNSIGNED_BYTE<span class="token punctuation">,</span>yuvPtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//https://blog.csdn.net/xipiaoyouzi/article/details/53584798 纹理参数解析</span>
    <span class="token function">glTexParameteri</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span>GL_TEXTURE_MAG_FILTER<span class="token punctuation">,</span>GL_LINEAR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glTexParameteri</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span>GL_TEXTURE_MIN_FILTER<span class="token punctuation">,</span>GL_LINEAR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glTexParameteri</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> GL_TEXTURE_WRAP_S<span class="token punctuation">,</span> GL_CLAMP_TO_EDGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glTexParameteri</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> GL_TEXTURE_WRAP_T<span class="token punctuation">,</span> GL_CLAMP_TO_EDGE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">glActiveTexture</span><span class="token punctuation">(</span>GL_TEXTURE1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//激活纹理单元GL_TEXTURE1</span>
    <span class="token function">glBindTexture</span><span class="token punctuation">(</span>GL_TEXTURE1<span class="token punctuation">,</span>idU<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//使用内存中的数据创建真正的u分量纹理数据</span>
    <span class="token function">glTexImage2D</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>GL_RED<span class="token punctuation">,</span>videoW <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">,</span> videoH <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>GL_RED<span class="token punctuation">,</span>GL_UNSIGNED_BYTE<span class="token punctuation">,</span>yuvPtr <span class="token operator">+</span> videoW <span class="token operator">*</span> videoH<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glTexParameteri</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span>GL_TEXTURE_MAG_FILTER<span class="token punctuation">,</span>GL_LINEAR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glTexParameteri</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span>GL_TEXTURE_MIN_FILTER<span class="token punctuation">,</span>GL_LINEAR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glTexParameteri</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> GL_TEXTURE_WRAP_S<span class="token punctuation">,</span> GL_CLAMP_TO_EDGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glTexParameteri</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> GL_TEXTURE_WRAP_T<span class="token punctuation">,</span> GL_CLAMP_TO_EDGE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">glActiveTexture</span><span class="token punctuation">(</span>GL_TEXTURE2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//激活纹理单元GL_TEXTURE2</span>
    <span class="token function">glBindTexture</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span>idV<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//使用内存中的数据创建真正的v分量纹理数据</span>
    <span class="token function">glTexImage2D</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GL_RED<span class="token punctuation">,</span> videoW <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">,</span> videoH <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GL_RED<span class="token punctuation">,</span> GL_UNSIGNED_BYTE<span class="token punctuation">,</span> yuvPtr<span class="token operator">+</span>videoW<span class="token operator">*</span>videoH<span class="token operator">*</span><span class="token number">5</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glTexParameteri</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span>GL_TEXTURE_MAG_FILTER<span class="token punctuation">,</span>GL_LINEAR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glTexParameteri</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span>GL_TEXTURE_MIN_FILTER<span class="token punctuation">,</span>GL_LINEAR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glTexParameteri</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> GL_TEXTURE_WRAP_S<span class="token punctuation">,</span> GL_CLAMP_TO_EDGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glTexParameteri</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> GL_TEXTURE_WRAP_T<span class="token punctuation">,</span> GL_CLAMP_TO_EDGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//指定y纹理要使用新值</span>
    <span class="token function">glUniform1i</span><span class="token punctuation">(</span>textureUniformY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//指定u纹理要使用新值</span>
    <span class="token function">glUniform1i</span><span class="token punctuation">(</span>textureUniformU<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//指定v纹理要使用新值</span>
    <span class="token function">glUniform1i</span><span class="token punctuation">(</span>textureUniformV<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//使用顶点数组方式绘制图形</span>
    <span class="token function">glDrawArrays</span><span class="token punctuation">(</span>GL_TRIANGLE_FAN<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//高亮当前选中窗口</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>main.cpp</strong></p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"openglwidget.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QApplication&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QPixmap&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QLabel&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QHBoxLayout&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    QApplication <span class="token function">a</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    openglwidget openglw<span class="token punctuation">;</span>

    QLabel label<span class="token punctuation">;</span>
    label<span class="token punctuation">.</span><span class="token function">setScaledContents</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    QHBoxLayout hlay<span class="token punctuation">;</span>
    hlay<span class="token punctuation">.</span><span class="token function">addWidget</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>label<span class="token punctuation">)</span><span class="token punctuation">;</span>
    openglw<span class="token punctuation">.</span><span class="token function">setLayout</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hlay<span class="token punctuation">)</span><span class="token punctuation">;</span>

    QPixmap <span class="token function">pix</span><span class="token punctuation">(</span>openglw<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pix<span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span>Qt<span class="token double-colon punctuation">::</span>transparent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    label<span class="token punctuation">.</span><span class="token function">setPixmap</span><span class="token punctuation">(</span>pix<span class="token punctuation">)</span><span class="token punctuation">;</span>

    openglw<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> a<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>**结果显示：**使用电脑录屏的无音频/有音频视频均可播放，但会失真，播放单通道视频需要调播放器及转换参数。(暂时还不会结束线程的操作t-t)<br> <img src="https://images2.imgbox.com/70/ac/sHYR2rKk_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5153cb339a9e956f2cf86cd7720c6be2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">4、表达式dict(zip([1，2]，[3，4]))的值为</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/baa84f49a306eb3fe9e47fba1f93f659/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Qt：FFmpeg解码音频</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>