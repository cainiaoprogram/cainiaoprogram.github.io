<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android 新增加Audio Codec ，遇到的编译问题处理 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android 新增加Audio Codec ，遇到的编译问题处理" />
<meta property="og:description" content="在Android S 上新增加Audio Codec Support ,遇到如下编译问题，记录一下处理方法，
1. error 1
******************************************************
error: VNDK library: libstagefright_foundation&#39;s ABI has EXTENDING CHANGES Please check compatibility report at: out/soong/.intermediates/frameworks/av/media/libstagefright/foundation/libstagefright_foundation/android_vendor.31_arm64_armv8-a_cortex-a73_shared/libstagefright_foundation.so.abidiff
******************************************************
2.error 2
******************************************************
error: VNDK library: libaudioutils&#39;s ABI has EXTENDING CHANGES Please check compatibility report at: out/soong/.intermediates/system/media/audio_utils/libaudioutils/android_vendor.31_arm64_armv8-a_cortex-a73_shared/libaudioutils.so.abidiff
******************************************************
分析error：
1.针对error 1 查看libstagefright_foundation.so.abidiff这个文件提示如下，
lib_name: &#34;libstagefright_foundation&#34; arch: &#34;arm64&#34; global_vars_added { name: &#34;android::MEDIA_MIMETYPE_AUDIO_AVS3&#34; source_file: &#34;frameworks/av/media/libstagefright/foundation/include/media/stagefright/foundation/MediaDefs.h&#34; linker_set_key: &#34;_ZN7android25MEDIA_MIMETYPE_AUDIO_AVS3E&#34; referenced_type: &#34;const char *&#34; access: public_access } added_elf_objects { name: &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/a22bbd14a3ef031a1f57ef9ef36a5b5a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-14T14:46:33+08:00" />
<meta property="article:modified_time" content="2023-02-14T14:46:33+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android 新增加Audio Codec ，遇到的编译问题处理</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>在Android S 上新增加Audio Codec Support ,遇到如下编译问题，记录一下处理方法，</p> 
<p>1. error 1</p> 
<p>******************************************************<br> error: VNDK library: libstagefright_foundation's ABI has EXTENDING CHANGES Please check compatibility report at: out/soong/.intermediates/frameworks/av/media/libstagefright/foundation/libstagefright_foundation/android_vendor.31_arm64_armv8-a_cortex-a73_shared/libstagefright_foundation.so.abidiff<br> ******************************************************</p> 
<p>2.error 2</p> 
<p>******************************************************<br> error: VNDK library: libaudioutils's ABI has EXTENDING CHANGES Please check compatibility report at: out/soong/.intermediates/system/media/audio_utils/libaudioutils/android_vendor.31_arm64_armv8-a_cortex-a73_shared/libaudioutils.so.abidiff<br> ******************************************************</p> 
<p>分析error：</p> 
<p>1.针对error 1 查看libstagefright_foundation.so.abidiff这个文件提示如下，</p> 
<pre><code>lib_name: "libstagefright_foundation"
arch: "arm64"
global_vars_added {
  name: "android::MEDIA_MIMETYPE_AUDIO_AVS3"
  source_file: "frameworks/av/media/libstagefright/foundation/include/media/stagefright/foundation/MediaDefs.h"
  linker_set_key: "_ZN7android25MEDIA_MIMETYPE_AUDIO_AVS3E"
  referenced_type: "const char *"
  access: public_access
}
added_elf_objects {
  name: "_ZN7android25MEDIA_MIMETYPE_AUDIO_AVS3E"
}
compatibility_status: EXTENSION</code></pre> 
<p>结论是，新加了全局变量，这正好是我新加的内容。</p> 
<pre><code>新加内容
MediaDefs.h
extern const char *MEDIA_MIMETYPE_AUDIO_AVS3;
MediaDefs.cpp
const char *MEDIA_MIMETYPE_AUDIO_AVS3 = "audio/av3a";
</code></pre> 
<p>2.针对error 2 查看libaudioutils.so.abidiff这个文件提示如下，</p> 
<pre><code class="hljs">lib_name: "libaudioutils"
arch: "arm64"
enum_type_extension_diffs {
  type_stack: "android::PowerLog::log-&gt; android::PowerLog *-&gt; android::PowerLog-&gt; const audio_format_t-&gt; audio_format_t-&gt; "
  name: "audio_format_t"
  fields_added {
    enum_field_value: -536870912
    name: "AUDIO_FORMAT_AVS3"
  }
}
compatibility_status: EXTENSION</code></pre> 
<p>结论是，新加了全局变量，这也正好是我新加的内容。</p> 
<p>其实，印出error 的同时，已经提示处理方法了，就是执行android 脚本，再生成新的header 文件就可以了。</p> 
<p>接下来看看完整的Error 提示：</p> 
<p>1. error 1</p> 
<pre><code>FAILED: out/soong/.intermediates/frameworks/av/media/libstagefright/foundation/libstagefright_foundation/android_vendor.31_arm64_armv8-a_cortex-a73_shared/libstagefright_foundation.so.abidiff
(prebuilts/clang-tools/linux-x86/bin/header-abi-diff -allow-unreferenced-changes -allow-unreferenced-elf-symbol-changes -lib libstagefright_foundation -arch arm64 -o out/soong/.intermediates/frameworks/av/media/libstagefright/foundation/libstagefright_foundation/android_vendor.31_arm64_armv8-a_cortex-a73_shared/libstagefright_foundation.so.abidiff -new out/soong/.intermediates/frameworks/av/media/libstagefright/foundation/libstagefright_foundation/android_vendor.31_arm64_armv8-a_cortex-a73_shared/libstagefright_foundation.so.lsdump -old prebuilts/abi-dumps/vndk/31/64/arm64_armv8-a/source-based/libstagefright_foundation.so.lsdump)|| (echo 'error: Please update ABI references with: $ANDROID_BUILD_TOP/development/vndk/tools/header-checker/utils/create_reference_dumps.py  -l libstagefright_foundation' &amp;&amp; (mkdir -p $DIST_DIR/abidiffs &amp;&amp; cp out/soong/.intermediates/frameworks/av/media/libstagefright/foundation/libstagefright_foundation/android_vendor.31_arm64_armv8-a_cortex-a73_shared/libstagefright_foundation.so.abidiff $DIST_DIR/abidiffs/) &amp;&amp; exit 1)
******************************************************
error: VNDK library: libstagefright_foundation's ABI has EXTENDING CHANGES Please check compatibility report at: out/soong/.intermediates/frameworks/av/media/libstagefright/foundation/libstagefright_foundation/android_vendor.31_arm64_armv8-a_cortex-a73_shared/libstagefright_foundation.so.abidiff
******************************************************
error: Please update ABI references with: $ANDROID_BUILD_TOP/development/vndk/tools/header-checker/utils/create_reference_dumps.py  -l libstagefright_foundation
10:46:20 ninja failed with: exit status 1

#### failed to build some targets (20 seconds) ####
</code></pre> 
<p>2.error 2</p> 
<pre><code>[ 10% 348/3267] //system/media/audio_utils:libaudioutils header-abi-diff libaudioutils.so.abidiff [arm]
FAILED: out/soong/.intermediates/system/media/audio_utils/libaudioutils/android_vendor.31_arm_armv8-a_cortex-a73_shared/libaudioutils.so.abidiff
(prebuilts/clang-tools/linux-x86/bin/header-abi-diff -allow-unreferenced-changes -allow-unreferenced-elf-symbol-changes -lib libaudioutils -arch arm -o out/soong/.intermediates/system/media/audio_utils/libaudioutils/android_vendor.31_arm_armv8-a_cortex-a73_shared/libaudioutils.so.abidiff -new out/soong/.intermediates/system/media/audio_utils/libaudioutils/android_vendor.31_arm_armv8-a_cortex-a73_shared/libaudioutils.so.lsdump -old prebuilts/abi-dumps/vndk/31/64/arm_armv8-a/source-based/libaudioutils.so.lsdump)|| (echo 'error: Please update ABI references with: $ANDROID_BUILD_TOP/development/vndk/tools/header-checker/utils/create_reference_dumps.py  -l libaudioutils' &amp;&amp; (mkdir -p $DIST_DIR/abidiffs &amp;&amp; cp out/soong/.intermediates/system/media/audio_utils/libaudioutils/android_vendor.31_arm_armv8-a_cortex-a73_shared/libaudioutils.so.abidiff $DIST_DIR/abidiffs/) &amp;&amp; exit 1)
******************************************************
error: VNDK library: libaudioutils's ABI has EXTENDING CHANGES Please check compatibility report at: out/soong/.intermediates/system/media/audio_utils/libaudioutils/android_vendor.31_arm_armv8-a_cortex-a73_shared/libaudioutils.so.abidiff
******************************************************
error: Please update ABI references with: $ANDROID_BUILD_TOP/development/vndk/tools/header-checker/utils/create_reference_dumps.py  -l libaudioutils
14:11:43 ninja failed with: exit status 1

#### failed to build some targets (01:19 (mm:ss)) ####</code></pre> 
<p>解决方法：执行提示的命令后，生成新的文件。</p> 
<p>error 1</p> 
<pre><code>cd development/vndk/tools/header-checker/utils/
development/vndk/tools/header-checker/utils$ ./create_reference_dumps.py  -l libstagefright_foundation -product xxx
============================================
ninja: no work to do.
Creating dumps for target_arch: arm and variant  armv8-a
Created abi dump at /prebuilts/abi-dumps/vndk/31/64/arm_armv8-a/source-based/libstagefright_foundation.so.lsdump
Creating dumps for target_arch: arm64 and variant  armv8-a
Created abi dump at /prebuilts/abi-dumps/vndk/31/64/arm64_armv8-a/source-based/libstagefright_foundation.so.lsdump

msg: Processed 2 libraries in  3.13055180311203  minutes</code></pre> 
<p>error 2</p> 
<pre><code>development/vndk/tools/header-checker/utils$ ./create_reference_dumps.py  -l libaudioutils -product xxx

[100% 42/42] //system/media/audio_utils:libaudioutils header-abi-linker libaudioutils.so.lsdump
Creating dumps for target_arch: arm and variant  armv8-a
Created abi dump at prebuilts/abi-dumps/vndk/31/64/arm_armv8-a/source-based/libaudioutils.so.lsdump
Creating dumps for target_arch: arm64 and variant  armv8-a
Created abi dump at prebuilts/abi-dumps/vndk/31/64/arm64_armv8-a/source-based/libaudioutils.so.lsdump

msg: Processed 2 libraries in  3.355355123678843  minutes</code></pre> 
<p>-product 参数，是限定特定产品才编译，不做全编译。</p> 
<p>再执行编译，就可以正常编译了。</p> 
<p>提交代码时候，也需要把新生成的文件上传到仓库。</p> 
<p>libstagefright_foundation.so.lsdump 文件的修改，长下面这样子。</p> 
<p></p> 
<p></p> 
<p></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/df5b6f3dda659dcbe79bb54f7c009732/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">python实现api接口</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e9be9a8fdc97cd2e5637ddd5ca161086/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">测试学习从小白开始到XX级别需要经历的过程</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>