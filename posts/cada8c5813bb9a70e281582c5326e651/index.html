<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>kubernetes集群一个master两个node证书过期解决 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="kubernetes集群一个master两个node证书过期解决" />
<meta property="og:description" content="1.集群表现现象： 1.kubelet无法启动，并报如下错误：
[root@k8s01 ~]# journalctl -u kubelet.service -f -- Logs begin at Tue 2023-10-10 10:07:58 CST. -- Nov 10 15:30:31 k8s01 systemd[1]: Started kubelet: The Kubernetes Node Agent. Nov 10 15:30:31 k8s01 kubelet[25591]: Flag --network-plugin has been deprecated, will be removed along with dockershim. Nov 10 15:30:31 k8s01 kubelet[25591]: Flag --network-plugin has been deprecated, will be removed along with dockershim. Nov 10 15:30:31 k8s01 kubelet[25591]: I1110 15:30:31.153621 25591 server.go:440] &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/cada8c5813bb9a70e281582c5326e651/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-10-11T10:14:37+08:00" />
<meta property="article:modified_time" content="2023-10-11T10:14:37+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">kubernetes集群一个master两个node证书过期解决</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="1_0"></a>1.集群表现现象：</h3> 
<p>1.kubelet无法启动，并报如下错误：</p> 
<pre><code>[root@k8s01 ~]# journalctl -u kubelet.service  -f
-- Logs begin at Tue 2023-10-10 10:07:58 CST. --
Nov 10 15:30:31 k8s01 systemd[1]: Started kubelet: The Kubernetes Node Agent.
Nov 10 15:30:31 k8s01 kubelet[25591]: Flag --network-plugin has been deprecated, will be removed along with dockershim.
Nov 10 15:30:31 k8s01 kubelet[25591]: Flag --network-plugin has been deprecated, will be removed along with dockershim.
Nov 10 15:30:31 k8s01 kubelet[25591]: I1110 15:30:31.153621   25591 server.go:440] "Kubelet version" kubeletVersion="v1.21.2"
Nov 10 15:30:31 k8s01 kubelet[25591]: I1110 15:30:31.154104   25591 server.go:851] "Client rotation is on, will bootstrap in background"
Nov 10 15:30:31 k8s01 kubelet[25591]: E1110 15:30:31.157009   25591 bootstrap.go:265] part of the existing bootstrap client certificate in /etc/kubernetes/kubelet.conf is expired: 2024-10-08 06:25:08 +0000 UTC
Nov 10 15:30:31 k8s01 kubelet[25591]: E1110 15:30:31.157090   25591 server.go:292] "Failed to run kubelet" err="failed to run Kubelet: unable to load bootstrap kubeconfig: stat /etc/kubernetes/bootstrap-kubelet.conf: no such file or directory"
Nov 10 15:30:31 k8s01 systemd[1]: kubelet.service: main process exited, code=exited, status=1/FAILURE
Nov 10 15:30:31 k8s01 systemd[1]: Unit kubelet.service entered failed state.
Nov 10 15:30:31 k8s01 systemd[1]: kubelet.service failed.
Nov 10 15:30:41 k8s01 systemd[1]: kubelet.service holdoff time over, scheduling restart.
Nov 10 15:30:41 k8s01 systemd[1]: Stopped kubelet: The Kubernetes Node Agent.
Nov 10 15:30:41 k8s01 systemd[1]: Started kubelet: The Kubernetes Node Agent.
Nov 10 15:30:41 k8s01 kubelet[25676]: Flag --network-plugin has been deprecated, will be removed along with dockershim.
Nov 10 15:30:41 k8s01 kubelet[25676]: Flag --network-plugin has been deprecated, will be removed along with dockershim.
Nov 10 15:30:41 k8s01 kubelet[25676]: I1110 15:30:41.404211   25676 server.go:440] "Kubelet version" kubeletVersion="v1.21.2"
Nov 10 15:30:41 k8s01 kubelet[25676]: I1110 15:30:41.404751   25676 server.go:851] "Client rotation is on, will bootstrap in background"
Nov 10 15:30:41 k8s01 kubelet[25676]: E1110 15:30:41.407590   25676 bootstrap.go:265] part of the existing bootstrap client certificate in /etc/kubernetes/kubelet.conf is expired: 2024-10-08 06:25:08 +0000 UTC
Nov 10 15:30:41 k8s01 kubelet[25676]: E1110 15:30:41.407670   25676 server.go:292] "Failed to run kubelet" err="failed to run Kubelet: unable to load bootstrap kubeconfig: stat /etc/kubernetes/bootstrap-kubelet.conf: no such file or directory"
Nov 10 15:30:41 k8s01 systemd[1]: kubelet.service: main process exited, code=exited, status=1/FAILURE
Nov 10 15:30:41 k8s01 systemd[1]: Unit kubelet.service entered failed state.
Nov 10 15:30:41 k8s01 systemd[1]: kubelet.service failed.
</code></pre> 
<p>【分析】：</p> 
<ul><li>failed to run Kubelet: unable to load bootstrap kubeconfig: stat /etc/kubernetes/bootstrap-kubelet.conf: no such file or directory</li></ul> 
<blockquote> 
 <p>在前边我们就可以看到这个报错，如果你对k8s的认证比较了解的话，就会知道bootstrap-kubelet.conf是k8s API的引导令牌（Bootstrap Tokens）认证相关的文件。该机制根据证书生成token，然后将信息写字这个文件里。</p> 
</blockquote> 
<ul><li>kubectl命令报错如下：</li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@k8s01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get nodes</span>
Unable to connect to the server: x509: certificate has expired or is not yet valid: current <span class="token function">time</span> <span class="token number">2024</span>-11-10T15:30:55+08:00 is after <span class="token number">2024</span>-10-08T06:25:06Z
</code></pre> 
<p>【分析】：</p> 
<blockquote> 
 <p>这里我们可以定位到证书问题，证书过期。</p> 
</blockquote> 
<h3><a id="2_39"></a>2.解决集群问题</h3> 
<ul><li>备份并重新生成证书</li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@k8s01 ~<span class="token punctuation">]</span><span class="token comment"># cd /etc/kubernetes/pki/</span>
<span class="token punctuation">[</span>root@k8s01 pki<span class="token punctuation">]</span><span class="token comment"># mkdir backup</span>
<span class="token punctuation">[</span>root@k8s01 pki<span class="token punctuation">]</span><span class="token comment"># mv  apiserver.crt apiserver-etcd-client.key apiserver-kubelet-client.crt front-proxy-ca.crt front-proxy-client.crt front-proxy-client.key front-proxy-ca.key apiserver-kubelet-client.key apiserver.key apiserver-etcd-client.crt backup</span>
<span class="token punctuation">[</span>root@k8s01 pki<span class="token punctuation">]</span><span class="token comment"># kubeadm init phase certs all</span>
</code></pre> 
<ul><li>备份并重新生成配置文件</li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@k8s01 pki<span class="token punctuation">]</span><span class="token comment"># cd /etc/kubernetes/</span>
<span class="token punctuation">[</span>root@k8s01 kubernetes<span class="token punctuation">]</span><span class="token comment"># mkdir backup</span>
<span class="token punctuation">[</span>root@k8s01 kubernetes<span class="token punctuation">]</span><span class="token comment"># mv admin.conf controller-manager.conf kubelet.conf scheduler.conf  backup</span>
<span class="token punctuation">[</span>root@k8s01 kubernetes<span class="token punctuation">]</span><span class="token comment"># kubeadm  init phase kubeconfig all</span>
</code></pre> 
<ul><li>拷贝用户权限文件</li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@k8s01 kubernetes<span class="token punctuation">]</span><span class="token comment"># cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span>
</code></pre> 
<ul><li>查看证书</li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@k8s01 ~<span class="token punctuation">]</span><span class="token comment"># kubeadm  certs check-expiration</span>
</code></pre> 
<ul><li>启动kubelet</li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@k8s01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart kubelet</span>
<span class="token punctuation">[</span>root@k8s01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl status kubelet</span>
● kubelet.service - kubelet: The Kubernetes Node Agent
   Loaded: loaded <span class="token punctuation">(</span>/usr/lib/systemd/system/kubelet.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>
  Drop-In: /usr/lib/systemd/system/kubelet.service.d
           └─10-kubeadm.conf
   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Tue <span class="token number">2023</span>-10-10 <span class="token number">13</span>:53:03 CST<span class="token punctuation">;</span> 6s ago
     Docs: https://kubernetes.io/docs/
 Main PID: <span class="token number">5111</span> <span class="token punctuation">(</span>kubelet<span class="token punctuation">)</span>
    Tasks: <span class="token number">14</span>
   Memory: <span class="token number">29</span>.0M
   CGroup: /system.slice/kubelet.service
</code></pre> 
<ul><li>处理工作节点证书</li></ul> 
<pre><code class="prism language-bash">删除工作节点：
<span class="token punctuation">[</span>root@k8s01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete nodes k8s02</span>
<span class="token punctuation">[</span>root@k8s01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete nodes k8s03</span>
生成加入节点命令：
<span class="token punctuation">[</span>root@k8s01 ~<span class="token punctuation">]</span><span class="token comment"># kubeadm token create --print-join-command</span>
kubeadm <span class="token function">join</span> <span class="token number">172.11</span>.0.74:6443 <span class="token parameter variable">--token</span> msbk7j.8ynbop6j6irn9qw7 --discovery-token-ca-cert-hash sha256:d5bd944fa55cd38f8a2515958e9523f85dbae93e3e91e7b50a15cc9b33d196f0
把工作节点重新加入节点：
<span class="token punctuation">[</span>root@k8s02 ~<span class="token punctuation">]</span><span class="token comment"># kubeadm reset -f</span>
<span class="token punctuation">[</span>root@k8s02 ~<span class="token punctuation">]</span><span class="token comment"># kubeadm join 172.11.0.74:6443 --token msbk7j.8ynbop6j6irn9qw7 --discovery-token-ca-cert-hash sha256:d5bd944fa55cd38f8a2515958e9523f85dbae93e3e91e7b50a15cc9b33d196f0</span>
<span class="token punctuation">[</span>root@k8s03 ~<span class="token punctuation">]</span><span class="token comment"># kubeadm reset -f</span>
<span class="token punctuation">[</span>root@k8s03 ~<span class="token punctuation">]</span><span class="token comment"># kubeadm join 172.11.0.74:6443 --token msbk7j.8ynbop6j6irn9qw7 --discovery-token-ca-cert-hash sha256:d5bd944fa55cd38f8a2515958e9523f85dbae93e3e91e7b50a15cc9b33d196f0</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/19f8eb803ec9f07502cec41accd967cc/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【网络安全】网络入侵检测——入侵检测系统</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/43f6a29a8f0e85ade5c841a061820315/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Prometheus规则定义及基于docker简单邮箱钉钉服务发现</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>