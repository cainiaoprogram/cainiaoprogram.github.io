<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>数据交互系列：简述token和如何使用token - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="数据交互系列：简述token和如何使用token" />
<meta property="og:description" content="一、什么是token（理论） 解决http短连接,无状态管理的问题。
Jeb web token(JWT),是为了在网络应用环境间传递声明而执行的一种基于JSON的开发标准，JWT的声明一般被用来在身份提供者和服务提供者间传递被认证的用户身份信息，以便于从资源服务器获取资源，也可以增加一些科瓦ide其他业务逻辑所必须的声明信息。
👍传统的session认证 基于session认证所显露的问题 Session:每个用户经过我们的应用认证之后，我们的应用都要在服务端做一次记录，以方便用户下次请求的鉴别，通常而言，seesion都是保存在内存中，而随着认证用户的增多，服务器的开销会明显增大。
扩展性：用户认证之后，服务端做认证记录，如果认证的记录被保存在内存中的话，这意味着用户下次请求还必须要请求这台服务器上，这个才能拿到授权，这样在分布式的应用上，相应的限制了负载均衡的能力，这也意味着限制了应用的扩展能力。
CSRF:因为基于cookie来进行用户识别的,cookie如果截获，用户就会很容易受到跨站请求伪造的攻击。
👍基于token认证的鉴权机制 基于token的鉴权机制不需要在服务端去保留用户的认证信息或者会话信息。这就意味着基于token认证机制的应用不需要去考虑用户在哪一台服务器登录了，这就为应用的扩展提供了便利。
token鉴权流程如下 优点： 因为json的通用性，所以JWT是可以进行跨语言支持的，像JAVA,JavaScript,NodeJS,PHP等很多语言都可以使用。JWT可以在自身存储一些其他业务逻辑所必要的非敏感信息便于传输，jwt的构成非常简单，就是一个字符串，字节占用很小，所以它是。非常便于传输的，它不需要在服务器保存会话信息，所以易于应用的扩展。 👍JWT的结构 JWT 是由三段信息构成的，将三段信息文本用.链接一起就构成了JWT字符串,就像这样：
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ
第一部分我们称它为头部(header)第二部分我们称其为载荷(payload)第三部分是签证(signature) header jwt的头部承载着两部分的信息：
声明类型声明加密的算法（通常直接使用HMAC SHA256 ） 完整的头部就像下面这样的JSON
{ &#39;typ&#39;:&#39;JWT&#39;, &#39;alg&#39;:&#39;HS256&#39; } 将头部进行base64加密（该加密是可以对称解密的），构成了第一部分。
eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9 base64加密后变成一个完整的字符串。
payload 载荷就是存放有效信息的地方，这个名字是指飞机上承载的货品，有效信息包含三个部分
标准中注册的声明
iss:jwt签发者sub：jwt所面向的用户aud：接收jwt的一方exp：jwt的过期时间nbf：定义在什么时间之前，这过期时间必须大于签发时间iat：jwt的签发时间jti：jwt的唯一身份标识，主要用来作为一次性token，从而回避重放攻击 公共的声明
公共的声明可以添加任何信息，一般添加用户的相关信息或其他业务需要的必要信息，但不建议添加敏感信息，因为该部分客户端可解密。 私有的声明
例如，定义一个payload json：
{ &#34;sub&#34;:&#34;1234567890&#34;, &#34;name&#34;：&#34;john Doe&#34;, admin:true } 然后将其进行base64加密，得到jwt的第二部分
eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9 signature jwt 的第三部分是一个签证信息，这个签证信息由三部分组成
header(base64后的)payload(base64后的)secret 这个部分需要base64加密后的header和base64加密后的payload使用，使用.连接组成的字符串，然后通过header声明的加密方式加密secret组合加密，然后就构成了jwt的第三部分。
var encodedString=base64UrlEncode(header)&#43;&#39;.&#39;&#43;base64UrlEncode(payload) var signature = HMACHA256(encodedString,&#39;secret&#39;) 将这三部分用 . 连接成一个完整的字符串,构成了最终的jwt:
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIi wiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ
👍客户端获取到token之后 Token
token是服务端生成的一串字符串，以做客户端进行请求的一个令牌，当第一次登录后，服务器生成一个Token便将此Token返回给客户端，以后客户端只需带上这个token前来请求数据即可，无需再次带上用户名和密码。token可以设置在cookie或者headers中，都可以。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/052c218d7055a5209b22e3c405d1c9d9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-07T12:46:28+08:00" />
<meta property="article:modified_time" content="2024-01-07T12:46:28+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">数据交互系列：简述token和如何使用token</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="token_0"></a>一、什么是token（理论）</h2> 
<ul><li> <p>解决http短连接,无状态管理的问题。</p> </li><li> <p>Jeb web token(JWT),是为了在网络应用环境间传递声明而执行的一种基于JSON的开发标准，JWT的声明一般被用来在身份提供者和服务提供者间传递被认证的用户身份信息，以便于从资源服务器获取资源，也可以增加一些科瓦ide其他业务逻辑所必须的声明信息。</p> </li></ul> 
<h3><a id="session_httpsimgblogcsdnimgcnedf17f11f65241c6b31f45fa859c65efpng_5"></a>👍传统的session认证 <img src="https://images2.imgbox.com/49/10/0teOztFM_o.png" alt="请添加图片描述"></h3> 
<h4><a id="session_8"></a>基于session认证所显露的问题</h4> 
<p>Session:每个用户经过我们的应用认证之后，我们的应用都要在服务端做一次记录，以方便用户下次请求的鉴别，通常而言，seesion都是保存在内存中，而随着认证用户的增多，服务器的开销会明显增大。</p> 
<p>扩展性：用户认证之后，服务端做认证记录，如果认证的记录被保存在内存中的话，这意味着用户下次请求还必须要请求这台服务器上，这个才能拿到授权，这样在分布式的应用上，相应的限制了负载均衡的能力，这也意味着限制了应用的扩展能力。</p> 
<p>CSRF:因为基于cookie来进行用户识别的,cookie如果截获，用户就会很容易受到跨站请求伪造的攻击。</p> 
<h3><a id="token_16"></a>👍基于token认证的鉴权机制</h3> 
<p>基于token的鉴权机制不需要在服务端去保留用户的认证信息或者会话信息。这就意味着基于token认证机制的应用不需要去考虑用户在哪一台服务器登录了，这就为应用的扩展提供了便利。</p> 
<h4><a id="token_20"></a>token鉴权流程如下</h4> 
<p><img src="https://images2.imgbox.com/cd/4e/nzmrXT4G_o.png" alt="请添加图片描述"></p> 
<h4><a id="_22"></a>优点：</h4> 
<ul><li>因为json的通用性，所以JWT是可以进行跨语言支持的，像JAVA,JavaScript,NodeJS,PHP等很多语言都可以使用。</li><li>JWT可以在自身存储一些其他业务逻辑所必要的非敏感信息</li><li>便于传输，jwt的构成非常简单，就是一个字符串，字节占用很小，所以它是。</li><li>非常便于传输的，它不需要在服务器保存会话信息，所以易于应用的扩展。</li></ul> 
<h3><a id="JWT_29"></a>👍JWT的结构</h3> 
<p><img src="https://images2.imgbox.com/cf/6a/AFIBQitw_o.png" alt="请添加图片描述"></p> 
<p>JWT 是由三段信息构成的，将三段信息文本用.链接一起就构成了JWT字符串,就像这样：</p> 
<p><code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ</code></p> 
<ul><li>第一部分我们称它为头部(header)</li><li>第二部分我们称其为载荷(payload)</li><li>第三部分是签证(signature)</li></ul> 
<h4><a id="header_40"></a>header</h4> 
<p>jwt的头部承载着两部分的信息：</p> 
<ul><li>声明类型</li><li>声明加密的算法（通常直接使用<code>HMAC</code> <code>SHA256</code> ）</li></ul> 
<p>完整的头部就像下面这样的JSON</p> 
<pre><code class="prism language-javascript">
<span class="token punctuation">{<!-- --></span>
   <span class="token string-property property">'typ'</span><span class="token operator">:</span><span class="token string">'JWT'</span><span class="token punctuation">,</span>
   <span class="token string-property property">'alg'</span><span class="token operator">:</span><span class="token string">'HS256'</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>将头部进行base64加密（该加密是可以对称解密的），构成了第一部分。</p> 
<p><code>eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9</code> base64加密后变成一个完整的字符串。</p> 
<h4><a id="payload_62"></a>payload</h4> 
<p>载荷就是存放有效信息的地方，这个名字是指飞机上承载的货品，有效信息包含三个部分</p> 
<ul><li> <p>标准中注册的声明</p> 
  <ul><li>iss:jwt签发者</li><li>sub：jwt所面向的用户</li><li>aud：接收jwt的一方</li><li>exp：jwt的过期时间</li><li>nbf：定义在什么时间之前，这过期时间必须大于签发时间</li><li>iat：jwt的签发时间</li><li>jti：jwt的唯一身份标识，主要用来作为一次性token，从而回避重放攻击</li></ul> </li><li> <p>公共的声明</p> 
  <ul><li>公共的声明可以添加任何信息，一般添加用户的相关信息或其他业务需要的必要信息，但不建议添加敏感信息，因为该部分客户端可解密。</li></ul> </li><li> <p>私有的声明</p> </li><li> <p>例如，定义一个payload json：</p> <pre><code class="prism language-javascript">   <span class="token punctuation">{<!-- --></span>
   	<span class="token string-property property">"sub"</span><span class="token operator">:</span><span class="token string">"1234567890"</span><span class="token punctuation">,</span>
   	<span class="token string">"name"</span>：<span class="token string">"john Doe"</span><span class="token punctuation">,</span>
   	<span class="token literal-property property">admin</span><span class="token operator">:</span><span class="token boolean">true</span>
   <span class="token punctuation">}</span>
</code></pre> </li></ul> 
<p>然后将其进行base64加密，得到jwt的第二部分</p> 
<p><code>eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9 </code></p> 
<h4><a id="signature_98"></a>signature</h4> 
<p>jwt 的第三部分是一个签证信息，这个签证信息由三部分组成</p> 
<ul><li>header(base64后的)</li><li>payload(base64后的)</li><li>secret</li></ul> 
<p>这个部分需要base64加密后的header和base64加密后的payload使用，使用.连接组成的字符串，然后通过header声明的加密方式加密secret组合加密，然后就构成了jwt的第三部分。</p> 
<pre><code class="prism language-javascript">
<span class="token keyword">var</span> encodedString<span class="token operator">=</span><span class="token function">base64UrlEncode</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'.'</span><span class="token operator">+</span><span class="token function">base64UrlEncode</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
<span class="token keyword">var</span>  signature <span class="token operator">=</span> <span class="token constant">HMACHA256</span><span class="token punctuation">(</span>encodedString<span class="token punctuation">,</span><span class="token string">'secret'</span><span class="token punctuation">)</span>

</code></pre> 
<p>将这三部分用 . 连接成一个完整的字符串,构成了最终的jwt:<br> <code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIi wiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ</code></p> 
<h3><a id="token_118"></a>👍客户端获取到token之后</h3> 
<ul><li> <p>Token</p> <p>token是服务端生成的一串字符串，以做客户端进行请求的一个令牌，当第一次登录后，服务器生成一个Token便将此Token返回给客户端，以后客户端只需带上这个token前来请求数据即可，无需再次带上用户名和密码。token可以设置在cookie或者headers中，都可以。</p> </li><li> <p>公参</p> <p>公共参数，一般放在headers中，让所有的请求都带上这个参数，服务器会对他做一些处理，比如常用的比如：会在headers中设置app的版本，用于服务器进行接口的版本兼容。</p> </li><li> <p>客户端对于token的存储方式</p> 
  <ul><li> <p>存储在webStorage中，每次调用接口都当成一个字段传给后台</p> </li><li> <p>存储在cookie中，让他自动发送，缺点就是不能跨域</p> 
    <ul><li>将token存放在cookie中可以指定 httponly，来防止被Javascript读取，也可以指定secure，来保证token只在HTTPS下传输。缺点是不符合Restful最佳实践，容易受到CSRF攻击。</li><li>CSRF就是恶意攻击者盗用已经认证过的用户信息，以用户信息名义进行一些操作〈如发邮件、转账、购买商品等等)。由于身份已经认证过，所以目标网站会认为操作都是真正的用户操作的。CSRF并不能拿到用户信息，它只是<code>盗用用户凭证</code>去进行操作。</li></ul> </li><li> <p>拿到以后存储在webStorage中，每次调用接口的时候放在HTTP请求头的<code>Authorization</code>字段里</p> 
    <ul><li>将token存放在webStorage中，可以通过js来访问，这样会导致很容易受到xss攻击，如果js脚本被盗用，攻击者就可以轻易访问你的网站, webStroage作为一种储存机制,在传输过程中不会执行任何安全标准</li><li>xss攻击是一种注入代码攻击，恶意攻击者在目标网站上注入script代码，当访问者浏览王网站的时候通过执行注入的script代码达到<code>窃取用户信息，盗用用户身份</code>等。</li></ul> </li></ul> </li></ul> 
<h2><a id="token_142"></a>二、如何使用token？（案例）</h2> 
<p>以下使用两个小demo来简述后端生成token到客户端获取token到携带token去发送请求获取数据的整体流程。</p> 
<p>后台服务环境基于node，需要安装的第三方npm包如下</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"demo"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"version"</span><span class="token operator">:</span> <span class="token string">"1.0.0"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"description"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token string-property property">"main"</span><span class="token operator">:</span> <span class="token string">"index.js"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"test"</span><span class="token operator">:</span> <span class="token string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"author"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token string-property property">"license"</span><span class="token operator">:</span> <span class="token string">"ISC"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"cors"</span><span class="token operator">:</span> <span class="token string">"^2.8.5"</span><span class="token punctuation">,</span> 
    <span class="token string-property property">"express"</span><span class="token operator">:</span> <span class="token string">"^4.18.2"</span><span class="token punctuation">,</span> <span class="token comment">//web服务框架</span>
    <span class="token string-property property">"jsonwebtoken"</span><span class="token operator">:</span> <span class="token string">"^9.0.1"</span><span class="token punctuation">,</span> <span class="token comment">//生成和验证token</span>
    <span class="token string-property property">"mysql"</span><span class="token operator">:</span> <span class="token string">"^2.18.1"</span><span class="token punctuation">,</span> <span class="token comment">//数据库</span>
    <span class="token string-property property">"svg-captcha"</span><span class="token operator">:</span> <span class="token string">"^1.4.0"</span> <span class="token comment">//生成验证码</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="demo1token_167"></a>👍demo1：模拟前后端生成，获取和验证token</h3> 
<p>成功获取到token，并且检验成功。<br> <img src="https://images2.imgbox.com/06/6d/3nduWrw4_o.png" alt="请添加图片描述"></p> 
<h3><a id="_172"></a>前端代码</h3> 
<pre><code class="prism language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://cdn.bootcss.com/axios/0.19.0-beta.1/axios.min.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>点我发送请求，认证<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
        btn<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">let</span> config<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
                <span class="token literal-property property">headers</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
                    <span class="token string-property property">'Authorizition'</span><span class="token operator">:</span>localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">)</span><span class="token comment">//从缓存中取</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'http://localhost:3000/verifytoken'</span><span class="token punctuation">,</span>config<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token comment">// dom元素加载完就发送请求</span>
        document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'DOMContentLoaded'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'http://localhost:3000/gettoken'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
                <span class="token comment">//从res中解析token，并且存在localStorage 供后续请求使用</span>
                <span class="token keyword">let</span> token<span class="token operator">=</span>res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>token
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span>
                localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">,</span>token<span class="token punctuation">)</span> <span class="token comment">//放到缓存</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>   
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h3><a id="_211"></a>服务端代码（出现的问题和解决的方法）</h3> 
<p>出现问题<br> 1.跨域问题，<br> 2.客户端请求头设置参数，后端没有处理的问题</p> 
<p><img src="https://images2.imgbox.com/95/2b/FxHOcmNk_o.png" alt="请添加图片描述"><br> <img src="https://images2.imgbox.com/39/47/kIt2tRIW_o.png" alt="请添加图片描述"><br> 服务端设置响应控制头，cors方法防止跨域 （<a href="https://blog.csdn.net/Code_King006/article/details/131845285?spm=1001.2014.3001.5501">什么是cors方法？⏩点击此处查看交互专栏里的上一篇文章</a>）</p> 
<pre><code class="prism language-javascript">
<span class="token comment">// 设置响应头，cors方法，防止跨域</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 允许任何来源跨域</span>
    res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Origin'</span><span class="token punctuation">,</span><span class="token string">'*'</span><span class="token punctuation">)</span>
    <span class="token comment">// 如果请求中设置了请求头，那么这个首部是必要的</span>
    res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Headers'</span><span class="token punctuation">,</span><span class="token string">'*'</span><span class="token punctuation">)</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span><span class="token string">'public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>结果：成功获取到token</p> 
<p><img src="https://images2.imgbox.com/2a/f0/clAZIlLT_o.png" alt="请添加图片描述"></p> 
<h4><a id="_235"></a>整体代码展示</h4> 
<pre><code class="prism language-javascript"><span class="token comment">// 模拟 加载页面拿到token,再向后台发请求时验证token</span>

<span class="token comment">// 生成和验证token</span>
<span class="token keyword">const</span> jwt<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'jsonwebtoken'</span><span class="token punctuation">)</span>
<span class="token comment">// 生成验证码</span>
<span class="token keyword">const</span> captcha<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'svg-captcha'</span><span class="token punctuation">)</span>
<span class="token comment">// 启动web服务的框架</span>
<span class="token keyword">const</span> express<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>

<span class="token comment">// 定义密钥</span>
<span class="token keyword">const</span> key<span class="token operator">=</span><span class="token string">'my key'</span>

<span class="token comment">// 启动服务</span>
<span class="token keyword">const</span> app<span class="token operator">=</span><span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 设置响应头，cors方法，防止跨域</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 允许任何来源跨域</span>
    res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Origin'</span><span class="token punctuation">,</span><span class="token string">'*'</span><span class="token punctuation">)</span>
    <span class="token comment">// 如果请求中设置了请求头，那么这个首部是必要的</span>
    res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Headers'</span><span class="token punctuation">,</span><span class="token string">'*'</span><span class="token punctuation">)</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span><span class="token string">'public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token comment">// 基于jsonwebtoken模块，生成token，将token返回给客户端</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/gettoken'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 声明携带的载荷</span>
    <span class="token keyword">let</span> payload<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        <span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'dema'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">userId</span><span class="token operator">:</span><span class="token number">1003</span><span class="token punctuation">,</span>
        <span class="token literal-property property">exp</span><span class="token operator">:</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1000</span><span class="token operator">+</span><span class="token number">3600</span><span class="token operator">*</span><span class="token number">24</span>  <span class="token comment">// 设置过期时间</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// sign方法用于办法token</span>
    <span class="token keyword">let</span> token<span class="token operator">=</span>jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span>payload<span class="token punctuation">,</span>key<span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        <span class="token literal-property property">code</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token literal-property property">result</span><span class="token operator">:</span><span class="token string">'ok'</span><span class="token punctuation">,</span>
        token
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>    

<span class="token comment">// 验证token</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/verifytoken'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 获取Authorization消息头</span>
    <span class="token comment">// console.log(req)</span>
    <span class="token keyword">let</span> token<span class="token operator">=</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>authorization
    <span class="token comment">// 验证token，获取token中存储的payload数据</span>
    jwt<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span>key<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>decoded</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token comment">//若验证失败，则err将不是null</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>decoded<span class="token punctuation">)</span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server is running....'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre> 
<h3><a id="demo2tokentoken_300"></a>👍demo2：获取token，携带token去验证输入的验证码是否正确</h3> 
<h3><a id="_301"></a>实现的步骤</h3> 
<ul><li> 
  <ol><li>加载页面，客户端获取token，并存入本地缓存</li></ol> </li><li> 
  <ol start="2"><li>加载页面，获取验证码图片并渲染到页面</li></ol> </li><li> 
  <ol start="3"><li>客户端再次发送请求，验证码+携带token，如果得到的响应是验证码输入成功，即为验证码验证成功</li></ol> </li></ul> 
<h3><a id="_305"></a>实现的效果</h3> 
<p><img src="https://images2.imgbox.com/6b/e4/cw9IdGdp_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_308"></a>前端代码完整展示</h3> 
<pre><code class="prism language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://cdn.bootcss.com/axios/0.19.0-beta.1/axios.min.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>  
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>img<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
     <span class="token comment">&lt;!-- svg --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>点我认证<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
        <span class="token comment">// 验证验证码</span>
        btn<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">let</span> config<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
                <span class="token literal-property property">headers</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
                    <span class="token string-property property">'Authorizition'</span><span class="token operator">:</span>localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">)</span><span class="token comment">//从缓存中取</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            
            axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'http://localhost:3000/resgister?ucode='</span><span class="token operator">+</span>text<span class="token punctuation">.</span>value<span class="token punctuation">,</span>config<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        

        <span class="token comment">// dom元素加载完就发送请求</span>
        document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'DOMContentLoaded'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'http://localhost:3000/gettoken'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">let</span> token<span class="token operator">=</span>res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>token
                localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">,</span>token<span class="token punctuation">)</span> 
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">,</span>token<span class="token punctuation">)</span> 
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token comment">// 页面加载完获取验证码</span>
        window<span class="token punctuation">.</span><span class="token function-variable function">onload</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'http://localhost:3000/getcode'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
                 <span class="token keyword">let</span> svg<span class="token operator">=</span>res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>svg 
                 console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'svg'</span><span class="token punctuation">,</span>svg<span class="token punctuation">)</span>
                 <span class="token keyword">let</span> img<span class="token operator">=</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span>
                 img<span class="token punctuation">.</span>innerHTML<span class="token operator">=</span>svg
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>   
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h3><a id="_362"></a>服务端代码完整展示</h3> 
<pre><code class="prism language-javascript"><span class="token comment">// 生成和验证token</span>
<span class="token keyword">const</span> jwt<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'jsonwebtoken'</span><span class="token punctuation">)</span>
<span class="token comment">// 生成验证码</span>
<span class="token keyword">const</span> captcha<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'svg-captcha'</span><span class="token punctuation">)</span>
<span class="token comment">// 启动web服务的框架</span>
<span class="token keyword">const</span> express<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>


<span class="token comment">// 定义密钥</span>
<span class="token keyword">const</span> key<span class="token operator">=</span><span class="token string">'my key'</span>

<span class="token comment">// 启动服务</span>
<span class="token keyword">const</span> app<span class="token operator">=</span><span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 设置响应头，cors方法，防止跨域</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 允许任何来源跨域</span>
    res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Origin'</span><span class="token punctuation">,</span><span class="token string">'*'</span><span class="token punctuation">)</span>
    <span class="token comment">// 如果请求中设置了请求头，那么这个首部是必要的</span>
    res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Headers'</span><span class="token punctuation">,</span><span class="token string">'*'</span><span class="token punctuation">)</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span><span class="token string">'public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token comment">//模拟redis数据库</span>
<span class="token keyword">let</span> redis<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token comment">//模拟redis数据库</span>


<span class="token comment">// 基于jsonwebtoken模块，生成token，将token返回给客户端</span>

<span class="token keyword">let</span> token

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/gettoken'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 声明携带的载荷</span>
    <span class="token keyword">let</span> payload<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        <span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'dema'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">userId</span><span class="token operator">:</span><span class="token number">1003</span><span class="token punctuation">,</span>
        <span class="token literal-property property">exp</span><span class="token operator">:</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1000</span><span class="token operator">+</span><span class="token number">3600</span><span class="token operator">*</span><span class="token number">24</span>  <span class="token comment">// 设置过期时间</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// sign方法用于办法token</span>
    token<span class="token operator">=</span>jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span>payload<span class="token punctuation">,</span>key<span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        <span class="token literal-property property">code</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token literal-property property">result</span><span class="token operator">:</span><span class="token string">'ok'</span><span class="token punctuation">,</span>
        token
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>    

<span class="token comment">// 接收请求，返回验证码图片</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/getcode'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 生成验证码</span>
    <span class="token keyword">let</span> cap<span class="token operator">=</span>captcha<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//生成一个验证码图片</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'生成的token'</span><span class="token punctuation">,</span>token<span class="token punctuation">)</span>
    <span class="token comment">// token验证成功</span>
    <span class="token comment">// 缺一步，把正确答案和token做配对存入redis里</span>
    redis<span class="token punctuation">[</span>token<span class="token punctuation">]</span><span class="token operator">=</span>cap<span class="token punctuation">.</span>text
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'当前redis'</span><span class="token punctuation">,</span>redis<span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        <span class="token literal-property property">svg</span><span class="token operator">:</span>cap<span class="token punctuation">.</span>data
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 验证token，验证验证码是否一致</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/resgister'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 获取用户输入的验证码</span>
    <span class="token keyword">let</span> ucode<span class="token operator">=</span>req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>ucode
    <span class="token comment">// 从请求头获取token，验证成功，执行后续业务</span>
    <span class="token keyword">let</span> token<span class="token operator">=</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>authorizition
    <span class="token comment">// 验证token，获取token中存储的payload数据</span>
    jwt<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span>key<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>decoded</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token comment">// 验证失败</span>
            res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'刷新重试'</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">//token验证成功</span>
    <span class="token keyword">let</span> answer<span class="token operator">=</span>redis<span class="token punctuation">[</span>token<span class="token punctuation">]</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ucode<span class="token punctuation">.</span><span class="token function">toLocaleLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span>answer<span class="token punctuation">.</span><span class="token function">toLocaleLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'验证码输入正确'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'验证码输入错误'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
 


app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3001</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server is running....'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8a8a36cccd04f3023a48692e7f41e8e1/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">了解统计分类中的贝叶斯理论误差限</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ce5457226ab98a2d1a0c0b2090f12ba8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Django5&#43;DRF序列化</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>