<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>基于Linux内核时钟的简单闹钟应用 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="基于Linux内核时钟的简单闹钟应用" />
<meta property="og:description" content="目录 技术路线应用程序模块设计 总体功能以及设计流程图 代码Makefiletimer.calarm.c 编译过程及编译结果清理工程编译工程 运行或测试结果导入模块调用应用程序 参考文章 技术路线 在本实例中，我们采用应用程序以及内核模块的结合以达到使用动态定时器定时的目的。
其中使用了应用程序中调用了两个系统调用函数，而系统调用函数使用模块的方式进行导入。下面分别对应用程序和内核模块功能进行介绍：
应用程序 应用程序部分，首先接受来自用户输入的参数，并且对命令进行检测，如果有误，对用户进行提醒，如果正确，将调用第一个系统调用函数，将用户输入的定时时间传入内核函数中，进行定时器的定时，并且在后面通过轮询去检测定时完成标志，其中检测的函数也是一个系统调用函数，当定时完成标志被置一后，调用声音驱动函数，发出闹铃的响声并提示用户。
模块设计 模块设计部分，主要是方便应用程序对内核的动态定时器进行管理。其中在导入模块的时候，为了修改内存中的表项，首先修改寄存器的保护位，然后修改映射在内存中的系统调用表，把空闲的系统调用表项指向自己写的模块函数，并且保留原始的系统调用表，方便卸载模块的时候恢复系统调用表。模块中包含两个系统调用函数，其中一个接收来自应用程序中用户输入的参数，根据此参数设置定时器的基本定时，并在定时器的回调函数中打印倒计时，当到达定时时间的时候将计时完成标志置位。而第二个系统调用函数则是向应用程序返回计时完成标志，以达到通知应用程序的目的。
总体功能以及设计 获取到命令行中用户输入的定时参数，要能够对参数进行检查以及对输错的参数进行提示等，引导用户了解命令的使用方法。在正确得到用户输入后，解析命令，计时开始，并将用户设定计时信息输出在命令行中，方便用户进行确认。在系统内核日志中打印倒计时，在计时完成后，响起铃声，通知用户，并在命令行中输出完成信息。
流程图 代码 Makefile 1.	#obj-m表示编译生成可加载模块 2.	obj-m:=timer.o 3.	#需要编译的模块源文件地址 4.	PWD:= $(shell pwd) 5.	CC:= gcc 6.	#指定内核源码的位置 7.	KERNELDIR:= /lib/modules/$(shell uname -r)/build 8.	#关闭gcc优化选项，避免插入模块出错 9.	EXTRA_CFLAGS= -O0 10.	11.	all: 12.	make -C $(KERNELDIR) M=$(PWD) modules 13.	$(CC) alarm.c -o alarm 14.	clean: 15.	make -C $(KERNELDIR) M=$(PWD) clean 16.	rm -rf alarm 17." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/b03d0484dba3c38b558058f2dc780172/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-03-01T15:33:12+08:00" />
<meta property="article:modified_time" content="2021-03-01T15:33:12+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">基于Linux内核时钟的简单闹钟应用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#_3" rel="nofollow">技术路线</a></li><li><ul><li><a href="#_8" rel="nofollow">应用程序</a></li><li><a href="#_12" rel="nofollow">模块设计</a></li></ul> 
  </li><li><a href="#_18" rel="nofollow">总体功能以及设计</a></li><li><ul><li><a href="#_21" rel="nofollow">流程图</a></li></ul> 
  </li><li><a href="#_27" rel="nofollow">代码</a></li><li><ul><li><a href="#Makefile_28" rel="nofollow">Makefile</a></li><li><a href="#timerc_50" rel="nofollow">timer.c</a></li><li><a href="#alarmc_195" rel="nofollow">alarm.c</a></li></ul> 
  </li><li><a href="#_303" rel="nofollow">编译过程及编译结果</a></li><li><ul><li><a href="#_305" rel="nofollow">清理工程</a></li><li><a href="#_312" rel="nofollow">编译工程</a></li></ul> 
  </li><li><a href="#_318" rel="nofollow">运行或测试结果</a></li><li><ul><li><a href="#_320" rel="nofollow">导入模块</a></li><li><a href="#_328" rel="nofollow">调用应用程序</a></li></ul> 
  </li><li><a href="#_344" rel="nofollow">参考文章</a></li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="_3"></a>技术路线</h2> 
<p>在本实例中，我们采用应用程序以及内核模块的结合以达到使用动态定时器定时的目的。<br> 其中使用了应用程序中调用了两个系统调用函数，而系统调用函数使用模块的方式进行导入。下面分别对应用程序和内核模块功能进行介绍：</p> 
<h3><a id="_8"></a>应用程序</h3> 
<p>应用程序部分，首先接受来自用户输入的参数，并且对命令进行检测，如果有误，对用户进行提醒，如果正确，将调用第一个系统调用函数，将用户输入的定时时间传入内核函数中，进行定时器的定时，并且在后面通过轮询去检测定时完成标志，其中检测的函数也是一个系统调用函数，当定时完成标志被置一后，调用声音驱动函数，发出闹铃的响声并提示用户。</p> 
<h3><a id="_12"></a>模块设计</h3> 
<p>模块设计部分，主要是方便应用程序对内核的动态定时器进行管理。其中在导入模块的时候，为了修改内存中的表项，首先修改寄存器的保护位，然后修改映射在内存中的系统调用表，把空闲的系统调用表项指向自己写的模块函数，并且保留原始的系统调用表，方便卸载模块的时候恢复系统调用表。模块中包含两个系统调用函数，其中一个接收来自应用程序中用户输入的参数，根据此参数设置定时器的基本定时，并在定时器的回调函数中打印倒计时，当到达定时时间的时候将计时完成标志置位。而第二个系统调用函数则是向应用程序返回计时完成标志，以达到通知应用程序的目的。</p> 
<hr> 
<h2><a id="_18"></a>总体功能以及设计</h2> 
<p>获取到命令行中用户输入的定时参数，要能够对参数进行检查以及对输错的参数进行提示等，引导用户了解命令的使用方法。在正确得到用户输入后，解析命令，计时开始，并将用户设定计时信息输出在命令行中，方便用户进行确认。在系统内核日志中打印倒计时，在计时完成后，响起铃声，通知用户，并在命令行中输出完成信息。</p> 
<h3><a id="_21"></a>流程图</h3> 
<p><img src="https://images2.imgbox.com/77/96/rKqdKSEt_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<h2><a id="_27"></a>代码</h2> 
<h3><a id="Makefile_28"></a>Makefile</h3> 
<pre><code class="prism language-c"><span class="token number">1.</span>	#obj<span class="token operator">-</span>m表示编译生成可加载模块  
<span class="token number">2.</span>	obj<span class="token operator">-</span>m<span class="token punctuation">:</span><span class="token operator">=</span>timer<span class="token punctuation">.</span>o  
<span class="token number">3.</span>	#需要编译的模块源文件地址  
<span class="token number">4.</span>	PWD<span class="token punctuation">:</span><span class="token operator">=</span> $<span class="token punctuation">(</span>shell pwd<span class="token punctuation">)</span>  
<span class="token number">5.</span>	CC<span class="token punctuation">:</span><span class="token operator">=</span> gcc  
<span class="token number">6.</span>	#指定内核源码的位置  
<span class="token number">7.</span>	KERNELDIR<span class="token punctuation">:</span><span class="token operator">=</span> <span class="token operator">/</span>lib<span class="token operator">/</span>modules<span class="token operator">/</span>$<span class="token punctuation">(</span>shell uname <span class="token operator">-</span>r<span class="token punctuation">)</span><span class="token operator">/</span>build  
<span class="token number">8.</span>	#关闭gcc优化选项，避免插入模块出错  
<span class="token number">9.</span>	EXTRA_CFLAGS<span class="token operator">=</span> <span class="token operator">-</span>O0  
<span class="token number">10.</span>	  
<span class="token number">11.</span>	all<span class="token punctuation">:</span>  
<span class="token number">12.</span>	    make <span class="token operator">-</span>C $<span class="token punctuation">(</span>KERNELDIR<span class="token punctuation">)</span>  M<span class="token operator">=</span>$<span class="token punctuation">(</span>PWD<span class="token punctuation">)</span> modules  
<span class="token number">13.</span>	    $<span class="token punctuation">(</span>CC<span class="token punctuation">)</span> alarm<span class="token punctuation">.</span>c <span class="token operator">-</span>o alarm  
<span class="token number">14.</span>	clean<span class="token punctuation">:</span>  
<span class="token number">15.</span>	    make <span class="token operator">-</span>C $<span class="token punctuation">(</span>KERNELDIR<span class="token punctuation">)</span> M<span class="token operator">=</span>$<span class="token punctuation">(</span>PWD<span class="token punctuation">)</span> clean  
<span class="token number">16.</span>	    rm <span class="token operator">-</span>rf alarm  
<span class="token number">17.</span>	    sudo modprobe pcspkr  
</code></pre> 
<h3><a id="timerc_50"></a>timer.c</h3> 
<pre><code class="prism language-c"><span class="token number">1.</span>	#include <span class="token operator">&lt;</span>linux<span class="token operator">/</span>kernel<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>  
<span class="token number">2.</span>	#include <span class="token operator">&lt;</span>linux<span class="token operator">/</span>init<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>  
<span class="token number">3.</span>	#include <span class="token operator">&lt;</span>linux<span class="token operator">/</span>unistd<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>  
<span class="token number">4.</span>	#include <span class="token operator">&lt;</span>linux<span class="token operator">/</span>time<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>  
<span class="token number">5.</span>	#include <span class="token operator">&lt;</span><span class="token keyword">asm</span><span class="token operator">/</span>uaccess<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>  
<span class="token number">6.</span>	#include <span class="token operator">&lt;</span>linux<span class="token operator">/</span>sched<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>  
<span class="token number">7.</span>	#include <span class="token operator">&lt;</span>linux<span class="token operator">/</span>kallsyms<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>  
<span class="token number">8.</span>	#include <span class="token operator">&lt;</span>linux<span class="token operator">/</span>module<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>  
<span class="token number">9.</span>	#include <span class="token operator">&lt;</span>linux<span class="token operator">/</span>timer<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>  
<span class="token number">10.</span>	#include <span class="token operator">&lt;</span>linux<span class="token operator">/</span>jiffies<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>  
<span class="token number">11.</span>	<span class="token comment">/* 系统调用号 */</span>  
<span class="token number">12.</span>	#define __NR_syscall <span class="token number">335</span>  
<span class="token number">13.</span>	#define __NR_pausecall <span class="token number">336</span>  
<span class="token number">14.</span>	<span class="token comment">/*struct timer*/</span>  
<span class="token number">15.</span>	<span class="token keyword">struct</span> timer_list mytimer<span class="token punctuation">;</span>  
<span class="token number">16.</span>	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span> sys_call_table<span class="token punctuation">;</span>  
<span class="token number">17.</span>	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">clear_and_return_cr0</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">18.</span>	<span class="token keyword">void</span> <span class="token function">setback_cr0</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">19.</span>	<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">B_timer</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">20.</span>	<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">myfunc</span><span class="token punctuation">(</span><span class="token keyword">int</span> timecnt<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">21.</span>	<span class="token comment">/* 用来存储cr0寄存器原来的值 */</span>  
<span class="token number">22.</span>	<span class="token keyword">int</span> orig_cr0<span class="token punctuation">;</span>  
<span class="token number">23.</span>	<span class="token comment">/*定义一个函数指针，用来保存一个系统调用*/</span>  
<span class="token number">24.</span>	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>sys_call_table <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token number">25.</span>	<span class="token comment">/*timeok*/</span>  
<span class="token number">26.</span>	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> timeok <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token number">27.</span>	<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>anything_saved<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/*定义一个函数指针，用来保存一个系统调用*/</span>  
<span class="token number">28.</span>	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> n_timecnt<span class="token punctuation">;</span>  
<span class="token number">29.</span>	<span class="token comment">//为了修改内存中的表项，还要修改寄存器的保护位  </span>
<span class="token number">30.</span>	<span class="token comment">/* 
31.	 * 设置cr0寄存器的第17位为0 
32.	 */</span>  
<span class="token number">33.</span>	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">clear_and_return_cr0</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>  
<span class="token number">34.</span>	<span class="token punctuation">{<!-- --></span>  
<span class="token number">35.</span>	    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cr0 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token number">36.</span>	    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> ret<span class="token punctuation">;</span>  
<span class="token number">37.</span>	    <span class="token comment">/* 前者用在32位系统。后者用在64位系统，本系统64位 */</span>  
<span class="token number">38.</span>	    <span class="token comment">//asm volatile ("movl %%cr0, %%eax" : "=a"(cr0));     </span>
<span class="token number">39.</span>	    <span class="token comment">/* 将cr0寄存器的值移动到rax寄存器中，同时输出到cr0变量中 */</span>  
<span class="token number">40.</span>	    <span class="token keyword">asm</span> <span class="token keyword">volatile</span> <span class="token punctuation">(</span><span class="token string">"movq %%cr0, %%rax"</span> <span class="token punctuation">:</span> <span class="token string">"=a"</span><span class="token punctuation">(</span>cr0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
<span class="token number">41.</span>	    ret <span class="token operator">=</span> cr0<span class="token punctuation">;</span>  
<span class="token number">42.</span>	    <span class="token comment">/* 将cr0寄存器的值移动到rax寄存器中，同时输出到cr0变量中 */</span>  
<span class="token number">43.</span>	    cr0 <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token number">0xfffeffff</span><span class="token punctuation">;</span>    
<span class="token number">44.</span>	    <span class="token comment">//asm volatile ("movl %%eax, %%cr0" :: "a"(cr0));  </span>
<span class="token number">45.</span>	    <span class="token comment">/* 读取cr0的值到rax寄存器，再将rax寄存器的值放入cr0中 */</span>  
<span class="token number">46.</span>	    <span class="token keyword">asm</span> <span class="token keyword">volatile</span> <span class="token punctuation">(</span><span class="token string">"movq %%rax, %%cr0"</span> <span class="token punctuation">:</span><span class="token punctuation">:</span> <span class="token string">"a"</span><span class="token punctuation">(</span>cr0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
<span class="token number">47.</span>	    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>  
<span class="token number">48.</span>	<span class="token punctuation">}</span>  
<span class="token number">49.</span>	  
<span class="token number">50.</span>	<span class="token comment">/* 读取val的值到rax寄存器，再将rax寄存器的值放入cr0中 */</span>  
<span class="token number">51.</span>	<span class="token keyword">void</span> <span class="token function">setback_cr0</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> val<span class="token punctuation">)</span>  
<span class="token number">52.</span>	<span class="token punctuation">{<!-- --></span>  
<span class="token number">53.</span>	    <span class="token comment">//asm volatile ("movl %%eax, %%cr0" :: "a"(val));  </span>
<span class="token number">54.</span>	    <span class="token keyword">asm</span> <span class="token keyword">volatile</span> <span class="token punctuation">(</span><span class="token string">"movq %%rax, %%cr0"</span> <span class="token punctuation">:</span><span class="token punctuation">:</span> <span class="token string">"a"</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">55.</span>	<span class="token punctuation">}</span>  
<span class="token number">56.</span>	<span class="token comment">//一秒到了后，调用的函数，进行定时参数的检查，若到达定时器指定时间  </span>
<span class="token number">57.</span>	<span class="token comment">//将定时完成标志位置1  </span>
<span class="token number">58.</span>	
<span class="token number">59.</span>	<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">B_timer</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span>  
<span class="token number">60.</span>	<span class="token punctuation">{<!-- --></span>  
<span class="token number">61.</span>	    <span class="token keyword">if</span><span class="token punctuation">(</span>n_timecnt <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>  
<span class="token number">62.</span>	    <span class="token punctuation">{<!-- --></span>  
<span class="token number">63.</span>	        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"time cnt is %d\n"</span><span class="token punctuation">,</span>n_timecnt<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">64.</span>	        n_timecnt <span class="token operator">=</span> n_timecnt <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>  
<span class="token number">65.</span>	        <span class="token function">mod_timer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mytimer<span class="token punctuation">,</span> jiffies <span class="token operator">+</span> HZ<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">66.</span>	    <span class="token punctuation">}</span>  
<span class="token number">67.</span>	    <span class="token keyword">else</span>  
<span class="token number">68.</span>	    <span class="token punctuation">{<!-- --></span>  
<span class="token number">69.</span>	        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"It is on time\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">70.</span>	        timeok <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  
<span class="token number">71.</span>	    <span class="token punctuation">}</span>  
<span class="token number">72.</span>	<span class="token punctuation">}</span>  
<span class="token number">73.</span>	  
<span class="token number">74.</span>	<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">myfunc</span><span class="token punctuation">(</span><span class="token keyword">int</span> timecnt<span class="token punctuation">)</span>  
<span class="token number">75.</span>	<span class="token punctuation">{<!-- --></span>  
<span class="token number">76.</span>	    <span class="token comment">/****************time set**********************/</span>  
<span class="token number">77.</span>	    <span class="token comment">//初始化内核定时器  </span>
<span class="token number">78.</span>	    timeok <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token number">79.</span>	    <span class="token function">init_timer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mytimer<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">80.</span>	    <span class="token comment">//指定定时时间到后的回调函数  </span>
<span class="token number">81.</span>	    mytimer<span class="token punctuation">.</span>function <span class="token operator">=</span> B_timer<span class="token punctuation">;</span>  
<span class="token number">82.</span>	    <span class="token function">add_timer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mytimer<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">83.</span>	    <span class="token comment">//基本定时为1秒  </span>
<span class="token number">84.</span>	    <span class="token function">mod_timer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mytimer<span class="token punctuation">,</span> jiffies <span class="token operator">+</span> HZ<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">85.</span>	    n_timecnt <span class="token operator">=</span> timecnt<span class="token punctuation">;</span>  
<span class="token number">86.</span>	    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"Time start!!!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">87.</span>	    <span class="token keyword">return</span> timecnt<span class="token punctuation">;</span>  
<span class="token number">88.</span>	<span class="token punctuation">}</span>  
<span class="token number">89.</span>	<span class="token comment">//系统调用函数，获取定时器状态信息  </span>
<span class="token number">90.</span>	<span class="token keyword">static</span> <span class="token keyword">char</span> <span class="token function">Askfunc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>  
<span class="token number">91.</span>	<span class="token punctuation">{<!-- --></span>  
<span class="token number">92.</span>	    <span class="token keyword">return</span> timeok<span class="token punctuation">;</span>  
<span class="token number">93.</span>	<span class="token punctuation">}</span>  
<span class="token number">94.</span>	  
<span class="token number">95.</span>	<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Init_syscall</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>  
<span class="token number">96.</span>	<span class="token punctuation">{<!-- --></span>  
<span class="token number">97.</span>	    <span class="token comment">//修改映射在内存中的系统调用表，把空闲的系统调用表项指向自己写的模块函数  </span>
<span class="token number">98.</span>	    <span class="token comment">/* 获取系统调用服务首地址 */</span>  
<span class="token number">99.</span>	    sys_call_table <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">kallsyms_lookup_name</span><span class="token punctuation">(</span><span class="token string">"sys_call_table"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">100.</span>	    <span class="token comment">//printk("sys_call_table: 0x%p\n", sys_call_table);  </span>
<span class="token number">101.</span>	    <span class="token comment">/* 保存原始系统调用 */</span>  
<span class="token number">102.</span>	    anything_saved <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>sys_call_table<span class="token punctuation">[</span>__NR_syscall<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">103.</span>	    <span class="token comment">/* 设置cr0可更改 */</span>  
<span class="token number">104.</span>	    orig_cr0 <span class="token operator">=</span> <span class="token function">clear_and_return_cr0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">105.</span>	    <span class="token comment">/* 更改原始的系统调用服务地址 */</span>  
<span class="token number">106.</span>	    sys_call_table<span class="token punctuation">[</span>__NR_syscall<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>myfunc<span class="token punctuation">;</span>  
<span class="token number">107.</span>	    sys_call_table<span class="token punctuation">[</span>__NR_pausecall<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>Askfunc<span class="token punctuation">;</span>  
<span class="token number">108.</span>	    <span class="token comment">/* 设置为原始的只读cr0 */</span>  
<span class="token number">109.</span>	    <span class="token function">setback_cr0</span><span class="token punctuation">(</span>orig_cr0<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">110.</span>	<span class="token punctuation">}</span>  
<span class="token number">111.</span>	<span class="token comment">//导入模块的时候调用的函数  </span>
<span class="token number">112.</span>	<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">mytimer_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>  
<span class="token number">113.</span>	<span class="token punctuation">{<!-- --></span>  
<span class="token number">114.</span>	    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"Insmod Ok !\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">115.</span>	    <span class="token function">Init_syscall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">116.</span>	    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token number">117.</span>	<span class="token punctuation">}</span>  
<span class="token number">118.</span>	<span class="token comment">//卸载模块的时候调用的函数  </span>
<span class="token number">119.</span>	<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">mytimer_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>  
<span class="token number">120.</span>	<span class="token punctuation">{<!-- --></span>  
<span class="token number">121.</span>	    <span class="token function">del_timer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mytimer<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">122.</span>	    <span class="token comment">/* 设置cr0中对sys_call_table的更改权限 */</span>  
<span class="token number">123.</span>	    orig_cr0 <span class="token operator">=</span> <span class="token function">clear_and_return_cr0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">124.</span>	    <span class="token comment">/* 设置cr0可更改 */</span>  
<span class="token number">125.</span>	    sys_call_table<span class="token punctuation">[</span>__NR_syscall<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>anything_saved<span class="token punctuation">;</span>  
<span class="token number">126.</span>	    <span class="token comment">/* 恢复原有的中断向量表中的函数指针的值 */</span>  
<span class="token number">127.</span>	    <span class="token function">setback_cr0</span><span class="token punctuation">(</span>orig_cr0<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">128.</span>	    <span class="token comment">/* 恢复原有的cr0的值 */</span>  
<span class="token number">129.</span>	    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"rmmod OK !\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">130.</span>	<span class="token punctuation">}</span>  
<span class="token number">131.</span>	<span class="token comment">//module function  </span>
<span class="token number">132.</span>	<span class="token function">module_init</span><span class="token punctuation">(</span>mytimer_init<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">133.</span>	<span class="token function">module_exit</span><span class="token punctuation">(</span>mytimer_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">134.</span>	<span class="token comment">//  </span>
<span class="token number">135.</span>	  
<span class="token number">136.</span>	<span class="token comment">//相关信息  </span>
<span class="token number">137.</span>	<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">138.</span>	<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"willpower"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">139.</span>	<span class="token function">MODULE_DESCRIPTION</span><span class="token punctuation">(</span><span class="token string">"Demo for timer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

</code></pre> 
<h3><a id="alarmc_195"></a>alarm.c</h3> 
<pre><code class="prism language-c"><span class="token number">1.</span>	#include <span class="token operator">&lt;</span>syscall<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>  
<span class="token number">2.</span>	#include <span class="token operator">&lt;</span>stdio<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>  
<span class="token number">3.</span>	#include <span class="token operator">&lt;</span>linux<span class="token operator">/</span>unistd<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>  
<span class="token number">4.</span>	#include <span class="token operator">&lt;</span>stdlib<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>  
<span class="token number">5.</span>	#include <span class="token operator">&lt;</span>fcntl<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>  
<span class="token number">6.</span>	#include <span class="token operator">&lt;</span>string<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>  
<span class="token number">7.</span>	#include <span class="token operator">&lt;</span>unistd<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>  
<span class="token number">8.</span>	#include <span class="token operator">&lt;</span>sys<span class="token operator">/</span>ioctl<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>  
<span class="token number">9.</span>	#include <span class="token operator">&lt;</span>sys<span class="token operator">/</span>types<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>  
<span class="token number">10.</span>	#include <span class="token operator">&lt;</span>linux<span class="token operator">/</span>kd<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>  
<span class="token number">11.</span>	<span class="token comment">/*input alarm -t 30 or pause like alarm -h  (like 30 )*/</span>  
<span class="token number">12.</span>	<span class="token keyword">int</span> timecnt<span class="token punctuation">,</span>pausetime<span class="token punctuation">;</span>  
<span class="token number">13.</span>	<span class="token comment">//sounds  </span>
<span class="token number">14.</span>	<span class="token keyword">void</span> <span class="token function">Buzzer</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">15.</span>	<span class="token comment">//命令解析函数  </span>
<span class="token number">16.</span>	<span class="token keyword">char</span> <span class="token function">parse_command_line</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>timecnt<span class="token punctuation">)</span>  
<span class="token number">17.</span>	<span class="token punctuation">{<!-- --></span>  
<span class="token number">18.</span>	    <span class="token keyword">char</span> <span class="token operator">*</span>arg0 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>argv<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">19.</span>	    <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token operator">*</span>argv <span class="token punctuation">)</span>  
<span class="token number">20.</span>	    <span class="token punctuation">{<!-- --></span>  
<span class="token number">21.</span>	        <span class="token comment">//检查参数是否含有-t  </span>
<span class="token number">22.</span>	        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span> <span class="token operator">*</span>argv<span class="token punctuation">,</span><span class="token string">"-t"</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>  
<span class="token number">23.</span>	        <span class="token punctuation">{<!-- --></span> <span class="token comment">/*time*/</span>  
<span class="token number">24.</span>	            <span class="token comment">//将输入的数字字符串转换为整形  </span>
<span class="token number">25.</span>	            <span class="token keyword">int</span> time <span class="token operator">=</span> atoi <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span> <span class="token operator">++</span>argv <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">26.</span>	            <span class="token comment">//检查输入定时器参数是否在正确范围内  </span>
<span class="token number">27.</span>	            <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> time <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span> time <span class="token operator">&gt;</span> <span class="token number">65535</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span>  
<span class="token number">28.</span>	            <span class="token punctuation">{<!-- --></span>  
<span class="token number">29.</span>	                <span class="token comment">//输出错误提示  </span>
<span class="token number">30.</span>	          fprintf <span class="token punctuation">(</span> <span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Bad parameter: time must be from 1..65535\n"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">31.</span>	                exit <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>  
<span class="token number">32.</span>	            <span class="token punctuation">}</span>  
<span class="token number">33.</span>	            <span class="token keyword">else</span>  
<span class="token number">34.</span>	            <span class="token punctuation">{<!-- --></span>  
<span class="token number">35.</span>	                <span class="token operator">*</span>timecnt <span class="token operator">=</span> time<span class="token punctuation">;</span>  
<span class="token number">36.</span>	                argv<span class="token operator">++</span><span class="token punctuation">;</span>  
<span class="token number">37.</span>	            <span class="token punctuation">}</span>  
<span class="token number">38.</span>	            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>  
<span class="token number">39.</span>	        <span class="token punctuation">}</span>  
<span class="token number">40.</span>	         <span class="token keyword">else</span>  
<span class="token number">41.</span>	        <span class="token punctuation">{<!-- --></span>  
<span class="token number">42.</span>	            <span class="token comment">//command error output help  </span>
<span class="token number">43.</span>	            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Bad parameter: %s\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">44.</span>	            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Please enter again!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">45.</span>	            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"You can use -t for timecnt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">46.</span>	            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">47.</span>	        <span class="token punctuation">}</span>  
<span class="token number">48.</span>	    <span class="token punctuation">}</span>  
<span class="token number">49.</span>	<span class="token punctuation">}</span>  
<span class="token number">50.</span>	<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>  
<span class="token number">51.</span>	<span class="token punctuation">{<!-- --></span>  
<span class="token number">52.</span>	    <span class="token comment">//parse_conmand  </span>
<span class="token number">53.</span>	    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">parse_command_line</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> <span class="token operator">&amp;</span>timecnt<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>  
<span class="token number">54.</span>	    <span class="token punctuation">{<!-- --></span>  
<span class="token number">55.</span>	        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"timecnt is %d\n"</span><span class="token punctuation">,</span> timecnt<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">56.</span>	        <span class="token comment">//系统调用，传入定时事件timecnt  </span>
<span class="token number">57.</span>	        <span class="token function">timeset</span><span class="token punctuation">(</span>timecnt<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">58.</span>	        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  
<span class="token number">59.</span>	        <span class="token punctuation">{<!-- --></span>  
<span class="token number">60.</span>	            <span class="token comment">//对定时完成标志做检查  </span>
<span class="token number">61.</span>	            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">timeget</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>  
<span class="token number">62.</span>	            <span class="token punctuation">{<!-- --></span>  
<span class="token number">63.</span>	                <span class="token comment">//定时事件到达，响起铃声  </span>
<span class="token number">64.</span>	                <span class="token function">Buzzer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">65.</span>	                <span class="token keyword">break</span><span class="token punctuation">;</span>  
<span class="token number">66.</span>	            <span class="token punctuation">}</span>  
<span class="token number">67.</span>	        <span class="token punctuation">}</span>  
<span class="token number">68.</span>	        <span class="token comment">//输出完成调用提示  </span>
<span class="token number">69.</span>	        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"timecnt action is successful!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">70.</span>	    <span class="token punctuation">}</span>  
<span class="token number">71.</span>	    <span class="token keyword">else</span>  
<span class="token number">72.</span>	    <span class="token punctuation">{<!-- --></span>  
<span class="token number">73.</span>	        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Error!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">74.</span>	    <span class="token punctuation">}</span>  
<span class="token number">75.</span>	    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token number">76.</span>	<span class="token punctuation">}</span>  
<span class="token number">77.</span>	<span class="token keyword">void</span> <span class="token function">Buzzer</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>  
<span class="token number">78.</span>	<span class="token punctuation">{<!-- --></span>  
<span class="token number">79.</span>	    <span class="token keyword">int</span> console_fd<span class="token punctuation">;</span>  
<span class="token number">80.</span>	    <span class="token keyword">int</span> i<span class="token punctuation">;</span>  
<span class="token number">81.</span>	    <span class="token comment">//open dev  </span>
<span class="token number">82.</span>	    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> console_fd <span class="token operator">=</span> open <span class="token punctuation">(</span> <span class="token string">"/dev/console"</span><span class="token punctuation">,</span> O_WRONLY <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span>  
<span class="token number">83.</span>	    <span class="token punctuation">{<!-- --></span>  
<span class="token number">84.</span>	        <span class="token comment">//Error  </span>
<span class="token number">85.</span>	        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Failed to open console.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">86.</span>	        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">87.</span>	        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">88.</span>	    <span class="token punctuation">}</span>  
<span class="token number">89.</span>	    <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>  
<span class="token number">90.</span>	    <span class="token punctuation">{<!-- --></span>  
<span class="token number">91.</span>	        <span class="token keyword">int</span> magical_fairy_number <span class="token operator">=</span> <span class="token number">1190000</span><span class="token operator">/</span><span class="token number">3000</span><span class="token punctuation">;</span>  
<span class="token number">92.</span>	        <span class="token comment">/* 开始发声 */</span>  
<span class="token number">93.</span>	        <span class="token function">ioctl</span><span class="token punctuation">(</span>console_fd<span class="token punctuation">,</span> KIOCSOUND<span class="token punctuation">,</span> magical_fairy_number<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">94.</span>	        <span class="token comment">/*等待... */</span>  
<span class="token number">95.</span>	        <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">96.</span>	         <span class="token comment">/* 停止发声*/</span>  
<span class="token number">97.</span>	        <span class="token function">ioctl</span><span class="token punctuation">(</span>console_fd<span class="token punctuation">,</span> KIOCSOUND<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">98.</span>	         <span class="token comment">/* 等待... */</span>  
<span class="token number">99.</span>	        <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">100.</span>	        <span class="token comment">/* 重复播放*/</span>  
<span class="token number">101.</span>	    <span class="token punctuation">}</span>  
<span class="token number">102.</span>	<span class="token punctuation">}</span>

</code></pre> 
<h2><a id="_303"></a>编译过程及编译结果</h2> 
<h3><a id="_305"></a>清理工程</h3> 
<p>可以看到只有alarm.c、timer.c以及Makefile文件，其中~结尾的是备份文件。</p> 
<p><img src="https://images2.imgbox.com/bf/5e/3EO664kI_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_312"></a>编译工程</h3> 
<p>可以看到生成了可执行文件alarm,以及可导入模块timer.ko文件</p> 
<p><img src="https://images2.imgbox.com/1f/39/JsUDWwag_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_318"></a>运行或测试结果</h2> 
<h3><a id="_320"></a>导入模块</h3> 
<p>可以看到模块被成功导入</p> 
<p><img src="https://images2.imgbox.com/9d/60/7ZfCobc7_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/e4/fa/WY3djByt_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_328"></a>调用应用程序</h3> 
<p>其中调用的格式为alarm -t cnt 使用-t参数设置定时的时间。<br> 成功调用后，会在系统内核日志中打印倒计时，方便用户进行检查。<br> 到时间后，会响起铃声提醒用户进行查看。</p> 
<p><img src="https://images2.imgbox.com/0a/d1/9g80TNrC_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/22/06/v2CE1unW_o.png" alt="在这里插入图片描述"></p> 
<p>应用程序会对输入参数做检查</p> 
<p><img src="https://images2.imgbox.com/d9/93/SUGAM96K_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_344"></a>参考文章</h2> 
<p><a href="http://www.360doc.com/content/14/0725/09/17328427_396891662.shtml" rel="nofollow">[1] Linux下的声音编程方法</a><br> <a href="https://blog.csdn.net/zusi_csdn/article/details/79644359">[2] zusi_csdn. Linux驱动开发1-内核入门之hello模块</a><br> <a href="https://blog.csdn.net/cbl709/article/details/7349538">[3] cbl709. linux 内核定时器编程</a><br> <a href="https://blog.csdn.net/weixin_41565755/article/details/91149548">[4] Shell命令控制蜂鸣器发声</a><br> <a href="https://kunaly.blog.csdn.net/article/details/99633062" rel="nofollow">[5] Kunaly. Linux内核定时器timer_list的使用</a><br> <a href="https://blog.csdn.net/wangliang888888/article/details/90487274">[6] Linux内核定时器</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ce6c4d150e870451f9cc811375d9c7a5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Spring Data Jpa 动态查询Specification的基本用法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/86dc2939966d6d3b0e4d1bc683007e77/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">java getter返回值_使用Java中的getter方法返回私有集合</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>