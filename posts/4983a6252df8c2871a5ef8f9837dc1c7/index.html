<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Redis专题(持续更新) - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Redis专题(持续更新)" />
<meta property="og:description" content="04-VIP-Redis缓存设计与性能优化 文章目录 04-VIP-Redis缓存设计与性能优化正文多级缓存架构 缓存设计缓存穿透 缓存与数据库双写不一致明天我们说开发规范与性能优化! 正文 多级缓存架构 缓存设计 缓存穿透 缓存穿透是指查询一个根本不存在的数据， 缓存层和存储层都不会命中， 通常出于容错的考虑， 如果从存储层查不到数据则不写入缓存层。
缓存穿透将导致不存在的数据每次请求都要到存储层去查询， 失去了缓存保护后端存储的意义。
造成缓存穿透的基本原因有两个：
第一， 自身业务代码或者数据出现问题。
第二， 一些恶意攻击、 爬虫等造成大量空命中。
缓存穿透问题解决方案：
1、缓存空对象
1 String get(String key) { 2 // 从缓存中获取数据 3 String cacheValue = cache.get(key); 4 // 缓存为空 5 if (StringUtils.isBlank(cacheValue)) { 6 // 从存储中获取 7 String storageValue = storage.get(key); 8 cache.set(key, storageValue); 9 // 如果存储数据为空， 需要设置一个过期时间(300秒) 10 if (storageValue == null) { 11 cache.expire(key, 60 * 5); 12 } 13 return storageValue; 14 } else { 15 // 缓存非空 16 return cacheValue; 17 } 18 } 2、布隆过滤器" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/4983a6252df8c2871a5ef8f9837dc1c7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-30T17:18:06+08:00" />
<meta property="article:modified_time" content="2023-12-30T17:18:06+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Redis专题(持续更新)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="04VIPRedis_0"></a>04-VIP-Redis缓存设计与性能优化</h2> 
<hr> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#04VIPRedis_0" rel="nofollow">04-VIP-Redis缓存设计与性能优化</a></li><li><a href="#_10" rel="nofollow">正文</a></li><li><ul><li><a href="#_11" rel="nofollow">多级缓存架构</a></li></ul> 
  </li><li><a href="#_13" rel="nofollow">缓存设计</a></li><li><ul><li><a href="#_14" rel="nofollow">缓存穿透</a></li></ul> 
  </li><li><a href="#_214" rel="nofollow">缓存与数据库双写不一致</a></li><li><a href="#_234" rel="nofollow">明天我们说开发规范与性能优化!</a></li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="_10"></a>正文</h2> 
<h3><a id="_11"></a>多级缓存架构</h3> 
<p><img src="https://images2.imgbox.com/b5/e1/GNgKTEyv_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_13"></a>缓存设计</h2> 
<h3><a id="_14"></a>缓存穿透</h3> 
<p>缓存穿透是指查询一个根本不存在的数据， 缓存层和存储层都不会命中， 通常出于容错的考虑， 如果从存储层查不到数据则不写入缓存层。<br> 缓存穿透将导致不存在的数据每次请求都要到存储层去查询， 失去了缓存保护后端存储的意义。<br> 造成缓存穿透的基本原因有两个：<br> 第一， 自身业务代码或者数据出现问题。<br> 第二， 一些恶意攻击、 爬虫等造成大量空命中。<br> 缓存穿透问题解决方案：<br> 1、缓存空对象</p> 
<pre><code class="prism language-java"><span class="token number">1</span> <span class="token class-name">String</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2</span> <span class="token comment">// 从缓存中获取数据</span>
<span class="token number">3</span> <span class="token class-name">String</span> cacheValue <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">4</span> <span class="token comment">// 缓存为空</span>
<span class="token number">5</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>cacheValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">6</span> <span class="token comment">// 从存储中获取</span>
<span class="token number">7</span> <span class="token class-name">String</span> storageValue <span class="token operator">=</span> storage<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">8</span> cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> storageValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">9</span> <span class="token comment">// 如果存储数据为空， 需要设置一个过期时间(300秒)</span>
<span class="token number">10</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>storageValue <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">11</span> cache<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">12</span> <span class="token punctuation">}</span>
<span class="token number">13</span> <span class="token keyword">return</span> storageValue<span class="token punctuation">;</span>
<span class="token number">14</span> <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">15</span> <span class="token comment">// 缓存非空</span>
<span class="token number">16</span> <span class="token keyword">return</span> cacheValue<span class="token punctuation">;</span>
<span class="token number">17</span> <span class="token punctuation">}</span>
<span class="token number">18</span> <span class="token punctuation">}</span>
</code></pre> 
<p>2、布隆过滤器<br> 对于恶意攻击，向服务器请求大量不存在的数据造成的缓存穿透，还可以用布隆过滤器先做一次过滤，对于不存在的数据布隆过滤器一般都能够过滤掉，不让请求再往后端发送。当布隆过滤器说某个值存在时，这个值可能不存在；当它说不存在时，那就肯定不存在。<br> <img src="https://images2.imgbox.com/73/7c/701jjqVf_o.png" alt="在这里插入图片描述"><br> 布隆过滤器就是一个大型的位数组和几个不一样的无偏 hash 函数。所谓无偏就是能够把元素的 hash 值算得<br> 比较均匀。<br> 向布隆过滤器中添加 key 时，会使用多个 hash 函数对 key 进行 hash 算得一个整数索引值然后对位数组长度<br> 进行取模运算得到一个位置，每个 hash 函数都会算得一个不同的位置。再把位数组的这几个位置都置为 1 就<br> 完成了 add 操作。<br> 向布隆过滤器询问 key 是否存在时，跟 add 一样，也会把 hash 的几个位置都算出来，看看位数组中这几个位<br> 置是否都为 1，只要有一个位为 0，那么说明布隆过滤器中这个key 不存在。如果都是 1，这并不能说明这个<br> key 就一定存在，只是极有可能存在，因为这些位被置为 1 可能是因为其它的 key 存在所致。如果这个位数组<br> 比较稀疏，这个概率就会很大，如果这个位数组比较拥挤，这个概率就会降低。<br> 这种方法适用于数据命中不高、 数据相对固定、 实时性低（通常是数据集较大） 的应用场景， 代码维护较为<br> 复杂， 但是缓存空间占用很少。<br> 可以用redisson实现布隆过滤器，引入依赖：</p> 
<pre><code class="prism language-java"><span class="token number">1</span> <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
<span class="token number">2</span> <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>redisson<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
<span class="token number">3</span> <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>redisson<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
<span class="token number">4</span> <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">3.6</span><span class="token number">.5</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
<span class="token number">5</span> <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre> 
<p>示例伪代码：</p> 
<pre><code class="prism language-java"><span class="token number">1</span> <span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>redisson</span><span class="token punctuation">;</span>
<span class="token number">2</span>
<span class="token number">3</span> <span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>redisson<span class="token punctuation">.</span></span><span class="token class-name">Redisson</span></span><span class="token punctuation">;</span>
<span class="token number">4</span> <span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>redisson<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">RBloomFilter</span></span><span class="token punctuation">;</span>
<span class="token number">5</span> <span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>redisson<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">RedissonClient</span></span><span class="token punctuation">;</span>
<span class="token number">6</span> <span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>redisson<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">Config</span></span><span class="token punctuation">;</span>
<span class="token number">7</span>
<span class="token number">8</span> <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedissonBloomFilter</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">9</span>
<span class="token number">10</span> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">11</span> <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">12</span> config<span class="token punctuation">.</span><span class="token function">useSingleServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token string">"redis://localhost:6379"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">13</span> <span class="token comment">//构造Redisson</span>
<span class="token number">14</span> <span class="token class-name">RedissonClient</span> redisson <span class="token operator">=</span> <span class="token class-name">Redisson</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">15</span>
<span class="token number">16</span> <span class="token class-name">RBloomFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> bloomFilter <span class="token operator">=</span> redisson<span class="token punctuation">.</span><span class="token function">getBloomFilter</span><span class="token punctuation">(</span><span class="token string">"nameList"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">17</span> <span class="token comment">//初始化布隆过滤器：预计元素为100000000L,误差率为3%,根据这两个参数会计算出底层的bit数组大小</span>
<span class="token number">18</span> bloomFilter<span class="token punctuation">.</span><span class="token function">tryInit</span><span class="token punctuation">(</span><span class="token number">100000000L</span><span class="token punctuation">,</span><span class="token number">0.03</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">19</span> <span class="token comment">//将zhuge插入到布隆过滤器中</span>
<span class="token number">20</span> bloomFilter<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"zhuge"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">21</span>
<span class="token number">22</span> <span class="token comment">//判断下面号码是否在布隆过滤器中</span>
<span class="token number">23</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>bloomFilter<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"guojia"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//false</span>
<span class="token number">24</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>bloomFilter<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"baiqi"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//false</span>
<span class="token number">25</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>bloomFilter<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"zhuge"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//true</span>
<span class="token number">26</span> <span class="token punctuation">}</span>
<span class="token number">27</span> <span class="token punctuation">}</span>
</code></pre> 
<p>使用布隆过滤器需要把所有数据提前放入布隆过滤器，并且在增加数据时也要往布隆过滤器里放，布隆过滤器<br> 缓存过滤伪代码：</p> 
<pre><code class="prism language-java"><span class="token number">1</span> <span class="token comment">//初始化布隆过滤器</span>
<span class="token number">2</span> <span class="token class-name">RBloomFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> bloomFilter <span class="token operator">=</span> redisson<span class="token punctuation">.</span><span class="token function">getBloomFilter</span><span class="token punctuation">(</span><span class="token string">"nameList"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">3</span> <span class="token comment">//初始化布隆过滤器：预计元素为100000000L,误差率为3%</span>
<span class="token number">4</span> bloomFilter<span class="token punctuation">.</span><span class="token function">tryInit</span><span class="token punctuation">(</span><span class="token number">100000000L</span><span class="token punctuation">,</span><span class="token number">0.03</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5</span>
<span class="token number">6</span> <span class="token comment">//把所有数据存入布隆过滤器</span>
<span class="token number">7</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
<span class="token number">8</span> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token operator">:</span> keys<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">9</span> bloomFilter<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">10</span> <span class="token punctuation">}</span>
<span class="token number">11</span> <span class="token punctuation">}</span>
<span class="token number">12</span>
<span class="token number">13</span> <span class="token class-name">String</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">14</span> <span class="token comment">// 从布隆过滤器这一级缓存判断下key是否存在</span>
<span class="token number">15</span> <span class="token class-name">Boolean</span> exist <span class="token operator">=</span> bloomFilter<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">16</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>exist<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
<span class="token number">17</span> <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span>
<span class="token number">18</span> <span class="token punctuation">}</span>
<span class="token number">19</span> <span class="token comment">// 从缓存中获取数据</span>
<span class="token number">20</span> <span class="token class-name">String</span> cacheValue <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">21</span> <span class="token comment">// 缓存为空</span>
<span class="token number">22</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>cacheValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">23</span> <span class="token comment">// 从存储中获取</span>
<span class="token number">24</span> <span class="token class-name">String</span> storageValue <span class="token operator">=</span> storage<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">25</span> cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> storageValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">26</span> <span class="token comment">// 如果存储数据为空， 需要设置一个过期时间(300秒)</span>
<span class="token number">27</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>storageValue <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">28</span> cache<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">29</span> <span class="token punctuation">}</span>
<span class="token number">30</span> <span class="token keyword">return</span> storageValue<span class="token punctuation">;</span>
<span class="token number">31</span> <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">32</span> <span class="token comment">// 缓存非空</span>
<span class="token number">33</span> <span class="token keyword">return</span> cacheValue<span class="token punctuation">;</span>
<span class="token number">34</span> <span class="token punctuation">}</span>
<span class="token number">35</span> <span class="token punctuation">}</span>
</code></pre> 
<p>注意：布隆过滤器不能删除数据，如果要删除得重新初始化数据。<br> 缓存失效(击穿)<br> 由于大批量缓存在同一时间失效可能导致大量请求同时穿透缓存直达数据库，可能会造成数据库瞬间压力过大<br> 甚至挂掉，对于这种情况我们在批量增加缓存时最好将这一批数据的缓存过期时间设置为一个时间段内的不同<br> 时间。<br> 示例伪代码：</p> 
<pre><code class="prism language-java"><span class="token number">1</span> <span class="token class-name">String</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2</span> <span class="token comment">// 从缓存中获取数据</span>
<span class="token number">3</span> <span class="token class-name">String</span> cacheValue <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">4</span> <span class="token comment">// 缓存为空</span>
<span class="token number">5</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>cacheValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">6</span> <span class="token comment">// 从存储中获取</span>
<span class="token number">7</span> <span class="token class-name">String</span> storageValue <span class="token operator">=</span> storage<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">8</span> cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> storageValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">9</span> <span class="token comment">//设置一个过期时间(300到600之间的一个随机数)</span>
<span class="token number">10</span> <span class="token keyword">int</span> expireTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">300</span><span class="token punctuation">;</span>
<span class="token number">11</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>storageValue <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">12</span> cache<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> expireTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">13</span> <span class="token punctuation">}</span>
<span class="token number">14</span> <span class="token keyword">return</span> storageValue<span class="token punctuation">;</span>
<span class="token number">15</span> <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">16</span> <span class="token comment">// 缓存非空</span>
<span class="token number">17</span> <span class="token keyword">return</span> cacheValue<span class="token punctuation">;</span>
<span class="token number">18</span> <span class="token punctuation">}</span>
<span class="token number">19</span> <span class="token punctuation">}</span>
</code></pre> 
<p>缓存雪崩<br> 缓存雪崩指的是缓存层支撑不住或宕掉后， 流量会像奔逃的野牛一样， 打向后端存储层。<br> 由于缓存层承载着大量请求， 有效地保护了存储层， 但是如果缓存层由于某些原因不能提供服务(比如超大并<br> 发过来，缓存层支撑不住，或者由于缓存设计不好，类似大量请求访问bigkey，导致缓存能支撑的并发急剧下<br> 降)， 于是大量请求都会打到存储层， 存储层的调用量会暴增， 造成存储层也会级联宕机的情况。<br> 预防和解决缓存雪崩问题， 可以从以下三个方面进行着手。<br> 1） 保证缓存层服务高可用性，比如使用Redis Sentinel或Redis Cluster。<br> 2） 依赖隔离组件为后端限流熔断并降级。比如使用Sentinel或Hystrix限流降级组件。<br> 比如服务降级，我们可以针对不同的数据采取不同的处理方式。当业务应用访问的是非核心数据（例如电商商<br> 品属性，用户信息等）时，暂时停止从缓存中查询这些数据，而是直接返回预定义的默认降级信息、空值或是<br> 错误提示信息；当业务应用访问的是核心数据（例如电商商品库存）时，仍然允许查询缓存，如果缓存缺失，<br> 也可以继续通过数据库读取。<br> 3） 提前演练。 在项目上线前， 演练缓存层宕掉后， 应用以及后端的负载情况以及可能出现的问题， 在此基<br> 础上做一些预案设定。<br> 热点缓存key重建优化<br> 开发人员使用“缓存+过期时间”的策略既可以加速数据读写， 又保证数据的定期更新， 这种模式基本能够满<br> 足绝大部分需求。 但是有两个问题如果同时出现， 可能就会对应用造成致命的危害：<br> 当前key是一个热点key（例如一个热门的娱乐新闻），并发量非常大。<br> 重建缓存不能在短时间完成， 可能是一个复杂计算， 例如复杂的SQL、 多次IO、 多个依赖等。<br> 在缓存失效的瞬间， 有大量线程来重建缓存， 造成后端负载加大， 甚至可能会让应用崩溃。<br> 要解决这个问题主要就是要避免大量线程同时重建缓存。<br> 我们可以利用互斥锁来解决，此方法只允许一个线程重建缓存， 其他线程等待重建缓存的线程执行完， 重新从<br> 缓存获取数据即可。<br> 示例伪代码：</p> 
<pre><code class="prism language-java"><span class="token number">1</span> <span class="token class-name">String</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2</span> <span class="token comment">// 从Redis中获取数据</span>
<span class="token number">3</span> <span class="token class-name">String</span> value <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">4</span> <span class="token comment">// 如果value为空， 则开始重构缓存</span>
<span class="token number">5</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">6</span> <span class="token comment">// 只允许一个线程重建缓存， 使用nx， 并设置过期时间ex</span>
<span class="token number">7</span> <span class="token class-name">String</span> mutexKey <span class="token operator">=</span> <span class="token string">"mutext:key:"</span> <span class="token operator">+</span> key<span class="token punctuation">;</span>
<span class="token number">8</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>mutexKey<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token string">"ex 180"</span><span class="token punctuation">,</span> <span class="token string">"nx"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">9</span> <span class="token comment">// 从数据源获取数据</span>
<span class="token number">10</span> value <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">11</span> <span class="token comment">// 回写Redis， 并设置过期时间</span>
<span class="token number">12</span> redis<span class="token punctuation">.</span><span class="token function">setex</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> timeout<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">13</span> <span class="token comment">// 删除key_mutex</span>
<span class="token number">14</span> redis<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>mutexKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">15</span> <span class="token punctuation">}</span><span class="token comment">// 其他线程休息50毫秒后重试</span>
<span class="token number">16</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">17</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">18</span> <span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">19</span> <span class="token punctuation">}</span>
<span class="token number">20</span> <span class="token punctuation">}</span>
<span class="token number">21</span> <span class="token keyword">return</span> value<span class="token punctuation">;</span>
<span class="token number">22</span> <span class="token punctuation">}</span>
</code></pre> 
<h2><a id="_214"></a>缓存与数据库双写不一致</h2> 
<p>在大并发下，同时操作数据库与缓存会存在数据不一致性问题<br> 1、双写不一致情况<br> <img src="https://images2.imgbox.com/3f/32/s1yuZk9X_o.png" alt="在这里插入图片描述"><br> 2、读写并发不一致<br> <img src="https://images2.imgbox.com/a7/89/125jtG36_o.png" alt="在这里插入图片描述"><br> 解决方案：<br> 1、对于并发几率很小的数据(如个人维度的订单数据、用户数据等)，这种几乎不用考虑这个问题，很少会发生<br> 缓存不一致，可以给缓存数据加上过期时间，每隔一段时间触发读的主动更新即可。<br> 2、就算并发很高，如果业务上能容忍短时间的缓存数据不一致(如商品名称，商品分类菜单等)，缓存加上过期<br> 时间依然可以解决大部分业务对于缓存的要求。<br> 3、如果不能容忍缓存数据不一致，可以通过加读写锁保证并发读写或写写的时候按顺序排好队，读读的时候相<br> 当于无锁。<br> 4、也可以用阿里开源的canal通过监听数据库的binlog日志及时的去修改缓存，但是引入了新的中间件，增加<br> 了系统的复杂度。<br> <img src="https://images2.imgbox.com/65/f2/zdvzYcYs_o.png" alt="在这里插入图片描述"><br> 总结：<br> 以上我们针对的都是读多写少的情况加入缓存提高性能，如果写多读多的情况又不能容忍缓存数据不一致，那<br> 就没必要加缓存了，可以直接操作数据库。放入缓存的数据应该是对实时性、一致性要求不是很高的数据。切<br> 记不要为了用缓存，同时又要保证绝对的一致性做大量的过度设计和控制，增加系统复杂性！</p> 
<h2><a id="_234"></a>明天我们说开发规范与性能优化!</h2>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e4580d33db1fde9e220355556803127e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Vue 实现卡片切换动画&#43;input模糊搜索的字匹配正则变色</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/534d4f66d0bddc9616edfb576e42f9ac/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">网络安全入门之小白篇</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>