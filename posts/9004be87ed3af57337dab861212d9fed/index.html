<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SEATA整合sharding-jdbc思路 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="SEATA整合sharding-jdbc思路" />
<meta property="og:description" content="​ 这里主要是参考了ShardingSphere官网的整合思路
​参考连接：https://shardingsphere.apache.org/document/legacy/4.x/document/cn/features/transaction/principle/base-transaction-seata/
​ 具体内容如下：
​ 整合Seata AT事务时，需要把TM，RM，TC的模型融入到ShardingSphere 分布式事务的SPI的生态中。在数据库资源上，Seata通过对接DataSource接口，让JDBC操作可以同TC进行RPC通信。同样，ShardingSphere也是面向DataSource接口对用户配置的物理DataSource进行了聚合，因此把物理DataSource二次包装为Seata 的DataSource后，就可以把Seata AT事务融入到ShardingSphere的分片中。
​ 解读：
​ 这里注意ShardingSphere分布式事务的SPI的生态中，已经提供了整合的实现类SeataATShardingTransactionManager，只需要导入对应jar包就可以使用了
&lt;dependency&gt; &lt;groupId&gt;org.apache.shardingsphere&lt;/groupId&gt; &lt;artifactId&gt;sharding-transaction-base-seata-at&lt;/artifactId&gt; &lt;version&gt;demo里面用的4.1.1版本&lt;/version&gt; &lt;/dependency&gt; ​ 我们来看下SeataATShardingTransactionManager里面的内容：
// // Source code recreated from a .class file by IntelliJ IDEA // (powered by FernFlower decompiler) // package org.apache.shardingsphere.transaction.base.seata.at; import com.google.common.base.Preconditions; import io.seata.config.FileConfiguration; import io.seata.core.context.RootContext; import io.seata.core.rpc.netty.RmRpcClient; import io.seata.core.rpc.netty.TmRpcClient; import io.seata.rm.RMClient; import io.seata.rm.datasource.DataSourceProxy; import io.seata.tm.TMClient; import io.seata.tm.api.GlobalTransactionContext; import java.sql.Connection; import java.sql.SQLException; import java.util.Collection; import java.util.HashMap; import java." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/9004be87ed3af57337dab861212d9fed/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-01-05T14:02:44+08:00" />
<meta property="article:modified_time" content="2022-01-05T14:02:44+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SEATA整合sharding-jdbc思路</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>​ 这里主要是参考了ShardingSphere官网的整合思路</p> 
<p>​参考连接：https://shardingsphere.apache.org/document/legacy/4.x/document/cn/features/transaction/principle/base-transaction-seata/</p> 
<p>​ 具体内容如下：</p> 
<p>​ 整合Seata AT事务时，需要把TM，RM，TC的模型融入到ShardingSphere 分布式事务的SPI的生态中。在数据库资源上，Seata通过对接DataSource接口，让JDBC操作可以同TC进行RPC通信。同样，ShardingSphere也是面向DataSource接口对用户配置的物理DataSource进行了聚合，因此把物理DataSource二次包装为Seata 的DataSource后，就可以把Seata AT事务融入到ShardingSphere的分片中。</p> 
<p>​ 解读：</p> 
<p>​ 这里注意ShardingSphere分布式事务的SPI的生态中，已经提供了整合的实现类SeataATShardingTransactionManager，只需要导入对应jar包就可以使用了</p> 
<pre><code class="prism language-bash"><span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org.apache.shardingsphere<span class="token operator">&lt;</span>/groupId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>sharding-transaction-base-seata-at<span class="token operator">&lt;</span>/artifactId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span>demo里面用的4.1.1版本<span class="token operator">&lt;</span>/version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/dependency<span class="token operator">&gt;</span>
</code></pre> 
<p>​ 我们来看下SeataATShardingTransactionManager里面的内容：</p> 
<pre><code class="prism language-bash">//
// Source code recreated from a .class <span class="token function">file</span> by IntelliJ IDEA
// <span class="token punctuation">(</span>powered by FernFlower decompiler<span class="token punctuation">)</span>
//

package org.apache.shardingsphere.transaction.base.seata.at<span class="token punctuation">;</span>

<span class="token function">import</span> com.google.common.base.Preconditions<span class="token punctuation">;</span>
<span class="token function">import</span> io.seata.config.FileConfiguration<span class="token punctuation">;</span>
<span class="token function">import</span> io.seata.core.context.RootContext<span class="token punctuation">;</span>
<span class="token function">import</span> io.seata.core.rpc.netty.RmRpcClient<span class="token punctuation">;</span>
<span class="token function">import</span> io.seata.core.rpc.netty.TmRpcClient<span class="token punctuation">;</span>
<span class="token function">import</span> io.seata.rm.RMClient<span class="token punctuation">;</span>
<span class="token function">import</span> io.seata.rm.datasource.DataSourceProxy<span class="token punctuation">;</span>
<span class="token function">import</span> io.seata.tm.TMClient<span class="token punctuation">;</span>
<span class="token function">import</span> io.seata.tm.api.GlobalTransactionContext<span class="token punctuation">;</span>
<span class="token function">import</span> java.sql.Connection<span class="token punctuation">;</span>
<span class="token function">import</span> java.sql.SQLException<span class="token punctuation">;</span>
<span class="token function">import</span> java.util.Collection<span class="token punctuation">;</span>
<span class="token function">import</span> java.util.HashMap<span class="token punctuation">;</span>
<span class="token function">import</span> java.util.Iterator<span class="token punctuation">;</span>
<span class="token function">import</span> java.util.Map<span class="token punctuation">;</span>
<span class="token function">import</span> javax.sql.DataSource<span class="token punctuation">;</span>
<span class="token function">import</span> org.apache.shardingsphere.spi.database.DatabaseType<span class="token punctuation">;</span>
<span class="token function">import</span> org.apache.shardingsphere.transaction.core.ResourceDataSource<span class="token punctuation">;</span>
<span class="token function">import</span> org.apache.shardingsphere.transaction.core.TransactionType<span class="token punctuation">;</span>
<span class="token function">import</span> org.apache.shardingsphere.transaction.spi.ShardingTransactionManager<span class="token punctuation">;</span>

public final class SeataATShardingTransactionManager implements ShardingTransactionManager <span class="token punctuation">{<!-- --></span>
    private final Map<span class="token operator">&lt;</span>String, DataSource<span class="token operator">&gt;</span> dataSourceMap <span class="token operator">=</span> new HashMap<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    private final FileConfiguration configuration <span class="token operator">=</span> new FileConfiguration<span class="token punctuation">(</span><span class="token string">"seata.conf"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    public <span class="token function-name function">SeataATShardingTransactionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    public void init<span class="token punctuation">(</span>DatabaseType databaseType, Collection<span class="token operator">&lt;</span>ResourceDataSource<span class="token operator">&gt;</span> resourceDataSources<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        this.initSeataRPCClient<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Iterator var3 <span class="token operator">=</span> resourceDataSources.iterator<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        while<span class="token punctuation">(</span>var3.hasNext<span class="token punctuation">(</span><span class="token punctuation">))</span> <span class="token punctuation">{<!-- --></span>
            ResourceDataSource each <span class="token operator">=</span> <span class="token punctuation">(</span>ResourceDataSource<span class="token punctuation">)</span>var3.next<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            this.dataSourceMap.put<span class="token punctuation">(</span>each.getOriginalName<span class="token punctuation">(</span><span class="token punctuation">)</span>, new DataSourceProxy<span class="token punctuation">(</span>each.getDataSource<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    public TransactionType <span class="token function-name function">getTransactionType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token builtin class-name">return</span> TransactionType.BASE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    public boolean <span class="token function-name function">isInTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token builtin class-name">return</span> null <span class="token operator">!=</span> RootContext.getXID<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    public Connection getConnection<span class="token punctuation">(</span>String dataSourceName<span class="token punctuation">)</span> throws SQLException <span class="token punctuation">{<!-- --></span>
        <span class="token builtin class-name">return</span> <span class="token variable"><span class="token punctuation">((</span>DataSource<span class="token punctuation">)</span>this.dataSourceMap.get<span class="token punctuation">(</span>dataSourceName<span class="token punctuation">))</span></span>.getConnection<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    public void <span class="token function-name function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        try <span class="token punctuation">{<!-- --></span>
            SeataTransactionHolder.set<span class="token punctuation">(</span>GlobalTransactionContext.getCurrentOrCreate<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
            SeataTransactionHolder.get<span class="token punctuation">(</span><span class="token punctuation">)</span>.begin<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            SeataTransactionBroadcaster.collectGlobalTxId<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> catch <span class="token punctuation">(</span>Throwable var2<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            throw var2<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    public void <span class="token function-name function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        try <span class="token punctuation">{<!-- --></span>
            try <span class="token punctuation">{<!-- --></span>
                SeataTransactionHolder.get<span class="token punctuation">(</span><span class="token punctuation">)</span>.commit<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> finally <span class="token punctuation">{<!-- --></span>
                SeataTransactionBroadcaster.clear<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                SeataTransactionHolder.clear<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span> catch <span class="token punctuation">(</span>Throwable var5<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            throw var5<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    public void <span class="token function-name function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        try <span class="token punctuation">{<!-- --></span>
            try <span class="token punctuation">{<!-- --></span>
                SeataTransactionHolder.get<span class="token punctuation">(</span><span class="token punctuation">)</span>.rollback<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> finally <span class="token punctuation">{<!-- --></span>
                SeataTransactionBroadcaster.clear<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                SeataTransactionHolder.clear<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span> catch <span class="token punctuation">(</span>Throwable var5<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            throw var5<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    public void <span class="token function-name function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        this.dataSourceMap.clear<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        SeataTransactionHolder.clear<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        TmRpcClient.getInstance<span class="token punctuation">(</span><span class="token punctuation">)</span>.destroy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        RmRpcClient.getInstance<span class="token punctuation">(</span><span class="token punctuation">)</span>.destroy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    private void <span class="token function-name function">initSeataRPCClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        String applicationId <span class="token operator">=</span> this.configuration.getConfig<span class="token punctuation">(</span><span class="token string">"client.application.id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Preconditions.checkNotNull<span class="token punctuation">(</span>applicationId, <span class="token string">"please config application id within seata.conf file"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String transactionServiceGroup <span class="token operator">=</span> this.configuration.getConfig<span class="token punctuation">(</span><span class="token string">"client.transaction.service.group"</span>, <span class="token string">"default"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        TMClient.init<span class="token punctuation">(</span>applicationId, transactionServiceGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
        RMClient.init<span class="token punctuation">(</span>applicationId, transactionServiceGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>从源码得知SeataATShardingTransactionManager主要做了三件事：</p> 
<p>第一：将所有数据源封装成seata的代理数据源DataSourceProxy，并放入dataSourceMap中备用。</p> 
<p>第二：初始化TM和RM。</p> 
<p>第三：提供开启，提交，回滚和关闭事务的方法。</p> 
<p>看到这三个功能，是不是很像seata中GlobalTransactionScanner的作用？</p> 
<p>没错！</p> 
<p>这二者的功能是一模一样的，说白了，这里ShardingSphere就是拿自己分库分表的配置文件做里子，用seata的提供好的DataSourceProxy，TMClient，RMClient和GlobalTransaction这几个对象做衣服，重新封装了一个控制分布式事务的对象。</p> 
<p>说人话，就是SeataATShardingTransactionManager对GlobalTransactionScanner进行了二次封装，不仅满足单库微服务的分布式事务，还满足分库分表微服务的分布式事务，变得更强了。</p> 
<p>那么如何使用SeataATShardingTransactionManager呢？</p> 
<p>非常简单，两步搞定！</p> 
<p>第一：在resources下提供seata.conf配置文件，内容如下：</p> 
<pre><code class="prism language-bash">client <span class="token punctuation">{<!-- --></span>
    application.id <span class="token operator">=</span> order-server
    transaction.service.group <span class="token operator">=</span> ltf_tx_group
<span class="token punctuation">}</span>
第二：用@Transactional搭配@ShardingTransactionType<span class="token punctuation">(</span>TransactionType.BASE<span class="token punctuation">)</span>来开启全局事务

//这里切记不要加@GlobalTransactional
@Transactional
@ShardingTransactionType<span class="token punctuation">(</span>TransactionType.BASE<span class="token punctuation">)</span>
public void seataDemo<span class="token punctuation">(</span>Boolean hasError<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    //下单操作
    Order order <span class="token operator">=</span> new Order<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    order.setOrderName<span class="token punctuation">(</span><span class="token string">"测试数据"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    order.setBuyNum<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderMapper.insert<span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>

    //减库存（这里参数什么的就自己脑补了）
    productClient.minusStock<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    //异常模拟
    if<span class="token punctuation">(</span>hasError<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        int <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token number">1</span>/0<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>但是这里要注意一个问题！！！！！！</p> 
<p>虽然SeataATShardingTransactionManager和GlobalTransactionScanner做的事情一样，但是二者绝对不能混合使用！！！！！！</p> 
<p>也就是说@ShardingTransactionType(TransactionType.BASE)和@GlobalTransactional绝对不能同时出现！！！！！！</p> 
<p>看过上面SeataATShardingTransactionManager你就能明白，ShardingSphere把获取到的全局事务，放到了线程的局部变量里面了。而GlobalTransactionScanner则是采用动态代理的方式对方法进行增强。根本不能放在一起，杂交是要出问题的！</p> 
<p>ok！最终总结一句！</p> 
<p>只要你的项目中用到sharding-jdbc，那么你全部微服务都需要导入seata整合sharding-jdbc的jar包</p> 
<pre><code class="prism language-bash"><span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org.apache.shardingsphere<span class="token operator">&lt;</span>/groupId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>sharding-transaction-base-seata-at<span class="token operator">&lt;</span>/artifactId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span>demo里面用的4.1.1版本<span class="token operator">&lt;</span>/version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/dependency<span class="token operator">&gt;</span>
</code></pre> 
<p>而且，你的项目中千万不能再出现@GlobalTransactional注解了，用SeataATShardingTransactionManager就可以了。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7547ee64b985f3ff55973f1b8caa02b7/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">IDEA: Internal error (java.lang.UnsupportedClassVersionError)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a453409a10c570ce7823e1966d03e734/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">计算机网络课后答案(谢希仁第八版)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>