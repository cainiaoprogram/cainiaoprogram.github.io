<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Kudu-集群管理、基架感知、透明分层存储管理、性能优化 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Kudu-集群管理、基架感知、透明分层存储管理、性能优化" />
<meta property="og:description" content="文章目录 Kudu集群管理Kudu命令行工具命令行工具盘点常见命令 Kudu Web界面WebUI端口Master Web UITablet Server Web UI 监控和管理工具编译和安装使用 备份与恢复 其他高级主题机架感知机架感知作用配置机架感知 透明分层存储管理索引跳跃式扫描优化资源规划性能调优硬件层面优化操作系统层面优化网络优化配置调优 透明分层存储案例分析需求分析方案设计架构设计分层存储设计 模拟数据构建数据流水线数据验证 Kudu集群管理 Kudu命令行工具 命令行工具盘点 Kudu在安装时默认就安装了命令行工具，只需要执行Kudu命令就能看到所有的命令分组：
一共有14个分组，组下面才是具体的命令，分组如下：
执行kudu命令组就可以列出下面的子命令：
kudu cluster 常见命令 Kudu提供了丰富的命令行工具方便用户管理集群，这里选择一些常见且命令做一下介绍。
（1）kudu cluster
举例：
sudo -u kudu kudu cluster ksck node01:7051,node02:7051,node03:7051 sudo -u kudu kudu cluster rebalance node01:7051,node02:7051,node03:7051 （2）kudu master
举例：
kudu master list node01:7051,node02:7051,node03:7051 kudu master status node01:7051 （3）kudu tserver
举例：
kudu tserver list node01:7051,node02:7051,node03:7051 kudu tserver status node01:7050 （4）kudu table
举例：
kudu table list node01:7051,node02:7051,node03:7051 kudu table describe node01:7051,node02:7051,node03:7051 students kudu table locate_row node01:7051,node02:7051,node03:7051 students &#39;[1]&#39; kudu table rename_table node01:7051,node02:7051,node03:7051 users user kudu table scan node01:7051,node02:7051,node03:7051 user -columns=name,age （5）kudu tablet" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/3394152ff640026199fb669eb018478b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-11T18:06:04+08:00" />
<meta property="article:modified_time" content="2023-07-11T18:06:04+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Kudu-集群管理、基架感知、透明分层存储管理、性能优化</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#Kudu_5" rel="nofollow">Kudu集群管理</a></li><li><ul><li><a href="#Kudu_7" rel="nofollow">Kudu命令行工具</a></li><li><ul><li><a href="#_9" rel="nofollow">命令行工具盘点</a></li><li><a href="#_29" rel="nofollow">常见命令</a></li></ul> 
    </li><li><a href="#Kudu_Web_114" rel="nofollow">Kudu Web界面</a></li><li><ul><li><a href="#WebUI_116" rel="nofollow">WebUI端口</a></li><li><a href="#Master_Web_UI_124" rel="nofollow">Master Web UI</a></li><li><a href="#Tablet_Server_Web_UI_140" rel="nofollow">Tablet Server Web UI</a></li></ul> 
    </li><li><a href="#_156" rel="nofollow">监控和管理工具</a></li><li><ul><li><a href="#_162" rel="nofollow">编译和安装</a></li><li><a href="#_314" rel="nofollow">使用</a></li></ul> 
    </li><li><a href="#_334" rel="nofollow">备份与恢复</a></li></ul> 
   </li><li><a href="#_380" rel="nofollow">其他高级主题</a></li><li><ul><li><a href="#_382" rel="nofollow">机架感知</a></li><li><ul><li><a href="#_384" rel="nofollow">机架感知作用</a></li><li><a href="#_410" rel="nofollow">配置机架感知</a></li></ul> 
    </li><li><a href="#_535" rel="nofollow">透明分层存储管理</a></li><li><a href="#_585" rel="nofollow">索引跳跃式扫描优化</a></li><li><a href="#_640" rel="nofollow">资源规划</a></li><li><a href="#_692" rel="nofollow">性能调优</a></li><li><ul><li><a href="#_694" rel="nofollow">硬件层面优化</a></li><li><a href="#_714" rel="nofollow">操作系统层面优化</a></li><li><a href="#_748" rel="nofollow">网络优化</a></li><li><a href="#_760" rel="nofollow">配置调优</a></li></ul> 
   </li></ul> 
   </li><li><a href="#_817" rel="nofollow">透明分层存储案例分析</a></li><li><ul><li><a href="#_819" rel="nofollow">需求分析</a></li><li><a href="#_836" rel="nofollow">方案设计</a></li><li><ul><li><a href="#_838" rel="nofollow">架构设计</a></li><li><a href="#_855" rel="nofollow">分层存储设计</a></li></ul> 
    </li><li><a href="#_1029" rel="nofollow">模拟数据</a></li><li><a href="#_1170" rel="nofollow">构建数据流水线</a></li><li><a href="#_1180" rel="nofollow">数据验证</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="Kudu_5"></a>Kudu集群管理</h3> 
<h4><a id="Kudu_7"></a>Kudu命令行工具</h4> 
<h5><a id="_9"></a>命令行工具盘点</h5> 
<p>Kudu在安装时默认就安装了命令行工具，只需要执行Kudu命令就能看到所有的命令分组：</p> 
<p><img src="https://images2.imgbox.com/ab/f8/0QSsCa5t_o.png" alt="MSIZE"></p> 
<p><strong>一共有14个分组，组下面才是具体的命令，分组如下：</strong></p> 
<p><img src="https://images2.imgbox.com/41/62/yl8ljRea_o.png" alt="MMSIZE"></p> 
<p><strong>执行kudu命令组就可以列出下面的子命令</strong>：</p> 
<pre><code class="prism language-bash">kudu cluster
</code></pre> 
<p><img src="https://images2.imgbox.com/9d/8f/c28hkFuF_o.png" alt="MMSIZE"></p> 
<h5><a id="_29"></a>常见命令</h5> 
<p>Kudu提供了丰富的命令行工具方便用户管理集群，这里选择一些常见且命令做一下介绍。</p> 
<p>（1）kudu cluster</p> 
<p><img src="https://images2.imgbox.com/0a/0d/vpXJwSBh_o.png" alt="MMSIZE"></p> 
<p>举例：</p> 
<pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token parameter variable">-u</span> kudu kudu cluster ksck node01:7051,node02:7051,node03:7051 
<span class="token function">sudo</span> <span class="token parameter variable">-u</span> kudu kudu cluster rebalance node01:7051,node02:7051,node03:7051 
</code></pre> 
<p>（2）kudu master</p> 
<p><img src="https://images2.imgbox.com/2d/72/9LArw7dg_o.png" alt="MMSIZE"></p> 
<p>举例：</p> 
<pre><code class="prism language-bash">kudu master list node01:7051,node02:7051,node03:7051 
kudu master status node01:7051 
</code></pre> 
<p>（3）kudu tserver</p> 
<p><img src="https://images2.imgbox.com/15/38/bGXlwRbG_o.png" alt="MMSIZE"></p> 
<p>举例：</p> 
<pre><code class="prism language-bash">kudu tserver list node01:7051,node02:7051,node03:7051 
kudu tserver status node01:7050 
</code></pre> 
<p>（4）kudu table</p> 
<p><img src="https://images2.imgbox.com/d2/65/kjMnIlvv_o.png" alt="MMSIZE"></p> 
<p>举例：</p> 
<pre><code class="prism language-bash">kudu table list node01:7051,node02:7051,node03:7051 
kudu table describe node01:7051,node02:7051,node03:7051 students 
kudu table locate_row node01:7051,node02:7051,node03:7051 students <span class="token string">'[1]'</span> 
kudu table rename_table node01:7051,node02:7051,node03:7051 <span class="token function">users</span> user 
kudu table scan node01:7051,node02:7051,node03:7051 user <span class="token parameter variable">-columns</span><span class="token operator">=</span>name,age 
</code></pre> 
<p>（5）kudu tablet</p> 
<p><img src="https://images2.imgbox.com/b3/52/wLvsWByp_o.png" alt="MMSIZE"></p> 
<p>举例：</p> 
<pre><code class="prism language-bash">kudu tablet leader_step_down node01:7051,node02:7051,node03:7051 ea5023405f694426abe0c1887726e4cb 
</code></pre> 
<p>（6）kudu perf</p> 
<p><img src="https://images2.imgbox.com/ac/90/2mjh4EMJ_o.png" alt="MMSIZE"></p> 
<p>举例：</p> 
<pre><code class="prism language-bash">kudu perf table_scan node01:7051,node02:7051,node03:7051 students 
</code></pre> 
<h4><a id="Kudu_Web_114"></a>Kudu Web界面</h4> 
<h5><a id="WebUI_116"></a>WebUI端口</h5> 
<p>除了命令行工具，我们之前已经看到Kudu提供Master和Tablet Server Web UI，默认端口如下：</p> 
<p><img src="https://images2.imgbox.com/57/42/DZ373pxQ_o.png" alt="MMSIZE"></p> 
<h5><a id="Master_Web_UI_124"></a>Master Web UI</h5> 
<p>（1）主界面</p> 
<p>访问任意一台Master的WebUI即可，如果你没有修改默认端口：</p> 
<p>http://node01:8051</p> 
<p><img src="https://images2.imgbox.com/74/2a/lvuwmrsf_o.png" alt="MSIZE"></p> 
<p>下表是对主界面菜单功能的说明：</p> 
<p><img src="https://images2.imgbox.com/e5/30/vLifMVxP_o.png" alt="MMSIZE"></p> 
<h5><a id="Tablet_Server_Web_UI_140"></a>Tablet Server Web UI</h5> 
<p>（1）主界面</p> 
<p>访问任意一台tserver的WebUI即可，如果你没有修改默认端口：</p> 
<p>http://node01:8050</p> 
<p><img src="https://images2.imgbox.com/77/eb/NgNNz3So_o.png" alt="MSIZE"></p> 
<p>下表是对主界面菜单功能的说明：</p> 
<p><img src="https://images2.imgbox.com/f3/d9/rLTWeF7R_o.png" alt="MMSIZE"></p> 
<h4><a id="_156"></a>监控和管理工具</h4> 
<p>Github上有一个Kudu的监控管理工具kudu-plus，它使用JavaFX开发的一个桌面应用，见如下链接：</p> 
<p>https://github.com/Xchunguang/kudu-plus</p> 
<h5><a id="_162"></a>编译和安装</h5> 
<p>（1）克隆代码</p> 
<pre><code class="prism language-bash"><span class="token function">git</span> clone https://github.com/Xchunguang/kudu-plus.git 
</code></pre> 
<p>（2）修改kudu-client版本</p> 
<p>导入项目到IDEA，然后修改pom.xml：</p> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span> 
         <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span> 
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 
                             http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span> 
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span> 
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>packaging</span><span class="token punctuation">&gt;</span></span>jar<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>packaging</span><span class="token punctuation">&gt;</span></span> 
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.xuchg<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> 
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>KuduPlus<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span> 
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span> 
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.0.3.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span> <span class="token punctuation">/&gt;</span></span> 
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span> 
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">&gt;</span></span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project.build.sourceEncoding</span><span class="token punctuation">&gt;</span></span>UTF-8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project.build.sourceEncoding</span><span class="token punctuation">&gt;</span></span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project.reporting.outputEncoding</span><span class="token punctuation">&gt;</span></span>UTF- 
            8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project.reporting.outputEncoding</span><span class="token punctuation">&gt;</span></span> 
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span> 
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span> 
        <span class="token comment">&lt;!--boot依赖 --&gt;</span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span> 
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> 
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span> 
        <span class="token comment">&lt;!-- jpa --&gt;</span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span> 
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> 
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-jpa<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span> 
        <span class="token comment">&lt;!--lombok插件 --&gt;</span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span> 
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> 
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span> 
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span> 
        <span class="token comment">&lt;!--fastjson依赖 --&gt;</span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span> 
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> 
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span> 
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>[1.2.31,)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span> 
        <span class="token comment">&lt;!--derby内嵌数据库依赖 --&gt;</span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span> 
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.derby<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> 
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>derby<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span> 
        <span class="token comment">&lt;!--druid数据源依赖 --&gt;</span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span> 
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> 
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>druid<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span> 
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0.31<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span> 
        <span class="token comment">&lt;!-- 日志 --&gt;</span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span> 
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>log4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> 
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>log4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span> 
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2.17<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span> 
        <span class="token comment">&lt;!-- commons-lang3 --&gt;</span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span> 
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> 
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-lang3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span> 
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span> 
        <span class="token comment">&lt;!-- kudu-client --&gt;</span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span> 
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.kudu<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> 
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>kudu-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span> 
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.10.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span> 
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span> 
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span> 
            <span class="token comment">&lt;!--javafx application package --&gt;</span> 
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span> 
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.zenjava<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> 
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>javafx-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span> 
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>8.8.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span> 
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span> 
                    <span class="token comment">&lt;!--启动类 --&gt;</span> 
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mainClass</span><span class="token punctuation">&gt;</span></span>com.xuchg.MainApplication<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mainClass</span><span class="token punctuation">&gt;</span></span> 
                    <span class="token comment">&lt;!--运行文件名 --&gt;</span> 
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appName</span><span class="token punctuation">&gt;</span></span>KuduPlus<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appName</span><span class="token punctuation">&gt;</span></span> 
                    <span class="token comment">&lt;!--启用自定义打包配置 --&gt;</span> 
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>verbose</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>verbose</span><span class="token punctuation">&gt;</span></span> 
                    <span class="token comment">&lt;!--菜单图标 --&gt;</span> 
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>needMenu</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>needMenu</span><span class="token punctuation">&gt;</span></span> 
                    <span class="token comment">&lt;!--桌面图标 --&gt;</span> 
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>needShortcut</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>needShortcut</span><span class="token punctuation">&gt;</span></span> 
                    <span class="token comment">&lt;!--JVM参数 --&gt;</span> 
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>jvmArgs</span><span class="token punctuation">&gt;</span></span> 
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>jvmArg</span><span class="token punctuation">&gt;</span></span>-Xms50M<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>jvmArg</span><span class="token punctuation">&gt;</span></span> 
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>jvmArg</span><span class="token punctuation">&gt;</span></span>-Xmx100M<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>jvmArg</span><span class="token punctuation">&gt;</span></span> 
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>jvmArg</span><span class="token punctuation">&gt;</span></span>-XX:MaxPermSize=100M<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>jvmArg</span><span class="token punctuation">&gt;</span></span> 
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>jvmArg</span><span class="token punctuation">&gt;</span></span>-XX:-UseGCOverheadLimit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>jvmArg</span><span class="token punctuation">&gt;</span></span> 
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>jvmArg</span><span class="token punctuation">&gt;</span></span>-Dvisualvm.display.name=KuduPlus<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>jvmArg</span><span class="token punctuation">&gt;</span></span> 
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>jvmArgs</span><span class="token punctuation">&gt;</span></span> 
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>vendor</span><span class="token punctuation">&gt;</span></span>大讲台<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>vendor</span><span class="token punctuation">&gt;</span></span> 
                    <span class="token comment">&lt;!--安装配置项 --&gt;</span> 
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bundleArguments</span><span class="token punctuation">&gt;</span></span> 
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>installdirChooser</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>installdirChooser</span><span class="token punctuation">&gt;</span></span> 
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bundleArguments</span><span class="token punctuation">&gt;</span></span> 
                    <span class="token comment">&lt;!--允许所有权限 --&gt;</span> 
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>allPermissions</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>allPermissions</span><span class="token punctuation">&gt;</span></span> 
                    <span class="token comment">&lt;!--版本信息 --&gt;</span> 
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>nativeReleaseVersion</span><span class="token punctuation">&gt;</span></span>v1.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>nativeReleaseVersion</span><span class="token punctuation">&gt;</span></span> 
                    <span class="token comment">&lt;!--说明信息 --&gt;</span> 
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span> 
                        KuduPlus是kudu可视化管理工具 
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span> 
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span> 
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span> 
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span> 
</code></pre> 
<p>（3）编译</p> 
<pre><code class="prism language-bash">mvn clean jfx:native 
</code></pre> 
<p>注意编译JavaFX应用跟普通应用是有区别的</p> 
<p>编译完成之后在targetjfxnativeKuduPlus下：</p> 
<p><img src="https://images2.imgbox.com/5a/00/0fzYRbrz_o.png" alt="MMSIZE"></p> 
<p>（4）安装</p> 
<p>我们targetjfxnativeKuduPlus整个目录拷贝到任意一个你喜欢的目录就算安装好了（绿色版本）。</p> 
<h5><a id="_314"></a>使用</h5> 
<p>（1）启动</p> 
<p>进入安装目录，点击：</p> 
<p><img src="https://images2.imgbox.com/ea/a2/p5F8xesU_o.png" alt="MMSIZE"></p> 
<p>（2）新建连接</p> 
<p><img src="https://images2.imgbox.com/3f/3a/LR5stWBo_o.png" alt="MMSIZE"></p> 
<p><img src="https://images2.imgbox.com/89/b1/XFbPsdNX_o.png" alt="MMSIZE"></p> 
<p>（3）连接集群</p> 
<p><img src="https://images2.imgbox.com/ef/23/Pkm696ju_o.png" alt="MMSIZE"></p> 
<h4><a id="_334"></a>备份与恢复</h4> 
<p>从Kudu 1.10.0开始，Kudu通过Apache Spark Job支持完整表备份和增量表备份。 此外，它还支持通过使用Apache Spark还原Job从完整备份和增量备份还原表。</p> 
<p>原理：</p> 
<p><img src="https://images2.imgbox.com/8b/ce/PBOKL1US_o.png" alt="MMSIZE"></p> 
<p>备份表：</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">cd</span> /usr/lib/kudu 
spark-submit <span class="token parameter variable">--class</span> org.apache.kudu.backup.KuduBackup kudu-backup2_2.11-1.10.0- cdh6.3.0.jar  
<span class="token parameter variable">--kuduMasterAddresses</span> master1-host,master-2-host,master-3-host  
<span class="token parameter variable">--rootPath</span> hdfs:///kudu-backups  
foo bar 
</code></pre> 
<p>第一次执行是全量备份，后续执行就是增量备份，可以通过 --forceFull 标志来强制再次执行一次全量备份。</p> 
<p>HDFS目录结构：</p> 
<pre><code class="prism language-bash">/<span class="token operator">&lt;</span>rootPath<span class="token operator">&gt;</span>/<span class="token operator">&lt;</span>tableId<span class="token operator">&gt;</span>-<span class="token operator">&lt;</span>tableName<span class="token operator">&gt;</span>/<span class="token operator">&lt;</span>backup-id<span class="token operator">&gt;</span>/ 
.kudu-metadata.json 
part-.<span class="token operator">&lt;</span>format<span class="token operator">&gt;</span> 
</code></pre> 
<p>目前只支持parquet格式，一个分区对应一个part-.parquet文件。</p> 
<p>恢复表：</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">cd</span> /usr/lib/kudu 
spark-submit <span class="token parameter variable">--class</span> org.apache.kudu.backup.KuduRestore kudu-backup2_2.11- <span class="token number">1.10</span>.0-cdh6.3.0.jar  
<span class="token parameter variable">--kuduMasterAddresses</span> master1-host,master-2-host,master-3-host  
<span class="token parameter variable">--rootPath</span> hdfs:///kudu-backups  
foo bar 
</code></pre> 
<p>注意：目前还不支持物理备份</p> 
<h3><a id="_380"></a>其他高级主题</h3> 
<h4><a id="_382"></a>机架感知</h4> 
<h5><a id="_384"></a>机架感知作用</h5> 
<p>机架感知通俗的讲就是Kudu能够知道每个Tablet Server处于哪个数据中心的哪个机架，它在副本的负载策略上就可以考虑的更全面，避免同一tablet的多个副本负载到同一机架，从而防止整个机架故障时tablet不可用。</p> 
<p>下图是一个很好的例子：</p> 
<p><img src="https://images2.imgbox.com/2b/05/E571Zw9o_o.png" alt="MSIZE"></p> 
<p>上图中，L0-L2是三个机架，TS0 -TS5是5台Tablet Server，有两张表：</p> 
<ul><li>A表(副本因子=3)，包含A0-A3四个tablets</li><li>B表（副本因子=5)，包含B0-B2三个tablets</li></ul> 
<p>如果Kudu配置了机架感知，它就会发现上面的tablet分布违背了相关规则：</p> 
<ul><li>副本A0.0和A0.1构成了大多数副本（三分之二），并且位于相同的位置/L0中，一旦L0机架电源或者交换机故障，将只有L1上的A0.2—个tablet副本可用且无法选择出leader（根据Raft协议必须 n/2+1 个副本正常才可以选举，n=总副本数）</li><li>B表的大多数副本集中在TSO-TS4，而TS5非常空闲，在即考虑机架分布式又考虑负载均衡的前提下，需要把B表的相关副本往TS5挪一挪</li></ul> 
<p>经过手工负载均衡，负载可能会变成如下样子：</p> 
<p><img src="https://images2.imgbox.com/ad/bd/RfLbm6Nc_o.png" alt="MSIZE"></p> 
<p>注意：目前还不支持自动复杂均衡。</p> 
<h5><a id="_410"></a>配置机架感知</h5> 
<p>本节将告诉大家如何配置Kudu的机架感知：</p> 
<ul><li><strong>准备机架感知脚本</strong></li><li><strong>启用机架感知</strong></li></ul> 
<p><strong>（1）准备机架感知脚本</strong></p> 
<pre><code class="prism language-bash"><span class="token function">vi</span> location_awareness.sh
</code></pre> 
<p>脚本内容如下：</p> 
<pre><code class="prism language-shell"><span class="token shebang important">#!/bin/sh </span>
<span class="token comment">#</span>
<span class="token comment"># It's assumed a Kudu cluster consists of nodes with IPv4 addresses in the </span>
<span class="token comment"># private 192.168.100.0/32 subnet. The nodes are hosted in racks, where </span>
<span class="token comment"># each rack can contain at most 32 nodes. This results in 8 locations, </span>
<span class="token comment"># one location per rack. </span>
<span class="token comment">#</span>
<span class="token comment"># This example script maps IP addresses into locations assuming that RPC </span>
<span class="token comment"># endpoints of tablet servers are specified via IPv4 addresses. If tablet </span>
<span class="token comment"># servers' RPC endpoints are specified using DNS hostnames (and that's how </span>
<span class="token comment"># it's done by default), the script should consume DNS hostname instead of </span>
<span class="token comment"># an IP address as an input parameter. Check the `--rpc_bind_addresses` and </span>
<span class="token comment"># `--rpc_advertised_addresses` command line flags of kudu-tserver for details. </span>
<span class="token comment">#</span>
<span class="token comment"># DISCLAIMER: </span>
<span class="token comment"># This is an example Bourne shell script for Kudu location assignment. Please </span>
<span class="token comment"># note it's just a toy script created with illustrative-only purpose. </span>
<span class="token comment"># The error handling and the input validation are minimalistic. Also, the </span>
<span class="token comment"># network topology choice, supportability and capacity planning aspects of </span>
<span class="token comment"># this script might be sub-optimal if applied as-is for real-world use cases. </span>
<span class="token builtin class-name">set</span> <span class="token parameter variable">-e</span> 
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$#</span> <span class="token parameter variable">-ne</span> <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span> 
  <span class="token builtin class-name">echo</span> <span class="token string">"usage: <span class="token variable">$0</span> &lt;ip_address&gt;"</span> 
  <span class="token builtin class-name">exit</span> <span class="token number">1</span> 
<span class="token keyword">fi</span>

<span class="token assign-left variable">ip_address</span><span class="token operator">=</span><span class="token variable">$1</span> 
<span class="token builtin class-name">shift</span> 

<span class="token assign-left variable">suffix</span><span class="token operator">=</span><span class="token variable">${ip_address<span class="token operator">##</span>192.168.2.}</span> 
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token string">"<span class="token variable">${suffix<span class="token operator">##</span>*.*}</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span> 
  <span class="token comment"># An IP address from a non-controlled subnet: maps into the 'other' location. </span>
  <span class="token builtin class-name">echo</span> <span class="token string">"/other"</span> 
  <span class="token builtin class-name">exit</span> <span class="token number">0</span> 
<span class="token keyword">fi</span>

<span class="token comment"># The mapping of the IP addresses </span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token string">"<span class="token variable">$suffix</span>"</span> <span class="token parameter variable">-o</span> <span class="token variable">$suffix</span> <span class="token parameter variable">-lt</span> <span class="token number">0</span> <span class="token parameter variable">-o</span> <span class="token variable">$suffix</span> <span class="token parameter variable">-gt</span> <span class="token number">255</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span> 
    <span class="token builtin class-name">echo</span> <span class="token string">"ERROR: '<span class="token variable">$ip_address</span>' is not a valid IPv4 address"</span> 
    <span class="token builtin class-name">exit</span> <span class="token number">2</span> 
<span class="token keyword">fi</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$suffix</span> <span class="token parameter variable">-eq</span> <span class="token number">0</span> <span class="token parameter variable">-o</span> <span class="token variable">$suffix</span> <span class="token parameter variable">-eq</span> <span class="token number">255</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span> 
  <span class="token builtin class-name">echo</span> <span class="token string">"ERROR: '<span class="token variable">$ip_address</span>' is a 0xffffff00 IPv4 subnet address"</span> 
  <span class="token builtin class-name">exit</span> <span class="token number">3</span> 
<span class="token keyword">fi</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$suffix</span> <span class="token parameter variable">-lt</span> <span class="token number">32</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span> 
  <span class="token builtin class-name">echo</span> <span class="token string">"/dc0/rack00"</span> 
<span class="token keyword">elif</span> <span class="token punctuation">[</span> <span class="token variable">$suffix</span> <span class="token parameter variable">-ge</span> <span class="token number">32</span> <span class="token parameter variable">-a</span> <span class="token variable">$suffix</span> <span class="token parameter variable">-lt</span> <span class="token number">64</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span> 
  <span class="token builtin class-name">echo</span> <span class="token string">"/dc0/rack01"</span> 
<span class="token keyword">elif</span> <span class="token punctuation">[</span> <span class="token variable">$suffix</span> <span class="token parameter variable">-ge</span> <span class="token number">64</span> <span class="token parameter variable">-a</span> <span class="token variable">$suffix</span> <span class="token parameter variable">-lt</span> <span class="token number">96</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span> 
  <span class="token builtin class-name">echo</span> <span class="token string">"/dc0/rack02"</span> 
<span class="token keyword">elif</span> <span class="token punctuation">[</span> <span class="token variable">$suffix</span> <span class="token parameter variable">-ge</span> <span class="token number">96</span> <span class="token parameter variable">-a</span> <span class="token variable">$suffix</span> <span class="token parameter variable">-lt</span> <span class="token number">128</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span> 
  <span class="token builtin class-name">echo</span> <span class="token string">"/dc0/rack03"</span> 
<span class="token keyword">elif</span> <span class="token punctuation">[</span> <span class="token variable">$suffix</span> <span class="token parameter variable">-ge</span> <span class="token number">128</span> <span class="token parameter variable">-a</span> <span class="token variable">$suffix</span> <span class="token parameter variable">-lt</span> <span class="token number">160</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span> 
  <span class="token builtin class-name">echo</span> <span class="token string">"/dc0/rack04"</span> 
<span class="token keyword">elif</span> <span class="token punctuation">[</span> <span class="token variable">$suffix</span> <span class="token parameter variable">-ge</span> <span class="token number">160</span> <span class="token parameter variable">-a</span> <span class="token variable">$suffix</span> <span class="token parameter variable">-lt</span> <span class="token number">192</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span> 
  <span class="token builtin class-name">echo</span> <span class="token string">"/dc0/rack05"</span> 
<span class="token keyword">elif</span> <span class="token punctuation">[</span> <span class="token variable">$suffix</span> <span class="token parameter variable">-ge</span> <span class="token number">192</span> <span class="token parameter variable">-a</span> <span class="token variable">$suffix</span> <span class="token parameter variable">-lt</span> <span class="token number">224</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span> 
    <span class="token builtin class-name">echo</span> <span class="token string">"/dc0/rack06"</span> 
<span class="token keyword">else</span>
  <span class="token builtin class-name">echo</span> <span class="token string">"/dc0/rack07"</span> 
<span class="token keyword">fi</span>
</code></pre> 
<p>保存退出后：</p> 
<pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">chmod</span> +x location_awareness.sh
</code></pre> 
<p>最后分发到Kudu的各个节点指定目录下：</p> 
<pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">scp</span> location_awareness.sh root@node01:/usr/share/kudu 
<span class="token function">sudo</span> <span class="token function">scp</span> location_awareness.sh root@node02:/usr/share/kudu 
<span class="token function">sudo</span> <span class="token function">scp</span> location_awareness.sh root@node03:/usr/share/kudu 
</code></pre> 
<p><strong>（2）、启用机架感知</strong></p> 
<p>在所有节点上启用机架感知。</p> 
<ul><li> <p><strong>修改Master配置</strong></p> <pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">vi</span> /etc/kudu/conf/master.gflagfile
<span class="token comment"># 增加如下配置项：</span>
<span class="token parameter variable">--location_mapping_cmd</span><span class="token operator">=</span>/usr/share/kudu/location_awareness.sh
</code></pre> </li><li> <p><strong>修改Tablet Server</strong></p> <pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">vi</span> /etc/kudu/conf/tserver.gflagfile
<span class="token comment"># 增加如下配置项：</span>
<span class="token function">sudo</span> <span class="token function">vi</span> /etc/kudu/conf/tserver.gflagfile 
</code></pre> </li><li> <p><strong>重启Master和Tablet Server</strong></p> <pre><code class="prism language-bash">kudu-cluster.sh restart 
</code></pre> </li></ul> 
<h4><a id="_535"></a>透明分层存储管理</h4> 
<p><strong>（1）存储选择方法</strong></p> 
<p>Kudu是为快速数据上的快速分析场景而生的，但是Kudu的成本并不低，且扩展性并没有那么好（tserver的个数不能太多）。</p> 
<p>HDFS旨在以低成本实现无限的可扩展性。它针对数据不可更改的面向批处理的场景进行了优化，当使用Parquet文件格式，可以以极高的吞吐量和效率访问结构化数据。</p> 
<ul><li><strong>对于数据比较小且不断变化的数据（例如维表）通常全部存放到Kudu</strong></li><li><strong>当数据不会超过Kudu的扩展范围限制，且能够从Kudu的独特功能中受益时（快速变化、快速分），通常作为大表保存在Kudu</strong></li><li><strong>当数据量非常大，面向批处理且基本不太可能变更的情况下首选以Parquet格式将数据存储在HDFS中（冷数据）</strong></li></ul> 
<p>**（2）基于滑动窗口的透明存储管理方案 **</p> 
<p>当您需要两个存储层的优势时，滑动窗口模式是一个有用的解决方案。该方案的主要思路是：</p> 
<ul><li><strong>使用lmpala创建2张表：Kudu表和Parquet 格式的HDFS表</strong></li><li><strong>这两张表都是按照时间分区的表，分区粒度取决于数据在Kudu表和HDFS表之间迁移的频率，般是按照年或者月或者曰分区，特殊情况下可以更细粒度</strong></li><li><strong>在lmpala另外创建一个统一视图，并使用where字句定义一个边界，由该边界决定哪些数据该从哪个表读取</strong></li><li><strong>Kudu中变冷的数据分区会定期的被刷写到HDFS (Parquet）</strong></li><li><strong>数据刷写之后，在HDFS表新增分区、使用原子的ALTER VIEW 操作把视图的边界往前推移</strong></li></ul> 
<p><img src="https://images2.imgbox.com/2b/5e/A9vXNBid_o.png" alt="MMSIZE"></p> 
<p>该方案的好处是：</p> 
<ul><li><strong>流式数据可立即查询</strong></li><li><strong>可以更新迟到的数据或进行手动更正</strong></li><li><strong>HDFS中存储的数据具有最佳大小，可提高性能并防止小文件降低成本</strong></li></ul> 
<p><strong>（3）数据从Kudu迁到HDFS的过程</strong></p> 
<p>数据从Kudu迁移到HDFS需要经过下面两个步骤，该过程需要定时自动调度。</p> 
<ul><li> <p><strong>数据迁移</strong></p> <p>在第一阶段，将现在不变的数据从Kudu复制到HDFS。即使将数据从Kudu复制到HDFS，在视图中定义的边界也将阻止向用户显示重复数据。此步骤应该包含检查机制，以确保成功完成数据的迁移和卸载。</p> <p><img src="https://images2.imgbox.com/fb/21/e3m6znhO_o.png" alt="MMSIZE"></p> </li><li> <p><strong>元数据修改</strong></p> <p>在第二阶段，既然已将数据安全地复制到HDFS，则更改元数据以调整如何显示卸载的分区。 这包括向前移动边界，添加下一个时间窗口的新的Kudu分区以及删除旧的Kudu分区。</p> <p><img src="https://images2.imgbox.com/10/8e/JTIXdXvE_o.png" alt="MMSIZE"></p> </li></ul> 
<h4><a id="_585"></a>索引跳跃式扫描优化</h4> 
<p><strong>（1）索引跳跃式扫描优化</strong></p> 
<p>我们通过如下例子来说明Kudu的索引跳跃式扫描优化，现有如下一张表：</p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> metrics <span class="token punctuation">(</span> 
    host STRING<span class="token punctuation">,</span> 
    tstamp <span class="token keyword">INT</span><span class="token punctuation">,</span> 
    clusterid <span class="token keyword">INT</span><span class="token punctuation">,</span> 
    role STRING<span class="token punctuation">,</span> 
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>host<span class="token punctuation">,</span> tstamp<span class="token punctuation">,</span> clusterid<span class="token punctuation">)</span> 
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>数据是这个样子的：</p> 
<p><img src="https://images2.imgbox.com/ee/7f/kw4w9fW9_o.png" alt="MMSIZE"></p> 
<p>Kudu在内部会创建主键索引（B-tree），跟上表类似，索引数据按所有主键列的组合排序。当用户查询包含第一主键列（host）时，Kudu将使用索引（因为索引数据主要在第一个主键列上排序）。</p> 
<p>如果用户查询不包含第一个主键列而仅包含tstamp列怎么办？tstamp虽然在固定host下是有序的，但全局是无须的，所以无法使用主键索引。在关系型数据库中一般采用二级索引，但是Kudu并不支持二级索引，难道必须全表扫描吗？</p> 
<p>Kudu当然不会全表扫描。在下面的查询中，tstamp之前的列为“prefifix column”，列的具体值为“prefifixkey”，在咱们的例子中host就是prefifix column。在索引中首先按照prefifix key排序，相同的prefifix key在按照剩余列的值排序，因此可以使用索引跳转到具有不同prefifix key且tstamp满足条件的行上。</p> 
<pre><code class="prism language-bash">SELECT clusterid FROM metrics WHERE tstamp <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/f6/29/aZipGhb8_o.png" alt="MMSIZE"></p> 
<p>上图中绿色的是扫描的行，其余的是跳过的。Tablet Server使用索引（ prefifix key (host =helium)+tstamp = 100）跳过不匹配的行直接到达第三行并逐步扫描直到不匹配tstamp = 100，就通过下一个prefifix key (host = ubuntu)+tstamp = 100继续跳过不匹配的行。其余prefifix key采用相同的做法，这就叫做Index Skip Scan优化。</p> 
<p><strong>（2）性能</strong></p> 
<ul><li> <p>索引跳跃式扫描优化的性能与前缀列 （prefix column) 的基数(prefix key去重后的数量）负相关</p> <p>以上面的例子来说：host的基数越低，跳跃扫描性能越高，反之则性能越差。</p> </li><li> <p>前缀列基数很高时，索引跳跃式扫描优化就不可取了</p> <p>使用前面的metrics表，官方有一个测试，见下图：</p> <p><img src="https://images2.imgbox.com/1c/4a/vCHJfwv4_o.png" alt="MMSIZE"></p> </li></ul> 
<p>在每个tablet一千万行的数据规模下，当【前缀列host基数&gt;sqrt(number_of_rows_in_tablet)】时，索引跳跃式扫描性能开始下降。 为了解决这个问题：</p> 
<ul><li>Kudu目前在【跳跃次数&gt;sqrt(number_of_rows_in_tablet)】时自动禁用跳跃扫描优化</li><li>更好的策略Kudu会在未来推出，让我们拭目以待</li></ul> 
<h4><a id="_640"></a>资源规划</h4> 
<p>在做资源规划是重点考虑的是tserver，master负载要小很多，回顾已知tserver相关的建议和限制如下：</p> 
<p><img src="https://images2.imgbox.com/1c/51/ES6tBhFJ_o.png" alt="MMSIZE"></p> 
<p><strong>（1）集群规模</strong></p> 
<p><img src="https://images2.imgbox.com/96/d3/oJm64HeR_o.png" alt="MMSIZE"></p> 
<p>这里有一个预估tserver服务器数量的公式供参考：t=d/(k∗(1-p))∗r</p> 
<p><img src="https://images2.imgbox.com/3d/11/iVKzWRZj_o.png" alt="MMSIZE"></p> 
<p>示例：</p> 
<pre><code class="prism language-bash"><span class="token assign-left variable">d</span><span class="token operator">=</span>120T 
<span class="token assign-left variable">K</span><span class="token operator">=</span>8T 
<span class="token assign-left variable">p</span><span class="token operator">=</span><span class="token number">25</span>% 
<span class="token assign-left variable">r</span><span class="token operator">=</span><span class="token number">3</span> 
<span class="token assign-left variable">t</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">120</span> / <span class="token punctuation">(</span><span class="token number">8</span> * <span class="token punctuation">(</span><span class="token number">1</span> - <span class="token number">0.25</span><span class="token punctuation">))</span><span class="token punctuation">)</span>*3 <span class="token operator">=</span> <span class="token number">60</span> 
</code></pre> 
<p><strong>（2）内存和CPU</strong></p> 
<p><img src="https://images2.imgbox.com/2d/58/hicoCtbA_o.png" alt="MMSIZE"></p> 
<p><strong>（3）磁盘</strong></p> 
<p>跟HDFS不一样，Kudu针对SSD做了特别优化，推荐使用SSD：</p> 
<p><img src="https://images2.imgbox.com/ff/37/gkQjp0V8_o.png" alt="MMSIZE"></p> 
<p>WAL、metadata、data的目录配置别忘了：</p> 
<pre><code class="prism language-bash"><span class="token parameter variable">--fs_wal_dir</span> 
<span class="token parameter variable">--fs_metadata_dir</span> 
<span class="token parameter variable">--fs_data_dirs</span>
</code></pre> 
<p><strong>（4）网卡</strong></p> 
<p><img src="https://images2.imgbox.com/b1/5e/Iasw4T4w_o.png" alt="MMSIZE"></p> 
<h4><a id="_692"></a>性能调优</h4> 
<h5><a id="_694"></a>硬件层面优化</h5> 
<ul><li> <p><strong>tserver的WAL采用M.2接口(NVMe协办议）SSD</strong></p> <p>Kudu的每一次写入都会先写WAL，WAL是确保数据不丢失的关键，所以一般都会同步写磁盘（顺序写），为了提高性能建议tserver采用M.2接口（NVMe协议）SSD来存储WAL，至少也得是普通SSD (master读写压力小，跟操作系统共享SSD即可）</p> <pre><code class="prism language-bash"><span class="token parameter variable">--fs_wal_dir</span><span class="token operator">=</span>/data/kudu/tserver/wal
</code></pre> </li><li> <p><strong>数据存储多SSD</strong></p> <p>tserver负责数据的读写和复制，压力比较大，建议采用多SSD分散读写10。</p> <pre><code class="prism language-bash"><span class="token parameter variable">--fs_data_dirs</span><span class="token operator">=</span>/disk1/kudu/tserver/data,/disk2/kudu/tserver/data,/disk3/kudu/tserv er/data
</code></pre> </li></ul> 
<h5><a id="_714"></a>操作系统层面优化</h5> 
<ul><li> <p>文件描述符和线程数限制</p> <p>操作系统会控制每个用户使用的文件描述符和线程数，Kudu作为数据库肯定比一般应用需要更多文件描述符和线程数。</p> <p>如果Kudu使用的线程数超过OS的限制，你会在日志中看到如下报错：</p> <pre><code class="prism language-bash">pthread_create failed: Resource temporarily unavailable
</code></pre> </li><li> <p>降低或者禁用swap使用交换区会导致性能下降，建议降低swap的使用：</p> <pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">su</span>
<span class="token builtin class-name">echo</span> <span class="token string">"vm. swappiness=10"</span><span class="token operator">&gt;&gt;</span> /etc/sysctl.conf
<span class="token builtin class-name">exit</span>
</code></pre> <p>上面参数重启才能生效，可以同时搭配如下命令避免重启：</p> <pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">sysctl</span> vm. <span class="token assign-left variable">swappiness</span><span class="token operator">=</span><span class="token number">10</span>
</code></pre> <p>检查当前是否生效：</p> <pre><code class="prism language-bash"><span class="token function">cat</span> /proc/sys/vm /swappiness
</code></pre> </li></ul> 
<h5><a id="_748"></a>网络优化</h5> 
<ul><li> <p>多机架万兆网络<br> <img src="https://images2.imgbox.com/64/1f/mJAow0Sd_o.png" alt=""></p> </li><li> <p><strong>双干兆网卡绑定</strong></p> <p>双干兆网卡绑定可以应对单一网卡故障并提高性能。</p> </li></ul> 
<h5><a id="_760"></a>配置调优</h5> 
<p>以下参数没有特别说明的，master和tserver都需要配置。</p> 
<p>（1）<strong>tserver内存限制</strong></p> 
<p>Tablet Server能使用的最大内存量，tablet Server在批量写入数据时并非实时写入磁盘，而是先Cache在内存中，在flflush到磁盘。这个值设置过小时，会造成Kudu数据写入性能显著下降。对于写入性能要求比较高的集群，建议设置更大的值 ：</p> 
<pre><code class="prism language-bash"><span class="token parameter variable">--memory_limit_hard_bytes</span>
</code></pre> 
<p>还有两个软限制：</p> 
<pre><code class="prism language-bash"><span class="token comment">## Cgroup 内存软限制，这个限制并不会阻止进程使用超过限额的内存，只是在系统内存不足时，会优先回 收超过限额的进程占用的内存，使之向限定值靠拢,当进程试图占用的内存超过了cgroups的限制，会触发 out of memory，导致进程被kill掉 </span>
<span class="token parameter variable">--memory_limit_soft_percentage</span><span class="token operator">=</span><span class="token number">80</span>
</code></pre> 
<p>（2）<strong>tserver维护管理器线程数</strong></p> 
<p>Kudu后台对数据进行维护操作，如写入数据时的并发线程数，一般设置为4，建议的是数据目录的3倍 ：</p> 
<pre><code class="prism language-bash"><span class="token parameter variable">--maintenance_manager_num_threads</span><span class="token operator">=</span><span class="token number">6</span>
</code></pre> 
<p>master和tserver都有这个配置只改tserver。</p> 
<p>（3）<strong>调大tserver block cache容量</strong></p> 
<p>分配给Kudu Tablet Server块缓存的最大内存量，建议是2-4G：</p> 
<pre><code class="prism language-bash"><span class="token parameter variable">--block_cache_capacity_mb</span><span class="token operator">=</span><span class="token number">2048</span>
</code></pre> 
<p>（4） 避免磁盘耗尽</p> 
<p>为避免磁盘空间耗尽，应该保留一部分空间：</p> 
<pre><code class="prism language-bash"><span class="token comment">#默认-1，表示保留1%的磁盘空间，自己配置是必须大于0</span>
<span class="token parameter variable">--fs_data_dirs_reserved_bytes</span>
</code></pre> 
<p>（5）容忍磁盘故障</p> 
<p>如果某个tablet的数据分散到更多的磁盘，则数据会更加分散，这个值越小每个tablet的数据会更加集中，不过受磁盘故障影响就越小。</p> 
<pre><code class="prism language-bash"><span class="token comment">#每个tablet的数据分散到几个目录</span>
fs_target_data_dirs_per-tablet<span class="token operator">=</span><span class="token number">3</span>
</code></pre> 
<h3><a id="_817"></a>透明分层存储案例分析</h3> 
<h4><a id="_819"></a>需求分析</h4> 
<p>某车联网系统架构如下：</p> 
<p><img src="https://images2.imgbox.com/4d/6f/YBO6xhx9_o.png" alt="MMSIZE"></p> 
<p>随着业务的发展整体架构存在如下问题：</p> 
<ul><li><strong>分析模块实时性不高</strong></li><li><strong>业务系统和报表系统经常出现数据对不上的情况</strong></li><li><strong>HBase可用性不高</strong></li><li><strong>数据过度冗余成本高、维护复杂</strong></li></ul> 
<p>再继续拓展业务之前需要把系统架构进一步升级以解决上述问题。</p> 
<h4><a id="_836"></a>方案设计</h4> 
<h5><a id="_838"></a>架构设计</h5> 
<p><img src="https://images2.imgbox.com/0f/c6/4bpfJsQv_o.png" alt="MMSIZE"></p> 
<p>上面架构如何解决之前存在问题的：</p> 
<ul><li>Kudu可以实时入库、实时分析</li><li>车载设备上传的数据只有Kudu+HDFS(Parquet)一份，不存在不一致的问题</li><li>Kudu的tablet有可靠的副本机制，可用性比HBase高</li><li>车载设备上传的数据只有Kudu+HDFS(Parquet)一份，不存在数据过度冗余问题，可维护性更好</li></ul> 
<p>数据流：</p> 
<p><img src="https://images2.imgbox.com/41/6e/CGm2hui0_o.png" alt="MMSIZE"></p> 
<h5><a id="_855"></a>分层存储设计</h5> 
<p><img src="https://images2.imgbox.com/81/99/xDHyn4UZ_o.png" alt="MMSIZE"></p> 
<p>以电池温度数据为例，进行分层存储设计如下：</p> 
<p><strong>（1）核心字段说明</strong></p> 
<p>假定电池温度数据有如下核心字段：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">deviceid</span><span class="token operator">:</span><span class="token number">3455224435.</span>
    <span class="token literal-property property">platenumber</span><span class="token operator">:</span><span class="token string">"京A-12345"</span>
    <span class="token literal-property property">batteryid</span><span class="token operator">:</span> <span class="token number">123</span>
    <span class="token literal-property property">detecttime</span><span class="token operator">:</span><span class="token string">"2019-01-01"</span>，
    <span class="token literal-property property">temperature</span><span class="token operator">:</span><span class="token number">45.5</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>网关服务会把原始的mqtt消息转换为json。</p> 
<p>注意：为了实验效果我这里的detecttime精确到天，实际业务中肯定是精确到毫秒。</p> 
<p><strong>（2） Kudu表</strong></p> 
<p>数据首先会写入Kudu表，在lmpala中的建表语句如下：</p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> battery_temp_data_kudu 
<span class="token punctuation">(</span> 
    deviceid <span class="token keyword">INT</span><span class="token punctuation">,</span> 
    batteryid <span class="token keyword">TINYINT</span><span class="token punctuation">,</span> 
    detecttime <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span> 
    platenumber STRING<span class="token punctuation">,</span> 
    temperature <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>deviceid<span class="token punctuation">,</span>batteryid<span class="token punctuation">,</span>detecttime<span class="token punctuation">)</span> 
<span class="token punctuation">)</span>
<span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> 
<span class="token keyword">HASH</span><span class="token punctuation">(</span>deviceid<span class="token punctuation">)</span> PARTITIONS <span class="token number">6</span><span class="token punctuation">,</span> 
RANGE<span class="token punctuation">(</span>detecttime<span class="token punctuation">)</span> <span class="token punctuation">(</span> 
    <span class="token keyword">PARTITION</span> <span class="token string">'2019-01-01'</span> <span class="token operator">&lt;=</span> <span class="token keyword">VALUES</span> <span class="token operator">&lt;</span> <span class="token string">'2019-02-01'</span><span class="token punctuation">,</span> 
    <span class="token keyword">PARTITION</span> <span class="token string">'2019-02-01'</span> <span class="token operator">&lt;=</span> <span class="token keyword">VALUES</span> <span class="token operator">&lt;</span> <span class="token string">'2019-03-01'</span><span class="token punctuation">,</span> 
    <span class="token keyword">PARTITION</span> <span class="token string">'2019-03-01'</span> <span class="token operator">&lt;=</span> <span class="token keyword">VALUES</span> <span class="token operator">&lt;</span> <span class="token string">'2019-04-01'</span><span class="token punctuation">,</span> 
    <span class="token keyword">PARTITION</span> <span class="token string">'2019-04-01'</span> <span class="token operator">&lt;=</span> <span class="token keyword">VALUES</span> <span class="token operator">&lt;</span> <span class="token string">'2019-05-01'</span> 
<span class="token punctuation">)</span>
STORED <span class="token keyword">AS</span> KUDU<span class="token punctuation">;</span> 
</code></pre> 
<pre><code class="prism language-bash">INSERT INTO battery_temp_data_kudu VALUES 
<span class="token punctuation">(</span><span class="token number">345522443</span>, <span class="token number">1</span>,<span class="token string">"2019-01-01"</span>,<span class="token string">"苏A-12345"</span>,23.5<span class="token punctuation">)</span>, 
<span class="token punctuation">(</span><span class="token number">345552443</span>, <span class="token number">2</span>,<span class="token string">"2019-01-01"</span>,<span class="token string">"苏A-12345"</span>,45.6<span class="token punctuation">)</span>, 
<span class="token punctuation">(</span><span class="token number">345578443</span>, <span class="token number">3</span>,<span class="token string">"2019-01-01"</span>,<span class="token string">"苏A-12345"</span>,56.7<span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre> 
<p>（3）<strong>HDFS表</strong></p> 
<p>Kudu表中的数据会定期刷写成Parquet文件加载到HDFS表，在Impala中的建表语句如下：</p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> battery_temp_data_parquet 
<span class="token punctuation">(</span> 
    deviceid <span class="token keyword">INT</span><span class="token punctuation">,</span> 
    batteryid <span class="token keyword">TINYINT</span><span class="token punctuation">,</span> 
    detecttime <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span> 
    platenumber STRING<span class="token punctuation">,</span> 
    temperature <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> 
<span class="token punctuation">)</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token keyword">year</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">month</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">day</span> <span class="token keyword">int</span><span class="token punctuation">)</span> 
STORED <span class="token keyword">AS</span> PARQUET<span class="token punctuation">;</span> 
</code></pre> 
<p><strong>（4）同一视图</strong></p> 
<p>Kudu和HDFS两张表的数据需要对外提供统一视图，以确保检索和分析数据的完整性、一致性，在Impala中的创建统一视图的语句如下：</p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> battery_temp_data_view <span class="token keyword">AS</span> 
<span class="token keyword">SELECT</span> deviceid<span class="token punctuation">,</span> batteryid<span class="token punctuation">,</span> detecttime<span class="token punctuation">,</span> platenumber<span class="token punctuation">,</span> temperature 
<span class="token keyword">FROM</span> battery_temp_data_kudu 
<span class="token keyword">WHERE</span> detecttime <span class="token operator">&gt;=</span> <span class="token string">"2019-01-01"</span> 
<span class="token keyword">UNION</span> <span class="token keyword">ALL</span> 
<span class="token keyword">SELECT</span> deviceid<span class="token punctuation">,</span> batteryid<span class="token punctuation">,</span> detecttime<span class="token punctuation">,</span> platenumber<span class="token punctuation">,</span> temperature 
<span class="token keyword">FROM</span> battery_temp_data_parquet 
<span class="token keyword">WHERE</span> detecttime <span class="token operator">&lt;</span> <span class="token string">"2019-01-01"</span> 
<span class="token operator">AND</span> <span class="token keyword">year</span> <span class="token operator">=</span> <span class="token keyword">year</span><span class="token punctuation">(</span>detecttime<span class="token punctuation">)</span> 
<span class="token operator">AND</span> <span class="token keyword">month</span> <span class="token operator">=</span> <span class="token keyword">month</span><span class="token punctuation">(</span>detecttime<span class="token punctuation">)</span> 
<span class="token operator">AND</span> <span class="token keyword">day</span> <span class="token operator">=</span> <span class="token keyword">day</span><span class="token punctuation">(</span>detecttime<span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre> 
<p>注意1：where子句中的边界可以确保数据在两个表之间复制是不会读取重复数据</p> 
<p>注意2：从HDFS表查询数据时用AND指定了年月日，这样可以谓词下推直接跳过不必要的分区</p> 
<p>注意3：要使用UNION ALL，UNION虽然会去重但是性能差，去重是由where子句指定的边界来搞定的</p> 
<p><strong>（5）数据迁移语句与执行脚本</strong></p> 
<p>Kudu表中的数据定期迁移到HDFS表的脚本window_data_move.sql：</p> 
<pre><code class="prism language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> ${var:hdfs_table} <span class="token keyword">PARTITION</span> <span class="token punctuation">(</span><span class="token keyword">year</span><span class="token punctuation">,</span> <span class="token keyword">month</span><span class="token punctuation">,</span> <span class="token keyword">day</span><span class="token punctuation">)</span> 
<span class="token keyword">SELECT</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">year</span><span class="token punctuation">(</span>detecttime<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">month</span><span class="token punctuation">(</span>detecttime<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">day</span><span class="token punctuation">(</span>detecttime<span class="token punctuation">)</span> 
<span class="token keyword">FROM</span> ${var:kudu_table} 
<span class="token keyword">WHERE</span> detecttime <span class="token operator">&gt;=</span> add_months<span class="token punctuation">(</span><span class="token string">"${var:new_boundary_time}"</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> 
<span class="token operator">AND</span> detecttime <span class="token operator">&lt;</span> <span class="token string">"${var:new_boundary_time}"</span><span class="token punctuation">;</span> 
<span class="token keyword">COMPUTE</span> INCREMENTAL STATS ${var:hdfs_table}<span class="token punctuation">;</span> 
</code></pre> 
<p>注意：COMPUTE INCREMENTAL STATS指Impala会对HDFS表的各个分区进行统计，对查询性能有帮助，不是必需的。</p> 
<p>执行脚本如下：</p> 
<pre><code class="prism language-bash">impala-shell <span class="token parameter variable">-i</span> node02:21000 <span class="token parameter variable">-f</span> window_data_move.sql  
<span class="token parameter variable">--var</span><span class="token operator">=</span>kudu_table<span class="token operator">=</span>battery_temp_data_kudu  
<span class="token parameter variable">--var</span><span class="token operator">=</span>hdfs_table<span class="token operator">=</span>battery_temp_data_parquet  
<span class="token parameter variable">--var</span><span class="token operator">=</span>new_boundary_time<span class="token operator">=</span><span class="token string">"2019-02-01"</span> 
</code></pre> 
<p>（6）<strong>修改视图语句与执行脚本</strong></p> 
<p>修改统一视图脚本window_view_alter.sql：</p> 
<pre><code class="prism language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">VIEW</span> ${var:view_name} <span class="token keyword">AS</span> 
<span class="token keyword">SELECT</span> deviceid<span class="token punctuation">,</span> batteryid<span class="token punctuation">,</span> detecttime<span class="token punctuation">,</span> platenumber<span class="token punctuation">,</span> temperature 
<span class="token keyword">FROM</span> ${var:kudu_table} 
<span class="token keyword">WHERE</span> detecttime <span class="token operator">&gt;=</span> <span class="token string">"${var:new_boundary_time}"</span> 
<span class="token keyword">UNION</span> <span class="token keyword">ALL</span> 
<span class="token keyword">SELECT</span> deviceid<span class="token punctuation">,</span> batteryid<span class="token punctuation">,</span> detecttime<span class="token punctuation">,</span> platenumber<span class="token punctuation">,</span> temperature 
<span class="token keyword">FROM</span> ${var:hdfs_table} 
<span class="token keyword">WHERE</span> detecttime <span class="token operator">&lt;</span> <span class="token string">"${var:new_boundary_time}"</span> 
<span class="token operator">AND</span> <span class="token keyword">year</span> <span class="token operator">=</span> <span class="token keyword">year</span><span class="token punctuation">(</span>detecttime<span class="token punctuation">)</span> 
<span class="token operator">AND</span> <span class="token keyword">month</span> <span class="token operator">=</span> <span class="token keyword">month</span><span class="token punctuation">(</span>detecttime<span class="token punctuation">)</span> 
<span class="token operator">AND</span> <span class="token keyword">day</span> <span class="token operator">=</span> <span class="token keyword">day</span><span class="token punctuation">(</span>detecttime<span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre> 
<p>执行脚本如下：</p> 
<pre><code class="prism language-bash">impala-shell <span class="token parameter variable">-i</span> node02:21000 <span class="token parameter variable">-f</span> window_view_alter.sql  
<span class="token parameter variable">--var</span><span class="token operator">=</span>view_name<span class="token operator">=</span>battery_temp_data_view  
<span class="token parameter variable">--var</span><span class="token operator">=</span>kudu_table<span class="token operator">=</span>battery_temp_data_kudu  
<span class="token parameter variable">--var</span><span class="token operator">=</span>hdfs_table<span class="token operator">=</span>battery_temp_data_parquet  
<span class="token parameter variable">--var</span><span class="token operator">=</span>new_boundary_time<span class="token operator">=</span><span class="token string">"2019-02-01"</span>
</code></pre> 
<p>（7）<strong>删除和新建Kudu表分区语句与执行脚本</strong></p> 
<p>删除和新建kudu表分区的语句window_partition_shift.sql：</p> 
<pre><code class="prism language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> ${var:kudu_table} 
<span class="token keyword">ADD</span> RANGE <span class="token keyword">PARTITION</span> add_months<span class="token punctuation">(</span><span class="token string">"${var:new_boundary_time}"</span><span class="token punctuation">,</span> 
${var:window_length}<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token keyword">VALUES</span> <span class="token operator">&lt;</span> add_months<span class="token punctuation">(</span><span class="token string">"${var:new_boundary_time}"</span><span class="token punctuation">,</span> 
${var:window_length} <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> ${var:kudu_table} 
<span class="token keyword">DROP</span> RANGE <span class="token keyword">PARTITION</span> add_months<span class="token punctuation">(</span><span class="token string">"${var:new_boundary_time}"</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> 
<span class="token operator">&lt;=</span> <span class="token keyword">VALUES</span> <span class="token operator">&lt;</span> <span class="token string">"${var:new_boundary_time}"</span><span class="token punctuation">;</span> 
</code></pre> 
<p>执行脚本如下：</p> 
<pre><code class="prism language-bash">impala-shell <span class="token parameter variable">-i</span> node02:21000 <span class="token parameter variable">-f</span> window_partition_shift.sql  
<span class="token parameter variable">--var</span><span class="token operator">=</span>kudu_table<span class="token operator">=</span>battery_temp_data_kudu  
<span class="token parameter variable">--var</span><span class="token operator">=</span>new_boundary_time<span class="token operator">=</span><span class="token string">"2019-02-01"</span>  
<span class="token parameter variable">--var</span><span class="token operator">=</span>window_length<span class="token operator">=</span><span class="token number">3</span> 
</code></pre> 
<h4><a id="_1029"></a>模拟数据</h4> 
<p>我们直接利用之前的工程，新增如下依赖：</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span> 
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.github.javafaker<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> 
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>javafaker<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span> 
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span> 
</code></pre> 
<p>创建com.djt.kudu.datasimulator.BatteryTempDateSimulator类：</p> 
<pre><code class="prism language-scala"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>djt<span class="token punctuation">.</span>kudu<span class="token punctuation">.</span>datasimulator</span><span class="token punctuation">;</span> 
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>javafaker<span class="token punctuation">.</span></span><span class="token class-name">Faker</span></span><span class="token punctuation">;</span> 
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kudu<span class="token punctuation">.</span></span><span class="token class-name">Schema</span></span><span class="token punctuation">;</span> 
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kudu<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span> 
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span> 
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>math<span class="token punctuation">.</span></span><span class="token class-name">BigDecimal</span></span><span class="token punctuation">;</span> 
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">Timestamp</span></span><span class="token punctuation">;</span> 
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span></span><span class="token punctuation">;</span> 
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span></span><span class="token punctuation">;</span> 
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span> 
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Locale</span></span><span class="token punctuation">;</span> 
public <span class="token keyword">class</span> BatteryTempDateSimulator <span class="token punctuation">{<!-- --></span> 
    <span class="token keyword">private</span> static <span class="token keyword">final</span> <span class="token builtin">String</span> KUDU_MASTER <span class="token operator">=</span> 
    <span class="token string">"node01:7051,node02:7051,node03:7051"</span><span class="token punctuation">;</span> 
    public static void simulator<span class="token punctuation">(</span><span class="token builtin">String</span> detecttime<span class="token punctuation">)</span> throws Exception<span class="token punctuation">{<!-- --></span> 
        Faker faker <span class="token operator">=</span> <span class="token keyword">new</span> Faker<span class="token punctuation">(</span><span class="token keyword">new</span> Locale<span class="token punctuation">(</span><span class="token string">"zh-CN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        List<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> shortNames <span class="token operator">=</span> 
        Arrays<span class="token punctuation">.</span>asList<span class="token punctuation">(</span><span class="token string">"苏"</span><span class="token punctuation">,</span><span class="token string">"京"</span><span class="token punctuation">,</span><span class="token string">"津"</span><span class="token punctuation">,</span><span class="token string">"晋"</span><span class="token punctuation">,</span><span class="token string">"冀"</span><span class="token punctuation">,</span><span class="token string">"蒙"</span><span class="token punctuation">,</span><span class="token string">"辽"</span><span class="token punctuation">,</span><span class="token string">"吉"</span><span class="token punctuation">,</span><span class="token string">"浙"</span><span class="token punctuation">,</span><span class="token string">"闽"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token comment">//1、获取KuduClient </span>
        KuduClient client <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> 
        KuduTable table <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> 
        KuduSession session <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> 
        <span class="token builtin">String</span> tableName <span class="token operator">=</span> <span class="token string">"impala::default.battery_temp_data_kudu"</span><span class="token punctuation">;</span> 
        <span class="token keyword">try</span><span class="token punctuation">{<!-- --></span>
            client <span class="token operator">=</span> <span class="token keyword">new</span> KuduClient<span class="token punctuation">.</span>KuduClientBuilder<span class="token punctuation">(</span>KUDU_MASTER<span class="token punctuation">)</span><span class="token punctuation">.</span>build<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token comment">//2、打开表KuduTable </span>
            table <span class="token operator">=</span> client<span class="token punctuation">.</span>openTable<span class="token punctuation">(</span>tableName<span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token comment">//3、创建会话KuduSession </span>
            session <span class="token operator">=</span> client<span class="token punctuation">.</span>newSession<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            session<span class="token punctuation">.</span>setFlushInterval<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token comment">//4、循环插入数据 </span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>int i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
                Insert insert <span class="token operator">=</span> table<span class="token punctuation">.</span>newInsert<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
                PartialRow row<span class="token operator">=</span>insert<span class="token punctuation">.</span>getRow<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
                <span class="token comment">//生成模拟数据 </span>
                int deviceid <span class="token operator">=</span> 
                faker<span class="token punctuation">.</span>number<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numberBetween<span class="token punctuation">(</span><span class="token number">100000000</span><span class="token punctuation">,</span><span class="token number">999999999</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
                <span class="token builtin">String</span> platenumber <span class="token operator">=</span> 
                shortNames<span class="token punctuation">.</span>get<span class="token punctuation">(</span>faker<span class="token punctuation">.</span>number<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numberBetween<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span>"<span class="token operator">-</span> 
"<span class="token operator">+</span>faker<span class="token punctuation">.</span>number<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numberBetween<span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">,</span><span class="token number">999999</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
                int batteryid <span class="token operator">=</span> faker<span class="token punctuation">.</span>number<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numberBetween<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
                double temperature <span class="token operator">=</span> faker<span class="token punctuation">.</span>number<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>randomDouble<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
                row<span class="token punctuation">.</span>addInt<span class="token punctuation">(</span><span class="token string">"deviceid"</span><span class="token punctuation">,</span>deviceid<span class="token punctuation">)</span><span class="token punctuation">;</span> 
                row<span class="token punctuation">.</span>addString<span class="token punctuation">(</span><span class="token string">"platenumber"</span><span class="token punctuation">,</span>platenumber<span class="token punctuation">)</span><span class="token punctuation">;</span> 
                row<span class="token punctuation">.</span>addByte<span class="token punctuation">(</span><span class="token string">"batteryid"</span><span class="token punctuation">,</span><span class="token builtin">Byte</span><span class="token punctuation">.</span>parseByte<span class="token punctuation">(</span>batteryid<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
                row<span class="token punctuation">.</span>addDecimal<span class="token punctuation">(</span><span class="token string">"temperature"</span><span class="token punctuation">,</span>BigDecimal<span class="token punctuation">.</span>valueOf<span class="token punctuation">(</span>temperature<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
                row<span class="token punctuation">.</span>addTimestamp<span class="token punctuation">(</span><span class="token string">"detecttime"</span><span class="token punctuation">,</span> Timestamp<span class="token punctuation">.</span>valueOf<span class="token punctuation">(</span>detecttime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
                session<span class="token punctuation">.</span>apply<span class="token punctuation">(</span>insert<span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token punctuation">}</span>
            <span class="token comment">//5、session关闭 </span>
            session<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token comment">//判断错误数 </span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span>countPendingErrors<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> 
                RowErrorsAndOverflowStatus result <span class="token operator">=</span> session<span class="token punctuation">.</span>getPendingErrors<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
                <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>isOverflowed<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> 
                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span>println<span class="token punctuation">(</span>"<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>buffer溢出<span class="token operator">!</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> 
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>"<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                RowError<span class="token punctuation">[</span><span class="token punctuation">]</span> errs <span class="token operator">=</span> result<span class="token punctuation">.</span>getRowErrors<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
                <span class="token keyword">for</span><span class="token punctuation">(</span>RowError error<span class="token operator">:</span>errs<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> 
                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span>println<span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span> 
                <span class="token punctuation">}</span> 
            <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span> 
            <span class="token comment">//6、关闭资源 </span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">!=</span>client<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> 
                client<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span>
    public static void main<span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> throws Exception <span class="token punctuation">{<!-- --></span> 
        simulator<span class="token punctuation">(</span><span class="token string">"2019-01-02 00:00:00"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Test</span> 
    public void testSelect<span class="token punctuation">(</span><span class="token punctuation">)</span> throws KuduException <span class="token punctuation">{<!-- --></span> 
        <span class="token comment">//1、获取KuduClient </span>
        KuduClient client <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> 
        <span class="token comment">//2、打开表 </span>
        KuduTable table <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> 
        <span class="token builtin">String</span> tableName <span class="token operator">=</span> <span class="token string">"impala::default.battery_temp_data_kudu"</span><span class="token punctuation">;</span> 
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            client <span class="token operator">=</span> <span class="token keyword">new</span> KuduClient<span class="token punctuation">.</span>KuduClientBuilder<span class="token punctuation">(</span>KUDU_MASTER<span class="token punctuation">)</span><span class="token punctuation">.</span>build<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            table <span class="token operator">=</span> client<span class="token punctuation">.</span>openTable<span class="token punctuation">(</span>tableName<span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token comment">//3、指定查询条件 </span>
            Schema schema <span class="token operator">=</span> table<span class="token punctuation">.</span>getSchema<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            List<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> columnNames <span class="token operator">=</span> <span class="token keyword">new</span> ArrayList<span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            columnNames<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token string">"deviceid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            columnNames<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token string">"batteryid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            columnNames<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token string">"detecttime"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            columnNames<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token string">"platenumber"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            columnNames<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token string">"temperature"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token comment">//4、获取扫描器 </span>
            KuduScanner scanner <span class="token operator">=</span> client<span class="token punctuation">.</span>newScannerBuilder<span class="token punctuation">(</span>table<span class="token punctuation">)</span> 
            <span class="token punctuation">.</span>setProjectedColumnNames<span class="token punctuation">(</span>columnNames<span class="token punctuation">)</span> 
            <span class="token punctuation">.</span>build<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token comment">//5、查询并处理结果集 </span>
            int resCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> 
            <span class="token keyword">while</span> <span class="token punctuation">(</span>scanner<span class="token punctuation">.</span>hasMoreRows<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> 
                RowResultIterator results <span class="token operator">=</span> scanner<span class="token punctuation">.</span>nextRows<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
                <span class="token keyword">while</span> <span class="token punctuation">(</span>results<span class="token punctuation">.</span>hasNext<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> 
                    RowResult res <span class="token operator">=</span> results<span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
                    int deviceid <span class="token operator">=</span> res<span class="token punctuation">.</span>getInt<span class="token punctuation">(</span><span class="token string">"deviceid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
                    <span class="token builtin">String</span> batteryid <span class="token operator">=</span> res<span class="token punctuation">.</span>getByte<span class="token punctuation">(</span><span class="token string">"batteryid"</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">;</span> 
                    <span class="token builtin">String</span> detecttime <span class="token operator">=</span> 
                    res<span class="token punctuation">.</span>getTimestamp<span class="token punctuation">(</span><span class="token string">"detecttime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toString<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
                    <span class="token builtin">String</span> platenumber <span class="token operator">=</span> res<span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token string">"platenumber"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
                    <span class="token builtin">String</span> temperature<span class="token operator">=</span>res<span class="token punctuation">.</span>getDecimal<span class="token punctuation">(</span><span class="token string">"temperature"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toString<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span>printf<span class="token punctuation">(</span>"deviceid<span class="token operator">=</span><span class="token operator">%</span>d<span class="token punctuation">,</span>batteryid<span class="token operator">=</span><span class="token operator">%</span>s<span class="token punctuation">,</span>detecttime<span class="token operator">=</span><span class="token operator">%</span>s<span class="token punctuation">,</span>platenumber<span class="token operator">=</span><span class="token operator">%</span>s<span class="token punctuation">,</span>temper 
ature<span class="token operator">=</span><span class="token operator">%</span>srn"<span class="token punctuation">,</span>deviceid<span class="token punctuation">,</span>batteryid<span class="token punctuation">,</span>detecttime<span class="token punctuation">,</span>platenumber<span class="token punctuation">,</span>temperature<span class="token punctuation">)</span><span class="token punctuation">;</span> 
                    resCount<span class="token operator">++</span><span class="token punctuation">;</span> 
                <span class="token punctuation">}</span> 
            <span class="token punctuation">}</span> 
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span>println<span class="token punctuation">(</span><span class="token string">"resCount="</span><span class="token operator">+</span>resCount<span class="token punctuation">)</span><span class="token punctuation">;</span> 
            scanner<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span> 
            <span class="token comment">//7、回收资源 </span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">!=</span>client<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> 
                client<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_1170"></a>构建数据流水线</h4> 
<p>按照如下步骤来执行：</p> 
<ol><li>建表s</li><li>开启模拟程序</li><li>模拟数据迁移</li></ol> 
<h4><a id="_1180"></a>数据验证</h4> 
<p>我们通过以下几条语句，来证明Impala统一视图的有效性（分层架构的有效性）：</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">from</span> battery_temp_data_kudu <span class="token keyword">where</span> detecttime <span class="token operator">&gt;=</span> <span class="token string">"2019-01-01"</span> <span class="token operator">and</span> 
detecttime<span class="token operator">&lt;</span> <span class="token string">"2019-02-01"</span><span class="token punctuation">;</span> 
<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">from</span> battery_temp_data_kudu <span class="token keyword">where</span> detecttime <span class="token operator">&gt;=</span> <span class="token string">"2019-02-01"</span> <span class="token operator">and</span> 
detecttime<span class="token operator">&lt;</span> <span class="token string">"2019-03-01"</span><span class="token punctuation">;</span> 
<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">from</span> battery_temp_data_kudu <span class="token keyword">where</span> detecttime <span class="token operator">&gt;=</span> <span class="token string">"2019-03-01"</span> <span class="token operator">and</span> 
detecttime<span class="token operator">&lt;</span> <span class="token string">"2019-04-01"</span><span class="token punctuation">;</span> 
<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">from</span> battery_temp_data_kudu <span class="token keyword">where</span> detecttime <span class="token operator">&gt;=</span> <span class="token string">"2019-04-01"</span> <span class="token operator">and</span> 
detecttime<span class="token operator">&lt;</span> <span class="token string">"2019-05-01"</span><span class="token punctuation">;</span> 
<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">from</span> battery_temp_data_parquet <span class="token keyword">where</span> detecttime <span class="token operator">&gt;=</span> <span class="token string">"2019-01-01"</span> 
<span class="token operator">and</span> detecttime<span class="token operator">&lt;</span> <span class="token string">"2019-02-01"</span><span class="token punctuation">;</span> 
<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">from</span> battery_temp_data_parquet <span class="token keyword">where</span> detecttime <span class="token operator">&gt;=</span> <span class="token string">"2019-02-01"</span> 
<span class="token operator">and</span> detecttime<span class="token operator">&lt;</span> <span class="token string">"2019-03-01"</span><span class="token punctuation">;</span> 
<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">from</span> battery_temp_data_parquet <span class="token keyword">where</span> detecttime <span class="token operator">&gt;=</span> <span class="token string">"2019-03-01"</span> 
<span class="token operator">and</span> detecttime<span class="token operator">&lt;</span> <span class="token string">"2019-04-01"</span><span class="token punctuation">;</span> 
<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">from</span> battery_temp_data_parquet <span class="token keyword">where</span> detecttime <span class="token operator">&gt;=</span> <span class="token string">"2019-04-01"</span> 
<span class="token operator">and</span> detecttime<span class="token operator">&lt;</span> <span class="token string">"2019-05-01"</span><span class="token punctuation">;</span> 
<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">from</span> battery_temp_data_view <span class="token keyword">where</span> detecttime <span class="token operator">&gt;=</span> <span class="token string">"2019-01-01"</span> <span class="token operator">and</span> 
detecttime<span class="token operator">&lt;</span> <span class="token string">"2019-02-01"</span><span class="token punctuation">;</span> 
<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">from</span> battery_temp_data_view <span class="token keyword">where</span> detecttime <span class="token operator">&gt;=</span> <span class="token string">"2019-02-01"</span> <span class="token operator">and</span> 
detecttime<span class="token operator">&lt;</span> <span class="token string">"2019-03-01"</span><span class="token punctuation">;</span> 
<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">from</span> battery_temp_data_view <span class="token keyword">where</span> detecttime <span class="token operator">&gt;=</span> <span class="token string">"2019-03-01"</span> <span class="token operator">and</span> 
detecttime<span class="token operator">&lt;</span> <span class="token string">"2019-04-01"</span><span class="token punctuation">;</span> 
<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">from</span> battery_temp_data_view <span class="token keyword">where</span> detecttime <span class="token operator">&gt;=</span> <span class="token string">"2019-04-01"</span> <span class="token operator">and</span> 
detecttime<span class="token operator">&lt;</span> <span class="token string">"2019-05-01"</span><span class="token punctuation">;</span> 
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d3f0ad1f3f86d76756562227d14eff47/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Kudu-客户端API编程、生态整合(Spark、Flink、Impala)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/dbeba7b3c751836174074c856a116292/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Linux — 安装JDK 使用rpm命令安装</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>