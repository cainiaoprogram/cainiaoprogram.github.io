<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MMCV-Registry类代码详解(1) - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="MMCV-Registry类代码详解(1)" />
<meta property="og:description" content="目录
1.功能简介
2.初始化函数
参数说明：
构造函数优先级：
2.1self.infer_scope()方法
2.2_add_children()方法
源码在工程中的路径为mmcv/utils/registry.py，可对照源码阅读本文。
1.功能简介 简单地说，Registry类实现了字符串到类的一种映射。目的是仅使用字符串（例如某个模型的名字）来方便快捷地创建一个类实例。源码注释中给了这么一个例子：
&#34;&#34;&#34; Example: &gt;&gt;&gt; MODELS = Registry(&#39;models&#39;) &gt;&gt;&gt; @MODELS.register_module() &gt;&gt;&gt; class ResNet: &gt;&gt;&gt; pass &gt;&gt;&gt; resnet = MODELS.build(dict(type=&#39;ResNet&#39;)) &#34;&#34;&#34; 符号@表示装饰器，涉及Python的一些语法，可自行学习。在@MODELS.register_module()后定义模型，可理解为模型已经被MODELS.register_module()方法修饰，修饰过的模型可通过 MODELS.build()方法使用模型名称直接创建实例，具体使用实例可参考MMdetection自定义backbone。
2.初始化函数 &#34;&#34;&#34; Args: name (str): Registry name. build_func(func, optional): Build function to construct instance from Registry, func:`build_from_cfg` is used if neither ``parent`` or ``build_func`` is specified. If ``parent`` is specified and ``build_func`` is not given, ``build_func`` will be inherited from ``parent``." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/7a1dc23d37ee236fa4b8413e6261dcfc/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-30T15:38:38+08:00" />
<meta property="article:modified_time" content="2022-03-30T15:38:38+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">MMCV-Registry类代码详解(1)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="1.%E5%8A%9F%E8%83%BD%E7%AE%80%E4%BB%8B-toc" style="margin-left:0px;"><a href="#1.%E5%8A%9F%E8%83%BD%E7%AE%80%E4%BB%8B" rel="nofollow">1.功能简介</a></p> 
<p id="2.%E5%88%9D%E5%A7%8B%E5%8C%96%E5%87%BD%E6%95%B0-toc" style="margin-left:0px;"><a href="#2.%E5%88%9D%E5%A7%8B%E5%8C%96%E5%87%BD%E6%95%B0" rel="nofollow">2.初始化函数</a></p> 
<p id="%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E%EF%BC%9A-toc" style="margin-left:40px;"><a href="#%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E%EF%BC%9A" rel="nofollow">参数说明：</a></p> 
<p id="%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E4%BC%98%E5%85%88%E7%BA%A7%EF%BC%9A-toc" style="margin-left:40px;"><a href="#%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E4%BC%98%E5%85%88%E7%BA%A7%EF%BC%9A" rel="nofollow">构造函数优先级：</a></p> 
<p id="2.1self.infer_scope()%E6%96%B9%E6%B3%95-toc" style="margin-left:40px;"><a href="#2.1self.infer_scope%28%29%E6%96%B9%E6%B3%95" rel="nofollow">2.1self.infer_scope()方法</a></p> 
<p id="2.2_add_children()%E6%96%B9%E6%B3%95-toc" style="margin-left:40px;"><a href="#2.2_add_children%28%29%E6%96%B9%E6%B3%95" rel="nofollow">2.2_add_children()方法</a></p> 
<hr id="hr-toc"> 
<p></p> 
<p>源码在工程中的路径为mmcv/utils/registry.py，可对照源码阅读本文。</p> 
<h2 id="1.%E5%8A%9F%E8%83%BD%E7%AE%80%E4%BB%8B">1.功能简介</h2> 
<p>简单地说，Registry类实现了字符串到类的一种映射。目的是仅使用字符串（例如某个模型的名字）来方便快捷地创建一个类实例。源码注释中给了这么一个例子：</p> 
<pre><code class="language-python">"""
Example:
        &gt;&gt;&gt; MODELS = Registry('models')
        &gt;&gt;&gt; @MODELS.register_module()
        &gt;&gt;&gt; class ResNet:
        &gt;&gt;&gt;     pass
        &gt;&gt;&gt; resnet = MODELS.build(dict(type='ResNet'))
"""</code></pre> 
<p>符号@表示装饰器，涉及Python的一些语法，可自行学习。在@MODELS.register_module()后定义模型，可理解为模型已经被MODELS.register_module()方法修饰，修饰过的模型可通过 MODELS.build()方法使用模型名称直接创建实例，具体使用实例可参考<a class="link-info" href="https://mmdetection.readthedocs.io/en/latest/tutorials/customize_models.html" rel="nofollow" title="MMdetection自定义backbone">MMdetection自定义backbone</a>。</p> 
<h2 id="2.%E5%88%9D%E5%A7%8B%E5%8C%96%E5%87%BD%E6%95%B0">2.初始化函数</h2> 
<pre><code class="language-python">"""
Args:
    name (str): Registry name.
    build_func(func, optional): Build function to construct instance from
        Registry, func:`build_from_cfg` is used if neither ``parent`` or
        ``build_func`` is specified. If ``parent`` is specified and
        ``build_func`` is not given,  ``build_func`` will be inherited
        from ``parent``. Default: None.
    parent (Registry, optional): Parent registry. The class registered in
        children registry could be built from parent. Default: None.
    scope (str, optional): The scope of registry. It is the key to search
        for children registry. If not specified, scope will be the name of
        the package where class is defined, e.g. mmdet, mmcls, mmseg.
        Default: None.

"""
def __init__(self, name, build_func=None, parent=None, scope=None):
    self._name = name
    self._module_dict = dict()
    self._children = dict()
    self._scope = self.infer_scope() if scope is None else scope

    # self.build_func will be set with the following priority:
    # 1. build_func
    # 2. parent.build_func
    # 3. build_from_cfg
    if build_func is None:
        if parent is not None:
            self.build_func = parent.build_func
        else:
            self.build_func = build_from_cfg
    else:
        self.build_func = build_func
    if parent is not None:
        assert isinstance(parent, Registry)
        parent._add_children(self)
        self.parent = parent
    else:
        self.parent = None</code></pre> 
<h3 id="%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E%EF%BC%9A">参数说明：</h3> 
<p>name（字符串类型）：Registry类名称，例如源码示例中的'model'；</p> 
<p>build_func（函数类型，可选）：构造Registry类实例的构造函数；</p> 
<p>parent（Registry类型，可选，默认值为None）：在子类中注册过的类，可以利用子类的父类的构造函数构建实例；</p> 
<p>scope（字符串类型，可选，默认值为None）：Registry类的作用域。如果未指定，作用域会是该类定义的库的名称，例如mmdet，mmcls，mmseg等。</p> 
<h3 id="%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E4%BC%98%E5%85%88%E7%BA%A7%EF%BC%9A">构造函数优先级：</h3> 
<p>构造函数会按照如下优先级进行设置：</p> 
<p>1. 参数中传入的build_func；</p> 
<p>2. 父类的build_func；</p> 
<p>3. 从配置文件中获取设置信息。</p> 
<p>在初始化函数中出现了<span style="background-color:#d7d8d9;">self.infer_scope()</span>和<span style="background-color:#d7d8d9;">_add_children()</span>方法，接下来依次进行说明。</p> 
<h3 id="2.1self.infer_scope()%E6%96%B9%E6%B3%95">2.1self.infer_scope()方法</h3> 
<p>功能：推测registry的作用域，返回registry被定义的的库的名称。</p> 
<p>源码中提供了一个示例：</p> 
<pre><code class="language-python">"""
Example:
    # in mmdet/models/backbone/resnet.py
    &gt;&gt;&gt; MODELS = Registry('models')
    &gt;&gt;&gt; @MODELS.register_module()
    &gt;&gt;&gt; class ResNet:
    &gt;&gt;&gt;     pass
    The scope of ``ResNet`` will be ``mmdet``.
"""</code></pre> 
<p>源码比较简单，而且涉及其他方法，不再展开，只需要知道功能就可以。</p> 
<h3 id="2.2_add_children()%E6%96%B9%E6%B3%95">2.2_add_children()方法</h3> 
<p>参数：作为子类的Registry的实例对象。</p> 
<p>功能：将参数中传入的Registry实例对象，根据其作用域被当做子类添加，父类registry可以从子类registry创建对象。</p> 
<p>源码解析：</p> 
<pre><code class="language-python">def _add_children(self, registry):
    # 判断传入的registry是不是Registry类，不是则报错
    assert isinstance(registry, Registry)
    # 判断传入的registry作用域是否为None，为None则报错
    assert registry.scope is not None
    # 若传入registry的作用域已经在self._children字典中，存在则报错
    assert registry.scope not in self.children, \
        f'scope {registry.scope} exists in {self.name} registry'
    # 将registry作用域作为键，registry作为值存入self._children字典中
    self.children[registry.scope] = registry</code></pre> 
<p> 注意：self.children方法就是返回self._children字典，类似用法的方法还有name，scope，module_dict。</p> 
<p> 源码提供的示例：</p> 
<pre><code class="language-python">"""
Example:
    &gt;&gt;&gt; models = Registry('models')
    &gt;&gt;&gt; mmdet_models = Registry('models', parent=models)
    &gt;&gt;&gt; @mmdet_models.register_module()
    &gt;&gt;&gt; class ResNet:
    &gt;&gt;&gt;     pass
    &gt;&gt;&gt; resnet = models.build(dict(type='mmdet.ResNet'))
"""</code></pre> 
<p>首先，创建了一个Registry类的实例models；</p> 
<p>然后又创建了一个Registry类的实例mmdet_models，并将models实例（类型为Registry类）传递给形参parent，此时，在初始化函数中，如下代码会调用父类（即models）的_add_children()方法，将mmdet_models添加到models._children中：</p> 
<pre><code class="language-python">if parent is not None:
    assert isinstance(parent, Registry)
    parent._add_children(self)
    self.parent = parent
else:
    self.parent = None</code></pre> 
<p>注意，此时的传入_add_children()方法中的self参数是指实例对象mmdet_models；</p> 
<p>通过子类mmdet_models修饰，定义网络模型；</p> 
<p>通过父类models从子类mmdet_models创建模型实例。</p> 
<p></p> 
<p>本期内容先写到这里，后期再继续更新剩余内容……</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9c655271449f6cf061c30ca039f83fd5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">tensorflow2.4复现parnet网络模型实现猫狗分类</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/dd7f1184423a8b9c80c706134415708c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">小猫爪：S32K3学习笔记12-S32K3之STCU2</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>