<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【MM32F5270开发板试用】播放TF卡WAV格式音乐，I2S驱动CS4344 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【MM32F5270开发板试用】播放TF卡WAV格式音乐，I2S驱动CS4344" />
<meta property="og:description" content="【MM32F5270开发板试用】播放TF卡WAV格式音乐，I2S驱动CS4344 上四篇文章：
【MM32F5270开发板试用】一、依靠SPI_SD，移植FatFs文件系统
【MM32F5270开发板试用】SysTick&#43;Scheduler轮询
【MM32F5270开发板试用】如何将数据存放在DTCM
【MM32F5270开发板试用】依靠SPI_SD，移植FatFs文件系统（优化版本）
本次所有代码按照以前习惯全部开源：我的Github地址是：https://github.com/kings669/MM32F5
代码比较多，一篇文章也放不下，大家可以直接Clone下代码看就行。
一、I2S总线 I2S(Inter—IC Sound)总线, 又称
集成电路内置音频总线，是飞利浦公司为数字音频设备之间的音频数据传输而制定的一种总线标准，该总线专门用于音频设备之间的数据传输，广泛应用于各种多媒体系统。它采用了沿独立的导线传输时钟与数据信号的设计，通过将数据和时钟信号分离，避免了因时差诱发的失真，为用户节省了购买抵抗音频抖动的专业设备的费用。
在MM32F5270中，SPI与I2S共用引脚。在I2S的描述中，支持半双工通信，也支持全双工模式（通过配置 SPI_I2S_I2SCFGR.HDSEL 位来决定）。
在看一下引脚定义：
我们发送给CS4344的格式是飞利浦标准
我们需要配置为主模式，具体流程可以参考手册。
驱动代码部分
void I2S_Configure(I2S_Protocol_Type Standard, I2S_DataWidth_Type DataFormat, uint32_t AudioFreq, I2S_XferMode_Type Mode) { /* Setup the I2S. */ I2S_Master_Init_Type i2s_master_init; i2s_master_init.ClockFreqHz = CLOCK_APB1_FREQ; i2s_master_init.SampleRate = AudioFreq; i2s_master_init.DataWidth = DataFormat; i2s_master_init.Protocol = Standard; i2s_master_init.EnableMCLK = true; i2s_master_init.Polarity = I2S_Polarity_1; i2s_master_init.XferMode = Mode; I2S_InitMaster(SPI2, &amp;i2s_master_init); I2S_EnableDMA(SPI2, true); I2S_Enable(SPI2, true); } void I2S_DMA_Transfer(uint16_t *Buffer, uint32_t BufferSize) { /* Setup the DMA for I2S RX." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/be47612d47d08e8708b4f3691733c9e9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-10-05T13:59:31+08:00" />
<meta property="article:modified_time" content="2022-10-05T13:59:31+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【MM32F5270开发板试用】播放TF卡WAV格式音乐，I2S驱动CS4344</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="MM32F5270TFWAVI2SCS4344_0"></a>【MM32F5270开发板试用】播放TF卡WAV格式音乐，I2S驱动CS4344</h2> 
<p>上四篇文章：<br> 【MM32F5270开发板试用】一、依靠SPI_SD，移植FatFs文件系统<br> 【MM32F5270开发板试用】SysTick+Scheduler轮询<br> 【MM32F5270开发板试用】如何将数据存放在DTCM<br> 【MM32F5270开发板试用】依靠SPI_SD，移植FatFs文件系统（优化版本）<br> 本次所有代码按照以前习惯全部开源：我的Github地址是：https://github.com/kings669/MM32F5</p> 
<p>代码比较多，一篇文章也放不下，大家可以直接Clone下代码看就行。</p> 
<h3><a id="I2S_9"></a>一、I2S总线</h3> 
<blockquote> 
 <p>I2S(Inter—IC Sound)总线, 又称<br> 集成电路内置音频总线，是飞利浦公司为数字音频设备之间的音频数据传输而制定的一种总线标准，该总线专门用于音频设备之间的数据传输，广泛应用于各种多媒体系统。它采用了沿独立的导线传输时钟与数据信号的设计，通过将数据和时钟信号分离，避免了因时差诱发的失真，为用户节省了购买抵抗音频抖动的专业设备的费用。</p> 
</blockquote> 
<p>在MM32F5270中，SPI与I2S共用引脚。在I2S的描述中，支持半双工通信，也支持全双工模式（通过配置 SPI_I2S_I2SCFGR.HDSEL 位来决定）。<br> <img src="https://images2.imgbox.com/09/1b/4ltzHjDv_o.png" alt="image.png"></p> 
<p>在看一下引脚定义：<br> <img src="https://images2.imgbox.com/3b/ee/3aLpcxqL_o.png" alt="image.png"></p> 
<p>我们发送给CS4344的格式是飞利浦标准<br> <img src="https://images2.imgbox.com/05/03/jPLMYjj5_o.png" alt="image.png"></p> 
<p>我们需要配置为主模式，具体流程可以参考手册。<br> <img src="https://images2.imgbox.com/d1/95/P2cJSGIX_o.png" alt="image.png"></p> 
<p><strong>驱动代码部分</strong></p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">I2S_Configure</span><span class="token punctuation">(</span>I2S_Protocol_Type   Standard<span class="token punctuation">,</span>
                         I2S_DataWidth_Type DataFormat<span class="token punctuation">,</span>
                         <span class="token class-name">uint32_t</span> AudioFreq<span class="token punctuation">,</span>
                         I2S_XferMode_Type Mode<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* Setup the I2S. */</span>
    I2S_Master_Init_Type i2s_master_init<span class="token punctuation">;</span>
        
    i2s_master_init<span class="token punctuation">.</span>ClockFreqHz  <span class="token operator">=</span> CLOCK_APB1_FREQ<span class="token punctuation">;</span>
    i2s_master_init<span class="token punctuation">.</span>SampleRate   <span class="token operator">=</span> AudioFreq<span class="token punctuation">;</span>
    i2s_master_init<span class="token punctuation">.</span>DataWidth    <span class="token operator">=</span> DataFormat<span class="token punctuation">;</span>
    i2s_master_init<span class="token punctuation">.</span>Protocol     <span class="token operator">=</span> Standard<span class="token punctuation">;</span>
    i2s_master_init<span class="token punctuation">.</span>EnableMCLK   <span class="token operator">=</span> true<span class="token punctuation">;</span>
    i2s_master_init<span class="token punctuation">.</span>Polarity     <span class="token operator">=</span> I2S_Polarity_1<span class="token punctuation">;</span>
    i2s_master_init<span class="token punctuation">.</span>XferMode     <span class="token operator">=</span> Mode<span class="token punctuation">;</span>
    
        <span class="token function">I2S_InitMaster</span><span class="token punctuation">(</span>SPI2<span class="token punctuation">,</span> <span class="token operator">&amp;</span>i2s_master_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">I2S_EnableDMA</span><span class="token punctuation">(</span>SPI2<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">I2S_Enable</span><span class="token punctuation">(</span>SPI2<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2S_DMA_Transfer</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> <span class="token operator">*</span>Buffer<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> BufferSize<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
      <span class="token comment">/* Setup the DMA for I2S RX. */</span>
    DMA_Channel_Init_Type dma_channel_init<span class="token punctuation">;</span>

    dma_channel_init<span class="token punctuation">.</span>MemAddr           <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dma_channel_init<span class="token punctuation">.</span>MemAddrIncMode    <span class="token operator">=</span> DMA_AddrIncMode_IncAfterXfer<span class="token punctuation">;</span>
    dma_channel_init<span class="token punctuation">.</span>PeriphAddr        <span class="token operator">=</span> <span class="token function">I2S_GetTxDataRegAddr</span><span class="token punctuation">(</span>SPI2<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* use tx data register here. */</span>
    dma_channel_init<span class="token punctuation">.</span>PeriphAddrIncMode <span class="token operator">=</span> DMA_AddrIncMode_StayAfterXfer<span class="token punctuation">;</span>
    dma_channel_init<span class="token punctuation">.</span>Priority          <span class="token operator">=</span> DMA_Priority_Highest<span class="token punctuation">;</span>
    dma_channel_init<span class="token punctuation">.</span>XferCount         <span class="token operator">=</span> BufferSize<span class="token punctuation">;</span>
    dma_channel_init<span class="token punctuation">.</span>XferMode          <span class="token operator">=</span> DMA_XferMode_MemoryToPeriph<span class="token punctuation">;</span>
    dma_channel_init<span class="token punctuation">.</span>ReloadMode        <span class="token operator">=</span> DMA_ReloadMode_AutoReload<span class="token punctuation">;</span>             <span class="token comment">/* DMA_AutoReloadMode_Circular */</span>
    dma_channel_init<span class="token punctuation">.</span>XferWidth         <span class="token operator">=</span> DMA_XferWidth_16b<span class="token punctuation">;</span>
    <span class="token function">DMA_InitChannel</span><span class="token punctuation">(</span>DMA1<span class="token punctuation">,</span> DMA_REQ_DMA1_SPI2_TX<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dma_channel_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* Enable DMA transfer done interrupt. */</span>
    <span class="token function">DMA_EnableChannelInterrupts</span><span class="token punctuation">(</span>DMA1<span class="token punctuation">,</span> DMA_REQ_DMA1_SPI2_TX<span class="token punctuation">,</span> DMA_CHN_INT_XFER_DONE<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">DMA_EnableChannelInterrupts</span><span class="token punctuation">(</span>DMA1<span class="token punctuation">,</span> DMA_REQ_DMA1_SPI2_TX<span class="token punctuation">,</span> DMA_CHN_INT_XFER_HALF_DONE<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">NVIC_EnableIRQ</span><span class="token punctuation">(</span>DMA1_CH5_IRQn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token function">DMA_EnableChannel</span><span class="token punctuation">(</span>DMA1<span class="token punctuation">,</span> DMA_REQ_DMA1_SPI2_TX<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="WAV_74"></a>二、WAV文件</h3> 
<blockquote> 
 <p>WAV是最常见的声音文件格式之一，是微软公司专门为Windows开发的一种标准数字音频文件，该文件能记录各种单声道或立体声的声音信息，并能保证声音不失真。但WAV文件有一个致命的缺点，就是它所占用的磁盘空间太大（每分钟的音乐大约需要12兆磁盘空间）。它符合资源互换文件格式（RIFF）规范，用于保存Windows平台的音频信息资源，被Windows平台及其应用程序所广泛支持。Wave格式支持MSADPCM、CCITTA律、CCITT μ律和其他压缩算法，支持多种音频位数、采样频率和声道，是PC机上最为流行的声音文件格式；但其文件尺寸较大，多用于存储简短的声音片段。</p> 
</blockquote> 
<p>网上也有许多关于WAV的讲解，这里就不展开讲解。刚好我在查找资料的时候发现了有类似工程的，我这里直接使用了他的播放部分，由于我没有购置屏幕，所以选择使用串口来打印信息。</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"wav.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"i2s_port.h"</span></span>

FIL     WAV_File<span class="token punctuation">;</span>
UINT    WAV_BR<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
FRESULT WAV_RES<span class="token punctuation">;</span>

DTCM_RAM <span class="token class-name">uint8_t</span> WAV_DataBuffer<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span>WAV_BUFFER_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> WAV_NextIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> WAV_PlayEnded <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token class-name">uint32_t</span> WAV_PlaybackTotal     <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token class-name">uint32_t</span> WAV_PlaybackProgress  <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token class-name">uint8_t</span> <span class="token function">WAV_DecodeFile</span><span class="token punctuation">(</span>WAV_TypeDef <span class="token operator">*</span>pWav<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>Path<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>Name<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">static</span> ChunkRIFF_TypeDef <span class="token operator">*</span>WAV_RIFF<span class="token punctuation">;</span>
    <span class="token keyword">static</span> ChunkFMT_TypeDef  <span class="token operator">*</span>WAV_FMT <span class="token punctuation">;</span>
    <span class="token keyword">static</span> ChunkFACT_TypeDef <span class="token operator">*</span>WAV_FACT<span class="token punctuation">;</span>
    <span class="token keyword">static</span> ChunkDATA_TypeDef <span class="token operator">*</span>WAV_DATA<span class="token punctuation">;</span>

        <span class="token keyword">static</span> <span class="token class-name">uint8_t</span> WAV_HeadBuffer<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token class-name">uint8_t</span> Result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">char</span> FilePath<span class="token punctuation">[</span> <span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token function">memset</span><span class="token punctuation">(</span> FilePath<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>FilePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sprintf</span><span class="token punctuation">(</span>FilePath<span class="token punctuation">,</span> <span class="token string">"%s%s"</span><span class="token punctuation">,</span>   Path<span class="token punctuation">,</span>   Name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\r\n"</span><span class="token punctuation">,</span>FilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    WAV_RES <span class="token operator">=</span> <span class="token function">f_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>WAV_File<span class="token punctuation">,</span> FilePath<span class="token punctuation">,</span> FA_READ<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>WAV_RES <span class="token operator">==</span> FR_OK<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* ¶ÁÈ¡512×Ö½ÚÔÚÊý¾Ý */</span>
        WAV_RES <span class="token operator">=</span> <span class="token function">f_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>WAV_File<span class="token punctuation">,</span> WAV_HeadBuffer<span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>WAV_BR<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>WAV_RES <span class="token operator">==</span> FR_OK<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>WAV_BR<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">/* »ñÈ¡RIFF¿é */</span>
            WAV_RIFF <span class="token operator">=</span> <span class="token punctuation">(</span>ChunkRIFF_TypeDef <span class="token operator">*</span><span class="token punctuation">)</span>WAV_HeadBuffer<span class="token punctuation">;</span>

            <span class="token comment">/* ÊÇWAV¸ñÊ½ÎÄ¼þ */</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>WAV_RIFF<span class="token operator">-&gt;</span>Format <span class="token operator">==</span> <span class="token number">0x45564157</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">/* »ñÈ¡FMT¿é */</span>
                WAV_FMT  <span class="token operator">=</span> <span class="token punctuation">(</span>ChunkFMT_TypeDef <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>WAV_HeadBuffer<span class="token operator">+</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">/* ¶ÁÈ¡FACT¿é */</span>
                WAV_FACT <span class="token operator">=</span> <span class="token punctuation">(</span>ChunkFACT_TypeDef <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>WAV_HeadBuffer<span class="token operator">+</span><span class="token number">12</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">+</span>WAV_FMT<span class="token operator">-&gt;</span>ChunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>WAV_FACT<span class="token operator">-&gt;</span>ChunkID <span class="token operator">==</span> <span class="token number">0x74636166</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>WAV_FACT<span class="token operator">-&gt;</span>ChunkID <span class="token operator">==</span> <span class="token number">0x5453494C</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">/* ¾ßÓÐFACT/LIST¿éµÄÊ±ºò(Î´²âÊÔ) */</span>
                    pWav<span class="token operator">-&gt;</span>DataStart<span class="token operator">=</span><span class="token number">12</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">+</span>WAV_FMT<span class="token operator">-&gt;</span>ChunkSize<span class="token operator">+</span><span class="token number">8</span><span class="token operator">+</span>WAV_FACT<span class="token operator">-&gt;</span>ChunkSize<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span>
                <span class="token punctuation">{<!-- --></span>
                    pWav<span class="token operator">-&gt;</span>DataStart<span class="token operator">=</span><span class="token number">12</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">+</span>WAV_FMT<span class="token operator">-&gt;</span>ChunkSize<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">/* ¶ÁÈ¡DATA¿é */</span>
                WAV_DATA <span class="token operator">=</span> <span class="token punctuation">(</span>ChunkDATA_TypeDef <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>WAV_HeadBuffer<span class="token operator">+</span>pWav<span class="token operator">-&gt;</span>DataStart<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">/* ½âÎö³É¹¦ */</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>WAV_DATA<span class="token operator">-&gt;</span>ChunkID <span class="token operator">==</span> <span class="token number">0x61746164</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    pWav<span class="token operator">-&gt;</span>AudioFormat   <span class="token operator">=</span> WAV_FMT<span class="token operator">-&gt;</span>AudioFormat<span class="token punctuation">;</span>     <span class="token comment">/* ÒôÆµ¸ñÊ½ */</span>
                    pWav<span class="token operator">-&gt;</span>nChannels     <span class="token operator">=</span> WAV_FMT<span class="token operator">-&gt;</span>NumOfChannels<span class="token punctuation">;</span>   <span class="token comment">/* Í¨µÀÊý */</span>
                    pWav<span class="token operator">-&gt;</span>SampleRate    <span class="token operator">=</span> WAV_FMT<span class="token operator">-&gt;</span>SampleRate<span class="token punctuation">;</span>      <span class="token comment">/* ²ÉÑùÂÊ */</span>
                    pWav<span class="token operator">-&gt;</span>BitRate       <span class="token operator">=</span> WAV_FMT<span class="token operator">-&gt;</span>ByteRate<span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">;</span>      <span class="token comment">/* µÃµ½Î»ËÙ */</span>
                    pWav<span class="token operator">-&gt;</span>BlockAlign    <span class="token operator">=</span> WAV_FMT<span class="token operator">-&gt;</span>BlockAlign<span class="token punctuation">;</span>      <span class="token comment">/* ¿é¶ÔÆë */</span>
                    pWav<span class="token operator">-&gt;</span>BitsPerSample <span class="token operator">=</span> WAV_FMT<span class="token operator">-&gt;</span>BitsPerSample<span class="token punctuation">;</span>   <span class="token comment">/* Î»Êý,16/24/32Î» */</span>

                    pWav<span class="token operator">-&gt;</span>DataSize      <span class="token operator">=</span> WAV_DATA<span class="token operator">-&gt;</span>ChunkSize<span class="token punctuation">;</span>      <span class="token comment">/* Êý¾Ý¿é´óÐ¡ */</span>
                    pWav<span class="token operator">-&gt;</span>DataStart     <span class="token operator">=</span> pWav<span class="token operator">-&gt;</span>DataStart<span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">;</span>        <span class="token comment">/* Êý¾ÝÁ÷¿ªÊ¼µÄµØ·½ */</span>

                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\npWav-&gt;AudioFormat   : %d"</span><span class="token punctuation">,</span> pWav<span class="token operator">-&gt;</span>AudioFormat<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\npWav-&gt;nChannels     : %d"</span><span class="token punctuation">,</span> pWav<span class="token operator">-&gt;</span>nChannels<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\npWav-&gt;SampleRate    : %d"</span><span class="token punctuation">,</span> pWav<span class="token operator">-&gt;</span>SampleRate<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\npWav-&gt;BitRate       : %d"</span><span class="token punctuation">,</span> pWav<span class="token operator">-&gt;</span>BitRate<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\npWav-&gt;BlockAlign    : %d"</span><span class="token punctuation">,</span> pWav<span class="token operator">-&gt;</span>BlockAlign<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\npWav-&gt;BitsPerSample : %d"</span><span class="token punctuation">,</span> pWav<span class="token operator">-&gt;</span>BitsPerSample<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\npWav-&gt;DataSize      : %d"</span><span class="token punctuation">,</span> pWav<span class="token operator">-&gt;</span>DataSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\npWav-&gt;DataStart     : %d"</span><span class="token punctuation">,</span> pWav<span class="token operator">-&gt;</span>DataStart<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    WAV_PlaybackTotal <span class="token operator">=</span> pWav<span class="token operator">-&gt;</span>DataSize<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span>
                <span class="token punctuation">{<!-- --></span>
                    Result <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">/* DATAÇøÓòÎ´ÕÒµ½ */</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{<!-- --></span>
                Result <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>     <span class="token comment">/* ·ÇWAV¸ñÊ½ÎÄ¼þ */</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

       <span class="token function">f_close</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>WAV_File<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        Result <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>             <span class="token comment">/* ´ò¿ªÎÄ¼þ´íÎó */</span>
    <span class="token punctuation">}</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\n\r\nWAV Decode File Result : %d\r\n\r\n"</span><span class="token punctuation">,</span> Result<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> Result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">WAV_PrepareData</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>WAV_NextIndex <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        WAV_RES <span class="token operator">=</span> <span class="token function">f_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>WAV_File<span class="token punctuation">,</span> WAV_DataBuffer<span class="token punctuation">[</span>WAV_NextIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> WAV_BUFFER_SIZE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>WAV_BR<span class="token punctuation">[</span>WAV_NextIndex<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>WAV_BR<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> WAV_PlayEnded <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        WAV_RES <span class="token operator">=</span> <span class="token function">f_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>WAV_File<span class="token punctuation">,</span> WAV_DataBuffer<span class="token punctuation">[</span>WAV_NextIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> WAV_BUFFER_SIZE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>WAV_BR<span class="token punctuation">[</span>WAV_NextIndex<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>WAV_BR<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> WAV_PlayEnded <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">WAV_PlayHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>WAV_PlayEnded <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        WAV_PlaybackProgress <span class="token operator">+=</span> WAV_BR<span class="token punctuation">[</span>WAV_NextIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token function">I2S_DMA_Transfer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>WAV_DataBuffer<span class="token punctuation">[</span>WAV_NextIndex<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>WAV_BR<span class="token punctuation">[</span>WAV_NextIndex<span class="token punctuation">]</span> <span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">DMA_EnableChannel</span><span class="token punctuation">(</span>DMA1<span class="token punctuation">,</span>DMA_REQ_DMA1_SPI2_TX<span class="token punctuation">,</span>false<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">f_close</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>WAV_File<span class="token punctuation">)</span><span class="token punctuation">;</span> 
                <span class="token function">I2S_PowerON</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\nWAV Play Finish!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token comment">//WAV_NextIndex = 1;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>WAV_NextIndex <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> WAV_NextIndex <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>                   WAV_NextIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">WAV_PlaySong</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>Path<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>Name<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    WAV_TypeDef WaveFile<span class="token punctuation">;</span>
    <span class="token keyword">char</span> FilePath<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">/* »ñÈ¡WAVÎÄ¼þµÄÐÅÏ¢ */</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">WAV_DecodeFile</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>WaveFile<span class="token punctuation">,</span> Path<span class="token punctuation">,</span> Name<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>WaveFile<span class="token punctuation">.</span>BitsPerSample <span class="token operator">==</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>WaveFile<span class="token punctuation">.</span>nChannels <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
           <span class="token punctuation">(</span>WaveFile<span class="token punctuation">.</span>SampleRate  <span class="token operator">&gt;</span> <span class="token number">44000</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>WaveFile<span class="token punctuation">.</span>SampleRate <span class="token operator">&lt;</span> <span class="token number">48100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
                    <span class="token function">I2S_PowerON</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">I2S_Configure</span><span class="token punctuation">(</span>I2S_Protocol_PHILIPS<span class="token punctuation">,</span> I2S_DataWidth_16b<span class="token punctuation">,</span>I2S_AudioFreq_44k<span class="token punctuation">,</span> I2S_XferMode_TxOnly<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\nWAV File Error!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\nNot WAV File!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">memset</span><span class="token punctuation">(</span> FilePath<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>FilePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sprintf</span><span class="token punctuation">(</span>FilePath<span class="token punctuation">,</span> <span class="token string">"%s%s"</span><span class="token punctuation">,</span>   Path<span class="token punctuation">,</span>   Name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"&gt;f_open WAV Start...\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    WAV_RES <span class="token operator">=</span> <span class="token function">f_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>WAV_File<span class="token punctuation">,</span> FilePath<span class="token punctuation">,</span> FA_READ<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>WAV_RES <span class="token operator">==</span> FR_OK<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"&gt;f_open WAV Done!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        WAV_NextIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        WAV_PlayEnded <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        WAV_PlaybackProgress <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token function">WAV_PrepareData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">WAV_PlayHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\nWAV File Open Error : %d"</span><span class="token punctuation">,</span> WAV_RES<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p></p> 
<div class="csdn-video-box"> 
 <iframe id="4U1XKL9J-1664949514189" frameborder="0" src="https://player.bilibili.com/player.html?aid=514885653" allowfullscreen="true" data-mediaembed="bilibili"></iframe> 
 <p>国产芯片MM32F5270播放音频</p> 
</div> 
<p></p> 
<h3><a id="_275"></a>总结</h3> 
<p>能够加上DMA的地方都已经使用，参考了最大吞吐率的那篇文章，数据放在了DTCM区，通过DMA传输给I2S。感觉播放效果还行。现在代码播放mp3文件还有些问题，正在排查。在测试的时候，播放wav一直没有声音，之后将SPI改为硬件后效果直接上来了。从接触新板子开始，已经感受到国产MCU进步之快，希望有一天能够干翻ST。😜<br> 参考工程：https://bbs.21ic.com/icview-3223488-1-1.html （据说作者就是官方的工作人员😀）</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e7392a15c6db799c9c4b0334cad4d477/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【MM32F5270开发板试用】依靠SPI_SD，移植FatFs文件系统（优化版本）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/966090c41ef3d53635e690630925c9de/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">（附源码）SSM学生网上请假系统JAVA计算机毕业设计项目</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>