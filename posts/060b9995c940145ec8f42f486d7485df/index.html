<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SCS【7】单细胞转录组之轨迹分析 (Monocle 3)  聚类、分类和计数细胞 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="SCS【7】单细胞转录组之轨迹分析 (Monocle 3)  聚类、分类和计数细胞" />
<meta property="og:description" content="点击关注，桓峰基因
桓峰基因公众号推出单细胞系列教程，有需要生信分析的老师可以联系我们！首选看下转录分析教程整理如下：
Topic 6. 克隆进化之 Canopy
Topic 7. 克隆进化之 Cardelino
Topic 8. 克隆进化之 RobustClone
SCS【1】今天开启单细胞之旅，述说单细胞测序的前世今生
SCS【2】单细胞转录组 之 cellranger
SCS【3】单细胞转录组数据 GEO 下载及读取
SCS【4】单细胞转录组数据可视化分析 (Seurat 4.0)
SCS【5】单细胞转录组数据可视化分析 (scater)
SCS【6】单细胞转录组之细胞类型自动注释 (SingleR)
SCS【7】单细胞转录组之轨迹分析 (Monocle 3) 聚类、分类和计数细胞
今天来说说单细胞转录组数据的细胞轨迹分析，学会这些分析结果，距离发文章就只差样本的选择了，有创新性的样本将成为文章的亮点，并不是分析内容了！
前 言 单细胞转录组测序(scRNA-seq)实验使我们能够发现新的细胞类型，并帮助我们了解它们是如何在发育过程中产生的。Monocle 3包提供了一个分析单细胞基因表达实验的工具包。
Monocle 3可以执行三种主要类型的分析:
聚类、分类和计数细胞。单细胞RNA-Seq实验允许发现新的(可能是罕见的)细胞亚型。
构建单细胞轨迹。在发育、疾病和整个生命过程中，细胞从一种状态过渡到另一种状态。Monocle 3可以发现这些转变。
差异表达分析。对新细胞类型和状态的描述，首先要与其他更容易理解的细胞进行比较。Monocle 3包括一个复杂的，但易于使用的表达系统。
Monocle 3的主要更新 Monocle 3已被重新设计，用于分析大型、复杂的单细胞数据集。Monocle 3的核心算法具有高度的可扩展性，可以处理数百万个细胞。Monocle 3增加了一些强大的新功能，使生物体或胚胎规模的实验分析成为可能:
一个更好的结构化工作流程来学习发展轨迹；
支持UMAP算法初始化轨迹推断；
支持多根轨迹；
学习有循环或收敛点轨迹的方法；
自动分割细胞的算法，利用“近似图抽象”的思想来学习不相交或平行的轨迹；
一种新的基因表达轨迹依赖的统计测试；
将查询数据映射到引用上；
将注释从引用转移到查询数据集；
保存并加载Monocle对象和转换模型；
fit_models的混合负二项分布；
一个可视化轨迹和基因表达的3D界面。
工作流程图如下：
软件安装 if (!requireNamespace(&#34;BiocManager&#34;, quietly = TRUE)) install.packages(&#34;BiocManager&#34;) BiocManager::install(version = &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/060b9995c940145ec8f42f486d7485df/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-09T12:00:46+08:00" />
<meta property="article:modified_time" content="2022-09-09T12:00:46+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SCS【7】单细胞转录组之轨迹分析 (Monocle 3)  聚类、分类和计数细胞</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div id="js_content"> 
 <p style="text-align:left;"><img src="https://images2.imgbox.com/1e/fb/qdhEYQS6_o.gif" alt="1918fed9f068bab7f3604d8c61e53e3d.gif"> </p> 
 <p style="text-align:left;">  点击关注，桓峰基因</p> 
 <p>桓峰基因公众号推出单细胞系列教程，有需要生信分析的老师可以联系我们！首选看下转录分析教程整理如下：</p> 
 <p style="text-align:left;"><a href="" rel="nofollow">Topic 6. 克隆进化之 Canopy</a></p> 
 <p style="text-align:left;"><a href="" rel="nofollow">Topic 7. 克隆进化之 Cardelino</a></p> 
 <p style="text-align:left;"><a href="" rel="nofollow">Topic 8. 克隆进化之 RobustClone</a></p> 
 <p style="text-align:left;"><a href="" rel="nofollow">SCS【1】今天开启单细胞之旅，述说单细胞测序的前世今生</a></p> 
 <p style="text-align:left;"><a href="" rel="nofollow">SCS【2】单细胞转录组 之 cellranger</a></p> 
 <p style="text-align:left;"><a href="" rel="nofollow">SCS【3】单细胞转录组数据 GEO 下载及读取</a></p> 
 <p style="text-align:left;"><a href="" rel="nofollow">SCS【4】单细胞转录组数据可视化分析 (Seurat 4.0)</a></p> 
 <p style="text-align:left;"><a href="" rel="nofollow">SCS【5】单细胞转录组数据可视化分析 (scater)</a></p> 
 <p style="text-align:left;"><a href="" rel="nofollow">SCS【6】单细胞转录组之细胞类型自动注释 (SingleR)</a></p> 
 <p style="text-align:left;">SCS【7】单细胞转录组之轨迹分析 (Monocle 3) 聚类、分类和计数细胞</p> 
 <p>今天来说说单细胞转录组数据的细胞轨迹分析，学会这些分析结果，距离发文章就只差样本的选择了，有创新性的样本将成为文章的亮点，并不是分析内容了！</p> 
 <hr> 
 <h3>前    言</h3> 
 <p>单细胞转录组测序(scRNA-seq)实验使我们能够发现新的细胞类型，并帮助我们了解它们是如何在发育过程中产生的。Monocle 3包提供了一个分析单细胞基因表达实验的工具包。</p> 
 <p>Monocle 3可以执行三种主要类型的分析:</p> 
 <ol><li><p>聚类、分类和计数细胞。单细胞RNA-Seq实验允许发现新的(可能是罕见的)细胞亚型。</p></li><li><p>构建单细胞轨迹。在发育、疾病和整个生命过程中，细胞从一种状态过渡到另一种状态。Monocle 3可以发现这些转变。</p></li><li><p>差异表达分析。对新细胞类型和状态的描述，首先要与其他更容易理解的细胞进行比较。Monocle 3包括一个复杂的，但易于使用的表达系统。</p></li></ol> 
 <h4>Monocle 3的主要更新</h4> 
 <p>Monocle 3已被重新设计，用于分析大型、复杂的单细胞数据集。Monocle 3的核心算法具有高度的可扩展性，可以处理数百万个细胞。Monocle 3增加了一些强大的新功能，使生物体或胚胎规模的实验分析成为可能:</p> 
 <ol><li><p>一个更好的结构化工作流程来学习发展轨迹；</p></li><li><p>支持UMAP算法初始化轨迹推断；</p></li><li><p>支持多根轨迹；</p></li><li><p>学习有循环或收敛点轨迹的方法；</p></li><li><p>自动分割细胞的算法，利用“近似图抽象”的思想来学习不相交或平行的轨迹；</p></li><li><p>一种新的基因表达轨迹依赖的统计测试；</p></li><li><p>将查询数据映射到引用上；</p></li><li><p>将注释从引用转移到查询数据集；</p></li><li><p>保存并加载Monocle对象和转换模型；</p></li><li><p>fit_models的混合负二项分布；</p></li><li><p>一个可视化轨迹和基因表达的3D界面。</p></li></ol> 
 <p>工作流程图如下：</p> 
 <p style="text-align:center;"><img src="https://images2.imgbox.com/fa/b7/Jk1t8Sw1_o.png" alt="d9f7a4abd80444273ec196be21bb5cc0.png"></p> 
 <h3>软件安装</h3> 
 <pre class="has"><code class="language-go">if (!requireNamespace("BiocManager", quietly = TRUE))
  install.packages("BiocManager")
  BiocManager::install(version = "3.14")
  
BiocManager::install(c('BiocGenerics', 'DelayedArray', 'DelayedMatrixStats',
                       'limma', 'lme4', 'S4Vectors', 'SingleCellExperiment',
                       'SummarizedExperiment', 'batchelor', 'Matrix.utils',
                       'HDF5Array', 'terra', 'ggrastr'))
install.packages("devtools")
devtools::install_github('cole-trapnell-lab/monocle3')</code></pre> 
 <h3>数据读取及处理</h3> 
 <p>Monocle在cell_data_set类的对象中保存单细胞表达式数据。该类派生自Bioconductor  SingleCellExperiment类，该类提供了一个通用接口，对于那些使用Bioconductor分析其他单细胞实验的人来说是很熟悉的。这个类需要三个输入文件:</p> 
 <ol><li><p>expression_matrix，表达值的数字矩阵，行是基因，列是cell</p></li><li><p>cell_metadata，一个数据框，行是cell，列是cell属性(如细胞类型，培养条件，天数等)；</p></li><li><p>gene_metadata，一个数据框，行是特征(如基因)，列是基因属性，如生物类型，gc内容等。</p></li></ol> 
 <h4>表达值矩阵必须:</h4> 
 <p>(1). 拥有与cell_metadata的行数相同的列数;</p> 
 <p>(2). 拥有与gene_metadata的行数相同的行数。</p> 
 <p>另外:</p> 
 <ol><li><p>cell_metadata：对象的行名称应该与表达式矩阵的列名匹配；</p></li><li><p>gene_metadata：对象的行名应该匹配表达式矩阵的行名；</p></li><li><p>gene_metadata：一列应该命名为“gene_short_name”，它代表每个基因的基因符号或简单名称(通常用于绘图)。</p></li></ol> 
 <p>Monocle3 官网：</p> 
 <blockquote> 
  <p>https://cole-trapnell-lab.github.io/monocle3/</p> 
 </blockquote> 
 <p>由于pbmc都是分化成熟的免疫细胞，理论上并不存在直接的分化关系，因此不适合用来做拟时轨迹分析。这里只能使用软件包自带的数据集进行学习演示。</p> 
 <p>官方给的教程是直击读取，但是由于我们国内读取速度非常慢，我把三个rds都下载了，有需要测试的老师们，可以加我微信，私信给您！</p> 
 <pre class="has"><code class="language-go">library(monocle3)
# Load the data expression_matrix &lt;-
# readRDS(url('https://depts.washington.edu:/trapnell-lab/software/monocle3/celegans/data/cao_l2_expression.rds'))
# cell_metadata &lt;-
# readRDS(url('https://depts.washington.edu:/trapnell-lab/software/monocle3/celegans/data/cao_l2_colData.rds'))
# gene_annotation &lt;-
# readRDS(url('https://depts.washington.edu:/trapnell-lab/software/monocle3/celegans/data/cao_l2_rowData.rds'))
expression_matrix &lt;- readRDS("cao_l2_expression.rds")
cell_metadata &lt;- readRDS("cao_l2_colData.rds")
gene_annotation &lt;- readRDS("cao_l2_rowData.rds")</code></pre> 
 <h4>Step 1: Normalize and pre-process the data</h4> 
 <p>使用Monocle 3的第一步是将数据加载到Monocle 3的主类cell_data_set:</p> 
 <pre class="has"><code class="language-go"># Make the CDS object
cds &lt;- new_cell_data_set(expression_matrix, cell_metadata = cell_metadata, gene_metadata = gene_annotation)
cds &lt;- preprocess_cds(cds, num_dim = 100, method = c("PCA", "LSI"))
plot_pc_variance_explained(cds)</code></pre> 
 <p><img src="https://images2.imgbox.com/78/b9/UeqLiZ7q_o.png" alt="400b7cf213ab3dc945984ff670684a20.png"></p> 
 <h4>Step 2: Remove batch effects with cell alignment</h4> 
 <p>在Monocle 3中，可以使用几种不同的方法从类似(但不是完全相同)的条件中减去未观察到的批次效应或排序细胞。</p> 
 <pre class="has"><code class="language-go">cds &lt;- align_cds(cds, alignment_group = "batch")</code></pre> 
 <h4>Step 3: Reduce the dimensions using "UMAP", "tSNE", "PCA", "LSI", "Aligned"</h4> 
 <p>降维算法，这里面提供了5种方法：</p> 
 <pre class="has"><code class="language-go">cds &lt;- reduce_dimension(cds, reduction_method = c("UMAP", "tSNE", "PCA", "LSI", "Aligned"))</code></pre> 
 <h4>Step 4: Cluster the cells</h4> 
 <p>细胞聚类：</p> 
 <pre class="has"><code class="language-go">cds &lt;- cluster_cells(cds)</code></pre> 
 <h4>Setp 5: Visualization</h4> 
 <h5>绘制数据分布</h5> 
 <p>绘制数据，可以使用Monocle的主要绘制函数plot_cells():</p> 
 <pre class="has"><code class="language-go">plot_cells(cds)</code></pre> 
 <p><img src="https://images2.imgbox.com/fd/d9/ACGsVTFA_o.png" alt="1ec7e23e75d7936859b5b03143f6af97.png"></p> 
 <h5>添加细胞类型</h5> 
 <p>上图中的每个点表示cell_data_set对象cds中的一个不同的细胞。正如你所看到的，这些细胞组成了许多组，有些有数千个细胞，有些只有几个。通过观察它表达的基因，根据类型手工注释每个细胞。我们可以使用plot_cells()的color_cells_by参数通过作者的原始注释给UMAP图中的单元格上色。</p> 
 <pre class="has"><code class="language-go">plot_cells(cds, color_cells_by = "cao_cell_type")</code></pre> 
 <p><img src="https://images2.imgbox.com/0a/a6/uBiIyL25_o.png" alt="365feaa5fd37c4571d19eb129c1e3325.png"></p> 
 <h5>设置颜色</h5> 
 <p>在UMAP图中，你可以看到许多细胞类型非常接近。除了稍后描述的一些情况外，color_cells_by可以是colData(cds)中任何列的名称。注意，当color_cells_by是一个分类变量时，标签将被添加到绘图中，每个标签大致位于具有该标签的所有单元格的中间。</p> 
 <p>你也可以根据细胞表达的基因或一组基因的多少来给细胞着色:</p> 
 <pre class="has"><code class="language-go">plot_cells(cds, genes = c("cpna-2", "egl-21", "ram-2", "inos-1"))</code></pre> 
 <p><img src="https://images2.imgbox.com/11/f6/M1aCFoYl_o.png" alt="2a9295a6457ad59d9decfe19a86261c3.png"></p> 
 <h5>tSNE降维绘图</h5> 
 <pre class="has"><code class="language-go">cds &lt;- reduce_dimension(cds, reduction_method = "tSNE")
plot_cells(cds, reduction_method = "tSNE", color_cells_by = "cao_cell_type")</code></pre> 
 <p><img src="https://images2.imgbox.com/7e/14/dkfP4RAi_o.png" alt="f62280c78566b17f29acb383e3669d9a.png"></p> 
 <h3>检查去除批次效应</h3> 
 <p>在进行基因表达分析时，批次效应是很重要的，批次效应是指不同实验批次所测细胞转录组的系统性差异。这些可能是技术性的，如在单细胞RNA-seq协议中引入的，或生物学的，如可能来自不同窝小鼠的那些。如何识别批处理效果并解释它们，从而使它们不会混淆您的分析，这是一个复杂的问题，但Monocle提供了处理它们的工具。</p> 
 <h4>批次色板着色</h4> 
 <p>在执行降维时，应该始终检查批处理效果。您应该向colData添加一个列，该列对每个单元格来自哪个批处理进行编码。然后，您可以简单地通过批处理给细胞着色。在数据中加入了一个“板块”注释，指定了每个细胞来自哪个科学 RNA - SEQ板块。用色板着色 UMAP 显示:</p> 
 <pre class="has"><code class="language-go">plot_cells(cds, color_cells_by = "plate", label_cell_groups = FALSE)</code></pre> 
 <p><img src="https://images2.imgbox.com/c7/52/JYQUpjnL_o.png" alt="3f6dcf88036176f3b479d11edc657cfd.png"></p> 
 <h4>align_cds() 去除批次效应</h4> 
 <p>这些数据中并没有明显的批处理效果。如果数据中包含更多由于培养皿而产生的实质性变化，我们就会期望看到实际上只来自一个培养皿的细胞群。然而，我们可以尝试通过运行align_cds()函数来删除批处理的效果:</p> 
 <pre class="has"><code class="language-go">cds &lt;- align_cds(cds, num_dim = 100, alignment_group = "plate")
cds &lt;- reduce_dimension(cds)
plot_cells(cds, color_cells_by = "plate", label_cell_groups = FALSE)</code></pre> 
 <p><img src="https://images2.imgbox.com/25/b4/hzmOfxY1_o.png" alt="e2bc01e149dc8b18d324fc404670d9c7.png"></p> 
 <h3>将细胞分组成簇</h3> 
 <p>将细胞分组为 cluster 是识别数据中表达细胞类型的重要步骤。Monocle使用一种称为社区检测的技术来对细胞进行分组。Levine等人引入了这种方法，作为表现图算法的一部分。你可以使用cluster_cells()函数来聚类细胞，就像这样:</p> 
 <pre class="has"><code class="language-go">cds &lt;- cluster_cells(cds, resolution = 1e-05)
plot_cells(cds)</code></pre> 
 <p><img src="https://images2.imgbox.com/d3/0a/bisXNTLx_o.png" alt="92e596e8df4cbc644d0cd8a95106fbb9.png"></p> 
 <p>注意，现在当我们调用不带参数的plot_cells()时，它会根据默认值按聚类给细胞着色。</p> 
 <p>cluster_cells()还使用Alex Wolf等人作为PAGA算法的一部分引入的统计测试，将细胞分成更大、更分离的组，称为分区。你可以这样可视化这些分区:</p> 
 <pre class="has"><code class="language-go">plot_cells(cds, color_cells_by = "partition", group_cells_by = "partition")</code></pre> 
 <p><img src="https://images2.imgbox.com/6f/63/uGK9fZ1f_o.png" alt="189b951663522a03a846b4c0a13da9fc.png"></p> 
 <p>一旦运行cluster_cells()， plot_cells()函数将根据您想要给细胞着色的方式对每个细胞簇进行单独标记。例如，下面的调用根据它们的细胞类型注释对细胞进行着色，每个簇根据其中最常见的注释进行标记:</p> 
 <pre class="has"><code class="language-go">plot_cells(cds, color_cells_by = "cao_cell_type")</code></pre> 
 <p><img src="https://images2.imgbox.com/95/32/B1rBloPC_o.png" alt="1824f7151b435ea5304aaf12d7496f96.png"></p> 
 <p>通过传递 group_cells_by="partition"，可以选择标记整个分区而不是簇。您还可以通过将 labels_per_group=2 传递给 plot_cells() 来绘制每个集群的前2个标签。最后，可以禁用这个标记策略，使 plot_cells() 与调用 cluster_cells() 之前一样，如下所示:</p> 
 <pre class="has"><code class="language-go">plot_cells(cds, color_cells_by = "cao_cell_type", label_groups_by_cluster = FALSE)</code></pre> 
 <p><img src="https://images2.imgbox.com/c0/f4/mNb3NT3E_o.png" alt="959d18b0339d1682842644ec04db9c17.png"></p> 
 <p style="text-align:left;">我们这期先分析第一部分，内容过多，一次完成有点太乱了，目前单细胞测序的费用也在降低，单细胞系列可算是目前的测序神器，有这方面需求的老师，联系桓峰基因，提供最高端的科研服务！<br></p> 
 <p style="text-align:center;">桓峰基因，铸造成功的您！</p> 
 <p style="text-align:center;">未来桓峰基因公众号将不间断的推出单细胞系列生信分析教程，</p> 
 <p style="text-align:center;">敬请期待！！</p> 
 <p style="text-align:left;">有想进生信交流群的老师可以扫最后一个二维码加微信，备注“单位+姓名+目的”，有些想发广告的就免打扰吧，还得费力气把你踢出去！</p> 
 <p style="text-align:center;"><img src="https://images2.imgbox.com/40/17/Drch1dSx_o.png" alt="7a5d381b7d5672b281a00981a2fc4a16.png"></p> 
 <h5>References:</h5> 
 <ol><li><p>UMAP: McInnes, L, Healy, J, UMAP: Uniform Manifold Approximation and Projection for Dimension Reduction, ArXiv e-prints 1802.03426, 2018</p></li><li><p>tSNE: Laurens van der Maaten and Geoffrey Hinton. Visualizing data using t-SNE. J. Mach. Learn. Res., 9(Nov):2579– 2605, 2008.</p></li></ol> 
 <p><img src="https://images2.imgbox.com/6f/12/StnkQXwZ_o.gif" alt="c929297cf902d1b6e2780a7b4e34fed3.gif"></p> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e9a0c33627c7b5c226df1c6133cb10dd/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">vue3实现video控件的h5端进度条拖拽与跳转</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/312b97938aa42d32e6fda7fc5eb06f4f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Mybatis-Plus自动填充功能@TableField（FieldFill）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>