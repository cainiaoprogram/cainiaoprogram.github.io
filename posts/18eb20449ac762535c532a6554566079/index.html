<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>使用ASM框架创建ClassVisitor时遇到IllegalArgumentException的一种可能解决办法 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="使用ASM框架创建ClassVisitor时遇到IllegalArgumentException的一种可能解决办法" />
<meta property="og:description" content="背景 ASM是java语言中最为广泛使用的插装框架，其优点在于可以动态地在运行时改变java系统的行为，加入我们自己的逻辑。在软件测试领域应用广泛。但是其使用难度很高，一方面使用asm框架需要对java底层知识有较高的了解，另一方面网上关于asm的资料较少出现问题经常难以搜索到解决方案。参考资料[1]-[3]提供了一些关于asm的基础介绍。
使用ASM时一个非常大的问题在于我们往往需要将自己的少量逻辑插入到复杂的目标系统中进行测试，而我们对目标系统却没有很深的理解。这样当由于目标系统一些特性使得我们的插装代码出错时，我们就很容易处于一种无处下手的状态。
我在使用ASM插装一个不算太复杂的框架raft-java时，创建ClassVisitor总是会在构造函数出爆出IllegalArgumentException，这个问题困扰了我两天，最后发现是由于系统中多次引用asm后声明版本号不一致导致。在此记录下来以供其他的asm初学者进行参考。
问题描述 使用ASM插装raft-java时，遇到问题如下：
raft-java插装点：ServerMain类的main方法的server.start()语句前。
在server.start()执行前插入我们自己的函数逻辑。
插装逻辑如下图。
ClassReader cr = new ClassReader(input); ClassWriter cw = new ClassWriter(cr, ClassWriter.COMPUTE_MAXS); RaftDownCLassVIsitor rcv = new RaftDownCLassVIsitor(ASM9, cw); cr.accept(rcv, 0); byte[] contents = cw.toByteArray(); 其中RaftDownClassVisitor是我自己写的插装类，这里只摘录其构造函数和visitMethod函数。
public RaftDownCLassVIsitor(int api, ClassVisitor classVisitor) { super(api, classVisitor); } @Override public MethodVisitor visitMethod(int access, String name, String descriptor, String signature, String[] exceptions) { logger.info(&#34;visitMethod&#34; &#43; name); MethodVisitor mv = super.visitMethod(access, name, descriptor, signature, exceptions); if (className.equals(&#34;com/github/wenweihu86/raft/example/server/ServerMain&#34;)) { logger." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/18eb20449ac762535c532a6554566079/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-01-15T16:03:27+08:00" />
<meta property="article:modified_time" content="2023-01-15T16:03:27+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">使用ASM框架创建ClassVisitor时遇到IllegalArgumentException的一种可能解决办法</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>背景</h2> 
<p>ASM是java语言中最为广泛使用的插装框架，其优点在于可以动态地在运行时改变java系统的行为，加入我们自己的逻辑。在软件测试领域应用广泛。但是其使用难度很高，一方面使用asm框架需要对java底层知识有较高的了解，另一方面网上关于asm的资料较少出现问题经常难以搜索到解决方案。参考资料[1]-[3]提供了一些关于asm的基础介绍。</p> 
<p>使用ASM时一个非常大的问题在于我们往往需要将自己的少量逻辑插入到复杂的目标系统中进行测试，而我们对目标系统却没有很深的理解。这样当由于目标系统一些特性使得我们的插装代码出错时，我们就很容易处于一种无处下手的状态。</p> 
<p>我在使用ASM插装一个不算太复杂的框架raft-java时，创建ClassVisitor总是会在构造函数出爆出IllegalArgumentException，这个问题困扰了我两天，最后发现是由于系统中多次引用asm后声明版本号不一致导致。在此记录下来以供其他的asm初学者进行参考。</p> 
<h2><a id="_7"></a>问题描述</h2> 
<p>使用ASM插装raft-java时，遇到问题如下：<br> raft-java插装点：ServerMain类的main方法的server.start()语句前。<br> <img src="https://images2.imgbox.com/5e/6f/bEILwjR2_o.png" alt="在这里插入图片描述"><br> 在server.start()执行前插入我们自己的函数逻辑。<br> 插装逻辑如下图。</p> 
<pre><code class="prism language-java"><span class="token class-name">ClassReader</span> cr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassReader</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ClassWriter</span> cw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassWriter</span><span class="token punctuation">(</span>cr<span class="token punctuation">,</span> <span class="token class-name">ClassWriter</span><span class="token punctuation">.</span><span class="token constant">COMPUTE_MAXS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">RaftDownCLassVIsitor</span> rcv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RaftDownCLassVIsitor</span><span class="token punctuation">(</span><span class="token constant">ASM9</span><span class="token punctuation">,</span> cw<span class="token punctuation">)</span><span class="token punctuation">;</span>
cr<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>rcv<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> contents <span class="token operator">=</span> cw<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>其中RaftDownClassVisitor是我自己写的插装类，这里只摘录其构造函数和visitMethod函数。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">RaftDownCLassVIsitor</span><span class="token punctuation">(</span><span class="token keyword">int</span> api<span class="token punctuation">,</span> <span class="token class-name">ClassVisitor</span> classVisitor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>api<span class="token punctuation">,</span> classVisitor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">MethodVisitor</span> <span class="token function">visitMethod</span><span class="token punctuation">(</span><span class="token keyword">int</span> access<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">String</span> descriptor<span class="token punctuation">,</span> <span class="token class-name">String</span> signature<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> exceptions<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"visitMethod"</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MethodVisitor</span> mv <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">visitMethod</span><span class="token punctuation">(</span>access<span class="token punctuation">,</span> name<span class="token punctuation">,</span> descriptor<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> exceptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>className<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"com/github/wenweihu86/raft/example/server/ServerMain"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"visit com/github/wenweihu86/raft/example/server/ServerMain"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">RaftDownMethodVisitor</span> rmv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RaftDownMethodVisitor</span><span class="token punctuation">(</span><span class="token constant">ASM9</span><span class="token punctuation">,</span> mv<span class="token punctuation">)</span><span class="token punctuation">;</span>
            rmv<span class="token punctuation">.</span><span class="token function">setIndex</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> rmv<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> mv<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>其中RaftDownMethodVisitor类是我们自己写的MethodVisitor插装类。上面的visitMethod方法意思为当程序执行到ServerMain类的函数时，其返回的函数会是我们的RaftDownMethodVisitor提供的修改过的函数。<br> RaftDownMethodVisitor中则进一步判断，当调用server.start()语句时，先执行一些我们的逻辑。RaftDownMethodVisitor和本篇博客所阐释的问题关系不大，这里不再展开。<br> 使用上述代码进行实验时，系统报错：<br> <img src="https://images2.imgbox.com/b7/d5/aXzPBcUw_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_46"></a>解决过程</h2> 
<p>首先根据堆栈信息，查看ClassVisitor的构造函数。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">ClassVisitor</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> api<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ClassVisitor</span> classVisitor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>api <span class="token operator">!=</span> <span class="token class-name">Opcodes</span><span class="token punctuation">.</span><span class="token constant">ASM9</span>
        <span class="token operator">&amp;&amp;</span> api <span class="token operator">!=</span> <span class="token class-name">Opcodes</span><span class="token punctuation">.</span><span class="token constant">ASM8</span>
        <span class="token operator">&amp;&amp;</span> api <span class="token operator">!=</span> <span class="token class-name">Opcodes</span><span class="token punctuation">.</span><span class="token constant">ASM7</span>
        <span class="token operator">&amp;&amp;</span> api <span class="token operator">!=</span> <span class="token class-name">Opcodes</span><span class="token punctuation">.</span><span class="token constant">ASM6</span>
        <span class="token operator">&amp;&amp;</span> api <span class="token operator">!=</span> <span class="token class-name">Opcodes</span><span class="token punctuation">.</span><span class="token constant">ASM5</span>
        <span class="token operator">&amp;&amp;</span> api <span class="token operator">!=</span> <span class="token class-name">Opcodes</span><span class="token punctuation">.</span><span class="token constant">ASM4</span>
        <span class="token operator">&amp;&amp;</span> api <span class="token operator">!=</span> <span class="token class-name">Opcodes</span><span class="token punctuation">.</span><span class="token constant">ASM10_EXPERIMENTAL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Unsupported api "</span> <span class="token operator">+</span> api<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>api <span class="token operator">==</span> <span class="token class-name">Opcodes</span><span class="token punctuation">.</span><span class="token constant">ASM10_EXPERIMENTAL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token function">checkAsmExperimental</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>api <span class="token operator">=</span> api<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cv <span class="token operator">=</span> classVisitor<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>可以看到构造函数确实可以抛出IllegalArgumentException。但是从源码来看我们的输入并不应该触发这个异常才对。除此之外，从源码来看，抛出的IllegalArgumentException应该有“Unsupported api”的信息才对，但是我却打印不出来该信息。</p> 
<p>于是上网上寻找资料（参考资料[4]-[7]）。在过程中，发现一些人在使用asm插装springboot, gwt等项目时也产生过类似问题。解决方案则大多时将目标系统或者asm调整至固定版本。这引发人怀疑，会不会我们也是asm的版本出了问题呢？</p> 
<p>于是我使用mvn dependency:tree命令查看了raft-java的依赖。<br> <img src="https://images2.imgbox.com/d2/a8/UsQEMuef_o.png" alt="在这里插入图片描述"><br> 果然找到了raft-java自身依赖的asm，而且还是间接依赖，这样的依赖单纯看源码几乎不可能看出。raft-java本身使用了5.2版本的asm，而我们的插装代码则使用了9.1版本的asm并在创建RaftDownClassVisitor和RaftDownMethodVisitor时将asm版本指定成了9.（<code>RaftDownCLassVIsitor rcv = new RaftDownCLassVIsitor(ASM9, cw);</code>）。将这里传入的参数改为ASM5即可消除错误。</p> 
<h2><a id="_75"></a>解决方法</h2> 
<p>使用<code>mvn dependency:tree</code>命令检查目标系统有没有使用asm依赖。若有，则在创建ClassVisitor和MethodVisitor实例时需要注意传入的ASM版本号参数要和目标系统依赖的asm版本一致。</p> 
<pre><code class="prism language-java"><span class="token class-name">RaftDownCLassVIsitor</span> rcv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RaftDownCLassVIsitor</span><span class="token punctuation">(</span><span class="token constant">ASM5</span><span class="token punctuation">,</span> cw<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token class-name">RaftDownMethodVisitor</span> rmv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RaftDownMethodVisitor</span><span class="token punctuation">(</span><span class="token constant">ASM5</span><span class="token punctuation">,</span> mv<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h2><a id="_86"></a>一些经验教训</h2> 
<h3><a id="trycatch_87"></a>使用try…catch…捕捉异常</h3> 
<p>一些目标系统会使用全局性的try…catch…机制，导致即使代码在某一步出错，但是系统不会在这里报错。继续运行的系统可能会产生错误的行为，但是让人难以和出错的代码联系起来。<br> 在本次debug过程中，ClassVisitor的构造函数的异常只有在我将插装代码改为如下形式后才会被打印出来。</p> 
<pre><code class="prism language-java"><span class="token class-name">ClassReader</span> cr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassReader</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ClassWriter</span> cw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassWriter</span><span class="token punctuation">(</span>cr<span class="token punctuation">,</span> <span class="token class-name">ClassWriter</span><span class="token punctuation">.</span><span class="token constant">COMPUTE_MAXS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">RaftDownCLassVIsitor</span> rcv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RaftDownCLassVIsitor</span><span class="token punctuation">(</span><span class="token constant">ASM9</span><span class="token punctuation">,</span> cw<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// RaftDownCLassVIsitor rcv = new RaftDownCLassVIsitor(ASM5, cw);</span>
        cr<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>rcv<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     
    <span class="token punctuation">}</span>
<span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> contents <span class="token operator">=</span> cw<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>因此，当我们怀疑某一步出了问题时，应注意主动加上try…catch…使得异常可以被我们自己捕获。</p> 
<h3><a id="vscodemvn_dependencytree_104"></a>注意vscode和mvn dependency:tree展示的依赖的差别</h3> 
<p>使用vscode的java插件，我们也可以看到一个项目的依赖<br> <img src="https://images2.imgbox.com/ee/f6/qceKSe0r_o.png" alt="在这里插入图片描述"><br> 但是可以发现，vscode中展示出来的目标系统依赖的asm的版本(6.0_alphe)和<code>mvn dependency:tree</code>展示出来的asm的版本(5.2)并不一致。<br> 在本文所展示的例子中，只有使用<code>mvn dependency:tree</code>展示出来的asm-5.2版本才能阻止错误发生。</p> 
<h2><a id="_110"></a>讨论</h2> 
<p>在本文所展示的例子中，目标系统raft-java是maven项目，而我所写的插装代码则是gradle项目。我不清楚目标项目和插装代码的构建工具不同是否会导致依赖混淆。换言之，我不确定假如我使用maven作为插装代码的构建工具文中所提到的bug还会不会产生。此问题留待以后研究。</p> 
<h2><a id="_114"></a>参考资料</h2> 
<p>[1] <a href="https://asm.ow2.io/" rel="nofollow">https://asm.ow2.io/</a><br> [2] <a href="https://asm.ow2.io/asm4-guide.pdf" rel="nofollow">https://asm.ow2.io/asm4-guide.pdf</a><br> [3] <a href="https://github.com/wenweihu86/raft-java">raft-java仓库地址</a><br> [4] <a href="https://stackoverflow.com/questions/67590531/gwt-application-fails-with-illegalargumentexception-in-org-objectweb-asm-classvi" rel="nofollow">https://stackoverflow.com/questions/67590531/gwt-application-fails-with-illegalargumentexception-in-org-objectweb-asm-classvi</a><br> [5] <a href="https://cloud.tencent.com/developer/article/1918986" rel="nofollow">https://cloud.tencent.com/developer/article/1918986</a><br> [6] <a href="https://stackoverflow.com/questions/25403911/illegalargumentexception-at-org-springframework-asm-classreader-when-initializin" rel="nofollow">https://stackoverflow.com/questions/25403911/illegalargumentexception-at-org-springframework-asm-classreader-when-initializin</a><br> [7] <a href="https://issues.apache.org/jira/browse/BEANUTILS-477" rel="nofollow">https://issues.apache.org/jira/browse/BEANUTILS-477</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7621a56a8f6eaba22d3569b606d0789a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Fiddler打开后提示:AppContainer Configuration</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8db2928875292061423dbf747316d6d8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">跨链桥安全事件总结分析</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>