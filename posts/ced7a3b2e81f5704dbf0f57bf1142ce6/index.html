<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>部署etcd集群 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="部署etcd集群" />
<meta property="og:description" content="参考： https://www.cnblogs.com/51wansheng/p/10234036.html
一、环境说明 ubuntu 18.04 172.18.0.30 (master)ubuntu 18.04 172.18.0.26 (node1)etcd 版本：v2.3.7 二、安装etcd 分别在master和node1机器上安装etcd
# step1：下载某版本etcd的release包 $ wget https://github.com/etcd-io/etcd/releases/download/v2.3.7/etcd-v2.3.7-linux-amd64.tar.gz # step2：解压安装到 /data/ 目录下（安装到那个目录可以自己定） $ tar -C /data -zxvf etcd-v2.3.7-linux-amd64.tar.gz # step3：检查安装是否成功 $ /data/etcd-v2.3.7-linux-amd64/etcdctl -v etcdctl version 2.3.7 三、配置etcd etcd重要配置参数的说明，不通版本的etcd可能参数选项以及选项的默认值会有些许出入，可以通过 etcd --help查看
--name	# etcd实例名称 --data-dir	# etcd数据存储的目录 --listen-client-urls	# 供外部客户端使用的url --advertise-client-urls	# 广播给外部客户端使用的url --listen-peer-urls	# 集群内部通信使用的url --initial-advertise-peer-urls	# 广播给集群内其他成员访问的url --initial-cluster	# 初始集群成员列表 --initial-cluster-token	# 集群的名称 --initial-cluster-state	# 初始集群状态，new为新建集群（master为new，node为existing） 我们通过systemd来管理etcd服务，所以在/etc/systemd/system目录下新建etcd.service文件，不了解systemd的可以查看阮一峰老师的博客
1、master机器（172.18.0.30） # vim /etcsystemd/system/etcd." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/ced7a3b2e81f5704dbf0f57bf1142ce6/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-05-20T19:41:44+08:00" />
<meta property="article:modified_time" content="2020-05-20T19:41:44+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">部署etcd集群</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><strong>参考：</strong> https://www.cnblogs.com/51wansheng/p/10234036.html</p> 
<h4><a id="_2"></a>一、环境说明</h4> 
<ul><li>ubuntu 18.04 172.18.0.30 (master)</li><li>ubuntu 18.04 172.18.0.26 (node1)</li><li>etcd 版本：v2.3.7</li></ul> 
<h4><a id="etcd_7"></a>二、安装etcd</h4> 
<p>分别在master和node1机器上安装etcd</p> 
<pre><code># step1：下载某版本etcd的release包
$ wget https://github.com/etcd-io/etcd/releases/download/v2.3.7/etcd-v2.3.7-linux-amd64.tar.gz

# step2：解压安装到 /data/ 目录下（安装到那个目录可以自己定）
$ tar -C /data -zxvf etcd-v2.3.7-linux-amd64.tar.gz

# step3：检查安装是否成功
$ /data/etcd-v2.3.7-linux-amd64/etcdctl -v
etcdctl version 2.3.7
</code></pre> 
<h4><a id="etcd_21"></a>三、配置etcd</h4> 
<p>etcd重要配置参数的说明，不通版本的etcd可能参数选项以及选项的默认值会有些许出入，可以通过 <code>etcd --help</code>查看</p> 
<pre><code>--name										# etcd实例名称
--data-dir									# etcd数据存储的目录
--listen-client-urls						# 供外部客户端使用的url
--advertise-client-urls				# 广播给外部客户端使用的url
--listen-peer-urls						# 集群内部通信使用的url
--initial-advertise-peer-urls		# 广播给集群内其他成员访问的url
--initial-cluster							# 初始集群成员列表
--initial-cluster-token				# 集群的名称
--initial-cluster-state					# 初始集群状态，new为新建集群（master为new，node为existing）
</code></pre> 
<p>我们通过systemd来管理etcd服务，所以在<code>/etc/systemd/system</code>目录下新建<code>etcd.service</code>文件，不了解systemd的可以查看阮一峰老师的<a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-commands.html" rel="nofollow">博客</a></p> 
<h5><a id="1master17218030_35"></a>1、master机器（172.18.0.30）</h5> 
<pre><code># vim /etcsystemd/system/etcd.service

[Unit]
Description=Etcd Server
After=network.target
After=network-online.target
Wants=network-online.target

[Service]
Type=notify
WorkingDirectory=/data/etcd-v2.3.7-linux-amd64
User=root
ExecStart=/data/etcd-v2.3.7-linux-amd64/etcd --name etcd0 --data-dir /data/etcd_data/etcd1 \
    --listen-client-urls http://172.18.0.30:2379,http://localhost:2379 --advertise-client-urls http://172.18.0.30:2379,http://localhost:2379 \
    --listen-peer-urls http://172.18.0.30:2380 --initial-advertise-peer-urls http://172.18.0.30:2380 \
    --initial-cluster etcd0=http://172.18.0.30:2380,etcd1=http://172.18.0.26:2480 --initial-cluster-token etcd-cluster \
    --initial-cluster-state new
Restart=always

[Install]
WantedBy=multi-user.target
</code></pre> 
<p>注：如果默认的<code>2379</code>、<code>2380</code>端口已被占用，可以配置etcd监听其他未被占用的端口</p> 
<h5><a id="2node117218026_61"></a>2、node1机器（172.18.0.26）</h5> 
<pre><code># vim /etc/systemd/system/etcd.service

[Unit]
Description=Etcd Server
After=network.target
After=network-online.target
Wants=network-online.target

[Service]
Type=notify
WorkingDirectory=/data/etcd-v2.3.7-linux-amd64
User=root
ExecStart=/data/etcd-v2.3.7-linux-amd64/etcd --name etcd1 --data-dir /data/etcd_data/etcd0 \
    --listen-client-urls http://172.18.0.26:2479,http://localhost:2479 --advertise-client-urls http://172.18.0.26:2479,http://localhost:2479 \
    --listen-peer-urls http://172.18.0.26:2480 --initial-advertise-peer-urls http://172.18.0.26:2480 \
    --initial-cluster etcd0=http://172.18.0.30:2380,etcd1=http://172.18.0.26:2480 --initial-cluster-token etcd-cluster \
    --initial-cluster-state existing
Restart=always

[Install]
WantedBy=multi-user.target
</code></pre> 
<h3><a id="etcd_86"></a>三、启动etcd服务</h3> 
<p>配置好etcd的服务后，分别启动master和node1节点的etcd服务</p> 
<pre><code># step1：重新加载systemd配置文件（修改systemd配置文件后必须重新加载）
$ systemctl daemon-reload

# step2：启动etcd服务
$ systemctl restart etcd

# 停止etcd服务
$ systmectl stop etcd

# 查看etcd状态
$ systemctl status etcd

# 查看etcd日志
$ journalctl -u etcd

# 设置etcd开机启动
$ systemctl enable etcd
</code></pre> 
<h4><a id="etcd_108"></a>四、使用etcd</h4> 
<pre><code># 查看etcd集群成员（可以在集群成员的任一台机器上操作）
$ /data/etcd-v2.3.7-linux-amd64/etcdctl member list
bd3b67d271b1097d: name=etcd0 peerURLs=http://172.18.0.30:2380 clientURLs=http://172.18.0.30:2379,http://localhost:2379 isLeader=true
e5ad2a6d82697b13: name=etcd1 peerURLs=http://172.18.0.26:2480 clientURLs=http://172.18.0.26:2479,http://localhost:2479 isLeader=false

# 查看集群成员健康情况
$ /data/etcd-v2.3.7-linux-amd64/etcdctl cluster-health
member bd3b67d271b1097d is healthy: got healthy result from http://172.18.0.30:2379
member e5ad2a6d82697b13 is healthy: got healthy result from http://172.18.0.26:2479
cluster is healthy

# 在master上set一个key-value
$ /data/etcd-v2.3.7-linux-amd64/etcdctl set name tab609
tab609

# 在node1上get这个key的值（注：如果监听的不是默认端口2380则需要指定 --endpoints）
$ /data/etcd-v2.3.7-linux-amd64/etcdctl --endpoints http://localhost:2479 get name
tab609

# 更多etcdctl操作可以查看帮助
$ /data/etcd-v2.3.7-linux-amd64/etcdctl help
</code></pre> 
<h4><a id="etcdnode217218017_133"></a>五、etcd集群新增一个节点node2（172.18.0.17）</h4> 
<h5><a id="1etcd_134"></a>1、安装etcd</h5> 
<p>同上安装步骤</p> 
<h5><a id="2etcd_137"></a>2、配置etcd</h5> 
<p>node2节点</p> 
<pre><code>#  vim /etc/systemd/sytem/etcd.service

[Unit]
Description=Etcd Server
After=network.target
After=network-online.target
Wants=network-online.target

[Service]
Type=notify
WorkingDirectory=/data/etcd-v2.3.7-linux-amd64
User=root
ExecStart=/data/etcd-v2.3.7-linux-amd64/etcd --name etcd2 --data-dir /data/etcd_data/etcd2 \
    --listen-client-urls http://172.18.0.17:2479,http://localhost:2479 --advertise-client-urls http://172.18.0.17:2479,http://localhost:2479 \
    --listen-peer-urls http://172.18.0.17:2480 --initial-advertise-peer-urls http://172.18.0.17:2480 \
    --initial-cluster etcd0=http://172.18.0.30:2380,etcd1=http://172.18.0.26:2480,etcd2=http://172.18.0.17:2480 --initial-cluster-token yj1918-etcd-cluster \
    --initial-cluster-state existing
Restart=always

[Install]
WantedBy=multi-user.target
</code></pre> 
<p>master节点配置文件中的集群成员添加node2节点，只需修改<code>--initial-cluster</code>参数选项</p> 
<pre><code># vim /etc/systemd/sytem/etcd.service

ExecStart= ... \
	--initial-cluster etcd0=http://172.18.0.30:2380,etcd1=http://172.18.0.26:2480,etcd2=http://172.18.0.17:2480
</code></pre> 
<p>同理node1节点配置文件中的集群成员也添加node2节点，只需修改<code>--initial-cluster</code>参数选项</p> 
<pre><code># vim /etc/systemd/sytem/etcd.service

ExecStart= ... \
	--initial-cluster etcd0=http://172.18.0.30:2380,etcd1=http://172.18.0.26:2480,etcd2=http://172.18.0.17:2480
</code></pre> 
<h5><a id="3etcd_178"></a>3、启动etcd服务</h5> 
<p>分别在master、node1、node2上执行同上的启动步骤，但在启动node2的时候启动失败，报如下错误</p> 
<pre><code>error validating peerURLs {ClusterID:b0f36b8e1c8349f4 Members:[&amp;{ID:bd3b67d271b1097d RaftAttributes:{PeerURLs:[http://172.18.0.30:2380]} Attributes:{Name:etcd0 ClientURLs:[http://172.18.0.30:2379]
</code></pre> 
<p>也就是说在验证对端（master）的rul时出错了，谷歌后找到<a href="https://www.jianshu.com/p/587faa31eb9c" rel="nofollow">解决方法</a>，我们需要在启动新节点之前，必须把新节点接入集群，然后再启动新节点</p> 
<pre><code># 在master上添加新的节点成员（master机器操作）
$  /data/etcd-v2.3.7-linux-amd64/etcdctl member add node2 http://172.18.0.17:2480

# 重新启动node2的etcd服务就可以成功了（node2机器操作）
$ systemctl restart etcd

# 查看集群的成员（如我在node2上执行，如果监听的不是默认端口2379则需要指定 --endpoints）
$ /data/etcd-v2.3.7-linux-amd64/etcdctl --endpoints http://172.18.0.17:2479 member list
bd3b67d271b1097d: name=etcd0 peerURLs=http://172.18.0.30:2380 clientURLs=http://172.18.0.30:2379,http://localhost:2379 isLeader=true
e20ddba3b692fe46: name=etcd2 peerURLs=http://172.18.0.17:2480 clientURLs=http://172.18.0.17:2479,http://localhost:2479 isLeader=false
e5ad2a6d82697b13: name=etcd1 peerURLs=http://172.18.0.26:2480 clientURLs=http://172.18.0.26:2479,http://localhost:2479 isLeader=false

</code></pre> 
<p><strong>写在最后：</strong> etcd是集群，我们get取数据的时候，怎么保证数据的一致性和可靠性呢？etcd是通过类似选举的方式，过半通过规则返回数据。比如集群有三台机器，如果两台机器的key-value都相同，即2/3过半，则返回数据。为了保证数据的一致和可靠性，etcd集群的机器数必须奇数且大于一个节点，并非偶数，更详细可以查看：https://www.jianshu.com/p/5aed73b288f7</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e4a63365f6327b2cbdd101fa87974bea/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">ExecutorService的submit方法使用过程中的坑和源码剖析</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/55d3bb275a62dc002a6dade99f77efce/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">双线性插值法之放大收缩图像及其python实现</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>