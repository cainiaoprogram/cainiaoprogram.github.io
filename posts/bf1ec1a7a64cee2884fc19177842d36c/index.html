<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MYSQL窗口函数 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="MYSQL窗口函数" />
<meta property="og:description" content="文章目录 一、为何使用窗口函数二、什么是窗口函数三、窗口函数如何使用3.1 序号函数3.2 分布函数3.3 前后函数3.4 头尾函数3.5 其他函数3.6 聚类窗口函数 一、为何使用窗口函数 在日常工作中经常会遇到类似这样的需求：
怎么样得到各部门工资排名前N名的员工列表? 查找各部门每人工资占部门总工资的百分比? 对于这样的需求，使用传统的SQL实现起来比较困难，这类需求都有一个共同的特点，需要在单表中满足某些条件的记录集内部做一些函数操作。不使用窗口函数的话可能要进行多次的表连接操作，可读性差的同时还会影响性能。
窗口函数适用场景: 对分组统计结果中的每一条记录进行计算的场景下, 使用窗口函数更好, 注意, 是每一条；因为MySQL的普通聚合函数的结果(如 group by)是每一组只有一条记录。
二、什么是窗口函数 窗口函数也称为OLAP（Online Anallytical Processing）函数，意思是对数据库数据进行实时分析处理。窗口函数就是为了实现OLAP而添加的标准SQL功能。
窗口的概念非常重要，它可以理解为记录集合，窗口函数也就是在满足某种条件的记录集合上执行的特殊函数，对于每条记录都要在此窗口内执行函数，有的函数，随着记录不同，窗口大小都是固定的，这种属于静态窗口；有的函数则相反，不同的记录对应着不同的窗口，这种动态变化的窗口叫滑动窗口。
窗口函数和普通聚合函数也很容易混淆，二者区别如下：
聚合函数是将多条记录聚合为一条；而窗口函数是每条记录都会执行，查询结果并不会改变记录条数，有几条记录执行完还是几条。普通聚合函数也可以用于窗口函数中，赋予它窗口函数的功能。
原因就在于窗口函数的执行顺序（逻辑上的）是在FROM，JOIN，WHERE，GROUP BY，HAVING之后，在ORDER　BY，LIMIT，SELECT　DISTINCT之前。它执行时GROUP BY的聚合过程已经完成了，所以不会再产生数据聚合。 窗口函数的简单语法如下：
&lt;窗口函数&gt; OVER (partition by &lt;用于分组的列名&gt; order by &lt;用于排序的列名&gt;) 三、窗口函数如何使用 数据表：
drop table if exists examination_info,user_info,exam_record; CREATE TABLE examination_info ( id int PRIMARY KEY AUTO_INCREMENT COMMENT &#39;自增ID&#39;, exam_id int UNIQUE NOT NULL COMMENT &#39;试卷ID&#39;, tag varchar(32) COMMENT &#39;类别标签&#39;, difficulty varchar(8) COMMENT &#39;难度&#39;, duration int NOT NULL COMMENT &#39;时长&#39;, release_time datetime COMMENT &#39;发布时间&#39; )CHARACTER SET utf8 COLLATE utf8_general_ci; CREATE TABLE user_info ( id int PRIMARY KEY AUTO_INCREMENT COMMENT &#39;自增ID&#39;, uid int UNIQUE NOT NULL COMMENT &#39;用户ID&#39;, `nick_name` varchar(64) COMMENT &#39;昵称&#39;, achievement int COMMENT &#39;成就值&#39;, level int COMMENT &#39;用户等级&#39;, job varchar(32) COMMENT &#39;职业方向&#39;, register_time datetime COMMENT &#39;注册时间&#39; )CHARACTER SET utf8 COLLATE utf8_general_ci; CREATE TABLE exam_record ( id int PRIMARY KEY AUTO_INCREMENT COMMENT &#39;自增ID&#39;, uid int NOT NULL COMMENT &#39;用户ID&#39;, exam_id int NOT NULL COMMENT &#39;试卷ID&#39;, start_time datetime NOT NULL COMMENT &#39;开始时间&#39;, submit_time datetime COMMENT &#39;提交时间&#39;, score tinyint COMMENT &#39;得分&#39; )CHARACTER SET utf8 COLLATE utf8_general_ci; INSERT INTO user_info(uid,`nick_name`,achievement,`level`,job,register_time) VALUES (1001, &#39;牛客1&#39;, 3200, 7, &#39;算法&#39;, &#39;2020-01-01 10:00:00&#39;), (1002, &#39;牛客2号&#39;, 2500, 6, &#39;算法&#39;, &#39;2020-01-01 10:00:00&#39;), (1003, &#39;牛客3号♂&#39;, 2200, 5, &#39;算法&#39;, &#39;2020-01-01 10:00:00&#39;); INSERT INTO examination_info(exam_id,tag,difficulty,duration,release_time) VALUES (9001, &#39;SQL&#39;, &#39;hard&#39;, 60, &#39;2020-01-01 10:00:00&#39;), (9002, &#39;SQL&#39;, &#39;hard&#39;, 80, &#39;2020-01-01 10:00:00&#39;), (9003, &#39;算法&#39;, &#39;hard&#39;, 80, &#39;2020-01-01 10:00:00&#39;), (9004, &#39;PYTHON&#39;, &#39;medium&#39;, 70, &#39;2020-01-01 10:00:00&#39;); INSERT INTO exam_record(uid,exam_id,start_time,submit_time,score) VALUES (1001, 9001, &#39;2020-01-01 09:01:01&#39;, &#39;2020-01-01 09:21:59&#39;, 90), (1002, 9001, &#39;2020-01-20 10:01:01&#39;, null, null), (1002, 9001, &#39;2020-02-01 12:11:01&#39;, null, null), (1003, 9001, &#39;2020-03-01 19:01:01&#39;, null, null), (1001, 9001, &#39;2020-03-01 12:01:01&#39;, null, null), (1002, 9001, &#39;2020-03-01 12:01:01&#39;, &#39;2020-03-01 12:41:01&#39;, 90), (1002, 9001, &#39;2020-05-02 19:01:01&#39;, &#39;2020-05-02 19:32:00&#39;, 90), (1001, 9002, &#39;2020-01-02 19:01:01&#39;, &#39;2020-01-02 19:59:01&#39;, 69), (1001, 9002, &#39;2020-02-02 12:01:01&#39;, &#39;2020-02-02 12:20:01&#39;, 99), (1002, 9002, &#39;2020-02-02 12:01:01&#39;, null, null), (1002, 9002, &#39;2020-02-02 12:01:01&#39;, &#39;2020-02-02 12:43:01&#39;, 81), (1002, 9002, &#39;2020-03-02 12:11:01&#39;, null, null), (1001, 9001, &#39;2020-01-02 10:01:01&#39;, &#39;2020-01-02 10:31:01&#39;, 89), (1001, 9002, &#39;2020-01-01 12:11:01&#39;, null, null), (1002, 9001, &#39;2020-01-01 18:01:01&#39;, &#39;2020-01-01 18:59:02&#39;, 90), (1002, 9003, &#39;2020-05-06 12:01:01&#39;, null, null), (1001, 9002, &#39;2020-05-05 18:01:01&#39;, null, null); 3." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/bf1ec1a7a64cee2884fc19177842d36c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-18T10:42:50+08:00" />
<meta property="article:modified_time" content="2022-07-18T10:42:50+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">MYSQL窗口函数</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_2" rel="nofollow">一、为何使用窗口函数</a></li><li><a href="#_14" rel="nofollow">二、什么是窗口函数</a></li><li><a href="#_34" rel="nofollow">三、窗口函数如何使用</a></li><li><ul><li><a href="#31__98" rel="nofollow">3.1 序号函数</a></li><li><a href="#32__117" rel="nofollow">3.2 分布函数</a></li><li><a href="#33__147" rel="nofollow">3.3 前后函数</a></li><li><a href="#34__171" rel="nofollow">3.4 头尾函数</a></li><li><a href="#35__197" rel="nofollow">3.5 其他函数</a></li><li><a href="#36__226" rel="nofollow">3.6 聚类窗口函数</a></li></ul> 
 </li></ul> 
</div> 
<br> 
<img src="https://images2.imgbox.com/02/6a/hYIRCSjW_o.png" alt="在这里插入图片描述"> 
<p></p> 
<h2><a id="_2"></a>一、为何使用窗口函数</h2> 
<p>在日常工作中经常会遇到类似这样的需求：</p> 
<pre><code class="prism language-sql">怎么样得到各部门工资排名前N名的员工列表?
查找各部门每人工资占部门总工资的百分比?
</code></pre> 
<p>对于这样的需求，使用传统的SQL实现起来比较困难，这类需求都有一个共同的特点，<mark>需要在单表中满足某些条件的记录集内部做一些函数操作</mark>。不使用窗口函数的话可能要进行多次的表连接操作，可读性差的同时还会影响性能。</p> 
<p>窗口函数<mark>适用场景</mark>: 对分组统计结果中的每一条记录进行计算的场景下, 使用窗口函数更好, 注意, 是每一条；因为MySQL的普通聚合函数的结果(如 group by)是每一组只有一条记录。</p> 
<h2><a id="_14"></a>二、什么是窗口函数</h2> 
<ul><li> <p><mark>窗口函数</mark>也称为OLAP（Online Anallytical Processing）函数，意思是对数据库数据进行实时分析处理。窗口函数就是为了实现OLAP而添加的标准SQL功能。</p> </li><li> <p><mark>窗口</mark>的概念非常重要，它可以理解为记录集合，窗口函数也就是在满足某种条件的记录集合上执行的特殊函数，对于每条记录都要在此窗口内执行函数，有的函数，随着记录不同，窗口大小都是固定的，这种属于静态窗口；有的函数则相反，不同的记录对应着不同的窗口，这种动态变化的窗口叫滑动窗口。</p> </li><li> <p>窗口函数和普通聚合函数也很容易混淆，二者<mark>区别</mark>如下：</p> </li></ul> 
<ol><li>聚合函数是将多条记录聚合为一条；而窗口函数是每条记录都会执行，查询结果并不会改变记录条数，有几条记录执行完还是几条。</li><li>普通聚合函数也可以用于窗口函数中，赋予它窗口函数的功能。<br> 原因就在于<mark>窗口函数的执行顺序</mark>（逻辑上的）是在FROM，JOIN，WHERE，GROUP BY，HAVING之后，在ORDER　BY，LIMIT，SELECT　DISTINCT之前。它执行时GROUP BY的聚合过程已经完成了，所以不会再产生数据聚合。</li></ol> 
<p><strong>窗口函数的简单语法如下：</strong></p> 
<pre><code class="prism language-sql"><span class="token operator">&lt;</span>窗口函数<span class="token operator">&gt;</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> <span class="token operator">&lt;</span>用于分组的列名<span class="token operator">&gt;</span>
                <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token operator">&lt;</span>用于排序的列名<span class="token operator">&gt;</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="_34"></a>三、窗口函数如何使用</h2> 
<p>数据表：</p> 
<pre><code class="prism language-sql"><span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> examination_info<span class="token punctuation">,</span>user_info<span class="token punctuation">,</span>exam_record<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> examination_info <span class="token punctuation">(</span>
    id <span class="token keyword">int</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'自增ID'</span><span class="token punctuation">,</span>
    exam_id <span class="token keyword">int</span> <span class="token keyword">UNIQUE</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'试卷ID'</span><span class="token punctuation">,</span>
    tag <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'类别标签'</span><span class="token punctuation">,</span>
    difficulty <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'难度'</span><span class="token punctuation">,</span>
    duration <span class="token keyword">int</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'时长'</span><span class="token punctuation">,</span>
    release_time <span class="token keyword">datetime</span> <span class="token keyword">COMMENT</span> <span class="token string">'发布时间'</span>
<span class="token punctuation">)</span><span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> user_info <span class="token punctuation">(</span>
    id <span class="token keyword">int</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'自增ID'</span><span class="token punctuation">,</span>
    uid <span class="token keyword">int</span> <span class="token keyword">UNIQUE</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户ID'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>nick_name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'昵称'</span><span class="token punctuation">,</span>
    achievement <span class="token keyword">int</span> <span class="token keyword">COMMENT</span> <span class="token string">'成就值'</span><span class="token punctuation">,</span>
    <span class="token keyword">level</span> <span class="token keyword">int</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户等级'</span><span class="token punctuation">,</span>
    job <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'职业方向'</span><span class="token punctuation">,</span>
    register_time <span class="token keyword">datetime</span> <span class="token keyword">COMMENT</span> <span class="token string">'注册时间'</span>
<span class="token punctuation">)</span><span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> exam_record <span class="token punctuation">(</span>
    id <span class="token keyword">int</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'自增ID'</span><span class="token punctuation">,</span>
    uid <span class="token keyword">int</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户ID'</span><span class="token punctuation">,</span>
    exam_id <span class="token keyword">int</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'试卷ID'</span><span class="token punctuation">,</span>
    start_time <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'开始时间'</span><span class="token punctuation">,</span>
    submit_time <span class="token keyword">datetime</span> <span class="token keyword">COMMENT</span> <span class="token string">'提交时间'</span><span class="token punctuation">,</span>
    score <span class="token keyword">tinyint</span> <span class="token keyword">COMMENT</span> <span class="token string">'得分'</span>
<span class="token punctuation">)</span><span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci<span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> user_info<span class="token punctuation">(</span>uid<span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>nick_name<span class="token punctuation">`</span></span><span class="token punctuation">,</span>achievement<span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>level<span class="token punctuation">`</span></span><span class="token punctuation">,</span>job<span class="token punctuation">,</span>register_time<span class="token punctuation">)</span> <span class="token keyword">VALUES</span>
  <span class="token punctuation">(</span><span class="token number">1001</span><span class="token punctuation">,</span> <span class="token string">'牛客1'</span><span class="token punctuation">,</span> <span class="token number">3200</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">'算法'</span><span class="token punctuation">,</span> <span class="token string">'2020-01-01 10:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token number">1002</span><span class="token punctuation">,</span> <span class="token string">'牛客2号'</span><span class="token punctuation">,</span> <span class="token number">2500</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">'算法'</span><span class="token punctuation">,</span> <span class="token string">'2020-01-01 10:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token number">1003</span><span class="token punctuation">,</span> <span class="token string">'牛客3号♂'</span><span class="token punctuation">,</span> <span class="token number">2200</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'算法'</span><span class="token punctuation">,</span> <span class="token string">'2020-01-01 10:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> examination_info<span class="token punctuation">(</span>exam_id<span class="token punctuation">,</span>tag<span class="token punctuation">,</span>difficulty<span class="token punctuation">,</span>duration<span class="token punctuation">,</span>release_time<span class="token punctuation">)</span> <span class="token keyword">VALUES</span>
  <span class="token punctuation">(</span><span class="token number">9001</span><span class="token punctuation">,</span> <span class="token string">'SQL'</span><span class="token punctuation">,</span> <span class="token string">'hard'</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token string">'2020-01-01 10:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token number">9002</span><span class="token punctuation">,</span> <span class="token string">'SQL'</span><span class="token punctuation">,</span> <span class="token string">'hard'</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token string">'2020-01-01 10:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token number">9003</span><span class="token punctuation">,</span> <span class="token string">'算法'</span><span class="token punctuation">,</span> <span class="token string">'hard'</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token string">'2020-01-01 10:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token number">9004</span><span class="token punctuation">,</span> <span class="token string">'PYTHON'</span><span class="token punctuation">,</span> <span class="token string">'medium'</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">,</span> <span class="token string">'2020-01-01 10:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> exam_record<span class="token punctuation">(</span>uid<span class="token punctuation">,</span>exam_id<span class="token punctuation">,</span>start_time<span class="token punctuation">,</span>submit_time<span class="token punctuation">,</span>score<span class="token punctuation">)</span> <span class="token keyword">VALUES</span>
<span class="token punctuation">(</span><span class="token number">1001</span><span class="token punctuation">,</span> <span class="token number">9001</span><span class="token punctuation">,</span> <span class="token string">'2020-01-01 09:01:01'</span><span class="token punctuation">,</span> <span class="token string">'2020-01-01 09:21:59'</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">1002</span><span class="token punctuation">,</span> <span class="token number">9001</span><span class="token punctuation">,</span> <span class="token string">'2020-01-20 10:01:01'</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">1002</span><span class="token punctuation">,</span> <span class="token number">9001</span><span class="token punctuation">,</span> <span class="token string">'2020-02-01 12:11:01'</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">1003</span><span class="token punctuation">,</span> <span class="token number">9001</span><span class="token punctuation">,</span> <span class="token string">'2020-03-01 19:01:01'</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">1001</span><span class="token punctuation">,</span> <span class="token number">9001</span><span class="token punctuation">,</span> <span class="token string">'2020-03-01 12:01:01'</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">1002</span><span class="token punctuation">,</span> <span class="token number">9001</span><span class="token punctuation">,</span> <span class="token string">'2020-03-01 12:01:01'</span><span class="token punctuation">,</span> <span class="token string">'2020-03-01 12:41:01'</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">1002</span><span class="token punctuation">,</span> <span class="token number">9001</span><span class="token punctuation">,</span> <span class="token string">'2020-05-02 19:01:01'</span><span class="token punctuation">,</span> <span class="token string">'2020-05-02 19:32:00'</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">1001</span><span class="token punctuation">,</span> <span class="token number">9002</span><span class="token punctuation">,</span> <span class="token string">'2020-01-02 19:01:01'</span><span class="token punctuation">,</span> <span class="token string">'2020-01-02 19:59:01'</span><span class="token punctuation">,</span> <span class="token number">69</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">1001</span><span class="token punctuation">,</span> <span class="token number">9002</span><span class="token punctuation">,</span> <span class="token string">'2020-02-02 12:01:01'</span><span class="token punctuation">,</span> <span class="token string">'2020-02-02 12:20:01'</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">1002</span><span class="token punctuation">,</span> <span class="token number">9002</span><span class="token punctuation">,</span> <span class="token string">'2020-02-02 12:01:01'</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">1002</span><span class="token punctuation">,</span> <span class="token number">9002</span><span class="token punctuation">,</span> <span class="token string">'2020-02-02 12:01:01'</span><span class="token punctuation">,</span> <span class="token string">'2020-02-02 12:43:01'</span><span class="token punctuation">,</span> <span class="token number">81</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">1002</span><span class="token punctuation">,</span> <span class="token number">9002</span><span class="token punctuation">,</span> <span class="token string">'2020-03-02 12:11:01'</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">1001</span><span class="token punctuation">,</span> <span class="token number">9001</span><span class="token punctuation">,</span> <span class="token string">'2020-01-02 10:01:01'</span><span class="token punctuation">,</span> <span class="token string">'2020-01-02 10:31:01'</span><span class="token punctuation">,</span> <span class="token number">89</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">1001</span><span class="token punctuation">,</span> <span class="token number">9002</span><span class="token punctuation">,</span> <span class="token string">'2020-01-01 12:11:01'</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">1002</span><span class="token punctuation">,</span> <span class="token number">9001</span><span class="token punctuation">,</span> <span class="token string">'2020-01-01 18:01:01'</span><span class="token punctuation">,</span> <span class="token string">'2020-01-01 18:59:02'</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">1002</span><span class="token punctuation">,</span> <span class="token number">9003</span><span class="token punctuation">,</span> <span class="token string">'2020-05-06 12:01:01'</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">1001</span><span class="token punctuation">,</span> <span class="token number">9002</span><span class="token punctuation">,</span> <span class="token string">'2020-05-05 18:01:01'</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="31__98"></a>3.1 序号函数</h3> 
<ul><li>ROW_NUMBER()：顺序排序——1、2、3</li><li>RANK()：并列排序，跳过重复序号——1、1、3</li><li>DENSE_RANK()：并列排序，不跳过重复序号——1、1、2</li></ul> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> nick_name<span class="token punctuation">,</span>ei<span class="token punctuation">.</span>exam_id<span class="token punctuation">,</span>score<span class="token punctuation">,</span>
row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> nick_name <span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">desc</span><span class="token punctuation">)</span> row_ranking<span class="token punctuation">,</span>
rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> nick_name <span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">desc</span><span class="token punctuation">)</span> ranking<span class="token punctuation">,</span>
dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> nick_name <span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">desc</span><span class="token punctuation">)</span> dense_ranking
<span class="token keyword">from</span> user_info ui 
<span class="token keyword">join</span> exam_record er <span class="token keyword">on</span> ui<span class="token punctuation">.</span>uid <span class="token operator">=</span> er<span class="token punctuation">.</span>uid
<span class="token keyword">join</span> examination_info ei <span class="token keyword">on</span> er<span class="token punctuation">.</span>exam_id <span class="token operator">=</span> ei<span class="token punctuation">.</span>exam_id
<span class="token keyword">where</span> score <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>
</code></pre> 
<p>结果：<br> <img src="https://images2.imgbox.com/45/66/3QhvERas_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="32__117"></a>3.2 分布函数</h3> 
<ol><li>percent_rank()</li></ol> 
<ul><li>用途：和之前的RANK()函数相关，每行按照如下公式进行计算： (rank - 1) / (rows - 1)</li></ul> 
<p>其中，rank为RANK()函数产生的序号，rows为当前窗口的记录总行数。</p> 
<ol start="2"><li>cume_dist()</li></ol> 
<ul><li>用途：分组内大于等于当前rank值的行数/分组内总行数，这个函数比percen_rank使用场景更多。</li></ul> 
<p><strong>应用场景</strong>：班级中比当前同学成绩高的学生比例是多少</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> nick_name<span class="token punctuation">,</span>ei<span class="token punctuation">.</span>exam_id<span class="token punctuation">,</span>score<span class="token punctuation">,</span>
PERCENT_RANK<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> nick_name
			      <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> score <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">percent</span><span class="token punctuation">,</span>
CUME_DIST<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> nick_name
                 <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> score <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cumdist
<span class="token keyword">from</span> user_info ui 
<span class="token keyword">join</span> exam_record er <span class="token keyword">on</span> ui<span class="token punctuation">.</span>uid <span class="token operator">=</span> er<span class="token punctuation">.</span>uid
<span class="token keyword">join</span> examination_info ei <span class="token keyword">on</span> er<span class="token punctuation">.</span>exam_id <span class="token operator">=</span> ei<span class="token punctuation">.</span>exam_id
<span class="token keyword">where</span> score <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>
</code></pre> 
<p>结果：<br> <img src="https://images2.imgbox.com/77/2c/alwx5Kjf_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="33__147"></a>3.3 前后函数</h3> 
<ul><li>lead(n) / lag(n)</li><li>用途：分组中位于当前行后n行（lead）/ 前n行(lag)的记录值。</li><li>应用场景：求每个用户相邻两次浏览的时间差</li></ul> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> nick_name<span class="token punctuation">,</span>ei<span class="token punctuation">.</span>exam_id<span class="token punctuation">,</span>score<span class="token punctuation">,</span>
 lead<span class="token punctuation">(</span>score<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> nick_name
                              <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> score <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">as</span> leadVal<span class="token punctuation">,</span>
 lag<span class="token punctuation">(</span>score<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> nick_name
                             <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> score <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">as</span> lagVal
<span class="token keyword">from</span> user_info ui 
<span class="token keyword">join</span> exam_record er <span class="token keyword">on</span> ui<span class="token punctuation">.</span>uid <span class="token operator">=</span> er<span class="token punctuation">.</span>uid
<span class="token keyword">join</span> examination_info ei <span class="token keyword">on</span> er<span class="token punctuation">.</span>exam_id <span class="token operator">=</span> ei<span class="token punctuation">.</span>exam_id
<span class="token keyword">where</span> score <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>
</code></pre> 
<p>结果：<br> <img src="https://images2.imgbox.com/bc/bf/gNadV10G_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="34__171"></a>3.4 头尾函数</h3> 
<ul><li>first_val(expr) / last_val(expr)</li><li>用途：得到分区中的第一个/最后一个指定参数的值</li></ul> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> nick_name<span class="token punctuation">,</span>ei<span class="token punctuation">.</span>exam_id<span class="token punctuation">,</span>score<span class="token punctuation">,</span>
  FIRST_VALUE<span class="token punctuation">(</span>score<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> nick_name
                                   <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> score <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">as</span> firstVal<span class="token punctuation">,</span>
       LAST_VALUE<span class="token punctuation">(</span>score<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> nick_name
                                  <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> score <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">as</span> lastVal
<span class="token keyword">from</span> user_info ui 
<span class="token keyword">join</span> exam_record er <span class="token keyword">on</span> ui<span class="token punctuation">.</span>uid <span class="token operator">=</span> er<span class="token punctuation">.</span>uid
<span class="token keyword">join</span> examination_info ei <span class="token keyword">on</span> er<span class="token punctuation">.</span>exam_id <span class="token operator">=</span> ei<span class="token punctuation">.</span>exam_id
<span class="token keyword">where</span> score <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>

</code></pre> 
<p>结果：</p> 
<p><img src="https://images2.imgbox.com/59/78/NPWM0Du6_o.png" alt="在这里插入图片描述"><br> 截止到第二行，第一个记录为90分，最后一个记录为90分；</p> 
<p>截止到第四行，第一个记录为90分，最后一个记录为81分.</p> 
<h3><a id="35__197"></a>3.5 其他函数</h3> 
<ol><li>nth_value(expr, n)</li></ol> 
<ul><li>用途：返回窗口中第N个expr的值，expr可以是表达式，也可以是列名</li></ul> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> nick_name<span class="token punctuation">,</span>ei<span class="token punctuation">.</span>exam_id<span class="token punctuation">,</span>score<span class="token punctuation">,</span>
  nth_value<span class="token punctuation">(</span>score<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> nick_name
                                   <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> score <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token number">1</span>th<span class="token punctuation">,</span>
       nth_value<span class="token punctuation">(</span>score<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> nick_name
                                   <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> score <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token number">2</span>th
<span class="token keyword">from</span> user_info ui 
<span class="token keyword">join</span> exam_record er <span class="token keyword">on</span> ui<span class="token punctuation">.</span>uid <span class="token operator">=</span> er<span class="token punctuation">.</span>uid
<span class="token keyword">join</span> examination_info ei <span class="token keyword">on</span> er<span class="token punctuation">.</span>exam_id <span class="token operator">=</span> ei<span class="token punctuation">.</span>exam_id
<span class="token keyword">where</span> score <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>

</code></pre> 
<ul><li>结果：</li></ul> 
<p><img src="https://images2.imgbox.com/42/20/eSSdw5XP_o.png" alt="在这里插入图片描述"><br> 2. nfile()</p> 
<ul><li>用途：将分区中的有序数据分为n个桶，记录桶号。</li><li>此函数在数据分析中应用较多，比如由于数据量大，需要将数据平均分配到N个并行的进程分别计算，此时就可以用NFILE(N)对数据进行分组，由于记录数不一定被N整除，所以数据不一定完全平均，多出来的部分则依次加给第一组、第二组···直到分配完。</li></ul> 
<h3><a id="36__226"></a>3.6 聚类窗口函数</h3> 
<p>聚和窗口函数和上面提到的专用窗口函数用法完全相同，只需要把聚合函数写在窗口函数的位置即可，但是函数后面括号里面不能为空，需要指定聚合的列名。</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
   <span class="token function">sum</span><span class="token punctuation">(</span>成绩<span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> 学号<span class="token punctuation">)</span> <span class="token keyword">as</span> current_sum<span class="token punctuation">,</span>
   <span class="token function">avg</span><span class="token punctuation">(</span>成绩<span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> 学号<span class="token punctuation">)</span> <span class="token keyword">as</span> current_avg<span class="token punctuation">,</span>
   <span class="token function">count</span><span class="token punctuation">(</span>成绩<span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> 学号<span class="token punctuation">)</span> <span class="token keyword">as</span> current_count<span class="token punctuation">,</span>
   <span class="token function">max</span><span class="token punctuation">(</span>成绩<span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> 学号<span class="token punctuation">)</span> <span class="token keyword">as</span> current_max<span class="token punctuation">,</span>
   <span class="token function">min</span><span class="token punctuation">(</span>成绩<span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> 学号<span class="token punctuation">)</span> <span class="token keyword">as</span> current_min
<span class="token keyword">from</span> 班级表
</code></pre> 
<p><img src="https://images2.imgbox.com/71/ae/yHwJpzh1_o.png" alt="在这里插入图片描述"><br> 聚合函数作为窗口函数，可以在每一行的数据里直观的看到，截止到本行数据，统计数据是多少（最大值、最小值等）。同时可以看出每一行数据，对整体统计数据的影响。</p> 
<p>参考链接：<a href="https://zhuanlan.zhihu.com/p/120269203" rel="nofollow">狗哥数据分析</a><br> 数据来源：<a href="https://www.nowcoder.com/exam/oj?page=1&amp;tab=SQL%E7%AF%87&amp;topicId=240" rel="nofollow">牛客网</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f0218f3852d172f777c3bc2c6ae0bd79/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">查看模型训练时gpu利用率</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/17a940942aacad3958a5409e08a2ac04/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">在GitHub上学黑客 --- 黑客成长技术清单</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>