<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>深度学习 Day14——P3天气识别 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="深度学习 Day14——P3天气识别" />
<meta property="og:description" content="🍨 本文为🔗365天深度学习训练营 中的学习记录博客🍖 原作者：K同学啊 | 接辅导、项目定制 文章目录 前言1 我的环境2 代码实现与执行结果2.1 前期准备2.1.1 引入库2.1.2 设置GPU（如果设备上支持GPU就使用GPU,否则使用CPU）2.1.3 导入数据2.1.4 可视化数据2.1.4 图像数据变换2.1.4 划分数据集2.1.4 加载数据2.1.4 查看数据 2.2 构建CNN网络模型2.3 训练模型2.3.1 训练模型2.3.2 编写训练函数2.3.3 编写测试函数2.3.4 正式训练 2.4 结果可视化 3 知识点详解3.1 torchvision.transforms.Compose()详解3.2 pathlib中glob匹配多个格式文件获取数据列表3.3 plt.tight_layout()作用3.4 x.view()函数3.5 The freeze_support error解决方案3.6 提升测试acc--改变优化器 总结 前言 本文将采用pytorch框架创建CNN网络，实现天气识别。讲述实现代码与执行结果，并浅谈涉及知识点。
关键字： torchvision.transforms.Compose()详解,pathlib中glob匹配多个格式文件获取数据列表,plt.tight_layout()作用,x.view()函数，The freeze_support error解决方案，提升测试acc–改变优化器。
1 我的环境 电脑系统：Windows 11语言环境：python 3.8.6编译器：pycharm2020.2.3深度学习环境：
torch == 1.9.1&#43;cu111
torchvision == 0.10.1&#43;cu111显卡：NVIDIA GeForce RTX 4070 2 代码实现与执行结果 2.1 前期准备 2.1.1 引入库 import torch import torch.nn as nn from torchvision import transforms, datasets import os from pathlib import Path from PIL import Image from torchinfo import summary import torch." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/888b5c8a072037923de5bf2fbd2c3604/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-14T11:40:30+08:00" />
<meta property="article:modified_time" content="2023-12-14T11:40:30+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">深度学习 Day14——P3天气识别</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <ul><li><strong>🍨 本文为<a href="https://mp.weixin.qq.com/s/Nb93582M_5usednAKp_Jtw" rel="nofollow">🔗365天深度学习训练营</a> 中的学习记录博客</strong></li><li><strong>🍖 原作者：<a href="https://mtyjkh.blog.csdn.net/" rel="nofollow">K同学啊 | 接辅导、项目定制</a></strong></li></ul> 
</blockquote> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_9" rel="nofollow">前言</a></li><li><a href="#1__14" rel="nofollow">1 我的环境</a></li><li><a href="#2__23" rel="nofollow">2 代码实现与执行结果</a></li><li><ul><li><a href="#21__24" rel="nofollow">2.1 前期准备</a></li><li><ul><li><a href="#211__25" rel="nofollow">2.1.1 引入库</a></li><li><a href="#212_GPUGPUGPUCPU_47" rel="nofollow">2.1.2 设置GPU（如果设备上支持GPU就使用GPU,否则使用CPU）</a></li><li><a href="#213__61" rel="nofollow">2.1.3 导入数据</a></li><li><a href="#214__77" rel="nofollow">2.1.4 可视化数据</a></li><li><a href="#214__99" rel="nofollow">2.1.4 图像数据变换</a></li><li><a href="#214__130" rel="nofollow">2.1.4 划分数据集</a></li><li><a href="#214___147" rel="nofollow">2.1.4 加载数据</a></li><li><a href="#214__162" rel="nofollow">2.1.4 查看数据</a></li></ul> 
   </li><li><a href="#22_CNN_179" rel="nofollow">2.2 构建CNN网络模型</a></li><li><a href="#23__258" rel="nofollow">2.3 训练模型</a></li><li><ul><li><a href="#231__259" rel="nofollow">2.3.1 训练模型</a></li><li><a href="#232__269" rel="nofollow">2.3.2 编写训练函数</a></li><li><a href="#233__302" rel="nofollow">2.3.3 编写测试函数</a></li><li><a href="#234__331" rel="nofollow">2.3.4 正式训练</a></li></ul> 
   </li><li><a href="#24__383" rel="nofollow">2.4 结果可视化</a></li></ul> 
  </li><li><a href="#3__408" rel="nofollow">3 知识点详解</a></li><li><ul><li><a href="#31_torchvisiontransformsCompose_409" rel="nofollow">3.1 torchvision.transforms.Compose()详解</a></li><li><a href="#32_pathlibglob_438" rel="nofollow">3.2 pathlib中glob匹配多个格式文件获取数据列表</a></li><li><a href="#33_plttight_layout_456" rel="nofollow">3.3 plt.tight_layout()作用</a></li><li><a href="#34_xview_484" rel="nofollow">3.4 x.view()函数</a></li><li><a href="#35_The_freeze_support_error_514" rel="nofollow">3.5 The freeze_support error解决方案</a></li><li><a href="#36_acc_539" rel="nofollow">3.6 提升测试acc--改变优化器</a></li></ul> 
  </li><li><a href="#_576" rel="nofollow">总结</a></li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="_9"></a>前言</h2> 
<p>本文将采用pytorch框架创建CNN网络，实现天气识别。讲述实现代码与执行结果，并浅谈涉及知识点。<br> 关键字： torchvision.transforms.Compose()详解,pathlib中glob匹配多个格式文件获取数据列表,plt.tight_layout()作用,x.view()函数，The freeze_support error解决方案，提升测试acc–改变优化器。</p> 
<h2><a id="1__14"></a>1 我的环境</h2> 
<ul><li>电脑系统：Windows 11</li><li>语言环境：python 3.8.6</li><li>编译器：pycharm2020.2.3</li><li>深度学习环境：<br> torch == 1.9.1+cu111<br> torchvision == 0.10.1+cu111</li><li>显卡：NVIDIA GeForce RTX 4070</li></ul> 
<h2><a id="2__23"></a>2 代码实现与执行结果</h2> 
<h3><a id="21__24"></a>2.1 前期准备</h3> 
<h4><a id="211__25"></a>2.1.1 引入库</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn

<span class="token keyword">from</span> torchvision <span class="token keyword">import</span> transforms<span class="token punctuation">,</span> datasets
<span class="token keyword">import</span> os
<span class="token keyword">from</span> pathlib <span class="token keyword">import</span> Path
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">from</span> torchinfo <span class="token keyword">import</span> summary
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt

plt<span class="token punctuation">.</span>rcParams<span class="token punctuation">[</span><span class="token string">'font.sans-serif'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'SimHei'</span><span class="token punctuation">]</span>  <span class="token comment"># 用来正常显示中文标签</span>
plt<span class="token punctuation">.</span>rcParams<span class="token punctuation">[</span><span class="token string">'axes.unicode_minus'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">False</span>  <span class="token comment"># 用来正常显示负号</span>
plt<span class="token punctuation">.</span>rcParams<span class="token punctuation">[</span><span class="token string">'figure.dpi'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">100</span>  <span class="token comment"># 分辨率</span>
<span class="token keyword">import</span> warnings

warnings<span class="token punctuation">.</span>filterwarnings<span class="token punctuation">(</span><span class="token string">'ignore'</span><span class="token punctuation">)</span>  <span class="token comment"># 忽略一些warning内容，无需打印</span>
</code></pre> 
<h4><a id="212_GPUGPUGPUCPU_47"></a>2.1.2 设置GPU（如果设备上支持GPU就使用GPU,否则使用CPU）</h4> 
<pre><code class="prism language-python"><span class="token triple-quoted-string string">"""前期准备-设置GPU"""</span>
<span class="token comment"># 如果设备上支持GPU就使用GPU,否则使用CPU</span>
 device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">"cuda"</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">"cpu"</span><span class="token punctuation">)</span>
 <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Using {} device"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>输出</p> 
<pre><code>Using cuda device
</code></pre> 
<h4><a id="213__61"></a>2.1.3 导入数据</h4> 
<pre><code class="prism language-python"><span class="token triple-quoted-string string">'''前期工作-导入数据'''</span>
data_dir <span class="token operator">=</span> <span class="token string">"D:/DeepLearning/data/weather_photos/"</span>
data_dir <span class="token operator">=</span> Path<span class="token punctuation">(</span>data_dir<span class="token punctuation">)</span>

data_paths <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>data_dir<span class="token punctuation">.</span>glob<span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
classeNames <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"\\"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">for</span> path <span class="token keyword">in</span> data_paths<span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>classeNames<span class="token punctuation">)</span>
</code></pre> 
<p>输出</p> 
<pre><code>['cloudy', 'rain', 'shine', 'sunrise']
</code></pre> 
<h4><a id="214__77"></a>2.1.4 可视化数据</h4> 
<pre><code class="prism language-python"><span class="token triple-quoted-string string">'''前期工作-可视化数据'''</span>
<span class="token comment"># 指定图像文件夹路径</span>
image_folder <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>data_dir<span class="token punctuation">,</span> <span class="token string">'cloudy/'</span><span class="token punctuation">)</span>
<span class="token comment"># 获取文件夹中的所有图像文件</span>
image_files <span class="token operator">=</span> <span class="token punctuation">[</span>f <span class="token keyword">for</span> f <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>image_folder<span class="token punctuation">)</span> <span class="token keyword">if</span> f<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">".jpg"</span><span class="token punctuation">,</span> <span class="token string">".png"</span><span class="token punctuation">,</span> <span class="token string">".jpeg"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token comment"># 创建Matplotlib图像</span>
fig<span class="token punctuation">,</span> axes <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># 使用列表推导式加载和显示图像</span>
<span class="token keyword">for</span> ax<span class="token punctuation">,</span> img_file <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>axes<span class="token punctuation">.</span>flat<span class="token punctuation">,</span> image_files<span class="token punctuation">)</span><span class="token punctuation">:</span>
    img_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>image_folder<span class="token punctuation">,</span> img_file<span class="token punctuation">)</span>
    img <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>img_path<span class="token punctuation">)</span>
    ax<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
    ax<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
<span class="token comment"># 显示图像</span>
plt<span class="token punctuation">.</span>tight_layout<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/0e/cb/2cQDRpN9_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="214__99"></a>2.1.4 图像数据变换</h4> 
<pre><code class="prism language-python"><span class="token triple-quoted-string string">'''前期工作-图像数据变换'''</span>
total_datadir <span class="token operator">=</span> data_dir

<span class="token comment"># 关于transforms.Compose的更多介绍可以参考：https://blog.csdn.net/qq_38251616/article/details/124878863</span>
train_transforms <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
    transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 将输入图片resize成统一尺寸</span>
    transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 将PIL Image或numpy.ndarray转换为tensor，并归一化到[0,1]之间</span>
    transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span>  <span class="token comment"># 标准化处理--&gt;转换为标准正太分布（高斯分布），使模型更容易收敛</span>
        mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        std<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 其中 mean=[0.485,0.456,0.406]与std=[0.229,0.224,0.225] 从数据集中随机抽样计算得到的。</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
total_data <span class="token operator">=</span> datasets<span class="token punctuation">.</span>ImageFolder<span class="token punctuation">(</span>total_datadir<span class="token punctuation">,</span> transform<span class="token operator">=</span>train_transforms<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>total_data<span class="token punctuation">)</span>
</code></pre> 
<p>输出</p> 
<pre><code>Dataset ImageFolder
    Number of datapoints: 1125
    Root location: D:\DeepLearning\data\weather_photos
    StandardTransform
Transform: Compose(
               Resize(size=[224, 224], interpolation=bilinear, max_size=None, antialias=None)
               ToTensor()
               Normalize(mean=[0.485, 0.456, 0.406], std=[0.229, 0.224, 0.225])
           )
</code></pre> 
<h4><a id="214__130"></a>2.1.4 划分数据集</h4> 
<pre><code class="prism language-python"><span class="token triple-quoted-string string">'''前期工作-划分数据集'''</span>
train_size <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token number">0.8</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>total_data<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># train_size表示训练集大小，通过将总体数据长度的80%转换为整数得到；</span>
test_size <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>total_data<span class="token punctuation">)</span> <span class="token operator">-</span> train_size  <span class="token comment"># test_size表示测试集大小，是总体数据长度减去训练集大小。</span>
<span class="token comment"># 使用torch.utils.data.random_split()方法进行数据集划分。该方法将总体数据total_data按照指定的大小比例（[train_size, test_size]）随机划分为训练集和测试集，</span>
<span class="token comment"># 并将划分结果分别赋值给train_dataset和test_dataset两个变量。</span>
train_dataset<span class="token punctuation">,</span> test_dataset <span class="token operator">=</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>random_split<span class="token punctuation">(</span>total_data<span class="token punctuation">,</span> <span class="token punctuation">[</span>train_size<span class="token punctuation">,</span> test_size<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>train_dataset<span class="token punctuation">,</span> test_dataset<span class="token punctuation">)</span>

</code></pre> 
<p>输出</p> 
<pre><code>&lt;torch.utils.data.dataset.Subset object at 0x000001A0144E8D00&gt; &lt;torch.utils.data.dataset.Subset object at 0x000001A0144E8DC0&gt;
</code></pre> 
<h4><a id="214___147"></a>2.1.4 加载数据</h4> 
<pre><code class="prism language-python"><span class="token triple-quoted-string string">'''前期工作-加载数据'''</span>
batch_size <span class="token operator">=</span> <span class="token number">32</span>

train_dl <span class="token operator">=</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>train_dataset<span class="token punctuation">,</span>
                                       batch_size<span class="token operator">=</span>batch_size<span class="token punctuation">,</span>
                                       shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                                       num_workers<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
test_dl <span class="token operator">=</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>test_dataset<span class="token punctuation">,</span>
                                      batch_size<span class="token operator">=</span>batch_size<span class="token punctuation">,</span>
                                      shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                                      num_workers<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="214__162"></a>2.1.4 查看数据</h4> 
<pre><code class="prism language-python"><span class="token triple-quoted-string string">'''前期工作-查看数据'''</span>
<span class="token keyword">for</span> X<span class="token punctuation">,</span> y <span class="token keyword">in</span> test_dl<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Shape of X [N, C, H, W]: "</span><span class="token punctuation">,</span> X<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Shape of y: "</span><span class="token punctuation">,</span> y<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> y<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span>
    <span class="token keyword">break</span>
</code></pre> 
<p>输出</p> 
<pre><code>Shape of X [N, C, H, W]:  torch.Size([32, 3, 224, 224])
Shape of y:  torch.Size([32]) torch.int64
</code></pre> 
<h3><a id="22_CNN_179"></a>2.2 构建CNN网络模型</h3> 
<p><img src="https://images2.imgbox.com/02/75/OheJBSoC_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python"><span class="token triple-quoted-string string">"""构建CNN网络"""</span>
<span class="token keyword">class</span> <span class="token class-name">Network_bn</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>Network_bn<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">"""
        nn.Conv2d()函数：
        第一个参数（in_channels）是输入的channel数量
        第二个参数（out_channels）是输出的channel数量
        第三个参数（kernel_size）是卷积核大小
        第四个参数（stride）是步长，默认为1
        第五个参数（padding）是填充大小，默认为0
        """</span>
        self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> out_channels<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bn1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">,</span> out_channels<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bn2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pool <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv4 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">,</span> out_channels<span class="token operator">=</span><span class="token number">24</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bn4 <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv5 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">24</span><span class="token punctuation">,</span> out_channels<span class="token operator">=</span><span class="token number">24</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bn5 <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">24</span> <span class="token operator">*</span> <span class="token number">50</span> <span class="token operator">*</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>classeNames<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>bn1<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>bn2<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv2<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>pool<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>bn4<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv4<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>bn5<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv5<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>pool<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> x<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">50</span> <span class="token operator">*</span> <span class="token number">50</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>fc1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

        <span class="token keyword">return</span> x
        
model <span class="token operator">=</span> Network_bn<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span>
summary<span class="token punctuation">(</span>model<span class="token punctuation">)</span>        
</code></pre> 
<p>输出</p> 
<pre><code>Network_bn(
  (conv1): Conv2d(3, 12, kernel_size=(5, 5), stride=(1, 1))
  (bn1): BatchNorm2d(12, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
  (conv2): Conv2d(12, 12, kernel_size=(5, 5), stride=(1, 1))
  (bn2): BatchNorm2d(12, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
  (pool): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)
  (conv4): Conv2d(12, 24, kernel_size=(5, 5), stride=(1, 1))
  (bn4): BatchNorm2d(24, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
  (conv5): Conv2d(24, 24, kernel_size=(5, 5), stride=(1, 1))
  (bn5): BatchNorm2d(24, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
  (fc1): Linear(in_features=60000, out_features=4, bias=True)
)
=================================================================
Layer (type:depth-idx)                   Param #
=================================================================
Network_bn                               --
├─Conv2d: 1-1                            912
├─BatchNorm2d: 1-2                       24
├─Conv2d: 1-3                            3,612
├─BatchNorm2d: 1-4                       24
├─MaxPool2d: 1-5                         --
├─Conv2d: 1-6                            7,224
├─BatchNorm2d: 1-7                       48
├─Conv2d: 1-8                            14,424
├─BatchNorm2d: 1-9                       48
├─Linear: 1-10                           240,004
=================================================================
Total params: 266,320
Trainable params: 266,320
Non-trainable params: 0
=================================================================
</code></pre> 
<h3><a id="23__258"></a>2.3 训练模型</h3> 
<h4><a id="231__259"></a>2.3.1 训练模型</h4> 
<pre><code class="prism language-python"><span class="token triple-quoted-string string">"""训练模型--设置超参数"""</span>
loss_fn <span class="token operator">=</span> nn<span class="token punctuation">.</span>CrossEntropyLoss<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 创建损失函数，计算实际输出和真实相差多少，交叉熵损失函数，事实上，它就是做图片分类任务时常用的损失函数</span>
learn_rate <span class="token operator">=</span> <span class="token number">1e-4</span>  <span class="token comment"># 学习率</span>
opt <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>SGD<span class="token punctuation">(</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>learn_rate<span class="token punctuation">)</span>  <span class="token comment"># 作用是定义优化器，用来训练时候优化模型参数；其中，SGD表示随机梯度下降，用于控制实际输出y与真实y之间的相差有多大</span>

</code></pre> 
<h4><a id="232__269"></a>2.3.2 编写训练函数</h4> 
<pre><code class="prism language-python"><span class="token triple-quoted-string string">"""训练模型--编写训练函数"""</span>
<span class="token comment"># 训练循环</span>
<span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>dataloader<span class="token punctuation">,</span> model<span class="token punctuation">,</span> loss_fn<span class="token punctuation">,</span> optimizer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    size <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>dataloader<span class="token punctuation">.</span>dataset<span class="token punctuation">)</span>  <span class="token comment"># 训练集的大小，一共60000张图片</span>
    num_batches <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>dataloader<span class="token punctuation">)</span>  <span class="token comment"># 批次数目，1875（60000/32）</span>

    train_loss<span class="token punctuation">,</span> train_acc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>  <span class="token comment"># 初始化训练损失和正确率</span>

    <span class="token keyword">for</span> X<span class="token punctuation">,</span> y <span class="token keyword">in</span> dataloader<span class="token punctuation">:</span>  <span class="token comment"># 加载数据加载器，得到里面的 X（图片数据）和 y（真实标签）</span>
        X<span class="token punctuation">,</span> y <span class="token operator">=</span> X<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">,</span> y<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span> <span class="token comment"># 用于将数据存到显卡</span>

        <span class="token comment"># 计算预测误差</span>
        pred <span class="token operator">=</span> model<span class="token punctuation">(</span>X<span class="token punctuation">)</span>  <span class="token comment"># 网络输出</span>
        loss <span class="token operator">=</span> loss_fn<span class="token punctuation">(</span>pred<span class="token punctuation">,</span> y<span class="token punctuation">)</span>  <span class="token comment"># 计算网络输出和真实值之间的差距，targets为真实值，计算二者差值即为损失</span>

        <span class="token comment"># 反向传播</span>
        optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 清空过往梯度</span>
        loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 反向传播，计算当前梯度</span>
        optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 根据梯度更新网络参数</span>

        <span class="token comment"># 记录acc与loss</span>
        train_acc <span class="token operator">+=</span> <span class="token punctuation">(</span>pred<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> y<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
        train_loss <span class="token operator">+=</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>

    train_acc <span class="token operator">/=</span> size
    train_loss <span class="token operator">/=</span> num_batches

    <span class="token keyword">return</span> train_acc<span class="token punctuation">,</span> train_loss
</code></pre> 
<h4><a id="233__302"></a>2.3.3 编写测试函数</h4> 
<pre><code class="prism language-python"><span class="token triple-quoted-string string">"""训练模型--编写测试函数"""</span>
<span class="token comment"># 测试函数和训练函数大致相同，但是由于不进行梯度下降对网络权重进行更新，所以不需要传入优化器</span>
<span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span>dataloader<span class="token punctuation">,</span> model<span class="token punctuation">,</span> loss_fn<span class="token punctuation">)</span><span class="token punctuation">:</span>
    size <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>dataloader<span class="token punctuation">.</span>dataset<span class="token punctuation">)</span>  <span class="token comment"># 测试集的大小，一共10000张图片</span>
    num_batches <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>dataloader<span class="token punctuation">)</span>  <span class="token comment"># 批次数目，313（10000/32=312.5，向上取整）</span>
    test_loss<span class="token punctuation">,</span> test_acc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>

    <span class="token comment"># 当不进行训练时，停止梯度更新，节省计算内存消耗</span>
    <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># 测试时模型参数不用更新，所以 no_grad，整个模型参数正向推就ok，不反向更新参数</span>
        <span class="token keyword">for</span> imgs<span class="token punctuation">,</span> target <span class="token keyword">in</span> dataloader<span class="token punctuation">:</span>
            imgs<span class="token punctuation">,</span> target <span class="token operator">=</span> imgs<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">,</span> target<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>

            <span class="token comment"># 计算loss</span>
            target_pred <span class="token operator">=</span> model<span class="token punctuation">(</span>imgs<span class="token punctuation">)</span>
            loss <span class="token operator">=</span> loss_fn<span class="token punctuation">(</span>target_pred<span class="token punctuation">,</span> target<span class="token punctuation">)</span>

            test_loss <span class="token operator">+=</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
            test_acc <span class="token operator">+=</span> <span class="token punctuation">(</span>target_pred<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> target<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#统计预测正确的个数</span>

    test_acc <span class="token operator">/=</span> size
    test_loss <span class="token operator">/=</span> num_batches

    <span class="token keyword">return</span> test_acc<span class="token punctuation">,</span> test_loss

</code></pre> 
<h4><a id="234__331"></a>2.3.4 正式训练</h4> 
<pre><code class="prism language-python"><span class="token triple-quoted-string string">"""训练模型--正式训练"""</span>
epochs <span class="token operator">=</span> <span class="token number">20</span>
train_loss <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
train_acc <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
test_loss <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
test_acc <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>
    epoch_train_acc<span class="token punctuation">,</span> epoch_train_loss <span class="token operator">=</span> train<span class="token punctuation">(</span>train_dl<span class="token punctuation">,</span> model<span class="token punctuation">,</span> loss_fn<span class="token punctuation">,</span> opt<span class="token punctuation">)</span>

    model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    epoch_test_acc<span class="token punctuation">,</span> epoch_test_loss <span class="token operator">=</span> test<span class="token punctuation">(</span>test_dl<span class="token punctuation">,</span> model<span class="token punctuation">,</span> loss_fn<span class="token punctuation">)</span>

    train_acc<span class="token punctuation">.</span>append<span class="token punctuation">(</span>epoch_train_acc<span class="token punctuation">)</span>
    train_loss<span class="token punctuation">.</span>append<span class="token punctuation">(</span>epoch_train_loss<span class="token punctuation">)</span>
    test_acc<span class="token punctuation">.</span>append<span class="token punctuation">(</span>epoch_test_acc<span class="token punctuation">)</span>
    test_loss<span class="token punctuation">.</span>append<span class="token punctuation">(</span>epoch_test_loss<span class="token punctuation">)</span>

    template <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'Epoch:{:2d}, Train_acc:{:.1f}%, Train_loss:{:.3f}, Test_acc:{:.1f}%，Test_loss:{:.3f}'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> epoch_train_acc <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">,</span> epoch_train_loss<span class="token punctuation">,</span> epoch_test_acc <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">,</span> epoch_test_loss<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Done'</span><span class="token punctuation">)</span>
</code></pre> 
<p>输出</p> 
<pre><code>Epoch: 1, Train_acc:55.8%, Train_loss:1.098, Test_acc:58.7%，Test_loss:1.073
Epoch: 2, Train_acc:79.8%, Train_loss:0.682, Test_acc:74.2%，Test_loss:1.073
Epoch: 3, Train_acc:83.7%, Train_loss:0.536, Test_acc:78.2%，Test_loss:0.552
Epoch: 4, Train_acc:85.3%, Train_loss:0.472, Test_acc:80.9%，Test_loss:0.466
Epoch: 5, Train_acc:88.4%, Train_loss:0.412, Test_acc:82.7%，Test_loss:0.477
Epoch: 6, Train_acc:88.8%, Train_loss:0.367, Test_acc:88.0%，Test_loss:0.418
Epoch: 7, Train_acc:90.7%, Train_loss:0.318, Test_acc:88.4%，Test_loss:0.411
Epoch: 8, Train_acc:91.4%, Train_loss:0.288, Test_acc:86.2%，Test_loss:0.371
Epoch: 9, Train_acc:91.8%, Train_loss:0.289, Test_acc:86.7%，Test_loss:0.377
Epoch:10, Train_acc:91.4%, Train_loss:0.282, Test_acc:89.3%，Test_loss:0.342
Epoch:11, Train_acc:93.1%, Train_loss:0.248, Test_acc:89.3%，Test_loss:0.332
Epoch:12, Train_acc:93.6%, Train_loss:0.230, Test_acc:87.6%，Test_loss:0.344
Epoch:13, Train_acc:94.8%, Train_loss:0.216, Test_acc:88.9%，Test_loss:0.381
Epoch:14, Train_acc:94.2%, Train_loss:0.206, Test_acc:87.6%，Test_loss:0.340
Epoch:15, Train_acc:94.8%, Train_loss:0.199, Test_acc:88.4%，Test_loss:0.316
Epoch:16, Train_acc:94.7%, Train_loss:0.205, Test_acc:88.4%，Test_loss:0.475
Epoch:17, Train_acc:95.7%, Train_loss:0.222, Test_acc:86.7%，Test_loss:0.340
Epoch:18, Train_acc:96.1%, Train_loss:0.200, Test_acc:88.0%，Test_loss:0.319
Epoch:19, Train_acc:95.4%, Train_loss:0.182, Test_acc:88.4%，Test_loss:0.337
Epoch:20, Train_acc:96.8%, Train_loss:0.192, Test_acc:89.3%，Test_loss:0.304
Done
</code></pre> 
<h3><a id="24__383"></a>2.4 结果可视化</h3> 
<pre><code class="prism language-python"><span class="token triple-quoted-string string">"""训练模型--结果可视化"""</span>
epochs_range <span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span>epochs<span class="token punctuation">)</span>

plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>epochs_range<span class="token punctuation">,</span> train_acc<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Training Accuracy'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>epochs_range<span class="token punctuation">,</span> test_acc<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Test Accuracy'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span>loc<span class="token operator">=</span><span class="token string">'lower right'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Training and Validation Accuracy'</span><span class="token punctuation">)</span>

plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>epochs_range<span class="token punctuation">,</span> train_loss<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Training Loss'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>epochs_range<span class="token punctuation">,</span> test_loss<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Test Loss'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span>loc<span class="token operator">=</span><span class="token string">'upper right'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Training and Validation Loss'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/b9/85/LRTSifbD_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="3__408"></a>3 知识点详解</h2> 
<h3><a id="31_torchvisiontransformsCompose_409"></a>3.1 torchvision.transforms.Compose()详解</h3> 
<p>torchvision是pytorch的一个图形库，它服务于PyTorch深度学习框架的，主要用来构建计算机视觉模型。torchvision.transforms主要是用于常见的一些图形变换。以下是torchvision的构成：</p> 
<p>1.torchvision.datasets: 一些加载数据的函数及常用的数据集接口；<br> 2.torchvision.models: 包含常用的模型结构（含预训练模型），例如AlexNet、VGG、ResNet等；<br> 3.torchvision.transforms: 常用的图片变换，例如裁剪、旋转等；<br> 4.torchvision.utils: 其他的一些有用的方法。</p> 
<pre><code class="prism language-python">torchvision<span class="token punctuation">.</span>transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">)</span>类的主要作用是串联多个图片变换的操作。

<span class="token keyword">from</span> torchvision<span class="token punctuation">.</span>transforms <span class="token keyword">import</span> transforms

train_transforms <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
    transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                  <span class="token comment"># 将输入图片resize成统一尺寸</span>
    transforms<span class="token punctuation">.</span>RandomRotation<span class="token punctuation">(</span>degrees<span class="token operator">=</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment"># 随机旋转，-10到10度之间随机选</span>
    transforms<span class="token punctuation">.</span>RandomHorizontalFlip<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>         <span class="token comment"># 随机水平翻转 选择一个概率概率</span>
    transforms<span class="token punctuation">.</span>RandomVerticalFlip<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>           <span class="token comment"># 随机垂直翻转</span>
    transforms<span class="token punctuation">.</span>RandomPerspective<span class="token punctuation">(</span>distortion_scale<span class="token operator">=</span><span class="token number">0.6</span><span class="token punctuation">,</span> p<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment"># 随机视角</span>
    transforms<span class="token punctuation">.</span>GaussianBlur<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sigma<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 随机选择的高斯模糊模糊图像</span>
    transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>          <span class="token comment"># 将PIL Image或numpy.ndarray转换为tensor，并归一化到[0,1]之间</span>
    transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span>           <span class="token comment"># 标准化处理--&gt;转换为标准正太分布（高斯分布），使模型更容易收敛</span>
        mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
        std <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 其中 mean=[0.485,0.456,0.406]与std=[0.229,0.224,0.225] 从数据集中随机抽样计算得到的。</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p>参考链接:<a href="https://blog.csdn.net/qq_38251616/article/details/124878863">torchvision.transforms.Compose()详解【Pytorch入门手册】</a></p> 
<h3><a id="32_pathlibglob_438"></a>3.2 pathlib中glob匹配多个格式文件获取数据列表</h3> 
<p>可视化数据可用另一种方式显示</p> 
<pre><code class="prism language-python"><span class="token triple-quoted-string string">'''数据预处理-可视化数据'''</span>
    cloudyPath <span class="token operator">=</span> Path<span class="token punctuation">(</span>data_dir<span class="token punctuation">)</span><span class="token operator">/</span><span class="token string">"cloudy"</span>
    image_files <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>resolve<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> p <span class="token keyword">in</span> cloudyPath<span class="token punctuation">.</span>glob<span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">)</span> <span class="token keyword">if</span> p<span class="token punctuation">.</span>suffix <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">".jpg"</span><span class="token punctuation">,</span> <span class="token string">".png"</span><span class="token punctuation">,</span> <span class="token string">".jpeg"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>image_files<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">24</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        image_file <span class="token operator">=</span> image_files<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        ax <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
        img <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>image_file<span class="token punctuation">)</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">"off"</span><span class="token punctuation">)</span>
    <span class="token comment"># 显示图片</span>
    plt<span class="token punctuation">.</span>tight_layout<span class="token punctuation">(</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="33_plttight_layout_456"></a>3.3 plt.tight_layout()作用</h3> 
<p>tight_layout会自动调整子图参数，使之填充整个图像区域。这是个实验特性，可能在一些情况下不工作。它仅仅检查坐标轴标签、刻度标签以及标题的部分。</p> 
<p>当你拥有多个子图时，你会经常看到不同轴域的标签叠在一起。</p> 
<pre><code class="prism language-python">plt<span class="token punctuation">.</span>rcParams<span class="token punctuation">[</span><span class="token string">'savefig.facecolor'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"0.8"</span>

<span class="token keyword">def</span> <span class="token function">example_plot</span><span class="token punctuation">(</span>ax<span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
     ax<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
     ax<span class="token punctuation">.</span>locator_params<span class="token punctuation">(</span>nbins<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
     ax<span class="token punctuation">.</span>set_xlabel<span class="token punctuation">(</span><span class="token string">'x-label'</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span>fontsize<span class="token punctuation">)</span>
     ax<span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">'y-label'</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span>fontsize<span class="token punctuation">)</span>
     ax<span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">'Title'</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span>fontsize<span class="token punctuation">)</span>

plt<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token string">'all'</span><span class="token punctuation">)</span>
fig<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ax1<span class="token punctuation">,</span> ax2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>ax3<span class="token punctuation">,</span> ax4<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span>nrows<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> ncols<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
example_plot<span class="token punctuation">(</span>ax1<span class="token punctuation">)</span>
example_plot<span class="token punctuation">(</span>ax2<span class="token punctuation">)</span>
example_plot<span class="token punctuation">(</span>ax3<span class="token punctuation">)</span>
example_plot<span class="token punctuation">(</span>ax4<span class="token punctuation">)</span>
</code></pre> 
<p>产生图片：<br> <img src="https://images2.imgbox.com/ce/35/wcCJzX0N_o.png" alt="在这里插入图片描述"><br> 增加plt.tight_layout()会调整子图之间的间隔来减少堆叠。<br> <img src="https://images2.imgbox.com/d4/09/6eOthUCB_o.png" alt="在这里插入图片描述"><br> 参考链接：<a href="https://blog.csdn.net/love1005lin/article/details/116697085">plt.tight_layout()</a></p> 
<h3><a id="34_xview_484"></a>3.4 x.view()函数</h3> 
<p>在构建神经网络的时候，经常会用到x.view()函数，实际上view（）类似于reshape（）的用法，将张量重新规划格式，本文将简单介绍这个函数的用法。</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch

a <span class="token operator">=</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">17</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
a <span class="token operator">=</span> a<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
</code></pre> 
<p>输出</p> 
<pre><code>torch.Size([16])
tensor([ 1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15, 16])
torch.Size([4, 4])
tensor([[ 1,  2,  3,  4],
        [ 5,  6,  7,  8],
        [ 9, 10, 11, 12],
        [13, 14, 15, 16]])
</code></pre> 
<p>这里view的第一个参数有时会是-1，-1代表不确定，行数将由张量的长度除以列数决定，也就是说<br> a.view(-1,4) == a.view(4,4)<br> a.view(-1,8) == a.view(2,8)</p> 
<p>参考链接：<a href="https://blog.51cto.com/u_14597003/5988978" rel="nofollow">x.view(-1,4)</a></p> 
<h3><a id="35_The_freeze_support_error_514"></a>3.5 The freeze_support error解决方案</h3> 
<pre><code>RuntimeError:
       An attempt has been made to start a new process before the
       current process has finished its bootstrapping phase.

   This probably means that you are not using fork to start your
   child processes and you have forgotten to use the proper idiom
   in the main module:

       if __name__ == '__main__':
           freeze_support()
           ...

   The "freeze_support()" line can be omitted if the program
   is not going to be frozen to produce an executable.
</code></pre> 
<p>这个错误相信很多人都碰到过，就是，在Linux中可以很好运行的代码，在Windows中会给出这样的错误。<br> 究其原因，往往出现在multiprocess上。当程序中调用 multiprocess函数，却不是在main中时，会出现这样的报错。</p> 
<p><strong>解决方案：</strong><br> 写一个main函数，然后在if <strong>name</strong> == ‘<strong>main</strong>’:中运行这个main函数。把那些引用multiprocessing的函数作都放到main()函数里去执行就OK了。<br> 参考链接：<a href="https://juejin.cn/post/6844904195972136974" rel="nofollow">Windows freeze_support Error: An attempt has been made to start a new process</a></p> 
<h3><a id="36_acc_539"></a>3.6 提升测试acc–改变优化器</h3> 
<p>原文优化器设置为SDG</p> 
<pre><code class="prism language-python">opt <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>learn_rate<span class="token punctuation">)</span> 
</code></pre> 
<p>变更优化器为Adam后，代码如下</p> 
<pre><code class="prism language-python">opt <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>learn_rate<span class="token punctuation">)</span> 
</code></pre> 
<p>变更后，测试精度提升</p> 
<pre><code>Epoch: 2, Train_acc:84.2%, Train_loss:0.435, Test_acc:90.2%，Test_loss:0.257
Epoch: 3, Train_acc:89.1%, Train_loss:0.323, Test_acc:84.9%，Test_loss:0.481
Epoch: 4, Train_acc:89.3%, Train_loss:0.346, Test_acc:91.6%，Test_loss:0.218
Epoch: 5, Train_acc:91.3%, Train_loss:0.272, Test_acc:92.9%，Test_loss:0.271
Epoch: 6, Train_acc:96.9%, Train_loss:0.183, Test_acc:94.7%，Test_loss:0.184
Epoch: 7, Train_acc:93.8%, Train_loss:0.261, Test_acc:92.0%，Test_loss:0.312
Epoch: 8, Train_acc:95.6%, Train_loss:0.141, Test_acc:92.4%，Test_loss:0.203
Epoch: 9, Train_acc:97.2%, Train_loss:0.143, Test_acc:94.2%，Test_loss:0.170
Epoch:10, Train_acc:93.1%, Train_loss:0.224, Test_acc:93.8%，Test_loss:0.265
Epoch:11, Train_acc:95.3%, Train_loss:0.275, Test_acc:93.8%，Test_loss:0.211
Epoch:12, Train_acc:95.6%, Train_loss:0.164, Test_acc:94.7%，Test_loss:0.196
Epoch:13, Train_acc:98.2%, Train_loss:0.066, Test_acc:93.3%，Test_loss:0.432
Epoch:14, Train_acc:99.0%, Train_loss:0.052, Test_acc:95.1%，Test_loss:0.191
Epoch:15, Train_acc:98.7%, Train_loss:0.087, Test_acc:93.3%，Test_loss:0.248
Epoch:16, Train_acc:96.8%, Train_loss:0.156, Test_acc:93.8%，Test_loss:0.290
Epoch:17, Train_acc:97.7%, Train_loss:0.067, Test_acc:93.8%，Test_loss:0.268
Epoch:18, Train_acc:99.1%, Train_loss:0.036, Test_acc:94.7%，Test_loss:0.388
Epoch:19, Train_acc:99.6%, Train_loss:0.021, Test_acc:95.6%，Test_loss:0.176
Epoch:20, Train_acc:99.9%, Train_loss:0.012, Test_acc:95.1%，Test_loss:0.181
Done
</code></pre> 
<p><img src="https://images2.imgbox.com/48/e1/vAbj4JH3_o.png" alt="在这里插入图片描述"><br> 优化器的详解可以参考链接<a href="https://blog.csdn.net/LittleRuby/article/details/134843265?spm=1001.2014.3001.5502">深度学习 Day11——T11优化器对比实验</a></p> 
<h2><a id="_576"></a>总结</h2> 
<p>通过本文的学习，遇到The freeze_support error问题，网上检索该问题解决方案，顺利解决该问题，并通过改变优化器的方式，提升了原有模型的测试精度。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ac28dfbfa3d8da2c48faed473993eaa2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">深度学习 Day11——T11优化器对比实验</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/32e285f02988fb045305d8d5c946019e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">深度学习 Day17——P6好莱坞明星识别</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>