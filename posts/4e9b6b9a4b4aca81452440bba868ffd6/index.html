<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>解决 Android 8.0 系统应用无法使用WebView的问题 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="解决 Android 8.0 系统应用无法使用WebView的问题" />
<meta property="og:description" content="WebView 常用于加载简单的 html 网页，如用户协议、电子说明书等。
在 android 8.0 系统上，普通应用使用 WebView 时，正常使用没问题。
如果是系统级应用，就会报错
java.lang.UnsupportedOperationException: For security reasons, WebView is not allowed in privileged processes 解决办法有：
1.使用 hookWebView() 方法欺骗系统；
2.修改源代码；
一.使用 hookWebView() 方法欺骗系统； 使用 hookWebView() 方法欺骗系统，然后在应用的 Application 的 onCreate() 里调用此方法。 /** * 给WebViewFactory sProviderInstance赋值，避免进行进程判断而抛出异常（系统应用不能使用WebView） */ @SuppressWarnings(&#34;unchecked&#34;) public static void hookWebView() { int sdkInt = Build.VERSION.SDK_INT; try { Class&lt;?&gt; factoryClass = Class.forName(&#34;android.webkit.WebViewFactory&#34;); Field field = factoryClass.getDeclaredField(&#34;sProviderInstance&#34;); field.setAccessible(true); Object sProviderInstance = field.get(null); if (sProviderInstance !" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/4e9b6b9a4b4aca81452440bba868ffd6/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-10T14:54:50+08:00" />
<meta property="article:modified_time" content="2023-09-10T14:54:50+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">解决 Android 8.0 系统应用无法使用WebView的问题</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>WebView 常用于加载简单的 html 网页，如用户协议、电子说明书等。<br> 在 android 8.0 系统上，普通应用使用 WebView 时，正常使用没问题。<br> 如果是系统级应用，就会报错</p> 
<pre><code>java.lang.UnsupportedOperationException: For security reasons, WebView is not allowed in privileged processes
</code></pre> 
<p>解决办法有：<br> 1.使用 <code>hookWebView()</code> 方法欺骗系统；<br> 2.修改源代码；</p> 
<h2><a id="_hookWebView__10"></a>一.使用 <code>hookWebView()</code> 方法欺骗系统；</h2> 
<ol><li>使用 <code>hookWebView()</code> 方法欺骗系统，然后在应用的 <code>Application</code> 的 <code>onCreate()</code> 里调用此方法。</li></ol> 
<pre><code>	/**
     * 给WebViewFactory sProviderInstance赋值，避免进行进程判断而抛出异常（系统应用不能使用WebView）
     */
    @SuppressWarnings("unchecked")
    public static void hookWebView() {
        int sdkInt = Build.VERSION.SDK_INT;
        try {
            Class&lt;?&gt; factoryClass = Class.forName("android.webkit.WebViewFactory");
            Field field = factoryClass.getDeclaredField("sProviderInstance");
            field.setAccessible(true);
            Object sProviderInstance = field.get(null);
            if (sProviderInstance != null) {
                Log.i(TAG, "sProviderInstance isn't null");
                return;
            }

            Method getProviderClassMethod;
            if (sdkInt &gt; 22) {
                getProviderClassMethod = factoryClass.getDeclaredMethod("getProviderClass");
            } else if (sdkInt == 22) {
                getProviderClassMethod = factoryClass.getDeclaredMethod("getFactoryClass");
            } else {
                Log.i(TAG, "Don't need to Hook WebView");
                return;
            }
            getProviderClassMethod.setAccessible(true);
            Class&lt;?&gt; factoryProviderClass = (Class&lt;?&gt;) getProviderClassMethod.invoke(factoryClass);
            Class&lt;?&gt; delegateClass = Class.forName("android.webkit.WebViewDelegate");
            Constructor&lt;?&gt; delegateConstructor = delegateClass.getDeclaredConstructor();
            delegateConstructor.setAccessible(true);
            if (sdkInt &lt; 26) {//低于Android O版本
                Constructor&lt;?&gt; providerConstructor = factoryProviderClass.getConstructor(delegateClass);
                if (providerConstructor != null) {
                    providerConstructor.setAccessible(true);
                    sProviderInstance = providerConstructor.newInstance(delegateConstructor.newInstance());
                }
            } else {
                Field chromiumMethodName = factoryClass.getDeclaredField("CHROMIUM_WEBVIEW_FACTORY_METHOD");
                chromiumMethodName.setAccessible(true);
                String chromiumMethodNameStr = (String) chromiumMethodName.get(null);
                if (chromiumMethodNameStr == null) {
                    chromiumMethodNameStr = "create";
                }
                Method staticFactory = factoryProviderClass.getMethod(chromiumMethodNameStr, delegateClass);
                if (staticFactory != null) {
                    sProviderInstance = staticFactory.invoke(null, delegateConstructor.newInstance());
                }
            }

            if (sProviderInstance != null) {
                field.set("sProviderInstance", sProviderInstance);
                Log.i(TAG, "Hook success!");
            } else {
                Log.i(TAG, "Hook failed!");
            }
        } catch (Throwable e) {
            Log.w(TAG, e);
        }
    }
</code></pre> 
<p>2.我已经这样改了，又有新问题出现了。<br> 我是在 Setting 应用中添加，报错如下：</p> 
<pre><code>Caused by: java.lang.IllegalArgumentException: WebView cannot be used with device protected storage
</code></pre> 
<p>删除 <code>AndroidManifest.xml</code> 文件里的 <code>android:defaultToDeviceProtectedStorage="true"</code>配置即可。<br> 测试之后发现，不用在 <code>Application</code> 里调用 <code>hookWebView()</code> 方法，<br> 在使用 <code>WebView</code> 的 <code>Activity</code> 里调用也会生效。</p> 
<h2><a id="_85"></a>二.修改源代码</h2> 
<p>搜索异常提示 <code>"For security reasons, WebView is not allowed in privileged processes"</code> 得知，<br> 是在 <code>frameworks/base/core/java/android/webkit/WebViewFactory.java</code> 的<br> <code>static WebViewFactoryProvider getProvider() {}</code> 方法中抛出的，</p> 
<pre><code>static WebViewFactoryProvider getProvider() {
        synchronized (sProviderLock) {
            // For now the main purpose of this function (and the factory abstraction) is to keep
            // us honest and minimize usage of WebView internals when binding the proxy.
            if (sProviderInstance != null) return sProviderInstance;

            final int uid = android.os.Process.myUid();
            if (uid == android.os.Process.ROOT_UID || uid == android.os.Process.SYSTEM_UID
                    || uid == android.os.Process.PHONE_UID || uid == android.os.Process.NFC_UID
                    || uid == android.os.Process.BLUETOOTH_UID) {
                throw new UnsupportedOperationException(
                        "For security reasons, WebView is not allowed in privileged processes");
            }
            //省略其余代码
        }
   }
</code></pre> 
<p>可以看到，如果是系统级uid，直接抛出异常。<br> 将该异常注释即可，当然，这样做不好，谨慎。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9aa7915696f1350e6d59d6bd8930fded/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【大数据】CDH环境搭建</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/076484a7a85d80973a86fda7ab1dccfc/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">冒险游戏：假期冒险公园巡游者 15 parkRanger15 CE mac中文</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>