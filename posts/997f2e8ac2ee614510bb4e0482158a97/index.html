<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>嵌入式学习笔记——STM32的USART收发字符串及串口中断 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="嵌入式学习笔记——STM32的USART收发字符串及串口中断" />
<meta property="og:description" content="USART收发字符串及串口中断 前言字符串的收发发送一个字符串接收字符串需求 利用串口实现printf 中断中断是什么串口的接收中断以及空闲中断实现代码实现效果 总结M4系列目录 前言 上一篇中，介绍了串口收发相关的寄存器，通过代码实现了一个字节的收发，本文接着上面的内容，通过功能函数实现字符串的收发，然后引入中断解决收发过程中while()死等的问题。
字符串的收发 发送一个字符串 根据昨天的字符发送函数，只需要稍作修改即可实现发送函数了，一个字符串的结尾会有一个’\0’作为结束符，所以再发送过程中，只需要判断当前发送的字符是不是结束符即可，如果不是结束符就将该位发送至电脑的串口调试助手，如果是结束符，那就意味着一个字符串发送完毕了。具体代码如下：
/******************************************* *函数名 :Usart1_Send_Str *函数功能 :串口1发送一个字符串函数 *函数参数 :u8 *str *函数返回值:无 *函数描述 : *********************************************/ void Usart1_Send_Str(u8 *str) { while(*str != &#39;\0&#39;) { Usart1_Send_Byte(*str); str&#43;&#43;; } } 接收字符串 发送字符串相对容易，接收这边，就需要借用C语言中的数组来帮忙了，因为数据是一个字符一个字符的发送过来的，每一次只能接收一个字符，所以需要使用一个数组来存接收到的位，而且串口助手在发送字符串的时候是不会给单片机发送结束符，所以还需要编程者自己规定结束符，当然，后面引入空闲中断之后就不需要这样操作了。这里笔者使用的是‘#’作为结束标志。具体实现代码如下：
/******************************************* *函数名 :Usart1_Receive_Str *函数功能 :串口1接收一个字节函数 *函数参数 :void *函数返回值:u8 str *函数描述 : *********************************************/ void Usart1_Receive_Str(void) { static u8 i=0; //等待接收完成 while(!(USART1-&gt;SR &amp; (1&lt;&lt;5))); //将数据寄存器的数据读取到数组 Str_Buff[i] = USART1-&gt;DR; i&#43;&#43;; if(Str_Buff[i-1]==&#39;#&#39;)//如果检测到结束标志‘#’ { Str_Buff[i-1]= &#39;\0&#39;;//手动给字符串添加‘\0’结束符 i=0; Usart1_Receive_Str_Flag=1;//接收完成的标志位置一 Usart1_Send_Str(Str_Buff);//将接受的数组再发回串口助手 } } 需求 使用串口调试助手发送11打开1号小灯，10关闭一号小灯，21打开二号小灯，20关闭二号小灯。效果如下：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/997f2e8ac2ee614510bb4e0482158a97/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-06T18:04:13+08:00" />
<meta property="article:modified_time" content="2023-05-06T18:04:13+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">嵌入式学习笔记——STM32的USART收发字符串及串口中断</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>USART收发字符串及串口中断</h4> 
 <ul><li><a href="#_1" rel="nofollow">前言</a></li><li><a href="#_3" rel="nofollow">字符串的收发</a></li><li><ul><li><a href="#_4" rel="nofollow">发送一个字符串</a></li><li><a href="#_24" rel="nofollow">接收字符串</a></li><li><ul><li><a href="#_52" rel="nofollow">需求</a></li></ul> 
   </li><li><a href="#printf_57" rel="nofollow">利用串口实现printf</a></li></ul> 
  </li><li><a href="#_88" rel="nofollow">中断</a></li><li><ul><li><a href="#_90" rel="nofollow">中断是什么</a></li><li><a href="#_115" rel="nofollow">串口的接收中断以及空闲中断</a></li><li><ul><li><a href="#_127" rel="nofollow">实现代码</a></li><li><a href="#_224" rel="nofollow">实现效果</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_268" rel="nofollow">总结</a></li><li><a href="#M4_270" rel="nofollow">M4系列目录</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>前言</h2> 
<p>上一篇中，介绍了串口收发相关的寄存器，通过代码实现了一个字节的收发，本文接着上面的内容，通过功能函数实现字符串的收发，然后引入中断解决收发过程中while()死等的问题。</p> 
<h2><a id="_3"></a>字符串的收发</h2> 
<h3><a id="_4"></a>发送一个字符串</h3> 
<p>根据昨天的字符发送函数，只需要稍作修改即可实现发送函数了，一个字符串的结尾会有一个’\0’作为结束符，所以再发送过程中，只需要判断当前发送的字符是不是结束符即可，如果不是结束符就将该位发送至电脑的串口调试助手，如果是结束符，那就意味着一个字符串发送完毕了。具体代码如下：</p> 
<pre><code class="prism language-javascript"><span class="token comment">/*******************************************
*函数名    :Usart1_Send_Str
*函数功能  :串口1发送一个字符串函数
*函数参数  :u8 *str
*函数返回值:无
*函数描述  :
*********************************************/</span>
<span class="token keyword">void</span> <span class="token function">Usart1_Send_Str</span><span class="token punctuation">(</span><span class="token parameter">u8 <span class="token operator">*</span>str</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">*</span>str <span class="token operator">!=</span> <span class="token string">'\0'</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">Usart1_Send_Byte</span><span class="token punctuation">(</span><span class="token operator">*</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
		str<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h3><a id="_24"></a>接收字符串</h3> 
<p>发送字符串相对容易，接收这边，就需要借用C语言中的数组来帮忙了，因为数据是一个字符一个字符的发送过来的，每一次只能接收一个字符，所以需要使用一个数组来存接收到的位，而且串口助手在发送字符串的时候是不会给单片机发送结束符，所以还需要编程者自己规定结束符，当然，后面引入空闲中断之后就不需要这样操作了。这里笔者使用的是‘#’作为结束标志。具体实现代码如下：</p> 
<pre><code class="prism language-javascript">
<span class="token comment">/*******************************************
*函数名    :Usart1_Receive_Str
*函数功能  :串口1接收一个字节函数
*函数参数  :void
*函数返回值:u8 str
*函数描述  :
*********************************************/</span>
<span class="token keyword">void</span> <span class="token function">Usart1_Receive_Str</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">void</span></span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">static</span> u8 i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token comment">//等待接收完成</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token constant">USART1</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token constant">SR</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//将数据寄存器的数据读取到数组</span>
		Str_Buff<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">USART1</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token constant">DR</span><span class="token punctuation">;</span>
		i<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>Str_Buff<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">'#'</span><span class="token punctuation">)</span><span class="token comment">//如果检测到结束标志‘#’</span>
	<span class="token punctuation">{<!-- --></span>
		Str_Buff<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span><span class="token comment">//手动给字符串添加‘\0’结束符</span>
		i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
		Usart1_Receive_Str_Flag<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//接收完成的标志位置一</span>
		<span class="token function">Usart1_Send_Str</span><span class="token punctuation">(</span>Str_Buff<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将接受的数组再发回串口助手</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_52"></a>需求</h4> 
<p>使用串口调试助手发送11打开1号小灯，10关闭一号小灯，21打开二号小灯，20关闭二号小灯。效果如下：<br> <img src="https://images2.imgbox.com/91/f0/a1kOUvPO_o.gif" alt="在这里插入图片描述"><br> 主函数代码：<br> <img src="https://images2.imgbox.com/8d/b0/P3FuNrGW_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="printf_57"></a>利用串口实现printf</h3> 
<p>在C语言的学习中，使用频率最高的输出函数就是printf了，这个函数在单片机上也同样适用，只是要改一下输出的方向，所以也叫重定向。<br> 在C中printf函数-----输出函数<br> 输出方向：PC机------&gt;屏幕<br> 在单片机中printf-------输出函数<br> 输出方向： 单片机----&gt;PC机<br> 关于具体的修改其实KEIL已经帮我们做好了，需要我们修改的只有一个，就是将“stdio.h”内的fputc，也就是字符输出函数，修改到和我们的字符串输出函数关联即可。具体代码如下：</p> 
<pre><code class="prism language-javascript"> <span class="token comment">//printf的重定向函数</span>
<span class="token comment">//fputc-----专门发送字符的函数h</span>
int <span class="token function">fputc</span><span class="token punctuation">(</span><span class="token parameter">int c<span class="token punctuation">,</span> <span class="token constant">FILE</span> <span class="token operator">*</span> stream</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">Usart1_Send_Byte</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> c<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>将此代码放到USART1.c中即可，不需要调用也不需要声明。<br> <img src="https://images2.imgbox.com/d3/31/tmdoGInX_o.png" alt="在这里插入图片描述"><br> 然后就是勾选KEIL的库，如下图所示，依次选择魔法棒、Target、然后将3所在位置的复选框锁定。<br> <img src="https://images2.imgbox.com/6c/04/sBmxLfSj_o.png" alt="在这里插入图片描述"><br> 然后再在USART1.h中添加stdio.h。<br> <img src="https://images2.imgbox.com/ab/5c/MA7vMntz_o.png" alt="在这里插入图片描述"><br> 最后在主函数中调用printf即可，printf主要是方便我们的后期调试，实用语法与C一致。<br> <img src="https://images2.imgbox.com/06/ea/kn1koNcG_o.png" alt="在这里插入图片描述"><br> 实际输出效果：<br> <img src="https://images2.imgbox.com/a0/98/Ffr6aEzG_o.png" alt="在这里插入图片描述"><br> 到这里，已经实现了字符串的收发，但是存在两个问题，<br> 1是上位机发送数据到板子上必须要设置结束符，类似笔者此处的‘#’；<br> 2是此代码在接收时会阻塞在等待接受完毕的while,这会导致其他的模块工作不正常，在while(1)内，一定要尽力避免死等的出现。<br> 很明显，现在这个代码还不太令人满意，那么要怎么修改呢，在修改代码之前，需要先去了解一个新的东西——中断。<br> <img src="https://images2.imgbox.com/b0/fe/o6Cye686_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_88"></a>中断</h2> 
<p>首先，需要知道中断是个什么东西，它有什么作用，具体怎么使用，下面一一来进行介绍。</p> 
<h3><a id="_90"></a>中断是什么</h3> 
<p>中断嘛，按照名字的第一反应是终止一件事，打断某些东西的感觉，实际上也差不多是这个意思，它终止和打断的就是前面编写的main函数里面运行的东西。<br> <img src="https://images2.imgbox.com/88/d1/xh1Agc29_o.png" alt="在这里插入图片描述"><br> 也就是说在程序正常运行过程中，出现了不正常的事件（异常），CPU会优先去处理这个异常，处理完之后再回到正常的程序中。这个异常事件就是中断。<br> 中断的目的：由外设或者CPU创造一个异常事件（紧急事件）<br> 紧急事件发生的时间和地点：未知<br> 紧急事件是实时响应的，紧急事件不能执行太久（里面不能有延时 循环 阻塞程序）<br> 下面我们来看一张图：<br> 代码正常运行的时候是如下图所示的蓝色箭头方向，首先会依次向下执行初始化代码，然后进入while循环，始终在任务1与任务2之间循环运行。</p> 
<div class="mermaid"> 
 <svg id="mermaid-svg-n2TMqP7VQHxAGnXq" width="286.8000183105469" xmlns="http://www.w3.org/2000/svg" height="62" viewbox="0 0 286.8000183105469 62" class="mermaid-svg"> 
  <style>#mermaid-svg-n2TMqP7VQHxAGnXq {font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-svg-n2TMqP7VQHxAGnXq .error-icon{fill:#552222;}#mermaid-svg-n2TMqP7VQHxAGnXq .error-text{fill:#552222;stroke:#552222;}#mermaid-svg-n2TMqP7VQHxAGnXq .edge-thickness-normal{stroke-width:2px;}#mermaid-svg-n2TMqP7VQHxAGnXq .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-n2TMqP7VQHxAGnXq .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-n2TMqP7VQHxAGnXq .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-n2TMqP7VQHxAGnXq .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-n2TMqP7VQHxAGnXq .marker{fill:#333333;stroke:#333333;}#mermaid-svg-n2TMqP7VQHxAGnXq .marker.cross{stroke:#333333;}#mermaid-svg-n2TMqP7VQHxAGnXq svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-n2TMqP7VQHxAGnXq .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#mermaid-svg-n2TMqP7VQHxAGnXq .cluster-label text{fill:#333;}#mermaid-svg-n2TMqP7VQHxAGnXq .cluster-label span{color:#333;}#mermaid-svg-n2TMqP7VQHxAGnXq .label text,#mermaid-svg-n2TMqP7VQHxAGnXq span{fill:#333;color:#333;}#mermaid-svg-n2TMqP7VQHxAGnXq .node rect,#mermaid-svg-n2TMqP7VQHxAGnXq .node circle,#mermaid-svg-n2TMqP7VQHxAGnXq .node ellipse,#mermaid-svg-n2TMqP7VQHxAGnXq .node polygon,#mermaid-svg-n2TMqP7VQHxAGnXq .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-svg-n2TMqP7VQHxAGnXq .node .label{text-align:center;}#mermaid-svg-n2TMqP7VQHxAGnXq .node.clickable{cursor:pointer;}#mermaid-svg-n2TMqP7VQHxAGnXq .arrowheadPath{fill:#333333;}#mermaid-svg-n2TMqP7VQHxAGnXq .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-svg-n2TMqP7VQHxAGnXq .flowchart-link{stroke:#333333;fill:none;}#mermaid-svg-n2TMqP7VQHxAGnXq .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-svg-n2TMqP7VQHxAGnXq .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-svg-n2TMqP7VQHxAGnXq .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-svg-n2TMqP7VQHxAGnXq .cluster text{fill:#333;}#mermaid-svg-n2TMqP7VQHxAGnXq .cluster span{color:#333;}#mermaid-svg-n2TMqP7VQHxAGnXq div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-n2TMqP7VQHxAGnXq :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style> 
  <g> 
   <g class="output"> 
    <g class="clusters"></g> 
    <g class="edgePaths"> 
     <g class="edgePath LS-任务1 LE-任务2" id="L-任务1-任务2" style="opacity: 1;"> 
      <path class="path" d="M68.4000015258789,25.528985444649607L72.56666819254558,24.774154537208005C76.73333485921223,24.019323629766404,85.06666819254558,22.509661814883202,93.4000015258789,21.7548309074416C101.73333485921223,21,110.06666819254558,21,118.4000015258789,21C126.73333485921223,21,135.06666819254556,21,143.4000015258789,21C151.73333485921225,21,160.06666819254556,21,168.4000015258789,21C176.73333485921225,21,185.06666819254556,21,193.4000015258789,21.7548309074416C201.73333485921225,22.509661814883202,210.06666819254556,24.019323629766404,214.23333485921225,24.774154537208005L218.4000015258789,25.528985444649607" marker-end="url(#arrowhead112)" style="fill:none"></path> 
      <defs> 
       <marker id="arrowhead112" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
        <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path> 
       </marker> 
      </defs> 
     </g> 
     <g class="edgePath LS-任务2 LE-任务1" style="opacity: 1;" id="L-任务2-任务1"> 
      <path class="path" d="M218.4000015258789,36.47101455535039L214.23333485921225,37.225845462791995C210.06666819254556,37.980676370233596,201.73333485921225,39.4903381851168,193.4000015258789,40.2451690925584C185.06666819254556,41,176.73333485921225,41,168.4000015258789,41C160.06666819254556,41,151.73333485921225,41,143.4000015258789,41C135.06666819254556,41,126.73333485921223,41,118.4000015258789,41C110.06666819254558,41,101.73333485921223,41,93.4000015258789,40.2451690925584C85.06666819254558,39.4903381851168,76.73333485921223,37.980676370233596,72.56666819254558,37.225845462791995L68.4000015258789,36.47101455535039" marker-end="url(#arrowhead113)" style="fill:none"></path> 
      <defs> 
       <marker id="arrowhead113" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
        <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path> 
       </marker> 
      </defs> 
     </g> 
    </g> 
    <g class="edgeLabels"> 
     <g class="edgeLabel" transform="" style="opacity: 1;"> 
      <g transform="translate(0,0)" class="label"> 
       <rect rx="0" ry="0" width="0" height="0"></rect> 
       <foreignobject width="0" height="0"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span id="L-L-任务1-任务2" class="edgeLabel L-LS-任务1' L-LE-任务2"></span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="edgeLabel" style="opacity: 1;" transform=""> 
      <g transform="translate(0,0)" class="label"> 
       <rect rx="0" ry="0" width="0" height="0"></rect> 
       <foreignobject width="0" height="0"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span id="L-L-任务2-任务1" class="edgeLabel L-LS-任务2' L-LE-任务1"></span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="nodes"> 
     <g class="node default" id="flowchart-任务1-27" transform="translate(38.20000076293945,31)" style="opacity: 1;"> 
      <rect rx="0" ry="0" x="-30.200000762939453" y="-23" width="60.400001525878906" height="46" class="label-container"></rect> 
      <g class="label" transform="translate(0,0)"> 
       <g transform="translate(-20.200000762939453,-13)"> 
        <foreignobject width="40.400001525878906" height="26"> 
         <div style="display: inline-block; white-space: nowrap;">
           任务1 
         </div> 
        </foreignobject> 
       </g> 
      </g> 
     </g> 
     <g class="node default" style="opacity: 1;" id="flowchart-任务2-28" transform="translate(248.60000228881836,31)"> 
      <rect rx="0" ry="0" x="-30.200000762939453" y="-23" width="60.400001525878906" height="46" class="label-container"></rect> 
      <g class="label" transform="translate(0,0)"> 
       <g transform="translate(-20.200000762939453,-13)"> 
        <foreignobject width="40.400001525878906" height="26"> 
         <div style="display: inline-block; white-space: nowrap;">
           任务2 
         </div> 
        </foreignobject> 
       </g> 
      </g> 
     </g> 
    </g> 
   </g> 
  </g> 
 </svg> 
</div> 
<p>-------&gt;任务2<br> 如果我们在初始化中，初始化了中断，就会有一个对应的中断服务函数，当中断的条件满足了，程序就会暂时终止main函数里面的内容，去把中断服务函数里面的内容执行完毕了再回来运行main里面的内容。<br> <img src="https://images2.imgbox.com/47/7e/UJLynmhp_o.png" alt="在这里插入图片描述"><br> 同时，从上图可以看出，当中断被初始化后，任何时刻都可能满足中断的条件，也就是在任何位置都可能会跳出main里面的内容去执行中断服务函数里面的内容。因此说它产生的时间和地点是未知的。<br> 此时代码的运行顺序就不固定了可能是从任务1跳出去执行任务3任务4后再回来执行任务2</p> 
<div class="mermaid"> 
 <svg id="mermaid-svg-Yh5e3PFoemw1EdJc" width="701.2000122070312" xmlns="http://www.w3.org/2000/svg" height="104" viewbox="9.5367431640625e-7 0 701.2000122070312 104" class="mermaid-svg"> 
  <style>#mermaid-svg-Yh5e3PFoemw1EdJc {font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-svg-Yh5e3PFoemw1EdJc .error-icon{fill:#552222;}#mermaid-svg-Yh5e3PFoemw1EdJc .error-text{fill:#552222;stroke:#552222;}#mermaid-svg-Yh5e3PFoemw1EdJc .edge-thickness-normal{stroke-width:2px;}#mermaid-svg-Yh5e3PFoemw1EdJc .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-Yh5e3PFoemw1EdJc .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-Yh5e3PFoemw1EdJc .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-Yh5e3PFoemw1EdJc .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-Yh5e3PFoemw1EdJc .marker{fill:#333333;stroke:#333333;}#mermaid-svg-Yh5e3PFoemw1EdJc .marker.cross{stroke:#333333;}#mermaid-svg-Yh5e3PFoemw1EdJc svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-Yh5e3PFoemw1EdJc .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#mermaid-svg-Yh5e3PFoemw1EdJc .cluster-label text{fill:#333;}#mermaid-svg-Yh5e3PFoemw1EdJc .cluster-label span{color:#333;}#mermaid-svg-Yh5e3PFoemw1EdJc .label text,#mermaid-svg-Yh5e3PFoemw1EdJc span{fill:#333;color:#333;}#mermaid-svg-Yh5e3PFoemw1EdJc .node rect,#mermaid-svg-Yh5e3PFoemw1EdJc .node circle,#mermaid-svg-Yh5e3PFoemw1EdJc .node ellipse,#mermaid-svg-Yh5e3PFoemw1EdJc .node polygon,#mermaid-svg-Yh5e3PFoemw1EdJc .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-svg-Yh5e3PFoemw1EdJc .node .label{text-align:center;}#mermaid-svg-Yh5e3PFoemw1EdJc .node.clickable{cursor:pointer;}#mermaid-svg-Yh5e3PFoemw1EdJc .arrowheadPath{fill:#333333;}#mermaid-svg-Yh5e3PFoemw1EdJc .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-svg-Yh5e3PFoemw1EdJc .flowchart-link{stroke:#333333;fill:none;}#mermaid-svg-Yh5e3PFoemw1EdJc .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-svg-Yh5e3PFoemw1EdJc .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-svg-Yh5e3PFoemw1EdJc .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-svg-Yh5e3PFoemw1EdJc .cluster text{fill:#333;}#mermaid-svg-Yh5e3PFoemw1EdJc .cluster span{color:#333;}#mermaid-svg-Yh5e3PFoemw1EdJc div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-Yh5e3PFoemw1EdJc :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style> 
  <g> 
   <g class="output"> 
    <g class="clusters"></g> 
    <g class="edgePaths"> 
     <g class="edgePath LS-任务1 LE-1" id="L-任务1-1" style="opacity: 1;"> 
      <path class="path" d="M464.00000190734863,75.86594221051614L459.83333524068195,78.05495184209678C455.6666685740153,80.24396147367743,447.33333524068195,84.62198073683872,436.63333527247113,86.81099036841935C425.93333530426025,89,412.8666687011719,89,399.8000020980835,89C386.7333354949951,89,373.66666889190674,89,357.933335463206,89C342.2000020345052,89,323.8000017801921,89,305.4000015258789,89C287.00000127156574,89,268.6000010172526,89,252.86666758855185,89C237.13333415985107,89,224.0666675567627,89,211.00000095367432,89C197.93333435058594,89,184.86666774749756,89,169.13333431879678,89C153.40000089009604,89,135.00000063578287,89,116.60000038146973,89C98.20000012715657,89,79.79999987284343,89,66.43333307902019,85.91751699180433C53.06666628519694,82.83503398360865,44.73333295186361,76.67006796721732,40.56666628519694,73.58758495902164L36.39999961853027,70.50510195082597" marker-end="url(#arrowhead167)" style="fill:none"></path> 
      <defs> 
       <marker id="arrowhead167" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
        <path d="M 0 0 L 0 0 L 0 0 z" style="fill: #333"></path> 
       </marker> 
      </defs> 
     </g> 
     <g class="edgePath LS-1 LE-任务3" style="opacity: 1;" id="L-1-任务3"> 
      <path class="path" d="M36.39999961853027,49.494898049174026L40.56666628519694,46.41241504097835C44.73333295186361,43.329932032782686,53.06666628519694,37.16496601639134,61.39999961853027,34.08248300819567C69.7333329518636,31,78.06666628519694,31,82.2333329518636,31L86.39999961853027,31" marker-end="url(#arrowhead168)" style="fill:none"></path> 
      <defs> 
       <marker id="arrowhead168" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
        <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path> 
       </marker> 
      </defs> 
     </g> 
     <g class="edgePath LS-任务3 LE-2" style="opacity: 1;" id="L-任务3-2"> 
      <path class="path" d="M146.80000114440918,31L150.96666781107584,31C155.13333447774252,31,163.46666781107584,31,171.80000114440918,31C180.13333447774252,31,188.46666781107584,31,192.63333447774252,31L196.80000114440918,31" marker-end="url(#arrowhead169)" style="fill:none"></path> 
      <defs> 
       <marker id="arrowhead169" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
        <path d="M 0 0 L 0 0 L 0 0 z" style="fill: #333"></path> 
       </marker> 
      </defs> 
     </g> 
     <g class="edgePath LS-2 LE-任务4" style="opacity: 1;" id="L-2-任务4"> 
      <path class="path" d="M225.20000076293945,31L229.3666674296061,31C233.5333340962728,31,241.8666674296061,31,250.20000076293945,31C258.53333409627277,31,266.86666742960614,31,271.03333409627277,31L275.20000076293945,31" marker-end="url(#arrowhead170)" style="fill:none"></path> 
      <defs> 
       <marker id="arrowhead170" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
        <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path> 
       </marker> 
      </defs> 
     </g> 
     <g class="edgePath LS-任务4 LE-3" style="opacity: 1;" id="L-任务4-3"> 
      <path class="path" d="M335.60000228881836,31L339.76666895548504,31C343.9333356221517,31,352.26666895548504,31,360.60000228881836,31C368.9333356221517,31,377.26666895548504,31,381.4333356221517,31L385.60000228881836,31" marker-end="url(#arrowhead171)" style="fill:none"></path> 
      <defs> 
       <marker id="arrowhead171" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
        <path d="M 0 0 L 0 0 L 0 0 z" style="fill: #333"></path> 
       </marker> 
      </defs> 
     </g> 
     <g class="edgePath LS-3 LE-任务1" style="opacity: 1;" id="L-3-任务1"> 
      <path class="path" d="M414.00000190734863,31L418.1666685740153,31C422.33333524068195,31,430.6666685740153,31,439.00000190734863,33.18900963158064C447.33333524068195,35.378019263161285,455.6666685740153,39.75603852632258,459.83333524068195,41.945048157903216L464.00000190734863,44.13405778948386" marker-end="url(#arrowhead172)" style="fill:none"></path> 
      <defs> 
       <marker id="arrowhead172" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
        <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path> 
       </marker> 
      </defs> 
     </g> 
     <g class="edgePath LS-任务1 LE-任务2" style="opacity: 1;" id="L-任务1-任务2"> 
      <path class="path" d="M524.4000034332275,47.4166665226941L528.5666700998942,45.68055543557841C532.7333367665609,43.94444434846273,541.0666700998942,40.47222217423137,550.1000034809113,38.73611108711568C559.1333368619283,37,568.866670290629,37,578.6000037193298,37C588.3333371480306,37,598.0666705767313,37,607.1000039577484,38.73611108711568C616.1333373387655,40.47222217423137,624.4666706720988,43.94444434846273,628.6333373387655,45.68055543557841L632.8000040054321,47.4166665226941" marker-end="url(#arrowhead173)" style="fill:none"></path> 
      <defs> 
       <marker id="arrowhead173" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
        <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path> 
       </marker> 
      </defs> 
     </g> 
     <g class="edgePath LS-任务2 LE-任务1" style="opacity: 1;" id="L-任务2-任务1"> 
      <path class="path" d="M632.8000040054321,72.5833334773059L628.6333373387655,74.31944456442159C624.4666706720988,76.05555565153726,616.1333373387655,79.52777782576864,607.1000039577484,81.26388891288433C598.0666705767313,83,588.3333371480306,83,578.6000037193298,83C568.866670290629,83,559.1333368619283,83,550.1000034809113,81.26388891288433C541.0666700998942,79.52777782576864,532.7333367665609,76.05555565153726,528.5666700998942,74.31944456442159L524.4000034332275,72.5833334773059" marker-end="url(#arrowhead174)" style="fill:none"></path> 
      <defs> 
       <marker id="arrowhead174" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
        <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path> 
       </marker> 
      </defs> 
     </g> 
    </g> 
    <g class="edgeLabels"> 
     <g class="edgeLabel" transform="" style="opacity: 1;"> 
      <g transform="translate(0,0)" class="label"> 
       <rect rx="0" ry="0" width="0" height="0"></rect> 
       <foreignobject width="0" height="0"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span id="L-L-任务1-1" class="edgeLabel L-LS-任务1' L-LE-1"></span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="edgeLabel" style="opacity: 1;" transform=""> 
      <g transform="translate(0,0)" class="label"> 
       <rect rx="0" ry="0" width="0" height="0"></rect> 
       <foreignobject width="0" height="0"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span id="L-L-1-任务3" class="edgeLabel L-LS-1' L-LE-任务3"></span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="edgeLabel" style="opacity: 1;" transform=""> 
      <g transform="translate(0,0)" class="label"> 
       <rect rx="0" ry="0" width="0" height="0"></rect> 
       <foreignobject width="0" height="0"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span id="L-L-任务3-2" class="edgeLabel L-LS-任务3' L-LE-2"></span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="edgeLabel" style="opacity: 1;" transform=""> 
      <g transform="translate(0,0)" class="label"> 
       <rect rx="0" ry="0" width="0" height="0"></rect> 
       <foreignobject width="0" height="0"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span id="L-L-2-任务4" class="edgeLabel L-LS-2' L-LE-任务4"></span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="edgeLabel" style="opacity: 1;" transform=""> 
      <g transform="translate(0,0)" class="label"> 
       <rect rx="0" ry="0" width="0" height="0"></rect> 
       <foreignobject width="0" height="0"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span id="L-L-任务4-3" class="edgeLabel L-LS-任务4' L-LE-3"></span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="edgeLabel" style="opacity: 1;" transform=""> 
      <g transform="translate(0,0)" class="label"> 
       <rect rx="0" ry="0" width="0" height="0"></rect> 
       <foreignobject width="0" height="0"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span id="L-L-3-任务1" class="edgeLabel L-LS-3' L-LE-任务1"></span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="edgeLabel" style="opacity: 1;" transform="translate(578.6000037193298,37)"> 
      <g transform="translate(-4.200000286102295,-13)" class="label"> 
       <rect rx="0" ry="0" width="8.40000057220459" height="26"></rect> 
       <foreignobject width="8.40000057220459" height="26"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span id="L-L-任务1-任务2" class="edgeLabel L-LS-任务1' L-LE-任务2">4</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="edgeLabel" style="opacity: 1;" transform="translate(578.6000037193298,83)"> 
      <g transform="translate(-4.200000286102295,-13)" class="label"> 
       <rect rx="0" ry="0" width="8.40000057220459" height="26"></rect> 
       <foreignobject width="8.40000057220459" height="26"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span id="L-L-任务2-任务1" class="edgeLabel L-LS-任务2' L-LE-任务1">5</span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="nodes"> 
     <g class="node default" id="flowchart-1-40" transform="translate(22.199999809265137,60)" style="opacity: 1;"> 
      <rect rx="0" ry="0" x="-14.200000286102295" y="-23" width="28.40000057220459" height="46" class="label-container"></rect> 
      <g class="label" transform="translate(0,0)"> 
       <g transform="translate(-4.200000286102295,-13)"> 
        <foreignobject width="8.40000057220459" height="26"> 
         <div style="display: inline-block; white-space: nowrap;">
           1 
         </div> 
        </foreignobject> 
       </g> 
      </g> 
     </g> 
     <g class="node default" style="opacity: 1;" id="flowchart-2-42" transform="translate(211.00000095367432,31)"> 
      <rect rx="0" ry="0" x="-14.200000286102295" y="-23" width="28.40000057220459" height="46" class="label-container"></rect> 
      <g class="label" transform="translate(0,0)"> 
       <g transform="translate(-4.200000286102295,-13)"> 
        <foreignobject width="8.40000057220459" height="26"> 
         <div style="display: inline-block; white-space: nowrap;">
           2 
         </div> 
        </foreignobject> 
       </g> 
      </g> 
     </g> 
     <g class="node default" style="opacity: 1;" id="flowchart-3-44" transform="translate(399.8000020980835,31)"> 
      <rect rx="0" ry="0" x="-14.200000286102295" y="-23" width="28.40000057220459" height="46" class="label-container"></rect> 
      <g class="label" transform="translate(0,0)"> 
       <g transform="translate(-4.200000286102295,-13)"> 
        <foreignobject width="8.40000057220459" height="26"> 
         <div style="display: inline-block; white-space: nowrap;">
           3 
         </div> 
        </foreignobject> 
       </g> 
      </g> 
     </g> 
     <g class="node default" style="opacity: 1;" id="flowchart-任务1-39" transform="translate(494.2000026702881,60)"> 
      <rect rx="0" ry="0" x="-30.200000762939453" y="-23" width="60.400001525878906" height="46" class="label-container"></rect> 
      <g class="label" transform="translate(0,0)"> 
       <g transform="translate(-20.200000762939453,-13)"> 
        <foreignobject width="40.400001525878906" height="26"> 
         <div style="display: inline-block; white-space: nowrap;">
           任务1 
         </div> 
        </foreignobject> 
       </g> 
      </g> 
     </g> 
     <g class="node default" style="opacity: 1;" id="flowchart-任务3-41" transform="translate(116.60000038146973,31)"> 
      <rect rx="0" ry="0" x="-30.200000762939453" y="-23" width="60.400001525878906" height="46" class="label-container"></rect> 
      <g class="label" transform="translate(0,0)"> 
       <g transform="translate(-20.200000762939453,-13)"> 
        <foreignobject width="40.400001525878906" height="26"> 
         <div style="display: inline-block; white-space: nowrap;">
           任务3 
         </div> 
        </foreignobject> 
       </g> 
      </g> 
     </g> 
     <g class="node default" style="opacity: 1;" id="flowchart-任务4-43" transform="translate(305.4000015258789,31)"> 
      <rect rx="0" ry="0" x="-30.200000762939453" y="-23" width="60.400001525878906" height="46" class="label-container"></rect> 
      <g class="label" transform="translate(0,0)"> 
       <g transform="translate(-20.200000762939453,-13)"> 
        <foreignobject width="40.400001525878906" height="26"> 
         <div style="display: inline-block; white-space: nowrap;">
           任务4 
         </div> 
        </foreignobject> 
       </g> 
      </g> 
     </g> 
     <g class="node default" style="opacity: 1;" id="flowchart-任务2-46" transform="translate(663.0000047683716,60)"> 
      <rect rx="0" ry="0" x="-30.200000762939453" y="-23" width="60.400001525878906" height="46" class="label-container"></rect> 
      <g class="label" transform="translate(0,0)"> 
       <g transform="translate(-20.200000762939453,-13)"> 
        <foreignobject width="40.400001525878906" height="26"> 
         <div style="display: inline-block; white-space: nowrap;">
           任务2 
         </div> 
        </foreignobject> 
       </g> 
      </g> 
     </g> 
    </g> 
   </g> 
  </g> 
 </svg> 
</div> 
<p>也有可能是直接就先去执行任务3，任务4后再回来执行任务1和任务2，等等还有多种可能，也就是只要初始化中断后，任何时刻，只要中断信号满足了，CPU就需要优先解决中断事件。<br> 这正是中断的意义所在，类似上面的串口接收，没有中断的话，需要一直死等，这会严重影响其他函数的运行，引入中断后，就可以通过中断来判断是否接收完成了。那么具体是怎么配置的呢。<br> 通过上面的流程图，大致分析一下，首先，肯定需要在初始化中初始化中断，然后是需要一个中断服务函数来存放异常事件，此外还需要判断对应的中断事件有没有产生。</p> 
<h3><a id="_115"></a>串口的接收中断以及空闲中断</h3> 
<p>本文主要是接着串口先体验一下中断的作用，关于STM32中断系统的详细介绍放到下一篇中。<br> 在配置串口的接收和发送的时候，串口相关的有很多寄存器是直接跳过了的，这里面就有一部分是和中断相关的，<br> 首先，来看控制寄存器1（USART1-CR[0]）的第四到第八位都是中断相关的使能位，也就是说，只要在代码中配置了相关的位，就可以在其描述的时刻产生对应的中断信号，这里面常用的就是第4位的空闲中断和第5位的接收完成中断；第4位的中断信号是在接收完成后一段时间内再也没有数据接收了就会被触发，所以叫做空闲中断的使能；而第5是接收中断，也就是每次接收完一个字符后就会触发一次中断；编程者可以使用这两个中断实现非阻塞的串口数据接收。当接收中断产生的时候就读取接受的字符到数组，当产生空闲中断的时候就在数组末尾添加结束标志。这样就省去了结束符，也解决了接收死等的问题。<br> <img src="https://images2.imgbox.com/32/46/WZNnWiFc_o.png" alt="在这里插入图片描述"><br> <strong>串口的接收中断：</strong><br> 触发条件是：串口的DR寄存器接收到了值，接收到触发信号后，会将信号传递给NVIC控制器，NVIC控制器会将CPU调到中断服务函数中使用。<br> <strong>串口的空闲中断：</strong><br> 触发条件：在串口接收数据过程中，如果有一段事件串口停止工作了会产生触发信号。<br> 在串口工作结束的时候产生一次中断请求<br> 接收到字符串的时候没有结束条件，可以使用空闲中断作为判断字符串结束的条件<br> 只要使用串口的模块，大部分都需要接收数据，但是如果使用基础的串口函数都会造成阻塞</p> 
<h4><a id="_127"></a>实现代码</h4> 
<p>首先来分析一下实现流程，伪代码：</p> 
<pre><code class="prism language-javascript">串口<span class="token number">1</span>的初始化函数
<span class="token punctuation">{<!-- --></span>
   <span class="token comment">//打开时钟</span>
   <span class="token comment">//GPIO控制器配置</span>
   <span class="token comment">//USART1的控制器配置</span>
    加上串口的接收中断使能
   <span class="token comment">//NVIC控制器的配置</span>
    优先级分组   <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>   主函数的初始化之上
    优先级合成
    优先级分配
    使能中断源
<span class="token punctuation">}</span>

在nvic<span class="token punctuation">.</span>c中写中断服务函数即可
Void <span class="token function">串口1的中断服务函数名</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">void</span></span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
   <span class="token function">If</span><span class="token punctuation">(</span><span class="token constant">USART1</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token constant">SR</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//开启了CR1中的接收中断使能</span>
   <span class="token punctuation">{<!-- --></span>
     <span class="token comment">//清除标志位 //读取DR寄存器  同一个步骤</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>首先，肯定是需要实现串口的基础收发功能的，这个步骤在之前已经实现了，然后再其基础上开启串口的接收中断使能和空闲中断使能，也就是使能对应寄存器的第4位和第5位。<br> 操作代码如下：</p> 
<pre><code class="prism language-javascript">		<span class="token constant">USART1</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token constant">CR1</span>  <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//使能接收中断</span>
		<span class="token constant">USART1</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token constant">CR1</span>  <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//使能空闲中断</span>
</code></pre> 
<p>需要将这两行代码添加到如下图所示的位置。<br> <img src="https://images2.imgbox.com/a8/a4/InLPKlIg_o.png" alt=""><br> 其实到这里有关串口中断的配置已经完成了，但是为了方便后面的对中断的管理，还需要对中断进行分组和设置优先级，原因是在整个系统中，中断不可能只有一个，为了避免中断之间的冲突，就需要对中断的优先级进行管理，也正是为了方便管理，stm32的所有中断都有固定的命名，具体的管理和分组留到下一篇中在做介绍，在本文只需要知道这一段代码的作用就是设置中断分组、优先级，还有就是打开对应的中断使能即可。<br> 代码如下：</p> 
<pre><code class="prism language-javascript"><span class="token comment">//NVIC控制器配置</span>
		u32 pri<span class="token operator">=</span><span class="token function">NVIC_EncodePriority</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置抢占优先级为0，响应优先级为0</span>
		<span class="token function">NVIC_SetPriority</span><span class="token punctuation">(</span>USART1_IRQn<span class="token punctuation">,</span>pri<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//将对应的优先级设置映射到对应的中断</span>
		<span class="token function">NVIC_EnableIRQ</span><span class="token punctuation">(</span>USART1_IRQn<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">//使能中断</span>
</code></pre> 
<p>此段代码的位置如下：<br> <img src="https://images2.imgbox.com/46/f1/fSd9NNYO_o.png" alt="在这里插入图片描述"><br> 除此之外，还需要添加一句在所有的初始化之前的的中断分组函数</p> 
<pre><code class="prism language-javascript"><span class="token function">NVIC_SetPriorityGrouping</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置中断的优先组别（111-110-101-100）</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/5d/d9/DlHiGRLY_o.png" alt="在这里插入图片描述"><br> 至此，有关串口中断的初始化部分就搞定了，然后就是中断服务函数，中断服务函数的名称也是固定的，必须使用.s文件内的命名才可以，否则会找不到的，而且中断服务函数在使用的时候不需要调用、声明，也没有返回值、形参。只需要按照.s的函数名命名即可。<br> 具体代码如下：<br> 还是需要在对应文件夹下新建Nvic.c和Nvic.h。并将Nvic.c添加到工程，在主函数的main.h添加Nvic.h的头文件。</p> 
<pre><code class="prism language-javascript">#include <span class="token string">"Nvic.h"</span>
UsartStruct Usart1_Receive<span class="token punctuation">;</span><span class="token comment">//声明结构体</span>
<span class="token comment">/*******************************
函数名：USART1_IRQHandler
函数功能：串口一的中断服务函数函数
函数形参：无
函数返回值：void
备注：
********************************/</span>
<span class="token keyword">void</span> <span class="token function">USART1_IRQHandler</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">void</span></span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">USART1</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token constant">SR</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//判断接收中断</span>
	<span class="token punctuation">{<!-- --></span>
		Usart1_Receive<span class="token punctuation">.</span>Rebuf<span class="token punctuation">[</span>Usart1_Receive<span class="token punctuation">.</span>ReBytes<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">USART1</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token constant">DR</span><span class="token punctuation">;</span>
		Usart1_Receive<span class="token punctuation">.</span>ReBytes<span class="token operator">++</span><span class="token punctuation">;</span>
 	<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">USART1</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token constant">SR</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//判断空闲中断</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token constant">USART1</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token constant">SR</span><span class="token punctuation">;</span>
		<span class="token constant">USART1</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token constant">DR</span><span class="token punctuation">;</span><span class="token comment">//清除标志位</span>
		Usart1_Receive<span class="token punctuation">.</span>Rebuf<span class="token punctuation">[</span>Usart1_Receive<span class="token punctuation">.</span>ReBytes<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'\0'</span><span class="token punctuation">;</span>
		Usart1_Receive<span class="token punctuation">.</span>ReBytes<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
		Usart1_Receive<span class="token punctuation">.</span>UsartFlag<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>Nvic.h</p> 
<pre><code class="prism language-javascript">#ifndef _NVIC_H__
#define _NVIC_H__
#include <span class="token string">"stm32f4xx.h"</span>
#define	<span class="token constant">RBUF_MAX</span>				<span class="token number">50</span>
typedef struct
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>Usart_Recelve_Process<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//串口数据处理函数</span>
	u8 	Rebuf<span class="token punctuation">[</span><span class="token constant">RBUF_MAX</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token comment">//串口接收数据数组</span>
	u16 ReBytes<span class="token punctuation">;</span>                <span class="token comment">//串口接收数据长度 </span>
	u8 	UsartFlag<span class="token punctuation">;</span>				<span class="token comment">//串口接收到数据标志位</span>
	
<span class="token punctuation">}</span>UsartStruct<span class="token punctuation">;</span>
extern UsartStruct Usart1_Receive<span class="token punctuation">;</span><span class="token comment">//外部声明</span>
#endif
</code></pre> 
<h4><a id="_224"></a>实现效果</h4> 
<p>为了方便看见效果，这里写了一个小需求，使用串口调试助手发送“open”，打开LED1和LED2，并通过printf返回小灯状态，发送“close”，关闭LED1和LED2。<br> 注意需要使用到“String.h”里面的字符串处理函数，要将这个头文件添加到main.h<br> 具体的main.c内容如下：</p> 
<pre><code class="prism language-javascript">#include <span class="token string">"main.h"</span>

int <span class="token function">main</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">void</span></span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token comment">/*------------------变量定义区--------------------------*/</span>

<span class="token comment">/*------------------初始化外设区------------------------*/</span>
	<span class="token function">NVIC_SetPriorityGrouping</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置中断的优先组别（111-110-101-100）</span>
	<span class="token function">Led_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Key_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Usart1_Init</span><span class="token punctuation">(</span><span class="token number">115200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"系统初始化完毕\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*------------------单次运行区--------------------------*/</span>	
	
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">//防止程序跑飞</span>
	<span class="token punctuation">{<!-- --></span>
<span class="token comment">/*------------------主循环区--------------------------*/</span>	
		<span class="token keyword">if</span><span class="token punctuation">(</span>Usart1_Receive<span class="token punctuation">.</span>UsartFlag<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			Usart1_Receive<span class="token punctuation">.</span>UsartFlag<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> char<span class="token operator">*</span><span class="token punctuation">)</span>Usart1_Receive<span class="token punctuation">.</span>Rebuf<span class="token punctuation">,</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span> <span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token constant">LED_1_ON</span><span class="token punctuation">;</span>
				<span class="token constant">LED_2</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"小灯已打开\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> char<span class="token operator">*</span><span class="token punctuation">)</span>Usart1_Receive<span class="token punctuation">.</span>Rebuf<span class="token punctuation">,</span><span class="token string">"close"</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token constant">LED_1_OFF</span><span class="token punctuation">;</span>
				<span class="token constant">LED_2</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"小灯已关闭\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>最终运行效果：<br> <img src="https://images2.imgbox.com/8d/84/g6N8LTBF_o.jpg" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/ee/00/hRcV7BSF_o.jpg" alt="在这里插入图片描述"></p> 
<h2><a id="_268"></a>总结</h2> 
<p>本文主要是进一步完善串口的收发功能函数，并引出串口中断的相关使用办法，由于基础的串口接收时会有阻塞作用，会导致while(1）内的其他功能无法正常运行，就像流水灯、按键扫描这些都会收到影响，所以就引入了串口中断，当对应的中断信号到了，说明已经接收到了数据，此时CPU跳出去先把数据接收，再回来继续运行while(1)的内容，这样就巧妙地回避了一直等待接受的过程。这一篇中代码有些多，写的也有些混乱，大家有建议可以指出，以错误之处也欢迎提出。</p> 
<h2><a id="M4_270"></a>M4系列目录</h2> 
<p><a href="http://t.csdn.cn/Irvs2" rel="nofollow">1.嵌入式学习笔记——概述</a><br> <a href="http://t.csdn.cn/4cYhT" rel="nofollow">2.嵌入式学习笔记——基于Cortex-M的单片机介绍</a><br> <a href="http://t.csdn.cn/17IMP" rel="nofollow">3.嵌入式学习笔记——STM32单片机开发前的准备</a><br> <a href="http://t.csdn.cn/rMSba" rel="nofollow">4.嵌入式学习笔记——STM32硬件基础知识</a><br> <a href="http://t.csdn.cn/Gx3XX" rel="nofollow">5.嵌入式学习笔记——认识STM32的 GPIO口</a><br> <a href="http://t.csdn.cn/xYkrp" rel="nofollow">6.嵌入式学习笔记——使用寄存器编程操作GPIO</a><br> <a href="http://t.csdn.cn/9I3XJ" rel="nofollow">7.嵌入式学习笔记——寄存器实现控制LED小灯</a><br> <a href="http://t.csdn.cn/GCXZt" rel="nofollow">8.嵌入式学习笔记——使用寄存器编程实现按键输入功能</a><br> <a href="http://t.csdn.cn/7fro1" rel="nofollow">9.嵌入式学习笔记——STM32的USART通信概述</a><br> <a href="http://t.csdn.cn/1CnuS" rel="nofollow">10.嵌入式学习笔记——STM32的USART相关寄存器介绍及其配置</a><br> <a href="http://t.csdn.cn/jLPpG" rel="nofollow">11.嵌入式学习笔记——STM32的USART收发字符串及串口中断</a><br> <a href="http://t.csdn.cn/oBBy3" rel="nofollow">12.嵌入式学习笔记——STM32的中断控制体系</a><br> <a href="http://t.csdn.cn/vphF0" rel="nofollow">13.嵌入式学习笔记——STM32寄存器编程实现外部中断</a><br> <a href="http://t.csdn.cn/CuEqB" rel="nofollow">14.嵌入式学习笔记——STM32的时钟树</a><br> <a href="http://t.csdn.cn/tECCk" rel="nofollow">15.嵌入式学习笔记——SysTick(系统滴答)</a><br> <a href="http://t.csdn.cn/5KauG" rel="nofollow">16.嵌入式学习笔记——M4的基本定时器</a><br> <a href="http://t.csdn.cn/v7Pyq" rel="nofollow">17.嵌入式学习笔记——通用定时器</a><br> <a href="http://t.csdn.cn/oLpFm" rel="nofollow">18.嵌入式学习笔记——PWM与输入捕获（上）</a><br> <a href="http://t.csdn.cn/hfvmu" rel="nofollow">19.嵌入式学习笔记——PWM与输入捕获（下）</a><br> <a href="http://t.csdn.cn/u6M39" rel="nofollow">20.嵌入式学习笔记——ADC模数转换器</a><br> <a href="http://t.csdn.cn/vmuqh" rel="nofollow">21.嵌入式学习笔记——DMA</a><br> <a href="http://t.csdn.cn/5pAfv" rel="nofollow">22.嵌入式学习笔记——SPI通信</a><br> <a href="http://t.csdn.cn/6ec5g" rel="nofollow">23.嵌入式学习笔记——SPI通信的应用</a><br> <a href="http://t.csdn.cn/c71nl" rel="nofollow">24嵌入式学习笔记——IIC通信</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/06f1bc07584a03bb258027cc1b4b3f14/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">直线飙升到10万&#43;star的AutoGpt，有多强？帮我写了个网页！</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/bb4900a766ff866c3bef73bf81661f76/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">寻找两个正序数组的中位数（python）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>