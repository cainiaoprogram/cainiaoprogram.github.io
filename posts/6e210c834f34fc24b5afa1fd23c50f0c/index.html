<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>STP 3 - 生成树协议中4个guard 和 3个fast加一个filter - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="STP 3 - 生成树协议中4个guard 和 3个fast加一个filter" />
<meta property="og:description" content="最近出的几个问题总是和生成树协议有问题，复习的时候顺带总结，温故而知新。
先上一个大牛总结的图(Vinny), 总结的非常好，你看完后面的文章再来看这张图就会会心一笑 - i got it !
先讲下计时器，不论什么协议总是有些计时器，Hello数据包什么的。尤其到路由协议，怎么建立邻居关系，怎么通知拓扑改变，各种不同路由协议是各显神通。
所以在理解的时候最好要了解为什么这些协议需要计时器等等，这样我们就可以以不变应万变。
STP Timer （计时器的配置在当前交换机成为根桥时有用，因为默认只有根桥产生bpdu）
Hello - 发送BPDU的频率，默认2sMax Age - 在没有收到bpdu的情况下保持在block mode，默认20sForward Delay - 在listening 和 learning阶段等待时间，默认各15s 配置：
Router(config)#spanning-tree vlan 1 hello-time ?
&lt;1-10&gt; number of seconds between generation of config BPDUs
Router(config)#spanning-tree vlan 1 forward-time ?
&lt;4-30&gt; number of seconds for the forward delay timer
Router(config)#spanning-tree vlan 1 max-age ?
&lt;6-40&gt; maximum number of seconds the information in a BPDU is valid" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/6e210c834f34fc24b5afa1fd23c50f0c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2014-05-02T21:42:44+08:00" />
<meta property="article:modified_time" content="2014-05-02T21:42:44+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">STP 3 - 生成树协议中4个guard 和 3个fast加一个filter</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>最近出的几个问题总是和生成树协议有问题，复习的时候顺带总结，温故而知新。</p> 
<p><br> </p> 
<p>先上一个大牛总结的图(Vinny), 总结的非常好，你看完后面的文章再来看这张图就会会心一笑 - i got it !</p> 
<p><img src="https://images2.imgbox.com/33/77/LUu1nRt4_o.jpg" alt=""><br> </p> 
<p>先讲下计时器，不论什么协议总是有些计时器，Hello数据包什么的。尤其到路由协议，怎么建立邻居关系，怎么通知拓扑改变，各种不同路由协议是各显神通。</p> 
<p>所以在理解的时候最好要了解为什么这些协议需要计时器等等，这样我们就可以以不变应万变。</p> 
<p><br> </p> 
<p><span style="font-size:14px"><strong>STP Timer </strong></span></p> 
<p><strong><span style="font-size:12px">（计时器的配置在当前交换机成为根桥时有用，因为默认只有根桥产生bpdu）</span></strong></p> 
<p></p> 
<ul><li>Hello - 发送BPDU的频率，默认2s</li><li>Max Age - 在没有收到bpdu的情况下保持在block mode，默认20s</li><li>Forward Delay - 在listening 和 learning阶段等待时间，默认各15s</li></ul> 
<p></p> 
<p><strong>配置：</strong></p> 
<p>Router(config)#<span style="color:#ff0000">spanning-tree vlan 1 hello-time</span> ?<br>   &lt;1-10&gt;  number of seconds between generation of config BPDUs</p> 
<p>Router(config)#<span style="color:#ff0000">spanning-tree vlan 1 forward-time</span> ?<br>   &lt;4-30&gt;  number of seconds for the forward delay timer<br> </p> 
<p>Router(config)#<span style="color:#ff0000">spanning-tree vlan 1 max-age</span> ?<br>   &lt;6-40&gt;  maximum number of seconds the information in a BPDU is valid<br> </p> 
<p><br> </p> 
<p><strong>验证</strong>：</p> 
<p>Router#<span style="color:#ff0000">sh spanning-tree vlan 1 br</span><br> <br> <br> VLAN1<br>   Spanning tree enabled protocol ieee<br>   Root ID    Priority    32768<br>              Address     cc00.5f24.0000<br>              This bridge is the root<br>              <strong><span style="color:#ff0000">Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec</span></strong><br> <br> <br>   Bridge ID  Priority    32768<br>              Address     cc00.5f24.0000<br>              Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec<br>              Aging Time 300<br> <br> <br> Interface                                   Designated<br> Name                 Port ID Prio Cost  Sts Cost  Bridge ID            Port ID<br> -------------------- ------- ---- ----- --- ----- -------------------- -------<br> FastEthernet0/0      128.1    128    19 FWD     0 32768 cc00.5f24.0000 128.1<br> FastEthernet0/1      128.2    128    19 FWD     0 32768 cc00.5f24.0000 128.2<br> </p> 
<p><br> </p> 
<p>====================</p> 
<p><strong><span style="font-size:14px">PortFast</span></strong></p> 
<p></p> 
<ul><li>由于局域网中并不是所有设备都运行STP协议，比如PC，电话等等，对于连接终端用户的交换机端口其实是没有必要把整个生成树端口状态走完。Port Fast的作用就是跳过 Listening &amp; Learning 阶段直接从block进入forwarding。当然前提是确保物理层没有产生环路。</li><li>portfast命令也会影响TCN的生成。面向终端用户的端口默认是会在用户连接或断开时发送TCN到root，这时成个STP都会重新收敛并重置 mac address table /CAM table (by setting aging time to max)。<span style="color:#ff0000">如果开启portfast，就不会生成TCN</span></li></ul> 
<div> 
 <strong>配置：</strong> 
</div> 
<div> 
 <ul><li>interface command - spanning-tree portfast </li><li>global command - spanning-tree portfast default (enable portfast on non-trunk ports)</li></ul> 
</div> 
<div> 
 <br> 
</div> 
<div>
  ======================== 
</div> 
<div> 
 <strong><span style="font-size:14px">UplinkFast</span></strong> 
</div> 
<div> 
 <strong><span style="font-size:14px"><br> </span></strong> 
</div> 
<div>
  用于当直连根端口不工作时，立即启用备用根端口。实际上当原有根端口down，交换机会复制CAM table的内容通过备用端口发送给邻居交换机，加快收敛速度。当启用这个命令后， 
 <span style="color:#ff0000">优先级和root path cost会被更改为更高</span>，意味着更不容易竞争根桥或作为别的交换机去根桥的通路（transit path）。 
</div> 
<div> 
 <br> 
</div> 
<div>
  一般应用于有blocked port，而且处于access层的交换机 
</div> 
<div> 
 <br> 
</div> 
<div> 
 <strong>配置</strong>： 
</div> 
<div>
  global command - spanning-tree uplinkfast 
</div> 
<div> 
 <br> 
</div> 
<div>
  ======================== 
</div> 
<div> 
 <span style="font-size:14px"><strong>BackboneFast</strong></span> 
</div> 
<div> 
 <span style="font-size:14px"><strong><br> </strong></span> 
</div> 
<div>
  用于当与交换机非直接相连的链接无效时（邻居交换机通往root的链接down），帮助加速收敛（省去20s Max-age）比如以下拓扑（开启backboneFast） 
</div> 
<div> 
 <br> 
</div> 
<div> 
 <img src="https://images2.imgbox.com/23/5e/nCpZC05G_o.jpg" alt=""> 
 <br> 
</div> 
<div> 
 <ul><li>SW4是根桥，SW1通过SW3再到SW4。当SW3和SW4之间的Etherchannel断路， SW3向SW1发送 Inferior BPDU警示SW1下游路径去SW4代价很高，应另寻出路。</li><li>BackboneFast可以在所有交换机上开启，用来侦测非直连链路失效。</li></ul> 
</div> 
<div> 
 <strong>配置</strong>： 
</div> 
<div>
  global configuration - spanning-tree backbonefast 
</div> 
<div> 
 <br> 
</div> 
<div>
  ====================== 
</div> 
<div> 
 <span style="font-size:14px"><strong>BPDU Filter</strong></span> 
</div> 
<div> 
 <br> 
</div> 
<div>
  过滤接收和发送BPDU，可以在interface配置也可以global下配置。被配置的端口就不会发送和接收bpdu。一般会和portfast在一起用，动态管理终端连接，但是有安全风险 （man in the middle attack） 
</div> 
<div> 
 <br> 
</div> 
<div> 
 <ul><li>interface level - 双向过滤，既收不到，也不向外发。</li><li>global level - 单向过滤，不向外发</li></ul> 
</div> 
<div> 
 <br> 
</div> 
<div> 
 <strong>interface配置</strong>： 
</div> 
<div>
  intface - spanning-tree bpdufilter enable 
</div> 
<div> 
 <br> 
</div> 
<div> 
 <strong>interface验证</strong>： 
</div> 
<div>
  sh run interface [interface id] 
</div> 
<div>
  clear spanning-tree counters &amp; sh spanning-tree interface [id] details | in BPDU 
</div> 
<div> 
 <br> 
</div> 
<div> 
 <strong>Global配置（和portfast一起用</strong>） 
</div> 
<div>
  spanning-tree portfast default 
</div> 
<div>
  spanning-tree portfast bpdufilter default 
</div> 
<div> 
 <br> 
</div> 
<div>
  这种情况很有意思，全局开启portfast和bpdufilter。如果端口A连接的是PC，没有收到bpdu，那么bpdufilter使交换机也不是端口A向外发送bpdu；端口B恰好连接到另一台交换机，收到了bpdu，bpdufilter就会在端口B关闭portfast功能，进而可以进行bpdu沟通。 
</div> 
<div> 
 <br> 
</div> 
<div>
  ========================= 
</div> 
<div> 
 <strong><span style="font-size:14px">BPDU Guard</span><br> </strong> 
</div> 
<div> 
 <br> 
</div> 
<div>
  如果在不该收到bpdu的端口收到bpdu数据包，则关闭该端口（err-disable)。有时候因为bpdu guard，莫名其妙端口变为Err-disable，可参考我另一篇博文  
 <a target="_blank" href="http://blog.csdn.net/ziyuanzhao/article/details/22792243" rel="noopener noreferrer">Err-disable诊断与恢复</a> 。 
</div> 
<div>
  例如：当面向主机的端口开启了bpdu guard，但是有人连接了一个交换机，端口收到bpdu后就会被置于Err-disable状态。如果err-disable recovery time没有开启的话，就必须联系网络管理员去shut/ no shut端口。当然前提是必须先移除那个多余的交换机，不然端口依然会被关闭。 
</div> 
<div> 
 <br> 
</div> 
<div>
  在全局配置模式下可以和portfast一起配合使用 
</div> 
<div>
  spanning-tree portfast default 
</div> 
<div>
  spanning-tree portfast bpduguard default 
</div> 
<div> 
 <div> 
  <br> 
 </div> 
</div> 
<div>
  ========================= 
</div> 
<div> 
 <strong><span style="font-size:14px">Root Guard</span></strong> 
</div> 
<div> 
 <br> 
</div> 
<div>
  防止新加入的交换机打乱原有拓扑，一般配置在Core和Distribution 面向access layer的端口。一旦下行端口接收到bpdu包，指示下行邻居交换机为根桥，这时root guard就会block这个下行端口直到邻居交换机priority等信息更改（不再与原有根桥竞争），才会解除对下行端口block。 
</div> 
<div> 
 <br> 
</div> 
<div> 
 <strong>端口上配置：</strong> 
</div> 
<div>
  interface level - spanning-tree guard root 
</div> 
<div> 
 <br> 
</div> 
<div> 
 <strong>验证：</strong> 
</div> 
<div>
  sh spanning-tree interface [id] detail 
</div> 
<div> 
 <span style="font-size:14px"><strong><br> </strong></span> 
</div> 
<div> 
 <span style="font-size:14px">=====================</span> 
</div> 
<div> 
 <strong><span style="font-size:14px">Loop Guard &amp; UDLD (Unidirection Link Detection) "Guard"</span></strong> 
</div> 
<div> 
 <br> 
</div> 
<div>
  红色标出的是两者的优缺点。这就是为什么经常同时使用 
</div> 
<div> 
 <ul><li>Loop Guard - 防止配置错误，ios软件问题导致stp不能正常工作</li><li>UDLD - 能侦测出物理链路断路或搭错跳线</li></ul> 
</div> 
<div> 
 <span style="font-size:14px"> <br> </span> 
</div> 
<div> 
 <span style="font-size:14px"></span> 
 <table bgcolor="#FFFFFF" cellpadding="3" cellspacing="1" border="1" width="60%" style="color:rgb(0,0,0); font-family:arial,helvetica,sans-serif; font-size:12px; text-align:start"><tbody><tr><th height="" width="" bgcolor="#CCCCFF" colspan="1" rowspan="1">Functionality</th><th height="" width="" bgcolor="#CCCCFF" colspan="1" rowspan="1">Loop Guard</th><th height="" width="" bgcolor="#CCCCFF" colspan="1" rowspan="1">UDLD</th></tr><tr><td height="" width="" bgcolor="#FFFFFF" colspan="1" rowspan="1">Configuration</td><td height="" width="" bgcolor="#FFFFFF" colspan="1" rowspan="1">Per-port</td><td height="" width="" bgcolor="#FFFFFF" colspan="1" rowspan="1">Per-port</td></tr><tr><td height="" width="" bgcolor="#FFFFFF" colspan="1" rowspan="1">Action granularity</td><td height="" width="" bgcolor="#FFFFFF" colspan="1" rowspan="1">Per-VLAN</td><td height="" width="" bgcolor="#FFFFFF" colspan="1" rowspan="1">Per-port</td></tr><tr><td height="" width="" bgcolor="#FFFFFF" colspan="1" rowspan="1">Autorecover</td><td height="" width="" bgcolor="#FFFFFF" colspan="1" rowspan="1">Yes</td><td height="" width="" bgcolor="#FFFFFF" colspan="1" rowspan="1">Yes, with err-disable timeout feature</td></tr><tr><td height="" width="" bgcolor="#FFFFFF" colspan="1" rowspan="1">Protection against STP failures caused by unidirectional links</td><td height="" width="" bgcolor="#FFFFFF" colspan="1" rowspan="1">Yes, when enabled on all root and alternate ports in redundant topology</td><td height="" width="" bgcolor="#FFFFFF" colspan="1" rowspan="1">Yes, when enabled on all links in redundant topology</td></tr><tr><td height="" width="" bgcolor="#FFFFFF" colspan="1" rowspan="1"><span style="color:#ff0000">Protection against STP failures caused by problems in the software (designated switch does not send BPDU)</span></td><td height="" width="" bgcolor="#FFFFFF" colspan="1" rowspan="1"><span style="color:#ff0000">Yes</span></td><td height="" width="" bgcolor="#FFFFFF" colspan="1" rowspan="1"><span style="color:#ff0000">No</span></td></tr><tr><td height="" width="" bgcolor="#FFFFFF" colspan="1" rowspan="1"><span style="color:#ff0000">Protection against miswiring.</span></td><td height="" width="" bgcolor="#FFFFFF" colspan="1" rowspan="1"><span style="color:#ff0000">No</span></td><td height="" width="" bgcolor="#FFFFFF" colspan="1" rowspan="1"><span style="color:#ff0000">Yes</span></td></tr></tbody></table> 
 <br> 
</div> 
<div> 
 <span style="font-size:14px"><strong>loopguard配置</strong>：</span> 
</div> 
<div> 
 <span style="font-size:12px">interface level -  spanning-tree guard loop</span> 
</div> 
<div> 
 <span style="font-size:12px">global level - spanning-tree loopgauard default</span> 
</div> 
<div> 
 <br> 
</div> 
<div> 
 <br> 
</div> 
<div> 
 <strong>UDLD配置和验证:</strong> 
</div> 
<div>
  interface level - udld port 
</div> 
<div>
  show udld interface [id] 
</div> 
<div> 
 <br> 
</div> 
<div> 
 <br> 
</div> 
<div>
  思科文档： http://www.cisco.com/c/en/us/support/docs/lan-switching/spanning-tree-protocol/10596-84.html 
</div> 
<div>
  INE blog "UDLD mode of Operations"：http://blog.ine.com/2008/07/05/udld-modes-of-operation/ 
</div> 
<div> 
 <br> 
</div> 
<div>
  看来UDLD需要再来一篇单独讲啊，很多地方都能用到。今天先到这里吧。 
</div> 
<div> 
 <span style="font-size:14px"><br> </span> 
</div> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6cc16a84d61aab8ebea772a8a74c5e50/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">FFTW使用小结</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4606c6fa83b536a3260c871463f2e960/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">cocos2d-x安装配置步骤</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>