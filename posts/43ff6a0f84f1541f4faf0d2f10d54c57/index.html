<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>IOS内嵌H5页面实现（JS实现图片正常显示，并正确返回文档的高度） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="IOS内嵌H5页面实现（JS实现图片正常显示，并正确返回文档的高度）" />
<meta property="og:description" content="1、需求 由于IOS原生开发对含有html标签的数据处理很麻烦，所以在做文章详情时，采用内嵌H5页面形式混合开发。
2、流程 ObjC将字符串类型的数据，通过Window上的JS方法将数据传递给JS。JS拿到数据渲染H5页面，并通知ObjC H5文档高度（JS实现图片正常显示，并正确返回文档的高度）。
3、实现 JS方法定义 index.html
&lt;!DOCTYPE html&gt; &lt;html lang=&#34;en&#34;&gt; &lt;head&gt; &lt;meta charset=&#34;UTF-8&#34;&gt; &lt;meta name=&#34;viewport&#34; content=&#34;width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no&#34;&gt; &lt;title&gt;文章详情&lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;div class=&#34;article-wrapper&#34;&gt; &lt;div class=&#34;article-content&#34; id=&#34;content&#34;&gt; &lt;p&gt;数据加载中...&lt;/p&gt; &lt;/div&gt; &lt;/div&gt; &lt;script src=&#34;app.js&#34;&gt;&lt;/script&gt; &lt;script&gt; // 原生App中，通过调用articleDetail()方法，将数据传递到该页面， // js实现页面渲染 function articleDetail(content) { cap.init(&#39;#content&#39;, content); } &lt;/script&gt; &lt;/body&gt; &lt;/html&gt; app.js
/* * Create by Capricorncd 2017 */ // 方法封装 var cap = function () { // 预加载图片 var LOADING_IMG = &#39;http://xmqvip1-1253933147." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/43ff6a0f84f1541f4faf0d2f10d54c57/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2017-08-29T16:45:54+08:00" />
<meta property="article:modified_time" content="2017-08-29T16:45:54+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">IOS内嵌H5页面实现（JS实现图片正常显示，并正确返回文档的高度）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h5 id="1需求">1、需求</h5> 
<p>由于IOS原生开发对含有html标签的数据处理很麻烦，所以在做文章详情时，采用内嵌H5页面形式混合开发。</p> 
<h5 id="2流程">2、流程</h5> 
<p>ObjC将字符串类型的数据，通过Window上的JS方法将数据传递给JS。JS拿到数据渲染H5页面，并通知ObjC H5文档高度（JS实现图片正常显示，并正确返回文档的高度）。</p> 
<p><img src="https://images2.imgbox.com/3f/e1/UPTEB5HU_o.png" alt="这里写图片描述" title=""></p> 
<h5 id="3实现">3、实现</h5> 
<ul><li>JS方法定义</li></ul> 
<p>index.html</p> 
<pre class="prettyprint"><code class="language-html hljs "><span class="hljs-doctype">&lt;!DOCTYPE html&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">html</span> <span class="hljs-attribute">lang</span>=<span class="hljs-value">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">charset</span>=<span class="hljs-value">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"viewport"</span> <span class="hljs-attribute">content</span>=<span class="hljs-value">"width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">title</span>&gt;</span>文章详情<span class="hljs-tag">&lt;/<span class="hljs-title">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">body</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"article-wrapper"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"article-content"</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"content"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span>数据加载中...<span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"app.js"</span>&gt;</span><span class="javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">script</span>&gt;</span><span class="javascript">
<span class="hljs-comment">// 原生App中，通过调用articleDetail()方法，将数据传递到该页面，</span>
<span class="hljs-comment">// js实现页面渲染</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">articleDetail</span><span class="hljs-params">(content)</span> {<!-- --></span>
    cap.init(<span class="hljs-string">'#content'</span>, content);
}
</span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">html</span>&gt;</span></code></pre> 
<p>app.js</p> 
<pre class="prettyprint"><code class="language-javascript hljs "><span class="hljs-comment">/*
 * Create by Capricorncd 2017
*/</span>
<span class="hljs-comment">// 方法封装</span>
<span class="hljs-keyword">var</span> cap = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {<!-- --></span>
    <span class="hljs-comment">// 预加载图片</span>
    <span class="hljs-keyword">var</span> LOADING_IMG = <span class="hljs-string">'http://xmqvip1-1253933147.picgz.myqcloud.com/backend/2017/08/28/1503890004850.gif?imageView2'</span>

    <span class="hljs-comment">// 图片id前缀</span>
    <span class="hljs-keyword">var</span> idPrefix = <span class="hljs-string">'IMG'</span> + <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime() + <span class="hljs-string">'_'</span>;

    <span class="hljs-comment">// 替换预加载图片</span>
    <span class="hljs-keyword">var</span> showPreloadImages = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(str)</span> {<!-- --></span>
        <span class="hljs-keyword">var</span> arr = str.match(<span class="hljs-regexp">/&lt;img.*?&gt;/ig</span>);
        <span class="hljs-keyword">var</span> images = {};
        <span class="hljs-keyword">var</span> count = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> (arr) {
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; arr.length; i++) {
                <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/src=(?:'|")(.+?)(?:'|")/ig</span>.test(arr[i])) {
                    images[i] = <span class="hljs-built_in">RegExp</span>.$<span class="hljs-number">1</span>;
                    count++;
                }
                <span class="hljs-keyword">var</span> tmp = <span class="hljs-string">'&lt;img id="'</span>+ (idPrefix + i) +<span class="hljs-string">'" src="'</span>+ LOADING_IMG +<span class="hljs-string">'" width="200" height="200"&gt;'</span>;
                str = str.replace(arr[i], tmp);
            }
            preloadImages(images, count);
        }
        <span class="hljs-keyword">return</span> str;
    }

    <span class="hljs-comment">// 预加载图片</span>
    <span class="hljs-keyword">var</span> preloadImages = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(images, len)</span> {<!-- --></span>
        <span class="hljs-keyword">if</span> (!len) <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">var</span> count = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">var</span> newImages = {};
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> images) {
            imgLoading(images[key], key, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data, index)</span> {<!-- --></span>
                newImages[index] = data;
                count++;
                <span class="hljs-keyword">if</span> (count == len) {
                    reloadDocument(newImages);
                }
            })
        }
    }

    <span class="hljs-comment">// 加载图片</span>
    <span class="hljs-keyword">var</span> imgLoading = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(img, index, callback)</span> {<!-- --></span>
        <span class="hljs-keyword">var</span> image = <span class="hljs-keyword">new</span> Image();
        image.src = img;
        image.onload = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {<!-- --></span>
            callback &amp;&amp; callback(image, index);
        }
        image.onerror = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {<!-- --></span>
            callback &amp;&amp; callback(image, index);
        }
    }

    <span class="hljs-comment">// 重新渲染页面</span>
    <span class="hljs-keyword">var</span> reloadDocument = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(images)</span> {<!-- --></span>
        <span class="hljs-comment">// console.log(images);</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> images) {
            <span class="hljs-keyword">var</span> img = images[key];
            <span class="hljs-keyword">var</span> elem = getElm(<span class="hljs-string">'#'</span> + idPrefix + key);
            elem.src = img.src;
            <span class="hljs-keyword">var</span> wh = resizeToImage(elem, img);
            elem.setAttribute(<span class="hljs-string">'width'</span>, wh.w);
            elem.setAttribute(<span class="hljs-string">'height'</span>, wh.h);
        }
        callbackDocHeight();
    }

    <span class="hljs-comment">// 重新计算图片尺寸</span>
    <span class="hljs-keyword">var</span> resizeToImage = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(elem, img)</span> {<!-- --></span>
        <span class="hljs-comment">// 父级容器宽度</span>
        <span class="hljs-keyword">var</span> parentNodeWidth = elem.parentNode ? elem.parentNode.offsetWidth : el.offsetWidth;
        <span class="hljs-keyword">var</span> w = img.width, h = img.height;
        <span class="hljs-keyword">if</span> (img.width &gt; parentNodeWidth) {
            w = parentNodeWidth;
            h = <span class="hljs-built_in">Math</span>.ceil(img.height*(parentNodeWidth/img.width));
        }
        <span class="hljs-keyword">return</span> {w: w, h: h};
    }

    <span class="hljs-comment">// 清除content文档数据中的换行</span>
    <span class="hljs-keyword">var</span> clearLineBreak = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(content)</span> {<!-- --></span>
        <span class="hljs-keyword">return</span> content.replace(<span class="hljs-regexp">/[\n\r]|&lt;p&gt;\0*?&lt;\/p&gt;/ig</span>, <span class="hljs-string">''</span>);
    }

    <span class="hljs-comment">// 获取文档高度</span>
    <span class="hljs-keyword">var</span> callbackDocHeight = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {<!-- --></span>
        setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {<!-- --></span>
            <span class="hljs-keyword">var</span> oh = document.body.offsetHeight + <span class="hljs-number">24</span>;
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 调用ObjC的方法</span>
                window.webkit.messageHandlers.webViewActualHeight.postMessage(oh);
            } <span class="hljs-keyword">catch</span> (e) {}
        }, <span class="hljs-number">0</span>);
    }

    <span class="hljs-comment">// 获取DOM元素</span>
    <span class="hljs-keyword">var</span> getElm = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(selector)</span> {<!-- --></span>
        <span class="hljs-keyword">return</span> document.querySelector(selector);
    }

    <span class="hljs-keyword">return</span> {
        init: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(selector, content)</span> {<!-- --></span>
            <span class="hljs-keyword">var</span> el = getElm(selector);
            <span class="hljs-keyword">var</span> timer = setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {<!-- --></span>
                el.innerHTML = <span class="hljs-string">'&lt;p&gt;ERROR: 数据加载超时...&lt;/p&gt;'</span>;
                callbackDocHeight();
                <span class="hljs-keyword">if</span> (timer) clearTimeout(timer);
            }, <span class="hljs-number">3000</span>);

            content = showPreloadImages(clearLineBreak(content));
            <span class="hljs-keyword">if</span> (timer) clearTimeout(timer);
            el.innerHTML = content || <span class="hljs-string">'&lt;p&gt;ERROR: 获取数据失败！&lt;/p&gt;'</span>;
            callbackDocHeight();
        },
        <span class="hljs-comment">// 拼接纯文本数据使用</span>
        <span class="hljs-comment">// 将纯文本转换为html代码</span>
        textHandler: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(text)</span> {<!-- --></span>
            <span class="hljs-keyword">if</span> (!text) <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
            <span class="hljs-comment">// 将换行符/回车转换为p标签</span>
            <span class="hljs-keyword">return</span> <span class="hljs-string">'&lt;p&gt;'</span> + text.replace(<span class="hljs-regexp">/[\r\n]/ig</span>, <span class="hljs-string">'&lt;/p&gt;&lt;p&gt;'</span>) + <span class="hljs-string">'&lt;/p&gt;'</span>;
        },
        <span class="hljs-comment">// 拼接图片数组使用</span>
        <span class="hljs-comment">// 将图片转换为html代码</span>
        imgHandle: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(imgs)</span> {<!-- --></span>
            <span class="hljs-keyword">if</span> (!imgs <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
            <span class="hljs-keyword">var</span> content = <span class="hljs-string">''</span>;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; imgs.length; i++) {
                content += <span class="hljs-string">'&lt;p&gt;&lt;img src="'</span>+ imgs[i] +<span class="hljs-string">'"&gt;&lt;/p&gt;'</span>;
            }
            <span class="hljs-keyword">return</span> content;
        }
    }
}();</code></pre> 
<ul><li>ObjC方法定义</li></ul> 
<pre class="prettyprint"><code class="language-oc hljs ruby">[configuration.userContentController <span class="hljs-symbol">addScriptMessageHandler:</span><span class="hljs-keyword">self</span> <span class="hljs-symbol">name:</span>@<span class="hljs-string">"webViewActualHeight"</span>];</code></pre> 
<pre class="prettyprint"><code class="language-oc hljs avrasm">- (void)userContentController:(WKUserContentController *)userContentController didReceiveScriptMessage:(WKScriptMessage *)message
{
    NSLog(@<span class="hljs-string">"body:%@"</span>, message<span class="hljs-preprocessor">.body</span>)<span class="hljs-comment">;</span>
    if ([message<span class="hljs-preprocessor">.name</span> isEqualToString:@<span class="hljs-string">"webViewActualHeight"</span>]) {
        CGFloat height = [message<span class="hljs-preprocessor">.body</span> doubleValue]<span class="hljs-comment">;</span>
        self<span class="hljs-preprocessor">.myWebView</span><span class="hljs-preprocessor">.frame</span> = CGRectMake(<span class="hljs-number">20</span>, CGRectGetMaxY(self<span class="hljs-preprocessor">.topicCreateTimeL</span><span class="hljs-preprocessor">.frame</span>), SCREEN_W-<span class="hljs-number">40</span>, height)<span class="hljs-comment">;</span>
        self<span class="hljs-preprocessor">.bottomLine</span><span class="hljs-preprocessor">.frame</span> = CGRectMake(<span class="hljs-number">20</span>, CGRectGetMaxY(self<span class="hljs-preprocessor">.myWebView</span><span class="hljs-preprocessor">.frame</span>)+<span class="hljs-number">20</span>, <span class="hljs-number">50</span>, <span class="hljs-number">2</span>)<span class="hljs-comment">;</span>
        if(self<span class="hljs-preprocessor">.headerHeight</span>) {
            self<span class="hljs-preprocessor">.headerHeight</span>(CGRectGetMaxY(self<span class="hljs-preprocessor">.bottomLine</span><span class="hljs-preprocessor">.frame</span>))<span class="hljs-comment">;</span>
        }
    }
}</code></pre> 
<p>至此，就实现了与原生App的一种交互模式，并正确返回文档的高度。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4645e06ea04765f2293a12e5b10719ee/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">多层神经网络BP算法 文本垃圾分类</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d549c61a65fabd63473bcabe84005258/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Dojo request （js ajax）向java后台传汉字乱码的通用解决方法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>