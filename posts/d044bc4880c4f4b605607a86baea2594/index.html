<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>电商项目实战--收货地址相关 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="电商项目实战--收货地址相关" />
<meta property="og:description" content="27. 收货地址-分析 关于“收货地址”数据的管理，涉及的功能有：增加，修改，删除，设为默认，显示列表。
以上功能的开发顺序应该是：增加 &gt; 显示列表 &gt; 设为默认 &gt; 删除 &gt; 修改。
28. 收货地址-创建数据表 创建收货地址数据表：
CREATE TABLE t_address ( aid INT AUTO_INCREMENT COMMENT &#39;收货地址id&#39;, uid INT COMMENT &#39;用户id&#39;, name VARCHAR(50) COMMENT &#39;收货人姓名&#39;, province_code CHAR(6) COMMENT &#39;省代号&#39;, province_name VARCHAR(50) COMMENT &#39;省名称&#39;, city_code CHAR(6) COMMENT &#39;市代号&#39;, city_name VARCHAR(50) COMMENT &#39;市名称&#39;, area_code CHAR(6) COMMENT &#39;区代号&#39;, area_name VARCHAR(50) COMMENT &#39;区名称&#39;, zip CHAR(6) COMMENT &#39;邮编&#39;, address VARCHAR(100) COMMENT &#39;详细地址&#39;, phone VARCHAR(20) COMMENT &#39;手机&#39;, tel VARCHAR(20) COMMENT &#39;固话&#39;, tag VARCHAR(30) COMMENT &#39;地址类型&#39;, is_default INT COMMENT &#39;是否默认，0-非默认，1-默认&#39;, created_user VARCHAR(50) COMMENT &#39;创建人&#39;, created_time DATETIME COMMENT &#39;创建时间&#39;, modified_user VARCHAR(50) COMMENT &#39;最后修改人&#39;, modified_time DATETIME COMMENT &#39;最后修改时间&#39;, PRIMARY KEY (aid) ) DEFAULT CHARSET=UTF8; 29." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/d044bc4880c4f4b605607a86baea2594/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-07-03T20:08:44+08:00" />
<meta property="article:modified_time" content="2019-07-03T20:08:44+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">电商项目实战--收货地址相关</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h4><a id="27__0"></a>27. 收货地址-分析</h4> 
<p>关于“收货地址”数据的管理，涉及的功能有：增加，修改，删除，设为默认，显示列表。</p> 
<p>以上功能的开发顺序应该是：增加 &gt; 显示列表 &gt; 设为默认 &gt; 删除 &gt; 修改。</p> 
<h4><a id="28__6"></a>28. 收货地址-创建数据表</h4> 
<p>创建收货地址数据表：</p> 
<pre><code>CREATE TABLE t_address (
	aid INT AUTO_INCREMENT COMMENT '收货地址id',
	uid INT COMMENT '用户id',
	name VARCHAR(50) COMMENT '收货人姓名',
	province_code CHAR(6) COMMENT '省代号',
	province_name VARCHAR(50) COMMENT '省名称',
	city_code CHAR(6) COMMENT '市代号',
	city_name VARCHAR(50) COMMENT '市名称',
	area_code CHAR(6) COMMENT '区代号',
	area_name VARCHAR(50) COMMENT '区名称',
	zip CHAR(6) COMMENT '邮编',
	address VARCHAR(100) COMMENT '详细地址',
	phone VARCHAR(20) COMMENT '手机',
	tel VARCHAR(20) COMMENT '固话',
	tag VARCHAR(30) COMMENT '地址类型',
	is_default INT COMMENT '是否默认，0-非默认，1-默认',
	created_user VARCHAR(50) COMMENT '创建人',
	created_time DATETIME COMMENT '创建时间',
	modified_user VARCHAR(50) COMMENT '最后修改人',
	modified_time DATETIME COMMENT '最后修改时间',
	PRIMARY KEY (aid)
) DEFAULT CHARSET=UTF8;
</code></pre> 
<h4><a id="29__34"></a>29. 收货地址-创建实体类</h4> 
<p>创建<code>cn.tedu.store.entity.Address</code>，继承自<code>BaseEntity</code>：</p> 
<pre><code class="prism language-java">	<span class="token comment">/**
	 * 收货地址数据的实体类
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Address</span> <span class="token keyword">extends</span> <span class="token class-name">BaseEntity</span> <span class="token punctuation">{<!-- --></span>
	
		<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">6946915401608396201</span>L<span class="token punctuation">;</span>
	
		<span class="token keyword">private</span> Integer aid<span class="token punctuation">;</span>
		<span class="token keyword">private</span> Integer uid<span class="token punctuation">;</span>
		<span class="token keyword">private</span> String name<span class="token punctuation">;</span>
		<span class="token keyword">private</span> String provinceCode<span class="token punctuation">;</span>
		<span class="token keyword">private</span> String provinceName<span class="token punctuation">;</span>
		<span class="token keyword">private</span> String cityCode<span class="token punctuation">;</span>
		<span class="token keyword">private</span> String cityName<span class="token punctuation">;</span>
		<span class="token keyword">private</span> String areaCode<span class="token punctuation">;</span>
		<span class="token keyword">private</span> String areaName<span class="token punctuation">;</span>
		<span class="token keyword">private</span> String zip<span class="token punctuation">;</span>
		<span class="token keyword">private</span> String address<span class="token punctuation">;</span>
		<span class="token keyword">private</span> String phone<span class="token punctuation">;</span>
		<span class="token keyword">private</span> String tel<span class="token punctuation">;</span>
		<span class="token keyword">private</span> String tag<span class="token punctuation">;</span>
		<span class="token keyword">private</span> Integer isDefault<span class="token punctuation">;</span>
	
	<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="30__63"></a>30. 收货地址-增加-持久层</h4> 
<p><strong>(a) 规划SQL语句</strong></p> 
<p>增加收货地址需要执行的SQL语句大致是：</p> 
<pre><code>insert into t_address (除了aid以外的所有字段) values (匹配的值列表)
</code></pre> 
<p>后续，在执行插入数据时，需要确定插入的收货地址数据是不是默认收货地址，每个用户都应该有且仅有1条默认收货地址，当新创建收货地址时，第1条是默认的，其它的都不是默认的！则需要判断出“即将创建的收货地址是不是第1条”，可以通过“查询某用户的收货地址数据的数量”来判断，即数量为0时，即将创建的就是第1条，数量不为0时，即将创建就不是第1条：</p> 
<pre><code>select count(*) from t_address where uid=?
</code></pre> 
<p>另外，还可以限制每个用户最多允许创建多少条收货地址，该功能也可以通过以上查询来完成！</p> 
<p><strong>(b) 接口与抽象方法</strong></p> 
<p>创建<code>cn.tedu.store.mapper.AddressMapper</code>接口，并在接口中添加抽象方法：</p> 
<pre><code>Integer addnew(Address address);

Integer countByUid(Integer uid);
</code></pre> 
<p><strong>© 配置映射</strong></p> 
<p>将原有的<code>UserMapper.xml</code>复制，并粘贴为<code>AddressMapper.xml</code>，删除其中各子级节点的配置，将根节点对应的接口修改为<code>AddressMapper</code>接口，然后，在该文件中配置以上2个抽象方法的映射：</p> 
<pre><code class="prism language-xml">	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">namespace</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>cn.tedu.store.mapper.AddressMapper<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
	
		<span class="token comment">&lt;!-- 增加收货地址数据 --&gt;</span>
		<span class="token comment">&lt;!-- Integer addnew(Address address) --&gt;</span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>insert</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>addnew<span class="token punctuation">"</span></span>
			<span class="token attr-name">useGeneratedKeys</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
			<span class="token attr-name">keyProperty</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>aid<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
			INSERT INTO t_address (
				uid, name,
				province_code, province_name,
				city_code, city_name,
				area_code, area_name,
				zip, address,
				phone, tel,
				tag, is_default,
				created_user, created_time,
				modified_user, modified_time
			) VALUES (
				#{uid}, #{name},
				#{provinceCode}, #{provinceName},
				#{cityCode}, #{cityName},
				#{areaCode}, #{areaName},
				#{zip}, #{address},
				#{phone}, #{tel},
				#{tag}, #{isDefault},
				#{createdUser}, #{createdTime},
				#{modifiedUser}, #{modifiedTime}
			)
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>insert</span><span class="token punctuation">&gt;</span></span>
		
		<span class="token comment">&lt;!-- 统计某用户的收货地址的数量 --&gt;</span>
		<span class="token comment">&lt;!-- Integer countByUid(Integer uid) --&gt;</span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>countByUid<span class="token punctuation">"</span></span>
			<span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>java.lang.Integer<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
			SELECT 
				COUNT(*) 
			FROM 
				t_address 
			WHERE 
				uid=#{uid}
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>
	
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mapper</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>在<strong>src/test/java</strong>下创建<code>cn.tedu.store.mapper.AddressMapperTests</code>测试类，编写并执行单元测试：</p> 
<pre><code class="prism language-java">	<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span>SpringRunner<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
	<span class="token annotation punctuation">@SpringBootTest</span>
	<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AddressMapperTests</span> <span class="token punctuation">{<!-- --></span>
	
		<span class="token annotation punctuation">@Autowired</span>
		AddressMapper mapper<span class="token punctuation">;</span>
		
		<span class="token annotation punctuation">@Test</span>
		<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addnew</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			Address address <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			address<span class="token punctuation">.</span><span class="token function">setUid</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			address<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"小刘同学"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			Integer rows <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">addnew</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
			System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"rows="</span> <span class="token operator">+</span> rows<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
		<span class="token annotation punctuation">@Test</span>
		<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">countByUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			Integer uid <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
			Integer count <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">countByUid</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
			System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"count="</span> <span class="token operator">+</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
	<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="31__160"></a>31. 收货地址-增加-业务层</h4> 
<p><strong>(a) 规划异常</strong></p> 
<p>插入数据可能产生<code>InsertException</code>。</p> 
<p>如果需要限制用户创建的收货地址数据，则达到上限仍尝试创建，就会产生<code>cn.tedu.store.service.ex.AddressCountLimitException</code>。</p> 
<p><strong>(b) 接口与抽象方法</strong></p> 
<p>创建<code>cn.tedu.store.service.IAddressService</code>接口，然后，在接口中添加抽象方法：</p> 
<pre><code>void create(Integer uid, String username, Address address) throws AddressCountLimitException, InsertException;
</code></pre> 
<p><strong>© 实现抽象方法</strong></p> 
<p>创建<code>cn.tedu.store.service.impl.AddressServiceImpl</code>类，实现<code>IAddressService</code>接口，在类之前添加<code>@Service</code>注解，在类中添加<code>@Autowired private AddressMapper addressMapper;</code>持久层对象：</p> 
<pre><code>@Service
public class AddressServiceImpl implements IAddressService {
	@Autowired
	private AddressMapper addressMapper;
}
</code></pre> 
<p>然后，复制持久层接口中的2个抽象方法，粘贴到该实现类中，然后，私有化实现这2个方法：</p> 
<pre><code class="prism language-java">	<span class="token comment">/**
	 * 增加收货地址数据
	 * @param address 收货地址数据
	 * @throws InsertException
	 */</span>
	<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">addnew</span><span class="token punctuation">(</span>Address address<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		Integer rows <span class="token operator">=</span> addressMapper<span class="token punctuation">.</span><span class="token function">addnew</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>rows <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InsertException</span><span class="token punctuation">(</span><span class="token string">"..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
	 * 统计某用户的收货地址的数量
	 * @param uid 用户的id
	 * @return 用户的收货地址的数量
	 */</span>
	<span class="token keyword">private</span> Integer <span class="token function">countByUid</span><span class="token punctuation">(</span>Integer uid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>uid <span class="token operator">==</span> null <span class="token operator">||</span> uid <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> addressMapper<span class="token punctuation">.</span><span class="token function">countByUid</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p>重写接口中的抽象方法：</p> 
<pre><code>public void create(Integer uid, String username, Address address) throws AddressCountLimitException, InsertException {
	// 基于参数uid查询该用户的收货地址数量
	// 判断数量是否达到上限值
	// 是：AddressCountLimitException

	// 补全参数address中的数据：uid
	// TODO 补全参数address中的数据：省市区的名称
	// 补全参数address中的数据：isDefault，根据收货地址数量确定该属性的值
	// 创建当前时间对象
	// 补全参数address中的数据：4项日志
	// 执行增加
}
</code></pre> 
<p>具体实现代码为：</p> 
<pre><code class="prism language-java">	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">create</span><span class="token punctuation">(</span>Integer uid<span class="token punctuation">,</span> String username<span class="token punctuation">,</span> Address address<span class="token punctuation">)</span>
			<span class="token keyword">throws</span> AddressCountLimitException<span class="token punctuation">,</span> InsertException <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 基于参数uid查询该用户的收货地址数量</span>
		Integer count <span class="token operator">=</span> <span class="token function">countByUid</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 判断数量是否达到上限值</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;=</span> MAX_COUNT<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 是：AddressCountLimitException</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AddressCountLimitException</span><span class="token punctuation">(</span>
				<span class="token string">"增加收货地址失败！当前收货地址的数量("</span> <span class="token operator">+</span> count <span class="token operator">+</span> <span class="token string">")已经达到上限("</span> <span class="token operator">+</span> MAX_COUNT <span class="token operator">+</span> <span class="token string">")！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 补全参数address中的数据：uid</span>
		address<span class="token punctuation">.</span><span class="token function">setUid</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// TODO 补全参数address中的数据：省市区的名称</span>
		<span class="token comment">// 补全参数address中的数据：isDefault，根据收货地址数量确定该属性的值</span>
		Integer isDefault <span class="token operator">=</span> count <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
		address<span class="token punctuation">.</span><span class="token function">setIsDefault</span><span class="token punctuation">(</span>isDefault<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 创建当前时间对象</span>
		Date now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 补全参数address中的数据：4项日志</span>
		address<span class="token punctuation">.</span><span class="token function">setCreatedUser</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
		address<span class="token punctuation">.</span><span class="token function">setCreatedTime</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">;</span>
		address<span class="token punctuation">.</span><span class="token function">setModifiedUser</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
		address<span class="token punctuation">.</span><span class="token function">setModifiedTime</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 执行增加</span>
		<span class="token function">addnew</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p>完成后，在<strong>src/test/java</strong>下创建<code>cn.tedu.store.service.AddressServiceTests</code>测试类，编写并执行单元测试：</p> 
<pre><code class="prism language-java">	<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span>SpringRunner<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
	<span class="token annotation punctuation">@SpringBootTest</span>
	<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AddressServiceTests</span> <span class="token punctuation">{<!-- --></span>
	
		<span class="token annotation punctuation">@Autowired</span>
		IAddressService service<span class="token punctuation">;</span>
		
		<span class="token annotation punctuation">@Test</span>
		<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
				Integer uid <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
				String username <span class="token operator">=</span> <span class="token string">"超级管理员"</span><span class="token punctuation">;</span>
				Address address <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				address<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"小赵同学"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				address<span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token string">"开心小区1号2单元303室"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				service<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>uid<span class="token punctuation">,</span> username<span class="token punctuation">,</span> address<span class="token punctuation">)</span><span class="token punctuation">;</span>
				System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"OK."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ServiceException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		
	<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="32__283"></a>32. 收货地址-增加-控制器层</h4> 
<p><strong>(a) 统一处理异常</strong></p> 
<p>需要处理<code>AddressCountLimitException</code>。</p> 
<p><strong>(b) 设计请求</strong></p> 
<p>设计“增加收货地址”的请求方式：</p> 
<pre><code>请求路径：/addresses/create
请求参数：Address address, HttpSession session
请求方式：POST
响应数据：JsonResult&lt;Void&gt;
</code></pre> 
<p><strong>© 处理请求</strong></p> 
<p>创建<code>cn.tedu.store.controller.AddressController</code>，继承自<code>BaseController</code>，在类之前添加<code>@RestController</code>和<code>@RequestMapping("addresses")</code>注解，在类中添加<code>@Autowired private IAddressService addressService;</code>业务层对象：</p> 
<pre><code>@RestController
@RequestMapping("addresses")
public class AddressController extends BaseController {

	@Autowired
	private IAddressService addressService;

}
</code></pre> 
<p>然后，添加处理请求的方法：</p> 
<pre><code>@RequestMapping("create")
public JsonResult&lt;Void&gt; create(Address address, HttpSession session) {
	// 从Session中获取uid和username
	// 调用业务层对象执行新增收货地址
	// 返回成功
}
</code></pre> 
<p>完成后，打开浏览器，先登录，通过<code>http://localhost:8080/addresses/create?name=Kitty</code>进行测试。</p> 
<p>检查完成后，可以将接口中的<code>MAX_COUNT</code>设置为更大一些的值。</p> 
<h4><a id="33__324"></a>33. 收货地址-增加-前端界面</h4> 
<h4><a id="34__326"></a>34. 收货地址-导入省市区数据</h4> 
<p>进入MySQL控制台，执行指令以导入省市区数据</p> 
<pre><code>source 脚本文件路径
</code></pre> 
<h4><a id="35__332"></a>35. 服务器端提供省/市/区的数据查询功能</h4> 
<p>首先，应该创建与数据表对应的<code>cn.tedu.store.entity.District</code>实体类：</p> 
<pre><code>public class District implements Serializable {
	private Integer id;
	private String parent;
	private String code;
	private String name;
}
</code></pre> 
<p>服务器端需要提供“获取全国所有的省的列表”、“获取某省所有的市的列表”、“某市所有的区的列表”功能，这些功能的查询操作都是：</p> 
<pre><code>select * from t_dict_district where parent=?
</code></pre> 
<p>所以，在处理持久层时，先创建<code>cn.tedu.store.mapper.DistrictMapper</code>持久层接口，并添加抽象方法：</p> 
<pre><code>List&lt;District&gt; findByParent(String parent);
</code></pre> 
<p>然后，复制得到<code>DistrictMapper.xml</code>文件，并配置以上抽象方法的映射：</p> 
<pre><code class="prism language-xml">	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>findByParent<span class="token punctuation">"</span></span> 
		<span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>cn.tedu.store.entity.District<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
		SELECT 
			id, parent,
			code, name
		FROM 
			t_dict_district 
		WHERE 
			parent=#{parent}
		ORDER BY
			code ASC
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>在<strong>src/test/java</strong>下创建<code>cn.tedu.store.mapper.DistrictMapperTests</code>测试类，编写并执行单元测试：</p> 
<pre><code class="prism language-java">	<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span>SpringRunner<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
	<span class="token annotation punctuation">@SpringBootTest</span>
	<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DistrictMapperTests</span> <span class="token punctuation">{<!-- --></span>
	
		<span class="token annotation punctuation">@Autowired</span>
		DistrictMapper mapper<span class="token punctuation">;</span>
		
		<span class="token annotation punctuation">@Test</span>
		<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">findByParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			String parent <span class="token operator">=</span> <span class="token string">"86"</span><span class="token punctuation">;</span>
			List<span class="token generics function"><span class="token punctuation">&lt;</span>District<span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">findByParent</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
			System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"count="</span> <span class="token operator">+</span> list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span>District item <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		
	<span class="token punctuation">}</span>
</code></pre> 
<p>创建<code>cn.tedu.store.service.IDistrictService</code>接口，然后，在接口中添加抽象方法：</p> 
<pre><code>List&lt;District&gt; getByParent(String parent);
</code></pre> 
<p>创建<code>cn.tedu.store.service.impl.DistrictServiceImpl</code>类，实现<code>IDistrictService</code>接口，在类之前添加<code>@Service</code>注解，在类中添加<code>@Autowired private DistrictMapper districtMapper;</code>持久层对象：</p> 
<pre><code>@Service
public class DistrictServiceImpl implements IDistrictService {
	@Autowired
	private DistrictMapper districtMapper;
}
</code></pre> 
<p>然后，复制持久层接口中的抽象方法，粘贴到该实现类中，然后，私有化实现这2个方法：</p> 
<pre><code>/**
 * 获取全国所有省/某省所有市/某市所有区的列表
 * @param parent 父级单位的代号，如果获取全国所有省，则使用86作为父级代号
 * @return 匹配的省或市或区的列表
 */
private List&lt;District&gt; findByParent(String parent) {
	return districtMapper.findByParent(parent);
}
</code></pre> 
<p>重写接口中的抽象方法：</p> 
<pre><code>public List&lt;District&gt; getByParent(String parent) {
	return findByParent(parent);
}
</code></pre> 
<p>完成后，在<strong>src/test/java</strong>下创建<code>cn.tedu.store.service.DistrictServiceTests</code>测试类，编写并执行单元测试：</p> 
<pre><code class="prism language-java">	<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span>SpringRunner<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
	<span class="token annotation punctuation">@SpringBootTest</span>
	<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DistrictServiceTests</span> <span class="token punctuation">{<!-- --></span>
	
		<span class="token annotation punctuation">@Autowired</span>
		IDistrictService service<span class="token punctuation">;</span>
		
		<span class="token annotation punctuation">@Test</span>
		<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getByParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			String parent <span class="token operator">=</span> <span class="token string">"86"</span><span class="token punctuation">;</span>
			List<span class="token generics function"><span class="token punctuation">&lt;</span>District<span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">getByParent</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
			System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"count="</span> <span class="token operator">+</span> list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span>District item <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		
	<span class="token punctuation">}</span>
</code></pre> 
<p>后续，客户提交的请求应该是：</p> 
<pre><code>请求路径：/districts/
请求参数：String parent
请求类型：GET
响应数据：JsonResult&lt;List&lt;District&gt;&gt;
是否拦截：否，需要添加白名单
</code></pre> 
<p>创建<code>cn.tedu.store.controller.DistrictController</code>，继承自<code>BaseController</code>，在类之前添加<code>@RestController</code>和<code>@RequestMapping("districts")</code>注解，在类中添加<code>@Autowired private IDistrictService districtService;</code>业务层对象：</p> 
<pre><code>@RestController
@RequestMapping("districts")
public class DistrictController extends BaseController {

	@Autowired
	private IDistrictService districtService;

}
</code></pre> 
<p>然后，添加处理请求的方法：</p> 
<pre><code>@GetMapping("/")
public JsonResult&lt;List&lt;District&gt;&gt; getByParent(String parent) {
	// 调用业务层对象执行查询
	// 返回成功和查询结果
}
</code></pre> 
<p>然后，在拦截器的配置中，将<code>/districts/**</code>添加为白名单。</p> 
<p>完成后，打开浏览器，先登录，通过<code>http://localhost:8080/districts/?parent=86</code>进行测试。</p> 
<h4><a id="36__467"></a>36. 收货地址-增加-业务层-补</h4> 
<p>首先，需要在<code>DistrictMapper.java</code>接口中定义抽象方法：</p> 
<pre><code>District findByCode(String code);
</code></pre> 
<p>然后，在<code>DistrictMapper.xml</code>中配置映射，SQL语句大致是：</p> 
<pre><code>select name from t_ditc_district where code=?
</code></pre> 
<p>完成后，在<code>DistrictMapperTests</code>中编写并执行单元测试：</p> 
<p>由于不允许在处理<code>Address</code>的业务层中直接访问以上<code>DistrictMapper</code>接口中的内容，所以，还需要以上功能开发至业务层！使得处理<code>Address</code>的业务层时，可以调用处理<code>District</code>数据的业务层功能！</p> 
<p>所以，在<code>IDistrictService</code>中添加抽象方法：</p> 
<pre><code>District getByCode(String code);
</code></pre> 
<p>然后，在业务层中先私有化实现持久层的新方法：</p> 
<pre><code>private District findByCode(String code) {
	return districtMapper.findByCode(code);
}
</code></pre> 
<p>再实现接口中的抽象方法：</p> 
<pre><code>public District getByCode(String code) {
	return findByCode(code);
}
</code></pre> 
<p>完成后，在<code>DistrictServiceTests</code>中编写并执行单元测试：</p> 
<p>接下来，就可以在<code>AddressServiceImpl</code>中声明<code>@Autowired IDistrictService districtService;</code>对象，并添加用于“根据省/市/区”代号获取名称的私有方法：</p> 
<pre><code>/**
 * 根据省/市/区的代号获取名称
 * @param code 省/市/区的代号
 * @return 省/市/区的代号匹配的名称，如果没有匹配的数据，则返回空字符串
 */
private String getDistrictNameByCode(String code) {
	District result = districtService.getByCode("");
	return result == null ? "" : result.getName();
}
</code></pre> 
<p>最后，在“增加”功能的业务层中，调用3次以上方法，根据代号获取对应的名称，并装到参数<code>address</code>中执行增加，则最终添加的数量中就是包含省市区数据的！</p> 
<p>完全完成后，包括测试也通过后，应该删除现在的全部数据，然后，增加不少于10数据。</p> 
<h4><a id="37__515"></a>37. 收货地址-显示列表-持久层</h4> 
<p><strong>(a) 规划SQL语句</strong></p> 
<p>查询所需要显示的列表的SQL语句大致是：</p> 
<pre><code>select 
	*
from 
	t_address 
where 
	uid=?
</code></pre> 
<p><strong>(b) 接口与抽象方法</strong></p> 
<p>在<code>AddressMapper</code>中添加抽象方法：</p> 
<pre><code>/**
 * 获取某用户的收货地址数据的列表
 * @param uid 用户的id
 * @return 用户的收货地址数据的列表
 */
List&lt;Address&gt; findByUid(Integer uid);
</code></pre> 
<p><strong>© 配置映射</strong></p> 
<p>如果查询列表中的字段列表使用<code>*</code>号，则表示查询所有字段，由于存在查询结果的列名与封装的对象的属性名不匹配的问题，所以，先配置一个<code>&lt;resultMap&gt;</code>（可参考<strong>UserMapper.xml</strong>中的配置）：</p> 
<pre><code class="prism language-xml">	<span class="token comment">&lt;!-- 查询结果与收货地址数据实体的映射 --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AddressEntityMap<span class="token punctuation">"</span></span> 
		<span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>cn.tedu.store.entity.Address<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>aid<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>aid<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>uid<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>uid<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>province_code<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>provinceCode<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>province_name<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>provinceName<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>city_code<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>cityCode<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>city_name<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>cityName<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>area_code<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>areaCode<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>area_name<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>areaName<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>zip<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>zip<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>tel<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>tel<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>phone<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>phone<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>tag<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>tag<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>is_default<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>isDefault<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>created_user<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>createdUser<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>created_time<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>createdTime<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>modified_user<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>modifiedUser<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>modified_time<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>modifiedTime<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>然后配置以上接口中的抽象方法：</p> 
<pre><code class="prism language-xml">	<span class="token comment">&lt;!-- 获取某用户的收货地址数据的列表 --&gt;</span>
	<span class="token comment">&lt;!-- List&lt;Address&gt; findByUid(Integer uid) --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>findByUid<span class="token punctuation">"</span></span>
		<span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AddressEntityMap<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
		SELECT 
			*
		FROM 
			t_address 
		WHERE 
			uid=#{uid}
		ORDER BY
			is_default DESC,
			modified_time DESC
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>在<code>AddressMapperTests</code>中测试：</p> 
<pre><code>@Test
public void findByUid() {
	Integer uid = 7;
	List&lt;Address&gt; list = mapper.findByUid(uid);
	System.err.println("count=" + list.size());
	for (Address item : list) {
		System.err.println(item);
	}
}
</code></pre> 
<h4><a id="38__596"></a>38. 收货地址-显示列表-业务层</h4> 
<p><strong>(a) 规划异常</strong></p> 
<p>无</p> 
<p><strong>(b) 接口与抽象方法</strong></p> 
<p>将持久层中的抽象方法复制到业务层接口，然后把方法名的<code>find</code>改成<code>get</code>：</p> 
<pre><code>/**
 * 获取某用户的收货地址数据的列表
 * @param uid 用户的id
 * @return 用户的收货地址数据的列表
 */
List&lt;Address&gt; getByUid(Integer uid);
</code></pre> 
<p><strong>© 实现抽象方法</strong></p> 
<p>将持久层中的抽象方法复制到业务层实现类，然后私有化实现：</p> 
<pre><code class="prism language-java">	<span class="token comment">/**
	 * 获取某用户的收货地址数据的列表
	 * @param uid 用户的id
	 * @return 用户的收货地址数据的列表
	 */</span>
	<span class="token keyword">private</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>Address<span class="token punctuation">&gt;</span></span> <span class="token function">findByUid</span><span class="token punctuation">(</span>Integer uid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		List<span class="token generics function"><span class="token punctuation">&lt;</span>Address<span class="token punctuation">&gt;</span></span> addresses <span class="token operator">=</span> addressMapper<span class="token punctuation">.</span><span class="token function">findByUid</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>Address address <span class="token operator">:</span> addresses<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			address<span class="token punctuation">.</span><span class="token function">setTel</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
			address<span class="token punctuation">.</span><span class="token function">setZip</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
			address<span class="token punctuation">.</span><span class="token function">setCreatedUser</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
			address<span class="token punctuation">.</span><span class="token function">setCreatedTime</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
			address<span class="token punctuation">.</span><span class="token function">setModifiedUser</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
			address<span class="token punctuation">.</span><span class="token function">setModifiedTime</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> addresses<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

然后添加接口中定义的抽象方法：

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>Address<span class="token punctuation">&gt;</span></span> <span class="token function">getByUid</span><span class="token punctuation">(</span>Integer uid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token function">findByUid</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

完成后，进行测试：

	<span class="token annotation punctuation">@Test</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getByUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		Integer uid <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
		List<span class="token generics function"><span class="token punctuation">&lt;</span>Address<span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">getByUid</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
		System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"count="</span> <span class="token operator">+</span> list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>Address item <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="39__654"></a>39. 收货地址-显示列表-控制器层</h4> 
<p><strong>(a) 统一处理异常</strong></p> 
<p>无</p> 
<p><strong>(b) 设计请求</strong></p> 
<p>设计“收货地址-显示列表”的请求方式：</p> 
<pre><code>请求路径：/addresses/
请求参数：HttpSession session
请求方式：GET
响应数据：JsonResult&lt;List&lt;Address&gt;&gt;
</code></pre> 
<p><strong>© 处理请求</strong></p> 
<pre><code>@GetMapping
public JsonResult&lt;List&lt;Address&gt;&gt; getByUid(HttpSession session) {

}
</code></pre> 
<p>完成后，打开浏览器，可通过<code>http://localhost:8080/addresses/</code>进行测试访问。</p> 
<h4><a id="40__678"></a>40. 收货地址-显示列表-前端界面</h4> 
<h4><a id="41__681"></a>41. 收货地址-设为默认-持久层</h4> 
<p><strong>(a) 规划SQL语句</strong></p> 
<p>如果需要把某条收货地址设置为默认，需要执行的SQL语句大致是：</p> 
<pre><code>update t_address set is_default=1,modified_user=?,modified_time=? where aid=?
</code></pre> 
<p>除此以外，还需要将原有的默认地址设置为非默认，由于原默认收货地址数据的id可能是未知的，可以“将该用户的所有收货地址设置为非默认，然后再把指定的那条设置为默认”即可，所以，“将该用户的所有收货地址设置为非默认”的SQL语句大致是：</p> 
<pre><code>update t_address set is_default=0 where uid=?
</code></pre> 
<p>在操作数据之前，还是应该对数据进行检查，例如：检查收货地址数据是否存在，对应的SQL查询是：</p> 
<pre><code>select aid from t_address where aid=?
</code></pre> 
<p>以上查询时，查询的字段并不重要，最终只需要判断查询结果是否为null即可，即：用于判断将要被设置为默认的收货地址数据是否存在。</p> 
<p>除此以外，由于参数aid是客户端提交的，应该视为不可靠数据，该aid对应的数据可能是不存在的，另外，也可能是他人的数据，所以，在查询时，还应该将uid也查询出来，用于和Session中的uid对比，以判断即将需要操作的数据的归属是否正常：</p> 
<pre><code>select uid from t_address where aid=?
</code></pre> 
<p><strong>(b) 接口与抽象方法</strong></p> 
<p>在<code>AddressMapper.java</code>接口中，声明3个抽象方法：</p> 
<pre><code>Integer updateDefault(
	@Param("aid") Integer aid, 
	@Param("username") String username, 
	@Param("modifiedTime") Date modifiedTime);

Integer updateNonDefault(Integer uid);

Address findByAid(Integer aid);
</code></pre> 
<p><strong>© 配置映射</strong></p> 
<p>映射：</p> 
<pre><code class="prism language-xml">	<span class="token comment">&lt;!-- 将指定的收货地址设置为默认 --&gt;</span>
	<span class="token comment">&lt;!-- Integer updateDefault(
			@Param("aid") Integer aid, 
			@Param("username") String username, 
			@Param("modifiedTime") Date modifiedTime) --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>update</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>updateDefault<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
		UPDATE
			t_address
		SET
			is_default=1,
			modified_user=#{username},
			modified_time=#{modifiedTime}
		WHERE
			aid=#{aid}
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>update</span><span class="token punctuation">&gt;</span></span>
	
	<span class="token comment">&lt;!-- 将指定用户的收货地址全部设置为非默认 --&gt;</span>
	<span class="token comment">&lt;!-- Integer updateNonDefault(Integer uid) --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>update</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>updateNonDefault<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
		UPDATE
			t_address
		SET
			is_default=0
		WHERE
			uid=#{uid}
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>update</span><span class="token punctuation">&gt;</span></span>

	<span class="token comment">&lt;!-- 根据收货地址id查询收货地址详情 --&gt;</span>
	<span class="token comment">&lt;!-- Address findByAid(Integer aid) --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>findByAid<span class="token punctuation">"</span></span>
		<span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AddressEntityMap<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
		SELECT 
			*
		FROM 
			t_address 
		WHERE 
			aid=#{aid}
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>单元测试：</p> 
<pre><code class="prism language-java">	<span class="token annotation punctuation">@Test</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		Integer aid <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>
		String username <span class="token operator">=</span> <span class="token string">"哈哈"</span><span class="token punctuation">;</span>
		Date modifiedTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		Integer rows <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">updateDefault</span><span class="token punctuation">(</span>aid<span class="token punctuation">,</span> username<span class="token punctuation">,</span> modifiedTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
		System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"rows="</span> <span class="token operator">+</span> rows<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token annotation punctuation">@Test</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateNonDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		Integer uid <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
		Integer rows <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">updateNonDefault</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
		System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"rows="</span> <span class="token operator">+</span> rows<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token annotation punctuation">@Test</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">findByAid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		Integer aid <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>
		Address result <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">findByAid</span><span class="token punctuation">(</span>aid<span class="token punctuation">)</span><span class="token punctuation">;</span>
		System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="42__784"></a>42. 收货地址-设为默认-业务层</h4> 
<p><strong>(a) 规划异常</strong></p> 
<p>此次设为默认的主要操作是<code>Update</code>操作，则可能抛出<code>UpdateException</code>；</p> 
<p>在操作之前，应该检查被设置为默认的数据是否存在，所以，可能抛出<code>AddressNotFoundException</code>；</p> 
<p>在检查时，还应该检查数据归属是否正确，即用户操作的是不是自己的数据，如果不是，则抛出<code>AccessDeniedException</code>。</p> 
<p><strong>(b) 接口与抽象方法</strong></p> 
<p>在<code>IAddressService</code>接口中添加：</p> 
<pre><code>void setDefault(Integer aid, Integer uid, String username) throws AddressNotFoundException, AccessDeniedException, UpdateException;
</code></pre> 
<p><strong>© 实现抽象方法</strong></p> 
<p>先从<code>AddressMapper.java</code>接口中复制新的抽象方法并粘贴到业务层实现类<code>AddressServiceImpl</code>中，并私有化实现这些方法：</p> 
<p>然后，重写<code>IAddressService</code>接口中的抽象方法：</p> 
<pre><code>public void setDefault(Integer aid, Integer uid, String username) throws AddressNotFoundException, AccessDeniedException, UpdateException {
	// 根据参数aid查询数据
	// 判断查询结果是否为null
	// 是：AddressNotFoundException

	// 判断查询结果中的uid与参数uid是否不同
	// 是：AccessDeniedException

	// 将该用户的所有收货地址设置为非默认

	// 将指定的收货地址设置为默认
}
</code></pre> 
<p>具体实现为：</p> 
<pre><code class="prism language-java">	<span class="token annotation punctuation">@Override</span>
	<span class="token annotation punctuation">@Transactional</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setDefault</span><span class="token punctuation">(</span>Integer aid<span class="token punctuation">,</span> Integer uid<span class="token punctuation">,</span> String username<span class="token punctuation">)</span>
			<span class="token keyword">throws</span> AddressNotFoundException<span class="token punctuation">,</span> AccessDeniedException<span class="token punctuation">,</span> UpdateException <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 根据参数aid查询数据</span>
		Address result <span class="token operator">=</span> <span class="token function">findByAid</span><span class="token punctuation">(</span>aid<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 判断查询结果是否为null</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 是：AddressNotFoundException</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AddressNotFoundException</span><span class="token punctuation">(</span>
				<span class="token string">"设置默认收货地址失败！尝试访问的数据不存在！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 判断查询结果中的uid与参数uid是否不同</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span><span class="token function">getUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 是：AccessDeniedException</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AccessDeniedException</span><span class="token punctuation">(</span>
				<span class="token string">"设置默认收货地址失败！不允许访问他人的数据！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 将该用户的所有收货地址设置为非默认</span>
		<span class="token function">updateNonDefault</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 将指定的收货地址设置为默认</span>
		<span class="token function">updateDefault</span><span class="token punctuation">(</span>aid<span class="token punctuation">,</span> username<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

完成后，单元测试：

	<span class="token annotation punctuation">@Test</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
			Integer aid <span class="token operator">=</span> <span class="token number">250</span><span class="token punctuation">;</span>
			Integer uid <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
			String username <span class="token operator">=</span> <span class="token string">"呵呵"</span><span class="token punctuation">;</span>
			service<span class="token punctuation">.</span><span class="token function">setDefault</span><span class="token punctuation">(</span>aid<span class="token punctuation">,</span> uid<span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>
			System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"OK."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ServiceException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="43__865"></a>43. 收货地址-设为默认-控制器层</h4> 
<p><strong>(a) 统一处理异常</strong></p> 
<p>需要处理2个新的异常！</p> 
<p><strong>(b) 设计请求</strong></p> 
<p>设计“收货地址-设为默认”的请求方式：</p> 
<pre><code>请求路径：/addresses/{aid}/set_default
请求参数：@PathVariable("aid") Integer aid, HttpSession session
请求方式：POST
响应数据：JsonResult&lt;Void&gt;

http://localhost:8080/addresses/18/set_default
</code></pre> 
<p><strong>© 处理请求</strong></p> 
<pre><code>@RequestMapping("{aid}/set_default")
public JsonResult&lt;Void&gt; setDefault(
	@PathVariable("aid") Integer aid, 
	HttpSession session) {
	// 从Session中获取uid和username
	Integer uid = getUidFromSession(session);
	String username = getUsernameFromSession(session);
	// 调用业务层对象执行设置默认
	addressService.setDefault(aid, uid, username);
	// 返回
	return new JsonResult&lt;&gt;(SUCCESS);
}
</code></pre> 
<h4><a id="44__897"></a>44. 收货地址-设为默认-前端界面</h4> 
<h4><a id="45__899"></a>45. 收货地址－删除-持久层</h4> 
<p><strong>(a) 规划SQL语句</strong></p> 
<p>当执行删除时，需要执行的SQL语句大致是：</p> 
<pre><code>delete from t_address where aid=?
</code></pre> 
<p>在执行删除之前，还应该检查数据是否存在和数据归属是否正确，这项检查功能已经存在，无需再开发或调整。</p> 
<p>如果删除的是“默认”的收货地址，如果这已经是最后一条收货地址，则无需进行后续的任何处理，可以在删除之后，再次通过此前的<code>countByUid()</code>进行查询，从而得知刚才删除的是不是最后一条收货地址。</p> 
<p>如果删除的是“默认”的收货地址，且还有更多的收货地址，则应该把剩余的收货地址中的某一条设置为默认，可以制定规则“将最近修改的那条设置为默认”，设置为默认可以使用此前的<code>updateDefault()</code>直接完成，而“找出最近修改的收货地址”需要执行的SQL语句大致是：</p> 
<pre><code>select * from t_address where uid=? order by modified_time desc limit 0,1
</code></pre> 
<p><strong>(b) 接口与抽象方法</strong></p> 
<p>则需要在持久层接口中添加2个抽象方法：</p> 
<pre><code>Integer deleteByAid(Integer aid);

Address findLastModified(Integer uid);
</code></pre> 
<p><strong>© 配置映射</strong></p> 
<p>映射：</p> 
<pre><code class="prism language-xml">	<span class="token comment">&lt;!-- 根据收货地址数据的id删除收货地址 --&gt;</span>
	<span class="token comment">&lt;!-- Integer deleteByAid(Integer aid) --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>delete</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>deleteByAid<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
		DELETE FROM
			t_address
		WHERE
			aid=#{aid}
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>delete</span><span class="token punctuation">&gt;</span></span>

	<span class="token comment">&lt;!-- 查询某用户最后修改的收货地址数据 --&gt;</span>
	<span class="token comment">&lt;!-- Address findLastModified(Integer uid) --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>findLastModified<span class="token punctuation">"</span></span>
		<span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AddressEntityMap<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
		SELECT
			*
		FROM
			t_address
		WHERE
			uid=#{uid}
		ORDER BY
			modified_time DESC
		LIMIT
			0,1
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>测试：</p> 
<pre><code>@Test
public void deleteByAid() {
	Integer aid = 20;
	Integer rows = mapper.deleteByAid(aid);
	System.err.println("rows=" + rows);
}

@Test
public void findLastModified() {
	Integer uid = 7;
	Address result = mapper.findLastModified(uid);
	System.err.println(result);
}
</code></pre> 
<h4><a id="46__968"></a>46. 收货地址－删除-业务层</h4> 
<p><strong>(a) 规划异常</strong></p> 
<p>删除时：DeleteException；</p> 
<p>删除前：AddressNotFoundException，AccessDeniedException；</p> 
<p>删除后：UpdateException。</p> 
<p><strong>(b) 接口与抽象方法</strong></p> 
<pre><code>void delete(Integer aid, Integer uid, String username) throws AddressNotFoundException, AccessDeniedException, DeleteException, UpdateException;
</code></pre> 
<p><strong>© 实现抽象方法</strong></p> 
<p>私有化实现持久层中新增的方法：</p> 
<pre><code class="prism language-java">	<span class="token comment">/**
	 * 根据收货地址数据的id删除收货地址
	 * @param aid 收货地址数据的id
	 * @throws DeleteException 删除数据异常
	 */</span>
	<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">deleteByAid</span><span class="token punctuation">(</span>Integer aid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		Integer rows <span class="token operator">=</span> addressMapper<span class="token punctuation">.</span><span class="token function">deleteByAid</span><span class="token punctuation">(</span>aid<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>rows <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">DeleteException</span><span class="token punctuation">(</span>
				<span class="token string">"删除收货地址失败！出现未知错误！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
	 * 查询某用户最后修改的收货地址数据
	 * @param uid 用户的id
	 * @return 该用户最后修改的收货地址数据
	 */</span>
	<span class="token keyword">private</span> Address <span class="token function">findLastModified</span><span class="token punctuation">(</span>Integer uid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> addressMapper<span class="token punctuation">.</span><span class="token function">findLastModified</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

重写业务接口中的抽象方法：

	<span class="token annotation punctuation">@Transactional</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span>Integer aid<span class="token punctuation">,</span> Integer uid<span class="token punctuation">,</span> String username<span class="token punctuation">)</span> <span class="token keyword">throws</span> AddressNotFoundException<span class="token punctuation">,</span> AccessDeniedException<span class="token punctuation">,</span> DeleteException<span class="token punctuation">,</span> UpdateException <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 根据参数aid查询数据</span>
		<span class="token comment">// 判断查询结果是否为null：AddressNotFoundException</span>

		<span class="token comment">// 判断查询结果中的uid与参数uid是否不同：AccessDeniedException</span>

		<span class="token comment">// 执行删除</span>

		<span class="token comment">// 判断此前的查询结果中的isDefault是否为0：return</span>

		<span class="token comment">// 根据参数uid统计收货地址数量</span>
		<span class="token comment">// 判断数量为0：return</span>

		<span class="token comment">// 根据参数uid查询最后修改的收货地址</span>

		<span class="token comment">// 根据查询到的最后修改的收货地址中的aid执行设置默认</span>
	<span class="token punctuation">}</span>

实现：

	<span class="token annotation punctuation">@Override</span>
	<span class="token annotation punctuation">@Transactional</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span>Integer aid<span class="token punctuation">,</span> Integer uid<span class="token punctuation">,</span> String username<span class="token punctuation">)</span>
			<span class="token keyword">throws</span> AddressNotFoundException<span class="token punctuation">,</span> AccessDeniedException<span class="token punctuation">,</span> DeleteException<span class="token punctuation">,</span> UpdateException <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 根据参数aid查询数据</span>
		Address result <span class="token operator">=</span> <span class="token function">findByAid</span><span class="token punctuation">(</span>aid<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 判断查询结果是否为null</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 是：AddressNotFoundException</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AddressNotFoundException</span><span class="token punctuation">(</span>
				<span class="token string">"删除收货地址失败！尝试访问的数据不存在！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 判断查询结果中的uid与参数uid是否不同</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span><span class="token function">getUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 是：AccessDeniedException</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AccessDeniedException</span><span class="token punctuation">(</span>
				<span class="token string">"删除收货地址失败！不允许访问他人的数据！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 执行删除</span>
		<span class="token function">deleteByAid</span><span class="token punctuation">(</span>aid<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 判断此前的查询结果中的isDefault是否为0：return</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getIsDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 根据参数uid统计收货地址数量</span>
		Integer count <span class="token operator">=</span> <span class="token function">countByUid</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 判断数量为0：return</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 根据参数uid查询最后修改的收货地址</span>
		Address lastModifiedAddress <span class="token operator">=</span> <span class="token function">findLastModified</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 根据查询到的最后修改的收货地址中的aid执行设置默认</span>
		<span class="token function">updateDefault</span><span class="token punctuation">(</span>lastModifiedAddress<span class="token punctuation">.</span><span class="token function">getAid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> username<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

测试：

	<span class="token annotation punctuation">@Test</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
			Integer aid <span class="token operator">=</span> <span class="token number">26</span><span class="token punctuation">;</span>
			Integer uid <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
			String username <span class="token operator">=</span> <span class="token string">"呵呵"</span><span class="token punctuation">;</span>
			service<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>aid<span class="token punctuation">,</span> uid<span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>
			System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"OK."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ServiceException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="47__1089"></a>47. 收货地址－删除-控制器层</h4> 
<p><strong>(a) 统一处理异常</strong></p> 
<p>处理：DeleteException</p> 
<p><strong>(b) 设计请求</strong></p> 
<p>设计“收货地址－删除”的请求方式：</p> 
<pre><code>/resources/id/command

请求路径：/addresses/{aid}/delete
请求参数：@PathVariable("aid") Integer aid, HttpSession session
请求方式：POST
响应数据：JsonResult&lt;Void&gt;

http://localhost:8080/addresses/18/delete
</code></pre> 
<p><strong>© 处理请求</strong><br> ```java<br> @RequestMapping("{aid}/delete")<br> public JsonResult delete(<br> @PathVariable(“aid”) Integer aid,<br> HttpSession session) {<!-- --><br> // 从Session中获取uid和username<br> Integer uid = getUidFromSession(session);<br> String username = getUsernameFromSession(session);<br> // 调用业务层对象执行删除<br> addressService.delete(aid, uid, username);<br> // 返回<br> return new JsonResult&lt;&gt;(SUCCESS);<br> }</p> 
<pre><code>### 48. 收货地址－删除-前端界面

</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f004d1d4da27a18eb37391e1af12ea03/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">要开始准备找工作了，昨天闲时就自己写了个数据结构排序类，包括了堆排序，归并排序，速度排序，插入排序。...</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8604b0db5adf043ff5f3308d7606411f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">11-字符数组和字符串函数</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>