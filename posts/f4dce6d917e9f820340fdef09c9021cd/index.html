<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>微信小程序蓝牙功能全套开发流程介绍 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="微信小程序蓝牙功能全套开发流程介绍" />
<meta property="og:description" content="一、开发流程 流程图：流程图作者原文章 实现模块顺序 1.1初始化蓝牙模块（打开蓝牙适配器） 初次加载，自动获取获取系统信息，检查蓝牙适配器是否可用
初始化蓝牙，提示打开GPS和蓝牙，开始自动搜索蓝牙设备
1.2搜索周围蓝牙 开始搜索蓝牙设备，定时1s获取搜索到的设备
把搜索到的设备保存在一个数组内，渲染在页面
1.3监听搜索设备 监听5s后停止搜索，并把新设备push到数组进行渲染
显示设备名称和连接按钮
1.4连接目标设备 点击连接按钮创建连接，获取设备信息
连接成功停止搜索，获取已连接蓝牙的服务
1.5获取服务、特征值 连接成功获取蓝牙设备服务和特征值(是否能读写)
1.6开启notify，监听特征值变化 开启监听功能，发送指令后接收设备响应的数据
1.7发送指令、读写数据 设备特征值中写入数据，必须设备的特征支持 write
ArrayBuffer转16进制字符串
1.8断开连接 清空设备名、设备id，关闭蓝牙模块
二、实现模块代码 初始化蓝牙模块（打开蓝牙适配器） openBluetoothAdapter() { let that = this; uni.openBluetoothAdapter({ //初始化蓝牙模块 success(res) { console.log(res, &#39;初始化蓝牙成功&#39;); uni.onBluetoothAdapterStateChange((res) =&gt; { // 监听蓝牙适配器状态变化 if (!res.available) { uni.showModal({ title: &#39;温馨提示&#39;, content: &#39;蓝牙适配器不可用，请重新启动&#39;, showCancel: false }); } }); that.searchBlue(); //开始搜索 }, fail(res) { console.log(res, &#39;初始化蓝牙失败&#39;); uni.showToast({ title: &#39;请检查手机蓝牙是否打开&#39;, icon: &#39;none&#39; }); } }); }, 开始搜索周围蓝牙 searchBlue() { let that = this; uni." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/f4dce6d917e9f820340fdef09c9021cd/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-14T16:44:15+08:00" />
<meta property="article:modified_time" content="2023-11-14T16:44:15+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">微信小程序蓝牙功能全套开发流程介绍</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div> 
 <p></p> 
 <h2>一、开发流程</h2> 
 <ol><li style="margin-left:1.4em;"> <h3>流程图：<a class="kdocs-link" href="http://iotts.com.cn/blog/2022/05/30/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E8%93%9D%E7%89%99BLE%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94API%E5%8F%8A%E6%B5%81%E7%A8%8B%E4%BB%8B%E7%BB%8D-%E4%B8%80/" rel="nofollow" title="流程图作者原文章">流程图作者原文章</a></h3> </li></ol> 
 <div> 
  <div> 
   <div> 
    <img alt="" src="https://images2.imgbox.com/52/49/g7lwq6Tc_o.png" width="549"> 
   </div> 
  </div> 
 </div> 
 <ol><li style="margin-left:1.4em;text-align:left;"> <h3>实现模块顺序</h3> </li></ol> 
 <h4>1.1初始化蓝牙模块（打开蓝牙适配器）</h4> 
 <p>初次加载，自动获取获取系统信息，检查蓝牙适配器是否可用</p> 
 <p>初始化蓝牙，提示打开GPS和蓝牙，开始自动搜索蓝牙设备</p> 
 <div> 
  <div> 
   <div> 
    <img alt="" src="https://images2.imgbox.com/ec/05/sW8LlH9u_o.png" width="670"> 
   </div> 
  </div> 
 </div> 
 <div> 
  <div> 
   <div> 
    <img alt="" src="https://images2.imgbox.com/90/bb/2EswqAHa_o.png" width="646"> 
   </div> 
  </div> 
 </div> 
 <h4>1.2搜索周围蓝牙</h4> 
 <p>开始搜索蓝牙设备，定时1s获取搜索到的设备</p> 
 <p>把搜索到的设备保存在一个数组内，渲染在页面</p> 
 <div> 
  <div> 
   <div> 
    <img alt="" src="https://images2.imgbox.com/8d/97/DrxOA5rB_o.png" width="658"> 
   </div> 
  </div> 
 </div> 
 <h4>1.3监听搜索设备</h4> 
 <p>监听5s后停止搜索，并把新设备push到数组进行渲染</p> 
 <p>显示设备名称和连接按钮</p> 
 <h4>1.4连接目标设备</h4> 
 <p>点击连接按钮创建连接，获取设备信息</p> 
 <p>连接成功停止搜索，获取已连接蓝牙的服务</p> 
 <div> 
  <div> 
   <div> 
    <img alt="" src="https://images2.imgbox.com/95/0c/lACwx8Gc_o.png" width="624"> 
   </div> 
  </div> 
 </div> 
 <h4>1.5获取服务、特征值</h4> 
 <p>连接成功获取蓝牙设备服务和特征值(是否能读写)</p> 
 <div> 
  <div> 
   <div> 
    <img alt="" src="https://images2.imgbox.com/58/fa/DwdfLPmk_o.png" width="649"> 
   </div> 
  </div> 
 </div> 
 <h4>1.6开启notify，监听特征值变化</h4> 
 <p>开启监听功能，发送指令后接收设备响应的数据</p> 
 <div> 
  <div> 
   <div> 
    <img alt="" src="https://images2.imgbox.com/ba/d9/RRnsGpHq_o.png" width="594"> 
   </div> 
  </div> 
 </div> 
 <h4>1.7发送指令、读写数据</h4> 
 <p>设备特征值中写入数据，必须设备的特征支持 write</p> 
 <p>ArrayBuffer转16进制字符串</p> 
 <div> 
  <div> 
   <div> 
    <img alt="" src="https://images2.imgbox.com/d2/dc/8Cy84L9n_o.png" width="580"> 
   </div> 
  </div> 
 </div> 
 <h4>1.8断开连接</h4> 
 <p>清空设备名、设备id，关闭蓝牙模块</p> 
 <div> 
  <div> 
   <div> 
    <img alt="" src="https://images2.imgbox.com/3f/1c/pbYjVYUx_o.png" width="604"> 
   </div> 
  </div> 
 </div> 
 <h2>二、实现模块代码</h2> 
 <ol><li style="margin-left:1.4em;"> <h3>初始化蓝牙模块（打开蓝牙适配器）</h3> </li></ol> 
 <pre><code class="language-plain">
<code class="language-plaintext">openBluetoothAdapter() {
        let that = this;
        uni.openBluetoothAdapter({ //初始化蓝牙模块
          success(res) {
            console.log(res, '初始化蓝牙成功');
            uni.onBluetoothAdapterStateChange((res) =&gt; { // 监听蓝牙适配器状态变化
              if (!res.available) {
                uni.showModal({
                  title: '温馨提示',
                  content: '蓝牙适配器不可用，请重新启动',
                  showCancel: false
                });
              }
            });
            that.searchBlue(); //开始搜索
          },
          fail(res) {
            console.log(res, '初始化蓝牙失败');
            uni.showToast({
              title: '请检查手机蓝牙是否打开',
              icon: 'none'
            });
          }
        });
      },</code></code></pre> 
 <ol><li style="margin-left:1.4em;"> <h3>开始搜索周围蓝牙</h3> </li></ol> 
 <pre><code class="language-plain">
<code class="language-plaintext">searchBlue() {
        let that = this;
        uni.startBluetoothDevicesDiscovery({
          // services: [],
          success: (res) =&gt; {
            console.log(res, "开始搜索设备");
            uni.showLoading({
              title: '正在搜索设备'
            });
            that.getBluetoothDevices();
          },
          fail: (res) =&gt; {
            console.log(res, '搜索失败');
            uni.showToast({
              title: '搜索蓝牙设备失败!',
              icon: 'none'
            });
          }
        });
      },</code></code></pre> 
 <ol><li style="margin-left:1.4em;"> <h3>获取搜索到的设备</h3> </li></ol> 
 <pre><code class="language-plain">
<code class="language-plaintext">getBluetoothDevices() {
        let that = this;
        setTimeout(() =&gt; {
          uni.getBluetoothDevices({ // 获取搜索到的设备
            success: (res) =&gt; {
              console.log(res, "搜索到的设备");
              let devicesListArr = [];
              if (res.devices.length &gt; 0) {
                uni.hideLoading(res.devices);
                res.devices.forEach((device) =&gt; {
                  if (!device.name &amp;&amp; !device.localName) {
                    return;
                  } else if (device.name.substring(0, 2) == 'AA') {
                    devicesListArr.push(device);
                    that.devicesList = devicesListArr;
                    that.isHideList = true;
                    that.watchBluetoothFound(); // 监听搜索到的新设备
                  } else {
                    return
                  }
                });
              } else {
                uni.hideLoading();
                uni.showModal({
                  title: '温馨提示',
                  content: '无法搜索到蓝牙设备，请重试',
                  showCancel: false
                });
                uni.closeBluetoothAdapter({ //关闭蓝牙模块
                  success: (res) =&gt; {
                    console.log(res, "关闭蓝牙模块");
                  }
                });
              }
            }
          });
        }, 2000);
      },</code></code></pre> 
 <ol><li style="margin-left:1.4em;"> <h3>监听搜索设备</h3> </li></ol> 
 <pre><code class="language-plain">
<code class="language-plaintext">watchBluetoothFound() {
        let that = this;
        uni.onBluetoothDeviceFound(function(res) { // 监听搜索到的新设备
          if (String(res.devices.name).substring(0, 2) == 'AA') {
            devicesListArr.push(res.devices);
            that.devicesList = devicesListArr;
            console.log(res.devices, "监听新设备");
          }
        })
      },</code></code></pre> 
 <ol><li style="margin-left:1.4em;"> <h3>连接目标设备</h3> </li></ol> 
 <pre><code class="language-plain">
<code class="language-plaintext">createBLEConnection(e) {
        let that = this;
        let deviceId = e.currentTarget.dataset.id;
        let connectName = e.currentTarget.dataset.name;
        console.log("正在连接" + connectName);
        uni.showLoading({
          title: '连接中...'
        });
        uni.createBLEConnection({
          deviceId,
          success: (res) =&gt; {
            uni.hideLoading();
            that.stopBluetoothDevicesDiscovery(); // 连接成功，停止搜索
            console.log(res, "连接成功");
            if (res.errCode == 0) {
              that.deviceId = deviceId;
              that.connectName = connectName;
              that.isHideConnect = true;
              that.getBLEDeviceServices(deviceId); // 获取服务
            } else if (res.errCode == 10012) {
              uni.showToast({
                title: '连接超时，请重试！'
              });
            }
          },
          fail(error) {
            uni.hideLoading();
            console.log(error, '连接失败');
            uni.showToast({
              title: '连接失败！'
            });
          }
        });
      },</code></code></pre> 
 <ol><li style="margin-left:1.4em;"> <h3>获取设备所有服务</h3> </li></ol> 
 <pre><code class="language-plain">
<code class="language-plaintext">getBLEDeviceServices(deviceId) {
        let that = this;
        // let serviceId;
        uni.getBLEDeviceServices({
          deviceId,
          success: (res) =&gt; {
            console.log(res.services, "获取设备服务");
            for (let i = 0; i &lt; res.services.length; i++) {
              let isPrimary = res.services[i].isPrimary
              let uuid = res.services[i].uuid.substring(4, 8) == 'FE60' 
              if (isPrimary &amp;&amp; uuid) {
                this.getBLEDeviceCharacteristics(deviceId, res.services[i].uuid)
                return
              }
            }
          }
        });
      },</code></code></pre> 
 <ol><li style="margin-left:1.4em;"> <h3>获取特征值</h3> </li></ol> 
 <pre><code class="language-plain">
<code class="language-plaintext">getBLEDeviceCharacteristics(deviceId, serviceId) {
        let that = this;
        uni.getBLEDeviceCharacteristics({ 
          deviceId,
          serviceId,
          success: (res) =&gt; {
            console.log(res.characteristics, '获取特征值成功')
            let characteristicId = res.characteristics[0].uuid;
            let writeNews = {
              deviceId,
              serviceId,
              characteristicId
            };
            that.writeNews = writeNews;
            let notifyId = res.characteristics[1].uuid;
            that.notifyBLECharacteristicValueChange(serviceId, notifyId);
          },
          fail(err) {
            console.log(err, "获取失败");
          }
        });
      },</code></code></pre> 
 <ol><li style="margin-left:1.4em;"> <h3>启用监听特征值变化</h3> </li></ol> 
 <pre><code class="language-plain">
<code class="language-plaintext">notifyBLECharacteristicValueChange(serviceId, characteristicId) {
        let that = this;
        uni.notifyBLECharacteristicValueChange({ // 启用监听设备特征值变化 
          type: 'notification',
          state: true, // 启用 notify 功能
          deviceId: that.writeNews.deviceId,
          serviceId,
          characteristicId,
          success(res) {
            console.log(res, '启用监听成功');
            that.onBLECharacteristicValueChange()
          },
          fail: (err) =&gt; {
            console.log(err, "启用监听失败");
          }
        });
      },</code></code></pre> 
 <ol><li style="margin-left:1.4em;"> <h3>监听特征值变化</h3> </li></ol> 
 <pre><code class="language-plain">
<code class="language-plaintext">onBLECharacteristicValueChange() {
        let that = this;
        uni.onBLECharacteristicValueChange(res =&gt; {
          console.log(res, '监听变化成功');
          let resHex = that.ab2hex(res.value)
          console.log('从机响应的数据:', resHex)
        })
      },</code></code></pre> 
 <ol><li style="margin-left:1.4em;"> <h3>发送、读取数据</h3> </li></ol> 
 <pre><code class="language-plain">
<code class="language-plaintext">writeBLECharacteristicValue(order) { // 向蓝牙设备发送一个0x00的16进制数据
        let that = this;
        let msg = order;
        let buffer = new ArrayBuffer(msg.length / 2); // 定义 buffer 长度
        let dataView = new DataView(buffer); // 从二进制ArrayBuffer对象中读写多种数值类型
        let ind = 0;
        for (var i = 0, len = msg.length; i &lt; len; i += 2) {
          let code = parseInt(msg.substr(i, 2), 16)
          dataView.setUint8(ind, code)
          ind++
        }
        console.log('主机写入的指令:', that.ab2hex(buffer));
        uni.writeBLECharacteristicValue({
          deviceId: that.writeNews.deviceId,
          serviceId: that.writeNews.serviceId,
          characteristicId: that.writeNews.characteristicId,
          value: buffer,
          writeType: 'writeNoResponse',
          success: (res) =&gt; {
            console.log(res, '写入数据成功');
            that.onBLECharacteristicValueChange()
          },
          fail: (err) =&gt; {
            console.log(err);
          }
        })
      },</code></code></pre> 
 <ol><li style="margin-left:1.4em;"> <h3>断开连接</h3> </li></ol> 
 <pre><code class="language-plain">
<code class="language-plaintext">closeBLEConnection() {
        let that = this;
        console.log(that);
        uni.closeBLEConnection({
          deviceId: this.deviceId,
          success: () =&gt; {
            uni.showToast({
              title: '已断开连接'
            });
            that.deviceId = '';
            that.connectName = '';
            that.isHideConnect = false;
          }
        });
        that.closeBluetoothAdapter();
      },</code></code></pre> 
 <ol><li style="margin-left:1.4em;"> <h3>关闭蓝牙模块</h3> </li></ol> 
 <pre><code class="language-plain">
<code class="language-plaintext">closeBluetoothAdapter() {
        let that = this;
        uni.closeBluetoothAdapter({
          success: (res) =&gt; {
            console.log(res);
            that.devicesList = [];
            that.isHideList = false;
            that.isHideConnect = false;
          }
        });
      },</code></code></pre> 
 <ol><li style="margin-left:1.4em;"> <h3>停止搜索设备</h3> </li></ol> 
 <pre><code class="language-plain">
<code class="language-plaintext">stopBluetoothDevicesDiscovery() {
        uni.stopBluetoothDevicesDiscovery({
          success(res) {
            console.log(res);
          }
        });
      },</code></code></pre> 
 <ol><li style="margin-left:1.4em;"> <h3>ArrayBuffer转16进制字符串</h3> </li></ol> 
 <pre><code class="language-plain">
<code class="language-plaintext">ab2hex(buffer) {
        var hexArr = Array.prototype.map.call(
          new Uint8Array(buffer),
          function(bit) {
            return ('00' + bit.toString(16)).slice(-2);
          });
        return hexArr.join('');
      },</code></code></pre> 
 <h2>三、遇到的问题以及解决</h2> 
 <h3>问题1：onBLECharacteristicValueChange监听不到响应数据？</h3> 
 <h3>解决方法：</h3> 
 <p>1、给onBLECharacteristicValueChange添加延时器；</p> 
 <p>2、给notifyBLECharacteristicValueChange添加type: 'notification'；</p> 
 <p>3、给writeBLECharacteristicValue添加 writeType: 'writeNoResponse'；</p> 
 <p>4、更换手机设备：Android、IOS设备；</p> 
 <p>5、查看特征值：read、notify、write、writeNoResponse；</p> 
 <p>6、分包发送：蓝牙BLE最大支持20个字节发送，因此超过20个字节需要分包发送；</p> 
 <p>7、遵循硬件文档：使用指定服务，写入、接收分别使用的特征值（成功解决）；</p> 
 <p></p> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/74c54fe9f46449e52d1e2df60bfbad8e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">vue中实现图片懒加载的几种方法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/884049b56bc813b368f1585f2a8c2e69/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">VSCode设置中文语言界面（VScode设置其他语言界面）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>