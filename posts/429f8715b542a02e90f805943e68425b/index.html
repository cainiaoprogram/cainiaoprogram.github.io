<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Mask R-CNN讲解 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Mask R-CNN讲解" />
<meta property="og:description" content="文章目录 一：Mask R-CNN的横空出世二：网络架构【Backbone】【RPN】【ProposalLayer】【DetectionTargetLayer】【ROIAlign】【bbox检测】【Mask分割】 三：损失函数四：测试过程五：总结 一：Mask R-CNN的横空出世 Mask R-CNN是何凯明大神的新作。Mask R-CNN是一种在有效检测目标的同时输出高质量的实例分割mask。是对faster r-cnn的扩展，与bbox检测并行的增加一个预测分割mask的分支。Mask R-CNN 可以应用到人体姿势识别。并且在实例分割、目标检测、人体关键点检测三个任务都取得了现在最好的效果，下图是Mask R-CNN的检测效果图：
可见，Mask R-CNN其实是将物体检测和语义分割结合起来，从而达到了实例分割的效果。
二：网络架构 由上图可见，网络架构大概可分为以下几部分：
BackboneRPNProposalLayerDetectionTargetLayerROIAlignbbox检测Mask分割 下面我将按部分讲解，强调：需要有一定的Faster R-CNN基础，还不太了解的小伙伴可移步本人另一篇文章Faster R-CNN最全讲解。
【Backbone】 与Faster R-CNN使用VGG作为backbone不同，Mask R-CNN使用50层和101层的ResNet网络作为backbone，同时作者还探究了另一种有效的主干结构，叫做FPN。所以，其实有四种backbone选择，ResNet50，ResNet101，ResNet50 &#43; FPN，ResNet101 ＋ FPN。选择不同的backbone，ROI生成方式、RP的选择以及RP投射到feature map上的选择会有所不同，并且进入Head层的特征图大小也不尽相同，见下图：
本文选择ResNet101 &#43; FPN作为Backbone进行讲解，也是最复杂的一种选择，了解它的原理，其他类型的backbone自然也都掌握了。下面进入正式讲解：
首先我先来讲讲FPN的作用是什么，为什么现在这么火？
深层网络容易响应语义特征，浅层网络容易响应图像特征。但是到了物体检测领域，这个特征便成了一个重要的问题，高层网络虽然能响应语义特征，但是由于Feature Map的尺寸较小，含有的几何信息并不多，不利于物体检测；浅层网络虽然包含比较多的几何信息，但是图像的语义特征并不多，不利于图像的分类，这个问题在小尺寸物体检测上更为显著和，这也就是为什么物体检测算法普遍对小物体检测效果不好的最重要原因之一。很自然地可以想到，使用合并了的深层和浅层特征来同时满足分类和检测的需求，也就是FPN思想，其演变过程如下图：
FPN使用的是图像金字塔的思想以解决物体检测场景中小尺寸物体检测困难的问题，传统的图像金字塔方法（图a）采用输入多尺度图像的方式构建多尺度的特征，该方法的最大问题便是识别时间为单幅图的k倍，其中k是缩放的尺寸个数。Faster R-CNN等方法为了提升检测速度，使用了单尺度的Feature Map（图b），但单尺度的特征图限制了模型的检测能力，尤其是训练集中覆盖率极低的样本（例如较大和较小样本）。不同于Faster R-CNN只使用最顶层的Feature Map，SSD[6]利用卷积网络的层次结构，从VGG的第conv4_3开始，通过网络的不同层得到了多尺度的Feature Map（图c），该方法虽然能提高精度且基本上没有增加测试时间，但没有使用更加低层的Feature Map，然而这些低层次的特征对于检测小物体是非常有帮助的。
针对上面这些问题，FPN采用了SSD的金字塔内Feature Map的形式。与SSD不同的是，FPN不仅使用了VGG中层次深的Feature Map，并且浅层的Feature Map也被应用到FPN中。并通过自底向上的结构（bottom-up），自顶向下（top-down）以及横向连接（lateral connection）将这些Feature Map高效的整合起来，在提升精度的同时并没有大幅增加检测时间（图d）。
通过将Faster R-CNN的RPN和Fast R-CNN的骨干框架换成FPN，Faster R-CNN的平均精度从51.7%提升到56.9%。
FPN的代码出现在./mrcnn/model.py中，核心代码如下：
# Build the shared convolutional layers. # Bottom-up Layers # Returns a list of the last layers of each stage, 5 in total." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/429f8715b542a02e90f805943e68425b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-08T10:16:49+08:00" />
<meta property="article:modified_time" content="2022-09-08T10:16:49+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Mask R-CNN讲解</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#Mask_RCNN_1" rel="nofollow">一：Mask R-CNN的横空出世</a></li><li><a href="#_7" rel="nofollow">二：网络架构</a></li><li><ul><li><a href="#Backbone_19" rel="nofollow">【Backbone】</a></li><li><a href="#RPN_86" rel="nofollow">【RPN】</a></li><li><a href="#ProposalLayer_89" rel="nofollow">【ProposalLayer】</a></li><li><a href="#DetectionTargetLayer_99" rel="nofollow">【DetectionTargetLayer】</a></li><li><a href="#ROIAlign_281" rel="nofollow">【ROIAlign】</a></li><li><a href="#bbox_308" rel="nofollow">【bbox检测】</a></li><li><a href="#Mask_311" rel="nofollow">【Mask分割】</a></li></ul> 
  </li><li><a href="#_316" rel="nofollow">三：损失函数</a></li><li><a href="#_330" rel="nofollow">四：测试过程</a></li><li><a href="#_354" rel="nofollow">五：总结</a></li></ul> 
</div> 
<p></p> 
<h2><a id="Mask_RCNN_1"></a>一：Mask R-CNN的横空出世</h2> 
<p>Mask R-CNN是何凯明大神的新作。Mask R-CNN是一种在有效检测目标的同时输出高质量的实例分割mask。是对faster r-cnn的扩展，<mark>与bbox检测并行的增加一个预测分割mask的分支</mark>。Mask R-CNN 可以应用到人体姿势识别。并且在实例分割、目标检测、人体关键点检测三个任务都取得了现在最好的效果，下图是Mask R-CNN的检测效果图：<br> <img src="https://images2.imgbox.com/81/6a/MnIPpZaS_o.png" alt="在这里插入图片描述"><br> 可见，Mask R-CNN其实是将<mark>物体检测和语义分割结合起来</mark>，从而<mark>达到了实例分割的效果</mark>。</p> 
<h2><a id="_7"></a>二：网络架构</h2> 
<p><img src="https://images2.imgbox.com/5a/06/ljMWe85p_o.png" alt="在这里插入图片描述"><br> 由上图可见，网络架构大概可分为以下几部分：</p> 
<ul><li><strong>Backbone</strong></li><li><strong>RPN</strong></li><li><strong>ProposalLayer</strong></li><li><strong>DetectionTargetLayer</strong></li><li><strong>ROIAlign</strong></li><li><strong>bbox检测</strong></li><li><strong>Mask分割</strong></li></ul> 
<p>下面我将按部分讲解，<strong>强调</strong>：需要有一定的Faster R-CNN基础，还不太了解的小伙伴可移步本人另一篇文章<a href="https://blog.csdn.net/weixin_43702653/article/details/124045469?spm=1001.2014.3001.5501">Faster R-CNN最全讲解</a>。</p> 
<h3><a id="Backbone_19"></a>【Backbone】</h3> 
<p>与Faster R-CNN使用VGG作为backbone不同，Mask R-CNN使用50层和101层的ResNet网络作为backbone，同时作者还探究了另一种有效的主干结构，叫做FPN。所以，<strong>其实有四种backbone选择，ResNet50，ResNet101，ResNet50 + FPN，ResNet101 ＋ FPN</strong>。选择不同的backbone，ROI生成方式、RP的选择以及RP投射到feature map上的选择会有所不同，并且进入Head层的特征图大小也不尽相同，见下图：<br> <img src="https://images2.imgbox.com/cd/29/n9QGtxEz_o.png" alt="在这里插入图片描述"><br> <mark>本文选择ResNet101 + FPN作为Backbone进行讲解</mark>，也是最复杂的一种选择，了解它的原理，其他类型的backbone自然也都掌握了。<strong>下面进入正式讲解：</strong></p> 
<p><strong>首先我先来讲讲FPN的作用是什么，为什么现在这么火</strong>？</p> 
<hr> 
<p><mark>深层网络容易响应语义特征，浅层网络容易响应图像特征</mark>。但是到了物体检测领域，这个特征便成了一个重要的问题，高层网络虽然能响应语义特征，但是由于Feature Map的尺寸较小，含有的几何信息并不多，不利于物体检测；浅层网络虽然包含比较多的几何信息，但是图像的语义特征并不多，不利于图像的分类，<strong>这个问题在小尺寸物体检测上更为显著和</strong>，这也就是为什么物体检测算法普遍对小物体检测效果不好的最重要原因之一。很自然地可以想到，使用合并了的深层和浅层特征来同时满足分类和检测的需求，也就是FPN思想，其演变过程如下图：<br> <img src="https://images2.imgbox.com/8c/a3/j0Erb9uH_o.png" alt="在这里插入图片描述"></p> 
<p>FPN使用的是图像金字塔的思想以解决物体检测场景中小尺寸物体检测困难的问题，传统的图像金字塔方法（图a）采用输入多尺度图像的方式构建多尺度的特征，该方法的最大问题便是识别时间为单幅图的k倍，其中k是缩放的尺寸个数。Faster R-CNN等方法为了提升检测速度，使用了单尺度的Feature Map（图b），但单尺度的特征图限制了模型的检测能力，尤其是训练集中覆盖率极低的样本（例如较大和较小样本）。不同于Faster R-CNN只使用最顶层的Feature Map，SSD[6]利用卷积网络的层次结构，从VGG的第conv4_3开始，通过网络的不同层得到了多尺度的Feature Map（图c），该方法虽然能提高精度且基本上没有增加测试时间，但没有使用更加低层的Feature Map，然而这些低层次的特征对于检测小物体是非常有帮助的。</p> 
<p>针对上面这些问题，FPN采用了SSD的金字塔内Feature Map的形式。与SSD不同的是，FPN不仅使用了VGG中层次深的Feature Map，并且浅层的Feature Map也被应用到FPN中。并通过自底向上的结构（bottom-up），自顶向下（top-down）以及横向连接（lateral connection）将这些Feature Map高效的整合起来，在提升精度的同时并没有大幅增加检测时间（图d）。</p> 
<p>通过将Faster R-CNN的RPN和Fast R-CNN的骨干框架换成FPN，Faster R-CNN的平均精度从51.7%提升到56.9%。</p> 
<p>FPN的代码出现在<code>./mrcnn/model.py</code>中，核心代码如下：</p> 
<pre><code class="prism language-python"><span class="token comment"># Build the shared convolutional layers.</span>
<span class="token comment"># Bottom-up Layers</span>
<span class="token comment"># Returns a list of the last layers of each stage, 5 in total.</span>
<span class="token comment"># Don't create the thead (stage 5), so we pick the 4th item in the list.</span>
<span class="token keyword">if</span> <span class="token builtin">callable</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>BACKBONE<span class="token punctuation">)</span><span class="token punctuation">:</span>
    _<span class="token punctuation">,</span> C2<span class="token punctuation">,</span> C3<span class="token punctuation">,</span> C4<span class="token punctuation">,</span> C5 <span class="token operator">=</span> config<span class="token punctuation">.</span>BACKBONE<span class="token punctuation">(</span>input_image<span class="token punctuation">,</span> stage5<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> train_bn<span class="token operator">=</span>config<span class="token punctuation">.</span>TRAIN_BN<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    _<span class="token punctuation">,</span> C2<span class="token punctuation">,</span> C3<span class="token punctuation">,</span> C4<span class="token punctuation">,</span> C5 <span class="token operator">=</span> resnet_graph<span class="token punctuation">(</span>input_image<span class="token punctuation">,</span> config<span class="token punctuation">.</span>BACKBONE<span class="token punctuation">,</span> stage5<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> train_bn<span class="token operator">=</span>config<span class="token punctuation">.</span>TRAIN_BN<span class="token punctuation">)</span>
<span class="token comment"># Top-down Layers</span>
<span class="token comment"># TODO: add assert to varify feature map sizes match what's in config</span>
P5 <span class="token operator">=</span> KL<span class="token punctuation">.</span>Conv2D<span class="token punctuation">(</span>config<span class="token punctuation">.</span>TOP_DOWN_PYRAMID_SIZE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'fpn_c5p5'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>C5<span class="token punctuation">)</span>
P4 <span class="token operator">=</span> KL<span class="token punctuation">.</span>Add<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"fpn_p4add"</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    KL<span class="token punctuation">.</span>UpSampling2D<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"fpn_p5upsampled"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>P5<span class="token punctuation">)</span><span class="token punctuation">,</span>
    KL<span class="token punctuation">.</span>Conv2D<span class="token punctuation">(</span>config<span class="token punctuation">.</span>TOP_DOWN_PYRAMID_SIZE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'fpn_c4p4'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>C4<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
P3 <span class="token operator">=</span> KL<span class="token punctuation">.</span>Add<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"fpn_p3add"</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    KL<span class="token punctuation">.</span>UpSampling2D<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"fpn_p4upsampled"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>P4<span class="token punctuation">)</span><span class="token punctuation">,</span>
    KL<span class="token punctuation">.</span>Conv2D<span class="token punctuation">(</span>config<span class="token punctuation">.</span>TOP_DOWN_PYRAMID_SIZE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'fpn_c3p3'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>C3<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
P2 <span class="token operator">=</span> KL<span class="token punctuation">.</span>Add<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"fpn_p2add"</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    KL<span class="token punctuation">.</span>UpSampling2D<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"fpn_p3upsampled"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>P3<span class="token punctuation">)</span><span class="token punctuation">,</span>
    KL<span class="token punctuation">.</span>Conv2D<span class="token punctuation">(</span>config<span class="token punctuation">.</span>TOP_DOWN_PYRAMID_SIZE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'fpn_c2p2'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>C2<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># Attach 3x3 conv to all P layers to get the final feature maps.</span>
P2 <span class="token operator">=</span> KL<span class="token punctuation">.</span>Conv2D<span class="token punctuation">(</span>config<span class="token punctuation">.</span>TOP_DOWN_PYRAMID_SIZE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">"SAME"</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"fpn_p2"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>P2<span class="token punctuation">)</span>
P3 <span class="token operator">=</span> KL<span class="token punctuation">.</span>Conv2D<span class="token punctuation">(</span>config<span class="token punctuation">.</span>TOP_DOWN_PYRAMID_SIZE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">"SAME"</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"fpn_p3"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>P3<span class="token punctuation">)</span>
P4 <span class="token operator">=</span> KL<span class="token punctuation">.</span>Conv2D<span class="token punctuation">(</span>config<span class="token punctuation">.</span>TOP_DOWN_PYRAMID_SIZE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">"SAME"</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"fpn_p4"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>P4<span class="token punctuation">)</span>
P5 <span class="token operator">=</span> KL<span class="token punctuation">.</span>Conv2D<span class="token punctuation">(</span>config<span class="token punctuation">.</span>TOP_DOWN_PYRAMID_SIZE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">"SAME"</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"fpn_p5"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>P5<span class="token punctuation">)</span>
<span class="token comment"># P6 is used for the 5th anchor scale in RPN. Generated by</span>
<span class="token comment"># subsampling from P5 with stride of 2.</span>
P6 <span class="token operator">=</span> KL<span class="token punctuation">.</span>MaxPooling2D<span class="token punctuation">(</span>pool_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strides<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"fpn_p6"</span><span class="token punctuation">)</span><span class="token punctuation">(</span>P5<span class="token punctuation">)</span>

<span class="token comment"># Note that P6 is used in RPN, but not in the classifier heads.</span>
rpn_feature_maps <span class="token operator">=</span> <span class="token punctuation">[</span>P2<span class="token punctuation">,</span> P3<span class="token punctuation">,</span> P4<span class="token punctuation">,</span> P5<span class="token punctuation">,</span> P6<span class="token punctuation">]</span>
mrcnn_feature_maps <span class="token operator">=</span> <span class="token punctuation">[</span>P2<span class="token punctuation">,</span> P3<span class="token punctuation">,</span> P4<span class="token punctuation">,</span> P5<span class="token punctuation">]</span>
</code></pre> 
<p>自底向上方法反映在上面代码的第6行或者第8行，自底向上即是卷积网络的前向过程，在Mask R-CNN中，用户可以根据配置文件选择使用<code>ResNet-50</code>或者<code>ResNet-101</code>。代码中的<code>resnet_graph</code>就是一个残差块网络，其返回值C2，C3，C4，C5，是每次池化之后得到的Feature Map，该函数也实现在<code>./mrcnn/model.py</code>中（代码片段2）。需要注意的是在残差网络中，C2，C3，C4，C5经过的降采样次数分别是2，3，4，5即分别对应原图中的步长分别是4，8，16，32。</p> 
<p>残差网络得到的C1-C5由于经历了不同的降采样次数，所以得到的Feature Map的尺寸也不同。为了提升计算效率，首先FPN使用<code>1 × 1卷积</code>进行了降维，得到P5，然后<strong>使用双线性插值进行上采样</strong>，将P5上采样到和C4相同的尺寸。</p> 
<p>之后，FPN也使用<code>1 × 1卷积</code> 卷积对P4进行了降维，由于降维并不改变尺寸大小，所以<strong>P5和P4具有相同的尺寸，FPN直接把P5单位加到P4得到了更新后的P4</strong>。基于同样的策略，我们使用P4更新P3，P3更新P2。这整个过程是从网络的顶层向下层开始更新的，<strong>所以叫做自顶向下路径</strong>。</p> 
<p>FPN使用单位加的操作来更新特征，这种单位加操作叫做横向连接。由于使用了单位加，所以P2，P3，P4，P5应该具有相同数量的Feature Map（源码中该值为256），所以FPN使用了<code>1 × 1卷积</code> 卷积进行降维。</p> 
<p>在更新完Feature Map之后，FPN在P2，P3，P4，P5之后均接了一个<code>3 × 3卷积</code>操作，该卷积操作是为了减轻上采样的混叠效应（aliasing effect）。</p> 
<p>至此，Backbone部分中的核心FPN结构讲解完成，附下图加深理解：<br> <img src="https://images2.imgbox.com/5f/0e/jrCNwLeu_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<p>讲解完了FPN，我再补充一个重要细节。FPN输出了P2至P6五个特征图，它们都将输入进RPN网络中，用于ROI的产生。但是，只有P2~P5会用于ROI特征提取，稍微注意一下，后面会详细讲解。</p> 
<h3><a id="RPN_86"></a>【RPN】</h3> 
<p>Mask R-CNN中的RPN数据标注和训练的流程，和Faster R-CNN中的RPN基本没有任何区别，<mark>唯一的区别就是</mark>：Mask R-CNN会将五种不同尺寸大小的Anchors，分别在P2~P6这五个特征图上生成，并且一个锚点对应三种长宽比例。</p> 
<h3><a id="ProposalLayer_89"></a>【ProposalLayer】</h3> 
<p>将RPN网路的输出作为该模块的输入，首先利用rpn_bbox对anchors进行第一次修正，得到ROI并删除其中的一部分超界的ROI。接着，对剩下的ROI进行score排序，保留其中预测为前景色概率大的一部分（具体值可以在配置文件中进行配置）。最后，利用NMS获得最终的RP。</p> 
<pre><code>ProposalLayer的作用主要是：
1. 利用rpn_bbox对anchors进行修正,得到ROI
2. 舍弃掉修正后边框超过图片大小的anchor，由于我们的anchor的坐标的大小是归一化的，只要坐标不超过0 1区间即可
3. 根据rpn网络，获取score靠前的前6000个ROI
4. 利用非极大抑制的方法获得最后的RP
</code></pre> 
<h3><a id="DetectionTargetLayer_99"></a>【DetectionTargetLayer】</h3> 
<p>DetectionTargetLayer的输入包含了，<code>target_rois</code>, <code>input_gt_class_ids</code>, <code>gt_boxes</code>,<code> input_gt_masks</code>。其中target_rois是ProposalLayer输出的结果。首先，计算target_rois中的每一个rois和哪一个真实的框gt_boxes iou值，如果最大的iou大于0.5，则被认为是正样本，负样本是是iou小于0.5。选择出了正负样本，还要保证样本的均衡性，具体可以才配置文件中进行配置。最后计算了正样本中的anchor和哪一个真实的框最接近，用真实的框和anchor计算出偏移值，并且将mask的大小resize成28*28，这些都是后面的分类和mask网络要用到的真实的值。下面是该层的主要代码：</p> 
<pre><code class="prism language-python">获取的就是每个rois和哪个真实的框最接近，计算出和真实框的距离，以及要预测的mask，这些信息都会在网络的头的classify和mask网络
<span class="token comment">#所使用</span>
<span class="token keyword">def</span> <span class="token function">detection_targets_graph</span><span class="token punctuation">(</span>proposals<span class="token punctuation">,</span> gt_class_ids<span class="token punctuation">,</span> gt_boxes<span class="token punctuation">,</span> gt_masks<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Generates detection targets for one image. Subsamples proposals and
    generates target class IDs, bounding box deltas, and masks for each.
    Inputs:
    proposals: [N, (y1, x1, y2, x2)] in normalized coordinates. Might
               be zero padded if there are not enough proposals.
    gt_class_ids: [MAX_GT_INSTANCES] int class IDs
    gt_boxes: [MAX_GT_INSTANCES, (y1, x1, y2, x2)] in normalized coordinates.
    gt_masks: [height, width, MAX_GT_INSTANCES] of boolean type.
    Returns: Target ROIs and corresponding class IDs, bounding box shifts,
    and masks.
    rois: [TRAIN_ROIS_PER_IMAGE, (y1, x1, y2, x2)] in normalized coordinates
    class_ids: [TRAIN_ROIS_PER_IMAGE]. Integer class IDs. Zero padded.
    deltas: [TRAIN_ROIS_PER_IMAGE, NUM_CLASSES, (dy, dx, log(dh), log(dw))]
            Class-specific bbox refinements.
    masks: [TRAIN_ROIS_PER_IMAGE, height, width). Masks cropped to bbox
           boundaries and resized to neural network output size.
    Note: Returned arrays might be zero padded if not enough target ROIs.
    """</span>
    <span class="token comment"># Assertions</span>
    asserts <span class="token operator">=</span> <span class="token punctuation">[</span>
        tf<span class="token punctuation">.</span>Assert<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>greater<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>proposals<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>proposals<span class="token punctuation">]</span><span class="token punctuation">,</span>
                  name<span class="token operator">=</span><span class="token string">"roi_assertion"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>control_dependencies<span class="token punctuation">(</span>asserts<span class="token punctuation">)</span><span class="token punctuation">:</span>
        proposals <span class="token operator">=</span> tf<span class="token punctuation">.</span>identity<span class="token punctuation">(</span>proposals<span class="token punctuation">)</span>
 
    <span class="token comment"># Remove zero padding</span>
    proposals<span class="token punctuation">,</span> _ <span class="token operator">=</span> trim_zeros_graph<span class="token punctuation">(</span>proposals<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"trim_proposals"</span><span class="token punctuation">)</span>
    <span class="token comment">#去除非零的真实的框，也就是只留下真实存在的有意义的框</span>
    gt_boxes<span class="token punctuation">,</span> non_zeros <span class="token operator">=</span> trim_zeros_graph<span class="token punctuation">(</span>gt_boxes<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"trim_gt_boxes"</span><span class="token punctuation">)</span>
    gt_class_ids <span class="token operator">=</span> tf<span class="token punctuation">.</span>boolean_mask<span class="token punctuation">(</span>gt_class_ids<span class="token punctuation">,</span> non_zeros<span class="token punctuation">,</span>
                                   name<span class="token operator">=</span><span class="token string">"trim_gt_class_ids"</span><span class="token punctuation">)</span>
    gt_masks <span class="token operator">=</span> tf<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>gt_masks<span class="token punctuation">,</span> tf<span class="token punctuation">.</span>where<span class="token punctuation">(</span>non_zeros<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>
                         name<span class="token operator">=</span><span class="token string">"trim_gt_masks"</span><span class="token punctuation">)</span>
 
    <span class="token comment"># Handle COCO crowds</span>
    <span class="token comment"># A crowd box in COCO is a bounding box around several instances. Exclude</span>
    <span class="token comment"># them from training. A crowd box is given a negative class ID.</span>
    <span class="token comment">#在coco数据集中，有的框会标注很多的物体，在训练中，去掉这些框</span>
    crowd_ix <span class="token operator">=</span> tf<span class="token punctuation">.</span>where<span class="token punctuation">(</span>gt_class_ids <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
    non_crowd_ix <span class="token operator">=</span> tf<span class="token punctuation">.</span>where<span class="token punctuation">(</span>gt_class_ids <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
    crowd_boxes <span class="token operator">=</span> tf<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>gt_boxes<span class="token punctuation">,</span> crowd_ix<span class="token punctuation">)</span>
    crowd_masks <span class="token operator">=</span> tf<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>gt_masks<span class="token punctuation">,</span> crowd_ix<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token comment">#下面就是一张图片中真实存在的物体用于训练</span>
    gt_class_ids <span class="token operator">=</span> tf<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>gt_class_ids<span class="token punctuation">,</span> non_crowd_ix<span class="token punctuation">)</span>
    gt_boxes <span class="token operator">=</span> tf<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>gt_boxes<span class="token punctuation">,</span> non_crowd_ix<span class="token punctuation">)</span>
    gt_masks <span class="token operator">=</span> tf<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>gt_masks<span class="token punctuation">,</span> non_crowd_ix<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
 
    <span class="token comment"># Compute overlaps matrix [proposals, gt_boxes]</span>
    <span class="token comment">#计算iou的值</span>
    overlaps <span class="token operator">=</span> overlaps_graph<span class="token punctuation">(</span>proposals<span class="token punctuation">,</span> gt_boxes<span class="token punctuation">)</span>
 
    <span class="token comment"># Compute overlaps with crowd boxes [anchors, crowds]</span>
    crowd_overlaps <span class="token operator">=</span> overlaps_graph<span class="token punctuation">(</span>proposals<span class="token punctuation">,</span> crowd_boxes<span class="token punctuation">)</span>
    crowd_iou_max <span class="token operator">=</span> tf<span class="token punctuation">.</span>reduce_max<span class="token punctuation">(</span>crowd_overlaps<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    no_crowd_bool <span class="token operator">=</span> <span class="token punctuation">(</span>crowd_iou_max <span class="token operator">&lt;</span> <span class="token number">0.001</span><span class="token punctuation">)</span>
 
    <span class="token comment"># Determine positive and negative ROIs</span>
    roi_iou_max <span class="token operator">=</span> tf<span class="token punctuation">.</span>reduce_max<span class="token punctuation">(</span>overlaps<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment"># 1. Positive ROIs are those with &gt;= 0.5 IoU with a GT box</span>
    <span class="token comment">#和真实的框的iou值大于0.5时，被认为是正样本</span>
    positive_roi_bool <span class="token operator">=</span> <span class="token punctuation">(</span>roi_iou_max <span class="token operator">&gt;=</span> <span class="token number">0.5</span><span class="token punctuation">)</span>
    positive_indices <span class="token operator">=</span> tf<span class="token punctuation">.</span>where<span class="token punctuation">(</span>positive_roi_bool<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token comment"># 2. Negative ROIs are those with &lt; 0.5 with every GT box. Skip crowds.</span>
    <span class="token comment">#负样本是是iou小于0.5并且和crowd box相交不大的anchor</span>
    negative_indices <span class="token operator">=</span> tf<span class="token punctuation">.</span>where<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>logical_and<span class="token punctuation">(</span>roi_iou_max <span class="token operator">&lt;</span> <span class="token number">0.5</span><span class="token punctuation">,</span> no_crowd_bool<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
 
    <span class="token comment"># Subsample ROIs. Aim for 33% positive</span>
    <span class="token comment"># Positive ROIs</span>
    positive_count <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>TRAIN_ROIS_PER_IMAGE <span class="token operator">*</span>
                         config<span class="token punctuation">.</span>ROI_POSITIVE_RATIO<span class="token punctuation">)</span>
    positive_indices <span class="token operator">=</span> tf<span class="token punctuation">.</span>random_shuffle<span class="token punctuation">(</span>positive_indices<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span>positive_count<span class="token punctuation">]</span>
    positive_count <span class="token operator">=</span> tf<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>positive_indices<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token comment"># Negative ROIs. Add enough to maintain positive:negative ratio.</span>
    r <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">/</span> config<span class="token punctuation">.</span>ROI_POSITIVE_RATIO
    negative_count <span class="token operator">=</span> tf<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>r <span class="token operator">*</span> tf<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>positive_count<span class="token punctuation">,</span> tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>int32<span class="token punctuation">)</span> <span class="token operator">-</span> positive_count
    negative_indices <span class="token operator">=</span> tf<span class="token punctuation">.</span>random_shuffle<span class="token punctuation">(</span>negative_indices<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span>negative_count<span class="token punctuation">]</span>
    <span class="token comment"># Gather selected ROIs</span>
    <span class="token comment">#选择出正负样本</span>
    positive_rois <span class="token operator">=</span> tf<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>proposals<span class="token punctuation">,</span> positive_indices<span class="token punctuation">)</span>
    negative_rois <span class="token operator">=</span> tf<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>proposals<span class="token punctuation">,</span> negative_indices<span class="token punctuation">)</span>
 
    <span class="token comment"># Assign positive ROIs to GT boxes.</span>
    <span class="token comment">#计算正样本和哪个真实的框最接近</span>
    positive_overlaps <span class="token operator">=</span> tf<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>overlaps<span class="token punctuation">,</span> positive_indices<span class="token punctuation">)</span>
    roi_gt_box_assignment <span class="token operator">=</span> tf<span class="token punctuation">.</span>cond<span class="token punctuation">(</span>
        tf<span class="token punctuation">.</span>greater<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>positive_overlaps<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        true_fn <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> tf<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>positive_overlaps<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        false_fn <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> tf<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>tf<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    roi_gt_boxes <span class="token operator">=</span> tf<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>gt_boxes<span class="token punctuation">,</span> roi_gt_box_assignment<span class="token punctuation">)</span>
    roi_gt_class_ids <span class="token operator">=</span> tf<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>gt_class_ids<span class="token punctuation">,</span> roi_gt_box_assignment<span class="token punctuation">)</span>
 
    <span class="token comment"># Compute bbox refinement for positive ROIs</span>
    <span class="token comment">#用最接近的真实框修正rpn网络预测的框</span>
    deltas <span class="token operator">=</span> utils<span class="token punctuation">.</span>box_refinement_graph<span class="token punctuation">(</span>positive_rois<span class="token punctuation">,</span> roi_gt_boxes<span class="token punctuation">)</span>
    deltas <span class="token operator">/=</span> config<span class="token punctuation">.</span>BBOX_STD_DEV
 
    <span class="token comment"># Assign positive ROIs to GT masks</span>
    <span class="token comment"># Permute masks to [N, height, width, 1]</span>
    transposed_masks <span class="token operator">=</span> tf<span class="token punctuation">.</span>expand_dims<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>gt_masks<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment"># Pick the right mask for each ROI</span>
    <span class="token comment"># 计算和每一个rois最接近的框的mask</span>
    roi_masks <span class="token operator">=</span> tf<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>transposed_masks<span class="token punctuation">,</span> roi_gt_box_assignment<span class="token punctuation">)</span>
 
    <span class="token comment"># Compute mask targets</span>
    boxes <span class="token operator">=</span> positive_rois
    <span class="token keyword">if</span> config<span class="token punctuation">.</span>USE_MINI_MASK<span class="token punctuation">:</span>
        <span class="token comment"># Transform ROI coordinates from normalized image space</span>
        <span class="token comment"># to normalized mini-mask space.</span>
        y1<span class="token punctuation">,</span> x1<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> x2 <span class="token operator">=</span> tf<span class="token punctuation">.</span>split<span class="token punctuation">(</span>positive_rois<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        gt_y1<span class="token punctuation">,</span> gt_x1<span class="token punctuation">,</span> gt_y2<span class="token punctuation">,</span> gt_x2 <span class="token operator">=</span> tf<span class="token punctuation">.</span>split<span class="token punctuation">(</span>roi_gt_boxes<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        gt_h <span class="token operator">=</span> gt_y2 <span class="token operator">-</span> gt_y1
        gt_w <span class="token operator">=</span> gt_x2 <span class="token operator">-</span> gt_x1
        y1 <span class="token operator">=</span> <span class="token punctuation">(</span>y1 <span class="token operator">-</span> gt_y1<span class="token punctuation">)</span> <span class="token operator">/</span> gt_h
        x1 <span class="token operator">=</span> <span class="token punctuation">(</span>x1 <span class="token operator">-</span> gt_x1<span class="token punctuation">)</span> <span class="token operator">/</span> gt_w
        y2 <span class="token operator">=</span> <span class="token punctuation">(</span>y2 <span class="token operator">-</span> gt_y1<span class="token punctuation">)</span> <span class="token operator">/</span> gt_h
        x2 <span class="token operator">=</span> <span class="token punctuation">(</span>x2 <span class="token operator">-</span> gt_x1<span class="token punctuation">)</span> <span class="token operator">/</span> gt_w
        boxes <span class="token operator">=</span> tf<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>y1<span class="token punctuation">,</span> x1<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> x2<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    box_ids <span class="token operator">=</span> tf<span class="token punctuation">.</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>roi_masks<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment"># crop_and_resize相当于roipolling的操作</span>
    masks <span class="token operator">=</span> tf<span class="token punctuation">.</span>image<span class="token punctuation">.</span>crop_and_resize<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>roi_masks<span class="token punctuation">,</span> tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> boxes<span class="token punctuation">,</span>
                                     box_ids<span class="token punctuation">,</span>
                                     config<span class="token punctuation">.</span>MASK_SHAPE<span class="token punctuation">)</span>
    <span class="token comment"># Remove the extra dimension from masks.</span>
    masks <span class="token operator">=</span> tf<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span>masks<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
 
    <span class="token comment"># Threshold mask pixels at 0.5 to have GT masks be 0 or 1 to use with</span>
    <span class="token comment"># binary cross entropy loss.</span>
    masks <span class="token operator">=</span> tf<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>masks<span class="token punctuation">)</span>
 
    <span class="token comment"># Append negative ROIs and pad bbox deltas and masks that</span>
    <span class="token comment"># are not used for negative ROIs with zeros.</span>
    rois <span class="token operator">=</span> tf<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>positive_rois<span class="token punctuation">,</span> negative_rois<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    N <span class="token operator">=</span> tf<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>negative_rois<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    P <span class="token operator">=</span> tf<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span>config<span class="token punctuation">.</span>TRAIN_ROIS_PER_IMAGE <span class="token operator">-</span> tf<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>rois<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    rois <span class="token operator">=</span> tf<span class="token punctuation">.</span>pad<span class="token punctuation">(</span>rois<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> P<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    roi_gt_boxes <span class="token operator">=</span> tf<span class="token punctuation">.</span>pad<span class="token punctuation">(</span>roi_gt_boxes<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> N <span class="token operator">+</span> P<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    roi_gt_class_ids <span class="token operator">=</span> tf<span class="token punctuation">.</span>pad<span class="token punctuation">(</span>roi_gt_class_ids<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> N <span class="token operator">+</span> P<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    deltas <span class="token operator">=</span> tf<span class="token punctuation">.</span>pad<span class="token punctuation">(</span>deltas<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> N <span class="token operator">+</span> P<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    masks <span class="token operator">=</span> tf<span class="token punctuation">.</span>pad<span class="token punctuation">(</span>masks<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> N <span class="token operator">+</span> P<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
 
    <span class="token keyword">return</span> rois<span class="token punctuation">,</span> roi_gt_class_ids<span class="token punctuation">,</span> deltas<span class="token punctuation">,</span> masks
</code></pre> 
<p>最后返回的是：</p> 
<pre><code>rois: [TRAIN_ROIS_PER_IMAGE, (y1, x1, y2, x2)] in normalized coordinates
class_ids: [TRAIN_ROIS_PER_IMAGE]. Integer class IDs. Zero padded.
deltas: [TRAIN_ROIS_PER_IMAGE, NUM_CLASSES, (dy, dx, log(dh), log(dw))]
    Class-specific bbox refinements.
masks: [TRAIN_ROIS_PER_IMAGE, height, width). Masks cropped to bbox
   boundaries and resized to neural network output size.
</code></pre> 
<p>由于RP标注的操作和Faster R-CNN如出一辙，所以<mark>我来重点讲解一下mask训练样本的标注</mark>，<strong>下面开始讲解</strong>：<br> <img src="https://images2.imgbox.com/15/b4/OKMuT2HE_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/eb/e6/Pwj74onr_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/6f/50/ndac2L2G_o.png" alt="在这里插入图片描述"></p> 
<p>首先对于上面的原图，通过labelme将它标记，生成label.png，分离出person，dog，分别默认是1，2。其中0是背景，如下图实验可以证明：<br> <img src="https://images2.imgbox.com/43/89/vwNbvssm_o.png" alt="在这里插入图片描述"><br> 可见，label.png虽然打印出来是0，1，2三个值的单通道组成，<strong>但显示出来的却是RGB图像</strong>，原因藏在labelme下的<code>draw.py</code>文件中，如下图：<br> <img src="https://images2.imgbox.com/b5/0d/bEQn11EK_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/2c/64/2G4xranW_o.png" alt="在这里插入图片描述"><br> 所以，可以理解为最终的标记结果是一个shape为<code>[3，W，H]</code>的mask掩码，共三层掩码，每一层掩码由0，1构成（可以理解为True和False）。<strong>所以上图的label.png可以理解成是三种掩码共同作用在原图中的结果，第一层掩码的索引是0，正好对应背景，目标图像是黑色，然后贴到原图上。接着，第二层掩码索引是1，代表person，目标图像时绿色，然后贴到原图上，第三层掩码同理。</strong></p> 
<p>接着对mask进行<mark>最近邻插值方式的resize</mark>，将原图变为网络需要的输入图像大小，<strong>pytorch中默认resize是线性插值</strong>，那样会改变掩码中的值，会有小数出现，显然是不对的。（PIL中的Image方法中的resize默认的是最近邻插值方式）。</p> 
<p>至此，输入图像的大掩码已经标注出来，每一个RP在原图中的mask自然也获得了。但是它还不是真正的用来与预测结果pixel-to-pixel比较的训练样本（和一般的图像分割不同），<strong>还得将每一个RP在原图中的mask转化成head层最后的28×28低分辨率的mask（此时是软掩码）</strong>。</p> 
<p>具体做法是通过<strong>下图的公式</strong>计算出每一个RP属于的feature map，不同尺度的ROI使用不同特征层作为ROIAlign层的输入，大尺度ROI就用后面一些的金字塔层，比如P5；小尺度ROI就用前面一点的特征层，比如P3。定义了一个系数Pk，判断ROI该用那个层的输出。查询到了对应的特征图level后，将RP除以缩放倍数，投射到所属的特征图上，原图的大mask也倍数缩放。<strong>这样，得到了每一个RP对应的feature map上的mask。</strong><br> <img src="https://images2.imgbox.com/78/b4/PukFVE2u_o.png" alt="在这里插入图片描述"></p> 
<p>最后，将RP在特征图上的mask输入进下一模块<strong>ROIAlign</strong>中，最后得到<code>28×28</code>的软掩码，取<code>0.5的阈值</code>进行二值化阈值处理（<code>mask.round()</code>即可），<mark>转化为硬掩码</mark>，用于后面的二分类交叉熵损失的计算。<strong>大功告成！！！！</strong></p> 
<h3><a id="ROIAlign_281"></a>【ROIAlign】</h3> 
<p>ROIAlign是ROIPooling的进化版，下面来具体讲解一下它的优化：</p> 
<hr> 
<p>ROIAlign的提出是为了解决Faster R-CNN中RoI Pooling的区域不匹配的问题，下面我们来举例说明什么是区域不匹配。ROI Pooling的区域不匹配问题是由于ROI Pooling过程中的取整操作产生的（如下图），我们知道ROI Pooling是Faster R-CNN中必不可少的一步，因为其会产生长度固定的特征向量，有了长度固定的特征向量才能进行softmax计算分类损失。</p> 
<p>如下图，输入是一张<code>800×800</code> 的图片，经过一个有5次降采样的卷机网络，得到大小为 <code>25×25</code> 的Feature Map。图中的ROI区域大小是 <code>600×500</code> ，经过网络之后对应的区域为 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          600 
         
        
          32 
         
        
       
      
        {600}\over {32} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.1901em; vertical-align: -0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8451em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">32</span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.394em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">600</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.345em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         × 
        
       
      
        × 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6667em; vertical-align: -0.0833em;"></span><span class="mord">×</span></span></span></span></span><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          500 
         
        
          32 
         
        
       
      
        500\over32 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.1901em; vertical-align: -0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8451em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">32</span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.394em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">500</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.345em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         = 
        
       
         18.75 
        
       
         × 
        
       
         15.625 
        
       
      
        = 18.75 × 15.625 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.3669em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.7278em; vertical-align: -0.0833em;"></span><span class="mord">18.75</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">15.625</span></span></span></span></span>，由于无法整除，ROI Pooling采用向下取整的方式，进而得到ROI区域的Feature Map的大小为 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         18 
        
       
         × 
        
       
         15 
        
       
      
        18 × 15 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.7278em; vertical-align: -0.0833em;"></span><span class="mord">18</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">15</span></span></span></span></span>，<strong>这就造成了第一次区域不匹配</strong>。</p> 
<p>RoI Pooling的下一步是对Feature Map分bin，加入我们需要一个<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         7 
        
       
         × 
        
       
         7 
        
       
      
        7 × 7 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.7278em; vertical-align: -0.0833em;"></span><span class="mord">7</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">7</span></span></span></span></span>的bin，每个bin的大小为<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          18 
         
        
          7 
         
        
       
      
        {18}\over {7} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.1901em; vertical-align: -0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8451em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">7</span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.394em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">18</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.345em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         × 
        
       
      
        × 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6667em; vertical-align: -0.0833em;"></span><span class="mord">×</span></span></span></span></span><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          15 
         
        
          7 
         
        
       
      
        15\over7 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.1901em; vertical-align: -0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8451em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">7</span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.394em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">15</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.345em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span> ，由于不能整除，ROI同样采用了向下取整的方式，从而每个bin的大小为 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         2 
        
       
         × 
        
       
         2 
        
       
      
        2 × 2 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.7278em; vertical-align: -0.0833em;"></span><span class="mord">2</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">2</span></span></span></span></span> ，即整个RoI区域的Feature Map的尺寸为<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         14 
        
       
         × 
        
       
         14 
        
       
      
        14 × 14 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.7278em; vertical-align: -0.0833em;"></span><span class="mord">14</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">14</span></span></span></span></span> 。<strong>第二次区域不匹配问题因此产生</strong>。</p> 
<p>对比ROI Pooling之前的Feature Map，ROI Pooling分别在横向和纵向产生了4.75和1.625的误差，对于物体分类或者物体检测场景来说，<mark>这几个像素的位移或许对结果影响不大，但是语义分割任务通常要精确到每个像素点</mark>，因此ROI Pooling是不能应用到Mask R-CNN中的。</p> 
<p><img src="https://images2.imgbox.com/43/97/dw6JfyCK_o.png" alt="在这里插入图片描述"><br> 为了解决这个问题，<strong>作者提出了RoIAlign</strong>。<mark>RoIAlign并没有取整的过程，可以全程使用浮点数操作</mark>，步骤如下：</p> 
<pre><code>1. 计算RoI区域的边长，边长不取整；
2. 将ROI区域均匀分成k × k个bin，每个bin的大小不取整；
3. 每个bin的值为其最邻近的Feature Map的四个值通过双线性插值得到；
4. 使用Max Pooling或者Average Pooling得到长度固定的特征向量。
</code></pre> 
<p>上面步骤如下图所示：<br> <img src="https://images2.imgbox.com/d0/5b/7KHDMd3f_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<p>回到流程的正式讲解，首先输入RP特征图，用的是上一节所讲公式分配的feature map上投射出的，在此不再赘述。<mark>补充一下，训练时只传入挑选出的正负样本RP，测试时都传入</mark>。然后得到两张<code>7×7</code>和<code>14×14</code>大小的特征图，分别传入进Head层的两个功能分支。</p> 
<h3><a id="bbox_308"></a>【bbox检测】</h3> 
<p>这里原理和faster R-CNN一模一样，不再赘述，最后得到预测的类别概率和bbox回归参数。</p> 
<h3><a id="Mask_311"></a>【Mask分割】</h3> 
<p><img src="https://images2.imgbox.com/14/21/3laIl63U_o.png" alt="在这里插入图片描述"><br> Mask分支用的就是传统的<strong>FCN</strong>图像分割方法，最后生成<code>28×28×80</code>的预测mask结果，注意得到的结果是软掩码，经过sigmoid后的0~1浮点数。</p> 
<h2><a id="_316"></a>三：损失函数</h2> 
<p>最后，来讲一讲网络到底是如何训练的，贴上损失函数：<br> <img src="https://images2.imgbox.com/b5/2d/h9vvWjsU_o.png" alt="在这里插入图片描述"></p> 
<p>Mask R-CNN采用了和Faster R-CNN相同的两步走策略，即先使用RPN提取候选区域，关于RPN的详细介绍，可以参考Faster R-CNN一文。不同于Faster R-CNN中使用分类和回归的多任务回归，Mask R-CNN在其基础上并行添加了一个用于语义分割的Mask损失函数，所以Mask R-CNN的损失函数可以表示为上式。</p> 
<p>上式的分类损失和回归框矫正损失，就不再赘述了，实在是老生常谈。我来主要讲解一下<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          L 
         
         
         
           c 
          
         
           l 
          
         
           s 
          
         
        
       
      
        L_{cls} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span style="margin-right: 0.0197em;" class="mord mathnormal mtight">l</span><span class="mord mathnormal mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>语义分割损失。</p> 
<p>在进行掩码预测时，FCN的分割和预测是同时进行的，即要预测每个像素属于哪一类。而<mark>Mask R-CNN将分类和语义分割任务进行了解耦</mark>，即每个类单独的预测一个位置掩码，<strong>这种解耦提升了语义分割的效果</strong>，从下图来看，提升效果还是很明显的：<br> <img src="https://images2.imgbox.com/98/95/936ZiaIh_o.png" alt="在这里插入图片描述"><br> 所以根据RP训练样本所对应的类别，单独针对该类对应的mask通道，进行二值交叉熵损失计算。（不用训练背景mask通道，负样本RP直接不训练就行）</p> 
<p>至此，Mask R-CNN的所有细节和训练损失函数计算全部讲解完成，<strong>下面再讲解一下测试流程</strong>。</p> 
<h2><a id="_330"></a>四：测试过程</h2> 
<p>测试过程只有head层有一些区别，主要是bbox检测和语义分割的先后顺序问题。Head层先利用上分支，得到最终预测框和预测类别。再对它们进行语义分割，因为已知预测类别，所以相当于实例分割。<br> 最后将<code>28×28</code>的mask线性插值成feature map中的ROI大小，再缩放倍数，得到原图中的ROI。最后，得到的是软掩码，进行阈值分割，得到真正的原图ROI掩码。还原代码如下：</p> 
<pre><code class="prism language-python">
<span class="token keyword">def</span> <span class="token function">unmold_mask</span><span class="token punctuation">(</span>mask<span class="token punctuation">,</span> bbox<span class="token punctuation">,</span> image_shape<span class="token punctuation">)</span><span class="token punctuation">:</span> 
<span class="token triple-quoted-string string">"""Converts a mask generated by the neural network to a format similar    
to its original shape.    
mask: [height, width] of type float. A small, typically 28x28 mask.    
bbox: [y1, x1, y2, x2]. The box to fit the mask in.    

Returns a binary mask with the same size as the original image.   
 """</span>    
threshold <span class="token operator">=</span> <span class="token number">0.5</span>    
y1<span class="token punctuation">,</span> x1<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> x2 <span class="token operator">=</span> bbox    
mask <span class="token operator">=</span> resize<span class="token punctuation">(</span>mask<span class="token punctuation">,</span> <span class="token punctuation">(</span>y2 <span class="token operator">-</span> y1<span class="token punctuation">,</span> x2 <span class="token operator">-</span> x1<span class="token punctuation">)</span><span class="token punctuation">)</span>    
mask <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>mask <span class="token operator">&gt;=</span> threshold<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">bool</span><span class="token punctuation">)</span> 
<span class="token comment"># Put the mask in the right location.    </span>
full_mask <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>image_shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span><span class="token builtin">bool</span><span class="token punctuation">)</span>    
full_mask<span class="token punctuation">[</span>y1<span class="token punctuation">:</span>y2<span class="token punctuation">,</span> x1<span class="token punctuation">:</span>x2<span class="token punctuation">]</span> <span class="token operator">=</span> mask 
<span class="token keyword">return</span> full_mask
</code></pre> 
<h2><a id="_354"></a>五：总结</h2> 
<p>Mask R-CNN是一个很多state-of-the-art算法的合成体，并非常巧妙的设计了这些模块的合成接口：</p> 
<pre><code>1. 使用残差网络作为卷积结构
2. 使用FPN作为骨干架构
3. 使用Faster R-CNN的物体检测流程：RPN+Fast R-CNN
4. 增加FCN用于语义分割
</code></pre> 
<p>Mask R-CNN设计的主要接口有：</p> 
<pre><code>1. 将FCN和Faster R-CNN合并，通过构建一个三任务的损失函数来优化模型
2. 使用RoIAlign优化了RoI Pooling，解决了Faster R-CNN在语义分割中的区域不匹配问题
</code></pre> 
<p>最后，附上一个全局流程图，<mark>庆祝我们的大功告成</mark>：</p> 
<img src="https://images2.imgbox.com/ee/15/4VXex2Lg_o.png" width="2000%"> 
<hr> 
<p>  至此我对Mask R-CNN的细节原理，进行了全面讲解，希望对大家有所帮助，有不懂的地方或者建议，欢迎大家在下方留言评论。</p> 
<p>我是努力在CV泥潭中摸爬滚打的江南咸鱼，我们一起努力，不留遗憾！</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ffab89006f59d862d165572b9c2e3073/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">python -- strip(), split()用法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a09cf43ca1da4949b43dee0820a0df26/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Faster R-CNN最全讲解</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>