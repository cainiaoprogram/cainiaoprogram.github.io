<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>五、Python复习教程（重点）-爬虫框架实战 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="五、Python复习教程（重点）-爬虫框架实战" />
<meta property="og:description" content="目录导航： 文章目录 目录导航：九、Python网络爬虫进阶实战(上)1. Scrapy框架介绍与安装1.1.认识Scrapy框架Scrapy框架介绍：Scrapy框架的运行原理：Scrapy主要包括了以下组件：Scrapy运行流程大概如下： 1.2 Scrapy的安装：1.3 Scrapy爬虫框架的具体使用步骤如下： 2. Scrapy框架的使用2.1 Scrapy框架的命令介绍Scrapy 命令 分为两种：`全局命令` 和 `项目命令`。全局命令项目命令： Scrapy框架的命令使用：shell命令, 进入scrpay交互环境 2.2 Scrapy框架的使用：① 创建项目② 进入demo项目目录，创建爬虫spider类文件③ 创建Item④ 解析Response⑤ 使用Item Pipeline⑥ 运行： 2.3 Scrapy框架中的POST提交： 3. Selector选择器3.1 直接使用：3.2 Scrapy shell3.3 Xpath选择器：3.4 CSS选择器：3.5 正则匹配： 4. Spider的使用4.1 Spider运行流程：4.2 Spider类分析：4.3 实战案例： 5. Downloader Middleware的使用5.1 使用说明：5.2 自定义Downloader Middleware中间件① process_request(request,spider)② process_response(request, response, spider)③ process_exception(request, exception, spider) 5.3 实战案例： 6. Spider Middleware的使用6.1 激活spider中间件6.2 编写您自己的spider中间件process_spider_input(response, spider)process_spider_output(response, result, spider)process_spider_exception(response, exception, spider)process_start_requests(start_requests, spider) Scrapy框架的配置Settings内置设置参考手册 7. ItemPipeline的使用7.1 如何编写你自己的item pipeline① `process_item(item, spider)`② `open_spider(spider)`③ `close_spider(spider)` 7." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/e48784f7caa5af0c91f2aaaf2a3deff3/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-10-26T17:29:25+08:00" />
<meta property="article:modified_time" content="2020-10-26T17:29:25+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">五、Python复习教程（重点）-爬虫框架实战</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_1"></a>目录导航：</h2> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_1" rel="nofollow">目录导航：</a></li><li><a href="#Python_5" rel="nofollow">九、Python网络爬虫进阶实战(上)</a></li><li><ul><li><a href="#1_Scrapy_20" rel="nofollow">1. Scrapy框架介绍与安装</a></li><li><ul><li><a href="#11Scrapy_22" rel="nofollow">1.1.认识Scrapy框架</a></li><li><ul><li><a href="#Scrapy_24" rel="nofollow">Scrapy框架介绍：</a></li><li><a href="#Scrapy_34" rel="nofollow">Scrapy框架的运行原理：</a></li><li><a href="#Scrapy_38" rel="nofollow">Scrapy主要包括了以下组件：</a></li><li><ul><li><a href="#Scrapy_59" rel="nofollow">Scrapy运行流程大概如下：</a></li></ul> 
    </li></ul> 
    </li><li><a href="#12_Scrapy_74" rel="nofollow">1.2 Scrapy的安装：</a></li><li><a href="#13_Scrapy_112" rel="nofollow">1.3 Scrapy爬虫框架的具体使用步骤如下：</a></li></ul> 
   </li><li><a href="#2_Scrapy_116" rel="nofollow">2. Scrapy框架的使用</a></li><li><ul><li><a href="#21_Scrapy_118" rel="nofollow">2.1 Scrapy框架的命令介绍</a></li><li><ul><li><a href="#Scrapy_____120" rel="nofollow">Scrapy 命令 分为两种：`全局命令` 和 `项目命令`。</a></li><li><ul><li><a href="#_125" rel="nofollow">全局命令</a></li><li><a href="#_151" rel="nofollow">项目命令：</a></li></ul> 
     </li><li><a href="#Scrapy_182" rel="nofollow">Scrapy框架的命令使用：</a></li><li><ul><li><a href="#shell_scrpay_241" rel="nofollow">shell命令, 进入scrpay交互环境</a></li></ul> 
    </li></ul> 
    </li><li><a href="#22_Scrapy_260" rel="nofollow">2.2 Scrapy框架的使用：</a></li><li><ul><li><a href="#__268" rel="nofollow">① 创建项目</a></li><li><a href="#_demospider_295" rel="nofollow">② 进入demo项目目录，创建爬虫spider类文件</a></li><li><a href="#_Item_342" rel="nofollow">③ 创建Item</a></li><li><a href="#_Response_361" rel="nofollow">④ 解析Response</a></li><li><a href="#_Item_Pipeline_390" rel="nofollow">⑤ 使用Item Pipeline</a></li><li><a href="#__408" rel="nofollow">⑥ 运行：</a></li></ul> 
    </li><li><a href="#23_ScrapyPOST_426" rel="nofollow">2.3 Scrapy框架中的POST提交：</a></li></ul> 
   </li><li><a href="#3_Selector_465" rel="nofollow">3. Selector选择器</a></li><li><ul><li><a href="#31__471" rel="nofollow">3.1 直接使用：</a></li><li><a href="#32_Scrapy_shell_487" rel="nofollow">3.2 Scrapy shell</a></li><li><a href="#33_Xpath_550" rel="nofollow">3.3 Xpath选择器：</a></li><li><a href="#34_CSS_640" rel="nofollow">3.4 CSS选择器：</a></li><li><a href="#35__686" rel="nofollow">3.5 正则匹配：</a></li></ul> 
   </li><li><a href="#4_Spider_695" rel="nofollow">4. Spider的使用</a></li><li><ul><li><a href="#41_Spider_700" rel="nofollow">4.1 Spider运行流程：</a></li><li><a href="#42_Spider_708" rel="nofollow">4.2 Spider类分析：</a></li><li><a href="#43__834" rel="nofollow">4.3 实战案例：</a></li></ul> 
   </li><li><a href="#5_Downloader_Middleware_984" rel="nofollow">5. Downloader Middleware的使用</a></li><li><ul><li><a href="#51__991" rel="nofollow">5.1 使用说明：</a></li><li><a href="#52_Downloader_Middleware_1021" rel="nofollow">5.2 自定义Downloader Middleware中间件</a></li><li><ul><li><a href="#_process_requestrequestspider_1029" rel="nofollow">① process_request(request,spider)</a></li><li><a href="#_process_responserequest_response_spider_1037" rel="nofollow">② process_response(request, response, spider)</a></li><li><a href="#_process_exceptionrequest_exception_spider_1054" rel="nofollow">③ process_exception(request, exception, spider)</a></li></ul> 
    </li><li><a href="#53__1061" rel="nofollow">5.3 实战案例：</a></li></ul> 
   </li><li><a href="#_1143" rel="nofollow"></a></li><li><a href="#6_Spider_Middleware_1145" rel="nofollow">6. Spider Middleware的使用</a></li><li><ul><li><a href="#61_spider_1149" rel="nofollow">6.1 激活spider中间件</a></li><li><a href="#62_spider_1173" rel="nofollow">6.2 编写您自己的spider中间件</a></li><li><ul><li><a href="#process_spider_inputresponse_spider_1178" rel="nofollow">process_spider_input(response, spider)</a></li><li><a href="#process_spider_outputresponse_result_spider_1194" rel="nofollow">process_spider_output(response, result, spider)</a></li><li><a href="#process_spider_exceptionresponse_exception_spider_1207" rel="nofollow">process_spider_exception(response, exception, spider)</a></li><li><a href="#process_start_requestsstart_requests_spider_1224" rel="nofollow">process_start_requests(start_requests, spider)</a></li></ul> 
    </li><li><a href="#ScrapySettings_1242" rel="nofollow">Scrapy框架的配置Settings</a></li><li><ul><li><a href="#_1247" rel="nofollow">内置设置参考手册</a></li></ul> 
   </li></ul> 
   </li><li><a href="#7_ItemPipeline_1348" rel="nofollow">7. ItemPipeline的使用</a></li><li><ul><li><a href="#71_item_pipeline_1358" rel="nofollow">7.1 如何编写你自己的item pipeline</a></li><li><ul><li><a href="#_process_itemitem_spider_1362" rel="nofollow">① `process_item(item, spider)`</a></li><li><a href="#_open_spiderspider_1370" rel="nofollow">② `open_spider(spider)`</a></li><li><a href="#_close_spiderspider_1375" rel="nofollow">③ `close_spider(spider)`</a></li></ul> 
    </li><li><a href="#72__1380" rel="nofollow">7.2 样例：</a></li><li><ul><li><a href="#item_1382" rel="nofollow">验证价格，同时丢弃没有价格的item</a></li><li><a href="#itemJSON_1402" rel="nofollow">将item写入JSON文件：</a></li><li><a href="#_1422" rel="nofollow">去重</a></li><li><a href="#Item_Pipeline_1442" rel="nofollow">启用一个Item Pipeline组件:</a></li></ul> 
    </li><li><a href="#73_Scrapy_1455" rel="nofollow">7.3 Scrapy框架案例实战：</a></li><li><ul><li><a href="#__1461" rel="nofollow">① 创建项目</a></li><li><a href="#_educsdnspidercourses_1486" rel="nofollow">② 进入educsdn项目目录，创建爬虫spider类文件（courses课程）</a></li><li><a href="#_Item_1526" rel="nofollow">③ 创建Item</a></li><li><a href="#_Response_1547" rel="nofollow">④ 解析Response</a></li><li><a href="#_1588" rel="nofollow">⑤、创建数据库和表：</a></li><li><a href="#Item_Pipeline_1605" rel="nofollow">⑥、使用Item Pipeline</a></li><li><a href="#__1661" rel="nofollow">⑦ 修改配置文件</a></li><li><a href="#_1677" rel="nofollow">⑧、运行爬取：</a></li><li><a href="#_ImagesPipeline_1687" rel="nofollow">① ImagesPipeline介绍</a></li><li><a href="#__1694" rel="nofollow">② 具体使用：</a></li></ul> 
   </li></ul> 
   </li><li><a href="#8_Scrapy_1756" rel="nofollow">8. Scrapy爬虫案例实战</a></li><li><ul><li><ul><li><a href="#__1762" rel="nofollow">① 创建项目</a></li><li><a href="#_tencentspiderhr_1787" rel="nofollow">② 进入tencent项目目录，创建爬虫spider类文件（hr招聘信息）</a></li><li><a href="#_Item_1836" rel="nofollow">③ 创建Item</a></li><li><a href="#_Response_1866" rel="nofollow">④ 解析Response</a></li><li><a href="#_1926" rel="nofollow">⑤、创建数据库和表：</a></li><li><a href="#Item_Pipeline_1943" rel="nofollow">⑥、使用Item Pipeline</a></li><li><a href="#__1995" rel="nofollow">⑦ 修改配置文件</a></li><li><a href="#_2022" rel="nofollow">⑧、运行爬取：</a></li></ul> 
   </li></ul> 
   </li><li><a href="#9_Scrapy_2030" rel="nofollow">9. Scrapy扩展</a></li><li><ul><li><a href="#1_scrapy_2032" rel="nofollow">1. 如何使scrapy爬取信息不打印在命令窗口中</a></li><li><a href="#2_Scrapy_2047" rel="nofollow">2. Scrapy中的日志处理</a></li></ul> 
  </li></ul> 
  </li><li><a href="#Python_2091" rel="nofollow">十、Python网络爬虫进阶实战(中)</a></li><li><ul><li><a href="#09_Selenium_2093" rel="nofollow">09. Selenium的使用</a></li><li><ul><li><a href="#91__2095" rel="nofollow">9.1 动态渲染页面爬取</a></li><li><a href="#92_Selenium_2103" rel="nofollow">9.2 Selenium的介绍</a></li><li><a href="#93_Selenium_2119" rel="nofollow">9.3 Selenium的使用</a></li><li><ul><li><ul><li><a href="#_python_2121" rel="nofollow">① 初次体验：模拟谷歌浏览器访问百度首页，并输入python关键字搜索</a></li><li><a href="#__2156" rel="nofollow">② 声明浏览器对象</a></li><li><a href="#__2168" rel="nofollow">③ 访问页面</a></li><li><a href="#__2180" rel="nofollow">④ 查找节点：</a></li><li><a href="#__2227" rel="nofollow">⑤ 节点交互：</a></li><li><a href="#__2254" rel="nofollow">⑥ 动态链：</a></li><li><a href="#_JavaScript_2293" rel="nofollow">⑦ 执行JavaScript：</a></li><li><a href="#__2310" rel="nofollow">⑧ 获取节点信息：</a></li><li><a href="#_Frame_2334" rel="nofollow">⑨ 切换Frame：</a></li><li><a href="#__2339" rel="nofollow">⑩ 延迟等待：</a></li><li><a href="#11__2375" rel="nofollow">11 前进和后退：</a></li><li><a href="#12_Cookies_2394" rel="nofollow">12 Cookies：</a></li><li><a href="#13__2412" rel="nofollow">13 选项卡管理：</a></li><li><a href="#14__2435" rel="nofollow">14 异常处理：</a></li></ul> 
    </li></ul> 
   </li></ul> 
   </li><li><a href="#10_Selenium_2459" rel="nofollow">10. Selenium爬取淘宝商品</a></li><li><ul><li><a href="#__2461" rel="nofollow">① 案例要求</a></li><li><a href="#__2465" rel="nofollow">② 案例分析：</a></li><li><a href="#__2469" rel="nofollow">③ 具体代码实现</a></li></ul> 
   </li><li><a href="#11_MongoDB_2547" rel="nofollow">11. MongoDB数据库</a></li><li><ul><li><a href="#11_RDBMSNoSQL_2556" rel="nofollow">1.1 RDBMS与NoSQL区别：</a></li><li><a href="#12_WindowsMongoDB_2585" rel="nofollow">1.2 Windows下安装MongoDB：</a></li><li><a href="#13__2618" rel="nofollow">1.3 数据库的操作</a></li><li><ul><li><a href="#_MongoDB_2620" rel="nofollow">① MongoDB的数据库操作</a></li><li><a href="#_MongoDB_2654" rel="nofollow">② MongoDB的集合操作：</a></li><li><a href="#__2683" rel="nofollow">③ 数据类型：</a></li><li><a href="#__2706" rel="nofollow">④ 数据的操作</a></li></ul> 
    </li><li><a href="#114__2888" rel="nofollow">11.4 备份与恢复</a></li><li><a href="#115_python_2909" rel="nofollow">11.5 与python交互</a></li></ul> 
   </li><li><a href="#12_ScrapySelenium_2978" rel="nofollow">12. Scrapy框架使用Selenium</a></li><li><ul><li><ul><li><a href="#__2987" rel="nofollow">① 创建项目</a></li><li><a href="#_Item_3008" rel="nofollow">② 定义Item类</a></li><li><a href="#__3026" rel="nofollow">③ 解析页面</a></li><li><a href="#_Selenium_3059" rel="nofollow">④ 对接Selenium</a></li><li><a href="#__3128" rel="nofollow">⑤ 解析页面信息</a></li><li><a href="#__3163" rel="nofollow">⑥ 存储结果</a></li></ul> 
   </li></ul> 
   </li><li><a href="#13__3210" rel="nofollow">13. 代理的使用</a></li><li><ul><li><a href="#131__3212" rel="nofollow">13.1 代理服务的介绍：</a></li><li><a href="#132__3226" rel="nofollow">13.2 代理的设置：</a></li><li><ul><li><a href="#_urllib_3228" rel="nofollow">① urllib的代理设置</a></li><li><a href="#_requests_3252" rel="nofollow">② requests的代理设置</a></li><li><a href="#_Selenium_3272" rel="nofollow">③ Selenium的代理使用</a></li><li><a href="#_Scrapy_3302" rel="nofollow">④ 在Scrapy使用代理</a></li></ul> 
    </li><li><a href="#133_IP_3312" rel="nofollow">13.3 免费代理IP的使用</a></li><li><a href="#134_IP_3342" rel="nofollow">13.4 收费代理IP的使用</a></li></ul> 
   </li><li><a href="#14__3408" rel="nofollow">14. 使用代理爬取信息实战</a></li><li><ul><li><a href="#141__3410" rel="nofollow">14.1 实战目标：</a></li><li><a href="#142__3416" rel="nofollow">14.2 准备工作：</a></li><li><a href="#143__3424" rel="nofollow">14.3 具体实现：</a></li><li><ul><li><a href="#__3426" rel="nofollow">① 创建项目</a></li><li><a href="#_Item_3447" rel="nofollow">② 定义Item类</a></li><li><a href="#__3463" rel="nofollow">③ 解析页面</a></li><li><a href="#__3501" rel="nofollow">④ 存储结果</a></li><li><a href="#__3546" rel="nofollow">⑤ 执行爬虫文件开始信息爬取</a></li><li><a href="#__3563" rel="nofollow">⑥ 在中间件中使用付费代理服务来解决上面错误：</a></li></ul> 
   </li></ul> 
   </li><li><a href="#15_Redis_3582" rel="nofollow">15. Redis数据库</a></li><li><ul><li><a href="#151_Redis_3584" rel="nofollow">15.1 Redis简介</a></li><li><a href="#152_Redis_3600" rel="nofollow">15.2 Redis的安装：</a></li><li><a href="#153_Redis_3648" rel="nofollow">15.3 Redis的操作：</a></li><li><ul><li><a href="#_String_3653" rel="nofollow">① String（子串类型）</a></li><li><a href="#_hash_3703" rel="nofollow">② hash类型：</a></li><li><a href="#_list_3729" rel="nofollow">③ list类型（双向链表结构）</a></li><li><a href="#_sets_3764" rel="nofollow">④ sets类型和操作：</a></li><li><a href="#_sorted_set_3792" rel="nofollow">⑤ 有序集合(sorted set)：</a></li><li><a href="#_Redis_3823" rel="nofollow">⑥ Redis常用命令：</a></li></ul> 
    </li><li><a href="#154_Redis_3841" rel="nofollow">15.4 Redis高级实用特性</a></li><li><a href="#155_PythonRedis_3930" rel="nofollow">15.5 Python使用Redis</a></li><li><ul><li><a href="#redishash_3957" rel="nofollow">redis操作hash哈希</a></li><li><a href="#redislist_3976" rel="nofollow">redis操作list链表</a></li><li><a href="#redisset_4008" rel="nofollow">redis操作set集合</a></li></ul> 
   </li></ul> 
   </li><li><a href="#16__4029" rel="nofollow">16. 分布式爬虫原理</a></li><li><ul><li><a href="#161__4034" rel="nofollow">16.1 分布式爬虫架构</a></li><li><a href="#162__4044" rel="nofollow">16.2 维护爬取队列</a></li><li><a href="#163__4052" rel="nofollow">16.3 如何去重</a></li><li><a href="#164__4059" rel="nofollow">16.4 防止中断</a></li><li><a href="#165__4085" rel="nofollow">16.5 架构实现</a></li></ul> 
   </li><li><a href="#17_Scrapy_4091" rel="nofollow">17. Scrapy分布式实战</a></li><li><ul><li><a href="#171__4098" rel="nofollow">17.1 准备</a></li><li><a href="#172_Scrapyredis_4122" rel="nofollow">17.2 Scrapy-redis各个组件介绍</a></li><li><ul><li><a href="#_connectionpy_4124" rel="nofollow">① connection.py</a></li><li><a href="#_dupefilterpy_4128" rel="nofollow">② dupefilter.py</a></li><li><a href="#_queuepy_4134" rel="nofollow">③ queue.py</a></li><li><a href="#_pipelinespy_4139" rel="nofollow">④ pipelines.py</a></li><li><a href="#_schedulerpy_4144" rel="nofollow">⑤ scheduler.py</a></li><li><a href="#_spiderpy_4149" rel="nofollow">⑥ spider.py</a></li></ul> 
    </li><li><a href="#173_Scrapy_4153" rel="nofollow">17.3 具体使用(对Scrapy改造)：</a></li><li><ul><li><a href="#1settingspyredisscrapyredis__4155" rel="nofollow">1.首先在settings.py中配置redis（在scrapy-redis 自带的例子中已经配置好）</a></li><li><a href="#2itempy_4176" rel="nofollow">2.item.py的改造</a></li><li><a href="#3spiderstar_turlsredis_keyredisrequestscrapyspiderRedisSpider_4198" rel="nofollow">3.spider的改造。star_turls变成了redis_key从redis中获得request，继承的scrapy.spider变成RedisSpider。</a></li><li><a href="#_4221" rel="nofollow">**启动爬虫：**</a></li><li><a href="#Scrapysettingspy_4233" rel="nofollow">**更多关于配置Scrapy框架中配置：settings.py**</a></li></ul> 
    </li><li><a href="#174__4284" rel="nofollow">17.4 实战案例：</a></li><li><ul><li><a href="#_slave_4294" rel="nofollow">① 编写slave(从)项目代码：</a></li><li><a href="#_master_4399" rel="nofollow">② 编写master(主)项目代码：</a></li></ul> 
    </li><li><a href="#175_Redis_4502" rel="nofollow">17.5 处理的Redis里的数据：</a></li><li><ul><li><a href="#MongoDB_4508" rel="nofollow">存入的MongoDB</a></li></ul> 
   </li></ul> 
  </li></ul> 
  </li><li><a href="#Python_4550" rel="nofollow">十一、Python网络爬虫进阶实战(下)</a></li><li><ul><li><a href="#18_App_4552" rel="nofollow">18. App的信息爬取</a></li><li><ul><li><a href="#181_Charles_4560" rel="nofollow">18.1 Charles的介绍</a></li><li><ul><li><a href="#Charles_4569" rel="nofollow">Charles主要功能:</a></li></ul> 
    </li><li><a href="#182_Charles_4584" rel="nofollow">18.2 Charles的配置</a></li><li><ul><li><a href="#__4586" rel="nofollow">① 网络共享配置：</a></li><li><a href="#__4593" rel="nofollow">② 代理设置：</a></li><li><a href="#__4603" rel="nofollow">③ 证书配置：</a></li><li><a href="#_Charles__HTTPS__4630" rel="nofollow">⑤ Charles 配置 HTTPS 代理的乱码问题</a></li></ul> 
    </li><li><a href="#183_Charles_4640" rel="nofollow">18.3 Charles的运行原理和具体使用</a></li><li><ul><li><a href="#__4642" rel="nofollow">① 运行原理：</a></li><li><a href="#__4648" rel="nofollow">② 具体使用</a></li></ul> 
   </li></ul> 
   </li><li><a href="#19_mitmproxy_4655" rel="nofollow">19. mitmproxy的使用</a></li><li><ul><li><a href="#191__4669" rel="nofollow">19.1 安装和配置：</a></li><li><a href="#192_mitmproxy_4718" rel="nofollow">19.2 mitmproxy的使用：</a></li><li><a href="#193_mitmdump_4749" rel="nofollow">19.3 mitmdump的使用：</a></li></ul> 
   </li><li><a href="#20_App_4812" rel="nofollow">20. App信息抓取实战</a></li><li><ul><li><ul><li><a href="#__4814" rel="nofollow">① 抓取目标：</a></li><li><a href="#__4822" rel="nofollow">② 准备工作和抓取分析</a></li><li><a href="#__4841" rel="nofollow">③ 代码编写：</a></li></ul> 
   </li></ul> 
   </li><li><a href="#21_API_4880" rel="nofollow">21. 从API爬取天气预报数据</a></li><li><ul><li><a href="#211_API_4882" rel="nofollow">21.1 注册免费API和阅读文档</a></li><li><a href="#212__4897" rel="nofollow">21.2 提取全国城市信息</a></li><li><a href="#213__4931" rel="nofollow">21.3 获取指定城市的天气信息</a></li><li><a href="#214__4969" rel="nofollow">21.4 综合实例</a></li></ul> 
   </li><li><a href="#22__5036" rel="nofollow">22. 滑动验证码的识别</a></li><li><ul><li><a href="#221__5038" rel="nofollow">22.1 滑动验证码的识别介绍</a></li><li><a href="#222__5050" rel="nofollow">22.2 实现步骤：</a></li><li><ul><li><a href="#__5052" rel="nofollow">① 初始化</a></li><li><a href="#__5078" rel="nofollow">② 模拟登录填写，点开滑块验证</a></li><li><a href="#__5111" rel="nofollow">③ 获取并储存有无缺口的两张图片</a></li><li><a href="#__5163" rel="nofollow">④ 获取缺口位置</a></li><li><a href="#__5210" rel="nofollow">⑤ 获取移动轨迹</a></li><li><a href="#__5259" rel="nofollow">⑥ 按照轨迹拖动，完全验证</a></li><li><a href="#__5286" rel="nofollow">⑦ 完成登录</a></li></ul> 
    </li><li><a href="#223__5306" rel="nofollow">22.3 完整代码：</a></li></ul> 
   </li><li><a href="#23__5503" rel="nofollow">23. 爬虫项目需求分析</a></li><li><ul><li><ul><li><a href="#1__5505" rel="nofollow">1 项目名称</a></li><li><a href="#2__5509" rel="nofollow">2 项目描述：</a></li><li><a href="#3__5518" rel="nofollow">3 爬取网站过程分析：</a></li><li><a href="#4__5537" rel="nofollow">4 运行环境要求：</a></li><li><a href="#5__5548" rel="nofollow">5 项目中的建议：</a></li></ul> 
   </li></ul> 
   </li><li><a href="#24__5572" rel="nofollow">24. 爬虫项目架构设计</a></li><li><ul><li><ul><li><a href="#1__5574" rel="nofollow">1. 数据库设计：</a></li><li><a href="#2__5610" rel="nofollow">2. 项目结构：</a></li><li><a href="#3__5625" rel="nofollow">3. 具体实施描述</a></li><li><a href="#4__5627" rel="nofollow">4. 项目中的规范：</a></li></ul> 
   </li></ul> 
   </li><li><a href="#25__5629" rel="nofollow">25. 爬虫项目的代码实现</a></li><li><ul><li><a href="#251__5631" rel="nofollow">25.1 数据库的准备：</a></li><li><a href="#252_1_5656" rel="nofollow">25.2 模块1的实现：</a></li><li><a href="#253_2_5699" rel="nofollow">25.3 模块2的实现：</a></li><li><a href="#254_3_5846" rel="nofollow">25.4 模块3的实现：</a></li><li><a href="#255_4_5998" rel="nofollow">25.5 模块4的实现：</a></li><li><a href="#256__6047" rel="nofollow">25.6 反爬处理：</a></li></ul> 
   </li><li><a href="#26_web_6053" rel="nofollow">26. 使用web展示爬取信息</a></li><li><ul><li><a href="#261_mywebweb_6055" rel="nofollow">26.1 创建项目myweb和应用web</a></li><li><a href="#262__6092" rel="nofollow">26.2 执行数据库连接配置,网站配置</a></li><li><a href="#263_Model_6153" rel="nofollow">26.3 定义Model类</a></li><li><a href="#264_URL_6180" rel="nofollow">26.4 URL路由配置：</a></li><li><a href="#265__6205" rel="nofollow">26.5 编写视图处理文件</a></li><li><a href="#265__6236" rel="nofollow">26.5 编写模板输出文件</a></li><li><a href="#266__6288" rel="nofollow">26.6 启动服务测试：</a></li><li><a href="#267__6298" rel="nofollow">26.7 练习：</a></li></ul> 
   </li><li><a href="#Published_with_GitBookhttpswwwgitbookcom_6302" rel="nofollow">[Published with GitBook](https://www.gitbook.com/)</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="Python_5"></a>九、Python网络爬虫进阶实战(上)</h2> 
<pre><code class="prism language-python"><span class="token number">1</span><span class="token punctuation">.</span> Scrapy框架介绍与安装
<span class="token number">2</span><span class="token punctuation">.</span> Scrapy框架的使用
<span class="token number">3</span><span class="token punctuation">.</span> Selector选择器
<span class="token number">4</span><span class="token punctuation">.</span> Spider的使用
<span class="token number">5</span><span class="token punctuation">.</span> Downloader Middleware的使用
<span class="token number">6</span><span class="token punctuation">.</span> Spider Middleware的使用
<span class="token number">7</span><span class="token punctuation">.</span> ItemPipeline的使用
<span class="token number">8</span><span class="token punctuation">.</span> Scrapy实战案例
</code></pre> 
<h3><a id="1_Scrapy_20"></a>1. Scrapy框架介绍与安装</h3> 
<h4><a id="11Scrapy_22"></a>1.1.认识Scrapy框架</h4> 
<h5><a id="Scrapy_24"></a>Scrapy框架介绍：</h5> 
<ul><li><code>Scrapy</code>是: 由<code>Python</code>语言开发的一个快速、高层次的屏幕抓取和web抓取框架，用于抓取web站点并从页面中提取结构化的数据。</li><li>Scrapy用途广泛，可以用于<code>数据挖掘</code>、<code>监测</code>和<code>自动化测试</code>。</li></ul> 
<p><img src="https://images2.imgbox.com/76/ae/oIp9YodQ_o.png" alt="img">]</p> 
<ul><li>Scrapy吸引人的地方在于它是一个框架，任何人都可以根据需求方便的修改。它也提供了多种类型爬虫的基类，如BaseSpider、sitemap爬虫等，最新版本又提供了web2.0爬虫的支持。</li><li>Scrap，是碎片的意思，这个Python的爬虫框架叫Scrapy。</li></ul> 
<h5><a id="Scrapy_34"></a>Scrapy框架的运行原理：</h5> 
<p><img src="https://images2.imgbox.com/44/c0/G7sIbZAe_o.png" alt="img">]</p> 
<h5><a id="Scrapy_38"></a>Scrapy主要包括了以下组件：</h5> 
<ul><li>引擎(Scrapy Engine) 
  <ul><li>用来处理整个系统的数据流处理, 触发事务(框架核心)</li></ul> </li><li>Item 项目，它定义了爬取结果的数据结构，爬取的数据会赋值成改Item对象</li><li>调度器(Scheduler) 
  <ul><li>用来接受引擎发过来的请求, 压入队列中, 并在引擎再次请求的时候返回.</li><li>可以想像成一个URL（抓取网页的网址或者说是链接）的优先队列, 由它来决定下一个要抓取的网址是什么, 同时去除重复的网址</li></ul> </li><li>下载器(Downloader) 
  <ul><li>用于下载网页内容, 并将网页内容返回给蜘蛛(Scrapy下载器是建立在twisted这个高效的异步模型上的)</li></ul> </li><li>爬虫(Spiders) 
  <ul><li>爬虫是主要干活的, 用于从特定的网页中提取自己需要的信息, 即所谓的实体(Item)。用户也可以从中提取出链接,让Scrapy继续抓取下一个页面</li></ul> </li><li>项目管道(Pipeline) 
  <ul><li>负责处理爬虫从网页中抽取的实体，主要的功能是持久化实体、验证实体的有效性、清除不需要的信息。当页面被爬虫解析后，将被发送到项目管道，并经过几个特定的次序处理数据。</li></ul> </li><li>下载器中间件(Downloader Middlewares) 
  <ul><li>位于Scrapy引擎和下载器之间的框架，主要是处理Scrapy引擎与下载器之间的请求及响应。</li></ul> </li><li>爬虫中间件(Spider Middlewares) 
  <ul><li>介于Scrapy引擎和爬虫之间的框架，主要工作是处理蜘蛛的响应输入和请求输出。</li></ul> </li><li>调度中间件(Scheduler Middewares) 
  <ul><li>介于Scrapy引擎和调度之间的中间件，从Scrapy引擎发送到调度的请求和响应。</li></ul> </li></ul> 
<h6><a id="Scrapy_59"></a>Scrapy运行流程大概如下：</h6> 
<p>数据处理流程</p> 
<ul><li>Scrapy的整个数据处理流程有Scrapy引擎进行控制，其主要的运行方式为：</li><li>引擎打开一个域名，时蜘蛛处理这个域名，并让蜘蛛获取第一个爬取的URL。</li><li>引擎从蜘蛛那获取第一个需要爬取的URL，然后作为请求在调度中进行调度。</li><li>引擎从调度那获取接下来进行爬取的页面。</li><li>调度将下一个爬取的URL返回给引擎，引擎将它们通过下载中间件发送到下载器。</li><li>当网页被下载器下载完成以后，响应内容通过下载中间件被发送到引擎。</li><li>引擎收到下载器的响应并将它通过蜘蛛中间件发送到蜘蛛进行处理。</li><li>蜘蛛处理响应并返回爬取到的项目，然后给引擎发送新的请求。</li><li>引擎将抓取到的项目项目管道，并向调度发送请求。</li><li>系统重复第二部后面的操作，直到调度中没有请求，然后断开引擎与域之间的联系。</li></ul> 
<h4><a id="12_Scrapy_74"></a>1.2 Scrapy的安装：</h4> 
<ul><li>第一种：在命令行模式下使用pip命令即可安装：</li></ul> 
<pre><code>    $ pip install scrapy

    F:\Python02\demo&gt;scrapy version
    Scrapy 1.5.0
</code></pre> 
<ul><li>第二种：首先下载，然后再安装：</li></ul> 
<pre><code>    $ pip download scrapy -d ./

    # 通过指定国内镜像源下载 
    $pip download  -i https://pypi.tuna.tsinghua.edu.cn/simple scrapy -d ./
</code></pre> 
<ul><li>具体文件如下：</li></ul> 
<p><img src="https://images2.imgbox.com/80/44/ArIEULen_o.png" alt="img">]</p> 
<ul><li>进入下载目录后执行下面命令安装：</li></ul> 
<pre><code>  $ pip install Scrapy-1.5.0-py2.py3-none-any.whl
</code></pre> 
<ul><li>注意安装过程中由于缺少 <code>Microsoft Visual C++ 14.0</code> 那么请先安装此软件后再执行上面的命令安装就可以了。</li></ul> 
<p><img src="https://images2.imgbox.com/dc/44/6Y725u24_o.png" alt="img">]</p> 
<ul><li>下载软件如下：visualcppbuildtools_full.exe</li></ul> 
<p><img src="https://images2.imgbox.com/86/02/tVY4Idam_o.png" alt="img">]</p> 
<h4><a id="13_Scrapy_112"></a>1.3 Scrapy爬虫框架的具体使用步骤如下：</h4> 
<p><img src="https://images2.imgbox.com/41/cc/jQnxXXVW_o.png" alt="img">]</p> 
<h3><a id="2_Scrapy_116"></a>2. Scrapy框架的使用</h3> 
<h4><a id="21_Scrapy_118"></a>2.1 Scrapy框架的命令介绍</h4> 
<h5><a id="Scrapy_____120"></a>Scrapy 命令 分为两种：<code>全局命令</code> 和 <code>项目命令</code>。</h5> 
<ul><li><code>全局命令</code>：在哪里都能使用。</li><li><code>项目命令</code>：必须在爬虫项目里面才能使用。</li></ul> 
<h6><a id="_125"></a>全局命令</h6> 
<pre><code>C:\Users\AOBO&gt;scrapy -h
Scrapy 1.2.1 - no active project

使用格式:
  scrapy &lt;command&gt; [options] [args]

可用的命令:
  bench         测试本地硬件性能（工作原理：）：scrapy bench
  commands
  fetch         取URL使用Scrapy下载
  genspider     产生新的蜘蛛使用预先定义的模板
  runspider     运用单独一个爬虫文件：scrapy runspider abc.py
  settings      获取设置值
  shell         进入交互终端，用于爬虫的调试（如果你不调试，那么就不常用）：scrapy shell http://www.baidu.com --nolog（--nolog 不显示日志信息）
  startproject  创建一个爬虫项目，如：scrapy startproject demo（demo 创建的爬虫项目的名字）
  version       查看版本：（scrapy version）
  view          下载一个网页的源代码，并在默认的文本编辑器中打开这个源代码：scrapy view http://www.aobossir.com/

  [ more ]      从项目目录运行时可获得更多命令

使用 "scrapy &lt;command&gt; -h" 要查看有关命令的更多信息
</code></pre> 
<h6><a id="_151"></a>项目命令：</h6> 
<pre><code>D:\BaiduYunDownload\first&gt;scrapy -h
Scrapy 1.2.1 - project: first

Usage:
  scrapy &lt;command&gt; [options] [args]

Available commands:
  bench         Run quick benchmark test
  check         Check spider contracts
  commands
  crawl         运行一个爬虫文件。：scrapy crawl f1 或者 scrapy crawl f1 --nolog
  edit          使用编辑器打开爬虫文件 （Windows上似乎有问题，Linux上没有问题）：scrapy edit f1
  fetch         Fetch a URL using the Scrapy downloader
  genspider     Generate new spider using pre-defined templates
  list          列出当前爬虫项目下所有的爬虫文件： scrapy list
  parse         Parse URL (using its spider) and print the results
  runspider     Run a self-contained spider (without creating a project)
  settings      获取设置值
  shell         进入交互终端，用于爬虫的调试（如果你不调试，那么就不常用）
  startproject  创建一个爬虫项目，如：scrapy startproject demo（demo 创建的爬虫项目的名字）
  version       查看版本：（scrapy version）
  view          下载一个网页的源代码，并在默认的文本编辑器中打开这个源代码

Use "scrapy &lt;command&gt; -h" to see more info about a command
</code></pre> 
<p>注意：Scrapy运行ImportError: No module named win32api错误。请安装：pip install pypiwin32</p> 
<h5><a id="Scrapy_182"></a>Scrapy框架的命令使用：</h5> 
<ul><li> <p>查看所有命令</p> <pre><code>scrapy -h
</code></pre> </li><li> <p>查看帮助信息:</p> <pre><code>scapy --help
</code></pre> </li><li> <p>查看版本信息:</p> <pre><code>(venv)ql@ql:~$ scrapy version
Scrapy 1.1.2
(venv)ql@ql:~$ 
(venv)ql@ql:~$ scrapy version -v
Scrapy    : 1.1.2
lxml      : 3.6.4.0
libxml2   : 2.9.4
Twisted   : 16.4.0
Python    : 2.7.12 (default, Jul  1 2016, 15:12:24) - [GCC 5.4.0 20160609]
pyOpenSSL : 16.1.0 (OpenSSL 1.0.2g-fips  1 Mar 2016)
Platform  : Linux-4.4.0-36-generic-x86_64-with-Ubuntu-16.04-xenial
(venv)ql@ql:~$
</code></pre> </li><li> <p>新建一个工程</p> </li></ul> 
<pre><code>scrapy startproject spider_name
</code></pre> 
<ul><li> <p>构建爬虫genspider(generator spider)</p> </li><li> <p>一个工程中可以存在多个spider, 但是名字必须唯一</p> <pre><code>scrapy genspider name domain
#如:
#scrapy genspider sohu sohu.org
</code></pre> </li><li> <p>查看当前项目内有多少爬虫</p> <pre><code>scrapy list
</code></pre> </li><li> <p>view使用浏览器打开网页</p> <pre><code>scrapy view http://www.baidu.com
</code></pre> </li></ul> 
<h6><a id="shell_scrpay_241"></a>shell命令, 进入scrpay交互环境</h6> 
<pre><code># 进入该url的交互环境
scrapy shell http://www.dmoz.org/Computers/Programming/Languages/Python/Books/
</code></pre> 
<ul><li> <p>之后便进入交互环境，我们主要使用这里面的response命令, 例如可以使用</p> <pre><code>response.xpath()    #括号里直接加xpath路径
</code></pre> </li><li> <p>runspider命令用于直接运行创建的爬虫, 并不会运行整个项目</p> <pre><code>scrapy runspider 爬虫名称
</code></pre> </li></ul> 
<h4><a id="22_Scrapy_260"></a>2.2 Scrapy框架的使用：</h4> 
<ul><li>接下来通过一个简单的项目，完成一遍Scrapy抓取流程。</li><li>具体流程如下： 
  <ul><li>创建一个scrapy项目：</li><li>创键一个Spider来抓取站点和处理数据。</li><li>到过命令行将抓取的抓取内容导出</li></ul> </li></ul> 
<h5><a id="__268"></a>① 创建项目</h5> 
<ul><li>爬取我爱我家的楼盘信息：</li><li>网址： https://fang.5i5j.com/bj/loupan/</li><li>在命令行编写下面命令，创建项目demo</li></ul> 
<pre><code>scrapy startproject  demo
</code></pre> 
<ul><li>项目目录结构：</li></ul> 
<pre><code>demo
├── demo
│   ├── __init__.py
│   ├── __pycache__
│   ├── items.py        # Items的定义，定义抓取的数据结构
│   ├── middlewares.py  # 定义Spider和DownLoader的Middlewares中间件实现。 
│   ├── pipelines.py    # 它定义Item Pipeline的实现，即定义数据管道
│   ├── settings.py     # 它定义项目的全局配置
│   └── spiders         # 其中包含一个个Spider的实现，每个Spider都有一个文件
│       ├── __init__.py
│       └── __pycache__
└── scrapy.cfg    #Scrapy部署时的配置文件，定义了配置文件路径、部署相关信息等内容
</code></pre> 
<h5><a id="_demospider_295"></a>② 进入demo项目目录，创建爬虫spider类文件</h5> 
<ul><li>执行genspider命令，第一个参数是Spider的名称，第二个参数是网站域名。</li></ul> 
<pre><code>scrapy genspider fang fang.5i5j.com

$ tree 

├── demo
│   ├── __init__.py
│   ├── __pycache__
│   │   ├── __init__.cpython-36.pyc
│   │   └── settings.cpython-36.pyc
│   ├── items.py
│   ├── middlewares.py
│   ├── pipelines.py
│   ├── settings.py
│   └── spiders
│       ├── __init__.py
│       ├── __pycache__
│       │   └── __init__.cpython-36.pyc
│       └── fang.py  #在spiders目录下有了一个爬虫类文件fang.py
└── scrapy.cfg


# fang.py的文件代码如下：

# -*- coding: utf-8 -*-
import scrapy

class FangSpider(scrapy.Spider):
    name = 'fang'
    allowed_domains = ['fang.5i5j.com']
    start_urls = ['http://fang.5i5j.com/']

    def parse(self, response):
        pass
</code></pre> 
<ul><li>Spider是自己定义的类，Scrapy用它来从网页中抓取内容，并解析抓取结果。</li><li>此类继承Scrapy提供的Spider类scrapy.Spider，类中有三个属性：name、allowed_domains、start_urls和方法parse。</li><li>name：是每个项目唯一名字，用于区分不同Spider。</li><li>allowed_domains: 它是允许爬取的域名，如果初始或后续的请求链接不是这个域名，则请求链接会被过滤掉</li><li>start_urls： 它包含了Spider在启动时爬取的URL列表，初始请求是由它来定义的。</li><li>parse方法： 调用start_urls链接请求下载执行后则调用parse方法，并将结果传入此方法。</li></ul> 
<h5><a id="_Item_342"></a>③ 创建Item</h5> 
<ul><li>Item是保存爬取数据的容器，它的使用方法和字典类型，但相比字典多了些保护机制。</li><li>创建Item需要继承scrapy.Item类，并且定义类型为scrapy.Field的字段：（标题、地址、开盘时间、浏览次数、单价）</li><li>具体代码如下：</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">import</span> scrapy

<span class="token keyword">class</span> <span class="token class-name">FangItem</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Item<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># define the fields for your item here like:</span>
    title <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    address <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    time <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    clicks <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    price <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">#pass</span>
</code></pre> 
<h5><a id="_Response_361"></a>④ 解析Response</h5> 
<ul><li>在fang.py文件中，parse()方法的参数response是start_urls里面的链接爬取后的结果。</li><li>提取的方式可以是CSS选择器、XPath选择器或者是re正则表达式。</li></ul> 
<pre><code class="prism language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">import</span> scrapy
<span class="token keyword">from</span> demo<span class="token punctuation">.</span>items <span class="token keyword">import</span> FangItem

<span class="token keyword">class</span> <span class="token class-name">FangSpider</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">'fang'</span>
    allowed_domains <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'fang.5i5j.com'</span><span class="token punctuation">]</span>
    <span class="token comment">#start_urls = ['http://fang.5i5j.com/']</span>
    start_urls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'https://fang.5i5j.com/bj/loupan/'</span><span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        hlist <span class="token operator">=</span> response<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">"div.houseList_list"</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> vo <span class="token keyword">in</span> hlist<span class="token punctuation">:</span>
            item <span class="token operator">=</span> FangItem<span class="token punctuation">(</span><span class="token punctuation">)</span>
            item<span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span> <span class="token operator">=</span>  vo<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">"h3.fontS20 a::text"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span>
            item<span class="token punctuation">[</span><span class="token string">'address'</span><span class="token punctuation">]</span> <span class="token operator">=</span>  vo<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">"span.addressName::text"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span>
            item<span class="token punctuation">[</span><span class="token string">'time'</span><span class="token punctuation">]</span> <span class="token operator">=</span>  vo<span class="token punctuation">.</span>re<span class="token punctuation">(</span><span class="token string">"&lt;span&gt;(.*?)开盘&lt;/span&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            item<span class="token punctuation">[</span><span class="token string">'clicks'</span><span class="token punctuation">]</span> <span class="token operator">=</span>  vo<span class="token punctuation">.</span>re<span class="token punctuation">(</span><span class="token string">"&lt;span&gt;&lt;i&gt;([0-9]+)&lt;/i&gt;浏览&lt;/span&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            item<span class="token punctuation">[</span><span class="token string">'price'</span><span class="token punctuation">]</span> <span class="token operator">=</span>  vo<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">"i.fontS24::text"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">#print(item)</span>
            <span class="token keyword">yield</span> item
</code></pre> 
<h5><a id="_Item_Pipeline_390"></a>⑤ 使用Item Pipeline</h5> 
<ul><li>Item Pipeline为项目管道，当Item生产后，他会自动被送到Item Pipeline进行处理：</li><li>我们常用Item Pipeline来做如下操作： 
  <ul><li>清理HTML数据</li><li>验证抓取数据，检查抓取字段</li><li>查重并丢弃重复内容</li><li>将爬取结果保存到数据库里。</li></ul> </li></ul> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">DemoPipeline</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">process_item</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> item<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
        <span class="token keyword">return</span> item
</code></pre> 
<ul><li>进入配置settings中开启Item Pipelines的使用</li></ul> 
<h5><a id="__408"></a>⑥ 运行：</h5> 
<ul><li> <p>执行如下命令来启用数据爬取</p> <pre><code>scrapy crawl fang
</code></pre> </li><li> <p>将结果保存到文件中: 格式：json、csv、xml、pickle、marshal等</p> </li></ul> 
<pre><code>scrapy crawl fang -o fangs.json
scrapy crawl fang -o fangs.csv
scrapy crawl fang -o fangs.xml
scrapy crawl fang -o fangs.pickle
scrapy crawl fang -o fangs.marshal
</code></pre> 
<h4><a id="23_ScrapyPOST_426"></a>2.3 Scrapy框架中的POST提交：</h4> 
<ul><li>在Scrapy框架中默认都是GET的提交方式，但是我们可以使用<code>FormRequest</code>来完成POST提交，并可以携带参数。</li><li>如下案例为有道词典的翻译信息爬取案例，网址：<code>http://fanyi.youdao.com/translate?smartresult=dict&amp;smartresult=rule</code></li><li>首先创建一个<code>youdao</code>有道的爬虫文件：</li></ul> 
<pre><code>scrapy genspider youdao fanyi.youdao.com
</code></pre> 
<ul><li>编写爬虫文件，注意返回的是json格式，具体代码如下：</li></ul> 
<pre><code class="prism language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">import</span> scrapy<span class="token punctuation">,</span>json


<span class="token keyword">class</span> <span class="token class-name">YoudaoSpider</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">'youdao'</span>
    allowed_domains <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'fanyi.youdao.com'</span><span class="token punctuation">]</span>
    <span class="token comment">#start_urls = ['http://fanyi.youdao.com']</span>

    <span class="token keyword">def</span> <span class="token function">start_requests</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        url <span class="token operator">=</span> <span class="token string">'http://fanyi.youdao.com/translate?smartresult=dict&amp;smartresult=rule'</span>
        keyword <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"请输入要翻译的单词："</span><span class="token punctuation">)</span>
        data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'i'</span><span class="token punctuation">:</span>keyword<span class="token punctuation">,</span><span class="token string">'doctype'</span><span class="token punctuation">:</span> <span class="token string">'json'</span><span class="token punctuation">,</span><span class="token punctuation">}</span>
        <span class="token comment"># FormRequest 是Scrapy发送POST请求的方法</span>
        <span class="token keyword">yield</span> scrapy<span class="token punctuation">.</span>FormRequest<span class="token punctuation">(</span>
            url <span class="token operator">=</span> url<span class="token punctuation">,</span>
            formdata <span class="token operator">=</span> data<span class="token punctuation">,</span>
            callback <span class="token operator">=</span> self<span class="token punctuation">.</span>parse
        <span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        res <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>response<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">[</span><span class="token string">'translateResult'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tgt'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"按任意键继续"</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="3_Selector_465"></a>3. Selector选择器</h3> 
<ul><li>对用爬取信息的解析，我们在之前已经介绍了正则re、Xpath、Beautiful Soup和PyQuery。</li><li>而Scrapy还给我们提供自己的数据解析方法，即Selector（选择器）。</li><li>Selector（选择器）是基于lxml来构建的，支持XPath、CSS选择器以及正则表达式，功能全面，解析速度和准确度非常高。</li></ul> 
<h4><a id="31__471"></a>3.1 直接使用：</h4> 
<ul><li>Selector（选择器）是一个可以独立使用模块。 直接导入模块，就可以实例化使用，如下所示：</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">from</span> scrapy <span class="token keyword">import</span> Selector

content<span class="token operator">=</span><span class="token string">"&lt;html&gt;&lt;head&gt;&lt;title&gt;My html&lt;/title&gt;&lt;body&gt;&lt;h3&gt;Hello Word!&lt;/h3&gt;&lt;/body&gt;&lt;/head&gt;&lt;/html&gt;"</span>

selector <span class="token operator">=</span> Selector<span class="token punctuation">(</span>text<span class="token operator">=</span>content<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>selector<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'/html/head/title/text()'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>selector<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">'h3::text'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="32_Scrapy_shell_487"></a>3.2 Scrapy shell</h4> 
<ul><li>我们借助于Scrapy shell来模拟请求的过程，然后把一些可操作的变量传递给我们，如request、response等。</li></ul> 
<pre><code>zhangtaodeMacBook-Pro:scrapydemo zhangtao$ scrapy shell http://www.baidu.com
2018-05-08 14:46:29 [scrapy.utils.log] INFO: Scrapy 1.5.0 started (bot: scrapybot)
2018-05-08 14:46:29 [scrapy.utils.log] INFO: Versions: lxml 4.2.1.0, libxml2 2.9.8, cssselect 1.0.3, parsel 1.4.0, w3lib 1.19.0, Twisted 18.4.0, Python 3.6.4 (default, Jan  6 2018, 11:49:38) - [GCC 4.2.1 Compatible Apple LLVM 8.0.0 (clang-800.0.42.1)], pyOpenSSL 17.5.0 (OpenSSL 1.1.0h  27 Mar 2018), cryptography 2.2.2, Platform Darwin-15.6.0-x86_64-i386-64bit
2018-05-08 14:46:29 [scrapy.crawler] INFO: Overridden settings: {'DUPEFILTER_CLASS': 'scrapy.dupefilters.BaseDupeFilter', 'LOGSTATS_INTERVAL': 0}
2018-05-08 14:46:29 [scrapy.middleware] INFO: Enabled extensions:
['scrapy.extensions.corestats.CoreStats',
 'scrapy.extensions.telnet.TelnetConsole',
 'scrapy.extensions.memusage.MemoryUsage']
2018-05-08 14:46:29 [scrapy.middleware] INFO: Enabled downloader middlewares:
['scrapy.downloadermiddlewares.httpauth.HttpAuthMiddleware',
 'scrapy.downloadermiddlewares.downloadtimeout.DownloadTimeoutMiddleware',
 'scrapy.downloadermiddlewares.defaultheaders.DefaultHeadersMiddleware',
 'scrapy.downloadermiddlewares.useragent.UserAgentMiddleware',
 'scrapy.downloadermiddlewares.retry.RetryMiddleware',
 'scrapy.downloadermiddlewares.redirect.MetaRefreshMiddleware',
 'scrapy.downloadermiddlewares.httpcompression.HttpCompressionMiddleware',
 'scrapy.downloadermiddlewares.redirect.RedirectMiddleware',
 'scrapy.downloadermiddlewares.cookies.CookiesMiddleware',
 'scrapy.downloadermiddlewares.httpproxy.HttpProxyMiddleware',
 'scrapy.downloadermiddlewares.stats.DownloaderStats']
2018-05-08 14:46:29 [scrapy.middleware] INFO: Enabled spider middlewares:
['scrapy.spidermiddlewares.httperror.HttpErrorMiddleware',
 'scrapy.spidermiddlewares.offsite.OffsiteMiddleware',
 'scrapy.spidermiddlewares.referer.RefererMiddleware',
 'scrapy.spidermiddlewares.urllength.UrlLengthMiddleware',
 'scrapy.spidermiddlewares.depth.DepthMiddleware']
2018-05-08 14:46:29 [scrapy.middleware] INFO: Enabled item pipelines:
[]
2018-05-08 14:46:29 [scrapy.extensions.telnet] DEBUG: Telnet console listening on 127.0.0.1:6023
2018-05-08 14:46:29 [scrapy.core.engine] INFO: Spider opened
2018-05-08 14:46:29 [scrapy.core.engine] DEBUG: Crawled (200) &lt;GET http://www.baidu.com&gt; (referer: None)
[s] Available Scrapy objects:
[s]   scrapy     scrapy module (contains scrapy.Request, scrapy.Selector, etc)
[s]   crawler    &lt;scrapy.crawler.Crawler object at 0x108ea8ac8&gt;
[s]   item       {}
[s]   request    &lt;GET http://www.baidu.com&gt;
[s]   response   &lt;200 http://www.baidu.com&gt;
[s]   settings   &lt;scrapy.settings.Settings object at 0x109cbb8d0&gt;
[s]   spider     &lt;DefaultSpider 'default' at 0x109f56e10&gt;
[s] Useful shortcuts:
[s]   fetch(url[, redirect=True]) Fetch URL and update local objects (by default, redirects are followed)
[s]   fetch(req)                  Fetch a scrapy.Request and update local objects 
[s]   shelp()           Shell help (print this help)
[s]   view(response)    View response in a browser
&gt;&gt;&gt; response.url
'http://www.baidu.com'
&gt;&gt;&gt; response.status
200
&gt;&gt;&gt; response.xpath('/html/head/title/text()').extract_first()
'百度一下，你就知道'
&gt;&gt;&gt; response.xpath('//a/text()').extract_first()
'新闻'
&gt;&gt;&gt; response.xpath('//a/text()').extract()
['新闻', 'hao123', '地图', '视频', '贴吧', '登录', '更多产品', '关于百度', 'About Baidu', '使用百度前必读', '意见反馈']
&gt;&gt;&gt; response.xpath('//a/@href').extract()
['http://news.baidu.com', 'http://www.hao123.com', 'http://map.baidu.com', 'http://v.baidu.com', 'http://tieba.baidu.com', 'http://www.baidu.com/bdorz/login.gif?login&amp;tpl=mn&amp;u=http%3A%2F%2Fwww.baidu.com%2f%3fbdorz_come%3d1', '//www.baidu.com/more/', 'http://home.baidu.com', 'http://ir.baidu.com', 'http://www.baidu.com/duty/', 'http://jianyi.baidu.com/']
</code></pre> 
<h4><a id="33_Xpath_550"></a>3.3 Xpath选择器：</h4> 
<ul><li>response.selector属性返回内容相当于response的body构造了一个Selector对象。</li><li>Selector对象可以调用xpath（）方法实现信息的解析提取。 
  <ul><li>在xpath（）后使用extract（）可以返回所有的元素结果。</li><li>若xpath（）有问题，那么extract（）会返回一个空列表。</li><li>在xpath（）后使用extract_first（）可以返回第一个元素结果。</li></ul> </li><li>使用scrapy shell 爬取"淘宝网"-&gt;“商品分类”-&gt;"特色市场"的信息。</li></ul> 
<pre><code class="prism language-web-idl">$ scrapy shell https://www.taobao.com/tbhome/page/special-markets
... ...

&gt;&gt;&gt; response.url
'https://www.taobao.com/tbhome/page/special-markets'

&gt;&gt;&gt; response.status
200

&gt;&gt;&gt; response.selector.xpath("//dt/text()")
[&lt;Selector xpath='//dt/text()' data='时尚爆料王'&gt;, &lt;Selector xpath='//dt/text()' data='品质生活家'&gt;, 
 &lt;Selector xpath='//dt/text()' data='特色玩味控'&gt;, &lt;Selector xpath='//dt/text()' data='实惠专业户'&gt;]

&gt;&gt;&gt; response.selector.xpath("//dt/text()").extract()
['时尚爆料王', '品质生活家', '特色玩味控', '实惠专业户']

&gt;&gt;&gt; dllist = response.selector.xpath("//dl[@class='market-list']")
&gt;&gt;&gt; for v in dllist:
...     print(v.xpath("./dt/text()").extract_first())
... 
时尚爆料王
品质生活家
特色玩味控
实惠专业户

&gt;&gt;&gt; for v in dllist:
...     print(v.xpath("./dt/text()").extract_first())
...     print("="*50)
...     alist = v.xpath(".//a")
...     for a in alist:
...             print(a.xpath("./@href").extract_first(),end=":")
...             print(a.xpath("./span/img/@alt").extract_first())
... 
时尚爆料王
==================================================
https://if.taobao.com/:潮流从这里开始
https://guang.taobao.com/:外貌协会の逛街指南
https://mei.taobao.com/:妆 出你的腔调
https://g.taobao.com/:探索全球美好生活
//star.taobao.com/:全球明星在这里
https://mm.taobao.com/:美女红人集中地
https://www.taobao.com/markets/designer/stylish:全球创意设计师平台
品质生活家
==================================================
https://chi.taobao.com/chi/:食尚全球 地道中国
//q.taobao.com:懂得好生活
https://www.jiyoujia.com/:过我想要的生活
https://www.taobao.com/markets/sph/sph/sy:尖货奢品品味选择
https://www.taobao.com/markets/qbb/index:享受育儿生活新方式
//car.taobao.com/:买车省钱，用车省心
//sport.taobao.com/:爱上运动每一天
//zj.taobao.com:匠心所在  物有所值
//wt.taobao.com/:畅享优质通信生活
https://www.alitrip.com/:比梦想走更远
特色玩味控
==================================================
https://china.taobao.com:地道才够味！
https://www.taobao.com/markets/3c/tbdc:为你开启潮流新生活
https://acg.taobao.com/:ACGN  好玩好看
https://izhongchou.taobao.com/index.htm:认真对待每一个梦想。
//enjoy.taobao.com/:园艺宠物爱好者集中营
https://sf.taobao.com/:法院处置资产，0佣金捡漏
https://zc-paimai.taobao.com/:超值资产，投资首选
https://paimai.taobao.com/:想淘宝上拍卖
//xue.taobao.com/:给你未来的学习体验
//2.taobao.com:让你的闲置游起来
https://ny.taobao.com/:价格实惠品类齐全
实惠专业户
==================================================
//tejia.taobao.com/:优质好货 特价专区
https://qing.taobao.com/:品牌尾货365天最低价
https://ju.taobao.com/jusp/other/mingpin/tp.htm:奢侈品团购第一站
https://ju.taobao.com/jusp/other/juliangfan/tp.htm?spm=608.5847457.102202.5.jO4uZI:重新定义家庭生活方式
https://qiang.taobao.com/:抢到就是赚到！
https://ju.taobao.com/jusp/nv/fcdppc/tp.htm:大牌正品 底价特惠
https://ju.taobao.com/jusp/shh/life/tp.htm?:惠聚身边精选好货
https://ju.taobao.com/jusp/sp/global/tp.htm?spm=0.0.0.0.biIDGB:10点上新 全球底价
https://try.taobao.com/index.htm:总有新奇等你发现
</code></pre> 
<h4><a id="34_CSS_640"></a>3.4 CSS选择器：</h4> 
<ul><li>同xpath()一样。</li><li>使用scrapy shell 爬取"淘宝网"-&gt;“商品分类”-&gt;"主题市场"的信息。</li></ul> 
<pre><code class="prism language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> response<span class="token punctuation">.</span>url
<span class="token string">'https://www.taobao.com/tbhome/page/market-list'</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> response<span class="token punctuation">.</span>status
<span class="token number">200</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> response<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">"a.category-name-level1::text"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token string">'女装男装'</span><span class="token punctuation">,</span> <span class="token string">'鞋类箱包'</span><span class="token punctuation">,</span> <span class="token string">'母婴用品'</span><span class="token punctuation">,</span> <span class="token string">'护肤彩妆'</span><span class="token punctuation">,</span> <span class="token string">'汇吃美食'</span><span class="token punctuation">,</span> <span class="token string">'珠宝配饰'</span><span class="token punctuation">,</span> <span class="token string">'家装建材'</span><span class="token punctuation">,</span> <span class="token string">'家居家纺'</span><span class="token punctuation">,</span> <span class="token string">'百货市场'</span><span class="token punctuation">,</span> <span class="token string">'汽车·用品'</span><span class="token punctuation">,</span> <span class="token string">'手机数码'</span><span class="token punctuation">,</span> <span class="token string">'家电办公'</span><span class="token punctuation">,</span> <span class="token string">'更多服务'</span><span class="token punctuation">,</span> <span class="token string">'生活服务'</span><span class="token punctuation">,</span> <span class="token string">'运动户外'</span><span class="token punctuation">,</span> <span class="token string">'花鸟文娱'</span><span class="token punctuation">,</span> <span class="token string">'农资采购'</span><span class="token punctuation">]</span>

<span class="token comment">#获取淘宝页面中所有分类信息</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> dlist <span class="token operator">=</span> response<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">"div.home-category-list"</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> dd <span class="token keyword">in</span> dlist<span class="token punctuation">:</span>
      <span class="token keyword">print</span><span class="token punctuation">(</span>dd<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">"a.category-name-level1::text"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token operator">*</span><span class="token number">50</span><span class="token punctuation">)</span>
      alist <span class="token operator">=</span> dd<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">"li.category-list-item"</span><span class="token punctuation">)</span>
      <span class="token keyword">for</span> v <span class="token keyword">in</span> alist<span class="token punctuation">:</span>
              <span class="token keyword">print</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">"./a/text()"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
              <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"-"</span><span class="token operator">*</span><span class="token number">50</span><span class="token punctuation">)</span>
              talist <span class="token operator">=</span> v<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">"div.category-items a"</span><span class="token punctuation">)</span>
              <span class="token keyword">for</span> a <span class="token keyword">in</span> talist<span class="token punctuation">:</span>
                      <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">"::text"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>end<span class="token operator">=</span><span class="token string">" "</span><span class="token punctuation">)</span>
              <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span>女装男装
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
潮流女装
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
羽绒服 毛呢大衣 毛衣 冬季外套 新品 裤子 连衣裙 腔调 

时尚男装
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
秋冬新品 淘特莱斯 淘先生 拾货 秋冬外套 时尚套装 潮牌 爸爸装 

性感内衣
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
春新品 性感诱惑 甜美清新 简约优雅 奢华高贵 运动风 塑身 基础内衣 

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

注：css中获取属性：a<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">"::attr(href)"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="35__686"></a>3.5 正则匹配：</h4> 
<pre><code class="prism language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> response<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">"//head"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>re<span class="token punctuation">(</span><span class="token string">"&lt;title&gt;(.*?)&lt;/title&gt;"</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token string">'淘宝首页行业市场'</span><span class="token punctuation">]</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> response<span class="token punctuation">.</span>selector<span class="token punctuation">.</span>re<span class="token punctuation">(</span><span class="token string">"&lt;a .*?&gt;(.*?)&lt;/a&gt;"</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="4_Spider_695"></a>4. Spider的使用</h3> 
<ul><li>在Scrapy中，要抓取网站的链接配置、抓取逻辑、解析逻辑里其实都是在Spider中配置的。</li><li>Spider要做的事就是有两件：<code>定义抓取网站的动作</code>和<code>分析爬取下来的网页</code>。</li></ul> 
<h4><a id="41_Spider_700"></a>4.1 Spider运行流程：</h4> 
<ul><li>整个抓取循环过程如下所述： 
  <ul><li>以初始的URL初始化Request,并设置回调函数。请求成功时Response生成并作为参数传给该回调函数。</li><li>在回调函数内分析返回的网页内容。返回结果两种形式，一种为字典或Item数据对象；另一种是解析到下一个链接。</li><li>如果返回的是字典或Item对象，我们可以将结果存入文件，也可以使用Pipeline处理并保存。</li><li>如果返回Request，Response会被传递给Request中定义的回调函数参数，即再次使用选择器来分析生成数据Item。</li></ul> </li></ul> 
<h4><a id="42_Spider_708"></a>4.2 Spider类分析：</h4> 
<ul><li>Spider类源代码：打开文件<code>Python36/Lib/site-packages/scrapy/spiders/__init__.py</code></li></ul> 
<pre><code class="prism language-python"><span class="token keyword">import</span> logging
<span class="token keyword">import</span> warnings

<span class="token keyword">from</span> scrapy <span class="token keyword">import</span> signals
<span class="token keyword">from</span> scrapy<span class="token punctuation">.</span>http <span class="token keyword">import</span> Request
<span class="token keyword">from</span> scrapy<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>trackref <span class="token keyword">import</span> object_ref
<span class="token keyword">from</span> scrapy<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>url <span class="token keyword">import</span> url_is_from_spider
<span class="token keyword">from</span> scrapy<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>deprecate <span class="token keyword">import</span> create_deprecated_class
<span class="token keyword">from</span> scrapy<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> ScrapyDeprecationWarning
<span class="token keyword">from</span> scrapy<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>deprecate <span class="token keyword">import</span> method_is_overridden

<span class="token comment">#所有爬虫的基类，自定义的爬虫必须从继承此类</span>
<span class="token keyword">class</span> <span class="token class-name">Spider</span><span class="token punctuation">(</span>object_ref<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token comment">#定义spider名字的字符串(string)。spider的名字定义了Scrapy如何定位(并初始化)spider，所以其必须是唯一的。</span>
    <span class="token comment">#name是spider最重要的属性，而且是必须的。</span>
    <span class="token comment">#一般做法是以该网站(domain)(加或不加 后缀 )来命名spider。 例如，如果spider爬取 douban.com ，该spider通常会被命名为 douban</span>
    name <span class="token operator">=</span> <span class="token boolean">None</span>
    custom_settings <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token comment">#初始化，提取爬虫名字，start_ruls</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> name <span class="token keyword">is</span> <span class="token operator">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>name <span class="token operator">=</span> name
        <span class="token comment"># 如果爬虫没有名字，中断后续操作则报错</span>
        <span class="token keyword">elif</span> <span class="token operator">not</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"%s must have a name"</span> <span class="token operator">%</span> <span class="token builtin">type</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">.</span>__name__<span class="token punctuation">)</span>

        <span class="token comment"># python 对象或类型通过内置成员__dict__来存储成员信息</span>
        self<span class="token punctuation">.</span>__dict__<span class="token punctuation">.</span>update<span class="token punctuation">(</span>kwargs<span class="token punctuation">)</span>

        <span class="token comment">#URL列表。当没有指定的URL时，spider将从该列表中开始进行爬取。因此，第一个被获取到的页面的URL将是该列表之一。 后续的URL将会从获取到的数据中提取。</span>
        <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">'start_urls'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>start_urls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    @<span class="token builtin">property</span>
    <span class="token keyword">def</span> <span class="token function">logger</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        logger <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span>self<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
        <span class="token keyword">return</span> logging<span class="token punctuation">.</span>LoggerAdapter<span class="token punctuation">(</span>logger<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token string">'spider'</span><span class="token punctuation">:</span> self<span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment"># 打印Scrapy执行后的log信息</span>
    <span class="token keyword">def</span> <span class="token function">log</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> message<span class="token punctuation">,</span> level<span class="token operator">=</span>log<span class="token punctuation">.</span>DEBUG<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span><span class="token punctuation">:</span>
        log<span class="token punctuation">.</span>msg<span class="token punctuation">(</span>message<span class="token punctuation">,</span> spider<span class="token operator">=</span>self<span class="token punctuation">,</span> level<span class="token operator">=</span>level<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span>

    @<span class="token builtin">classmethod</span>
    <span class="token keyword">def</span> <span class="token function">from_crawler</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> crawler<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        spider <span class="token operator">=</span> cls<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        spider<span class="token punctuation">.</span>_set_crawler<span class="token punctuation">(</span>crawler<span class="token punctuation">)</span>
        <span class="token keyword">return</span> spider

    <span class="token comment">#判断对象object的属性是否存在，不存在做断言处理</span>
    <span class="token keyword">def</span> <span class="token function">set_crawler</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> crawler<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">assert</span> <span class="token operator">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">'_crawler'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Spider already bounded to %s"</span> <span class="token operator">%</span> crawler
        self<span class="token punctuation">.</span>_set_crawler<span class="token punctuation">(</span>crawler<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_set_crawler</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> crawler<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>crawler <span class="token operator">=</span> crawler
        self<span class="token punctuation">.</span>settings <span class="token operator">=</span> crawler<span class="token punctuation">.</span>settings
        crawler<span class="token punctuation">.</span>signals<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>self<span class="token punctuation">.</span>close<span class="token punctuation">,</span> signals<span class="token punctuation">.</span>spider_closed<span class="token punctuation">)</span>

    <span class="token comment">#@property</span>
    <span class="token comment">#def crawler(self):</span>
    <span class="token comment">#    assert hasattr(self, '_crawler'), "Spider not bounded to any crawler"</span>
    <span class="token comment">#    return self._crawler</span>

    <span class="token comment">#@property</span>
    <span class="token comment">#def settings(self):</span>
    <span class="token comment">#    return self.crawler.settings</span>

    <span class="token comment">#该方法将读取start_urls内的地址，并为每一个地址生成一个Request对象，交给Scrapy下载并返回Response</span>
    <span class="token comment">#该方法仅调用一次</span>
    <span class="token keyword">def</span> <span class="token function">start_requests</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> url <span class="token keyword">in</span> self<span class="token punctuation">.</span>start_urls<span class="token punctuation">:</span>
            <span class="token keyword">yield</span> self<span class="token punctuation">.</span>make_requests_from_url<span class="token punctuation">(</span>url<span class="token punctuation">)</span>

    <span class="token comment">#start_requests()中调用，实际生成Request的函数。</span>
    <span class="token comment">#Request对象默认的回调函数为parse()，提交的方式为get</span>
    <span class="token keyword">def</span> <span class="token function">make_requests_from_url</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> Request<span class="token punctuation">(</span>url<span class="token punctuation">,</span> dont_filter<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token comment">#默认的Request对象回调函数，处理返回的response。</span>
    <span class="token comment">#生成Item或者Request对象。用户必须实现这个类</span>
    <span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> NotImplementedError

    @<span class="token builtin">classmethod</span>
    <span class="token keyword">def</span> <span class="token function">handles_request</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> url_is_from_spider<span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">,</span> cls<span class="token punctuation">)</span>

    @<span class="token builtin">staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">close</span><span class="token punctuation">(</span>spider<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">:</span>
        closed <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>spider<span class="token punctuation">,</span> <span class="token string">'closed'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token builtin">callable</span><span class="token punctuation">(</span>closed<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> closed<span class="token punctuation">(</span>reason<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"&lt;%s %r at 0x%0x&gt;"</span> <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">.</span>__name__<span class="token punctuation">,</span> self<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">)</span>

    __repr__ <span class="token operator">=</span> __str__
</code></pre> 
<ul><li> <p><code>Spider</code>类继承自<code>scrapy.spiders.Spider</code>.</p> </li><li> <p><code>Spider</code>类这个提供了<code>start_requests()</code>方法的默认实现，读取并请求<code>start_urls</code>属性，并调用<code>parse()</code>方法解析结果。</p> </li><li> <pre><code>Spider
</code></pre> <p>类的属性和方法：</p> 
  <ul><li><code>name</code>：爬虫名称，必须唯一的，可以生成多个相同的Spider实例，数量没有限制。</li><li><code>allowed_domains</code>: 允许爬取的域名，是可选配置，不在此范围的链接不会被跟进爬取。</li><li><code>start_urls</code>: 它是起始URL列表，当我们没有实现start_requests()方法时，默认会从这个列表开始抓取。</li><li><code>custom_settings</code>: 它是一个字典，专属于Spider的配置，此设置会覆盖项目全局的设置，必须定义成类变量。</li><li><code>crawler</code>：它是由from_crawler()方法设置的，Crawler对象包含了很多项目组件，可以获取settings等配置信息。</li><li><code>settings</code>: 利用它我们可以直接获取项目的全局设置变量。</li><li><code>start_requests()</code>: 使用start_urls里面的URL来构造Request，而且Request是GET请求方法。</li><li><code>parse()</code>: 当Response没有指定回调函数时，该方法会默认被调用。</li><li><code>closed()</code>: 当Spider关闭时，该方法会调用。</li></ul> </li></ul> 
<h4><a id="43__834"></a>4.3 实战案例：</h4> 
<ul><li>任务：使用scrapy爬取关键字为<code>python</code>信息的百度文库搜索信息（每页10条信息）</li><li>url地址分析： <code>https://wenku.baidu.com/search?word=python&amp;pn=0</code> 第一页</li><li>url地址分析： <code>https://wenku.baidu.com/search?word=python&amp;pn=10</code> 第二页</li><li>具体实现：</li><li>① 使用scrapy命令创建爬虫项目dbwenku</li></ul> 
<pre><code>$ scrapy startproject bdwenku
</code></pre> 
<ul><li>② 创建spider爬虫文件wenku：</li></ul> 
<pre><code>$ cd bdwenku

$ scrapy genspider wenku wenku.baidu.com
</code></pre> 
<ul><li>③ 编辑<code>wenku.py</code>爬虫文件，代码如下：</li></ul> 
<pre><code class="prism language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">import</span> scrapy

<span class="token keyword">class</span> <span class="token class-name">WenkuSpider</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">'wenku'</span>
    allowed_domains <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'wenku.baidu.com'</span><span class="token punctuation">]</span>
    start_urls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'https://wenku.baidu.com/search?word=python&amp;pn=0'</span><span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Hello Scrapy"</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
</code></pre> 
<ul><li>④ 运行测试：</li></ul> 
<pre><code> $ scrapy crawl wenku
</code></pre> 
<ul><li>爬取数据出现错误: <code>DEBUG: Forbidden by robots.txt:</code> 请求被拒绝了</li><li>也就是百度文库的robots.txt设置了禁止外部爬取信息。</li><li>解决办法：在settings.py配置文件中，将ROBOTSTXT_OBEY的值设为False，忽略robot协议，继续爬取。</li></ul> 
<pre><code>...
2018-05-11 11:00:54 [scrapy.core.engine] INFO: Spider opened
2018-05-11 11:00:54 [scrapy.extensions.logstats] INFO: Crawled 0 pages (at 0 pages/min), scraped 0 items (at 0 items/min)
2018-05-11 11:00:54 [scrapy.extensions.telnet] DEBUG: Telnet console listening on 127.0.0.1:6027
2018-05-11 11:00:56 [scrapy.core.engine] DEBUG: Crawled (200) &lt;GET https://wenku.baidu.com/robots.txt&gt; (referer: None)
2018-05-11 11:00:56 [scrapy.downloadermiddlewares.robotstxt] DEBUG: Forbidden by robots.txt: &lt;GET https://wenku.baidu.com/search?word=python&amp;pn=0&gt;
2018-05-11 11:00:56 [scrapy.core.engine] INFO: Closing spider (finished)
2018-05-11 11:00:56 [scrapy.statscollectors] INFO: Dumping Scrapy stats:
{'downloader/exception_count': 1,
 'downloader/exception_type_count/scrapy.exceptions.IgnoreRequest': 1,
...
</code></pre> 
<ul><li>⑤ Spider爬虫文件：<code>wenku.py</code> 的几种写法：</li></ul> 
<pre><code class="prism language-python"><span class="token comment"># 单请求的信息爬取</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">import</span> scrapy

<span class="token keyword">class</span> <span class="token class-name">WenkuSpider</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">'wenku'</span>
    allowed_domains <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'wenku.baidu.com'</span><span class="token punctuation">]</span>
    start_urls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'https://wenku.baidu.com/search?word=python&amp;pn=0'</span><span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        dllist <span class="token operator">=</span> response<span class="token punctuation">.</span>selector<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">"//dl"</span><span class="token punctuation">)</span>
        <span class="token comment">#print(len(dllist))</span>
        <span class="token keyword">for</span> dd <span class="token keyword">in</span> dllist<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>dd<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">"./dt/p/a/@title"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># 多个请求的信息爬取</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">import</span> scrapy

<span class="token keyword">class</span> <span class="token class-name">WenkuSpider</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">'wenku'</span>
    allowed_domains <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'wenku.baidu.com'</span><span class="token punctuation">]</span>
    start_urls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'https://wenku.baidu.com/search?word=python&amp;pn=0'</span><span class="token punctuation">,</span><span class="token string">'https://wenku.baidu.com/search?word=python&amp;pn=10'</span><span class="token punctuation">,</span><span class="token string">'https://wenku.baidu.com/search?word=python&amp;pn=20'</span><span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        dllist <span class="token operator">=</span> response<span class="token punctuation">.</span>selector<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">"//dl"</span><span class="token punctuation">)</span>
        <span class="token comment">#print(len(dllist))</span>
        <span class="token keyword">for</span> dd <span class="token keyword">in</span> dllist<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>dd<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">"./dt/p/a/@title"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token operator">*</span><span class="token number">70</span><span class="token punctuation">)</span> <span class="token comment">#输出一条每个请求后分割线</span>
<span class="token comment"># 实现一个爬取循环，获取10页信息</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">import</span> scrapy

<span class="token keyword">class</span> <span class="token class-name">WenkuSpider</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">'wenku'</span>
    allowed_domains <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'wenku.baidu.com'</span><span class="token punctuation">]</span>
    start_urls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'https://wenku.baidu.com/search?word=python&amp;pn=0'</span><span class="token punctuation">]</span>
    p<span class="token operator">=</span><span class="token number">0</span>
    <span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        dllist <span class="token operator">=</span> response<span class="token punctuation">.</span>selector<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">"//dl"</span><span class="token punctuation">)</span>
        <span class="token comment">#print(len(dllist))</span>
        <span class="token keyword">for</span> dd <span class="token keyword">in</span> dllist<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>dd<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">"./dt/p/a/@title"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token operator">*</span><span class="token number">70</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>p <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>p <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">:</span>
            next_url <span class="token operator">=</span> <span class="token string">'https://wenku.baidu.com/search?word=python&amp;pn='</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>p<span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">)</span>
            url <span class="token operator">=</span> response<span class="token punctuation">.</span>urljoin<span class="token punctuation">(</span>next_url<span class="token punctuation">)</span> <span class="token comment">#构建绝对url地址（这里可省略）</span>
            <span class="token keyword">yield</span> scrapy<span class="token punctuation">.</span>Request<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span>callback<span class="token operator">=</span>self<span class="token punctuation">.</span>parse<span class="token punctuation">)</span>
python
python教程
PYTHON测试题
简明_Python_教程
如何自学 Python<span class="token punctuation">(</span>干货合集<span class="token punctuation">)</span>
python
python
Python介绍<span class="token punctuation">(</span>Introduction to Python<span class="token punctuation">)</span>
Python编程入门<span class="token punctuation">(</span>适合于零基础朋友<span class="token punctuation">)</span>
Python教程
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
python
十分钟学会Python
Python 基础语法<span class="token punctuation">(</span>一<span class="token punctuation">)</span>
python基础分享
Python入门
python新手教程
python资源中文大全
python_笔记
Python与中文处理
python
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
python
python教程
PYTHON测试题
简明_Python_教程
如何自学 Python<span class="token punctuation">(</span>干货合集<span class="token punctuation">)</span>
python
python
Python介绍<span class="token punctuation">(</span>Introduction to Python<span class="token punctuation">)</span>
Python编程入门<span class="token punctuation">(</span>适合于零基础朋友<span class="token punctuation">)</span>
Python教程
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
</code></pre> 
<h3><a id="5_Downloader_Middleware_984"></a>5. Downloader Middleware的使用</h3> 
<ul><li>在Downloader Middleware的功能十分强大：可以修改User-Agent、处理重定向、设置代理、失败重试、设置Cookies等。</li><li>Downloader Middleware在整个架构中起作用的位置是以下两个。 
  <ul><li>在Scheduler调度出队列的Request发送给Doanloader下载之前，也就是我们可以在Request执行下载前对其进行修改。</li><li>在下载后生成的Response发送给Spider之前，也就是我们可以生成Resposne被Spider解析之前对其进行修改。</li></ul> </li></ul> 
<h4><a id="51__991"></a>5.1 使用说明：</h4> 
<ul><li>在Scrapy中已经提供了许多Downloader Middleware，如：负责失败重试、自动重定向等中间件：</li><li>它们都被定义到DOWNLOADER_MIDDLEWARES_BASE变量中。</li></ul> 
<pre><code># 在python3.6/site-packages/scrapy/settings/default_settings.py默认配置中

DOWNLOADER_MIDDLEWARES_BASE = {
    # Engine side
    'scrapy.downloadermiddlewares.robotstxt.RobotsTxtMiddleware': 100,
    'scrapy.downloadermiddlewares.httpauth.HttpAuthMiddleware': 300,
    'scrapy.downloadermiddlewares.downloadtimeout.DownloadTimeoutMiddleware': 350,
    'scrapy.downloadermiddlewares.defaultheaders.DefaultHeadersMiddleware': 400,
    'scrapy.downloadermiddlewares.useragent.UserAgentMiddleware': 500,
    'scrapy.downloadermiddlewares.retry.RetryMiddleware': 550,
    'scrapy.downloadermiddlewares.ajaxcrawl.AjaxCrawlMiddleware': 560,
    'scrapy.downloadermiddlewares.redirect.MetaRefreshMiddleware': 580,
    'scrapy.downloadermiddlewares.httpcompression.HttpCompressionMiddleware': 590,
    'scrapy.downloadermiddlewares.redirect.RedirectMiddleware': 600,
    'scrapy.downloadermiddlewares.cookies.CookiesMiddleware': 700,
    'scrapy.downloadermiddlewares.httpproxy.HttpProxyMiddleware': 750,
    'scrapy.downloadermiddlewares.stats.DownloaderStats': 850,
    'scrapy.downloadermiddlewares.httpcache.HttpCacheMiddleware': 900,
    # Downloader side
}
</code></pre> 
<ul><li>字典格式，其中数字为优先级，越小的优先调用。</li></ul> 
<h4><a id="52_Downloader_Middleware_1021"></a>5.2 自定义Downloader Middleware中间件</h4> 
<ul><li>我们可以通过项目的DOWNLOADER_MIDDLEWARES变量设置来添加自己定义的Downloader Middleware。</li><li>其中Downloader Middleware有三个核心方法： 
  <ul><li>process_request(request,spider)</li><li>process_response(request,response，spider)</li><li>process_exception(request,exception，spider)</li></ul> </li></ul> 
<h5><a id="_process_requestrequestspider_1029"></a>① process_request(request,spider)</h5> 
<ul><li>当每个request通过下载中间件时，该方法被调用，这里有一个要求，该方法必须返回以下三种中的任意一种：<code>None</code>,返回一个<code>Response对象</code>、<code>返回一个Request对象</code>或<code>raise IgnoreRequest</code>。三种返回值的作用是不同的。</li><li><code>None</code>:Scrapy将继续处理该request，执行其他的中间件的相应方法，直到合适的下载器处理函数(download handler)被调用,该request被执行(其response被下载)。</li><li><code>Response对象</code>：Scrapy将不会调用任何其他的process_request()或process_exception() 方法，或相应地下载函数；其将返回该response。 已安装的中间件的 process_response() 方法则会在每个response返回时被调用。</li><li><code>Request对象</code>：Scrapy则停止调用 process_request方法并重新调度返回的request。当新返回的request被执行后， 相应地中间件链将会根据下载的response被调用。</li><li><code>raise一个IgnoreRequest异常</code>：则安装的下载中间件的 process_exception() 方法会被调用。如果没有任何一个方法处理该异常， 则request的errback(Request.errback)方法会被调用。如果没有代码处理抛出的异常，则该异常被忽略且不记录。</li></ul> 
<h5><a id="_process_responserequest_response_spider_1037"></a>② process_response(request, response, spider)</h5> 
<ul><li>process_response的返回值也是有三种：<code>response对象</code>，<code>request对象</code>，或者<code>raise一个IgnoreRequest异常</code></li><li>如果其返回一个Response(可以与传入的response相同，也可以是全新的对象)， 该response会被在链中的其他中间件的 process_response() 方法处理。</li><li>如果其返回一个 Request 对象，则中间件链停止， 返回的request会被重新调度下载。处理类似于 process_request() 返回request所做的那样。</li><li>如果其抛出一个 IgnoreRequest 异常，则调用request的errback(Request.errback)。</li><li>如果没有代码处理抛出的异常，则该异常被忽略且不记录(不同于其他异常那样)。</li><li>这里我们写一个简单的例子还是上面的项目，我们在中间件中继续添加如下代码：</li></ul> 
<pre><code class="prism language-python"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">def</span> <span class="token function">process_response</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
    response<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">201</span>
    <span class="token keyword">return</span> response
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<h5><a id="_process_exceptionrequest_exception_spider_1054"></a>③ process_exception(request, exception, spider)</h5> 
<ul><li>当下载处理器(download handler)或 process_request() (下载中间件)抛出异常(包括 IgnoreRequest 异常)时，Scrapy调用 process_exception()。</li><li>process_exception() 也是返回三者中的一个: 返回 None 、 一个 Response 对象、或者一个 Request 对象。</li><li>如果其返回 None ，Scrapy将会继续处理该异常，接着调用已安装的其他中间件的 process_exception() 方法，直到所有中间件都被调用完毕，则调用默认的异常处理。</li><li>如果其返回一个 Response 对象，则已安装的中间件链的 process_response() 方法被调用。Scrapy将不会调用任何其他中间件的 process_exception() 方法。</li></ul> 
<h4><a id="53__1061"></a>5.3 实战案例：</h4> 
<ul><li>任务测试：使用scrapy爬取豆瓣图书Top250信息</li><li>网址：https://book.douban.com/top250?start=0</li><li>使用shell命令直接爬取报403错误</li></ul> 
<pre><code># 在命令行下直接运行scrapy shell命令爬取信息，报403错误

$ scrapy shell https://book.douban.com/top250 

&gt;&gt;&gt; response.status
&gt;&gt;&gt; 403
</code></pre> 
<ul><li>① 新建一个项目douban，命令如下所示：</li></ul> 
<pre><code>scrapy startproject douban
</code></pre> 
<ul><li>② 新建一个Spider类,名字为dbbook，命令如下所示：</li></ul> 
<pre><code>cd douban

scrapy genspider dbbook book.douban.com
</code></pre> 
<ul><li>编写爬虫代码。如下：</li></ul> 
<pre><code class="prism language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">import</span> scrapy

<span class="token keyword">class</span> <span class="token class-name">DbbookSpider</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">'dbbook'</span>
    allowed_domains <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'book.douban.com'</span><span class="token punctuation">]</span>
    start_urls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'https://book.douban.com/top250?start=0'</span><span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#print("状态：")</span>
        <span class="token keyword">pass</span>
</code></pre> 
<ul><li>③ 执行爬虫命令,排除错误。</li></ul> 
<p>$ <code>scrapy crawl dbbook</code> #结果返回403错误(服务器端拒绝访问)。</p> 
<p>原因分析：默认scrapy框架请求信息中的<code>User-Agent</code>的值为：<code>Scrapy/1.5.0(http://scrapy.org)</code>.</p> 
<p>解决方案：我们可以在settings.py配置文件中：设置 <code>USER_AGENT</code> 或者<code>DEFAULT_REQUEST_HEADERS</code>信息：</p> 
<pre><code class="prism language-python">USER_AGENT <span class="token operator">=</span> <span class="token string">'Opera/9.80(WindowsNT6.1;U;en)Presto/2.8.131Version/11.11'</span>

或者
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
DEFAULT_REQUEST_HEADERS <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
   <span class="token string">'Accept'</span><span class="token punctuation">:</span> <span class="token string">'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'</span><span class="token punctuation">,</span>
   <span class="token string">'Accept-Language'</span><span class="token punctuation">:</span> <span class="token string">'en'</span><span class="token punctuation">,</span>
   <span class="token string">'User-Agent'</span><span class="token punctuation">:</span><span class="token string">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.139 Safari/537.36'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<ul><li>④ 开启Downloader Middleware中间件</li><li>在项目的settings.py配置文件中：开启设置<code>DOWNLOADER_MIDDLEWARES</code>信息：</li></ul> 
<pre><code class="prism language-python">DOWNLOADER_MIDDLEWARES <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'douban.middlewares.DoubanDownloaderMiddleware'</span><span class="token punctuation">:</span> <span class="token number">543</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
  <span class="token keyword">def</span> <span class="token function">process_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#输出header头信息</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">)</span>
        <span class="token comment">#伪装浏览器用户</span>
        request<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'user-agent'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.139 Safari/537.36'</span>

        <span class="token keyword">return</span> <span class="token boolean">None</span>
</code></pre> 
<h3><a id="_1143"></a></h3> 
<h3><a id="6_Spider_Middleware_1145"></a>6. Spider Middleware的使用</h3> 
<ul><li>Spider中间件是介入到Scrapy的spider处理机制的钩子框架，您可以添加代码来处理发送给 Spiders 的response及spider产生的item和request。</li></ul> 
<h4><a id="61_spider_1149"></a>6.1 激活spider中间件</h4> 
<ul><li>要启用spider中间件，您可以将其加入到 SPIDER_MIDDLEWARES 设置中。 该设置是一个字典，键位中间件的路径，值为中间件的顺序(order)。</li><li>样例:</li></ul> 
<pre><code class="prism language-python">SPIDER_MIDDLEWARES <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'myproject.middlewares.CustomSpiderMiddleware'</span><span class="token punctuation">:</span> <span class="token number">543</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>SPIDER_MIDDLEWARES 设置会与Scrapy定义的 SPIDER_MIDDLEWARES_BASE 设置合并(但不是覆盖)， 而后根据顺序(order)进行排序，最后得到启用中间件的有序列表: 第一个中间件是最靠近引擎的，最后一个中间件是最靠近spider的。</li><li>关于如何分配中间件的顺序请查看 SPIDER_MIDDLEWARES_BASE 设置，而后根据您想要放置中间件的位置选择一个值。 由于每个中间件执行不同的动作，您的中间件可能会依赖于之前(或者之后)执行的中间件，因此顺序是很重要的。</li><li>如果您想禁止内置的(在 SPIDER_MIDDLEWARES_BASE 中设置并默认启用的)中间件， 您必须在项目的 SPIDER_MIDDLEWARES 设置中定义该中间件，并将其值赋为 None 。 例如，如果您想要关闭off-site中间件:</li></ul> 
<pre><code class="prism language-python">SPIDER_MIDDLEWARES <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'myproject.middlewares.CustomSpiderMiddleware'</span><span class="token punctuation">:</span> <span class="token number">543</span><span class="token punctuation">,</span>
    <span class="token string">'scrapy.contrib.spidermiddleware.offsite.OffsiteMiddleware'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>最后，请注意，有些中间件需要通过特定的设置来启用。更多内容请查看相关中间件文档。</li></ul> 
<h4><a id="62_spider_1173"></a>6.2 编写您自己的spider中间件</h4> 
<ul><li>编写spider中间件十分简单。每个中间件组件是一个定义了以下一个或多个方法的Python类:</li><li>来自类：class scrapy.contrib.spidermiddleware.SpiderMiddleware</li></ul> 
<h5><a id="process_spider_inputresponse_spider_1178"></a>process_spider_input(response, spider)</h5> 
<pre><code>当response通过spider中间件时，该方法被调用，处理该response。

`process_spider_input()` 应该返回 None 或者抛出一个异常。

如果其返回 None ，Scrapy将会继续处理该response，调用所有其他的中间件直到spider处理该response。

如果其跑出一个异常(exception)，Scrapy将不会调用任何其他中间件的 process_spider_input() 方法，并调用request的errback。 errback的输出将会以另一个方向被重新输入到中间件链中，使用 process_spider_output() 方法来处理，当其抛出异常时则带调用 process_spider_exception() 。

参数: 
response (Response 对象) – 被处理的response
spider (Spider 对象) – 该response对应的spider
</code></pre> 
<h5><a id="process_spider_outputresponse_result_spider_1194"></a>process_spider_output(response, result, spider)</h5> 
<pre><code>当Spider处理response返回result时，该方法被调用。

`process_spider_output()` 必须返回包含 Request 或 Item 对象的可迭代对象(iterable)。

参数: 
response (Response 对象) – 生成该输出的response
result (包含 Request 或 Item 对象的可迭代对象(iterable)) – spider返回的result
spider (Spider 对象) – 其结果被处理的spider
</code></pre> 
<h5><a id="process_spider_exceptionresponse_exception_spider_1207"></a>process_spider_exception(response, exception, spider)</h5> 
<pre><code>当spider或(其他spider中间件的) process_spider_input() 跑出异常时， 该方法被调用。

`process_spider_exception()` 必须要么返回 None ， 要么返回一个包含 Response 或 Item 对象的可迭代对象(iterable)。

如果其返回 None ，Scrapy将继续处理该异常，调用中间件链中的其他中间件的 process_spider_exception() 方法，直到所有中间件都被调用，该异常到达引擎(异常将被记录并被忽略)。

如果其返回一个可迭代对象，则中间件链的 process_spider_output() 方法被调用， 其他的 process_spider_exception() 将不会被调用。

参数: 
response (Response 对象) – 异常被抛出时被处理的response
exception (Exception 对象) – 被跑出的异常
spider (Spider 对象) – 抛出该异常的spider
</code></pre> 
<h5><a id="process_start_requestsstart_requests_spider_1224"></a>process_start_requests(start_requests, spider)</h5> 
<pre><code>0.15 新版功能.

该方法以spider 启动的request为参数被调用，执行的过程类似于 process_spider_output() ，只不过其没有相关联的response并且必须返回request(不是item)。

其接受一个可迭代的对象(start_requests 参数)且必须返回另一个包含 Request 对象的可迭代对象。

注解

当在您的spider中间件实现该方法时， 您必须返回一个可迭代对象(类似于参数start_requests)且不要遍历所有的 start_requests。 该迭代器会很大(甚至是无限)，进而导致内存溢出。 Scrapy引擎在其具有能力处理start request时将会拉起request， 因此start request迭代器会变得无限，而由其他参数来停止spider( 例如时间限制或者item/page记数)。

参数: 
start_requests (包含 Request 的可迭代对象) – start requests
spider (Spider 对象) – start requests所属的spider
</code></pre> 
<h4><a id="ScrapySettings_1242"></a>Scrapy框架的配置Settings</h4> 
<ul><li>Scrapy设置(settings)提供了定制Scrapy组件的方法。可以控制包括核心(core)，插件(extension)，pipeline及spider组件。</li><li>参考文档：http://scrapy-chs.readthedocs.io/zh_CN/1.0/topics/settings.html#topics-settings-ref</li></ul> 
<h5><a id="_1247"></a>内置设置参考手册</h5> 
<ul><li> <p><code>BOT_NAME</code></p> 
  <ul><li>默认: ‘scrapybot’</li><li>当您使用 startproject 命令创建项目时其也被自动赋值。</li></ul> </li><li> <p><code>CONCURRENT_ITEMS</code></p> 
  <ul><li>默认: 100</li><li>Item Processor(即 Item Pipeline) 同时处理(每个response的)item的最大值。</li></ul> </li><li> <p><code>CONCURRENT_REQUESTS</code></p> 
  <ul><li>默认: 16</li><li>Scrapy downloader 并发请求(concurrent requests)的最大值。</li></ul> </li><li> <p><code>DEFAULT_REQUEST_HEADERS</code></p> 
  <ul><li> <p>默认: 如下</p> <pre><code>{
  'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
  'Accept-Language': 'en',
}
</code></pre> </li><li> <p>Scrapy HTTP Request使用的默认header。</p> </li></ul> </li><li> <p><code>DEPTH_LIMIT</code></p> 
  <ul><li>默认: 0</li><li>爬取网站最大允许的深度(depth)值。如果为0，则没有限制。</li></ul> </li><li> <p><code>DOWNLOAD_DELAY</code></p> 
  <ul><li>默认: 0</li><li>下载器在下载同一个网站下一个页面前需要等待的时间。该选项可以用来限制爬取速度， 减轻服务器压力。同时也支持小数:</li></ul> </li><li> <p><code>DOWNLOAD_DELAY = 0.25 # 250 ms of delay</code></p> 
  <ul><li>默认情况下，Scrapy在两个请求间不等待一个固定的值， 而是使用0.5到1.5之间的一个随机值 * DOWNLOAD_DELAY 的结果作为等待间隔。</li></ul> </li><li> <p><code>DOWNLOAD_TIMEOUT</code></p> 
  <ul><li>默认: 180</li><li>下载器超时时间(单位: 秒)。</li></ul> </li><li> <p><code>ITEM_PIPELINES</code></p> 
  <ul><li> <p>默认: {}</p> </li><li> <p>保存项目中启用的pipeline及其顺序的字典。该字典默认为空，值(value)任意，不过值(value)习惯设置在0-1000范围内，值越小优先级越高。</p> <pre><code>ITEM_PIPELINES = {
'mySpider.pipelines.SomethingPipeline': 300,
'mySpider.pipelines.ItcastJsonPipeline': 800,
}
</code></pre> </li></ul> </li><li> <p><code>LOG_ENABLED</code></p> 
  <ul><li>默认: True</li><li>是否启用logging。</li></ul> </li><li> <p><code>LOG_ENCODING</code></p> 
  <ul><li>默认: ‘utf-8’</li><li>logging使用的编码。</li></ul> </li><li> <p><code>LOG_LEVEL</code></p> 
  <ul><li>默认: ‘DEBUG’</li><li>log的最低级别。可选的级别有: CRITICAL、 ERROR、WARNING、INFO、DEBUG 。</li></ul> </li><li> <p><code>USER_AGENT</code></p> 
  <ul><li>默认: “Scrapy/VERSION (+<a href="http://scrapy.org/" rel="nofollow">http://scrapy.org</a>)”</li><li>爬取的默认User-Agent，除非被覆盖。</li></ul> </li><li> <p><code>PROXIES：</code> 代理设置</p> 
  <ul><li> <p>示例：</p> <pre><code>PROXIES = [
{'ip_port': '111.11.228.75:80', 'password': ''},
{'ip_port': '120.198.243.22:80', 'password': ''},
{'ip_port': '111.8.60.9:8123', 'password': ''},
{'ip_port': '101.71.27.120:80', 'password': ''},
{'ip_port': '122.96.59.104:80', 'password': ''},
{'ip_port': '122.224.249.122:8088', 'password':''},
]
</code></pre> </li></ul> </li><li> <p><code>COOKIES_ENABLED = False</code></p> 
  <ul><li>禁用Cookies</li></ul> </li></ul> 
<h3><a id="7_ItemPipeline_1348"></a>7. ItemPipeline的使用</h3> 
<ul><li>当Item在Spider中被收集之后，它将会被传递到Item Pipeline，一些组件会按照一定的顺序执行对Item的处理。</li><li>每个item pipeline组件(有时称之为“Item Pipeline”)是实现了简单方法的Python类。他们接收到Item并通过它执行一些行为，同时也决定此Item是否继续通过pipeline，或是被丢弃而不再进行处理。</li><li>以下是item pipeline的一些典型应用： 
  <ul><li>清理HTML数据</li><li>验证爬取的数据(检查item包含某些字段)</li><li>查重(并丢弃)</li><li>将爬取结果保存到数据库中</li></ul> </li></ul> 
<h4><a id="71_item_pipeline_1358"></a>7.1 如何编写你自己的item pipeline</h4> 
<ul><li>编写你自己的item pipeline很简单，每个item pipiline组件是一个独立的Python类，同时必须实现以下方法:</li></ul> 
<h5><a id="_process_itemitem_spider_1362"></a>① <code>process_item(item, spider)</code></h5> 
<ul><li>每个item pipeline组件都需要调用该方法，这个方法必须返回一个 Item (或任何继承类)对象， 或是抛出 DropItem 异常，被丢弃的item将不会被之后的pipeline组件所处理。</li><li>参数: 
  <ul><li>item (Item 对象) – 被爬取的item</li><li>spider (Spider 对象) – 爬取该item的spider</li></ul> </li><li>此外,他们也可以实现以下方法:</li></ul> 
<h5><a id="_open_spiderspider_1370"></a>② <code>open_spider(spider)</code></h5> 
<ul><li>当spider被开启时，这个方法被调用。</li><li>参数: spider (Spider 对象) – 被开启的spider</li></ul> 
<h5><a id="_close_spiderspider_1375"></a>③ <code>close_spider(spider)</code></h5> 
<ul><li>当spider被关闭时，这个方法被调用</li><li>参数: spider (Spider 对象) – 被关闭的spider</li></ul> 
<h4><a id="72__1380"></a>7.2 样例：</h4> 
<h5><a id="item_1382"></a>验证价格，同时丢弃没有价格的item</h5> 
<ul><li>让我们来看一下以下这个假设的pipeline，它为那些不含税(price_excludes_vat 属性)的item调整了 price 属性，同时丢弃了那些没有价格的item:</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">from</span> scrapy<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> DropItem

<span class="token keyword">class</span> <span class="token class-name">PricePipeline</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    vat_factor <span class="token operator">=</span> <span class="token number">1.15</span>

    <span class="token keyword">def</span> <span class="token function">process_item</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> item<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> item<span class="token punctuation">[</span><span class="token string">'price'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> item<span class="token punctuation">[</span><span class="token string">'price_excludes_vat'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                item<span class="token punctuation">[</span><span class="token string">'price'</span><span class="token punctuation">]</span> <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token string">'price'</span><span class="token punctuation">]</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>vat_factor
            <span class="token keyword">return</span> item
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> DropItem<span class="token punctuation">(</span><span class="token string">"Missing price in %s"</span> <span class="token operator">%</span> item<span class="token punctuation">)</span>
</code></pre> 
<h5><a id="itemJSON_1402"></a>将item写入JSON文件：</h5> 
<ul><li>以下pipeline将所有(从所有spider中)爬取到的item，存储到一个独立地 items.jl 文件，每行包含一个序列化为JSON格式的item:</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">import</span> json

<span class="token keyword">class</span> <span class="token class-name">JsonWriterPipeline</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span><span class="token builtin">file</span> <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'items.jl'</span><span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">process_item</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> item<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        line <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\n"</span>
        self<span class="token punctuation">.</span><span class="token builtin">file</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span>line<span class="token punctuation">)</span>
        <span class="token keyword">return</span> item
</code></pre> 
<ul><li>注解:JsonWriterPipeline的目的只是为了介绍怎样编写item pipeline，如果你想要将所有爬取的item都保存到同一个JSON文件， 你需要使用 Feed exports 。</li></ul> 
<h5><a id="_1422"></a>去重</h5> 
<ul><li>一个用于去重的过滤器，丢弃那些已经被处理过的item。让我们假设我们的item有一个唯一的id，但是我们spider返回的多个item中包含有相同的id:</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">from</span> scrapy<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> DropItem

<span class="token keyword">class</span> <span class="token class-name">DuplicatesPipeline</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>ids_seen <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">process_item</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> item<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> item<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>ids_seen<span class="token punctuation">:</span>
            <span class="token keyword">raise</span> DropItem<span class="token punctuation">(</span><span class="token string">"Duplicate item found: %s"</span> <span class="token operator">%</span> item<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>ids_seen<span class="token punctuation">.</span>add<span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> item
</code></pre> 
<h5><a id="Item_Pipeline_1442"></a>启用一个Item Pipeline组件:</h5> 
<ul><li>为了启用一个Item Pipeline组件，你必须将它的类添加到 ITEM_PIPELINES 配置，就像下面这个例子:</li></ul> 
<pre><code class="prism language-python">ITEM_PIPELINES <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'myproject.pipelines.PricePipeline'</span><span class="token punctuation">:</span> <span class="token number">300</span><span class="token punctuation">,</span>
    <span class="token string">'myproject.pipelines.JsonWriterPipeline'</span><span class="token punctuation">:</span> <span class="token number">800</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>分配给每个类的整型值，确定了他们运行的顺序，item按数字从低到高的顺序，通过pipeline，通常将这些数字定义在0-1000范围内。</li></ul> 
<h4><a id="73_Scrapy_1455"></a>7.3 Scrapy框架案例实战：</h4> 
<ul><li>任务：爬取csdn学院中的课程信息（编程语言的）</li><li>网址：<code>https://edu.csdn.net/courses/o280/p1</code> （第一页）</li><li><code>https://edu.csdn.net/courses/o280/p2</code> （第二页）</li></ul> 
<h5><a id="__1461"></a>① 创建项目</h5> 
<ul><li>在命令行编写下面命令，创建项目demo</li></ul> 
<pre><code>scrapy startproject  educsdn
</code></pre> 
<ul><li>项目目录结构：</li></ul> 
<pre><code>educsdn
├── educsdn
│   ├── __init__.py
│   ├── __pycache__
│   ├── items.py        # Items的定义，定义抓取的数据结构
│   ├── middlewares.py  # 定义Spider和DownLoader的Middlewares中间件实现。 
│   ├── pipelines.py    # 它定义Item Pipeline的实现，即定义数据管道
│   ├── settings.py     # 它定义项目的全局配置
│   └── spiders         # 其中包含一个个Spider的实现，每个Spider都有一个文件
│       ├── __init__.py
│       └── __pycache__
└── scrapy.cfg    #Scrapy部署时的配置文件，定义了配置文件路径、部署相关信息等内容
</code></pre> 
<h5><a id="_educsdnspidercourses_1486"></a>② 进入educsdn项目目录，创建爬虫spider类文件（courses课程）</h5> 
<ul><li>执行genspider命令，第一个参数是Spider的名称，第二个参数是网站域名。</li></ul> 
<pre><code>scrapy genspider courses edu.csdn.net

$ tree 

├── demo
│   ├── __init__.py
│   ├── __pycache__
│   │   ├── __init__.cpython-36.pyc
│   │   └── settings.cpython-36.pyc
│   ├── items.py
│   ├── middlewares.py
│   ├── pipelines.py
│   ├── settings.py
│   └── spiders
│       ├── __init__.py
│       ├── __pycache__
│       │   └── __init__.cpython-36.pyc
│       └── courses.py  #在spiders目录下有了一个爬虫类文件courses.py
└── scrapy.cfg


# courses.py的文件代码如下：

# -*- coding: utf-8 -*-
import scrapy

class CoursesSpider(scrapy.Spider):
    name = 'courses'
    allowed_domains = ['edu.csdn.net']
    start_urls = ['http://edu.csdn.net/']

    def parse(self, response):
        pass
</code></pre> 
<h5><a id="_Item_1526"></a>③ 创建Item</h5> 
<ul><li>Item是保存爬取数据的容器，它的使用方法和字典类型，但相比字典多了些保护机制。</li><li>创建Item需要继承scrapy.Item类，并且定义类型为scrapy.Field的字段：（课程标题、课程地址、图片、授课老师，视频时长、价格）</li><li>具体代码如下：（修改类名为CoursesItem）</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">import</span> scrapy

<span class="token keyword">class</span> <span class="token class-name">CoursesItem</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Item<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># define the fields for your item here like:</span>
    <span class="token comment"># name = scrapy.Field()</span>
    title <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    url <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    pic <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    teacher <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    time <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    price <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">#pass</span>
</code></pre> 
<h5><a id="_Response_1547"></a>④ 解析Response</h5> 
<ul><li>在fang.py文件中，parse()方法的参数response是start_urls里面的链接爬取后的结果。</li><li>提取的方式可以是CSS选择器、XPath选择器或者是re正则表达式。</li></ul> 
<pre><code class="prism language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">import</span> scrapy
<span class="token keyword">from</span> educsdn<span class="token punctuation">.</span>items <span class="token keyword">import</span> CoursesItem

<span class="token keyword">class</span> <span class="token class-name">CoursesSpider</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">'courses'</span>
    allowed_domains <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'edu.csdn.net'</span><span class="token punctuation">]</span>
    start_urls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'https://edu.csdn.net/courses/o280/p1'</span><span class="token punctuation">]</span>
    p<span class="token operator">=</span><span class="token number">1</span>
    <span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#解析并输出课程标题</span>
        <span class="token comment">#print(response.selector.css("div.course_dl_list span.title::text").extract())</span>
        <span class="token comment">#获取所有课程</span>
        dlist <span class="token operator">=</span> response<span class="token punctuation">.</span>selector<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">"div.course_dl_list"</span><span class="token punctuation">)</span>
        <span class="token comment">#遍历课程，并解析信息后封装到item容器中</span>
        <span class="token keyword">for</span> dd <span class="token keyword">in</span> dlist<span class="token punctuation">:</span>
            item <span class="token operator">=</span> CoursesItem<span class="token punctuation">(</span><span class="token punctuation">)</span>
            item<span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span> <span class="token operator">=</span> dd<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">"span.title::text"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span>
            item<span class="token punctuation">[</span><span class="token string">'url'</span><span class="token punctuation">]</span> <span class="token operator">=</span> dd<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">"a::attr(href)"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span>
            item<span class="token punctuation">[</span><span class="token string">'pic'</span><span class="token punctuation">]</span> <span class="token operator">=</span> dd<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">"img::attr(src)"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span>
            item<span class="token punctuation">[</span><span class="token string">'teacher'</span><span class="token punctuation">]</span> <span class="token operator">=</span> dd<span class="token punctuation">.</span>re_first<span class="token punctuation">(</span><span class="token string">"&lt;p&gt;讲师：(.*?)&lt;/p&gt;"</span><span class="token punctuation">)</span>
            item<span class="token punctuation">[</span><span class="token string">'time'</span><span class="token punctuation">]</span> <span class="token operator">=</span> dd<span class="token punctuation">.</span>re_first<span class="token punctuation">(</span><span class="token string">"&lt;em&gt;([0-9]+)&lt;/em&gt;课时"</span><span class="token punctuation">)</span>
            item<span class="token punctuation">[</span><span class="token string">'price'</span><span class="token punctuation">]</span> <span class="token operator">=</span> dd<span class="token punctuation">.</span>re_first<span class="token punctuation">(</span><span class="token string">"￥([0-9\.]+)"</span><span class="token punctuation">)</span>
            <span class="token comment">#print(item)</span>
            <span class="token comment">#print("="*70)</span>
            <span class="token keyword">yield</span> item

        <span class="token comment">#获取前10页的课程信息 </span>
        self<span class="token punctuation">.</span>p <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>p <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">:</span>
            next_url <span class="token operator">=</span> <span class="token string">'https://edu.csdn.net/courses/o280/p'</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>p<span class="token punctuation">)</span>
            url <span class="token operator">=</span> response<span class="token punctuation">.</span>urljoin<span class="token punctuation">(</span>next_url<span class="token punctuation">)</span> <span class="token comment">#构建绝对url地址（这里可省略）</span>
            <span class="token keyword">yield</span> scrapy<span class="token punctuation">.</span>Request<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span>callback<span class="token operator">=</span>self<span class="token punctuation">.</span>parse<span class="token punctuation">)</span>
</code></pre> 
<h5><a id="_1588"></a>⑤、创建数据库和表：</h5> 
<ul><li>在mysql中创建数据库<code>csdndb</code>和数据表<code>courses</code></li></ul> 
<pre><code class="prism language-mysql">CREATE TABLE `courses` (                          
   `id` int(10) unsigned NOT NULL AUTO_INCREMENT,  
   `title` varchar(255) DEFAULT NULL,              
   `url` varchar(255) DEFAULT NULL,                
   `pic` varchar(255) DEFAULT NULL,                
   `teacher` varchar(32) DEFAULT NULL,             
   `time` varchar(16) DEFAULT NULL,                
   `price` varchar(16) DEFAULT NULL,               
   PRIMARY KEY (`id`)                              
 ) ENGINE=InnoDB DEFAULT CHARSET=utf8
</code></pre> 
<h5><a id="Item_Pipeline_1605"></a>⑥、使用Item Pipeline</h5> 
<ul><li>Item Pipeline为项目管道，当Item生产后，他会自动被送到Item Pipeline进行处理：</li><li>我们常用Item Pipeline来做如下操作： 
  <ul><li>清理HTML数据</li><li>验证抓取数据，检查抓取字段</li><li>查重并丢弃重复内容</li><li>将爬取结果保存到数据库里。</li></ul> </li></ul> 
<pre><code class="prism language-python"><span class="token keyword">import</span> pymysql
<span class="token keyword">from</span> scrapy<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> DropItem

<span class="token keyword">class</span> <span class="token class-name">EducsdnPipeline</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">process_item</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> item<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> item<span class="token punctuation">[</span><span class="token string">'price'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> DropItem<span class="token punctuation">(</span><span class="token string">"Drop item found: %s"</span> <span class="token operator">%</span> item<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> item


<span class="token keyword">class</span> <span class="token class-name">MysqlPipeline</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>host<span class="token punctuation">,</span>database<span class="token punctuation">,</span>user<span class="token punctuation">,</span>password<span class="token punctuation">,</span>port<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>host <span class="token operator">=</span> host
        self<span class="token punctuation">.</span>database <span class="token operator">=</span> database
        self<span class="token punctuation">.</span>user <span class="token operator">=</span> user
        self<span class="token punctuation">.</span>password <span class="token operator">=</span> password
        self<span class="token punctuation">.</span>port <span class="token operator">=</span> port
        self<span class="token punctuation">.</span>db<span class="token operator">=</span><span class="token boolean">None</span>
        self<span class="token punctuation">.</span>cursor<span class="token operator">=</span><span class="token boolean">None</span>

    @<span class="token builtin">classmethod</span>
    <span class="token keyword">def</span> <span class="token function">from_crawler</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span>crawler<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> cls<span class="token punctuation">(</span>
            host <span class="token operator">=</span> crawler<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"MYSQL_HOST"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            database <span class="token operator">=</span> crawler<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"MYSQL_DATABASE"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            user <span class="token operator">=</span> crawler<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"MYSQL_USER"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            password <span class="token operator">=</span> crawler<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"MYSQL_PASS"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            port <span class="token operator">=</span> crawler<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"MYSQL_PORT"</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">open_spider</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>db <span class="token operator">=</span> pymysql<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>self<span class="token punctuation">.</span>host<span class="token punctuation">,</span>self<span class="token punctuation">.</span>user<span class="token punctuation">,</span>self<span class="token punctuation">.</span>password<span class="token punctuation">,</span>self<span class="token punctuation">.</span>database<span class="token punctuation">,</span>charset<span class="token operator">=</span><span class="token string">'utf8'</span><span class="token punctuation">,</span>port<span class="token operator">=</span>self<span class="token punctuation">.</span>port<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cursor <span class="token operator">=</span> self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">process_item</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> item<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        sql <span class="token operator">=</span> <span class="token string">"insert into courses(title,url,pic,teacher,time,price) values('%s','%s','%s','%s','%s','%s')"</span><span class="token operator">%</span><span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>item<span class="token punctuation">[</span><span class="token string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>item<span class="token punctuation">[</span><span class="token string">'pic'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>item<span class="token punctuation">[</span><span class="token string">'teacher'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token string">'time'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token string">'price'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">#print(item)</span>
        self<span class="token punctuation">.</span>cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> item

    <span class="token keyword">def</span> <span class="token function">close_spider</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="__1661"></a>⑦ 修改配置文件</h5> 
<ul><li>打开配置文件：settings.py 开启并配置ITEM_PIPELINES信息，配置数据库连接信息</li></ul> 
<pre><code class="prism language-python">ITEM_PIPELINES <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'educsdn.pipelines.EducsdnPipeline'</span><span class="token punctuation">:</span> <span class="token number">300</span><span class="token punctuation">,</span>
    <span class="token string">'educsdn.pipelines.MysqlPipeline'</span><span class="token punctuation">:</span> <span class="token number">301</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
MYSQL_HOST <span class="token operator">=</span> <span class="token string">'localhost'</span>
MYSQL_DATABASE <span class="token operator">=</span> <span class="token string">'csdndb'</span>
MYSQL_USER <span class="token operator">=</span> <span class="token string">'root'</span>
MYSQL_PASS <span class="token operator">=</span> <span class="token string">''</span>
MYSQL_PORT <span class="token operator">=</span> <span class="token number">3306</span>
</code></pre> 
<h5><a id="_1677"></a>⑧、运行爬取：</h5> 
<ul><li> <p>执行如下命令来启用数据爬取</p> <pre><code>scrapy crawl courses
</code></pre> </li></ul> 
<p>7.4 下载和处理文件和图像:</p> 
<h5><a id="_ImagesPipeline_1687"></a>① ImagesPipeline介绍</h5> 
<ul><li>Scrapy提供了专门处理下载的Pipeline，包含文件下载和图片下载，其原理与抓取页面的原理一样。</li><li>下载过程支持异步和多线程，下载十分高效。</li><li>网址：https://docs.scrapy.org/en/latest/topics/media-pipeline.html</li><li>实现方式：定义一个<code>ItemPipeline</code> 类继承 <code>scrapy.pipelines.images.ImagesPipeline</code>。</li></ul> 
<h5><a id="__1694"></a>② 具体使用：</h5> 
<ul><li>首先定义存储文件的路径，在settings.py配置文件中添加代码：<code>IMAGES_STORE = './images'</code></li><li>并在项目目录下创建 <code>images</code> 文件夹 （与scrapy.cfg文件同级）。</li><li>要在pipelines.py文件中定义一个‘ImagePipeline’类，其代码如下：</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">from</span> scrapy <span class="token keyword">import</span> Request
<span class="token keyword">from</span> scrapy<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> DropItem
<span class="token keyword">from</span> scrapy<span class="token punctuation">.</span>pipelines<span class="token punctuation">.</span>images <span class="token keyword">import</span> ImagesPipeline

<span class="token keyword">class</span> <span class="token class-name">ImagePipeline</span><span class="token punctuation">(</span>ImagesPipeline<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''自定义图片存储类'''</span>

    <span class="token keyword">def</span> <span class="token function">get_media_requests</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> item<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''通过抓取的item对象获取图片信息，并创建Request请求对象添加调度队列，等待调度执行下载'''</span>
        <span class="token keyword">yield</span> Request<span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token string">'pic'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">file_path</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>request<span class="token punctuation">,</span>response<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>info<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''返回图片下载后保存的名称，没有此方法Scrapy则自动给一个唯一值作为图片名称'''</span>
        url <span class="token operator">=</span> request<span class="token punctuation">.</span>url
        file_name <span class="token operator">=</span> url<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> file_name

    <span class="token keyword">def</span> <span class="token function">item_completed</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> results<span class="token punctuation">,</span> item<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">''' 下载完成后的处理方法，其中results内容结构如下说明'''</span>
        image_paths <span class="token operator">=</span> <span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token string">'path'</span><span class="token punctuation">]</span> <span class="token keyword">for</span> ok<span class="token punctuation">,</span> x <span class="token keyword">in</span> results <span class="token keyword">if</span> ok<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token operator">not</span> image_paths<span class="token punctuation">:</span>
            <span class="token keyword">raise</span> DropItem<span class="token punctuation">(</span><span class="token string">"Item contains no images"</span><span class="token punctuation">)</span>
        <span class="token comment">#item['image_paths'] = image_paths</span>
        <span class="token keyword">return</span> item
</code></pre> 
<ul><li> <p>在item_completed()方法中，results参数内容结构如下：</p> <pre><code>  print(results)
  [(True, {'url': 'https://img-bss.csdn.net/201803191642534078.png', 
           'path': '201803191642534078.png', 
           'checksum': 'cc1368dbc122b6762f3e26ccef0dd105'}
  )]
</code></pre> </li><li> <p>在settings.py文件中配置如下（启用下载）：</p> </li></ul> 
<pre><code class="prism language-python"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
ITEM_PIPELINES <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'educsdn.pipelines.EducsdnPipeline'</span><span class="token punctuation">:</span> <span class="token number">300</span><span class="token punctuation">,</span>
    <span class="token string">'educsdn.pipelines.ImagePipeline'</span><span class="token punctuation">:</span> <span class="token number">301</span><span class="token punctuation">,</span>
    <span class="token string">'educsdn.pipelines.MysqlPipeline'</span><span class="token punctuation">:</span> <span class="token number">302</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
MYSQL_HOST <span class="token operator">=</span> <span class="token string">"localhost"</span>
MYSQL_DATABASE <span class="token operator">=</span> <span class="token string">"csdndb"</span>
MYSQL_USER <span class="token operator">=</span> <span class="token string">"root"</span>
MYSQL_PASS <span class="token operator">=</span> <span class="token string">""</span>
MYSQL_PORT <span class="token operator">=</span> <span class="token number">3306</span>

IMAGES_STORE <span class="token operator">=</span> <span class="token string">"./images"</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<h3><a id="8_Scrapy_1756"></a>8. Scrapy爬虫案例实战</h3> 
<ul><li>任务：爬取腾讯网中关于指定条件的所有<code>社会招聘</code>信息，搜索条件为<code>北京</code>地区，<code>Python</code>关键字的就业岗位,并将信息存储到MySql数据库中。</li><li>网址：https://hr.tencent.com/position.php?keywords=python&amp;lid=2156</li><li>实现思路：首先爬取每页的招聘信息列表，再爬取对应的招聘详情信息</li></ul> 
<h5><a id="__1762"></a>① 创建项目</h5> 
<ul><li>在命令行编写下面命令，创建项目tencent</li></ul> 
<pre><code>scrapy startproject  tencent
</code></pre> 
<ul><li>项目目录结构：</li></ul> 
<pre><code>tencent
├── tencent
│   ├── __init__.py
│   ├── __pycache__
│   ├── items.py        # Items的定义，定义抓取的数据结构
│   ├── middlewares.py  # 定义Spider和DownLoader的Middlewares中间件实现。 
│   ├── pipelines.py    # 它定义Item Pipeline的实现，即定义数据管道
│   ├── settings.py     # 它定义项目的全局配置
│   └── spiders         # 其中包含一个个Spider的实现，每个Spider都有一个文件
│       ├── __init__.py
│       └── __pycache__
└── scrapy.cfg    #Scrapy部署时的配置文件，定义了配置文件路径、部署相关信息等内容
</code></pre> 
<h5><a id="_tencentspiderhr_1787"></a>② 进入tencent项目目录，创建爬虫spider类文件（hr招聘信息）</h5> 
<ul><li>执行genspider命令，第一个参数是Spider的名称，第二个参数是网站域名。</li></ul> 
<pre><code>scrapy genspider hr hr.tencent.com

$ tree 

├── tencent
│   ├── __init__.py
│   ├── __pycache__
│   │   ├── __init__.cpython-36.pyc
│   │   └── settings.cpython-36.pyc
│   ├── items.py
│   ├── middlewares.py
│   ├── pipelines.py
│   ├── settings.py
│   └── spiders
│       ├── __init__.py
│       ├── __pycache__
│       │   └── __init__.cpython-36.pyc
│       └── hr.py  #在spiders目录下有了一个爬虫类文件hr.py
└── scrapy.cfg


# hr.py的文件代码如下：

# -*- coding: utf-8 -*-
import scrapy

class HrSpider(scrapy.Spider):
    name = 'hr' 
    allowed_domains = ['hr.tencent.com']
    start_urls = ['https://hr.tencent.com/position.php?keywords=python&amp;lid=2156']

    def parse(self, response):
        #解析当前招聘列表信息的url地址：
        detail_urls = response.css('tr.even a::attr(href),tr.odd a::attr(href)').extract()
        #遍历url地址
        for url in detail_urls:
            #fullurl = 'http://hr.tencent.com/' + url
            #构建绝对的url地址，效果同上（域名加相对地址）
            fullurl = response.urljoin(url) 
            print(fullurl)
</code></pre> 
<ul><li>测试一下获取第一页的招聘详情url地址信息</li></ul> 
<h5><a id="_Item_1836"></a>③ 创建Item</h5> 
<ul><li>Item是保存爬取数据的容器，它的使用方法和字典类型，但相比字典多了些保护机制。</li><li>创建Item需要继承scrapy.Item类，并且定义类型为scrapy.Field的字段： 
  <ul><li>职位id号，名称、位置、类别、要求、人数、工作职责、工作要求</li></ul> </li><li>具体代码如下：（创建一个类名为HrItem）</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">import</span> scrapy

<span class="token keyword">class</span> <span class="token class-name">TencentItem</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Item<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># define the fields for your item here like:</span>
    <span class="token comment"># name = scrapy.Field()</span>
    <span class="token keyword">pass</span>

<span class="token keyword">class</span> <span class="token class-name">HrItem</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Item<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''
       人事招聘信息封装类
       （职位id号，名称、位置、类别、要求、人数、职责和要求）
    '''</span>
    table <span class="token operator">=</span> <span class="token string">"hr"</span>  <span class="token comment">#表名</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span> 
    title <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    location <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token builtin">type</span> <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    number <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    duty <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    requirement <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="_Response_1866"></a>④ 解析Response</h5> 
<ul><li>在hr.py文件中，parse()方法的参数response是start_urls里面的链接爬取后的结果。</li><li>提取的方式可以是CSS选择器、XPath选择器或者是re正则表达式。</li></ul> 
<pre><code class="prism language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">import</span> scrapy
<span class="token keyword">from</span> tencent<span class="token punctuation">.</span>items <span class="token keyword">import</span> HrItem

<span class="token keyword">class</span> <span class="token class-name">HrSpider</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">'hr'</span>
    allowed_domains <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'hr.tencent.com'</span><span class="token punctuation">]</span>
    start_urls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'https://hr.tencent.com/position.php?keywords=python&amp;lid=2156'</span><span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#解析当前招聘列表信息的url地址：</span>
        detail_urls <span class="token operator">=</span> response<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">'tr.even a::attr(href),tr.odd a::attr(href)'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">#遍历url地址</span>
        <span class="token keyword">for</span> url <span class="token keyword">in</span> detail_urls<span class="token punctuation">:</span>
            <span class="token comment">#fullurl = 'http://hr.tencent.com/' + url</span>
            <span class="token comment">#构建绝对的url地址，效果同上（域名加相对地址）</span>
            fullurl <span class="token operator">=</span> response<span class="token punctuation">.</span>urljoin<span class="token punctuation">(</span>url<span class="token punctuation">)</span> 
            <span class="token comment">#print(fullurl)</span>
            <span class="token comment"># 构造请求准备爬取招聘详情信息，并指定由parse_page()方法解析回调函数</span>
            <span class="token keyword">yield</span> scrapy<span class="token punctuation">.</span>Request<span class="token punctuation">(</span>url<span class="token operator">=</span>fullurl<span class="token punctuation">,</span>callback<span class="token operator">=</span>self<span class="token punctuation">.</span>parse_page<span class="token punctuation">)</span>

        <span class="token comment">#获取下一页的url地址</span>
        next_url <span class="token operator">=</span> response<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">"#next::attr(href)"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">#判断若不是最后一页</span>
        <span class="token keyword">if</span> next_url <span class="token operator">!=</span> <span class="token string">"javascript:;"</span><span class="token punctuation">:</span>
            url <span class="token operator">=</span> response<span class="token punctuation">.</span>urljoin<span class="token punctuation">(</span>next_url<span class="token punctuation">)</span>
            <span class="token comment">#构造下一页招聘列表信息的爬取</span>
            <span class="token keyword">yield</span> scrapy<span class="token punctuation">.</span>Request<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span>callback<span class="token operator">=</span>self<span class="token punctuation">.</span>parse<span class="token punctuation">)</span>

    <span class="token comment"># 解析详情页</span>
    <span class="token keyword">def</span> <span class="token function">parse_page</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#构造招聘信息的Item容器对象</span>
        item <span class="token operator">=</span> HrItem<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 解析id号信息，并封装到Item中</span>
        item<span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">]</span> <span class="token operator">=</span> response<span class="token punctuation">.</span>selector<span class="token punctuation">.</span>re_first<span class="token punctuation">(</span><span class="token string">'οnclick="applyPosition\(([0-9]+)\);"'</span><span class="token punctuation">)</span>
        <span class="token comment">#标题</span>
        item<span class="token punctuation">[</span><span class="token string">"title"</span><span class="token punctuation">]</span> <span class="token operator">=</span> response<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">'#sharetitle::text'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">#位置</span>
        item<span class="token punctuation">[</span><span class="token string">"location"</span><span class="token punctuation">]</span> <span class="token operator">=</span> response<span class="token punctuation">.</span>selector<span class="token punctuation">.</span>re_first<span class="token punctuation">(</span><span class="token string">'&lt;span class="lightblue l2"&gt;工作地点：&lt;/span&gt;(.*?)&lt;/td&gt;'</span><span class="token punctuation">)</span>
        <span class="token comment">#类别</span>
        item<span class="token punctuation">[</span><span class="token string">"type"</span><span class="token punctuation">]</span> <span class="token operator">=</span> response<span class="token punctuation">.</span>selector<span class="token punctuation">.</span>re_first<span class="token punctuation">(</span><span class="token string">'&lt;span class="lightblue"&gt;职位类别：&lt;/span&gt;(.*?)&lt;/td&gt;'</span><span class="token punctuation">)</span>
        <span class="token comment">#人数</span>
        item<span class="token punctuation">[</span><span class="token string">"number"</span><span class="token punctuation">]</span> <span class="token operator">=</span> response<span class="token punctuation">.</span>selector<span class="token punctuation">.</span>re_first<span class="token punctuation">(</span><span class="token string">'&lt;span class="lightblue"&gt;招聘人数：&lt;/span&gt;([0-9]+)人&lt;/td&gt;'</span><span class="token punctuation">)</span>
        <span class="token comment">#工作职责</span>
        duty <span class="token operator">=</span> response<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//table//tr[3]//li/text()'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract<span class="token punctuation">(</span><span class="token punctuation">)</span>
        item<span class="token punctuation">[</span><span class="token string">"duty"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>duty<span class="token punctuation">)</span>
        <span class="token comment">#工作要求</span>
        requirement <span class="token operator">=</span> response<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//table//tr[4]//li/text()'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract<span class="token punctuation">(</span><span class="token punctuation">)</span>
        item<span class="token punctuation">[</span><span class="token string">"requirement"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>requirement<span class="token punctuation">)</span>
        <span class="token comment">#print(item)</span>
        <span class="token comment">#交给管道文件</span>
        <span class="token keyword">yield</span> item
</code></pre> 
<h5><a id="_1926"></a>⑤、创建数据库和表：</h5> 
<ul><li>在mysql中创建数据库<code>mydb</code>和数据表<code>hr</code></li></ul> 
<pre><code class="prism language-mysql">CREATE TABLE `hr` (                          
   `id` int(10) unsigned NOT NULL AUTO_INCREMENT,  
   `title` varchar(255) DEFAULT NULL,              
   `location` varchar(32) DEFAULT NULL,                
   `type` varchar(32) DEFAULT NULL,                
   `number` varchar(32) DEFAULT NULL,             
   `duty` text DEFAULT NULL,                
   `requirement` text DEFAULT NULL,               
   PRIMARY KEY (`id`)                              
 ) ENGINE=InnoDB DEFAULT CHARSET=utf8
</code></pre> 
<h5><a id="Item_Pipeline_1943"></a>⑥、使用Item Pipeline</h5> 
<ul><li>在Item管道文件中，定义一个MysqlPipeline，负责连接数据库并执行信息写入操作</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">import</span> pymysql

<span class="token keyword">class</span> <span class="token class-name">TencentPipeline</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">process_item</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> item<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> item

<span class="token keyword">class</span> <span class="token class-name">MysqlPipeline</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>host<span class="token punctuation">,</span>user<span class="token punctuation">,</span>password<span class="token punctuation">,</span>database<span class="token punctuation">,</span>port<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>host <span class="token operator">=</span> host
        self<span class="token punctuation">.</span>user <span class="token operator">=</span> user
        self<span class="token punctuation">.</span>password <span class="token operator">=</span> password
        self<span class="token punctuation">.</span>database <span class="token operator">=</span> database
        self<span class="token punctuation">.</span>port <span class="token operator">=</span> port

    @<span class="token builtin">classmethod</span>
    <span class="token keyword">def</span> <span class="token function">from_crawler</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span>crawler<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> cls<span class="token punctuation">(</span>
            host <span class="token operator">=</span> crawler<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"MYSQL_HOST"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            user <span class="token operator">=</span> crawler<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"MYSQL_USER"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            password <span class="token operator">=</span> crawler<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"MYSQL_PASS"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            database <span class="token operator">=</span> crawler<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"MYSQL_DATABASE"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            port <span class="token operator">=</span> crawler<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"MYSQL_PORT"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">open_spider</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''负责连接数据库'''</span>
        self<span class="token punctuation">.</span>db <span class="token operator">=</span> pymysql<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>self<span class="token punctuation">.</span>host<span class="token punctuation">,</span>self<span class="token punctuation">.</span>user<span class="token punctuation">,</span>self<span class="token punctuation">.</span>password<span class="token punctuation">,</span>self<span class="token punctuation">.</span>database<span class="token punctuation">,</span>charset<span class="token operator">=</span><span class="token string">"utf8"</span><span class="token punctuation">,</span>port<span class="token operator">=</span>self<span class="token punctuation">.</span>port<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cursor <span class="token operator">=</span> self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">process_item</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> item<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''执行数据表的写入操作'''</span>
        <span class="token comment">#组装sql语句</span>
        data <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
        keys <span class="token operator">=</span> <span class="token string">','</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>data<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        values<span class="token operator">=</span><span class="token string">','</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'%s'</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
        sql <span class="token operator">=</span> <span class="token string">"insert into %s(%s) values(%s)"</span><span class="token operator">%</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>table<span class="token punctuation">,</span>keys<span class="token punctuation">,</span>values<span class="token punctuation">)</span>
        <span class="token comment">#指定参数，并执行sql添加</span>
        self<span class="token punctuation">.</span>cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">,</span><span class="token builtin">tuple</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">#事务提交</span>
        self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> item

    <span class="token keyword">def</span> <span class="token function">close_spider</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''关闭连接数据库'''</span>
        self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="__1995"></a>⑦ 修改配置文件</h5> 
<ul><li>打开配置文件：settings.py 开启并配置ITEM_PIPELINES信息，配置数据库连接信息</li><li>当有CONCURRENT_REQUESTS，没有DOWNLOAD_DELAY 时，服务器会在同一时间收到大量的请求。</li><li>当有CONCURRENT_REQUESTS，有DOWNLOAD_DELAY 时，服务器不会在同一时间收到大量的请求。</li></ul> 
<pre><code class="prism language-python"><span class="token comment"># 忽略爬虫协议</span>
ROBOTSTXT_OBEY <span class="token operator">=</span> <span class="token boolean">False</span>

<span class="token comment"># 并发量</span>
CONCURRENT_REQUESTS <span class="token operator">=</span> <span class="token number">1</span> 

<span class="token comment">#下载延迟</span>
DOWNLOAD_DELAY <span class="token operator">=</span> <span class="token number">0</span>

ITEM_PIPELINES <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">#'educsdn.pipelines.EducsdnPipeline': 300,</span>
    <span class="token string">'educsdn.pipelines.MysqlPipeline'</span><span class="token punctuation">:</span> <span class="token number">301</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
MYSQL_HOST <span class="token operator">=</span> <span class="token string">'localhost'</span>
MYSQL_DATABASE <span class="token operator">=</span> <span class="token string">'mydb'</span>
MYSQL_USER <span class="token operator">=</span> <span class="token string">'root'</span>
MYSQL_PASS <span class="token operator">=</span> <span class="token string">''</span>
MYSQL_PORT <span class="token operator">=</span> <span class="token number">3306</span>
</code></pre> 
<h5><a id="_2022"></a>⑧、运行爬取：</h5> 
<ul><li> <p>执行如下命令来启用数据爬取</p> <pre><code class="prism language-python">scrapy crawl hr
</code></pre> </li></ul> 
<h3><a id="9_Scrapy_2030"></a>9. Scrapy扩展</h3> 
<h4><a id="1_scrapy_2032"></a>1. 如何使scrapy爬取信息不打印在命令窗口中</h4> 
<ul><li>通常，我们使用这条命令运行自己的scrapy爬虫：</li></ul> 
<pre><code class="prism language-python">scrapy crawl spider_name
</code></pre> 
<ul><li>但是，由这条命令启动的爬虫，会将所有爬虫运行中的debug信息及抓取到的信息打印在运行窗口中。</li><li>很乱，也不方便查询。所以，可使用该命令代替：</li></ul> 
<pre><code class="prism language-python">scrpay crawl spider_name  <span class="token operator">-</span>s LOG_FILE<span class="token operator">=</span><span class="token builtin">all</span><span class="token punctuation">.</span>log
</code></pre> 
<h4><a id="2_Scrapy_2047"></a>2. Scrapy中的日志处理</h4> 
<ul><li>Scrapy提供了log功能，可以通过 logging 模块使用</li><li>可以修改配置文件settings.py，任意位置添加下面两行</li></ul> 
<pre><code class="prism language-python">LOG_FILE <span class="token operator">=</span> <span class="token string">"mySpider.log"</span>
LOG_LEVEL <span class="token operator">=</span> <span class="token string">"INFO"</span>
</code></pre> 
<ul><li>Scrapy提供5层logging级别:</li></ul> 
<pre><code class="prism language-python">CRITICAL <span class="token operator">-</span> 严重错误<span class="token punctuation">(</span>critical<span class="token punctuation">)</span>
ERROR <span class="token operator">-</span> 一般错误<span class="token punctuation">(</span>regular errors<span class="token punctuation">)</span>
WARNING <span class="token operator">-</span> 警告信息<span class="token punctuation">(</span>warning messages<span class="token punctuation">)</span>
INFO <span class="token operator">-</span> 一般信息<span class="token punctuation">(</span>informational messages<span class="token punctuation">)</span>
DEBUG <span class="token operator">-</span> 调试信息<span class="token punctuation">(</span>debugging messages<span class="token punctuation">)</span>
</code></pre> 
<ul><li>logging设置</li><li>通过在setting.py中进行以下设置可以被用来配置logging:</li></ul> 
<pre><code class="prism language-python">LOG_ENABLED 默认<span class="token punctuation">:</span> <span class="token boolean">True</span>，启用logging
LOG_ENCODING 默认<span class="token punctuation">:</span> <span class="token string">'utf-8'</span>，logging使用的编码
LOG_FILE 默认<span class="token punctuation">:</span> <span class="token boolean">None</span>，在当前目录里创建logging输出文件的文件名
LOG_LEVEL 默认<span class="token punctuation">:</span> <span class="token string">'DEBUG'</span>，log的最低级别
LOG_STDOUT 默认<span class="token punctuation">:</span> <span class="token boolean">False</span> 如果为 <span class="token boolean">True</span>，进程所有的标准输出<span class="token punctuation">(</span>及错误<span class="token punctuation">)</span>将会被重定向到log中。例如，执行 <span class="token keyword">print</span> <span class="token string">"hello"</span> ，其将会在Scrapy log中显示
</code></pre> 
<ul><li>记录信息</li><li>下面给出如何使用WARING级别来记录信息</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">from</span> scrapy <span class="token keyword">import</span> log
log<span class="token punctuation">.</span>msg<span class="token punctuation">(</span><span class="token string">"This is a warning"</span><span class="token punctuation">,</span> level<span class="token operator">=</span>log<span class="token punctuation">.</span>WARNING<span class="token punctuation">)</span>
</code></pre> 
<p>​</p> 
<h2><a id="Python_2091"></a>十、Python网络爬虫进阶实战(中)</h2> 
<h3><a id="09_Selenium_2093"></a>09. Selenium的使用</h3> 
<h4><a id="91__2095"></a>9.1 动态渲染页面爬取</h4> 
<ul><li>对于访问Web时直接响应的数据（就是response内容可见），我们使用urllib、requests或Scrapy框架爬取。</li><li>对应一般的JavaScript动态渲染的页面信息（Ajax加载），我们可以通过分析Ajax请求来抓取信息。</li><li>即使通过Ajax获取数据，但还有会部分加密参数，后期经过JavaScript计算生成内容，导致我们难以直接找到规律，如淘宝页面。</li><li>为了解决这些问题，我们可以直接使用模拟浏览器运行的方式来实现信息获取。</li><li>在Python中有许多模拟浏览器运行库，如：Selenium、Splash、PyV8、Ghost等。</li></ul> 
<h4><a id="92_Selenium_2103"></a>9.2 Selenium的介绍</h4> 
<ul><li>Selenium是一个自动化测试工具，利用它可以驱动浏览器执行特定的动作，如点击，下拉，等操作。</li><li>Selenium可以获取浏览器当前呈现的页面源代码，做到可见既可爬，对应JavaScript动态渲染的信息爬取非常有效。</li><li>官方网址：<a href="http://www.seleniumhq.org/" rel="nofollow">http://www.seleniumhq.org</a></li><li>官方文档：<a href="http://selenium-python.readthedocs.io/" rel="nofollow">http://selenium-python.readthedocs.io</a></li><li>中文文档：<a href="http://selenium-python-zh.readthedocs.io/" rel="nofollow">http://selenium-python-zh.readthedocs.io</a></li><li>安装：<code>pip install selenium</code></li><li>Selenium支持非常多的浏览器，如Chrome、Firefox、Edge等，还支持无界面浏览器PhantomJS。</li><li>ChromeDriver浏览器驱动的安装：（注意浏览器版本：） 
  <ul><li>首先查看当前谷歌Chrome浏览器的版本V61<sub>V67(对应2.35</sub>2.38)，再到下面网址下载</li><li>网址：<code>https://chromedriver.storage.googleapis.com/index.html</code></li><li>Windows安装：将解压的文件：<code>chromedriver.exe</code> 放置到Python的Scripts目录下。</li><li>Mac/Linux安装：将解压的文件：<code>chromedriver</code> 放置到<code>/usr/local/bin/</code>目录下</li></ul> </li><li>PhantomJS驱动的下载地址：http://phantomjs.org/download.html</li></ul> 
<h4><a id="93_Selenium_2119"></a>9.3 Selenium的使用</h4> 
<h6><a id="_python_2121"></a>① 初次体验：模拟谷歌浏览器访问百度首页，并输入python关键字搜索</h6> 
<pre><code class="prism language-python"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>common<span class="token punctuation">.</span>by <span class="token keyword">import</span> By
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>common<span class="token punctuation">.</span>keys <span class="token keyword">import</span> Keys
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>support <span class="token keyword">import</span> expected_conditions <span class="token keyword">as</span> EC
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>support<span class="token punctuation">.</span>wait <span class="token keyword">import</span> WebDriverWait

<span class="token comment">#初始化一个浏览器（如：谷歌，使用Chrome需安装chromedriver）</span>
driver <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#driver = webdriver.PhantomJS() #无界面浏览器</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token comment">#请求网页</span>
    driver<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"https://www.baidu.com"</span><span class="token punctuation">)</span>
    <span class="token comment">#查找id值为kw的节点对象（搜索输入框）</span>
    <span class="token builtin">input</span> <span class="token operator">=</span> driver<span class="token punctuation">.</span>find_element_by_id<span class="token punctuation">(</span><span class="token string">"kw"</span><span class="token punctuation">)</span>
    <span class="token comment">#模拟键盘输入字串内容</span>
    <span class="token builtin">input</span><span class="token punctuation">.</span>send_keys<span class="token punctuation">(</span><span class="token string">"python"</span><span class="token punctuation">)</span>
    <span class="token comment">#模拟键盘点击回车键</span>
    <span class="token builtin">input</span><span class="token punctuation">.</span>send_keys<span class="token punctuation">(</span>Keys<span class="token punctuation">.</span>ENTER<span class="token punctuation">)</span>
    <span class="token comment">#显式等待,最长10秒</span>
    wait <span class="token operator">=</span> WebDriverWait<span class="token punctuation">(</span>driver<span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token comment">#等待条件：10秒内必须有个id属性值为content_left的节点加载出来，否则抛异常。</span>
    wait<span class="token punctuation">.</span>until<span class="token punctuation">(</span>EC<span class="token punctuation">.</span>presence_of_element_located<span class="token punctuation">(</span><span class="token punctuation">(</span>By<span class="token punctuation">.</span>ID<span class="token punctuation">,</span><span class="token string">'content_left'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 输出响应信息</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>driver<span class="token punctuation">.</span>current_url<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>driver<span class="token punctuation">.</span>get_cookies<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>driver<span class="token punctuation">.</span>page_source<span class="token punctuation">)</span>
<span class="token keyword">finally</span><span class="token punctuation">:</span>
    <span class="token comment">#关闭浏览器</span>
    <span class="token comment">#driver.close()</span>
    <span class="token keyword">pass</span>
</code></pre> 
<h6><a id="__2156"></a>② 声明浏览器对象</h6> 
<pre><code class="prism language-python"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver

driver <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">#谷歌 需：ChromeDriver驱动</span>
driver <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>FireFox<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#火狐 需：GeckoDriver驱动</span>
driver <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Edge<span class="token punctuation">(</span><span class="token punctuation">)</span>  
driver <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Safari<span class="token punctuation">(</span><span class="token punctuation">)</span>  
driver <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>PhantomJS<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#无界面浏览器</span>
</code></pre> 
<h6><a id="__2168"></a>③ 访问页面</h6> 
<pre><code class="prism language-python"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver

driver <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#driver = webdriver.PhantomJS()</span>
driver<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"http://www.taobao.com"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>driver<span class="token punctuation">.</span>page_source<span class="token punctuation">)</span>
<span class="token comment">#driver.close()</span>
</code></pre> 
<h6><a id="__2180"></a>④ 查找节点：</h6> 
<ul><li>获取单个节点的方法： 
  <ul><li>find_element_by_id()</li><li>find_element_by_name()</li><li>find_element_by_xpath()</li><li>find_element_by_link_text()</li><li>find_element_by_partial_link_text()</li><li>find_element_by_tag_name()</li><li>find_element_by_class_name()</li><li>find_element_by_css_seletor()</li></ul> </li></ul> 
<pre><code class="prism language-python"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>common<span class="token punctuation">.</span>by <span class="token keyword">import</span> By

<span class="token comment">#创建浏览器对象</span>
driver <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#driver = webdriver.PhantomJS()</span>
driver<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"http://www.taobao.com"</span><span class="token punctuation">)</span>
<span class="token comment">#下面都是获取id属性值为q的节点对象</span>
<span class="token builtin">input</span> <span class="token operator">=</span> driver<span class="token punctuation">.</span>find_element_by_id<span class="token punctuation">(</span><span class="token string">"q"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span>

<span class="token builtin">input</span> <span class="token operator">=</span> driver<span class="token punctuation">.</span>find_element_by_css_selector<span class="token punctuation">(</span><span class="token string">"#q"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span>

<span class="token builtin">input</span> <span class="token operator">=</span> driver<span class="token punctuation">.</span>find_element_by_xpath<span class="token punctuation">(</span><span class="token string">"//*[@id='q']"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span>

<span class="token comment">#效果同上</span>
<span class="token builtin">input</span> <span class="token operator">=</span> driver<span class="token punctuation">.</span>find_element<span class="token punctuation">(</span>By<span class="token punctuation">.</span>ID<span class="token punctuation">,</span><span class="token string">"q"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span>

<span class="token comment">#driver.close()</span>
</code></pre> 
<ul><li>获取多个节点的方法： 
  <ul><li>find_elements_by_id()</li><li>find_elements_by_name()</li><li>find_elements_by_xpath()</li><li>find_elements_by_link_text()</li><li>find_elements_by_partial_link_text()</li><li>find_elements_by_tag_name()</li><li>find_elements_by_class_name()</li><li>find_elements_by_css_seletor()</li></ul> </li></ul> 
<h6><a id="__2227"></a>⑤ 节点交互：</h6> 
<pre><code class="prism language-python"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver
<span class="token keyword">import</span> time

<span class="token comment">#创建浏览器对象</span>
driver <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#driver = webdriver.PhantomJS()</span>
driver<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"http://www.taobao.com"</span><span class="token punctuation">)</span>
<span class="token comment">#下面都是获取id属性值为q的节点对象</span>
<span class="token builtin">input</span> <span class="token operator">=</span> driver<span class="token punctuation">.</span>find_element_by_id<span class="token punctuation">(</span><span class="token string">"q"</span><span class="token punctuation">)</span>
<span class="token comment">#模拟键盘输入iphone</span>
<span class="token builtin">input</span><span class="token punctuation">.</span>send_keys<span class="token punctuation">(</span><span class="token string">'iphone'</span><span class="token punctuation">)</span>
time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token comment">#清空输入框</span>
<span class="token builtin">input</span><span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#模拟键盘输入iPad</span>
<span class="token builtin">input</span><span class="token punctuation">.</span>send_keys<span class="token punctuation">(</span><span class="token string">'iPad'</span><span class="token punctuation">)</span>
<span class="token comment">#获取搜索按钮节点</span>
botton <span class="token operator">=</span> driver<span class="token punctuation">.</span>find_element_by_class_name<span class="token punctuation">(</span><span class="token string">"btn-search"</span><span class="token punctuation">)</span>
<span class="token comment">#触发点击动作</span>
botton<span class="token punctuation">.</span>click<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">#driver.close()</span>
</code></pre> 
<h6><a id="__2254"></a>⑥ 动态链：</h6> 
<ul><li>ActionChains是一种自动化低级别交互的方法，如鼠标移动，鼠标按钮操作，按键操作和上下文菜单交互。</li><li>这对于执行更复杂的操作（如悬停和拖放）很有用. 
  <ul><li>move_to_element（to_element ）-- 将鼠标移到元素的中间</li><li>move_by_offset（xoffset，yoffset ）-- 将鼠标移至当前鼠标位置的偏移量</li><li>drag_and_drop（源，目标）-- 然后移动到目标元素并释放鼠标按钮。</li><li>pause（秒）-- 以秒为单位暂停指定持续时间的所有输入</li><li>perform（）-- 执行所有存储的操作。</li><li>release（on_element = None ）释放元素上的一个持有鼠标按钮。</li><li>reset_actions（）-- 清除已存储在远程端的操作。</li><li>send_keys（* keys_to_send ）-- 将键发送到当前的焦点元素。</li><li>send_keys_to_element（element，* keys_to_send ）-- 将键发送到一个元素。</li></ul> </li></ul> 
<pre><code class="prism language-python"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver <span class="token keyword">import</span> ActionChains
<span class="token keyword">import</span> time

<span class="token comment">#创建浏览器对象</span>
driver <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#加载指定url地址</span>
url <span class="token operator">=</span> <span class="token string">'http://www.runoob.com/try/try.php?filename=jqueryui-api-droppable'</span>
driver<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
<span class="token comment"># 切换Frame窗口    </span>
driver<span class="token punctuation">.</span>switch_to<span class="token punctuation">.</span>frame<span class="token punctuation">(</span><span class="token string">'iframeResult'</span><span class="token punctuation">)</span>
<span class="token comment">#获取两个div节点对象</span>
source <span class="token operator">=</span> driver<span class="token punctuation">.</span>find_element_by_css_selector<span class="token punctuation">(</span><span class="token string">"#draggable"</span><span class="token punctuation">)</span>
target <span class="token operator">=</span> driver<span class="token punctuation">.</span>find_element_by_css_selector<span class="token punctuation">(</span><span class="token string">"#droppable"</span><span class="token punctuation">)</span>
<span class="token comment">#创建一个动作链对象</span>
actions <span class="token operator">=</span> ActionChains<span class="token punctuation">(</span>driver<span class="token punctuation">)</span>
<span class="token comment">#将一个拖拽操作添加到动作链队列中</span>
actions<span class="token punctuation">.</span>drag_and_drop<span class="token punctuation">(</span>source<span class="token punctuation">,</span>target<span class="token punctuation">)</span>
time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token comment">#执行所有存储的操作（顺序被触发）</span>
actions<span class="token punctuation">.</span>perform<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#driver.close()</span>
</code></pre> 
<h6><a id="_JavaScript_2293"></a>⑦ 执行JavaScript：</h6> 
<pre><code class="prism language-python"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver

<span class="token comment">#创建浏览器对象</span>
driver <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#加载指定url地址</span>
driver<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"https://www.zhihu.com/explore"</span><span class="token punctuation">)</span>
<span class="token comment">#执行javascript程序将页面滚动移至底部</span>
driver<span class="token punctuation">.</span>execute_script<span class="token punctuation">(</span><span class="token string">'window.scrollTo(0,document.body.scrollHeight)'</span><span class="token punctuation">)</span>
<span class="token comment">#执行javascript实现一个弹框操作</span>
driver<span class="token punctuation">.</span>execute_script<span class="token punctuation">(</span><span class="token string">'window.alert("Hello Selenium!")'</span><span class="token punctuation">)</span>

<span class="token comment">#driver.close()</span>
</code></pre> 
<h6><a id="__2310"></a>⑧ 获取节点信息：</h6> 
<pre><code class="prism language-python"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver <span class="token keyword">import</span> ActionChains

<span class="token comment">#创建浏览器对象</span>
driver <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#加载请求指定url地址</span>
driver<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"https://www.zhihu.com/explore"</span><span class="token punctuation">)</span>
<span class="token comment">#获取id属性值为zh-top-link-logo的节点（logo）</span>
logo <span class="token operator">=</span> driver<span class="token punctuation">.</span>find_element_by_id<span class="token punctuation">(</span><span class="token string">"zh-top-link-logo"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>logo<span class="token punctuation">)</span> <span class="token comment">#输出节点对象</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>logo<span class="token punctuation">.</span>get_attribute<span class="token punctuation">(</span><span class="token string">'class'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#节点的class属性值</span>
<span class="token comment">#获取id属性值为zu-top-add-question节点（提问按钮）</span>
<span class="token builtin">input</span> <span class="token operator">=</span> driver<span class="token punctuation">.</span>find_element_by_id<span class="token punctuation">(</span><span class="token string">"zu-top-add-question"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token comment">#获取节点间内容</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>  <span class="token comment">#获取id属性值</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">.</span>location<span class="token punctuation">)</span> <span class="token comment">#节点在页面中的相对位置</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">.</span>tag_name<span class="token punctuation">)</span> <span class="token comment">#节点标签名称</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">.</span>size<span class="token punctuation">)</span>     <span class="token comment">#获取节点的大小</span>
<span class="token comment">#driver.close()</span>
</code></pre> 
<h6><a id="_Frame_2334"></a>⑨ 切换Frame：</h6> 
<ul><li>网页中有一种节点叫做<code>iframe</code>，也就是子Frame，他可以将一个页面分成多个子父界面。</li><li>我们可以使用switch_to.frame()来切换Frame界面，实例详见<code>第⑥的动态链</code>案例</li></ul> 
<h6><a id="__2339"></a>⑩ 延迟等待：</h6> 
<ul><li>浏览器加载网页是需要时间的，Selenium也不例外，若要获取完整网页内容，就要延时等待。</li><li>在Selenium中延迟等待方式有两种：一种是隐式等待，一种是显式等待（推荐）。</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver

<span class="token comment">#创建浏览器对象</span>
driver <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#使用隐式等待(固定时间)</span>
driver<span class="token punctuation">.</span>implicitly_wait<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> 
<span class="token comment">#加载请求指定url地址</span>
driver<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"https://www.zhihu.com/explore"</span><span class="token punctuation">)</span>
<span class="token comment">#获取节点    </span>
<span class="token builtin">input</span> <span class="token operator">=</span> driver<span class="token punctuation">.</span>find_element_by_id<span class="token punctuation">(</span><span class="token string">"zu-top-add-question"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token comment">#获取节点间内容</span>

<span class="token comment">#driver.close()</span>
<span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>common<span class="token punctuation">.</span>by <span class="token keyword">import</span> By
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>support <span class="token keyword">import</span> expected_conditions <span class="token keyword">as</span> EC
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>support<span class="token punctuation">.</span>wait <span class="token keyword">import</span> WebDriverWait

<span class="token comment">#创建浏览器对象</span>
driver <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#加载请求指定url地址</span>
driver<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"https://www.zhihu.com/explore"</span><span class="token punctuation">)</span>
<span class="token comment">#显式等待,最长10秒</span>
wait <span class="token operator">=</span> WebDriverWait<span class="token punctuation">(</span>driver<span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token comment">#等待条件：10秒内必须有个id属性值为zu-top-add-question的节点加载出来，否则抛异常。</span>
<span class="token builtin">input</span> <span class="token operator">=</span> wait<span class="token punctuation">.</span>until<span class="token punctuation">(</span>EC<span class="token punctuation">.</span>presence_of_element_located<span class="token punctuation">(</span><span class="token punctuation">(</span>By<span class="token punctuation">.</span>ID<span class="token punctuation">,</span><span class="token string">'zu-top-add-question'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token comment">#获取节点间内容</span>
<span class="token comment">#driver.close()</span>
</code></pre> 
<h6><a id="11__2375"></a>11 前进和后退：</h6> 
<pre><code class="prism language-python"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver
<span class="token keyword">import</span> time

<span class="token comment">#创建浏览器对象</span>
driver <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#加载请求指定url地址</span>
driver<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"https://www.baidu.com"</span><span class="token punctuation">)</span>
driver<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"https://www.taobao.com"</span><span class="token punctuation">)</span>
driver<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"https://www.jd.com"</span><span class="token punctuation">)</span>
time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
driver<span class="token punctuation">.</span>back<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#后退</span>
time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">#前进</span>
driver<span class="token punctuation">.</span>forward<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#driver.close()</span>
</code></pre> 
<h6><a id="12_Cookies_2394"></a>12 Cookies：</h6> 
<pre><code class="prism language-python"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver <span class="token keyword">import</span> ActionChains

<span class="token comment">#创建浏览器对象</span>
driver <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#加载请求指定url地址</span>
driver<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"https://www.zhihu.com/explore"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>driver<span class="token punctuation">.</span>get_cookies<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
driver<span class="token punctuation">.</span>add_cookie<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'name'</span><span class="token punctuation">:</span><span class="token string">'namne'</span><span class="token punctuation">,</span><span class="token string">'domain'</span><span class="token punctuation">:</span><span class="token string">'www.zhihu.com'</span><span class="token punctuation">,</span><span class="token string">'value'</span><span class="token punctuation">:</span><span class="token string">'zhangsan'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>driver<span class="token punctuation">.</span>get_cookies<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
driver<span class="token punctuation">.</span>delete_all_cookies<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>driver<span class="token punctuation">.</span>get_cookies<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">#driver.close()</span>
</code></pre> 
<h6><a id="13__2412"></a>13 选项卡管理：</h6> 
<pre><code class="prism language-python"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver
<span class="token keyword">import</span> time

<span class="token comment">#创建浏览器对象</span>
driver <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#加载请求指定url地址</span>
driver<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"https://www.baidu.com"</span><span class="token punctuation">)</span>
<span class="token comment">#使用JavaScript开启一个新的选型卡</span>
driver<span class="token punctuation">.</span>execute_script<span class="token punctuation">(</span><span class="token string">'window.open()'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>driver<span class="token punctuation">.</span>window_handles<span class="token punctuation">)</span>
<span class="token comment">#切换到第二个选项卡，并打开url地址</span>
driver<span class="token punctuation">.</span>switch_to_window<span class="token punctuation">(</span>driver<span class="token punctuation">.</span>window_handles<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
driver<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"https://www.taobao.com"</span><span class="token punctuation">)</span>
time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token comment">#切换到第一个选项卡，并打开url地址</span>
driver<span class="token punctuation">.</span>switch_to_window<span class="token punctuation">(</span>driver<span class="token punctuation">.</span>window_handles<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
driver<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"https://www.jd.com"</span><span class="token punctuation">)</span>
<span class="token comment">#driver.close()</span>
</code></pre> 
<h6><a id="14__2435"></a>14 异常处理：</h6> 
<pre><code class="prism language-python"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>common<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> TimeoutException<span class="token punctuation">,</span>NoSuchElementException

<span class="token comment">#创建浏览器对象</span>
driver <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token comment">#加载请求指定url地址</span>
    driver<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"https://www.baidu.com"</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> TimeoutException<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Time Out'</span><span class="token punctuation">)</span>

<span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token comment">#加载请求指定url地址</span>
    driver<span class="token punctuation">.</span>find_element_by_id<span class="token punctuation">(</span><span class="token string">"demo"</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> NoSuchElementException<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'No Element'</span><span class="token punctuation">)</span>
<span class="token keyword">finally</span><span class="token punctuation">:</span>
    <span class="token comment">#driver.close()</span>
    <span class="token keyword">pass</span>
</code></pre> 
<h3><a id="10_Selenium_2459"></a>10. Selenium爬取淘宝商品</h3> 
<h4><a id="__2461"></a>① 案例要求</h4> 
<ul><li>使用Selenium爬取淘宝商品，指定关键字和指定页码信息来进行爬取</li></ul> 
<h4><a id="__2465"></a>② 案例分析：</h4> 
<ul><li>url地址：https://s.taobao.com/search?q=ipad</li></ul> 
<h4><a id="__2469"></a>③ 具体代码实现</h4> 
<pre><code class="prism language-python"><span class="token triple-quoted-string string">'''通过关键字爬取淘宝网站的信息数据'''</span>
<span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>common<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> TimeoutException
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>common<span class="token punctuation">.</span>by <span class="token keyword">import</span> By
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>support <span class="token keyword">import</span> expected_conditions <span class="token keyword">as</span> EC
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>support<span class="token punctuation">.</span>wait <span class="token keyword">import</span> WebDriverWait
<span class="token keyword">from</span> pyquery <span class="token keyword">import</span> PyQuery <span class="token keyword">as</span> pq
<span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> quote

KEYWORD <span class="token operator">=</span> <span class="token string">"ipad"</span>
MAX_PAGE <span class="token operator">=</span> <span class="token number">10</span>

<span class="token comment"># browser = webdriver.Chrome()</span>
<span class="token comment"># browser = webdriver.PhantomJS()</span>
<span class="token comment">#创建谷歌浏览器对象，启用Chrome的Headless无界面模式</span>
chrome_options <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>ChromeOptions<span class="token punctuation">(</span><span class="token punctuation">)</span>
chrome_options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--headless'</span><span class="token punctuation">)</span>
browser <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span>chrome_options<span class="token operator">=</span>chrome_options<span class="token punctuation">)</span>
<span class="token comment">#显式等待：</span>
wait <span class="token operator">=</span> WebDriverWait<span class="token punctuation">(</span>browser<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">index_page</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''抓取索引页 :param page: 页码'''</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'正在爬取第'</span><span class="token punctuation">,</span> page<span class="token punctuation">,</span> <span class="token string">'页'</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        url <span class="token operator">=</span> <span class="token string">'https://s.taobao.com/search?q='</span> <span class="token operator">+</span> quote<span class="token punctuation">(</span>KEYWORD<span class="token punctuation">)</span>
        browser<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
        <span class="token keyword">if</span> page <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token builtin">input</span> <span class="token operator">=</span> wait<span class="token punctuation">.</span>until<span class="token punctuation">(</span>EC<span class="token punctuation">.</span>presence_of_element_located<span class="token punctuation">(</span><span class="token punctuation">(</span>By<span class="token punctuation">.</span>CSS_SELECTOR<span class="token punctuation">,</span> <span class="token string">'#mainsrp-pager div.form &gt; input'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            submit <span class="token operator">=</span> wait<span class="token punctuation">.</span>until<span class="token punctuation">(</span>EC<span class="token punctuation">.</span>element_to_be_clickable<span class="token punctuation">(</span><span class="token punctuation">(</span>By<span class="token punctuation">.</span>CSS_SELECTOR<span class="token punctuation">,</span> <span class="token string">'#mainsrp-pager div.form &gt; span.btn.J_Submit'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token builtin">input</span><span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token builtin">input</span><span class="token punctuation">.</span>send_keys<span class="token punctuation">(</span>page<span class="token punctuation">)</span>
            submit<span class="token punctuation">.</span>click<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">#等待条件：显示当前页号，显式商品</span>
        wait<span class="token punctuation">.</span>until<span class="token punctuation">(</span>EC<span class="token punctuation">.</span>text_to_be_present_in_element<span class="token punctuation">(</span><span class="token punctuation">(</span>By<span class="token punctuation">.</span>CSS_SELECTOR<span class="token punctuation">,</span> <span class="token string">'#mainsrp-pager li.item.active &gt; span'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        wait<span class="token punctuation">.</span>until<span class="token punctuation">(</span>EC<span class="token punctuation">.</span>presence_of_element_located<span class="token punctuation">(</span><span class="token punctuation">(</span>By<span class="token punctuation">.</span>CSS_SELECTOR<span class="token punctuation">,</span> <span class="token string">'.m-itemlist .items .item'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        get_products<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> TimeoutException<span class="token punctuation">:</span>
        index_page<span class="token punctuation">(</span>page<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">get_products</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''提取商品数据'''</span>
    html <span class="token operator">=</span> browser<span class="token punctuation">.</span>page_source
    doc <span class="token operator">=</span> pq<span class="token punctuation">(</span>html<span class="token punctuation">)</span>
    items <span class="token operator">=</span> doc<span class="token punctuation">(</span><span class="token string">'#mainsrp-itemlist .items .item'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> item <span class="token keyword">in</span> items<span class="token punctuation">:</span>
        product <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">'image'</span><span class="token punctuation">:</span> item<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'.pic .img'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>attr<span class="token punctuation">(</span><span class="token string">'data-src'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'price'</span><span class="token punctuation">:</span> item<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'.price'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'deal'</span><span class="token punctuation">:</span> item<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'.deal-cnt'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'title'</span><span class="token punctuation">:</span> item<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'.title'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'shop'</span><span class="token punctuation">:</span> item<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'.shop'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'location'</span><span class="token punctuation">:</span> item<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'.location'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>product<span class="token punctuation">)</span>
        save_data<span class="token punctuation">(</span>product<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">save_data</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''保存数据'''</span>
    <span class="token keyword">pass</span>

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''遍历每一页'''</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> MAX_PAGE <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        index_page<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    browser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token comment"># 主程序入口</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="11_MongoDB_2547"></a>11. MongoDB数据库</h3> 
<ul><li>MongoDB 是一个<code>基于分布式文件存储</code>的数据库。由C++语言编写。旨在为 WEB 应用提供可扩展的高性能数据存储解决方案。</li><li>MongoDB 是一个<code>介于关系数据库和非关系数据库之间的产品</code>，是非关系数据库当中功能最丰富，最像关系数据库的。</li><li>参考地址: 
  <ul><li>MongoDB 官网地址：https://www.mongodb.com/</li><li>MongoDB 官方英文文档：https://docs.mongodb.com/manual/</li><li>MongoDB 各平台下载地址：https://www.mongodb.com/download-center#community</li></ul> </li></ul> 
<h4><a id="11_RDBMSNoSQL_2556"></a>1.1 RDBMS与NoSQL区别：</h4> 
<ul><li>关系数据库管理系统(RDBMS) 
  <ul><li>高度组织化结构化数据</li><li>结构化查询语言（SQL）</li><li>数据和关系都存储在单独的表中。</li><li>数据操纵语言，数据定义语言</li><li>严格的一致性</li><li>基础事务</li></ul> </li><li>非关系型数据库(NoSQL) 
  <ul><li>代表着不仅仅是SQL</li><li>没有声明性查询语言</li><li>没有预定义的模式</li><li>键 - 值对存储，列存储，文档存储，图形数据库</li><li>最终一致性，而非ACID属性</li><li>非结构化和不可预知的数据</li><li>CAP定理</li><li>高性能，高可用性和可伸缩性</li></ul> </li><li>RDBMS 与 MongoDB 对应的术语区别：</li></ul> 
<table><thead><tr><th>RDBMS</th><th>MongoDB</th></tr></thead><tbody><tr><td>数据库</td><td>数据库</td></tr><tr><td>表格</td><td>集合</td></tr><tr><td>行</td><td>文档</td></tr><tr><td>列</td><td>字段</td></tr><tr><td>表联合</td><td>嵌入文档</td></tr><tr><td>主键</td><td>主键 (MongoDB 提供了 key 为 _id )</td></tr></tbody></table> 
<h4><a id="12_WindowsMongoDB_2585"></a>1.2 Windows下安装MongoDB：</h4> 
<ul><li>下载地址:https://www.mongodb.org/dl/win32/x86_64-2008plus-ssl</li><li>最新版的在安装过程中出现卡死现象，建议选择版本3.4版本（测试过）。</li><li>安装图形界面，一步一步的安装即可：</li><li>创建数据库目录：</li></ul> 
<pre><code>c:\&gt;cd c:\

c:\&gt;mkdir data

c:\&gt;cd data

c:\data&gt;mkdir db

c:\data&gt;cd db

c:\data\db&gt;
</code></pre> 
<ul><li>启动MongoDB服务：</li></ul> 
<pre><code>C:\Program Files\MongoDB\Server\3.4\bin&gt;mongod --dbpath c:\data\db
</code></pre> 
<ul><li>连接MongoDB</li></ul> 
<pre><code>C:\Program Files\MongoDB\Server\3.4\bin&gt;mongo
</code></pre> 
<h4><a id="13__2618"></a>1.3 数据库的操作</h4> 
<h5><a id="_MongoDB_2620"></a>① MongoDB的数据库操作</h5> 
<ul><li>查看当前数据库名称</li></ul> 
<pre><code>db
</code></pre> 
<ul><li>查看所有数据库名称</li><li>列出所有在物理上存在的数据库</li></ul> 
<pre><code>show dbs
</code></pre> 
<p>·</p> 
<ul><li>切换数据库</li><li>如果数据库不存在，则指向数据库，但不创建，直到插入数据或创建集合时数据库才被创建</li></ul> 
<pre><code>use 数据库名称
</code></pre> 
<p>默认的数据库为测试，如果你没有创建新的数据库，集合将存放在测试数据库中</p> 
<ul><li>数据库删除 
  <ul><li>删除当前指向的数据库</li><li>如果数据库不存在，则什么也不做</li></ul> </li></ul> 
<pre><code>db.dropDatabase()
</code></pre> 
<h5><a id="_MongoDB_2654"></a>② MongoDB的集合操作：</h5> 
<ul><li>创建集合：</li></ul> 
<pre><code>db.createCollection(name, options)
</code></pre> 
<ul><li>name是要创建的集合的名称</li><li>options是一个文档，用于指定集合的配置</li><li>选项参数是可选的，所以只需要到指定的集合名称。以下是可以使用的选项列表：</li><li>例1：不限制集合大小 
  <ul><li>db.createCollection(“stu”)</li></ul> </li><li>例2：限制集合大小，后面学会插入语句后可以查看效果 
  <ul><li>参数capped：默认值为false表示不设置上限，值为true表示设置上限</li><li>参数size：当capped值为true时，需要指定此参数，表示上限大小，当文档达到上限时，会将之前的数据覆盖，单位为字节</li><li>db.createCollection(“sub”, { capped : true, size : 10 } )</li></ul> </li><li>查看当前数据库的集合</li></ul> 
<pre><code>show collections
</code></pre> 
<p>删除集合：</p> 
<pre><code>db.集合名称.drop()
</code></pre> 
<h5><a id="__2683"></a>③ 数据类型：</h5> 
<ul><li>下表为MongoDB中常用的几种数据类型： 
  <ul><li>Object ID：文档ID</li><li>String：字符串，最常用，必须是有效的UTF-8</li><li>Boolean：存储一个布尔值，true或false</li><li>Integer：整数可以是32位或64位，这取决于服务器</li><li>Double：存储浮点值</li><li>Arrays：数组或列表，多个值存储到一个键</li><li>Object：用于嵌入式的文档，即一个值为一个文档</li><li>Null：存储Null值</li><li>Timestamp：时间戳</li><li>Date：存储当前日期或时间的UNIX时间格式</li></ul> </li><li>object id 
  <ul><li>每个文档都有一个属性，为_id，保证每个文档的唯一性</li><li>可以自己去设置_id插入文档</li><li>如果没有提供，那么MongoDB为每个文档提供了一个独特的_id，类型为objectID</li><li>objectID是一个12字节的十六进制数 
    <ul><li>前4个字节为当前时间戳</li><li>接下来3个字节的机器ID</li><li>接下来的2个字节中MongoDB的服务进程id</li><li>最后3个字节是简单的增量值</li></ul> </li></ul> </li></ul> 
<h5><a id="__2706"></a>④ 数据的操作</h5> 
<ul><li>插入语法</li></ul> 
<pre><code>db.集合名称.insert(document)
</code></pre> 
<ul><li> <p>插入文档时，如果不指定_id参数，MongoDB的会为文档分配一个唯一的的ObjectId</p> </li><li> <p>例1:</p> <pre><code>db.stu.insert({name:'gj',gender:1})
</code></pre> </li><li> <p>例2:</p> <pre><code>s1={_id:'20160101',name:'hr'}
s1.gender=0
db.stu.insert(s1)
</code></pre> </li><li> <p>简单查询</p> </li></ul> 
<pre><code>db.集合名称.find()
</code></pre> 
<ul><li>数据的更新</li></ul> 
<pre><code>db.集合名称.update(
   &lt;query&gt;,
   &lt;update&gt;,
   {multi: &lt;boolean&gt;}
)
</code></pre> 
<ul><li>参数查询：查询条件，类似SQL语句更新中，其中部分</li><li>参数更新：更新操作符，类似SQL语句更新中集部分</li><li>参数多：可选，默认是假的，表示只更新找到的第一条记录，值为真表示把满足条件的文档全部更新</li></ul> 
<pre><code>例3：全文档更新
db.stu.update({name:'hr'},{name:'mnc'})
例4：指定属性更新，通过操作符$集
db.stu.insert({name:'hr',gender:0})
db.stu.update({name:'hr'},{$set:{name:'hys'}})
例5：修改多条匹配到的数据
db.stu.update({},{$set:{gender:0}},{multi:true})
</code></pre> 
<ul><li>数据的保存语法</li></ul> 
<pre><code>db.集合名称.save(document)
</code></pre> 
<ul><li>如果文档的_id已经存在则修改，如果文档的_id不存在则添加</li></ul> 
<pre><code>db.stu.save({_id:'20160102','name':'yk',gender:1})

db.stu.save({_id:'20160102','name':'wyk'})
</code></pre> 
<ul><li>删除 语法</li></ul> 
<pre><code>db.集合名称.remove(
   &lt;query&gt;,
   {
     justOne: &lt;boolean&gt;
   }
)
</code></pre> 
<ul><li>参数查询：可选，删除的文档的条件</li><li>参数来说只是个：可选，如果设为真或1，则只删除一条，默认为false，表示删除多条</li></ul> 
<pre><code>例：只删除匹配到的第一条
db.stu.remove({gender:0},{justOne:true})
例：全部删除
db.stu.remove({})
</code></pre> 
<ul><li>关于大小的示例</li></ul> 
<pre><code>创建集合
db.createCollection('sub',{capped:true,size:10})

插入第一条数据库查询
db.sub.insert({title:'linux',count:10})
db.sub.find()

插入第二条数据库查询
db.sub.insert({title:'web',count:15})
db.sub.find()

插入第三条数据库查询
db.sub.insert({title:'sql',count:8})
db.sub.find()

插入第四条数据库查询
db.sub.insert({title:'django',count:12})
db.sub.find()

插入第五条数据库查询
db.sub.insert({title:'python',count:14})
db.sub.find()
</code></pre> 
<ul><li>limit限制</li></ul> 
<pre><code>方法限制（）：用于读取指定数量的文档
    db.集合名称.find().limit(NUMBER)
参数号表示要获取文档的条数
如果没有指定参数则显示集合中的所有文档

例1：查询2条学生信息
    db.stu.find().limit(2)
</code></pre> 
<ul><li>投影</li></ul> 
<pre><code>在查询到的返回结果中，只选择必要的字段，而不是选择一个文档的整个字段
如：一个文档有5个字段，需要显示只有3个，投影其中3个字段即可
参数为字段与值，值为1表示显示，值为0不显示

    db.集合名称.find({},{字段名称:1,...})

特殊：对于_id列默认是显示的，如果不显示需要明确设置为0

例1
    db.stu.find({},{name:1,gender:1})
例2
    db.stu.find({},{_id:0,name:1,gender:1})
</code></pre> 
<ul><li>排序</li></ul> 
<pre><code>方法sort()，用于对结果集进行排序
    db.集合名称.find().sort({字段:1,...})
参数1为升序排列
参数-1为降序排列

例1：根据性别降序，再根据年龄升序
    db.stu.find().sort({gender:-1,age:1})
</code></pre> 
<ul><li>统计个数</li></ul> 
<pre><code>方法count()用于统计结果集中文档条数
    db.集合名称.find({条件}).count()
也可以与为
    db.集合名称.count({条件})

例1：统计男生人数
    db.stu.find({gender:1}).count()

例2：统计年龄大于20的男生人数
    b.stu.count({age:{$gt:20},gender:1})
</code></pre> 
<ul><li>消除重复</li></ul> 
<pre><code>方法distinct()对数据进行去重
    db.集合名称.distinct('去重字段',{条件})

例1:查找年龄大于18的性别（去重）
    db.stu.distinct('gender',{age:{$gt:18}})
</code></pre> 
<h4><a id="114__2888"></a>11.4 备份与恢复</h4> 
<pre><code>语法
mongodump -h dbhost -d dbname -o dbdirectory
-h：服务器地址，也可以指定端口号
-d：需要备份的数据库名称
-o：备份的数据存放位置，此目录中存放着备份出来的数据
例1
sudo mkdir test1bak
sudo mongodump -h 192.168.196.128:27017 -d test1 -o ~/Desktop/test1bak
恢复
语法
mongorestore -h dbhost -d dbname --dir dbdirectory
-h：服务器地址
-d：需要恢复的数据库实例
--dir：备份数据所在位置
例2
mongorestore -h 192.168.196.128:27017 -d test2 --dir ~/Desktop/test1bak/test1
</code></pre> 
<h4><a id="115_python_2909"></a>11.5 与python交互</h4> 
<ul><li> <p>安装python包</p> <pre><code>pip install pymongo
</code></pre> </li><li> <p>使用：</p> </li><li> <p>引入包pymongo</p> <pre><code>import pymongo
</code></pre> </li><li> <p>连接，创建客户端</p> <pre><code>client=pymongo.MongoClient("localhost", 27017)
</code></pre> </li><li> <p>获得数据库test1</p> <pre><code>db=client.test1
</code></pre> </li><li> <p>获得集合stu</p> <pre><code>stu = db.stu
</code></pre> </li><li> <p>添加文档</p> <pre><code>s1={name:'gj',age:18}
s1_id = stu.insert_one(s1).inserted_id
</code></pre> </li><li> <p>查找一个文档</p> <pre><code>s2=stu.find_one()
</code></pre> </li><li> <p>查找多个文档1</p> <pre><code>for cur in stu.find():
  print cur
</code></pre> </li><li> <p>查找多个文档2</p> <pre><code>cur=stu.find()
cur.next()
cur.next()
cur.next()
</code></pre> </li><li> <p>获取文档个数</p> <pre><code>print stu.count()
</code></pre> </li></ul> 
<h3><a id="12_ScrapySelenium_2978"></a>12. Scrapy框架使用Selenium</h3> 
<p>​</p> 
<ul><li>案例目标： 
  <ul><li>本节案例主要是通过Scrapy框架使用Selenium，以PhantomJS进行演示，爬取淘宝商品信息案例，并将信息存入数据库MongoDB中。</li></ul> </li><li>准备工作： 
  <ul><li>请确保PhantomJS和MongoDB都已安装号，并确保可以正常运行，安装好Scrapy、Selenium和PyMongod库。</li></ul> </li></ul> 
<h5><a id="__2987"></a>① 创建项目</h5> 
<ul><li>首先新建项目，名为scrapyseleniumtest：</li></ul> 
<pre><code>scrapy startproject scrapyseleniumtest
</code></pre> 
<ul><li>进入项目目录下，创建一个Spider（爬虫类）：</li></ul> 
<pre><code>cd srapytseleniumtest
scrapy genspider taobao www.baobao.com
</code></pre> 
<ul><li>进入settings.py的配置文件：将ROBOTSTXT_OBEY改为false</li></ul> 
<pre><code>ROBOTSTXT_OBEY = False
</code></pre> 
<h5><a id="_Item_3008"></a>② 定义Item类</h5> 
<pre><code class="prism language-python"><span class="token comment"># 定义信息封装类（图片、价格、购买人数、标题、店铺、发货源）</span>
<span class="token keyword">from</span> scrapy <span class="token keyword">import</span> Item<span class="token punctuation">,</span> Field

<span class="token keyword">class</span> <span class="token class-name">ProductItem</span><span class="token punctuation">(</span>Item<span class="token punctuation">)</span><span class="token punctuation">:</span>

    collection <span class="token operator">=</span> <span class="token string">'products'</span>

    image <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    price <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    deal <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    title <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    shop <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    location <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="__3026"></a>③ 解析页面</h5> 
<ul><li>在配置文件settings.py最后面定义搜索关键字和最大页码数信息：</li></ul> 
<pre><code class="prism language-python">KEYWORDS <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'iPad'</span><span class="token punctuation">]</span>

MAX_PAGE <span class="token operator">=</span> <span class="token number">100</span>
</code></pre> 
<ul><li>进入spider/taobao.py文件中编写，代码如下：</li></ul> 
<pre><code class="prism language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">from</span> scrapy <span class="token keyword">import</span> Request<span class="token punctuation">,</span> Spider
<span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> quote
<span class="token keyword">from</span> scrapyseleniumtest<span class="token punctuation">.</span>items <span class="token keyword">import</span> ProductItem

<span class="token keyword">class</span> <span class="token class-name">TaobaoSpider</span><span class="token punctuation">(</span>Spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">'taobao'</span>
    allowed_domains <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'www.taobao.com'</span><span class="token punctuation">]</span>
    base_url <span class="token operator">=</span> <span class="token string">'https://s.taobao.com/search?q='</span>

    <span class="token keyword">def</span> <span class="token function">start_requests</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> keyword <span class="token keyword">in</span> self<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'KEYWORDS'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> page <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'MAX_PAGE'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                url <span class="token operator">=</span> self<span class="token punctuation">.</span>base_url <span class="token operator">+</span> quote<span class="token punctuation">(</span>keyword<span class="token punctuation">)</span>
                <span class="token keyword">yield</span> Request<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>parse<span class="token punctuation">,</span> meta<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">'page'</span><span class="token punctuation">:</span> page<span class="token punctuation">}</span><span class="token punctuation">,</span> dont_filter<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>
</code></pre> 
<h5><a id="_Selenium_3059"></a>④ 对接Selenium</h5> 
<ul><li>通过定义DownloaderMiddleware中间件来实现对Selenium的使用。</li></ul> 
<pre><code class="prism language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>common<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> TimeoutException
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>common<span class="token punctuation">.</span>by <span class="token keyword">import</span> By
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>support<span class="token punctuation">.</span>ui <span class="token keyword">import</span> WebDriverWait
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>support <span class="token keyword">import</span> expected_conditions <span class="token keyword">as</span> EC
<span class="token keyword">from</span> scrapy<span class="token punctuation">.</span>http <span class="token keyword">import</span> HtmlResponse
<span class="token keyword">from</span> logging <span class="token keyword">import</span> getLogger


<span class="token keyword">class</span> <span class="token class-name">SeleniumMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> service_args<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>logger <span class="token operator">=</span> getLogger<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>timeout <span class="token operator">=</span> timeout
        self<span class="token punctuation">.</span>browser <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>PhantomJS<span class="token punctuation">(</span>service_args<span class="token operator">=</span>service_args<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>browser<span class="token punctuation">.</span>set_window_size<span class="token punctuation">(</span><span class="token number">1400</span><span class="token punctuation">,</span> <span class="token number">700</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>browser<span class="token punctuation">.</span>set_page_load_timeout<span class="token punctuation">(</span>self<span class="token punctuation">.</span>timeout<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>wait <span class="token operator">=</span> WebDriverWait<span class="token punctuation">(</span>self<span class="token punctuation">.</span>browser<span class="token punctuation">,</span> self<span class="token punctuation">.</span>timeout<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__del__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>browser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">process_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        用PhantomJS抓取页面
        :param request: Request对象
        :param spider: Spider对象
        :return: HtmlResponse
        """</span>
        self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">'PhantomJS is Starting'</span><span class="token punctuation">)</span>
        page <span class="token operator">=</span> request<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'page'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>browser<span class="token punctuation">.</span>get<span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
            <span class="token keyword">if</span> page <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">:</span>
                <span class="token builtin">input</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>wait<span class="token punctuation">.</span>until<span class="token punctuation">(</span>
                    EC<span class="token punctuation">.</span>presence_of_element_located<span class="token punctuation">(</span><span class="token punctuation">(</span>By<span class="token punctuation">.</span>CSS_SELECTOR<span class="token punctuation">,</span> <span class="token string">'#mainsrp-pager div.form &gt; input'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                submit <span class="token operator">=</span> self<span class="token punctuation">.</span>wait<span class="token punctuation">.</span>until<span class="token punctuation">(</span>
                    EC<span class="token punctuation">.</span>element_to_be_clickable<span class="token punctuation">(</span><span class="token punctuation">(</span>By<span class="token punctuation">.</span>CSS_SELECTOR<span class="token punctuation">,</span> <span class="token string">'#mainsrp-pager div.form &gt; span.btn.J_Submit'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token builtin">input</span><span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token builtin">input</span><span class="token punctuation">.</span>send_keys<span class="token punctuation">(</span>page<span class="token punctuation">)</span>
                submit<span class="token punctuation">.</span>click<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>wait<span class="token punctuation">.</span>until<span class="token punctuation">(</span>
                EC<span class="token punctuation">.</span>text_to_be_present_in_element<span class="token punctuation">(</span><span class="token punctuation">(</span>By<span class="token punctuation">.</span>CSS_SELECTOR<span class="token punctuation">,</span> <span class="token string">'#mainsrp-pager li.item.active &gt; span'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>wait<span class="token punctuation">.</span>until<span class="token punctuation">(</span>EC<span class="token punctuation">.</span>presence_of_element_located<span class="token punctuation">(</span><span class="token punctuation">(</span>By<span class="token punctuation">.</span>CSS_SELECTOR<span class="token punctuation">,</span> <span class="token string">'.m-itemlist .items .item'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> HtmlResponse<span class="token punctuation">(</span>url<span class="token operator">=</span>request<span class="token punctuation">.</span>url<span class="token punctuation">,</span> body<span class="token operator">=</span>self<span class="token punctuation">.</span>browser<span class="token punctuation">.</span>page_source<span class="token punctuation">,</span> request<span class="token operator">=</span>request<span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">,</span>
                                status<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> TimeoutException<span class="token punctuation">:</span>
            <span class="token keyword">return</span> HtmlResponse<span class="token punctuation">(</span>url<span class="token operator">=</span>request<span class="token punctuation">.</span>url<span class="token punctuation">,</span> status<span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">,</span> request<span class="token operator">=</span>request<span class="token punctuation">)</span>

    @<span class="token builtin">classmethod</span>
    <span class="token keyword">def</span> <span class="token function">from_crawler</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> crawler<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> cls<span class="token punctuation">(</span>timeout<span class="token operator">=</span>crawler<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'SELENIUM_TIMEOUT'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                   service_args<span class="token operator">=</span>crawler<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'PHANTOMJS_SERVICE_ARGS'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li>在settings.py配置文件中.设置我们自定义的中间件设置：</li></ul> 
<pre><code class="prism language-python">DOWNLOADER_MIDDLEWARES <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'scrapyseleniumtest.middlewares.SeleniumMiddleware'</span><span class="token punctuation">:</span> <span class="token number">543</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="__3128"></a>⑤ 解析页面信息</h5> 
<pre><code class="prism language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">from</span> scrapy <span class="token keyword">import</span> Request<span class="token punctuation">,</span> Spider
<span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> quote
<span class="token keyword">from</span> scrapyseleniumtest<span class="token punctuation">.</span>items <span class="token keyword">import</span> ProductItem


<span class="token keyword">class</span> <span class="token class-name">TaobaoSpider</span><span class="token punctuation">(</span>Spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">'taobao'</span>
    allowed_domains <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'www.taobao.com'</span><span class="token punctuation">]</span>
    base_url <span class="token operator">=</span> <span class="token string">'https://s.taobao.com/search?q='</span>


    <span class="token keyword">def</span> <span class="token function">start_requests</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> keyword <span class="token keyword">in</span> self<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'KEYWORDS'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> page <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'MAX_PAGE'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                url <span class="token operator">=</span> self<span class="token punctuation">.</span>base_url <span class="token operator">+</span> quote<span class="token punctuation">(</span>keyword<span class="token punctuation">)</span>
                <span class="token keyword">yield</span> Request<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>parse<span class="token punctuation">,</span> meta<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">'page'</span><span class="token punctuation">:</span> page<span class="token punctuation">}</span><span class="token punctuation">,</span> dont_filter<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        products <span class="token operator">=</span> response<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span>
            <span class="token string">'//div[@id="mainsrp-itemlist"]//div[@class="items"][1]//div[contains(@class, "item")]'</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> product <span class="token keyword">in</span> products<span class="token punctuation">:</span>
            item <span class="token operator">=</span> ProductItem<span class="token punctuation">(</span><span class="token punctuation">)</span>
            item<span class="token punctuation">[</span><span class="token string">'price'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>product<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'.//div[contains(@class, "price")]//text()'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
            item<span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>product<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'.//div[contains(@class, "title")]//text()'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
            item<span class="token punctuation">[</span><span class="token string">'shop'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>product<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'.//div[contains(@class, "shop")]//text()'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
            item<span class="token punctuation">[</span><span class="token string">'image'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>product<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'.//div[@class="pic"]//img[contains(@class, "img")]/@data-src'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
            item<span class="token punctuation">[</span><span class="token string">'deal'</span><span class="token punctuation">]</span> <span class="token operator">=</span> product<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'.//div[contains(@class, "deal-cnt")]//text()'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span>
            item<span class="token punctuation">[</span><span class="token string">'location'</span><span class="token punctuation">]</span> <span class="token operator">=</span> product<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'.//div[contains(@class, "location")]//text()'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">yield</span> item
</code></pre> 
<h5><a id="__3163"></a>⑥ 存储结果</h5> 
<pre><code class="prism language-python"><span class="token keyword">import</span> pymongo

<span class="token keyword">class</span> <span class="token class-name">MongoPipeline</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> mongo_uri<span class="token punctuation">,</span> mongo_db<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>mongo_uri <span class="token operator">=</span> mongo_uri
        self<span class="token punctuation">.</span>mongo_db <span class="token operator">=</span> mongo_db

    @<span class="token builtin">classmethod</span>
    <span class="token keyword">def</span> <span class="token function">from_crawler</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> crawler<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> cls<span class="token punctuation">(</span>mongo_uri<span class="token operator">=</span>crawler<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'MONGO_URI'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mongo_db<span class="token operator">=</span>crawler<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'MONGO_DB'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">open_spider</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>client <span class="token operator">=</span> pymongo<span class="token punctuation">.</span>MongoClient<span class="token punctuation">(</span>self<span class="token punctuation">.</span>mongo_uri<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>db <span class="token operator">=</span> self<span class="token punctuation">.</span>client<span class="token punctuation">[</span>self<span class="token punctuation">.</span>mongo_db<span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">process_item</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> item<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>db<span class="token punctuation">[</span>item<span class="token punctuation">.</span>collection<span class="token punctuation">]</span><span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> item

    <span class="token keyword">def</span> <span class="token function">close_spider</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li>配置文件信息：</li></ul> 
<pre><code class="prism language-python">ITEM_PIPELINES <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'scrapyseleniumtest.pipelines.MongoPipeline'</span><span class="token punctuation">:</span> <span class="token number">300</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>


KEYWORDS <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'iPad'</span><span class="token punctuation">]</span>

MAX_PAGE <span class="token operator">=</span> <span class="token number">100</span>

SELENIUM_TIMEOUT <span class="token operator">=</span> <span class="token number">20</span>

PHANTOMJS_SERVICE_ARGS <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'--load-images=false'</span><span class="token punctuation">,</span> <span class="token string">'--disk-cache=true'</span><span class="token punctuation">]</span>

MONGO_URI <span class="token operator">=</span> <span class="token string">'localhost'</span>

MONGO_DB <span class="token operator">=</span> <span class="token string">'taobao'</span>
</code></pre> 
<h3><a id="13__3210"></a>13. 代理的使用</h3> 
<h4><a id="131__3212"></a>13.1 代理服务的介绍：</h4> 
<ul><li>我们在做爬虫的过程中经常最初爬虫都正常运行，正常爬取数据，一切看起来都是美好，然而一杯茶的功夫就出现了错误。</li><li>如：403 Forbidden错误，“您的IP访问频率太高”错误，或者跳出一个验证码让我们输入，之后解封，但过一会又出现类似情况。</li><li>出现这个现象的原因是因为网站采取了一些反爬中措施，如：服务器检测IP在单位时间内请求次数超过某个阀值导致，称为封IP。</li><li>为了解决此类问题，代理就派上了用场，如：代理软件、付费代理、ADSL拨号代理，以帮助爬虫脱离封IP的苦海。</li><li>测试HTTP请求及响应的网站:http://httpbin.org/ 
  <ul><li>httpbin这个网站能测试 HTTP 请求和响应的各种信息，比如 cookie、ip、headers 和登录验证等.</li><li>且支持 GET、POST 等多种方法，对 web 开发和测试很有帮助。 
    <ul><li>GET地址 ：http://httpbin.org/get</li><li>POST地址：http://httpbin.org/post</li></ul> </li><li>它用 Python + Flask 编写，是一个开源项目。开源地址：https://github.com/Runscope/httpbin</li><li>返回信息中origin的字段就是客户端的IP地址，即可判断是否成功伪装IP：</li></ul> </li></ul> 
<h4><a id="132__3226"></a>13.2 代理的设置：</h4> 
<h5><a id="_urllib_3228"></a>① urllib的代理设置</h5> 
<pre><code class="prism language-python"><span class="token keyword">from</span> urllib<span class="token punctuation">.</span>error <span class="token keyword">import</span> URLError
<span class="token keyword">from</span> urllib<span class="token punctuation">.</span>request <span class="token keyword">import</span> ProxyHandler<span class="token punctuation">,</span> build_opener

proxy <span class="token operator">=</span> <span class="token string">'127.0.0.1:8888'</span>
<span class="token comment">#需要认证的代理</span>
<span class="token comment">#proxy = 'username:password@127.0.0.1:8888'</span>

<span class="token comment">#使用ProxyHandler设置代理</span>
proxy_handler <span class="token operator">=</span> ProxyHandler<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    <span class="token string">'http'</span><span class="token punctuation">:</span> <span class="token string">'http://'</span> <span class="token operator">+</span> proxy<span class="token punctuation">,</span>
    <span class="token string">'https'</span><span class="token punctuation">:</span> <span class="token string">'https://'</span> <span class="token operator">+</span> proxy
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">#传入参数创建Opener对象</span>
opener <span class="token operator">=</span> build_opener<span class="token punctuation">(</span>proxy_handler<span class="token punctuation">)</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    response <span class="token operator">=</span> opener<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'http://httpbin.org/get'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> URLError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>reason<span class="token punctuation">)</span>
</code></pre> 
<h5><a id="_requests_3252"></a>② requests的代理设置</h5> 
<pre><code class="prism language-python"><span class="token keyword">import</span> requests

proxy <span class="token operator">=</span> <span class="token string">'127.0.0.1:8888'</span>
<span class="token comment">#需要认证的代理</span>
<span class="token comment">#proxy = 'username:password@127.0.0.1:8888'</span>

proxies <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'http'</span><span class="token punctuation">:</span> <span class="token string">'http://'</span> <span class="token operator">+</span> proxy<span class="token punctuation">,</span>
    <span class="token string">'https'</span><span class="token punctuation">:</span> <span class="token string">'https://'</span> <span class="token operator">+</span> proxy<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'http://httpbin.org/get'</span><span class="token punctuation">,</span> proxies<span class="token operator">=</span>proxies<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
<span class="token keyword">except</span> requests<span class="token punctuation">.</span>exceptions<span class="token punctuation">.</span>ConnectionError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Error'</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>args<span class="token punctuation">)</span>
</code></pre> 
<h5><a id="_Selenium_3272"></a>③ Selenium的代理使用</h5> 
<ul><li>使用的是PhantomJS</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver

service_args <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'--proxy=127.0.0.1:9743'</span><span class="token punctuation">,</span>
    <span class="token string">'--proxy-type=http'</span><span class="token punctuation">,</span>
    <span class="token comment">#'--proxy-auth=username:password' #带认证代理</span>
<span class="token punctuation">]</span>

browser <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>PhantomJS<span class="token punctuation">(</span>service_args<span class="token operator">=</span>service_args<span class="token punctuation">)</span>
browser<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'http://httpbin.org/get'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>browser<span class="token punctuation">.</span>page_source<span class="token punctuation">)</span>
</code></pre> 
<ul><li>使用的是Chrome</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver

proxy <span class="token operator">=</span> <span class="token string">'127.0.0.1:9743'</span>
chrome_options <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>ChromeOptions<span class="token punctuation">(</span><span class="token punctuation">)</span>
chrome_options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--proxy-server=http://'</span> <span class="token operator">+</span> proxy<span class="token punctuation">)</span>
chrome <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span>chrome_options<span class="token operator">=</span>chrome_options<span class="token punctuation">)</span>
chrome<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'http://httpbin.org/get'</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="_Scrapy_3302"></a>④ 在Scrapy使用代理</h5> 
<pre><code class="prism language-python"><span class="token comment">#在Scrapy的Downloader Middleware中间件里</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">def</span> <span class="token function">process_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        request<span class="token punctuation">.</span>meta<span class="token punctuation">[</span><span class="token string">'proxy'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'http://127.0.0.1:9743'</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<h4><a id="133_IP_3312"></a>13.3 免费代理IP的使用</h4> 
<ul><li>我们可以从互联网中获取免费的代理IP：如：西刺 <a href="http://www.xicidaili.com/" rel="nofollow">http://www.xicidaili.com</a></li></ul> 
<pre><code class="prism language-python"><span class="token keyword">import</span> requests<span class="token punctuation">,</span>random

<span class="token comment">#定义代理池</span>
proxy_list <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'182.39.6.245:38634'</span><span class="token punctuation">,</span>
    <span class="token string">'115.210.181.31:34301'</span><span class="token punctuation">,</span>
    <span class="token string">'123.161.152.38:23201'</span><span class="token punctuation">,</span>
    <span class="token string">'222.85.5.187:26675'</span><span class="token punctuation">,</span>
    <span class="token string">'123.161.152.31:23127'</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>

<span class="token comment"># 随机选择一个代理</span>
proxy <span class="token operator">=</span>  random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>proxy_list<span class="token punctuation">)</span>

proxies <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'http'</span><span class="token punctuation">:</span> <span class="token string">'http://'</span> <span class="token operator">+</span> proxy<span class="token punctuation">,</span>
    <span class="token string">'https'</span><span class="token punctuation">:</span> <span class="token string">'https://'</span> <span class="token operator">+</span> proxy<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'http://httpbin.org/get'</span><span class="token punctuation">,</span> proxies<span class="token operator">=</span>proxies<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
<span class="token keyword">except</span> requests<span class="token punctuation">.</span>exceptions<span class="token punctuation">.</span>ConnectionError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Error'</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>args<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="134_IP_3342"></a>13.4 收费代理IP的使用</h4> 
<ul><li>收费代理还是很多的如： 
  <ul><li>西刺：<a href="http://www.xicidaili.com/" rel="nofollow">http://www.xicidaili.com</a></li><li>讯代理：http://www.xdaili.cn/</li><li>快代理：https://www.kuaidaili.com/</li><li>大象代理：http://www.daxiangdaili.com/</li></ul> </li><li>在requests中使用收费代理</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">import</span> requests

<span class="token comment"># 从代理服务中获取一个代理IP</span>
proxy <span class="token operator">=</span>  requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"http://tvp.daxiangdaili.com/ip/?tid=559775358931681&amp;num=1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text
proxies <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'http'</span><span class="token punctuation">:</span> <span class="token string">'http://'</span> <span class="token operator">+</span> proxy<span class="token punctuation">,</span>
    <span class="token string">'https'</span><span class="token punctuation">:</span> <span class="token string">'https://'</span> <span class="token operator">+</span> proxy<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'http://httpbin.org/get'</span><span class="token punctuation">,</span> proxies<span class="token operator">=</span>proxies<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
<span class="token keyword">except</span> requests<span class="token punctuation">.</span>exceptions<span class="token punctuation">.</span>ConnectionError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Error'</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>args<span class="token punctuation">)</span>
</code></pre> 
<ul><li>在scrapy中使用收费代理</li><li>创建scrapy项目：scrapy startproject httpbin</li><li>创建爬虫文件： ```cd httpbin</li></ul> 
<p>scrapy genspider hb httpbin.org</p> 
<pre><code>​```python
#编写爬虫文件hb.py
import scrapy

class HbSpider(scrapy.Spider):
    name = 'hb'
    allowed_domains = ['httpbin.org']
    start_urls = ['http://httpbin.org/get']

    def parse(self, response):
        print(response.body)

#编写中间件文件：middlewares.py 
class HttpbinProxyMiddleware(object):
    def process_request(self, request, spider):
        pro_addr = requests.get('http://127.0.0.1:5000/get').text
        request.meta['proxy'] = 'http://' + pro_addr

#修改配置文件settings.py

ROBOTSTXT_OBEY = False #关闭爬虫协议

DOWNLOADER_MIDDLEWARES = {
   'httpbin.middlewares.HttpbinProxyMiddleware': 543,
}

#关闭终端输出，改输出到指定日志文件中
LOG_LEVEL= 'DEBUG'

LOG_FILE ='log.txt'
</code></pre> 
<ul><li>执行信息爬取测试： scrapy crawl hb</li></ul> 
<h3><a id="14__3408"></a>14. 使用代理爬取信息实战</h3> 
<h4><a id="141__3410"></a>14.1 实战目标：</h4> 
<ul><li>本节目标是利用代理爬取微信公众号的文章信息，从中提取标题、摘要、发布日期、公众号以及url地址等内容。</li><li>本节爬取的是搜索关键字为<code>python</code>的，类别为<code>微信</code>的所有文章信息，并将信息存储到MongoDB中。</li><li>URL地址：http://weixin.sogou.com/weixin?type=2&amp;query=python&amp;ie=utf8&amp;s_from=input</li></ul> 
<h4><a id="142__3416"></a>14.2 准备工作：</h4> 
<ul><li>首先对要爬取的微信公众号的文章信息进行分析，确定url地址。</li><li>分析要爬取的信息加载方式，确定属性普通加载（在响应里使用xpath或css解析）。</li><li>分析如何获取更多页信息的爬取。就是如何跳转下一页。(没有登录的用户只能看到10页，登陆后才可看到其他页)</li><li>本次案例需要使用的Python库：Scrapy、requests、pymongo。</li><li>在MongoDB中创建一个数据库<code>wenxin</code>，让后在此库中创建一个集合<code>wx</code>，最后开启MongoDB数据库</li></ul> 
<h4><a id="143__3424"></a>14.3 具体实现：</h4> 
<h5><a id="__3426"></a>① 创建项目</h5> 
<ul><li>首先新建项目，名为weixin：</li></ul> 
<pre><code>scrapy startproject weixin
</code></pre> 
<ul><li>进入项目weixin目录下，创建一个Spider（爬虫类wx）：</li></ul> 
<pre><code>cd weixin
scrapy genspider wx weixin.sogou.com
</code></pre> 
<ul><li>进入settings.py的配置文件：将ROBOTSTXT_OBEY改为false，忽略爬虫协议</li></ul> 
<pre><code>ROBOTSTXT_OBEY = False
</code></pre> 
<h5><a id="_Item_3447"></a>② 定义Item类</h5> 
<pre><code class="prism language-python"><span class="token comment"># 定义信息封装类（标题、摘要、公众号、时间、URL地址）</span>
<span class="token keyword">import</span> scrapy

<span class="token keyword">class</span> <span class="token class-name">WxItem</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Item<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># define the fields for your item here like:</span>
    collection <span class="token operator">=</span> ‘wx’
    title <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    content <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    nickname <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    date <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    url <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="__3463"></a>③ 解析页面</h5> 
<ul><li>进入spider/wx.py文件中编写，代码如下：</li></ul> 
<pre><code class="prism language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">import</span> scrapy
<span class="token keyword">from</span> weixin<span class="token punctuation">.</span>items <span class="token keyword">import</span> WxItem

<span class="token keyword">class</span> <span class="token class-name">WxSpider</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">'wx'</span>
    allowed_domains <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'weixin.sogou.com'</span><span class="token punctuation">]</span>
    start_urls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'http://weixin.sogou.com/weixin?query=python&amp;type=2&amp;page=1&amp;ie=utf8'</span><span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#解析出当前页面中的所有文章信息</span>
        ullist <span class="token operator">=</span> response<span class="token punctuation">.</span>selector<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">"ul.news-list li"</span><span class="token punctuation">)</span>
        <span class="token comment">#遍历文章信息</span>
        <span class="token keyword">for</span> ul <span class="token keyword">in</span> ullist<span class="token punctuation">:</span>
            <span class="token comment">#解析具体信息并封装到item中</span>
            item <span class="token operator">=</span> WxItem<span class="token punctuation">(</span><span class="token punctuation">)</span>
            item<span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ul<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">"h3 a"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>re_first<span class="token punctuation">(</span><span class="token string">"&lt;a.*?&gt;(.*?)&lt;/a&gt;"</span><span class="token punctuation">)</span>  
            item<span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ul<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">"p.txt-info::text"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span>
            item<span class="token punctuation">[</span><span class="token string">'nickname'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ul<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">"a.account::text"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span>
            item<span class="token punctuation">[</span><span class="token string">'date'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ul<span class="token punctuation">.</span>re_first<span class="token punctuation">(</span><span class="token string">"document.write\(timeConvert\('([0-9]+)'\)\)"</span><span class="token punctuation">)</span>
            item<span class="token punctuation">[</span><span class="token string">'url'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ul<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">"h3 a::attr(href)"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
            <span class="token comment"># 交给pipelines（item管道）处理</span>
            <span class="token keyword">yield</span> item

        <span class="token comment">#解析出下一頁的url地址</span>
        next_url <span class="token operator">=</span> response<span class="token punctuation">.</span>selector<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">"#sogou_next::attr(href)"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">#判断是否存在</span>
        <span class="token keyword">if</span> next_url<span class="token punctuation">:</span>
            url <span class="token operator">=</span> response<span class="token punctuation">.</span>urljoin<span class="token punctuation">(</span>next_url<span class="token punctuation">)</span> <span class="token comment">#构建绝对url地址</span>
            <span class="token keyword">yield</span> scrapy<span class="token punctuation">.</span>Request<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span>callback<span class="token operator">=</span>self<span class="token punctuation">.</span>parse<span class="token punctuation">)</span> <span class="token comment">#交给调度去继续爬取下一页信息</span>
</code></pre> 
<h5><a id="__3501"></a>④ 存储结果</h5> 
<pre><code class="prism language-python"><span class="token keyword">import</span> pymongo

<span class="token keyword">class</span> <span class="token class-name">MongoPipeline</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">''' 完成MongoDB数据库对Item信息的存储'''</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> mongo_uri<span class="token punctuation">,</span> mongo_db<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''对象初始化'''</span>
        self<span class="token punctuation">.</span>mongo_uri <span class="token operator">=</span> mongo_uri
        self<span class="token punctuation">.</span>mongo_db <span class="token operator">=</span> mongo_db

    @<span class="token builtin">classmethod</span>
    <span class="token keyword">def</span> <span class="token function">from_crawler</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> crawler<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''通过依赖注入方式实例化当前类，并返回，参数是从配置文件获取MongoDB信息'''</span>
        <span class="token keyword">return</span> cls<span class="token punctuation">(</span>mongo_uri<span class="token operator">=</span>crawler<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'MONGO_URI'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mongo_db<span class="token operator">=</span>crawler<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'MONGO_DB'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">open_spider</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''Spider开启自动调用此方法，负责连接MongoDB，并选择数据库'''</span>
        self<span class="token punctuation">.</span>client <span class="token operator">=</span> pymongo<span class="token punctuation">.</span>MongoClient<span class="token punctuation">(</span>self<span class="token punctuation">.</span>mongo_uri<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>db <span class="token operator">=</span> self<span class="token punctuation">.</span>client<span class="token punctuation">[</span>self<span class="token punctuation">.</span>mongo_db<span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">process_item</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> item<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''选择对应集合并写入Item信息'''</span>
        self<span class="token punctuation">.</span>db<span class="token punctuation">[</span>item<span class="token punctuation">.</span>collection<span class="token punctuation">]</span><span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> item

    <span class="token keyword">def</span> <span class="token function">close_spider</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''Spider关闭时自动调用，负责关闭MongoDB的连接'''</span>
        self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li>修改配置文件settings.py信息：（开启MongoPipeline管道类，设置MongoDB的连接信息）</li></ul> 
<pre><code class="prism language-python">ITEM_PIPELINES <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'scrapyseleniumtest.pipelines.MongoPipeline'</span><span class="token punctuation">:</span> <span class="token number">300</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

MONGO_URI <span class="token operator">=</span> <span class="token string">'localhost'</span>

MONGO_DB <span class="token operator">=</span> <span class="token string">'taobao'</span>
</code></pre> 
<h5><a id="__3546"></a>⑤ 执行爬虫文件开始信息爬取</h5> 
<pre><code>scrapy crawl wx
</code></pre> 
<ul><li>注意：当前爬取信息过多时会报如下302错误：</li></ul> 
<pre><code>2018-05-30 22:40:10 [scrapy.downloadermiddlewares.redirect] DEBUG: Redirecting (
302) to &lt;GET http://weixin.sogou.com/antispider/?from=%2fweixin%3Fquery%3dpython
%26type%3d2%26page%3d1%26ie%3dutf8&gt; from &lt;GET http://weixin.sogou.com/weixin?que
ry=python&amp;type=2&amp;page=1&amp;ie=utf8&gt;
</code></pre> 
<p><img src="https://images2.imgbox.com/6f/89/gNPVznPM_o.png" alt="img">]</p> 
<h5><a id="__3563"></a>⑥ 在中间件中使用付费代理服务来解决上面错误：</h5> 
<pre><code class="prism language-python"><span class="token comment"># 在middlewares.py文件中定义一个Downloader中间件</span>
<span class="token keyword">import</span> requests
<span class="token keyword">class</span> <span class="token class-name">HttpbinProxyMiddleware</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">process_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        pro_addr <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'http://tvp.daxiangdaili.com/ip/?tid=559775358931681&amp;num=1'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text
        request<span class="token punctuation">.</span>meta<span class="token punctuation">[</span><span class="token string">'proxy'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'http://'</span> <span class="token operator">+</span> pro_addr
        <span class="token comment"># 设置启动上面我们写的这个代理</span>

<span class="token comment">#在settings.py配置文件中.设置我们自定义的Downloader MiddleWares中间件设置：</span>
DOWNLOADER_MIDDLEWARES <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
   <span class="token string">'httpbin.middlewares.HttpbinProxyMiddleware'</span><span class="token punctuation">:</span> <span class="token number">543</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>练习：没有登录的用户只能看到10页，登陆后才可看到其他页，那么如何实现爬取更多页信息呢？</strong></p> 
<h3><a id="15_Redis_3582"></a>15. Redis数据库</h3> 
<h4><a id="151_Redis_3584"></a>15.1 Redis简介</h4> 
<ul><li>Redis是完全开源免费的，遵守BSD协议，是一个高性能的key-value数据库。</li><li>Redis与其他 key - value 缓存产品有以下三个特点： 
  <ul><li>Redis支持数据的持久化，可以将内存中的数据保存在磁盘中，重启后可以再次加载进行使用。</li><li>Redis不仅仅支持简单的key-value类型(hash)的数据，同时还提供包括string(字符串)、list(链表)、set(集合)和sorted set(有序集合)。</li><li>Redis支持数据的备份，即master-slave模式的数据备份。</li></ul> </li><li>Redis是一个高性能的key-value数据库。 
  <ul><li>Redis的出现，很大程度补偿了memcached这类key/value存储的不足，在部分场合可以对关系数据库起到很好的补充作用。</li><li>它提供了Python，Ruby，Erlang，PHP客户端，使用很方便。</li></ul> </li><li>Redis优势: 
  <ul><li>性能极高 – Redis能读的速度是110000次/s,写的速度是81000次/s 。</li><li>丰富的数据类型 – Redis支持二进制案例的Strings,Lists,Hashes,Sets及Ordered Sets数据类型操作。</li><li>原子 – Redis的所有操作都是原子性的，意思就是要么成功执行要么失败完全不执行。单个操作是原子性的。多个操作也支持事务，即原子性，通过MULTI和EXEC指令包起来。</li><li>丰富的特性 – Redis还支持 publish/subscribe, 通知, key 过期等等特性。</li></ul> </li></ul> 
<h4><a id="152_Redis_3600"></a>15.2 Redis的安装：</h4> 
<ul><li>官方网站：<a href="https://redis.io/" rel="nofollow">https://redis.io</a></li><li>官方文档：https://redis.io/documentation</li><li>中文官网：<a href="http://www.redis.cn/" rel="nofollow">http://www.redis.cn</a></li><li>GitHub：https://github.com/antirez/redis</li><li>可视化管理工具：https://redisdesktop.com/download</li><li>windows下安装地址：https://github.com/MSOpenTech/redis/releases 
  <ul><li>可下载：Redis-x64-3.2.100.msi 直接next按钮安装即可</li><li>配置文件：redis.windows-service.conf</li></ul> </li><li>Liunx下的安装：（如 ubuntu）</li></ul> 
<pre><code>安装命令： sudo apt-get -y install redis-server

进入命令行模式：
$ redis-cli
127.0.0.1:6379&gt; set 'name' 'zhangsan'
ok
127.0.0.1:6379&gt; get 'name'
"zhangsan"

启停Redis服务：
sudo /etc/init.d/redis-server start
sudo /etc/init.d/redis-server stop
sudo /etc/init.d/redis-server restart
</code></pre> 
<ul><li>Mac下的安装：</li></ul> 
<pre><code>安装命令：brew install redis

启停服务：
brew services start redis
brew services stop redis
brew services restart redis

配置文件：
/usr/local/etc/redis.conf
</code></pre> 
<ul><li>redis-py的安装:(python操作redis)</li></ul> 
<pre><code>pip install redis
</code></pre> 
<h4><a id="153_Redis_3648"></a>15.3 Redis的操作：</h4> 
<ul><li>Redis的数据类型： 
  <ul><li>共计5种类型：string(字符串)、hash(哈希表) list(双向链表)、set(集合)和sorted set(有序集合)</li></ul> </li></ul> 
<h5><a id="_String_3653"></a>① String（子串类型）</h5> 
<pre><code>   set命令：设置一个键和值，键存在则只覆盖，返回ok
   &gt; set 键  值    例如： &gt;set name zhangsan

   get命令：获取一个键的值，返回值
   &gt; get 键     例如：&gt;get name

   setnx命令：设置一个不存在的键和值（防止覆盖），
   &gt; setnx 键 值      若键已存在则返回0表示失败

   setex命令：设置一个指定有效期的键和值（单位秒）
   &gt; setex 键 [有效时间] 值  例如: &gt;setex color 10 red 
    不写有效时间则表示永久有效，等价于set

   setrange命令：替换子字符串 (替换长度由子子串长度决定)
   &gt; setrange 键 位置 子字串  
   &gt; setrange name 4 aa  将name键对应值的第4个位置开始替换

   mset命令：批量设置键和值,成功则返回ok
   &gt; mset 键1 值1 键2 值2 键3 值3 ....

   msetnx命令：批量设置不存在的键和值,成功则返回ok
   &gt; msetnx 键1 值1 键2 值2 键3 值3 ....

   getset命令：获取原值，并设置新值

   getrange命令：获取指定范围的值
   &gt;getrange 键 0,4     //获取指定0到4位置上的值

   mget命令： 批量获取值
   &gt;mget 键1 键2 键3....

   incr命令： 指定键的值做加加操作，返回加后的结果。
   &gt;  键        例如： &gt;incr kid
   incrby命令： 设置某个键加上指定值
   &gt; incrby 键 m    //其中m可以是正整数或负整数

   decr命令： 指定键的值做减减操作，返回减后的结果。
   &gt; decr 键        例如： &gt;decr kid
   decrby命令： 设置某个键减上指定值
   &gt; decrby 键 m    //其中m可以是正整数或负整数

   append命令：给指定key的字符串追加value，返回新字符串值的长度
   &gt;append 键 追加字串

   strlen求长度 &gt;strlen 键名   //返回对应的值。
</code></pre> 
<h5><a id="_hash_3703"></a>② hash类型：</h5> 
<pre><code>  hset命令：设置一个哈希表的键和值
  &gt;hset hash名 键  值
  如：&gt;hset user:001 name zhangsan

  hsetnx命令：设置一个哈希表中不存在的键和值
  &gt;hsetnx hash名 键  值  //成功返回1，失败返回0
  如：&gt;hsetnx user:001 name zhangsan

  hmset命令： 批量设置

  hget命令： 获取执行哈希名中的键对应值

  hexists user:001 name //是否存在， 若存在返回1

  hlen user:001  //获取某哈希user001名中键的数量 

  hdel user:001 name //删除哈希user:001 中name键

  hkeys user:002   //返回哈希名为user:002中的所有键。
  hvals user:002   //返回哈希名为user:002中的所有值。
  hgetall user:002 //返回哈希名为user:002中的所有键和值。
</code></pre> 
<h5><a id="_list_3729"></a>③ list类型（双向链表结构）</h5> 
<ul><li>list即可以作为“栈”也可以作为"队列"。</li></ul> 
<pre><code> &gt;lpush list1 "world"  //在list1头部压入一个字串
 &gt;lpush list1 "hello"  // 在list1头部压入一个字串
 &gt;lrange list1 0 -1  //获取list1中内容
    0:表示开头  -1表示结尾。

 &gt;rpush list2 "world"  //在list2尾部压入一个字串
 &gt;rpush list2 "hello"  // 在list2尾部压入一个字串
 &gt;lrange list2 0 -1  //获取list2中内容
    0:表示开头  -1表示结尾。

 &gt;linsert list2 before "hello" "there"
 在key对应list的特定位置前或后添加字符串

 &gt;lset list2 1 "four"
 修改指定索引位置上的值

 &gt;lrem list2 2 "hello"  //删除前两个hello值
 &gt;lrem list2 -2 "hello" //删除后两个hello值
 &gt;lrem list2 0 "hello"  //删除所有hello值    

 &gt;ltrim mylist8 1 -1    //删除此范围外的值

 &gt;lpop list2   //从list2的头部删除元素，并返回删除元素
 &gt;rpop list2   //从list2的尾部删除元素，并返回删除元素
 &gt;rpoplpush list1 list2 //将list1的尾部一个元素移出到list2头部。并返回

 &gt;lindex list2 1 //返回list2中索引位置上的元素
 &gt;llen list2 //返回list2上长度
</code></pre> 
<h5><a id="_sets_3764"></a>④ sets类型和操作：</h5> 
<ul><li>Redis 的 Set 是 String 类型的无序集合。集合成员是唯一的，这就意味着集合中不能出现重复的数据。</li><li>集合中最大的成员数为 232 - 1 (4294967295, 每个集合可存储40多亿个成员)。</li></ul> 
<pre><code> &gt;sadd myset "hello" //向myset中添加一个元素
  成功返回1，失败(重复)返回0

 &gt;smembers myset //获取myset中的所有元素

 &gt;srem myset "one" //从myset中删除一个one
  成功返回1，失败(不存在)返回0

 &gt;spop myset //随机返回并删除myset中的一个元素

 &gt;sdiff myset1 myset2 //返回两个集合的差集
 以myset1为标准，获取myset2中不存在的。

 &gt; sinter myset2 myset3 交集

 &gt; sunion myset2 myset3 并集

 &gt; scard myset2 返回元素个数

 &gt; sismember myset2 two 判断myset2中是否包含two
</code></pre> 
<h5><a id="_sorted_set_3792"></a>⑤ 有序集合(sorted set)：</h5> 
<ul><li>Redis 有序集合和集合一样也是string类型元素的集合,且不允许重复的成员。</li><li>不同的是每个元素都会关联一个double类型的分数。redis正是通过分数来为集合中的成员进行从小到大的排序。</li></ul> 
<pre><code>向名称为 key 的 zset 中添加元素 member,score 用于排序。如果该元素已经存在,则根据 score 更新该元素的顺序
redis 127.0.0.1:6379&gt; zadd myzset 1 "one" 添加 
(integer) 1

redis 127.0.0.1:6379&gt; zadd myzset 2 "two" 
(integer) 1

redis 127.0.0.1:6379&gt; zadd myzset 3 "two"
(integer) 0

redis 127.0.0.1:6379&gt; zrange myzset 0 -1 withscores  查看
1) "one"  
2) "1"
3) "two"
4) "3"

redis 127.0.0.1:6379&gt; zrem myzset two  删除
(integer) 1
redis 127.0.0.1:6379&gt; zrange myzset 0 -1 withscores  查看
1) "one"
2) "1"

redis 127.0.0.1:6379&gt;
</code></pre> 
<h5><a id="_Redis_3823"></a>⑥ Redis常用命令：</h5> 
<pre><code> 1. 键值相关命令
 &gt;keys *  //返回键（key）
 &gt;keys list*   //返回名以list开头的所有键（key）
 &gt;exists list1  //判断键名为list1的是否存在
        存在返回1， 不存在返回0
 &gt;del list1 //删除一个键（名为list1）
 &gt;expire list1 10 //设置键名为list1的过期时间为10秒后
 &gt;ttl list1 //查看键名为list1的过期时间，若为-1表示以过期

 &gt;move age 1 //将键名age的转移到1数据库中。
 &gt;select 1 //表示进入到1数据库中，默认在0数据库 

 &gt;persist age //移除age的过期时间（设置为过期）
</code></pre> 
<h4><a id="154_Redis_3841"></a>15.4 Redis高级实用特性</h4> 
<pre><code> 1. 安全性：为Redis添加密码
-------------------------------
   1.进入配置文件：
     vi /usr/local/redis/etc/redis.conf
     设置：requirepass redis的密码
   2. 重启服务：
    # ./redis-cli shutdown 执行关闭
    # ./redis-server /usr/local/redis/etc/redis.conf  启动 
   3. 登录（两种）
    # ./redis-cli 客户端命令链接服务器
    &gt;auth 密码值  //授权后方可使用

    # ./redis-cli -a  密码 //连接时指定密码来进行授权


 2. 主从复制
------------------------------------------
    操作步骤：
     1.先将linux虚拟机关闭，之后克隆一个。
     2.启动两个虚拟机：master（主）和slave（从）
     3. 在slave（从）中配置一下ip地址
        # ifconfig eth0 192.168.128.229
        # ping 一下看看通不通。
     4. 配置从机
        进入：配置文件
        slaveof  192.168.128.228 6379   //配置连接主机的Redis的ip和端口
        masterauth 密码  //配置连接密码

        最后启动slave（从）机的Redis服务。

     其他：可以通过info命令中的role属性查看自己角色是master、slave


 3. 事务处理
--------------------------------------------
 &gt;multi   //开启一个事务
 &gt;set age 10 //暂存指令队列
 &gt;set age 20
 &gt;exec    //开始执行（提交事务）
 或&gt;discard //清空指令队列（事务回滚）

 4. 乐观锁
-----------------------------------
  在事务前对被操作的属性做一个：
 &gt; watch age
 &gt;multi   //开启一个事务(在此期间有其他修改，则此处会失败)
 &gt;set age 10 //暂存指令队列
 &gt;set age 20
 &gt;exec    //开始执行（提交事务）
 或&gt;discard //清空指令队列（事务回滚）

 5. 持久化机制(通过修改配置文件做设置)
-----------------------------------
   1. snapshotting(快照)默认方式
      配置    save
        save 900 1 #900秒内如果超过1个key被修改，则发起快照保存
        save 300 10 #300秒内容如超过10个key被修改，则发起快照保存
        save 60 10000
   2. Append-only file（aof方式）
      配置 appendonly on 改为yes
      会在bin目录下产生一个.aof的文件

   关于aof的配置  
    appendonly yes //启用aof 持久化方式 
    # appendfsync always //收到写命令就立即写入磁盘，最慢，但是保证完全的持久化 
    appendfsync everysec //每秒钟写入磁盘一次，在性能和持久化方面做了很好的折中 
    # appendfsync no //完全依赖os，性能最好,持久化没保证  

  6.  发布及订阅消息
----------------------
    需要开启多个会话端口
    会话1：&gt;subscribe tv1      //监听tv1频道
    会话2：&gt;subscribe tv1 tv2  //监听tv1和tv2频道
    会话3: &gt;publish tv1 消息   //向tv1频道发送一个消息

 7. 使用虚拟内存
-------------------------------
  在redis配置文件中设置
    vm-enabled yes          #开启vm功能
    vm-swap-file  /tmp/redis.swap   #交换出来的value保存的文件路径
    vm-max-memory 1000000   #redis使用的最大内存上限
    vm-page-size 32         #每个页面的大小32字节
    vm-pages 134217728      #最多使用多少页面
    vm-max-threads 4        #用于执行value对象换入患处的工作线程数量
</code></pre> 
<h4><a id="155_PythonRedis_3930"></a>15.5 Python使用Redis</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> redis 

<span class="token comment"># host是redis主机，需要redis服务端和客户端都启动 redis默认端口是6379</span>
r <span class="token operator">=</span> redis<span class="token punctuation">.</span>Redis<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'localhost'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">6379</span><span class="token punctuation">,</span> decode_responses<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token comment"># 字串操作</span>
r<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'junxi'</span><span class="token punctuation">)</span>  <span class="token comment"># key是"foo" value是"bar" 将键值对存入redis缓存</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 取出键name对应的值</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 如果键fruit不存在，那么输出是True；如果键fruit已经存在，输出是None</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token string">'fruit'</span><span class="token punctuation">,</span> <span class="token string">'watermelon'</span><span class="token punctuation">,</span> nx<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment"># True--不存在</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>setnx<span class="token punctuation">(</span><span class="token string">'fruit1'</span><span class="token punctuation">,</span> <span class="token string">'banana'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># fruit1不存在，输出为True</span>

<span class="token comment">#设置过期时间</span>
r<span class="token punctuation">.</span>setex<span class="token punctuation">(</span><span class="token string">"fruit2"</span><span class="token punctuation">,</span> <span class="token string">"orange"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'fruit2'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 5秒后，取值就从orange变成None</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>mget<span class="token punctuation">(</span><span class="token string">"fruit"</span><span class="token punctuation">,</span> <span class="token string">"fruit1"</span><span class="token punctuation">,</span> <span class="token string">"fruit2"</span><span class="token punctuation">,</span> <span class="token string">"k1"</span><span class="token punctuation">,</span> <span class="token string">"k2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 将目前redis缓存中的键对应的值批量取出来</span>
</code></pre> 
<h5><a id="redishash_3957"></a>redis操作hash哈希</h5> 
<pre><code class="prism language-python">r<span class="token punctuation">.</span>hset<span class="token punctuation">(</span><span class="token string">"hash1"</span><span class="token punctuation">,</span> <span class="token string">"k1"</span><span class="token punctuation">,</span> <span class="token string">"v1"</span><span class="token punctuation">)</span>
r<span class="token punctuation">.</span>hset<span class="token punctuation">(</span><span class="token string">"hash1"</span><span class="token punctuation">,</span> <span class="token string">"k2"</span><span class="token punctuation">,</span> <span class="token string">"v2"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>hkeys<span class="token punctuation">(</span><span class="token string">"hash1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 取hash中所有的key</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>hget<span class="token punctuation">(</span><span class="token string">"hash1"</span><span class="token punctuation">,</span> <span class="token string">"k1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment"># 单个取hash的key对应的值</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>hmget<span class="token punctuation">(</span><span class="token string">"hash1"</span><span class="token punctuation">,</span> <span class="token string">"k1"</span><span class="token punctuation">,</span> <span class="token string">"k2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 多个取hash的key对应的值</span>
r<span class="token punctuation">.</span>hsetnx<span class="token punctuation">(</span><span class="token string">"hash1"</span><span class="token punctuation">,</span> <span class="token string">"k2"</span><span class="token punctuation">,</span> <span class="token string">"v3"</span><span class="token punctuation">)</span> <span class="token comment"># 只能新建</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>hget<span class="token punctuation">(</span><span class="token string">"hash1"</span><span class="token punctuation">,</span> <span class="token string">"k2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">#hash的批量操作</span>
r<span class="token punctuation">.</span>hmset<span class="token punctuation">(</span><span class="token string">"hash2"</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token string">"k2"</span><span class="token punctuation">:</span> <span class="token string">"v2"</span><span class="token punctuation">,</span> <span class="token string">"k3"</span><span class="token punctuation">:</span> <span class="token string">"v3"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>hget<span class="token punctuation">(</span><span class="token string">"hash2"</span><span class="token punctuation">,</span> <span class="token string">"k2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 单个取出"hash2"的key-k2对应的value</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>hmget<span class="token punctuation">(</span><span class="token string">"hash2"</span><span class="token punctuation">,</span> <span class="token string">"k2"</span><span class="token punctuation">,</span> <span class="token string">"k3"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 批量取出"hash2"的key-k2 k3对应的value --方式1</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>hmget<span class="token punctuation">(</span><span class="token string">"hash2"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"k2"</span><span class="token punctuation">,</span> <span class="token string">"k3"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 批量取出"hash2"的key-k2 k3对应的value --方式2</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>hgetall<span class="token punctuation">(</span><span class="token string">"hash1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#取出所有的键值对</span>
</code></pre> 
<h5><a id="redislist_3976"></a>redis操作list链表</h5> 
<pre><code class="prism language-python">r<span class="token punctuation">.</span>lpush<span class="token punctuation">(</span><span class="token string">"list1"</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>lrange<span class="token punctuation">(</span><span class="token string">'list1'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

r<span class="token punctuation">.</span>rpush<span class="token punctuation">(</span><span class="token string">"list2"</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">)</span>  <span class="token comment"># 表示从右向左操作</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>llen<span class="token punctuation">(</span><span class="token string">"list2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 列表长度</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>lrange<span class="token punctuation">(</span><span class="token string">"list2"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 切片取出值，范围是索引号0-3</span>

r<span class="token punctuation">.</span>rpush<span class="token punctuation">(</span><span class="token string">"list2"</span><span class="token punctuation">,</span> <span class="token number">44</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">66</span><span class="token punctuation">)</span>    <span class="token comment"># 在列表的右边，依次添加44,55,66</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>llen<span class="token punctuation">(</span><span class="token string">"list2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 列表长度</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>lrange<span class="token punctuation">(</span><span class="token string">"list2"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 切片取出值，范围是索引号0到-1(最后一个元素)</span>

r<span class="token punctuation">.</span>lset<span class="token punctuation">(</span><span class="token string">"list2"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">11</span><span class="token punctuation">)</span>    <span class="token comment"># 把索引号是0的元素修改成-11</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>lrange<span class="token punctuation">(</span><span class="token string">"list2"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

r<span class="token punctuation">.</span>lrem<span class="token punctuation">(</span><span class="token string">"list2"</span><span class="token punctuation">,</span> <span class="token string">"11"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>    <span class="token comment"># 将列表中左边第一次出现的"11"删除</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>lrange<span class="token punctuation">(</span><span class="token string">"list2"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
r<span class="token punctuation">.</span>lrem<span class="token punctuation">(</span><span class="token string">"list2"</span><span class="token punctuation">,</span> <span class="token string">"99"</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token comment"># 将列表中右边第一次出现的"99"删除</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>lrange<span class="token punctuation">(</span><span class="token string">"list2"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
r<span class="token punctuation">.</span>lrem<span class="token punctuation">(</span><span class="token string">"list2"</span><span class="token punctuation">,</span> <span class="token string">"22"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token comment"># 将列表中所有的"22"删除</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>lrange<span class="token punctuation">(</span><span class="token string">"list2"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

r<span class="token punctuation">.</span>lpop<span class="token punctuation">(</span><span class="token string">"list2"</span><span class="token punctuation">)</span>    <span class="token comment"># 删除列表最左边的元素，并且返回删除的元素</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>lrange<span class="token punctuation">(</span><span class="token string">"list2"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
r<span class="token punctuation">.</span>rpop<span class="token punctuation">(</span><span class="token string">"list2"</span><span class="token punctuation">)</span>    <span class="token comment"># 删除列表最右边的元素，并且返回删除的元素</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>lrange<span class="token punctuation">(</span><span class="token string">"list2"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>lindex<span class="token punctuation">(</span><span class="token string">"list2"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 取出索引号是0的值</span>
</code></pre> 
<h5><a id="redisset_4008"></a>redis操作set集合</h5> 
<pre><code class="prism language-python"><span class="token comment">#新增</span>
r<span class="token punctuation">.</span>sadd<span class="token punctuation">(</span><span class="token string">"set1"</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">,</span> <span class="token number">44</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">66</span><span class="token punctuation">)</span>  <span class="token comment"># 往集合中添加元素</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>scard<span class="token punctuation">(</span><span class="token string">"set1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 集合的长度是4</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>smembers<span class="token punctuation">(</span><span class="token string">"set1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment"># 获取集合中所有的成员</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>sscan<span class="token punctuation">(</span><span class="token string">"set1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#获取集合中所有的成员--元组形式</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> r<span class="token punctuation">.</span>sscan_iter<span class="token punctuation">(</span><span class="token string">"set1"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>

<span class="token comment">#差集</span>
r<span class="token punctuation">.</span>sadd<span class="token punctuation">(</span><span class="token string">"set2"</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>smembers<span class="token punctuation">(</span><span class="token string">"set1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment"># 获取集合中所有的成员</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>smembers<span class="token punctuation">(</span><span class="token string">"set2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>sdiff<span class="token punctuation">(</span><span class="token string">"set1"</span><span class="token punctuation">,</span> <span class="token string">"set2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment"># 在集合set1但是不在集合set2中</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>sdiff<span class="token punctuation">(</span><span class="token string">"set2"</span><span class="token punctuation">,</span> <span class="token string">"set1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment"># 在集合set2但是不在集合set1中</span>
</code></pre> 
<h3><a id="16__4029"></a>16. 分布式爬虫原理</h3> 
<ul><li>在前面我们已经掌握了Scrapy框架爬虫，虽然爬虫是异步多线程的，但是我们只能在一台主机上运行，爬取效率还是有限。</li><li>分布式爬虫则是将多台主机组合起来，共同完成一个爬取任务，将大大提高爬取的效率。</li></ul> 
<h4><a id="161__4034"></a>16.1 分布式爬虫架构</h4> 
<ul><li>回顾Scrapy的架构： 
  <ul><li>Scrapy单机爬虫中有一个本地爬取队列Queue，这个队列是利用deque模块实现的。</li><li>如果有新的Request产生，就会放到队列里面，随后Request被Scheduler调度。</li><li>之后Request交给Downloader执行爬取，这就是简单的调度架构。</li></ul> </li><li>我们需要做的就是在多台主机上同时运行爬虫任务</li></ul> 
<p><img src="https://images2.imgbox.com/9e/be/pRnbGzSf_o.png" alt="img">]</p> 
<h4><a id="162__4044"></a>16.2 维护爬取队列</h4> 
<ul><li>关于爬取队列我们自然想到的是基于内存存储的Redis。它支持多种数据结构，如：列表、集合、有序集合等,存取的操作也非常简单。</li><li>Redis支持的这几种数据结构，在存储中都有各自优点： 
  <ul><li>列表(list)有lpush()、lpop()、rpush()、rpop()方法，可以实现先进先出的队列和先进后出的栈式爬虫队列。</li><li>集合(set)的元素是无序且不重复的，这样我们可以非常方便的实现随机且不重复的爬取队列。</li><li>有序集合有分数表示，而Scrapy的Request也有优先级的控制，我们可以用它来实现带优先级调度的队列。</li></ul> </li></ul> 
<h4><a id="163__4052"></a>16.3 如何去重</h4> 
<ul><li>Scrapy有自动去重，它的去重使用了Python中的集合实现。用它记录了Scrapy中每个Request的指纹（Request的散列值）。</li><li>对于分布式爬虫来说，我们肯定不能再用每个爬虫各自的集合来去重了，因为不能共享，各主机之间就无法做到去重了。</li><li>可以使用Redis的集合来存储指纹集合，那么这样去重集合也是利用Redis共享的。</li><li>每台主机只要将新生成Request的指纹与集合比对，判断是否重复并选择添加入到其中。即实例了分布式Request的去重。</li></ul> 
<h4><a id="164__4059"></a>16.4 防止中断</h4> 
<ul><li> <p>在Scrapy中，爬虫运行时的Request队列放在内存中。爬虫运行中断后，这个队列的空间就会被释放，导致爬取不能继续。</p> </li><li> <p>要做到中断后继续爬取，我们可以将队列中的Request保存起来，下次爬取直接读取保存的数据既可继续上一次爬取的队列。</p> </li><li> <p>在Scrapy中制定一个爬取队列的存储路径即可，这个路径使用</p> <pre><code>JOB_DIR
</code></pre> <p>变量来标识，命令如下：</p> <pre><code>scrapy crawl spider -s JOB_DIR=crawls/spider
</code></pre> </li><li> <p>更多详细使用请详见官方文档：http://doc.scrapy.org/en/latest/topics/jobs.html</p> </li><li> <p>在Scrapy中，我们实际是把爬取队列保存到本地，第二次爬取直接读取并恢复队列既可。</p> </li><li> <p>在分布式框架中就不用担心这个问题了，因为爬取队列本身就是用数据库存储的，中断后再启动就会接着上次中断的地方继续爬取。</p> </li><li> <p>当Redis的队列为空时，爬虫会重新爬取；当队列不为空时，爬虫便会接着上次中断支处继续爬取。</p> </li></ul> 
<h4><a id="165__4085"></a>16.5 架构实现</h4> 
<ul><li>首先实现一个共享的爬取队列，还要实现去重的功能。</li><li>重写一个Scheduer的实现，使之可以从共享的爬取队列存取Request</li><li>幸运的是，我们可以下载一个现成 <code>Scrapy-Redis</code> 分布式爬虫的开源包，直接使用就可以很方便实现分布式爬虫。</li></ul> 
<h3><a id="17_Scrapy_4091"></a>17. Scrapy分布式实战</h3> 
<ul><li>Scrapy-Redis则是一个基于Redis的Scrapy分布式组件。它利用Redis对用于爬取的请求(Requests)进行存储和调度(Schedule)，并对爬取产生的项目(items)存储以供后续处理使用。</li><li>scrapy-redi重写了scrapy一些比较关键的代码，将scrapy变成一个可以在多个主机上同时运行的分布式爬虫。</li></ul> 
<p><img src="https://images2.imgbox.com/df/71/Jt7W7tuY_o.png" alt="img">]</p> 
<h4><a id="171__4098"></a>17.1 准备</h4> 
<ul><li> <p>既然这么好能实现分布式爬取，那都需要准备什么呢？</p> </li><li> <p>需要准备的东西比较多，都有：</p> 
  <ul><li>scrapy</li><li>scrapy-redis</li><li>redis</li><li>mysql</li><li>python的mysqldb模块</li><li>python的redis模块</li></ul> </li><li> <p>为什么要有mysql呢？是因为我们打算把收集来的数据存放到mysql中</p> </li><li> <p>安装：</p> <pre><code>$ pip install scrapy-redis    
$ pip install redis
</code></pre> </li><li> <p>Scrapy-Redis的官方网址：https://github.com/rmax/scrapy-redis</p> </li></ul> 
<h4><a id="172_Scrapyredis_4122"></a>17.2 Scrapy-redis各个组件介绍</h4> 
<h5><a id="_connectionpy_4124"></a>① connection.py</h5> 
<ul><li>负责根据setting中配置实例化redis连接。被dupefilter和scheduler调用，总之涉及到redis存取的都要使用到这个模块。</li></ul> 
<h5><a id="_dupefilterpy_4128"></a>② dupefilter.py</h5> 
<ul><li>负责执行requst的去重，实现的很有技巧性，使用redis的set数据结构。</li><li>但是注意scheduler并不使用其中用于在这个模块中实现的dupefilter键做request的调度，而是使用queue.py模块中实现的queue。</li><li>当request不重复时，将其存入到queue中，调度时将其弹出。</li></ul> 
<h5><a id="_queuepy_4134"></a>③ queue.py</h5> 
<ul><li>其作用如II所述，但是这里实现了三种方式的queue：</li><li>FIFO的SpiderQueue，SpiderPriorityQueue，以及LIFI的SpiderStack。默认使用的是第二中，这也就是出现之前文章中所分析情况的原因（链接）。</li></ul> 
<h5><a id="_pipelinespy_4139"></a>④ pipelines.py</h5> 
<ul><li>这是是用来实现分布式处理的作用。它将Item存储在redis中以实现分布式处理。</li><li>另外可以发现，同样是编写pipelines，在这里的编码实现不同于文章（链接：）中所分析的情况，由于在这里需要读取配置，所以就用到了from_crawler()函数。</li></ul> 
<h5><a id="_schedulerpy_4144"></a>⑤ scheduler.py</h5> 
<ul><li>此扩展是对scrapy中自带的scheduler的替代（在settings的SCHEDULER变量中指出），正是利用此扩展实现crawler的分布式调度。其利用的数据结构来自于queue中实现的数据结构。</li><li>scrapy-redis所实现的两种分布式：爬虫分布式以及item处理分布式就是由模块scheduler和模块pipelines实现。上述其它模块作为为二者辅助的功能模块。</li></ul> 
<h5><a id="_spiderpy_4149"></a>⑥ spider.py</h5> 
<ul><li>设计的这个spider从redis中读取要爬的url,然后执行爬取，若爬取过程中返回更多的url，那么继续进行直至所有的request完成。之后继续从redis中读取url，循环这个过程。</li></ul> 
<h4><a id="173_Scrapy_4153"></a>17.3 具体使用(对Scrapy改造)：</h4> 
<h5><a id="1settingspyredisscrapyredis__4155"></a>1.首先在settings.py中配置redis（在scrapy-redis 自带的例子中已经配置好）</h5> 
<pre><code class="prism language-python">   <span class="token comment"># 指定使用scrapy-redis的去重</span>
   DUPEFILTER_CLASS <span class="token operator">=</span> <span class="token string">'scrapy_redis.dupefilters.RFPDupeFilter'</span>

   <span class="token comment"># 指定使用scrapy-redis的调度器</span>
   SCHEDULER <span class="token operator">=</span> <span class="token string">"scrapy_redis.scheduler.Scheduler"</span>

   <span class="token comment"># 在redis中保持scrapy-redis用到的各个队列，从而允许暂停和暂停后恢复，也就是不清理redis queues</span>
   SCHEDULER_PERSIST <span class="token operator">=</span> <span class="token boolean">True</span>

   <span class="token comment"># 指定排序爬取地址时使用的队列，</span>
   <span class="token comment"># 默认的 按优先级排序(Scrapy默认)，由sorted set实现的一种非FIFO、LIFO方式。</span>
   SCHEDULER_QUEUE_CLASS <span class="token operator">=</span> <span class="token string">'scrapy_redis.queue.SpiderPriorityQueue'</span>

   REDIS_URL <span class="token operator">=</span> <span class="token boolean">None</span> <span class="token comment"># 一般情况可以省去</span>
   REDIS_HOST <span class="token operator">=</span> <span class="token string">'127.0.0.1'</span> <span class="token comment"># 也可以根据情况改成 localhost</span>
   REDIS_PORT <span class="token operator">=</span> <span class="token number">6379</span>
</code></pre> 
<h5><a id="2itempy_4176"></a>2.item.py的改造</h5> 
<pre><code class="prism language-python"><span class="token keyword">from</span> scrapy<span class="token punctuation">.</span>item <span class="token keyword">import</span> Item<span class="token punctuation">,</span> Field
<span class="token keyword">from</span> scrapy<span class="token punctuation">.</span>loader <span class="token keyword">import</span> ItemLoader
<span class="token keyword">from</span> scrapy<span class="token punctuation">.</span>loader<span class="token punctuation">.</span>processors <span class="token keyword">import</span> MapCompose<span class="token punctuation">,</span> TakeFirst<span class="token punctuation">,</span> Join

<span class="token keyword">class</span> <span class="token class-name">ExampleItem</span><span class="token punctuation">(</span>Item<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    description <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    link <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    crawled <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    spider <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    url <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">ExampleLoader</span><span class="token punctuation">(</span>ItemLoader<span class="token punctuation">)</span><span class="token punctuation">:</span>
    default_item_class <span class="token operator">=</span> ExampleItem
    default_input_processor <span class="token operator">=</span> MapCompose<span class="token punctuation">(</span><span class="token keyword">lambda</span> s<span class="token punctuation">:</span> s<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    default_output_processor <span class="token operator">=</span> TakeFirst<span class="token punctuation">(</span><span class="token punctuation">)</span>
    description_out <span class="token operator">=</span> Join<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="3spiderstar_turlsredis_keyredisrequestscrapyspiderRedisSpider_4198"></a>3.spider的改造。star_turls变成了redis_key从redis中获得request，继承的scrapy.spider变成RedisSpider。</h5> 
<pre><code class="prism language-python"><span class="token keyword">from</span> scrapy_redis<span class="token punctuation">.</span>spiders <span class="token keyword">import</span> RedisSpider

<span class="token keyword">class</span> <span class="token class-name">MySpider</span><span class="token punctuation">(</span>RedisSpider<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Spider that reads urls from redis queue (myspider:start_urls)."""</span>
    name <span class="token operator">=</span> <span class="token string">'myspider_redis'</span>
    redis_key <span class="token operator">=</span> <span class="token string">'myspider:start_urls'</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># Dynamically define the allowed domains list.</span>
        domain <span class="token operator">=</span> kwargs<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">'domain'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>allowed_domains <span class="token operator">=</span> <span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> domain<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>MySpider<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">'name'</span><span class="token punctuation">:</span> response<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">'title::text'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'url'</span><span class="token punctuation">:</span> response<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_4221"></a><strong>启动爬虫：</strong></h5> 
<pre><code>$ scrapy runspider my.py
</code></pre> 
<p>可以输入多个来观察多进程的效果。。打开了爬虫之后你会发现爬虫处于等待爬取的状态，是因为list此时为空。所以需要在redis控制台中添加启动地址,这样就可以愉快的看到所有的爬虫都动起来啦。</p> 
<pre><code>lpush mycrawler:start_urls http://www.***.com
</code></pre> 
<h5><a id="Scrapysettingspy_4233"></a><strong>更多关于配置Scrapy框架中配置：settings.py</strong></h5> 
<pre><code># 指定使用scrapy-redis的调度器
SCHEDULER = "scrapy_redis.scheduler.Scheduler"

# 指定使用scrapy-redis的去重
DUPEFILTER_CLASS = 'scrapy_redis.dupefilters.RFPDupeFilter'

# 指定排序爬取地址时使用的队列，
# 默认的 按优先级排序(Scrapy默认)，由sorted set实现的一种非FIFO、LIFO方式。
SCHEDULER_QUEUE_CLASS = 'scrapy_redis.queue.SpiderPriorityQueue'
# 可选的 按先进先出排序（FIFO）
# SCHEDULER_QUEUE_CLASS = 'scrapy_redis.queue.SpiderQueue'
# 可选的 按后进先出排序（LIFO）
# SCHEDULER_QUEUE_CLASS = 'scrapy_redis.queue.SpiderStack'

# 在redis中保持scrapy-redis用到的各个队列，从而允许暂停和暂停后恢复，也就是不清理redis queues
SCHEDULER_PERSIST = True

# 只在使用SpiderQueue或者SpiderStack是有效的参数，指定爬虫关闭的最大间隔时间
# SCHEDULER_IDLE_BEFORE_CLOSE = 10

# 通过配置RedisPipeline将item写入key为 spider.name : items 的redis的list中，供后面的分布式处理item
# 这个已经由 scrapy-redis 实现，不需要我们写代码
ITEM_PIPELINES = {
    'example.pipelines.ExamplePipeline': 300,
    'scrapy_redis.pipelines.RedisPipeline': 400
}

# 指定redis数据库的连接参数
# REDIS_PASS是我自己加上的redis连接密码（默认不做）
REDIS_HOST = '127.0.0.1'
REDIS_PORT = 6379
#REDIS_PASS = 'redisP@ssw0rd'

# LOG等级
LOG_LEVEL = 'DEBUG'

#默认情况下,RFPDupeFilter只记录第一个重复请求。将DUPEFILTER_DEBUG设置为True会记录所有重复的请求。
DUPEFILTER_DEBUG =True

# 覆盖默认请求头，可以自己编写Downloader Middlewares设置代理和UserAgent
DEFAULT_REQUEST_HEADERS = {
    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
    'Accept-Language': 'zh-CN,zh;q=0.8',
    'Connection': 'keep-alive',
    'Accept-Encoding': 'gzip, deflate, sdch'
}
</code></pre> 
<h4><a id="174__4284"></a>17.4 实战案例：</h4> 
<ul><li>案例：实现主从分布式爬虫，爬取5i5j的楼盘信息</li><li>URL地址：https://fang.5i5j.com/bj/loupan/</li><li>准备工作： 
  <ul><li>开启redis数据库服务</li><li>将第二节<code>Scrapy框架的使用</code>中的案例demo复制过来两份：master(主)、slave(从)</li></ul> </li></ul> 
<p><img src="https://images2.imgbox.com/dc/ec/uBWvfjRI_o.png" alt="img">]</p> 
<h5><a id="_slave_4294"></a>① 编写slave(从)项目代码：</h5> 
<ul><li>查看items.py 保持不变：</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">import</span> scrapy

<span class="token keyword">class</span> <span class="token class-name">FangItem</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Item<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># define the fields for your item here like:</span>
    title <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    address <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    time <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    clicks <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    price <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li>编辑爬虫文件：fang.py</li></ul> 
<pre><code class="prism language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">import</span> scrapy
<span class="token keyword">from</span> demo<span class="token punctuation">.</span>items <span class="token keyword">import</span> FangItem
<span class="token keyword">from</span> scrapy_redis<span class="token punctuation">.</span>spiders <span class="token keyword">import</span> RedisSpider

<span class="token keyword">class</span> <span class="token class-name">FangSpider</span><span class="token punctuation">(</span>RedisSpider<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">'fang'</span>
    <span class="token comment">#allowed_domains = ['fang.5i5j.com']</span>
    <span class="token comment">#start_urls = ['https://fang.5i5j.com/bj/loupan/']</span>
    redis_key <span class="token operator">=</span> <span class="token string">'fangspider:start_urls'</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># Dynamically define the allowed domains list.</span>
        domain <span class="token operator">=</span> kwargs<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">'domain'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>allowed_domains <span class="token operator">=</span> <span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> domain<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>FangSpider<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#print(response.status)</span>
        hlist <span class="token operator">=</span> response<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">"div.houseList_list"</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> vo <span class="token keyword">in</span> hlist<span class="token punctuation">:</span>
            item <span class="token operator">=</span> FangItem<span class="token punctuation">(</span><span class="token punctuation">)</span>
            item<span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span> <span class="token operator">=</span> vo<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">"h3.fontS20 a::text"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span>
            item<span class="token punctuation">[</span><span class="token string">'address'</span><span class="token punctuation">]</span> <span class="token operator">=</span> vo<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">"span.addressName::text"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span>
            item<span class="token punctuation">[</span><span class="token string">'time'</span><span class="token punctuation">]</span> <span class="token operator">=</span> vo<span class="token punctuation">.</span>re<span class="token punctuation">(</span><span class="token string">"&lt;span&gt;(.*?)开盘&lt;/span&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            item<span class="token punctuation">[</span><span class="token string">'clicks'</span><span class="token punctuation">]</span> <span class="token operator">=</span> vo<span class="token punctuation">.</span>re<span class="token punctuation">(</span><span class="token string">"&lt;span&gt;&lt;i&gt;([0-9]+)&lt;/i&gt;浏览&lt;/span&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            item<span class="token punctuation">[</span><span class="token string">'price'</span><span class="token punctuation">]</span> <span class="token operator">=</span> vo<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">"i.fontS24::text"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
            <span class="token keyword">yield</span> item
        <span class="token comment">#pass</span>
</code></pre> 
<ul><li>查看pipelines.py保持不变</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">DemoPipeline</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">process_item</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> item<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token operator">*</span><span class="token number">70</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> item
</code></pre> 
<ul><li>编辑配置文件：settings.py配置文件：</li></ul> 
<pre><code class="prism language-python"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

ITEM_PIPELINES <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">#'demo.pipelines.DemoPipeline': 300,</span>
    <span class="token string">'scrapy_redis.pipelines.RedisPipeline'</span><span class="token punctuation">:</span> <span class="token number">400</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token comment"># 指定使用scrapy-redis的去重</span>
DUPEFILTER_CLASS <span class="token operator">=</span> <span class="token string">'scrapy_redis.dupefilter.RFPDupeFilter'</span>

<span class="token comment"># 指定使用scrapy-redis的调度器</span>
SCHEDULER <span class="token operator">=</span> <span class="token string">"scrapy_redis.scheduler.Scheduler"</span>

<span class="token comment"># 在redis中保持scrapy-redis用到的各个队列，从而允许暂停和暂停后恢复，也就是不清理redis queues</span>
SCHEDULER_PERSIST <span class="token operator">=</span> <span class="token boolean">True</span>

<span class="token comment"># 指定排序爬取地址时使用的队列，</span>
<span class="token comment"># 默认的 按优先级排序(Scrapy默认)，由sorted set实现的一种非FIFO、LIFO方式。</span>
SCHEDULER_QUEUE_CLASS <span class="token operator">=</span> <span class="token string">'scrapy_redis.queue.SpiderPriorityQueue'</span>

<span class="token comment"># REDIS_URL = 'redis://localhost:6379' # 一般情况可以省去</span>
REDIS_HOST <span class="token operator">=</span> <span class="token string">'localhost'</span> <span class="token comment"># 也可以根据情况改成 localhost</span>
REDIS_PORT <span class="token operator">=</span> <span class="token number">6379</span>
</code></pre> 
<ul><li>测试：爬取具体房屋信息</li></ul> 
<pre><code># 进入爬虫文件目录找到爬虫文件：
$ scrapy runspider fang.py
</code></pre> 
<p>另启一个终端，并连接redis数据库</p> 
<pre><code>$ redis_cli -p 6379

6379 &gt;lpush fangspider:start_urls https://fang.5i5j.com/bj/loupan/
</code></pre> 
<h5><a id="_master_4399"></a>② 编写master(主)项目代码：</h5> 
<ul><li>编辑items.py 储存url地址：</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">import</span> scrapy

<span class="token keyword">class</span> <span class="token class-name">MasterItem</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Item<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># define the fields for your item here like:</span>
    url <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>  
    <span class="token comment">#pass</span>
</code></pre> 
<ul><li>编辑爬虫文件：fang.py</li></ul> 
<pre><code class="prism language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">from</span> scrapy<span class="token punctuation">.</span>spider <span class="token keyword">import</span> CrawlSpider<span class="token punctuation">,</span>Rule  
<span class="token keyword">from</span> scrapy<span class="token punctuation">.</span>linkextractors <span class="token keyword">import</span> LinkExtractor  
<span class="token keyword">from</span> demo<span class="token punctuation">.</span>items <span class="token keyword">import</span> MasterItem  

<span class="token keyword">class</span> <span class="token class-name">FangSpider</span><span class="token punctuation">(</span>CrawlSpider<span class="token punctuation">)</span><span class="token punctuation">:</span>  

    name <span class="token operator">=</span> <span class="token string">'master'</span>  
    allowed_domains <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'fang.5i5j.com'</span><span class="token punctuation">]</span>
    start_urls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'https://fang.5i5j.com/bj/loupan/'</span><span class="token punctuation">]</span> 
    item <span class="token operator">=</span> MasterItem<span class="token punctuation">(</span><span class="token punctuation">)</span>  

    <span class="token comment">#Rule是在定义抽取链接的规则</span>
    rules <span class="token operator">=</span> <span class="token punctuation">(</span>  
        Rule<span class="token punctuation">(</span>LinkExtractor<span class="token punctuation">(</span>allow<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">'https://fang.5i5j.com/bj/loupan/n[0-9]+/'</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> callback<span class="token operator">=</span><span class="token string">'parse_item'</span><span class="token punctuation">,</span>  
             follow<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  
    <span class="token punctuation">)</span>  

    <span class="token keyword">def</span> <span class="token function">parse_item</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>response<span class="token punctuation">)</span><span class="token punctuation">:</span>  
        item <span class="token operator">=</span> self<span class="token punctuation">.</span>item  
        item<span class="token punctuation">[</span><span class="token string">'url'</span><span class="token punctuation">]</span> <span class="token operator">=</span> response<span class="token punctuation">.</span>url  
        <span class="token keyword">return</span> item
</code></pre> 
<ul><li>编辑pipelines.py负责存储爬取的url地址到redis中：</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">import</span> redis<span class="token punctuation">,</span>re

<span class="token keyword">class</span> <span class="token class-name">MasterPipeline</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>host<span class="token punctuation">,</span>port<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#连接redis数据库</span>
        self<span class="token punctuation">.</span>r <span class="token operator">=</span> redis<span class="token punctuation">.</span>Redis<span class="token punctuation">(</span>host<span class="token operator">=</span>host<span class="token punctuation">,</span> port<span class="token operator">=</span>port<span class="token punctuation">,</span> decode_responses<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token comment">#self.redis_url = 'redis://password:@localhost:6379/'  </span>
        <span class="token comment">#self.r = redis.Redis.from_url(self.redis_url,decode_responses=True)  </span>

    @<span class="token builtin">classmethod</span>
    <span class="token keyword">def</span> <span class="token function">from_crawler</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span>crawler<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''注入实例化对象（传入参数）'''</span>
        <span class="token keyword">return</span> cls<span class="token punctuation">(</span>
            host <span class="token operator">=</span> crawler<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"REDIS_HOST"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            port <span class="token operator">=</span> crawler<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"REDIS_PORT"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">process_item</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> item<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>  
        <span class="token comment">#使用正则判断url地址是否有效，并写入redis。</span>
        <span class="token keyword">if</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">'/bj/loupan/'</span><span class="token punctuation">,</span>item<span class="token punctuation">[</span><span class="token string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>r<span class="token punctuation">.</span>lpush<span class="token punctuation">(</span><span class="token string">'fangspider:start_urls'</span><span class="token punctuation">,</span> item<span class="token punctuation">[</span><span class="token string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>r<span class="token punctuation">.</span>lpush<span class="token punctuation">(</span><span class="token string">'fangspider:no_urls'</span><span class="token punctuation">,</span> item<span class="token punctuation">[</span><span class="token string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li>编辑配置文件：settings.py配置文件:</li></ul> 
<pre><code class="prism language-python">ITEM_PIPELINES <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'demo.pipelines.MasterPipeline'</span><span class="token punctuation">:</span> <span class="token number">300</span><span class="token punctuation">,</span>
    <span class="token comment">#'scrapy_redis.pipelines.RedisPipeline': 400,</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         

<span class="token comment"># 指定使用scrapy-redis的去重</span>
DUPEFILTER_CLASS <span class="token operator">=</span> <span class="token string">'scrapy_redis.dupefilter.RFPDupeFilter'</span>

<span class="token comment"># 指定使用scrapy-redis的调度器</span>
SCHEDULER <span class="token operator">=</span> <span class="token string">"scrapy_redis.scheduler.Scheduler"</span>

<span class="token comment"># 在redis中保持scrapy-redis用到的各个队列，从而允许暂停和暂停后恢复，也就是不清理redis queues</span>
SCHEDULER_PERSIST <span class="token operator">=</span> <span class="token boolean">True</span>

<span class="token comment"># 指定排序爬取地址时使用的队列，</span>
<span class="token comment"># 默认的 按优先级排序(Scrapy默认)，由sorted set实现的一种非FIFO、LIFO方式。</span>
SCHEDULER_QUEUE_CLASS <span class="token operator">=</span> <span class="token string">'scrapy_redis.queue.SpiderPriorityQueue'</span>

<span class="token comment"># REDIS_URL = 'redis:password//127.0.0.1:6379' # 一般情况可以省去</span>
REDIS_HOST <span class="token operator">=</span> <span class="token string">'127.0.0.1'</span> <span class="token comment"># 也可以根据情况改成 localhost</span>
REDIS_PORT <span class="token operator">=</span> <span class="token number">6379</span>
</code></pre> 
<ul><li>测试：爬取更多的url地址：</li></ul> 
<pre><code># 进入爬虫文件目录找到爬虫文件：
$ scrapy runspider fang.py
</code></pre> 
<h4><a id="175_Redis_4502"></a>17.5 处理的Redis里的数据：</h4> 
<ul><li>网站的数据爬回来了，但是放在Redis里没有处理。之前我们配置文件里面没有定制自己的ITEM_PIPELINES，而是使用了RedisPipeline，所以现在这些数据都被保存在redis的demo:items键中，所以我们需要另外做处理。</li><li>在scrapy-youyuan目录下可以看到一个process_items.py文件，这个文件就是scrapy-redis的example提供的从redis读取item进行处理的模版。</li><li>假设我们要把demo:items中保存的数据读出来写进MongoDB或者MySQL，那么我们可以自己写一个process_demo_profile.py文件，然后保持后台运行就可以不停地将爬回来的数据入库了。</li></ul> 
<h5><a id="MongoDB_4508"></a>存入的MongoDB</h5> 
<ul><li>启动的MongoDB数据库：sudo mongod</li><li>执行下面程序：python process_demo_mongodb.py</li></ul> 
<pre><code class="prism language-python"><span class="token comment"># process_demo_mongodb.py</span>

<span class="token keyword">import</span> json
<span class="token keyword">import</span> redis
<span class="token keyword">import</span> pymongo

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token comment"># 指定Redis数据库信息</span>
    rediscli <span class="token operator">=</span> redis<span class="token punctuation">.</span>StrictRedis<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">6379</span><span class="token punctuation">,</span> db<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token comment"># 指定MongoDB数据库信息</span>
    mongocli <span class="token operator">=</span> pymongo<span class="token punctuation">.</span>MongoClient<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'localhost'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">27017</span><span class="token punctuation">)</span>

    <span class="token comment"># 创建数据库名</span>
    db <span class="token operator">=</span> mongocli<span class="token punctuation">[</span><span class="token string">'demodb'</span><span class="token punctuation">]</span>
    <span class="token comment"># 创建空间</span>
    sheet <span class="token operator">=</span> db<span class="token punctuation">[</span><span class="token string">'fang'</span><span class="token punctuation">]</span>

    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token comment"># FIFO模式为 blpop，LIFO模式为 brpop，获取键值</span>
        source<span class="token punctuation">,</span> data <span class="token operator">=</span> rediscli<span class="token punctuation">.</span>blpop<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"demo:items"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        item <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        sheet<span class="token punctuation">.</span>insert<span class="token punctuation">(</span>item<span class="token punctuation">)</span>

        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span> u<span class="token string">"Processing: %(name)s &lt;%(link)s&gt;"</span> <span class="token operator">%</span> item
        <span class="token keyword">except</span> KeyError<span class="token punctuation">:</span>
            <span class="token keyword">print</span> u<span class="token string">"Error procesing: %r"</span> <span class="token operator">%</span> item

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="Python_4550"></a>十一、Python网络爬虫进阶实战(下)</h2> 
<h3><a id="18_App_4552"></a>18. App的信息爬取</h3> 
<ul><li>之前我们讲解的都是Web网页信息爬取，随着移动互联的发展，越来越多的企业并没有提供Web网页端的服务，而是直接开发App。</li><li>App的爬取相比Web端爬取更加容易，反爬中能力没有那么强，而且响应数据大多都是JSON形式，解析更加简单。</li><li>在APP端若想查看和分析内容那就需要借助抓包软件，常用的有：Filddler、Charles、mitmproxy、Appium等。</li><li>mitmproxy是一个支持HTTP/HTTPS协议的抓包程序，类似Fiddler、Charles的功能，只不过世它通过控制台的形式操作。 <img src="https://images2.imgbox.com/19/0c/uDR89DdA_o.png" alt="img">]</li><li>Appium是移动端的自动化测试工具，类似于前面所说的Selenium、利用它可以驱动Android、IOS等设备完成自动化测试。 <img src="https://images2.imgbox.com/5e/4b/dXx4zzV9_o.png" alt="img">]</li></ul> 
<h4><a id="181_Charles_4560"></a>18.1 Charles的介绍</h4> 
<ul><li>Charles是一个网络抓包工具，可以完成App的抓包分析，能够得到App运行过程中发生的所有网络请求和响应内容。</li><li>相关连接： 
  <ul><li>官方网站：<a href="https://www.charlesproxy.com/" rel="nofollow">https://www.charlesproxy.com</a></li><li>下载链接：https://www.charlesproxy.com/download</li></ul> </li></ul> 
<p><img src="https://images2.imgbox.com/99/b8/6N65eIwT_o.png" alt="img">]</p> 
<h5><a id="Charles_4569"></a>Charles主要功能:</h5> 
<pre><code>* 支持SSL代理。可以截取分析SSL的请求。
* 支持流量控制。可以模拟慢速网络以及等待时间（latency）较长的请求。
* 支持AJAX调试。可以自动将json或xml数据格式化，方便查看。
* 支持AMF调试。可以将Flash Remoting 或 Flex Remoting信息格式化，方便查看。
* 支持重发网络请求，方便后端调试。
* 支持修改网络请求参数。
* 支持网络请求的截获并动态修改。
* 检查HTML，CSS和RSS内容是否符合W3C标准。
</code></pre> 
<p><img src="https://images2.imgbox.com/34/0b/3LLuKmjI_o.png" alt="img">]</p> 
<h4><a id="182_Charles_4584"></a>18.2 Charles的配置</h4> 
<h5><a id="__4586"></a>① 网络共享配置：</h5> 
<ul><li>实现手机通过电脑上网：就是电脑通过网线上网，然后共享Wifi，手机在链接此wifi。 
  <ul><li>查看本机电脑的网络链接： <img src="https://images2.imgbox.com/97/ab/tjb4vnjO_o.png" alt="img">]</li><li>共享wifi设置： <img src="https://images2.imgbox.com/9d/c4/FthWMUjK_o.png" alt="img">]</li><li>手机链接此wifi，实现手机和电脑连接到同一个局域下 <img src="https://images2.imgbox.com/ee/14/kOyoPnZM_o.png" alt="img">]</li></ul> </li></ul> 
<h5><a id="__4593"></a>② 代理设置：</h5> 
<ul><li> <p>实现手机和电脑在同一局域网下的机上，完成Charles的代理设置：</p> 
  <ul><li> <p>首先查看电脑的打开Charles代理是否开启，具体操作是：<code>Proxy</code> -&gt; <code>Proxy Settings</code> ,打开代理设置界面，设置代理端口为：8888. <img src="https://images2.imgbox.com/ec/ac/8sQaDa1j_o.png" alt="img">]</p> </li><li> <p>打开手机的网络配置，并设置使用代理配置：</p> <p><img src="https://images2.imgbox.com/d3/38/qpsmiGam_o.png" alt="img">]</p> </li></ul> </li></ul> 
<h5><a id="__4603"></a>③ 证书配置：</h5> 
<ul><li> <p>安装完成后，我们还需要配置相关SSL证书 来抓取HTTPS协议的信息包。</p> </li><li> <p>Windows系统：</p> 
  <ul><li>首先打开Charles，点击<code>Help</code>-&gt;<code>SSL Proxying</code>-&gt;<code>Install Charles Root Certificate</code>,即可进入证书安装界面。</li><li>点击 “安装证书” 按钮，就会打开证书导入向导。</li><li>点击 “下一步” 按钮，此时需要选择证书存储区域“将所有证书放入下列存储”-&gt;点击"浏览"-&gt;选择“受信任的证书颁发机构”-&gt;“确定”-&gt;“下一步”-&gt;完成。</li></ul> </li><li> <p>Mac系统：</p> 
  <ul><li>首先打开Charles，点击<code>Help</code>-&gt;<code>SSL Proxying</code>-&gt;<code>Install Charles Root Certificate</code>,即可进入证书安装界面。</li><li>接下来，找到Charles的证书并双击，将 “信任” 设置为 “始终信任”即可 。</li></ul> </li><li> <p><code>IOS手机</code>：</p> 
  <ul><li> <p>在网络配置和代理开启的情况下，若是你的手机是IOS系统，可以按照下面的操作进行证书配置。</p> </li><li> <p>在手机浏览器上打开chls.pro/ssl后，便会打开证书安装页面，点击安装即可。</p> <p><img src="https://images2.imgbox.com/75/a9/DDPWWK3f_o.png" alt="img">]</p> </li><li> <p>在IOS手机上，点击“设置”-&gt;“通用”-&gt;“关于本机”-&gt;“证书信任设置”，设置开启即可。</p> <p><img src="https://images2.imgbox.com/fd/62/FPvBKdDv_o.png" alt="img">]</p> </li></ul> </li></ul> 
<h5><a id="_Charles__HTTPS__4630"></a>⑤ Charles 配置 HTTPS 代理的乱码问题</h5> 
<ul><li> <p>在 Charles 设置 SSL 代理：</p> 
  <ul><li> <p>Proxy –&gt; SSL Proxying Setting –&gt; Enable SSL Proxying</p> <p><img src="https://images2.imgbox.com/e6/2f/udRN75cv_o.png" alt="img">]</p> <p><img src="https://images2.imgbox.com/f3/30/axaB4Tnz_o.png" alt="img">]</p> </li></ul> </li></ul> 
<h4><a id="183_Charles_4640"></a>18.3 Charles的运行原理和具体使用</h4> 
<h5><a id="__4642"></a>① 运行原理：</h5> 
<ul><li>首先Charles运行在自己的PC上，Charles运行的时候会在PC的8888端口开启一个代理服务，这就是一个HTTP/HTTPS的代理。</li><li>确保手机和PC在同一个局域网内，我们可以使用手机模拟器通过虚拟网络连接，也可使用手机真机和PC通过无线网连接。</li><li>设置手机代理为Charles的代理地址，这样手机访问互联网的数据包就会流经Charles，Charles再转发这些数据包到真实的服务器，同理相反也是如此。</li></ul> 
<h5><a id="__4648"></a>② 具体使用</h5> 
<ul><li>手机运行App访问要爬取的平台信息，使用Charles抓包分析。</li><li>知道了请求和响应的具体信息，通过分析得到请求的URL地址和参数的规律，直接使用程序模拟即可批量爬取。</li></ul> 
<p><img src="https://images2.imgbox.com/a5/17/Lag2hvXo_o.png" alt="img">]</p> 
<h3><a id="19_mitmproxy_4655"></a>19. mitmproxy的使用</h3> 
<ul><li>mitmproxy是一个支持HHTP/HTTPS协议的抓包程序，类似Fiddler、Charles的功能，只不过世它通过控制台的形式操作。</li><li>mitmproxy还有两个关联组件： 
  <ul><li>mitmdump：它是mitmproxy的命令行接口，利用它我们可以对接Python脚本，用Python实现监听后的处理。</li><li>mitmweb： 它是一个Web程序，通过它我们可以清楚观察mimproxy捕获的请求。</li></ul> </li><li>mitmproxy的功能： 
  <ul><li>拦截HTTP和HTTPS请求和响应</li><li>保存HTTP会话请进行分析</li><li>模拟客户端请求，模拟服务器返回响应</li><li>利用反向代理将流量转发给指定的服务器</li><li>支持Mac和Linux上的透明代理</li><li>利用Python对HTTP请求和响应进行实时处理</li></ul> </li></ul> 
<h4><a id="191__4669"></a>19.1 安装和配置：</h4> 
<ul><li>安装：完成mitmproxy的安装，另外还附带安装了mitmdump和mimweb这两个组件</li></ul> 
<pre><code> pip3 install mitmproxy
</code></pre> 
<ul><li> <p>配置手机和PC处于同一局域网下：（具体步骤详见上一节内容）</p> </li><li> <p>打开手机的网络配置，并设置使用代理配置，端口监听 <code>8080</code>：（具体步骤详见上一节内容）</p> </li><li> <p>配置mitmproxy的CA证书。</p> 
  <ul><li> <p>对于mitmproxy来说，如果想要截获HTTPS请求，就需要设置CA证书，而mitmproxy安装后就会提供一套CA证书，只要客户信任了此证书即可。</p> </li><li> <p>首先运行启动<code>mitmdump</code>，就会在此命令下产生CA证书,我们可以从用户目录下的<code>.mitmproxy</code>目录下看到。</p> <pre><code> localhost:app zhangtao$ mitmdump
 Proxy server listening at http://*:8080
</code></pre> <p><img src="https://images2.imgbox.com/b1/b0/ole3FGPJ_o.png" alt="img">]</p> </li><li> <p>文件说明：</p> 
    <ul><li><code>mitmproxy-ca.pem</code> PEM格式的证书私钥</li><li><code>mitmproxy-ca-cert.pem</code> PEM格式证书，适用于大多数非Windows平台</li><li><code>mitmproxy-ca-cert.p12</code> PKCS12格式的证书，适用于大多数Windows平台</li><li><code>mitmproxy-ca-cert.cer</code> 与mitmproxy-ca-cert.pem相同（只是后缀名不同），适用于大部分Android平台</li><li><code>mitmproxy-dhparam.pem</code> PEM格式的秘钥文件，用于增强SSL安全性。</li></ul> </li><li> <p>在Mac系统下双击<code>mitmproxy-ca-cert.pem</code>即可弹出秘钥串管理页面，找到<code>mitmproxy</code>证书，打开设置选项，选择<code>始终信任</code>即可。</p> <p><img src="https://images2.imgbox.com/f3/c6/uHPCJkGx_o.png" alt="img">]</p> </li><li> <p>将<code>mitmproxy-ca-cert.pem</code>文件发送到iPhone手机上，点击安装就可以了（在IOS上通过AirDrop共享过去的）。</p> <p><img src="https://images2.imgbox.com/74/16/mTV0odee_o.png" alt="img">]</p> </li><li> <p>在iphone上安装CA证书（Android手机直接复制文件点击安装即可）</p> <p><img src="https://images2.imgbox.com/fa/63/bhSjn19p_o.png" alt="img">]</p> </li><li> <p>在IOS手机上，点击“设置” - &gt; “通用” - &gt; “关于本机” - &gt; “证书信任设置”，设置开启即可</p> <p><img src="https://images2.imgbox.com/02/cf/b0cRN3tL_o.png" alt="img">]</p> </li></ul> </li></ul> 
<h4><a id="192_mitmproxy_4718"></a>19.2 mitmproxy的使用：</h4> 
<ul><li>运行<code>mitmproxy</code> 命令就会打开一个监听窗口,此窗口就会输出一个App请求中的信息。</li></ul> 
<pre><code>  localhost:app zhangtao$ mitmproxy
</code></pre> 
<p><img src="https://images2.imgbox.com/96/69/1PbqRKU6_o.png" alt="img">]</p> 
<ul><li>mitmproxy的按键操作说明</li></ul> 
<table><thead><tr><th>按键</th><th>说明</th></tr></thead><tbody><tr><td>q</td><td>退出（相当于返回键，可一级一级返回）</td></tr><tr><td>d</td><td>删除当前（黄色箭头）指向的链接</td></tr><tr><td>D</td><td>恢复刚才删除的请求</td></tr><tr><td>G</td><td>跳到最新一个请求</td></tr><tr><td>g</td><td>跳到第一个请求</td></tr><tr><td>C</td><td>清空控制台（C是大写）</td></tr><tr><td>i</td><td>可输入需要拦截的文件或者域名（逗号需要用\来做转译，栗子：feezu.cn）</td></tr><tr><td>a</td><td>放行请求</td></tr><tr><td>A</td><td>放行所有请求</td></tr><tr><td>?</td><td>查看界面帮助信息</td></tr><tr><td>^ v</td><td>上下箭头移动光标</td></tr><tr><td>enter</td><td>查看光标所在列的内容</td></tr><tr><td>tab</td><td>分别查看 Request 和 Response 的详细信息</td></tr><tr><td>/</td><td>搜索body里的内容</td></tr><tr><td>esc</td><td>退出编辑</td></tr><tr><td>e</td><td>进入编辑模式</td></tr></tbody></table> 
<h4><a id="193_mitmdump_4749"></a>19.3 mitmdump的使用：</h4> 
<ul><li>mitmdump是mitmproxy的命令行接口，同时还可以对接Python对请求进行处理。</li><li>使用命令启动mitmproxy，并将截获的数据保存到指定文件中，命令如下：</li></ul> 
<pre><code>    mitmdump -w  outfile
</code></pre> 
<ul><li>使用指定命令截获的数据，如指定处理脚本文件为script.py.</li></ul> 
<pre><code>    mitmdump  -s  script.py
</code></pre> 
<ul><li>日志输出：</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">from</span> mitmproxy <span class="token keyword">import</span> ctx

<span class="token keyword">def</span> <span class="token function">request</span><span class="token punctuation">(</span>flow<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 修改请求头</span>
    flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'User-Agent'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'MitmProxy'</span>
    ctx<span class="token punctuation">.</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">)</span>
    ctx<span class="token punctuation">.</span>log<span class="token punctuation">.</span>warn<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">)</span>
    ctx<span class="token punctuation">.</span>log<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li>Request请求</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">from</span> mitmproxy <span class="token keyword">import</span> ctx

<span class="token comment"># 所有的请求都会经过request</span>
<span class="token keyword">def</span> <span class="token function">request</span><span class="token punctuation">(</span>flow<span class="token punctuation">)</span><span class="token punctuation">:</span>
    info <span class="token operator">=</span> ctx<span class="token punctuation">.</span>log<span class="token punctuation">.</span>info
    <span class="token comment"># info(flow.request.url)</span>
    <span class="token comment"># info(str(flow.request.headers))</span>
    <span class="token comment"># info(str(flow.request.cookies))</span>
    <span class="token comment"># info(flow.request.host)</span>
    <span class="token comment"># info(flow.request.method)</span>
    <span class="token comment"># info(str(flow.request.port))</span>
    <span class="token comment"># info(flow.request.scheme)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>method<span class="token punctuation">,</span><span class="token string">":"</span><span class="token punctuation">,</span>flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
</code></pre> 
<ul><li>Response响应</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">from</span> mitmproxy <span class="token keyword">import</span> ctx

<span class="token comment"># 所有的请求都会经过request</span>
<span class="token keyword">def</span> <span class="token function">response</span><span class="token punctuation">(</span>flow<span class="token punctuation">)</span><span class="token punctuation">:</span>
    info <span class="token operator">=</span> ctx<span class="token punctuation">.</span>log<span class="token punctuation">.</span>info
    <span class="token comment"># info(flow.response.url)</span>
    <span class="token comment"># info(str(flow.response.headers))</span>
    <span class="token comment"># info(str(flow.response.cookies))</span>
    info<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>flow<span class="token punctuation">.</span>response<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># info(str(flow.response.text))</span>
</code></pre> 
<ul><li>运行手机浏览器访问：<code>http://httpbin.org/get</code> 测试：</li></ul> 
<h3><a id="20_App_4812"></a>20. App信息抓取实战</h3> 
<h5><a id="__4814"></a>① 抓取目标：</h5> 
<ul><li> <p>我们的抓取目标是京东商城的App电子商品信息，并将信息保存到MongoDB数据库中。</p> </li><li> <p>我们将商品信息的id号、标题、单价、评价条数等信息</p> <p><img src="https://images2.imgbox.com/f2/0d/XkSJgHyr_o.png" alt="img">]</p> </li></ul> 
<h5><a id="__4822"></a>② 准备工作和抓取分析</h5> 
<ul><li> <p>准备工作：</p> 
  <ul><li>安装app抓包工具Charles、mitmproxy。</li><li>配置网络，确认手机和PC处于同一局域网下，并配置好代理服务</li><li>安装证书，确保可以抓取HTTPS的请求信息。</li><li>安装并开启MongoDB数据库。</li></ul> </li><li> <p>抓取分析：</p> 
  <ul><li> <p>打开iCharles抓包工具，让后使用手机打开京东App应用程序，让后搜索<code>电脑</code>商品信息。</p> </li><li> <p>在抓包工具中获取url地址：<code>http://api.m.jd.com/client.action?functionId=search</code></p> </li><li> <p>抓取信息格式为json格式。具体如下图所示</p> <p><img src="https://images2.imgbox.com/d7/4f/JjOyLfG2_o.png" alt="img">]</p> </li></ul> </li></ul> 
<h5><a id="__4841"></a>③ 代码编写：</h5> 
<pre><code class="prism language-python"><span class="token keyword">import</span> json
<span class="token comment">#import pymongo</span>
<span class="token keyword">from</span> mitmproxy <span class="token keyword">import</span> ctx

<span class="token comment">#连接MongoDB数据库jddb，选择集合shop</span>
<span class="token comment">#client = pymongo.MongoClient('localhost')</span>
<span class="token comment">#db = client['jddb']</span>
<span class="token comment">#collection = db['shop']</span>

<span class="token keyword">def</span> <span class="token function">response</span><span class="token punctuation">(</span>flow<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#global collection</span>
    url <span class="token operator">=</span> <span class="token string">'http://api.m.jd.com/client.action?functionId=search'</span>
    <span class="token keyword">if</span> flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
        text <span class="token operator">=</span> flow<span class="token punctuation">.</span>response<span class="token punctuation">.</span>text
        data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>text<span class="token punctuation">)</span>
        shops <span class="token operator">=</span> data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'wareInfo'</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> shop <span class="token keyword">in</span> shops<span class="token punctuation">:</span>
            item <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">'spuId'</span><span class="token punctuation">:</span> shop<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'spuId'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">'wname'</span><span class="token punctuation">:</span> shop<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'wname'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">'price'</span><span class="token punctuation">:</span> shop<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'jdPrice'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">'reviews'</span><span class="token punctuation">:</span> shop<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'reviews'</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            ctx<span class="token punctuation">.</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">#写入MongoDB数据库</span>
            <span class="token comment">#collection.insert(data)</span>
</code></pre> 
<ul><li>测试运行：</li></ul> 
<pre><code>mitmdump -s script.py
</code></pre> 
<p><img src="https://images2.imgbox.com/71/c5/sMqfWZpL_o.png" alt="img">]</p> 
<h3><a id="21_API_4880"></a>21. 从API爬取天气预报数据</h3> 
<h4><a id="211_API_4882"></a>21.1 注册免费API和阅读文档</h4> 
<ul><li>本节通过一个API接口(和风天气预报)爬取天气信息，该接口为个人开发者提供了一个免费的预报数据（有次数限制）。</li><li>首先访问和风天气网，注册一个账户。注册地址：https://console.heweather.com/</li></ul> 
<p><img src="https://images2.imgbox.com/ff/56/Ws8Ohl99_o.png" alt="img">]</p> 
<ul><li>在登陆后的控制台中可以看到个人认证的key(密钥)，这个key就是访问API接口的钥匙。</li></ul> 
<p><img src="https://images2.imgbox.com/ed/18/ZCbFg9cB_o.png" alt="img">]</p> 
<ul><li>获取key之后阅读API文档：https://www.heweather.com/documents/api/s6</li></ul> 
<p><img src="https://images2.imgbox.com/38/51/OsPmfl4E_o.png" alt="img">]</p> 
<h4><a id="212__4897"></a>21.2 提取全国城市信息</h4> 
<ul><li>通过API接口提取<code>3181</code>个城市信息。URL地址：<code>https://cdn.heweather.com/china-city-list.txt</code></li></ul> 
<p><img src="https://images2.imgbox.com/e7/45/EHNPSq9C_o.png" alt="img">]</p> 
<pre><code class="prism language-python"><span class="token comment"># 从网上读取城市列表信息，并使用正则将数据解析出来。</span>
<span class="token keyword">import</span> requests
<span class="token keyword">import</span> re

<span class="token comment"># 爬取城市信息列表</span>
url <span class="token operator">=</span> <span class="token string">"https://cdn.heweather.com/china-city-list.txt"</span>
res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
data <span class="token operator">=</span> res<span class="token punctuation">.</span>content<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>

<span class="token comment"># 使用换行符拆分出每一条城市信息数据</span>
dlist <span class="token operator">=</span> re<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'[\n\r]+'</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span>

<span class="token comment"># 剔除前两条无用的数据</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    dlist<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>dlist<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># 输出城市信息条数</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>dlist<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 输出前20条信息</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#使用空白符拆分出每个字段信息</span>
    item <span class="token operator">=</span> re<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"\s+"</span><span class="token punctuation">,</span>dlist<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment">#输出</span>
    <span class="token comment">#print(item)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">":"</span><span class="token punctuation">,</span>item<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="213__4931"></a>21.3 获取指定城市的天气信息</h4> 
<ul><li>此文档：https://www.heweather.com/documents/api/s6/weather</li><li>免费获取天气信息接口地址：https://free-api.heweather.com/s6/weather?location=城市&amp;key=用户认证key</li></ul> 
<p><img src="https://images2.imgbox.com/17/87/DKSq9yML_o.png" alt="img">]</p> 
<ul><li>抓取指定城市天气信息</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">import</span> requests
<span class="token keyword">import</span> time

<span class="token comment">#爬取指定城市的天气信息</span>
url <span class="token operator">=</span> <span class="token string">"https://free-api.heweather.com/s6/weather?location=北京&amp;key=a46fd5c4f1b54fda9ee71ba6711f09cd"</span>
res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token comment">#解析json数据</span>
dlist <span class="token operator">=</span> res<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>
data <span class="token operator">=</span> dlist<span class="token punctuation">[</span><span class="token string">'HeWeather6'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token comment">#输出部分天气信息</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"城市："</span><span class="token punctuation">,</span>data<span class="token punctuation">[</span><span class="token string">'basic'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'location'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"今日："</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'daily_forecast'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'date'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"温度："</span><span class="token punctuation">,</span>data<span class="token punctuation">[</span><span class="token string">'daily_forecast'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_min'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"~"</span><span class="token punctuation">,</span>data<span class="token punctuation">[</span><span class="token string">'daily_forecast'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_max'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'daily_forecast'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'cond_txt_d'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">" ~ "</span><span class="token punctuation">,</span>data<span class="token punctuation">[</span><span class="token string">'daily_forecast'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'cond_txt_n'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'daily_forecast'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'wind_dir'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>data<span class="token punctuation">[</span><span class="token string">'daily_forecast'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'wind_sc'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'级'</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li>输出结果：</li></ul> 
<pre><code>城市： 北京
今日： 2018-06-13
温度： 18 ~ 28
雷阵雨  ~  多云
东北风 1-2 级
</code></pre> 
<h4><a id="214__4969"></a>21.4 综合实例</h4> 
<ul><li>获取城市信息，并通过信息获取对应的天气信息。</li></ul> 
<pre><code class="prism language-python"><span class="token comment"># 从网上读取城市列表信息，并遍历部分城市信息，从API接口中爬取天气信息。</span>
<span class="token keyword">import</span> requests
<span class="token keyword">import</span> re
<span class="token keyword">import</span> time

<span class="token comment"># 爬取城市信息列表</span>
url <span class="token operator">=</span> <span class="token string">"https://cdn.heweather.com/china-city-list.txt"</span>
res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
data <span class="token operator">=</span> res<span class="token punctuation">.</span>content<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>

<span class="token comment"># 使用换行符拆分出每一条城市信息数据</span>
dlist <span class="token operator">=</span> re<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'[\n\r]+'</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span>

<span class="token comment"># 剔除前两条无用的数据</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    dlist<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>dlist<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># 输出城市信息条数</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>dlist<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 输出前10条信息</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#使用空白符拆分出每个字段信息</span>
    item <span class="token operator">=</span> re<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"\s+"</span><span class="token punctuation">,</span>dlist<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment">#输出</span>
    <span class="token comment">#print(item)</span>
    <span class="token comment">#print(item[0],":",item[2])</span>
    <span class="token comment">#爬取指定城市的天气信息</span>
    url <span class="token operator">=</span> <span class="token string">"https://free-api.heweather.com/s6/weather?location=%s&amp;key=a46fd5c4f1b54fda9ee71ba6711f09cd"</span><span class="token operator">%</span><span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token comment">#解析json数据</span>
    datalist <span class="token operator">=</span> res<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> datalist<span class="token punctuation">[</span><span class="token string">'HeWeather6'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token comment">#输出部分天气信息</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"城市："</span><span class="token punctuation">,</span>data<span class="token punctuation">[</span><span class="token string">'basic'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'location'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"今日："</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'daily_forecast'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'date'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"温度："</span><span class="token punctuation">,</span>data<span class="token punctuation">[</span><span class="token string">'daily_forecast'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_min'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"~"</span><span class="token punctuation">,</span>data<span class="token punctuation">[</span><span class="token string">'daily_forecast'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_max'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'daily_forecast'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'cond_txt_d'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">" . "</span><span class="token punctuation">,</span>data<span class="token punctuation">[</span><span class="token string">'daily_forecast'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'cond_txt_n'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'daily_forecast'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'wind_dir'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>data<span class="token punctuation">[</span><span class="token string">'daily_forecast'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'wind_sc'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'级'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token operator">*</span><span class="token number">70</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li>结果：</li></ul> 
<pre><code>3181
城市： 北京
今日： 2018-06-13
温度： 18 ~ 28
雷阵雨  .  多云
东北风 1-2 级
======================================================================
城市： 海淀
今日： 2018-06-14
温度： 18 ~ 30
多云  .  多云
南风 1-2 级
======================================================================
城市： 朝阳
... ...
</code></pre> 
<h3><a id="22__5036"></a>22. 滑动验证码的识别</h3> 
<h4><a id="221__5038"></a>22.1 滑动验证码的识别介绍</h4> 
<ul><li>本节目标：用程序识别极验滑动验证码的验证，包括分析识别思路、识别缺口位置、生成滑块拖动路径、模拟实现滑块拼合通过验证等步骤。</li><li>准备工作：本次案例我们使用Python库是Selenium，浏览器为Chrome。请确保已安装Selenium库和ChromeDriver浏览器驱动。</li><li>了解极验滑动验证码： 
  <ul><li>极验滑动验证码官网为：http://www.geetest.com/</li><li>验证方式为拖动滑块拼合图像，若图像完全拼合，则验证成功，否则需要重新验证，如图所示：</li></ul> </li></ul> 
<p><img src="https://images2.imgbox.com/df/3a/rMgcHgVO_o.png" alt="img">]</p> 
<ul><li>接下来我们链接地址：<code>https://account.geetest.com/login</code>，打开极验的管理后台登录页面，完成自动化登录操作。</li></ul> 
<h4><a id="222__5050"></a>22.2 实现步骤：</h4> 
<h5><a id="__5052"></a>① 初始化</h5> 
<ul><li>初始化链接地址、创建模拟浏览器对象、设置登录账户和密码等信息。</li></ul> 
<pre><code class="prism language-python">EMAIL <span class="token operator">=</span> <span class="token string">'登录账户'</span>
PASSWORD <span class="token operator">=</span> <span class="token string">'登录密码'</span>

<span class="token keyword">class</span> <span class="token class-name">CrackGeetest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>url <span class="token operator">=</span> <span class="token string">'https://account.geetest.com/login'</span>
        self<span class="token punctuation">.</span>browser <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">#设置显示等待时间</span>
        self<span class="token punctuation">.</span>wait <span class="token operator">=</span> WebDriverWait<span class="token punctuation">(</span>self<span class="token punctuation">.</span>browser<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>email <span class="token operator">=</span> EMAIL
        self<span class="token punctuation">.</span>password <span class="token operator">=</span> PASSWORD

    <span class="token keyword">def</span> <span class="token function">crack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>

<span class="token comment"># 程序主入口</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    crack <span class="token operator">=</span> CrackGeetest<span class="token punctuation">(</span><span class="token punctuation">)</span>
    crack<span class="token punctuation">.</span>crack<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="__5078"></a>② 模拟登录填写，点开滑块验证</h5> 
<ul><li>在实例化CrackGeetest对象后调用crack()方法开始模拟登录验证…</li><li>调用open()方法，打开登录界面，获取账户和密码输入框节点，完成账户和密码的输入。</li><li>调用get_geetest_button()方法获取滑动验证按钮，并点击。</li></ul> 
<pre><code>class CrackGeetest():
    #...

    def get_geetest_button(self):
        ''' 获取初始验证按钮,return：按钮对象 '''
        button = self.wait.until(EC.element_to_be_clickable((By.CLASS_NAME, 'geetest_radar_tip')))
        return button

    def open(self):
        ''' 打开网页输入用户名密码, return: None '''
        self.browser.get(self.url)
        email = self.wait.until(EC.presence_of_element_located((By.ID, 'email')))
        password = self.wait.until(EC.presence_of_element_located((By.ID, 'password')))
        email.send_keys(self.email)
        password.send_keys(self.password)

    def crack(self):
        # 输入用户名密码
        self.open()
        # 点击验证按钮
        button = self.get_geetest_button()
        button.click()
        #...
    #...
</code></pre> 
<h5><a id="__5111"></a>③ 获取并储存有无缺口的两张图片</h5> 
<ul><li>首先获取无缺口的验证图片，并保存到本地</li><li>获取滑块对象，并执行点击，让浏览器中显示有缺口图片</li><li>获取有缺口的验证图片，并保存到本地</li></ul> 
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">get_position</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">''' 获取验证码位置, return: 验证码位置(元组) '''</span>
        img <span class="token operator">=</span> self<span class="token punctuation">.</span>wait<span class="token punctuation">.</span>until<span class="token punctuation">(</span>EC<span class="token punctuation">.</span>presence_of_element_located<span class="token punctuation">(</span><span class="token punctuation">(</span>By<span class="token punctuation">.</span>CLASS_NAME<span class="token punctuation">,</span> <span class="token string">'geetest_canvas_img'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        location <span class="token operator">=</span> img<span class="token punctuation">.</span>location
        size <span class="token operator">=</span> img<span class="token punctuation">.</span>size
        top<span class="token punctuation">,</span>bottom<span class="token punctuation">,</span>left<span class="token punctuation">,</span>right <span class="token operator">=</span> location<span class="token punctuation">[</span><span class="token string">'y'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>location<span class="token punctuation">[</span><span class="token string">'y'</span><span class="token punctuation">]</span><span class="token operator">+</span>size<span class="token punctuation">[</span><span class="token string">'height'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>location<span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>location<span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">]</span><span class="token operator">+</span>size<span class="token punctuation">[</span><span class="token string">'width'</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">get_screenshot</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">''' 获取网页截图, return: 截图对象 '''</span>
        <span class="token comment">#浏览器截屏</span>
        screenshot <span class="token operator">=</span> self<span class="token punctuation">.</span>browser<span class="token punctuation">.</span>get_screenshot_as_png<span class="token punctuation">(</span><span class="token punctuation">)</span>
        screenshot <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>BytesIO<span class="token punctuation">(</span>screenshot<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> screenshot

    <span class="token keyword">def</span> <span class="token function">get_geetest_image</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'captcha.png'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">''' 获取验证码图片, return: 图片对象 '''</span>
        top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right <span class="token operator">=</span> self<span class="token punctuation">.</span>get_position<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'验证码位置'</span><span class="token punctuation">,</span> top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">)</span>
        screenshot <span class="token operator">=</span> self<span class="token punctuation">.</span>get_screenshot<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">#从网页截屏图片中裁剪处理验证图片</span>
        captcha <span class="token operator">=</span> screenshot<span class="token punctuation">.</span>crop<span class="token punctuation">(</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> right<span class="token punctuation">,</span> bottom<span class="token punctuation">)</span><span class="token punctuation">)</span>
        captcha<span class="token punctuation">.</span>save<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
        <span class="token keyword">return</span> captcha

    <span class="token keyword">def</span> <span class="token function">get_slider</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">''' 获取滑块, return: 滑块对象 '''</span>
        slider <span class="token operator">=</span> self<span class="token punctuation">.</span>wait<span class="token punctuation">.</span>until<span class="token punctuation">(</span>EC<span class="token punctuation">.</span>element_to_be_clickable<span class="token punctuation">(</span><span class="token punctuation">(</span>By<span class="token punctuation">.</span>CLASS_NAME<span class="token punctuation">,</span> <span class="token string">'geetest_slider_button'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> slider

    <span class="token keyword">def</span> <span class="token function">crack</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#...</span>

        <span class="token comment"># 获取验证码图片</span>
        image1 <span class="token operator">=</span> self<span class="token punctuation">.</span>get_geetest_image<span class="token punctuation">(</span><span class="token string">'captcha1.png'</span><span class="token punctuation">)</span>
        <span class="token comment"># 点按呼出缺口</span>
        slider <span class="token operator">=</span> self<span class="token punctuation">.</span>get_slider<span class="token punctuation">(</span><span class="token punctuation">)</span>
        slider<span class="token punctuation">.</span>click<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 获取带缺口的验证码图片</span>
        image2 <span class="token operator">=</span> self<span class="token punctuation">.</span>get_geetest_image<span class="token punctuation">(</span><span class="token string">'captcha2.png'</span><span class="token punctuation">)</span>

        <span class="token comment">#...</span>
</code></pre> 
<h5><a id="__5163"></a>④ 获取缺口位置</h5> 
<ul><li>对比两张图片的所有RBG像素点，得到不一样像素点的x值，即要移动的距离</li></ul> 
<pre><code class="prism language-python">BORDER <span class="token operator">=</span> <span class="token number">6</span>
INIT_LEFT <span class="token operator">=</span> <span class="token number">60</span>

<span class="token keyword">class</span> <span class="token class-name">CrackGeetest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  
    <span class="token keyword">def</span> <span class="token function">get_gap</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> image1<span class="token punctuation">,</span> image2<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">''' 获取缺口偏移量, 参数：image1不带缺口图片、image2带缺口图片。返回偏移量 '''</span>
        left <span class="token operator">=</span> <span class="token number">65</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> image1<span class="token punctuation">.</span>size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>image1<span class="token punctuation">.</span>size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> <span class="token operator">not</span> self<span class="token punctuation">.</span>is_pixel_equal<span class="token punctuation">(</span>image1<span class="token punctuation">,</span> image2<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    left <span class="token operator">=</span> i
                    <span class="token keyword">return</span> left
        <span class="token keyword">return</span> left

    <span class="token keyword">def</span> <span class="token function">is_pixel_equal</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> image1<span class="token punctuation">,</span> image2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''
        判断两个像素是否相同
        :param image1: 图片1
        :param image2: 图片2
        :param x: 位置x
        :param y: 位置y
        :return: 像素是否相同
        '''</span>
        <span class="token comment"># 取两个图片的像素点（R、G、B）</span>
        pixel1 <span class="token operator">=</span> image1<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span>
        pixel2 <span class="token operator">=</span> image2<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span>
        threshold <span class="token operator">=</span> <span class="token number">60</span>
        <span class="token keyword">if</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>pixel1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span>pixel2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;</span>threshold <span class="token operator">and</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>pixel1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-</span>pixel2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;</span>threshold <span class="token operator">and</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>pixel1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">-</span>pixel2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;</span>threshold<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">True</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">False</span>

    <span class="token keyword">def</span> <span class="token function">crack</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#...</span>

        <span class="token comment"># 获取缺口位置</span>
        gap <span class="token operator">=</span> self<span class="token punctuation">.</span>get_gap<span class="token punctuation">(</span>image1<span class="token punctuation">,</span> image2<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'缺口位置'</span><span class="token punctuation">,</span> gap<span class="token punctuation">)</span>
        <span class="token comment"># 减去缺口位移</span>
        gap <span class="token operator">-=</span> BORDER
</code></pre> 
<h5><a id="__5210"></a>⑤ 获取移动轨迹</h5> 
<ul><li>模拟人的行为习惯（先匀加速拖动后匀减速拖动），把需要拖动的总距离分成一段一段小的轨迹</li></ul> 
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">get_track</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> distance<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''
        根据偏移量获取移动轨迹
        :param distance: 偏移量
        :return: 移动轨迹
        '''</span>
        <span class="token comment"># 移动轨迹</span>
        track <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment"># 当前位移</span>
        current <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token comment"># 减速阈值</span>
        mid <span class="token operator">=</span> distance <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">/</span> <span class="token number">5</span>
        <span class="token comment"># 计算间隔</span>
        t <span class="token operator">=</span> <span class="token number">0.2</span>
        <span class="token comment"># 初速度</span>
        v <span class="token operator">=</span> <span class="token number">0</span>

        <span class="token keyword">while</span> current <span class="token operator">&lt;</span> distance<span class="token punctuation">:</span>
            <span class="token keyword">if</span> current <span class="token operator">&lt;</span> mid<span class="token punctuation">:</span>
                <span class="token comment"># 加速度为正2</span>
                a <span class="token operator">=</span> <span class="token number">2</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token comment"># 加速度为负3</span>
                a <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">3</span>
            <span class="token comment"># 初速度v0</span>
            v0 <span class="token operator">=</span> v
            <span class="token comment"># 当前速度v = v0 + at</span>
            v <span class="token operator">=</span> v0 <span class="token operator">+</span> a <span class="token operator">*</span> t
            <span class="token comment"># 移动距离x = v0t + 1/2 * a * t^2</span>
            move <span class="token operator">=</span> v0 <span class="token operator">*</span> t <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">*</span> a <span class="token operator">*</span> t <span class="token operator">*</span> t
            <span class="token comment"># 当前位移</span>
            current <span class="token operator">+=</span> move
            <span class="token comment"># 加入轨迹</span>
            track<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>move<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> track

    <span class="token keyword">def</span> <span class="token function">crack</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#...</span>

        <span class="token comment"># 获取移动轨迹</span>
        track <span class="token operator">=</span> self<span class="token punctuation">.</span>get_track<span class="token punctuation">(</span>gap<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'滑动轨迹'</span><span class="token punctuation">,</span> track<span class="token punctuation">)</span>
</code></pre> 
<h5><a id="__5259"></a>⑥ 按照轨迹拖动，完全验证</h5> 
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">move_to_gap</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> slider<span class="token punctuation">,</span> track<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''
        拖动滑块到缺口处
        :param slider: 滑块
        :param track: 轨迹
        :return: 
        '''</span>
        ActionChains<span class="token punctuation">(</span>self<span class="token punctuation">.</span>browser<span class="token punctuation">)</span><span class="token punctuation">.</span>click_and_hold<span class="token punctuation">(</span>slider<span class="token punctuation">)</span><span class="token punctuation">.</span>perform<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> x <span class="token keyword">in</span> track<span class="token punctuation">:</span>
            ActionChains<span class="token punctuation">(</span>self<span class="token punctuation">.</span>browser<span class="token punctuation">)</span><span class="token punctuation">.</span>move_by_offset<span class="token punctuation">(</span>xoffset<span class="token operator">=</span>x<span class="token punctuation">,</span> yoffset<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>perform<span class="token punctuation">(</span><span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>
        ActionChains<span class="token punctuation">(</span>self<span class="token punctuation">.</span>browser<span class="token punctuation">)</span><span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>perform<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">crack</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#...</span>

        <span class="token comment"># 拖动滑块</span>
        self<span class="token punctuation">.</span>move_to_gap<span class="token punctuation">(</span>slider<span class="token punctuation">,</span> track<span class="token punctuation">)</span>

        success <span class="token operator">=</span> self<span class="token punctuation">.</span>wait<span class="token punctuation">.</span>until<span class="token punctuation">(</span>
            EC<span class="token punctuation">.</span>text_to_be_present_in_element<span class="token punctuation">(</span><span class="token punctuation">(</span>By<span class="token punctuation">.</span>CLASS_NAME<span class="token punctuation">,</span> <span class="token string">'geetest_success_radar_tip_content'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'验证成功'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span>
</code></pre> 
<h5><a id="__5286"></a>⑦ 完成登录</h5> 
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">''' 执行登录 return: None '''</span>
        submit <span class="token operator">=</span> self<span class="token punctuation">.</span>wait<span class="token punctuation">.</span>until<span class="token punctuation">(</span>EC<span class="token punctuation">.</span>element_to_be_clickable<span class="token punctuation">(</span><span class="token punctuation">(</span>By<span class="token punctuation">.</span>CLASS_NAME<span class="token punctuation">,</span> <span class="token string">'login-btn'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        submit<span class="token punctuation">.</span>click<span class="token punctuation">(</span><span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'登录成功'</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">crack</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#...</span>

        <span class="token comment"># 失败后重试</span>
        <span class="token keyword">if</span> <span class="token operator">not</span> success<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>crack<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>login<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="223__5306"></a>22.3 完整代码：</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> time
<span class="token keyword">from</span> io <span class="token keyword">import</span> BytesIO
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver <span class="token keyword">import</span> ActionChains
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>common<span class="token punctuation">.</span>by <span class="token keyword">import</span> By
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>support<span class="token punctuation">.</span>ui <span class="token keyword">import</span> WebDriverWait
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>support <span class="token keyword">import</span> expected_conditions <span class="token keyword">as</span> EC

EMAIL <span class="token operator">=</span> <span class="token string">'122794105@qq.com'</span>
PASSWORD <span class="token operator">=</span> <span class="token string">'python123'</span>
BORDER <span class="token operator">=</span> <span class="token number">6</span>

<span class="token keyword">class</span> <span class="token class-name">CrackGeetest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>url <span class="token operator">=</span> <span class="token string">'https://account.geetest.com/login'</span>
        self<span class="token punctuation">.</span>browser <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">#设置显示等待时间</span>
        self<span class="token punctuation">.</span>wait <span class="token operator">=</span> WebDriverWait<span class="token punctuation">(</span>self<span class="token punctuation">.</span>browser<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>email <span class="token operator">=</span> EMAIL
        self<span class="token punctuation">.</span>password <span class="token operator">=</span> PASSWORD

    <span class="token keyword">def</span> <span class="token function">__del__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#self.browser.close()</span>
        <span class="token keyword">pass</span>

    <span class="token keyword">def</span> <span class="token function">get_geetest_button</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">''' 获取初始验证按钮,return：按钮对象 '''</span>
        button <span class="token operator">=</span> self<span class="token punctuation">.</span>wait<span class="token punctuation">.</span>until<span class="token punctuation">(</span>EC<span class="token punctuation">.</span>element_to_be_clickable<span class="token punctuation">(</span><span class="token punctuation">(</span>By<span class="token punctuation">.</span>CLASS_NAME<span class="token punctuation">,</span> <span class="token string">'geetest_radar_tip'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> button

    <span class="token keyword">def</span> <span class="token function">get_position</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">''' 获取验证码位置, return: 验证码位置(元组) '''</span>
        img <span class="token operator">=</span> self<span class="token punctuation">.</span>wait<span class="token punctuation">.</span>until<span class="token punctuation">(</span>EC<span class="token punctuation">.</span>presence_of_element_located<span class="token punctuation">(</span><span class="token punctuation">(</span>By<span class="token punctuation">.</span>CLASS_NAME<span class="token punctuation">,</span> <span class="token string">'geetest_canvas_img'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        location <span class="token operator">=</span> img<span class="token punctuation">.</span>location
        size <span class="token operator">=</span> img<span class="token punctuation">.</span>size
        top<span class="token punctuation">,</span>bottom<span class="token punctuation">,</span>left<span class="token punctuation">,</span>right <span class="token operator">=</span> location<span class="token punctuation">[</span><span class="token string">'y'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>location<span class="token punctuation">[</span><span class="token string">'y'</span><span class="token punctuation">]</span><span class="token operator">+</span>size<span class="token punctuation">[</span><span class="token string">'height'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>location<span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>location<span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">]</span><span class="token operator">+</span>size<span class="token punctuation">[</span><span class="token string">'width'</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">get_screenshot</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">''' 获取网页截图, return: 截图对象 '''</span>
        <span class="token comment">#浏览器截屏</span>
        screenshot <span class="token operator">=</span> self<span class="token punctuation">.</span>browser<span class="token punctuation">.</span>get_screenshot_as_png<span class="token punctuation">(</span><span class="token punctuation">)</span>
        screenshot <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>BytesIO<span class="token punctuation">(</span>screenshot<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> screenshot

    <span class="token keyword">def</span> <span class="token function">get_slider</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">''' 获取滑块, return: 滑块对象 '''</span>
        slider <span class="token operator">=</span> self<span class="token punctuation">.</span>wait<span class="token punctuation">.</span>until<span class="token punctuation">(</span>EC<span class="token punctuation">.</span>element_to_be_clickable<span class="token punctuation">(</span><span class="token punctuation">(</span>By<span class="token punctuation">.</span>CLASS_NAME<span class="token punctuation">,</span> <span class="token string">'geetest_slider_button'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> slider

    <span class="token keyword">def</span> <span class="token function">get_geetest_image</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'captcha.png'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">''' 获取验证码图片, return: 图片对象 '''</span>
        top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right <span class="token operator">=</span> self<span class="token punctuation">.</span>get_position<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'验证码位置'</span><span class="token punctuation">,</span> top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">)</span>
        screenshot <span class="token operator">=</span> self<span class="token punctuation">.</span>get_screenshot<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">#从网页截屏图片中裁剪处理验证图片</span>
        captcha <span class="token operator">=</span> screenshot<span class="token punctuation">.</span>crop<span class="token punctuation">(</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> right<span class="token punctuation">,</span> bottom<span class="token punctuation">)</span><span class="token punctuation">)</span>
        captcha<span class="token punctuation">.</span>save<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
        <span class="token keyword">return</span> captcha

    <span class="token keyword">def</span> <span class="token function">open</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">''' 打开网页输入用户名密码, return: None '''</span>
        self<span class="token punctuation">.</span>browser<span class="token punctuation">.</span>get<span class="token punctuation">(</span>self<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
        email <span class="token operator">=</span> self<span class="token punctuation">.</span>wait<span class="token punctuation">.</span>until<span class="token punctuation">(</span>EC<span class="token punctuation">.</span>presence_of_element_located<span class="token punctuation">(</span><span class="token punctuation">(</span>By<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token string">'email'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        password <span class="token operator">=</span> self<span class="token punctuation">.</span>wait<span class="token punctuation">.</span>until<span class="token punctuation">(</span>EC<span class="token punctuation">.</span>presence_of_element_located<span class="token punctuation">(</span><span class="token punctuation">(</span>By<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token string">'password'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        email<span class="token punctuation">.</span>send_keys<span class="token punctuation">(</span>self<span class="token punctuation">.</span>email<span class="token punctuation">)</span>
        password<span class="token punctuation">.</span>send_keys<span class="token punctuation">(</span>self<span class="token punctuation">.</span>password<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">get_gap</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> image1<span class="token punctuation">,</span> image2<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">''' 获取缺口偏移量, 参数：image1不带缺口图片、image2带缺口图片。返回偏移量 '''</span>
        left <span class="token operator">=</span> <span class="token number">65</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> image1<span class="token punctuation">.</span>size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>image1<span class="token punctuation">.</span>size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> <span class="token operator">not</span> self<span class="token punctuation">.</span>is_pixel_equal<span class="token punctuation">(</span>image1<span class="token punctuation">,</span> image2<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    left <span class="token operator">=</span> i
                    <span class="token keyword">return</span> left
        <span class="token keyword">return</span> left

    <span class="token keyword">def</span> <span class="token function">is_pixel_equal</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> image1<span class="token punctuation">,</span> image2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''
        判断两个像素是否相同
        :param image1: 图片1
        :param image2: 图片2
        :param x: 位置x
        :param y: 位置y
        :return: 像素是否相同
        '''</span>
        <span class="token comment"># 取两个图片的像素点（R、G、B）</span>
        pixel1 <span class="token operator">=</span> image1<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span>
        pixel2 <span class="token operator">=</span> image2<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span>
        threshold <span class="token operator">=</span> <span class="token number">60</span>
        <span class="token keyword">if</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>pixel1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span>pixel2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;</span>threshold <span class="token operator">and</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>pixel1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-</span>pixel2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;</span>threshold <span class="token operator">and</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>pixel1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">-</span>pixel2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;</span>threshold<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">True</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">False</span>

    <span class="token keyword">def</span> <span class="token function">get_track</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> distance<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''
        根据偏移量获取移动轨迹
        :param distance: 偏移量
        :return: 移动轨迹
        '''</span>
        <span class="token comment"># 移动轨迹</span>
        track <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment"># 当前位移</span>
        current <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token comment"># 减速阈值</span>
        mid <span class="token operator">=</span> distance <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">/</span> <span class="token number">5</span>
        <span class="token comment"># 计算间隔</span>
        t <span class="token operator">=</span> <span class="token number">0.2</span>
        <span class="token comment"># 初速度</span>
        v <span class="token operator">=</span> <span class="token number">0</span>

        <span class="token keyword">while</span> current <span class="token operator">&lt;</span> distance<span class="token punctuation">:</span>
            <span class="token keyword">if</span> current <span class="token operator">&lt;</span> mid<span class="token punctuation">:</span>
                <span class="token comment"># 加速度为正2</span>
                a <span class="token operator">=</span> <span class="token number">2</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token comment"># 加速度为负3</span>
                a <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">3</span>
            <span class="token comment"># 初速度v0</span>
            v0 <span class="token operator">=</span> v
            <span class="token comment"># 当前速度v = v0 + at</span>
            v <span class="token operator">=</span> v0 <span class="token operator">+</span> a <span class="token operator">*</span> t
            <span class="token comment"># 移动距离x = v0t + 1/2 * a * t^2</span>
            move <span class="token operator">=</span> v0 <span class="token operator">*</span> t <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">*</span> a <span class="token operator">*</span> t <span class="token operator">*</span> t
            <span class="token comment"># 当前位移</span>
            current <span class="token operator">+=</span> move
            <span class="token comment"># 加入轨迹</span>
            track<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>move<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> track

    <span class="token keyword">def</span> <span class="token function">move_to_gap</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> slider<span class="token punctuation">,</span> track<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''
        拖动滑块到缺口处
        :param slider: 滑块
        :param track: 轨迹
        :return: 
        '''</span>
        ActionChains<span class="token punctuation">(</span>self<span class="token punctuation">.</span>browser<span class="token punctuation">)</span><span class="token punctuation">.</span>click_and_hold<span class="token punctuation">(</span>slider<span class="token punctuation">)</span><span class="token punctuation">.</span>perform<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> x <span class="token keyword">in</span> track<span class="token punctuation">:</span>
            ActionChains<span class="token punctuation">(</span>self<span class="token punctuation">.</span>browser<span class="token punctuation">)</span><span class="token punctuation">.</span>move_by_offset<span class="token punctuation">(</span>xoffset<span class="token operator">=</span>x<span class="token punctuation">,</span> yoffset<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>perform<span class="token punctuation">(</span><span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>
        ActionChains<span class="token punctuation">(</span>self<span class="token punctuation">.</span>browser<span class="token punctuation">)</span><span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>perform<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">''' 执行登录 return: None '''</span>
        submit <span class="token operator">=</span> self<span class="token punctuation">.</span>wait<span class="token punctuation">.</span>until<span class="token punctuation">(</span>EC<span class="token punctuation">.</span>element_to_be_clickable<span class="token punctuation">(</span><span class="token punctuation">(</span>By<span class="token punctuation">.</span>CLASS_NAME<span class="token punctuation">,</span> <span class="token string">'login-btn'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        submit<span class="token punctuation">.</span>click<span class="token punctuation">(</span><span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'登录成功'</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">crack</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 输入用户名密码</span>
        self<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 点击验证按钮</span>
        button <span class="token operator">=</span> self<span class="token punctuation">.</span>get_geetest_button<span class="token punctuation">(</span><span class="token punctuation">)</span>
        button<span class="token punctuation">.</span>click<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 获取验证码图片</span>
        image1 <span class="token operator">=</span> self<span class="token punctuation">.</span>get_geetest_image<span class="token punctuation">(</span><span class="token string">'captcha1.png'</span><span class="token punctuation">)</span>
        <span class="token comment"># 点按呼出缺口</span>
        slider <span class="token operator">=</span> self<span class="token punctuation">.</span>get_slider<span class="token punctuation">(</span><span class="token punctuation">)</span>
        slider<span class="token punctuation">.</span>click<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 获取带缺口的验证码图片</span>
        image2 <span class="token operator">=</span> self<span class="token punctuation">.</span>get_geetest_image<span class="token punctuation">(</span><span class="token string">'captcha2.png'</span><span class="token punctuation">)</span>
        <span class="token comment"># 获取缺口位置</span>
        gap <span class="token operator">=</span> self<span class="token punctuation">.</span>get_gap<span class="token punctuation">(</span>image1<span class="token punctuation">,</span> image2<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'缺口位置'</span><span class="token punctuation">,</span> gap<span class="token punctuation">)</span>
        <span class="token comment"># 减去缺口位移</span>
        gap <span class="token operator">-=</span> BORDER
        <span class="token comment"># 获取移动轨迹</span>
        track <span class="token operator">=</span> self<span class="token punctuation">.</span>get_track<span class="token punctuation">(</span>gap<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'滑动轨迹'</span><span class="token punctuation">,</span> track<span class="token punctuation">)</span>
        <span class="token comment"># 拖动滑块</span>
        self<span class="token punctuation">.</span>move_to_gap<span class="token punctuation">(</span>slider<span class="token punctuation">,</span> track<span class="token punctuation">)</span>

        success <span class="token operator">=</span> self<span class="token punctuation">.</span>wait<span class="token punctuation">.</span>until<span class="token punctuation">(</span>
            EC<span class="token punctuation">.</span>text_to_be_present_in_element<span class="token punctuation">(</span><span class="token punctuation">(</span>By<span class="token punctuation">.</span>CLASS_NAME<span class="token punctuation">,</span> <span class="token string">'geetest_success_radar_tip_content'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'验证成功'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span>

        <span class="token comment"># 失败后重试</span>
        <span class="token keyword">if</span> <span class="token operator">not</span> success<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>crack<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>login<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 程序主入口</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    crack <span class="token operator">=</span> CrackGeetest<span class="token punctuation">(</span><span class="token punctuation">)</span>
    crack<span class="token punctuation">.</span>crack<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="23__5503"></a>23. 爬虫项目需求分析</h3> 
<h5><a id="1__5505"></a>1 项目名称</h5> 
<ul><li>《豆瓣读书信息爬取项目》</li></ul> 
<h5><a id="2__5509"></a>2 项目描述：</h5> 
<ul><li> <p>使用Python编程语言编写一个网络爬虫项目，将豆瓣读书网站上的所有图书信息爬取下来，并存储到MySQL数据库中。</p> </li><li> <p>爬取信息字段要求：<br> [ID号、书名、作者、出版社、原作名、译者、出版年、页数、定价、装帧、丛书、ISBN、评分、评论人数]</p> <p><img src="https://images2.imgbox.com/f8/fe/wIquqYx0_o.png" alt="img">]</p> </li></ul> 
<h5><a id="3__5518"></a>3 爬取网站过程分析：</h5> 
<ul><li>打开豆瓣读书的首页：https://book.douban.com/</li></ul> 
<p><img src="https://images2.imgbox.com/d6/4e/aP16aw27_o.png" alt="img">]</p> 
<ul><li>在豆瓣读书首页的右侧点击<code>所有热门标签</code>，打开<code>豆瓣图书标签</code>页面：</li><li>网址：https://book.douban.com/tag/?view=type&amp;icn=index-sorttags-all</li></ul> 
<p><img src="https://images2.imgbox.com/0c/6d/YLYCVVjd_o.png" alt="img">]</p> 
<ul><li>点击<code>豆瓣图书标签</code>页面中所有的标签，进行对应标签下图书信息的列表页展示。</li></ul> 
<p><img src="https://images2.imgbox.com/72/fc/o51WhbYy_o.png" alt="img">] <img src="https://images2.imgbox.com/13/21/pSCA82Fo_o.png" alt="img">]</p> 
<ul><li>在豆瓣图书列表页中可以获取每本圖片詳情信息。</li></ul> 
<p><img src="https://images2.imgbox.com/14/49/yOmj29VB_o.png" alt="img">]</p> 
<h5><a id="4__5537"></a>4 运行环境要求：</h5> 
<ul><li>运行环境描述： 
  <ul><li>操作系统：Windows/Linux/Mac</li><li>python语言3.5以上版本</li><li>MySQL数据库</li><li>Redis数据库</li><li>Scrapy框架</li><li>Scrapy-Redis</li><li>还有其他各种驱动组件，使用pip命令安装</li></ul> </li></ul> 
<h5><a id="5__5548"></a>5 项目中的建议：</h5> 
<ul><li>本次项目信息爬取量大，建议使用分布式信息爬取。</li><li>访问时的错误：</li></ul> 
<pre><code>检测到有异常请求从你的 IP 发出，请`登录`使用豆瓣。
</code></pre> 
<ul><li>爬取豆瓣遇到的问题：https://blog.csdn.net/eye_water/article/details/78585394</li></ul> 
<pre><code>最近需要爬取豆瓣的用户评分数据构造一个数据集，但是在爬取时却出了问题: 
豆瓣封IP，白天一分钟可以访问40次，晚上一分钟可以访问60次，超过限制次数就会封IP。 
于是，我便去代理IP网站上找了几个代理IP，但是爬取时又碰到了问题，明明已经使用代理IP，但是一旦超过限制次数爬虫仍然不能正常访问豆瓣。 
问题出在Cookie上 
豆瓣利用封IP+封Cookie来限制爬虫，因此只用代理IP的话也不行，Cookie也要更换。 
想法一： 
每次使用代理IP时，先访问豆瓣官网获取Cookie再访问用户的评论页面。本以为换了IP，Cookie随之也会更换，其实Cookie并没有改变。 
想法二： 
伪造Cookie。 
观察豆瓣设置的Cookie格式，并进行伪造。
</code></pre> 
<h3><a id="24__5572"></a>24. 爬虫项目架构设计</h3> 
<h5><a id="1__5574"></a>1. 数据库设计：</h5> 
<ul><li>为了方便后续的数据处理，将所有图书信息都汇总的一张数据表中。</li><li>创建数据库：<code>doubandb</code></li><li>进入数据库创建数据表：<code>books</code></li><li>表中字段：</li></ul> 
<pre><code>    [ 
      ID号、书名、作者、出版社、原作名、译者、出版年、页数、
      定价、装帧、丛书、ISBN、评分、评论人数
    ]
</code></pre> 
<ul><li>数据表结构：</li></ul> 
<pre><code class="prism language-mysql">CREATE TABLE `books` (                                            
  `id` bigint(20) unsigned NOT NULL COMMENT 'ID号',              
  `title` varchar(255) DEFAULT NULL COMMENT '书名',             
  `author` varchar(64) DEFAULT NULL COMMENT '作者',             
  `press` varchar(255) DEFAULT NULL COMMENT '出版社',          
  `original` varchar(255) DEFAULT NULL COMMENT '原作名',       
  `translator` varchar(128) DEFAULT NULL COMMENT '译者',        
  `imprint` varchar(128) DEFAULT NULL COMMENT '出版年',        
  `pages` int(10) unsigned DEFAULT NULL COMMENT '页数',         
  `price` double(6,2) unsigned DEFAULT NULL COMMENT '定价',     
  `binding` varchar(32) DEFAULT NULL COMMENT '装帧',            
  `series` varchar(128) DEFAULT NULL COMMENT '丛书',            
  `isbn` varchar(128) DEFAULT NULL COMMENT 'ISBN',                
  `score` varchar(128) DEFAULT NULL COMMENT '评分',             
  `number` int(10) unsigned DEFAULT NULL COMMENT '评论人数',  
  PRIMARY KEY (`id`)                                              
) ENGINE=InnoDB DEFAULT CHARSET=utf8
</code></pre> 
<h5><a id="2__5610"></a>2. 项目结构：</h5> 
<ul><li>本次项目设计分为四个模块，如下图所示：</li></ul> 
<p><img src="https://images2.imgbox.com/19/8b/NVrUp4oU_o.png" alt="img">]</p> 
<ul><li>说明： 
  <ul><li>模块一：实现豆瓣图书信息所有标签信息的爬取，并图书的标签信息写入到Redis数据库中，此模块可使用rquests简单实现。</li><li>模块二：负责从Redis中获取每个图书标签，并分页式的爬取每本图书的url信息，并将信息写入到redis中。</li><li>模块三：负责从Redis中获取每个图书的url地址，并爬取对应的图书详情，将每本图书详情信息写回到redis数据库中。</li><li>模块四：负责从Redis中获取每本图书的详情信息，并将信息依次写入到MySQL数据中，作为最终的爬取信息。</li></ul> </li><li>本次项目结构采用Scrapy-Redis主从分布式架构： 
  <ul><li>主master负责爬取每本图书的url地址（要去重），并将信息添加到Redis的url队列中（模块二）</li><li>从slave负责从Redis的url队列中获取每本书的url，并爬取对应的图书信息（过滤掉无用数据）（模块三）。</li></ul> </li></ul> 
<h5><a id="3__5625"></a>3. 具体实施描述</h5> 
<h5><a id="4__5627"></a>4. 项目中的规范：</h5> 
<h3><a id="25__5629"></a>25. 爬虫项目的代码实现</h3> 
<h4><a id="251__5631"></a>25.1 数据库的准备：</h4> 
<ul><li>启动MySQL和Redis数据库</li><li>在MySQL数据库中创建数据库：<code>doubandb</code>，并进入数据库中创建<code>books</code>数据表</li></ul> 
<pre><code class="prism language-mysql">CREATE TABLE `books` (                                            
  `id` bigint(20) unsigned NOT NULL COMMENT 'ID号',              
  `title` varchar(255) DEFAULT NULL COMMENT '书名',             
  `author` varchar(64) DEFAULT NULL COMMENT '作者',             
  `press` varchar(255) DEFAULT NULL COMMENT '出版社',          
  `original` varchar(255) DEFAULT NULL COMMENT '原作名',       
  `translator` varchar(128) DEFAULT NULL COMMENT '译者',        
  `imprint` varchar(128) DEFAULT NULL COMMENT '出版年',        
  `pages` int(10) unsigned DEFAULT NULL COMMENT '页数',         
  `price` double(6,2) unsigned DEFAULT NULL COMMENT '定价',     
  `binding` varchar(32) DEFAULT NULL COMMENT '装帧',            
  `series` varchar(128) DEFAULT NULL COMMENT '丛书',            
  `isbn` varchar(128) DEFAULT NULL COMMENT 'ISBN',                
  `score` varchar(128) DEFAULT NULL COMMENT '评分',             
  `number` int(10) unsigned DEFAULT NULL COMMENT '评论人数',  
  PRIMARY KEY (`id`)                                              
) ENGINE=InnoDB DEFAULT CHARSET=utf8
</code></pre> 
<h4><a id="252_1_5656"></a>25.2 模块1的实现：</h4> 
<ul><li>实现豆瓣图书信息所有标签信息的爬取，并图书的标签信息写入到Redis数据库中，此模块可使用rquests简单实现。</li><li>创建一个独立的python文件：load_tag_url.py 代码如下</li></ul> 
<pre><code class="prism language-python"><span class="token comment">#使用requests加pyquery爬取所有豆瓣图书标签信息，并将信息储存于redis中</span>

<span class="token keyword">import</span> requests
<span class="token keyword">from</span> pyquery <span class="token keyword">import</span> PyQuery <span class="token keyword">as</span> pq
<span class="token keyword">import</span> redis

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#使用requests爬取所有豆瓣图书标签信息</span>
    url <span class="token operator">=</span> <span class="token string">"https://book.douban.com/tag/?view=type&amp;icn=index-sorttags-all"</span>
    res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"status:%d"</span> <span class="token operator">%</span> res<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span>
    html <span class="token operator">=</span> res<span class="token punctuation">.</span>content<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>

    <span class="token comment"># 使用Pyquery解析HTML文档</span>
    <span class="token comment">#print(html)</span>
    doc <span class="token operator">=</span> pq<span class="token punctuation">(</span>html<span class="token punctuation">)</span>
    <span class="token comment">#获取网页中所有豆瓣图书标签链接信息</span>
    items <span class="token operator">=</span> doc<span class="token punctuation">(</span><span class="token string">"table.tagCol tr td a"</span><span class="token punctuation">)</span>

    <span class="token comment"># 指定Redis数据库信息</span>
    link <span class="token operator">=</span> redis<span class="token punctuation">.</span>StrictRedis<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">6379</span><span class="token punctuation">,</span> db<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token comment">#遍历封装数据并返回</span>
    <span class="token keyword">for</span> a <span class="token keyword">in</span> items<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#拼装tag的url地址信息</span>
        tag <span class="token operator">=</span> a<span class="token punctuation">.</span>attr<span class="token punctuation">.</span>href
        <span class="token comment">#将信息以tag:start_urls写入到Redis中</span>
        link<span class="token punctuation">.</span>lpush<span class="token punctuation">(</span><span class="token string">"book:tag_urls"</span><span class="token punctuation">,</span>tag<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"共计写入tag：%d个"</span><span class="token operator">%</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">#主程序入口</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li>运行：<code>python load_tag_url.py</code></li></ul> 
<h4><a id="253_2_5699"></a>25.3 模块2的实现：</h4> 
<ul><li>此模块负责从Redis中获取每个图书标签，并分页式的爬取每本图书的url信息，并将信息写入到redis中。</li><li>① 首先在命令行编写下面命令，创建项目master(主)和爬虫文件</li></ul> 
<pre><code>scrapy startproject  master

cd master

scrapy genspider book book.douban.com
</code></pre> 
<ul><li>② 编辑<code>master/item.py</code> 文件</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">import</span> scrapy

<span class="token keyword">class</span> <span class="token class-name">MasterItem</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Item<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># define the fields for your item here like:</span>
    url <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">#pass</span>
</code></pre> 
<ul><li>③ 编辑<code>master/settings.py</code> 文件</li></ul> 
<pre><code class="prism language-python"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

ROBOTSTXT_OBEY <span class="token operator">=</span> <span class="token boolean">False</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token comment">#下载器在下载同一个网站下一个页面前需要等待的时间。该选项可以用来限制爬取速度， 减轻服务器压力。同时也支持小数:</span>
DOWNLOAD_DELAY <span class="token operator">=</span> <span class="token number">2</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token comment"># Override the default request headers:</span>
DEFAULT_REQUEST_HEADERS <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">#   'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',</span>
<span class="token comment">#   'Accept-Language': 'en',</span>
    <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/5.0 (Windows NT 6.1; WOW64; rv:43.0) Gecko/20100101 Firefox/43.0'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

ITEM_PIPELINES <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'master.pipelines.MasterPipeline'</span><span class="token punctuation">:</span> <span class="token number">300</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token comment"># 指定使用scrapy-redis的去重</span>
DUPEFILTER_CLASS <span class="token operator">=</span> <span class="token string">'scrapy_redis.dupefilter.RFPDupeFilter'</span>

<span class="token comment"># 指定使用scrapy-redis的调度器</span>
SCHEDULER <span class="token operator">=</span> <span class="token string">"scrapy_redis.scheduler.Scheduler"</span>

<span class="token comment"># 在redis中保持scrapy-redis用到的各个队列，从而允许暂停和暂停后恢复，也就是不清理redis queues</span>
SCHEDULER_PERSIST <span class="token operator">=</span> <span class="token boolean">True</span>

<span class="token comment"># 指定排序爬取地址时使用的队列，</span>
<span class="token comment"># 默认的 按优先级排序(Scrapy默认)，由sorted set实现的一种非FIFO、LIFO方式。</span>
SCHEDULER_QUEUE_CLASS <span class="token operator">=</span> <span class="token string">'scrapy_redis.queue.SpiderPriorityQueue'</span>

<span class="token comment"># REDIS_URL = 'redis://localhost:6379' # 一般情况可以省去</span>
REDIS_HOST <span class="token operator">=</span> <span class="token string">'localhost'</span> <span class="token comment"># 也可以根据情况改成 localhost</span>
REDIS_PORT <span class="token operator">=</span> <span class="token number">6379</span>
</code></pre> 
<ul><li>④ 编辑<code>master/spiders/book.py</code> 文件</li></ul> 
<pre><code class="prism language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">import</span> scrapy
<span class="token keyword">from</span> master<span class="token punctuation">.</span>items <span class="token keyword">import</span> MasterItem 
<span class="token keyword">from</span> scrapy <span class="token keyword">import</span> Request
<span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> quote
<span class="token keyword">import</span> redis<span class="token punctuation">,</span>re<span class="token punctuation">,</span>time<span class="token punctuation">,</span>random

<span class="token keyword">class</span> <span class="token class-name">BookSpider</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">'master_book'</span>
    allowed_domains <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'book.douban.com'</span><span class="token punctuation">]</span>
    base_url <span class="token operator">=</span> <span class="token string">'https://book.douban.com'</span>

    <span class="token keyword">def</span> <span class="token function">start_requests</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">''' 从redis中获取，并爬取标签对应的网页信息 '''</span>
        r <span class="token operator">=</span> redis<span class="token punctuation">.</span>Redis<span class="token punctuation">(</span>host<span class="token operator">=</span>self<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"REDIS_HOST"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> port<span class="token operator">=</span>self<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"REDIS_PORT"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> decode_responses<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token keyword">while</span> r<span class="token punctuation">.</span>llen<span class="token punctuation">(</span><span class="token string">'book:tag_urls'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            tag <span class="token operator">=</span> r<span class="token punctuation">.</span>lpop<span class="token punctuation">(</span><span class="token string">'book:tag_urls'</span><span class="token punctuation">)</span>
            url <span class="token operator">=</span> self<span class="token punctuation">.</span>base_url <span class="token operator">+</span> quote<span class="token punctuation">(</span>tag<span class="token punctuation">)</span>
            <span class="token keyword">yield</span> Request<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>parse<span class="token punctuation">,</span>dont_filter<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">''' 解析每页的图书详情的url地址信息 '''</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
        lists <span class="token operator">=</span> response<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">'#subject_list ul li.subject-item a.nbg::attr(href)'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> lists<span class="token punctuation">:</span>
            <span class="token keyword">for</span> i <span class="token keyword">in</span> lists<span class="token punctuation">:</span>
                item <span class="token operator">=</span> MasterItem<span class="token punctuation">(</span><span class="token punctuation">)</span>
                item<span class="token punctuation">[</span><span class="token string">'url'</span><span class="token punctuation">]</span> <span class="token operator">=</span> i
                <span class="token keyword">yield</span> item

        <span class="token comment">#获取下一页的url地址</span>
        next_url <span class="token operator">=</span> response<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">"span.next a::attr(href)"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">#判断若不是最后一页</span>
        <span class="token keyword">if</span> next_url<span class="token punctuation">:</span>
            url <span class="token operator">=</span> response<span class="token punctuation">.</span>urljoin<span class="token punctuation">(</span>next_url<span class="token punctuation">)</span>
            <span class="token comment">#构造下一页招聘列表信息的爬取</span>
            <span class="token keyword">yield</span> scrapy<span class="token punctuation">.</span>Request<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span>callback<span class="token operator">=</span>self<span class="token punctuation">.</span>parse<span class="token punctuation">)</span>
</code></pre> 
<ul><li>⑤ 编辑<code>master/pipelines.py</code> 文件</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">import</span> redis<span class="token punctuation">,</span>re

<span class="token keyword">class</span> <span class="token class-name">MasterPipeline</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>host<span class="token punctuation">,</span>port<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#连接redis数据库</span>
        self<span class="token punctuation">.</span>r <span class="token operator">=</span> redis<span class="token punctuation">.</span>Redis<span class="token punctuation">(</span>host<span class="token operator">=</span>host<span class="token punctuation">,</span> port<span class="token operator">=</span>port<span class="token punctuation">,</span> decode_responses<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    @<span class="token builtin">classmethod</span>
    <span class="token keyword">def</span> <span class="token function">from_crawler</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span>crawler<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''注入实例化对象（传入参数）'''</span>
        <span class="token keyword">return</span> cls<span class="token punctuation">(</span>
            host <span class="token operator">=</span> crawler<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"REDIS_HOST"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            port <span class="token operator">=</span> crawler<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"REDIS_PORT"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">process_item</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> item<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>  
        <span class="token comment">#使用正则判断url地址是否有效，并写入redis。</span>
        bookid <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">"book.douban.com/subject/([0-9]+)/"</span><span class="token punctuation">,</span>item<span class="token punctuation">[</span><span class="token string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> bookid<span class="token punctuation">:</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>r<span class="token punctuation">.</span>sadd<span class="token punctuation">(</span><span class="token string">'books:id'</span><span class="token punctuation">,</span>bookid<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>r<span class="token punctuation">.</span>lpush<span class="token punctuation">(</span><span class="token string">'bookspider:start_urls'</span><span class="token punctuation">,</span> item<span class="token punctuation">[</span><span class="token string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>r<span class="token punctuation">.</span>lpush<span class="token punctuation">(</span><span class="token string">'bookspider:no_urls'</span><span class="token punctuation">,</span> item<span class="token punctuation">[</span><span class="token string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li>⑥ 测试运行：</li></ul> 
<pre><code>  scarpy crawl master_book
</code></pre> 
<h4><a id="254_3_5846"></a>25.4 模块3的实现：</h4> 
<ul><li>负责从Redis中获取每个图书的url地址，并爬取对应的图书详情，将每本图书详情信息写回到redis数据库中。</li><li>① 首先在命令行编写下面命令，创建项目salve(从)和爬虫文件</li></ul> 
<pre><code>scrapy startproject  salve

cd salve

scrapy genspider book book.douban.com
</code></pre> 
<ul><li>② 编辑<code>salve/item.py</code> 文件</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">import</span> scrapy

<span class="token keyword">class</span> <span class="token class-name">BookItem</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Item<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># define the fields for your item here like:</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>       <span class="token comment">#ID号</span>
    title <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">#书名</span>
    author <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">#作者</span>
    press <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">#出版社</span>
    original <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#原作名</span>
    translator <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#译者</span>
    imprint <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">#出版年</span>
    pages <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">#页数</span>
    price <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">#定价</span>
    binding <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">#装帧</span>
    series <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">#丛书</span>
    isbn <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>     <span class="token comment">#ISBN</span>
    score <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">#评分</span>
    number <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">#评论人数</span>
    <span class="token comment">#pass</span>
</code></pre> 
<ul><li>③ 编辑<code>salve/settings.py</code> 文件</li></ul> 
<pre><code class="prism language-python">BOT_NAME <span class="token operator">=</span> <span class="token string">'slave'</span>

SPIDER_MODULES <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'slave.spiders'</span><span class="token punctuation">]</span>
NEWSPIDER_MODULE <span class="token operator">=</span> <span class="token string">'slave.spiders'</span>


<span class="token comment"># Obey robots.txt rules</span>
ROBOTSTXT_OBEY <span class="token operator">=</span> <span class="token boolean">False</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token comment"># Override the default request headers:</span>
DEFAULT_REQUEST_HEADERS <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">#   'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',</span>
<span class="token comment">#   'Accept-Language': 'en',</span>
    <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/5.0 (Windows NT 6.1; WOW64; rv:43.0) Gecko/20100101 Firefox/43.0'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

ITEM_PIPELINES <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">#'slave.pipelines.SlavePipeline': 300,</span>
    <span class="token string">'scrapy_redis.pipelines.RedisPipeline'</span><span class="token punctuation">:</span> <span class="token number">400</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token comment"># 指定使用scrapy-redis的去重</span>
DUPEFILTER_CLASS <span class="token operator">=</span> <span class="token string">'scrapy_redis.dupefilter.RFPDupeFilter'</span>

<span class="token comment"># 指定使用scrapy-redis的调度器</span>
SCHEDULER <span class="token operator">=</span> <span class="token string">"scrapy_redis.scheduler.Scheduler"</span>

<span class="token comment"># 在redis中保持scrapy-redis用到的各个队列，从而允许暂停和暂停后恢复，也就是不清理redis queues</span>
SCHEDULER_PERSIST <span class="token operator">=</span> <span class="token boolean">True</span>

<span class="token comment"># 指定排序爬取地址时使用的队列，</span>
<span class="token comment"># 默认的 按优先级排序(Scrapy默认)，由sorted set实现的一种非FIFO、LIFO方式。</span>
SCHEDULER_QUEUE_CLASS <span class="token operator">=</span> <span class="token string">'scrapy_redis.queue.SpiderPriorityQueue'</span>

<span class="token comment"># REDIS_URL = 'redis://localhost:6379' # 一般情况可以省去</span>
REDIS_HOST <span class="token operator">=</span> <span class="token string">'localhost'</span> <span class="token comment"># 也可以根据情况改成 localhost</span>
REDIS_PORT <span class="token operator">=</span> <span class="token number">6379</span>
</code></pre> 
<ul><li>④ 编辑<code>salve/spiders/book.py</code> 文件</li></ul> 
<pre><code class="prism language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">import</span> scrapy<span class="token punctuation">,</span>re
<span class="token keyword">from</span> slave<span class="token punctuation">.</span>items <span class="token keyword">import</span> BookItem
<span class="token keyword">from</span> scrapy_redis<span class="token punctuation">.</span>spiders <span class="token keyword">import</span> RedisSpider

<span class="token keyword">class</span> <span class="token class-name">BookSpider</span><span class="token punctuation">(</span>RedisSpider<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">'slave_book'</span>
    <span class="token comment">#allowed_domains = ['book.douban.com']</span>
    <span class="token comment">#start_urls = ['http://book.douban.com/']</span>
    redis_key <span class="token operator">=</span> <span class="token string">"bookspider:start_urls"</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># Dynamically define the allowed domains list.</span>
        domain <span class="token operator">=</span> kwargs<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">'domain'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>allowed_domains <span class="token operator">=</span> <span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> domain<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>BookSpider<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"======================"</span><span class="token punctuation">,</span>response<span class="token punctuation">.</span>status<span class="token punctuation">)</span>
        item <span class="token operator">=</span> BookItem<span class="token punctuation">(</span><span class="token punctuation">)</span>
        vo <span class="token operator">=</span> response<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">"#wrapper"</span><span class="token punctuation">)</span>
        item<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> vo<span class="token punctuation">.</span>re_first<span class="token punctuation">(</span><span class="token string">'id="collect_form_([0-9]+)"'</span><span class="token punctuation">)</span> <span class="token comment">#ID号</span>
        item<span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span> <span class="token operator">=</span> vo<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">"h1 span::text"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#书名</span>

        <span class="token comment">#使用正则获取里面的info里面的图书信息</span>
        info <span class="token operator">=</span> vo<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">"#info"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">#print(info)</span>
        authors <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">'&lt;span.*?作者.*?&lt;/span&gt;(.*?)&lt;br&gt;'</span><span class="token punctuation">,</span>info<span class="token punctuation">,</span>re<span class="token punctuation">.</span>S<span class="token punctuation">)</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        item<span class="token punctuation">[</span><span class="token string">'author'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"、"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'&lt;a.*?&gt;(.*?)&lt;/a&gt;'</span><span class="token punctuation">,</span>authors<span class="token punctuation">,</span>re<span class="token punctuation">.</span>S<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#作者</span>
        item<span class="token punctuation">[</span><span class="token string">'press'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">" "</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'&lt;span.*?出版社:&lt;/span&gt;\s*(.*?)&lt;br&gt;'</span><span class="token punctuation">,</span>info<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#出版社</span>
        item<span class="token punctuation">[</span><span class="token string">'original'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">" "</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'&lt;span.*?原作名:&lt;/span&gt;\s*(.*?)&lt;br&gt;'</span><span class="token punctuation">,</span>info<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#原作名</span>
        yz <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">'&lt;span.*?译者.*?&lt;/span&gt;(.*?)&lt;br&gt;'</span><span class="token punctuation">,</span>info<span class="token punctuation">,</span>re<span class="token punctuation">.</span>S<span class="token punctuation">)</span>
        <span class="token keyword">if</span> yz<span class="token punctuation">:</span>
            item<span class="token punctuation">[</span><span class="token string">'translator'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"、"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'&lt;a.*?&gt;(.*?)&lt;/a&gt;'</span><span class="token punctuation">,</span>yz<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>re<span class="token punctuation">.</span>S<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#译者</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            item<span class="token punctuation">[</span><span class="token string">'translator'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">""</span>
        item<span class="token punctuation">[</span><span class="token string">'imprint'</span><span class="token punctuation">]</span> <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">'&lt;span.*?出版年:&lt;/span&gt;\s*([0-9\-]+)&lt;br&gt;'</span><span class="token punctuation">,</span>info<span class="token punctuation">)</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">#出版年</span>
        item<span class="token punctuation">[</span><span class="token string">'pages'</span><span class="token punctuation">]</span> <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">'&lt;span.*?页数:&lt;/span&gt;\s*([0-9]+)&lt;br&gt;'</span><span class="token punctuation">,</span>info<span class="token punctuation">)</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">#页数</span>
        item<span class="token punctuation">[</span><span class="token string">'price'</span><span class="token punctuation">]</span> <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">'&lt;span.*?定价:&lt;/span&gt;.*?([0-9\.]+)元?&lt;br&gt;'</span><span class="token punctuation">,</span>info<span class="token punctuation">)</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">#定价</span>
        item<span class="token punctuation">[</span><span class="token string">'binding'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">" "</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'&lt;span.*?装帧:&lt;/span&gt;\s*(.*?)&lt;br&gt;'</span><span class="token punctuation">,</span>info<span class="token punctuation">,</span>re<span class="token punctuation">.</span>S<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#装帧</span>
        item<span class="token punctuation">[</span><span class="token string">'series'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">" "</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'&lt;span.*?丛书:&lt;/span&gt;.*?&lt;a .*?&gt;(.*?)&lt;/a&gt;&lt;br&gt;'</span><span class="token punctuation">,</span>info<span class="token punctuation">,</span>re<span class="token punctuation">.</span>S<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#丛书</span>
        item<span class="token punctuation">[</span><span class="token string">'isbn'</span><span class="token punctuation">]</span> <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">'&lt;span.*?ISBN:&lt;/span&gt;\s*([0-9]+)&lt;br&gt;'</span><span class="token punctuation">,</span>info<span class="token punctuation">)</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">#ISBN</span>

        item<span class="token punctuation">[</span><span class="token string">'score'</span><span class="token punctuation">]</span> <span class="token operator">=</span> vo<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">"strong.rating_num::text"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#评分</span>
        item<span class="token punctuation">[</span><span class="token string">'number'</span><span class="token punctuation">]</span> <span class="token operator">=</span> vo<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">"a.rating_people span::text"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#评论人数</span>
        <span class="token comment">#print(item)</span>
        <span class="token keyword">yield</span> item
</code></pre> 
<ul><li>⑤ 编辑<code>salve/pipelines.py</code> 文件</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">SlavePipeline</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">process_item</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> item<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> item
</code></pre> 
<ul><li>⑥ 测试运行</li></ul> 
<pre><code># 在spider目录下和book.py在一起。
scrapy runspider book.py
</code></pre> 
<h4><a id="255_4_5998"></a>25.5 模块4的实现：</h4> 
<ul><li>负责从Redis中获取每本图书的详情信息，并将信息依次写入到MySQL数据中，作为最终的爬取信息。</li><li>在当前目录下创建一个：item_save.py的独立爬虫文件</li></ul> 
<pre><code class="prism language-python"><span class="token comment">#将Redis中的Item信息遍历写入到数据库中</span>
<span class="token keyword">import</span> json
<span class="token keyword">import</span> redis
<span class="token keyword">import</span> pymysql

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token comment"># 指定Redis数据库信息</span>
    rediscli <span class="token operator">=</span> redis<span class="token punctuation">.</span>StrictRedis<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">6379</span><span class="token punctuation">,</span> db<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token comment"># 指定MySQL数据库信息</span>
    db <span class="token operator">=</span> pymysql<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">"localhost"</span><span class="token punctuation">,</span>user<span class="token operator">=</span><span class="token string">"root"</span><span class="token punctuation">,</span>password<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">,</span>db<span class="token operator">=</span><span class="token string">"doubandb"</span><span class="token punctuation">,</span>charset<span class="token operator">=</span><span class="token string">"utf8"</span><span class="token punctuation">)</span>
    <span class="token comment">#使用cursor()方法创建一个游标对象cursor</span>
    cursor <span class="token operator">=</span> db<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token comment"># FIFO模式为 blpop，LIFO模式为 brpop，获取键值</span>
        source<span class="token punctuation">,</span> data <span class="token operator">=</span> rediscli<span class="token punctuation">.</span>blpop<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"book:items"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            item <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
            <span class="token comment">#组装sql语句</span>
            dd <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
            keys <span class="token operator">=</span> <span class="token string">','</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>dd<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            values<span class="token operator">=</span><span class="token string">','</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'%s'</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token builtin">len</span><span class="token punctuation">(</span>dd<span class="token punctuation">)</span><span class="token punctuation">)</span>
            sql <span class="token operator">=</span> <span class="token string">"insert into books(%s) values(%s)"</span><span class="token operator">%</span><span class="token punctuation">(</span>keys<span class="token punctuation">,</span>values<span class="token punctuation">)</span>
            <span class="token comment">#指定参数，并执行sql添加</span>
            cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">,</span><span class="token builtin">tuple</span><span class="token punctuation">(</span>dd<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">#事务提交</span>
            db<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"写入信息成功："</span><span class="token punctuation">,</span>dd<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> err<span class="token punctuation">:</span>
            <span class="token comment">#事务回滚</span>
            db<span class="token punctuation">.</span>rollback<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"SQL执行错误，原因："</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span>

<span class="token comment">#主程序入口</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li>使用python命令测试即可</li></ul> 
<h4><a id="256__6047"></a>25.6 反爬处理：</h4> 
<ul><li>降低爬取频率</li><li>浏览器伪装</li><li>IP代理服务的使用</li></ul> 
<h3><a id="26_web_6053"></a>26. 使用web展示爬取信息</h3> 
<h4><a id="261_mywebweb_6055"></a>26.1 创建项目myweb和应用web</h4> 
<pre><code>    # 创建项目框架myweb
    $ django-admin startproject myweb

    $ cd myweb

    # 在项目中创建一个web应用
    $ python3 manage.py startapp web

    # 创建模板目录
    $ mkdir templates
    $ mkdir templates/web

    $ cd ..

    $ tree myweb

    myweb
    ├── myweb
    │   ├── __init__.py
    │   ├── settings.py
    │   ├── urls.py
    │   └── wsgi.py
    ├── manage.py
    ├── web
    │   ├── admin.py
    │   ├── apps.py
    │   ├── __init__.py
    │   ├── models.py
    │   ├── tests.py
    │   └── views.py
    └── templates
        └── web
</code></pre> 
<h4><a id="262__6092"></a>26.2 执行数据库连接配置,网站配置</h4> 
<ul><li>① 编辑myweb/web/<strong>init</strong>.py文件，添加Pymysql的数据库操作支持</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">import</span> pymysql
pymysql<span class="token punctuation">.</span>install_as_MySQLdb<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li>② 编辑myweb/web/settings.py文件，配置数据库连接</li></ul> 
<pre><code class="prism language-python"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment">#配置自己的服务器IP地址</span>
ALLOWED_HOSTS <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'*'</span><span class="token punctuation">]</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment">#添加自己应用</span>
INSTALLED_APPS <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'django.contrib.admin'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.auth'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.contenttypes'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.sessions'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.messages'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.staticfiles'</span><span class="token punctuation">,</span>
    <span class="token string">'web'</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token comment"># 配置模板路径信息</span>
TEMPLATES <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token string">'BACKEND'</span><span class="token punctuation">:</span> <span class="token string">'django.template.backends.django.DjangoTemplates'</span><span class="token punctuation">,</span>
        <span class="token string">'DIRS'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>BASE_DIR<span class="token punctuation">,</span><span class="token string">'templates'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">'APP_DIRS'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
        <span class="token string">'OPTIONS'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">'context_processors'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token string">'django.template.context_processors.debug'</span><span class="token punctuation">,</span>
                <span class="token string">'django.template.context_processors.request'</span><span class="token punctuation">,</span>
                <span class="token string">'django.contrib.auth.context_processors.auth'</span><span class="token punctuation">,</span>
                <span class="token string">'django.contrib.messages.context_processors.messages'</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>


<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment"># 数据库连接配置</span>
DATABASES <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
<span class="token string">'default'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'ENGINE'</span><span class="token punctuation">:</span> <span class="token string">'django.db.backends.mysql'</span><span class="token punctuation">,</span>
    <span class="token string">'NAME'</span><span class="token punctuation">:</span> <span class="token string">'doubandb'</span><span class="token punctuation">,</span>
    <span class="token string">'USER'</span><span class="token punctuation">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
    <span class="token string">'PASSWORD'</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    <span class="token string">'HOST'</span><span class="token punctuation">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
    <span class="token string">'PORT'</span><span class="token punctuation">:</span> <span class="token string">'3306'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<h4><a id="263_Model_6153"></a>26.3 定义Model类</h4> 
<ul><li>编辑myweb/web/models.py</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>db <span class="token keyword">import</span> models

<span class="token comment">#图书信息模型</span>
<span class="token keyword">class</span> <span class="token class-name">Books</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    title <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token comment">#书名</span>
    author <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token comment">#作者</span>
    press <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">255</span><span class="token punctuation">)</span>  <span class="token comment">#出版社</span>
    original <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token comment">#原作名</span>
    translator <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token comment">#译者</span>
    imprint <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token comment">#出版年</span>
    pages <span class="token operator">=</span> models<span class="token punctuation">.</span>IntegerField<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">#页数</span>
    price <span class="token operator">=</span> models<span class="token punctuation">.</span>FloatField<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#定价</span>
    binding <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token comment">#装帧</span>
    series <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token comment">#丛书</span>
    isbn <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token comment">#ISBN</span>
    score <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token comment">#评分</span>
    number <span class="token operator">=</span> models<span class="token punctuation">.</span>IntegerField<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">#评论人数</span>

    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>
        db_table <span class="token operator">=</span> <span class="token string">"books"</span>  <span class="token comment"># 更改表名</span>
</code></pre> 
<h4><a id="264_URL_6180"></a>26.4 URL路由配置：</h4> 
<ul><li>编辑 myweb/myweb/urls.py 根路由配置文件：</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>urls <span class="token keyword">import</span> url<span class="token punctuation">,</span>include

urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
    url<span class="token punctuation">(</span>r<span class="token string">'^'</span><span class="token punctuation">,</span>include<span class="token punctuation">(</span><span class="token string">'web.urls'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre> 
<ul><li>创建web子路由文件：myweb/web/urls.py 并编写代码如下：</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>urls <span class="token keyword">import</span> url

<span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> views

urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
    url<span class="token punctuation">(</span>r<span class="token string">'^$'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>index<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"index"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    url<span class="token punctuation">(</span>r<span class="token string">'^/$'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>index<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"index"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre> 
<h4><a id="265__6205"></a>26.5 编写视图处理文件</h4> 
<ul><li>编辑视图文件：myweb/web/views.py</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> render
<span class="token keyword">from</span> django<span class="token punctuation">.</span>core<span class="token punctuation">.</span>paginator <span class="token keyword">import</span> Paginator
<span class="token keyword">from</span> web<span class="token punctuation">.</span>models <span class="token keyword">import</span> Books
<span class="token comment"># Create your views here.</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#获取商品信息查询对象</span>
    mod <span class="token operator">=</span> Books<span class="token punctuation">.</span>objects
    <span class="token builtin">list</span> <span class="token operator">=</span> mod<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">#执行分页处理</span>
    pIndex <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"p"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    page <span class="token operator">=</span> Paginator<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token comment">#以50条每页创建分页对象</span>
    maxpages <span class="token operator">=</span> page<span class="token punctuation">.</span>num_pages <span class="token comment">#最大页数</span>
    <span class="token comment">#判断页数是否越界</span>
    <span class="token keyword">if</span> pIndex <span class="token operator">&gt;</span> maxpages<span class="token punctuation">:</span>
        pIndex <span class="token operator">=</span> maxpages
    <span class="token keyword">if</span> pIndex <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">:</span>
        pIndex <span class="token operator">=</span> <span class="token number">1</span>
    list2 <span class="token operator">=</span> page<span class="token punctuation">.</span>page<span class="token punctuation">(</span>pIndex<span class="token punctuation">)</span> <span class="token comment">#当前页数据</span>
    plist <span class="token operator">=</span> page<span class="token punctuation">.</span>page_range   <span class="token comment">#页码数列表   </span>

    <span class="token comment">#封装信息加载模板输出</span>
    context <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"booklist"</span><span class="token punctuation">:</span>list2<span class="token punctuation">,</span><span class="token string">'plist'</span><span class="token punctuation">:</span>plist<span class="token punctuation">,</span><span class="token string">'pIndex'</span><span class="token punctuation">:</span>pIndex<span class="token punctuation">,</span><span class="token string">'maxpages'</span><span class="token punctuation">:</span>maxpages<span class="token punctuation">}</span>
    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span><span class="token string">"web/index.html"</span><span class="token punctuation">,</span>context<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="265__6236"></a>26.5 编写模板输出文件</h4> 
<pre><code class="prism language-html"><span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>浏览图书信息<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text/css<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token style language-css">
        <span class="token selector">table</span><span class="token punctuation">{<!-- --></span><span class="token property">font-size</span><span class="token punctuation">:</span>13px<span class="token punctuation">;</span><span class="token property">line-height</span><span class="token punctuation">:</span>25px<span class="token punctuation">;</span><span class="token property">border-collapse</span><span class="token punctuation">:</span> collapse<span class="token punctuation">;</span><span class="token punctuation">}</span>
        <span class="token selector">table,table tr th, table tr td</span> <span class="token punctuation">{<!-- --></span> <span class="token property">border</span><span class="token punctuation">:</span>1px solid #dddddd<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>center</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>浏览图书信息<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>95%<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">background-color</span><span class="token punctuation">:</span>#ddeedd<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">&gt;</span></span>ID号<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">&gt;</span></span>标题<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">&gt;</span></span>作者<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">&gt;</span></span>出版社<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">&gt;</span></span>出版年<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">&gt;</span></span>单价<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">&gt;</span></span>评分<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>
            {% for book in booklist %}
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>{<!-- -->{ book.id }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>{<!-- -->{ book.title }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>{<!-- -->{ book.author }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>{<!-- -->{ book.press }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>{<!-- -->{ book.imprint }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>{<!-- -->{ book.price }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>{<!-- -->{ book.score }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>
            {% endfor %}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
        {% for pindex in plist %}
            {% if pIndex == pindex %}
                {<!-- -->{pindex}}<span class="token entity" title=" ">&amp;nbsp;</span><span class="token entity" title=" ">&amp;nbsp;</span>
            {% else %}
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{% url <span class="token punctuation">'</span>index<span class="token punctuation">'</span>%}?p={<!-- -->{ pindex }}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>{<!-- -->{ pindex }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token entity" title=" ">&amp;nbsp;</span><span class="token entity" title=" ">&amp;nbsp;</span>
            {% endif %}
        {% endfor %}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>center</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h4><a id="266__6288"></a>26.6 启动服务测试：</h4> 
<pre><code>  $ python manage.py runserver

  使用浏览器访问测试
</code></pre> 
<p><img src="https://images2.imgbox.com/58/34/oSc78niD_o.png" alt="img">]</p> 
<h4><a id="267__6298"></a>26.7 练习：</h4> 
<ul><li>当数据很多时，请问如何实现百度的页面显示效果？ 如：上一页 … 10,11,12,13,14,15,16,17,18 … 下一页</li></ul> 
<h3><a id="Published_with_GitBookhttpswwwgitbookcom_6302"></a><a href="https://www.gitbook.com/" rel="nofollow">Published with GitBook</a></h3>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8fd12dd5175ec7afcc96a90942b2ea2f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">一、Python复习教程（重点）- 基础</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/46a54216ee121ce79ae88d6b40e73f3b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">[Graph Embedding] DeepWalk 论文笔记</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>