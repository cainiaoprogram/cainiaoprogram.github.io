<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Prometheus源码学习(9) scrape-target - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Prometheus源码学习(9) scrape-target" />
<meta property="og:description" content="主要作用 scrape.Target 是一次抓取的具体对象，包含了抓取和抓取后存储所需要的全部信息。从 targetGroup.Group 到 scrape.Target 的转换过程如下：
targetsFromGroup函数遍历每个targetGroup.Group中的Target，合并targetGroup.Group的公共标签集（记为A）和这个Target本身的标签集（记为B）为标签集C。populateLabels函数从C和*config.ScrapeConfig中创建Target。 以下是具体代码
target 定义 target 是 scrapePool 抓取的最终目标，描述一个 HTTP 或 HTTPS 端点。target 结构体内嵌了 MetricMetadataStore 接口类型的字段 metadata。
// TargetHealth describes the health state of a target. type TargetHealth string // The possible health states of a target based on the last performed scrape. // 目标的三种健康状态值，基于最后一次抓取来设置。 const ( HealthUnknown TargetHealth = &#34;unknown&#34; HealthGood TargetHealth = &#34;up&#34; HealthBad TargetHealth = &#34;down&#34; ) // Target refers to a singular HTTP or HTTPS endpoint." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/e8fed8e133fd71c0d049c8096328aa2e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-05-23T21:33:52+08:00" />
<meta property="article:modified_time" content="2021-05-23T21:33:52+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Prometheus源码学习(9) scrape-target</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>主要作用</h2> 
<p>scrape.Target 是一次抓取的具体对象，包含了抓取和抓取后存储所需要的全部信息。从 targetGroup.Group 到 scrape.Target 的转换过程如下：</p> 
<ol><li>targetsFromGroup函数遍历每个targetGroup.Group中的Target，合并targetGroup.Group的公共标签集（记为A）和这个Target本身的标签集（记为B）为标签集C。</li><li>populateLabels函数从C和*config.ScrapeConfig中创建Target。</li></ol> 
<p>以下是具体代码</p> 
<h2><a id="target__7"></a>target 定义</h2> 
<p>target 是 scrapePool 抓取的最终目标，描述一个 HTTP 或 HTTPS 端点。target 结构体内嵌了 MetricMetadataStore 接口类型的字段 metadata。</p> 
<pre><code class="prism language-go"><span class="token comment">// TargetHealth describes the health state of a target.</span>
<span class="token keyword">type</span> TargetHealth <span class="token builtin">string</span>

<span class="token comment">// The possible health states of a target based on the last performed scrape.</span>
<span class="token comment">// 目标的三种健康状态值，基于最后一次抓取来设置。</span>
<span class="token keyword">const</span> <span class="token punctuation">(</span>
	HealthUnknown TargetHealth <span class="token operator">=</span> <span class="token string">"unknown"</span>
	HealthGood    TargetHealth <span class="token operator">=</span> <span class="token string">"up"</span>
	HealthBad     TargetHealth <span class="token operator">=</span> <span class="token string">"down"</span>
<span class="token punctuation">)</span>

<span class="token comment">// Target refers to a singular HTTP or HTTPS endpoint.</span>
<span class="token keyword">type</span> Target <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// Labels before any processing.</span>
	<span class="token comment">// 未经处理的抓取到的原始标签集。</span>
	discoveredLabels labels<span class="token punctuation">.</span>Labels
	<span class="token comment">// Any labels that are added to this target and its metrics.</span>
	<span class="token comment">// 经过 relabel 处理后的标签集，会记录进 TSDB。</span>
	labels labels<span class="token punctuation">.</span>Labels
	<span class="token comment">// Additional URL parameters that are part of the target URL.</span>
	<span class="token comment">// 目标 URL 的额外参数。</span>
	params url<span class="token punctuation">.</span>Values

	<span class="token comment">// 读写锁保护下面的变量。</span>
	mtx                sync<span class="token punctuation">.</span>RWMutex
	<span class="token comment">// 最后一次抓取的错误值。</span>
	lastError          <span class="token builtin">error</span>
	<span class="token comment">// 最后一次抓取的时间。</span>
	lastScrape         time<span class="token punctuation">.</span>Time
	<span class="token comment">// 最后一次抓取的耗时。</span>
	lastScrapeDuration time<span class="token punctuation">.</span>Duration
	<span class="token comment">// 目标的健康状态。</span>
	health             TargetHealth
	<span class="token comment">// 标签的元数据。</span>
	metadata           MetricMetadataStore
<span class="token punctuation">}</span>
</code></pre> 
<p>构造函数</p> 
<pre><code class="prism language-go"><span class="token comment">// NewTarget creates a reasonably configured target for querying.</span>
<span class="token keyword">func</span> <span class="token function">NewTarget</span><span class="token punctuation">(</span>labels<span class="token punctuation">,</span> discoveredLabels labels<span class="token punctuation">.</span>Labels<span class="token punctuation">,</span> params url<span class="token punctuation">.</span>Values<span class="token punctuation">)</span> <span class="token operator">*</span>Target <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>Target<span class="token punctuation">{<!-- --></span>
		labels<span class="token punctuation">:</span>           labels<span class="token punctuation">,</span>
		discoveredLabels<span class="token punctuation">:</span> discoveredLabels<span class="token punctuation">,</span>
		params<span class="token punctuation">:</span>           params<span class="token punctuation">,</span>
		health<span class="token punctuation">:</span>           HealthUnknown<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="_61"></a>元数据及其存储</h2> 
<h3><a id="_62"></a>定义</h3> 
<pre><code class="prism language-go"><span class="token comment">// MetricMetadataStore represents a storage for metadata.</span>
<span class="token comment">// MetricMetadataStore 接口代表元数据的存储。</span>
<span class="token keyword">type</span> MetricMetadataStore <span class="token keyword">interface</span> <span class="token punctuation">{<!-- --></span>
	<span class="token function">ListMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>MetricMetadata
	<span class="token function">GetMetadata</span><span class="token punctuation">(</span>metric <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>MetricMetadata<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span>
	<span class="token function">SizeMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span>
	<span class="token function">LengthMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token comment">// MetricMetadata is a piece of metadata for a metric.</span>
<span class="token comment">// MetricMetadata 是一个指标的元数据。</span>
<span class="token comment">// 包括指标名、指标类型、帮助信息（这三项在用客户端写观测指标时都要写）</span>
<span class="token comment">// 和指标单位。</span>
<span class="token keyword">type</span> MetricMetadata <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	Metric <span class="token builtin">string</span>
	Type   textparse<span class="token punctuation">.</span>MetricType
	Help   <span class="token builtin">string</span>
	Unit   <span class="token builtin">string</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_84"></a>获取元数据</h3> 
<p>target 有 MetadataList()、MetadataSize()、MetadataLength() 和 Metadata() 方法，获取元数据的一些信息，这些方法内部就是加读锁调用 metadata 字段的相对应的方法。</p> 
<h3><a id="_87"></a>设置元数据</h3> 
<p>参数是个接口类型，也就是实现了接口方法的结构体。</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>Target<span class="token punctuation">)</span> <span class="token function">SetMetadataStore</span><span class="token punctuation">(</span>s MetricMetadataStore<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	t<span class="token punctuation">.</span>mtx<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> t<span class="token punctuation">.</span>mtx<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	t<span class="token punctuation">.</span>metadata <span class="token operator">=</span> s
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="hash__96"></a>hash 方法</h3> 
<p>用于得到一个目标的唯一标识。FVN-1a 是一个简单的非加密哈希算法，性能较高，碰撞率较低。该方法用目标的标签集的哈希值和目标的端点 URL 作为参数计算哈希值，其中标签集的哈希值使用 xxHash 算法。</p> 
<pre><code class="prism language-go"><span class="token comment">// hash returns an identifying hash for the target.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>Target<span class="token punctuation">)</span> <span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">uint64</span> <span class="token punctuation">{<!-- --></span>
	h <span class="token operator">:=</span> fnv<span class="token punctuation">.</span><span class="token function">New64a</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">//nolint: errcheck</span>
	h<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%016d"</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>labels<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment">//nolint: errcheck</span>
	h<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">URL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token keyword">return</span> h<span class="token punctuation">.</span><span class="token function">Sum64</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="offset__111"></a>offset 方法</h3> 
<p>得到距离目标开始下一次抓取循环的时间。参数中包含一个随机数，用于打散抓取开始时间，均匀化 Prometheus 的负载。</p> 
<h3><a id="_114"></a>获取/设置标签集的方法</h3> 
<p>Labels()、DiscoveredLabels()、SetDiscoveredLabels(l labels.Labels) 分别用于获取目标的非元信息（不以“————”开头）标签集、relabel 前的原始标签集和设置 relabel 前的原始标签集。需要注意的是 Labels() 方法没有加锁。</p> 
<h3><a id="URL__neturlURL_117"></a>URL() 方法组装 net/url.URL</h3> 
<pre><code class="prism language-go"><span class="token comment">// URL returns a copy of the target's URL.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>Target<span class="token punctuation">)</span> <span class="token function">URL</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>url<span class="token punctuation">.</span>URL <span class="token punctuation">{<!-- --></span>
	params <span class="token operator">:=</span> url<span class="token punctuation">.</span>Values<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

	<span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> t<span class="token punctuation">.</span>params <span class="token punctuation">{<!-- --></span>
		params<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token function">copy</span><span class="token punctuation">(</span>params<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 将 url 参数相关的标签添加到参数中</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> l <span class="token operator">:=</span> <span class="token keyword">range</span> t<span class="token punctuation">.</span>labels <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token operator">!</span>strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> model<span class="token punctuation">.</span>ParamLabelPrefix<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		ks <span class="token operator">:=</span> l<span class="token punctuation">.</span>Name<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>ParamLabelPrefix<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">]</span>

		<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>params<span class="token punctuation">[</span>ks<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
			params<span class="token punctuation">[</span>ks<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> l<span class="token punctuation">.</span>Value
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			params<span class="token punctuation">[</span>ks<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span>l<span class="token punctuation">.</span>Value<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token operator">&amp;</span>url<span class="token punctuation">.</span>URL<span class="token punctuation">{<!-- --></span>
		Scheme<span class="token punctuation">:</span>   t<span class="token punctuation">.</span>labels<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>SchemeLabel<span class="token punctuation">)</span><span class="token punctuation">,</span>
		Host<span class="token punctuation">:</span>     t<span class="token punctuation">.</span>labels<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>AddressLabel<span class="token punctuation">)</span><span class="token punctuation">,</span>
		Path<span class="token punctuation">:</span>     t<span class="token punctuation">.</span>labels<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>MetricsPathLabel<span class="token punctuation">)</span><span class="token punctuation">,</span>
		RawQuery<span class="token punctuation">:</span> params<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="Report__150"></a>Report() 设置最后一次抓取的结构体字段值</h3> 
<pre><code class="prism language-go"><span class="token comment">// Report sets target data about the last scrape.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>Target<span class="token punctuation">)</span> <span class="token function">Report</span><span class="token punctuation">(</span>start time<span class="token punctuation">.</span>Time<span class="token punctuation">,</span> dur time<span class="token punctuation">.</span>Duration<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	t<span class="token punctuation">.</span>mtx<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> t<span class="token punctuation">.</span>mtx<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		t<span class="token punctuation">.</span>health <span class="token operator">=</span> HealthGood
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		t<span class="token punctuation">.</span>health <span class="token operator">=</span> HealthBad
	<span class="token punctuation">}</span>

	t<span class="token punctuation">.</span>lastError <span class="token operator">=</span> err
	t<span class="token punctuation">.</span>lastScrape <span class="token operator">=</span> start
	t<span class="token punctuation">.</span>lastScrapeDuration <span class="token operator">=</span> dur
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="LastErrorLastScrapeLastScrapeDurationHealth__169"></a>LastError()、LastScrape()、LastScrapeDuration()、Health() 方法加读锁获取结构体最后一次抓取的错误、最后一次抓取的时间、最后一次抓取的耗时和最后一次抓取目标的状态字段。</h3> 
<h3><a id="Targets_171"></a>Targets</h3> 
<p>是一个实现了 sort 接口的 Taget 指针切片，排序依据是 URL 字符串。</p> 
<pre><code class="prism language-go"><span class="token comment">// Targets is a sortable list of targets.</span>
<span class="token keyword">type</span> Targets <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Target

<span class="token keyword">func</span> <span class="token punctuation">(</span>ts Targets<span class="token punctuation">)</span> <span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span>           <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> <span class="token function">len</span><span class="token punctuation">(</span>ts<span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>ts Targets<span class="token punctuation">)</span> <span class="token function">Less</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> ts<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">URL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> ts<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">URL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>ts Targets<span class="token punctuation">)</span> <span class="token function">Swap</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token builtin">int</span><span class="token punctuation">)</span>      <span class="token punctuation">{<!-- --></span> ts<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> ts<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> ts<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> ts<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token punctuation">}</span>

</code></pre> 
<h3><a id="limitAppender__183"></a>limitAppender 结构体限制一次批量追加的样本数。</h3> 
<pre><code class="prism language-go"><span class="token comment">// limitAppender limits the number of total appended samples in a batch.</span>
<span class="token keyword">type</span> limitAppender <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	storage<span class="token punctuation">.</span>Appender

	limit <span class="token builtin">int</span>
	i     <span class="token builtin">int</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="limitAppender__Add__AddFast__194"></a>*limitAppender 的 Add 和 AddFast 方法向存储追加时间序列样本，超过限制数量将返回错误。后面读到存储部分再具体分析。</h3> 
<h3><a id="timeLimitAppender__196"></a>timeLimitAppender 结构体是限制插入时间的，如果要追加的样本时间戳超过限制就返回错误。</h3> 
<h3><a id="populateLabels__relabel__rebalel__relabel__198"></a>populateLabels 函数从给定的标签集和抓取配置中构造一个标签集。返回的第二个值是 relabel 之前的标签集。如果目标在 rebalel 期间被丢弃，就返回 relabel 之前的原始标签集。</h3> 
<pre><code class="prism language-go"><span class="token comment">// populateLabels builds a label set from the given label set and scrape configuration.</span>
<span class="token comment">// It returns a label set before relabeling was applied as the second return value.</span>
<span class="token comment">// Returns the original discovered label set found before relabelling was applied if the target is dropped during relabeling.</span>
<span class="token keyword">func</span> <span class="token function">populateLabels</span><span class="token punctuation">(</span>lset labels<span class="token punctuation">.</span>Labels<span class="token punctuation">,</span> cfg <span class="token operator">*</span>config<span class="token punctuation">.</span>ScrapeConfig<span class="token punctuation">)</span> <span class="token punctuation">(</span>res<span class="token punctuation">,</span> orig labels<span class="token punctuation">.</span>Labels<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// Copy labels into the labelset for the target if they are not set already.</span>
	scrapeLabels <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>labels<span class="token punctuation">.</span>Label<span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">{<!-- --></span>Name<span class="token punctuation">:</span> model<span class="token punctuation">.</span>JobLabel<span class="token punctuation">,</span> Value<span class="token punctuation">:</span> cfg<span class="token punctuation">.</span>JobName<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{<!-- --></span>Name<span class="token punctuation">:</span> model<span class="token punctuation">.</span>MetricsPathLabel<span class="token punctuation">,</span> Value<span class="token punctuation">:</span> cfg<span class="token punctuation">.</span>MetricsPath<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{<!-- --></span>Name<span class="token punctuation">:</span> model<span class="token punctuation">.</span>SchemeLabel<span class="token punctuation">,</span> Value<span class="token punctuation">:</span> cfg<span class="token punctuation">.</span>Scheme<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	lb <span class="token operator">:=</span> labels<span class="token punctuation">.</span><span class="token function">NewBuilder</span><span class="token punctuation">(</span>lset<span class="token punctuation">)</span>

	<span class="token comment">// 如果参数标签集 lset 中不含有 job、metricPath 和 scheme 标签就把它们添加进去。</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> l <span class="token operator">:=</span> <span class="token keyword">range</span> scrapeLabels <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> lv <span class="token operator">:=</span> lset<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">;</span> lv <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{<!-- --></span>
			lb<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> l<span class="token punctuation">.</span>Value<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Encode scrape query parameters as labels.</span>
	<span class="token comment">// 添加 url 参数标签。</span>
	<span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> cfg<span class="token punctuation">.</span>Params <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
			lb<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>ParamLabelPrefix<span class="token operator">+</span>k<span class="token punctuation">,</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// relabel 之前的标签集。</span>
	preRelabelLabels <span class="token operator">:=</span> lb<span class="token punctuation">.</span><span class="token function">Labels</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 应用 relabel。</span>
	lset <span class="token operator">=</span> relabel<span class="token punctuation">.</span><span class="token function">Process</span><span class="token punctuation">(</span>preRelabelLabels<span class="token punctuation">,</span> cfg<span class="token punctuation">.</span>RelabelConfigs<span class="token operator">...</span><span class="token punctuation">)</span>

	<span class="token comment">// Check if the target was dropped.</span>
	<span class="token comment">// 如果 relabel 把这个标签集丢弃了就返回 relabel 之前的标签集</span>
	<span class="token keyword">if</span> lset <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> preRelabelLabels<span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 如果 relabel 后 __address__ 标签没有了就返回错误。</span>
	<span class="token keyword">if</span> v <span class="token operator">:=</span> lset<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>AddressLabel<span class="token punctuation">)</span><span class="token punctuation">;</span> v <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"no address"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	lb <span class="token operator">=</span> labels<span class="token punctuation">.</span><span class="token function">NewBuilder</span><span class="token punctuation">(</span>lset<span class="token punctuation">)</span>

	<span class="token comment">// addPort checks whether we should add a default port to the address.</span>
	<span class="token comment">// If the address is not valid, we don't append a port either.</span>
	<span class="token comment">// addPort 检查是否需要为地址添加默认端口。如果地址不合法，也不添加端口。</span>
	addPort <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// If we can split, a port exists and we don't have to add one.</span>
		<span class="token comment">// 有端口就不用添加了。</span>
		<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">SplitHostPort</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token boolean">false</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// If adding a port makes it valid, the previous error</span>
		<span class="token comment">// was not due to an invalid address and we can append a port.</span>
		<span class="token comment">// 如果添加以后不合法就可以添加。</span>
		<span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">SplitHostPort</span><span class="token punctuation">(</span>s <span class="token operator">+</span> <span class="token string">":1234"</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> err <span class="token operator">==</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	addr <span class="token operator">:=</span> lset<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>AddressLabel<span class="token punctuation">)</span>
	<span class="token comment">// If it's an address with no trailing port, infer it based on the used scheme.</span>
	<span class="token comment">// __address__ 标签如果没有端口就根据 http 或 https 推断一个默认值。</span>
	<span class="token keyword">if</span> <span class="token function">addPort</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// Addresses reaching this point are already wrapped in [] if necessary.</span>
		<span class="token keyword">switch</span> lset<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>SchemeLabel<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">case</span> <span class="token string">"http"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">:</span>
			addr <span class="token operator">=</span> addr <span class="token operator">+</span> <span class="token string">":80"</span>
		<span class="token keyword">case</span> <span class="token string">"https"</span><span class="token punctuation">:</span>
			addr <span class="token operator">=</span> addr <span class="token operator">+</span> <span class="token string">":443"</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"invalid scheme: %q"</span><span class="token punctuation">,</span> cfg<span class="token punctuation">.</span>Scheme<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		lb<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>AddressLabel<span class="token punctuation">,</span> addr<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 检查地址标签的值是否是合法地址。</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> config<span class="token punctuation">.</span><span class="token function">CheckTargetAddress</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span><span class="token function">LabelValue</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>

	<span class="token comment">// Meta labels are deleted after relabelling. Other internal labels propagate to</span>
	<span class="token comment">// the target which decides whether they will be part of their label set.</span>
	<span class="token comment">// relabel 以后删除 __meta_ 开头的标签。其他的内部标签保留。</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> l <span class="token operator">:=</span> <span class="token keyword">range</span> lset <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> model<span class="token punctuation">.</span>MetaLabelPrefix<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			lb<span class="token punctuation">.</span><span class="token function">Del</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Default the instance label to the target address.</span>
	<span class="token comment">// instance 标签为空就设置为地址。</span>
	<span class="token keyword">if</span> v <span class="token operator">:=</span> lset<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>InstanceLabel<span class="token punctuation">)</span><span class="token punctuation">;</span> v <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{<!-- --></span>
		lb<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>InstanceLabel<span class="token punctuation">,</span> addr<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 最终标签集</span>
	res <span class="token operator">=</span> lb<span class="token punctuation">.</span><span class="token function">Labels</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 最后检查一遍，标签值必须都是合法的 UTF8 字符。</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> l <span class="token operator">:=</span> <span class="token keyword">range</span> res <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// Check label values are valid, drop the target if not.</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>model<span class="token punctuation">.</span><span class="token function">LabelValue</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"invalid label value for %q: %q"</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> l<span class="token punctuation">.</span>Value<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> res<span class="token punctuation">,</span> preRelabelLabels<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="targetGroupGroup__Target__307"></a>targetGroup.Group 到 Target 的转换</h2> 
<p>targetGroup.Group 在 prometheus/discovery/targetgroup/targetgroup.go 中，Target 在 prometheus/scrape/target.go 中。这是从服务发现到抓取目标的转换。</p> 
<pre><code class="prism language-go"><span class="token comment">// targetsFromGroup builds targets based on the given TargetGroup and config.</span>
<span class="token keyword">func</span> <span class="token function">targetsFromGroup</span><span class="token punctuation">(</span>tg <span class="token operator">*</span>targetgroup<span class="token punctuation">.</span>Group<span class="token punctuation">,</span> cfg <span class="token operator">*</span>config<span class="token punctuation">.</span>ScrapeConfig<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Target<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	targets <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Target<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>tg<span class="token punctuation">.</span>Targets<span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> i<span class="token punctuation">,</span> tlset <span class="token operator">:=</span> <span class="token keyword">range</span> tg<span class="token punctuation">.</span>Targets <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// tlset 是这个目标独有的标签，tg.Labels 是这个 group 公共的标签。</span>
		lbls <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>labels<span class="token punctuation">.</span>Label<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>tlset<span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">len</span><span class="token punctuation">(</span>tg<span class="token punctuation">.</span>Labels<span class="token punctuation">)</span><span class="token punctuation">)</span>

		<span class="token keyword">for</span> ln<span class="token punctuation">,</span> lv <span class="token operator">:=</span> <span class="token keyword">range</span> tlset <span class="token punctuation">{<!-- --></span>
			lbls <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>lbls<span class="token punctuation">,</span> labels<span class="token punctuation">.</span>Label<span class="token punctuation">{<!-- --></span>Name<span class="token punctuation">:</span> <span class="token function">string</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span><span class="token punctuation">,</span> Value<span class="token punctuation">:</span> <span class="token function">string</span><span class="token punctuation">(</span>lv<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">for</span> ln<span class="token punctuation">,</span> lv <span class="token operator">:=</span> <span class="token keyword">range</span> tg<span class="token punctuation">.</span>Labels <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> tlset<span class="token punctuation">[</span>ln<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">{<!-- --></span>
				lbls <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>lbls<span class="token punctuation">,</span> labels<span class="token punctuation">.</span>Label<span class="token punctuation">{<!-- --></span>Name<span class="token punctuation">:</span> <span class="token function">string</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span><span class="token punctuation">,</span> Value<span class="token punctuation">:</span> <span class="token function">string</span><span class="token punctuation">(</span>lv<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		lset <span class="token operator">:=</span> labels<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>lbls<span class="token operator">...</span><span class="token punctuation">)</span>

		lbls<span class="token punctuation">,</span> origLabels<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">populateLabels</span><span class="token punctuation">(</span>lset<span class="token punctuation">,</span> cfg<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">Wrapf</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"instance %d in group %s"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> tg<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> lbls <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">||</span> origLabels <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			targets <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>targets<span class="token punctuation">,</span> <span class="token function">NewTarget</span><span class="token punctuation">(</span>lbls<span class="token punctuation">,</span> origLabels<span class="token punctuation">,</span> cfg<span class="token punctuation">.</span>Params<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> targets<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="_341"></a>习得</h2> 
<ol><li>FVN-1a 是一个简单的非加密哈希算法，性能好，哈希碰撞概率极低。</li><li>nolint:errCheck 用于提示 IDE 忽略错误检查。</li><li>应该利用 instance 标签，为其设置有意义的值，例如主机名，这样可以降低标签基数。</li></ol>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6b5b63b8628b0b06ac17fa29221f60c1/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">ch454c语言程序实例,CSDN18luck手机客户端下载 -IT新利18官网登录 大本营</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2cae69dee17edd59bd894dd83dbeb80b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">ZYNQ-XADC使用</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>