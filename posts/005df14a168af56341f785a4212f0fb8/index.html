<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>驱动开发platform - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="驱动开发platform" />
<meta property="og:description" content="任务 : 基于platform驱动模型完成LED驱动的编写，实现三盏灯的点亮
应用层程序
#include &lt;stdlib.h&gt; #include &lt;stdio.h&gt; #include &lt;sys/types.h&gt; #include &lt;sys/stat.h&gt; #include &lt;sys/ioctl.h&gt; #include &lt;fcntl.h&gt; #include &lt;unistd.h&gt; #include &lt;string.h&gt; #define LED_ON _IOW(&#39;l&#39;,1,int) #define LED_OFF _IOW(&#39;l&#39;,0,int) int main(int argc, char const *argv[]) { // 打开第一个设备文件 int fd1 = open(&#34;/dev/myled0&#34;, O_RDWR); if (fd1 &lt; 0) { printf(&#34;打开设备文件失败\n&#34;); exit(-1); } // 打开第二个设备文件 int fd2 = open(&#34;/dev/myled1&#34;, O_RDWR); if (fd2 &lt; 0) { printf(&#34;打开设备文件失败\n&#34;); exit(-1); } // 打开第三个设备文件 int fd3 = open(&#34;/dev/myled2&#34;, O_RDWR); if (fd3 &lt; 0) { printf(&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/005df14a168af56341f785a4212f0fb8/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-01T08:30:00+08:00" />
<meta property="article:modified_time" content="2023-11-01T08:30:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">驱动开发platform</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>任务 :  基于platform驱动模型完成LED驱动的编写，实现三盏灯的点亮</p> 
<p>应用层程序</p> 
<pre><code class="language-cs">#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;sys/ioctl.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;unistd.h&gt;
#include &lt;string.h&gt;

#define LED_ON _IOW('l',1,int)
#define LED_OFF _IOW('l',0,int)
int main(int argc, char const *argv[])
{
	// 打开第一个设备文件
	int fd1 = open("/dev/myled0", O_RDWR);
	if (fd1 &lt; 0)
	{
		printf("打开设备文件失败\n");
		exit(-1);
	}
	// 打开第二个设备文件
	int fd2 = open("/dev/myled1", O_RDWR);
	if (fd2 &lt; 0)
	{
		printf("打开设备文件失败\n");
		exit(-1);
	}
	// 打开第三个设备文件
	int fd3 = open("/dev/myled2", O_RDWR);
	if (fd3 &lt; 0)
	{
		printf("打开设备文件失败\n");
		exit(-1);
	}

	while (1)
	{
		int a, b;
		// 从终端读取
		printf("请输入字符\n");
		printf("第一个字符:1(LED1) 2(LED2) 3(LED3)\n");
		scanf("%d", &amp;a);
		printf("第二个字符:0(关灯) 1(开灯)\n");
		printf("请输入&gt;");
		scanf("%d", &amp;b);
		// 向设备文件中写
		switch (b)
		{
		case 1:
			switch (a)
			{
			case 1: // LED1
				printf("LED1_ON\n");
				ioctl(fd1, LED_ON,&amp;a);
				break;
			case 2: // LED2
				printf("LED2_ON\n");
				ioctl(fd2, LED_ON,&amp;a);
				break;
			case 3: // LED3
				printf("LED3_ON\n");
				ioctl(fd3, LED_ON,&amp;a);
				break;
			}
			break;
		case 0:
			switch (a)
			{
			case 1: // LED1
				printf("LED1_OFF\n");
				ioctl(fd1, LED_OFF,&amp;a);
				break;
			case 2: // LED2
				printf("LED2_OFF\n");
				ioctl(fd2, LED_OFF,&amp;a);
				break;
			case 3: // LED3
				printf("LED3_OFF\n");
				ioctl(fd3, LED_OFF,&amp;a);
				break;
			}
			break;
		}
	}

	close(fd1);
	close(fd2);
	close(fd3);

	return 0;
}</code></pre> 
<p>驱动代码</p> 
<pre><code class="language-cs">#include &lt;linux/init.h&gt;
#include &lt;linux/module.h&gt;
#include &lt;linux/platform_device.h&gt;
#include &lt;linux/mod_devicetable.h&gt;
#include &lt;linux/of.h&gt;
#include &lt;linux/of_gpio.h&gt;
#include &lt;linux/gpio.h&gt;
#include &lt;linux/io.h&gt;
#include &lt;linux/fs.h&gt;
#include &lt;linux/device.h&gt;

#define LED_ON _IOW('l',1,int)
#define LED_OFF _IOW('l',0,int)
struct resource *res;
int irqnum;
struct gpio_desc *gpionum1;
struct gpio_desc *gpionum2;
struct gpio_desc *gpionum3;
struct device *dev;

int major;
struct class *cls;

struct of_device_id of_tab[] =
    {
        {
            .compatible = "hqyj,myplatform",
        },
        {
            .compatible = "hqyj,myplatform1",
        },
        {},
};
// 打开文件函数
int myopen(struct inode *inode, struct file *file)
{

    return 0;
}
// 关闭文件函数
int myclose(struct inode *inode, struct file *file)
{
	int i;
	for(i = 0;i &lt; 3;i++)
	{
		device_destroy(cls,MKDEV(major,i));
	}
	class_destroy(cls);
	unregister_chrdev(major,"mychrdev");
    return 0;
}

// io控制函数
long myioctl(struct file *file, unsigned int cmd, unsigned long arg)
{
	printk("__ioctrl__");
    int which;
    int ret = copy_from_user(&amp;which, (void *)arg, 4);
    if (ret)
    {
        printk("copy_from_user failed\n");
        return -EIO;
    }
    printk("copy_from_user success : [%d]\n",which);
    switch (cmd)
    {
    case LED_ON:
        switch (which)
        {
        case 1:
			printk("[1] : LED_ON\n");
            gpiod_set_value(gpionum1, 1);
            break;
        case 2:
			printk("[2] : LED_ON\n");
            gpiod_set_value(gpionum2, 1);
            break;
        case 3:
			printk("[3] : LED_ON\n");
            gpiod_set_value(gpionum3, 1);
            break;
        }
        break;
    case LED_OFF:
        switch (which)
        {
        case 1:
			printk("[1] : LED_OFF\n");
            gpiod_set_value(gpionum1, 0);
            break;
        case 2:
			printk("[2] : LED_OFF\n");
            gpiod_set_value(gpionum2, 0);
            break;
        case 3:
			printk("[3] : LED_OFF\n");
            gpiod_set_value(gpionum3, 0);
            break;
        }
        break;
    }
    return 0;
}

// 操作方法结构体
struct file_operations fops = {
    .open = myopen,
    .unlocked_ioctl = myioctl,
    .release = myclose,
};

// 匹配成功函数
int pdri_probe(struct platform_device *pdev)
{
    printk("%s : %s : %d\n", __FILE__, __func__, __LINE__);

    // 字符设备注册
    major = register_chrdev(0, "mychrdev", &amp;fops);
    if (major &lt; 0)
    {
        printk("register_chrdev failed\n");
        return -1;
    }
    printk("register_chrdev success\n");

    // 提交上级目录
    cls = class_create(THIS_MODULE, "mychrdev");
    if (IS_ERR(cls))
    {
        printk("class_create failed\n");
        return -PTR_ERR(cls);
    }
    printk("class_create success\n");

    // 向上提交三次节点信息
    int i;
    for (i = 0; i &lt; 3; i++)
    {
        dev = device_create(cls, NULL, MKDEV(major, i), NULL, "myled%d", i);
        if (IS_ERR(dev))
        {
            printk("[%d] : device_create failed\n", i);
            return -PTR_ERR(dev);
        }
    }
    printk("device_create success\n");

    // 获取设备信息
    res = platform_get_resource(pdev, IORESOURCE_MEM, 0);
    if (res == NULL)
    {
        printk("MEM : platform_get_resource failed\n");
        return -1;
    }
    printk("MEN : %x\n", res-&gt;start);

    // 获取中断号信息
    irqnum = platform_get_irq(pdev, 0);
    if (irqnum &lt; 0)
    {
        printk("IRQ : platform_get_irq failed\n");
        return -1;
    }
    printk("IRQ : %d\n", irqnum);

    // 获取LED1gpio信息
    gpionum1 = gpiod_get_from_of_node(pdev-&gt;dev.of_node, "led1-gpioe", 0, GPIOD_OUT_LOW, NULL);
    if (IS_ERR(gpionum1))
    {
        printk("gpiod_get_from_of_node failed\n");
        return PTR_ERR(gpionum1);
    }
    printk("gpiod_get_from_of_node success\n");

    // 获取LED2gpio信息
    gpionum2 = gpiod_get_from_of_node(pdev-&gt;dev.of_node, "led2-gpiof", 0, GPIOD_OUT_LOW, NULL);
    if (IS_ERR(gpionum2))
    {
        printk("gpiod_get_from_of_node failed\n");
        return PTR_ERR(gpionum2);
    }
    printk("gpiod_get_from_of_node success\n");

    // 获取LED3gpio信息
    gpionum3 = gpiod_get_from_of_node(pdev-&gt;dev.of_node, "led3-gpioe", 0, GPIOD_OUT_LOW, NULL);
    if (IS_ERR(gpionum3))
    {
        printk("gpiod_get_from_of_node failed\n");
        return PTR_ERR(gpionum3);
    }
    printk("gpiod_get_from_of_node success\n");

    return 0;
}

// 分离函数
int pdri_remove(struct platform_device *pdev)
{
    gpiod_set_value(gpionum1, 0);
    gpiod_set_value(gpionum2, 0);
    gpiod_set_value(gpionum3, 0);
    gpiod_put(gpionum1);
    gpiod_put(gpionum2);
    gpiod_put(gpionum3);
    printk("%s : %s : %d\n", __FILE__, __func__, __LINE__);
    return 0;
}

// 给驱动对象分配空间
struct platform_driver pdri = {
    .probe = pdri_probe,
    .remove = pdri_remove,
    .driver.name = "a",
    .driver.of_match_table = of_tab,
};

module_platform_driver(pdri);

MODULE_LICENSE("GPL");</code></pre> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/dd6c2d5229582fcd8db15b028ab3238c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【雕爷学编程】MicroPython手册之 ESP32-S2 定时器</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/110a300a3adc4adafbe58866c0821d92/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">maven--pom.xml--标签大全</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>