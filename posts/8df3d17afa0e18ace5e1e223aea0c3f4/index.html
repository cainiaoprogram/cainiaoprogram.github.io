<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>中科曙光使用记录 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="中科曙光使用记录" />
<meta property="og:description" content="0 前言 曙光超算平台是一款高性能、高可靠性和高可扩展性的超级计算机平台。它采用了自主研发的曙光超算架构，并采用国产GPU（即DCU），硬件基于ROCm平台。其核心技术包括：
曙光超算架构：采用高性能处理器和互连网络，实现超高速的数据传输和处理能力。计算加速技术：支持GPU加速和FPGA加速，进一步提升计算性能和效率。高可靠性设计：采用冗余设计和错误检测纠正技术，实现硬件故障自动切换和修复，保证计算任务的连续性。可扩展性：支持多机房间级联，实现大规模计算任务的并行处理。多编程模型和开发工具：提供多种编程模型和开发工具，方便用户进行软件开发和优化。 本文对中科曙光超算平台的使用进行介绍
环境搭建 1.1 pytorch 安装包安装记录 由于曙光云使用的是国产GPU（即DCU），硬件是基于ROCm的，因此不能适配PyTorch官网下载的包（无法调用DCU），因此只能使用曙光云平台提供的编译好的PyTorch包进行安装。切忌不能使用pip install torch==1.7.0 torchvision的命令直接安装，而应该选择曙光云本地提供的包进行安装。
本次安装基于python 3.9版本进行安装，pytorch版本为1.13.1
1.1.1 环境创建、依赖包安装
首先，和conda创建环境相同，创建py39环境，并激活环境
conda create -n env_py39 python=3.9
conda activate env_py39
1.1.2 本地安装pytorch1.13.1(由曙光编译好的版本)
查看本地whl包所在目录
其他所需用到GPU的whl包可以在相关目录下找到，例如这里的dtk-22.04.1，不同名称下对应不同依赖包版本
安装pytorch1.13.1
# 安装torch pip install /public/software/apps/DeepLearning/whl/torch-1.13.1a0&#43;git4c8a1fe.abi0.dtk2304-cp39-cp39-linux_x86_64.whl 除了与GPU相关的包(比如torch和torchvision)，其他包可直接通过pip install从网上进行安装，无需曙光云本地提供。例如以下安装numpy（注意先激活环境）
# 安装numpy pip install numpy -i https://pypi.tuna.tsinghua.edu.cn/simple 安装完毕后，可通过pip list所安装的包，到此步只是完成安装工作。
pip list 1.1.3 节点申请、环境变量配置(测试能否调用到dcu)
查看所在队列
whichpartition 申请并登录计算节点，进行测试
salloc -p kshdtest -N 1 -n 8 --gres=dcu:1 登录计算节点
# ssh 节点 ssh b02r1n02 切换rocm编译器版本（加载dtk23.04），跟后续使用GPU的关系很大" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/8df3d17afa0e18ace5e1e223aea0c3f4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-24T08:53:43+08:00" />
<meta property="article:modified_time" content="2023-11-24T08:53:43+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">中科曙光使用记录</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div></div> 
<div> 
 <div> 
  <h2 style="margin-left:0pt;text-align:left;"><strong><span style="color:#1a1a1a;">0 前言</span></strong></h2> 
  <p style="margin-left:0;text-align:justify;"><span style="color:#333333;">曙光超算平台是一款高性能、高可靠性和高可扩展性的超级计算机平台。它采用了自主研发的曙光超算架构，并采用国产GPU（即DCU），硬件基于ROCm平台。其核心技术包括：</span></p> 
  <ul><li style="text-align:left;"><span style="color:#333333;">曙光超算架构：采用高性能处理器和互连网络，实现超高速的数据传输和处理能力。</span></li><li style="text-align:left;"><span style="color:#333333;">计算加速技术：支持GPU加速和FPGA加速，进一步提升计算性能和效率。</span></li><li style="text-align:left;"><span style="color:#333333;">高可靠性设计：采用冗余设计和错误检测纠正技术，实现硬件故障自动切换和修复，保证计算任务的连续性。</span></li><li style="text-align:left;"><span style="color:#333333;">可扩展性：支持多机房间级联，实现大规模计算任务的并行处理。</span></li><li style="text-align:left;"><span style="color:#333333;">多编程模型和开发工具：提供多种编程模型和开发工具，方便用户进行软件开发和优化。</span></li></ul> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">本</span><span style="color:#333333;">文对中科曙光超算平台的使用进行介绍</span></p> 
  <ol><li style="text-align:left;"><strong><span style="color:#1a1a1a;">环境搭建</span></strong></li></ol> 
  <h4 style="margin-left:0pt;text-align:left;"><strong><span style="color:#1a1a1a;">1.1 pytorch 安装包安装记录</span></strong></h4> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">由于曙光云使用的是国产GPU（即DCU），硬件是基于ROCm的，因此不能适配PyTorch官网下载的包（无法调用DCU），因此</span><strong><span style="color:#333333;">只能使用曙光云平台提供的编译好的PyTorch包进行安装</span></strong><span style="color:#333333;">。切忌不能使用pip install torch==1.7.0 torchvision的命令直接安装，而应该选择曙光云本地提供的包进行安装。</span></p> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">本次安装基于python 3.9版本进行安装，pytorch版本为1.13.1</span></p> 
  <p style="margin-left:0;text-align:left;"><strong><span style="color:#333333;">1.1.1 环境创建、依赖包安装</span></strong></p> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">首先</span><span style="color:#333333;">，和conda创建环境相同，创建py39环境，并激活环境</span></p> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">conda create -n </span><span style="color:#333333;">env_py39</span><span style="color:#333333;"> python=3.</span><span style="color:#333333;">9</span></p> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">conda activate env_py39</span></p> 
  <p style="margin-left:0;text-align:left;"><strong><span style="color:#333333;">1.1.2 本地安装pytorch1.13.1(由曙光编译好的版本)</span></strong></p> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">查看本地whl包所在目录</span></p> 
  <p style="margin-left:0;text-align:left;"><img alt="" height="31" src="https://images2.imgbox.com/d7/b9/ixwN4UiO_o.png" width="733"></p> 
  <p style="margin-left:0;text-align:left;"></p> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">其他所需用到GPU的whl包可以在相关目录下找到，例如这里的dtk-22.04.1，不同名称下对应不同依赖包版本</span></p> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">安装pytorch1.13.1</span></p> 
  <p style="margin-left:0;text-align:left;"></p> 
  <pre><span style="background-color:#fafafa;"><code><span style="color:#708090;"># 安装torch</span>
<span style="color:#000000;">pip install </span><span style="color:#9a6e3a;">/</span><span style="color:#000000;">public</span><span style="color:#9a6e3a;">/</span><span style="color:#000000;">software</span><span style="color:#9a6e3a;">/</span><span style="color:#000000;">apps</span><span style="color:#9a6e3a;">/</span><span style="color:#000000;">DeepLearning</span><span style="color:#9a6e3a;">/</span><span style="color:#000000;">whl</span><span style="color:#9a6e3a;">/</span><span style="color:#000000;">torch</span><span style="color:#9a6e3a;">-</span><span style="color:#990055;">1.13</span><span style="color:#999999;">.</span><span style="color:#990055;">1a0</span><span style="color:#9a6e3a;">+</span><span style="color:#000000;">git4c8a1fe</span><span style="color:#999999;">.</span><span style="color:#000000;">abi0</span><span style="color:#999999;">.</span><span style="color:#000000;">dtk2304</span><span style="color:#9a6e3a;">-</span><span style="color:#000000;">cp39</span><span style="color:#9a6e3a;">-</span><span style="color:#000000;">cp39</span><span style="color:#9a6e3a;">-</span><span style="color:#000000;">linux_x86_64</span><span style="color:#999999;">.</span><span style="color:#000000;">whl</span>
</code></span></pre> 
  <p></p> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">除了与GPU相关的包(比如torch和torchvision)，其他包可直接通过pip install从网上进行安装，无需曙光云本地提供。例如以下安装numpy（注意先激活环境）</span></p> 
  <p style="margin-left:0;text-align:left;"></p> 
  <pre><span style="background-color:#fafafa;"><code><span style="color:#708090;"># 安装numpy</span>
<span style="color:#000000;">pip install numpy </span><span style="color:#9a6e3a;">-</span><span style="color:#000000;">i https</span><span style="color:#999999;">:</span><span style="color:#9a6e3a;">//</span><span style="color:#000000;">pypi</span><span style="color:#999999;">.</span><span style="color:#000000;">tuna</span><span style="color:#999999;">.</span><span style="color:#000000;">tsinghua</span><span style="color:#999999;">.</span><span style="color:#000000;">edu</span><span style="color:#999999;">.</span><span style="color:#000000;">cn</span><span style="color:#9a6e3a;">/</span><span style="color:#000000;">simple</span>
</code></span></pre> 
  <p></p> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">安装完毕后，可通过pip list所安装的包，</span><strong><span style="color:#333333;">到此步只是完成安装工作</span></strong><span style="color:#333333;">。</span></p> 
  <p style="margin-left:0;text-align:left;"></p> 
  <pre><span style="background-color:#fafafa;"><code><span style="color:#000000;">pip </span><span style="color:#669900;">list</span>
</code></span></pre> 
  <p></p> 
  <p style="margin-left:0;text-align:left;"></p> 
  <p style="margin-left:0;text-align:left;"><strong><span style="color:#333333;">1.1.3 节点申请、环境变量配置(测试能否调用到dcu)</span></strong></p> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">查看所在队列</span></p> 
  <p style="margin-left:0;text-align:left;"></p> 
  <pre><span style="background-color:#fafafa;"><code><span style="color:#000000;">whichpartition</span>
</code></span></pre> 
  <p></p> 
  <p style="margin-left:0;text-align:left;"><img alt="" height="48" src="https://images2.imgbox.com/3b/38/1xYreDFc_o.png" width="443"></p> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">申请并登录计算节点，进行测试</span></p> 
  <p style="margin-left:0;text-align:left;"></p> 
  <pre><span style="background-color:#fafafa;"><code><span style="color:#000000;">salloc  </span><span style="color:#9a6e3a;">-</span><span style="color:#000000;">p kshdtest </span><span style="color:#9a6e3a;">-</span><span style="color:#000000;">N </span><span style="color:#990055;">1</span> <span style="color:#9a6e3a;">-</span><span style="color:#000000;">n </span><span style="color:#990055;">8</span> <span style="color:#9a6e3a;">--</span><span style="color:#000000;">gres</span><span style="color:#9a6e3a;">=</span><span style="color:#000000;">dcu</span><span style="color:#999999;">:</span><span style="color:#990055;">1</span>
</code></span></pre> 
  <p></p> 
  <p style="margin-left:0;text-align:left;"></p> 
  <p style="margin-left:0;text-align:left;"><img alt="" height="173" src="https://images2.imgbox.com/c9/a4/WXFl8JLS_o.png" width="761"></p> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">登录计算节点</span></p> 
  <p style="margin-left:0;text-align:left;"></p> 
  <pre><span style="background-color:#fafafa;"><code><span style="color:#708090;"># ssh 节点</span>
<span style="color:#000000;">ssh b02r1n02</span>
</code></span></pre> 
  <p></p> 
  <p style="margin-left:0;text-align:left;"><img alt="" height="71" src="https://images2.imgbox.com/5a/95/ljOcHqmZ_o.png" width="639"></p> 
  <p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">切换rocm编译器版本（加载dtk2</span></span><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">3</span></span><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">.04），跟后续使用GPU的关系很大</span></span></p> 
  <p style="margin-left:0;text-align:left;"></p> 
  <pre><span style="background-color:#fafafa;"><code><span style="color:#000000;">module switch compiler</span><span style="color:#9a6e3a;">/</span><span style="color:#000000;">rocm</span><span style="color:#9a6e3a;">/</span><span style="color:#000000;">dtk</span><span style="color:#9a6e3a;">-</span><span style="color:#990055;">23.04</span>
</code></span></pre> 
  <p></p> 
  <p style="margin-left:0;text-align:left;"><img alt="" height="32" src="https://images2.imgbox.com/6d/45/00QRCFRZ_o.png" width="640"></p> 
  <p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">在本地创建一个pytorch_env.sh的文件，添加环境变量</span></span></p> 
  <p style="margin-left:0;text-align:left;"></p> 
  <pre><span style="background-color:#fafafa;"><code><span style="color:#000000;">vi  </span><span style="color:#9a6e3a;">~/</span><span style="color:#000000;">pytorch_env</span><span style="color:#999999;">.</span><span style="color:#000000;">sh</span>

<span style="color:#000000;">export LD_LIBRARY_PATH</span><span style="color:#9a6e3a;">=/</span><span style="color:#000000;">public</span><span style="color:#9a6e3a;">/</span><span style="color:#000000;">software</span><span style="color:#9a6e3a;">/</span><span style="color:#000000;">apps</span><span style="color:#9a6e3a;">/</span><span style="color:#000000;">DeepLearning</span><span style="color:#9a6e3a;">/</span><span style="color:#000000;">PyTorch</span><span style="color:#9a6e3a;">/</span><span style="color:#000000;">lib</span><span style="color:#999999;">:</span><span style="color:#9a6e3a;">/</span><span style="color:#000000;">public</span><span style="color:#9a6e3a;">/</span><span style="color:#000000;">software</span><span style="color:#9a6e3a;">/</span><span style="color:#000000;">apps</span><span style="color:#9a6e3a;">/</span><span style="color:#000000;">DeepLearning</span><span style="color:#9a6e3a;">/</span><span style="color:#000000;">PyTorch</span><span style="color:#9a6e3a;">/</span><span style="color:#000000;">lmdb</span><span style="color:#9a6e3a;">-</span><span style="color:#990055;">0.9.24</span><span style="color:#9a6e3a;">-</span><span style="color:#000000;">build</span><span style="color:#9a6e3a;">/</span><span style="color:#000000;">lib</span><span style="color:#999999;">:</span><span style="color:#9a6e3a;">/</span><span style="color:#000000;">public</span><span style="color:#9a6e3a;">/</span><span style="color:#000000;">software</span><span style="color:#9a6e3a;">/</span><span style="color:#000000;">apps</span><span style="color:#9a6e3a;">/</span><span style="color:#000000;">DeepLearning</span><span style="color:#9a6e3a;">/</span><span style="color:#000000;">PyTorch</span><span style="color:#9a6e3a;">/</span><span style="color:#000000;">opencv</span><span style="color:#9a6e3a;">-</span><span style="color:#990055;">2.4.13.6</span><span style="color:#9a6e3a;">-</span><span style="color:#000000;">build</span><span style="color:#9a6e3a;">/</span><span style="color:#000000;">lib</span><span style="color:#999999;">:</span><span style="color:#9a6e3a;">/</span><span style="color:#000000;">public</span><span style="color:#9a6e3a;">/</span><span style="color:#000000;">software</span><span style="color:#9a6e3a;">/</span><span style="color:#000000;">apps</span><span style="color:#9a6e3a;">/</span><span style="color:#000000;">DeepLearning</span><span style="color:#9a6e3a;">/</span><span style="color:#000000;">PyTorch</span><span style="color:#9a6e3a;">/</span><span style="color:#000000;">openblas</span><span style="color:#9a6e3a;">-</span><span style="color:#990055;">0.3.7</span><span style="color:#9a6e3a;">-</span><span style="color:#000000;">build</span><span style="color:#9a6e3a;">/</span><span style="color:#000000;">lib</span><span style="color:#999999;">:</span><span style="color:#000000;">$LD_LIBRARY_PATH</span>
</code></span></pre> 
  <p></p> 
  <p style="margin-left:0;text-align:left;"></p> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">source ~/pytorch_env.sh</span></p> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">以后每次登录新的节点时，</span><strong><span style="color:#333333;">一定要执行一次</span></strong><span style="color:#333333;">source ~/pytorch_env.sh命令，这关系到服务器能不能找到PyTorch</span></p> 
  <p style="margin-left:0;text-align:left;"><strong><span style="color:#333333;">1.1.4 测试pytorch是否可用</span></strong></p> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">依次输入</span></p> 
  <p style="margin-left:0;text-align:left;"></p> 
  <pre><span style="background-color:#fafafa;"><code><span style="color:#000000;">python</span>
<span style="color:#0077aa;">import</span><span style="color:#000000;"> torch</span>
<span style="color:#000000;">torch</span><span style="color:#999999;">.</span><span style="color:#000000;">cuda</span><span style="color:#999999;">.</span><span style="color:#000000;">is_available</span><span style="color:#999999;">()</span>
<span style="color:#000000;">torch</span><span style="color:#999999;">.</span><span style="color:#000000;">__version__</span>
</code></span></pre> 
  <p></p> 
  <p style="margin-left:0;text-align:left;"></p> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">此时，pytorch正常安装，且显卡可用</span></p> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">其他未使用到gpu的依赖包通过pip install xxx安装即可</span></p> 
  <ol><li style="text-align:left;"><strong><span style="color:#1a1a1a;">算子运行</span></strong></li></ol> 
  <h4 style="margin-left:0pt;text-align:left;"><strong><span style="color:#1a1a1a;">2.1 算子包、模型、数据上传</span></strong></h4> 
  <p style="margin-left:0;text-align:left;"></p> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">可通过E-File将算子、模型、数据等上传。通常文件大小大于2G可通过快传操作(需下载快传客户端)上传文件夹，经测试，快传速度大概为10Mbps(大概为1.25mb/s)。注意的是，由于曙光服务器无法访问内网，需在算子包对使用epointml包的部分进行改造，将数据、模型设为本地目录。直接读取，舍弃从平台下载的方式。</span></p> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">文件快传</span></p> 
  <p style="margin-left:0;text-align:center;"><img alt="" height="482" src="https://images2.imgbox.com/cf/a6/EAFqJBma_o.png" width="599"></p> 
  <h4 style="margin-left:0pt;text-align:left;"><strong><span style="color:#1a1a1a;">2.1.2 算子运行</span></strong></h4> 
  <h5 style="margin-left:0pt;text-align:left;"><strong><span style="color:#1a1a1a;">2.1.2.1 方式一 提交交互式作业</span></strong></h5> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">终端进入对应目录，激活相关坏境，节点申请完毕后 类似后台执行，示例如下：</span></p> 
  <ul><li style="text-align:left;"><span style="color:#333333;">首先查看是否有空闲节点</span></li></ul> 
  <p style="margin-left:0;text-align:left;"></p> 
  <pre><span style="background-color:#fafafa;"><code><span style="color:#000000;">sinfo</span>
</code></span></pre> 
  <p></p> 
  <p style="margin-left:0;text-align:left;"><img alt="" height="110" src="https://images2.imgbox.com/4e/54/aFbCjdfZ_o.png" width="563"></p> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">此时，看到有idle表示节点处于空闲状态，可申请资源使用</span></p> 
  <ul><li style="text-align:left;"><span style="color:#333333;">申请资源，方法可参考环境搭建中一系列流程</span></li></ul> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">申请节点--</span><span style="color:#333333;">source ~/pytorch_env.sh-</span><span style="color:#333333;">-激活环境</span></p> 
  <ul><li style="text-align:left;"><span style="color:#333333;">查看DCU状态</span></li></ul> 
  <p style="margin-left:0;text-align:left;"></p> 
  <pre><span style="background-color:#fafafa;"><code><span style="color:#000000;">hy-smi</span>
</code></span></pre> 
  <p></p> 
  <p style="margin-left:0;text-align:left;"><img alt="" height="258" src="https://images2.imgbox.com/b7/0e/CESHBh4n_o.png" width="762"></p> 
  <ul><li style="text-align:left;"><span style="color:#333333;">进入项目进行python xxx.py操作</span></li></ul> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">该方式运行的前提是节点有所空闲，且终端不能关闭，一旦关闭则运行退出。</span></p> 
  <h5 style="margin-left:0pt;text-align:left;"><strong><span style="color:#1a1a1a;">2.1.2.2 方式二 提交批处理作业(推荐)</span></strong></h5> 
  <p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">用户使用sbatch命令提交作业脚本，其基本格式为sbatch jobfile。jobfile为作业脚本文件。在批处理作业脚本中，脚本第一行以"#!"字符开头，并指定脚本文件的解释程序，如sh，bash。接下来写作业使用到的调度系统参数，以#开头，最后写作业运行的程序命令。</span></span></p> 
  <p style="margin-left:0;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#333333;">示例</span></span><span style="background-color:#ffffff;"><span style="color:#333333;">脚本如下：</span></span></p> 
  <p style="margin-left:0;text-align:left;"></p> 
  <pre><span style="background-color:#fafafa;"><code><span style="color:#000000;">#!/bin/bash</span>
<span style="color:#708090;">#SBATCH -o bloom.out         # 指定作业标准输出文件的名称</span>
<span style="color:#708090;">#SBATCH --partition=kshdtest # 表示将作业提交到kshdtest队列#SBATCH -J bloom_job         # 作业名称，可在作业管理中看到</span>
<span style="color:#708090;">#SBATCH -n 16                # 作业申请的总cpu核心数</span>
<span style="color:#708090;">#SBATCH -N 1                 # 作业申请的节点数</span>
<span style="color:#708090;">#SBATCH --gres=dcu:4         # 表示本作业使用的加速卡数量</span>
<span style="color:#708090;">#SBATCH --exclusive          # 指定作业独占计算节点   </span>

<span style="color:#000000;">module switch compiler/rocm/dtk-23.04  </span><span style="color:#708090;"># 切换rocm编译器版本</span>
<span style="color:#669900;">source</span><span style="color:#000000;"> ~/pytorch_env.sh                </span><span style="color:#708090;"># 激活~/pytorch_env.sh  </span>
<span style="color:#669900;">source</span><span style="color:#000000;"> activate env_py39               </span><span style="color:#708090;"># 激活对应环境</span>
<span style="color:#669900;">cd</span><span style="color:#000000;"> ~/test/infer                        </span><span style="color:#708090;"># cd到指定目录</span>
<span style="color:#000000;">python httptest.py                     </span><span style="color:#708090;"># 执行脚本</span>
</code></span></pre> 
  <p></p> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">更多常用选项可以参考如下链接：</span></p> 
  <p style="margin-left:0;text-align:left;"><a href="https://ac.sugon.com/doc/1.0.6/11250/general-handbook/scheduler/sbatch.html" rel="nofollow" title="提交批处理作业-sbatch">提交批处理作业-sbatch</a></p> 
  <p style="margin-left:0;text-align:left;"></p> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">定义好运行命令后，可执行</span></p> 
  <p style="margin-left:0;text-align:left;"></p> 
  <pre><span style="background-color:#fafafa;"><code><span style="color:#000000;">sbatch ~/bloom.sh</span>
</code></span></pre> 
  <p></p> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">等待作业运行即可，若此时无空闲节点，则该作业处理排队中</span></p> 
  <p style="margin-left:0;text-align:center;"><img alt="" height="49" src="https://images2.imgbox.com/db/2d/tDHcsyS2_o.png" width="451"></p> 
  <p style="margin-left:0;text-align:justify;"><span style="color:#333333;">排队处理</span></p> 
  <p style="margin-left:0;text-align:justify;"><img alt="" height="258" src="https://images2.imgbox.com/59/a8/c7kMxGE6_o.png" width="1200"></p> 
  <p style="margin-left:0;text-align:justify;"><span style="color:#333333;">运行完成</span></p> 
  <p style="margin-left:0;text-align:center;"><img alt="" height="80" src="https://images2.imgbox.com/be/60/4XJk1vmT_o.png" width="1200"></p> 
  <p style="margin-left:0;text-align:left;"><span style="color:#333333;">可在网页作业管理中找到该作业运行的日志，详细信息等</span></p> 
  <p style="margin-left:0;text-align:left;"><img alt="" height="910" src="https://images2.imgbox.com/b2/fb/X70iN1V2_o.png" width="1200"></p> 
  <ol><li style="text-align:left;"><strong><span style="color:#1a1a1a;">性能测试报告</span></strong></li></ol> 
  <h4 style="margin-left:0pt;text-align:left;"><strong><span style="color:#1a1a1a;">3.1 快捷指令</span></strong></h4> 
  <ul><li style="text-align:left;"><strong><span style="color:#333333;">Slurm命令</span></strong></li></ul> 
  <table border="1" cellspacing="0"><tbody><tr><td colspan="1" rowspan="1" style="background-color:#ebebeb;vertical-align:middle;width:134px;"> <p style="margin-left:0;text-align:center;"><span style="color:#121212;">Slurm命令</span></p> </td><td colspan="1" rowspan="1" style="background-color:#ebebeb;vertical-align:middle;width:324px;"> <p style="margin-left:0;text-align:center;"><span style="color:#121212;">功能</span></p> </td></tr><tr><td colspan="1" rowspan="1" style="background-color:#ffffff;vertical-align:middle;width:134px;"> <p style="margin-left:0;text-align:center;"><span style="color:#121212;">sinfo</span></p> </td><td colspan="1" rowspan="1" style="background-color:#ffffff;vertical-align:middle;width:324px;"> <p style="margin-left:0;text-align:center;"><span style="color:#121212;">查看集群分区状态</span></p> </td></tr><tr><td colspan="1" rowspan="1" style="background-color:#ffffff;vertical-align:middle;width:134px;"> <p style="margin-left:0;text-align:center;"><span style="color:#121212;">squeue</span></p> </td><td colspan="1" rowspan="1" style="background-color:#ffffff;vertical-align:middle;width:324px;"> <p style="margin-left:0;text-align:center;"><span style="color:#121212;">查看作业队列</span></p> </td></tr><tr><td colspan="1" rowspan="1" style="background-color:#ffffff;vertical-align:middle;width:134px;"> <p style="margin-left:0;text-align:center;"><span style="color:#121212;">srun, salloc</span></p> </td><td colspan="1" rowspan="1" style="background-color:#ffffff;vertical-align:middle;width:324px;"> <p style="margin-left:0;text-align:center;"><span style="color:#121212;">交互式运行作业</span></p> </td></tr><tr><td colspan="1" rowspan="1" style="background-color:#ffffff;vertical-align:middle;width:134px;"> <p style="margin-left:0;text-align:center;"><span style="color:#121212;">sbatch</span></p> </td><td colspan="1" rowspan="1" style="background-color:#ffffff;vertical-align:middle;width:324px;"> <p style="margin-left:0;text-align:center;"><span style="color:#121212;">提交作业</span></p> </td></tr><tr><td colspan="1" rowspan="1" style="background-color:#ffffff;vertical-align:middle;width:134px;"> <p style="margin-left:0;text-align:center;"><span style="color:#121212;">scancel</span></p> </td><td colspan="1" rowspan="1" style="background-color:#ffffff;vertical-align:middle;width:324px;"> <p style="margin-left:0;text-align:center;"><span style="color:#121212;">取消作业</span></p> </td></tr><tr><td colspan="1" rowspan="1" style="background-color:#ffffff;vertical-align:middle;width:134px;"> <p style="margin-left:0;text-align:center;"><span style="color:#121212;">scontrol</span></p> </td><td colspan="1" rowspan="1" style="background-color:#ffffff;vertical-align:middle;width:324px;"> <p style="margin-left:0;text-align:center;"><span style="color:#121212;">查看和修改作业参数</span></p> </td></tr><tr><td colspan="1" rowspan="1" style="background-color:#ffffff;vertical-align:middle;width:134px;"> <p style="margin-left:0;text-align:center;"><span style="color:#121212;">sacct</span></p> </td><td colspan="1" rowspan="1" style="background-color:#ffffff;vertical-align:middle;width:324px;"> <p style="margin-left:0;text-align:center;"><span style="color:#121212;">查看已完成作业</span></p> </td></tr></tbody></table> 
  <ul><li style="text-align:left;"><strong><span style="color:#333333;">sinfo</span></strong></li></ul> 
  <p style="margin-left:0;text-align:left;"></p> 
  <pre><span style="background-color:#fafafa;"><code><span style="color:#000000;">sinfo               </span><span style="color:#708090;">#查看所有分区状态</span>
<span style="color:#000000;">sinfo -a            </span><span style="color:#708090;">#查看所有分区状态</span>
<span style="color:#000000;">sinfo -N            </span><span style="color:#708090;">#查看节点状态</span>
<span style="color:#000000;">sinfo -n node-name  </span><span style="color:#708090;">#查看指定节点状态</span>
<span style="color:#000000;">sinfo --help        </span><span style="color:#708090;">#查看sinfo的说明</span>
</code></span></pre> 
  <p></p> 
  <ul><li style="text-align:left;"><strong><span style="color:#333333;">节点状态</span></strong></li></ul> 
  <table border="1" cellspacing="0"><tbody><tr><td colspan="1" rowspan="1" style="background-color:#f2f2f2;vertical-align:middle;width:120px;"> <p style="margin-left:0;text-align:center;"><span style="color:#333333;">alloc</span></p> </td><td colspan="1" rowspan="1" style="background-color:#f2f2f2;vertical-align:middle;width:120px;"> <p style="margin-left:0;text-align:center;"><span style="color:#333333;">idle</span></p> </td><td colspan="1" rowspan="1" style="background-color:#f2f2f2;vertical-align:middle;width:120px;"> <p style="margin-left:0;text-align:center;"><span style="color:#333333;">mix</span></p> </td><td colspan="1" rowspan="1" style="background-color:#f2f2f2;vertical-align:middle;width:120px;"> <p style="margin-left:0;text-align:center;"><span style="color:#333333;">down</span></p> </td><td colspan="1" rowspan="1" style="background-color:#f2f2f2;vertical-align:middle;width:120px;"> <p style="margin-left:0;text-align:center;"><span style="color:#333333;">drain</span></p> </td></tr><tr><td colspan="1" rowspan="1" style="vertical-align:middle;width:120px;"> <p style="margin-left:0;text-align:center;"><span style="color:#333333;">节点在用</span></p> </td><td colspan="1" rowspan="1" style="vertical-align:middle;width:120px;"> <p style="margin-left:0;text-align:center;"><span style="color:#333333;">节点可用</span></p> </td><td colspan="1" rowspan="1" style="vertical-align:middle;width:120px;"> <p style="margin-left:0;text-align:center;"><span style="color:#333333;">部分占用</span></p> </td><td colspan="1" rowspan="1" style="vertical-align:middle;width:120px;"> <p style="margin-left:0;text-align:center;"><span style="color:#333333;">节点下线</span></p> </td><td colspan="1" rowspan="1" style="vertical-align:middle;width:120px;"> <p style="margin-left:0;text-align:center;"><span style="color:#333333;">节点故障</span></p> </td></tr></tbody></table> 
  <ul><li style="text-align:left;"><strong><span style="color:#333333;">Squeue</span></strong></li></ul> 
  <p style="margin-left:0;text-align:left;"></p> 
  <p style="margin-left:0;text-align:left;"></p> 
  <pre><span style="background-color:#fafafa;"><code><span style="color:#000000;">squeue              </span><span style="color:#708090;">#查看运行中的作业列表</span>
<span style="color:#000000;">squeue -l           </span><span style="color:#708090;">#查看列表细节信息</span>
<span style="color:#000000;">squeue -j job-id    </span><span style="color:#708090;">#查看运行中作业信息</span>
<span style="color:#000000;">squeue -u username  </span><span style="color:#708090;">#查看user所有运行中的作业</span>
</code></span></pre> 
  <p></p> 
  <ul><li style="text-align:left;"><strong><span style="color:#333333;">作业状态</span></strong></li></ul> 
  <table border="1" cellspacing="0"><tbody><tr><td colspan="1" rowspan="1" style="background-color:#ebebeb;vertical-align:middle;width:125px;"> <p style="margin-left:0;text-align:center;"><span style="color:#121212;">R</span></p> </td><td colspan="1" rowspan="1" style="background-color:#ebebeb;vertical-align:middle;width:114px;"> <p style="margin-left:0;text-align:center;"><span style="color:#121212;">PD</span></p> </td><td colspan="1" rowspan="1" style="background-color:#ebebeb;vertical-align:middle;width:126px;"> <p style="margin-left:0;text-align:center;"><span style="color:#121212;">CG</span></p> </td><td colspan="1" rowspan="1" style="background-color:#ebebeb;vertical-align:middle;width:122px;"> <p style="margin-left:0;text-align:center;"><span style="color:#121212;">CD</span></p> </td></tr><tr><td colspan="1" rowspan="1" style="background-color:#ffffff;vertical-align:middle;width:125px;"> <p style="margin-left:0;text-align:center;"><span style="color:#121212;">正在运行</span></p> </td><td colspan="1" rowspan="1" style="background-color:#ffffff;vertical-align:middle;width:114px;"> <p style="margin-left:0;text-align:center;"><span style="color:#121212;">正在排队</span></p> </td><td colspan="1" rowspan="1" style="background-color:#ffffff;vertical-align:middle;width:126px;"> <p style="margin-left:0;text-align:center;"><span style="color:#121212;">即将完成</span></p> </td><td colspan="1" rowspan="1" style="background-color:#ffffff;vertical-align:middle;width:122px;"> <p style="margin-left:0;text-align:center;"><span style="color:#121212;">已完成</span></p> </td></tr></tbody></table> 
  <ul><li style="text-align:left;"><strong><span style="color:#333333;">查看显存使用情况</span></strong></li></ul> 
  <p style="margin-left:0;text-align:left;"></p> 
  <pre><span style="background-color:#fafafa;"><code><span style="color:#000000;">rocm-smi</span>
</code></span></pre> 
  <p></p> 
  <h4 style="margin-left:0pt;text-align:left;"><strong><span style="color:#1a1a1a;">3.2 推理性能测试报告</span></strong></h4> 
  <p style="margin-left:0;text-align:justify;"><span style="color:#333333;">测试脚本选用了belle-bloom-560m模型、100条测试数据进行推理，显存占用和推理时间如下</span></p> 
  <p style="margin-left:0;text-align:left;"><strong><span style="color:#333333;">中科曙光配置</span></strong></p> 
  <table border="1" cellspacing="0"><tbody><tr><td colspan="1" rowspan="1" style="background-color:#f2f2f2;vertical-align:middle;width:86.2px;"> <p style="margin-left:0;text-align:center;"><span style="color:#333333;">服务器</span></p> </td><td colspan="1" rowspan="1" style="background-color:#f2f2f2;vertical-align:middle;width:86.2px;"> <p style="margin-left:0;text-align:center;"><span style="color:#333333;">模型</span></p> </td><td colspan="1" rowspan="1" style="background-color:#f2f2f2;vertical-align:middle;width:86.2px;"> <p style="margin-left:0;text-align:center;"><span style="color:#333333;">显存占用</span></p> </td><td colspan="1" rowspan="1" style="background-color:#f2f2f2;vertical-align:middle;width:86.2px;"> <p style="margin-left:0;text-align:center;"><span style="color:#333333;">服务器</span></p> </td><td colspan="1" rowspan="1" style="background-color:#f2f2f2;vertical-align:middle;width:86.2px;"> <p style="margin-left:0;text-align:center;"><span style="color:#333333;">内存占用</span></p> </td><td colspan="1" rowspan="1" style="background-color:#f2f2f2;vertical-align:middle;width:86.2px;"> <p style="margin-left:0;text-align:center;"><span style="color:#333333;">平均推理时间</span></p> </td><td colspan="1" rowspan="1" style="background-color:#f2f2f2;vertical-align:middle;width:86.2px;"> <p style="margin-left:0;text-align:center;"><span style="color:#333333;">总耗时</span></p> </td></tr><tr><td colspan="1" rowspan="1" style="vertical-align:middle;width:86.2px;"> <p style="margin-left:0;text-align:center;"><span style="color:#333333;">DCU</span></p> </td><td colspan="1" rowspan="1" style="vertical-align:middle;width:86.2px;"> <p style="margin-left:0;text-align:center;"><span style="color:#333333;">belle-bloom-560m</span></p> </td><td colspan="1" rowspan="1" style="vertical-align:middle;width:86.2px;"> <p style="margin-left:0;text-align:center;"><span style="color:#333333;">16G</span><span style="color:#333333;">42%-88%</span></p> </td><td colspan="1" rowspan="1" style="vertical-align:middle;width:86.2px;"> <p style="margin-left:0;text-align:center;"><span style="color:#333333;">DCU</span></p> </td><td colspan="1" rowspan="1" style="vertical-align:middle;width:86.2px;"> <p style="margin-left:0;text-align:center;"><span style="color:#333333;"> 2</span><span style="color:#333333;">.5G</span></p> </td><td colspan="1" rowspan="1" style="vertical-align:middle;width:86.2px;"> <p style="margin-left:0;text-align:center;"><span style="color:#333333;">11.77s</span></p> </td><td colspan="1" rowspan="1" style="vertical-align:middle;width:86.2px;"> <p style="margin-left:0;text-align:center;"><span style="color:#333333;">1177.19s</span></p> </td></tr></tbody></table> 
  <p style="margin-left:0;text-align:left;"></p> 
  <p style="margin-left:0;text-align:left;"><strong><span style="color:#333333;">结果</span></strong></p> 
  <p style="margin-left:0;text-align:left;"><img alt="" height="523" src="https://images2.imgbox.com/59/83/oYVTYzmO_o.png" width="1025"></p> 
  <p style="margin-left:0;text-align:left;"></p> 
 </div> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c93167c1b120f3a63c00cb27a386ae0b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">大模型并行训练</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/80d3df4a8e3d78ca9802b4c8b0d7e621/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">PaddleDetection研究报告——百度目标检测PP-YOLOE论文解读&#43;实践应用</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>