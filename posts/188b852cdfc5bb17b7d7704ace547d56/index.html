<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>bmp2png---using libpng - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="bmp2png---using libpng" />
<meta property="og:description" content="#include &lt;png.h&gt;#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;stdint.h&gt;/* A coloured pixel. */typedef struct {uint8_t red;uint8_t green;uint8_t blue;} pixel_t;/* A picture. */typedef struct {pixel_t *pixels;size_t width;size_t height;} bitmap_t;/* Given &#34;bitmap&#34;, this returns the pixel of bitmap at the point (&#34;x&#34;, &#34;y&#34;). */static pixel_t * pixel_at (bitmap_t * bitmap, int x, int y){return bitmap-&gt;pixels &#43; bitmap-&gt;width * y &#43; x;}/* Write &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/188b852cdfc5bb17b7d7704ace547d56/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2011-04-07T23:39:00+08:00" />
<meta property="article:modified_time" content="2011-04-07T23:39:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">bmp2png---using libpng</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p><textarea name="code" class="cpp:collapse:showcolumns">#include &lt;png.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;stdint.h&gt;
    
/* A coloured pixel. */
typedef struct {
    uint8_t red;
    uint8_t green;
    uint8_t blue;
} pixel_t;
/* A picture. */
    
typedef struct  {
    pixel_t *pixels;
    size_t width;
    size_t height;
} bitmap_t;
    
/* Given "bitmap", this returns the pixel of bitmap at the point 
   ("x", "y"). */
static pixel_t * pixel_at (bitmap_t * bitmap, int x, int y)
{
    return bitmap-&gt;pixels + bitmap-&gt;width * y + x;
}
    
/* Write "bitmap" to a PNG file specified by "path"; returns 0 on
   success, non-zero on error. */
static int save_png_to_file (bitmap_t *bitmap, const char *path)
{
    FILE * fp;
    png_structp png_ptr = NULL;
    png_infop info_ptr = NULL;
    size_t x, y;
    png_byte ** row_pointers = NULL;
    /* "status" contains the return value of this function. At first
       it is set to a value which means 'failure'. When the routine
       has finished its work, it is set to a value which means
       'success'. */
    int status = -1;
    /* The following number is set by trial and error only. I cannot
       see where it it is documented in the libpng manual.
    */
    int pixel_size = 3;
    int depth = 8;
    
    fp = fopen (path, "wb");
    if (! fp) {
        goto fopen_failed;
    }
    png_ptr = png_create_write_struct (PNG_LIBPNG_VER_STRING, NULL, NULL, NULL);
    if (png_ptr == NULL) {
        goto png_create_write_struct_failed;
    }
    
    info_ptr = png_create_info_struct (png_ptr);
    if (info_ptr == NULL) {
        goto png_create_info_struct_failed;
    }
    
    /* Set up error handling. */
    if (setjmp (png_jmpbuf (png_ptr))) {
        goto png_failure;
    }
    
    /* Set image attributes. */
    png_set_IHDR (png_ptr,
                  info_ptr,
                  bitmap-&gt;width,
                  bitmap-&gt;height,
                  depth,
                  PNG_COLOR_TYPE_RGB,
                  PNG_INTERLACE_NONE,
                  PNG_COMPRESSION_TYPE_DEFAULT,
                  PNG_FILTER_TYPE_DEFAULT);
    
    /* Initialize rows of PNG. */
    row_pointers = png_malloc (png_ptr, bitmap-&gt;height * sizeof (png_byte *));
    for (y = 0; y &lt; bitmap-&gt;height; ++y) {
        png_byte *row = 
            png_malloc (png_ptr, sizeof (uint8_t) * bitmap-&gt;width * pixel_size);
        row_pointers[y] = row;
        for (x = 0; x &lt; bitmap-&gt;width; ++x) {
            pixel_t * pixel = pixel_at (bitmap, x, y);
            *row++ = pixel-&gt;red;
            *row++ = pixel-&gt;green;
            *row++ = pixel-&gt;blue;
        }
    }
    
    /* Write the image data to "fp". */
    png_init_io (png_ptr, fp);
    png_set_rows (png_ptr, info_ptr, row_pointers);
    png_write_png (png_ptr, info_ptr, PNG_TRANSFORM_IDENTITY, NULL);
    /* The routine has successfully written the file, so we set
       "status" to a value which indicates success. */
    status = 0;
    
    for (y = 0; y &lt; bitmap-&gt;height; y++) {
        png_free (png_ptr, row_pointers[y]);
    }
    png_free (png_ptr, row_pointers);
    
 png_failure:
 png_create_info_struct_failed:
    png_destroy_write_struct (&amp;png_ptr, &amp;info_ptr);
 png_create_write_struct_failed:
    fclose (fp);
 fopen_failed:
    return status;
}
/* Given "value" and "max", the maximum value which we expect "value"
   to take, this returns an integer between 0 and 255 proportional to
   "value" divided by "max". */
static int pix (int value, int max)
{
    if (value &lt; 0)
        return 0;
    return (int) (256.0 *((double) (value)/(double) max));
}
int main ()
{
    bitmap_t fruit;
    int x;
    int y;
    /* Create an image. */
    fruit.width = 100;
    fruit.height = 100;
    fruit.pixels = calloc (sizeof (pixel_t), fruit.width * fruit.height);
    for (y = 0; y &lt; fruit.height; y++) {
        for (x = 0; x &lt; fruit.width; x++) {
            pixel_t * pixel = pixel_at (&amp; fruit, x, y);
            pixel-&gt;red = pix (x, fruit.width);
            pixel-&gt;green = pix (y, fruit.height);
        }
    }
    /* Write the image to a file 'fruit.png'. */
    save_png_to_file (&amp; fruit, "fruit.png");
    return 0;
}</textarea> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fbe76b84e760ae5d70f8f7e4d6b0f58f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【Successful Lisp】语法（1）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ac10efdc7166291ba696e2a1162690a8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">用eclipse连接MySQL的一点心得体会，如何加载数据库驱动</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>