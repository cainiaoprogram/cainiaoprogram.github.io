<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>微信公众号脚手架 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="微信公众号脚手架" />
<meta property="og:description" content="一、前言 方便要开发微信公众号的朋友们，可以快速将服务搭建起来，不要把时间浪费在服务的搭建上，专心写我们的业务代码。
你需要了解的知识：
1.微信公众号大概的开发流程
2.注册公众号（本脚手架是用公共的测试账号）
3.服务器的配置
4.内网穿透（我用的是花生壳）
5.公众号开发文档先大概看一遍
废话不多说了，你懂得，直接讲重点…
脚手架代码下载地址：下载
二、几个关键的地方 本项目依赖SDK开发工具包（WxJava）https://gitee.com/binary/weixin-java-tools
2.1 验证服务器地址有效性 开发者ID(AppID)
开发者密码(AppSecret)
服务器地址(URL)
令牌(Token)
2.2 AccessToken的处理 access_token是公众号的全局唯一接口调用凭据，公众号调用各接口时都需使用access_token。开发者需要进行妥善保存。access_token的存储至少要保留512个字符空间。access_token的有效期目前为2个小时（7200秒），需定时刷新，重复获取将导致上次获取的access_token失效。
2.3 公众号消息的处理 2.4 网页授权，拆分链接 2.5 Js-Sdk配置，测试 将以上问题先注意一下。
三、怎么快速把项目跑起来 3.1 项目结构 3.2 修改配置 1.application.xml (公众号对应配置修改，支持多个公众号)
2.JedisConfiguration.java （修改Redis配置，如果不配置，就内存缓存）
3.3 启动服务 WxMpDemoApplication.java
3.4 常用配置 我的内网穿透域名：http://chenxingxing.51vip.biz
1.接口配置信息URL：${内网穿透域名}/wx/portal/${appId} 例如：http://chenxingxing.51vip.biz/wx/portal/wx62458041039e62ee 2.JS接口安全域名 例如：chenxingxing.51vip.biz 3.消息模板 例如：{{first.DATA}} 4.创建菜单 例如：http://chenxingxing.51vip.biz/wx/menu/wx62458041039e62ee/create 5.发送模板 例如：http://chenxingxing.51vip.biz/wx/other/wx62458041039e62ee/sendTemplate 6.授权回调地址 例如：http://chenxingxing.51vip.biz/wx/redirect/wx62458041039e62ee/oauth/callback 7.拆分链接 例如：http://chenxingxing.51vip.biz/wx/redirect/wx62458041039e62ee/split/jump?url=http://chenxingxing.51vip.biz 基本上到这，你的公众号就可以用了。然后你配置一下菜单，发消息，发模板，测试测试。
四、怎么玩 公众号开发文档：https://developers.weixin.qq.com/doc/offiaccount/Basic_Information/Access_Overview.html
4.1 创建菜单 访问url：http://chenxingxing.51vip.biz/wx/menu/wx62458041039e62ee/create
4.2 发送模板消息 访问url：http://chenxingxing.51vip.biz/wx/other/wx62458041039e62ee/sendTemplate
4.3 Js-Sdk测试 访问url：http://chenxingxing.51vip.biz/jssdk" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/3ef1796647e7f3858de86d416e180b74/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-02-22T16:08:08+08:00" />
<meta property="article:modified_time" content="2020-02-22T16:08:08+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">微信公众号脚手架</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><img src="https://images2.imgbox.com/13/f9/J2MYcJg9_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_1"></a>一、前言</h3> 
<p>方便要开发微信公众号的朋友们，可以快速将服务搭建起来，不要把时间浪费在服务的搭建上，专心写我们的业务代码。</p> 
<p>你需要了解的知识：</p> 
<blockquote> 
 <p>1.微信公众号大概的开发流程<br> 2.注册公众号（本脚手架是用公共的测试账号）<br> 3.服务器的配置<br> 4.内网穿透（我用的是花生壳）<br> 5.公众号开发文档先大概看一遍</p> 
</blockquote> 
<p>废话不多说了，你懂得，直接讲重点…</p> 
<p><img src="https://images2.imgbox.com/ea/e9/U5Kt5gIn_o.png" alt="在这里插入图片描述"><br> 脚手架代码下载地址：<a href="https://gitee.com/lanxinghua/wechat/tree/master/wechat-mp-demo" rel="nofollow">下载</a></p> 
<hr> 
<h3><a id="_17"></a>二、几个关键的地方</h3> 
<p>本项目依赖SDK开发工具包（WxJava）https://gitee.com/binary/weixin-java-tools</p> 
<h6><a id="21__19"></a>2.1 验证服务器地址有效性</h6> 
<p>开发者ID(AppID)<br> 开发者密码(AppSecret)<br> 服务器地址(URL)<br> 令牌(Token)</p> 
<h6><a id="22_AccessToken_25"></a>2.2 AccessToken的处理</h6> 
<p>access_token是公众号的全局唯一接口调用凭据，公众号调用各接口时都需使用access_token。开发者需要进行妥善保存。access_token的存储至少要保留512个字符空间。access_token的有效期目前为2个小时（7200秒），需定时刷新，重复获取将导致上次获取的access_token失效。</p> 
<h6><a id="23__28"></a>2.3 公众号消息的处理</h6> 
<h6><a id="24__30"></a>2.4 网页授权，拆分链接</h6> 
<h6><a id="25_JsSdk_31"></a>2.5 Js-Sdk配置，测试</h6> 
<p>将以上问题先注意一下。</p> 
<hr> 
<h3><a id="_36"></a>三、怎么快速把项目跑起来</h3> 
<h6><a id="31__37"></a>3.1 项目结构</h6> 
<p><img src="https://images2.imgbox.com/4a/20/r6ulo0et_o.png" alt="Alt" width="500" height="300"></p> 
<hr> 
<h6><a id="32__42"></a>3.2 修改配置</h6> 
<p>1.application.xml (公众号对应配置修改，支持多个公众号)<br> 2.JedisConfiguration.java （修改Redis配置，如果不配置，就内存缓存）</p> 
<hr> 
<h6><a id="33__48"></a>3.3 启动服务</h6> 
<p>WxMpDemoApplication.java<br> <img src="https://images2.imgbox.com/d5/37/XeItS8Xz_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<h6><a id="34__53"></a>3.4 常用配置</h6> 
<p>我的内网穿透域名：http://chenxingxing.51vip.biz</p> 
<pre><code class="prism language-html">1.接口配置信息URL：${内网穿透域名}/wx/portal/${appId}
例如：http://chenxingxing.51vip.biz/wx/portal/wx62458041039e62ee

2.JS接口安全域名
例如：chenxingxing.51vip.biz

3.消息模板
例如：{<!-- -->{first.DATA}}

4.创建菜单    
例如：http://chenxingxing.51vip.biz/wx/menu/wx62458041039e62ee/create

5.发送模板
例如：http://chenxingxing.51vip.biz/wx/other/wx62458041039e62ee/sendTemplate

6.授权回调地址
例如：http://chenxingxing.51vip.biz/wx/redirect/wx62458041039e62ee/oauth/callback

7.拆分链接
例如：http://chenxingxing.51vip.biz/wx/redirect/wx62458041039e62ee/split/jump?url=http://chenxingxing.51vip.biz
</code></pre> 
<p>基本上到这，你的公众号就可以用了。然后你配置一下菜单，发消息，发模板，测试测试。</p> 
<hr> 
<h3><a id="_81"></a>四、怎么玩</h3> 
<p><a href="https://developers.weixin.qq.com/doc/offiaccount/Basic_Information/Access_Overview.html" rel="nofollow">公众号开发文档：</a>https://developers.weixin.qq.com/doc/offiaccount/Basic_Information/Access_Overview.html</p> 
<h6><a id="41__84"></a>4.1 创建菜单</h6> 
<p>访问url：http://chenxingxing.51vip.biz/wx/menu/wx62458041039e62ee/create<br> <img src="https://images2.imgbox.com/4c/6a/1KlaYCps_o.png" alt="Alt" width="300" height="600"></p> 
<hr> 
<h6><a id="42__89"></a>4.2 发送模板消息</h6> 
<p>访问url：http://chenxingxing.51vip.biz/wx/other/wx62458041039e62ee/sendTemplate</p> 
<p><img src="https://images2.imgbox.com/86/5a/O0RVP1YQ_o.png" alt="Alt" width="500" height="300"></p> 
<hr> 
<h6><a id="43_JsSdk_95"></a>4.3 Js-Sdk测试</h6> 
<p>访问url：http://chenxingxing.51vip.biz/jssdk<br> <img src="https://images2.imgbox.com/90/2e/QGqD5PMv_o.png" alt="在这里插入图片描述" width="400" height="600"></p> 
<pre><code class="prism language-html"><span class="token doctype">&lt;!DOCTYPE HTML&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>th</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.thymeleaf.org<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Jssdk测试<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://res.wx.qq.com/open/js/jweixin-1.6.0.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://www.w3school.com.cn/jquery/jquery-1.11.1.min.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Content-Type<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text/html; charset=UTF-8<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token comment">&lt;!-- head 中 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://cdn.bootcss.com/weui/1.1.3/style/weui.min.css<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://cdn.bootcss.com/jquery-weui/1.2.1/css/jquery-weui.min.css<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Jssdk测试<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>javascript:;<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>weui-btn weui-btn_primary<span class="token punctuation">"</span></span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wxConfig()<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>wxConfig<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>javascript:;<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>weui-btn weui-btn_warn<span class="token punctuation">"</span></span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>share()<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>分享<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>javascript:;<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>weui-btn weui-btn_default<span class="token punctuation">"</span></span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>chooseImage()<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>拍照<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>javascript:;<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>weui-btn weui-btn_warn<span class="token punctuation">"</span></span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>pay()<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>微信支付<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>javascript:;<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>weui-btn weui-btn_plain-default<span class="token punctuation">"</span></span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>getLocation()<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>获取地理位置<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>javascript:;<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>weui-btn weui-btn_plain-primary<span class="token punctuation">"</span></span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>scanQRCode()<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>扫一扫<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://cdn.bootcss.com/jquery/1.11.0/jquery.min.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://cdn.bootcss.com/jquery-weui/1.2.1/js/jquery-weui.min.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript">
    <span class="token keyword">function</span> <span class="token function">wxConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        $<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">"wx/redirect/wx62458041039e62ee/create/jsapi_sign"</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span>
            url<span class="token punctuation">:</span>location<span class="token punctuation">.</span>href  <span class="token comment">//传递当前页面的url</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            wx<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                debug<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token comment">// 开启调试模式,如何设计为true的话调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印，如果为false则不打印</span>
                appId<span class="token punctuation">:</span> data<span class="token punctuation">.</span>appId<span class="token punctuation">,</span><span class="token comment">// 必填，公众号的唯一标识</span>
                timestamp<span class="token punctuation">:</span> data<span class="token punctuation">.</span>timestamp<span class="token punctuation">,</span><span class="token comment">// 必填，生成签名的时间戳</span>
                nonceStr<span class="token punctuation">:</span> data<span class="token punctuation">.</span>nonceStr<span class="token punctuation">,</span> <span class="token comment">// 必填，生成签名的随机串</span>
                signature<span class="token punctuation">:</span> data<span class="token punctuation">.</span>signature<span class="token punctuation">,</span><span class="token comment">// 必填，签名</span>
                jsApiList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'chooseImage'</span><span class="token punctuation">,</span> <span class="token string">'scanQRCode'</span><span class="token punctuation">,</span><span class="token string">'updateAppMessageShareData'</span><span class="token punctuation">,</span><span class="token string">'getLocation'</span><span class="token punctuation">,</span><span class="token string">'closeWindow'</span><span class="token punctuation">,</span><span class="token string">'checkJsApi'</span><span class="token punctuation">]</span>  <span class="token comment">// 必填，需要使用的JS接口列表</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            wx<span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                $<span class="token punctuation">.</span><span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"验证成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            wx<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                $<span class="token punctuation">.</span><span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"微信认证失败，请重试"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">share</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        wx<span class="token punctuation">.</span><span class="token function">updateAppMessageShareData</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            title<span class="token punctuation">:</span> <span class="token string">'分享标题'</span><span class="token punctuation">,</span> <span class="token comment">// 分享标题</span>
            desc<span class="token punctuation">:</span> <span class="token string">'分享描述'</span><span class="token punctuation">,</span> <span class="token comment">// 分享描述</span>
            link<span class="token punctuation">:</span> <span class="token string">'http://chenxingxing.51vip.biz/jssdk'</span><span class="token punctuation">,</span> <span class="token comment">// 该链接域名或路径必须与当前页面对应的公众号JS安全域名一致</span>
            imgUrl<span class="token punctuation">:</span> <span class="token string">'http://mmbiz.qpic.cn/mmbiz_jpg/kqu5eakDVMTcnKRKc54W9NZaLkWLSlibgXOAvicicAGV6XwTSYf6WhMQ1ov0RLE9ahKw54BvOcmexNmy9pdNGklqw/0'</span><span class="token punctuation">,</span> <span class="token comment">// 分享图标</span>
            success<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 设置成功</span>
                $<span class="token punctuation">.</span><span class="token function">alert</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">chooseImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        wx<span class="token punctuation">.</span><span class="token function">chooseImage</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            count<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 默认9</span>
            sizeType<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'original'</span><span class="token punctuation">,</span> <span class="token string">'compressed'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 可以指定是原图还是压缩图，默认二者都有</span>
            sourceType<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'album'</span><span class="token punctuation">,</span> <span class="token string">'camera'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 可以指定来源是相册还是相机，默认二者都有</span>
            success<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">var</span> localIds <span class="token operator">=</span> res<span class="token punctuation">.</span>localIds<span class="token punctuation">;</span> <span class="token comment">// 返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片</span>
                $<span class="token punctuation">.</span><span class="token function">alert</span><span class="token punctuation">(</span>localIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">getLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        wx<span class="token punctuation">.</span><span class="token function">getLocation</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            type<span class="token punctuation">:</span> <span class="token string">'wgs84'</span><span class="token punctuation">,</span> <span class="token comment">// 默认为wgs84的gps坐标，如果要返回直接给openLocation用的火星坐标，可传入'gcj02'</span>
            success<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">var</span> latitude <span class="token operator">=</span> res<span class="token punctuation">.</span>latitude<span class="token punctuation">;</span> <span class="token comment">// 纬度，浮点数，范围为90 ~ -90</span>
                <span class="token keyword">var</span> longitude <span class="token operator">=</span> res<span class="token punctuation">.</span>longitude<span class="token punctuation">;</span> <span class="token comment">// 经度，浮点数，范围为180 ~ -180。</span>
                <span class="token keyword">var</span> speed <span class="token operator">=</span> res<span class="token punctuation">.</span>speed<span class="token punctuation">;</span> <span class="token comment">// 速度，以米/每秒计</span>
                <span class="token keyword">var</span> accuracy <span class="token operator">=</span> res<span class="token punctuation">.</span>accuracy<span class="token punctuation">;</span> <span class="token comment">// 位置精度</span>
                $<span class="token punctuation">.</span><span class="token function">alert</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">scanQRCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        wx<span class="token punctuation">.</span><span class="token function">scanQRCode</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            needResult<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 默认为0，扫描结果由微信处理，1则直接返回扫描结果，</span>
            scanType<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"qrCode"</span><span class="token punctuation">,</span><span class="token string">"barCode"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 可以指定扫二维码还是一维码，默认二者都有</span>
            success<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">var</span> result <span class="token operator">=</span> res<span class="token punctuation">.</span>resultStr<span class="token punctuation">;</span> <span class="token comment">// 当needResult 为 1 时，扫码返回的结果</span>
                $<span class="token punctuation">.</span><span class="token function">alert</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">pay</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        wx<span class="token punctuation">.</span><span class="token function">chooseWXPay</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            timestamp<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 支付签名时间戳，注意微信jssdk中的所有使用timestamp字段均为小写。但最新版的支付后台生成签名使用的timeStamp字段名需大写其中的S字符</span>
            nonceStr<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token comment">// 支付签名随机串，不长于 32 位</span>
            <span class="token keyword">package</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token comment">// 统一支付接口返回的prepay_id参数值，提交格式如：prepay_id=\*\*\*）</span>
            signType<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token comment">// 签名方式，默认为'SHA1'，使用新版支付需传入'MD5'</span>
            paySign<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token comment">// 支付签名</span>
            success<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 支付成功后的回调函数</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<hr> 
<h6><a id="44__213"></a>4.4 拆分链接</h6> 
<p>访问url：http://chenxingxing.51vip.biz/wx/redirect/wx62458041039e62ee/split/jump?url=http://chenxingxing.51vip.biz</p> 
<p>比如我们现在微信公众号里面访问http://chenxingxing.51vip.biz这个页面，但是这个页面要先让用户授权，所以这里我们同样通过拆分链接的方式，在后头自动实现授权，然后将用户授权完的信息token，返回给前端。【拆分链接的好处，不需要配置个性化参数，很多地方都可以嵌入该链接】</p> 
<p><img src="https://images2.imgbox.com/48/77/5cyVA5NB_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<h6><a id="45__221"></a>4.5 各种事件的处理</h6> 
<p>在对于Hadler里面处理就可以。<br> <img src="https://images2.imgbox.com/c4/16/O8oYEeHT_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>lxh<span class="token punctuation">.</span>mp<span class="token punctuation">.</span>config<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>lxh<span class="token punctuation">.</span>mp<span class="token punctuation">.</span>handler<span class="token punctuation">.</span>*<span class="token punctuation">;</span>
<span class="token keyword">import</span> lombok<span class="token punctuation">.</span>Data<span class="token punctuation">;</span>
<span class="token keyword">import</span> me<span class="token punctuation">.</span>chanjar<span class="token punctuation">.</span>weixin<span class="token punctuation">.</span>common<span class="token punctuation">.</span>api<span class="token punctuation">.</span>WxConsts<span class="token punctuation">;</span>
<span class="token keyword">import</span> me<span class="token punctuation">.</span>chanjar<span class="token punctuation">.</span>weixin<span class="token punctuation">.</span>mp<span class="token punctuation">.</span>api<span class="token punctuation">.</span>WxMpMessageRouter<span class="token punctuation">;</span>
<span class="token keyword">import</span> me<span class="token punctuation">.</span>chanjar<span class="token punctuation">.</span>weixin<span class="token punctuation">.</span>mp<span class="token punctuation">.</span>api<span class="token punctuation">.</span>WxMpService<span class="token punctuation">;</span>
<span class="token keyword">import</span> me<span class="token punctuation">.</span>chanjar<span class="token punctuation">.</span>weixin<span class="token punctuation">.</span>mp<span class="token punctuation">.</span>api<span class="token punctuation">.</span>impl<span class="token punctuation">.</span>WxMpServiceImpl<span class="token punctuation">;</span>
<span class="token keyword">import</span> me<span class="token punctuation">.</span>chanjar<span class="token punctuation">.</span>weixin<span class="token punctuation">.</span>mp<span class="token punctuation">.</span>config<span class="token punctuation">.</span>impl<span class="token punctuation">.</span>WxMpDefaultConfigImpl<span class="token punctuation">;</span>
<span class="token keyword">import</span> me<span class="token punctuation">.</span>chanjar<span class="token punctuation">.</span>weixin<span class="token punctuation">.</span>mp<span class="token punctuation">.</span>config<span class="token punctuation">.</span>impl<span class="token punctuation">.</span>WxMpRedisConfigImpl<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>context<span class="token punctuation">.</span>properties<span class="token punctuation">.</span>EnableConfigurationProperties<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Bean<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Configuration<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Order<span class="token punctuation">;</span>
<span class="token keyword">import</span> redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span>Jedis<span class="token punctuation">;</span>
<span class="token keyword">import</span> redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span>JedisPool<span class="token punctuation">;</span>

<span class="token keyword">import</span> javax<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Resource<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>stream<span class="token punctuation">.</span>Collectors<span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token keyword">static</span> me<span class="token punctuation">.</span>chanjar<span class="token punctuation">.</span>weixin<span class="token punctuation">.</span>common<span class="token punctuation">.</span>api<span class="token punctuation">.</span>WxConsts<span class="token punctuation">.</span>EventType<span class="token punctuation">.</span>*<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">static</span> me<span class="token punctuation">.</span>chanjar<span class="token punctuation">.</span>weixin<span class="token punctuation">.</span>common<span class="token punctuation">.</span>api<span class="token punctuation">.</span>WxConsts<span class="token punctuation">.</span>XmlMsgType<span class="token punctuation">.</span>EVENT<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">static</span> me<span class="token punctuation">.</span>chanjar<span class="token punctuation">.</span>weixin<span class="token punctuation">.</span>common<span class="token punctuation">.</span>api<span class="token punctuation">.</span>WxConsts<span class="token punctuation">.</span>MenuButtonType<span class="token punctuation">.</span>CLICK<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">static</span> me<span class="token punctuation">.</span>chanjar<span class="token punctuation">.</span>weixin<span class="token punctuation">.</span>common<span class="token punctuation">.</span>api<span class="token punctuation">.</span>WxConsts<span class="token punctuation">.</span>MenuButtonType<span class="token punctuation">.</span>VIEW<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">static</span> me<span class="token punctuation">.</span>chanjar<span class="token punctuation">.</span>weixin<span class="token punctuation">.</span>mp<span class="token punctuation">.</span>constant<span class="token punctuation">.</span>WxMpEventConstants<span class="token punctuation">.</span>CustomerService<span class="token punctuation">.</span>*<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">static</span> me<span class="token punctuation">.</span>chanjar<span class="token punctuation">.</span>weixin<span class="token punctuation">.</span>mp<span class="token punctuation">.</span>constant<span class="token punctuation">.</span>WxMpEventConstants<span class="token punctuation">.</span>POI_CHECK_NOTIFY<span class="token punctuation">;</span>

<span class="token comment">/**
 * created by lanxinghua@2dfire.com on 2020/2/21
 * 微信公众号配置
 * wxMpService
 * WxMpMessageRouter
 *
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span>WxMpProperties<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WxMpConfiguration</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> WxMpProperties properties<span class="token punctuation">;</span>
    <span class="token comment">// 更新2020.2.22 加入redis</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> JedisPool jedisPool<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> LogHandler logHandler<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> NullHandler nullHandler<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> KfSessionHandler kfSessionHandler<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> StoreCheckNotifyHandler storeCheckNotifyHandler<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> LocationHandler locationHandler<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> MenuHandler menuHandler<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> MsgHandler msgHandler<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> UnSubscribeHandler unsubscribeHandler<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> SubscribeHandler subscribeHandler<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> ScanHandler scanHandler<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> WxMpService <span class="token function">wxMpService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>WxMpProperties<span class="token punctuation">.</span>MpConfig<span class="token punctuation">&gt;</span></span> configs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>properties<span class="token punctuation">.</span><span class="token function">getConfigs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>configs <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"请添加公众号相关配置，注意别配错了！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        WxMpService service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WxMpServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 公众号信息缓存起来</span>
        service<span class="token punctuation">.</span><span class="token function">setMultiConfigStorages</span><span class="token punctuation">(</span>configs<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>a <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 默认缓存在内存中，配置redis就放入redis中</span>
            WxMpDefaultConfigImpl configStorage <span class="token operator">=</span> <span class="token operator">!</span><span class="token function">redisIsOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">WxMpDefaultConfigImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">WxMpRedisConfigImpl</span><span class="token punctuation">(</span>jedisPool<span class="token punctuation">)</span><span class="token punctuation">;</span>

            configStorage<span class="token punctuation">.</span><span class="token function">setAppId</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">getAppId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            configStorage<span class="token punctuation">.</span><span class="token function">setSecret</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">getSecret</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            configStorage<span class="token punctuation">.</span><span class="token function">setToken</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            configStorage<span class="token punctuation">.</span><span class="token function">setAesKey</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">getAesKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> configStorage<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span>WxMpDefaultConfigImpl<span class="token operator">:</span><span class="token operator">:</span>getAppId<span class="token punctuation">,</span> e <span class="token operator">-</span><span class="token operator">&gt;</span> e<span class="token punctuation">,</span> <span class="token punctuation">(</span>o<span class="token punctuation">,</span> n<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> o<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> service<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * redis是否可用
     * @return
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">redisIsOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            Jedis jedis <span class="token operator">=</span> jedisPool<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            jedis<span class="token punctuation">.</span><span class="token function">ping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> WxMpMessageRouter <span class="token function">wxMpMessageRouter</span><span class="token punctuation">(</span>WxMpService wxMpService<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> WxMpMessageRouter newRouter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WxMpMessageRouter</span><span class="token punctuation">(</span>wxMpService<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 记录所有事件的日志 （异步执行）</span>
        newRouter<span class="token punctuation">.</span><span class="token function">rule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logHandler<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">/**---------------------------------------  事件处理 ----------------------------------------**/</span>
        <span class="token comment">// 接收客服会话管理事件</span>
        newRouter<span class="token punctuation">.</span><span class="token function">rule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">msgType</span><span class="token punctuation">(</span>EVENT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">event</span><span class="token punctuation">(</span>KF_CREATE_SESSION<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>kfSessionHandler<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        newRouter<span class="token punctuation">.</span><span class="token function">rule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">msgType</span><span class="token punctuation">(</span>EVENT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">event</span><span class="token punctuation">(</span>KF_CLOSE_SESSION<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>kfSessionHandler<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        newRouter<span class="token punctuation">.</span><span class="token function">rule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">msgType</span><span class="token punctuation">(</span>EVENT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">event</span><span class="token punctuation">(</span>KF_SWITCH_SESSION<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>kfSessionHandler<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 门店审核事件</span>
        newRouter<span class="token punctuation">.</span><span class="token function">rule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">msgType</span><span class="token punctuation">(</span>EVENT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">event</span><span class="token punctuation">(</span>POI_CHECK_NOTIFY<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>storeCheckNotifyHandler<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 自定义菜单事件</span>
        newRouter<span class="token punctuation">.</span><span class="token function">rule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">msgType</span><span class="token punctuation">(</span>EVENT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">event</span><span class="token punctuation">(</span>CLICK<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>menuHandler<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 点击菜单连接事件</span>
        newRouter<span class="token punctuation">.</span><span class="token function">rule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">msgType</span><span class="token punctuation">(</span>EVENT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">event</span><span class="token punctuation">(</span>VIEW<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>nullHandler<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 关注事件</span>
        newRouter<span class="token punctuation">.</span><span class="token function">rule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">msgType</span><span class="token punctuation">(</span>EVENT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">event</span><span class="token punctuation">(</span>SUBSCRIBE<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>subscribeHandler<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 取消关注事件</span>
        newRouter<span class="token punctuation">.</span><span class="token function">rule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">msgType</span><span class="token punctuation">(</span>EVENT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">event</span><span class="token punctuation">(</span>UNSUBSCRIBE<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>unsubscribeHandler<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 上报地理位置事件</span>
        newRouter<span class="token punctuation">.</span><span class="token function">rule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">msgType</span><span class="token punctuation">(</span>EVENT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">event</span><span class="token punctuation">(</span>WxConsts<span class="token punctuation">.</span>EventType<span class="token punctuation">.</span>LOCATION<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>locationHandler<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 接收地理位置消息</span>
        newRouter<span class="token punctuation">.</span><span class="token function">rule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">msgType</span><span class="token punctuation">(</span>WxConsts<span class="token punctuation">.</span>XmlMsgType<span class="token punctuation">.</span>LOCATION<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>locationHandler<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 扫码事件</span>
        newRouter<span class="token punctuation">.</span><span class="token function">rule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">msgType</span><span class="token punctuation">(</span>EVENT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">event</span><span class="token punctuation">(</span>WxConsts<span class="token punctuation">.</span>EventType<span class="token punctuation">.</span>SCAN<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>scanHandler<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 默认</span>
        newRouter<span class="token punctuation">.</span><span class="token function">rule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>msgHandler<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> newRouter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<hr> 
<p>后续还将整理小程序，企业微信的脚手架！！！</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/21efaaa1d0214fcc128681d04bca8e54/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Curator的简单封装使用</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/32186cae9beb2d4aca6f5b9376be85a8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">C&#43;&#43;打不开文件</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>