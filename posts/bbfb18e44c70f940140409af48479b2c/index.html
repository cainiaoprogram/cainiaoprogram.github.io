<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【分布式微服务专题】SpringSecurity OAuth2快速入门 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【分布式微服务专题】SpringSecurity OAuth2快速入门" />
<meta property="og:description" content="目录 前言阅读对象阅读导航前置知识笔记正文一、OAuth2 介绍1.1 使用场景*1.2 基本概念（角色）1.3 优缺点 二、OAuth2的设计思路2.1 客户端授权模式2.1.0 基本参数说明2.1.1 授权码模式2.1.2 简化（隐式）模式2.1.3 密码模式2.1.4 客户端模式 2.2 令牌的使用2.3 令牌更新 三、Spring Security OAuth2快速开始3.1 授权服务器的几个节点3.2 整体架构（授权码模式）3.3 代码整合（授权码模式）3.4 更新令牌3.5 基于redis存储Token 四、Spring Security Oauth2整合JWT4.1 整合JWT4.2 扩展JWT中的存储内容4.3 解析JWT 学习总结感谢 前言 这里面的笔记都是我这里抄抄那里抄抄得来的，然后也经过了一些简单的测试，主要是用来拓宽知识面用的，毕竟到了项目开发中，不会裸用这些技术框架，通常都是采用第三方集成框架。
另外需要说明的是，这里要介绍的Spring Security OAuth2框架应该有点过时了，在Spring官网已经没有了项目介绍，现在项目似乎已经升级，并且迁移为Spring Authorization Server项目。所以我打算学习完现在的OAuth2之后，继续学习Spring Authorization Server。
阅读对象 了解、熟悉Spring Security有过OAuth2使用经验 阅读导航 系列上一篇文章：《【分布式微服务专题】SpringSecurity快速入门》
前置知识 笔记正文 一、OAuth2 介绍 权威文档地址：OAuth2.0协议介绍
OAuth（Open Authorization，开放授权）是一个关于授权（authorization）的开放网络标准协议，允许用户授权第三方应用访问他们存储在另外的服务提供者上的信息，而不需要将用户名和密码提供给第三方移动应用或分享他们数据的所有内容。OAuth在全世界得到广泛应用，目前的版本是2.0版。
注意：OAuth2只是一种标准协议，或者叫作：规范！ 其实在我们计算机学习中，你会发现很多各种各样的规范，这些规范往往指的是一种约定，并不特指某一具体的项目，SpringSecurityOAuth2才是一个具体的项目。可别被带偏了呀
标准协议特点：
简单：不管是OAuth服务提供者还是应用开发者，都很易于理解与使用安全：没有涉及到用户密钥等信息，更安全更灵活开放：任何服务提供商都可以实现OAuth，任何软件开发商都可以使用OAuth 1.1 使用场景 原生app授权：app登录请求后台接口，为了安全认证，所有请求都带token信息，如果登录验证、请求后台数据。前后端分离单页面应用：前后端分离框架，前端请求后台数据，需要进行oauth2安全认证，比如使用vue、react或者h5开发的app第三方应用授权登录，比如QQ，微博，微信的授权登录 案例1：云快印
有一个【云快印】的网站，可以将用户存储在的百度网盘上的照片打印出来。用户为了使用该服务，必须让【云快印】读取自己储存在百度网盘上的照片。只有得到用户的授权，百度网盘才会同意【云快印】取这些照片。那么，【云快印】怎样获得用户的授权呢？
传统方法是，用户将自己百度网盘的用户名和密码，告诉【云快印】，后者就可以读取用户的照片了。这样的做法有以下几个严重的缺点：
【云快印】为了后续的服务，会保存用户的密码，这样很不安全百度网盘不得不部署密码登录，而我们知道，单纯的密码登录并不安全【云快印】拥有了获取用户储存在百度网盘服务所有资料的权力，用户没法限制【云快印】获得授权的范围和有效期用户只有修改密码，才能收回赋予【云快印】的权力。但是这样做，会使得其他所有获得用户授权的第三方应用程序全部失效只要有一个第三方应用程序被破解，就会导致用户密码泄漏，以及所有被密码保护的数据泄漏。 综上缺陷，这显然不是我们期待的方案。
案例2：CSDN登录
附上一张常见的OAuth2场景：CSDN接入微信QQ开放平台，用户可以通过微信QQ登录CSDN
*1.2 基本概念（角色） 角色：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/bbfb18e44c70f940140409af48479b2c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-09T15:04:57+08:00" />
<meta property="article:modified_time" content="2024-01-09T15:04:57+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【分布式微服务专题】SpringSecurity OAuth2快速入门</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#_1" rel="nofollow">前言</a></li><li><a href="#_4" rel="nofollow">阅读对象</a></li><li><a href="#_7" rel="nofollow">阅读导航</a></li><li><a href="#_9" rel="nofollow">前置知识</a></li><li><a href="#_10" rel="nofollow">笔记正文</a></li><li><ul><li><a href="#OAuth2__11" rel="nofollow">一、OAuth2 介绍</a></li><li><ul><li><a href="#11__23" rel="nofollow">1.1 使用场景</a></li><li><a href="#font_colorred12_font_42" rel="nofollow"><font color="red">*1.2 基本概念（角色）</font></a></li><li><a href="#13__55" rel="nofollow">1.3 优缺点</a></li></ul> 
   </li><li><a href="#OAuth2_70" rel="nofollow">二、OAuth2的设计思路</a></li><li><ul><li><a href="#21__86" rel="nofollow">2.1 客户端授权模式</a></li><li><ul><li><a href="#210__95" rel="nofollow">2.1.0 基本参数说明</a></li><li><a href="#211__106" rel="nofollow">2.1.1 授权码模式</a></li><li><a href="#212__166" rel="nofollow">2.1.2 简化（隐式）模式</a></li><li><a href="#213__197" rel="nofollow">2.1.3 密码模式</a></li><li><a href="#214__223" rel="nofollow">2.1.4 客户端模式</a></li></ul> 
    </li><li><a href="#22__243" rel="nofollow">2.2 令牌的使用</a></li><li><a href="#23__246" rel="nofollow">2.3 令牌更新</a></li></ul> 
   </li><li><a href="#Spring_Security_OAuth2_258" rel="nofollow">三、Spring Security OAuth2快速开始</a></li><li><ul><li><a href="#31__267" rel="nofollow">3.1 授权服务器的几个节点</a></li><li><a href="#32__275" rel="nofollow">3.2 整体架构（授权码模式）</a></li><li><a href="#33__283" rel="nofollow">3.3 代码整合（授权码模式）</a></li><li><a href="#34__387" rel="nofollow">3.4 更新令牌</a></li><li><a href="#35_redisToken_439" rel="nofollow">3.5 基于redis存储Token</a></li></ul> 
   </li><li><a href="#Spring_Security_Oauth2JWT_490" rel="nofollow">四、Spring Security Oauth2整合JWT</a></li><li><ul><li><a href="#41_JWT_493" rel="nofollow">4.1 整合JWT</a></li><li><a href="#42_JWT_583" rel="nofollow">4.2 扩展JWT中的存储内容</a></li><li><a href="#43_JWT_689" rel="nofollow">4.3 解析JWT</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_726" rel="nofollow">学习总结</a></li><li><a href="#_728" rel="nofollow">感谢</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>前言</h2> 
<p>这里面的笔记都是我这里抄抄那里抄抄得来的，然后也经过了一些简单的测试，主要是用来拓宽知识面用的，毕竟到了项目开发中，不会裸用这些技术框架，通常都是采用第三方集成框架。<br> 另外需要说明的是，这里要介绍的<code>Spring Security OAuth2</code>框架应该有点过时了，在Spring官网已经没有了项目介绍，现在项目似乎已经升级，并且迁移为<code>Spring Authorization Server</code>项目。所以我打算学习完现在的OAuth2之后，继续学习<code>Spring Authorization Server</code>。</p> 
<h2><a id="_4"></a>阅读对象</h2> 
<ol><li>了解、熟悉Spring Security</li><li>有过OAuth2使用经验</li></ol> 
<h2><a id="_7"></a>阅读导航</h2> 
<p>系列上一篇文章：《<a href="https://blog.csdn.net/qq_32681589/article/details/135280088?spm=1001.2014.3001.5502">【分布式微服务专题】SpringSecurity快速入门</a>》</p> 
<h2><a id="_9"></a>前置知识</h2> 
<h2><a id="_10"></a>笔记正文</h2> 
<h3><a id="OAuth2__11"></a>一、OAuth2 介绍</h3> 
<blockquote> 
 <p>权威文档地址：<a href="https://www.rfc-editor.org/rfc/rfc6749.html" rel="nofollow">OAuth2.0协议介绍</a></p> 
</blockquote> 
<p>OAuth（Open Authorization，开放授权）是一个关于授权（authorization）的<mark>开放网络标准协议</mark>，允许用户授权第三方应用访问他们存储在另外的服务提供者上的信息，而不需要将用户名和密码提供给第三方移动应用或分享他们数据的所有内容。OAuth在全世界得到广泛应用，目前的版本是2.0版。</p> 
<blockquote> 
 <p><mark>注意：OAuth2只是一种标准协议，或者叫作：规范！ 其实在我们计算机学习中，你会发现很多各种各样的规范，这些规范往往指的是一种约定，并不特指某一具体的项目，SpringSecurityOAuth2才是一个具体的项目。可别被带偏了呀</mark></p> 
</blockquote> 
<p><strong>标准协议特点：</strong></p> 
<ul><li>简单：不管是OAuth服务提供者还是应用开发者，都很易于理解与使用</li><li>安全：没有涉及到用户密钥等信息，更安全更灵活</li><li>开放：任何服务提供商都可以实现OAuth，任何软件开发商都可以使用OAuth</li></ul> 
<h4><a id="11__23"></a>1.1 使用场景</h4> 
<ul><li>原生app授权：app登录请求后台接口，为了安全认证，所有请求都带token信息，如果登录验证、请求后台数据。</li><li>前后端分离单页面应用：前后端分离框架，前端请求后台数据，需要进行oauth2安全认证，比如使用vue、react或者h5开发的app</li><li>第三方应用授权登录，比如QQ，微博，微信的授权登录</li></ul> 
<p><strong>案例1：云快印</strong><br> 有一个【云快印】的网站，可以将用户存储在的百度网盘上的照片打印出来。用户为了使用该服务，必须让【云快印】读取自己储存在百度网盘上的照片。只有得到用户的授权，百度网盘才会同意【云快印】取这些照片。那么，【云快印】怎样获得用户的授权呢？<br> 传统方法是，用户将自己百度网盘的用户名和密码，告诉【云快印】，后者就可以读取用户的照片了。这样的做法有以下几个严重的缺点：</p> 
<ol><li>【云快印】为了后续的服务，会保存用户的密码，这样很不安全</li><li>百度网盘不得不部署密码登录，而我们知道，单纯的密码登录并不安全</li><li>【云快印】拥有了获取用户储存在百度网盘服务所有资料的权力，用户没法限制【云快印】获得授权的范围和有效期</li><li>用户只有修改密码，才能收回赋予【云快印】的权力。但是这样做，会使得其他所有获得用户授权的第三方应用程序全部失效</li><li>只要有一个第三方应用程序被破解，就会导致用户密码泄漏，以及所有被密码保护的数据泄漏。</li></ol> 
<p>综上缺陷，这显然不是我们期待的方案。</p> 
<p><strong>案例2：CSDN登录</strong><br> 附上一张常见的OAuth2场景：CSDN接入微信QQ开放平台，用户可以通过微信QQ登录CSDN<br> <img src="https://images2.imgbox.com/5b/ec/diZYkWoQ_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="font_colorred12_font_42"></a><font color="red">*1.2 基本概念（角色）</font></h4> 
<p><strong>角色：</strong></p> 
<ol><li><code>Third-party application</code>：第三方应用程序，又称【客户端client / 三方应用】，即例子中的【云快印】</li><li><code>HTTP service</code>：HTTP服务提供商，简称【服务提供商】，即例子中的百度网盘</li><li><code>Resource Owne</code>：资源所有者，又称【用户user】</li><li><code>User Agent</code>：用户代理，比如浏览器</li><li><code>Authorization server</code>：授权服务器，即服务提供商专门用来处理认证授权的服务器</li><li><code>Resource server</code>：资源服务器，即服务提供商存放用户生成的资源的服务器。它与授权服务器，可以是同一台服务器，也可以是不同的服务器。当然，想要访问资源，需要通过认证服务器由资源所有者授权才可以访问</li></ol> 
<p><strong>概念：</strong></p> 
<ol><li>授权许可 (Authorization Grant)：授权许可是资源所有者授权给客户端访问受保护资源的凭证。OAuth2定义了多种授权许可类型，如授权码、简化授权、密码授权和客户端凭证等</li><li>访问令牌 (Access Token)：访问令牌是由授权服务器颁发给客户端的凭证，表示客户端被授权访问受保护资源的权限。客户端使用访问令牌来请求资源服务器获取受保护资源</li><li>刷新令牌 (Refresh Token)：刷新令牌是可选的，用于在访问令牌过期后获取新的访问令牌。客户端可以使用刷新令牌向授权服务器请求刷新访问令牌，以延长访问权限的有效期</li></ol> 
<h4><a id="13__55"></a>1.3 优缺点</h4> 
<p>优点：</p> 
<ul><li>更安全，客户端不接触用户密码，服务器端更易集中保护</li><li>广泛传播并被持续采用</li><li>短寿命和封装的token</li><li>资源服务器和授权服务器解耦</li><li>集中式授权，简化客户端</li><li>HTTP/JSON友好，易于请求和传递token</li><li>考虑多种客户端架构场景</li><li>客户可以具有不同的信任级别</li></ul> 
<p>缺点：</p> 
<ul><li>协议框架太宽泛，造成各种实现的兼容性和互操作性差</li><li>不是一个认证协议，本身并不能告诉你任何用户信息</li></ul> 
<h3><a id="OAuth2_70"></a>二、OAuth2的设计思路</h3> 
<p>OAuth在【客户端】与【服务提供商】之间，设置了一个授权层（authorization layer）。【客户端】不能直接登录【服务提供商】，只能登录授权层，以此将用户与客户端区分开来。【客户端】登录授权层所用的令牌（token），与用户的密码不同。用户可以在登录的时候，指定授权层令牌的权限范围和有效期，【客户端】登录授权层以后，【服务提供商】根据令牌的权限范围和有效期，向【客户端】开放用户储存的资料。<br> <img src="https://images2.imgbox.com/5f/0a/qu7yhA3r_o.png" alt="在这里插入图片描述"><br> （1）用户打开客户端以后，客户端要求用户给予授权<br> （2）用户同意给予客户端授权<br> （3）客户端使用上一步获得的授权，向授权服务器申请令牌。<br> （4）授权服务器对客户端进行认证以后，确认无误，同意发放令牌<br> （5）客户端使用令牌，向资源服务器申请获取资源<br> （6）资源服务器确认令牌无误，同意向客户端开放资源</p> 
<blockquote> 
 <p>令牌（token）与密码（password）的作用是一样的，都可以进入系统，但是有三点差异<br> （1）令牌是短期的，到期会自动失效，用户自己无法修改。密码一般长期有效，用户不修改，就不会发生变化<br> （2）令牌可以被数据所有者撤销，会立即失效。密码一般不允许被他人撤销<br> （3）令牌有权限范围（scope）。对于网络服务来说，只读令牌就比读写令牌更安全。密码一般是完整权限<br> 上面这些设计，保证了令牌既可以让第三方应用获得权限，同时又随时可控，不会危及系统安全。这就是 OAuth 2.0 的优点</p> 
</blockquote> 
<h4><a id="21__86"></a>2.1 客户端授权模式</h4> 
<p>客户端必须得到用户的授权（authorization grant），才能获得令牌（access token）。OAuth 2.0 对于如何颁发令牌的细节，规定得非常详细。具体来说，一共分成四种授权类型（authorization grant），即四种颁发令牌的方式，适用于不同的互联网场景。它们分别是：</p> 
<ul><li>授权码模式（authorization code）</li><li>密码模式（resource owner password credentials）</li><li>简化（隐式）模式（implicit）</li><li>客户端模式（client credentials）</li></ul> 
<p>不过不管哪一种授权方式，它们的本质流程都是：三方客户端到服务提供商系统中备案，说明自己身份，然后拿到身份识别码【客户端id + 客户端密钥】。这是为了防止令牌被滥用，没有备案过的第三方应用，是不会拿到令牌的。</p> 
<h5><a id="210__95"></a>2.1.0 基本参数说明</h5> 
<p>在客户端授权中，我们通常需要用到以下参数：</p> 
<ul><li><code>client_id</code>：客户端应用的ID</li><li><code>client_secret</code>：客户端秘钥</li><li><code>response_type</code>：响应类型，可选的值有：<code>code</code>、<code>token</code>等</li><li><code>grant_type</code>：授权模式，可选的值有<code>authorization_code</code>、<code>password</code>、<code>client_credentials</code>等，对应的是不同的授权模式</li><li><code>scope</code>：授权范围</li><li><code>redirect_uri</code>：回调地址</li><li><code>username</code>：用户名称，通常是在密码模式下使用</li><li><code>password</code>：用户密码，通常是在密码模式下使用</li></ul> 
<h5><a id="211__106"></a>2.1.1 授权码模式</h5> 
<blockquote> 
 <p>目前主流的三方授权模式</p> 
</blockquote> 
<p>授权码（authorization code）方式，指的是第三方应用先申请一个授权码，然后再用该码获取令牌。</p> 
<p><strong>特点：</strong></p> 
<ul><li>安全性最高</li><li>适用于有后端的Web应用（前后分离）</li><li>授权码通过前端传送</li><li>令牌储存在后端（避免令牌泄露）</li><li>由后端与资源服务器通信</li></ul> 
<p><strong>一般性流程描述：</strong><br> （1）用户访问客户端，后者将前者导向授权服务器<br> （2）用户选择是否给予客户端授权<br> （3）假设用户给予授权，授权服务器将用户导向客户端事先指定的【重定向URI（redirection URI）】，同时附上一个授权码<br> （4）客户端收到授权码，附上早先的【重定向URI】，向授权服务器申请令牌。这一步是在客户端的后台的服务器上完成的，对用户不可见<br> （5）授权服务器核对了授权码和重定向URI，确认无误后，向客户端发送访问令牌（access token）和更新令牌（refresh token）</p> 
<p><strong>案例：</strong><br> 1） A网站提供一个链接，用户点击后就会跳转到 B 网站，授权用户数据给 A 网站使用。下面就是 A 网站跳转 B 网站的一个示意链接</p> 
<pre><code class="prism language-bash">https://b.com/oauth/authorize?
   <span class="token assign-left variable">response_type</span><span class="token operator">=</span>code<span class="token operator">&amp;</span>            <span class="token comment"># 表示授权类型，此处固定为code</span>
   <span class="token assign-left variable">client_id</span><span class="token operator">=</span>CLIENT_ID<span class="token operator">&amp;</span>           <span class="token comment"># 表示客户端的id，通常为必填</span>
   <span class="token assign-left variable">redirect_uri</span><span class="token operator">=</span>CALLBACK_URL<span class="token operator">&amp;</span>     <span class="token comment"># 表示重定向的uri。接受或拒绝请求后的跳转地址</span>
   <span class="token assign-left variable">scope</span><span class="token operator">=</span>read					  <span class="token comment"># 表示申请的权限范围（这里是只读）</span>
   <span class="token assign-left variable">state</span><span class="token operator">=</span>xxx					  <span class="token comment"># 示客户端的当前状态，可以指定任意值，授权服务器会原封不动地返回这个值</span>
</code></pre> 
<p>2）用户跳转后，B 网站会要求用户登录，然后询问是否同意给予 A 网站授权。用户表示同意，这时 B 网站就会跳回<code>redirect_uri</code>参数指定的网址。跳转时，会传回一个授权码，就像下面这样</p> 
<pre><code class="prism language-bash">https://a.com/callback?code<span class="token operator">=</span>AUTHORIZATION_CODE    <span class="token comment">#code参数就是授权码</span>
</code></pre> 
<p>3）A 网站拿到授权码以后，就可以在后端，向 B 网站请求令牌。 用户不可见，服务端行为</p> 
<pre><code class="prism language-bash">https://b.com/oauth/token?
  <span class="token assign-left variable">client_id</span><span class="token operator">=</span>CLIENT_ID<span class="token operator">&amp;</span>
  <span class="token assign-left variable">client_secret</span><span class="token operator">=</span>CLIENT_SECRET<span class="token operator">&amp;</span>      <span class="token comment"># client_id和client_secret用来让 B 确认 A 的身份,client_secret参数是保密的，因此只能在后端发请求</span>
  <span class="token assign-left variable">grant_type</span><span class="token operator">=</span>authorization_code<span class="token operator">&amp;</span>    <span class="token comment"># 采用的授权方式是授权码</span>
  <span class="token assign-left variable">code</span><span class="token operator">=</span>AUTHORIZATION_CODE<span class="token operator">&amp;</span>          <span class="token comment"># 上一步拿到的授权码</span>
  <span class="token assign-left variable">redirect_uri</span><span class="token operator">=</span>CALLBACK_URL			<span class="token comment"># 令牌颁发后的回调网址</span>
</code></pre> 
<p>4）B 网站收到请求以后，就会颁发令牌。具体做法是向<code>redirect_uri</code>指定的网址，发送一段<code>JSON</code>数据</p> 
<pre><code class="prism language-bash"><span class="token punctuation">{<!-- --></span>    
   <span class="token string">"access_token"</span><span class="token builtin class-name">:</span><span class="token string">"ACCESS_TOKEN"</span>,     <span class="token comment"># 令牌</span>
   <span class="token string">"token_type"</span><span class="token builtin class-name">:</span><span class="token string">"bearer"</span>,
   <span class="token string">"expires_in"</span>:2592000,
   <span class="token string">"refresh_token"</span><span class="token builtin class-name">:</span><span class="token string">"REFRESH_TOKEN"</span>,
   <span class="token string">"scope"</span><span class="token builtin class-name">:</span><span class="token string">"read"</span>,
   <span class="token string">"uid"</span>:100101,
   <span class="token string">"info"</span>:<span class="token punctuation">{<!-- --></span><span class="token punctuation">..</span>.<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="212__166"></a>2.1.2 简化（隐式）模式</h5> 
<p>有些 Web 应用是纯前端应用，没有后端。这时就不能用上面的方式了，必须将令牌储存在前端。RFC 6749 就规定了第二种方式，允许直接向前端颁发令牌，这种方式没有授权码这个中间步骤，所以称为【（授权码）隐式（implicit）】</p> 
<p><strong>特点：</strong></p> 
<ul><li>三方应用没有服务端</li><li>不需要授权码，直接颁发令牌给三方</li><li>不安全，适用于安全要求不高的场景</li><li>令牌时效短，通常是会话期内有效</li></ul> 
<p><strong>一般性流程描述：</strong><br> （1）用户访问客户端，后者将前者导向授权服务器<br> （2）用户选择是否给予客户端授权<br> （3）假设用户给予授权，授权服务器将用户导向客户端事先指定的【重定向URI（redirection URI）】，并在URI的Hash部分包含了访问令牌</p> 
<p><strong>案例：</strong><br> 1）A 网站提供一个链接，要求用户跳转到 B 网站，授权用户数据给 A 网站使用</p> 
<pre><code class="prism language-bash"> https://b.com/oauth/authorize?
   <span class="token assign-left variable">response_type</span><span class="token operator">=</span>token<span class="token operator">&amp;</span>          <span class="token comment"># response_type参数为token，表示要求直接返回令牌</span>
   <span class="token assign-left variable">client_id</span><span class="token operator">=</span>CLIENT_ID<span class="token operator">&amp;</span>
   <span class="token assign-left variable">redirect_uri</span><span class="token operator">=</span>CALLBACK_URL<span class="token operator">&amp;</span>
   <span class="token assign-left variable">scope</span><span class="token operator">=</span>read
</code></pre> 
<p>2）用户跳转到 B 网站，登录后同意给予 A 网站授权。这时，B 网站就会跳回<code>redirect_uri</code>参数指定的跳转网址，并且把令牌作为 URL 参数，传给 A 网站</p> 
<pre><code class="prism language-bash">https://a.com/callback<span class="token comment">#token=ACCESS_TOKEN     #token参数就是令牌，A 网站直接在前端拿到令牌</span>
</code></pre> 
<h5><a id="213__197"></a>2.1.3 密码模式</h5> 
<p>如果你高度信任某个应用，RFC 6749 也允许用户把用户名和密码，直接告诉该应用。该应用就使用你的密码，申请令牌，这种方式称为【密码式（password）】。<br> 在这种模式中，用户必须把自己的密码给客户端，但是客户端不得储存密码。这通常用在用户对客户端高度信任的情况下，比如客户端是操作系统的一部分，或者由一个著名公司出品。而授权服务器只有在其他授权模式无法执行的情况下，才能考虑使用这种模式。</p> 
<p><strong>特点：</strong></p> 
<ul><li>用户必须把自己的密码给客户端，但是客户端不得储存密码</li></ul> 
<p><strong>一般性流程描述：</strong><br> （1）用户向客户端提供用户名和密码<br> （2）客户端将用户名和密码发给授权服务器，向后者请求令牌<br> （3）授权服务器确认无误后，向客户端提供访问令牌</p> 
<p><strong>案例：</strong><br> 1）A 网站要求用户提供 B 网站的用户名和密码，拿到以后，A 就直接向 B 请求令牌。整个过程中，客户端不得保存用户的密码</p> 
<pre><code class="prism language-bash"> https://oauth.b.com/token?
   <span class="token assign-left variable">grant_type</span><span class="token operator">=</span>password<span class="token operator">&amp;</span>       <span class="token comment"># 授权方式是"密码式"</span>
   <span class="token assign-left variable">username</span><span class="token operator">=</span>USERNAME<span class="token operator">&amp;</span>
   <span class="token assign-left variable">password</span><span class="token operator">=</span>PASSWORD<span class="token operator">&amp;</span>
   <span class="token assign-left variable">client_id</span><span class="token operator">=</span>CLIENT_ID

</code></pre> 
<p>2）B 网站验证身份通过后，直接给出令牌。注意，这时不需要跳转，而是把令牌放在 JSON 数据里面，作为 HTTP 回应，A 因此拿到令牌</p> 
<h5><a id="214__223"></a>2.1.4 客户端模式</h5> 
<p>客户端模式（Client Credentials Grant）指客户端以自己的名义，而不是以用户的名义，向【服务提供商】请求授权。<br> 适用于没有前端的命令行应用，即在命令行下请求令牌。一般用来提供给我们完全信任的服务器端服务。</p> 
<p><strong>特点：</strong><br> <strong>一般性流程描述：</strong><br> （1）客户端向授权服务器进行身份认证，并要求一个访问令牌<br> （2）授权服务器确认无误后，向客户端提供访问令牌</p> 
<p><strong>案例：</strong><br> 1）A 应用在命令行向 B 发出请求</p> 
<pre><code class="prism language-bash"> https://oauth.b.com/token?
   <span class="token assign-left variable">grant_type</span><span class="token operator">=</span>client_credentials<span class="token operator">&amp;</span>
   <span class="token assign-left variable">client_id</span><span class="token operator">=</span>CLIENT_ID<span class="token operator">&amp;</span>
   <span class="token assign-left variable">client_secret</span><span class="token operator">=</span>CLIENT_SECRET
</code></pre> 
<p>2）B 网站验证通过以后，直接返回令牌</p> 
<h4><a id="22__243"></a>2.2 令牌的使用</h4> 
<p>A 网站拿到令牌以后，就可以向 B 网站的 API 请求数据了。这个时候，每次发送的请求，都会带上令牌，具体做法是，在头信息header中，加上一个<code>Authorization</code>字段，然后把令牌值设置在该字段中</p> 
<h4><a id="23__246"></a>2.3 令牌更新</h4> 
<p>令牌到期之后，正常来说是需要有自动刷新的逻辑的，不然每次到期让用户重新申请授权，未免显得太麻烦，而且也没必要。于是OAuth 2.0 允许用户自动更新令牌。<br> 具体方法是，B 网站颁发令牌的时候，一次性颁发两个令牌，一个用于获取数据，另一个用于获取新的令牌（refresh token 字段）。令牌到期前，用户使用 refresh token 发一个请求，去更新令牌。</p> 
<pre><code class="prism language-bash"> https://b.com/oauth/token?
   <span class="token assign-left variable">grant_type</span><span class="token operator">=</span>refresh_token<span class="token operator">&amp;</span>    <span class="token comment"># grant_type参数为refresh_token表示要求更新令牌</span>
   <span class="token assign-left variable">client_id</span><span class="token operator">=</span>CLIENT_ID<span class="token operator">&amp;</span>
   <span class="token assign-left variable">client_secret</span><span class="token operator">=</span>CLIENT_SECRET<span class="token operator">&amp;</span>
   <span class="token assign-left variable">refresh_token</span><span class="token operator">=</span>REFRESH_TOKEN    <span class="token comment"># 用于更新令牌的令牌</span>
</code></pre> 
<h3><a id="Spring_Security_OAuth2_258"></a>三、Spring Security OAuth2快速开始</h3> 
<p>首先，为了帮助更好的理解当前正在做什么，先再次声明以下内容：</p> 
<ul><li>Spring Security是Spring提供的一个身份验证和访问控制<mark>框架</mark>，是一个具体的项目</li><li>OAuth是一个标准协议，是一种约定，不特指某一个具体的项目</li><li>Spring Security OAuth2是实现了OAuth2标准协议的Spring Security框架，是一个具体的项目</li></ul> 
<p>我在前面大概介绍过SpringSecurity了，这边就不再赘述了。但首先我们得再次声明一点：SpringSecurity主要实现了【认证】和【访问控制】。<br> 正常在我们的企业应用中，需要结合SpringSecurity与OAuth2，这样才算是得到一套完整的解决方案。我们可以通过Spring Security + OAuth2构建一个授权服务器来验证用户身份以提供access_token，并使用这个access_token来从资源服务器请求数据。</p> 
<h4><a id="31__267"></a>3.1 授权服务器的几个节点</h4> 
<p><img src="https://images2.imgbox.com/1f/12/w4Pb9lCd_o.png" alt="在这里插入图片描述"><br> 上面是一个典型授权服务器的节点图。它们分别有如下作用：</p> 
<ul><li>Authorize Endpoint ：授权端点，进行授权</li><li>Token Endpoint ：令牌端点，经过授权拿到对应的Token</li><li>Introspection Endpoint ：校验端点，校验Token的合法性</li><li>Revocation Endpoint ：撤销端点，撤销授权</li></ul> 
<h4><a id="32__275"></a>3.2 整体架构（授权码模式）</h4> 
<p><img src="https://images2.imgbox.com/02/2f/R5Ot7G6r_o.png" alt="在这里插入图片描述"><br> <strong>上图的流程：</strong></p> 
<ol><li>用户访问资源，此时没有Token。Oauth2RestTemplate会报错，这个报错信息会被Oauth2ClientContextFilter捕获并重定向到授权服务器</li><li>授权服务器通过Authorization Endpoint进行授权，并通过AuthorizationServerTokenServices生成【授权码】并返回给客户端</li><li>客户端拿到授权码去授权服务器通过Token Endpoint调用AuthorizationServerTokenServices生成Token并返回给客户端</li><li>客户端拿到Token去资源服务器访问资源，一般会通过Oauth2AuthenticationManager调用ResourceServerTokenServices进行校验。校验通过可以获取资源</li></ol> 
<h4><a id="33__283"></a>3.3 代码整合（授权码模式）</h4> 
<p>1）引入依赖</p> 
<pre><code class="prism language-xml">    <span class="token comment">&lt;!-- 接入spring security--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework.security.oauth/spring-security-oauth2 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.security.oauth<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-security-oauth2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.5.2.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>2）配置 spring security</p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        http<span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/oauth/**"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>3）配置授权服务器</p> 
<pre><code class="prism language-bash">public class AuthorizationServerConfig extends AuthorizationServerConfigurerAdapter <span class="token punctuation">{<!-- --></span>

    @Autowired
    private PasswordEncoder passwordEncoder<span class="token punctuation">;</span>

    @Override
    public void configure<span class="token punctuation">(</span>ClientDetailsServiceConfigurer clients<span class="token punctuation">)</span> throws Exception <span class="token punctuation">{<!-- --></span>

        clients.inMemory<span class="token punctuation">(</span><span class="token punctuation">)</span>
                // 配置client_id
                .withClient<span class="token punctuation">(</span><span class="token string">"client"</span><span class="token punctuation">)</span>
                // 配置client-secret
                .secret<span class="token punctuation">(</span>passwordEncoder.encode<span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">))</span>
                // 配置访问token的有效期
                .accessTokenValiditySeconds<span class="token punctuation">(</span><span class="token number">3600</span><span class="token punctuation">)</span>
                // 配置刷新token的有效期
                .refreshTokenValiditySeconds<span class="token punctuation">(</span><span class="token number">864000</span><span class="token punctuation">)</span>
                // 配置redirect_uri，用于授权成功后跳转
                .redirectUris<span class="token punctuation">(</span><span class="token string">"http://www.baidu.com"</span><span class="token punctuation">)</span>
                // 配置申请的权限范围
                .scopes<span class="token punctuation">(</span><span class="token string">"all"</span><span class="token punctuation">)</span>
                // 配置grant_type，表示授权类型
                .authorizedGrantTypes<span class="token punctuation">(</span><span class="token string">"authorization_code"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>4）配置资源服务器</p> 
<pre><code class="prism language-bash">@Configuration
@EnableResourceServer
public class ResourceServiceConfig extends ResourceServerConfigurerAdapter <span class="token punctuation">{<!-- --></span>

    @Override
    public void configure<span class="token punctuation">(</span>HttpSecurity http<span class="token punctuation">)</span> throws Exception <span class="token punctuation">{<!-- --></span>
        http.authorizeRequests<span class="token punctuation">(</span><span class="token punctuation">)</span>
        .anyRequest<span class="token punctuation">(</span><span class="token punctuation">)</span>.authenticated<span class="token punctuation">(</span><span class="token punctuation">)</span>
        .and<span class="token punctuation">(</span><span class="token punctuation">)</span>.requestMatchers<span class="token punctuation">(</span><span class="token punctuation">)</span>.antMatchers<span class="token punctuation">(</span><span class="token string">"/user/**"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>5）测试，获取授权码<br> 输入：<a href="" rel="nofollow">http://localhost:8081/oauth/authorize?response_type=code&amp;client_id=client&amp;redirect_uri=http://www.baidu.com&amp;scope=all</a><br> 接着会进入这个页面：<br> <img src="https://images2.imgbox.com/b8/65/tjFTHjwy_o.png" alt="在这里插入图片描述"><br> 登录之后选择<code>Approve</code><br> <img src="https://images2.imgbox.com/6c/0b/rtENZuBH_o.png" alt="在这里插入图片描述"><br> 接着就会在地址栏显示如下：<br> <img src="https://images2.imgbox.com/67/98/OYCegPAv_o.png" alt="在这里插入图片描述"><br> 上面的<code>code</code>即为我们的【授权码】</p> 
<p>6）根据授权码获取令牌<br> 下面需要使用<code>Apifox</code>来构建一个post请求，去授权服务器中获取令牌了<br> <img src="https://images2.imgbox.com/b8/4d/UlgopdHP_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/f8/ee/CmKLd2LH_o.png" alt="在这里插入图片描述"><br> 7）请求令牌，得到如下数据：<br> <img src="https://images2.imgbox.com/8a/6a/W9NjVoet_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="34__387"></a>3.4 更新令牌</h4> 
<p>使用oauth2时，如果令牌失效了，可以使用刷新令牌通过refresh_token的授权模式再次获取access_token。只需修改认证服务器的配置，添加refresh_token的授权模式即可。<br> 1）修改授权服务器<code>AuthorizationServerConfig</code>配置，增加refresh_token配置</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableAuthorizationServer</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizationServerConfig</span> <span class="token keyword">extends</span> <span class="token class-name">AuthorizationServerConfigurerAdapter</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">PasswordEncoder</span> passwordEncoder<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ShenUserService</span> userService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">AuthenticationManager</span> authenticationManagerBean<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationServerEndpointsConfigurer</span> endpoints<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        endpoints<span class="token punctuation">.</span><span class="token function">authenticationManager</span><span class="token punctuation">(</span>authenticationManagerBean<span class="token punctuation">)</span> <span class="token comment">//使用密码模式需要配置</span>
                <span class="token comment">// .tokenStore(tokenStore)  //指定token存储到redis</span>
                <span class="token punctuation">.</span><span class="token function">reuseRefreshTokens</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>  <span class="token comment">//refresh_token是否重复使用</span>
                <span class="token punctuation">.</span><span class="token function">userDetailsService</span><span class="token punctuation">(</span>userService<span class="token punctuation">)</span> <span class="token comment">//刷新令牌授权包含对用户信息的检查</span>
                <span class="token punctuation">.</span><span class="token function">allowedTokenEndpointRequestMethods</span><span class="token punctuation">(</span><span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">,</span><span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//支持GET,POST请求</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">ClientDetailsServiceConfigurer</span> clients<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>

        clients<span class="token punctuation">.</span><span class="token function">inMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">// 配置client_id</span>
                <span class="token punctuation">.</span><span class="token function">withClient</span><span class="token punctuation">(</span><span class="token string">"client"</span><span class="token punctuation">)</span>
                <span class="token comment">// 配置client-secret</span>
                <span class="token punctuation">.</span><span class="token function">secret</span><span class="token punctuation">(</span>passwordEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">// 配置访问token的有效期</span>
                <span class="token punctuation">.</span><span class="token function">accessTokenValiditySeconds</span><span class="token punctuation">(</span><span class="token number">3600</span><span class="token punctuation">)</span>
                <span class="token comment">// 配置刷新token的有效期</span>
                <span class="token punctuation">.</span><span class="token function">refreshTokenValiditySeconds</span><span class="token punctuation">(</span><span class="token number">864000</span><span class="token punctuation">)</span>
                <span class="token comment">// 配置redirect_uri，用于授权成功后跳转</span>
                <span class="token punctuation">.</span><span class="token function">redirectUris</span><span class="token punctuation">(</span><span class="token string">"http://www.baidu.com"</span><span class="token punctuation">)</span>
                <span class="token comment">// 配置申请的权限范围</span>
                <span class="token punctuation">.</span><span class="token function">scopes</span><span class="token punctuation">(</span><span class="token string">"all"</span><span class="token punctuation">)</span>
                <span class="token comment">// 配置grant_type，表示授权类型</span>
                <span class="token punctuation">.</span><span class="token function">authorizedGrantTypes</span><span class="token punctuation">(</span><span class="token string">"authorization_code"</span><span class="token punctuation">,</span> <span class="token string">"implicit"</span><span class="token punctuation">,</span> <span class="token string">"refresh_token"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>测试获取token，得到如下结果：<br> <img src="https://images2.imgbox.com/47/0f/wJx2vV51_o.png" alt="在这里插入图片描述"><br> 相比之前的，多了一个<code>refresh_token</code></p> 
<h4><a id="35_redisToken_439"></a>3.5 基于redis存储Token</h4> 
<p>我们生成的token可以存储在很多地方，比较常用的一种方式是存储到redis中。只需要3步即可</p> 
<p>1）引入依赖</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-pool2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>2）修改application.yml</p> 
<pre><code class="prism language-yml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 127.0.0.1
    <span class="token key atrule">database</span><span class="token punctuation">:</span> <span class="token number">0</span>
</code></pre> 
<p>3）编写redis配置类，声明<code>TokenStore</code> Bean</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisConfig</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisConnectionFactory</span> redisConnectionFactory<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">TokenStore</span> <span class="token function">tokenStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RedisTokenStore</span><span class="token punctuation">(</span>redisConnectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>4）在授权服务器<code>AuthorizationServerConfig</code>配置中指定令牌的存储策略为Redis</p> 
<pre><code class="prism language-java">   <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationServerEndpointsConfigurer</span> endpoints<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        endpoints<span class="token punctuation">.</span><span class="token function">authenticationManager</span><span class="token punctuation">(</span>authenticationManagerBean<span class="token punctuation">)</span> <span class="token comment">//使用密码模式需要配置</span>
                <span class="token punctuation">.</span><span class="token function">tokenStore</span><span class="token punctuation">(</span>tokenStore<span class="token punctuation">)</span>  <span class="token comment">//指定token存储到redis</span>
                <span class="token punctuation">.</span><span class="token function">reuseRefreshTokens</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>  <span class="token comment">//refresh_token是否重复使用</span>
                <span class="token punctuation">.</span><span class="token function">userDetailsService</span><span class="token punctuation">(</span>userService<span class="token punctuation">)</span> <span class="token comment">//刷新令牌授权包含对用户信息的检查</span>
                <span class="token punctuation">.</span><span class="token function">allowedTokenEndpointRequestMethods</span><span class="token punctuation">(</span><span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">,</span><span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//支持GET,POST请求</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="Spring_Security_Oauth2JWT_490"></a>四、Spring Security Oauth2整合JWT</h3> 
<p>我在前一篇笔记里面已经简单介绍过JWT了，感兴趣的朋友可以看看我上一篇文章，链接在最前面的【阅读导航】中有介绍。下面开始介绍整合步骤</p> 
<h4><a id="41_JWT_493"></a>4.1 整合JWT</h4> 
<p>1）引入依赖</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-security-jwt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0.9.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>2）添加配置文件JwtTokenStoreConfig.java</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtTokenStoreConfig</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">TokenStore</span> <span class="token function">jwtTokenStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JwtTokenStore</span><span class="token punctuation">(</span><span class="token function">jwtAccessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">JwtAccessTokenConverter</span> <span class="token function">jwtAccessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">JwtAccessTokenConverter</span> accessTokenConverter <span class="token operator">=</span> <span class="token keyword">new</span>
                <span class="token class-name">JwtAccessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 配置JWT使用的秘钥</span>
        accessTokenConverter<span class="token punctuation">.</span><span class="token function">setSigningKey</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> accessTokenConverter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>3）在授权服务器<code>AuthorizationServerConfig</code>配置中指定令牌的存储策略为JWT</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableAuthorizationServer</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizationServerConfig</span> <span class="token keyword">extends</span> <span class="token class-name">AuthorizationServerConfigurerAdapter</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">PasswordEncoder</span> passwordEncoder<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ShenUserService</span> userService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">AuthenticationManager</span> authenticationManagerBean<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">TokenStore</span> tokenStore<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">JwtAccessTokenConverter</span> jwtAccessTokenConverter<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationServerEndpointsConfigurer</span> endpoints<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        endpoints<span class="token punctuation">.</span><span class="token function">authenticationManager</span><span class="token punctuation">(</span>authenticationManagerBean<span class="token punctuation">)</span> <span class="token comment">// 使用密码模式需要配置</span>
                <span class="token punctuation">.</span><span class="token function">tokenStore</span><span class="token punctuation">(</span>tokenStore<span class="token punctuation">)</span>  <span class="token comment">// 指定token存储到redis</span>
                <span class="token punctuation">.</span><span class="token function">accessTokenConverter</span><span class="token punctuation">(</span>jwtAccessTokenConverter<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">reuseRefreshTokens</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>  <span class="token comment">// refresh_token是否重复使用</span>
                <span class="token punctuation">.</span><span class="token function">userDetailsService</span><span class="token punctuation">(</span>userService<span class="token punctuation">)</span> <span class="token comment">// 刷新令牌授权包含对用户信息的检查</span>
                <span class="token punctuation">.</span><span class="token function">allowedTokenEndpointRequestMethods</span><span class="token punctuation">(</span><span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">,</span> <span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 支持GET,POST请求</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">ClientDetailsServiceConfigurer</span> clients<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>

        clients<span class="token punctuation">.</span><span class="token function">inMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">// 配置client_id</span>
                <span class="token punctuation">.</span><span class="token function">withClient</span><span class="token punctuation">(</span><span class="token string">"client"</span><span class="token punctuation">)</span>
                <span class="token comment">// 配置client-secret</span>
                <span class="token punctuation">.</span><span class="token function">secret</span><span class="token punctuation">(</span>passwordEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">// 配置访问token的有效期</span>
                <span class="token punctuation">.</span><span class="token function">accessTokenValiditySeconds</span><span class="token punctuation">(</span><span class="token number">3600</span><span class="token punctuation">)</span>
                <span class="token comment">// 配置刷新token的有效期</span>
                <span class="token punctuation">.</span><span class="token function">refreshTokenValiditySeconds</span><span class="token punctuation">(</span><span class="token number">864000</span><span class="token punctuation">)</span>
                <span class="token comment">// 配置redirect_uri，用于授权成功后跳转</span>
                <span class="token punctuation">.</span><span class="token function">redirectUris</span><span class="token punctuation">(</span><span class="token string">"http://www.baidu.com"</span><span class="token punctuation">)</span>
                <span class="token comment">// 配置申请的权限范围</span>
                <span class="token punctuation">.</span><span class="token function">scopes</span><span class="token punctuation">(</span><span class="token string">"all"</span><span class="token punctuation">)</span>
                <span class="token comment">// 配置grant_type，表示授权类型</span>
                <span class="token punctuation">.</span><span class="token function">authorizedGrantTypes</span><span class="token punctuation">(</span><span class="token string">"authorization_code"</span><span class="token punctuation">,</span> <span class="token string">"implicit"</span><span class="token punctuation">,</span> <span class="token string">"refresh_token"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>4）接着还是按照上面的测试步骤走一遍，得到以下结果，令牌变成了JWT格式<br> <img src="https://images2.imgbox.com/6d/12/LQRVPfxf_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="42_JWT_583"></a>4.2 扩展JWT中的存储内容</h4> 
<p>有时候我们需要扩展JWT中存储的内容，这里我们在JWT中扩展一个 key为enhance，value为enhance info 的数据。<br> 继承TokenEnhancer实现一个JWT内容增强器</p> 
<p>1）新增<code>JwtTokenEnhancer </code>，增强内容：<code>("enhance", "enhance info")</code></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtTokenEnhancer</span> <span class="token keyword">implements</span> <span class="token class-name">TokenEnhancer</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">OAuth2AccessToken</span> <span class="token function">enhance</span><span class="token punctuation">(</span><span class="token class-name">OAuth2AccessToken</span> accessToken<span class="token punctuation">,</span>
                                     <span class="token class-name">OAuth2Authentication</span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> info <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        info<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"enhance"</span><span class="token punctuation">,</span> <span class="token string">"enhance info"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">DefaultOAuth2AccessToken</span><span class="token punctuation">)</span> accessToken<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAdditionalInformation</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> accessToken<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>2）在授权服务器<code>AuthorizationServerConfig</code>配置中配置JWT的内容增强器</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableAuthorizationServer</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizationServerConfig</span> <span class="token keyword">extends</span> <span class="token class-name">AuthorizationServerConfigurerAdapter</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">PasswordEncoder</span> passwordEncoder<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ShenUserService</span> userService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">AuthenticationManager</span> authenticationManagerBean<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">TokenStore</span> tokenStore<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">JwtAccessTokenConverter</span> jwtAccessTokenConverter<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">JwtTokenEnhancer</span> jwtTokenEnhancer<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationServerEndpointsConfigurer</span> endpoints<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>

        <span class="token comment">//配置JWT的内容增强器</span>
        <span class="token class-name">TokenEnhancerChain</span> enhancerChain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TokenEnhancerChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TokenEnhancer</span><span class="token punctuation">&gt;</span></span> delegates <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        delegates<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>jwtTokenEnhancer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        delegates<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>jwtAccessTokenConverter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        enhancerChain<span class="token punctuation">.</span><span class="token function">setTokenEnhancers</span><span class="token punctuation">(</span>delegates<span class="token punctuation">)</span><span class="token punctuation">;</span>

        endpoints<span class="token punctuation">.</span><span class="token function">authenticationManager</span><span class="token punctuation">(</span>authenticationManagerBean<span class="token punctuation">)</span> <span class="token comment">// 使用密码模式需要配置</span>
                <span class="token punctuation">.</span><span class="token function">tokenStore</span><span class="token punctuation">(</span>tokenStore<span class="token punctuation">)</span>  <span class="token comment">// 指定token存储到redis</span>
                <span class="token punctuation">.</span><span class="token function">accessTokenConverter</span><span class="token punctuation">(</span>jwtAccessTokenConverter<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">tokenEnhancer</span><span class="token punctuation">(</span>enhancerChain<span class="token punctuation">)</span> <span class="token comment">//配置tokenEnhancer</span>
                <span class="token punctuation">.</span><span class="token function">reuseRefreshTokens</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>  <span class="token comment">// refresh_token是否重复使用</span>
                <span class="token punctuation">.</span><span class="token function">userDetailsService</span><span class="token punctuation">(</span>userService<span class="token punctuation">)</span> <span class="token comment">// 刷新令牌授权包含对用户信息的检查</span>
                <span class="token punctuation">.</span><span class="token function">allowedTokenEndpointRequestMethods</span><span class="token punctuation">(</span><span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">,</span> <span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 支持GET,POST请求</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">ClientDetailsServiceConfigurer</span> clients<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>

        clients<span class="token punctuation">.</span><span class="token function">inMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">// 配置client_id</span>
                <span class="token punctuation">.</span><span class="token function">withClient</span><span class="token punctuation">(</span><span class="token string">"client"</span><span class="token punctuation">)</span>
                <span class="token comment">// 配置client-secret</span>
                <span class="token punctuation">.</span><span class="token function">secret</span><span class="token punctuation">(</span>passwordEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">// 配置访问token的有效期</span>
                <span class="token punctuation">.</span><span class="token function">accessTokenValiditySeconds</span><span class="token punctuation">(</span><span class="token number">3600</span><span class="token punctuation">)</span>
                <span class="token comment">// 配置刷新token的有效期</span>
                <span class="token punctuation">.</span><span class="token function">refreshTokenValiditySeconds</span><span class="token punctuation">(</span><span class="token number">864000</span><span class="token punctuation">)</span>
                <span class="token comment">// 配置redirect_uri，用于授权成功后跳转</span>
                <span class="token punctuation">.</span><span class="token function">redirectUris</span><span class="token punctuation">(</span><span class="token string">"http://www.baidu.com"</span><span class="token punctuation">)</span>
                <span class="token comment">// 配置申请的权限范围</span>
                <span class="token punctuation">.</span><span class="token function">scopes</span><span class="token punctuation">(</span><span class="token string">"all"</span><span class="token punctuation">)</span>
                <span class="token comment">// 配置grant_type，表示授权类型</span>
                <span class="token punctuation">.</span><span class="token function">authorizedGrantTypes</span><span class="token punctuation">(</span><span class="token string">"authorization_code"</span><span class="token punctuation">,</span> <span class="token string">"implicit"</span><span class="token punctuation">,</span> <span class="token string">"refresh_token"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>3）测试，获取令牌<br> 4）对获取到的令牌，解密之后得到</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"user_name"</span><span class="token operator">:</span> <span class="token string">"Nico"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"scope"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"all"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string-property property">"exp"</span><span class="token operator">:</span> <span class="token number">1704786179</span><span class="token punctuation">,</span>
    <span class="token string-property property">"authorities"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"admin"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string-property property">"jti"</span><span class="token operator">:</span> <span class="token string">"2DyqZildiHtLr7tojfDOwGqjnLE"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"client_id"</span><span class="token operator">:</span> <span class="token string">"client"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"enhance"</span><span class="token operator">:</span> <span class="token string">"enhance info"</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>可以看见，在<code>Payload</code>中得到了被加强的内容</p> 
<h4><a id="43_JWT_689"></a>4.3 解析JWT</h4> 
<p>1）添加依赖</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!--JWT依赖--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.jsonwebtoken<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jjwt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.9.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>2）修改UserController类，使用jjwt工具类来解析Authorization头中存储的JWT内容</p> 
<pre><code class="prism language-java">
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/getCurrentUser"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getCurrentUser</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">,</span>
                                 <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> header <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"Authorization"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>header<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            token <span class="token operator">=</span> header<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"bearer"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            token <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"access_token"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setSigningKey</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">parseClaimsJws</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>3）测试，不过这一次我们需要将得到的令牌放在header的<code>Authorization</code>中了，因为我们的逻辑是这么写的<br> 接着访问上面的<code>getCurrentUser</code>接口，即会得到如下结果：<br> <img src="https://images2.imgbox.com/b4/db/JE6nNCtt_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_726"></a>学习总结</h2> 
<ol><li>稍微学习了OAuth2的一些内容，只不过还是有一些疑惑的点</li></ol> 
<h2><a id="_728"></a>感谢</h2> 
<ol><li>感谢站内大佬【作者：歪桃】的文章《<a href="https://blog.csdn.net/m0_37892044/article/details/116599077">Spring Security oauth2（一）快速入门，搭建授权服务器</a>》</li><li>感谢大佬【作者：阮一峰】的文章《<a href="https://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html" rel="nofollow">理解OAuth 2.0</a>》</li></ol>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ea1f22e39cba410e66ef0627f0bc67a6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">团结引擎 | 发布微信小游戏的那些坑</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/96e11ecc321f96c73b275c4f868c87fd/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">redis详解</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>