<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>vue中eventbus被多次触发（vue中使用eventbus踩过的坑） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="vue中eventbus被多次触发（vue中使用eventbus踩过的坑）" />
<meta property="og:description" content="一开始的需求是这样子的，我为了实现两个页面组件之间的数据传递，假设我有页面A，点击页面A上的某一个按钮之后，页面会自动跳转到页面B，同时我希望将页面A上的某一些参数携带过去给页面B。（我知道，小参数的时候可以通过路由的params或者query去传参数，或者大型数据可以用vuex来处理，很遗憾我到现在还没有做很大型的项目，所以还没有用过vuex，接下来会学习一下。）
然后我就想，这不就是不同组件之间的数据传递问题而已吗？直接用bus 巴士事件来传递数据不就行了吗。于是，我就很愉快地进行了。关于vue中的eventbus的使用，我之前在一篇vue中的数据传递中有提到过… 先给你们看一下我一开始的代码：
实现目标： 点击之后，bus emit事件，然后顺便跳转路由到/moneyRecord页面。 接下来就是在MoneyRecord页面中去on接收这个事件，然后接受参数。 // 这是页面A的内部触发bus事件的代码 editList (index, date, item) { // 点击进入编辑的页面，需要传递的参数比较多。 console.log(index, date, item) bus.$emit(&#39;get&#39;, { item: item.type, date: date }) this.$router.replace({path: &#39;/moneyRecord&#39;}) } // moneyRecord页面 created () { //这里我将icon的list给保存下来了 bus.$on(&#39;get&#39;, this.myhandle) }, methods: { myhandle (val) { console.log(val, &#39;这是从上个页面传递过来的参数&#39;) } } 就当我欣喜若狂的时候，觉得自己只要在页面A触发了get事件，页面B中就会理所当然的接受了数据。然而，结果却不如人意，看一下下面的动图。 主要是看这是从上个页面传来的数据这一行数据的输出次数情况来判断事件触发次数 不知道你有没有发现，就是我第一次进去list页面的时候，我随便点击一下list下的任何一个item，控制台没有输出。但是当我第二次再点击触发事件的时候，就会输出一个测试数据。再一次进去点击，就输出两个数据。。。依次增加了。（控制台上那个“这是从上个页面传来的数据”就是测试数据） 问题：
问题1： 为什么第一次触发的时候页面B中的on事件没有被触发? 问题2： 为什么后面再一次依次去触发的时候会出现，每一次都会发现好像之前的on事件分发都没有被撤销一样，导致每一次的事件触发执行越来越多? 解决：
针对问题1
这个还得从vue的生命周期说起了，我先进行了测试，就是当从页面组件A跳转到页面组件B的时候，两个组件的生命周期分别是怎么样的，关于vue的生命周期具体每一个时期做什么事情我就不再赘述了，下面po一张vue生命周期的图。 我自己做了实验来验证，这个页面跳转过程中，这两个组件的生命周期的执行情况。
// 我分别在页面A和页面B中去添加以下代码： beforeCreate () { console.group(&#39;%c%s&#39;, &#39;color:red&#39;, &#39;beforeCreate 创建前状态===============组件2》&#39;) }, created () { console." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/354455688a89aba7ae2d90a2a1b525e6/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-12-14T17:11:14+08:00" />
<meta property="article:modified_time" content="2020-12-14T17:11:14+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">vue中eventbus被多次触发（vue中使用eventbus踩过的坑）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p><font color="#764ba2">一开始的需求是这样子的，我为了实现两个页面组件之间的数据传递，假设我有页面A，点击页面A上的某一个按钮之后，页面会自动跳转到页面B，同时我希望将页面A上的某一些参数携带过去给页面B。（我知道，小参数的时候可以通过路由的params或者query去传参数，或者大型数据可以用vuex来处理，很遗憾我到现在还没有做很大型的项目，所以还没有用过vuex，接下来会学习一下。）</font></p> 
</blockquote> 
<h6><a id="bus_vueeventbusvue_2"></a>然后我就想，这不就是不同组件之间的数据传递问题而已吗？直接用bus 巴士事件来传递数据不就行了吗。于是，我就很愉快地进行了。关于vue中的eventbus的使用，我之前在一篇vue中的数据传递中有提到过…</h6> 
<p>先给你们看一下我一开始的代码：</p> 
<pre><code class="prism language-javascript">实现目标： 
点击之后，bus emit事件，然后顺便跳转路由到<span class="token operator">/</span>moneyRecord页面。
接下来就是在MoneyRecord页面中去on接收这个事件，然后接受参数。
<span class="token comment">// 这是页面A的内部触发bus事件的代码</span>
<span class="token function">editList</span> <span class="token punctuation">(</span>index<span class="token punctuation">,</span> date<span class="token punctuation">,</span> item<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 点击进入编辑的页面，需要传递的参数比较多。</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> date<span class="token punctuation">,</span> item<span class="token punctuation">)</span>
  bus<span class="token punctuation">.</span><span class="token function">$emit</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
    item<span class="token punctuation">:</span> item<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
    date<span class="token punctuation">:</span> date
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>$router<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>path<span class="token punctuation">:</span> <span class="token string">'/moneyRecord'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// moneyRecord页面</span>
<span class="token function">created</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">//这里我将icon的list给保存下来了</span>
  bus<span class="token punctuation">.</span><span class="token function">$on</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>myhandle<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
methods<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">myhandle</span> <span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token string">'这是从上个页面传递过来的参数'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="AgetB_31"></a>就当我欣喜若狂的时候，觉得自己只要在页面A触发了get事件，页面B中就会理所当然的接受了数据。然而，结果却不如人意，看一下下面的动图。</h6> 
<h6><a id="_33"></a>主要是看这是从上个页面传来的数据这一行数据的输出次数情况来判断事件触发次数</h6> 
<p><img src="https://images2.imgbox.com/2e/a1/mF3bQK8w_o.gif" alt="在这里插入图片描述"></p> 
<h6><a id="listlistitem_36"></a>不知道你有没有发现，就是我第一次进去list页面的时候，我随便点击一下list下的任何一个item，控制台没有输出。但是当我第二次再点击触发事件的时候，就会输出一个测试数据。再一次进去点击，就输出两个数据。。。依次增加了。（控制台上那个“这是从上个页面传来的数据”就是测试数据）</h6> 
<p><font color="#66a6ff"><strong>问题：</strong></font></p> 
<ul><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled> 问题1： 为什么第一次触发的时候页面B中的on事件没有被触发?</li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled> 问题2： 为什么后面再一次依次去触发的时候会出现，每一次都会发现好像之前的on事件分发都没有被撤销一样，导致每一次的事件触发执行越来越多?</li></ul> 
<p><font color="#66a6ff"><strong>解决：</strong></font></p> 
<ul><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" checked disabled> 针对问题1<br> 这个还得从vue的生命周期说起了，我先进行了测试，就是当从页面组件A跳转到页面组件B的时候，两个组件的生命周期分别是怎么样的，关于vue的生命周期具体每一个时期做什么事情我就不再赘述了，下面po一张vue生命周期的图。</li></ul> 
<p><img src="https://images2.imgbox.com/e1/18/sd1YjLEu_o.png" alt="在这里插入图片描述"></p> 
<p>我自己做了实验来验证，这个页面跳转过程中，这两个组件的生命周期的执行情况。</p> 
<pre><code class="prism language-cpp"><span class="token comment">// 我分别在页面A和页面B中去添加以下代码：</span>
beforeCreate <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   console<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token string">'%c%s'</span><span class="token punctuation">,</span> <span class="token string">'color:red'</span><span class="token punctuation">,</span> <span class="token string">'beforeCreate 创建前状态===============组件2》'</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span><span class="token punctuation">,</span>
 created <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   console<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token string">'%c%s'</span><span class="token punctuation">,</span> <span class="token string">'color:red'</span><span class="token punctuation">,</span> <span class="token string">'created 创建完毕状态===============组件2》'</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span><span class="token punctuation">,</span>
 beforeMount <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   console<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token string">'%c%s'</span><span class="token punctuation">,</span> <span class="token string">'color:red'</span><span class="token punctuation">,</span> <span class="token string">'beforeMount 挂载前状态===============组件2》'</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span><span class="token punctuation">,</span>
 mounted <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   console<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token string">'%c%s'</span><span class="token punctuation">,</span> <span class="token string">'color:red'</span><span class="token punctuation">,</span> <span class="token string">'mounted 挂载状态===============组件2》'</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span><span class="token punctuation">,</span>
 beforeUpdate <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   console<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token string">'%c%s'</span><span class="token punctuation">,</span> <span class="token string">'color:red'</span><span class="token punctuation">,</span> <span class="token string">'beforeUpdate 更新前状态===============组件2》'</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span><span class="token punctuation">,</span>
 updated <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   console<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token string">'%c%s'</span><span class="token punctuation">,</span> <span class="token string">'color:red'</span><span class="token punctuation">,</span> <span class="token string">'updated 更新状态===============组件2》'</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span><span class="token punctuation">,</span>
 beforeDestroy <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   console<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token string">'%c%s'</span><span class="token punctuation">,</span> <span class="token string">'color:red'</span><span class="token punctuation">,</span> <span class="token string">'beforeDestroy 破前状态===============组件2》'</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span><span class="token punctuation">,</span>
 destroyed <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   console<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token string">'%c%s'</span><span class="token punctuation">,</span> <span class="token string">'color:red'</span><span class="token punctuation">,</span> <span class="token string">'destroyed 破坏状态===============组件2》'</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
<span class="token comment">// 另外一个组件的我就不放出来了</span>
</code></pre> 
<p>测试结果图：<br> <img src="https://images2.imgbox.com/18/49/mbixe6oL_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/25/08/dIQV3lXp_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="ABB_created_AA_emit_B_81"></a>其实，可以通过结果清楚看到，当我们还在页面A的时候，页面B还没生成，也就是页面B中的 <code>created</code> 中所监听的来自于A中的事件还没有被触发。这个时候当你A中 <code>emit事件</code> 的时候，B其实是没有监听到的。</h6> 
<h6><a id="BABB_created__beforeMount_AA_beforeDestory__destoryed_83"></a>再看一下，红色的是B页面组件，当你从页面A到页面B跳转的时候，发生了什么？首先是先B组件先 <code>created</code> 然后 <code>beforeMount</code> 接着A组件才被销毁，A组件才执行 <code>beforeDestory</code> ，以及 <code>destoryed</code></h6> 
<h6><a id="Aemit_beforeDestory_B_created__on__85"></a>所以，我们可以把A页面组件中的emit事件写在 <code>beforeDestory</code> 中去。因为这个时候，B页面组件已经被 <code>created</code> 了，也就是我们写的 <code>$on</code> 事件已经触发了</h6> 
<p>所以可以，在 <code>beforeDestory</code> 的时候，<code>$emit事件</code></p> 
<pre><code class="prism language-javascript"><span class="token comment">// 修改一下A页面中的代码：</span>
<span class="token comment">// 这是原先的代码</span>
<span class="token function">editList</span> <span class="token punctuation">(</span>index<span class="token punctuation">,</span> date<span class="token punctuation">,</span> item<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">//  点击进入编辑的页面，需要传递的参数比较多。</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> date<span class="token punctuation">,</span> item<span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>item <span class="token operator">=</span> item<span class="token punctuation">.</span>type
  <span class="token keyword">this</span><span class="token punctuation">.</span>date <span class="token operator">=</span> date
  <span class="token keyword">this</span><span class="token punctuation">.</span>$router<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>path<span class="token punctuation">:</span> <span class="token string">'/moneyRecord'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 重新在data属性内部定义新的变量，来存储要传过去的数据；</span>
然后：
<span class="token function">beforeDestroy</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>highlight<span class="token punctuation">,</span> <span class="token string">'这是今年的数据'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">'看看组件销毁之前会发生什么'</span><span class="token punctuation">)</span>
 bus<span class="token punctuation">.</span><span class="token function">$emit</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
  item<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>item<span class="token punctuation">,</span>
   date<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>date
 <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> 
<p>接下来。看一下修改之后的效果<br> <img src="https://images2.imgbox.com/76/53/dF8Q8wUj_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="list_emit__beforeDestoryed__emit_B_on__112"></a>可以看到，就是第一次点击list的时候，也就是第一次触发 <code>emit事件</code> 的时候，控制太就输出了，所以在 <code>beforeDestoryed</code> 去 <code>$emit</code> 是起到作用的，B页面组件也 <code>监听$on</code> 到了。</h6> 
<h6><a id="_114"></a>但是，好像，就是事件的触发还是会依次增加，就是控制台的输出每次都有所增加了…</h6> 
<p>解决：<br> 看一下github上提出的。issue <a href="https://github.com/vuejs/vue/issues/3399">https://github.com/vuejs/vue/issues/3399</a></p> 
<p><img src="https://images2.imgbox.com/ea/f7/5raeGPO5_o.png" alt="在这里插入图片描述"><br> 尤大大提出了以下解决：<br> <img src="https://images2.imgbox.com/c6/26/gwDExaqM_o.png" alt="在这里插入图片描述"></p> 
<p>就是说，这个 <code>$on事件</code> 是不会自动清楚销毁的，需要我们手动来销毁。（不过我不太清楚这里的 <code>external bus</code> 是什么意思，有大神能解答一下的吗，尤大大也提到如果是注册的是 <code>external bus</code> 的时候需要清除）</p> 
<p>所以。我在B组件页面中添加 <code>Bus.$off</code> 来关闭。代码如下：</p> 
<pre><code class="prism language-javascript"><span class="token comment">// 在B组件页面中添加以下语句，在组件beforeDestory的时候销毁。</span>
  <span class="token function">beforeDestroy</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    bus<span class="token punctuation">.</span><span class="token function">$off</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>myhandle<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> 
<p>来看一下输出的结果：<br> <img src="https://images2.imgbox.com/58/9c/9Ze0352q_o.png" alt="请添加图片描述"></p> 
<h6><a id="mixin_135"></a>当然，尤大大还说可以写一个mixin？我还不知道是什么？以后在研究一下。</h6> 
<blockquote> 
 <p><font color="#764ba2">总结： 所以，如果想要用bus 来进行页面组件之间的数据传递，需要注意亮点，组件A <code>$emit事件</code> 应在 <code>beforeDestory</code> 生命周期内。其次，组件B内的 <code>$on</code> 记得要销毁。</font></p> 
</blockquote> 
<hr> 
<p><font color="#66a6ff"> <strong>提问时间：你们在实现页面组件之间的数据传递有什么好的方法吗？可以留言分享一下吗？有时候虽然也可以通过从后台获取，但是考虑到数据只有几个需要传的话，就没有必要去请求数据，我知道有的还有用vuex传递和路由带参传递，还有呢？</strong></font></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/730db77aaec609a57c45736995c17495/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">pandas._libs.tslibs.timestamps.Timestamp数据类型转化为13位时间戳</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6c5210643b3997b7012f967ca1a9c607/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">SAS-A00-255 Predictive Modeling Use SAS EM</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>