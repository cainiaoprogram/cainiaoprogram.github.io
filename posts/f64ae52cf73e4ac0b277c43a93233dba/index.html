<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Iceberg: 列式读取Parquet数据 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Iceberg: 列式读取Parquet数据" />
<meta property="og:description" content="通过Spark读取Parquet文件的基本流程 SQL ==&gt; Spark解析SQL生成逻辑计划树 LogicalPlan ==&gt; Spark创建扫描表/读取数据的逻辑计划结点 DataSourceV2ScanRelation ==&gt; Spark优化逻辑计划树，生成物理计划树 SparkPlan ==&gt; Spark根据不同的属性，将逻辑计划结点DataSourceV2ScanRelation转换成物理计划结点BatchScanExec BatchScanExec ==&gt; BatchScanExec::inputRDD属性的延迟生成DataSourceRDD实例 DataSourceRDD ==&gt; DataSourceRDD::compute方法创建PartitionReader实例 PartitionReader ==&gt; Iceberg中实现了Spark中的BatchDataReader接口 BatchDataReader ==&gt; BatchDataReader::open方法会创建Parquet文件上的迭代器（Spark中遍历数据的过程都是基于迭代器） VectorizedParquetReader ==&gt; VectorizedParquetReader::next方法，读取Parquet文件中的内容，并封装成Spark中的ColumnarBatch对象 ColumnarBatch 两种BaseBatchReader的实现类 BaseBatchReader支持以Batch &#43; Vectorized的特性，读取底层的文件。
ColumnarBatchReader 通过VectorizedSparkParquetReaders::build Reader()静态方法创建的读取器，关键特性如下：
支持读取Delete File以Arrow的格式直接读取Parquet文件最终返回的数据集的类型为Spark.ColumnarBatch，是Spark中的实现类 public static ColumnarBatchReader buildReader( Schema expectedSchema, MessageType fileSchema, Map&lt;Integer, ?&gt; idToConstant, DeleteFilter&lt;InternalRow&gt; deleteFilter) { return (ColumnarBatchReader) TypeWithSchemaVisitor.visit( expectedSchema.asStruct(), fileSchema, new ReaderBuilder( expectedSchema, fileSchema, NullCheckingForGet.NULL_CHECKING_ENABLED, idToConstant, ColumnarBatchReader::new, deleteFilter)); ArrowBatchReader 通过ArrowReader::buildReader()静态方法创建的读取器，关键特性如下：
不支持读取Delete File以Arrow的格式直接读取Parquet文件返回的最终结果为ColumnarBatch类型，是Iceberg内置的实现类 在Iceberg 1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/f64ae52cf73e4ac0b277c43a93233dba/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-05T20:05:44+08:00" />
<meta property="article:modified_time" content="2024-01-05T20:05:44+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Iceberg: 列式读取Parquet数据</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="SparkParquet_0"></a>通过Spark读取Parquet文件的基本流程</h2> 
<pre><code class="prism language-shell">SQL
<span class="token operator">==</span><span class="token operator">&gt;</span> Spark解析SQL生成逻辑计划树
LogicalPlan
<span class="token operator">==</span><span class="token operator">&gt;</span> Spark创建扫描表/读取数据的逻辑计划结点
DataSourceV2ScanRelation
<span class="token operator">==</span><span class="token operator">&gt;</span> Spark优化逻辑计划树，生成物理计划树
SparkPlan
<span class="token operator">==</span><span class="token operator">&gt;</span> Spark根据不同的属性，将逻辑计划结点DataSourceV2ScanRelation转换成物理计划结点BatchScanExec
BatchScanExec
<span class="token operator">==</span><span class="token operator">&gt;</span> BatchScanExec::inputRDD属性的延迟生成DataSourceRDD实例
DataSourceRDD
<span class="token operator">==</span><span class="token operator">&gt;</span> DataSourceRDD::compute方法创建PartitionReader实例
PartitionReader
<span class="token operator">==</span><span class="token operator">&gt;</span> Iceberg中实现了Spark中的BatchDataReader接口
BatchDataReader
<span class="token operator">==</span><span class="token operator">&gt;</span> BatchDataReader::open方法会创建Parquet文件上的迭代器（Spark中遍历数据的过程都是基于迭代器）
VectorizedParquetReader
<span class="token operator">==</span><span class="token operator">&gt;</span> VectorizedParquetReader::next方法，读取Parquet文件中的内容，并封装成Spark中的ColumnarBatch对象
ColumnarBatch
</code></pre> 
<h2><a id="BaseBatchReaderT_22"></a>两种BaseBatchReader的实现类</h2> 
<blockquote> 
 <p>BaseBatchReader支持以Batch + Vectorized的特性，读取底层的文件。</p> 
</blockquote> 
<h3><a id="ColumnarBatchReader_25"></a>ColumnarBatchReader</h3> 
<blockquote> 
 <p>通过<code>VectorizedSparkParquetReaders::build Reader()</code>静态方法创建的读取器，关键特性如下：</p> 
 <blockquote> 
  <ol><li>支持读取Delete File</li><li>以Arrow的格式直接读取Parquet文件</li><li>最终返回的数据集的类型为Spark.ColumnarBatch，是Spark中的实现类</li></ol> 
 </blockquote> 
</blockquote> 
<pre><code class="prism language-java">  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ColumnarBatchReader</span> <span class="token function">buildReader</span><span class="token punctuation">(</span>
      <span class="token class-name">Schema</span> expectedSchema<span class="token punctuation">,</span>
      <span class="token class-name">MessageType</span> fileSchema<span class="token punctuation">,</span>
      <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> idToConstant<span class="token punctuation">,</span>
      <span class="token class-name">DeleteFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InternalRow</span><span class="token punctuation">&gt;</span></span> deleteFilter<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">ColumnarBatchReader</span><span class="token punctuation">)</span>
        <span class="token class-name">TypeWithSchemaVisitor</span><span class="token punctuation">.</span><span class="token function">visit</span><span class="token punctuation">(</span>
            expectedSchema<span class="token punctuation">.</span><span class="token function">asStruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            fileSchema<span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">ReaderBuilder</span><span class="token punctuation">(</span>
                expectedSchema<span class="token punctuation">,</span>
                fileSchema<span class="token punctuation">,</span>
                <span class="token class-name">NullCheckingForGet</span><span class="token punctuation">.</span><span class="token constant">NULL_CHECKING_ENABLED</span><span class="token punctuation">,</span>
                idToConstant<span class="token punctuation">,</span>
                <span class="token class-name">ColumnarBatchReader</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">,</span>
                deleteFilter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="ArrowBatchReader_50"></a>ArrowBatchReader</h3> 
<blockquote> 
 <p>通过<code>ArrowReader::buildReader()</code>静态方法创建的读取器，关键特性如下：</p> 
 <blockquote> 
  <ol><li>不支持读取Delete File</li><li>以Arrow的格式直接读取Parquet文件</li><li>返回的最终结果为ColumnarBatch类型，是Iceberg内置的实现类</li></ol> 
 </blockquote> 
 <p>在Iceberg 1.2.x的版本中，只在测试用例中使用到，因此在这里不再讨论，它的实现比ColumnarBatchReader更简单。</p> 
</blockquote> 
<h2><a id="ColumnarBatchReader_59"></a>ColumnarBatchReader的创建</h2> 
<h3><a id="DataSourceRDDcomputePartitionReaderColumnarBatch_60"></a>DataSourceRDD::compute方法中创建PartitionReader实例</h3> 
<pre><code class="prism language-java"><span class="token comment">// 在计算RDD数据的过程中，会通过如下的方法创建一个实现了PartitionReader接口的具体类的实例，</span>
<span class="token comment">// 这里partitionReaderFactory的类型为SparkColumnarReaderFactory，</span>
<span class="token comment">// SparkColumnarReaderFactory类是Iceberg中的实现，它重写了createColumnarReader(InputPartition)接口</span>
<span class="token comment">// 以返回一个PartitionReader&lt;ColumnarBatch&gt;的实例。</span>
val batchReader <span class="token operator">=</span> partitionReaderFactory<span class="token punctuation">.</span><span class="token function">createColumnarReader</span><span class="token punctuation">(</span>inputPartition<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="PartitionReaderFactorycreateColumnarReaderBatchDataReader_69"></a>PartitionReaderFactory.createColumnarReader方法创建BatchDataReader实例</h4> 
<pre><code class="prism language-java"><span class="token keyword">class</span> <span class="token class-name">SparkColumnarReaderFactory</span> <span class="token keyword">implements</span> <span class="token class-name">PartitionReaderFactory</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">public</span> <span class="token class-name">PartitionReader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ColumnarBatch</span><span class="token punctuation">&gt;</span></span> <span class="token function">createColumnarReader</span><span class="token punctuation">(</span><span class="token class-name">InputPartition</span> inputPartition<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">SparkInputPartition</span> partition <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SparkInputPartition</span><span class="token punctuation">)</span> inputPartition<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>partition<span class="token punctuation">.</span><span class="token function">allTasksOfType</span><span class="token punctuation">(</span><span class="token class-name">FileScanTask</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BatchDataReader</span><span class="token punctuation">(</span>partition<span class="token punctuation">,</span> batchSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span>
          <span class="token string">"Unsupported task group for columnar reads: "</span> <span class="token operator">+</span> partition<span class="token punctuation">.</span><span class="token function">taskGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="BatchDataReaderopenVectorizedParquetReaderColumnarBatch_83"></a>BatchDataReader::open方法创建VectorizedParquetReader迭代器</h3> 
<h4><a id="BatchDataReaderopen_84"></a>BatchDataReader::open</h4> 
<pre><code class="prism language-java"><span class="token keyword">class</span> <span class="token class-name">BatchDataReader</span> <span class="token keyword">extends</span> <span class="token class-name">BaseBatchReader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FileScanTask</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">implements</span> <span class="token class-name">PartitionReader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ColumnarBatch</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">protected</span> <span class="token class-name">CloseableIterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ColumnarBatch</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">FileScanTask</span> task<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 获取Data File的路径</span>
    <span class="token class-name">String</span> filePath <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">file</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Opening data file {}"</span><span class="token punctuation">,</span> filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// update the current file for Spark's filename() function</span>
    <span class="token class-name">InputFileBlockHolder</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> task<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> task<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> idToConstant <span class="token operator">=</span> <span class="token function">constantsMap</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> <span class="token function">expectedSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取底层文件的句柄</span>
    <span class="token class-name">InputFile</span> inputFile <span class="token operator">=</span> <span class="token function">getInputFile</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Preconditions</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>inputFile<span class="token punctuation">,</span> <span class="token string">"Could not find InputFile associated with FileScanTask"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取数据文件对应的Delete Files</span>
    <span class="token class-name">SparkDeleteFilter</span> deleteFilter <span class="token operator">=</span>
        task<span class="token punctuation">.</span><span class="token function">deletes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">?</span> <span class="token keyword">null</span>
            <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">SparkDeleteFilter</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> task<span class="token punctuation">.</span><span class="token function">deletes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 返回一个数据文件上的迭代器</span>
    <span class="token keyword">return</span> <span class="token function">newBatchIterable</span><span class="token punctuation">(</span>
            inputFile<span class="token punctuation">,</span>
            task<span class="token punctuation">.</span><span class="token function">file</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            task<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            task<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            task<span class="token punctuation">.</span><span class="token function">residual</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            idToConstant<span class="token punctuation">,</span>
            deleteFilter<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="BaseBatchReadernewBatchIterableVectorizedParquetReader_119"></a>BaseBatchReader::newBatchIterable方法创建VectorizedParquetReader实例</h4> 
<blockquote> 
 <p>VectorizedParquetReader类是最上层的类，它提供了对遍历文件内容的入口。</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">BaseBatchReader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">ScanTask</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">BaseReader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ColumnarBatch</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>

  <span class="token keyword">protected</span> <span class="token class-name">CloseableIterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ColumnarBatch</span><span class="token punctuation">&gt;</span></span> <span class="token function">newBatchIterable</span><span class="token punctuation">(</span>
      <span class="token class-name">InputFile</span> inputFile<span class="token punctuation">,</span>
      <span class="token class-name">FileFormat</span> format<span class="token punctuation">,</span>
      <span class="token keyword">long</span> start<span class="token punctuation">,</span>
      <span class="token keyword">long</span> length<span class="token punctuation">,</span>
      <span class="token class-name">Expression</span> residual<span class="token punctuation">,</span>
      <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> idToConstant<span class="token punctuation">,</span>
      <span class="token class-name">SparkDeleteFilter</span> deleteFilter<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>format<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">case</span> <span class="token constant">PARQUET</span><span class="token operator">:</span>
        <span class="token comment">// 如果文件的格式是PARQUET，则创建一个Parquet上的迭代器</span>
        <span class="token keyword">return</span> <span class="token function">newParquetIterable</span><span class="token punctuation">(</span>inputFile<span class="token punctuation">,</span> start<span class="token punctuation">,</span> length<span class="token punctuation">,</span> residual<span class="token punctuation">,</span> idToConstant<span class="token punctuation">,</span> deleteFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> <span class="token constant">ORC</span><span class="token operator">:</span>
        <span class="token comment">// 忽略，不讨论</span>
        <span class="token keyword">return</span> <span class="token function">newOrcIterable</span><span class="token punctuation">(</span>inputFile<span class="token punctuation">,</span> start<span class="token punctuation">,</span> length<span class="token punctuation">,</span> residual<span class="token punctuation">,</span> idToConstant<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span>
            <span class="token string">"Format: "</span> <span class="token operator">+</span> format <span class="token operator">+</span> <span class="token string">" not supported for batched reads"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
 
  <span class="token keyword">private</span> <span class="token class-name">CloseableIterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ColumnarBatch</span><span class="token punctuation">&gt;</span></span> <span class="token function">newParquetIterable</span><span class="token punctuation">(</span>
      <span class="token class-name">InputFile</span> inputFile<span class="token punctuation">,</span>
      <span class="token keyword">long</span> start<span class="token punctuation">,</span>
      <span class="token keyword">long</span> length<span class="token punctuation">,</span>
      <span class="token class-name">Expression</span> residual<span class="token punctuation">,</span>
      <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> idToConstant<span class="token punctuation">,</span>
      <span class="token class-name">SparkDeleteFilter</span> deleteFilter<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// get required schema if there are deletes</span>
    <span class="token class-name">Schema</span> requiredSchema <span class="token operator">=</span> deleteFilter <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> deleteFilter<span class="token punctuation">.</span><span class="token function">requiredSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">expectedSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token class-name">Parquet</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>inputFile<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">project</span><span class="token punctuation">(</span>requiredSchema<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> length<span class="token punctuation">)</span>
        <span class="token comment">// 指定可以创建BaseBatchReader的实现类的实例的方法</span>
        <span class="token punctuation">.</span><span class="token function">createBatchedReaderFunc</span><span class="token punctuation">(</span>
            fileSchema <span class="token operator">-&gt;</span>
                <span class="token class-name">VectorizedSparkParquetReaders</span><span class="token punctuation">.</span><span class="token function">buildReader</span><span class="token punctuation">(</span>
                    requiredSchema<span class="token punctuation">,</span> fileSchema<span class="token punctuation">,</span> idToConstant<span class="token punctuation">,</span> deleteFilter<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">recordsPerBatch</span><span class="token punctuation">(</span>batchSize<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>residual<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">caseSensitive</span><span class="token punctuation">(</span><span class="token function">caseSensitive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">// Spark eagerly consumes the batches. So the underlying memory allocated could be reused</span>
        <span class="token comment">// without worrying about subsequent reads clobbering over each other. This improves</span>
        <span class="token comment">// read performance as every batch read doesn't have to pay the cost of allocating memory.</span>
        <span class="token punctuation">.</span><span class="token function">reuseContainers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">withNameMapping</span><span class="token punctuation">(</span><span class="token function">nameMapping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="ColumnarBatchReadernewColumnarBatchReader_178"></a>ColumnarBatchReader::new方法创建ColumnarBatchReader实例</h3> 
<blockquote> 
 <p><code>VectorizedSparkParquetReaders.buildReader()</code>方法见第一大章节的简述。</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ColumnarBatchReader</span> <span class="token keyword">extends</span> <span class="token class-name">BaseBatchReader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ColumnarBatch</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> hasIsDeletedColumn<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">DeleteFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InternalRow</span><span class="token punctuation">&gt;</span></span> deletes <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">long</span> rowStartPosInBatch <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// 只有一个构造器，readers是保存了读取文件中每一个列（字段）的Reader，它们都是实现了VectorizedReader&lt;T&gt;接口的</span>
  <span class="token comment">// VectorizedArrowReader&lt;T&gt;的实例</span>
  <span class="token keyword">public</span> <span class="token class-name">ColumnarBatchReader</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">VectorizedReader</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> readers<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>readers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 遍历每一个字段的Reader类型，看看当前文件中是不是存在内置的列_deleted，它标识着当前当前行是不是被删除了。</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hasIsDeletedColumn <span class="token operator">=</span>
        readers<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">anyMatch</span><span class="token punctuation">(</span>reader <span class="token operator">-&gt;</span> reader <span class="token keyword">instanceof</span> <span class="token class-name">DeletedVectorReader</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="Parquet_197"></a>Parquet文件读取</h2> 
<blockquote> 
 <p>通过前面的分析，知道对上层（Spark RDD）可见的接口，是由VectorizedParquetReader（一个Iterator的实现类）提供的，<br> 它内部封装了对ColumnarBatchReader的操作。</p> 
</blockquote> 
<h3><a id="VectorizedParquetReaderiteratorParquet_201"></a>VectorizedParquetReader::iterator方法，返回Parquet文件上的迭代器</h3> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VectorizedParquetReader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">CloseableGroup</span> <span class="token keyword">implements</span> <span class="token class-name">CloseableIterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">CloseableIterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">FileIterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> iter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileIterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addCloseable</span><span class="token punctuation">(</span>iter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> iter<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="FileIteratornext_213"></a>FileIterator::next方法，读取数据</h3> 
<blockquote> 
 <p>由于FilterIterator实现了JAVA中的Iterator接口，因此可以在compute Spark RDD时，通过这个迭代器，获取到文件中的内容，<br> 也就是next()方法返回的ColumnarBatch对象。</p> 
</blockquote> 
<pre><code class="prism language-java">  <span class="token comment">/**
   * 这里T的类型为ColumnarBatch。
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">FileIterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">CloseableIterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
  
    <span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchElementException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>valuesRead <span class="token operator">&gt;=</span> nextRowGroupStart<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 第一次执行时，valuesRead == nextRowGroupStart，表示开始读取一个新的RowGroup</span>
        <span class="token comment">// 这里调用advance()后，nextRowGroupStart指向了下一个要读取的RowGroup的起始位置，</span>
        <span class="token comment">// 但当前的RowGroup是还没有被读取的，被延迟到了后面的过程。</span>
        <span class="token function">advance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// batchSize is an integer, so casting to integer is safe</span>
      <span class="token comment">// 读取当前RowGroup的数据，其中：</span>
      <span class="token comment">//   nextRowGroupStart指向的是下一个RowGroup的起始位置，</span>
      <span class="token comment">//   valuesRead的值表示一共读取了多少行</span>
      <span class="token comment">// 这里必须有nextRowGroupStart &gt;= nextRowGroupStart，而它们的差值就是当前RowGroup剩余的没有被读取的行</span>
      <span class="token keyword">int</span> numValuesToRead <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>nextRowGroupStart <span class="token operator">-</span> valuesRead<span class="token punctuation">,</span> batchSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 读取指定数量的行，这里的model就是前面提到的ColumnarBatchReader的实例对象。</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>reuseContainers<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>last <span class="token operator">=</span> model<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>last<span class="token punctuation">,</span> numValuesToRead<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>last <span class="token operator">=</span> model<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> numValuesToRead<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 累加读取的行数</span>
      valuesRead <span class="token operator">+=</span> numValuesToRead<span class="token punctuation">;</span>

      <span class="token keyword">return</span> last<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 移动读取指针到下一个RowGroup的起始位置。
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">advance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>shouldSkip<span class="token punctuation">[</span>nextRowGroup<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        nextRowGroup <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        reader<span class="token punctuation">.</span><span class="token function">skipNextRowGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token class-name">PageReadStore</span> pages<span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        pages <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">readNextRowGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeIOException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 从绑定的RowGroups信息中，计算下一个RowGroup的起始位置</span>
      <span class="token keyword">long</span> rowPosition <span class="token operator">=</span> rowGroupsStartRowPos<span class="token punctuation">[</span>nextRowGroup<span class="token punctuation">]</span><span class="token punctuation">;</span>
      model<span class="token punctuation">.</span><span class="token function">setRowGroupInfo</span><span class="token punctuation">(</span>pages<span class="token punctuation">,</span> columnChunkMetadata<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>nextRowGroup<span class="token punctuation">)</span><span class="token punctuation">,</span> rowPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>
      nextRowGroupStart <span class="token operator">+=</span> pages<span class="token punctuation">.</span><span class="token function">getRowCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      nextRowGroup <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="ColumnarBatchReaderread_275"></a>ColumnarBatchReader::read</h4> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ColumnarBatchReader</span> <span class="token keyword">extends</span> <span class="token class-name">BaseBatchReader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ColumnarBatch</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">VectorHolder</span><span class="token punctuation">[</span><span class="token punctuation">]</span> vectorHolders<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ColumnarBatch</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token class-name">ColumnarBatch</span> reuse<span class="token punctuation">,</span> <span class="token keyword">int</span> numRowsToRead<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>reuse <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 如果指定了不复用当前的VectorHolder来存储数据时，就关闭它们</span>
      <span class="token function">closeVectors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 由内部类ColumnBatchLoader负责代理进行真正的读取操作。</span>
    <span class="token class-name">ColumnarBatch</span> columnarBatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ColumnBatchLoader</span><span class="token punctuation">(</span>numRowsToRead<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadDataToColumnBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rowStartPosInBatch <span class="token operator">+=</span> numRowsToRead<span class="token punctuation">;</span>
    <span class="token keyword">return</span> columnarBatch<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="ColumnBatchLoaderloadDataToColumnBatchColumnarBatch_293"></a>ColumnBatchLoader::loadDataToColumnBatch读取数据，封装成ColumnarBatch对象</h4> 
<pre><code class="prism language-java">  <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">ColumnBatchLoader</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 读取的数据记录总数</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> numRowsToRead<span class="token punctuation">;</span>
    <span class="token comment">// the rowId mapping to skip deleted rows for all column vectors inside a batch, it is null when</span>
    <span class="token comment">// there is no deletes</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> rowIdMapping<span class="token punctuation">;</span>
    <span class="token comment">// the array to indicate if a row is deleted or not, it is null when there is no "_deleted"</span>
    <span class="token comment">// metadata column</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span><span class="token punctuation">[</span><span class="token punctuation">]</span> isDeleted<span class="token punctuation">;</span>

    <span class="token class-name">ColumnBatchLoader</span><span class="token punctuation">(</span><span class="token keyword">int</span> numRowsToRead<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token class-name">Preconditions</span><span class="token punctuation">.</span><span class="token function">checkArgument</span><span class="token punctuation">(</span>
          numRowsToRead <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"Invalid number of rows to read: %s"</span><span class="token punctuation">,</span> numRowsToRead<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>numRowsToRead <span class="token operator">=</span> numRowsToRead<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>hasIsDeletedColumn<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        isDeleted <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">boolean</span><span class="token punctuation">[</span>numRowsToRead<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">ColumnarBatch</span> <span class="token function">loadDataToColumnBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 对读取的数据记录进行过滤，得到未删除的数据记录总数</span>
      <span class="token keyword">int</span> numRowsUndeleted <span class="token operator">=</span> <span class="token function">initRowIdMapping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 以Arrows格式，读取每一列的数据，表示为Spark.ColumnVector类型</span>
      <span class="token class-name">ColumnVector</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arrowColumnVectors <span class="token operator">=</span> <span class="token function">readDataToColumnVectors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 创建一个ColumnarBatch实例，包含所有存活的数据</span>
      <span class="token class-name">ColumnarBatch</span> newColumnarBatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ColumnarBatch</span><span class="token punctuation">(</span>arrowColumnVectors<span class="token punctuation">)</span><span class="token punctuation">;</span>
      newColumnarBatch<span class="token punctuation">.</span><span class="token function">setNumRows</span><span class="token punctuation">(</span>numRowsUndeleted<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasEqDeletes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如果有等值删除的文件存在，则还需要按值来过滤掉被删除的数据行</span>
        <span class="token comment">// 由于基于等值删除的文件过滤数据时，需要知道每一行的实际值，因此只有将数据读取到内存中才知道哪一行要被删除掉</span>
        <span class="token function">applyEqDelete</span><span class="token punctuation">(</span>newColumnarBatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>hasIsDeletedColumn <span class="token operator">&amp;&amp;</span> rowIdMapping <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如果存在被删除的数据行，则需要重新分配行号，从0开始自然递增</span>
        <span class="token comment">// reset the row id mapping array, so that it doesn't filter out the deleted rows</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numRowsToRead<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          rowIdMapping<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        newColumnarBatch<span class="token punctuation">.</span><span class="token function">setNumRows</span><span class="token punctuation">(</span>numRowsToRead<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 返回</span>
      <span class="token keyword">return</span> newColumnarBatch<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">ColumnVector</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">readDataToColumnVectors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token class-name">ColumnVector</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arrowColumnVectors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ColumnVector</span><span class="token punctuation">[</span>readers<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token class-name">ColumnVectorBuilder</span> columnVectorBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ColumnVectorBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> readers<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        vectorHolders<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> readers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>vectorHolders<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> numRowsToRead<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> numRowsInVector <span class="token operator">=</span> vectorHolders<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">numValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Preconditions</span><span class="token punctuation">.</span><span class="token function">checkState</span><span class="token punctuation">(</span>
            numRowsInVector <span class="token operator">==</span> numRowsToRead<span class="token punctuation">,</span>
            <span class="token string">"Number of rows in the vector %s didn't match expected %s "</span><span class="token punctuation">,</span>
            numRowsInVector<span class="token punctuation">,</span>
            numRowsToRead<span class="token punctuation">)</span><span class="token punctuation">;</span>

        arrowColumnVectors<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span>
            columnVectorBuilder
                <span class="token punctuation">.</span><span class="token function">withDeletedRows</span><span class="token punctuation">(</span>rowIdMapping<span class="token punctuation">,</span> isDeleted<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>vectorHolders<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> numRowsInVector<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> arrowColumnVectors<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">boolean</span> <span class="token function">hasEqDeletes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> deletes <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> deletes<span class="token punctuation">.</span><span class="token function">hasEqDeletes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> <span class="token function">initRowIdMapping</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token class-name">Pair</span><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token operator">&gt;</span> posDeleteRowIdMapping <span class="token operator">=</span> <span class="token function">posDelRowIdMapping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>posDeleteRowIdMapping <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        rowIdMapping <span class="token operator">=</span> posDeleteRowIdMapping<span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> posDeleteRowIdMapping<span class="token punctuation">.</span><span class="token function">second</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        rowIdMapping <span class="token operator">=</span> <span class="token function">initEqDeleteRowIdMapping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> numRowsToRead<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 如果当前文件包含 positions delete files，那么需要建立索引数据结构
     */</span>
    <span class="token class-name">Pair</span><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token operator">&gt;</span> <span class="token function">posDelRowIdMapping</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>deletes <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> deletes<span class="token punctuation">.</span><span class="token function">hasPosDeletes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">buildPosDelRowIdMapping</span><span class="token punctuation">(</span>deletes<span class="token punctuation">.</span><span class="token function">deletedRowPositions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * Build a row id mapping inside a batch, which skips deleted rows. Here is an example of how we
     * delete 2 rows in a batch with 8 rows in total. [0,1,2,3,4,5,6,7] -- Original status of the
     * row id mapping array [F,F,F,F,F,F,F,F] -- Original status of the isDeleted array Position
     * delete 2, 6 [0,1,3,4,5,7,-,-] -- After applying position deletes [Set Num records to 6]
     * [F,F,T,F,F,F,T,F] -- After applying position deletes
     *
     * @param deletedRowPositions a set of deleted row positions
     * @return the mapping array and the new num of rows in a batch, null if no row is deleted
     */</span>
    <span class="token class-name">Pair</span><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token operator">&gt;</span> <span class="token function">buildPosDelRowIdMapping</span><span class="token punctuation">(</span><span class="token class-name">PositionDeleteIndex</span> deletedRowPositions<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>deletedRowPositions <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 为新读取的数据记录，创建一个数组，保存所有没有被删除的行号，从0开始</span>
      <span class="token comment">// 基本算法：使用双指针，将所有未删除的行放到队列一端，且有序</span>
      <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> posDelRowIdMapping <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>numRowsToRead<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">int</span> originalRowId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 指向待判定的行的下标</span>
      <span class="token keyword">int</span> currentRowId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 存活行的下标</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>originalRowId <span class="token operator">&lt;</span> numRowsToRead<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>deletedRowPositions<span class="token punctuation">.</span><span class="token function">isDeleted</span><span class="token punctuation">(</span>originalRowId <span class="token operator">+</span> rowStartPosInBatch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 如果当前行没有被删除，则将其添加到currentRowId指向的位置</span>
          posDelRowIdMapping<span class="token punctuation">[</span>currentRowId<span class="token punctuation">]</span> <span class="token operator">=</span> originalRowId<span class="token punctuation">;</span>
          <span class="token comment">// currentRowId指向下一个待插入的位置  </span>
          currentRowId<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>hasIsDeletedColumn<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            isDeleted<span class="token punctuation">[</span>originalRowId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          deletes<span class="token punctuation">.</span><span class="token function">incrementDeleteCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        originalRowId<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>currentRowId <span class="token operator">==</span> numRowsToRead<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// there is no delete in this batch</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">Pair</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>posDelRowIdMapping<span class="token punctuation">,</span> currentRowId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">initEqDeleteRowIdMapping</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> eqDeleteRowIdMapping <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasEqDeletes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        eqDeleteRowIdMapping <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>numRowsToRead<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numRowsToRead<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          eqDeleteRowIdMapping<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> eqDeleteRowIdMapping<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Filter out the equality deleted rows. Here is an example, [0,1,2,3,4,5,6,7] -- Original
     * status of the row id mapping array [F,F,F,F,F,F,F,F] -- Original status of the isDeleted
     * array Position delete 2, 6 [0,1,3,4,5,7,-,-] -- After applying position deletes [Set Num
     * records to 6] [F,F,T,F,F,F,T,F] -- After applying position deletes Equality delete 1 &lt;= x &lt;=
     * 3 [0,4,5,7,-,-,-,-] -- After applying equality deletes [Set Num records to 4]
     * [F,T,T,T,F,F,T,F] -- After applying equality deletes
     *
     * @param columnarBatch the {@link ColumnarBatch} to apply the equality delete
     */</span>
    <span class="token keyword">void</span> <span class="token function">applyEqDelete</span><span class="token punctuation">(</span><span class="token class-name">ColumnarBatch</span> columnarBatch<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 对经过position deletes 过滤的数据行，进行按值删除</span>
      <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InternalRow</span><span class="token punctuation">&gt;</span></span> it <span class="token operator">=</span> columnarBatch<span class="token punctuation">.</span><span class="token function">rowIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">int</span> rowId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">int</span> currentRowId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 行式遍历</span>
        <span class="token class-name">InternalRow</span> row <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>deletes<span class="token punctuation">.</span><span class="token function">eqDeletedRowFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// the row is NOT deleted</span>
          <span class="token comment">// skip deleted rows by pointing to the next undeleted row Id</span>
          <span class="token comment">// 更新成员变量rowIdMapping</span>
          rowIdMapping<span class="token punctuation">[</span>currentRowId<span class="token punctuation">]</span> <span class="token operator">=</span> rowIdMapping<span class="token punctuation">[</span>rowId<span class="token punctuation">]</span><span class="token punctuation">;</span>
          currentRowId<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>hasIsDeletedColumn<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            isDeleted<span class="token punctuation">[</span>rowIdMapping<span class="token punctuation">[</span>rowId<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          deletes<span class="token punctuation">.</span><span class="token function">incrementDeleteCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        rowId<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 更新最新的存活记录数</span>
      columnarBatch<span class="token punctuation">.</span><span class="token function">setNumRows</span><span class="token punctuation">(</span>currentRowId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/392254e984f75ae37c8433c78d6b3f90/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Trino: 基于时间片的Split数据处理模型</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5e7b9f12ddffbac27a701d4d7cc75d7d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Iceberg: COW模式下的MERGE INTO的执行流程</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>