<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>bmp文件格式 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="bmp文件格式" />
<meta property="og:description" content="一个常用的bmp文件内容由以下结构组成:
BITMAPFILEHEADER &#43; BITMAPINFO &#43; 数据
typedef struct tagBITMAPFILEHEADER { WORD bfType; DWORD bfSize; WORD bfReserved1; WORD bfReserved2; DWORD bfOffBits; } BITMAPFILEHEADER, *PBITMAPFILEHEADER; typedef struct tagBITMAPINFO { BITMAPINFOHEADER bmiHeader; RGBQUAD bmiColors[1]; } BITMAPINFO, *PBITMAPINFO; typedef struct tagBITMAPINFOHEADER{
DWORD biSize; LONG biWidth; LONG biHeight; WORD biPlanes; WORD biBitCount; DWORD biCompression; DWORD biSizeImage; LONG biXPelsPerMeter; LONG biYPelsPerMeter; DWORD biClrUsed; DWORD biClrImportant; } BITMAPINFOHEADER, *PBITMAPINFOHEADER; procedure TfrmServer.SaveBmpFile(pData: Pointer; DataLen: DWORD);
var
fhdr: TBitmapFileHeader;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/1b9ad5ed216fdd2e7b51f8f820117648/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2007-09-08T15:28:00+08:00" />
<meta property="article:modified_time" content="2007-09-08T15:28:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">bmp文件格式</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>一个常用的bmp文件内容由以下结构组成:</p> 
<p><font style="BACKGROUND-COLOR: #c0c0c0" size="5"><strong>BITMAPFILEHEADER + BITMAPINFO + 数据</strong></font></p> 
<p><font face="Courier New">typedef struct tagBITMAPFILEHEADER { <br>  WORD    </font><a class="synParam" href="http://writeblog.csdn.net/Editor/FCKeditor/editor/" rel="nofollow"><font face="Courier New">bfType</font></a><font face="Courier New">; <br>  DWORD   </font><a class="synParam" href="http://writeblog.csdn.net/Editor/FCKeditor/editor/" rel="nofollow"><font face="Courier New">bfSize</font></a><font face="Courier New">; <br>  WORD    </font><a class="synParam" href="http://writeblog.csdn.net/Editor/FCKeditor/editor/" rel="nofollow"><font face="Courier New">bfReserved1</font></a><font face="Courier New">; <br>  WORD    </font><a class="synParam" href="http://writeblog.csdn.net/Editor/FCKeditor/editor/" rel="nofollow"><font face="Courier New">bfReserved2</font></a><font face="Courier New">; <br>  DWORD   </font><a class="synParam" href="http://writeblog.csdn.net/Editor/FCKeditor/editor/" rel="nofollow"><font face="Courier New">bfOffBits</font></a><font face="Courier New">; <br>} BITMAPFILEHEADER, *PBITMAPFILEHEADER; </font></p> 
<p><font face="Courier New">typedef struct tagBITMAPINFO { <br>  BITMAPINFOHEADER </font><a class="synParam" href="http://writeblog.csdn.net/Editor/FCKeditor/editor/" rel="nofollow"><font face="Courier New">bmiHeader</font></a><font face="Courier New">; <br>  RGBQUAD          </font><a class="synParam" href="http://writeblog.csdn.net/Editor/FCKeditor/editor/" rel="nofollow"><font face="Courier New">bmiColors</font></a><font face="Courier New">[1]; <br>} BITMAPINFO, *PBITMAPINFO; </font></p> 
<p><font face="Courier New"></font></p> 
<p><font face="Courier New">typedef struct tagBITMAPINFOHEADER{<!-- --><br>  DWORD  </font><a class="synParam" href="http://writeblog.csdn.net/Editor/FCKeditor/editor/" rel="nofollow"><font face="Courier New">biSize</font></a><font face="Courier New">; <br>  LONG   </font><a class="synParam" href="http://writeblog.csdn.net/Editor/FCKeditor/editor/" rel="nofollow"><font face="Courier New">biWidth</font></a><font face="Courier New">; <br>  LONG   </font><a class="synParam" href="http://writeblog.csdn.net/Editor/FCKeditor/editor/" rel="nofollow"><font face="Courier New">biHeight</font></a><font face="Courier New">; <br>  WORD   </font><a class="synParam" href="http://writeblog.csdn.net/Editor/FCKeditor/editor/" rel="nofollow"><font face="Courier New">biPlanes</font></a><font face="Courier New">; <br>  WORD   </font><a class="synParam" href="http://writeblog.csdn.net/Editor/FCKeditor/editor/" rel="nofollow"><font face="Courier New">biBitCount</font></a><font face="Courier New">; <br>  DWORD  </font><a class="synParam" href="http://writeblog.csdn.net/Editor/FCKeditor/editor/" rel="nofollow"><font face="Courier New">biCompression</font></a><font face="Courier New">; <br>  DWORD  </font><a class="synParam" href="http://writeblog.csdn.net/Editor/FCKeditor/editor/" rel="nofollow"><font face="Courier New">biSizeImage</font></a><font face="Courier New">; <br>  LONG   </font><a class="synParam" href="http://writeblog.csdn.net/Editor/FCKeditor/editor/" rel="nofollow"><font face="Courier New">biXPelsPerMeter</font></a><font face="Courier New">; <br>  LONG   </font><a class="synParam" href="http://writeblog.csdn.net/Editor/FCKeditor/editor/" rel="nofollow"><font face="Courier New">biYPelsPerMeter</font></a><font face="Courier New">; <br>  DWORD  </font><a class="synParam" href="http://writeblog.csdn.net/Editor/FCKeditor/editor/" rel="nofollow"><font face="Courier New">biClrUsed</font></a><font face="Courier New">; <br>  DWORD  </font><a class="synParam" href="http://writeblog.csdn.net/Editor/FCKeditor/editor/" rel="nofollow"><font face="Courier New">biClrImportant</font></a><font face="Courier New">; <br>} BITMAPINFOHEADER, *PBITMAPINFOHEADER;</font> </p> 
<p> procedure TfrmServer.SaveBmpFile(pData: Pointer; DataLen: DWORD);<br>var<br>    fhdr: TBitmapFileHeader;<br>    bi: TBitmapInfo;<br>    LenH, Lenbi: Integer;<br>    hFile: THandle;<br>begin<br>    LenH:= SizeOf(fhdr);<br>    Lenbi:= SizeOf(bi);<br>    ZeroMemory(@fhdr, LenH);<br>    ZeroMemory(@bi, Lenbi);</p> 
<p>    fhdr.bfType:=  $4d42;        // 0x42 = "B" 0x4d = "M"<br>    fhdr.bfSize:= LenH + Lenbi + DataLen;<br>    fhdr.bfOffBits:= LenH + Lenbi;<br>    with bi.bmiHeader do<br>    begin<br>        biSize:= SizeOf(TBitmapInfoHeader);<br>        biWidth:= State.VideoWidth;<br>        biHeight:= State.VideoHeight;<br>        biPlanes:= 1;<br>        biBitCount:= 32;<br>        biCompression:= BI_RGB;<br>        biSizeImage:= DataLen;<br>        biXPelsPerMeter:= 0;<br>        biYPelsPerMeter:= 0;<br>        biClrUsed:= 0;<br>        biClrImportant:= 0;<br>    end;</p> 
<p>    hFile:= FileCreate('c:/test.bmp', fmCreate);<br>    FileWrite(hFile, fhdr, LenH);<br>    FileWrite(hFile, bi, Lenbi);<br>    FileWrite(hFile, pdata^, DataLen);<br>    FileClose(hFile);</p> 
<p><br>end;</p> 
<pre>void CreateBMPFile(HWND hwnd, LPTSTR pszFile, PBITMAPINFO pbi, 
                  HBITMAP hBMP, HDC hDC) 
 { 
     HANDLE hf;                 // file handle 
    BITMAPFILEHEADER hdr;       // bitmap file-header 
    PBITMAPINFOHEADER pbih;     // bitmap info-header 
    LPBYTE lpBits;              // memory pointer 
    DWORD dwTotal;              // total count of bytes 
    DWORD cb;                   // incremental count of bytes 
    BYTE *hp;                   // byte pointer 
    DWORD dwTmp; 

    pbih = (PBITMAPINFOHEADER) pbi; 
    lpBits = (LPBYTE) GlobalAlloc(GMEM_FIXED, pbih-&gt;biSizeImage);

    if (!lpBits) 
         errhandler("GlobalAlloc", hwnd); 

    // Retrieve the color table (RGBQUAD array) and the bits 
    // (array of palette indices) from the DIB. 
    if (!GetDIBits(hDC, hBMP, 0, (WORD) pbih-&gt;biHeight, lpBits, pbi, 
        DIB_RGB_COLORS)) 
    {
        errhandler("GetDIBits", hwnd); 
    }

    // Create the .BMP file. 
    hf = CreateFile(pszFile, 
                   GENERIC_READ | GENERIC_WRITE, 
                   (DWORD) 0, 
                    NULL, 
                   CREATE_ALWAYS, 
                   FILE_ATTRIBUTE_NORMAL, 
                   (HANDLE) NULL); 
    if (hf == INVALID_HANDLE_VALUE) 
        errhandler("CreateFile", hwnd); 
    hdr.bfType = 0x4d42;        // 0x42 = "B" 0x4d = "M" 
    // Compute the size of the entire file. 
    hdr.bfSize = (DWORD) (sizeof(BITMAPFILEHEADER) + 
                 pbih-&gt;biSize + pbih-&gt;biClrUsed 
                 * sizeof(RGBQUAD) + pbih-&gt;biSizeImage); 
    hdr.bfReserved1 = 0; 
    hdr.bfReserved2 = 0; 

    // Compute the offset to the array of color indices. 
    hdr.bfOffBits = (DWORD) sizeof(BITMAPFILEHEADER) + 
                    pbih-&gt;biSize + pbih-&gt;biClrUsed 
                    * sizeof (RGBQUAD); 

    // Copy the BITMAPFILEHEADER into the .BMP file. 
    if (!WriteFile(hf, (LPVOID) &amp;hdr, sizeof(BITMAPFILEHEADER), 
        (LPDWORD) &amp;dwTmp,  NULL)) 
    {
       errhandler("WriteFile", hwnd); 
    }

    // Copy the BITMAPINFOHEADER and RGBQUAD array into the file. 
    if (!WriteFile(hf, (LPVOID) pbih, sizeof(BITMAPINFOHEADER) 
                  + pbih-&gt;biClrUsed * sizeof (RGBQUAD), 
                  (LPDWORD) &amp;dwTmp, ( NULL)) 
        errhandler("WriteFile", hwnd); 

    // Copy the array of color indices into the .BMP file. 
    dwTotal = cb = pbih-&gt;biSizeImage; 
    hp = lpBits; 
    if (!WriteFile(hf, (LPSTR) hp, (int) cb, (LPDWORD) &amp;dwTmp,NULL)) 
           errhandler("WriteFile", hwnd); 

    // Close the .BMP file. 
     if (!CloseHandle(hf)) 
           errhandler("CloseHandle", hwnd); 

    // Free memory. 
    GlobalFree((HGLOBAL)lpBits);
}</pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ad0bc1384a3fba6c4ddc46495e81a27e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">学习ie5.5的Element Behaviors笔记</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/64674493839da8f661d1893ad7132934/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">CPoint,CSize,CRect类说明</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>