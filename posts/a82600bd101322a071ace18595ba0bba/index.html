<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux framebuffer双缓冲防止闪烁 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Linux framebuffer双缓冲防止闪烁" />
<meta property="og:description" content="昨天写了一篇文章：
使用Linux Framebuffer绘制32位真彩图形： https://blog.csdn.net/dog250/article/details/90113737
并发了朋友圈表示这件事结束了，玩了一天，玩恶心了。
但是我依然是想做出一个可以拖拽的不规则GUI界面(用皮鞋或者小小的照片做界面轮廓)来的。所以半夜就爬起来继续折腾。
无奈，没有找到获取鼠标焦点的好方法，都太复杂，要知道，我是希望在framebuffer上玩啊，不希望依赖那些已经集成在GUI里面的东西。
我不就想模拟个拖拽嘛，简单，用线程控制图片在屏幕上漂移，即：
// setPoint方法已经抽象独立了出来，成为一个static方法，以免main函数太长。 while(true) { setPoint(width, height, xoffset%200, yoffset%50); try { Thread.sleep(100); } catch (InterruptedException e) { } xoffset &#43;= 2; yoffset &#43;= 2; } 这个代码测试下来， 闪烁太厉害了！ 根本就没法看：
怎么办？如果简单的图片漂移都这么闪烁，那如果鼠标拖拽移动图片，结局注定令人遗憾。怎么办？
找根源！根源就是 画图的时间太久了！ 我可是一个像素一个像素画的啊！
当然了，我知道，如果Java通过JNI将一个像素数组传递到本地代码，然后本地代码直接 memcpy，那将是令人赛里布瑞特的。可是我并不知道如何从Java往本地代码传递大数组…另外，我注意是想把事情做纯粹些。 我不想把事情交给库去解决，我要自己解决！ (可能赚钱的经理们又要笑我了，但我就是这样，鄙视业务逻辑。)
利用双缓冲来解决问题。
意思就是说， 逐像素点画图这件耗时的操作，不要直接操作显存，而是操作一块预先分配好的和显存一样大小的缓冲区，等逐点画图完成之后，一次性将该缓冲区的内容memcpy到事先mmap好的显存地址空间。
关于 双缓冲 技术我就不多说了，这技术的解释已经烂大街了，诸如什么流水线相关的形而上解释，看着都烦了，不过确实是那么回事。
直接上代码吧，先看Java代码 Drawimage.java：
import java.awt.image.*; import java.io.*; import javax.imageio.ImageIO; public class Drawimage { static File src = null; static BufferedImage img = null; native static void setFB(int x, int y, int rgb); native static void show(int x); static { System." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/a82600bd101322a071ace18595ba0bba/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-05-12T07:48:33+08:00" />
<meta property="article:modified_time" content="2019-05-12T07:48:33+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux framebuffer双缓冲防止闪烁</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>昨天写了一篇文章：<br> <em><strong>使用Linux Framebuffer绘制32位真彩图形：</strong></em> <a href="https://blog.csdn.net/dog250/article/details/90113737">https://blog.csdn.net/dog250/article/details/90113737</a><br> 并发了朋友圈表示这件事结束了，玩了一天，玩恶心了。</p> 
<p>但是我依然是想做出一个可以拖拽的不规则GUI界面(用皮鞋或者小小的照片做界面轮廓)来的。所以半夜就爬起来继续折腾。</p> 
<p>无奈，没有找到获取鼠标焦点的好方法，都太复杂，要知道，我是希望在framebuffer上玩啊，不希望依赖那些已经集成在GUI里面的东西。</p> 
<p>我不就想模拟个拖拽嘛，简单，用线程控制图片在屏幕上漂移，即：</p> 
<pre><code class="prism language-java"><span class="token comment">// setPoint方法已经抽象独立了出来，成为一个static方法，以免main函数太长。</span>
<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token function">setPoint</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> xoffset<span class="token operator">%</span><span class="token number">200</span><span class="token punctuation">,</span> yoffset<span class="token operator">%</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
		Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>
	xoffset <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span>
	yoffset <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这个代码测试下来， <em><strong>闪烁太厉害了！</strong></em> 根本就没法看：<br> <img src="https://images2.imgbox.com/00/8e/BvGMVwsJ_o.png" alt=""><br> <img src="https://images2.imgbox.com/69/b1/N1O4K9P3_o.png" alt="在这里插入图片描述"></p> 
<p>怎么办？如果简单的图片漂移都这么闪烁，那如果鼠标拖拽移动图片，结局注定令人遗憾。怎么办？</p> 
<p>找根源！根源就是 <em><strong>画图的时间太久了！</strong></em> 我可是一个像素一个像素画的啊！</p> 
<p>当然了，我知道，如果Java通过JNI将一个像素数组传递到本地代码，然后本地代码直接 memcpy，那将是令人赛里布瑞特的。可是我并不知道如何从Java往本地代码传递大数组…另外，我注意是想把事情做纯粹些。 <em><strong>我不想把事情交给库去解决，我要自己解决！</strong></em> (可能赚钱的经理们又要笑我了，但我就是这样，鄙视业务逻辑。)</p> 
<p>利用双缓冲来解决问题。</p> 
<p>意思就是说， <em><strong><font size="4">逐像素点画图这件耗时的操作，不要直接操作显存，而是操作一块预先分配好的和显存一样大小的缓冲区，等逐点画图完成之后，一次性将该缓冲区的内容memcpy到事先mmap好的显存地址空间。</font></strong></em></p> 
<p>关于 <em><strong>双缓冲</strong></em> 技术我就不多说了，这技术的解释已经烂大街了，诸如什么流水线相关的形而上解释，看着都烦了，不过确实是那么回事。</p> 
<p>直接上代码吧，先看Java代码 <em><strong>Drawimage.java</strong></em>：</p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> java<span class="token punctuation">.</span>awt<span class="token punctuation">.</span>image<span class="token punctuation">.</span>*<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>*<span class="token punctuation">;</span>
<span class="token keyword">import</span> javax<span class="token punctuation">.</span>imageio<span class="token punctuation">.</span>ImageIO<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Drawimage</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">static</span> File src <span class="token operator">=</span> null<span class="token punctuation">;</span>
	<span class="token keyword">static</span> BufferedImage img <span class="token operator">=</span> null<span class="token punctuation">;</span>
	<span class="token keyword">native</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setFB</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> <span class="token keyword">int</span> rgb<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">native</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">static</span> <span class="token punctuation">{<!-- --></span>
		System<span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">"setFB"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setPoint</span><span class="token punctuation">(</span><span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> <span class="token keyword">int</span> xoffset<span class="token punctuation">,</span> <span class="token keyword">int</span> yoffset<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> rgb<span class="token punctuation">,</span> a1<span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> width <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> height<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				rgb <span class="token operator">=</span> img<span class="token punctuation">.</span><span class="token function">getRGB</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>
				a1 <span class="token operator">=</span> <span class="token punctuation">(</span>rgb<span class="token operator">&gt;&gt;</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0xFF</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>a1 <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					Drawimage<span class="token punctuation">.</span><span class="token function">setFB</span><span class="token punctuation">(</span>i <span class="token operator">+</span> xoffset<span class="token punctuation">,</span> j <span class="token operator">+</span> yoffset<span class="token punctuation">,</span> rgb<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> xoffset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> yoffset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		src <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		img <span class="token operator">=</span> ImageIO<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>
		width <span class="token operator">=</span> img<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		height <span class="token operator">=</span> img<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">setPoint</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> xoffset<span class="token operator">%</span><span class="token number">200</span><span class="token punctuation">,</span> yoffset<span class="token operator">%</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			Drawimage<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 清空之前的图形</span>
			Drawimage<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 显示当下的图形 </span>
    		<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
				Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 这个时间频率最好和你的显示器刷新频率切合。</span>
			<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>
			xoffset <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// x漂移</span>
			yoffset <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// y漂移</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>再看本地代码 <em><strong>setFB.c</strong></em> ：</p> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;linux/fb.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;jni.h&gt;</span></span>

<span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>mem <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

<span class="token comment">// 定义第二缓冲区</span>
<span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>back_buffer <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> fb_var_screeninfo info<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">setPixel</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> <span class="token keyword">int</span> c<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> idx<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> x <span class="token operator">&gt;=</span> info<span class="token punctuation">.</span>xres <span class="token operator">||</span> y <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> y <span class="token operator">&gt;=</span> info<span class="token punctuation">.</span>yres<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	idx <span class="token operator">=</span> y<span class="token operator">*</span>info<span class="token punctuation">.</span>xres <span class="token operator">+</span> x<span class="token punctuation">;</span>
	<span class="token comment">// 操作第二缓冲区，而不是直接操作显存</span>
	back_buffer<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

JNIEXPORT <span class="token keyword">void</span> JNICALL Java_Drawimage_show <span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jclass class<span class="token punctuation">,</span> <span class="token keyword">int</span> a<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">// show指令下达，说明画图操作已经完成，这里一次性替换显存的内容</span>
	<span class="token comment">// 注意，替换的时机最好是显示器刷新的时机，完美契合！！</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">memcpy</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> back_buffer<span class="token punctuation">,</span> info<span class="token punctuation">.</span>xres<span class="token operator">*</span>info<span class="token punctuation">.</span>yres<span class="token operator">*</span>info<span class="token punctuation">.</span>bits_per_pixel<span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">memset</span><span class="token punctuation">(</span>back_buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span>xres<span class="token operator">*</span>info<span class="token punctuation">.</span>yres<span class="token operator">*</span>info<span class="token punctuation">.</span>bits_per_pixel<span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">memset</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span>xres<span class="token operator">*</span>info<span class="token punctuation">.</span>yres<span class="token operator">*</span>info<span class="token punctuation">.</span>bits_per_pixel<span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

JNIEXPORT <span class="token keyword">void</span> JNICALL Java_Drawimage_setFB <span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jclass class<span class="token punctuation">,</span> jint x<span class="token punctuation">,</span> jint y<span class="token punctuation">,</span> <span class="token keyword">int</span> rgb<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">static</span> <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/fb0"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> FBIOGET_VSCREENINFO<span class="token punctuation">,</span> <span class="token operator">&amp;</span>info<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		info<span class="token punctuation">.</span>bits_per_pixel <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
		info<span class="token punctuation">.</span>xres <span class="token operator">=</span> <span class="token number">800</span><span class="token punctuation">;</span>
		info<span class="token punctuation">.</span>yres <span class="token operator">=</span> <span class="token number">600</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> FBIOPUT_VSCREENINFO<span class="token punctuation">,</span> <span class="token operator">&amp;</span>info<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		mem <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span>xres<span class="token operator">*</span>info<span class="token punctuation">.</span>yres<span class="token operator">*</span>info<span class="token punctuation">.</span>bits_per_pixel<span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">,</span> PROT_READ<span class="token operator">|</span>PROT_WRITE<span class="token punctuation">,</span> MAP_SHARED<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>mem <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"exit\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		back_buffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span>xres<span class="token operator">*</span>info<span class="token punctuation">.</span>yres<span class="token operator">*</span>info<span class="token punctuation">.</span>bits_per_pixel<span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">,</span> PROT_READ<span class="token operator">|</span>PROT_WRITE<span class="token punctuation">,</span> MAP_SHARED<span class="token operator">|</span>MAP_ANONYMOUS<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>back_buffer <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"back_buffer exit\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token function">setPixel</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> rgb<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>动图不闪哦：<br> <img src="https://images2.imgbox.com/37/bc/OCAmo5Yk_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/8d/1b/lognrk0x_o.png" alt="在这里插入图片描述"></p> 
<p>双缓冲的原理就是这么简单。10年前看的的那些冗长的Java代码，都是假的，及其虚假。</p> 
<hr> 
<p>皮鞋?下雨进水，一定会湿，问题的关键不是会不会湿，而是皮鞋进水湿了之后， <em><strong>会不会胖！</strong></em></p> 
<p>浙江温州皮鞋湿，下雨进水不会胖。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e1f7eedae1092f0b70a3f2707e72d099/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">MPlayer移植步骤</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/fe5335e2a40902dcee5cbd036e9bd9b4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">CppCheck C&#43;&#43;静态代码检查工具在Visual Studio(VS)下的配置和使用</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>