<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MySQL的在RC和RR模式下的锁 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="MySQL的在RC和RR模式下的锁" />
<meta property="og:description" content="InnoDB的锁机制：
数据库使用所是为了支持更好的并发，提供数据的完整性和一致性。InnoDB是一个支持锁的存储引擎，锁的类型有：共享锁（S）、排它锁（X）、意向共享锁（IS）、意向排它锁（IX）。为了支持更好的并发，InnoDB提供了非锁定读：不需要等待访问行上的锁释放，读取行的一个快照。该方法是通过InnoDB的一个特写：MVCC实现的。
InnoDB的锁分类：
Record Lock：行锁：单个行记录上的行锁
Gap Lock：间隙锁，锁定一个范围，但不包括记录本身
Next-Key Lock：Gap&#43;Record Lock，锁定一个范围，并且锁定记录本身
无索引&#43;RC/RR
当对无索引的字段进行更新时（RR级别），通过锁主键的方式，来锁住所有记录，RC级别不会锁所有记录。
构建表及初始化数据：
mysql -uroot -p USE test; DROP TABLE IF EXISTS t_none; CREATE TABLE `t_none` ( `id` int(11) NOT NULL, `mem_id` int(11) DEFAULT NULL, PRIMARY KEY (`id`) ) ENGINE=InnoDB; INSERT INTO t_none VALUES(1,1),(3,3),(5,5),(9,9),(11,11); REPEATABLE-READ（RR）默认级别
Session A
Session B
root@localhost[zjkj]:10:53:18&gt;prompt A&gt;&gt;
PROMPT set to &#39;A&gt;&gt;&#39;
A&gt;&gt;select @@session.tx_isolation;
root@localhost[(none)]:11:02:58&gt;prompt B&gt;&gt;
PROMPT set to &#39;B&gt;&gt;&#39;
B&gt;&gt;select @@session.tx_isolation;
A&gt;&gt;begin;
Query OK, 0 rows affected (0." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/326099dc10e91a7dcbc3084a59461bd7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-07-08T15:21:36+08:00" />
<meta property="article:modified_time" content="2019-07-08T15:21:36+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">MySQL的在RC和RR模式下的锁</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div class="artical-content-bak main-content editor-side-new"> 
 <div class="con editor-preview-side" id="result"> 
  <p style="text-indent:0;"><strong><span style="font-family:'宋体';font-size:16px;">InnoDB的</span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">锁机制：</span></span></strong></p> 
  <p style="text-indent:32px;"><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">数据库</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">使用所是为了支持更好的并发，提供</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">数据</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">的完整性和一致性。</span></span><span style="font-family:'宋体';font-size:16px;">InnoD</span><span style="font-family:'宋体';font-size:16px;">B是一个支持锁的存储</span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">引擎</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">，锁的类型有：</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">共享锁</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">（</span></span><span style="font-family:'宋体';font-size:16px;">S</span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">）</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">、</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">排</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">它</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">锁（</span></span><span style="font-family:'宋体';font-size:16px;">X</span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">）</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">、</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">意向</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">共享</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">锁（</span></span><span style="font-family:'宋体';font-size:16px;">IS</span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">）</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">、</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">意向排</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">它</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">锁（</span></span><span style="font-family:'宋体';font-size:16px;">IX</span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">）</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">。</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">为</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">了</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">支持更好的并发，</span>InnoDB提供了</span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">非</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">锁定读：不需要等待访问行上的锁释放，读取行的一个快照。该</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">方法</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">是通过</span>InnoDB的一个特写：MVCC实现的。</span></p> 
  <p style="text-indent:0;"><strong><span style="font-family:'宋体';font-size:16px;">InnoD</span><span style="font-family:'宋体';font-size:16px;">B的</span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">锁</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">分类：</span></span></strong></p> 
  <p style="margin-left:28px;"><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';"></span></span></p> 
  <ul style="list-style-type:disc;" class="list-paddingleft-2"><li><p>Record Lock：行锁：单个行记录上的行锁</p></li><li><p>Gap Lock：间隙锁，锁定一个范围，但不包括记录本身</p></li><li><p>Next-Key Lock：Gap+Record Lock，锁定一个范围，并且锁定记录本身</p><p><br></p><p><br></p></li></ul> 
  <ul style="list-style-type:square;" class="list-paddingleft-2"><li><p style="margin-left:24px;"><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">无</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">索引</span>+RC/RR</span></p></li></ul> 
  <p style="margin-left:28px;text-indent:0;"><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">当</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">对无</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">索引</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">的字段进行更新时</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">（</span>RR</span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">级别</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">）</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">，</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">通过</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">锁主键的方式，来锁住</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">所有</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">记录</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">，</span>R</span><span style="font-family:'宋体';font-size:16px;">C</span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">级别</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">不会</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">锁所有</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">记录。</span></span></p> 
  <p style="margin-left:24px;text-indent:0;"><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">构建</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">表</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">及初始化</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">数据：</span></span></p> 
  <pre><code class="language-sql">mysql -uroot -p
USE test;
DROP TABLE IF EXISTS t_none;
CREATE TABLE `t_none` (
  `id` int(11) NOT NULL,
  `mem_id` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB;
INSERT INTO t_none VALUES(1,1),(3,3),(5,5),(9,9),(11,11);</code></pre> 
  <table width="1084"><tbody><tr class="firstRow"><td rowspan="1" colspan="2" width="957"><p><strong><span style="font-family:Calibri;font-weight:bold;font-size:19px;">REPEATABLE-READ</span></strong><strong><span style="font-family:'宋体';font-weight:bold;font-size:19px;"><span style="font-family:'宋体';">（</span>RR<span style="font-family:'宋体';">）默认</span></span></strong><strong><span style="font-family:Calibri;font-weight:bold;font-size:19px;"><span style="font-family:'宋体';">级别</span></span></strong></p></td></tr><tr><td width="478"><p><span style="font-family:'宋体';font-size:19px;">Session</span><span style="font-family:Calibri;font-size:19px;"> A</span></p></td><td width="479"><p><span style="font-family:'宋体';font-size:19px;">Session</span><span style="font-family:Calibri;font-size:19px;"> B</span></p></td></tr><tr><td width="478"><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">root@localhost[zjkj]:10:53:18&gt;</span><strong><span style="font-family:'Courier New';font-weight:bold;font-size:12px;">prompt A&gt;&gt;</span></strong></p><p style="text-indent:0;background:rgb(190,190,190);"><span style="font-family:'Courier New';font-size:12px;">PROMPT set to 'A&gt;&gt;'</span></p><p><span style="font-family:'Courier New';font-size:12px;">A&gt;&gt;</span><strong><span style="font-family:'Courier New';font-weight:bold;font-size:12px;">select @@session.tx_isolation;</span></strong></p></td><td width="479"><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">root@localhost[(none)]:11:02:58&gt;</span><strong><span style="font-family:'Courier New';font-weight:bold;font-size:12px;">prompt B&gt;&gt;</span></strong></p><p style="text-indent:0;background:rgb(190,190,190);"><span style="font-family:'Courier New';font-size:12px;">PROMPT set to 'B&gt;&gt;'</span></p><p><span style="font-family:'Courier New';font-size:12px;">B&gt;&gt;</span><strong><span style="font-family:'Courier New';font-weight:bold;font-size:12px;">select @@session.tx_isolation;</span></strong></p></td></tr><tr><td width="478"><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">A&gt;&gt;</span><strong><span style="font-family:'Courier New';font-weight:bold;font-size:12px;">begin;</span></strong></p><p><span style="font-family:'Courier New';font-size:11px;">Query OK, 0 rows affected (0.00 sec)</span></p></td><td width="479"><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">B&gt;&gt;</span><strong><span style="font-family:'Courier New';font-weight:bold;font-size:12px;">begin;</span></strong></p><p><span style="font-family:'Courier New';font-size:11px;">Query OK, 0 rows affected (0.00 sec)</span></p></td></tr><tr><td width="478"><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">A&gt;&gt;</span><strong><span style="font-family:'Courier New';font-weight:bold;font-size:12px;">select * from t_none;</span></strong></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">+----+--------+</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">| id | mem_id |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">+----+--------+</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">|  1 |      1 |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">|  3 |      3 |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">|  5 |      5 |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">|  9 |      9 |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">| 11 |     11 |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">+----+--------+</span></p><p><span style="font-family:'Courier New';font-size:11px;">5 rows in set (0.00 sec)</span></p></td><td width="479"><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">B&gt;&gt;</span><strong><span style="font-family:'Courier New';font-weight:bold;font-size:12px;">select * from t_none;</span></strong></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">+----+--------+</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">| id | mem_id |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">+----+--------+</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">|  1 |      1 |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">|  3 |      3 |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">|  5 |      5 |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">|  9 |      9 |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">| 11 |     11 |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">+----+--------+</span></p><p><span style="font-family:'Courier New';font-size:11px;">5 rows in set (0.00 sec)</span></p><p><br></p></td></tr><tr><td width="478"><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">A&gt;&gt;</span><span style="font-family:'宋体';font-size:16px;"> </span><strong><span style="font-family:'Courier New';font-weight:bold;font-size:12px;">select * from t_none where mem_id=3 for update;</span></strong></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">+----+--------+</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">| id | mem_id |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">+----+--------+</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">|  3 |      3 |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">+----+--------+</span></p><p><span style="font-family:'Courier New';font-size:11px;">1 row in set (0.01 sec)</span></p></td><td width="479"><br></td></tr><tr><td width="478"><br></td><td width="479"><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">B&gt;&gt;</span><strong><span style="font-family:'Courier New';font-weight:bold;font-size:12px;">insert into t_none values(2,2);</span></strong></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span></p><p style="text-indent:0;"><strong><span style="font-family:'Courier New';font-weight:bold;font-size:12px;">B&gt;&gt;delete from t_none where id=9;</span></strong></p><p><span style="font-family:'Courier New';font-size:11px;">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span></p></td></tr><tr><td colspan="2" rowspan="1" width="957"><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">show engin inondb status<span style="font-family:'宋体';">部分</span></span><span style="font-family:'Courier New';font-size:12px;"><span style="font-family:'宋体';">输出：</span></span></p><p style="text-indent:0;background:rgb(190,190,190);"><span style="font-family:'Courier New';font-size:12px;">------------</span></p><p style="text-indent:0;background:rgb(190,190,190);"><span style="font-family:'Courier New';font-size:12px;">TRANSACTIONS</span></p><p style="text-indent:0;background:rgb(190,190,190);"><span style="font-family:'Courier New';font-size:12px;">------------</span></p><p style="text-indent:0;background:rgb(190,190,190);"><span style="font-family:'Courier New';font-size:12px;">Trx id counter 10661</span></p><p style="text-indent:0;background:rgb(190,190,190);"><span style="font-family:'Courier New';font-size:12px;">Purge done for trx's n:o &lt; 10659 undo n:o &lt; 0 state: running but idle</span></p><p style="text-indent:0;background:rgb(190,190,190);"><span style="font-family:'Courier New';font-size:12px;">History list length 351</span></p><p style="text-indent:0;background:rgb(190,190,190);"><span style="font-family:'Courier New';font-size:12px;">Total number of lock structs in row lock hash table 2</span></p><p style="text-indent:0;background:rgb(190,190,190);"><span style="font-family:'Courier New';font-size:12px;">LIST OF TRANSACTIONS FOR EACH SESSION:</span></p><p style="text-indent:0;background:rgb(190,190,190);"><span style="font-family:'Courier New';font-size:12px;">---TRANSACTION 10588, not started</span></p><p style="text-indent:0;background:rgb(190,190,190);"><span style="font-family:'Courier New';font-size:12px;">MySQL thread id 4, OS thread handle 0x7f6f5085c700, query id 339 localhost root init</span></p><p style="text-indent:0;background:rgb(190,190,190);"><span style="font-family:'Courier New';font-size:12px;">show engine innodb status</span></p><p style="text-indent:0;background:rgb(190,190,190);"><span style="font-family:'Courier New';font-size:12px;">---TRANSACTION 10660, ACTIVE 17 sec inserting</span></p><p style="text-indent:0;background:rgb(190,190,190);"><span style="font-family:'Courier New';font-size:12px;">mysql tables in use 1, locked 1</span></p><p style="text-indent:0;background:rgb(190,190,190);"><span style="font-family:'Courier New';font-size:12px;">LOCK WAIT 2 lock struct(s), heap size 376, 1 row lock(s)</span></p><p style="text-indent:0;background:rgb(190,190,190);"><span style="font-family:'Courier New';font-size:12px;">MySQL thread id 11, OS thread handle 0x7f6f508de700, query id 338 localhost root update</span></p><p style="text-indent:0;background:rgb(190,190,190);"><span style="font-family:'Courier New';font-size:12px;">insert into t_none values(2,2)</span></p><p style="text-indent:0;background:rgb(190,190,190);"><span style="font-family:'Courier New';font-size:12px;">------- TRX HAS BEEN WAITING 17 SEC FOR THIS LOCK TO BE GRANTED:</span></p><p><span style="font-family:'Courier New';font-size:12px;">RECORD LOCKS space id 68 page no 3 n bits 72 index `</span><strong><span style="font-family:'Courier New';font-weight:bold;font-size:12px;">PRIMARY</span></strong><span style="font-family:'Courier New';font-size:12px;">` of table `test`.`t_none` trx id 10660 lock_mode X locks </span><strong><span style="font-family:'Courier New';font-weight:bold;font-size:12px;">gap</span></strong><span style="font-family:'Courier New';font-size:12px;"> before rec insert intention waiting</span></p></td></tr><tr><td colspan="2" rowspan="1" width="957"><p style="text-indent:0;"><span style="font-size:14px;"><span style="font-family:'宋体';">结论：通过</span><span style="font-family:'宋体';">上面很</span><span style="font-family:'宋体';">容易的</span><span style="font-family:'宋体';">看到，</span><span style="font-family:'宋体';">没有通过</span><span style="font-family:'宋体';">索引</span><span style="font-family:'宋体';">for</span><span style="font-family:'Courier New';"> update<span style="font-family:'宋体';">时，当进行</span></span><span style="font-family:'宋体';">增</span><span style="font-family:'宋体';">删</span><span style="font-family:'宋体';">改</span><span style="font-family:'宋体';">都会</span><span style="font-family:'宋体';"><span style="font-family:'宋体';">锁住，</span>MySQL</span><span style="font-family:'宋体';">内部会</span><span style="font-family:'宋体';">通过基于</span><strong><span style="font-weight:bold;font-family:'宋体';">锁</span></strong><strong><span style="font-weight:bold;font-family:'宋体';">默认</span></strong><strong><span style="font-weight:bold;font-family:'宋体';">主键</span></strong><strong><span style="font-weight:bold;font-family:'宋体';">方式</span></strong><strong><span style="font-weight:bold;font-family:'宋体';">，</span></strong><strong><span style="font-weight:bold;font-family:'宋体';">对所有</span></strong><strong><span style="font-family:'Courier New';font-weight:bold;"><span style="font-family:'宋体';">记录加</span>X<span style="font-family:'宋体';">锁</span></span></strong><span style="font-family:'宋体';">。</span></span></p><p><span style="font-size:14px;"><span style="font-size:14px;font-family:'宋体';">下面</span><span style="font-family:'Courier New';font-size:12px;"><span style="font-size:14px;font-family:'宋体';">是</span>RC<span style="font-size:14px;font-family:'宋体';">级别的实验</span></span></span></p><br></td></tr><tr><td colspan="2" rowspan="1" width="957"><p><strong><span style="font-family:'宋体';font-weight:bold;font-size:13px;">Read</span></strong><strong><span style="font-family:'Courier New';font-weight:bold;font-size:13px;"> Committed<span style="font-family:'宋体';">级别</span></span></strong><strong><span style="font-family:'宋体';font-weight:bold;font-size:13px;"><span style="font-family:'宋体';">（</span>RC<span style="font-family:'宋体';">）</span></span></strong></p></td></tr><tr><td colspan="1" rowspan="1" width="478"><p><span style="font-family:'宋体';font-size:12px;">Session</span><span style="font-family:'Courier New';font-size:12px;"> A</span></p></td><td colspan="1" rowspan="1" width="479"><p><span style="font-family:'宋体';font-size:12px;">Session</span><span style="font-family:'Courier New';font-size:12px;"> B</span></p></td></tr><tr><td colspan="1" rowspan="1" width="478"><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">A&gt;&gt;set @@session.tx_isolation="read-committed";</span></p><p><span style="font-family:'Courier New';font-size:11px;">Query OK, 0 rows affected (0.00 sec)</span></p></td><td colspan="1" rowspan="1" width="479"><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">B&gt;&gt;set @@session.tx_isolation="read-committed";</span></p><p><span style="font-family:'Courier New';font-size:11px;">Query OK, 0 rows affected (0.00 sec)</span></p></td></tr><tr><td colspan="1" rowspan="1" width="478"><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">A&gt;&gt;select @@session.tx_isolation;</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">+------------------------+</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">| @@session.tx_isolation |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">+------------------------+</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">| READ-COMMITTED         |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">+------------------------+</span></p><p><span style="font-family:'Courier New';font-size:11px;">1 row in set (0.00 sec)</span></p></td><td colspan="1" rowspan="1" width="479"><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">B&gt;&gt;select @@session.tx_isolation;</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">+------------------------+</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">| @@session.tx_isolation |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">+------------------------+</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">| READ-COMMITTED         |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">+------------------------+</span></p><p><span style="font-family:'Courier New';font-size:11px;">1 row in set (0.01 sec)</span></p></td></tr><tr><td colspan="1" rowspan="1" width="478"><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">A&gt;&gt;</span><strong><span style="font-family:'Courier New';font-weight:bold;font-size:12px;">begin;</span></strong></p><p><span style="font-family:'Courier New';font-size:11px;">Query OK, 0 rows affected (0.00 sec)</span></p></td><td colspan="1" rowspan="1" width="479"><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">B&gt;&gt;</span><strong><span style="font-family:'Courier New';font-weight:bold;font-size:12px;">begin;</span></strong></p><p><span style="font-family:'Courier New';font-size:11px;">Query OK, 0 rows affected (0.00 sec)</span></p></td></tr><tr><td colspan="1" rowspan="1" width="478"><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">A&gt;&gt;select * from t_none where mem_id=3 for update;</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">+----+--------+</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">| id | mem_id |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">+----+--------+</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">|  3 |      3 |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">+----+--------+</span></p><p><span style="font-family:'Courier New';font-size:11px;">1 row in set (0.01 sec)</span></p></td><td colspan="1" rowspan="1" width="479"><br></td></tr><tr><td colspan="1" rowspan="1" width="478"><br></td><td colspan="1" rowspan="1" width="479"><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">B&gt;&gt;insert into t_none values(2,2);</span></p><p><span style="font-family:'Courier New';font-size:11px;">Query OK, 1 row affected (0.01 sec)</span></p></td></tr><tr><td colspan="1" rowspan="1" width="478"><br></td><td colspan="1" rowspan="1" width="479"><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">B&gt;&gt;select * from t_none;</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">+----+--------+</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">| id | mem_id |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">+----+--------+</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">|  1 |      1 |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">|  2 |      2 |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">|  3 |      3 |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">|  5 |      5 |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">|  9 |      9 |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">| 11 |     11 |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">+----+--------+</span></p><p><span style="font-family:'Courier New';font-size:11px;">6 rows in set (0.00 sec</span></p></td></tr><tr><td colspan="1" rowspan="1" width="478"><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">A&gt;&gt;</span><strong><span style="font-family:'Courier New';font-weight:bold;font-size:12px;">rollback;</span></strong></p><p><span style="font-family:'Courier New';font-size:11px;">Query OK, 0 rows affected (0.00 sec)</span></p></td><td colspan="1" rowspan="1" width="479"><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">B&gt;&gt;</span><strong><span style="font-family:'Courier New';font-weight:bold;font-size:12px;">rollback;</span></strong></p><p><span style="font-family:'Courier New';font-size:11px;">Query OK, 0 rows affected (0.00 sec)</span></p></td></tr><tr><td colspan="2" rowspan="1" width="957"><p><strong><span style="font-family:'宋体';font-weight:bold;font-size:12px;"><span style="font-family:'宋体';">结论：在</span></span></strong><strong><span style="font-family:'Courier New';font-weight:bold;font-size:12px;">RC<span style="font-family:'宋体';">级别下，事务</span><span style="font-family:'Courier New';">B</span><span style="font-family:'宋体';">是可以进行增删改</span></span></strong><strong><span style="font-family:'宋体';font-weight:bold;font-size:12px;"><span style="font-family:'宋体';">（除被</span></span></strong><strong><span style="font-family:'Courier New';font-weight:bold;font-size:12px;"><span style="font-family:'宋体';">锁定的</span></span></strong><strong><span style="font-family:'宋体';font-weight:bold;font-size:12px;"><span style="font-family:'宋体';">记录</span></span></strong><strong><span style="font-family:'Courier New';font-weight:bold;font-size:12px;"><span style="font-family:'宋体';">本身</span></span></strong><strong><span style="font-family:'宋体';font-weight:bold;font-size:12px;"><span style="font-family:'宋体';">）</span></span></strong></p></td></tr></tbody></table> 
  <ul style="list-style-type:square;" class="list-paddingleft-2"><li><p style="margin-left:24px;"><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">非唯一</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">索引</span></span><span style="font-family:'宋体';font-size:16px;">+</span><span style="font-family:'宋体';font-size:16px;">RR/RC</span></p></li></ul> 
  <p style="text-indent:0;"><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">  在</span></span><span style="font-family:'宋体';font-size:16px;">RR级别下</span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">，</span></span><span style="font-family:'宋体';font-size:16px;">InnoDB对于非唯一索引会加Gap Lock</span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">（也即</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">锁定一个区间</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">），而</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">在</span>RC</span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">级别</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">下</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">无</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">。</span></span></p> 
  <p style="text-indent:8px;"><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">构造</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">初始化表</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">及</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">数据</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">：</span></span></p> 
  <pre><code class="language-sql">mysql -uroot -p
USE test;
DROP TABLE IF EXISTS t_idx;
CREATE TABLE `t_idx` (
  `id` int(11) NOT NULL,
  `mem_id` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`),
   KEY `idx_mem_id` (`mem_id`)
) ENGINE=InnoDB;
INSERT INTO t_idx VALUES(1,1),(3,3),(5,5),(9,9),(11,11);</code></pre> 
  <p><br></p> 
  <table width="1084"><tbody><tr class="firstRow"><td rowspan="1" colspan="2" width="957"><strong><span style="font-family:Calibri;font-size:19px;">REPEATABLE-READ</span></strong><strong><span style="font-family:'宋体';font-size:19px;">（RR）默认</span></strong><strong><span style="font-family:Calibri;font-size:19px;"><span style="font-family:'宋体';">级别</span></span></strong><strong><span style="font-family:'宋体';font-size:19px;">（RR模式）</span></strong></td></tr><tr><td width="478"><p><span style="font-family:'宋体';font-size:19px;">Session</span><span style="font-family:Calibri;font-size:19px;"> A</span></p></td><td width="479"><p><span style="font-family:'宋体';font-size:19px;">Session</span><span style="font-family:Calibri;font-size:19px;"> B</span></p></td></tr><tr><td width="478"><p><span style="font-family:Calibri;font-size:14px;">root@localhost[(none)]:06:01:59&gt;use test;</span></p><p style="text-indent:0;"><span style="font-size:12px;"><span style="font-family:'Courier New';font-size:12px;">root@localhost[zjkj]:10:53:18&gt;</span><strong><span style="font-family:'Courier New';font-size:12px;">prompt A&gt;&gt;</span></strong></span></p><p style="text-indent:0;background:rgb(190,190,190);"><span style="font-family:'Courier New';font-size:12px;">PROMPT set to 'A&gt;&gt;'</span></p></td><td width="479"><p><span style="font-family:Calibri;font-size:12px;">root@localhost[(none)]:06:01:59&gt;use test;</span></p><p style="text-indent:0;"><span style="font-size:12px;"><span style="font-family:'Courier New';font-size:12px;">root@localhost[(none)]:11:02:58&gt;</span><strong><span style="font-family:'Courier New';font-size:12px;">prompt B&gt;&gt;</span></strong></span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">PROMPT set to 'B&gt;&gt;'</span></p></td></tr><tr><td width="478"><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">A&gt;&gt;select @@session.tx_isolation;</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">+------------------------+</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">| @@session.tx_isolation |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">+------------------------+</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">| REPEATABLE-READ        |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">+------------------------+</span></p><p><span style="font-family:'Courier New';font-size:12px;">1 row in set (0.00 sec)</span></p></td><td width="479"><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">B&gt;&gt;select @@session.tx_isolation;</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">+------------------------+</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">| @@session.tx_isolation |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">+------------------------+</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">| REPEATABLE-READ        |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">+------------------------+</span></p><p><span style="font-family:'Courier New';font-size:12px;">1 row in set (0.02 sec)</span></p></td></tr><tr><td width="478"><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">A&gt;&gt;</span><strong><span style="font-family:'Courier New';font-size:12px;">begin;</span></strong></p><p><span style="font-family:'Courier New';font-size:11px;">Query OK, 0 rows affected (0.00 sec)</span></p></td><td width="479"><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">B&gt;&gt;</span><strong><span style="font-family:'Courier New';font-size:12px;">begin;</span></strong></p><p><span style="font-family:'Courier New';font-size:11px;">Query OK, 0 rows affected (0.00 sec)</span></p></td></tr><tr><td width="478"><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">A&gt;&gt;</span><strong><span style="font-family:'Courier New';font-size:12px;">select * from </span></strong><span style="font-family:'Courier New';font-size:13px;">t_idx</span><strong><span style="font-family:'Courier New';font-size:12px;">;</span></strong></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">+----+--------+</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">| id | mem_id |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">+----+--------+</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">|  1 |      1 |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">|  3 |      3 |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">|  5 |      5 |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">|  9 |      9 |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">| 11 |     11 |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">+----+--------+</span></p><p><span style="font-family:'Courier New';font-size:12px;">5 rows in set (0.04 sec)</span></p></td><td width="479"><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">B&gt;&gt;</span><strong><span style="font-family:'Courier New';font-size:12px;">select * from </span></strong><span style="font-family:'Courier New';font-size:13px;">t_idx</span><strong><span style="font-family:'Courier New';font-size:12px;">;</span></strong></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;background:rgb(190,190,190);">+----+--------+</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;background:rgb(190,190,190);">| id | mem_id |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;background:rgb(190,190,190);">+----+--------+</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;background:rgb(190,190,190);">|  1 |      1 |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;background:rgb(190,190,190);">|  3 |      3 |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;background:rgb(190,190,190);">|  5 |      5 |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;background:rgb(190,190,190);">|  9 |      9 |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;background:rgb(190,190,190);">| 11 |     11 |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;background:rgb(190,190,190);">+----+--------+</span></p><p><span style="font-family:'Courier New';font-size:11px;background:rgb(190,190,190);">5 rows in set (0.00 sec)</span></p></td></tr><tr><td width="478"><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">A&gt;&gt;</span><strong><span style="font-family:'Courier New';font-size:12px;">select * from t_idx where mem_id=3 for update;</span></strong></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">+----+--------+</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">| id | mem_id |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">+----+--------+</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">|  3 |      3 |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">+----+--------+</span></p><p><span style="font-family:'Courier New';font-size:12px;">1 row in set (0.05 sec)</span></p></td><td width="479"><br></td></tr><tr><td width="478"><br></td><td width="479"><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">B&gt;&gt;</span><strong><span style="font-family:'Courier New';font-size:12px;">insert into t_idx values(2,2);</span></strong></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';color:rgb(255,0,0);font-size:11px;">#</span><span style="font-family:'宋体';color:rgb(255,0,0);font-size:11px;"><span style="font-family:'宋体';">问题</span></span><span style="font-family:'Courier New';color:rgb(255,0,0);font-size:11px;"><span style="font-family:'宋体';">？这里为什么会</span></span><span style="font-family:'宋体';color:rgb(255,0,0);font-size:11px;"><span style="font-family:'宋体';">出现</span></span><span style="font-family:'Courier New';color:rgb(255,0,0);font-size:11px;"><span style="font-family:'宋体';">阻塞呢？</span></span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">B&gt;&gt;</span><strong><span style="font-family:'Courier New';font-size:12px;">insert into t_idx values(4,4);</span></strong></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';color:rgb(255,0,0);font-size:11px;">#</span><span style="font-family:'宋体';color:rgb(255,0,0);font-size:11px;"><span style="font-family:'宋体';">问题</span></span><span style="font-family:'Courier New';color:rgb(255,0,0);font-size:11px;"><span style="font-family:'宋体';">？这里为什么会</span></span><span style="font-family:'宋体';color:rgb(255,0,0);font-size:11px;"><span style="font-family:'宋体';">出现</span></span><span style="font-family:'Courier New';color:rgb(255,0,0);font-size:11px;"><span style="font-family:'宋体';">阻塞呢？</span></span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">B&gt;&gt;</span><strong><span style="font-family:'Courier New';font-size:11px;">insert into t_idx values(3,3);</span></strong></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">B&gt;&gt;</span><strong><span style="font-family:'Courier New';font-size:11px;">insert into t_idx values(5,5);</span></strong></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">ERROR 1062 (23000): Duplicate entry '5' for key 'PRIMARY'</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">B&gt;&gt;</span><strong><span style="font-family:'Courier New';font-size:11px;">insert into t_idx values(1,1);</span></strong></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:10px;">ERROR 1062 (23000): Duplicate entry '1' for key 'PRIMARY'</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:10px;">#######<span style="font-family:'宋体';">下面</span></span><span style="font-family:'宋体';font-size:10px;"><span style="font-family:'宋体';">插入</span></span><span style="font-family:'Courier New';font-size:10px;"><span style="font-family:'宋体';">全部可以</span></span><span style="font-family:'宋体';font-size:10px;">#</span><span style="font-family:'Courier New';font-size:10px;">#####</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">B&gt;&gt;</span><strong><span style="font-family:'Courier New';font-size:12px;">insert into t_idx values(6,6);</span></strong></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">Query OK, 1 row affected (0.00 sec)</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">B&gt;&gt;</span><strong><span style="font-family:'Courier New';font-size:12px;">insert into t_idx values(7,7);</span></strong></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">B&gt;&gt;</span><strong><span style="font-family:'Courier New';font-size:12px;">insert into t_idx values(8,8);</span></strong></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:11px;">Query OK, 1 row affected (0.01 sec)</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">B&gt;&gt;</span><strong><span style="font-family:'Courier New';font-size:12px;">insert into t_idx values(12,12);</span></strong></p><p><span style="font-family:'Courier New';font-size:11px;">Query OK, 1 row affected (0.00 sec)</span></p></td></tr><tr><td width="478"><br></td><td width="479"><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">B&gt;&gt;select * from t_idx;</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">+----+--------+</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">| id | mem_id |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">+----+--------+</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">|  1 |      1 |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">|  3 |      3 |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">|  5 |      5 |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">|  6 |      6 |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">|  7 |      7 |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">|  8 |      8 |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">|  9 |      9 |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">| 11 |     11 |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">| 12 |     12 |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">+----+--------+</span></p><p><span style="font-family:'Courier New';font-size:12px;">9 rows in set (0.00 sec)</span></p></td></tr><tr><td colspan="2" rowspan="1" width="957"><span style="font-size:10px;">show engin<span style="font-family:'Courier New';">e</span><span style="font-family:'宋体';"> inondb status部分</span><span style="font-family:'宋体';">输出：</span></span><p style="text-indent:0;background:rgb(190,190,190);"><span style="font-family:'Courier New';font-size:12px;">------------</span></p><p style="text-indent:0;background:rgb(190,190,190);"><span style="font-family:'Courier New';font-size:12px;">TRANSACTIONS</span></p><p style="text-indent:0;background:rgb(190,190,190);"><span style="font-family:'Courier New';font-size:12px;">------------</span></p><p style="text-indent:0;background:rgb(190,190,190);"><span style="font-family:'Courier New';font-size:12px;">Trx id counter 11044</span></p><p style="text-indent:0;background:rgb(190,190,190);"><span style="font-family:'Courier New';font-size:12px;">Purge done for trx's n:o &lt; 11041 undo n:o &lt; 0 state: running but idle</span></p><p style="text-indent:0;background:rgb(190,190,190);"><span style="font-family:'Courier New';font-size:12px;">History list length 372</span></p><p style="text-indent:0;background:rgb(190,190,190);"><span style="font-family:'Courier New';font-size:12px;">Total number of lock structs in row lock hash table 5</span></p><p style="text-indent:0;background:rgb(190,190,190);"><span style="font-family:'Courier New';font-size:12px;">LIST OF TRANSACTIONS FOR EACH SESSION:</span></p><p style="text-indent:0;background:rgb(190,190,190);"><span style="font-family:'Courier New';font-size:12px;">---TRANSACTION 0, not started</span></p><p style="text-indent:0;background:rgb(190,190,190);"><span style="font-family:'Courier New';font-size:12px;">MySQL thread id 3, OS thread handle 0x7fd0430df700, query id 47 localhost root init</span></p><p style="text-indent:0;background:rgb(190,190,190);"><span style="font-family:'Courier New';font-size:12px;">show engine innodb status</span></p><p style="text-indent:0;background:rgb(190,190,190);"><span style="font-family:'Courier New';font-size:12px;">---TRANSACTION 11039, ACTIVE 228 sec inserting</span></p><p style="text-indent:0;background:rgb(190,190,190);"><span style="font-family:'Courier New';font-size:12px;">mysql tables in use 1, locked 1</span></p><p style="text-indent:0;background:rgb(190,190,190);"><span style="font-family:'Courier New';font-size:12px;">LOCK WAIT 3 lock struct(s), heap size 1248, 3 row lock(s), undo log entries 4</span></p><p style="text-indent:0;background:rgb(190,190,190);"><span style="font-family:'Courier New';font-size:12px;">MySQL thread id 1, OS thread handle 0x7fd064099700, query id 45 localhost root update</span></p><p style="text-indent:0;background:rgb(190,190,190);"><span style="font-family:'Courier New';font-size:12px;">insert into t_idx values(4,4)</span></p><p style="text-indent:0;background:rgb(190,190,190);"><span style="font-family:'Courier New';font-size:12px;">Trx read view will not see trx with id &gt;= 11040, sees &lt; 11038</span></p><p style="text-indent:0;background:rgb(190,190,190);"><span style="font-family:'Courier New';font-size:12px;">------- TRX HAS BEEN WAITING 22 SEC FOR THIS LOCK TO BE GRANTED:</span></p><p><span style="font-family:'Courier New';font-size:12px;">RECORD LOCKS space id 70 page no 4 n bits 80 index `idx_mem_id` of table `</span><strong><span style="font-family:'Courier New';font-size:12px;">test`.`t_idx` trx id 11039 lock_mode X locks </span></strong><strong><span style="font-family:'Courier New';color:rgb(255,0,0);font-size:12px;">gap</span></strong><strong><span style="font-family:'Courier New';font-size:12px;"> before rec insert intention waitin</span></strong></p></td></tr><tr><td colspan="2" rowspan="1" width="957"><span style="font-size:12px;">结论：<span style="font-family:'宋体';">通过</span><span style="font-family:'宋体';">上面可以看到，</span><span style="font-family:'宋体';">通过</span><span style="font-family:'宋体';">非</span><span style="font-family:'宋体';">唯一</span><span style="font-family:'宋体';">索引字段</span><span style="font-family:'宋体';">进行</span><span style="font-family:'宋体';">更新时，</span><span style="font-family:'宋体';">在</span><span style="font-family:'宋体';">进行增删改时，有</span><span style="font-family:'宋体';">的</span><span style="font-family:'宋体';">记录会出现阻塞，为什么会出现阻塞呢？</span><span style="font-family:'宋体';">其实</span><span style="font-family:'宋体';">就是用</span><span style="font-family:'宋体';">到</span><span style="font-family:'Courier New';"><span style="font-family:'宋体';">了</span>MySQL</span><span style="font-family:'宋体';">的</span><span style="font-family:'宋体';">间隙锁</span><span style="font-family:'宋体';">。那</span><span style="font-family:'Courier New';">MySQL<span style="font-family:'宋体';">这里为什么要用间隙锁呢？目的主要是防止幻读。</span></span><span style="font-family:'宋体';"> 那为什么</span><span style="font-family:'宋体';">有的记录</span><span style="font-family:'宋体';">可以</span><span style="font-family:'宋体';">插入有的不可以，</span><span style="font-family:'宋体';">因为</span><span style="font-family:'Courier New';">InnoDB<span style="font-family:'宋体';">对于行的查询时采用了</span>Next-Key Lock<span style="font-family:'宋体';">的算法</span></span><span style="font-family:'宋体';">，</span><span style="font-family:'宋体';">锁定的是一个范围（</span><span style="font-family:'宋体';">GAP</span><span style="font-family:'宋体';">）</span><span style="font-family:'宋体';">如下</span><span style="font-family:'宋体';">：（</span><span style="font-family:'宋体';">∞,1]，(</span><span style="font-family:'Courier New';">1</span><span style="font-family:'宋体';">,</span><span style="font-family:'Courier New';">3</span><span style="font-family:'宋体';">]，(</span><span style="font-family:'Courier New';">3</span><span style="font-family:'宋体';">,</span><span style="font-family:'Courier New';">5</span><span style="font-family:'宋体';">]，(</span><span style="font-family:'Courier New';">5</span><span style="font-family:'宋体';">,</span><span style="font-family:'Courier New';">9</span><span style="font-family:'宋体';">]，(</span><span style="font-family:'Courier New';">9</span><span style="font-family:'宋体';">,</span><span style="font-family:'Courier New';">11</span><span style="font-family:'宋体';">]，(</span><span style="font-family:'Courier New';">11</span><span style="font-family:'宋体';">, ∞</span><span style="font-family:'Courier New';">)</span><span style="font-family:'宋体';">。InnoDB</span><span style="font-family:'Courier New';"><span style="font-family:'宋体';">对辅助索引下一个键值也要加上</span>Gap Lock<span style="font-family:'宋体';">，</span></span><span style="font-family:'宋体';">例如</span><span style="font-family:'宋体';">上面进行插入</span><span style="font-family:'宋体';">2、<span style="font-family:'Courier New';">4</span>、<span style="font-family:'Courier New';">1</span>、<span style="font-family:'Courier New';">3</span>、<span style="font-family:'Courier New';">5</span>时</span><span style="font-family:'宋体';">，就可以看出</span><span style="font-family:'宋体';">，</span><span style="font-family:'Courier New';"><span style="font-family:'宋体';">其实锁住的区间是</span>(1,5)</span><span style="font-family:'宋体';">。</span></span></td></tr><tr><td colspan="2" rowspan="1" width="957"><strong><span style="font-family:'宋体';font-size:12px;">Read</span></strong><strong><span style="font-family:'Courier New';font-size:12px;"> Committed<span style="font-family:'宋体';">级别</span></span></strong><strong><span style="font-family:'宋体';font-size:12px;">（RC）</span></strong></td></tr><tr><td colspan="1" rowspan="1" width="478"><p><span style="font-family:'宋体';font-size:12px;">Session</span><span style="font-family:'Courier New';font-size:12px;"> A</span></p></td><td colspan="1" rowspan="1" width="479"><p><span style="font-family:'宋体';font-size:12px;">Session</span><span style="font-family:'Courier New';font-size:12px;"> B</span></p></td></tr><tr><td colspan="1" rowspan="1" width="478"><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">A&gt;&gt;</span><strong><span style="font-family:'Courier New';font-size:12px;">rollback;</span></strong></p><p><span style="font-family:'Courier New';font-size:12px;">Query OK, 0 rows affected (0.00 sec)</span></p></td><td colspan="1" rowspan="1" width="479"><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">B&gt;&gt;</span><strong><span style="font-family:'Courier New';font-size:12px;">rollback;</span></strong></p><p><span style="font-family:'Courier New';font-size:12px;">Query OK, 0 rows affected (0.00 sec)</span></p></td></tr><tr><td colspan="1" rowspan="1" width="478"><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">A&gt;&gt;</span><strong><span style="font-family:'Courier New';font-size:12px;">set @@session.tx_isolation="read-committed";</span></strong></p><p><span style="font-family:'Courier New';font-size:12px;">Query OK, 0 rows affected (0.00 sec)</span></p></td><td colspan="1" rowspan="1" width="479"><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">B&gt;&gt;</span><strong><span style="font-family:'Courier New';font-size:12px;">set @@session.tx_isolation="read-committed";</span></strong></p><p><span style="font-family:'Courier New';font-size:12px;">Query OK, 0 rows affected (0.00 sec)</span></p></td></tr><tr><td colspan="1" rowspan="1" width="478"><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">A&gt;&gt;</span><strong><span style="font-family:'Courier New';font-size:12px;">select @@session.tx_isolation;</span></strong></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">+------------------------+</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">| @@session.tx_isolation |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">+------------------------+</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">| READ-COMMITTED         |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">+------------------------+</span></p><p><span style="font-family:'Courier New';font-size:12px;">1 row in set (0.00 sec)</span></p></td><td colspan="1" rowspan="1" width="479"><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">B&gt;&gt;</span><strong><span style="font-family:'Courier New';font-size:12px;">select @@session.tx_isolation;</span></strong></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">+------------------------+</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">| @@session.tx_isolation |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">+------------------------+</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">| READ-COMMITTED         |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">+------------------------+</span></p><p><span style="font-family:'Courier New';font-size:12px;">1 row in set (0.01 sec)</span></p></td></tr><tr><td colspan="1" rowspan="1" width="478"><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">A&gt;&gt;</span><strong><span style="font-family:'Courier New';font-size:12px;">begin;</span></strong></p><p><span style="font-family:'Courier New';font-size:12px;">Query OK, 0 rows affected (0.00 sec)</span></p></td><td colspan="1" rowspan="1" width="479"><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">B&gt;&gt;</span><strong><span style="font-family:'Courier New';font-size:12px;">begin;</span></strong></p><p><span style="font-family:'Courier New';font-size:12px;">Query OK, 0 rows affected (0.00 sec)</span></p></td></tr><tr><td colspan="1" rowspan="1" width="478"><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">A&gt;&gt;</span><strong><span style="font-family:'Courier New';font-size:12px;">select * from t_idx where mem_id=3 for update;</span></strong></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">+----+--------+</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">| id | mem_id |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">+----+--------+</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">|  1 |      3 |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">|  3 |      3 |</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">+----+--------+</span></p><p><span style="font-family:'Courier New';font-size:12px;">2 rows in set (0.00 sec)</span></p></td><td colspan="1" rowspan="1" width="479"><br></td></tr><tr><td colspan="1" rowspan="1" width="478"><br></td><td colspan="1" rowspan="1" width="479"><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">B&gt;&gt;</span><strong><span style="font-family:'Courier New';font-size:12px;">insert into t_idx values(1,1);</span></strong></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">ERROR 1062 (23000): Duplicate entry '1' for key 'PRIMARY'</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">B&gt;&gt;</span><strong><span style="font-family:'Courier New';font-size:12px;">insert into t_idx values(2,2);</span></strong></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">Query OK, 1 row affected (0.00 sec)</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">B&gt;&gt;</span><strong><span style="font-family:'Courier New';font-size:12px;">insert into t_idx values(3,3);</span></strong></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span></p><p style="text-indent:0;"><span style="font-family:'Courier New';font-size:12px;">B&gt;&gt;</span><strong><span style="font-family:'Courier New';font-size:12px;">insert into t_idx values(4,4);</span></strong></p><p><span style="font-family:'Courier New';font-size:12px;">Query OK, 1 row affected (0.01 sec)</span></p></td></tr><tr><td colspan="2" rowspan="1" width="957"><span style="font-size:14px;"><strong><span style="font-family:'宋体';">结论：在</span></strong><strong><span style="font-family:'Courier New';">RC<span style="font-family:'宋体';">级别下，事务</span>B<span style="font-family:'宋体';">是可以进行增删改</span></span></strong><strong><span style="font-family:'宋体';">（除被</span></strong><strong><span style="font-family:'宋体';">锁定的</span></strong><strong><span style="font-family:'宋体';">记录</span></strong><strong><span style="font-family:'宋体';">本身</span></strong><strong><span style="font-family:'宋体';">），</span></strong><strong><span style="font-family:'宋体';">没有出现间隙锁的</span></strong><strong><span style="font-family:'宋体';">现象</span></strong><strong><span style="font-family:'宋体';">。</span></strong></span></td></tr></tbody></table> 
  <p><br></p> 
  <ul class="list-paddingleft-2" style="list-style-type:square;"><li><p style="text-indent:0;"><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">唯一</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">索引</span>+RR/RC</span></p></li></ul> 
  <p><span style="font-family:'宋体';font-size:19px;"><span style="font-family:'宋体';">构造</span></span><span style="font-family:Calibri;font-size:19px;"><span style="font-family:'宋体';">初始</span></span><span style="font-family:'宋体';font-size:19px;"><span style="font-family:'宋体';">化</span></span><span style="font-family:Calibri;font-size:19px;"><span style="font-family:'宋体';">表</span></span><span style="font-family:'宋体';font-size:19px;"><span style="font-family:'宋体';">及</span></span><span style="font-family:Calibri;font-size:19px;"><span style="font-family:'宋体';">数据</span></span><span style="font-family:'宋体';font-size:19px;"><span style="font-family:'宋体';">：</span></span></p> 
  <pre><code class="language-sql">mysql -uroot –p
use test;
DROP TABLE IF EXISTS t_pk;
CREATE TABLE `t_pk` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `mem_id` int(11) NOT NULL ,
  PRIMARY KEY (`id`),
  UNIQUE  `uq_mem_id` (`mem_id`)
) ENGINE=InnoDB;
INSERT INTO t_pk VALUES(1,1),(3,3),(5,5),(9,9),(11,11);</code></pre> 
  <table width="1084"><tbody><tr class="firstRow"><td rowspan="1" colspan="2" width="957"><strong>REPEATABLE READ<span style="font-family:'宋体';">（</span><span style="font-family:Calibri;">RR</span><span style="font-family:Calibri;font-size:19px;"><span style="font-family:'宋体';">级别</span></span><span style="font-family:'宋体';font-size:19px;">）</span></strong></td></tr><tr><td width="478"><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">root@localhost[(none)]:10:04:34&gt;use test;</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">root@localhost[test]:10:04:41&gt;prompt A&gt;&gt;</span></p><p><span style="font-family:Calibri;font-size:12px;">PROMPT set to 'A&gt;&gt;'</span></p></td><td width="479"><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">root@localhost[(none)]:10:04:37&gt;use test;</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">root@localhost[test]:10:04:52&gt;prompt B&gt;&gt;</span></p><p><span style="font-family:Calibri;font-size:12px;">PROMPT set to 'B&gt;&gt;'</span></p></td></tr><tr><td width="478"><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">A&gt;&gt;select @@session.tx_isolation;</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">+------------------------+</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">| @@session.tx_isolation |</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">+------------------------+</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">| REPEATABLE-READ        |</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">+------------------------+</span></p><p><span style="font-family:Calibri;font-size:12px;">1 row in set (0.01 sec)</span></p></td><td width="479"><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">B&gt;&gt;select @@session.tx_isolation;</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">+------------------------+</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">| @@session.tx_isolation |</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">+------------------------+</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">| REPEATABLE-READ        |</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">+------------------------+</span></p><p><span style="font-family:Calibri;font-size:12px;">1 row in set (0.00 sec)</span></p></td></tr><tr><td width="478"><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">A&gt;&gt;begin;</span></p><p><span style="font-family:Calibri;font-size:12px;">Query OK, 0 rows affected (0.00 sec)</span></p></td><td width="479"><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">B&gt;&gt;begin;</span></p><p><span style="font-family:Calibri;font-size:12px;">Query OK, 0 rows affected (0.00 sec)</span></p></td></tr><tr><td width="478"><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">A&gt;&gt;select * from t_pk;</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">+----+--------+</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">| id | mem_id |</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">+----+--------+</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">|  1 |      1 |</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">|  3 |      3 |</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">|  5 |      5 |</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">|  9 |      9 |</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">| 11 |     11 |</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">+----+--------+</span></p><p><span style="font-family:Calibri;font-size:12px;">5 rows in set (0.00 sec)</span></p></td><td width="479"><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">B&gt;&gt;select * from t_pk;</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">+----+--------+</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">| id | mem_id |</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">+----+--------+</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">|  1 |      1 |</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">|  3 |      3 |</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">|  5 |      5 |</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">|  9 |      9 |</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">| 11 |     11 |</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">+----+--------+</span></p><p><span style="font-family:Calibri;font-size:12px;">5 rows in set (0.00 sec)</span></p></td></tr><tr><td width="478"><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">A&gt;&gt;select * from t_pk where mem_id=3 for update;</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">+----+--------+</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">| id | mem_id |</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">+----+--------+</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">|  3 |      3 |</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">+----+--------+</span></p><p><span style="font-family:Calibri;font-size:12px;">1 row in set (0.00 sec)</span></p></td><td width="479"><br></td></tr><tr><td width="478"><br></td><td width="479"><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">B&gt;&gt;insert into t_pk values(2,2);</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">Query OK, 1 row affected (0.00 sec)</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">B&gt;&gt;insert into t_pk values(4,4);</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">Query OK, 1 row affected (0.00 sec)</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">B&gt;&gt;insert into t_pk values(3,3);</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">B&gt;&gt;insert into t_pk values(5,5);</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">ERROR 1062 (23000): Duplicate entry '5' for key 'PRIMARY'</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">B&gt;&gt;insert into t_pk values(7,7);</span></p><p><span style="font-family:Calibri;font-size:12px;">Query OK, 1 row affected (0.00 sec)</span></p></td></tr><tr><td colspan="2" rowspan="1" width="957"><span style="font-size:14px;">结论：<span style="font-family:'宋体';">从这里可以看到，对于基于唯一索引的更新，MySQL只是锁定了记录本身。</span></span><p><span style="font-size:14px;"><span style="font-size:14px;font-family:'宋体';">同理</span><span style="font-size:14px;font-family:'宋体';">，我们可以</span><span style="font-size:14px;font-family:'宋体';">推导</span><span style="font-size:14px;font-family:'宋体';">出主键</span><span style="font-size:14px;font-family:'宋体';">也是</span><span style="font-size:14px;font-family:'宋体';">一样的。</span><span style="font-size:14px;font-family:'宋体';">实验</span><span style="font-size:14px;font-family:'宋体';">的话我就略了，其实就是</span><span style="font-size:14px;font-family:'宋体';">将</span><span style="font-size:14px;font-family:'宋体';">上面的</span><span style="font-family:'宋体';font-size:19px;">mem_id<span style="font-size:14px;font-family:'宋体';">改成</span><span style="font-size:14px;font-family:Calibri;">id</span><span style="font-size:14px;font-family:'宋体';">即可</span></span><span style="font-size:14px;font-family:'宋体';">。</span></span></p></td></tr><tr><td rowspan="1" colspan="2" width="957"><strong><span style="font-family:'宋体';">基于主键</span><span style="font-family:Calibri;font-size:19px;"><span style="font-family:'宋体';">的</span>Record Lock</span><span style="font-family:'宋体';font-size:19px;">，</span><span style="font-family:Calibri;font-size:19px;"><span style="font-family:'宋体';">还是</span>RR<span style="font-family:'宋体';">级别</span></span></strong></td></tr><tr><td width="478"><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">A&gt;&gt;rollback;</span></p><p><span style="font-family:Calibri;font-size:12px;">Query OK, 0 rows affected (0.00 sec)</span></p></td><td width="479"><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">B&gt;&gt;rollback;</span></p><p><span style="font-family:Calibri;font-size:12px;">Query OK, 0 rows affected (0.00 sec)</span></p></td></tr><tr><td colspan="1" rowspan="1" width="478"><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">A&gt;&gt;begin;</span></p><p><span style="font-family:Calibri;font-size:12px;">Query OK, 0 rows affected (0.00 sec</span></p></td><td colspan="1" rowspan="1" width="479"><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">B&gt;&gt;begin;</span></p><p><span style="font-family:Calibri;font-size:12px;">Query OK, 0 rows affected (0.00 sec)</span></p></td></tr><tr><td colspan="1" rowspan="1" width="478"><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">A&gt;&gt;select * from t_pk where id=3 for update;</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">+----+--------+</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">| id | mem_id |</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">+----+--------+</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">|  3 |      3 |</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">+----+--------+</span></p><p><span style="font-family:Calibri;font-size:12px;">1 row in set (0.00 sec)</span></p></td><td colspan="1" rowspan="1" width="479"><br></td></tr><tr><td colspan="1" rowspan="1" width="478"><br></td><td colspan="1" rowspan="1" width="479"><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">B&gt;&gt;insert into t_pk values(2,2);</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">Query OK, 1 row affected (0.00 sec)</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">B&gt;&gt;insert into t_pk values(4,4);</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">Query OK, 1 row affected (0.00 sec)</span></p></td></tr><tr><td colspan="2" rowspan="1" width="957"><span style="font-size:16px;">结论：<span style="font-family:'宋体';">说明上面的推导正确。</span></span></td></tr><tr><td colspan="2" rowspan="1" width="957"><strong>Read-Committed<span style="font-family:'宋体';">级别</span><span style="font-family:Calibri;font-size:19px;"><span style="font-family:'宋体';">（</span></span><span style="font-family:'宋体';font-size:19px;">RC</span><span style="font-family:Calibri;font-size:19px;"><span style="font-family:'宋体';">）</span></span></strong></td></tr><tr><td colspan="1" rowspan="1" width="478"><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">A&gt;&gt;rollback;</span></p><p><span style="font-family:Calibri;font-size:12px;">Query OK, 0 rows affected (0.00 sec)</span></p></td><td colspan="1" rowspan="1" width="479"><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">B&gt;&gt;rollback;</span></p><p><span style="font-family:Calibri;font-size:12px;">Query OK, 0 rows affected (0.00 sec)</span></p></td></tr><tr><td width="478"><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">A&gt;&gt;set @@session.tx_isolation="read-committed";</span></p><p><span style="font-family:Calibri;font-size:12px;">Query OK, 0 rows affected (0.01 sec)</span></p></td><td width="479"><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">B&gt;&gt;set @@session.tx_isolation="read-committed";</span></p><p><span style="font-family:Calibri;font-size:12px;">Query OK, 0 rows affected (0.00 sec)</span></p></td></tr><tr><td colspan="1" rowspan="1" width="478"><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">A&gt;&gt;select @@session.tx_isolation;</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">+------------------------+</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">| @@session.tx_isolation |</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">+------------------------+</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">| READ-COMMITTED         |</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">+------------------------+</span></p><p><span style="font-family:Calibri;font-size:12px;">1 row in set (0.00 sec)</span></p></td><td colspan="1" rowspan="1" width="479"><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">B&gt;&gt;select @@session.tx_isolation;</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">+------------------------+</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">| @@session.tx_isolation |</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">+------------------------+</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">| READ-COMMITTED         |</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">+------------------------+</span></p><p><span style="font-family:Calibri;font-size:12px;">1 row in set (0.00 sec)</span></p></td></tr><tr><td colspan="1" rowspan="1" width="478"><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">A&gt;&gt;begin;</span></p><p><span style="font-family:Calibri;font-size:12px;">Query OK, 0 rows affected (0.00 sec)</span></p></td><td colspan="1" rowspan="1" width="479"><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">B&gt;&gt;begin;</span></p><p><span style="font-family:Calibri;font-size:12px;">Query OK, 0 rows affected (0.00 sec)</span></p></td></tr><tr><td colspan="1" rowspan="1" width="478"><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">A&gt;&gt;select * from t_pk;</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">+----+--------+</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">| id | mem_id |</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">+----+--------+</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">|  1 |      1 |</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">|  3 |      3 |</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">|  5 |      5 |</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">|  9 |      9 |</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">| 11 |     11 |</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">+----+--------+</span></p><p><span style="font-family:Calibri;font-size:12px;">5 rows in set (0.00 sec)</span></p></td><td colspan="1" rowspan="1" width="479"><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">B&gt;&gt;select * from t_pk;</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">+----+--------+</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">| id | mem_id |</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">+----+--------+</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">|  1 |      1 |</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">|  3 |      3 |</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">|  5 |      5 |</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">|  9 |      9 |</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">| 11 |     11 |</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">+----+--------+</span></p><p><span style="font-family:Calibri;font-size:12px;">5 rows in set (0.00 sec)</span></p></td></tr><tr><td colspan="1" rowspan="1" width="478"><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">A&gt;&gt;select * from t_pk where mem_id=3 for update;</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">+----+--------+</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">| id | mem_id |</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">+----+--------+</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">|  3 |      3 |</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">+----+--------+</span></p><p><span style="font-family:Calibri;font-size:12px;">1 row in set (0.00 sec)</span></p></td><td colspan="1" rowspan="1" width="479"><br></td></tr><tr><td colspan="1" rowspan="1" width="478"><br></td><td colspan="1" rowspan="1" width="479"><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">B&gt;&gt;insert into t_pk values(2,2);</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">Query OK, 1 row affected (0.00 sec)</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">B&gt;&gt;insert into t_pk values(4,4),(6,6),(10,10);</span></p><p style="text-indent:0;"><span style="font-family:'宋体';font-size:12px;">Query OK, 3 rows affected (0.00 sec)</span></p><p><span style="font-family:Calibri;font-size:12px;">Records: 3  Duplicates: 0  Warnings: 0</span></p></td></tr><tr><td colspan="2" rowspan="1" width="957"><span style="font-size:14px;">结论:<span style="font-family:'宋体';">说明</span><span style="font-family:'宋体';"></span><span style="font-family:Calibri;">RC</span><span style="font-family:'宋体';">级别下，没有间隙锁存在。</span></span></td></tr></tbody></table> 
  <ul class="list-paddingleft-2" style="list-style-type:square;"><li><p style="text-indent:0;"><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">主键</span></span><span style="font-family:'宋体';font-size:16px;">+RR/RC</span></p></li></ul> 
  <p style="text-indent:0;"><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">这跟唯一</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">索引</span>+RR/RC</span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">是</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">一样的，请</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">参看</span></span><span style="font-family:'宋体';font-size:16px;"><span style="font-family:'宋体';">上面的唯一索引</span></span><span style="font-family:'宋体';font-size:16px;">+RR/RC。</span></p> 
  <p><br></p> 
  <p><br></p> 
  <p><br></p> 
  <p><br></p> 
  <p><br></p> 
 </div> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5351a49c3e29a33c2607c1043791be16/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">华为路由器与交换机的基础命令</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0689f4c8f632767b6e8a804db5aca06b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">MySQL的show index 选择率</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>