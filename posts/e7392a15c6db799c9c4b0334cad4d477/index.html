<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【MM32F5270开发板试用】依靠SPI_SD，移植FatFs文件系统（优化版本） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【MM32F5270开发板试用】依靠SPI_SD，移植FatFs文件系统（优化版本）" />
<meta property="og:description" content="【MM32F5270开发板试用】依靠SPI_SD，移植FatFs文件系统（优化版本） 上三篇文章：
【MM32F5270开发板试用】一、依靠SPI_SD，移植FatFs文件系统
【MM32F5270开发板试用】SysTick&#43;Scheduler轮询
【MM32F5270开发板试用】如何将数据存放在DTCM
本次所有代码按照以前习惯全部开源：我的Github地址是：https://github.com/kings669/MM32F5
可能关注我的朋友发现，我最近没有更新文章，那是因为我前段时间去参加今年的智能车竞赛。现在，已经比完，可以有时间完成我后续的计划😄。
一、优化背景
在测试的过程中，发现播放音频卡顿十分卡顿，经过排除后发现，在官方适配的SPI是软件SPI。想到我们的整体流程是从SD卡开始，源头就卡了，何来最大吞吐率😄。
二、优化过程
1、开启时钟，在clock_init.c中
/* SPI3. */
RCC_EnableAPB1Periphs(RCC_APB1_PERIPH_SPI3, true);
RCC_ResetAPB1Periphs(RCC_APB1_PERIPH_SPI3);
2、引脚设置，在pin_init.c中
/* PC12 - GPIO output: SPI3_MOSI. */
gpio_init.Pins = GPIO_PIN_12;
gpio_init.PinMode = GPIO_PinMode_AF_PushPull;
gpio_init.Speed = GPIO_Speed_50MHz;
GPIO_Init(GPIOC, &amp;gpio_init);
GPIO_PinAFConf(GPIOC, gpio_init.Pins, GPIO_AF_6);
/* PC11 - GPIO input: SPI3_MISO. */
gpio_init.Pins = GPIO_PIN_11;
gpio_init.PinMode = GPIO_PinMode_In_Floating;
gpio_init.Speed = GPIO_Speed_50MHz;
GPIO_Init(GPIOC, &amp;gpio_init);
GPIO_PinAFConf(GPIOC, gpio_init.Pins, GPIO_AF_6);
/* PC10 - GPIO output: SPI3_SCK. */
gpio_init.Pins = GPIO_PIN_10;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/e7392a15c6db799c9c4b0334cad4d477/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-10-05T13:54:44+08:00" />
<meta property="article:modified_time" content="2022-10-05T13:54:44+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【MM32F5270开发板试用】依靠SPI_SD，移植FatFs文件系统（优化版本）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="MM32F5270SPI_SDFatFs_0"></a>【MM32F5270开发板试用】依靠SPI_SD，移植FatFs文件系统（优化版本）</h2> 
<p>上三篇文章：<br> 【MM32F5270开发板试用】一、依靠SPI_SD，移植FatFs文件系统<br> 【MM32F5270开发板试用】SysTick+Scheduler轮询<br> 【MM32F5270开发板试用】如何将数据存放在DTCM<br> 本次所有代码按照以前习惯全部开源：我的Github地址是：https://github.com/kings669/MM32F5</p> 
<p>可能关注我的朋友发现，我最近没有更新文章，那是因为我前段时间去参加今年的智能车竞赛。现在，已经比完，可以有时间完成我后续的计划😄。</p> 
<p>一、优化背景<br> 在测试的过程中，发现播放音频卡顿十分卡顿，经过排除后发现，在官方适配的SPI是软件SPI。想到我们的整体流程是从SD卡开始，源头就卡了，何来最大吞吐率😄。</p> 
<p>二、优化过程<br> 1、开启时钟，在clock_init.c中</p> 
<p>/* SPI3. */<br> RCC_EnableAPB1Periphs(RCC_APB1_PERIPH_SPI3, true);<br> RCC_ResetAPB1Periphs(RCC_APB1_PERIPH_SPI3);</p> 
<p>2、引脚设置，在pin_init.c中</p> 
<p>/* PC12 - GPIO output: SPI3_MOSI. */<br> gpio_init.Pins = GPIO_PIN_12;<br> gpio_init.PinMode = GPIO_PinMode_AF_PushPull;<br> gpio_init.Speed = GPIO_Speed_50MHz;<br> GPIO_Init(GPIOC, &amp;gpio_init);<br> GPIO_PinAFConf(GPIOC, gpio_init.Pins, GPIO_AF_6);</p> 
<p>/* PC11 - GPIO input: SPI3_MISO. */<br> gpio_init.Pins = GPIO_PIN_11;<br> gpio_init.PinMode = GPIO_PinMode_In_Floating;<br> gpio_init.Speed = GPIO_Speed_50MHz;<br> GPIO_Init(GPIOC, &amp;gpio_init);<br> GPIO_PinAFConf(GPIOC, gpio_init.Pins, GPIO_AF_6);</p> 
<p>/* PC10 - GPIO output: SPI3_SCK. */<br> gpio_init.Pins = GPIO_PIN_10;<br> gpio_init.PinMode = GPIO_PinMode_AF_PushPull;<br> gpio_init.Speed = GPIO_Speed_50MHz;<br> GPIO_Init(GPIOC, &amp;gpio_init);<br> GPIO_PinAFConf(GPIOC, gpio_init.Pins, GPIO_AF_6);</p> 
<p>/* PA15 - GPIO output: SPI3_CS. */<br> gpio_init.Pins = GPIO_PIN_15;<br> gpio_init.PinMode = GPIO_PinMode_AF_PushPull;<br> gpio_init.Speed = GPIO_Speed_50MHz;<br> GPIO_Init(GPIOA, &amp;gpio_init);<br> GPIO_PinAFConf(GPIOA, gpio_init.Pins, GPIO_AF_6);</p> 
<p>3、修改sdspi_port.c文件</p> 
<pre><code class="prism language-c"><span class="token comment">/*
 * Copyright 2022 MindMotion Microelectronics Co., Ltd.
 * All rights reserved.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 */</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"board_init.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sdspi.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"hal_spi.h"</span></span>

<span class="token comment">/* pins:
 * tx : PC12/SPI_MOSI
 * rx : PC8/SPI0_MISO
 * clk: PC12/SPI0_SCK
 * cs : PC11/SPI0_PCS0
 */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BOARD_SDSPI_TX_GPIO_PORT</span>  <span class="token expression">GPIOC</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BOARD_SDSPI_TX_GPIO_PIN</span>   <span class="token expression">GPIO_PIN_12</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BOARD_SDSPI_RX_GPIO_PORT</span>  <span class="token expression">GPIOC</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BOARD_SDSPI_RX_GPIO_PIN</span>   <span class="token expression">GPIO_PIN_11</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BOARD_SDSPI_CLK_GPIO_PORT</span> <span class="token expression">GPIOC</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BOARD_SDSPI_CLK_GPIO_PIN</span>  <span class="token expression">GPIO_PIN_10</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BOARD_SDSPI_CS_GPIO_PORT</span>  <span class="token expression">GPIOA</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BOARD_SDSPI_CS_GPIO_PIN</span>   <span class="token expression">GPIO_PIN_15</span></span>

SDSPI_ApiRetStatus_Type <span class="token function">sdspi_spi_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
SDSPI_ApiRetStatus_Type <span class="token function">sdspi_spi_freq</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> hz<span class="token punctuation">)</span><span class="token punctuation">;</span>
SDSPI_ApiRetStatus_Type <span class="token function">sdspi_spi_xfer</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>in<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>out<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> SDSPI_Interface_Type board_sdspi_if <span class="token operator">=</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span>baudrate <span class="token operator">=</span> <span class="token number">1000000u</span><span class="token punctuation">,</span> <span class="token comment">/* 1mhz. */</span>
    <span class="token punctuation">.</span>spi_init <span class="token operator">=</span> sdspi_spi_init<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>spi_freq <span class="token operator">=</span> sdspi_spi_freq<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>spi_xfer <span class="token operator">=</span> sdspi_spi_xfer
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token class-name">uint32_t</span> board_sdspi_delay_count<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">board_sdspi_delay</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> count<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span> i <span class="token operator">=</span> count<span class="token punctuation">;</span> i <span class="token operator">&gt;</span> <span class="token number">0u</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">__NOP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

SDSPI_ApiRetStatus_Type <span class="token function">sdspi_spi_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">GPIO_WriteBit</span><span class="token punctuation">(</span>BOARD_SDSPI_CS_GPIO_PORT <span class="token punctuation">,</span> BOARD_SDSPI_CS_GPIO_PIN <span class="token punctuation">,</span> <span class="token number">1u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//    GPIO_WriteBit(BOARD_SDSPI_TX_GPIO_PORT , BOARD_SDSPI_TX_GPIO_PIN , 0u);</span>
<span class="token comment">//    GPIO_WriteBit(BOARD_SDSPI_CLK_GPIO_PORT, BOARD_SDSPI_CLK_GPIO_PIN, 0u);</span>
    
    <span class="token comment">/* Setup SPI module. */</span>
    SPI_Master_Init_Type spi_init<span class="token punctuation">;</span>
    spi_init<span class="token punctuation">.</span>ClockFreqHz <span class="token operator">=</span> CLOCK_APB1_FREQ<span class="token punctuation">;</span>
    spi_init<span class="token punctuation">.</span>BaudRate <span class="token operator">=</span> SDMMC_CLOCK_400KHZ<span class="token punctuation">;</span>
    spi_init<span class="token punctuation">.</span>XferMode <span class="token operator">=</span> SPI_XferMode_TxRx<span class="token punctuation">;</span>
    spi_init<span class="token punctuation">.</span>PolPha <span class="token operator">=</span> SPI_PolPha_Alt2<span class="token punctuation">;</span>
    spi_init<span class="token punctuation">.</span>DataWidth <span class="token operator">=</span> SPI_DataWidth_8b<span class="token punctuation">;</span>
    spi_init<span class="token punctuation">.</span>LSB <span class="token operator">=</span> false<span class="token punctuation">;</span>
    spi_init<span class="token punctuation">.</span>AutoCS <span class="token operator">=</span> true<span class="token punctuation">;</span>
    <span class="token function">SPI_InitMaster</span><span class="token punctuation">(</span>SPI3<span class="token punctuation">,</span> <span class="token operator">&amp;</span>spi_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* Enable SPI. */</span>
    <span class="token function">SPI_Enable</span><span class="token punctuation">(</span>SPI3<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>
    

<span class="token comment">//    board_sdspi_delay_count = 100u;</span>
    <span class="token keyword">return</span> SDSPI_ApiRetStatus_Success<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">SPI_SetBaudRate</span><span class="token punctuation">(</span>SPI_Type <span class="token operator">*</span> SPIx<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> src_clk<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> baudrate<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint32_t</span> div <span class="token operator">=</span> src_clk <span class="token operator">/</span> baudrate<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>div <span class="token operator">&lt;</span> <span class="token number">2u</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* div = 0, 1 is not allowed. */</span>
        div <span class="token operator">=</span> <span class="token number">2u</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    SPIx<span class="token operator">-&gt;</span>SPBRG <span class="token operator">=</span> div<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>div <span class="token operator">&lt;=</span> <span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* to support high speed mode. */</span>
        SPIx<span class="token operator">-&gt;</span>CCTL <span class="token operator">|=</span> <span class="token punctuation">(</span>SPI_I2S_CCTL_TXEDGE_MASK <span class="token operator">|</span> SPI_I2S_CCTL_RXEDGE_MASK<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        SPIx<span class="token operator">-&gt;</span>CCTL <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>SPI_I2S_CCTL_TXEDGE_MASK <span class="token operator">|</span> SPI_I2S_CCTL_RXEDGE_MASK<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

SDSPI_ApiRetStatus_Type <span class="token function">sdspi_spi_freq</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> hz<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>hz<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">case</span> SDMMC_CLOCK_400KHZ<span class="token operator">:</span>
                <span class="token function">SPI_Enable</span><span class="token punctuation">(</span>SPI3<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">SPI_SetBaudRate</span><span class="token punctuation">(</span>SPI3<span class="token punctuation">,</span>CLOCK_APB1_FREQ<span class="token punctuation">,</span>SDMMC_CLOCK_400KHZ<span class="token punctuation">)</span><span class="token punctuation">;</span>    
                <span class="token function">SPI_Enable</span><span class="token punctuation">(</span>SPI3<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token function">SPI_Enable</span><span class="token punctuation">(</span>SPI3<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">SPI_SetBaudRate</span><span class="token punctuation">(</span>SPI3<span class="token punctuation">,</span>CLOCK_APB1_FREQ<span class="token punctuation">,</span>SD_CLOCK_25MHZ<span class="token punctuation">)</span><span class="token punctuation">;</span>    
                <span class="token function">SPI_Enable</span><span class="token punctuation">(</span>SPI3<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> SDSPI_ApiRetStatus_Success<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//SDSPI_ApiRetStatus_Type sdspi_spi_freq(uint32_t hz)</span>
<span class="token comment">//{<!-- --></span>
<span class="token comment">//    switch (hz)</span>
<span class="token comment">//    {<!-- --></span>
<span class="token comment">//    case SDMMC_CLOCK_400KHZ:</span>
<span class="token comment">//        board_sdspi_delay_count = 100u;</span>
<span class="token comment">//        break;</span>
<span class="token comment">//    default:</span>
<span class="token comment">//        board_sdspi_delay_count = 0u;</span>
<span class="token comment">//        break;</span>
<span class="token comment">//    }</span>
<span class="token comment">//    return SDSPI_ApiRetStatus_Success;</span>
<span class="token comment">//}</span>
<span class="token comment">/* SPI tx. */</span>
<span class="token keyword">void</span> <span class="token function">app_spi_putbyte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> c<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* Polling for tx empty. */</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span> SPI_STATUS_TX_FULL <span class="token operator">&amp;</span> <span class="token function">SPI_GetStatus</span><span class="token punctuation">(</span>SPI3<span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token function">SPI_PutData</span><span class="token punctuation">(</span>SPI3<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* SPI rx. */</span>
<span class="token class-name">uint8_t</span> <span class="token function">app_spi_getbyte</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* Polling for rx done. */</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0u</span> <span class="token operator">==</span> <span class="token punctuation">(</span>SPI_STATUS_RX_DONE <span class="token operator">&amp;</span> <span class="token function">SPI_GetStatus</span><span class="token punctuation">(</span>SPI3<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">SPI_GetData</span><span class="token punctuation">(</span>SPI3<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">uint8_t</span> <span class="token function">spi_xfer</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> tx_dat<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint8_t</span> rx_dat <span class="token operator">=</span> <span class="token number">0u</span><span class="token punctuation">;</span>
        <span class="token function">app_spi_putbyte</span><span class="token punctuation">(</span>tx_dat<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rx_dat<span class="token operator">=</span><span class="token function">app_spi_getbyte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> rx_dat<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//uint8_t spi_xfer(uint8_t tx_dat)</span>
<span class="token comment">//{<!-- --></span>
<span class="token comment">//    uint8_t rx_dat = 0u;</span>

<span class="token comment">//    for (uint8_t i = 0u; i &lt; 8u; i++)</span>
<span class="token comment">//    {<!-- --></span>
<span class="token comment">//        GPIO_WriteBit(BOARD_SDSPI_CLK_GPIO_PORT, BOARD_SDSPI_CLK_GPIO_PIN, 0u );</span>
<span class="token comment">//        GPIO_WriteBit(BOARD_SDSPI_TX_GPIO_PORT, BOARD_SDSPI_TX_GPIO_PIN, (0u != (tx_dat &amp; (1u &lt;&lt; (7u-i)))) ? 1u : 0u );</span>
<span class="token comment">//        board_sdspi_delay(board_sdspi_delay_count);</span>
<span class="token comment">//        GPIO_WriteBit(BOARD_SDSPI_CLK_GPIO_PORT, BOARD_SDSPI_CLK_GPIO_PIN, 1u );</span>
<span class="token comment">//        board_sdspi_delay(board_sdspi_delay_count);</span>
<span class="token comment">//        rx_dat = (rx_dat &lt;&lt; 1u) | GPIO_ReadInDataBit(BOARD_SDSPI_RX_GPIO_PORT, BOARD_SDSPI_RX_GPIO_PIN);</span>
<span class="token comment">//    }</span>

<span class="token comment">//    return rx_dat;</span>
<span class="token comment">//}</span>

<span class="token keyword">void</span> <span class="token function">spi_assert_cs</span><span class="token punctuation">(</span>bool enable<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">GPIO_WriteBit</span><span class="token punctuation">(</span>BOARD_SDSPI_CS_GPIO_PORT<span class="token punctuation">,</span> BOARD_SDSPI_CS_GPIO_PIN<span class="token punctuation">,</span> <span class="token punctuation">(</span>enable <span class="token operator">?</span> <span class="token number">0u</span><span class="token operator">:</span> <span class="token number">1u</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

SDSPI_ApiRetStatus_Type <span class="token function">sdspi_spi_xfer</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>in<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>out<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> len<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint8_t</span> inbuf<span class="token punctuation">,</span> outbuf<span class="token punctuation">;</span>
    <span class="token comment">//spi_assert_cs(true);</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span> i <span class="token operator">=</span> <span class="token number">0u</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        inbuf <span class="token operator">=</span> <span class="token punctuation">(</span>in <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">?</span> SDSPI_DUMMY_DATA<span class="token operator">:</span> <span class="token operator">*</span>in<span class="token operator">++</span><span class="token punctuation">;</span>
        outbuf <span class="token operator">=</span> <span class="token function">spi_xfer</span><span class="token punctuation">(</span>inbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token operator">*</span>out <span class="token operator">=</span> outbuf<span class="token punctuation">;</span>
            out<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//spi_assert_cs(false);</span>

    <span class="token keyword">return</span> SDSPI_ApiRetStatus_Success<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* EOF. */</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/df6241c2770e3fbfb6f593f7e74df304/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【MM32F5270开发板试用】如何将数据存放在DTCM</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/be47612d47d08e8708b4f3691733c9e9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【MM32F5270开发板试用】播放TF卡WAV格式音乐，I2S驱动CS4344</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>