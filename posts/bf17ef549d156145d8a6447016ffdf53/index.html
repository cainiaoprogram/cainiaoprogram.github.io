<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>YOLO-V5分类实战系列 —— 调优自己的数据集&#43;RK1808部署 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="YOLO-V5分类实战系列 —— 调优自己的数据集&#43;RK1808部署" />
<meta property="og:description" content="YOLO-V5分类实战系列 —— 调优自己的数据集 1、保存训练和测试图片2、数据归一化3、数据增强3.1、数据增强库：albumentations3.2、数据增强库：torchvision 4、ONNX CPU 推理4.1、Pt 模型转为 ONNX4.2、ONNX 推理验证4.3、 ONNX CPU推理（C&#43;&#43;） 5、RK 1808 部署5.1、查看模型输入、输出名字5.2、转换为RKNN模型5.3、C&#43;&#43; 芯片部署 6、调优策略6.1、数据标注6.2、数据清洗6.3、网络调优 1、保存训练和测试图片 问题1：训练过程中，如何保证训练集的数据增强和验证集的数据增强是基本一致的？
问题2：训练过程中，如何保证训练集和验证集的标签是正确的？
解决方法：训练测试过程中，保存训练图片和测试图片，并将标签画到图片可视化。
训练过程中，需要保证训练的数据预处理和测试的数据预处理保持一致，这一步还是很重要的，需要优先验证其一致性。常见的【预处理】包括：图片尺寸调整（resize，crop），色彩增强，空间变换（翻转，旋转等），归一化等。
下面的代码片段是数据读取的核心类，包括数据读取和数据增强。代码位置： 【utils/dataloaders.py】，并且需要在 def __init__() 中需要添加 self.augment = augment，保存图像的调用位置 def __getitem__() 中添加 self.save_images(f, sample)，下面代码都有添加（红色框内的代码） 训练和测试图片保存的代码片段如下，将其添加到类 ClassificationDataset 的成员函数即可。通过self.augment 判定是训练图片还是测试图片，进而对图片名字进行命名。保存的路径自己可以设置，
def save_images(self, f, sample): # 保存数据增强后的图片，用于对比训练和验证的图片预处理是否一致 print(&#39; -------------self.augment: &#39;, self.augment) if self.augment: print(&#39; -------------f: &#39;, f) a = f.split(&#39;/train/&#39;)[0]&#43;&#39;/train_aug/&#39;&#43;os.path.basename(f)[:-4]&#43;&#39;_train.jpg&#39; print(&#39; -------------a: &#39;, a) torchvision.utils.save_image(sample, a) else: print(&#39; -------------f: &#39;, f) a = f." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/bf17ef549d156145d8a6447016ffdf53/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-16T16:21:59+08:00" />
<meta property="article:modified_time" content="2023-11-16T16:21:59+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">YOLO-V5分类实战系列 —— 调优自己的数据集&#43;RK1808部署</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>YOLO-V5分类实战系列 —— 调优自己的数据集</h4> 
 <ul><li><ul><li><a href="#1_4" rel="nofollow">1、保存训练和测试图片</a></li><li><a href="#2_39" rel="nofollow">2、数据归一化</a></li><li><a href="#3_108" rel="nofollow">3、数据增强</a></li><li><ul><li><a href="#31albumentations_110" rel="nofollow">3.1、数据增强库：albumentations</a></li><li><a href="#32torchvision_239" rel="nofollow">3.2、数据增强库：torchvision</a></li></ul> 
   </li><li><a href="#4ONNX_CPU__281" rel="nofollow">4、ONNX CPU 推理</a></li><li><ul><li><a href="#41Pt__ONNX_288" rel="nofollow">4.1、Pt 模型转为 ONNX</a></li><li><a href="#42ONNX__294" rel="nofollow">4.2、ONNX 推理验证</a></li><li><a href="#43_ONNX_CPUC_299" rel="nofollow">4.3、 ONNX CPU推理（C++）</a></li></ul> 
   </li><li><a href="#5RK_1808__581" rel="nofollow">5、RK 1808 部署</a></li><li><ul><li><a href="#51_588" rel="nofollow">5.1、查看模型输入、输出名字</a></li><li><a href="#52RKNN_594" rel="nofollow">5.2、转换为RKNN模型</a></li><li><a href="#53C__694" rel="nofollow">5.3、C++ 芯片部署</a></li></ul> 
   </li><li><a href="#6_701" rel="nofollow">6、调优策略</a></li><li><ul><li><a href="#61_705" rel="nofollow">6.1、数据标注</a></li><li><a href="#62_712" rel="nofollow">6.2、数据清洗</a></li><li><a href="#63_719" rel="nofollow">6.3、网络调优</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<hr> 
<h3><a id="1_4"></a>1、保存训练和测试图片</h3> 
<blockquote> 
 <p>问题1：训练过程中，如何保证训练集的数据增强和验证集的数据增强是基本一致的？<br> 问题2：训练过程中，如何保证训练集和验证集的标签是正确的？</p> 
</blockquote> 
<blockquote> 
 <p><font color="Fuchsia">解决方法</font>：训练测试过程中，保存训练图片和测试图片，并将标签画到图片可视化。</p> 
</blockquote> 
<p>训练过程中，需要保证训练的数据预处理和测试的数据预处理保持一致，<font color="blue">这一步还是很重要的，需要优先验证其一致性</font>。常见的【<font color="Fuchsia">预处理</font>】包括：图片尺寸调整（resize，crop），色彩增强，空间变换（翻转，旋转等），归一化等。</p> 
<ul><li>下面的代码片段是数据读取的核心类，包括数据读取和数据增强。代码位置： 【<code>utils/dataloaders.py</code>】，并且需要在 <code>def __init__()</code> 中需要添加 <code>self.augment = augment</code>，保存图像的调用位置 <code>def __getitem__()</code> 中添加 <code>self.save_images(f, sample)</code>，下面代码都有添加（红色框内的代码）</li></ul> 
<p><img src="https://images2.imgbox.com/a6/fc/Jj6cMj11_o.png" alt="在这里插入图片描述" width="750"></p> 
<ul><li> <p>训练和测试图片保存的代码片段如下，将其添加到类 <code>ClassificationDataset</code> 的成员函数即可。通过<code>self.augment</code> 判定是训练图片还是测试图片，进而对图片名字进行命名。保存的路径自己可以设置，</p> <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">save_images</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> f<span class="token punctuation">,</span> sample<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 保存数据增强后的图片，用于对比训练和验证的图片预处理是否一致</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'   -------------self.augment: '</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>augment<span class="token punctuation">)</span>
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>augment<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'   -------------f: '</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span>
        a <span class="token operator">=</span> f<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'/train/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token string">'/train_aug/'</span><span class="token operator">+</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token string">'_train.jpg'</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'   -------------a: '</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>
        torchvision<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>save_image<span class="token punctuation">(</span>sample<span class="token punctuation">,</span> a<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'   -------------f: '</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span>
        a <span class="token operator">=</span> f<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'/test/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token string">'/train_aug/'</span><span class="token operator">+</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token string">'_test.jpg'</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'   -------------a: '</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>
        torchvision<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>save_image<span class="token punctuation">(</span>sample<span class="token punctuation">,</span> a<span class="token punctuation">)</span>
</code></pre> <p>训练过程中，测试和训练预处理保存的图片如下，<font color="blue">注意训练集和测试集的图片用同样的图片</font>，这样更方便对比，<br> <img src="https://images2.imgbox.com/e1/b9/uJVy93Sh_o.png" alt="在这里插入图片描述" width="500"></p> </li></ul> 
<hr> 
<h3><a id="2_39"></a>2、数据归一化</h3> 
<p>代码中默认的是【<font color="Fuchsia">ImageNet</font>】数据集的均值和标准差，具体如下</p> 
<pre><code class="prism language-python">IMAGENET_MEAN <span class="token operator">=</span> <span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span>  <span class="token comment"># RGB mean</span>
IMAGENET_STD <span class="token operator">=</span> <span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span>   <span class="token comment"># RGB standard deviation</span>
</code></pre> 
<p>当使用自己的数据集的时候，通常根据数据集是否与ImageNet差异性大小，决定是否重新计算均值和标准差。针对我自己的数据集，需要重新计算，代码如下</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">compute_mean_std</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token comment"># 将所有的【路径+图片】读取到列表 all_file </span>
    images_path <span class="token operator">=</span> <span class="token string">'datasets/biaozhu_train/train/'</span> <span class="token comment"># 针对自己的路径，需要修改</span>
    all_file <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k <span class="token keyword">in</span> os<span class="token punctuation">.</span>walk<span class="token punctuation">(</span>images_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'i: '</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'j: '</span><span class="token punctuation">,</span> j<span class="token punctuation">)</span>
            all_file<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>i<span class="token punctuation">,</span>kk<span class="token punctuation">)</span> <span class="token keyword">for</span> kk <span class="token keyword">in</span> k<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'------------------'</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 统计所有图片的数量</span>
    num_images <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>all_file<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">len</span><span class="token punctuation">(</span>all_file<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">len</span><span class="token punctuation">(</span>all_file<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 逐张图计算均值和方差</span>
    mean_r <span class="token operator">=</span> mean_g <span class="token operator">=</span> mean_b <span class="token operator">=</span> <span class="token number">0</span>
    std_r <span class="token operator">=</span> std_g <span class="token operator">=</span> std_b <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>all_file<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'   i: '</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'   j: '</span><span class="token punctuation">,</span> j<span class="token punctuation">)</span>
            img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>all_file<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'img shape: '</span><span class="token punctuation">,</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>

            img <span class="token operator">=</span> np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
            img <span class="token operator">=</span> img<span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">255.</span>

            <span class="token comment"># cv2</span>
            im_mean<span class="token punctuation">,</span> im_stds <span class="token operator">=</span> cv2<span class="token punctuation">.</span>meanStdDev<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
            mean_r <span class="token operator">+=</span> im_mean<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            mean_g <span class="token operator">+=</span> im_mean<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
            mean_b <span class="token operator">+=</span> im_mean<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>

            std_r <span class="token operator">+=</span> im_stds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            std_g <span class="token operator">+=</span> im_stds<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
            std_b <span class="token operator">+=</span> im_stds<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
    
    <span class="token comment"># 计算平均值</span>
    aa_r <span class="token operator">=</span> mean_r<span class="token operator">/</span>num_images
    aa_g <span class="token operator">=</span> mean_g<span class="token operator">/</span>num_images
    aa_b <span class="token operator">=</span> mean_b<span class="token operator">/</span>num_images

    bb_r <span class="token operator">=</span> std_r<span class="token operator">/</span>num_images
    bb_g <span class="token operator">=</span> std_g<span class="token operator">/</span>num_images
    bb_b <span class="token operator">=</span> std_b<span class="token operator">/</span>num_images

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">' last mean: '</span><span class="token punctuation">,</span> aa_r<span class="token punctuation">,</span>aa_g<span class="token punctuation">,</span>aa_b<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">' last stds: '</span><span class="token punctuation">,</span> bb_r<span class="token punctuation">,</span>bb_g<span class="token punctuation">,</span>bb_b<span class="token punctuation">)</span>
</code></pre> 
<p>计算结果如下，与【<font color="Fuchsia">ImageNet</font>】数据集的均值有差别</p> 
<pre><code class="prism language-python">IMAGENET_MEAN <span class="token operator">=</span> <span class="token number">0.3539317</span><span class="token punctuation">,</span> <span class="token number">0.36820036</span><span class="token punctuation">,</span> <span class="token number">0.37243055</span>
IMAGENET_STD <span class="token operator">=</span> <span class="token number">0.22637626</span><span class="token punctuation">,</span> <span class="token number">0.22498632</span><span class="token punctuation">,</span> <span class="token number">0.22197094</span>
</code></pre> 
<p><font color="blue">值得注意：使用自己计算的均值和标准差，训练过程更加稳定，波动较小</font></p> 
<hr> 
<h3><a id="3_108"></a>3、数据增强</h3> 
<p>官方源代码训练过程中，训练流程和验证流程的数据处理库有两个库（如果开发环境中安装了 <code>albumentations</code> 库），分别是 【<code>albumentations</code>】和【<code>torchvision</code>】，否则默认均使用【<code>torchvision</code>】。下面我们将分别介绍它们：</p> 
<h4><a id="31albumentations_110"></a>3.1、数据增强库：albumentations</h4> 
<p>训练过程中（如果安装了<code>albumentations</code>库），则会执行下图中的代码。如图所示，包括三类的数据增强，也是常用的图像数据增强方法</p> 
<p><img src="https://images2.imgbox.com/e8/bc/zEPpdOAg_o.png" alt="在这里插入图片描述" width="650"></p> 
<hr> 
<p>下面我们分别介绍上述的几种数据增强方式：</p> 
<ul><li> <p>随机裁剪</p> <pre><code class="prism language-python">A<span class="token punctuation">.</span>RandomResizedCrop<span class="token punctuation">(</span>height<span class="token operator">=</span>size<span class="token punctuation">,</span> width<span class="token operator">=</span>size<span class="token punctuation">,</span> scale<span class="token operator">=</span>scale<span class="token punctuation">,</span> ratio<span class="token operator">=</span>ratio<span class="token punctuation">)</span>
</code></pre> 
  <blockquote> 
   <p><strong>函数功能</strong>：先对图像进行裁剪，然后resize到固定的尺寸<br> <strong>height</strong>：处理完后，最终图像的高度；<br> <strong>width</strong>：处理完后，最终图像的宽度；<br> <strong>scale</strong>：裁剪图占整张图区域面积(h*w)的比例是多少；<br> <strong>ratio</strong>：裁剪区域的宽高比；</p> 
  </blockquote> <p>该函数的部分核心源码如下所示，主要计算待裁剪的【<font color="red">区域大小</font>】和【<font color="red">裁剪的起始位置</font>】，具体如下以及部分注释：</p> <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">get_params_dependent_on_targets</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">:</span>
	img <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">"image"</span><span class="token punctuation">]</span>
	area <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
	
	<span class="token comment"># 当【if】条件不满足时，尝试10次</span>
	<span class="token keyword">for</span> _attempt <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token comment"># 根据scale和ratio参数，得到随机的参数，进而计算裁剪图的大小（w，h）</span>
	    target_area <span class="token operator">=</span> random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token operator">*</span>self<span class="token punctuation">.</span>scale<span class="token punctuation">)</span> <span class="token operator">*</span> area
	    log_ratio <span class="token operator">=</span> <span class="token punctuation">(</span>math<span class="token punctuation">.</span>log<span class="token punctuation">(</span>self<span class="token punctuation">.</span>ratio<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> math<span class="token punctuation">.</span>log<span class="token punctuation">(</span>self<span class="token punctuation">.</span>ratio<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	    aspect_ratio <span class="token operator">=</span> math<span class="token punctuation">.</span>exp<span class="token punctuation">(</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token operator">*</span>log_ratio<span class="token punctuation">)</span><span class="token punctuation">)</span>
	
	    w <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>target_area <span class="token operator">*</span> aspect_ratio<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># skipcq: PTC-W0028</span>
	    h <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>target_area <span class="token operator">/</span> aspect_ratio<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># skipcq: PTC-W0028</span>
		
		<span class="token comment"># 计算裁剪区域在原图的起始点</span>
	    <span class="token keyword">if</span> <span class="token number">0</span> <span class="token operator">&lt;</span> w <span class="token operator">&lt;=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">and</span> <span class="token number">0</span> <span class="token operator">&lt;</span> h <span class="token operator">&lt;=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
	    	i <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> h<span class="token punctuation">)</span>
	       	j <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> w<span class="token punctuation">)</span>
			
			<span class="token comment"># 进行裁剪+resize操作，底层使用的OpenCV</span>
	        <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
	            <span class="token string">"crop_height"</span><span class="token punctuation">:</span> h<span class="token punctuation">,</span>
	            <span class="token string">"crop_width"</span><span class="token punctuation">:</span> w<span class="token punctuation">,</span>
	            <span class="token string">"h_start"</span><span class="token punctuation">:</span> i <span class="token operator">*</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token punctuation">(</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> h <span class="token operator">+</span> <span class="token number">1e-10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	            <span class="token string">"w_start"</span><span class="token punctuation">:</span> j <span class="token operator">*</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token punctuation">(</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> w <span class="token operator">+</span> <span class="token number">1e-10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	        <span class="token punctuation">}</span>
	
	<span class="token comment"># 尝试10次后，如果上述的【if】条件依然无法满足，则执行下面的代码进行裁剪</span>
	<span class="token comment"># Fallback to central crop</span>
	in_ratio <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
	<span class="token keyword">if</span> in_ratio <span class="token operator">&lt;</span> <span class="token builtin">min</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>ratio<span class="token punctuation">)</span><span class="token punctuation">:</span>
	    w <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
	    h <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>w <span class="token operator">/</span> <span class="token builtin">min</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>ratio<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">elif</span> in_ratio <span class="token operator">&gt;</span> <span class="token builtin">max</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>ratio<span class="token punctuation">)</span><span class="token punctuation">:</span>
	    h <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
	    w <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>h <span class="token operator">*</span> <span class="token builtin">max</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>ratio<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">else</span><span class="token punctuation">:</span>  <span class="token comment"># whole image</span>
	    w <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
	    h <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
	i <span class="token operator">=</span> <span class="token punctuation">(</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> h<span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">2</span>
	j <span class="token operator">=</span> <span class="token punctuation">(</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> w<span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">2</span>
	
	<span class="token comment"># 进行裁剪+resize操作，底层使用的OpenCV</span>
	<span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
	    <span class="token string">"crop_height"</span><span class="token punctuation">:</span> h<span class="token punctuation">,</span>
	    <span class="token string">"crop_width"</span><span class="token punctuation">:</span> w<span class="token punctuation">,</span>
	    <span class="token string">"h_start"</span><span class="token punctuation">:</span> i <span class="token operator">*</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token punctuation">(</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> h <span class="token operator">+</span> <span class="token number">1e-10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	    <span class="token string">"w_start"</span><span class="token punctuation">:</span> j <span class="token operator">*</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token punctuation">(</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> w <span class="token operator">+</span> <span class="token number">1e-10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
                
</code></pre> <p>测试原图</p> <p><img src="https://images2.imgbox.com/2d/85/AGOMcrSl_o.jpg" alt="在这里插入图片描述"><br> 处理后的结果如下图所示：下面三张图，分别使用 0.06，0.5，0.9 的 scale 参数得到的裁剪图，最终 resize 到 256，可以看到被裁剪的范围逐渐增大，由于是随机裁剪，所以裁剪后的区域差别较大</p> <p><img src="https://images2.imgbox.com/47/1a/qQqUpZLK_o.jpg" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/0d/41/avFGnyPp_o.jpg" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/cb/9f/kPlniNvc_o.jpg" alt="在这里插入图片描述"></p> </li><li> <p>空间变换</p> <pre><code class="prism language-python">A<span class="token punctuation">.</span>HorizontalFlip<span class="token punctuation">(</span>p<span class="token operator">=</span>hflip<span class="token punctuation">)</span> <span class="token comment"># 左右翻转</span>
A<span class="token punctuation">.</span>VerticalFlip<span class="token punctuation">(</span>p<span class="token operator">=</span>vflip<span class="token punctuation">)</span>   <span class="token comment"># 上下翻转</span>
</code></pre> <p>处理结果如下图所示（左图：左右翻转，右图：上下翻转），</p> <p><img src="https://images2.imgbox.com/67/3d/NVnMOpgo_o.jpg" alt="在这里插入图片描述"> <img src="https://images2.imgbox.com/b4/b5/E73xI7g1_o.jpg" alt="在这里插入图片描述"></p> </li><li> <p>色彩变换</p> <pre><code class="prism language-python">A<span class="token punctuation">.</span>ColorJitter<span class="token punctuation">(</span><span class="token operator">*</span>color_jitter<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment"># 随机改变图像的亮度，对比度，饱和度</span>
</code></pre> <p>不作介绍</p> </li><li> <p>归一化</p> <pre><code class="prism language-python">A<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span>mean<span class="token operator">=</span>mean<span class="token punctuation">,</span> std<span class="token operator">=</span>std<span class="token punctuation">)</span>  <span class="token comment"># Normalize and convert to Tensor</span>
</code></pre> <p>对于分类模型，通常需要减去均值，除以标准差，得到如下图所示：</p> <p><img src="https://images2.imgbox.com/4a/7b/i1zIX3HP_o.jpg" alt="在这里插入图片描述"></p> </li><li> <p>调整输入排列</p> <pre><code class="prism language-python">ToTensorV2<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
  <blockquote> 
   <p>函数功能：（1）HWC 转为 CHW；（2）numpy 转为 tensor</p> 
  </blockquote> <p>函数的核心源码如下：</p> <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">apply</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> img<span class="token punctuation">,</span> <span class="token operator">**</span>params<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># skipcq: PYL-W0613</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">)</span> <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"Albumentations only supports images in HW or HWC format"</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>
        img <span class="token operator">=</span> np<span class="token punctuation">.</span>expand_dims<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>img<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> </li></ul> 
<hr> 
<h4><a id="32torchvision_239"></a>3.2、数据增强库：torchvision</h4> 
<pre><code class="prism language-python"><span class="token comment"># 官方的预处理方法</span>
    <span class="token keyword">return</span> T<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>CenterCrop<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">,</span> ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> T<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span>IMAGENET_MEAN<span class="token punctuation">,</span> IMAGENET_STD<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li> <p>中心裁剪：CenterCrop(size)<br> 以最小边的大小裁剪长边的中心区域，核心代码如下</p> <pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">CenterCrop</span><span class="token punctuation">:</span>
    <span class="token comment"># YOLOv5 CenterCrop class for image preprocessing, i.e. T.Compose([CenterCrop(size), ToTensor()])</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token number">640</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>h<span class="token punctuation">,</span> self<span class="token punctuation">.</span>w <span class="token operator">=</span> <span class="token punctuation">(</span>size<span class="token punctuation">,</span> size<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token keyword">else</span> size

    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> im<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># im = np.array HWC</span>
        imh<span class="token punctuation">,</span> imw <span class="token operator">=</span> im<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
        m <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>imh<span class="token punctuation">,</span> imw<span class="token punctuation">)</span>  <span class="token comment"># min dimension</span>
        top<span class="token punctuation">,</span> left <span class="token operator">=</span> <span class="token punctuation">(</span>imh <span class="token operator">-</span> m<span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>imw <span class="token operator">-</span> m<span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">2</span>
        <span class="token keyword">return</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>im<span class="token punctuation">[</span>top<span class="token punctuation">:</span>top <span class="token operator">+</span> m<span class="token punctuation">,</span> left<span class="token punctuation">:</span>left <span class="token operator">+</span> m<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>w<span class="token punctuation">,</span> self<span class="token punctuation">.</span>h<span class="token punctuation">)</span><span class="token punctuation">,</span> interpolation<span class="token operator">=</span>cv2<span class="token punctuation">.</span>INTER_LINEAR<span class="token punctuation">)</span>
</code></pre> </li><li> <p>调整输入排列<br> 函数功能：（1）HWC 转为 CHW；（2）BGR 转 RGB；（3）numpy 转为 tensor；<br> 函数的核心源码如下：</p> <pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">ToTensor</span><span class="token punctuation">:</span>
    <span class="token comment"># YOLOv5 ToTensor class for image preprocessing, i.e. T.Compose([LetterBox(size), ToTensor()])</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> half<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>half <span class="token operator">=</span> half

    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> im<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># im = np.array HWC in BGR order</span>
        im <span class="token operator">=</span> np<span class="token punctuation">.</span>ascontiguousarray<span class="token punctuation">(</span>im<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># HWC to CHW -&gt; BGR to RGB -&gt; contiguous</span>
        im <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>im<span class="token punctuation">)</span>  <span class="token comment"># to torch</span>
        im <span class="token operator">=</span> im<span class="token punctuation">.</span>half<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>half <span class="token keyword">else</span> im<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># uint8 to fp16/32</span>
</code></pre> <p><code>T.Normalize(IMAGENET_MEAN, IMAGENET_STD)]</code>：不作介绍</p> </li></ul> 
<hr> 
<h3><a id="4ONNX_CPU__281"></a>4、ONNX CPU 推理</h3> 
<blockquote> 
 <p>主要包括三部分内容：</p> 
 <ol><li>Pt 转为 ONNX 模型；</li><li>ONNX 推理验证（Python）；</li><li>ONNX CPU 推理（C++）；</li></ol> 
</blockquote> 
<h4><a id="41Pt__ONNX_288"></a>4.1、Pt 模型转为 ONNX</h4> 
<p>代码位置：<code>yolov5/export.py</code></p> 
<pre><code class="prism language-python"><span class="token comment"># 针对自己的网络输入大小，注意 imgsz 的设置，默认是640</span>
python export<span class="token punctuation">.</span>py <span class="token operator">-</span><span class="token operator">-</span>weights runs<span class="token operator">/</span>train<span class="token operator">-</span>cls<span class="token operator">/</span>exp24<span class="token operator">/</span>weights<span class="token operator">/</span>best<span class="token punctuation">.</span>pt <span class="token operator">-</span><span class="token operator">-</span>include onnx <span class="token operator">-</span><span class="token operator">-</span>imgsz <span class="token number">256</span>
</code></pre> 
<h4><a id="42ONNX__294"></a>4.2、ONNX 推理验证</h4> 
<p>代码位置：<code>yolov5/classify/val.py</code></p> 
<pre><code class="prism language-python">python classify<span class="token operator">/</span>val<span class="token punctuation">.</span>py <span class="token operator">-</span><span class="token operator">-</span>weights best<span class="token punctuation">.</span>onnx
</code></pre> 
<h4><a id="43_ONNX_CPUC_299"></a>4.3、 ONNX CPU推理（C++）</h4> 
<p><code>main.cpp</code></p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/opencv.hpp&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/highgui/highgui.hpp&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/imgproc/imgproc.hpp&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;onnxruntime_cxx_api.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"helpers.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;algorithm&gt;</span></span>


<span class="token keyword">using</span> <span class="token keyword">namespace</span> cv<span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
 
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;: Parameters too less"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	std<span class="token double-colon punctuation">::</span>string class_path <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>string image_path <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    Ort<span class="token double-colon punctuation">::</span>Env env<span class="token punctuation">;</span>
    Ort<span class="token double-colon punctuation">::</span>Session <span class="token function">session</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Ort<span class="token double-colon punctuation">::</span>SessionOptions sessionOptions<span class="token punctuation">{<!-- --></span><span class="token keyword">nullptr</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">constexpr</span> <span class="token keyword">int64_t</span> numChannles <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token keyword">constexpr</span> <span class="token keyword">int64_t</span> width <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">;</span>
    <span class="token keyword">constexpr</span> <span class="token keyword">int64_t</span> height <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">;</span>
    <span class="token keyword">constexpr</span> <span class="token keyword">int64_t</span> numClasses <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">constexpr</span> <span class="token keyword">int64_t</span> numInputElements <span class="token operator">=</span> numChannles <span class="token operator">*</span> height <span class="token operator">*</span> width<span class="token punctuation">;</span>

    <span class="token keyword">const</span> string imgFile <span class="token operator">=</span> image_path<span class="token punctuation">;</span>
    <span class="token keyword">const</span> string labelFile <span class="token operator">=</span> class_path<span class="token punctuation">;</span>
    <span class="token keyword">auto</span> modelPath <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    sessionOptions <span class="token operator">=</span> <span class="token class-name">Ort</span><span class="token double-colon punctuation">::</span><span class="token function">SessionOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//load labels</span>
    Helpers utils<span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> labels <span class="token operator">=</span> utils<span class="token punctuation">.</span><span class="token function">loadLabels</span><span class="token punctuation">(</span>labelFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>labels<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        cout<span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to load labels: "</span> <span class="token operator">&lt;&lt;</span> labelFile <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//load image</span>
    vector<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span> imageVec <span class="token operator">=</span> utils<span class="token punctuation">.</span><span class="token function">loadImage</span><span class="token punctuation">(</span>imgFile<span class="token punctuation">,</span> height<span class="token punctuation">,</span> width<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>imageVec<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Invalid image format. Must be 224*224 RGB image. "</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// create session</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"create session. "</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    session <span class="token operator">=</span> <span class="token class-name">Ort</span><span class="token double-colon punctuation">::</span><span class="token function">Session</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> modelPath<span class="token punctuation">,</span> sessionOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// get the number of input</span>
    size_t num_input_nodes <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">GetInputCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">&gt;</span> <span class="token function">input_node_names</span><span class="token punctuation">(</span>num_input_nodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">&gt;</span> input_node_dims<span class="token punctuation">;</span>

    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Number of inputs = "</span> <span class="token operator">&lt;&lt;</span> num_input_nodes <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>

    <span class="token comment">// define shape</span>
    <span class="token keyword">const</span> array<span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token operator">&gt;</span> inputShape <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">,</span> numChannles<span class="token punctuation">,</span> height<span class="token punctuation">,</span> width<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> array<span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">&gt;</span> outputShape <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">,</span> numClasses<span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// define array</span>
    array<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token punctuation">,</span> numInputElements<span class="token operator">&gt;</span> input<span class="token punctuation">;</span>
    array<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token punctuation">,</span> numClasses<span class="token operator">&gt;</span> results<span class="token punctuation">;</span>

    <span class="token comment">// define Tensor</span>
    <span class="token keyword">auto</span> memory_info <span class="token operator">=</span> Ort<span class="token double-colon punctuation">::</span><span class="token class-name">MemoryInfo</span><span class="token double-colon punctuation">::</span><span class="token function">CreateCpu</span><span class="token punctuation">(</span>OrtDeviceAllocator<span class="token punctuation">,</span> OrtMemTypeCPU<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> inputTensor <span class="token operator">=</span> Ort<span class="token double-colon punctuation">::</span>Value<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">CreateTensor</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>memory_info<span class="token punctuation">,</span> input<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> input<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> inputShape<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> inputShape<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> outputTensor <span class="token operator">=</span> Ort<span class="token double-colon punctuation">::</span>Value<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">CreateTensor</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>memory_info<span class="token punctuation">,</span> results<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> results<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> outputShape<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> outputShape<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// copy image data to input array</span>
    <span class="token function">copy</span><span class="token punctuation">(</span>imageVec<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> imageVec<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> input<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// define names</span>
    Ort<span class="token double-colon punctuation">::</span>AllocatorWithDefaultOptions ort_alloc<span class="token punctuation">;</span>

    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">&gt;</span> inputNames<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">&gt;</span> outputNames<span class="token punctuation">;</span>
    inputNames<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span><span class="token function">GetInputName</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> ort_alloc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    outputNames<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span><span class="token function">GetOutputName</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> ort_alloc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Input name: "</span> <span class="token operator">&lt;&lt;</span> inputNames<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Output name: "</span> <span class="token operator">&lt;&lt;</span> outputNames<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>

    <span class="token comment">// run inference</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"run inference. "</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token keyword">try</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">auto</span> start <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>system_clock<span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            session<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>Ort<span class="token double-colon punctuation">::</span>RunOptions<span class="token punctuation">{<!-- --></span><span class="token keyword">nullptr</span><span class="token punctuation">}</span><span class="token punctuation">,</span> inputNames<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>inputTensor<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> outputNames<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>outputTensor<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">auto</span> end <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>system_clock<span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">duration_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>milliseconds<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"ms"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span><span class="token punctuation">(</span>Ort<span class="token double-colon punctuation">::</span>Exception<span class="token operator">&amp;</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> e<span class="token punctuation">.</span><span class="token function">what</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// sort results</span>
    vector<span class="token operator">&lt;</span>pair<span class="token operator">&lt;</span>size_t<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">&gt;&gt;</span> indexValuePairs<span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"results.size(): "</span> <span class="token operator">&lt;&lt;</span> results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> results<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"results[i]: "</span> <span class="token operator">&lt;&lt;</span> results<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        indexValuePairs<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> results<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">sort</span><span class="token punctuation">(</span>indexValuePairs<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> indexValuePairs<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> lhs<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> rhs<span class="token punctuation">)</span> 
    <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> lhs<span class="token punctuation">.</span>second <span class="token operator">&gt;</span> rhs<span class="token punctuation">.</span>second<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// show Top5</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> result <span class="token operator">=</span> indexValuePairs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        cout <span class="token operator">&lt;&lt;</span> i <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token string">": "</span> <span class="token operator">&lt;&lt;</span> labels<span class="token punctuation">[</span>result<span class="token punctuation">.</span>first<span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span> <span class="token operator">&lt;&lt;</span> result<span class="token punctuation">.</span>second <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>helpers.h</code></p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/highgui/highgui.hpp&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/imgproc/imgproc.hpp&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/core/core.hpp&gt;</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Helpers</span><span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
	vector<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span> <span class="token function">loadImage</span><span class="token punctuation">(</span><span class="token keyword">const</span> string path<span class="token punctuation">,</span> <span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
	vector<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token function">loadLabels</span><span class="token punctuation">(</span><span class="token keyword">const</span> string path<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> 
<p><code>helpers.cpp</code></p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fstream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;array&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"helpers.h"</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> cv<span class="token punctuation">;</span>


<span class="token keyword">const</span> <span class="token keyword">float</span> mean_vals<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0.3539317f</span><span class="token punctuation">,</span> <span class="token number">0.36820036f</span><span class="token punctuation">,</span> <span class="token number">0.37243055f</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">float</span> scale_vals<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">1.0</span> <span class="token operator">/</span> <span class="token number">0.22637626f</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token number">0.22498632f</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token number">0.22197094f</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">normalize_inplace_kxh</span><span class="token punctuation">(</span>cv<span class="token double-colon punctuation">::</span>Mat <span class="token operator">&amp;</span>mat_inplace<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">float</span> <span class="token operator">*</span>mean<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">float</span> <span class="token operator">*</span>scale<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>mat_inplace<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> CV_32FC3<span class="token punctuation">)</span> mat_inplace<span class="token punctuation">.</span><span class="token function">convertTo</span><span class="token punctuation">(</span>mat_inplace<span class="token punctuation">,</span> CV_32FC3<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mat_inplace<span class="token punctuation">.</span>rows<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    cv<span class="token double-colon punctuation">::</span>Vec3f <span class="token operator">*</span>p <span class="token operator">=</span> mat_inplace<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>Vec3f<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> mat_inplace<span class="token punctuation">.</span>cols<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      p<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>p<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> mean<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> scale<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      p<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>p<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> mean<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> scale<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      p<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>p<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> mean<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> scale<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

vector<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span> <span class="token class-name">Helpers</span><span class="token double-colon punctuation">::</span><span class="token function">loadImage</span><span class="token punctuation">(</span><span class="token keyword">const</span> string filename<span class="token punctuation">,</span> <span class="token keyword">int</span> sizeX<span class="token punctuation">,</span> <span class="token keyword">int</span> sizeY<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    Mat image <span class="token operator">=</span> <span class="token function">imread</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>image<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"No image found."</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// convert from BGR to RGB</span>
    <span class="token function">cvtColor</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> image<span class="token punctuation">,</span> COLOR_BGR2RGB<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// resize</span>
    <span class="token function">resize</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> image<span class="token punctuation">,</span> <span class="token function">Size</span><span class="token punctuation">(</span>sizeX<span class="token punctuation">,</span> sizeY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cv<span class="token double-colon punctuation">::</span>Mat canvas<span class="token punctuation">;</span>
    image<span class="token punctuation">.</span><span class="token function">convertTo</span><span class="token punctuation">(</span>canvas<span class="token punctuation">,</span> CV_32FC3<span class="token punctuation">,</span> <span class="token number">1.</span> <span class="token operator">/</span> <span class="token number">255.f</span><span class="token punctuation">,</span> <span class="token number">0.f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">normalize_inplace_kxh</span><span class="token punctuation">(</span>canvas<span class="token punctuation">,</span> mean_vals<span class="token punctuation">,</span> scale_vals<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// reshape to 1D</span>
    canvas <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">reshape</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// uint_8, [0, 255] -&gt; float, [0, 1]</span>
    <span class="token comment">// Normailze number to between 0 and 1</span>
    <span class="token comment">// Convert to vector&lt;float&gt; from cv::Mat.</span>
    vector<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span> vec<span class="token punctuation">;</span>
    canvas<span class="token punctuation">.</span><span class="token function">convertTo</span><span class="token punctuation">(</span>vec<span class="token punctuation">,</span> CV_32FC1<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Transpose (Height, Width, Channel)(224,224,3) to (Chanel, Height, Width)(3,224,224)</span>
    vector<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span> output<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t ch <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ch <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token operator">++</span>ch<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> ch<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> vec<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            output<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>vec<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> output<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

vector<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token class-name">Helpers</span><span class="token double-colon punctuation">::</span><span class="token function">loadLabels</span><span class="token punctuation">(</span><span class="token keyword">const</span> string filename<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    vector<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> output<span class="token punctuation">;</span>

    ifstream <span class="token function">file</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        string s<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">getline</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            output<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        file<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> output<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>CMakeLists.txt</p> 
<pre><code class="prism language-bash">cmake_minimum_required<span class="token punctuation">(</span>VERSION <span class="token number">3.0</span>.0<span class="token punctuation">)</span>
project<span class="token punctuation">(</span>demo VERSION <span class="token number">0.1</span>.0<span class="token punctuation">)</span>
set<span class="token punctuation">(</span>CMAKE_CXX_STANDARD <span class="token number">14</span><span class="token punctuation">)</span>

<span class="token comment"># Set(ONNXRUNTIME_DIR /home/yp/onnx/onnxruntime-linux-x64-gpu-1.12.1)</span>
Set<span class="token punctuation">(</span>ONNXRUNTIME_DIR /home/robot/Project/onnx_demo/onnxruntime-linux-x64-1.12.1<span class="token punctuation">)</span>
message<span class="token punctuation">(</span>STATUS <span class="token string">"ONNXRUNTIME_DIR: <span class="token variable">${ONNXRUNTIME_DIR}</span>"</span><span class="token punctuation">)</span>


include<span class="token punctuation">(</span>CTest<span class="token punctuation">)</span>
include_directories<span class="token punctuation">(</span><span class="token variable">${PROJECT_SOURCE_DIR}</span>/include<span class="token punctuation">)</span>
<span class="token comment"># enable_testing()</span>

<span class="token comment"># find_package(OpenCV 4.3 REQUIRED)</span>
list<span class="token punctuation">(</span>APPEND CMAKE_PREFIX_PATH <span class="token string">"/usr/local/opencv4.3"</span><span class="token punctuation">)</span>
find_package<span class="token punctuation">(</span> OpenCV REQUIRED <span class="token punctuation">)</span>
<span class="token comment"># find_package( OpenCV 4.3 REQUIRED ) </span>
include_directories<span class="token punctuation">(</span> <span class="token variable">${OpenCV_INCLUDE_DIRS}</span> <span class="token punctuation">)</span>
add_executable<span class="token punctuation">(</span>demo <span class="token variable">${PROJECT_SOURCE_DIR}</span>/main.cpp <span class="token variable">${PROJECT_SOURCE_DIR}</span>/src/helpers.cpp<span class="token punctuation">)</span>

target_link_libraries<span class="token punctuation">(</span>demo <span class="token variable">${OpenCV_LIBS}</span><span class="token punctuation">)</span>
target_include_directories<span class="token punctuation">(</span>demo PRIVATE <span class="token string">"<span class="token variable">${ONNXRUNTIME_DIR}</span>/include"</span><span class="token punctuation">)</span>
target_link_libraries<span class="token punctuation">(</span>demo <span class="token string">"<span class="token variable">${ONNXRUNTIME_DIR}</span>/lib/libonnxruntime.so"</span><span class="token punctuation">)</span>

set<span class="token punctuation">(</span>CPACK_PROJECT_NAME <span class="token variable">${PROJECT_NAME}</span><span class="token punctuation">)</span>
set<span class="token punctuation">(</span>CPACK_PROJECT_VERSION <span class="token variable">${PROJECT_VERSION}</span><span class="token punctuation">)</span>
include<span class="token punctuation">(</span>CPack<span class="token punctuation">)</span>
</code></pre> 
<p>编译脚本： <code>build.sh</code></p> 
<pre><code class="prism language-bash"><span class="token function">mkdir</span> build
<span class="token builtin class-name">cd</span> build
cmake <span class="token punctuation">..</span>
<span class="token function">make</span> <span class="token parameter variable">-j4</span>
</code></pre> 
<p>运行脚本： <code>run.sh</code></p> 
<pre><code class="prism language-bash"><span class="token assign-left variable">data_path</span><span class="token operator">=</span>/home/robot/Project/onnx_demo/onnxruntime_resnet-main/assets/1664450262_1664708729_02597_003.jpg
<span class="token assign-left variable">model_path</span><span class="token operator">=</span>/home/robot/Project/onnx_demo/onnxruntime_resnet-main/assets/best.onnx
<span class="token assign-left variable">class_path</span><span class="token operator">=</span>/home/robot/Project/onnx_demo/onnxruntime_resnet-main/assets/imagenet_classes.txt

./build/demo <span class="token variable">$model_path</span> <span class="token variable">$class_path</span> <span class="token variable">$data_path</span>
</code></pre> 
<hr> 
<h3><a id="5RK_1808__581"></a>5、RK 1808 部署</h3> 
<blockquote> 
 <p>主要流程包括：<br> （1）查看模型的输入和输出节点名称；<br> （2）PC模拟器模型转换为RKNN，以及推理；<br> （3）C++部署；</p> 
</blockquote> 
<h4><a id="51_588"></a>5.1、查看模型输入、输出名字</h4> 
<p>使用 Netron 打开 ONNX模型，如下图所示，可以得到【<font color="Fuchsia">输入，输出</font>】节点的名称，分别为【<font color="Fuchsia">images，output0</font>】，后面转换模型的时候，需要指定输入和输出节点名称，<br> <img src="https://images2.imgbox.com/c7/10/LYIUyrg7_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/9b/f4/c0vVN3FF_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<h4><a id="52RKNN_594"></a>5.2、转换为RKNN模型</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> urllib
<span class="token keyword">import</span> traceback
<span class="token keyword">import</span> time
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> cv2
<span class="token keyword">from</span> rknn<span class="token punctuation">.</span>api <span class="token keyword">import</span> RKNN

ONNX_MODEL <span class="token operator">=</span> <span class="token string">'best.onnx'</span>
RKNN_MODEL <span class="token operator">=</span> <span class="token string">'best.rknn'</span>


<span class="token keyword">def</span> <span class="token function">show_outputs</span><span class="token punctuation">(</span>outputs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output <span class="token operator">=</span> outputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    output_sorted <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>output<span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    top5_str <span class="token operator">=</span> <span class="token string">'resnet50v2\n-----TOP 5-----\n'</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        value <span class="token operator">=</span> output_sorted<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        index <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>output <span class="token operator">==</span> value<span class="token punctuation">)</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> j<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">5</span><span class="token punctuation">:</span>
              <span class="token keyword">break</span>
            <span class="token keyword">if</span> value <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
                topi <span class="token operator">=</span> <span class="token string">'{}: {}\n'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>index<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                topi <span class="token operator">=</span> <span class="token string">'-1: 0.0\n'</span>
            top5_str <span class="token operator">+=</span> topi
    <span class="token keyword">print</span><span class="token punctuation">(</span>top5_str<span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>

    <span class="token comment"># Create RKNN object</span>
    rknn <span class="token operator">=</span> RKNN<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment"># pre-process config</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'--&gt; Config model'</span><span class="token punctuation">)</span>
    rknn<span class="token punctuation">.</span>config<span class="token punctuation">(</span>mean_values<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">90.253</span><span class="token punctuation">,</span> <span class="token number">93.891</span><span class="token punctuation">,</span> <span class="token number">94.97</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> std_values<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">57.726</span><span class="token punctuation">,</span> <span class="token number">57.372</span><span class="token punctuation">,</span> <span class="token number">56.603</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> reorder_channel<span class="token operator">=</span><span class="token string">'0 1 2'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'done'</span><span class="token punctuation">)</span>

    <span class="token comment"># Load ONNX model</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'--&gt; Loading model'</span><span class="token punctuation">)</span>
    ret <span class="token operator">=</span> rknn<span class="token punctuation">.</span>load_onnx<span class="token punctuation">(</span>model<span class="token operator">=</span>ONNX_MODEL<span class="token punctuation">,</span>
                         inputs<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'images'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                         input_size_list<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                         outputs<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'output0'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Load resnet50v2 failed!'</span><span class="token punctuation">)</span>
        exit<span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'done'</span><span class="token punctuation">)</span>

    <span class="token comment"># Build model</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'--&gt; Building model'</span><span class="token punctuation">)</span>
    ret <span class="token operator">=</span> rknn<span class="token punctuation">.</span>build<span class="token punctuation">(</span>do_quantization<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> dataset<span class="token operator">=</span><span class="token string">'./dataset.txt'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Build resnet50v2 failed!'</span><span class="token punctuation">)</span>
        exit<span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'done'</span><span class="token punctuation">)</span>

    <span class="token comment"># Export RKNN model</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'--&gt; Export RKNN model'</span><span class="token punctuation">)</span>
    ret <span class="token operator">=</span> rknn<span class="token punctuation">.</span>export_rknn<span class="token punctuation">(</span>RKNN_MODEL<span class="token punctuation">)</span>
    <span class="token keyword">if</span> ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Export resnet50v2.rknn failed!'</span><span class="token punctuation">)</span>
        exit<span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'done'</span><span class="token punctuation">)</span>
    <span class="token comment"># Set inputs</span>
    img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">'./2_256x256.jpg'</span><span class="token punctuation">)</span>
    img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>img<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2RGB<span class="token punctuation">)</span>

    <span class="token comment"># init runtime environment</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'--&gt; Init runtime environment'</span><span class="token punctuation">)</span>
    ret <span class="token operator">=</span> rknn<span class="token punctuation">.</span>init_runtime<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Init runtime environment failed'</span><span class="token punctuation">)</span>
        exit<span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'done'</span><span class="token punctuation">)</span>
    
    <span class="token comment"># Inference</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'--&gt; Running model'</span><span class="token punctuation">)</span>
    t1 <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    outputs <span class="token operator">=</span> rknn<span class="token punctuation">.</span>inference<span class="token punctuation">(</span>inputs<span class="token operator">=</span><span class="token punctuation">[</span>img<span class="token punctuation">]</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> outputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    output <span class="token operator">=</span> np<span class="token punctuation">.</span>exp<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token operator">/</span>np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>exp<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
    outputs <span class="token operator">=</span> <span class="token punctuation">[</span>output<span class="token punctuation">]</span>

    t2 <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'inference time: '</span><span class="token punctuation">,</span> t2<span class="token operator">-</span>t1<span class="token punctuation">)</span>

    show_outputs<span class="token punctuation">(</span>outputs<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'done'</span><span class="token punctuation">)</span>

    rknn<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<hr> 
<h4><a id="53C__694"></a>5.3、C++ 芯片部署</h4> 
<p>对于分类模型的部署，可以参考官方的例子，几乎不需要更改太多代码，编译即可使用，这里不作详细解释</p> 
<blockquote> 
 <p><font color="Fuchsia">RK工具链Demo</font> ：<a href="https://github.com/rockchip-linux/rknpu/tree/master/rknn/rknn_api/examples/rknn_mobilenet_demo">https://github.com/rockchip-linux/rknpu/tree/master/rknn/rknn_api/examples/rknn_mobilenet_demo</a><br> <font color="Fuchsia">个人总结的博客</font>：<a href="https://blog.csdn.net/kxh123456/article/details/129370265?spm=1001.2014.3001.5502">Rockchip RV1126 模型部署（完整部署流程）</a>，该例子与1808共用一套工具链，可以作为参考</p> 
</blockquote> 
<hr> 
<h3><a id="6_701"></a>6、调优策略</h3> 
<blockquote> 
 <p>调优策略，也不是很方便介绍太细，下面只从几个大的方面介绍一些注意问题，比如数据标注，数据清洗，模型调优等。</p> 
</blockquote> 
<h4><a id="61_705"></a>6.1、数据标注</h4> 
<p>当我们面临一个实际场景时，基本的工作流程应该如下：</p> 
<blockquote> 
 <ol><li>采集数据：获取该场景下的数据样本，前期可以先采集一部分，验证整个过程。后续随着算法的调优和遇到的问题，数据采集也可能有一定的要求；</li><li>设计标注规则：比如一张图片应该标注什么标签。有些图片内容对应的标签是模糊不清的，判断可能也不唯一。此时，可能需要看我们关注的点是什么？训练的侧重不同，可能决定一张图片的标签是什么？所以关键是如何定义任务。根据训练的结果，以及项目的侧重点差异，可能会影响标签的标注（比如，我们更关注类别1的分类正确性，那么如果测试集，类别1的预测非常好，但是类别2,3相对较差，并且类别2,3多是相互预测错误，那么根据项目的需要，也是可以接受的）；</li></ol> 
</blockquote> 
<h4><a id="62_712"></a>6.2、数据清洗</h4> 
<p>通常我们需要先标注一组数据，根据自己数据集的规模，比如取出10%的规模进行训练测试。使用该数据训练网络，并得到初版的效果。此时我们推理测试集，查看测试集的预测情况，错误有哪些，为什么会错？是网络本身的问题，还是该图片本身的标签定义就很模糊呢？</p> 
<blockquote> 
 <ol><li>脏数据清洗：表示数据质量非常差，完全不可用，比如严重曝光，全黑数据，严重模糊，完全遮挡等；</li><li>标签模糊定义：有的数据标签比较难以定义，就分类问题而言，通常提取的是图像的全局+局部特征，有时候图片内同时存在目标特征和非目标特征，就存在定义类别的问题；</li><li>样本划分：当我们训练了一版基本的模型，准确度达到一定的高度。但是，当我们去推理测试集时，总有一些样本预测错误。此时，我们不妨预测一遍训练集，将预测错误的样本提取出来，逐个核对样本，确认是标签本身错误？特征不明显？困难样本？此时，再针对性的解决问题；</li></ol> 
</blockquote> 
<h4><a id="63_719"></a>6.3、网络调优</h4> 
<p>实际项目中，重点可能是数据的清洗，网络的调整比较有限，可以调整的有如下几方面，具体流程如下：</p> 
<blockquote> 
 <ol><li>网络结构：根据部署设备的性能，选择合适大小，应用较为广泛，易部署的模型；</li><li>超参数：学习率，batch-size等；</li><li>网络泛化：正则化，dropout，soft-label；</li></ol> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4c09ab8e812bad673d72f14d560f7898/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">前端界面网页截图(干货)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0530895985ee4d9367bb1965affb4194/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">解决编译时提示“没有那个文件或目录 #include ＜pcap.h＞”的问题</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>