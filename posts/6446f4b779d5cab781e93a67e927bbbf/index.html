<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>odoo-服务器上的安装和部署 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="odoo-服务器上的安装和部署" />
<meta property="og:description" content="odoo安装和服务器部署 转载自：原文，并记录了一些自己在实操过程中常出现的一些问题及解决方法。
仅针对odoo12和ubuntu18.04
由于ubuntu禁用了root账户，初始账户可通过sudo来获得root权限，也可通过修改root密码进入root账户
sudo passwd root su root 安装进行之前，切换到根目录
更新apt sudo apt update sudo apt upgrade -y 安装postgres数据库 下载并创建数据库，并让当前用户成为数据库超级用户
sudo apt install postgresql -y sudo su -c &#34;createuser -s $USER&#34; postgres#指定定当前用户为postgresql的超级管理员账户 安装postgresql 10：
apt install postgresql-10-postgis-2.4 -y 有时postgres数据库服务没有启动，采用如下命令启动：
/etc/init.d/postgresql start 在WSL上，如果windows上安装了postgres，linux也安装了，linux的数据库服务可能无法启动，此时可修改数据库端口
vim /etc/postgresql/11/main/postgresql.conf 配置文件中默认端口号为5432：
port = 5432 可修改为5433或者5434（在odoo.conf文件中需要配置）
安装系统依赖 sudo apt update sudo apt upgrade sudo apt install git -y # 安装Git sudo apt-get install git python3-dev python3-pip -y sudo apt install build-essential libxslt-dev libzip-dev libldap2-dev libsasl2-dev libssl-dev -y 安装wkhtmltox wget &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/6446f4b779d5cab781e93a67e927bbbf/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-07-10T14:16:06+08:00" />
<meta property="article:modified_time" content="2019-07-10T14:16:06+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">odoo-服务器上的安装和部署</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="odoo_0"></a>odoo安装和服务器部署</h3> 
<p>转载自：<a href="https://alanhou.org/odoo12-deployment/" rel="nofollow">原文</a>，并记录了一些自己在实操过程中常出现的一些问题及解决方法。</p> 
<p><em>仅针对odoo12和ubuntu18.04</em><br> 由于ubuntu禁用了root账户，初始账户可通过sudo来获得root权限，也可通过修改root密码进入root账户</p> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> <span class="token function">passwd</span> root
<span class="token function">su</span> root
</code></pre> 
<p>安装进行之前，切换到根目录</p> 
<h5><a id="apt_11"></a>更新apt</h5> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> apt update
<span class="token function">sudo</span> apt upgrade -y
</code></pre> 
<h5><a id="postgres_16"></a>安装postgres数据库</h5> 
<p>下载并创建数据库，并让当前用户成为数据库超级用户</p> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> apt <span class="token function">install</span> postgresql -y
<span class="token function">sudo</span> <span class="token function">su</span> -c <span class="token string">"createuser -s <span class="token variable">$USER</span>"</span> postgres<span class="token comment">#指定定当前用户为postgresql的超级管理员账户</span>
</code></pre> 
<p>安装postgresql 10：</p> 
<pre><code class="prism language-shell">apt <span class="token function">install</span> postgresql-10-postgis-2.4 -y
</code></pre> 
<p>有时postgres数据库服务没有启动，采用如下命令启动：</p> 
<pre><code class="prism language-shell">/etc/init.d/postgresql start
</code></pre> 
<p>在WSL上，如果windows上安装了postgres，linux也安装了，linux的数据库服务可能无法启动，此时可修改数据库端口</p> 
<pre><code class="prism language-shell">vim /etc/postgresql/11/main/postgresql.conf
</code></pre> 
<p>配置文件中默认端口号为5432：</p> 
<pre><code>port = 5432
</code></pre> 
<p>可修改为5433或者5434（在odoo.conf文件中需要配置）</p> 
<h5><a id="_39"></a>安装系统依赖</h5> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> apt update
<span class="token function">sudo</span> apt upgrade
<span class="token function">sudo</span> apt <span class="token function">install</span> <span class="token function">git</span> -y <span class="token comment"># 安装Git</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> <span class="token function">git</span> python3-dev python3-pip -y
<span class="token function">sudo</span> apt <span class="token function">install</span> build-essential libxslt-dev libzip-dev libldap2-dev libsasl2-dev libssl-dev -y
</code></pre> 
<h5><a id="wkhtmltox_47"></a>安装wkhtmltox</h5> 
<pre><code class="prism language-shell"><span class="token function">wget</span> <span class="token string">"https://github.com/wkhtmltopdf/wkhtmltopdf/releases/download/0.12.5/wkhtmltox_0.12.5-1.xenial_amd64.deb"</span> -O /tmp/wkhtml.deb
<span class="token function">sudo</span> dpkg -i /tmp/wkhtml.deb
<span class="token function">sudo</span> <span class="token function">apt-get</span> -fy <span class="token function">install</span> <span class="token comment"># 处理依赖错误</span>
</code></pre> 
<p>具体安装过程：</p> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> <span class="token function">apt-get</span> -f <span class="token function">install</span>
<span class="token function">sudo</span> <span class="token function">wget</span> https://github.com/wkhtmltopdf/wkhtmltopdf/releases/download/0.12.1/wkhtmltox-0.12.1_linux-trusty-amd64.debsudo dpkg -i wkhtmltox-0.12.1_linux-trusty-amd64.deb
<span class="token function">sudo</span> <span class="token function">cp</span> /usr/local/bin/wkhtmltoimage /usr/bin/wkhtmltoimage
<span class="token function">sudo</span> <span class="token function">cp</span> /usr/local/bin/wkhtmltopdf /usr/bin/wkhtmltopdf
</code></pre> 
<h5><a id="Gdata_60"></a>安装Gdata（可选）</h5> 
<pre><code>cd /opt/odoo
sudo wget https://pypi.python.org/packages/a8/70/bd554151443fe9e89d9a934a7891aaffc63b9cb5c7d608972919a002c03c/gdata-2.0.18.tar.gz
sudo tar zxvf gdata-2.0.18.tar.gzsudo chown -R odoo: gdata-2.0.18sudo -scd gdata-2.0.18/
python3 setup.py install
exit
</code></pre> 
<h5><a id="odoo120_69"></a>安装odoo12.0源码</h5> 
<pre><code class="prism language-shell"><span class="token function">mkdir</span> ~/odoo 
<span class="token function">cd</span> ~/odoo
<span class="token function">git</span> clone https://github.com/odoo/odoo.git -b 12.0 --depth<span class="token operator">=</span>1 <span class="token comment"># 获取 Odoo 源码</span>
</code></pre> 
<h5><a id="odoopython_75"></a>安装odoo需要的python包</h5> 
<pre><code class="prism language-shell">pip3 <span class="token function">install</span> -r ~/odoo-dev/odoo/requirements.txt
pip3 <span class="token function">install</span> num2words phonenumbers psycopg2-binary watchdog xlwt

</code></pre> 
<h5><a id="_81"></a>准备独立的用户</h5> 
<p>从安全角度建议使用独立的用户运行 Odoo，这一用户不带有任何系统的特权。为此我们需要创建系统和数据库用户，使用命令如下：</p> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> adduser --disabled-password --gecos <span class="token string">"Odoo"</span> odoo
<span class="token function">sudo</span> <span class="token function">su</span> -c <span class="token string">"createuser odoo"</span> postgres
createdb --owner<span class="token operator">=</span>odoo odoo-prod
</code></pre> 
<p>以上odoo 为用户名，odoo-prod用于运行 Odoo 实例的数据库名。odoo用户成为了odoo-prod数据库的所有者。也就说它对该数据库有创建和删除的权限，包括删除整个数据库的权限。如果你运行的是多租户服务器，应为每个租户创建一个类似 odoo 的指定系统用户。</p> 
<h5><a id="_89"></a>初始化数据库</h5> 
<p>一般运行前odoo会初始化数据库，也可以手动初始化，未初始化数据可能导致静态文件加载错误</p> 
<pre><code class="prism language-shell">~/odoo-dev/odoo/odoo-bin -d odoo-prod
</code></pre> 
<h5><a id="sass_94"></a>安装sass编译器</h5> 
<p>odoo12采用了sass编译，而非less</p> 
<pre><code class="prism language-shell"><span class="token function">cd</span> /usr/local/lib/
<span class="token function">sudo</span> <span class="token function">git</span> clone https://github.com/sass/sassc.git --branch 3.4.2 --depth 1
<span class="token function">sudo</span> <span class="token function">git</span> clone https://github.com/sass/libsass.git --branch 3.4-stable --depth 1
<span class="token function">sudo</span> <span class="token function">git</span> clone https://github.com/sass/sass-spec.git --depth<span class="token operator">=</span>1
<span class="token keyword">echo</span> <span class="token string">'SASS_LIBSASS_PATH="/usr/local/lib/libsass"'</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> -a /etc/environment
<span class="token function">source</span> /etc/environment
<span class="token function">sudo</span> <span class="token function">make</span> -C libsass
<span class="token function">sudo</span> <span class="token function">make</span> -C sassc
<span class="token function">sudo</span> <span class="token function">make</span> -C sassc <span class="token function">install</span>
</code></pre> 
<p>less的安装如下：</p> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> apt update
<span class="token function">sudo</span> apt upgrade
<span class="token function">sudo</span> apt <span class="token function">install</span> <span class="token function">git</span> -y <span class="token comment"># 安装Git</span>
<span class="token function">sudo</span> apt <span class="token function">install</span> python3-dev python3-pip -y <span class="token comment"># Python 3 for dev</span>
<span class="token function">sudo</span> apt <span class="token function">install</span> build-essential libxslt-dev libzip-dev libldap2-dev libsasl2-dev libssl-dev -y
</code></pre> 
<h5><a id="_115"></a>设置配置文件</h5> 
<pre><code class="prism language-shell。">sudo su -c "~/odoo-12/odoo-bin -d odoo-prod --db-filter='^odoo-prod$' --without-demo=all -i base --save --stop-after-init" odoo
</code></pre> 
<p>在启动 Odoo 服务时添加–save参数会将配置保存到~/.odoorc文件中，或在debian文件夹中的odoo.conf文件。我们将以这个文件作为服务配置的初始文件，将其保存到/etc/odoo下，使用命令如下：</p> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> <span class="token function">mkdir</span> /etc/odoo
<span class="token function">sudo</span> <span class="token function">cp</span> /home/odoo/odoo/debian/odoo.conf /etc/odoo/odoo.conf
<span class="token function">sudo</span> <span class="token function">chown</span> -R odoo /etc/odoo
<span class="token function">sudo</span> <span class="token function">chmod</span> u<span class="token operator">=</span>r,g<span class="token operator">=</span>rw,o<span class="token operator">=</span>r /etc/odoo/odoo.conf <span class="token comment"># 安全加固使用</span>
</code></pre> 
<p>以上命令最后一行是可选的，但它提升了系统的安全性。它确保运行 Odoo 进程的用户可以读取但无法修改配置文件。这时你将无法修改数据库主密码，但在生产服务下这不是什么问题，因为应使用list_db=False服务配置来禁用网页数据库管理员。我们还需为 Odoo 服务创建一个存储日志文件的目录。这通常放在/var/log目录下，命令如下:</p> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> <span class="token function">mkdir</span> /var/log/odoo
<span class="token function">sudo</span> <span class="token function">chown</span> odoo /var/log/odoo
</code></pre> 
<p>现在让我们通过如下命令编辑配置文件并确保已配置了一些重要参数：</p> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> <span class="token function">nano</span> /etc/odoo/odoo.conf
</code></pre> 
<p>以下是大部分重要参数的推荐值：</p> 
<pre><code>[options]
addons_path = /home/odoo/odoo-12/odoo/addons,/home/odoo/odoo-12/addons
admin_passwd = False
db_name = odoo-prod
dbfilter = ^odoo-prod$
http_port = 8069
list_db = False
logfile = /var/log/odoo/odoo-server.log
proxy_mode = True
without_demo = all
workers = 6
</code></pre> 
<p>下面逐一讲解：</p> 
<ul><li>addons_path是一组逗号分隔的用于查找插件模块的路径。读取顺序为从左到右，最左边目录的优先级最高.</li><li>admin_passwd是访问网页客户端数据库管理功能的主密码。一定要设置复杂的密码，或者最好是设为 False来关闭这一功能。</li><li>db_name是在服务启动时初始化的数据库实例。</li><li>dbfilter用于过滤可访问的数据库，它是一个 Python 解释的正则表达式。为使用户无需弹出窗口选择数据库，并使未经身份验证的 URL 可正常运作，应设置为^dbname<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ， 
         
        
          比 
         
        
          如 
         
        
          d 
         
        
          b 
         
        
          f 
         
        
          i 
         
        
          l 
         
        
          t 
         
        
          e 
         
        
          r 
         
         
         
           = 
          
         
           o 
          
         
        
          d 
         
        
          o 
         
        
          o 
         
        
          − 
         
        
          p 
         
        
          r 
         
        
          o 
         
        
          d 
         
        
       
         ，比如dbfilter=^odoo-prod 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.88888em; vertical-align: -0.19444em;"></span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">比</span><span class="mord cjk_fallback">如</span><span class="mord mathit">d</span><span class="mord mathit">b</span><span class="mord mathit" style="margin-right: 0.10764em;">f</span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right: 0.01968em;">l</span><span class="mord mathit">t</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel"><span class="mrel">=</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.664392em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight">o</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.77777em; vertical-align: -0.08333em;"></span><span class="mord mathit">d</span><span class="mord mathit">o</span><span class="mord mathit">o</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.88888em; vertical-align: -0.19444em;"></span><span class="mord mathit">p</span><span class="mord mathit" style="margin-right: 0.02778em;">r</span><span class="mord mathit">o</span><span class="mord mathit">d</span></span></span></span></span>。它支持%h和%d占位符，由 HTTP 请求主机名和子域名进行替换。</li><li>http_port是服务器监听的端口号，默认使用的是8069</li><li>list_db = False在 RPC级别和 UI 上屏蔽数据库列表，并屏蔽数据库管理界面以及相应的 RPC 功能。</li><li>logfile是服务日志写入的位置。对于系统服务，一般位于/var/log文件夹内。如果留空，日志会转而在标准输出中打印。</li><li>proxy_mode在需要反向代理访问时应设为True，我们需要用到反向代理。</li><li>without_demo在生产环境中应进行设置，这样新建的数据库中不会带有演示数据。</li><li>workers的值在大于等于2时启用多进程，一会儿我们会进一步的讨论。<br> 从安全角度看，admin_passwd=False和list_db=False选项尤为重要。它们屏蔽掉对数据库管理功能的网页端访问，在生产环境和面向外网的 Odoo 服务中都应进行设置。</li></ul> 
<p>以下也是会用到的参数：</p> 
<ul><li>data_dir是会话数据和附件存储的路径，记住将备份放在这里</li><li>http_interface设置监听的地址。默认监听0.0.0.0，但在使用反向代理时应设置为127.0.0.1来仅响应本地请求。Odoo 11中引入它来代替淘汰了的xmlrpc_interface参数。</li><li>我们可通过-c或–config选项来检查运行服务的设置：</li></ul> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> <span class="token function">su</span> -c <span class="token string">"~/odoo-12/odoo-bin -c /etc/odoo/odoo.conf"</span> odoo
</code></pre> 
<p>通过上述设置运行 Odoo 不会在终端中有任何输出，因为修改都写到了配置文件中定义的日志文件中了。要追踪服务的操作，我们需要在终端中运行如下命令：</p> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> <span class="token function">tail</span> -f /var/log/odoo/odoo-server.log
</code></pre> 
<p>如果运行时出现database not initialized的error，需要在运行时加入参数:</p> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> <span class="token function">su</span> -c <span class="token string">"~/odoo-12/odoo-bin -c /etc/odoo/odoo.conf -i base"</span> odoo 
</code></pre> 
<h5><a id="_Odoo__178"></a>设置 Odoo 为系统服务</h5> 
<h6><a id="systemd_179"></a>创建systemd服务</h6> 
<p>如果你使用的是较近的操作系统，如Debian 8或Ubuntu 16.04，你的启动服务就应该是systemd。要在系统中添加服务，只需创建一个描述服务的文件。我们创建/lib/systemd/system/odoo.service文件并加入如下内容：</p> 
<pre><code>[Unit]
Description=Odoo
After=postgresql.service
 
[Service]
Type=simple
User=odoo
Group=odoo
ExecStart=/home/odoo/odoo-12/odoo-bin -c /etc/odoo/odoo.conf
 
[Install]
WantedBy=multi-user.target
</code></pre> 
<p>下一步我们需要使用如下命令来注册这个新服务：</p> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> systemctl <span class="token function">enable</span> odoo.service
</code></pre> 
<p>使用如下命令启动该服务：</p> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> systemctl start odoo
</code></pre> 
<p>使用如下命令检查该服务状态：</p> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> systemctl status odoo
</code></pre> 
<p>最后，如需停止服务，请使用如下命令：</p> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> systemctl stop odoo
</code></pre> 
<h6><a id="Upstartsysvinit__211"></a>创建Upstart或sysvinit 服务</h6> 
<p>老版本Linux系统（ubuntu16.04以下的版本），如需请至原博查找</p> 
<h6><a id="_Odoo__214"></a>使用命令行检查 Odoo 服务</h6> 
<p>现在我们可以确定Odoo实例是否运行以及是否能正常对请求进行响应。如果Odoo正常运行，我们应该可以得到响应并且日志文件中不会报错。在服务器上通过如下命令可检测 Odoo 是否对HTTP请求进行响应：</p> 
<pre><code class="prism language-shell"><span class="token function">curl</span> http://localhost:8069
<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span><span class="token operator">&lt;</span>head<span class="token operator">&gt;</span><span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>window.location <span class="token operator">=</span> <span class="token string">'/web'</span> + location.hash<span class="token punctuation">;</span><span class="token operator">&lt;</span>/script<span class="token operator">&gt;</span><span class="token operator">&lt;</span>/head<span class="token operator">&gt;</span><span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
</code></pre> 
<p>此外通过如下命令可查看日志文件的内容：</p> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> <span class="token function">less</span> /var/log/odoo/odoo-server.log
</code></pre> 
<p>你还可以使用tail -f 来实时查看日志文件中新增的内容：</p> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> <span class="token function">tail</span> -f /var/log/odoo/odoo-server.log
</code></pre> 
<h5><a id="_Nginx__228"></a>设置 Nginx 反向代理</h5> 
<p>首先，我们应当安装Nginx，我们需要它监听默认的HTTP端口，所以需要确保没有被其它服务所占用。执行如下命令应该会报错：</p> 
<pre><code class="prism language-shell">$ <span class="token function">curl</span> http://localhost
curl: <span class="token punctuation">(</span>7<span class="token punctuation">)</span> Failed to connect to localhost port 80: Connection refused
</code></pre> 
<p>如果没有收到错误，应当禁用相应服务来让Nginx使用该端口。例如，关闭已有的Apache服务，使用sudo service apache2 stop。更好的选择是从服务器上删除该服务或重新配置让其监听其它端口，这样Nginx就可以正常使用HTTP和HTTPS端口(80 and 443) 了。</p> 
<p>一旦完成上述操作，就可以安装Nginx了：</p> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> nginx -y
<span class="token function">sudo</span> <span class="token function">service</span> nginx start <span class="token comment"># 如尚未启动，启动Nginx服务</span>
</code></pre> 
<p>要确定Nginx是否正确运行，通过浏览器访问或在服务上执行curl <a href="http://xn--localhostWelcome-3l9yvv54izvxfui364dj4ek142a" rel="nofollow">http://localhost应该可以得到一个Welcome</a> to nginx页面。<br> Nginx配置文件和Apache的方式基本相同，存储在/etc/nginx/available-sites/中，并可通过在/etc/nginx/enabled-sites/中添加软链接来激活。注意应同时关闭Nginx安装时默认带有的配置：</p> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> <span class="token function">rm</span> /etc/nginx/sites-enabled/default
<span class="token function">sudo</span> <span class="token function">touch</span> /etc/nginx/sites-available/odoo
<span class="token function">sudo</span> <span class="token function">ln</span> -s /etc/nginx/sites-available/odoo /etc/nginx/sites-enabled/odoo
</code></pre> 
<p>使用nano或vi等编辑器来编辑 Nginx配置文件：</p> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> <span class="token function">nano</span> /etc/nginx/sites-available/odoo
</code></pre> 
<p>一个基本的针对Odoo服务的Nginx配置文件如下例所示：</p> 
<pre><code>upstream odoo {
    server 127.0.0.1:8069;
}
upstream odoochat {
    server 127.0.0.1:8072;
}
server {
     listen 80;
     # Add Headers for odoo proxy mode
     proxy_set_header X-Forwarded-Host $host;
     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
     proxy_set_header X-Forwarded-Proto $scheme;
     proxy_set_header X-Real-IP $remote_addr;

     # log
     access_log /var/log/nginx/odoo.access.log;
     error_log /var/log/nginx/odoo.error.log;
     # Redirect longpoll requests to odoo longpolling port
     location /longpolling {
        proxy_pass http://odoochat;
     }
     # Redirect requests to odoo backend server
     location / {
         proxy_redirect off;
         proxy_pass http://odoo;
     }
     # common gzip
    gzip_types text/css text/scss text/plain text/xml application/xml application/json application/javascript;
    gzip on;
}
</code></pre> 
<p>补充：添加域名请在server 配置区内添加对 server_name 的配置<br> 首先为Odoo服务添加了upstream配置，监听了默认端口8069和8072。8069用于网页客户端和RPC请求，8072用于多进程时 Odoo 实时消息所需的长轮询(long polling)请求。</p> 
<p>Nginx应在默认HTTP端口80上接收访问流量，然后重定向到upstream odoo服务中。这在server配置区中进行了定义。/longpolling 地址的访问流量会传递到upstream odoochat，剩余的流量则传递到upstream odoo。这里我们还添加了一些请求头的信息，这样 Odoo 后台服务就会知道这些是经过代理的流量。</p> 
<p>出于安全考虑，应确保proxy_mode参数设为True。这是因为在Nginx作为代理时，所有的请求都会认为是来自本地而不是远程 IP 地址。在代理中设置X-ForwardedFor头以及启动–proxy-mode可解决这一问题。但是，如果不在代理级别强制header就启用–proxy-mode 会让其他人可以伪装远程地址。</p> 
<p>在配置文件的最后，可以看到两条gzip相关的命令，它们用于对一些文件进行压缩，提升性能。可通过如下命令测试配置是否正确：</p> 
<pre><code class="prism language-shell">$ <span class="token function">sudo</span> nginx -t   <span class="token comment">#出现以下提示说明配置成功</span>
nginx: the configuration <span class="token function">file</span> /etc/nginx/nginx.conf syntax is ok
nginx: configuration <span class="token function">file</span> /etc/nginx/nginx.conf <span class="token function">test</span> is successful
</code></pre> 
<p>如果出现错误，请检查配置文件中输入是否正确。常见的问题是默认的HTTP被其它服务所占用，如Apache或默认的Nginx网站，所以在重启Nginx服务前先通过本文中的命令确保并没有这种问题。在完成处理后，可使用如下命令重新加载新的配置：</p> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> /etc/init.d/nginx reload
</code></pre> 
<p>通过如下命令可确认 Nginx 是否将访问流量重定向到了后台Odoo服务中：</p> 
<pre><code class="prism language-shell">$ <span class="token function">curl</span> http://localhost
<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span><span class="token operator">&lt;</span>head<span class="token operator">&gt;</span><span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>window.location <span class="token operator">=</span> <span class="token string">'/web'</span> + location.hash<span class="token punctuation">;</span><span class="token operator">&lt;</span>/script<span class="token operator">&gt;</span><span class="token operator">&lt;</span>/head<span class="token operator">&gt;</span><span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
</code></pre> 
<h5><a id="HTTPS_308"></a>配置HTTPS安全服务</h5> 
<p>网站数据不应在因特网中以普通文件进行传输，在将Odoo网页服务暴露在网络中时，我们应使用HTTPS协议来对数据进行加密。有时可使用自签署证书。但注意自签署证书可能会带来安全风险，比如中间人攻击(Man-in-the-Middle Attack)，因此有些浏览器会不接受该证书。</p> 
<p>更健壮的解决方案是使用认证的证书机构所签署的证书，在运行商业或电商网站时这就尤为重要了。</p> 
<ul><li>创建自签署 SSL 证书<br> 下一步，我们应安装证书来启用SSL。创建一个自签署证书，可使用如下命令：</li></ul> 
<pre><code class="prism language-shell">$ <span class="token function">sudo</span> <span class="token function">mkdir</span> /etc/ssl/nginx <span class="token operator">&amp;&amp;</span> <span class="token function">cd</span> /etc/ssl/nginx
$ <span class="token function">sudo</span> openssl req -x509 -newkey rsa:2048 -keyout server.key -out server.crt -days 365 -nodes
$ <span class="token function">sudo</span> <span class="token function">chmod</span> a-wx * <span class="token comment"># make files read only</span>
$ <span class="token function">sudo</span> <span class="token function">chown</span> www-data:root * <span class="token comment"># access only to www-data group</span>
</code></pre> 
<p>上述命令创建一个/etc/ssl/nginx目录以及不带密码的自签署SSL证书。在运行openssl命令时，会要求用户输入其它信息，然后会生成一个证书和密钥文件。最后，将这些文件的所有权赋予用于运行网页服务的www-data用户。</p> 
<ul><li> <p>在 Nginx上配置HTTPS访问<br> 既然我们已经有了SSL证书，就可以配置 Nginx 来使用它了。要强制使用HTTPS，需要将所有的 HTTP 访问重定向到HTTPS。将前面的server区中替换为如下内容：</p> <pre><code>server {
    listen 80;
    rewrite ^(.*) https://$host$1 permanent;
}
</code></pre> <p>现在，如果重新加载Nginx配置并在浏览器中访问服务的话，将会看到http://地址被转换成了https:// 地址。但该地址不会返回任何内容，我们需要正确地配置HTTPS服务，可通过添加如下服务器配置来实现：</p> <pre><code>server {
    listen 443;
    # Add Headers for odoo proxy mode
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Real-IP $remote_addr;

    # SSL parameters
    ssl on;
    ssl_certificate /etc/ssl/nginx/server.crt;
    ssl_certificate_key /etc/ssl/nginx/server.key;
    ssl_session_timeout 30m;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers 'ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCMSHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSAAES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-
    SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-
    SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-
    SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHEDSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-
    SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-
    SHA:AES256-SHA:AES:CAMELLIA:DES-CBC3-
    SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-
    SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA';
    ssl_prefer_server_ciphers on;

    # log
    access_log /var/log/nginx/odoo.access.log;
    error_log /var/log/nginx/odoo.error.log;
    # Redirect longpoll requests to odoo longpolling port
    location /longpolling {
        proxy_pass http://odoochat;
    }

    # Redirect requests to odoo backend server
    location / {
        proxy_redirect off;
        proxy_pass http://odoo;
    }
    
    # common gzip
    gzip_types text/css text/scss text/plain text/xml application/xml application/json application/javascript;
    gzip on;
}
</code></pre> <p>以上配置代码会监听HTTPS端口并使用/etc/ssl/nginx/ 证书文件来对数据进行加密。这与我们在设置 Nginx 反向代理 中看到的server 配置区相似。如果重新加载配置，我们的 Odoo 服务将通过HTTPS进行运作，如以下命令所示：</p> <pre><code class="prism language-shell">	$ <span class="token function">sudo</span> nginx -t
	nginx: the configuration <span class="token function">file</span> /etc/nginx/nginx.conf syntax is ok
	nginx: configuration <span class="token function">file</span> /etc/nginx/nginx.conf <span class="token function">test</span> is successful
	$ <span class="token function">sudo</span> <span class="token function">service</span> nginx reload <span class="token comment"># or: sudo systemctl reload nginx</span>
	* Reloading nginx configuration nginx
	<span class="token punctuation">..</span>.done.
	$ <span class="token function">curl</span> -k https://localhost
	<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span><span class="token operator">&lt;</span>head<span class="token operator">&gt;</span><span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>window.location <span class="token operator">=</span> <span class="token string">'/web'</span> + location.hash<span class="token punctuation">;</span><span class="token operator">&lt;</span>/script<span class="token operator">&gt;</span><span class="token operator">&lt;</span>/head<span class="token operator">&gt;</span><span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
</code></pre> <p>最后部分的输入可用于确认Odoo客户端正通过HTTPS进行访问。</p> </li><li> <p>缓存静态内容<br> 我们可以配置 Nginx 来缓存服务端静态文件，这样再次请求时就可以访问Nginx 中的缓存，而无需将请求传递到upstream odoo服务中。启用静态内容缓存可带来更快的响应时间并减少 Odoo 服务的工作负载。要启用这一设置，在location /longpolling区之前加入如下代码：</p> <pre><code># cache static data
    location ~* /web/static/ {
    proxy_cache_valid 200 60m;
    proxy_buffering on;
    expires 864000;
    proxy_pass http://odoo;
}
</code></pre> <p>通过这一些命令，静态数据就可以缓存60分钟了。在这个期间的其它请求Nginx 会直接使用缓存进行响应。</p> </li></ul> 
<h5><a id="_400"></a>服务和模块更新</h5> 
<p>一旦 Odoo 服务运行了一段时间，就会需要对其进行升级。这包括两个步骤：获取服务或模块的新版本、执行安装。</p> 
<ul><li> <p>创建分阶环境<br> 如果你按照通过源码安装 Odoo一节正确地进行了安装，应该就可以在暂存区仓库中获取并测试新版本源码。强烈建议创建一个生产环境数据库的拷贝，并使用它进行升级测试。如果odoo-prod是我们的生产环境数据库，可通过如下命令创建一个拷贝odoo-stage：</p> <pre><code class="prism language-shell">dropdb odoo-stage
createdb --owner<span class="token operator">=</span>odoo odoo-stage
pg_dump odoo-prod <span class="token operator">|</span> psql -d odoo-stage
<span class="token function">sudo</span> <span class="token function">su</span> odoo
<span class="token function">cd</span> ~/.local/share/Odoo/filestore/
<span class="token function">cp</span> -al odoo-prod odoo-stage <span class="token comment"># create filestore hardlinks</span>
<span class="token keyword">exit</span>
</code></pre> <p>在使用以上数据库拷贝之前，应进行清理，比如停止计划动作、关闭 email 服务（包含发送和接收消息）。根据你的设置来执行这些指定步骤，但通常可使用自动化脚本来执行。记住psql可用于在命令行直接执行SQL命令，如psql -d odoo-stage -c “&lt;SQL命令&gt;”。</p> 
  <blockquote> 
   <p>注：可通过createdb命令来更快地创建拷贝：createdb –owner=odoo –template=odoo-prod odoo-stage。但需要说明的是要运行该命令，不能有任何对odoo-prod数据库的连接，因此需要停止Odoo生产环境的服务。</p> 
  </blockquote> </li><li> <p>更新 Odoo 源码<br> 我们使用git pull 命令来从GitHub仓库获取最新的Odoo源码。在那之前，我们可以使用git tag命令来为当前使用的提交创建一个标签，这样可以可容易的对更新进行撤销，命令如下：</p> <pre><code class="prism language-shell"><span class="token function">sudo</span> <span class="token function">su</span> odoo
<span class="token function">cd</span> ~/odoo-12
<span class="token function">git</span> tag --force 12-last-prod
<span class="token function">git</span> pull
</code></pre> <p>要让代码修改生效，我们需要重启Odoo服务。而要使用数据文件的修改生效，需要对模块进行升级。通常对Odoo稳定版本的修改都是代码的修复，因此无需冒险执行模块升级。如果需要对模块升级，可使用-u 附加参数，或者是-u base，它将升级所有模块。</p> <p>现在可以启动Odoo的分阶服务了，它将使用在分阶数据库上使用升级代码：</p> <pre><code class="prism language-shell">~/odoo-12/odoo-bin -d odoo-stage --http-port<span class="token operator">=</span>8080 -c /etc/odoo/odoo.conf <span class="token comment"># optionally add: -u base</span>
<span class="token keyword">exit</span>
</code></pre> <p>Odoo 分阶服务通过在8080端口上进行配置。可通过浏览器访问http://xxx:8080来检查升级代码是否正确运作。如果出现了错误，可通过如下命令来返回上一个版本：</p> <pre><code class="prism language-shell"><span class="token function">sudo</span> <span class="token function">su</span> odoo
<span class="token function">cd</span> ~/odoo-12
<span class="token function">git</span> checkout 12-last-prod
<span class="token keyword">exit</span>
</code></pre> <p>如果一切运行都如预期，则可安全地执行生产环境服务的升级，通常是通过重启来实现。如果想要执行实际的模块升级，建议的方法是停止服务、运行升级、再重启服务，命令如下：</p> <pre><code class="prism language-shell"><span class="token function">sudo</span> <span class="token function">service</span> odoo stop
<span class="token function">sudo</span> <span class="token function">su</span> -c <span class="token string">"~/odoo-12/odoo-bin -c /etc/odoo/odoo.conf -u base --stop-after-init"</span> odoo
<span class="token function">sudo</span> <span class="token function">service</span> odoo start
</code></pre> <p>记住对在用Git 版本进行记录，可通过 git checkout回到修改前，这让我们可以在需要的时候进行回滚。强烈推荐在执行数据库升级前保存备份。在完成之后，可使用 Git 拉取新的版本到生产仓库并完成升级：</p> <pre><code class="prism language-shell"><span class="token function">sudo</span> <span class="token function">su</span> odoo
<span class="token function">cd</span> ~/odoo-12
<span class="token function">git</span> tag --force 12-last-prod
<span class="token function">git</span> pull
<span class="token keyword">exit</span>
<span class="token function">sudo</span> <span class="token function">service</span> odoo restart <span class="token comment"># or: sudo systemctl restart odoo</span>
</code></pre> <p>无需频繁进行升级，但也不建议等上一年再进行升级。每几个月进行一次升级。还要记得重启服务来启用代码升级，但对模块升级则并非如此。但如果需要进行指定的漏洞修复，可以更早的进行升级。还应关注公开渠道对 Odoo 安全漏洞的披露，发 GitHub 上 Odoo 的Issues，具体可查看Security标签，或者是官方的邮件列表，可通过https://www.odoo.com/groups进行订阅。</p> <p>作为一项服务，企业版用户会更早地收到邮件通知来警报这一类问题。</p> </li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4fde8d5d0caf98024373771092856f9e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Opencv基本学习-----之三种提取图像亮度的方法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c5639fade2c509fafe6950ee434c5c11/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">java.lang.NoSuchFieldError异常</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>