<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>（附代码）入门 | 如何使用C/C&#43;&#43;调用Python脚本 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="（附代码）入门 | 如何使用C/C&#43;&#43;调用Python脚本" />
<meta property="og:description" content="编者荐语 在进行 C/C&#43;&#43; 进行开发的时候，很多非核心的功能，可以使用 Python 进行实现，因此学习在 C/C&#43;&#43; 程序中如何调用 Python 程序也是非常有必要的。实现的方法有许多种，今天给大家介绍一种小编认为的最方便的方法。
文章将会介绍一种通过嵌入 Python 来丰富你的 C/C&#43;&#43; 应用程序的方法（Python/C API），这种方式会使您的应用程序能够在不改变程序原有功能的基础上，使用 Python 编程语言而不是 C/C&#43;&#43; 语言来实现应用程序的某些功能。
这种方式可以用于多种目的，主要目的是允许我们通过用 Python 编写一些脚本来根据需要定制应用程序（某些功能可以更容易地用 Python 编写）。当你嵌入 Python 时，主程序一般情况下与 Python 实现无关，应用程序的某些部分会在需要的时候调用 Python 解释器，运行一些我们编写的 Python 代码。所以，如果你需要嵌入 Python，那么你首先需要一个 C/C&#43;&#43; 主程序。
基本使用方法 Python 提供了一套 C API库，使得开发者能很方便地从C/ C&#43;&#43; 程序中调用 Python 模块，C&#43;&#43; 用户应该注意，尽管 API 是完全使用 C 来定义的，但头文件已将入口点声明为 extern “C”，因此 API 在 C&#43;&#43; 中使用此 API 不必再做任何特殊处理。
具体的文档参考官方指南：https://docs.python.org/3.9/extending/embedding.html
如果需要使用这个套API，我们需要引入一个头文件和一个库文件，以Cmake构建为例，我们需要在 CMakeLists.txt 中加入：
find_package (Python COMPONENTS Interpreter Development REQUIRED) target_include_directories(${PROJECT_NAME} PRIVATE ${Python_INCLUDE_DIRS}) target_link_libraries(${PROJECT_NAME} PRIVATE ${Python_LIBRARIES}) Windows环境下应该是需要保证如下两个环境变量的存在（暂未测试）。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/fae661a0b3cba17b25745faaecfe133e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-06T11:41:57+08:00" />
<meta property="article:modified_time" content="2022-08-06T11:41:57+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">（附代码）入门 | 如何使用C/C&#43;&#43;调用Python脚本</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>编者荐语</h3> 
<p><strong>在进行 C/C++ 进行开发的时候，很多非核心的功能，可以使用 Python 进行实现，因此学习在 C/C++ 程序中如何调用 Python 程序也是非常有必要的。实现的方法有许多种，今天给大家介绍一种小编认为的最方便的方法。</strong></p> 
<p>文章将会介绍一种通过嵌入 Python 来丰富你的 C/C++ 应用程序的方法（Python/C API），这种方式会使您的应用程序能够在不改变程序原有功能的基础上，使用 Python 编程语言而不是 C/C++ 语言来实现应用程序的某些功能。</p> 
<p>这种方式可以用于多种目的，主要目的是允许我们通过用 Python 编写一些脚本来根据需要定制应用程序（某些功能可以更容易地用 Python 编写）。当你嵌入 Python 时，主程序一般情况下与 Python 实现无关，应用程序的某些部分会在需要的时候调用 Python 解释器，运行一些我们编写的 Python 代码。所以，如果你需要嵌入 Python，那么你首先需要一个 C/C++ 主程序。</p> 
<h3><a id="_7"></a>基本使用方法</h3> 
<p>Python 提供了一套 C API库，使得开发者能很方便地从C/ C++ 程序中调用 Python 模块，C++ 用户应该注意，尽管 API 是完全使用 C 来定义的，但头文件已将入口点声明为 extern “C”，因此 API 在 C++ 中使用此 API 不必再做任何特殊处理。</p> 
<p><img src="https://images2.imgbox.com/7b/0d/0yzRn24b_o.png" alt="在这里插入图片描述"><br> 具体的文档参考官方指南：https://docs.python.org/3.9/extending/embedding.html</p> 
<p>如果需要使用这个套API，我们需要引入一个头文件和一个库文件，以Cmake构建为例，我们需要在 CMakeLists.txt 中加入：</p> 
<pre><code class="prism language-bash">find_package <span class="token punctuation">(</span>Python COMPONENTS Interpreter Development REQUIRED<span class="token punctuation">)</span>
target_include_directories<span class="token punctuation">(</span><span class="token variable">${PROJECT_NAME}</span> PRIVATE <span class="token variable">${Python_INCLUDE_DIRS}</span><span class="token punctuation">)</span>
target_link_libraries<span class="token punctuation">(</span><span class="token variable">${PROJECT_NAME}</span> PRIVATE <span class="token variable">${Python_LIBRARIES}</span><span class="token punctuation">)</span>
</code></pre> 
<p>Windows环境下应该是需要保证如下两个环境变量的存在（暂未测试）。</p> 
<p><img src="https://images2.imgbox.com/3a/57/irC2TeLO_o.png" alt="在这里插入图片描述"><br> 然后我们就可以在 main.cpp 中引入相应的头文件了：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Python.h&gt;</span></span>
</code></pre> 
<p>之后，主程序要做的一件事就是是初始化 Python 解释器：</p> 
<pre><code class="prism language-cpp"><span class="token function">Py_Initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>当然，既然需要初始化解释器，作为可以在 C 语言中编写的代码，我们一般还需要对它进行释放（在不需要的时候）：</p> 
<pre><code class="prism language-cpp"><span class="token function">Py_Finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>现在我们变可以将需要运行的 Python 语句以字符串的形式传递给 Python 解释器：</p> 
<pre><code class="prism language-cpp"><span class="token function">PyRun_SimpleString</span><span class="token punctuation">(</span><span class="token string">"print("</span>Hello world<span class="token operator">!</span><span class="token string">")"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="_48"></a>举个简单的栗子</h3> 
<p>此方法没办法进行数值的传递（暂不考虑转换为字符串传递，毕竟麻烦的同时接收数据也是一个大问题）：</p> 
<p>1.初始化Python解释器；<br> 2.以字符串的形式传递代码；<br> 3.释放python解释器。</p> 
<p>代码如下：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PY_SSIZE_T_CLEAN</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Python.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">Py_Initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                       <span class="token comment">// 初始化python解释器</span>
    <span class="token function">PyRun_SimpleString</span><span class="token punctuation">(</span><span class="token string">"import matplotlib.pyplot as plt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 运行python代码</span>
    <span class="token function">PyRun_SimpleString</span><span class="token punctuation">(</span><span class="token string">"plt.plot([1,2,3,4], [12,3,23,231])"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PyRun_SimpleString</span><span class="token punctuation">(</span><span class="token string">"plt.show()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Py_Finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 释放python解释器</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>结果如下：</p> 
<p><img src="https://images2.imgbox.com/31/97/bdoflS5F_o.png" alt="在这里插入图片描述"><br> 显然，我们成功的在 C++ 程序中调用 Python 并绘制图像并显示了出来。</p> 
<h3><a id="_77"></a>常用数据类型</h3> 
<p>在python中有一句话叫做“一切皆对象”，这句话可以结合源码更好的进行理解。<br> 在python里，一切变量、函数、类等，在解释器中执行时，都会在在堆中新建一个对象，并将名字绑定在对象上。</p> 
<p>在 C/C++ 中，所有的 Python 类型都被声明为 PyObject ，为了能够操作 Python 的数据，Python提供了各种数据类型和 C 语言数据类型的转换操作：</p> 
<pre><code class="prism language-cpp">PyObject <span class="token operator">*</span>object<span class="token punctuation">;</span>  <span class="token comment">// 创建python的object的指针</span>
<span class="token function">Py_DECREF</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 销毁object</span>
</code></pre> 
<p><strong>1.数字与字符串处理</strong><br> 在 Python/C API 中提供了 Py_BuildValue() 函数对数字和字符串进行转换处理，使之变成Python中相应的数据类型。</p> 
<pre><code class="prism language-cpp">PyObject<span class="token operator">*</span> Arg <span class="token operator">=</span> <span class="token function">Py_BuildValue</span><span class="token punctuation">(</span><span class="token string">"(i, i)"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//i表示创建int型变量</span>
</code></pre> 
<p><strong>2.列表操作</strong><br> 在 Python/C API 中提供了 PyList_New() 函数用以创建一个新的 Python 列表。PyList_New() 函数的返回值为所创建的列表。</p> 
<p><strong>3.元组操作</strong><br> 在 Python/C API 中提供了 PyTuple_New() 函数，用以创建一个新的 Python 元组。PyTuple_New() 函数返回所创建的元组。</p> 
<p><strong>4.字典操作</strong><br> 在 Python/C API 中提供了 PyDict_New() 函数用以创建一个新的字典。PyDict_New() 函数返回所创建的字典。</p> 
<p><strong>5. cv::Mat 操作</strong><br> cv::Mat应该是我们会经常使用的格式了，参考代码如下：</p> 
<pre><code class="prism language-cpp">PyObject <span class="token operator">*</span><span class="token function">cvmat2py</span><span class="token punctuation">(</span>cv<span class="token double-colon punctuation">::</span>Mat <span class="token operator">&amp;</span>image<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">import_array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> row<span class="token punctuation">,</span> col<span class="token punctuation">;</span>
    col <span class="token operator">=</span> image<span class="token punctuation">.</span>cols<span class="token punctuation">;</span> <span class="token comment">//列宽</span>
    row <span class="token operator">=</span> image<span class="token punctuation">.</span>rows<span class="token punctuation">;</span> <span class="token comment">//行高</span>
    <span class="token keyword">int</span> channel <span class="token operator">=</span> image<span class="token punctuation">.</span><span class="token function">channels</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> irow <span class="token operator">=</span> row<span class="token punctuation">,</span> icol <span class="token operator">=</span> col <span class="token operator">*</span> channel<span class="token punctuation">;</span>
    npy_intp Dims<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>row<span class="token punctuation">,</span> col<span class="token punctuation">,</span> channel<span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">//图像维度信息</span>
    PyObject <span class="token operator">*</span>pyArray <span class="token operator">=</span> <span class="token function">PyArray_SimpleNewFromData</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> Dims<span class="token punctuation">,</span> NPY_UBYTE<span class="token punctuation">,</span> image<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    PyObject <span class="token operator">*</span>ArgArray <span class="token operator">=</span> <span class="token function">PyTuple_New</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PyTuple_SetItem</span><span class="token punctuation">(</span>ArgArray<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> pyArray<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ArgArray<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>更多操作请参考：https://docs.python.org/zh-cn/3/c-api/arg.html#building-values</p> 
<h3><a id="_126"></a>举个稍复杂一点的栗子</h3> 
<p>此方法可以进行进行数值的传递：</p> 
<p>1.初始化Python解释器；<br> 2.从C++到Python转换数据；<br> 3.用转换后的数据做参数调用Python函数；<br> 4.把函数返回值转换为C++数据结构；<br> 5.释放python解释器。</p> 
<p><strong>C++代码如下：</strong></p> 
<pre><code class="prism language-cpp">
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PY_SSIZE_T_CLEAN</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Python.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 初始化python解释器</span>
    <span class="token function">Py_Initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">Py_IsInitialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 添加编译后文件的所在路径</span>
    <span class="token function">PyRun_SimpleString</span><span class="token punctuation">(</span><span class="token string">"import sys"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PyRun_SimpleString</span><span class="token punctuation">(</span><span class="token string">"sys.path.append('./')"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 要调用的python文件名</span>
    <span class="token keyword">auto</span> pModule <span class="token operator">=</span> <span class="token function">PyImport_ImportModule</span><span class="token punctuation">(</span><span class="token string">"common"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 记得复制到编译后文件的路径下，同时不用加后缀名“.py“</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pModule<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Can't find your xx.py file."</span><span class="token punctuation">;</span>
        <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//获取模块中的函数</span>
    <span class="token keyword">auto</span> pFunc <span class="token operator">=</span> <span class="token function">PyObject_GetAttrString</span><span class="token punctuation">(</span>pModule<span class="token punctuation">,</span> <span class="token string">"add"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//从字符串创建python函数对象</span>

    <span class="token comment">// 参数类型转换</span>
    PyObject <span class="token operator">*</span>pArg <span class="token operator">=</span> <span class="token function">Py_BuildValue</span><span class="token punctuation">(</span><span class="token string">"ii"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//调用直接获得的函数，并传递参数</span>
    <span class="token keyword">auto</span> <span class="token operator">*</span>py_result <span class="token operator">=</span> <span class="token function">PyEval_CallObject</span><span class="token punctuation">(</span>pFunc<span class="token punctuation">,</span> pArg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> c_result<span class="token punctuation">;</span>
    <span class="token comment">// 将python类型的返回值转换为C类型</span>
    <span class="token function">PyArg_Parse</span><span class="token punctuation">(</span>py_result<span class="token punctuation">,</span> <span class="token string">"i"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>c_result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"return: "</span> <span class="token operator">&lt;&lt;</span> c_result <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>Python代码如下（命名为 common.py）：</strong></p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'a: '</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'b: '</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span>
    <span class="token keyword">return</span> a <span class="token operator">+</span> b
</code></pre> 
<p><strong>结果如下（代码中设置的 python 文件搜索路径为编译后的文件路径）：</strong></p> 
<p><img src="https://images2.imgbox.com/37/22/NTyhH7Cq_o.png" alt="在这里插入图片描述"><br> 这样比较简单的两个实现就完成了，更多操作请参考：https://docs.python.org/3.9/c-api/index.html#c-api-index</p> 
<h3><a id="_195"></a>参考资料</h3> 
<p>1.https://blog.csdn.net/pipisorry/article/details/49532341<br> 2.https://blog.csdn.net/qq_45401419/article/details/123562089<br> 3.https://zhuanlan.zhihu.com/p/146874652</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e2e5aab312f98f0dc0bc6ceea6f025d2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">shap库源码和代码实现</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5113f9b5d13c9cce6bd0c78f124e37e5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【校内模拟8.5】【搜索】A</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>