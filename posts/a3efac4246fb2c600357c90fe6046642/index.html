<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Ansible 安装与使用/ssh免密互信-以及解决免密不生效 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Ansible 安装与使用/ssh免密互信-以及解决免密不生效" />
<meta property="og:description" content="服务器
HostName IP CPU MEM DES
k8s-master 172.26.48.4 2 Core 2G k8s master 节点
k8s-node1 172.26.48.5 1 Core 2G 应用节点
k8s-node2 172.26.135.94 1 Core 2G 应用节点
| HostName | IP | CPU | MEM | DES
|–|–|–|–|–|–|
| k8s-master |172.26.48.4 |2Core | 2G | k8s master 节点 |
| k8s-node1 |172.26.48.5 |1 | 2G | 应用节点 |
| k8s-node2 | 172.26.135.94 | 1| 2G | 应用节点|
不要忘记修改本地/etc/hosts文件
# 将以下内容追加(&gt;&gt;)到 /etc/hosts文件 [root@k8s-master ~]# cat &lt;&lt;EOF &gt;&gt; /etc/hosts 172." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/a3efac4246fb2c600357c90fe6046642/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-08T09:40:18+08:00" />
<meta property="article:modified_time" content="2023-11-08T09:40:18+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Ansible 安装与使用/ssh免密互信-以及解决免密不生效</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>服务器<br> HostName IP CPU MEM DES<br> k8s-master 172.26.48.4 2 Core 2G k8s master 节点<br> k8s-node1 172.26.48.5 1 Core 2G 应用节点<br> k8s-node2 172.26.135.94 1 Core 2G 应用节点<br> | HostName | IP | CPU | MEM | DES<br> |–|–|–|–|–|–|<br> | k8s-master |172.26.48.4 |2Core | 2G | k8s master 节点 |<br> | k8s-node1 |172.26.48.5 |1 | 2G | 应用节点 |<br> | k8s-node2 | 172.26.135.94 | 1| 2G | 应用节点|<br> 不要忘记修改本地/etc/hosts文件</p> 
<pre><code class="prism language-ruby"><span class="token comment"># 将以下内容追加(&gt;&gt;)到 /etc/hosts文件</span>
<span class="token punctuation">[</span>root<span class="token variable">@k8s</span><span class="token operator">-</span>master <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># cat &lt;&lt;EOF &gt;&gt; /etc/hosts</span>
<span class="token number">172.26</span><span class="token number">.48</span><span class="token number">.4</span>    k8s<span class="token operator">-</span>master
<span class="token number">172.26</span><span class="token number">.48</span><span class="token number">.5</span>    k8s<span class="token operator">-</span>node1
<span class="token number">172.26</span><span class="token number">.135</span><span class="token number">.94</span>  k8s<span class="token operator">-</span>node2
<span class="token constant">EOF</span>
</code></pre> 
<p>CentOS 7 安装 ansible</p> 
<pre><code class="prism language-ruby"><span class="token punctuation">[</span>root<span class="token variable">@k8s</span><span class="token operator">-</span>master home<span class="token punctuation">]</span><span class="token comment"># yum install ansible -y</span>
Loaded plugins<span class="token operator">:</span> fastestmirror<span class="token punctuation">,</span> langpacks
Loading mirror speeds from cached hostfile
 <span class="token operator">*</span> base<span class="token operator">:</span> ftp<span class="token operator">-</span>srv2<span class="token punctuation">.</span>kddilabs<span class="token punctuation">.</span>jp
 <span class="token operator">*</span> extras<span class="token operator">:</span> ftp<span class="token operator">-</span>srv2<span class="token punctuation">.</span>kddilabs<span class="token punctuation">.</span>jp
 <span class="token operator">*</span> updates<span class="token operator">:</span> ftp<span class="token operator">-</span>srv2<span class="token punctuation">.</span>kddilabs<span class="token punctuation">.</span>jp
No package ansible available<span class="token punctuation">.</span>
<span class="token symbol">Error</span><span class="token operator">:</span> Nothing to <span class="token keyword">do</span>

<span class="token comment"># 原理：Ansible是属于Extra Packages for Enterprise Linux (EPEL)库的一部分，因此要先安装EPEL</span>
<span class="token punctuation">[</span>root<span class="token variable">@msy</span><span class="token operator">-</span>k8s<span class="token operator">-</span>master home<span class="token punctuation">]</span><span class="token comment"># yum install epel-release -y</span>
<span class="token punctuation">[</span>root<span class="token variable">@msy</span><span class="token operator">-</span>k8s<span class="token operator">-</span>master home<span class="token punctuation">]</span><span class="token comment"># yum install ansible -y</span>
<span class="token punctuation">[</span>root<span class="token variable">@msy</span><span class="token operator">-</span>k8s<span class="token operator">-</span>master home<span class="token punctuation">]</span><span class="token comment"># ansible --version</span>
ansible <span class="token number">2.7</span><span class="token number">.10</span>
  config file <span class="token operator">=</span> <span class="token operator">/</span>etc<span class="token operator">/</span>ansible<span class="token operator">/</span>ansible<span class="token punctuation">.</span>cfg
  configured <span class="token keyword">module</span> <span class="token class-name">search</span> path <span class="token operator">=</span> <span class="token punctuation">[</span>u<span class="token string-literal"><span class="token string">'/root/.ansible/plugins/modules'</span></span><span class="token punctuation">,</span> u<span class="token string-literal"><span class="token string">'/usr/share/ansible/plugins/modules'</span></span><span class="token punctuation">]</span>
  ansible python <span class="token keyword">module</span> <span class="token class-name">location</span> <span class="token operator">=</span> <span class="token operator">/</span>usr<span class="token operator">/</span>lib<span class="token operator">/</span>python2<span class="token punctuation">.</span><span class="token number">7</span><span class="token operator">/</span>site<span class="token operator">-</span>packages<span class="token operator">/</span>ansible
  executable location <span class="token operator">=</span> <span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>ansible
  python version <span class="token operator">=</span> <span class="token number">2.7</span><span class="token number">.5</span> <span class="token punctuation">(</span>default<span class="token punctuation">,</span> Jul <span class="token number">13</span> <span class="token number">2018</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">06</span><span class="token operator">:</span><span class="token number">57</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token constant">GCC</span> <span class="token number">4.8</span><span class="token number">.5</span> <span class="token number">20150623</span> <span class="token punctuation">(</span>Red Hat <span class="token number">4.8</span><span class="token number">.5</span><span class="token operator">-</span><span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span>root<span class="token variable">@msy</span><span class="token operator">-</span>k8s<span class="token operator">-</span>master home<span class="token punctuation">]</span><span class="token comment">#</span>
</code></pre> 
<p>配置 ansible hosts</p> 
<pre><code class="prism language-ruby">root<span class="token variable">@k8s</span><span class="token operator">-</span>master deploy<span class="token punctuation">]</span><span class="token comment"># cat &lt;&lt;EOF &gt;&gt; /etc/ansible/hosts</span>
<span class="token punctuation">[</span>all<span class="token punctuation">]</span>
<span class="token number">172.26</span><span class="token number">.48</span><span class="token number">.4</span>
<span class="token number">172.26</span><span class="token number">.48</span><span class="token number">.5</span>
<span class="token number">172.26</span><span class="token number">.135</span><span class="token number">.94</span>
<span class="token punctuation">[</span>nodes<span class="token punctuation">]</span>
<span class="token number">172.26</span><span class="token number">.48</span><span class="token number">.5</span>
<span class="token number">172.26</span><span class="token number">.135</span><span class="token number">.94</span>
<span class="token constant">EOF</span>
</code></pre> 
<p>创建 SSH key</p> 
<pre><code class="prism language-ruby"><span class="token punctuation">[</span>root<span class="token variable">@k8s</span><span class="token operator">-</span>master ansible<span class="token punctuation">]</span><span class="token comment"># pwd</span>
<span class="token operator">/</span>etc<span class="token operator">/</span>ansible
<span class="token punctuation">[</span>root<span class="token variable">@k8s</span><span class="token operator">-</span>master ansible<span class="token punctuation">]</span><span class="token comment"># ssh-keygen -t rsa</span>
Enter passphrase <span class="token punctuation">(</span>empty <span class="token keyword">for</span> no passphrase<span class="token punctuation">)</span><span class="token operator">:</span>
Enter same passphrase again<span class="token operator">:</span>
Your identification has been saved <span class="token keyword">in</span> <span class="token regex-literal"><span class="token regex">/root/</span></span><span class="token punctuation">.</span>ssh<span class="token operator">/</span>id_rsa<span class="token punctuation">.</span>
Your <span class="token keyword">public</span> key has been saved <span class="token keyword">in</span> <span class="token regex-literal"><span class="token regex">/root/</span></span><span class="token punctuation">.</span>ssh<span class="token operator">/</span>id_rsa<span class="token punctuation">.</span>pub<span class="token punctuation">.</span>
The key fingerprint is<span class="token operator">:</span>
<span class="token symbol">SHA256</span><span class="token symbol">:VJQenTc40F0FahV6wa</span><span class="token operator">+</span>c<span class="token operator">/</span>ftajF9JhT<span class="token operator">/</span>le050ERYLOBc root<span class="token variable">@k8s</span><span class="token operator">-</span>master
The key's randomart image is<span class="token operator">:</span>
<span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token punctuation">[</span><span class="token constant">RSA</span> <span class="token number">2048</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token operator">|</span>         <span class="token punctuation">.</span><span class="token operator">+=</span><span class="token punctuation">.</span><span class="token constant">E</span><span class="token operator">*</span><span class="token constant">B</span><span class="token operator">=</span><span class="token operator">|</span>
<span class="token operator">|</span>         <span class="token punctuation">.</span>oo<span class="token operator">*=</span>Boo<span class="token operator">|</span>
<span class="token operator">|</span>        <span class="token operator">..</span> <span class="token punctuation">.</span><span class="token operator">*</span>oo<span class="token operator">=</span>o<span class="token operator">|</span>
<span class="token operator">|</span>       <span class="token punctuation">.</span>  <span class="token operator">..</span> <span class="token punctuation">.</span> o<span class="token operator">=</span><span class="token operator">|</span>
<span class="token operator">|</span>        <span class="token constant">S</span>    <span class="token punctuation">.</span> <span class="token operator">*=</span><span class="token operator">|</span>
<span class="token operator">|</span>              <span class="token operator">=</span><span class="token operator">+</span><span class="token operator">*</span><span class="token operator">|</span>
<span class="token operator">|</span>              <span class="token punctuation">.</span>oB<span class="token operator">|</span>
<span class="token operator">|</span>               <span class="token operator">=</span><span class="token operator">+</span><span class="token operator">|</span>
<span class="token operator">|</span>              <span class="token punctuation">.</span>o<span class="token operator">*</span><span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token punctuation">[</span><span class="token constant">SHA256</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token punctuation">[</span>root<span class="token variable">@k8s</span><span class="token operator">-</span>master ansible<span class="token punctuation">]</span><span class="token comment">#</span>
</code></pre> 
<p>ansible 批量配置ssh免密</p> 
<pre><code class="prism language-ruby">ansible nodes <span class="token operator">-</span>m authorized_key <span class="token operator">-</span>a <span class="token string-literal"><span class="token string">"user=root key='{<!-- -->{ lookup('file','/root/.ssh/id_rsa.pub')}}' path='/root/.ssh/authorized_keys' manage_dir=no"</span></span> <span class="token operator">-</span><span class="token operator">-</span>ask<span class="token operator">-</span>pass <span class="token operator">-</span>c paramiko

</code></pre> 
<pre><code class="prism language-ruby"><span class="token constant">SSH</span> password<span class="token operator">:</span>
<span class="token operator">...</span><span class="token operator">...</span>
<span class="token punctuation">[</span>root<span class="token variable">@k8s</span><span class="token operator">-</span>master ansible<span class="token punctuation">]</span><span class="token comment">#</span>
</code></pre> 
<pre><code class="prism language-ruby"><span class="token comment">#因为密码都一样，所以只需要输入一次密码即可，如果密码不同  需要自定义</span>

<span class="token comment"># 说明：</span>
<span class="token comment"># 将秘钥推送到远程主机的哪个用户下</span>
user<span class="token operator">=</span>root
<span class="token comment"># 指定要推送的秘钥文件所在的路径</span>
key<span class="token operator">=</span><span class="token string-literal"><span class="token string">'{<!-- -->{ lookup('</span></span>file<span class="token string-literal"><span class="token string">','</span></span><span class="token regex-literal"><span class="token regex">/root/</span></span><span class="token punctuation">.</span>ssh<span class="token operator">/</span>id_rsa<span class="token punctuation">.</span>pub<span class="token string-literal"><span class="token string">')}}'</span></span>
<span class="token comment"># 将秘钥推送到远程主机的哪个目录下并重命名</span>
path<span class="token operator">=</span><span class="token string-literal"><span class="token string">'/root/.ssh/authorized_keys'</span></span>
<span class="token comment"># 指定模块是否应该管理authorized_keys文件所在的目录，如果设置为yes,模块会创建目录，以及设置一个已存在目录的拥有者和权限。如果通过 path 选项，重新指定了一个 authorized key 文件所在目录，那么应该将该选项设置为 no</span>
manage_dir<span class="token operator">=</span>no
<span class="token comment"># 是否移除 authorized_keys 文件中其它非指定 key</span>
exclusive <span class="token punctuation">[</span>default<span class="token operator">:</span> no<span class="token punctuation">]</span>：
<span class="token comment"># present 添加指定 key 到 authorized_keys 文件中；absent 从 authorized_keys 文件中移除指定 key</span>
state <span class="token punctuation">(</span><span class="token symbol">Choices</span><span class="token operator">:</span> present<span class="token punctuation">,</span> absent<span class="token punctuation">)</span> <span class="token punctuation">[</span>Default<span class="token operator">:</span> present<span class="token punctuation">]</span>：
</code></pre> 
<p>测试 SSH 免密是否成功, 查看所有节点的内核版本</p> 
<pre><code class="prism language-ruby"><span class="token punctuation">[</span>root<span class="token variable">@k8s</span><span class="token operator">-</span>master ansible<span class="token punctuation">]</span><span class="token comment"># ansible nodes -m shell -a 'uname -r'</span>
<span class="token number">172.26</span><span class="token number">.48</span><span class="token number">.5</span> <span class="token operator">|</span> <span class="token constant">CHANGED</span> <span class="token operator">|</span> rc<span class="token operator">=</span><span class="token number">0</span> <span class="token operator">&gt;&gt;</span>
<span class="token number">3.10</span><span class="token number">.0</span><span class="token operator">-</span><span class="token number">862.14</span><span class="token number">.4</span><span class="token punctuation">.</span>el7<span class="token punctuation">.</span>x86_64

<span class="token number">172.26</span><span class="token number">.135</span><span class="token number">.94</span> <span class="token operator">|</span> <span class="token constant">CHANGED</span> <span class="token operator">|</span> rc<span class="token operator">=</span><span class="token number">0</span> <span class="token operator">&gt;&gt;</span>
<span class="token number">3.10</span><span class="token number">.0</span><span class="token operator">-</span><span class="token number">862.14</span><span class="token number">.4</span><span class="token punctuation">.</span>el7<span class="token punctuation">.</span>x86_64

<span class="token punctuation">[</span>root<span class="token variable">@k8s</span><span class="token operator">-</span>master ansible<span class="token punctuation">]</span><span class="token comment">#</span>
</code></pre> 
<h5><a id="ansible_128"></a>不使用ansible手动配置免密</h5> 
<p>server1:root ——&gt; server2:root<br> 1、主控机生成公钥</p> 
<pre><code class="prism language-ruby"><span class="token punctuation">[</span>root<span class="token variable">@k8s</span><span class="token operator">-</span>master<span class="token punctuation">]</span><span class="token comment"># ssh-keygen -t rsa</span>
</code></pre> 
<pre><code class="prism language-ruby">cat  <span class="token regex-literal"><span class="token regex">/root/</span></span><span class="token punctuation">.</span>ssh<span class="token operator">/</span>id_rsa<span class="token punctuation">.</span>pub <span class="token operator">&gt;&gt;</span> <span class="token regex-literal"><span class="token regex">/root/</span></span><span class="token punctuation">.</span>ssh<span class="token operator">/</span>authorized_keys
</code></pre> 
<p>2.1、拷贝公钥信息到需要免密的服务器上（以此服务器为例-k8snodeip）</p> 
<pre><code class="prism language-ruby"><span class="token punctuation">[</span>root<span class="token variable">@k8s</span><span class="token operator">-</span>master<span class="token punctuation">]</span><span class="token comment"># ssh-copy-id -i /root/.ssh/id_rsa.pub root@k8snodeip</span>
</code></pre> 
<p>然受输入密码即可（完成）</p> 
<p>server1:user1——&gt; server2:user2 (普通用户免密)<br> 1、主控机生成公钥</p> 
<pre><code class="prism language-ruby"><span class="token punctuation">[</span>root<span class="token variable">@k8s</span><span class="token operator">-</span>user1<span class="token punctuation">]</span>$ ssh<span class="token operator">-</span>keygen <span class="token operator">-</span>t rsa
</code></pre> 
<p>2.1、拷贝公钥信息到需要免密的服务器上（以此服务器为例-k8snodeip）</p> 
<pre><code class="prism language-ruby"><span class="token punctuation">[</span>root<span class="token variable">@k8s</span><span class="token operator">-</span>user1<span class="token punctuation">]</span>$ cat <span class="token operator">~</span><span class="token operator">/</span><span class="token punctuation">.</span>ssh<span class="token regex-literal"><span class="token regex">/id_rsa.pub &gt;&gt; ~/</span></span><span class="token punctuation">.</span>ssh<span class="token operator">/</span>authorized_keys

<span class="token punctuation">[</span>root<span class="token variable">@k8s</span><span class="token operator">-</span>user1<span class="token punctuation">]</span>$ ssh<span class="token operator">-</span>copy<span class="token operator">-</span>id <span class="token operator">-</span>i <span class="token operator">~</span><span class="token operator">/</span><span class="token punctuation">.</span>ssh<span class="token operator">/</span>id_rsa<span class="token punctuation">.</span>pub user2<span class="token variable">@server2</span>
</code></pre> 
<p>然受输入密码即可（完成）</p> 
<p>3、取消免密登录<br> 只需要到免密的主机上把公钥去掉即可</p> 
<pre><code class="prism language-ruby">vim <span class="token regex-literal"><span class="token regex">/root/</span></span><span class="token punctuation">.</span>ssh<span class="token operator">/</span>authorized_keys
cat <span class="token regex-literal"><span class="token regex">/root/</span></span><span class="token punctuation">.</span>ssh<span class="token operator">/</span>authorized_keys
ssh<span class="token operator">-</span>rsa AAAAB3NzaC1yc2EAAAADAQABAA9SpdzH…… root<span class="token variable">@k8s</span><span class="token operator">-</span>master
</code></pre> 
<h4><a id="_170"></a>解决免密不生效</h4> 
<p>1、如果报错如下：</p> 
<pre><code class="prism language-ruby">Are you sure you want to continue connecting <span class="token punctuation">(</span>yes<span class="token operator">/</span>no<span class="token punctuation">)</span><span class="token operator">?</span> <span class="token number">16.11</span><span class="token number">.8</span><span class="token number">.86</span> <span class="token operator">|</span> <span class="token constant">UNREACHABLE!</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-literal"><span class="token string">"changed"</span></span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token string-literal"><span class="token string">"msg"</span></span><span class="token operator">:</span> <span class="token string-literal"><span class="token string">"Failed to connect to the host via ssh: Permission denied (publickey,gssapi-keyex,gssapi-with-mic,password)."</span></span><span class="token punctuation">,</span>
    <span class="token string-literal"><span class="token string">"unreachable"</span></span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
<span class="token operator">^</span><span class="token constant">C</span> <span class="token punctuation">[</span><span class="token constant">ERROR</span><span class="token punctuation">]</span><span class="token operator">:</span> User interrupted executio
</code></pre> 
<p>理论上以上步骤copy完public key就已经可以实现免密。排查了是sshd_config里配置的问题</p> 
<pre><code class="prism language-ruby"><span class="token comment">#第一步排查，确认文件以及目录权限</span>
chmod <span class="token number">700</span> <span class="token operator">~</span><span class="token operator">/</span><span class="token punctuation">.</span>ssh
chmod <span class="token number">600</span> <span class="token operator">~</span><span class="token operator">/</span><span class="token punctuation">.</span>ssh<span class="token operator">/</span><span class="token operator">*</span>

<span class="token comment">#第二步排查，若是上述配置后仍是不生效，检查/etc/ssh/sshd_config配置，而后执行systemctl restart sshd重启sshd服务</span>
<span class="token comment">#禁用root帐户登陆，若是是用root用户登陆请开启，若是注释掉，默认即为yes</span>
<span class="token comment">#PermitRootLogin yes</span>
 

<span class="token comment"># 是否容许用户自行使用成对的密钥系统进行登入行为，仅针对 version 2，若是注释掉，默认即为yes。</span>
RSAAuthentication yes
PubkeyAuthentication yes

<span class="token comment"># 至于自制的公钥数据就放置于用户家目录下的 .ssh/authorized_keys 内</span>
AuthorizedKeysFile      <span class="token punctuation">.</span>ssh<span class="token operator">/</span>authorized_keys

<span class="token comment">#第三步排查，若是上述配置以后仍是不能访问，尝试将/etc/ssh/sshd_config中的StrictModes配置改成no（若是注释掉，默认是yes的。注意这个配置可能会下降安全性），而后执行systemctl restart sshd重启sshd服务</span>
StrictModes no

</code></pre> 
<p>解决</p> 
<h5><a id="ansible_205"></a>配置ansible使用的用户</h5> 
<p>修改/etc/ansible/ansible.cfg</p> 
<pre><code class="prism language-shell"><span class="token assign-left variable">become</span><span class="token operator">=</span>True           <span class="token comment">###表示打开become开关，也就是输入密码那一栏</span>
<span class="token assign-left variable">become_method</span><span class="token operator">=</span>su      <span class="token comment">###表示用什么方式将普通账户切换到root或所需的其他账户，这里可以用su或sudo</span>
<span class="token assign-left variable">become_user</span><span class="token operator">=</span>root           <span class="token comment">##***设置为root账户，相当于我们以普通账户登入到远程主机时，再使用su - root切换为root账户。</span>
<span class="token assign-left variable">become_ask_pass</span><span class="token operator">=</span>True   <span class="token comment">###表示询问密码</span>
</code></pre> 
<h5><a id="_214"></a>报错处理</h5> 
<p>1、报错如下</p> 
<pre><code class="prism language-shell"> <span class="token punctuation">[</span>WARNING<span class="token punctuation">]</span>: Platform linux on <span class="token function">host</span> *.*.*.* is using the discovered Python interpreter at /usr/bin/python, but
future installation of another Python interpreter could change this. See
https://docs.ansible.com/ansible/2.9/reference_appendices/interpreter_discovery.html <span class="token keyword">for</span> <span class="token function">more</span> information.
</code></pre> 
<p>修改 vim /etc/ansible/ansible.cfg<br> 在ansible.cfg的[defaults]部分添加配置</p> 
<pre><code>interpreter_python = auto_legacy_silent
</code></pre> 
<p>2、报错如下</p> 
<pre><code class="prism language-shell"><span class="token operator">|</span> FAILED<span class="token operator">!</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"ansible_facts"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"discovered_interpreter_python"</span><span class="token builtin class-name">:</span> <span class="token string">"/usr/bin/python"</span>
    <span class="token punctuation">}</span>,
    <span class="token string">"changed"</span><span class="token builtin class-name">:</span> false,
    <span class="token string">"module_stderr"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
    <span class="token string">"module_stdout"</span><span class="token builtin class-name">:</span> <span class="token string">"sudo: a password is required<span class="token entity" title="\r">\r</span><span class="token entity" title="\n">\n</span>"</span>,
    <span class="token string">"msg"</span><span class="token builtin class-name">:</span> <span class="token string">"MODULE FAILURE<span class="token entity" title="\n">\n</span>See stdout/stderr for the exact error"</span>,
    <span class="token string">"rc"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
<span class="token punctuation">[</span>WARNING<span class="token punctuation">]</span>: Consider using <span class="token string">'become'</span>, <span class="token string">'become_method'</span>, and <span class="token string">'become_user'</span> rather than running <span class="token function">sudo</span>
</code></pre> 
<p>解决</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@leo ~<span class="token punctuation">]</span><span class="token comment"># visudo</span>
username   <span class="token assign-left variable">ALL</span><span class="token operator">=</span><span class="token punctuation">(</span>ALL<span class="token punctuation">)</span>       NOPASSWD: ALL
</code></pre> 
<p>3、报错如下</p> 
<pre><code class="prism language-ruby"><span class="token operator">|</span> <span class="token constant">FAILED</span> <span class="token operator">|</span> rc<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&gt;&gt;</span>
Timeout <span class="token punctuation">(</span><span class="token number">12</span>s<span class="token punctuation">)</span> waiting <span class="token keyword">for</span> privilege escalation prompt<span class="token operator">:</span>
</code></pre> 
<p>语法修改添加参数<code>-c paramiko</code></p> 
<pre><code>ansible all  -m shell -a 'sudo mkdir -p /home/leo/ansible'  -c paramiko
</code></pre> 
<p>3、报错如下</p> 
<pre><code class="prism language-ruby">Permission denied <span class="token punctuation">(</span>publickey<span class="token punctuation">,</span>gssapi<span class="token operator">-</span>keyex<span class="token punctuation">,</span>gssapi<span class="token operator">-</span>with<span class="token operator">-</span>mic<span class="token punctuation">,</span>password<span class="token punctuation">)</span><span class="token punctuation">.</span>
</code></pre> 
<p>解决：</p> 
<pre><code class="prism language-ruby">cat  <span class="token regex-literal"><span class="token regex">/root/</span></span><span class="token punctuation">.</span>ssh<span class="token operator">/</span>id_rsa<span class="token punctuation">.</span>pub <span class="token operator">&gt;&gt;</span> <span class="token regex-literal"><span class="token regex">/root/</span></span><span class="token punctuation">.</span>ssh<span class="token operator">/</span>authorized_keys
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/eda56d499b41c6d03143ef63b81d46ba/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">使用Go构建一个Postgres流平台</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6f622e69f73eb504d9fc472b8a7c0052/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">tensorrt推理 onxx转engine代码（python），cyclegan网络推理（python、C&#43;&#43;）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>