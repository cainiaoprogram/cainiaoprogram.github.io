<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Win10系统VS2022开发环境中(X86)Win32汇编(MASM32)环境配置和一些示例源码及解释 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Win10系统VS2022开发环境中(X86)Win32汇编(MASM32)环境配置和一些示例源码及解释" />
<meta property="og:description" content="抱歉，还是只能用米国的软件以及技术以及等等等等。。。。。。，所以各位勿怪。
如果配置完成，在vs2022调试环境下正确编译运行后，可以看到如下画面:
在VS022中开发学习汇编必然很方便。
这里可以下载vs2022项目源码: vs2022中Win32汇编(MASM32)环境配置和测试源码-桌面系统文档类资源-CSDN下载
注意, AsmDude(GitHub - vilyLei/asm-dude: Visual Studio extension for assembly syntax highlighting and code completion in assembly files and the disassembly window)只支持到vs2019。
主要配置过程如下： step1: 按照vs2022(直接官网下载Community版本)
step2：Download The MASM32 SDK这里下载masm32v11r.zip这个压缩包
step3: 将MASM32的install.exe运行安装到C盘(也可以是别的盘)，安装过程注意同意其解压，这里会耽搁一小段时间。
step4: 在vs2022中建立一个控制台应用。删除原来默认生成的cpp文件。
step5: 在项目图标上上右键, 生成依赖项-&gt;生成自定义-&gt;选中masm, 如下图:
step6: 在源文件图标上右键，添加 -&gt; 新建项， 新建 test.asm文件。
step7: 在test.asm写入代码如下:
.386 .model flat, stdcall .stack 4096 option casemap:none include	windows.inc include	user32.inc includelib	user32.lib include	kernel32.inc includelib	kernel32.lib .const szCaption	db	&#39;恭喜&#39;,0 szText	db	&#39;Win32汇编程序成功编译!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/70e8f3e4ef74fa0eccea5242f0e06ff7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-01T10:12:19+08:00" />
<meta property="article:modified_time" content="2022-04-01T10:12:19+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Win10系统VS2022开发环境中(X86)Win32汇编(MASM32)环境配置和一些示例源码及解释</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>抱歉，还是只能用米国的软件以及技术以及等等等等。。。。。。，所以各位勿怪。</p> 
<p>如果配置完成，在vs2022调试环境下正确编译运行后，可以看到如下画面:</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/e4/40/NtbQoOxX_o.png"></p> 
<p>在VS022中开发学习汇编必然很方便。</p> 
<p>这里可以下载vs2022项目源码: <a href="https://download.csdn.net/download/vily_lei/84796374" title="vs2022中Win32汇编(MASM32)环境配置和测试源码-桌面系统文档类资源-CSDN下载">vs2022中Win32汇编(MASM32)环境配置和测试源码-桌面系统文档类资源-CSDN下载</a></p> 
<p>注意, AsmDude(<a href="https://github.com/vilyLei/asm-dude" title="GitHub - vilyLei/asm-dude: Visual Studio extension for assembly syntax highlighting and code completion in assembly files and the disassembly window">GitHub - vilyLei/asm-dude: Visual Studio extension for assembly syntax highlighting and code completion in assembly files and the disassembly window</a>)只支持到vs2019。</p> 
<h3>主要配置过程如下：</h3> 
<p><strong>step1</strong>: 按照vs2022(直接官网下载Community版本)</p> 
<p><strong>step2</strong>：<a href="http://www.masm32.com/download.htm" rel="nofollow" title="Download The MASM32 SDK">Download The MASM32 SDK</a>这里下载masm32v11r.zip这个压缩包</p> 
<p><strong>step3</strong>: 将MASM32的install.exe运行安装到C盘(也可以是别的盘)，安装过程注意同意其解压，这里会耽搁一小段时间。</p> 
<p><strong>step4</strong>: 在vs2022中建立一个控制台应用。<span style="color:#fe2c24;">删除原来默认生成的cpp文件</span>。</p> 
<p><strong>step5</strong>: 在项目图标上上右键, 生成依赖项-&gt;生成自定义-&gt;选中masm, 如下图:</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/39/77/dyVZTRAf_o.png"></p> 
<p><strong>step6</strong>: 在源文件图标上右键，添加 -&gt; 新建项， 新建 test.asm文件。</p> 
<p><strong>step7</strong>: 在test.asm写入代码如下:</p> 
<pre><code>.386
.model flat, stdcall
.stack 4096
option casemap:none

include		windows.inc
include		user32.inc
includelib	user32.lib
include		kernel32.inc
includelib	kernel32.lib

.const

szCaption	db	'恭喜',0
szText		db	'Win32汇编程序成功编译!',0

.data

ExitProcess proto, dwExitcode: dword
; 代码段
.code
mainT PROC
	invoke	MessageBox,NULL,offset szText,offset szCaption,MB_OK
	invoke	ExitProcess,NULL

mainT ENDP

END mainT

// 部分代码源自 &lt;&lt;[琢石成器—Windows环境下32位汇编语言程序设计].罗云彬.第三版&gt;&gt;</code></pre> 
<p>上面代码中的 mainT是我这里为了解释如何配置而故意起的名字。</p> 
<p><strong>step8</strong>: 设置test.asm属性。在test.asm文件图标上点击右键-&gt;属性, 在弹出的界面设置如下图示:</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/56/ff/6UZasYmV_o.png"></p> 
<p><strong>step9</strong>: 设置解决方案平台配置为x86，如下图。</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/36/2f/snnYv6Jj_o.png"></p> 
<p><strong>step10</strong>: 在项目图标上右键，属性，设置程序入口为mainT，如下图:</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/23/e1/oyKer2eJ_o.png"></p> 
<p><strong>step11</strong>: 配置MASM32库目录。我的masm32安装目录是 C:\masm32, 所以才有如下图示的相关路径配置：</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/a0/b6/fRv0RHRG_o.png"></p> 
<p><img alt="" src="https://images2.imgbox.com/f1/ac/qLqwgXVi_o.png"></p> 
<p><strong>step12</strong>: 平台工具集的相关设置。右键项目图标，打开属性界面，设置如下:</p> 
<p>首先看到的是如下界面:</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/43/22/IfaHNnWJ_o.png"></p> 
<p>设置完成应用之后是就会变成如下图所示的界面： </p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/c7/17/dBq1ImMC_o.png"></p> 
<p>注意，默认vs2022所带的平台工具集版本版本较高，无法正常支持masm32, 需要按照低版本的工具集。(vs2022顶部主菜单)工具 -&gt; 获取工具和功能 -&gt; 修改，如下图：</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/0e/d3/2odTgZ3c_o.png"></p> 
<p>至此，设置完成，可以运行了。 </p> 
<p>再写一个 message box中的hello world显示代码:</p> 
<pre><code>.386
.model flat, stdcall
.stack 4096
option casemap:none

include		windows.inc
include		user32.inc
includelib	user32.lib
include		kernel32.inc
includelib	kernel32.lib

.data
	szCaption	db	'A MessageBox !',0
	szText		db	'Hello, World !',0
; 代码段
.code
mainT PROC
	invoke	MessageBox,NULL,offset szText,offset szCaption,MB_OK
	invoke	ExitProcess,NULL

mainT ENDP

END mainT
</code></pre> 
<p>调用成功如下图:</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/ec/a2/Rrf6NgWx_o.png"></p> 
<p></p> 
<h4>注意:</h4> 
<p>1. 防止 <strong>LNK2026    模块对于 SAFESEH 映像是不安全的</strong> 这个错误(release环境下)导致编译运行问题在属性窗口-&gt;连接器-&gt;命令行 里做如下图的设置(/SAFESEH:NO):</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/4a/51/MzNW5Ma2_o.png"></p> 
<p>2. 非法(错误的)访问不应该访问的内存区域会报 <strong>处有未经处理的异常: 0xC0000005: 执行位置 0x00585022 时发生访问冲突</strong> 这种错误。例如 asm代码中将函数定义在数据区就会报这个错误。下面是示例代码:</p> 
<pre><code>	.386
	.model flat, stdcall
	.stack 4096
	option casemap:none
	
; include some libs
	include		windows.inc
	include		kernel32.inc
	includelib	kernel32.lib

; data section
	.data
		szText		db	'Hello, MASM PROC !',0

	; 因为这个函数定义在数据区(段)，数据区是不具备可执行属性的，所以调用此函数会报 处有未经处理的异常: 0xC0000005: 执行位置 0x00585022 时发生访问冲突
	ErrorDefineFunc	proc	c uses eax ecx param0, param1
						mov		eax, param0
						mov		ecx, param1
						add		eax, ecx
						ret
	ErrorDefineFunc	endp
	.code
; define some proc
	; 定义在代码区域(段)内，能正确访问
	CorrectDefineFunc	proc	stdcall uses eax ecx param0, param1
						mov		eax, param0
						mov		ecx, param1
						add		eax, ecx
						ret
	CorrectDefineFunc	endp

	mainT proc
			; 调用此函数会出现崩溃错误：执行位置 0x00585022 时发生访问冲突
			;invoke		ErrorDefineFunc, 1, 2
			; 能正确调用此函数
			invoke		CorrectDefineFunc, 1, 2

			xor			eax, eax
			invoke		ExitProcess,NULL
	mainT endp
	end
; 注意 0x00585022 这个内存位置是的的值和运行时具体使用的内存有关
</code></pre> 
<p>上面的汇编代码编译为Debug程序再反汇编如下图:</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/9b/c6/GwvtFqeJ_o.png"></p> 
<p>上图中的一些指令:</p> 
<p>        INT3指令： Debugger breakpoint trap.</p> 
<p>        RETN指令：The <strong>ret</strong> instruction pops and jumps to the return address on the stack. A nonzero <em>#n</em> in the <strong>RET</strong> instruction indicates that after popping the return address, the value <em>#n</em> should be added to the stack pointer. RETN 8也就是 stack(栈) pop 8个字节。在这个程序里面也就是 ESP += 8。之所以8个字节，因为函数调用的时候，为了传参数，push了一个dword(4字节) 的2和一个dword(4字节) 的1，push一次执行一次ESP -= 4操作。注意，这里的操作全部是内存地址上的操作。</p> 
<p>        LEAVE指令：Tear down stack frame, 相当于如下汇编代码：</p> 
<pre><code>mov esp, ebp
pop ebp</code></pre> 
<p>        因为进入函数的时候，执行了如下代码:</p> 
<pre><code>PUSH EBP
MOV EBP, ESP</code></pre> 
<p>        因此函数返回之前要执行 LEAVE 指令。</p> 
<p>汇编指令细节详见: <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/x86-instructions" rel="nofollow" title="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/x86-instructions">https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/x86-instructions</a></p> 
<p><br> 一些x86伪指令(例如 .data, .code, invoke, proc 等等):</p> 
<p><a href="https://docs.microsoft.com/en-us/cpp/assembler/masm/proc?view=msvc-140" rel="nofollow" title="PROC | Microsoft Docs">PROC | Microsoft Docs</a></p> 
<p>伪指令由汇编编译器翻译为对应的汇编代码(指令)，用了伪指令能方便开发者写程序，但是也因为隐藏了细节而造成一些麻烦。因此，需要通过汇编程序编译出来之后再反汇编才能看到真正的汇编代码或指令。<strong>注意Release版本反汇编看到的汇编代码和Debug版本反汇编看到的汇编代码是有区别的。</strong></p> 
<p>上面的汇编代码编译为Release程序再反汇编如下图:</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/f6/f7/zFSXvFGD_o.png"></p> 
<p></p> 
<p>3.查看寄存器相关信息(寄存器中的值)</p> 
<p>        第一步， 在汇编源程序中设置断点，运行并进入调试状态。</p> 
<p>        第二步，vs顶部主菜单中选择: 调试 -&gt; 窗口 -&gt; 寄存器。就可以看到各个寄存器的值了。</p> 
<p>        第三步，在显示寄存器值得区域内点金右键，弹出菜单，就可以选择显示 <strong>标志寄存器、MMX、SSE</strong>等状态信息了。如下图:</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/7e/06/8yLcDsr1_o.png"></p> 
<p>可以和ARM(Advanced RISC Machines)处理器的寄存器做个比较，ARM 寄存器如下图:</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/ac/e1/zSzE1jCv_o.png"></p> 
<p>上图源自: <a href="https://www.intel.com/content/dam/www/programmable/us/en/pdfs/literature/third-party/ddi0100e_arm_arm.pdf" rel="nofollow" title="https://www.intel.com/content/dam/www/programmable/us/en/pdfs/literature/third-party/ddi0100e_arm_arm.pdf">https://www.intel.com/content/dam/www/programmable/us/en/pdfs/literature/third-party/ddi0100e_arm_arm.pdf</a></p> 
<p style="text-align:center;"></p> 
<h4>一些汇编相关的资料:<br><br><a href="https://www.cs.virginia.edu/~evans/cs216/guides/x86.pdf" rel="nofollow" title="https://www.cs.virginia.edu/~evans/cs216/guides/x86.pdf">https://www.cs.virginia.edu/~evans/cs216/guides/x86.pdf</a></h4> 
<p><a href="https://www.intel.com/content/dam/www/public/us/en/documents/manuals/64-ia-32-architectures-software-developer-instruction-set-reference-manual-325383.pdf" rel="nofollow" title="https://www.intel.com/content/dam/www/public/us/en/documents/manuals/64-ia-32-architectures-software-developer-instruction-set-reference-manual-325383.pdf">https://www.intel.com/content/dam/www/public/us/en/documents/manuals/64-ia-32-architectures-software-developer-instruction-set-reference-manual-325383.pdf</a></p> 
<p><a href="https://docs.oracle.com/cd/E19641-01/802-1948/802-1948.pdf" rel="nofollow" title="https://docs.oracle.com/cd/E19641-01/802-1948/802-1948.pdf">https://docs.oracle.com/cd/E19641-01/802-1948/802-1948.pdf</a></p> 
<p><a href="https://web.stanford.edu/class/archive/cs/cs107/cs107.1186/guide/x86-64.html" rel="nofollow" title="CS107 Guide to x86-64">CS107 Guide to x86-64</a></p> 
<p>windows api:</p> 
<p><a href="https://docs.microsoft.com/en-us/windows/console/writeconsole" rel="nofollow" title="WriteConsole function - Windows Console | Microsoft Docs">WriteConsole function - Windows Console | Microsoft Docs</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/71da22d837a9ed54bddb0d2a52958dad/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">8、随机裁剪 transforms.RandomCrop(）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7118ddc9eeb3b82195d2aa31a87a800b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【时空序列预测paper】PredRNN: Recurrent Neural Networks for PredictiveLearning using Spatiotemporal LSTMs</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>