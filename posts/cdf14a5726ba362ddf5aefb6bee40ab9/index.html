<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>netty 通过端口调用关闭 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="netty 通过端口调用关闭" />
<meta property="og:description" content="package websocketdemo.timeserver2;
import io.netty.bootstrap.ServerBootstrap;
import io.netty.channel.Channel;
import io.netty.channel.ChannelFuture;
import io.netty.channel.ChannelInitializer;
import io.netty.channel.ChannelOption;
import io.netty.channel.EventLoopGroup;
import io.netty.channel.nio.NioEventLoopGroup;
import io.netty.channel.socket.SocketChannel;
import io.netty.channel.socket.nio.NioServerSocketChannel;
import io.netty.handler.codec.http.HttpServerCodec;
/**
* 通过端口调用关闭netty演示&lt;br /&gt;
* 调用方法&lt;br /&gt;
* new TimeServer(8080, 8081).run(); //8080, 正常工作商品, 8081, 关闭端口&lt;br /&gt;
* http;//127.0.0.1:8081/close; //关闭netty
* @author lizw
*/
public class TimeServer {
private int port;
private int port_shutdown;
public TimeServer(int port) {
this.port = port;
}
public TimeServer(int port, int port_shutdown) {" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/cdf14a5726ba362ddf5aefb6bee40ab9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2015-12-26T17:48:42+08:00" />
<meta property="article:modified_time" content="2015-12-26T17:48:42+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">netty 通过端口调用关闭</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <pre><code class="language-java"><br>package websocketdemo.timeserver2;<br><br>import io.netty.bootstrap.ServerBootstrap;<br>import io.netty.channel.Channel;<br>import io.netty.channel.ChannelFuture;<br>import io.netty.channel.ChannelInitializer;<br>import io.netty.channel.ChannelOption;<br>import io.netty.channel.EventLoopGroup;<br>import io.netty.channel.nio.NioEventLoopGroup;<br>import io.netty.channel.socket.SocketChannel;<br>import io.netty.channel.socket.nio.NioServerSocketChannel;<br>import io.netty.handler.codec.http.HttpServerCodec;<br><br>/**<br> * 通过端口调用关闭netty演示&lt;br /&gt;<br> * 调用方法&lt;br /&gt;<br> * new TimeServer(8080, 8081).run(); //8080, 正常工作商品, 8081, 关闭端口&lt;br /&gt;<br> * http;//127.0.0.1:8081/close; //关闭netty<br> * @author lizw<br> */<br>public class TimeServer {<!-- --><br><br>	private int port;<br>	private int port_shutdown;<br><br>	public TimeServer(int port) {<!-- --><br>		this.port = port;<br>	}<br>	public TimeServer(int port, int port_shutdown) {<!-- --><br>		this.port = port;<br>		this.port_shutdown = port_shutdown;<br>	}<br><br>	public void run() throws Exception {<!-- --><br>		//用于常规端口的Group<br>		EventLoopGroup bossGroup = new NioEventLoopGroup();<br>		EventLoopGroup workerGroup = new NioEventLoopGroup();<br>		//用于关闭端口的Group<br>		EventLoopGroup bossGroup2 = new NioEventLoopGroup();<br>		EventLoopGroup workerGroup2 = new NioEventLoopGroup();<br>		try {<!-- --><br>			ServerBootstrap b=null;		//常规netty服务<br>			ServerBootstrap b2=null;	//关闭netty服务<br>			ChannelFuture f=null;<br>			ChannelFuture f2=null;<br>			{<!-- --><br>				//常规端口服务器建立<br>				System.out.println("start regular netty server thread");<br>				b = new ServerBootstrap(); // (2)<br>				b.group(bossGroup, workerGroup)<br>						.channel(NioServerSocketChannel.class) // (3)<br>						.childHandler(new ChannelInitializer&lt;SocketChannel&gt;() { // (4)<br>							@Override<br>							public void initChannel(SocketChannel ch) throws Exception {<!-- --><br>								ch.pipeline().addLast(new TimeServerHandler());<br>							}<br>						})<br>						.option(ChannelOption.SO_BACKLOG, 128) // (5)<br>						.childOption(ChannelOption.SO_KEEPALIVE, true); // (6)<br><br>				// Bind and start to accept incoming connections.<br>				f = b.bind(port).sync(); // (7)<br>			}<br>			{<!-- --><br>				//关闭netty应用服务器建立<br>				System.out.println("start shutdown netty server thread");<br>				b2 = new ServerBootstrap();<br>				b2.group(workerGroup2, bossGroup2);<br>				b2.channel(NioServerSocketChannel.class);<br>				final EventLoopGroup[] group={workerGroup, bossGroup, workerGroup2, bossGroup2};<br>				b2.childHandler(new ChannelInitializer() {<!-- --><br><br>					@Override<br>					protected void initChannel(Channel ch) throws Exception {<!-- --><br>						ch.pipeline().addLast(new HttpServerCodec());<br>						ch.pipeline().addLast(new CloaseServerHandler(group));<br>					}<br>				});<br>				f2 = b2.bind(port_shutdown).sync();<br>			}<br><br>			f.channel().closeFuture();<br>			f2.channel().closeFuture();<br>			System.out.println("netty服务器运行中");<br>		} finally {<!-- --><br>		}<br><br>	}<br><br>	public static void main(String[] args) throws Exception {<!-- --><br>		System.out.println("main start");<br>		int port=8080;<br>		int port_shutdown=8081;<br>		new TimeServer(port, port_shutdown).run();<br>		System.out.println("main end");<br>	}<br>}<br><br></code></pre> 
<br> 
<br> 
<pre><code class="language-java"><br>/*<br> * To change this license header, choose License Headers in Project Properties.<br> * To change this template file, choose Tools | Templates<br> * and open the template in the editor.<br> */<br>package websocketdemo.timeserver2;<br><br>import io.netty.buffer.ByteBuf;<br>import io.netty.buffer.Unpooled;<br>import io.netty.channel.Channel;<br>import io.netty.channel.ChannelFuture;<br>import io.netty.channel.ChannelFutureListener;<br>import io.netty.channel.ChannelHandlerContext;<br>import io.netty.channel.ChannelInboundHandlerAdapter;<br>import io.netty.channel.EventLoopGroup;<br>import io.netty.handler.codec.http.DefaultFullHttpResponse;<br>import io.netty.handler.codec.http.DefaultHttpRequest;<br>import io.netty.handler.codec.http.FullHttpResponse;<br>import static io.netty.handler.codec.http.HttpHeaders.Names.ACCEPT_RANGES;<br>import static io.netty.handler.codec.http.HttpHeaders.Names.CONTENT_LENGTH;<br>import static io.netty.handler.codec.http.HttpHeaders.Names.CONTENT_TYPE;<br>import static io.netty.handler.codec.http.HttpHeaders.Names.DATE;<br>import static io.netty.handler.codec.http.HttpHeaders.Names.SERVER;<br>import io.netty.handler.codec.http.HttpResponseStatus;<br>import io.netty.handler.codec.http.HttpVersion;<br>import java.io.UnsupportedEncodingException;<br>import java.util.Date;<br><br>/**<br> * 处理http请求, 用于判断 uri = "/close" 时关闭netty应用<br> * @author lizw<br> */<br>public class CloaseServerHandler extends ChannelInboundHandlerAdapter {<!-- --><br><br>	EventLoopGroup[] group;<br><br>	public CloaseServerHandler(EventLoopGroup[] group) {<!-- --><br>		this.group = group;<br>	}<br><br><br>	/**<br>	 * 处理http请求, 如果 uri = "/close" 则关闭服务器, 否则返回 404页面(BAD_GATEWAY)<br>	 * @param ctx<br>	 * @param msg<br>	 * @throws Exception <br>	 */<br>	@Override<br>	public void channelRead(final ChannelHandlerContext ctx, Object msg) throws Exception {<!-- --><br>		super.channelActive(ctx); //To change body of generated methods, choose Tools | Templates.<br>		DefaultHttpRequest req=null;<br>		FullHttpResponse response=null;<br>		boolean isClose=false;<br>		if(msg instanceof DefaultHttpRequest){<!-- --><br>			req=(DefaultHttpRequest)msg;<br>			String uri=req.getUri();<br>			if(0==uri.indexOf("/close"))<br>				isClose=true;<br>		}<br>		response=closeNetty(isClose);<br>		final ChannelFuture cf = ctx.writeAndFlush(response); // (3)<br>		if(!isClose)<br>			return;<br>		cf.addListener(new ChannelFutureListener() {<!-- --><br>			@Override<br>			public void operationComplete(ChannelFuture future) {<!-- --><br>				ctx.close();<br>				System.out.println("服务器马上关闭");<br>				for (EventLoopGroup g : group) {<!-- --><br>					g.shutdownGracefully();<br>				}<br>				System.out.println("服务器马上完成");<br>			}<br>		});<br>	}<br><br>	/**<br>	 * 关闭netty请求的响应<br>	 * @param flag true - 关闭, false - 返回 404页面(BAD_GATEWAY)<br>	 * @param FullHttpResponse<br>	 */<br>	private FullHttpResponse closeNetty(boolean flag) throws UnsupportedEncodingException{<!-- --><br>		FullHttpResponse response=null;<br>		if(flag){<!-- --><br>			String text=new String("服务器即将关闭");<br>			ByteBuf buf = Unpooled.wrappedBuffer(text.getBytes("utf-8"));<br>			response=new DefaultFullHttpResponse(HttpVersion.HTTP_1_1, HttpResponseStatus.OK, buf);<br>		}else{<!-- --><br>			String text=new String("404");<br>			ByteBuf buf = Unpooled.wrappedBuffer(text.getBytes("utf-8"));<br>			response=new DefaultFullHttpResponse(HttpVersion.HTTP_1_1, HttpResponseStatus.BAD_GATEWAY, buf);<br>		}<br>		response.headers().set(CONTENT_TYPE, "text/html;charset=utf-8");<br>		response.headers().set(CONTENT_LENGTH, response.content().readableBytes());<br>		response.headers().set(DATE, new Date().toString());<br>		response.headers().set(SERVER, "netty-4.0.29-Final");<br>		response.headers().set(ACCEPT_RANGES, "bytes");<br>		return response;<br>	}<br>}<br><br></code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6b015b3f225a905bc12ae4918b3fc52c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">css 文字长时不换行 显示...</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/17b8bcca01e925ccf64fa5a346d9f62a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Openwrt编译问题:Libnettle 3.1 was not found.</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>