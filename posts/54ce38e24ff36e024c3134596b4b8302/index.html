<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>druid数据库连接池问题：java.sql.SQLException: connection holder is null - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="druid数据库连接池问题：java.sql.SQLException: connection holder is null" />
<meta property="og:description" content="2019独角兽企业重金招聘Python工程师标准&gt;&gt;&gt; 项目中使用了alibaba/druid数据库连接池，但是发现运行着一段时间后，总会报
java.sql.SQLException: connection holder is null 查阅很多解决办法都说设置。
&lt;property name=&#34;removeAbandoned&#34; value=&#34;true&#34; /&gt; &lt;property name=&#34;removeAbandonedTimeout&#34; value=&#34;1800&#34; /&gt; 这两个参数就可以了，但我的项目里，并不是这种超时间使用连接没有回收而导致的，所以这种解决方法并不能解决我的问题。
而且druid版本已经是1.1.2最新的版本，排除了druid非bug原因，那就是我本身项目代码问题了。
在druid官方github问题里也有很多同学的发现问题发析原因，顿时有了思路。
参考连接: 原因分析1、原因分析2。
两个问题都指出跨线程使用druid而引发的，温少也建议不要跨线程使用数据连接。
所以经过两天的查资料，和不断地尝试，终于找出问题所在。
首先我的项目里是用了spring-boot，连接池配置这些就不贴出来了，都大同小异。
而我的事务管理也是用的是spring的 @Transactional 注入管理。
问题在于，我的一个service方法里的一个方法里，该方法在事务提交之后，会再次触发另一个service执行代码。
@Service @Transactional(value = &#34;transaction&#34;, rollbackFor = Exception.class) public class a_service { @Autowired private Dao dao; @Autowired private ApplicationEventPublisher publisher; /** *该方法执行所有代码之后，会触发publisher.publishEvent方法 */ public String test(){ .....省略执行代码..... publisher.publishEvent(params); } } @Service @Transactional(value = &#34;transaction&#34;, rollbackFor = Exception.class) public class b_service { @Autowired private Dao dao; /** * 当事务提交后, 才会真正的执行@TransactionalEventListener配置的Listener, 如果Listener抛异常, 方法返回失 * 败, 但事务不会回滚." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/54ce38e24ff36e024c3134596b4b8302/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2017-08-11T11:38:00+08:00" />
<meta property="article:modified_time" content="2017-08-11T11:38:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">druid数据库连接池问题：java.sql.SQLException: connection holder is null</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div class="content" id="articleContent"> 
 <div class="ad-wrap"> 
  <p><a style="color:#A00;font-weight:bold;" href="https://my.oschina.net/u/2663968/blog/3061697" rel="nofollow">2019独角兽企业重金招聘Python工程师标准&gt;&gt;&gt; </a> <img src="https://images2.imgbox.com/96/d2/JlN87C4y_o.png" alt="hot3.png"></p> 
 </div> 
 <p>项目中使用了<a href="https://github.com/alibaba">alibaba</a>/<strong><a href="https://github.com/alibaba/druid">druid</a>数据库连接池，但是发现运行着一段时间后，总会报</strong></p> 
 <pre><code class="language-java">java.sql.SQLException: connection holder is null</code></pre> 
 <p>查阅很多解决办法都说设置。</p> 
 <pre><code class="language-java"> &lt;property name="removeAbandoned" value="true" /&gt;

 &lt;property name="removeAbandonedTimeout" value="1800" /&gt;</code></pre> 
 <p>这两个参数就可以了，但我的项目里，并不是这种超时间使用连接没有回收而导致的，所以这种解决方法并不能解决我的问题。</p> 
 <p>而且druid版本已经是1.1.2最新的版本，排除了druid非bug原因，那就是我本身项目代码问题了。</p> 
 <p>在druid官方github问题里也有很多同学的发现问题发析原因，顿时有了思路。</p> 
 <p>参考连接:  <a href="https://github.com/alibaba/druid/issues/1889">原因分析1</a>、<a href="https://github.com/alibaba/druid/issues/1429">原因分析2</a>。</p> 
 <p>两个问题都指出跨线程使用druid而引发的，温少也建议不要跨线程使用数据连接。</p> 
 <p>所以经过两天的查资料，和不断地尝试，终于找出问题所在。</p> 
 <p>首先我的项目里是用了spring-boot，连接池配置这些就不贴出来了，都大同小异。</p> 
 <p>而我的事务管理也是用的是spring的 @Transactional 注入管理。</p> 
 <p>问题在于，我的一个service方法里的一个方法里，该方法在事务提交之后，会再次触发另一个service执行代码。</p> 
 <pre><code class="language-java">@Service
@Transactional(value = "transaction", rollbackFor = Exception.class)
public class a_service {
    
    @Autowired
    private Dao dao;

    @Autowired
    private ApplicationEventPublisher publisher;
    
    /**
     *该方法执行所有代码之后，会触发publisher.publishEvent方法
     */
    public String test(){
        .....省略执行代码.....
        
        publisher.publishEvent(params);
    }


}

@Service
@Transactional(value = "transaction", rollbackFor = Exception.class)
public class b_service {

    @Autowired
    private Dao dao;
    
    /**
     * 当事务提交后, 才会真正的执行@TransactionalEventListener配置的Listener, 如果Listener抛异常, 方法返回失
     * 败, 但事务不会回滚.
     */
    @TransactionalEventListener(phase = TransactionPhase.AFTER_COMPLETION)
    public String test(){
        dao.save(params);
    }


}</code></pre> 
 <p> </p> 
 <p>问题就出于 b_service执行这里，当触发b_service方法时，b_service的事务隔离级别是默认PROPAGATION_REQUIRED，即如果当前存在事务则加入该事务</p> 
 <p>PROPAGATION_REQUIRED<br> 加入当前正要执行的事务不在另外一个事务里，那么就起一个新的事务<br> 比如说，ServiceB.methodB的事务级别定义为PROPAGATION_REQUIRED, 那么由于执行ServiceA.methodA的时候，<br> ServiceA.methodA已经起了事务，这时调用ServiceB.methodB，ServiceB.methodB看到自己已经运行在ServiceA.methodA<br> 的事务内部，就不再起新的事务。而假如ServiceA.methodA运行的时候发现自己没有在事务中，他就会为自己分配一个事务。<br> 这样，在ServiceA.methodA或者在ServiceB.methodB内的任何地方出现异常，事务都会被回滚。即使ServiceB.methodB的事务已经被<br> 提交，但是ServiceA.methodA在接下来fail要回滚，ServiceB.methodB也要回滚</p> 
 <p>由于b_service方法事务监听a_service方法，a_service的连接提交事务后就回收到连接池中，b_service获取方法运行完之后归还连接，b_service获取的连接可能是a_service的准备归返的连接，所以就造成跨线程使用链接问题</p> 
 <p>解决方法就是在b_service 事务管理设置事务级别 <span style="color:#FF0000;">propagation = Propagation.REQUIRES_NEW</span></p> 
 <pre><code class="language-java">@Service
@Transactional(value = "transaction", propagation = Propagation.REQUIRES_NEW, rollbackFor = Exception.class)
public class b_service {

    @Autowired
    private Dao dao;
    
    /**
     * 当事务提交后, 才会真正的执行@TransactionalEventListener配置的Listener, 如果Listener抛异常, 方法返回失
     * 败, 但事务不会回滚.
     */
    @TransactionalEventListener(phase = TransactionPhase.AFTER_COMPLETION)
    public String test(){
        dao.save(params);
    }


}</code></pre> 
 <p>参考资料</p> 
 <p>https://github.com/alibaba/druid/issues/1429</p> 
 <p>https://github.com/alibaba/druid/issues/1889</p> 
 <p>http://timerbin.iteye.com/blog/2332995</p> 
 <p>https://my.oschina.net/haogrgr/blog/224010</p> 
 <p> </p> 
 <p>ps：</p> 
 <p>@TransactionalEventListener, 可以方便在事务周期内处理一些事情, 比如事务提交后触发某一事件.</p> 
 <p>    一个场景就是, 当插入记录提交事务后, 异步发送消息到其他系统, 或本地记录日志等操作, 现在可以通过TransactionalEventListener来做了. </p> 
 <p><a href="https://my.oschina.net/u/1789379/blog/1506456" rel="nofollow">更多关于TransactionalEventListener使用</a></p> 
 <p>上面的文字解释可能表达得不太好，也有些歧意，如果有更好见解，可以联系私信本人，谢谢</p> 
 <div class="ad-wrap"> 
  <div id="blog-title-ad"> 
   <ins class="adsbygoogle"></ins> 
  </div> 
 </div> 
</div> 
<p>转载于:https://my.oschina.net/u/1789379/blog/1506450</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f9d02c2433837741b167c90ed0856524/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Android Camera使用OpenGL ES 2.0和GLSurfaceView对预览进行实时二次处理（黑白滤镜）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/69e71e7af1a1a4df9bf87f83e6959b8a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">解决Can’t locate ExtUtils/MakeMaker.pm in @INC</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>