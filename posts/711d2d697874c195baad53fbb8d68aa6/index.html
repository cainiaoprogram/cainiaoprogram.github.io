<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>给Flutter &#43; FireBase 增加 badge 徽章，App启动器 通知红点。 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="给Flutter &#43; FireBase 增加 badge 徽章，App启动器 通知红点。" />
<meta property="og:description" content="在此之前需要配置好 firebase 在flutter 在项目中。（已经配置好的可以忽略此提示）
Firebase 配置教程：flutter &#43; firebase 云消息通知教程 (android-安卓、ios-苹果)_flutter firebase_messaging ios环境配置-CSDN博客
由于firebase 提供的消息通知测试只能做简单设置。所以这里需要自己搭建一个服务。
一、测试服务器搭建： 1. 来到 fireBase 控制台，进入需要搭建的项目。（生成私钥）
2.服务器环境-&gt; 向特定设备发送消息
官方文档给了六种服务器配置信息。以下例子采用 NestJs 进行快速搭建一个服务器。（搭建过程忽略）IDE使用的 Vscode。
在搭建好的项目中 安装 firebase-admin 依赖 (Linux, MacOs 命令前需要加 sudo 提高权限)
npm i firebase-admin 把上面在firebase 生成私钥 json 文件 复制到src文件夹下 并在service中引用。
Service 代码 ：(NestJs)
FireBase 官方例子比较老旧 许多Api 已经更改，需要注意。
可以直接在 NestJs 代码中，Ctrl &#43; 点击的方法进到 TypeScript 的类型声明文件中，查看相关Api 或者去官网查看相关已经废弃和新版Api。
官网Api参考连接：https://firebase.google.com/docs/reference/admin/node/firebase-admin.messaging.messaging.md?hl=zh-cn#messagingsend
import { Injectable } from &#39;@nestjs/common&#39;; import * as admin from &#39;firebase-admin&#39;; import * as serviceAccount from &#39;." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/711d2d697874c195baad53fbb8d68aa6/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-09T08:42:30+08:00" />
<meta property="article:modified_time" content="2024-01-09T08:42:30+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">给Flutter &#43; FireBase 增加 badge 徽章，App启动器 通知红点。</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <blockquote> 
 <p>在此之前需要配置好 firebase 在flutter 在项目中。（已经配置好的可以忽略此提示）</p> 
 <p>Firebase 配置教程：<a href="https://blog.csdn.net/q515656712/article/details/135121964?spm=1001.2014.3001.5502" title="flutter + firebase 云消息通知教程 (android-安卓、ios-苹果)_flutter firebase_messaging ios环境配置-CSDN博客">flutter + firebase 云消息通知教程 (android-安卓、ios-苹果)_flutter firebase_messaging ios环境配置-CSDN博客</a></p> 
</blockquote> 
<p> <span style="color:#fe2c24;">由于firebase 提供的消息通知测试只能做简单设置。所以这里需要自己搭建一个服务。</span></p> 
<h2>一、测试服务器搭建：</h2> 
<p>        1. 来到 fireBase 控制台，进入需要搭建的项目。（生成私钥）</p> 
<p>               <img alt="" height="317" src="https://images2.imgbox.com/4f/6b/NWeoohss_o.png" width="479"></p> 
<p></p> 
<p>        <a class="link-info" href="https://firebase.google.com/docs/cloud-messaging/send-message?hl=zh-cn#send-messages-to-specific-devices" rel="nofollow" title="2.服务器环境-&gt; 向特定设备发送消息">2.服务器环境-&gt; 向特定设备发送消息</a></p> 
<p>        <img alt="" height="196" src="https://images2.imgbox.com/81/ce/nxufEWll_o.png" width="354"></p> 
<p>        <strong><span style="color:#fe2c24;">官方文档给了六种服务器配置信息。以下例子采用 NestJs 进行快速搭建一个服务器。（搭建过程忽略）IDE使用的 Vscode。</span></strong></p> 
<p>        在搭建好的项目中 安装 firebase-admin 依赖 <span style="color:#fe2c24;">(Linux, MacOs 命令前需要加 sudo 提高权限)</span></p> 
<pre><code>npm i firebase-admin</code></pre> 
<p>        把上面在firebase 生成私钥 json 文件 复制到src文件夹下 并在service中引用。</p> 
<p>        <img alt="" height="419" src="https://images2.imgbox.com/85/d2/UBOmK3m6_o.png" width="515"></p> 
<p></p> 
<p><strong>Service 代码  ：(NestJs)</strong></p> 
<blockquote> 
 <p><strong><span style="color:#fe2c24;">FireBase 官方例子比较老旧 许多Api 已经更改，需要注意。</span></strong></p> 
 <p>可以直接在 NestJs 代码中，Ctrl + 点击的方法进到 TypeScript 的类型声明文件中，查看相关Api 或者去官网查看相关已经废弃和新版Api。<img alt="" height="361" src="https://images2.imgbox.com/c8/68/UlokJAyR_o.png" width="452"></p> 
 <p><a href="https://firebase.google.com/docs/reference/admin/node/firebase-admin.messaging.messaging.md?hl=zh-cn#messagingsend" rel="nofollow" title="官网Api参考连接：https://firebase.google.com/docs/reference/admin/node/firebase-admin.messaging.messaging.md?hl=zh-cn#messagingsend">官网Api参考连接：https://firebase.google.com/docs/reference/admin/node/firebase-admin.messaging.messaging.md?hl=zh-cn#messagingsend</a></p> 
</blockquote> 
<pre><code>import { Injectable } from '@nestjs/common';

import * as admin from 'firebase-admin';
import * as serviceAccount from './serviceAccountKey.json';
import { ApiTags } from '@nestjs/swagger';

const app = admin.initializeApp({
    credential: admin.credential.cert({
        projectId: serviceAccount.project_id,
        clientEmail: serviceAccount.client_email,
        privateKey: serviceAccount.private_key
    })
});

// 此处放上 firebase 为你生成的 token
let token: string = 'dAevBHOOS9GtQwWQ5ffhtU:APA91bGlc_35hvVYzV18-Ok0-ejWJvGzwrvdoMGTZSuXSxSX_k_5ZrCyLU9HrAZZZsCH9cSjwdAVFoXsKzP0H2qTBBTUaHRTZ7bgijIevdnCiiQ7UGG7qRwM3Kyh5XrGl89G8GU1NLoQ';

@ApiTags('App')
@Injectable()
export class AppService {
    async sendMessage(): Promise&lt;string&gt; {
        const message = {
            notification: {
                title: 'iwinvApp notification test2',
                body: 'body content',
            },
            data: {
                score: '850',
                time: '2:45'
            },
            apns: {
                payload: {
                    aps: { // ios 设置徽章显示数字
                        badge: 4,
                        sound: 'default'
                    }
                }
            },
            token: token
        };

        return await app.messaging().send(message)
  }
}
</code></pre> 
<p>     执行命令 启动服务：注意main.ts 中的 listen(Numbr) 中的端口号。</p> 
<pre><code>npm run start:dev</code></pre> 
<p>此时可以访问连接 <a href="http://127.0.0.1:3000/" rel="nofollow" title="http://127.0.0.1:3000/">http://127.0.0.1:3000/</a> （3000是你自己的端口号） 也可利用postman进行访问测试 <span style="color:#fe2c24;">（此例子中在Nestjs中安装了 swagger 进行测试）</span></p> 
<p><img alt="" class="left" height="574" src="https://images2.imgbox.com/a0/8f/T43Rg0DN_o.png" width="265"><img alt="" height="201" src="https://images2.imgbox.com/7f/59/dA6h0HVh_o.png" width="340"></p> 
<p></p> 
<h2>二、Android徽章问题：</h2> 
<p>对于支持应用图标徽章的 Android 设备制造商，当设备接收到 Firebase Cloud Messaging（FCM）推送通知时，往往会自动增加应用图标上的徽章数量。这种自动递增或增加徽章的行为通常是设备制造商或 Android 系统的默认行为，而无需应用程序代码进行特殊处理。</p> 
<p>但是，这种行为可能会因设备制造商和 Android 版本而异。不同的制造商可能会有自己的徽章实现方式或默认行为。因此，虽然大多数支持徽章的 Android 设备在接收到 FCM 通知时会自动增加徽章数量，但在特定设备或情况下可能会有例外。</p> 
<p>如果徽章功能对你的应用很重要，建议在支持的设备上进行详细的测试，以确保通知行为符合你的预期，并准备好处理任何可能的差异或问题。</p> 
<p><span style="color:#fe2c24;">安卓支持徽章的机型厂商 &gt;&gt;</span> <a href="https://github.com/leolin310148/ShortcutBadger/" title="GitHub - leolin310148/ShortcutBadger: An Android library supports badge notification like iOS in Samsung, LG, Sony and HTC launchers.">GitHub - leolin310148/ShortcutBadger: An Android library supports badge notification like iOS in Samsung, LG, Sony and HTC launchers.</a></p> 
<p></p> 
<h2>三、<span style="color:#4a4a4a;"><span style="background-color:#ffffff;">flutter_app_badger  flutter 应用内使用</span></span></h2> 
<p><span style="color:#4a4a4a;"><span style="background-color:#ffffff;">flutter_app_badger </span></span>插件地址&gt;&gt; <a href="https://pub.dev/packages/flutter_app_badger" rel="nofollow" title="https://pub.dev/packages/flutter_app_badger">https://pub.dev/packages/flutter_app_badger</a></p> 
<p>安装插件：</p> 
<pre><code>flutter pub add flutter_app_badger</code></pre> 
<p> ios 需要在 info.plist 中增加以下配置：</p> 
<pre><code>&lt;key&gt;UIBackgroundModes&lt;/key&gt;
    &lt;array&gt;
        &lt;string&gt;remote-notification&lt;/string&gt;
    &lt;/array&gt;</code></pre> 
<p><img alt="" height="465" src="https://images2.imgbox.com/72/94/16Y9CNwe_o.png" width="500"></p> 
<p></p> 
<pre><code>// 引入插件
import 'package:flutter_app_badger/flutter_app_badger.dart';

// 增加徽章调用方法
FlutterAppBadger.updateBadgeCount(1);

// 移除徽章方法 （ios 支持）
FlutterAppBadger.removeBadge();

// 检查当前设备是否支持徽章功能 （异步）

FlutterAppBadger.isAppBadgeSupported();</code></pre> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/985da95c4b549cf51202759c728539c7/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">用bat 命令 修改sql文件中的数据库名字 新的名字通过读取配置文件中的字段获取</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1d9e0db2a8406b4bec8a6988d45d5744/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">H3C配置远程登录（console、telnet、ssh）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>