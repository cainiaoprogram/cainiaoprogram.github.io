<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>3分钟快速实现mysql全量增量备份 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="3分钟快速实现mysql全量增量备份" />
<meta property="og:description" content="需求说明： mysql数据库ip地址为192.168.1.100，端口3306，root密码111111，
服务器cantos7中ip地址192.168.1.101
利用xtrabackup每周六进行全量备份，每天进行增量备份，保留2个礼拜的备份，并且保存到192.168.1.101的/data分区
为了在CentOS 7服务器上使用XtraBackup执行MySQL数据库的备份，您需要完成以下步骤：
步骤 1：在CentOS 7服务器（192.168.1.101）上安装Percona XtraBackup
首先，添加Percona软件包仓库：
sudo yum install https://repo.percona.com/yum/percona-release-latest.noarch.rpm 安装Percona XtraBackup：
sudo yum install percona-xtrabackup-24 步骤 2：创建备份脚本
创建一个脚本目录：
sudo mkdir -p /opt/backup_scripts 创建全量备份脚本 /opt/backup_scripts/full_backup.sh，并粘贴以下内容：
#!/bin/bash TIMESTAMP=$(date &#43;&#34;%Y-%m-%d_%H-%M-%S&#34;) BACKUP_DIR=&#34;/data/backups/full/$TIMESTAMP&#34; USER=&#34;root&#34; PASSWORD=&#34;111111&#34; HOST=&#34;192.168.1.100&#34; PORT=&#34;3306&#34; mkdir -p $BACKUP_DIR xtrabackup --backup --user=$USER --password=$PASSWORD --host=$HOST --port=$PORT --target-dir=$BACKUP_DIR xtrabackup --prepare --target-dir=$BACKUP_DIR find /data/backups/full -type d -ctime &#43;14 -exec rm -rf {} \; 创建增量备份脚本 /opt/backup_scripts/incremental_backup.sh，并粘贴以下内容：
#!/bin/bash TIMESTAMP=$(date &#43;&#34;%Y-%m-%d_%H-%M-%S&#34;) FULL_DIR=$(ls -td /data/backups/full/*/ | head -1) INCR_DIR=&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/a42d269165c4515e7cdabf2f2efd12a4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-06T14:20:00+08:00" />
<meta property="article:modified_time" content="2023-05-06T14:20:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">3分钟快速实现mysql全量增量备份</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>需求说明：</h2> 
<p>mysql数据库ip地址为192.168.1.100，端口3306，root密码111111，<br> 服务器cantos7中ip地址192.168.1.101<br> 利用xtrabackup每周六进行全量备份，每天进行增量备份，保留2个礼拜的备份，并且保存到192.168.1.101的/data分区</p> 
<p>为了在CentOS 7服务器上使用XtraBackup执行MySQL数据库的备份，您需要完成以下步骤：</p> 
<p><strong>步骤 1：在CentOS 7服务器（192.168.1.101）上安装Percona XtraBackup</strong></p> 
<ol><li> <p>首先，添加Percona软件包仓库：</p> <pre><code>sudo yum install https://repo.percona.com/yum/percona-release-latest.noarch.rpm
</code></pre> </li><li> <p>安装Percona XtraBackup：</p> <pre><code>sudo yum install percona-xtrabackup-24
</code></pre> </li></ol> 
<p><strong>步骤 2：创建备份脚本</strong></p> 
<ol><li> <p>创建一个脚本目录：</p> <pre><code>sudo mkdir -p /opt/backup_scripts
</code></pre> </li><li> <p>创建全量备份脚本 <code>/opt/backup_scripts/full_backup.sh</code>，并粘贴以下内容：</p> <pre><code class="prism language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token assign-left variable">TIMESTAMP</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +<span class="token string">"%Y-%m-%d_%H-%M-%S"</span><span class="token variable">)</span></span>
<span class="token assign-left variable">BACKUP_DIR</span><span class="token operator">=</span><span class="token string">"/data/backups/full/<span class="token variable">$TIMESTAMP</span>"</span>
<span class="token assign-left variable"><span class="token environment constant">USER</span></span><span class="token operator">=</span><span class="token string">"root"</span>
<span class="token assign-left variable">PASSWORD</span><span class="token operator">=</span><span class="token string">"111111"</span>
<span class="token assign-left variable">HOST</span><span class="token operator">=</span><span class="token string">"192.168.1.100"</span>
<span class="token assign-left variable">PORT</span><span class="token operator">=</span><span class="token string">"3306"</span>

<span class="token function">mkdir</span> -p <span class="token variable">$BACKUP_DIR</span>
xtrabackup --backup --user<span class="token operator">=</span><span class="token environment constant">$USER</span> --password<span class="token operator">=</span><span class="token variable">$PASSWORD</span> --host<span class="token operator">=</span><span class="token variable">$HOST</span> --port<span class="token operator">=</span><span class="token variable">$PORT</span> --target-dir<span class="token operator">=</span><span class="token variable">$BACKUP_DIR</span>

xtrabackup --prepare --target-dir<span class="token operator">=</span><span class="token variable">$BACKUP_DIR</span>

<span class="token function">find</span> /data/backups/full -type d -ctime +14 -exec <span class="token function">rm</span> -rf <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token punctuation">\</span><span class="token punctuation">;</span>
</code></pre> </li><li> <p>创建增量备份脚本 <code>/opt/backup_scripts/incremental_backup.sh</code>，并粘贴以下内容：</p> <pre><code class="prism language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token assign-left variable">TIMESTAMP</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +<span class="token string">"%Y-%m-%d_%H-%M-%S"</span><span class="token variable">)</span></span>
<span class="token assign-left variable">FULL_DIR</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">ls</span> -td /data/backups/full/*/ <span class="token operator">|</span> <span class="token function">head</span> -1<span class="token variable">)</span></span>
<span class="token assign-left variable">INCR_DIR</span><span class="token operator">=</span><span class="token string">"/data/backups/incremental/<span class="token variable">$TIMESTAMP</span>"</span>
<span class="token assign-left variable"><span class="token environment constant">USER</span></span><span class="token operator">=</span><span class="token string">"root"</span>
<span class="token assign-left variable">PASSWORD</span><span class="token operator">=</span><span class="token string">"111111"</span>
<span class="token assign-left variable">HOST</span><span class="token operator">=</span><span class="token string">"192.168.1.100"</span>
<span class="token assign-left variable">PORT</span><span class="token operator">=</span><span class="token string">"3306"</span>

<span class="token function">mkdir</span> -p <span class="token variable">$INCR_DIR</span>
xtrabackup --backup --incremental-basedir<span class="token operator">=</span><span class="token variable">$FULL_DIR</span> --user<span class="token operator">=</span><span class="token environment constant">$USER</span> --password<span class="token operator">=</span><span class="token variable">$PASSWORD</span> --host<span class="token operator">=</span><span class="token variable">$HOST</span> --port<span class="token operator">=</span><span class="token variable">$PORT</span> --target-dir<span class="token operator">=</span><span class="token variable">$INCR_DIR</span>

xtrabackup --prepare --apply-log-only --target-dir<span class="token operator">=</span><span class="token variable">$FULL_DIR</span>
xtrabackup --prepare --apply-log-only --incremental-dir<span class="token operator">=</span><span class="token variable">$INCR_DIR</span> --target-dir<span class="token operator">=</span><span class="token variable">$FULL_DIR</span>

<span class="token function">find</span> /data/backups/incremental -type d -ctime +14 -exec <span class="token function">rm</span> -rf <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token punctuation">\</span><span class="token punctuation">;</span>
</code></pre> </li><li> <p>使这两个脚本可执行：</p> <pre><code>sudo chmod +x /opt/backup_scripts/full_backup.sh
sudo chmod +x /opt/backup_scripts/incremental_backup.sh
</code></pre> </li></ol> 
<p><strong>步骤 3：配置定时任务</strong></p> 
<ol><li> <p>打开cron表：</p> <pre><code>crontab -e
</code></pre> </li><li> <p>添加以下条目以安排每周六进行全量备份，每天进行增量备份（您可以根据需要修改具体时间）：</p> <pre><code>#每周六凌晨1点进行全量备份
0 1 * * 6 /opt/backup_scripts/full_backup.sh &gt; /var/log/full_backup.log 2&gt;&amp;1
#每天凌晨2点进行增量备份
0 2 * * * /opt/backup_scripts/incremental_backup.sh &gt; /var/log/incremental_backup.log 2&gt;&amp;1
</code></pre> </li><li> <p>保存并退出编辑器。<br> 这样一来，您的 CentOS 7 服务器上就配置好了 XtraBackup，并且已经安排了定期的全量和增量备份。请确保检查 <code>/data/backups</code> 目录中的备份文件，以确保备份任务正常运行。如果需要，您可以根据实际需求调整定时任务的时间。</p> </li></ol> 
<p><strong>步骤 4：定期清理日志</strong><br> 您可以创建一个日志轮换脚本，用于定期清理和压缩日志文件。以下是一个简单的日志轮换脚本 <code>/opt/backup_scripts/rotate_logs.sh</code>：</p> 
<pre><code class="prism language-bash"><span class="token shebang important">#!/bin/bash</span>

<span class="token assign-left variable">LOG_DIR</span><span class="token operator">=</span><span class="token string">"/var/log"</span>
<span class="token assign-left variable">FULL_LOG_DIR</span><span class="token operator">=</span><span class="token string">"/var/log/full"</span>
<span class="token assign-left variable">INCR_LOG_DIR</span><span class="token operator">=</span><span class="token string">"/var/log/incremental"</span>
<span class="token assign-left variable">FULL_LOG</span><span class="token operator">=</span><span class="token string">"full_backup.log"</span>
<span class="token assign-left variable">INCR_LOG</span><span class="token operator">=</span><span class="token string">"incremental_backup.log"</span>
<span class="token assign-left variable">MAX_AGE</span><span class="token operator">=</span><span class="token number">10</span>

<span class="token comment"># Rotate full_backup.log</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> -e <span class="token string">"<span class="token variable">$LOG_DIR</span>/<span class="token variable">$FULL_LOG</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token function">mv</span> <span class="token string">"<span class="token variable">$LOG_DIR</span>/<span class="token variable">$FULL_LOG</span>"</span> <span class="token string">"<span class="token variable">$FULL_LOG_DIR</span>/<span class="token variable">$FULL_LOG</span>.<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%Y%m%d<span class="token variable">)</span></span>"</span>
    <span class="token function">gzip</span> -9 <span class="token string">"<span class="token variable">$FULL_LOG_DIR</span>/<span class="token variable">$FULL_LOG</span>.<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%Y%m%d<span class="token variable">)</span></span>"</span>
<span class="token keyword">fi</span>

<span class="token comment"># Rotate incremental_backup.log</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> -e <span class="token string">"<span class="token variable">$LOG_DIR</span>/<span class="token variable">$INCR_LOG</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token function">mv</span> <span class="token string">"<span class="token variable">$LOG_DIR</span>/<span class="token variable">$INCR_LOG</span>"</span> <span class="token string">"<span class="token variable">$INCR_LOG_DIR</span>/<span class="token variable">$INCR_LOG</span>.<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%Y%m%d<span class="token variable">)</span></span>"</span>
    <span class="token function">gzip</span> -9 <span class="token string">"<span class="token variable">$INCR_LOG_DIR</span>/<span class="token variable">$INCR_LOG</span>.<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%Y%m%d<span class="token variable">)</span></span>"</span>
<span class="token keyword">fi</span>

<span class="token comment"># Remove logs older than MAX_AGE days</span>
<span class="token function">find</span> <span class="token string">"<span class="token variable">$FULL_LOG_DIR</span>"</span> -type f -name <span class="token string">"<span class="token variable">$FULL_LOG</span>.*.gz"</span> -mtime +<span class="token variable">$MAX_AGE</span> -exec <span class="token function">rm</span> -f <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token punctuation">\</span><span class="token punctuation">;</span>
<span class="token function">find</span> <span class="token string">"<span class="token variable">$INCR_LOG_DIR</span>"</span> -type f -name <span class="token string">"<span class="token variable">$INCR_LOG</span>.*.gz"</span> -mtime +<span class="token variable">$MAX_AGE</span> -exec <span class="token function">rm</span> -f <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token punctuation">\</span><span class="token punctuation">;</span>
</code></pre> 
<ol><li> <p>设置脚本可执行权限：</p> <pre><code>sudo chmod +x /opt/backup_scripts/rotate_logs.sh
</code></pre> </li><li> <p>添加定时任务，每天凌晨3点执行日志轮换：</p> <pre><code>crontab -e
</code></pre> <p>添加以下条目：</p> <pre><code class="prism language-bash"><span class="token comment"># 每天凌晨5点执行日志轮换</span>
<span class="token number">0</span> <span class="token number">5</span> * * * /opt/backup_scripts/rotate_logs.sh
</code></pre> </li></ol> 
<p>这个脚本将每天早上5点运行，它将分别备份并压缩 <code>full_backup.log</code> 和 <code>incremental_backup.log</code> 文件。同时，它还将删除超过 <code>MAX_AGE</code>（默认为10天）的日志文件。您可以根据需要调整这个值。</p> 
<h3><a id="_142"></a>日志说明:</h3> 
<p><img src="https://images2.imgbox.com/79/36/3qHj8fnO_o.png" alt="在这里插入图片描述"><br> XtraBackup 在日志中显示已成功执行并备份数据库。在日志中，它显示了一系列的操作，包括 InnoDB 的恢复过程，创建和重写 redo log 文件以及其他一些初始化操作。最后，XtraBackup 完成了备份过程，并显示 “completed OK!”，表明备份已成功完成。</p> 
<p>请注意，定期备份数据库是非常重要的，以确保数据的安全性和完整性。使用 XtraBackup 可以帮助您实现这一目标。记得要定期检查日志文件，以确保备份过程始终正常运行。</p> 
<p>备份完以后可以用<code>du -lh --max-depth=1</code>查看备份文件大小</p> 
<h2><a id="_151"></a>该如何恢复：</h2> 
<p>使用Percona XtraBackup恢复MySQL数据库时，需要遵循以下步骤：</p> 
<p><strong>步骤 1：停止MySQL服务</strong><br> 在恢复数据库之前，需要停止正在运行的MySQL服务。在CentOS 7服务器上执行以下命令：</p> 
<pre><code>sudo systemctl stop mysqld
</code></pre> 
<p><strong>步骤 2：恢复全量备份</strong></p> 
<ol><li> <p>首先，导航到最新全量备份的目录：</p> <pre><code>cd /data/backups/full/&lt;latest_full_backup_directory&gt;
</code></pre> <p>请将<code>&lt;latest_full_backup_directory&gt;</code>替换为最新全量备份的目录名。</p> </li><li> <p>使用<code>xtrabackup</code>恢复全量备份：</p> <pre><code>sudo xtrabackup --copy-back --target-dir=&lt;latest_full_backup_directory&gt; --datadir=/var/lib/mysql
</code></pre> <p>请将<code>&lt;latest_full_backup_directory&gt;</code>替换为最新全量备份的目录名。</p> </li></ol> 
<p><strong>步骤 3：恢复增量备份（如有）</strong><br> 如果有增量备份，需要按照创建顺序依次恢复它们：</p> 
<ol><li> <p>导航到第一个增量备份的目录：</p> <pre><code>cd /data/backups/incremental/&lt;first_incremental_backup_directory&gt;
</code></pre> <p>请将<code>&lt;first_incremental_backup_directory&gt;</code>替换为第一个增量备份的目录名。</p> </li><li> <p>使用<code>xtrabackup</code>恢复增量备份：</p> <pre><code>sudo xtrabackup --copy-back --target-dir=&lt;first_incremental_backup_directory&gt; --datadir=/var/lib/mysql
</code></pre> <p>请将<code>&lt;first_incremental_backup_directory&gt;</code>替换为第一个增量备份的目录名。</p> </li><li> <p>对于其他增量备份，重复上述步骤。</p> </li></ol> 
<p><strong>步骤 4：设置正确的权限</strong><br> 为确保MySQL服务能够正常访问数据文件，请将数据目录的所有权更改为<code>mysql:mysql</code>：</p> 
<pre><code>sudo chown -R mysql:mysql /var/lib/mysql
</code></pre> 
<p><strong>步骤 5：重新启动MySQL服务</strong><br> 最后，重新启动MySQL服务：</p> 
<pre><code>sudo systemctl start mysqld
</code></pre> 
<p>现在，您已经使用Percona XtraBackup成功地恢复了MySQL数据库。请确保检查数据库中的数据，以验证恢复过程是否成功。</p> 
<h2><a id="_207"></a>验证备份是否成功</h2> 
<p>要验证MySQL数据库的备份是否成功，可以采取以下措施：</p> 
<ol><li> <p><strong>检查日志文件</strong>：检查在<code>/var/log/full_backup.log</code> 和 <code>/var/log/incremental_backup.log</code>中的日志文件。查看日志中是否有错误信息，确保备份过程已成功完成。通常，成功的备份会在日志末尾显示“completed OK!”。</p> </li><li> <p><strong>查看备份文件</strong>：在<code>/data/backups/full</code> 和 <code>/data/backups/incremental</code> 目录下检查备份文件。检查这些目录下是否有最近的备份，以及是否有期望的备份文件。</p> </li><li> <p><strong>检查备份文件大小</strong>：使用<code>du -sh /data/backups/full</code>和<code>du -sh /data/backups/incremental</code>命令查看全量和增量备份的总大小。确保备份大小与预期相符，并与原始数据库数据的大小相近。</p> </li><li> <p><strong>恢复测试</strong>：在一个测试环境中尝试恢复备份。这将帮助您检查备份的完整性，并确保在需要时能够成功恢复数据库。</p> </li></ol> 
<p>通过以上措施，可以有信心地确认MySQL数据库备份是否成功。定期进行这些检查以确保备份始终有效且可用。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/17d98f742d3937ea9dbde996e98ba4be/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">ubuntu连接airpods 转载</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a91ee0c3d89d693daf11e283fc26f4f7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">一文掌握IPD体系的核心精华及MM、RM和小IPD流程如何运作</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>