<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>RocketMQ 入门全面教程 超详细 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="RocketMQ 入门全面教程 超详细" />
<meta property="og:description" content="文章目录 一 MQ的安装1.1 官方地址下载1.2 环境需要1.3 注意事项1.3.1 需要关闭虚拟机linux防火墙1.3.2 主机防火墙 1.4 配置项1.4.1 broker 配置1.4.2 nameServer 配置 1.5 启动 NameServer1.5.1 NameServer 日志 1.6 启动 Broker1.6.1 Broker 日志 1.7 安装可视化 rocketmq-console1.7.1 下载 rocketmq-console1.7.2 编辑 rocketmq-console 配置文件1.7.3 启动 rocketmq-console1.7.4 rocketmq-console 日志1.7.3 访问可视化 二 基础入门2.1 MQ的定义2.2 为什么要用消息中间件2.2.1 应用解耦2.2.2 流量削峰2.2.3 数据分发 2.3 RocketMQ 产品发展2.3.1 RocketMQ 版本发展2.3.2 阿里内部项目的使用2.3.3 展望未来 三 RocketMQ 的物理架构3.1 核心概念3.1.1 NameServer3.1.2 生产者(Producer)3.1.3 消费者(Consumer)3.1.4 消息(Message)3.1.5 主机(Broker) 3.2 物理架构中的整体运转 四 RocketMQ 的概念模型4.1 核心概念4.1.1 分组(Group)4.1.2 主题(Topic)4.1.3 标签(Tag)4.1.4 消息队列(Message Queue)4." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/bf2c5ffb8332aab2f690047ad5eda8a7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-07-04T00:31:06+08:00" />
<meta property="article:modified_time" content="2021-07-04T00:31:06+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">RocketMQ 入门全面教程 超详细</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#_MQ_2" rel="nofollow">一 MQ的安装</a></li><li><ul><li><a href="#11__4" rel="nofollow">1.1 官方地址下载</a></li><li><a href="#12__20" rel="nofollow">1.2 环境需要</a></li><li><a href="#13__27" rel="nofollow">1.3 注意事项</a></li><li><ul><li><a href="#131_linux_32" rel="nofollow">1.3.1 需要关闭虚拟机linux防火墙</a></li><li><a href="#132__40" rel="nofollow">1.3.2 主机防火墙</a></li></ul> 
    </li><li><a href="#14__46" rel="nofollow">1.4 配置项</a></li><li><ul><li><a href="#141_broker__54" rel="nofollow">1.4.1 broker 配置</a></li><li><a href="#142_nameServer__64" rel="nofollow">1.4.2 nameServer 配置</a></li></ul> 
    </li><li><a href="#15__NameServer_76" rel="nofollow">1.5 启动 NameServer</a></li><li><ul><li><a href="#151_NameServer__89" rel="nofollow">1.5.1 NameServer 日志</a></li></ul> 
    </li><li><a href="#16__Broker_136" rel="nofollow">1.6 启动 Broker</a></li><li><ul><li><a href="#161_Broker__175" rel="nofollow">1.6.1 Broker 日志</a></li></ul> 
    </li><li><a href="#17__rocketmqconsole_225" rel="nofollow">1.7 安装可视化 rocketmq-console</a></li><li><ul><li><a href="#171__rocketmqconsole_227" rel="nofollow">1.7.1 下载 rocketmq-console</a></li><li><a href="#172__rocketmqconsole__239" rel="nofollow">1.7.2 编辑 rocketmq-console 配置文件</a></li><li><a href="#173__rocketmqconsole_290" rel="nofollow">1.7.3 启动 rocketmq-console</a></li><li><a href="#174_rocketmqconsole__297" rel="nofollow">1.7.4 rocketmq-console 日志</a></li><li><a href="#173__326" rel="nofollow">1.7.3 访问可视化</a></li></ul> 
   </li></ul> 
   </li><li><a href="#__334" rel="nofollow">二 基础入门</a></li><li><ul><li><a href="#21_MQ_337" rel="nofollow">2.1 MQ的定义</a></li><li><a href="#22__350" rel="nofollow">2.2 为什么要用消息中间件</a></li><li><ul><li><a href="#221__352" rel="nofollow">2.2.1 应用解耦</a></li><li><a href="#222__364" rel="nofollow">2.2.2 流量削峰</a></li><li><a href="#223__374" rel="nofollow">2.2.3 数据分发</a></li></ul> 
    </li><li><a href="#23_RocketMQ__390" rel="nofollow">2.3 RocketMQ 产品发展</a></li><li><ul><li><a href="#231_RocketMQ__392" rel="nofollow">2.3.1 RocketMQ 版本发展</a></li><li><a href="#232__402" rel="nofollow">2.3.2 阿里内部项目的使用</a></li><li><a href="#233__421" rel="nofollow">2.3.3 展望未来</a></li></ul> 
   </li></ul> 
   </li><li><a href="#_RocketMQ__439" rel="nofollow">三 RocketMQ 的物理架构</a></li><li><ul><li><a href="#31__446" rel="nofollow">3.1 核心概念</a></li><li><ul><li><a href="#311_NameServer_451" rel="nofollow">3.1.1 NameServer</a></li><li><a href="#312_Producer_462" rel="nofollow">3.1.2 生产者(Producer)</a></li><li><a href="#313__Consumer_466" rel="nofollow">3.1.3 消费者(Consumer)</a></li><li><a href="#314_Message_470" rel="nofollow">3.1.4 消息(Message)</a></li><li><a href="#315_Broker_474" rel="nofollow">3.1.5 主机(Broker)</a></li></ul> 
    </li><li><a href="#32__478" rel="nofollow">3.2 物理架构中的整体运转</a></li></ul> 
   </li><li><a href="#_RocketMQ__489" rel="nofollow">四 RocketMQ 的概念模型</a></li><li><ul><li><a href="#41__491" rel="nofollow">4.1 核心概念</a></li><li><ul><li><a href="#411_Group_493" rel="nofollow">4.1.1 分组(Group)</a></li><li><a href="#412_Topic_505" rel="nofollow">4.1.2 主题(Topic)</a></li><li><a href="#413_Tag_511" rel="nofollow">4.1.3 标签(Tag)</a></li><li><a href="#414_Message_Queue_515" rel="nofollow">4.1.4 消息队列(Message Queue)</a></li><li><a href="#415_Offset_524" rel="nofollow">4.1.5 偏移量(Offset)</a></li></ul> 
   </li></ul> 
   </li><li><a href="#__530" rel="nofollow">五 玩转各种消息</a></li><li><ul><li><a href="#51__532" rel="nofollow">5.1 普通消息</a></li><li><ul><li><a href="#511__562" rel="nofollow">5.1.1 消息发送</a></li><li><ul><li><a href="#5111__564" rel="nofollow">5.1.1.1 发送同步消息</a></li><li><a href="#5112__623" rel="nofollow">5.1.1.2 发送异步消息</a></li><li><a href="#5113__682" rel="nofollow">5.1.1.3 单向发送</a></li><li><a href="#5114__721" rel="nofollow">5.1.1.4 消息发送的权衡</a></li></ul> 
     </li><li><a href="#512__730" rel="nofollow">5.1.2 消息消费</a></li><li><ul><li><a href="#5121__732" rel="nofollow">5.1.2.1 集群消费</a></li><li><a href="#5122__791" rel="nofollow">5.1.2.2 广播消费</a></li><li><a href="#5123__837" rel="nofollow">5.1.2.3 消息消费时的权衡</a></li></ul> 
    </li></ul> 
    </li><li><a href="#52__861" rel="nofollow">5.2 顺序消息</a></li><li><ul><li><a href="#521__880" rel="nofollow">5.2.1 顺序消息生产</a></li><li><a href="#522__1038" rel="nofollow">5.2.2 顺序消息消费</a></li></ul> 
    </li><li><a href="#53__1086" rel="nofollow">5.3 消息发送时的重要方法/属性（工作参考使用）</a></li><li><ul><li><a href="#531__1090" rel="nofollow">5.3.1 属性</a></li><li><a href="#532__1116" rel="nofollow">5.3.2 方法</a></li><li><ul><li><a href="#5321__1132" rel="nofollow">5.3.2.1 单向发送</a></li><li><a href="#5333__1154" rel="nofollow">5.3.3.3 同步发送</a></li><li><a href="#5332__1172" rel="nofollow">5.3.3.2 异步发送</a></li></ul> 
    </li></ul> 
    </li><li><a href="#54__1237" rel="nofollow">5.4 消息消费时的重要方法/属性（工作参考使用）</a></li><li><ul><li><a href="#541__1241" rel="nofollow">5.4.1 属性</a></li><li><a href="#542__1268" rel="nofollow">5.4.2 方法</a></li><li><a href="#543_ACK_1330" rel="nofollow">5.4.3 消费确认(ACK)</a></li></ul> 
    </li><li><a href="#55__1342" rel="nofollow">5.5 延时消息</a></li><li><ul><li><a href="#551__1344" rel="nofollow">5.5.1 概念介绍</a></li><li><a href="#552__1351" rel="nofollow">5.5.2 适用场景</a></li><li><a href="#553__1356" rel="nofollow">5.5.3 使用方式</a></li></ul> 
    </li><li><a href="#56__1440" rel="nofollow">5.6 批量消息</a></li><li><ul><li><a href="#561__1513" rel="nofollow">5.6.1 批量切分</a></li></ul> 
    </li><li><a href="#57__1609" rel="nofollow">5.7 过滤消息</a></li><li><ul><li><a href="#571_Tag__1613" rel="nofollow">5.7.1 Tag 过滤</a></li><li><a href="#572_Sql__1732" rel="nofollow">5.7.2 Sql 过滤</a></li><li><ul><li><a href="#5721_SQL__1752" rel="nofollow">5.7.2.1 SQL 基本语法</a></li></ul> 
    </li></ul> 
    </li><li><a href="#58__1852" rel="nofollow">5.8 事务消息</a></li><li><ul><li><a href="#581__1858" rel="nofollow">5.8.1 正常事务流程</a></li><li><a href="#582__1868" rel="nofollow">5.8.2 事务补偿流程</a></li><li><a href="#583__1878" rel="nofollow">5.8.3 事务消息状态</a></li><li><a href="#584__1886" rel="nofollow">5.8.4 创建事务性生产者</a></li><li><a href="#585__1946" rel="nofollow">5.8.5 实现事务的监听接口</a></li><li><a href="#586__2000" rel="nofollow">5.8.6 消息消费者</a></li><li><a href="#587__2042" rel="nofollow">5.8.7 使用场景</a></li><li><a href="#588__2049" rel="nofollow">5.8.8 使用限制</a></li></ul> 
   </li></ul> 
   </li><li><a href="#_MQ_2064" rel="nofollow">一 MQ的安装</a></li><li><ul><li><a href="#11__2066" rel="nofollow">1.1 官方地址下载</a></li><li><a href="#12__2074" rel="nofollow">1.2 环境需要</a></li><li><a href="#13__2081" rel="nofollow">1.3 注意事项</a></li><li><ul><li><a href="#131_linux_2086" rel="nofollow">1.3.1 需要关闭虚拟机linux防火墙</a></li><li><a href="#132__2094" rel="nofollow">1.3.2 主机防火墙</a></li></ul> 
    </li><li><a href="#14__2099" rel="nofollow">1.4 配置项</a></li><li><ul><li><a href="#141_broker__2107" rel="nofollow">1.4.1 broker 配置</a></li><li><a href="#142_nameServer__2117" rel="nofollow">1.4.2 nameServer 配置</a></li></ul> 
    </li><li><a href="#15__NameServer_2129" rel="nofollow">1.5 启动 NameServer</a></li><li><ul><li><a href="#151_NameServer__2142" rel="nofollow">1.5.1 NameServer 日志</a></li></ul> 
    </li><li><a href="#16__Broker_2189" rel="nofollow">1.6 启动 Broker</a></li><li><ul><li><a href="#161_Broker__2228" rel="nofollow">1.6.1 Broker 日志</a></li></ul> 
    </li><li><a href="#17__rocketmqconsole_2278" rel="nofollow">1.7 安装可视化 rocketmq-console</a></li><li><ul><li><a href="#171__rocketmqconsole_2280" rel="nofollow">1.7.1 下载 rocketmq-console</a></li><li><a href="#172__rocketmqconsole__2291" rel="nofollow">1.7.2 编辑 rocketmq-console 配置文件</a></li><li><a href="#173__rocketmqconsole_2342" rel="nofollow">1.7.3 启动 rocketmq-console</a></li><li><a href="#174_rocketmqconsole__2349" rel="nofollow">1.7.4 rocketmq-console 日志</a></li><li><a href="#173__2378" rel="nofollow">1.7.3 访问可视化</a></li></ul> 
   </li></ul> 
   </li><li><a href="#__2385" rel="nofollow">二 基础入门</a></li><li><ul><li><a href="#21_MQ_2388" rel="nofollow">2.1 MQ的定义</a></li><li><a href="#22__2400" rel="nofollow">2.2 为什么要用消息中间件</a></li><li><ul><li><a href="#221__2402" rel="nofollow">2.2.1 应用解耦</a></li><li><a href="#222__2412" rel="nofollow">2.2.2 流量削峰</a></li><li><a href="#223__2421" rel="nofollow">2.2.3 数据分发</a></li></ul> 
    </li><li><a href="#23_RocketMQ__2436" rel="nofollow">2.3 RocketMQ 产品发展</a></li><li><ul><li><a href="#231_RocketMQ__2438" rel="nofollow">2.3.1 RocketMQ 版本发展</a></li><li><a href="#232__2448" rel="nofollow">2.3.2 阿里内部项目的使用</a></li><li><a href="#233__2467" rel="nofollow">2.3.3 展望未来</a></li></ul> 
   </li></ul> 
   </li><li><a href="#_RocketMQ__2484" rel="nofollow">三 RocketMQ 的物理架构</a></li><li><ul><li><a href="#31__2491" rel="nofollow">3.1 核心概念</a></li><li><ul><li><a href="#311_NameServer_2495" rel="nofollow">3.1.1 NameServer</a></li><li><a href="#312_Producer_2506" rel="nofollow">3.1.2 生产者(Producer)</a></li><li><a href="#313__Consumer_2510" rel="nofollow">3.1.3 消费者(Consumer)</a></li><li><a href="#314_Message_2514" rel="nofollow">3.1.4 消息(Message)</a></li><li><a href="#315_Broker_2518" rel="nofollow">3.1.5 主机(Broker)</a></li></ul> 
    </li><li><a href="#32__2522" rel="nofollow">3.2 物理架构中的整体运转</a></li></ul> 
   </li><li><a href="#_RocketMQ__2533" rel="nofollow">四 RocketMQ 的概念模型</a></li><li><ul><li><a href="#41__2535" rel="nofollow">4.1 核心概念</a></li><li><ul><li><a href="#411_Group_2537" rel="nofollow">4.1.1 分组(Group)</a></li><li><a href="#412_Topic_2549" rel="nofollow">4.1.2 主题(Topic)</a></li><li><a href="#413_Tag_2555" rel="nofollow">4.1.3 标签(Tag)</a></li><li><a href="#414_Message_Queue_2559" rel="nofollow">4.1.4 消息队列(Message Queue)</a></li><li><a href="#415_Offset_2568" rel="nofollow">4.1.5 偏移量(Offset)</a></li></ul> 
   </li></ul> 
   </li><li><a href="#__2574" rel="nofollow">五 玩转各种消息</a></li><li><ul><li><a href="#51__2576" rel="nofollow">5.1 普通消息</a></li><li><ul><li><a href="#511__2606" rel="nofollow">5.1.1 消息发送</a></li><li><ul><li><a href="#5111__2608" rel="nofollow">5.1.1.1 发送同步消息</a></li><li><a href="#5112__2663" rel="nofollow">5.1.1.2 发送异步消息</a></li><li><a href="#5113__2720" rel="nofollow">5.1.1.3 单向发送</a></li><li><a href="#5114__2758" rel="nofollow">5.1.1.4 消息发送的权衡</a></li></ul> 
     </li><li><a href="#512__2767" rel="nofollow">5.1.2 消息消费</a></li><li><ul><li><a href="#5121__2769" rel="nofollow">5.1.2.1 集群消费</a></li><li><a href="#5122__2827" rel="nofollow">5.1.2.2 广播消费</a></li><li><a href="#5123__2872" rel="nofollow">5.1.2.3 消息消费时的权衡</a></li></ul> 
    </li></ul> 
    </li><li><a href="#52__2896" rel="nofollow">5.2 顺序消息</a></li><li><ul><li><a href="#521__2913" rel="nofollow">5.2.1 顺序消息生产</a></li><li><a href="#522__3071" rel="nofollow">5.2.2 顺序消息消费</a></li></ul> 
    </li><li><a href="#53__3118" rel="nofollow">5.3 消息发送时的重要方法/属性（工作参考使用）</a></li><li><ul><li><a href="#531__3122" rel="nofollow">5.3.1 属性</a></li><li><a href="#532__3148" rel="nofollow">5.3.2 方法</a></li><li><ul><li><a href="#5321__3164" rel="nofollow">5.3.2.1 单向发送</a></li><li><a href="#5333__3186" rel="nofollow">5.3.3.3 同步发送</a></li><li><a href="#5332__3204" rel="nofollow">5.3.3.2 异步发送</a></li></ul> 
    </li></ul> 
    </li><li><a href="#54__3269" rel="nofollow">5.4 消息消费时的重要方法/属性（工作参考使用）</a></li><li><ul><li><a href="#541__3273" rel="nofollow">5.4.1 属性</a></li><li><a href="#542__3300" rel="nofollow">5.4.2 方法</a></li><li><a href="#543_ACK_3362" rel="nofollow">5.4.3 消费确认(ACK)</a></li></ul> 
    </li><li><a href="#55__3374" rel="nofollow">5.5 延时消息</a></li><li><ul><li><a href="#551__3376" rel="nofollow">5.5.1 概念介绍</a></li><li><a href="#552__3382" rel="nofollow">5.5.2 适用场景</a></li><li><a href="#553__3387" rel="nofollow">5.5.3 使用方式</a></li></ul> 
    </li><li><a href="#56__3470" rel="nofollow">5.6 批量消息</a></li><li><ul><li><a href="#561__3543" rel="nofollow">5.6.1 批量切分</a></li></ul> 
    </li><li><a href="#57__3639" rel="nofollow">5.7 过滤消息</a></li><li><ul><li><a href="#571_Tag__3643" rel="nofollow">5.7.1 Tag 过滤</a></li><li><a href="#572_Sql__3760" rel="nofollow">5.7.2 Sql 过滤</a></li><li><ul><li><a href="#5721_SQL__3780" rel="nofollow">5.7.2.1 SQL 基本语法</a></li></ul> 
    </li></ul> 
    </li><li><a href="#58__3877" rel="nofollow">5.8 事务消息</a></li><li><ul><li><a href="#581__3883" rel="nofollow">5.8.1 正常事务流程</a></li><li><a href="#582__3893" rel="nofollow">5.8.2 事务补偿流程</a></li><li><a href="#583__3903" rel="nofollow">5.8.3 事务消息状态</a></li><li><a href="#584__3911" rel="nofollow">5.8.4 创建事务性生产者</a></li><li><a href="#585__3971" rel="nofollow">5.8.5 实现事务的监听接口</a></li><li><a href="#586__4025" rel="nofollow">5.8.6 消息消费者</a></li><li><a href="#587__4067" rel="nofollow">5.8.7 使用场景</a></li><li><a href="#588__4074" rel="nofollow">5.8.8 使用限制</a></li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="_MQ_2"></a>一 MQ的安装</h3> 
<h4><a id="11__4"></a>1.1 官方地址下载</h4> 
<p>作者微信:<br> Xri2117<br> 欢迎大家加入JAVA交流群，添加作者微信拉群<br> 写博客不易，请尊重原创</p> 
<p><img src="https://images2.imgbox.com/1f/dc/bEakBir5_o.png" alt="在这里插入图片描述"></p> 
<p>使用最新的4.8的版本。</p> 
<p>http://rocketmq.apache.org/dowloading/releases/</p> 
<p><img src="https://images2.imgbox.com/c6/a7/iuPCwZ8z_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-BBviKevV-1625329014507)(845B800DD1ED4CBD85B5F4A99AFB47FA)]"></p> 
<h4><a id="12__20"></a>1.2 环境需要</h4> 
<ul><li>Linux 64位系统</li><li>Jdk 1.8</li><li>建议安装目录在/opt/建立rocketMq文件夹</li><li><mark>注：源码安装需要Maven。运行版本不需要</mark></li></ul> 
<h4><a id="13__27"></a>1.3 注意事项</h4> 
<p>假设服务的外网IP地址：192.168.56.101 虚拟机的话就是本机IP 主机和虚拟机之间需要ping通</p> 
<h5><a id="131_linux_32"></a>1.3.1 需要关闭虚拟机linux防火墙</h5> 
<p><mark>互相ping不同 未关闭防火墙 可能导致连接失败,无法生产消息</mark></p> 
<pre><code class="prism language-shell">systemctl stop firewalld
</code></pre> 
<h5><a id="132__40"></a>1.3.2 主机防火墙</h5> 
<p><img src="https://images2.imgbox.com/51/39/sPr8DiKQ_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-1LDzehYb-1625329014509)(EAD5477012344AFEA89AFC7C2D22E2E2)]"></p> 
<h4><a id="14__46"></a>1.4 配置项</h4> 
<p>RocketMQ默认的虚拟机内存较大，启动Broker如果因为内存不足失败，需要编辑如下两个配置文件，修改JVM内存大小。</p> 
<p><mark>但是这个也仅仅是在测试环境中，RocketMQ在生产上最低要求至少8G内存（官方推荐）才能确保RocketMQ的效果</mark></p> 
<p>编辑 runbroker.sh 和 runserver.sh修改默认JVM大小（windows上对应cmd文件）</p> 
<h5><a id="141_broker__54"></a>1.4.1 broker 配置</h5> 
<p>/bin目录下</p> 
<pre><code class="prism language-shell"><span class="token function">vim</span> runbroker.sh

<span class="token assign-left variable">JAVA_OPT</span><span class="token operator">=</span><span class="token string">"<span class="token variable">${JAVA_OPT}</span> -server -Xms1024m -Xmx1024m -Xmn512m -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=320m"</span>
</code></pre> 
<h5><a id="142_nameServer__64"></a>1.4.2 nameServer 配置</h5> 
<p>/bin目录下</p> 
<pre><code class="prism language-shell"><span class="token function">vim</span> runserver.sh

<span class="token assign-left variable">JAVA_OPT</span><span class="token operator">=</span><span class="token string">"<span class="token variable">${JAVA_OPT}</span> -server -Xms4g -Xmx4g -Xmn2g -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=320m"</span>
choose_gc_options

</code></pre> 
<h4><a id="15__NameServer_76"></a>1.5 启动 NameServer</h4> 
<pre><code class="prism language-shell"><span class="token comment"># 进入mq bin目录</span>
<span class="token builtin class-name">cd</span> /opt/bin

<span class="token comment"># 启动nameserver</span>
<span class="token function">nohup</span> <span class="token function">sh</span> mqnamesrv <span class="token operator">&amp;</span>

<span class="token comment"># 查看日志 会在~目录下有logs 日志路径可修改</span>
<span class="token function">tail</span> -200f ~/logs/rocketmqlogs/namesrv.log
</code></pre> 
<h5><a id="151_NameServer__89"></a>1.5.1 NameServer 日志</h5> 
<pre><code class="prism language-text">2021-07-03 03:16:42 INFO main - rocketmqHome=/opt/rocketmq
2021-07-03 03:16:42 INFO main - kvConfigPath=/root/namesrv/kvConfig.json
2021-07-03 03:16:42 INFO main - configStorePath=/root/namesrv/namesrv.properties
2021-07-03 03:16:42 INFO main - productEnvName=center
2021-07-03 03:16:42 INFO main - clusterTest=false
2021-07-03 03:16:42 INFO main - orderMessageEnable=false
2021-07-03 03:16:42 INFO main - listenPort=9876
2021-07-03 03:16:42 INFO main - serverWorkerThreads=8
2021-07-03 03:16:42 INFO main - serverCallbackExecutorThreads=0
2021-07-03 03:16:42 INFO main - serverSelectorThreads=3
2021-07-03 03:16:42 INFO main - serverOnewaySemaphoreValue=256
2021-07-03 03:16:42 INFO main - serverAsyncSemaphoreValue=64
2021-07-03 03:16:42 INFO main - serverChannelMaxIdleTimeSeconds=120
2021-07-03 03:16:42 INFO main - serverSocketSndBufSize=65535
2021-07-03 03:16:42 INFO main - serverSocketRcvBufSize=65535
2021-07-03 03:16:42 INFO main - serverPooledByteBufAllocatorEnable=true
2021-07-03 03:16:42 INFO main - useEpollNativeSelector=false
2021-07-03 03:16:42 INFO main - Server is running in TLS permissive mode
2021-07-03 03:16:42 INFO main - Tls config file doesn't exist, skip it
2021-07-03 03:16:42 INFO main - Log the final used tls related configuration
2021-07-03 03:16:42 INFO main - tls.test.mode.enable = true
2021-07-03 03:16:42 INFO main - tls.server.need.client.auth = none
2021-07-03 03:16:42 INFO main - tls.server.keyPath = null
2021-07-03 03:16:42 INFO main - tls.server.keyPassword = null
2021-07-03 03:16:42 INFO main - tls.server.certPath = null
2021-07-03 03:16:42 INFO main - tls.server.authClient = false
2021-07-03 03:16:42 INFO main - tls.server.trustCertPath = null
2021-07-03 03:16:42 INFO main - tls.client.keyPath = null
2021-07-03 03:16:42 INFO main - tls.client.keyPassword = null
2021-07-03 03:16:42 INFO main - tls.client.certPath = null
2021-07-03 03:16:42 INFO main - tls.client.authServer = false
2021-07-03 03:16:42 INFO main - tls.client.trustCertPath = null
2021-07-03 03:16:42 INFO main - Using OpenSSL provider
2021-07-03 03:16:43 INFO main - SSLContext created for server
2021-07-03 03:16:43 INFO main - Try to start service thread:FileWatchService started:false lastThread:null
2021-07-03 03:16:43 INFO NettyEventExecutor - NettyEventExecutor service started

# 容器已经启动
2021-07-03 03:16:43 INFO main - The Name Server boot success. serializeType=JSON
2021-07-03 03:16:43 INFO FileWatchService - FileWatchService service started
2021-07-03 03:17:43 INFO NSScheduledThread1 - --------------------------------------------------------
2021-07-03 03:17:43 INFO NSScheduledThread1 - configTable SIZE: 0
</code></pre> 
<h4><a id="16__Broker_136"></a>1.6 启动 Broker</h4> 
<p>修改配置文件增加外网地址(你启动加载哪个配置文件就修改哪个，这里修改broker.conf)</p> 
<pre><code class="prism language-conf">brokerClusterName = DefaultCluster
brokerName = broker-a
brokerId = 0
deleteWhen = 04
fileReservedTime = 48
brokerRole = ASYNC_MASTER
flushDiskType = ASYNC_FLUSH
# 公网ip 虚拟机的话就是虚拟机机ip 本机可以ping通 
brokerIP1=192.168.3.200
# nameserver地址
namesrvAddr=192.168.3.200:9876
</code></pre> 
<pre><code class="prism language-shell"><span class="token comment"># 进入mq bin目录</span>
<span class="token builtin class-name">cd</span> /opt/bin

<span class="token comment"># 启动broker -n 指定namever地址 conf文件配置后可以不指定，通过配置文件配置</span>
<span class="token comment"># autoCreateTopicEnable=true 这样启动的服务器可以自动创建主题（客户端）,不过生产一般不推荐。</span>
<span class="token function">nohup</span> <span class="token function">sh</span> mqbroker -c <span class="token punctuation">..</span>/conf/broker.conf -n <span class="token number">192.168</span>.3.200:9876 <span class="token assign-left variable">autoCreateTopicEnable</span><span class="token operator">=</span>true <span class="token operator">&amp;</span>

<span class="token comment"># 查看日志 会在~目录下有logs 日志路径可修改</span>
<span class="token function">tail</span> -200f ~/logs/rocketmqlogs/broker.log
</code></pre> 
<ul><li>可能发生的问题</li></ul> 
<pre><code class="prism language-shell"><span class="token comment"># /root/store/ 没有commitlog文件夹 创建即可</span>
<span class="token number">2021</span>-07-03 03:27:38 ERROR DiskCheckScheduledThread1 - Error when measuring disk space usage, <span class="token function">file</span> doesn<span class="token string">'t exist on this path: /root/store/commitlog

# /root/store/ 没有consumequeue文件夹 创建即可
Error when measuring disk space usage, file doesn'</span>t exist on this path: /root/store/consumequeue
</code></pre> 
<h5><a id="161_Broker__175"></a>1.6.1 Broker 日志</h5> 
<pre><code class="prism language-shell"> <span class="token punctuation">[</span>topicName<span class="token operator">=</span>SCHEDULE_TOPIC_XXXX, <span class="token assign-left variable">readQueueNums</span><span class="token operator">=</span><span class="token number">18</span>, <span class="token assign-left variable">writeQueueNums</span><span class="token operator">=</span><span class="token number">18</span>, <span class="token assign-left variable">perm</span><span class="token operator">=</span>RW-, <span class="token assign-left variable">topicFilterType</span><span class="token operator">=</span>SINGLE_TAG, <span class="token assign-left variable">topicSysFlag</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">order</span><span class="token operator">=</span>false<span class="token punctuation">]</span>
<span class="token number">2021</span>-07-03 03:29:51 INFO main - load exist <span class="token builtin class-name">local</span> topic, TopicConfig <span class="token punctuation">[</span>topicName<span class="token operator">=</span>RMQ_SYS_TRANS_HALF_TOPIC, <span class="token assign-left variable">readQueueNums</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">writeQueueNums</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">perm</span><span class="token operator">=</span>RW-, <span class="token assign-left variable">topicFilterType</span><span class="token operator">=</span>SINGLE_TAG, <span class="token assign-left variable">topicSysFlag</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">order</span><span class="token operator">=</span>false<span class="token punctuation">]</span>
<span class="token number">2021</span>-07-03 03:29:51 INFO main - load exist <span class="token builtin class-name">local</span> topic, TopicConfig <span class="token punctuation">[</span>topicName<span class="token operator">=</span>DefaultCluster_REPLY_TOPIC, <span class="token assign-left variable">readQueueNums</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">writeQueueNums</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">perm</span><span class="token operator">=</span>RW-, <span class="token assign-left variable">topicFilterType</span><span class="token operator">=</span>SINGLE_TAG, <span class="token assign-left variable">topicSysFlag</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">order</span><span class="token operator">=</span>false<span class="token punctuation">]</span>
<span class="token number">2021</span>-07-03 03:29:51 INFO main - load exist <span class="token builtin class-name">local</span> topic, TopicConfig <span class="token punctuation">[</span>topicName<span class="token operator">=</span>BenchmarkTest, <span class="token assign-left variable">readQueueNums</span><span class="token operator">=</span><span class="token number">1024</span>, <span class="token assign-left variable">writeQueueNums</span><span class="token operator">=</span><span class="token number">1024</span>, <span class="token assign-left variable">perm</span><span class="token operator">=</span>RW-, <span class="token assign-left variable">topicFilterType</span><span class="token operator">=</span>SINGLE_TAG, <span class="token assign-left variable">topicSysFlag</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">order</span><span class="token operator">=</span>false<span class="token punctuation">]</span>
<span class="token number">2021</span>-07-03 03:29:51 INFO main - load exist <span class="token builtin class-name">local</span> topic, TopicConfig <span class="token punctuation">[</span>topicName<span class="token operator">=</span>OFFSET_MOVED_EVENT, <span class="token assign-left variable">readQueueNums</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">writeQueueNums</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">perm</span><span class="token operator">=</span>RW-, <span class="token assign-left variable">topicFilterType</span><span class="token operator">=</span>SINGLE_TAG, <span class="token assign-left variable">topicSysFlag</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">order</span><span class="token operator">=</span>false<span class="token punctuation">]</span>
<span class="token number">2021</span>-07-03 03:29:51 INFO main - load exist <span class="token builtin class-name">local</span> topic, TopicConfig <span class="token punctuation">[</span>topicName<span class="token operator">=</span>broker-a, <span class="token assign-left variable">readQueueNums</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">writeQueueNums</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">perm</span><span class="token operator">=</span>RWX, <span class="token assign-left variable">topicFilterType</span><span class="token operator">=</span>SINGLE_TAG, <span class="token assign-left variable">topicSysFlag</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">order</span><span class="token operator">=</span>false<span class="token punctuation">]</span>
<span class="token number">2021</span>-07-03 03:29:51 INFO main - load exist <span class="token builtin class-name">local</span> topic, TopicConfig <span class="token punctuation">[</span>topicName<span class="token operator">=</span>TBW102, <span class="token assign-left variable">readQueueNums</span><span class="token operator">=</span><span class="token number">8</span>, <span class="token assign-left variable">writeQueueNums</span><span class="token operator">=</span><span class="token number">8</span>, <span class="token assign-left variable">perm</span><span class="token operator">=</span>RWX, <span class="token assign-left variable">topicFilterType</span><span class="token operator">=</span>SINGLE_TAG, <span class="token assign-left variable">topicSysFlag</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">order</span><span class="token operator">=</span>false<span class="token punctuation">]</span>
<span class="token number">2021</span>-07-03 03:29:51 INFO main - load exist <span class="token builtin class-name">local</span> topic, TopicConfig <span class="token punctuation">[</span>topicName<span class="token operator">=</span>SELF_TEST_TOPIC, <span class="token assign-left variable">readQueueNums</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">writeQueueNums</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">perm</span><span class="token operator">=</span>RW-, <span class="token assign-left variable">topicFilterType</span><span class="token operator">=</span>SINGLE_TAG, <span class="token assign-left variable">topicSysFlag</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">order</span><span class="token operator">=</span>false<span class="token punctuation">]</span>
<span class="token number">2021</span>-07-03 03:29:51 INFO main - load exist <span class="token builtin class-name">local</span> topic, TopicConfig <span class="token punctuation">[</span>topicName<span class="token operator">=</span>DefaultCluster, <span class="token assign-left variable">readQueueNums</span><span class="token operator">=</span><span class="token number">16</span>, <span class="token assign-left variable">writeQueueNums</span><span class="token operator">=</span><span class="token number">16</span>, <span class="token assign-left variable">perm</span><span class="token operator">=</span>RWX, <span class="token assign-left variable">topicFilterType</span><span class="token operator">=</span>SINGLE_TAG, <span class="token assign-left variable">topicSysFlag</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">order</span><span class="token operator">=</span>false<span class="token punctuation">]</span>
<span class="token number">2021</span>-07-03 03:29:51 INFO main - load /root/store/config/topics.json OK
<span class="token number">2021</span>-07-03 03:29:51 INFO main - load /root/store/config/consumerOffset.json OK
<span class="token number">2021</span>-07-03 03:29:51 INFO main - load /root/store/config/consumerFilter.json OK
<span class="token number">2021</span>-07-03 03:29:51 INFO main - Try to start <span class="token function">service</span> thread:AllocateMappedFileService started:false lastThread:null
<span class="token number">2021</span>-07-03 03:29:51 INFO main - load /root/store/config/delayOffset.json OK
<span class="token number">2021</span>-07-03 03:29:52 INFO main - Set user specified name server address: <span class="token number">192.168</span>.3.200:9876
<span class="token number">2021</span>-07-03 03:29:52 WARN main - Load default transaction message hook service: TransactionalMessageServiceImpl
<span class="token number">2021</span>-07-03 03:29:52 WARN main - Load default discard message hook service: DefaultTransactionalMessageCheckListener
<span class="token number">2021</span>-07-03 03:29:52 INFO main - The broker dose not <span class="token builtin class-name">enable</span> acl
<span class="token number">2021</span>-07-03 03:29:52 INFO main - Try to start <span class="token function">service</span> thread:ReputMessageService started:false lastThread:null
<span class="token number">2021</span>-07-03 03:29:52 INFO main - Try to start <span class="token function">service</span> thread:AcceptSocketService started:false lastThread:null
<span class="token number">2021</span>-07-03 03:29:52 INFO main - Try to start <span class="token function">service</span> thread:GroupTransferService started:false lastThread:null
<span class="token number">2021</span>-07-03 03:29:52 INFO main - Try to start <span class="token function">service</span> thread:HAClient started:false lastThread:null
<span class="token number">2021</span>-07-03 03:29:52 INFO main - Try to start <span class="token function">service</span> thread:FlushConsumeQueueService started:false lastThread:null
<span class="token number">2021</span>-07-03 03:29:52 INFO main - Try to start <span class="token function">service</span> thread:FlushRealTimeService started:false lastThread:null
<span class="token number">2021</span>-07-03 03:29:52 INFO main - Try to start <span class="token function">service</span> thread:StoreStatsService started:false lastThread:null
<span class="token number">2021</span>-07-03 03:29:52 INFO main - Try to start <span class="token function">service</span> thread:FileWatchService started:false lastThread:null
<span class="token number">2021</span>-07-03 03:29:52 INFO main - Try to start <span class="token function">service</span> thread:PullRequestHoldService started:false lastThread:null
<span class="token number">2021</span>-07-03 03:29:52 INFO FileWatchService - FileWatchService <span class="token function">service</span> started
<span class="token number">2021</span>-07-03 03:29:52 INFO PullRequestHoldService - PullRequestHoldService <span class="token function">service</span> started
<span class="token number">2021</span>-07-03 03:29:52 INFO main - Try to start <span class="token function">service</span> thread:TransactionalMessageCheckService started:false lastThread:null

<span class="token comment"># 注册成功</span>
<span class="token number">2021</span>-07-03 03:29:52 INFO brokerOutApi_thread_1 - register broker<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>to name server <span class="token number">192.168</span>.3.200:9876 OK

<span class="token comment"># 启动成功</span>
<span class="token number">2021</span>-07-03 03:29:52 INFO main - The broker<span class="token punctuation">[</span>broker-a, <span class="token number">192.168</span>.3.200:10911<span class="token punctuation">]</span> boot success. <span class="token assign-left variable">serializeType</span><span class="token operator">=</span>JSON and name server is <span class="token number">192.168</span>.3.200:9876
<span class="token number">2021</span>-07-03 03:30:02 INFO BrokerControllerScheduledThread1 - dispatch behind commit log <span class="token number">0</span> bytes
<span class="token number">2021</span>-07-03 03:30:02 INFO BrokerControllerScheduledThread1 - Slave fall behind master: <span class="token number">0</span> bytes

</code></pre> 
<pre><code class="prism language-text"># nameserver 日志会出现 新broker 注册
2021-07-03 03:29:52 INFO RemotingExecutorThread_4 - new broker registered, 192.168.3.200:10911 HAServer: 172.17.0.1:10912

</code></pre> 
<h4><a id="17__rocketmqconsole_225"></a>1.7 安装可视化 rocketmq-console</h4> 
<h5><a id="171__rocketmqconsole_227"></a>1.7.1 下载 rocketmq-console</h5> 
<p>运行前确保：已经有jdk1.8，Maven(打包需要安装Maven 3.2.x)</p> 
<p>下载：https://codeload.github.com/apache/rocketmq-externals/zip/master</p> 
<p><img src="https://images2.imgbox.com/17/98/AwWqFZBe_o.png" alt="在这里插入图片描述"></p> 
<p>这个包主要包含的是Message Connector，具体详情见 https://rocketmq-1.gitbook.io/rocketmq-connector/</p> 
<p>里面后端管理界面是：rocketmq-console</p> 
<h5><a id="172__rocketmqconsole__239"></a>1.7.2 编辑 rocketmq-console 配置文件</h5> 
<p>下载完成之后，进入‘\rocketmq-console\src\main\resources’文件夹，打开‘application.properties’进行配置。</p> 
<pre><code class="prism language-properties"># 服务器地址
server.address=192.168.3.200
# 控制台端口
server.port=8089

### SSL setting
#server.ssl.key-store=classpath:rmqcngkeystore.jks
#server.ssl.key-store-password=rocketmq
#server.ssl.keyStoreType=PKCS12
#server.ssl.keyAlias=rmqcngkey

#spring.application.index=true
spring.application.name=rocketmq-console
spring.http.encoding.charset=UTF-8
spring.http.encoding.enabled=true
spring.http.encoding.force=true
logging.level.root=INFO
logging.config=classpath:logback.xml
#if this value is empty,use env value rocketmq.config.namesrvAddr  NAMESRV_ADDR | now, you can set it in ops page.default localhost:9876

# nameserver地址 默认端口9876
rocketmq.config.namesrvAddr=192.168.3.200:9876
#if you use rocketmq version &lt; 3.5.8, rocketmq.config.isVIPChannel should be false.default true
rocketmq.config.isVIPChannel=
#rocketmq-console's data path:dashboard/monitor
rocketmq.config.dataPath=/tmp/rocketmq-console/data
#set it false if you don't want use dashboard.default true
rocketmq.config.enableDashBoardCollect=true
#set the message track trace topic if you don't want use the default one
rocketmq.config.msgTrackTopicName=
rocketmq.config.ticketKey=ticket

#Must create userInfo file: ${rocketmq.config.dataPath}/users.properties if the login is required
rocketmq.config.loginRequired=false

#set the accessKey and secretKey if you used acl
#rocketmq.config.accessKey=
#rocketmq.config.secretKey=
</code></pre> 
<p>进入\rocketmq-externals\rocketmq-console文件夹</p> 
<p>执行mvn clean package -Dmaven.test.skip=true 编译生成可执行jar包</p> 
<p>建议放入/opt/建立文件夹</p> 
<h5><a id="173__rocketmqconsole_290"></a>1.7.3 启动 rocketmq-console</h5> 
<pre><code class="prism language-shell"><span class="token comment"># 启动可视化 可指定内存大小</span>
<span class="token function">nohup</span> java -jar -Xms128m -Xmx256m rocketmq-console-ng-2.0.0.jar <span class="token operator">&amp;</span>
</code></pre> 
<h5><a id="174_rocketmqconsole__297"></a>1.7.4 rocketmq-console 日志</h5> 
<pre><code class="prism language-shell">  <span class="token builtin class-name">.</span>   ____          _            __ _ _
 /<span class="token punctuation">\</span><span class="token punctuation">\</span> / ___<span class="token string">'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '</span>_ <span class="token operator">|</span> <span class="token string">'_| | '</span>_ <span class="token punctuation">\</span>/ _` <span class="token operator">|</span> <span class="token punctuation">\</span> <span class="token punctuation">\</span> <span class="token punctuation">\</span> <span class="token punctuation">\</span>
 <span class="token punctuation">\</span><span class="token punctuation">\</span>/  ___<span class="token punctuation">)</span><span class="token operator">|</span> <span class="token operator">|</span>_<span class="token punctuation">)</span><span class="token operator">|</span> <span class="token operator">|</span> <span class="token operator">|</span> <span class="token operator">|</span> <span class="token operator">|</span> <span class="token operator">||</span> <span class="token punctuation">(</span>_<span class="token operator">|</span> <span class="token operator">|</span>  <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span>
  <span class="token string">'  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/
 :: Spring Boot ::        (v2.2.2.RELEASE)

[2021-07-03 03:41:10.868]  INFO Starting App v2.0.0 on localhost with PID 29113 (/opt/rocketmq-console/rocketmq-console-ng-2.0.0.jar started by root in /opt/rocketmq-console)
[2021-07-03 03:41:10.869]  INFO No active profile set, falling back to default profiles: default
[2021-07-03 03:41:13.198]  INFO setNameSrvAddrByProperty nameSrvAddr=192.168.3.200:9876
[2021-07-03 03:41:13.694]  INFO Tomcat initialized with port(s): 8089 (http)
[2021-07-03 03:41:13.708]  INFO Initializing ProtocolHandler ["http-nio-192.168.3.200-8089"]
[2021-07-03 03:41:13.709]  INFO Starting service [Tomcat]
[2021-07-03 03:41:13.709]  INFO Starting Servlet engine: [Apache Tomcat/9.0.29]
[2021-07-03 03:41:13.908]  INFO Initializing Spring embedded WebApplicationContext
[2021-07-03 03:41:13.909]  INFO Root WebApplicationContext: initialization completed in 2811 ms
[2021-07-03 03:41:15.166]  INFO Initializing ExecutorService '</span>applicationTaskExecutor<span class="token string">'
[2021-07-03 03:41:15.350]  INFO Adding welcome page: class path resource [static/index.html]
[2021-07-03 03:41:15.563]  INFO Initializing ExecutorService '</span>taskScheduler<span class="token string">'
[2021-07-03 03:41:15.584]  INFO Exposing 2 endpoint(s) beneath base path '</span>/actuator<span class="token string">'
[2021-07-03 03:41:15.656]  INFO Starting ProtocolHandler ["http-nio-192.168.3.200-8089"]
[2021-07-03 03:41:15.692]  INFO Tomcat started on port(s): 8089 (http) with context path '</span>'
<span class="token punctuation">[</span><span class="token number">2021</span>-07-03 03:41:15.697<span class="token punctuation">]</span>  INFO Started App <span class="token keyword">in</span> <span class="token number">5.735</span> seconds <span class="token punctuation">(</span>JVM running <span class="token keyword">for</span> <span class="token number">6.688</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="173__326"></a>1.7.3 访问可视化</h5> 
<p>浏览器输入 192.168.3.200:8089 查看</p> 
<p><img src="https://images2.imgbox.com/26/9e/NlqFKuEf_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-hyZ1z17i-1625329014512)(32DC3C51C2384D34AA41FCAA1AF08F19)]"></p> 
<h3><a id="__334"></a>二 基础入门</h3> 
<p>有需要其他介绍请参阅：<br> <a href="https://rocketmq.apache.org/docs/quick-start/" rel="nofollow">rocketMQ官方文档</a></p> 
<h4><a id="21_MQ_337"></a>2.1 MQ的定义</h4> 
<p>其实并没有标准定义。一般认为，消息中间件属于分布式系统中一个子系统，关注于数据的发送和接收，利用高效可靠的异步消息传递机制对分布<br> 式系统中的其余各个子系统进行集成。</p> 
<ol><li><strong>高效</strong>：对于消息的处理处理速度快。</li><li><strong>可靠</strong>：一般消息中间件都会有消息持久化机制和其他的机制确保消息不丢失。</li><li><strong>异步</strong>：指发送完一个请求，不需要等待返回，随时可以再发送下一个请求，既不需要等待</li><li><strong>总结</strong>，<mark>我们消息中间件不生产消息，只是消息的搬运工。</mark></li></ol> 
<p><img src="https://images2.imgbox.com/89/44/Mi4aaXS6_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-OIGyhOJi-1625329014513)(E2C045BFC5BF41E2B679BFD63D740350)]"></p> 
<h4><a id="22__350"></a>2.2 为什么要用消息中间件</h4> 
<h5><a id="221__352"></a>2.2.1 应用解耦</h5> 
<p>系统的耦合性越高，容错性就越低。以电商应用为例，用户创建订单后，如果耦合调用库存系统、物流系统、支付系统，任何一个子系统出了故障或者<br> 因为升级等原因暂时不可用，都会造成下单操作异常，影响用户使用体验</p> 
<p>使用消息中间件，系统的耦合性就会提高了。比如物流系统发生故障，需要几分钟才能来修复，在这段时间内，物流系统要处理的数据被缓存到消息队<br> 列中，用户的下单操作正常完成。当物流系统恢复后，继续处理存放在消息队列中的订单消息即可，终端系统感知不到物流系统发生过几分钟故障。</p> 
<p><img src="https://images2.imgbox.com/ab/cb/oyCJ1uAQ_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="222__364"></a>2.2.2 流量削峰</h5> 
<p>应用系统如果遇到系统请求流量的瞬间猛增，有可能会将系统压垮。有了消息队列可以将大量请求缓存起来，分散到很长一段时间处理，这样可以大大<br> 提到系统的稳定性和用户体验。</p> 
<p><strong>互联网公司的大促场景（双十一、店庆活动、秒杀活动）都会使用到 MQ</strong></p> 
<p><img src="https://images2.imgbox.com/a8/01/8eTwPvx7_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-luPz1Cc8-1625329014515)(D1D8FA759EC447E690620A81F51D47C5)]"></p> 
<h5><a id="223__374"></a>2.2.3 数据分发</h5> 
<p>通过消息队列可以让数据在多个系统更加之间进行流通。数据的产生方不需要关心谁来使用数据，只需要将数据发送到消息队列，数据使用方直接在消<br> 息队列中直接获取数据即可。</p> 
<p>接口调用的弊端，无论是新增系统，还是移除系统，代码改造工作量都很大。</p> 
<p>使用 MQ 做数据分发好处，无论是新增系统，还是移除系统，代码改造工作量较小。</p> 
<p>所以使用 MQ 做数据的分发，可以提高团队开发的效率</p> 
<p><img src="https://images2.imgbox.com/d9/c9/b9Kioicl_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="23_RocketMQ__390"></a>2.3 RocketMQ 产品发展</h4> 
<h5><a id="231_RocketMQ__392"></a>2.3.1 RocketMQ 版本发展</h5> 
<p>Metaq1.x 是 RocketMQ 前身的第一个版本，本质上把 Kafka 做了一次 java 版本的重写（Kafka 是 sacla）</p> 
<p>Meta2.x，主要是对存储部分进行了优化，因为 kafka 的数据存储，它的 paration 是一个全量的复制，在阿里、在淘宝的这种海量交易。Kafka 这种<br> 机制的横向拓展是非常不好的。2012 年阿里同时把 Meta2.0 从阿里内部开源出来，取名 RocketMQ，同时为了命名上的规范（版本上延续），所以这个就<br> 是 RocketMQ3.0</p> 
<p>现在 RocketMQ 主要维护的是 4.x 的版本，也是大家使用得最多的版本，2017 年从 Apache 顶级项目毕</p> 
<h5><a id="232__402"></a>2.3.2 阿里内部项目的使用</h5> 
<p>那么在阿里公司内部，原则上遵守开源共建原则。RocketMQ 项目只维护核心功能，且去除了所有其他运行时依赖，核心功能最简化。每个 BU<br> （ Business Unit 业务单元）的个性化需求都在 RocketMQ 项目之上进行深度定制。RocketMQ 向其他 BU 提供的仅仅是 Jar 包，例如要定制一个 Broker，<br> 那么只需要依赖 rocketmq-broker 这 jar 包即可，可通过 API 进行交互， 如果定制 client，则依赖 rocketmq-client 这个 jar 包，对其提供的 api 进行<br> 再封装</p> 
<p><strong>在 RocketMQ 项目基础上几个常用的项目如</strong>下</p> 
<ul><li>com.taobao.metaq v3.0 = RocketMQ + 淘宝个性化需求</li></ul> 
<p>为淘宝应用提供消息服务</p> 
<ul><li>com.alipay.zpullmsg v1.0 = RocketMQ + 支付宝个性化需求</li></ul> 
<p>为支付宝应用提供消息服务</p> 
<ul><li>com.alibaba.commonmq v1.0 = Notify + RocketMQ + B2B 个性化需求</li></ul> 
<p>为 B2B 应用提供消息服务</p> 
<h5><a id="233__421"></a>2.3.3 展望未来</h5> 
<p>从阿里负责 RocketMQ 的架构核心人员的信息来看，阿里内部一直全力拓展 RocketMQ</p> 
<p>2017 年 10 月份，OpenMessaging 项目由阿里巴巴发起，与雅虎、滴滴出行、Streamlio 公司共同参与创立, 项目意在创立厂商无关、平台无关的分布<br> 式消息及流处理领域的应用开发标准。同时 OpenMessaging 入驻 Linux 基金会</p> 
<p>OpenMessaging 项目已经开始在 Apache RocketMQ 中率先落地，并推广至整个阿里云平台.</p> 
<p>另外 RocketMQ5 的版本也在内部推进，主要的方向是 Cloud Native(云原生)</p> 
<p><strong>另外 Apache RocketMQ 的商业版本，Aliware MQ</strong> 在微服务、流计算、IoT、异步解耦、数据同步等场景有非常广泛的运用</p> 
<p><img src="https://images2.imgbox.com/cf/d2/UAcLf3Im_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_RocketMQ__439"></a>三 RocketMQ 的物理架构</h3> 
<p>消息队列 RocketMQ 是阿里巴巴集团基于高可用分布式集群技术，自主研发的云正式商用的专业消息中间件，既可为分布式应用系统提供异步解耦<br> 和削峰填谷的能力，同时也具备互联网应用所需的海量消息堆积、高吞吐、可靠重试等特性，是阿里巴巴双 11 使用的核心产品。</p> 
<p>RocketMQ 的设计基于主题的发布与订阅模式，其核心功能包括消息发送、消息存储(Broker)、消息消费，整体设计追求简单与性能第一。</p> 
<h4><a id="31__446"></a>3.1 核心概念</h4> 
<p><img src="https://images2.imgbox.com/35/9a/P5VC1CG8_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="311_NameServer_451"></a>3.1.1 NameServer</h5> 
<p>NameServer 是整个 RocketMQ 的“大脑”，它是 RocketMQ 的服务注册中心,所以 RocketMQ 需要先启动 NameServer 再启动 Rocket 中的 Broker。</p> 
<p>Broker 在启动时向所有 NameServer 注册（主要是服务器地址等），生产者在发送消息之前先从 NameServer 获取 Broker 服务器地址列表（消费者一<br> 样），然后根据负载均衡算法从列表中选择一台服务器进行消息发送。</p> 
<p>NameServer 与每台 Broker 服务保持长连接，并间隔 30s 检查 Broker 是否存活，如果检测到 Broker 宕机，则从路由注册表中将其移除。这样就可以实<br> 现 RocketMQ 的高可用。具体细节后续讲解</p> 
<h5><a id="312_Producer_462"></a>3.1.2 生产者(Producer)</h5> 
<p><strong>生产者</strong>：也称为消息发布者，负责生产并发送消息至 RocketMQ。</p> 
<h5><a id="313__Consumer_466"></a>3.1.3 消费者(Consumer)</h5> 
<p><strong>消费者</strong>：也称为消息订阅者，负责从 RocketMQ 接收并消费消息。</p> 
<h5><a id="314_Message_470"></a>3.1.4 消息(Message)</h5> 
<p><strong>消息</strong>：生产或消费的数据，对于 RocketMQ 来说，消息就是字节数组。</p> 
<h5><a id="315_Broker_474"></a>3.1.5 主机(Broker)</h5> 
<p>RocketMQ 的核心，用于暂存和传输消息。</p> 
<h4><a id="32__478"></a>3.2 物理架构中的整体运转</h4> 
<ol><li>NameServer 先启动</li><li>Broker 启动时向 NameServer 注册</li><li>生产者在发送某个主题的消息之前先从 NamerServer 获取 Broker 服务器地址列表（有可能是集群），然后根据负载均衡算法从列表中选择一台<br> Broker 进行消息发送。</li><li>NameServer 与每台 Broker 服务器保持长连接，并间隔 30S 检测 Broker 是否存活，如果检测到 Broker 宕机（使用心跳机制，如果检测超过120S），则从路由注册表中将其移除。</li><li>消费者在订阅某个主题的消息之前从 NamerServer 获取 Broker 服务器地址列表（有可能是集群），但是消费者选择从 Broker 中订阅消息，订阅<br> 规则由 Broker 配置决定</li></ol> 
<h3><a id="_RocketMQ__489"></a>四 RocketMQ 的概念模型</h3> 
<h4><a id="41__491"></a>4.1 核心概念</h4> 
<h5><a id="411_Group_493"></a>4.1.1 分组(Group)</h5> 
<p><strong>生产者</strong>：标识发送同一类消息的Producer，通常发送逻辑一致。发送普通消息的时候，仅标识使用，并无特别用处。<strong>主要作用用于事务消息</strong>：<br> （事务消息中如果某条发送某条消息的producer-A宕机，使得事务消息一直处于PREPARED状态并超时，则broker会回查同一个group的其它producer，<br> 确认这条消息应该 commit 还是 rollback）</p> 
<p><strong>消费者</strong>：标识一类 Consumer 的集合名称，这类 Consumer 通常消费一类消息，且消费逻辑一致。同一个 Consumer Group 下的各个实例将共同消费 topic<br> 的消息，起到负载均衡的作用。</p> 
<p>消费进度以 Consumer Group 为粒度管理，不同 Consumer Group 之间消费进度彼此不受影响，即消息 A 被 Consumer Group1 消费过，也会再给 Consumer<br> Group2 消费。</p> 
<h5><a id="412_Topic_505"></a>4.1.2 主题(Topic)</h5> 
<p>标识一类消息的逻辑名字，消息的逻辑管理单位。无论消息生产还是消费，都需要指定 Topic。</p> 
<p>区分消息的种类；一个发送者可以发送消息给一个或者多个 Topic<br> 一个消息的接收者可以订阅一个或者多个 Topic 消息</p> 
<h5><a id="413_Tag_511"></a>4.1.3 标签(Tag)</h5> 
<p>RocketMQ 支持给在发送的时候给 topic 打 tag，同一个 topic 的消息虽然逻辑管理是一样的。但是消费 topic1 的时候，如果你消费订阅的时候指定的<br> 是 tagA，那么 tagB 的消息将不会投递。</p> 
<h5><a id="414_Message_Queue_515"></a>4.1.4 消息队列(Message Queue)</h5> 
<p>简称 Queue 或 Q。消息物理管理单位。一个 Topic 将有若干个 Q。若一个 Topic 创建在不同的 Broker，则不同的 broker 上都有若干 Q，消息将物理地<br> 存储落在不同 Broker 结点上，具有水平扩展的能力。<br> 无论生产者还是消费者，实际的生产和消费都是针对 Q 级别。例如 Producer 发送消息的时候，会预先选择（默认轮询）好该 Topic 下面的某一条 Q<br> 发送；Consumer 消费的时候也会负载均衡地分配若干个 Q，只拉取对应 Q 的消息。<br> 每一条 message queue 均对应一个文件，这个文件存储了实际消息的索引信息。并且即使文件被删除，也能通过实际纯粹的消息文件（commit log）<br> 恢复回来。</p> 
<h5><a id="415_Offset_524"></a>4.1.5 偏移量(Offset)</h5> 
<p>RocketMQ 中，有很多 offset 的概念。一般我们只关心暴露到客户端的 offset。不指定的话，就是指 Message Queue 下面的 offset。<br> Message queue 是无限长的数组。一条消息进来下标就会涨 1,而这个数组的下标就是 offset，Message queue 中的 max offset 表示消息的最大 offset<br> Consumer offset 可以理解为标记 Consumer Group 在一条逻辑 Message Queue 上，消息消费到哪里即消费进度。但从源码上看，这个数值是消费过的<br> 最新消费的消息 offset+1，即实际上表示的是下次拉取的 offset</p> 
<h3><a id="__530"></a>五 玩转各种消息</h3> 
<h4><a id="51__532"></a>5.1 普通消息</h4> 
<ul><li><strong>导入MQ客户端依赖</strong></li></ul> 
<pre><code class="prism language-xml">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.rocketmq<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>rocketmq-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.8.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<ul><li><strong>消息发送步骤</strong></li></ul> 
<ol><li>创建消息生产者 producer，并指定生产者组名</li><li>指定 Nameserver 地址</li><li>启动 producer</li><li>创建消息对象，指定 Topic、Tag 和消息体</li><li>发送消息</li><li>关闭生产者 producer</li></ol> 
<ul><li><strong>消息消费者步骤</strong></li></ul> 
<ol><li>创建消费者 Consumer，指定消费者组名</li><li>指定 Nameserver 地址</li><li>订阅主题 Topic 和 Tag</li><li>设置回调函数，处理消息</li><li>启动消费者 consumer</li></ol> 
<h5><a id="511__562"></a>5.1.1 消息发送</h5> 
<h6><a id="5111__564"></a>5.1.1.1 发送同步消息</h6> 
<p><img src="https://images2.imgbox.com/f4/c2/keLT3CkB_o.png" alt="在这里插入图片描述"></p> 
<p>这种可靠性同步地发送方式使用的比较广泛，比如：重要的消息通知，短信通知。</p> 
<p>同步发送是指消息发送方发出数据后，同步等待，直到收到接收方发回响应之后才发下一个请求。</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @author Crazy.X
 * 同步发送
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SyncProducer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 实例化消息生产者Producer</span>
        <span class="token class-name">DefaultMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">"please_rename_unique_group_name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置NameServer的地址</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 启动Producer实例</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 创建消息，并指定Topic，Tag和消息体</span>
            <span class="token class-name">Message</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span>
                    <span class="token string">"TopicTest"</span> <span class="token comment">/* Topic */</span><span class="token punctuation">,</span>
                    <span class="token string">"TagA"</span> <span class="token comment">/* Tag */</span><span class="token punctuation">,</span>
                    <span class="token punctuation">(</span><span class="token string">"Hello RocketMQ "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">RemotingHelper</span><span class="token punctuation">.</span>DEFAULT_CHARSET<span class="token punctuation">)</span> <span class="token comment">/* Message body */</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 发送消息到一个Broker</span>
            <span class="token class-name">SendResult</span> sendResult <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 通过sendResult返回消息是否成功送达</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s%n"</span><span class="token punctuation">,</span> sendResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果不再发送消息，关闭Producer实例。</span>
        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/19/4c/raWqAGUn_o.png" alt="在这里插入图片描述"></p> 
<ul><li>Message ID</li></ul> 
<p>消息的全局唯一标识（内部机制的 ID 生成是使用机器 IP 和消息偏移量的组成，所以有可能重复，如果是幂等性还是最好考虑 Key），由消息队列 MQ<br> 系统自动生成，唯一标识某条消息。</p> 
<ul><li>SendStatus</li></ul> 
<p>发送的标识。成功，失败等</p> 
<ul><li>Queue</li></ul> 
<p>相当于是 Topic 的分区；用于并行发送和接收消息</p> 
<h6><a id="5112__623"></a>5.1.1.2 发送异步消息</h6> 
<p><img src="https://images2.imgbox.com/71/76/Rc688RHj_o.png" alt="在这里插入图片描述"></p> 
<p>异步消息通常用在对响应时间敏感的业务场景，即发送端不能容忍长时间地等待 Broker的响应</p> 
<p>消息发送方在发送了一条消息后，不等接收方发回响应，接着进行第二条消息发送。发送方通过回调接口的方式接收服务器响应，并对响应结果进行处理</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @author Crazy.X
 * 异步发送
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AsyncProducer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 实例化消息生产者Producer</span>
        <span class="token class-name">DefaultMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">"please_rename_unique_group_name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置NameServer的地址</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 启动Producer实例</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置发送异步失败时的重试次数</span>
        producer<span class="token punctuation">.</span><span class="token function">setRetryTimesWhenSendAsyncFailed</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//启用Broker故障延迟机制</span>
        producer<span class="token punctuation">.</span><span class="token function">setSendLatencyFaultEnable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> index <span class="token operator">=</span> i<span class="token punctuation">;</span>
            <span class="token comment">// 创建消息，并指定Topic，Tag和消息体</span>
            <span class="token class-name">Message</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span>
                    <span class="token string">"TopicTest"</span><span class="token punctuation">,</span>
                    <span class="token string">"TagA"</span><span class="token punctuation">,</span>
                    <span class="token string">"OrderID888"</span><span class="token punctuation">,</span>
                    <span class="token string">"Hello world"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">RemotingHelper</span><span class="token punctuation">.</span>DEFAULT_CHARSET<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// SendCallback接收异步返回结果的回调</span>
            producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SendCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token class-name">SendResult</span> sendResult<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%-10d OK %s %n"</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> sendResult<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onException</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%-10d Exception %s %n"</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果不再发送消息，关闭Producer实例。</span>
        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/de/e8/qW3goNDK_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="5113__682"></a>5.1.1.3 单向发送</h6> 
<p><img src="https://images2.imgbox.com/7f/ca/8p0eFqlZ_o.png" alt="在这里插入图片描述"></p> 
<p>这种方式主要用在不特别关心发送结果的场景，例如日志发送</p> 
<p>单向（Oneway）发送特点为发送方只负责发送消息，不等待服务器回应且没有回调函数触发，即只发送请求不等待应答。此方式发送消息的过程耗时非常短，一般在微秒级别。</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @author Crazy.X
 * 单向发送
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OneWayProducer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 实例化消息生产者Producer</span>
        <span class="token class-name">DefaultMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">"please_rename_unique_group_name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置NameServer的地址</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 启动Producer实例</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 创建消息，并指定Topic，Tag和消息体</span>
            <span class="token class-name">Message</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span>
                    <span class="token string">"TopicTest"</span> <span class="token comment">/* Topic */</span><span class="token punctuation">,</span>
                    <span class="token string">"TagA"</span> <span class="token comment">/* Tag */</span><span class="token punctuation">,</span>
                    <span class="token punctuation">(</span><span class="token string">"Hello RocketMQ "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">RemotingHelper</span><span class="token punctuation">.</span>DEFAULT_CHARSET<span class="token punctuation">)</span> <span class="token comment">/* Message body */</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 发送单向消息，没有任何返回结果</span>
            producer<span class="token punctuation">.</span><span class="token function">sendOneway</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
        <span class="token comment">// 如果不再发送消息，关闭Producer实例。</span>
        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="5114__721"></a>5.1.1.4 消息发送的权衡</h6> 
<table><thead><tr><th>发送方式</th><th>发送TPS</th><th>发送结果反馈</th><th>可靠性</th><th>适用场景</th></tr></thead><tbody><tr><td>同步可靠发送</td><td>快</td><td>有</td><td>不丢失</td><td>重要通知邮件、报名短信通知、营销短信系统等</td></tr><tr><td>异步可靠发送</td><td>快</td><td>有</td><td>不丢失</td><td>用户视频上传后通知启动转码服务、转码完成后通知推送转码结果等</td></tr><tr><td>单向发送</td><td>快</td><td>有</td><td>可能丢失</td><td>适用于某些耗时非常短，但对可靠性要求并不高的场景，例如日志收集</td></tr></tbody></table> 
<h5><a id="512__730"></a>5.1.2 消息消费</h5> 
<h6><a id="5121__732"></a>5.1.2.1 集群消费</h6> 
<p><img src="https://images2.imgbox.com/c6/93/rVQDtOLS_o.png" alt="在这里插入图片描述"></p> 
<p>消费者的一种消费模式。一个 Consumer Group 中的各个 Consumer 实例分摊去消费消息，即一条消息只会投递到一个 Consumer Group 下面的一个实例。</p> 
<p>实际上，每个 Consumer 是平均分摊 Message Queue 的去做拉取消费。例如某个 Topic 有 3 条 Q，其中一个 Consumer Group有3个实例（可能是3个进程，或者3台机器），那么每个实例只消费其中的 1 条 Q。</p> 
<p>而由 Producer 发送消息的时候是轮询所有的 Q,所以消息会平均散落在不同的 Q 上，可以认为 Q 上的消息是平均的。那么实例也就平均地消费消息了。<br> 这种模式下，<strong>消费进度(Consumer Offset)的存储会持久化到 Broker</strong>。</p> 
<pre><code class="prism language-java">
<span class="token comment">/**
 * @author Crazy.X
 * 推模式集群消费
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BalanceConsumer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 实例化消息消费者,指定组</span>
        <span class="token class-name">DefaultMQPushConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">"group1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定NameServer地址信息</span>
        consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置最大重新消费次数</span>
        consumer<span class="token punctuation">.</span><span class="token function">setMaxReconsumeTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 订阅Topic subExpression 对tag进行指定进行过滤 也可以正则表达式 TagA|TagB</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"TopicTest"</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 负载均衡模式集群消费</span>
        consumer<span class="token punctuation">.</span><span class="token function">setMessageModel</span><span class="token punctuation">(</span><span class="token class-name">MessageModel</span><span class="token punctuation">.</span>CLUSTERING<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 注册回调函数，处理消息</span>
        consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">ConsumeConcurrentlyStatus</span> <span class="token function">consumeMessage</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">&gt;</span></span> msgs<span class="token punctuation">,</span>
                                                            <span class="token class-name">ConsumeConcurrentlyContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MessageExt</span> msg <span class="token operator">:</span> msgs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token class-name">String</span> topic <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">String</span> msgBody <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">String</span> tags <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"收到消息: "</span> <span class="token operator">+</span> <span class="token string">"topic:"</span> <span class="token operator">+</span> topic <span class="token operator">+</span> <span class="token string">",tags:"</span> <span class="token operator">+</span> tags <span class="token operator">+</span> <span class="token string">",msgBody:"</span> <span class="token operator">+</span> msgBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 消费失败，认为没有消费，可能会重复发送</span>
                    <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span>RECONSUME_LATER<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 未出现异常进行提交 成功</span>
                <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span>CONSUME_SUCCESS<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//启动消息者</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Consumer Started.%n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/e7/40/qge4rqTV_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="5122__791"></a>5.1.2.2 广播消费</h6> 
<p><img src="https://images2.imgbox.com/01/6d/kVogGUE5_o.png" alt="在这里插入图片描述"></p> 
<p>消费者的一种消费模式。消息将对一个 Consumer Group 下的各个 Consumer 实例都投递一遍。即即使这些 Consumer 属于同一个 Consumer Group，<br> 消息也会被 Consumer Group 中的每个 Consumer 都消费一次。</p> 
<p>实际上，是一个消费组下的每个消费者实例都获取到了 topic 下面的每个 Message Queue 去拉取消费。所以消息会投递到每个消费者实例。<br> 这种模式下，<strong>消费进度(Consumer Offset)会存储持久化到实例本地</strong>。</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @author Crazy.X
 * 广播模式消费
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BroadcastConsumer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/// 实例化消息消费者,指定组</span>
        <span class="token class-name">DefaultMQPushConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">"group1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定NameServer地址信息</span>
        consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置最大重新消费次数</span>
        consumer<span class="token punctuation">.</span><span class="token function">setMaxReconsumeTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 订阅Topic subExpression 对tag进行指定进行过滤 也可以正则表达式 TagA|TagB</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"TopicTest"</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//广播模式消费</span>
        consumer<span class="token punctuation">.</span><span class="token function">setMessageModel</span><span class="token punctuation">(</span><span class="token class-name">MessageModel</span><span class="token punctuation">.</span>BROADCASTING<span class="token punctuation">)</span><span class="token punctuation">;</span>

        consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 广播模式下，消息队列 RocketMQ 保证每条消息至少被每台客户端消费一次，</span>
            <span class="token comment">// 但是并不会对消费失败的消息进行失败重投，因此业务方需要关注消费失败的情况。</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">ConsumeConcurrentlyStatus</span> <span class="token function">consumeMessage</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">&gt;</span></span> msgs<span class="token punctuation">,</span>
                                                            <span class="token class-name">ConsumeConcurrentlyContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" Receive New Messages: "</span> <span class="token operator">+</span> msgs <span class="token operator">+</span> <span class="token string">"%n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span>CONSUME_SUCCESS<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//启动消息者</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Consumer Started.%n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="5123__837"></a>5.1.2.3 消息消费时的权衡</h6> 
<p><strong>集群模式：适用场景&amp;注意事项</strong></p> 
<ol><li>消费端集群化部署，每条消息只需要被处理一次。</li><li>由于消费进度在服务端维护，可靠性更高。</li><li>集群消费模式下，每一条消息都只会被分发到一台机器上处理。如果需要被集群下的每一台机器都处理，请使用广播模式。</li><li>集群消费模式下，不保证每一次失败重投的消息路由到同一台机器上，因此处理消息时不应该做任何确定性假设。</li></ol> 
<p><strong>广播模式：适用场景&amp;注意事项</strong></p> 
<ol><li>广播消费模式下不支持顺序消息。</li><li>广播消费模式下不支持重置消费位点。</li><li>每条消息都需要被相同逻辑的多台机器处理。</li><li>消费进度在客户端维护，出现重复的概率稍大于集群模式。</li><li>广播模式下，消息队列 RocketMQ 保证每条消息至少被每台客户端消费一次，但是并不会对消费失败的消息进行失败重投，因此业务方需要关注消费失败的情况。</li><li>广播模式下，客户端每一次重启都会从最新消息消费。<strong>客户端在被停止期间发送至服务端的消息将会被自动跳过，请谨慎选择。</strong></li><li>广播模式下，每条消息都会被大量的客户端重复处理，因此推荐尽可能使用集群模式。</li><li>目前仅 Java 客户端支持广播模式。</li><li>广播模式下服务端不维护消费进度，所以消息队列RocketMQ控制台不支持消息堆积查询、消息堆积报警和订阅关系查询功能。</li></ol> 
<h4><a id="52__861"></a>5.2 顺序消息</h4> 
<p>消息有序指的是可以按照消息的发送顺序来消费(FIFO)。RocketMQ 可以严格的保证消息有序，可以分为分区有序或者全局有序。</p> 
<p>顺序消费的原理解析，在默认的情况下消息发送会采取 Round Robin 轮询方式把消息发送到不同的 queue(分区队列)；而消费消息的时候从多个 queue<br> 上拉取消息，这种情况发送和消费是不能保证顺序。但是如果控制发送的顺序消息只依次发送到同一个 queue 中，消费的时候只从这个 queue 上依次拉<br> 取，则就保证了顺序。当发送和消费参与的 queue 只有一个，则是全局有序；如果多个 queue 参与，则为分区有序，即相对每个 queue，消息都是有序的。</p> 
<ul><li>全局顺序消息<br> <img src="https://images2.imgbox.com/be/f2/x8Yco1oT_o.png" alt="在这里插入图片描述"></li></ul> 
<p>全局顺序只创建一个queqe 即可全局顺序 不做记录</p> 
<ul><li>部分顺序消息<br> <img src="https://images2.imgbox.com/cc/5d/dt98OXJv_o.png" alt="在这里插入图片描述"></li></ul> 
<h5><a id="521__880"></a>5.2.1 顺序消息生产</h5> 
<p>一个订单的顺序流程是：创建、付款、推送、完成。订单号相同的消息会被先后发送到同一个队列中，下面是订单进行分区有序的示例代码。</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @author Crazy.X
 * 部分顺序消息生产
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProducerInOrder</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 实例化消息生产者Producer</span>
        <span class="token class-name">DefaultMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">"OrderProducer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置NameServer的地址</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 启动Producer实例</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// tags数组 使用tag区分</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tags <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span><span class="token string">"TagA"</span><span class="token punctuation">,</span> <span class="token string">"TagC"</span><span class="token punctuation">,</span> <span class="token string">"TagD"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">// 订单列表 模拟订单数据</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> orderList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProducerInOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">buildOrders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Date</span> date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SimpleDateFormat</span> sdf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">"yyyy-MM-dd HH:mm:ss"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> dateStr <span class="token operator">=</span> sdf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 创建消息，并指定Topic，Tag和消息体</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> orderList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 加个时间前缀</span>
            <span class="token class-name">String</span> body <span class="token operator">=</span> dateStr <span class="token operator">+</span> <span class="token string">" Order:"</span> <span class="token operator">+</span> orderList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 指定tags组</span>
            <span class="token class-name">Message</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">"PartOrder"</span><span class="token punctuation">,</span> tags<span class="token punctuation">[</span>i <span class="token operator">%</span> tags<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"KEY"</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> body<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">SendResult</span> sendResult <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MessageQueueSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token class-name">MessageQueue</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> mqs<span class="token punctuation">,</span> <span class="token class-name">Message</span> msg<span class="token punctuation">,</span> <span class="token class-name">Object</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//根据订单id选择发送queue</span>
                    <span class="token class-name">Long</span> id <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">)</span> arg<span class="token punctuation">;</span>
                    <span class="token keyword">long</span> index <span class="token operator">=</span> id <span class="token operator">%</span> mqs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 返回</span>
                    <span class="token keyword">return</span> mqs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> orderList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//订单id</span>

            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"SendResult status:%s, queueId:%d, body:%s"</span><span class="token punctuation">,</span>
                    sendResult<span class="token punctuation">.</span><span class="token function">getSendStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    sendResult<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    body<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果不再发送消息，关闭Producer实例。</span>
        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 订单
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Order</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">private</span> <span class="token keyword">long</span> orderId<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> desc<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> orderId<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token keyword">long</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>orderId <span class="token operator">=</span> orderId<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> desc<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setDesc</span><span class="token punctuation">(</span><span class="token class-name">String</span> desc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>desc <span class="token operator">=</span> desc<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token string">"Order{"</span> <span class="token operator">+</span>
                    <span class="token string">"orderId="</span> <span class="token operator">+</span> orderId <span class="token operator">+</span>
                    <span class="token string">", desc='"</span> <span class="token operator">+</span> desc <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>
                    <span class="token string">'}'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 生成模拟订单数据
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> <span class="token function">buildOrders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> orderList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Order</span> orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token number">20210406001L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setDesc</span><span class="token punctuation">(</span><span class="token string">"创建"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token number">20210406002L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setDesc</span><span class="token punctuation">(</span><span class="token string">"创建"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token number">20210406001L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setDesc</span><span class="token punctuation">(</span><span class="token string">"付款"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token number">20210406003L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setDesc</span><span class="token punctuation">(</span><span class="token string">"创建"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token number">20210406002L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setDesc</span><span class="token punctuation">(</span><span class="token string">"付款"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token number">20210406003L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setDesc</span><span class="token punctuation">(</span><span class="token string">"付款"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token number">20210406002L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setDesc</span><span class="token punctuation">(</span><span class="token string">"推送"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token number">20210406003L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setDesc</span><span class="token punctuation">(</span><span class="token string">"推送"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token number">20210406002L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setDesc</span><span class="token punctuation">(</span><span class="token string">"完成"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token number">20210406001L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setDesc</span><span class="token punctuation">(</span><span class="token string">"推送"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token number">20210406003L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setDesc</span><span class="token punctuation">(</span><span class="token string">"完成"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token number">20210406001L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setDesc</span><span class="token punctuation">(</span><span class="token string">"完成"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> orderList<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-8BMWlGpo-1625329014522)(494F4EF9B5884E1C911324A04E9C0140)]</p> 
<h5><a id="522__1038"></a>5.2.2 顺序消息消费</h5> 
<p>消费时，同一个 OrderId 获取到的肯定是同一个队列。从而确保一个订单中处理的顺序。</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @author Crazy.X
 * 部分顺序消息消费
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConsumerInOrder</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">DefaultMQPushConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">"OrderConsumer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 设置Consumer第一次启动是从队列头部开始消费还是队列尾部开始消费&lt;br&gt;</span>
        <span class="token comment">// 如果非第一次启动，那么按照上次消费的位置继续消费</span>
        consumer<span class="token punctuation">.</span><span class="token function">setConsumeFromWhere</span><span class="token punctuation">(</span><span class="token class-name">ConsumeFromWhere</span><span class="token punctuation">.</span>CONSUME_FROM_FIRST_OFFSET<span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"PartOrder"</span><span class="token punctuation">,</span> <span class="token string">"TagA || TagC || TagD"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageListenerOrderly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">ConsumeOrderlyStatus</span> <span class="token function">consumeMessage</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">&gt;</span></span> msgs<span class="token punctuation">,</span> <span class="token class-name">ConsumeOrderlyContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                context<span class="token punctuation">.</span><span class="token function">setAutoCommit</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MessageExt</span> msg <span class="token operator">:</span> msgs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 可以看到每个queue有唯一的consume线程来消费, 订单对每个queue(分区)有序</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"consumeThread="</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                            <span class="token string">"queueId="</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                            <span class="token string">", content:"</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//模拟业务逻辑处理中...</span>
                    <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token class-name">ConsumeOrderlyStatus</span><span class="token punctuation">.</span>SUCCESS<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Consumer Started."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/18/2e/RThjXahq_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="53__1086"></a>5.3 消息发送时的重要方法/属性（工作参考使用）</h4> 
<p>属性与方法是整个类，可以放到一个类下观看</p> 
<h5><a id="531__1090"></a>5.3.1 属性</h5> 
<pre><code class="prism language-java">        <span class="token comment">//  producerGroup：生产者所属组(针对 事务消息 高可用)</span>
        <span class="token class-name">DefaultMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">"produce_details"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//  默认主题在每一个Broker队列数量(对于新创建主题有效)</span>
        producer<span class="token punctuation">.</span><span class="token function">setDefaultTopicQueueNums</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//  发送消息默认超时时间，默认3s (3000ms)</span>
        producer<span class="token punctuation">.</span><span class="token function">setSendMsgTimeout</span><span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//  消息体超过该值则启用压缩，默认4k</span>
        producer<span class="token punctuation">.</span><span class="token function">setCompressMsgBodyOverHowmuch</span><span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//  同步方式发送消息重试次数，默认为2，总共执行3次</span>
        producer<span class="token punctuation">.</span><span class="token function">setRetryTimesWhenSendFailed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//  异步方式发送消息重试次数，默认为2，总共执行3次</span>
        producer<span class="token punctuation">.</span><span class="token function">setRetryTimesWhenSendAsyncFailed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//  消息重试时选择另外一个Broker时（消息没有存储成功是否发送到另外一个broker），默认为false</span>
        producer<span class="token punctuation">.</span><span class="token function">setRetryAnotherBrokerWhenNotStoreOK</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//  允许发送的最大消息长度，默认为4M</span>
        producer<span class="token punctuation">.</span><span class="token function">setMaxMessageSize</span><span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 设置NameServer的地址</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<h5><a id="532__1116"></a>5.3.2 方法</h5> 
<pre><code class="prism language-java">        <span class="token comment">// 启动Producer实例</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 如果不再发送消息，关闭Producer实例。（这行代码要放在最后）</span>
        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 查找该主题下所有消息队列</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">MessageQueue</span> <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">fetchPublishMessageQueues</span><span class="token punctuation">(</span><span class="token string">"TopicTest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MessageQueue</span> queue <span class="token operator">:</span> <span class="token class-name">MessageQueue</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>queue<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h6><a id="5321__1132"></a>5.3.2.1 单向发送</h6> 
<pre><code class="prism language-java">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> index <span class="token operator">=</span> i<span class="token punctuation">;</span>
            <span class="token comment">// 创建消息，并指定Topic，Tag和消息体</span>
            <span class="token class-name">Message</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span>
                    <span class="token string">"TopicTest"</span><span class="token punctuation">,</span>
                    <span class="token string">"TagA"</span><span class="token punctuation">,</span>
                    <span class="token string">"OrderID888"</span><span class="token punctuation">,</span>
                    <span class="token string">"Hello world"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">RemotingHelper</span><span class="token punctuation">.</span>DEFAULT_CHARSET<span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//  ------------  单向发送  ------------</span>
            <span class="token comment">//  1.1发送单向消息</span>
            producer<span class="token punctuation">.</span><span class="token function">sendOneway</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//  1.2指定队列单向发送消息(使用select方法)</span>
            producer<span class="token punctuation">.</span><span class="token function">sendOneway</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token punctuation">(</span>mqs<span class="token punctuation">,</span> msg1<span class="token punctuation">,</span> arg<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> mqs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//  1.3指定队列单向发送消息(根据之前查找出来的主题)</span>
            producer<span class="token punctuation">.</span><span class="token function">sendOneway</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token class-name">MessageQueue</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h6><a id="5333__1154"></a>5.3.3.3 同步发送</h6> 
<pre><code class="prism language-java">            <span class="token comment">//  2.1同步发送消息</span>
            <span class="token class-name">SendResult</span> sendResult0 <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//  2.1同步超时发送消息(属性设置：sendMsgTimeout 发送消息默认超时时间，默认3s (3000ms) )</span>
            <span class="token class-name">SendResult</span> sendResult1 <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//  2.2指定队列同步发送消息(使用select方法)</span>
            <span class="token class-name">SendResult</span> sendResult2 <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MessageQueueSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token class-name">MessageQueue</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> mqs<span class="token punctuation">,</span> <span class="token class-name">Message</span> msg<span class="token punctuation">,</span> <span class="token class-name">Object</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> mqs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//  2.3指定队列同步发送消息(根据之前查找出来的主题队列信息)</span>
            <span class="token class-name">SendResult</span> sendResult3 <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token class-name">MessageQueue</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h6><a id="5332__1172"></a>5.3.3.2 异步发送</h6> 
<pre><code class="prism language-java">            <span class="token comment">//  3.1异步发送消息</span>
            producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SendCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token class-name">SendResult</span> sendResult<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%-10d OK %s %n"</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> sendResult<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onException</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%-10d Exception %s %n"</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//  3.1异步超时发送消息</span>
            producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SendCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token class-name">SendResult</span> sendResult<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%-10d OK %s %n"</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> sendResult<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onException</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%-10d Exception %s %n"</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//  3.2选择指定队列异步发送消息(根据之前查找出来的主题队列信息)</span>
            producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token class-name">MessageQueue</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">SendCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token annotation punctuation">@Override</span>
                        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token class-name">SendResult</span> sendResult<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%-10d OK %s %n"</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> sendResult<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token annotation punctuation">@Override</span>
                        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onException</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%-10d Exception %s %n"</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//  3.3选择指定队列异步发送消息(使用select方法)</span>
            producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MessageQueueSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token annotation punctuation">@Override</span>
                        <span class="token keyword">public</span> <span class="token class-name">MessageQueue</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> mqs<span class="token punctuation">,</span> <span class="token class-name">Message</span> msg<span class="token punctuation">,</span> <span class="token class-name">Object</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">return</span> mqs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">SendCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token annotation punctuation">@Override</span>
                        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token class-name">SendResult</span> sendResult<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%-10d OK %s %n"</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> sendResult<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token annotation punctuation">@Override</span>
                        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onException</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%-10d Exception %s %n"</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="54__1237"></a>5.4 消息消费时的重要方法/属性（工作参考使用）</h4> 
<p>属性与方法是整个类，可以放到一个类下观看</p> 
<h5><a id="541__1241"></a>5.4.1 属性</h5> 
<pre><code class="prism language-java">        <span class="token comment">// consumerGroup：消费者组</span>
        <span class="token class-name">DefaultMQPushConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">"Faker"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定NameServer地址信息.</span>
        consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 消息消费模式（默认集群消费）</span>
        consumer<span class="token punctuation">.</span><span class="token function">setMessageModel</span><span class="token punctuation">(</span><span class="token class-name">MessageModel</span><span class="token punctuation">.</span>CLUSTERING<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定消费开始偏移量（上次消费偏移量、最大偏移量、最小偏移量、启动时间戳）开始消费</span>
        consumer<span class="token punctuation">.</span><span class="token function">setConsumeFromWhere</span><span class="token punctuation">(</span><span class="token class-name">ConsumeFromWhere</span><span class="token punctuation">.</span>CONSUME_FROM_LAST_OFFSET<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 消费者最小线程数量(默认20)</span>
        consumer<span class="token punctuation">.</span><span class="token function">setConsumeThreadMin</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 消费者最大线程数量(默认20)</span>
        consumer<span class="token punctuation">.</span><span class="token function">setConsumeThreadMax</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 推模式下任务间隔时间(推模式也是基于不断的轮训拉取的封装)</span>
        consumer<span class="token punctuation">.</span><span class="token function">setPullInterval</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 推模式下任务拉取的条数,默认32条(一批批拉)</span>
        consumer<span class="token punctuation">.</span><span class="token function">setPullBatchSize</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 消息重试次数,-1代表16次 （超过 次数成为死信消息）</span>
        consumer<span class="token punctuation">.</span><span class="token function">setMaxReconsumeTimes</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 消息消费超时时间(消息可能阻塞正在使用的线程的最大时间：以分钟为单位)</span>
        consumer<span class="token punctuation">.</span><span class="token function">setConsumeTimeout</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<h5><a id="542__1268"></a>5.4.2 方法</h5> 
<pre><code class="prism language-java">        <span class="token comment">// 方法-订阅</span>
        <span class="token comment">// 基于主题订阅消息，消息过滤使用表达式</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"TopicTest"</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//tag  tagA||TagB||TagC</span>
        <span class="token comment">// 基于主题订阅消息，消息过滤使用表达式</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"TopicTest"</span><span class="token punctuation">,</span> <span class="token class-name">MessageSelector</span><span class="token punctuation">.</span><span class="token function">bySql</span><span class="token punctuation">(</span><span class="token string">"a between 0 and 3"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 基于主题订阅消息，消息过滤使用表达式</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"TopicTest"</span><span class="token punctuation">,</span> <span class="token class-name">MessageSelector</span><span class="token punctuation">.</span><span class="token function">byTag</span><span class="token punctuation">(</span><span class="token string">"tagA||TagB"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 取消消息订阅</span>
        consumer<span class="token punctuation">.</span><span class="token function">unsubscribe</span><span class="token punctuation">(</span><span class="token string">"TopicTest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 注册监听器</span>
        <span class="token comment">// 注册并发事件监听器</span>
        consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>msgs<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MessageExt</span> msg <span class="token operator">:</span> msgs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">String</span> topic <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> msgBody <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> tags <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"收到消息："</span> <span class="token operator">+</span> <span class="token string">" topic :"</span> <span class="token operator">+</span> topic <span class="token operator">+</span> <span class="token string">" ,tags : "</span> <span class="token operator">+</span> tags <span class="token operator">+</span> <span class="token string">" ,msg : "</span> <span class="token operator">+</span> msgBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//没有成功  -- 到重试队列中来</span>
                <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span>RECONSUME_LATER<span class="token punctuation">;</span>

            <span class="token punctuation">}</span>
            <span class="token comment">//  // 未出现异常进行提交 成功</span>
            <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span>CONSUME_SUCCESS<span class="token punctuation">;</span>
            <span class="token comment">//todo</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 注册顺序消息事件监听器</span>
        consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageListenerOrderly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">ConsumeOrderlyStatus</span> <span class="token function">consumeMessage</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">&gt;</span></span> msgs<span class="token punctuation">,</span> <span class="token class-name">ConsumeOrderlyContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                context<span class="token punctuation">.</span><span class="token function">setAutoCommit</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MessageExt</span> msg <span class="token operator">:</span> msgs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 可以看到每个queue有唯一的consume线程来消费, 订单对每个queue(分区)有序</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"consumeThread="</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"queueId="</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", content:"</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//模拟业务逻辑处理中...</span>
                    <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 这个点要注意：意思是先等一会，一会儿再处理这批消息，而不是放到重试队列里</span>
                    <span class="token keyword">return</span> <span class="token class-name">ConsumeOrderlyStatus</span><span class="token punctuation">.</span>SUSPEND_CURRENT_QUEUE_A_MOMENT<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token class-name">ConsumeOrderlyStatus</span><span class="token punctuation">.</span>SUCCESS<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//启动消息者</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Consumer Started.%n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<h5><a id="543_ACK_1330"></a>5.4.3 消费确认(ACK)</h5> 
<ol><li>业务实现消费回调的时候，当且仅当此回调函数返回 ConsumeConcurrentlyStatus.CONSUME_SUCCESS，RocketMQ 才会认为这批消息（默认是 1 条）<br> 是消费完成的。中途断电，抛出异常等都不会认为成功——即都会重新投递。</li><li>返回 ConsumeConcurrentlyStatus.RECONSUME_LATER，RocketMQ 就会认为这批消息消费失败了。</li><li>如果业务的回调没有处理好而抛出异常，会认为是消费失败 ConsumeConcurrentlyStatus.RECONSUME_LATER 处理。</li><li>为了保证消息是肯定被至少消费成功一次，RocketMQ 会把这批消息重发回 Broker（topic 不是原 topic 而是这个消费组的 RETRY topic），在延迟的某<br> 个时间点（默认是 10 秒，业务可设置）后，再次投递到这个 ConsumerGroup。而如果一直这样重复消费都持续失败到一定次数（默认 16 次），就会投<br> 递到 DLQ 死信队列。应用可以监控死信队列来做人工干预。</li><li>另外如果使用顺序消费的回调 MessageListenerOrderly 时，由于顺序消费是要前者消费成功才能继续消费，所以没有 RECONSUME_LATER 的这个状态，<br> 只有 SUSPEND_CURRENT_QUEUE_A_MOMENT 来暂停队列的其余消费，直到原消息不断重试成功为止才能继续消</li></ol> 
<h4><a id="55__1342"></a>5.5 延时消息</h4> 
<h5><a id="551__1344"></a>5.5.1 概念介绍</h5> 
<p><img src="https://images2.imgbox.com/46/0e/7Wi1l6od_o.png" alt="在这里插入图片描述"></p> 
<p><strong>延时消息</strong>：Producer 将消息发送到消息队列 RocketMQ 服务端，但并不期望这条消息立马投递，而是延迟一定时间后才投递到 Consumer 进行消费，该消息即延时消息。</p> 
<h5><a id="552__1351"></a>5.5.2 适用场景</h5> 
<p>消息生产和消费有时间窗口要求：比如在电商交易中超时未支付关闭订单的场景，在订单创建时会发送一条延时消息。这条消息将会在 30 分钟以<br> 后投递给消费者，消费者收到此消息后需要判断对应的订单是否已完成支付。 如支付未完成，则关闭订单。如已完成支付则忽略。</p> 
<h5><a id="553__1356"></a>5.5.3 使用方式</h5> 
<p><strong>Apache RocketMQ</strong> 目前只支持固定精度的定时消息，因为如果要支持任意的时间精度，在 Broker 层面，必须要做消息排序，如果再涉及到持久化，<br> 那么消息排序要不可避免的产生巨大性能开销。<mark>（阿里云 RocketMQ 提供了任意时刻的定时消息功能，Apache 的 RocketMQ 并没有,阿里并没有开源）</mark></p> 
<p>发送延时消息时需要设定一个延时时间长度，消息将从当前发送时间点开始延迟固定时间之后才开始投递</p> 
<p>延迟消息是根据延迟队列的 level 来的，延迟队列默认</p> 
<p>msg.setDelayTimeLevel(3)代表延迟 10 秒<br> “1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h”</p> 
<p><strong>在源码org/apache/rocketmq/store/config/MessageStoreConfig.java</strong><br> <img src="https://images2.imgbox.com/42/e3/gu1FVUVA_o.png" alt="在这里插入图片描述"></p> 
<p>是这 18 个等级（秒（s）、分（m）、小时（h）），level 为 1，表示延迟 1 秒后消费，level 为 5 表示延迟 1 分钟后消费，level 为 18 表示延迟 2 个<br> 小时消费。生产消息跟普通的生产消息类似，只需要在消息上设置延迟队列的 level 即可。消费消息跟普通的消费消息一致。</p> 
<ul><li>生产者</li></ul> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @author Crazy.X
 * 延时消息-生产者
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ScheduledMessageProducer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 实例化一个生产者来产生延时消息</span>
        <span class="token class-name">DefaultMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">"ScheduledProducer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定NameServer地址信息</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 启动Producer实例</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> totalMessagesToSend <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> totalMessagesToSend<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Message</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">"ScheduledTopic"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"Hello scheduled message "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 设置延时等级3,这个消息将在10s之后投递给消费者(详看delayTimeLevel)</span>
            <span class="token comment">// delayTimeLevel：(1~18个等级)"1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h"</span>
            <span class="token comment">// 4就是第四个等级 30s</span>
            message<span class="token punctuation">.</span><span class="token function">setDelayTimeLevel</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 发送消息</span>
            producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 关闭生产者</span>
        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>消费者</li></ul> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @author Crazy.X
 * 延时消息-消费者
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ScheduledMessageConsumer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 实例化消费者</span>
        <span class="token class-name">DefaultMQPushConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">"ScheduledConsumer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定NameServer地址信息</span>
        consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 订阅Topics</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"ScheduledTopic"</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 注册消息监听者</span>
        consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>messages<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MessageExt</span> message <span class="token operator">:</span> messages<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// msgId 消息ID</span>
                <span class="token comment">// getStoreTimestamp() 存储时间戳</span>
                <span class="token comment">// getBornTimestamp() 诞生时间戳</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Receive message[msgId="</span> <span class="token operator">+</span> message<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"] "</span>
                        <span class="token operator">+</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getStoreTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> message<span class="token punctuation">.</span><span class="token function">getBornTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"ms later"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 提交消费</span>
            <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span>CONSUME_SUCCESS<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 启动消费者</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/1e/56/mx6gWQnD_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="56__1440"></a>5.6 批量消息</h4> 
<p>批量发送消息能显著提高传递小消息的性能。限制是这些批量消息应该有相同的 topic，相同的 waitStoreMsgOK（集群时会细讲），而且不能是延<br> 时消息。此外，这一批消息的总大小不应超过 4MB</p> 
<ul><li>生产者</li></ul> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @author Crazy.X
 * 批量消息-生产者  list不要超过4m
 */</span>
<span class="token comment">/**
 * @author Crazy.X
 * 批量消息-生产者  list不要超过4m
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BatchProducer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 实例化消息生产者Producer</span>
        <span class="token class-name">DefaultMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">"BatchProducer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置NameServer的地址</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 启动Producer实例</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> topic <span class="token operator">=</span> <span class="token string">"BatchTest"</span><span class="token punctuation">;</span>
        <span class="token comment">// list不要超过4m</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span><span class="token punctuation">&gt;</span></span> messages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        messages<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> <span class="token string">"Tag"</span><span class="token punctuation">,</span> <span class="token string">"OrderID001"</span><span class="token punctuation">,</span> <span class="token string">"Hello world 0"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        messages<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> <span class="token string">"Tag"</span><span class="token punctuation">,</span> <span class="token string">"OrderID002"</span><span class="token punctuation">,</span> <span class="token string">"Hello world 1"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        messages<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> <span class="token string">"Tag"</span><span class="token punctuation">,</span> <span class="token string">"OrderID003"</span><span class="token punctuation">,</span> <span class="token string">"Hello world 2"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>messages<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果不再发送消息，关闭Producer实例。</span>
        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>消费者</li></ul> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @author Crazy.X
 * 批量消息-消费者 批量消费延迟较高
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BatchConsumer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 实例化消息消费者,指定组名</span>
        <span class="token class-name">DefaultMQPushConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">"BatchConsumer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置NameServer的地址</span>
        consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 订阅Topic</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"BatchTest"</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//负载均衡模式消费</span>
        consumer<span class="token punctuation">.</span><span class="token function">setMessageModel</span><span class="token punctuation">(</span><span class="token class-name">MessageModel</span><span class="token punctuation">.</span>CLUSTERING<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 注册回调函数，处理消息</span>
        consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>msgs<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s Receive New Messages: %s %n"</span><span class="token punctuation">,</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span>CONSUME_SUCCESS<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//启动消息者</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Consumer Started.%n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/da/fc/y3JZg9eu_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="561__1513"></a>5.6.1 批量切分</h5> 
<p>如果消息的总长度可能大于 4MB 时，这时候最好把消息进行分割</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @author Crazy.X
 * 批量消息-超过4m-生产者
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SplitBatchProducer</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 实例化消息生产者Producer</span>
        <span class="token class-name">DefaultMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">"BatchProducer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置NameServer的地址</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 启动Producer实例</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//large batch</span>
        <span class="token class-name">String</span> topic <span class="token operator">=</span> <span class="token string">"BatchTest"</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span><span class="token punctuation">&gt;</span></span> messages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//10万元素的数组</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            messages<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> <span class="token string">"Tag"</span><span class="token punctuation">,</span> <span class="token string">"OrderID"</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"Hello world "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//把大的消息分裂成若干个小的消息（1M左右）</span>
        <span class="token class-name">ListSplitter</span> splitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ListSplitter</span><span class="token punctuation">(</span>messages<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>splitter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span><span class="token punctuation">&gt;</span></span> listItem <span class="token operator">=</span> splitter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>listItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果不再发送消息，关闭Producer实例。</span>
        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Consumer Started.%n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">ListSplitter</span> <span class="token keyword">implements</span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Message</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span><span class="token punctuation">&gt;</span></span> messages<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> currIndex<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ListSplitter</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span><span class="token punctuation">&gt;</span></span> messages<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>messages <span class="token operator">=</span> messages<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> currIndex <span class="token operator">&lt;</span> messages<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span><span class="token punctuation">&gt;</span></span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> nextIndex <span class="token operator">=</span> currIndex<span class="token punctuation">;</span>
        <span class="token keyword">int</span> totalSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> nextIndex <span class="token operator">&lt;</span> messages<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> nextIndex<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Message</span> message <span class="token operator">=</span> messages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>nextIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> tmpSize <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> properties <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> properties<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                tmpSize <span class="token operator">+=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 增加日志的开销20字节</span>
            tmpSize <span class="token operator">=</span> tmpSize <span class="token operator">+</span> <span class="token number">20</span><span class="token punctuation">;</span>
            <span class="token comment">//1M</span>
            <span class="token keyword">int</span> sizeLimit <span class="token operator">=</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tmpSize <span class="token operator">&gt;</span> sizeLimit<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//单个消息超过了最大的限制（1M）</span>
                <span class="token comment">//忽略,否则会阻塞分裂的进程</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>nextIndex <span class="token operator">-</span> currIndex <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//假如下一个子列表没有元素,则添加这个子列表然后退出循环,否则只是退出循环</span>
                    nextIndex<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tmpSize <span class="token operator">+</span> totalSize <span class="token operator">&gt;</span> sizeLimit<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                totalSize <span class="token operator">+=</span> tmpSize<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span><span class="token punctuation">&gt;</span></span> subList <span class="token operator">=</span> messages<span class="token punctuation">.</span><span class="token function">subList</span><span class="token punctuation">(</span>currIndex<span class="token punctuation">,</span> nextIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        currIndex <span class="token operator">=</span> nextIndex<span class="token punctuation">;</span>
        <span class="token keyword">return</span> subList<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token string">"Not allowed to remove"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="57__1609"></a>5.7 过滤消息</h4> 
<p><strong>注意事项：</strong> <mark>区分tag group一定要不同的组，否则变成负载均衡状态出现数据错误</mark></p> 
<h5><a id="571_Tag__1613"></a>5.7.1 Tag 过滤</h5> 
<p>在大多数情况下，TAG 是一个简单而有用的设计，其可以来选择您想要的消息。举例说明:JD电商电脑商品的只消费电脑,书籍商品的只消费书籍</p> 
<ul><li>生产者</li></ul> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @author Crazy.X
 * tag过滤-生产者
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TagFilterProducer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 实例化消息生产者Producer</span>
        <span class="token class-name">DefaultMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">"TagFilterProducer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置NameServer的地址</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建两个tags</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tags <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span><span class="token string">"computer"</span><span class="token punctuation">,</span> <span class="token string">"book"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Message</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">"TagFilterTest"</span><span class="token punctuation">,</span>
                    tags<span class="token punctuation">[</span>i <span class="token operator">%</span> tags<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token string">"Hello world"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">RemotingHelper</span><span class="token punctuation">.</span>DEFAULT_CHARSET<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">SendResult</span> sendResult <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s%n"</span><span class="token punctuation">,</span> sendResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果不再发送消息，关闭Producer实例</span>
        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>消费者-tag computer</li></ul> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @author Crazy.X
 * tag过滤computer-消费者
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TagComputerFilterConsumer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">MQClientException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 实例化消息消费者,指定组名-tag区分的话组一定不要设置重复</span>
        <span class="token class-name">DefaultMQPushConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">"TagComputerFilterConsumer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置NameServer的地址</span>
        consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// tag来区分,举例说明:JD电商电脑商品的只消费电脑,书籍商品的只消费书籍</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"TagFilterTest"</span><span class="token punctuation">,</span> <span class="token string">"computer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定消费开始偏移量 ConsumeFromWhere.CONSUME_FROM_LAST_OFFSET 也是默认值,可见源码</span>
        consumer<span class="token punctuation">.</span><span class="token function">setConsumeFromWhere</span><span class="token punctuation">(</span><span class="token class-name">ConsumeFromWhere</span><span class="token punctuation">.</span>CONSUME_FROM_LAST_OFFSET<span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>msgs<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MessageExt</span> msg <span class="token operator">:</span> msgs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">String</span> topic <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> msgBody <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> msgPro <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token class-name">String</span> tags <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"收到消息："</span> <span class="token operator">+</span> <span class="token string">" topic :"</span> <span class="token operator">+</span> topic <span class="token operator">+</span> <span class="token string">" ,tags : "</span> <span class="token operator">+</span> tags <span class="token operator">+</span> <span class="token string">" ,a : "</span> <span class="token operator">+</span> msgPro <span class="token operator">+</span> <span class="token string">" ,msg : "</span> <span class="token operator">+</span> msgBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span>RECONSUME_LATER<span class="token punctuation">;</span>

            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span>CONSUME_SUCCESS<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Consumer Started.%n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/14/f2/pbTqi66k_o.png" alt="在这里插入图片描述"></p> 
<ul><li>消费者-tag book</li></ul> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @author Crazy.X
 * tag过滤book-消费者
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TagBookFilterConsumer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">MQClientException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 实例化消息消费者,指定组名-tag区分的话组一定不要设置重复</span>
        <span class="token class-name">DefaultMQPushConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">"TagBookFilterConsumer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置NameServer的地址</span>
        consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// tag来区分,举例说明:JD电商电脑商品的只消费电脑,书籍商品的只消费书籍</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"TagFilterTest"</span><span class="token punctuation">,</span> <span class="token string">"book"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定消费开始偏移量 ConsumeFromWhere.CONSUME_FROM_LAST_OFFSET 也是默认值,可见源码</span>
        consumer<span class="token punctuation">.</span><span class="token function">setConsumeFromWhere</span><span class="token punctuation">(</span><span class="token class-name">ConsumeFromWhere</span><span class="token punctuation">.</span>CONSUME_FROM_LAST_OFFSET<span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>msgs<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MessageExt</span> msg <span class="token operator">:</span> msgs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">String</span> topic <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> msgBody <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> msgPro <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token class-name">String</span> tags <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"收到消息："</span> <span class="token operator">+</span> <span class="token string">" topic :"</span> <span class="token operator">+</span> topic <span class="token operator">+</span> <span class="token string">" ,tags : "</span> <span class="token operator">+</span> tags <span class="token operator">+</span> <span class="token string">" ,a : "</span> <span class="token operator">+</span> msgPro <span class="token operator">+</span> <span class="token string">" ,msg : "</span> <span class="token operator">+</span> msgBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span>RECONSUME_LATER<span class="token punctuation">;</span>

            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span>CONSUME_SUCCESS<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Consumer Started.%n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/d4/3d/hv9NhCJJ_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="572_Sql__1732"></a>5.7.2 Sql 过滤</h5> 
<p><strong>注意：</strong> <mark>开启sql过滤会影响性能（不建议使用）</mark></p> 
<p>sql过滤需要broker.conf配置文件添加配置</p> 
<pre><code class="prism language-xml">brokerClusterName = DefaultCluster
brokerName = broker-a
brokerId = 0
deleteWhen = 04
fileReservedTime = 48
brokerRole = ASYNC_MASTER
flushDiskType = ASYNC_FLUSH
brokerIP1=192.168.3.200
namesrvAddr=192.168.3.200:9876
# 加入开启过滤
enablePropertyFilter=true

</code></pre> 
<h6><a id="5721_SQL__1752"></a>5.7.2.1 SQL 基本语法</h6> 
<p>RocketMQ 定义了一些基本语法来支持这个特性。你也可以很容易地扩展它。</p> 
<ol><li>数值比较：比如：<code>&gt;</code>，<code>&gt;=</code>，<code>&lt;</code>，<code>&lt;=</code>，<code>BETWEEN</code>，<code>=</code>；</li><li>字符比较：比如：<code>=</code>，<code>&lt;&gt;</code>，<code>IN</code>；</li><li><code>IS NULL</code> 或者 <code>IS NOT NULL</code>；</li></ol> 
<ul><li>逻辑符号：<code>AND</code>，<code>OR</code>，<code>NOT</code>；</li></ul> 
<p>常量支持类型为：</p> 
<ol><li>数值，比如：123，3.1415；</li><li>字符，比如：‘abc’，必须用单引号包裹起来；</li><li><code>NULL</code>，特殊的常量</li><li>布尔值，<code>TRUE</code> 或 <code>FALSE</code></li></ol> 
<p>只有推送消费者才能通过 SQL92 选择消息。界面是：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">MessageSelector</span> messageSelector<span class="token punctuation">)</span>
</code></pre> 
<ul><li>生产者</li></ul> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @author Crazy.X
 * sql过滤 -消息生产者（加入消息属性)
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SqlFilterProducer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 实例化消息生产者Producer</span>
        <span class="token class-name">DefaultMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">"SqlFilterProducer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置NameServer的地址</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tags <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span><span class="token string">"TagA"</span><span class="token punctuation">,</span> <span class="token string">"TagB"</span><span class="token punctuation">,</span> <span class="token string">"TagC"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Message</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">"SqlFilterTest"</span><span class="token punctuation">,</span>
                    tags<span class="token punctuation">[</span>i <span class="token operator">%</span> tags<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token punctuation">(</span><span class="token string">"Hello RocketMQ "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">RemotingHelper</span><span class="token punctuation">.</span>DEFAULT_CHARSET<span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 设置一些属性</span>
            msg<span class="token punctuation">.</span><span class="token function">putUserProperty</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">SendResult</span> sendResult <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s%n"</span><span class="token punctuation">,</span> sendResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果不再发送消息，关闭Producer实例</span>
        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/a3/db/s1GPDaIZ_o.png" alt="在这里插入图片描述"></p> 
<ul><li>消费者</li></ul> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @author Crazy.X
 * sql过滤-消费者
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SqlFilterConsumer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 实例化消息消费者,指定组名</span>
        <span class="token class-name">DefaultMQPushConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">"SqlFilterConsumer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置NameServer的地址</span>
        consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Don't forget to set enablePropertyFilter=true in broker</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"SqlFilterTest"</span><span class="token punctuation">,</span>
                <span class="token class-name">MessageSelector</span><span class="token punctuation">.</span><span class="token function">bySql</span><span class="token punctuation">(</span><span class="token string">"(TAGS is not null and TAGS in ('TagA', 'TagB'))"</span> <span class="token operator">+</span>
                        <span class="token string">"and (a is not null and a between 0 and 3)"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>msgs<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MessageExt</span> msg <span class="token operator">:</span> msgs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">String</span> topic <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> msgBody <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> msgPro <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token class-name">String</span> tags <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"收到消息："</span> <span class="token operator">+</span> <span class="token string">" topic :"</span> <span class="token operator">+</span> topic <span class="token operator">+</span> <span class="token string">" ,tags : "</span> <span class="token operator">+</span> tags <span class="token operator">+</span> <span class="token string">" ,a : "</span> <span class="token operator">+</span> msgPro <span class="token operator">+</span> <span class="token string">" ,msg : "</span> <span class="token operator">+</span> msgBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span>RECONSUME_LATER<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span>CONSUME_SUCCESS<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Consumer Started.%n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/3b/4c/EF3x8teQ_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="58__1852"></a>5.8 事务消息</h4> 
<p><img src="https://images2.imgbox.com/84/c1/9sI3sVSD_o.png" alt="在这里插入图片描述"></p> 
<p>其中分为两个流程：正常事务消息的发送及提交、事务消息的补偿流程。</p> 
<h5><a id="581__1858"></a>5.8.1 正常事务流程</h5> 
<p>(1) 发送消息（half 消息）：图中步骤 1。</p> 
<p>(2) 服务端响应消息写入结果：图中步骤 2。</p> 
<p>(3) 根据发送结果执行本地事务（如果写入失败，此时 half 消息对业务不可见，本地逻辑不执行）：图中步骤 3。</p> 
<p>(4) 根据本地事务状态执行 Commit 或者 Rollback（Commit 操作生成消息索引，消息对消费者可见）：图中步骤 4</p> 
<h5><a id="582__1868"></a>5.8.2 事务补偿流程</h5> 
<p>(1) 对没有 Commit/Rollback 的事务消息（pending 状态的消息），从服务端发起一次“回查”：图中步骤 5。</p> 
<p>(2) Producer 收到回查消息，检查回查消息对应的本地事务的状态：图中步骤 6。</p> 
<p>(3) 根据本地事务状态，重新 Commit 或者 Rollback：：图中步骤 6。</p> 
<p>其中，补偿阶段用于解决消息 Commit 或者 Rollback 发生超时或者失败的情况。</p> 
<h5><a id="583__1878"></a>5.8.3 事务消息状态</h5> 
<p>事务消息共有三种状态，提交状态、回滚状态、中间状态：</p> 
<ul><li>TransactionStatus.CommitTransaction: 提交状态，它允许消费者消费此消息（完成图中了 1，2,3,4 步，第 4 步是 Commit）。</li><li>TransactionStatus.RollbackTransaction: 回滚状态，它代表该消息将被删除，不允许被消费（完成图中了 1，2,3,4 步, 第 4 步是 Rollback）。</li><li>ransactionStatus.Unknown: 中间状态，它代表需要检查消息队列来确定状态（完成图中了 1，2,3 步, 但是没有 4 或者没有 7，无法 Commit</li></ul> 
<h5><a id="584__1886"></a>5.8.4 创建事务性生产者</h5> 
<p>使用 TransactionMQProducer 类创建生产者，并指定唯一的 ProducerGroup，就可以设置自定义线程池来处理这些检查请求。执行本地事务后、需<br> 要根据执行结果对消息队列进行回复</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @author Crazy.X
 * 事务消息-消息发送方
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransactionProducer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MQClientException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 创建事务监听器</span>
        <span class="token class-name">TransactionListener</span> transactionListener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransactionListenerImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建消息生产者</span>
        <span class="token class-name">TransactionMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransactionMQProducer</span><span class="token punctuation">(</span><span class="token string">"TransactionProducer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置NameServer的地址</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建线程池</span>
        <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>
                <span class="token number">2</span><span class="token punctuation">,</span>
                <span class="token number">5</span><span class="token punctuation">,</span>
                <span class="token number">100</span><span class="token punctuation">,</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            thread<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"client-transaction-msg-check-thread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> thread<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置生产者回查线程池</span>
        producer<span class="token punctuation">.</span><span class="token function">setExecutorService</span><span class="token punctuation">(</span>executorService<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 生产者设置监听器</span>
        producer<span class="token punctuation">.</span><span class="token function">setTransactionListener</span><span class="token punctuation">(</span>transactionListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 启动消息生产者</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tags <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span><span class="token string">"TagA"</span><span class="token punctuation">,</span> <span class="token string">"TagB"</span><span class="token punctuation">,</span> <span class="token string">"TagC"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Message</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span>
                        <span class="token string">"TransactionTopic"</span><span class="token punctuation">,</span>
                        tags<span class="token punctuation">[</span>i <span class="token operator">%</span> tags<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">,</span>
                        <span class="token string">"KEY"</span> <span class="token operator">+</span> i<span class="token punctuation">,</span>
                        <span class="token punctuation">(</span><span class="token string">"Hello RocketMQ "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">RemotingHelper</span><span class="token punctuation">.</span>DEFAULT_CHARSET<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//1,2步  半事务的发送，确认。</span>
                <span class="token class-name">SendResult</span> sendResult <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">sendMessageInTransaction</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s%n"</span><span class="token punctuation">,</span> sendResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MQClientException</span> <span class="token operator">|</span> <span class="token class-name">UnsupportedEncodingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="585__1946"></a>5.8.5 实现事务的监听接口</h5> 
<p>当发送半消息成功时，我们使用 executeLocalTransaction 方法来执行本地事务（<strong>步骤 3</strong>）。它返回前一节中提到的三个事务状态之一。<br> checkLocalTranscation 方法用于检查本地事务状态（<strong>步骤 5</strong>），并回应消息队列的检查请求。它也是返回前一节中提到的三个事务状态之一。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransactionListenerImpl</span> <span class="token keyword">implements</span> <span class="token class-name">TransactionListener</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 事务状态记录</span>
    <span class="token keyword">private</span> <span class="token class-name">AtomicInteger</span> transactionIndex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> localTrans <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//执行本地事务 3</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">LocalTransactionState</span> <span class="token function">executeLocalTransaction</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">,</span> <span class="token class-name">Object</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"执行本地事务"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> value <span class="token operator">=</span> transactionIndex<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//0,1,2</span>
        <span class="token keyword">int</span> status <span class="token operator">=</span> value <span class="token operator">%</span> <span class="token number">3</span><span class="token punctuation">;</span>
        localTrans<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getTransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//这里模拟的不进行步骤4  A系统不知道的--UNKNOW</span>
        <span class="token keyword">return</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span>UNKNOW<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//检查本地事务状态  默认是60s，一分钟检查一次</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">LocalTransactionState</span> <span class="token function">checkLocalTransaction</span><span class="token punctuation">(</span><span class="token class-name">MessageExt</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//打印每次回查的时间</span>
        <span class="token class-name">SimpleDateFormat</span> df <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">"yyyy-MM-dd HH:mm:ss"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置日期格式</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"checkLocalTransaction:"</span> <span class="token operator">+</span> df<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// new Date()为获取当前系统时间</span>
        <span class="token class-name">Integer</span> status <span class="token operator">=</span> localTrans<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getTransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> status<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"MQ检查消息【"</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span><span class="token function">getTransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"】事务状态【中间状态】"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span>UNKNOW<span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"MQ检查消息【"</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span><span class="token function">getTransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"】事务状态【提交状态】"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span>COMMIT_MESSAGE<span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"MQ检查消息【"</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span><span class="token function">getTransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"】事务状态【回滚状态】"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span>ROLLBACK_MESSAGE<span class="token punctuation">;</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"MQ检查消息【"</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span><span class="token function">getTransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"】事务状态【提交状态】"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span>COMMIT_MESSAGE<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//  System.out.println("MQ检查消息【"+msg.getTransactionId()+"】事务状态【提交状态】");</span>
        <span class="token keyword">return</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span>COMMIT_MESSAGE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="586__2000"></a>5.8.6 消息消费者</h5> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @author Crazy.X
 * 事务消息-消费者
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransactionalConsumer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 实例化消息生产者,指定组名</span>
        <span class="token class-name">DefaultMQPushConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">"TransactionalConsumer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置NameServer的地址</span>
        consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 订阅Topic</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"TransactionTopic"</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//负载均衡模式消费</span>
        consumer<span class="token punctuation">.</span><span class="token function">setMessageModel</span><span class="token punctuation">(</span><span class="token class-name">MessageModel</span><span class="token punctuation">.</span>CLUSTERING<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 注册回调函数，处理消息</span>
        consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>msgs<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MessageExt</span> msg <span class="token operator">:</span> msgs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">String</span> topic <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> msgBody <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> msgPro <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token class-name">String</span> tags <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"收到消息："</span> <span class="token operator">+</span> <span class="token string">" topic :"</span> <span class="token operator">+</span> topic <span class="token operator">+</span> <span class="token string">" ,tags : "</span> <span class="token operator">+</span> tags <span class="token operator">+</span> <span class="token string">" ,a : "</span> <span class="token operator">+</span> msgPro <span class="token operator">+</span> <span class="token string">" ,msg : "</span> <span class="token operator">+</span> msgBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span>RECONSUME_LATER<span class="token punctuation">;</span>

            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span>CONSUME_SUCCESS<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//启动消息者</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Consumer Started.%n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="587__2042"></a>5.8.7 使用场景</h5> 
<p>用户提交订单后，扣减库存成功、扣减优惠券成功、使用余额成功，但是在确认订单操作失败，需要对库存、库存、余额进行回退。如何保证数据<br> 的完整性？</p> 
<p>可以使用 RocketMQ 的分布式事务保证在下单失败后系统数据的完整性</p> 
<h5><a id="588__2049"></a>5.8.8 使用限制</h5> 
<ol><li>事务消息不支持延时消息和批量消息。</li><li>事务回查的间隔时间：BrokerConfig. transactionCheckInterval 通过 Broker 的配置文件设置好。3. 为了避免单个消息被检查太多次而导致半队列消息累积，我们默认将单个消息的检查次数限制为 15 次，但是用户可以通过 Broker 配置文件的<br> transactionCheckMax 参数来修改此限制。如果已经检查某条消息超过 N 次的话（ N = transactionCheckMax ） 则 Broker 将丢弃此消息，并在默认<br> 情况下同时打印错误日志。用户可以通过重写 AbstractTransactionCheckListener 类来修改这个行为。</li><li>事务消息将在 Broker 配置文件中的参数 transactionMsgTimeout 这样的特定时间长度之后被检查。当发送事务消息时，用户还可以通过设置用<br> 户属性 CHECK_IMMUNITY_TIME_IN_SECONDS 来改变这个限制，该参数优先于 transactionMsgTimeout 参数。</li><li>事务性消息可能不止一次被检查或消费。</li><li>事务性消息中用到了生产者群组，这种就是一种高可用机制，用来确保事务消息的可靠性。</li><li>提交给用户的目标主题消息可能会失败，目前这依日志的记录而定。它的高可用性通过 RocketMQ 本身的高可用性机制来保证，如果希望确保事<br> 务消息不丢失、并且事务完整性得到保证，建议使用同步的双重写入机制。</li><li>事务消息的生产者 ID 不能与其他类型消息的生产者 ID 共享。与其他类型的消息不同，事务消息允许反向查询、MQ 服务器能通过它们的生产者<br> ID 查询到消费者。[toc]</li></ol> 
<h3><a id="_MQ_2064"></a>一 MQ的安装</h3> 
<h4><a id="11__2066"></a>1.1 官方地址下载</h4> 
<p>使用最新的4.8的版本。</p> 
<p>http://rocketmq.apache.org/dowloading/releases/</p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-VPRKrBLA-1625329015934)(845B800DD1ED4CBD85B5F4A99AFB47FA)]</p> 
<h4><a id="12__2074"></a>1.2 环境需要</h4> 
<ul><li>Linux 64位系统</li><li>Jdk 1.8</li><li>建议安装目录在/opt/建立rocketMq文件夹</li><li><mark>注：源码安装需要Maven。运行版本不需要</mark></li></ul> 
<h4><a id="13__2081"></a>1.3 注意事项</h4> 
<p>假设服务的外网IP地址：192.168.56.101 虚拟机的话就是本机IP 主机和虚拟机之间需要ping通</p> 
<h5><a id="131_linux_2086"></a>1.3.1 需要关闭虚拟机linux防火墙</h5> 
<p><mark>互相ping不同 未关闭防火墙 可能导致连接失败,无法生产消息</mark></p> 
<pre><code class="prism language-shell">systemctl stop firewalld
</code></pre> 
<h5><a id="132__2094"></a>1.3.2 主机防火墙</h5> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-QEziWjBL-1625329015935)(EAD5477012344AFEA89AFC7C2D22E2E2)]</p> 
<h4><a id="14__2099"></a>1.4 配置项</h4> 
<p>RocketMQ默认的虚拟机内存较大，启动Broker如果因为内存不足失败，需要编辑如下两个配置文件，修改JVM内存大小。</p> 
<p><mark>但是这个也仅仅是在测试环境中，RocketMQ在生产上最低要求至少8G内存（官方推荐）才能确保RocketMQ的效果</mark></p> 
<p>编辑 runbroker.sh 和 runserver.sh修改默认JVM大小（windows上对应cmd文件）</p> 
<h5><a id="141_broker__2107"></a>1.4.1 broker 配置</h5> 
<p>/bin目录下</p> 
<pre><code class="prism language-shell"><span class="token function">vim</span> runbroker.sh

<span class="token assign-left variable">JAVA_OPT</span><span class="token operator">=</span><span class="token string">"<span class="token variable">${JAVA_OPT}</span> -server -Xms1024m -Xmx1024m -Xmn512m -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=320m"</span>
</code></pre> 
<h5><a id="142_nameServer__2117"></a>1.4.2 nameServer 配置</h5> 
<p>/bin目录下</p> 
<pre><code class="prism language-shell"><span class="token function">vim</span> runserver.sh

<span class="token assign-left variable">JAVA_OPT</span><span class="token operator">=</span><span class="token string">"<span class="token variable">${JAVA_OPT}</span> -server -Xms4g -Xmx4g -Xmn2g -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=320m"</span>
choose_gc_options

</code></pre> 
<h4><a id="15__NameServer_2129"></a>1.5 启动 NameServer</h4> 
<pre><code class="prism language-shell"><span class="token comment"># 进入mq bin目录</span>
<span class="token builtin class-name">cd</span> /opt/bin

<span class="token comment"># 启动nameserver</span>
<span class="token function">nohup</span> <span class="token function">sh</span> mqnamesrv <span class="token operator">&amp;</span>

<span class="token comment"># 查看日志 会在~目录下有logs 日志路径可修改</span>
<span class="token function">tail</span> -200f ~/logs/rocketmqlogs/namesrv.log
</code></pre> 
<h5><a id="151_NameServer__2142"></a>1.5.1 NameServer 日志</h5> 
<pre><code class="prism language-text">2021-07-03 03:16:42 INFO main - rocketmqHome=/opt/rocketmq
2021-07-03 03:16:42 INFO main - kvConfigPath=/root/namesrv/kvConfig.json
2021-07-03 03:16:42 INFO main - configStorePath=/root/namesrv/namesrv.properties
2021-07-03 03:16:42 INFO main - productEnvName=center
2021-07-03 03:16:42 INFO main - clusterTest=false
2021-07-03 03:16:42 INFO main - orderMessageEnable=false
2021-07-03 03:16:42 INFO main - listenPort=9876
2021-07-03 03:16:42 INFO main - serverWorkerThreads=8
2021-07-03 03:16:42 INFO main - serverCallbackExecutorThreads=0
2021-07-03 03:16:42 INFO main - serverSelectorThreads=3
2021-07-03 03:16:42 INFO main - serverOnewaySemaphoreValue=256
2021-07-03 03:16:42 INFO main - serverAsyncSemaphoreValue=64
2021-07-03 03:16:42 INFO main - serverChannelMaxIdleTimeSeconds=120
2021-07-03 03:16:42 INFO main - serverSocketSndBufSize=65535
2021-07-03 03:16:42 INFO main - serverSocketRcvBufSize=65535
2021-07-03 03:16:42 INFO main - serverPooledByteBufAllocatorEnable=true
2021-07-03 03:16:42 INFO main - useEpollNativeSelector=false
2021-07-03 03:16:42 INFO main - Server is running in TLS permissive mode
2021-07-03 03:16:42 INFO main - Tls config file doesn't exist, skip it
2021-07-03 03:16:42 INFO main - Log the final used tls related configuration
2021-07-03 03:16:42 INFO main - tls.test.mode.enable = true
2021-07-03 03:16:42 INFO main - tls.server.need.client.auth = none
2021-07-03 03:16:42 INFO main - tls.server.keyPath = null
2021-07-03 03:16:42 INFO main - tls.server.keyPassword = null
2021-07-03 03:16:42 INFO main - tls.server.certPath = null
2021-07-03 03:16:42 INFO main - tls.server.authClient = false
2021-07-03 03:16:42 INFO main - tls.server.trustCertPath = null
2021-07-03 03:16:42 INFO main - tls.client.keyPath = null
2021-07-03 03:16:42 INFO main - tls.client.keyPassword = null
2021-07-03 03:16:42 INFO main - tls.client.certPath = null
2021-07-03 03:16:42 INFO main - tls.client.authServer = false
2021-07-03 03:16:42 INFO main - tls.client.trustCertPath = null
2021-07-03 03:16:42 INFO main - Using OpenSSL provider
2021-07-03 03:16:43 INFO main - SSLContext created for server
2021-07-03 03:16:43 INFO main - Try to start service thread:FileWatchService started:false lastThread:null
2021-07-03 03:16:43 INFO NettyEventExecutor - NettyEventExecutor service started

# 容器已经启动
2021-07-03 03:16:43 INFO main - The Name Server boot success. serializeType=JSON
2021-07-03 03:16:43 INFO FileWatchService - FileWatchService service started
2021-07-03 03:17:43 INFO NSScheduledThread1 - --------------------------------------------------------
2021-07-03 03:17:43 INFO NSScheduledThread1 - configTable SIZE: 0
</code></pre> 
<h4><a id="16__Broker_2189"></a>1.6 启动 Broker</h4> 
<p>修改配置文件增加外网地址(你启动加载哪个配置文件就修改哪个，这里修改broker.conf)</p> 
<pre><code class="prism language-conf">brokerClusterName = DefaultCluster
brokerName = broker-a
brokerId = 0
deleteWhen = 04
fileReservedTime = 48
brokerRole = ASYNC_MASTER
flushDiskType = ASYNC_FLUSH
# 公网ip 虚拟机的话就是虚拟机机ip 本机可以ping通 
brokerIP1=192.168.3.200
# nameserver地址
namesrvAddr=192.168.3.200:9876
</code></pre> 
<pre><code class="prism language-shell"><span class="token comment"># 进入mq bin目录</span>
<span class="token builtin class-name">cd</span> /opt/bin

<span class="token comment"># 启动broker -n 指定namever地址 conf文件配置后可以不指定，通过配置文件配置</span>
<span class="token comment"># autoCreateTopicEnable=true 这样启动的服务器可以自动创建主题（客户端）,不过生产一般不推荐。</span>
<span class="token function">nohup</span> <span class="token function">sh</span> mqbroker -c <span class="token punctuation">..</span>/conf/broker.conf -n <span class="token number">192.168</span>.3.200:9876 <span class="token assign-left variable">autoCreateTopicEnable</span><span class="token operator">=</span>true <span class="token operator">&amp;</span>

<span class="token comment"># 查看日志 会在~目录下有logs 日志路径可修改</span>
<span class="token function">tail</span> -200f ~/logs/rocketmqlogs/broker.log
</code></pre> 
<ul><li>可能发生的问题</li></ul> 
<pre><code class="prism language-shell"><span class="token comment"># /root/store/ 没有commitlog文件夹 创建即可</span>
<span class="token number">2021</span>-07-03 03:27:38 ERROR DiskCheckScheduledThread1 - Error when measuring disk space usage, <span class="token function">file</span> doesn<span class="token string">'t exist on this path: /root/store/commitlog

# /root/store/ 没有consumequeue文件夹 创建即可
Error when measuring disk space usage, file doesn'</span>t exist on this path: /root/store/consumequeue
</code></pre> 
<h5><a id="161_Broker__2228"></a>1.6.1 Broker 日志</h5> 
<pre><code class="prism language-shell"> <span class="token punctuation">[</span>topicName<span class="token operator">=</span>SCHEDULE_TOPIC_XXXX, <span class="token assign-left variable">readQueueNums</span><span class="token operator">=</span><span class="token number">18</span>, <span class="token assign-left variable">writeQueueNums</span><span class="token operator">=</span><span class="token number">18</span>, <span class="token assign-left variable">perm</span><span class="token operator">=</span>RW-, <span class="token assign-left variable">topicFilterType</span><span class="token operator">=</span>SINGLE_TAG, <span class="token assign-left variable">topicSysFlag</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">order</span><span class="token operator">=</span>false<span class="token punctuation">]</span>
<span class="token number">2021</span>-07-03 03:29:51 INFO main - load exist <span class="token builtin class-name">local</span> topic, TopicConfig <span class="token punctuation">[</span>topicName<span class="token operator">=</span>RMQ_SYS_TRANS_HALF_TOPIC, <span class="token assign-left variable">readQueueNums</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">writeQueueNums</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">perm</span><span class="token operator">=</span>RW-, <span class="token assign-left variable">topicFilterType</span><span class="token operator">=</span>SINGLE_TAG, <span class="token assign-left variable">topicSysFlag</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">order</span><span class="token operator">=</span>false<span class="token punctuation">]</span>
<span class="token number">2021</span>-07-03 03:29:51 INFO main - load exist <span class="token builtin class-name">local</span> topic, TopicConfig <span class="token punctuation">[</span>topicName<span class="token operator">=</span>DefaultCluster_REPLY_TOPIC, <span class="token assign-left variable">readQueueNums</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">writeQueueNums</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">perm</span><span class="token operator">=</span>RW-, <span class="token assign-left variable">topicFilterType</span><span class="token operator">=</span>SINGLE_TAG, <span class="token assign-left variable">topicSysFlag</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">order</span><span class="token operator">=</span>false<span class="token punctuation">]</span>
<span class="token number">2021</span>-07-03 03:29:51 INFO main - load exist <span class="token builtin class-name">local</span> topic, TopicConfig <span class="token punctuation">[</span>topicName<span class="token operator">=</span>BenchmarkTest, <span class="token assign-left variable">readQueueNums</span><span class="token operator">=</span><span class="token number">1024</span>, <span class="token assign-left variable">writeQueueNums</span><span class="token operator">=</span><span class="token number">1024</span>, <span class="token assign-left variable">perm</span><span class="token operator">=</span>RW-, <span class="token assign-left variable">topicFilterType</span><span class="token operator">=</span>SINGLE_TAG, <span class="token assign-left variable">topicSysFlag</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">order</span><span class="token operator">=</span>false<span class="token punctuation">]</span>
<span class="token number">2021</span>-07-03 03:29:51 INFO main - load exist <span class="token builtin class-name">local</span> topic, TopicConfig <span class="token punctuation">[</span>topicName<span class="token operator">=</span>OFFSET_MOVED_EVENT, <span class="token assign-left variable">readQueueNums</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">writeQueueNums</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">perm</span><span class="token operator">=</span>RW-, <span class="token assign-left variable">topicFilterType</span><span class="token operator">=</span>SINGLE_TAG, <span class="token assign-left variable">topicSysFlag</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">order</span><span class="token operator">=</span>false<span class="token punctuation">]</span>
<span class="token number">2021</span>-07-03 03:29:51 INFO main - load exist <span class="token builtin class-name">local</span> topic, TopicConfig <span class="token punctuation">[</span>topicName<span class="token operator">=</span>broker-a, <span class="token assign-left variable">readQueueNums</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">writeQueueNums</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">perm</span><span class="token operator">=</span>RWX, <span class="token assign-left variable">topicFilterType</span><span class="token operator">=</span>SINGLE_TAG, <span class="token assign-left variable">topicSysFlag</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">order</span><span class="token operator">=</span>false<span class="token punctuation">]</span>
<span class="token number">2021</span>-07-03 03:29:51 INFO main - load exist <span class="token builtin class-name">local</span> topic, TopicConfig <span class="token punctuation">[</span>topicName<span class="token operator">=</span>TBW102, <span class="token assign-left variable">readQueueNums</span><span class="token operator">=</span><span class="token number">8</span>, <span class="token assign-left variable">writeQueueNums</span><span class="token operator">=</span><span class="token number">8</span>, <span class="token assign-left variable">perm</span><span class="token operator">=</span>RWX, <span class="token assign-left variable">topicFilterType</span><span class="token operator">=</span>SINGLE_TAG, <span class="token assign-left variable">topicSysFlag</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">order</span><span class="token operator">=</span>false<span class="token punctuation">]</span>
<span class="token number">2021</span>-07-03 03:29:51 INFO main - load exist <span class="token builtin class-name">local</span> topic, TopicConfig <span class="token punctuation">[</span>topicName<span class="token operator">=</span>SELF_TEST_TOPIC, <span class="token assign-left variable">readQueueNums</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">writeQueueNums</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">perm</span><span class="token operator">=</span>RW-, <span class="token assign-left variable">topicFilterType</span><span class="token operator">=</span>SINGLE_TAG, <span class="token assign-left variable">topicSysFlag</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">order</span><span class="token operator">=</span>false<span class="token punctuation">]</span>
<span class="token number">2021</span>-07-03 03:29:51 INFO main - load exist <span class="token builtin class-name">local</span> topic, TopicConfig <span class="token punctuation">[</span>topicName<span class="token operator">=</span>DefaultCluster, <span class="token assign-left variable">readQueueNums</span><span class="token operator">=</span><span class="token number">16</span>, <span class="token assign-left variable">writeQueueNums</span><span class="token operator">=</span><span class="token number">16</span>, <span class="token assign-left variable">perm</span><span class="token operator">=</span>RWX, <span class="token assign-left variable">topicFilterType</span><span class="token operator">=</span>SINGLE_TAG, <span class="token assign-left variable">topicSysFlag</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">order</span><span class="token operator">=</span>false<span class="token punctuation">]</span>
<span class="token number">2021</span>-07-03 03:29:51 INFO main - load /root/store/config/topics.json OK
<span class="token number">2021</span>-07-03 03:29:51 INFO main - load /root/store/config/consumerOffset.json OK
<span class="token number">2021</span>-07-03 03:29:51 INFO main - load /root/store/config/consumerFilter.json OK
<span class="token number">2021</span>-07-03 03:29:51 INFO main - Try to start <span class="token function">service</span> thread:AllocateMappedFileService started:false lastThread:null
<span class="token number">2021</span>-07-03 03:29:51 INFO main - load /root/store/config/delayOffset.json OK
<span class="token number">2021</span>-07-03 03:29:52 INFO main - Set user specified name server address: <span class="token number">192.168</span>.3.200:9876
<span class="token number">2021</span>-07-03 03:29:52 WARN main - Load default transaction message hook service: TransactionalMessageServiceImpl
<span class="token number">2021</span>-07-03 03:29:52 WARN main - Load default discard message hook service: DefaultTransactionalMessageCheckListener
<span class="token number">2021</span>-07-03 03:29:52 INFO main - The broker dose not <span class="token builtin class-name">enable</span> acl
<span class="token number">2021</span>-07-03 03:29:52 INFO main - Try to start <span class="token function">service</span> thread:ReputMessageService started:false lastThread:null
<span class="token number">2021</span>-07-03 03:29:52 INFO main - Try to start <span class="token function">service</span> thread:AcceptSocketService started:false lastThread:null
<span class="token number">2021</span>-07-03 03:29:52 INFO main - Try to start <span class="token function">service</span> thread:GroupTransferService started:false lastThread:null
<span class="token number">2021</span>-07-03 03:29:52 INFO main - Try to start <span class="token function">service</span> thread:HAClient started:false lastThread:null
<span class="token number">2021</span>-07-03 03:29:52 INFO main - Try to start <span class="token function">service</span> thread:FlushConsumeQueueService started:false lastThread:null
<span class="token number">2021</span>-07-03 03:29:52 INFO main - Try to start <span class="token function">service</span> thread:FlushRealTimeService started:false lastThread:null
<span class="token number">2021</span>-07-03 03:29:52 INFO main - Try to start <span class="token function">service</span> thread:StoreStatsService started:false lastThread:null
<span class="token number">2021</span>-07-03 03:29:52 INFO main - Try to start <span class="token function">service</span> thread:FileWatchService started:false lastThread:null
<span class="token number">2021</span>-07-03 03:29:52 INFO main - Try to start <span class="token function">service</span> thread:PullRequestHoldService started:false lastThread:null
<span class="token number">2021</span>-07-03 03:29:52 INFO FileWatchService - FileWatchService <span class="token function">service</span> started
<span class="token number">2021</span>-07-03 03:29:52 INFO PullRequestHoldService - PullRequestHoldService <span class="token function">service</span> started
<span class="token number">2021</span>-07-03 03:29:52 INFO main - Try to start <span class="token function">service</span> thread:TransactionalMessageCheckService started:false lastThread:null

<span class="token comment"># 注册成功</span>
<span class="token number">2021</span>-07-03 03:29:52 INFO brokerOutApi_thread_1 - register broker<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>to name server <span class="token number">192.168</span>.3.200:9876 OK

<span class="token comment"># 启动成功</span>
<span class="token number">2021</span>-07-03 03:29:52 INFO main - The broker<span class="token punctuation">[</span>broker-a, <span class="token number">192.168</span>.3.200:10911<span class="token punctuation">]</span> boot success. <span class="token assign-left variable">serializeType</span><span class="token operator">=</span>JSON and name server is <span class="token number">192.168</span>.3.200:9876
<span class="token number">2021</span>-07-03 03:30:02 INFO BrokerControllerScheduledThread1 - dispatch behind commit log <span class="token number">0</span> bytes
<span class="token number">2021</span>-07-03 03:30:02 INFO BrokerControllerScheduledThread1 - Slave fall behind master: <span class="token number">0</span> bytes

</code></pre> 
<pre><code class="prism language-text"># nameserver 日志会出现 新broker 注册
2021-07-03 03:29:52 INFO RemotingExecutorThread_4 - new broker registered, 192.168.3.200:10911 HAServer: 172.17.0.1:10912

</code></pre> 
<h4><a id="17__rocketmqconsole_2278"></a>1.7 安装可视化 rocketmq-console</h4> 
<h5><a id="171__rocketmqconsole_2280"></a>1.7.1 下载 rocketmq-console</h5> 
<p>运行前确保：已经有jdk1.8，Maven(打包需要安装Maven 3.2.x)</p> 
<p>下载：https://codeload.github.com/apache/rocketmq-externals/zip/master</p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-9sbOoIc6-1625329015936)(18778333602946D18F3A534BD7A3375D)]</p> 
<p>这个包主要包含的是Message Connector，具体详情见 https://rocketmq-1.gitbook.io/rocketmq-connector/</p> 
<p>里面后端管理界面是：rocketmq-console</p> 
<h5><a id="172__rocketmqconsole__2291"></a>1.7.2 编辑 rocketmq-console 配置文件</h5> 
<p>下载完成之后，进入‘\rocketmq-console\src\main\resources’文件夹，打开‘application.properties’进行配置。</p> 
<pre><code class="prism language-properties"># 服务器地址
server.address=192.168.3.200
# 控制台端口
server.port=8089

### SSL setting
#server.ssl.key-store=classpath:rmqcngkeystore.jks
#server.ssl.key-store-password=rocketmq
#server.ssl.keyStoreType=PKCS12
#server.ssl.keyAlias=rmqcngkey

#spring.application.index=true
spring.application.name=rocketmq-console
spring.http.encoding.charset=UTF-8
spring.http.encoding.enabled=true
spring.http.encoding.force=true
logging.level.root=INFO
logging.config=classpath:logback.xml
#if this value is empty,use env value rocketmq.config.namesrvAddr  NAMESRV_ADDR | now, you can set it in ops page.default localhost:9876

# nameserver地址 默认端口9876
rocketmq.config.namesrvAddr=192.168.3.200:9876
#if you use rocketmq version &lt; 3.5.8, rocketmq.config.isVIPChannel should be false.default true
rocketmq.config.isVIPChannel=
#rocketmq-console's data path:dashboard/monitor
rocketmq.config.dataPath=/tmp/rocketmq-console/data
#set it false if you don't want use dashboard.default true
rocketmq.config.enableDashBoardCollect=true
#set the message track trace topic if you don't want use the default one
rocketmq.config.msgTrackTopicName=
rocketmq.config.ticketKey=ticket

#Must create userInfo file: ${rocketmq.config.dataPath}/users.properties if the login is required
rocketmq.config.loginRequired=false

#set the accessKey and secretKey if you used acl
#rocketmq.config.accessKey=
#rocketmq.config.secretKey=
</code></pre> 
<p>进入\rocketmq-externals\rocketmq-console文件夹</p> 
<p>执行mvn clean package -Dmaven.test.skip=true 编译生成可执行jar包</p> 
<p>建议放入/opt/建立文件夹</p> 
<h5><a id="173__rocketmqconsole_2342"></a>1.7.3 启动 rocketmq-console</h5> 
<pre><code class="prism language-shell"><span class="token comment"># 启动可视化 可指定内存大小</span>
<span class="token function">nohup</span> java -jar -Xms128m -Xmx256m rocketmq-console-ng-2.0.0.jar <span class="token operator">&amp;</span>
</code></pre> 
<h5><a id="174_rocketmqconsole__2349"></a>1.7.4 rocketmq-console 日志</h5> 
<pre><code class="prism language-shell">  <span class="token builtin class-name">.</span>   ____          _            __ _ _
 /<span class="token punctuation">\</span><span class="token punctuation">\</span> / ___<span class="token string">'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '</span>_ <span class="token operator">|</span> <span class="token string">'_| | '</span>_ <span class="token punctuation">\</span>/ _` <span class="token operator">|</span> <span class="token punctuation">\</span> <span class="token punctuation">\</span> <span class="token punctuation">\</span> <span class="token punctuation">\</span>
 <span class="token punctuation">\</span><span class="token punctuation">\</span>/  ___<span class="token punctuation">)</span><span class="token operator">|</span> <span class="token operator">|</span>_<span class="token punctuation">)</span><span class="token operator">|</span> <span class="token operator">|</span> <span class="token operator">|</span> <span class="token operator">|</span> <span class="token operator">|</span> <span class="token operator">||</span> <span class="token punctuation">(</span>_<span class="token operator">|</span> <span class="token operator">|</span>  <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span>
  <span class="token string">'  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/
 :: Spring Boot ::        (v2.2.2.RELEASE)

[2021-07-03 03:41:10.868]  INFO Starting App v2.0.0 on localhost with PID 29113 (/opt/rocketmq-console/rocketmq-console-ng-2.0.0.jar started by root in /opt/rocketmq-console)
[2021-07-03 03:41:10.869]  INFO No active profile set, falling back to default profiles: default
[2021-07-03 03:41:13.198]  INFO setNameSrvAddrByProperty nameSrvAddr=192.168.3.200:9876
[2021-07-03 03:41:13.694]  INFO Tomcat initialized with port(s): 8089 (http)
[2021-07-03 03:41:13.708]  INFO Initializing ProtocolHandler ["http-nio-192.168.3.200-8089"]
[2021-07-03 03:41:13.709]  INFO Starting service [Tomcat]
[2021-07-03 03:41:13.709]  INFO Starting Servlet engine: [Apache Tomcat/9.0.29]
[2021-07-03 03:41:13.908]  INFO Initializing Spring embedded WebApplicationContext
[2021-07-03 03:41:13.909]  INFO Root WebApplicationContext: initialization completed in 2811 ms
[2021-07-03 03:41:15.166]  INFO Initializing ExecutorService '</span>applicationTaskExecutor<span class="token string">'
[2021-07-03 03:41:15.350]  INFO Adding welcome page: class path resource [static/index.html]
[2021-07-03 03:41:15.563]  INFO Initializing ExecutorService '</span>taskScheduler<span class="token string">'
[2021-07-03 03:41:15.584]  INFO Exposing 2 endpoint(s) beneath base path '</span>/actuator<span class="token string">'
[2021-07-03 03:41:15.656]  INFO Starting ProtocolHandler ["http-nio-192.168.3.200-8089"]
[2021-07-03 03:41:15.692]  INFO Tomcat started on port(s): 8089 (http) with context path '</span>'
<span class="token punctuation">[</span><span class="token number">2021</span>-07-03 03:41:15.697<span class="token punctuation">]</span>  INFO Started App <span class="token keyword">in</span> <span class="token number">5.735</span> seconds <span class="token punctuation">(</span>JVM running <span class="token keyword">for</span> <span class="token number">6.688</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="173__2378"></a>1.7.3 访问可视化</h5> 
<p>浏览器输入 192.168.3.200:8089 查看</p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-beesUikZ-1625329015937)(32DC3C51C2384D34AA41FCAA1AF08F19)]</p> 
<h3><a id="__2385"></a>二 基础入门</h3> 
<p>有需要其他介绍请参阅：<br> <a href="https://rocketmq.apache.org/docs/quick-start/" rel="nofollow">rocketMQ官方文档</a></p> 
<h4><a id="21_MQ_2388"></a>2.1 MQ的定义</h4> 
<p>其实并没有标准定义。一般认为，消息中间件属于分布式系统中一个子系统，关注于数据的发送和接收，利用高效可靠的异步消息传递机制对分布<br> 式系统中的其余各个子系统进行集成。</p> 
<ol><li><strong>高效</strong>：对于消息的处理处理速度快。</li><li><strong>可靠</strong>：一般消息中间件都会有消息持久化机制和其他的机制确保消息不丢失。</li><li><strong>异步</strong>：指发送完一个请求，不需要等待返回，随时可以再发送下一个请求，既不需要等待</li><li><strong>总结</strong>，<mark>我们消息中间件不生产消息，只是消息的搬运工。</mark></li></ol> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-3r97nWFx-1625329015937)(E2C045BFC5BF41E2B679BFD63D740350)]</p> 
<h4><a id="22__2400"></a>2.2 为什么要用消息中间件</h4> 
<h5><a id="221__2402"></a>2.2.1 应用解耦</h5> 
<p>系统的耦合性越高，容错性就越低。以电商应用为例，用户创建订单后，如果耦合调用库存系统、物流系统、支付系统，任何一个子系统出了故障或者<br> 因为升级等原因暂时不可用，都会造成下单操作异常，影响用户使用体验</p> 
<p>使用消息中间件，系统的耦合性就会提高了。比如物流系统发生故障，需要几分钟才能来修复，在这段时间内，物流系统要处理的数据被缓存到消息队<br> 列中，用户的下单操作正常完成。当物流系统恢复后，继续处理存放在消息队列中的订单消息即可，终端系统感知不到物流系统发生过几分钟故障。</p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-BR6aCFHZ-1625329015938)(F473FF79760A44748D7B2D334005CB38)]</p> 
<h5><a id="222__2412"></a>2.2.2 流量削峰</h5> 
<p>应用系统如果遇到系统请求流量的瞬间猛增，有可能会将系统压垮。有了消息队列可以将大量请求缓存起来，分散到很长一段时间处理，这样可以大大<br> 提到系统的稳定性和用户体验。</p> 
<p><strong>互联网公司的大促场景（双十一、店庆活动、秒杀活动）都会使用到 MQ</strong></p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-9Wv8EOCX-1625329015939)(D1D8FA759EC447E690620A81F51D47C5)]</p> 
<h5><a id="223__2421"></a>2.2.3 数据分发</h5> 
<p>通过消息队列可以让数据在多个系统更加之间进行流通。数据的产生方不需要关心谁来使用数据，只需要将数据发送到消息队列，数据使用方直接在消<br> 息队列中直接获取数据即可。</p> 
<p>接口调用的弊端，无论是新增系统，还是移除系统，代码改造工作量都很大。</p> 
<p>使用 MQ 做数据分发好处，无论是新增系统，还是移除系统，代码改造工作量较小。</p> 
<p>所以使用 MQ 做数据的分发，可以提高团队开发的效率</p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-90s6dGmd-1625329015940)(D9C3CFC2718D41449DEB5E6ACB48D3BE)]</p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-CLiAK4q2-1625329015940)(0B8C59349BFE4307BFB1C0E9FDD95C22)]</p> 
<h4><a id="23_RocketMQ__2436"></a>2.3 RocketMQ 产品发展</h4> 
<h5><a id="231_RocketMQ__2438"></a>2.3.1 RocketMQ 版本发展</h5> 
<p>Metaq1.x 是 RocketMQ 前身的第一个版本，本质上把 Kafka 做了一次 java 版本的重写（Kafka 是 sacla）</p> 
<p>Meta2.x，主要是对存储部分进行了优化，因为 kafka 的数据存储，它的 paration 是一个全量的复制，在阿里、在淘宝的这种海量交易。Kafka 这种<br> 机制的横向拓展是非常不好的。2012 年阿里同时把 Meta2.0 从阿里内部开源出来，取名 RocketMQ，同时为了命名上的规范（版本上延续），所以这个就<br> 是 RocketMQ3.0</p> 
<p>现在 RocketMQ 主要维护的是 4.x 的版本，也是大家使用得最多的版本，2017 年从 Apache 顶级项目毕</p> 
<h5><a id="232__2448"></a>2.3.2 阿里内部项目的使用</h5> 
<p>那么在阿里公司内部，原则上遵守开源共建原则。RocketMQ 项目只维护核心功能，且去除了所有其他运行时依赖，核心功能最简化。每个 BU<br> （ Business Unit 业务单元）的个性化需求都在 RocketMQ 项目之上进行深度定制。RocketMQ 向其他 BU 提供的仅仅是 Jar 包，例如要定制一个 Broker，<br> 那么只需要依赖 rocketmq-broker 这 jar 包即可，可通过 API 进行交互， 如果定制 client，则依赖 rocketmq-client 这个 jar 包，对其提供的 api 进行<br> 再封装</p> 
<p><strong>在 RocketMQ 项目基础上几个常用的项目如</strong>下</p> 
<ul><li>com.taobao.metaq v3.0 = RocketMQ + 淘宝个性化需求</li></ul> 
<p>为淘宝应用提供消息服务</p> 
<ul><li>com.alipay.zpullmsg v1.0 = RocketMQ + 支付宝个性化需求</li></ul> 
<p>为支付宝应用提供消息服务</p> 
<ul><li>com.alibaba.commonmq v1.0 = Notify + RocketMQ + B2B 个性化需求</li></ul> 
<p>为 B2B 应用提供消息服务</p> 
<h5><a id="233__2467"></a>2.3.3 展望未来</h5> 
<p>从阿里负责 RocketMQ 的架构核心人员的信息来看，阿里内部一直全力拓展 RocketMQ</p> 
<p>2017 年 10 月份，OpenMessaging 项目由阿里巴巴发起，与雅虎、滴滴出行、Streamlio 公司共同参与创立, 项目意在创立厂商无关、平台无关的分布<br> 式消息及流处理领域的应用开发标准。同时 OpenMessaging 入驻 Linux 基金会</p> 
<p>OpenMessaging 项目已经开始在 Apache RocketMQ 中率先落地，并推广至整个阿里云平台.</p> 
<p>另外 RocketMQ5 的版本也在内部推进，主要的方向是 Cloud Native(云原生)</p> 
<p><strong>另外 Apache RocketMQ 的商业版本，Aliware MQ</strong> 在微服务、流计算、IoT、异步解耦、数据同步等场景有非常广泛的运用</p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-6Gm54gNR-1625329015940)(9433EF6FA9124FA192DDB36C3543CC34)]</p> 
<h3><a id="_RocketMQ__2484"></a>三 RocketMQ 的物理架构</h3> 
<p>消息队列 RocketMQ 是阿里巴巴集团基于高可用分布式集群技术，自主研发的云正式商用的专业消息中间件，既可为分布式应用系统提供异步解耦<br> 和削峰填谷的能力，同时也具备互联网应用所需的海量消息堆积、高吞吐、可靠重试等特性，是阿里巴巴双 11 使用的核心产品。</p> 
<p>RocketMQ 的设计基于主题的发布与订阅模式，其核心功能包括消息发送、消息存储(Broker)、消息消费，整体设计追求简单与性能第一。</p> 
<h4><a id="31__2491"></a>3.1 核心概念</h4> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-3cR21OKf-1625329015941)(1A4F5708E8CA42DEB55FC369366EF867)]</p> 
<h5><a id="311_NameServer_2495"></a>3.1.1 NameServer</h5> 
<p>NameServer 是整个 RocketMQ 的“大脑”，它是 RocketMQ 的服务注册中心,所以 RocketMQ 需要先启动 NameServer 再启动 Rocket 中的 Broker。</p> 
<p>Broker 在启动时向所有 NameServer 注册（主要是服务器地址等），生产者在发送消息之前先从 NameServer 获取 Broker 服务器地址列表（消费者一<br> 样），然后根据负载均衡算法从列表中选择一台服务器进行消息发送。</p> 
<p>NameServer 与每台 Broker 服务保持长连接，并间隔 30s 检查 Broker 是否存活，如果检测到 Broker 宕机，则从路由注册表中将其移除。这样就可以实<br> 现 RocketMQ 的高可用。具体细节后续讲解</p> 
<h5><a id="312_Producer_2506"></a>3.1.2 生产者(Producer)</h5> 
<p><strong>生产者</strong>：也称为消息发布者，负责生产并发送消息至 RocketMQ。</p> 
<h5><a id="313__Consumer_2510"></a>3.1.3 消费者(Consumer)</h5> 
<p><strong>消费者</strong>：也称为消息订阅者，负责从 RocketMQ 接收并消费消息。</p> 
<h5><a id="314_Message_2514"></a>3.1.4 消息(Message)</h5> 
<p><strong>消息</strong>：生产或消费的数据，对于 RocketMQ 来说，消息就是字节数组。</p> 
<h5><a id="315_Broker_2518"></a>3.1.5 主机(Broker)</h5> 
<p>RocketMQ 的核心，用于暂存和传输消息。</p> 
<h4><a id="32__2522"></a>3.2 物理架构中的整体运转</h4> 
<ol><li>NameServer 先启动</li><li>Broker 启动时向 NameServer 注册</li><li>生产者在发送某个主题的消息之前先从 NamerServer 获取 Broker 服务器地址列表（有可能是集群），然后根据负载均衡算法从列表中选择一台<br> Broker 进行消息发送。</li><li>NameServer 与每台 Broker 服务器保持长连接，并间隔 30S 检测 Broker 是否存活，如果检测到 Broker 宕机（使用心跳机制，如果检测超过120S），则从路由注册表中将其移除。</li><li>消费者在订阅某个主题的消息之前从 NamerServer 获取 Broker 服务器地址列表（有可能是集群），但是消费者选择从 Broker 中订阅消息，订阅<br> 规则由 Broker 配置决定</li></ol> 
<h3><a id="_RocketMQ__2533"></a>四 RocketMQ 的概念模型</h3> 
<h4><a id="41__2535"></a>4.1 核心概念</h4> 
<h5><a id="411_Group_2537"></a>4.1.1 分组(Group)</h5> 
<p><strong>生产者</strong>：标识发送同一类消息的Producer，通常发送逻辑一致。发送普通消息的时候，仅标识使用，并无特别用处。<strong>主要作用用于事务消息</strong>：<br> （事务消息中如果某条发送某条消息的producer-A宕机，使得事务消息一直处于PREPARED状态并超时，则broker会回查同一个group的其它producer，<br> 确认这条消息应该 commit 还是 rollback）</p> 
<p><strong>消费者</strong>：标识一类 Consumer 的集合名称，这类 Consumer 通常消费一类消息，且消费逻辑一致。同一个 Consumer Group 下的各个实例将共同消费 topic<br> 的消息，起到负载均衡的作用。</p> 
<p>消费进度以 Consumer Group 为粒度管理，不同 Consumer Group 之间消费进度彼此不受影响，即消息 A 被 Consumer Group1 消费过，也会再给 Consumer<br> Group2 消费。</p> 
<h5><a id="412_Topic_2549"></a>4.1.2 主题(Topic)</h5> 
<p>标识一类消息的逻辑名字，消息的逻辑管理单位。无论消息生产还是消费，都需要指定 Topic。</p> 
<p>区分消息的种类；一个发送者可以发送消息给一个或者多个 Topic<br> 一个消息的接收者可以订阅一个或者多个 Topic 消息</p> 
<h5><a id="413_Tag_2555"></a>4.1.3 标签(Tag)</h5> 
<p>RocketMQ 支持给在发送的时候给 topic 打 tag，同一个 topic 的消息虽然逻辑管理是一样的。但是消费 topic1 的时候，如果你消费订阅的时候指定的<br> 是 tagA，那么 tagB 的消息将不会投递。</p> 
<h5><a id="414_Message_Queue_2559"></a>4.1.4 消息队列(Message Queue)</h5> 
<p>简称 Queue 或 Q。消息物理管理单位。一个 Topic 将有若干个 Q。若一个 Topic 创建在不同的 Broker，则不同的 broker 上都有若干 Q，消息将物理地<br> 存储落在不同 Broker 结点上，具有水平扩展的能力。<br> 无论生产者还是消费者，实际的生产和消费都是针对 Q 级别。例如 Producer 发送消息的时候，会预先选择（默认轮询）好该 Topic 下面的某一条 Q<br> 发送；Consumer 消费的时候也会负载均衡地分配若干个 Q，只拉取对应 Q 的消息。<br> 每一条 message queue 均对应一个文件，这个文件存储了实际消息的索引信息。并且即使文件被删除，也能通过实际纯粹的消息文件（commit log）<br> 恢复回来。</p> 
<h5><a id="415_Offset_2568"></a>4.1.5 偏移量(Offset)</h5> 
<p>RocketMQ 中，有很多 offset 的概念。一般我们只关心暴露到客户端的 offset。不指定的话，就是指 Message Queue 下面的 offset。<br> Message queue 是无限长的数组。一条消息进来下标就会涨 1,而这个数组的下标就是 offset，Message queue 中的 max offset 表示消息的最大 offset<br> Consumer offset 可以理解为标记 Consumer Group 在一条逻辑 Message Queue 上，消息消费到哪里即消费进度。但从源码上看，这个数值是消费过的<br> 最新消费的消息 offset+1，即实际上表示的是下次拉取的 offset</p> 
<h3><a id="__2574"></a>五 玩转各种消息</h3> 
<h4><a id="51__2576"></a>5.1 普通消息</h4> 
<ul><li><strong>导入MQ客户端依赖</strong></li></ul> 
<pre><code class="prism language-xml">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.rocketmq<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>rocketmq-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.8.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<ul><li><strong>消息发送步骤</strong></li></ul> 
<ol><li>创建消息生产者 producer，并指定生产者组名</li><li>指定 Nameserver 地址</li><li>启动 producer</li><li>创建消息对象，指定 Topic、Tag 和消息体</li><li>发送消息</li><li>关闭生产者 producer</li></ol> 
<ul><li><strong>消息消费者步骤</strong></li></ul> 
<ol><li>创建消费者 Consumer，指定消费者组名</li><li>指定 Nameserver 地址</li><li>订阅主题 Topic 和 Tag</li><li>设置回调函数，处理消息</li><li>启动消费者 consumer</li></ol> 
<h5><a id="511__2606"></a>5.1.1 消息发送</h5> 
<h6><a id="5111__2608"></a>5.1.1.1 发送同步消息</h6> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-pxDwclSm-1625329015942)(2B8B547B948B43FEA8CA47F3B84DE891)]</p> 
<p>这种可靠性同步地发送方式使用的比较广泛，比如：重要的消息通知，短信通知。</p> 
<p>同步发送是指消息发送方发出数据后，同步等待，直到收到接收方发回响应之后才发下一个请求。</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @author Crazy.X
 * 同步发送
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SyncProducer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 实例化消息生产者Producer</span>
        <span class="token class-name">DefaultMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">"please_rename_unique_group_name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置NameServer的地址</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 启动Producer实例</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 创建消息，并指定Topic，Tag和消息体</span>
            <span class="token class-name">Message</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span>
                    <span class="token string">"TopicTest"</span> <span class="token comment">/* Topic */</span><span class="token punctuation">,</span>
                    <span class="token string">"TagA"</span> <span class="token comment">/* Tag */</span><span class="token punctuation">,</span>
                    <span class="token punctuation">(</span><span class="token string">"Hello RocketMQ "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">RemotingHelper</span><span class="token punctuation">.</span>DEFAULT_CHARSET<span class="token punctuation">)</span> <span class="token comment">/* Message body */</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 发送消息到一个Broker</span>
            <span class="token class-name">SendResult</span> sendResult <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 通过sendResult返回消息是否成功送达</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s%n"</span><span class="token punctuation">,</span> sendResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果不再发送消息，关闭Producer实例。</span>
        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-M2WiwcVd-1625329015942)(2032ED4B864C4A3789D4C1ABBDE17438)]</p> 
<ul><li>Message ID</li></ul> 
<p>消息的全局唯一标识（内部机制的 ID 生成是使用机器 IP 和消息偏移量的组成，所以有可能重复，如果是幂等性还是最好考虑 Key），由消息队列 MQ<br> 系统自动生成，唯一标识某条消息。</p> 
<ul><li>SendStatus</li></ul> 
<p>发送的标识。成功，失败等</p> 
<ul><li>Queue</li></ul> 
<p>相当于是 Topic 的分区；用于并行发送和接收消息</p> 
<h6><a id="5112__2663"></a>5.1.1.2 发送异步消息</h6> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-lyOAviN7-1625329015942)(D75A128AD2FF48B999B1342EED9FBA83)]</p> 
<p>异步消息通常用在对响应时间敏感的业务场景，即发送端不能容忍长时间地等待 Broker的响应</p> 
<p>消息发送方在发送了一条消息后，不等接收方发回响应，接着进行第二条消息发送。发送方通过回调接口的方式接收服务器响应，并对响应结果进行处理</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @author Crazy.X
 * 异步发送
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AsyncProducer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 实例化消息生产者Producer</span>
        <span class="token class-name">DefaultMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">"please_rename_unique_group_name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置NameServer的地址</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 启动Producer实例</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置发送异步失败时的重试次数</span>
        producer<span class="token punctuation">.</span><span class="token function">setRetryTimesWhenSendAsyncFailed</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//启用Broker故障延迟机制</span>
        producer<span class="token punctuation">.</span><span class="token function">setSendLatencyFaultEnable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> index <span class="token operator">=</span> i<span class="token punctuation">;</span>
            <span class="token comment">// 创建消息，并指定Topic，Tag和消息体</span>
            <span class="token class-name">Message</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span>
                    <span class="token string">"TopicTest"</span><span class="token punctuation">,</span>
                    <span class="token string">"TagA"</span><span class="token punctuation">,</span>
                    <span class="token string">"OrderID888"</span><span class="token punctuation">,</span>
                    <span class="token string">"Hello world"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">RemotingHelper</span><span class="token punctuation">.</span>DEFAULT_CHARSET<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// SendCallback接收异步返回结果的回调</span>
            producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SendCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token class-name">SendResult</span> sendResult<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%-10d OK %s %n"</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> sendResult<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onException</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%-10d Exception %s %n"</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果不再发送消息，关闭Producer实例。</span>
        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-RjvurzRo-1625329015943)(83FF9F26D9204545B40CEE188EA534D8)]</p> 
<h6><a id="5113__2720"></a>5.1.1.3 单向发送</h6> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-yDbhth9g-1625329015943)(70080B7E8E7E44C9B617DF392E9208CF)]</p> 
<p>这种方式主要用在不特别关心发送结果的场景，例如日志发送</p> 
<p>单向（Oneway）发送特点为发送方只负责发送消息，不等待服务器回应且没有回调函数触发，即只发送请求不等待应答。此方式发送消息的过程耗时非常短，一般在微秒级别。</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @author Crazy.X
 * 单向发送
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OneWayProducer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 实例化消息生产者Producer</span>
        <span class="token class-name">DefaultMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">"please_rename_unique_group_name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置NameServer的地址</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 启动Producer实例</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 创建消息，并指定Topic，Tag和消息体</span>
            <span class="token class-name">Message</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span>
                    <span class="token string">"TopicTest"</span> <span class="token comment">/* Topic */</span><span class="token punctuation">,</span>
                    <span class="token string">"TagA"</span> <span class="token comment">/* Tag */</span><span class="token punctuation">,</span>
                    <span class="token punctuation">(</span><span class="token string">"Hello RocketMQ "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">RemotingHelper</span><span class="token punctuation">.</span>DEFAULT_CHARSET<span class="token punctuation">)</span> <span class="token comment">/* Message body */</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 发送单向消息，没有任何返回结果</span>
            producer<span class="token punctuation">.</span><span class="token function">sendOneway</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
        <span class="token comment">// 如果不再发送消息，关闭Producer实例。</span>
        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="5114__2758"></a>5.1.1.4 消息发送的权衡</h6> 
<table><thead><tr><th>发送方式</th><th>发送TPS</th><th>发送结果反馈</th><th>可靠性</th><th>适用场景</th></tr></thead><tbody><tr><td>同步可靠发送</td><td>快</td><td>有</td><td>不丢失</td><td>重要通知邮件、报名短信通知、营销短信系统等</td></tr><tr><td>异步可靠发送</td><td>快</td><td>有</td><td>不丢失</td><td>用户视频上传后通知启动转码服务、转码完成后通知推送转码结果等</td></tr><tr><td>单向发送</td><td>快</td><td>有</td><td>可能丢失</td><td>适用于某些耗时非常短，但对可靠性要求并不高的场景，例如日志收集</td></tr></tbody></table> 
<h5><a id="512__2767"></a>5.1.2 消息消费</h5> 
<h6><a id="5121__2769"></a>5.1.2.1 集群消费</h6> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-8WrMAWPp-1625329015944)(65B5C45B0AB94BCD9A9E128AD7E594E4)]</p> 
<p>消费者的一种消费模式。一个 Consumer Group 中的各个 Consumer 实例分摊去消费消息，即一条消息只会投递到一个 Consumer Group 下面的一个实例。</p> 
<p>实际上，每个 Consumer 是平均分摊 Message Queue 的去做拉取消费。例如某个 Topic 有 3 条 Q，其中一个 Consumer Group有3个实例（可能是3个进程，或者3台机器），那么每个实例只消费其中的 1 条 Q。</p> 
<p>而由 Producer 发送消息的时候是轮询所有的 Q,所以消息会平均散落在不同的 Q 上，可以认为 Q 上的消息是平均的。那么实例也就平均地消费消息了。<br> 这种模式下，<strong>消费进度(Consumer Offset)的存储会持久化到 Broker</strong>。</p> 
<pre><code class="prism language-java">
<span class="token comment">/**
 * @author Crazy.X
 * 推模式集群消费
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BalanceConsumer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 实例化消息消费者,指定组</span>
        <span class="token class-name">DefaultMQPushConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">"group1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定NameServer地址信息</span>
        consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置最大重新消费次数</span>
        consumer<span class="token punctuation">.</span><span class="token function">setMaxReconsumeTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 订阅Topic subExpression 对tag进行指定进行过滤 也可以正则表达式 TagA|TagB</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"TopicTest"</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 负载均衡模式集群消费</span>
        consumer<span class="token punctuation">.</span><span class="token function">setMessageModel</span><span class="token punctuation">(</span><span class="token class-name">MessageModel</span><span class="token punctuation">.</span>CLUSTERING<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 注册回调函数，处理消息</span>
        consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">ConsumeConcurrentlyStatus</span> <span class="token function">consumeMessage</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">&gt;</span></span> msgs<span class="token punctuation">,</span>
                                                            <span class="token class-name">ConsumeConcurrentlyContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MessageExt</span> msg <span class="token operator">:</span> msgs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token class-name">String</span> topic <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">String</span> msgBody <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">String</span> tags <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"收到消息: "</span> <span class="token operator">+</span> <span class="token string">"topic:"</span> <span class="token operator">+</span> topic <span class="token operator">+</span> <span class="token string">",tags:"</span> <span class="token operator">+</span> tags <span class="token operator">+</span> <span class="token string">",msgBody:"</span> <span class="token operator">+</span> msgBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 消费失败，认为没有消费，可能会重复发送</span>
                    <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span>RECONSUME_LATER<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 未出现异常进行提交 成功</span>
                <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span>CONSUME_SUCCESS<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//启动消息者</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Consumer Started.%n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-W7a3qL6i-1625329015944)(7A434D20B12E4988A495B1819B796146)]</p> 
<h6><a id="5122__2827"></a>5.1.2.2 广播消费</h6> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-JraRXBGk-1625329015945)(D9FA0964CAAA4CF9AC1DF851645A4BE7)]</p> 
<p>消费者的一种消费模式。消息将对一个 Consumer Group 下的各个 Consumer 实例都投递一遍。即即使这些 Consumer 属于同一个 Consumer Group，<br> 消息也会被 Consumer Group 中的每个 Consumer 都消费一次。</p> 
<p>实际上，是一个消费组下的每个消费者实例都获取到了 topic 下面的每个 Message Queue 去拉取消费。所以消息会投递到每个消费者实例。<br> 这种模式下，<strong>消费进度(Consumer Offset)会存储持久化到实例本地</strong>。</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @author Crazy.X
 * 广播模式消费
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BroadcastConsumer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/// 实例化消息消费者,指定组</span>
        <span class="token class-name">DefaultMQPushConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">"group1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定NameServer地址信息</span>
        consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置最大重新消费次数</span>
        consumer<span class="token punctuation">.</span><span class="token function">setMaxReconsumeTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 订阅Topic subExpression 对tag进行指定进行过滤 也可以正则表达式 TagA|TagB</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"TopicTest"</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//广播模式消费</span>
        consumer<span class="token punctuation">.</span><span class="token function">setMessageModel</span><span class="token punctuation">(</span><span class="token class-name">MessageModel</span><span class="token punctuation">.</span>BROADCASTING<span class="token punctuation">)</span><span class="token punctuation">;</span>

        consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 广播模式下，消息队列 RocketMQ 保证每条消息至少被每台客户端消费一次，</span>
            <span class="token comment">// 但是并不会对消费失败的消息进行失败重投，因此业务方需要关注消费失败的情况。</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">ConsumeConcurrentlyStatus</span> <span class="token function">consumeMessage</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">&gt;</span></span> msgs<span class="token punctuation">,</span>
                                                            <span class="token class-name">ConsumeConcurrentlyContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" Receive New Messages: "</span> <span class="token operator">+</span> msgs <span class="token operator">+</span> <span class="token string">"%n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span>CONSUME_SUCCESS<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//启动消息者</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Consumer Started.%n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="5123__2872"></a>5.1.2.3 消息消费时的权衡</h6> 
<p><strong>集群模式：适用场景&amp;注意事项</strong></p> 
<ol><li>消费端集群化部署，每条消息只需要被处理一次。</li><li>由于消费进度在服务端维护，可靠性更高。</li><li>集群消费模式下，每一条消息都只会被分发到一台机器上处理。如果需要被集群下的每一台机器都处理，请使用广播模式。</li><li>集群消费模式下，不保证每一次失败重投的消息路由到同一台机器上，因此处理消息时不应该做任何确定性假设。</li></ol> 
<p><strong>广播模式：适用场景&amp;注意事项</strong></p> 
<ol><li>广播消费模式下不支持顺序消息。</li><li>广播消费模式下不支持重置消费位点。</li><li>每条消息都需要被相同逻辑的多台机器处理。</li><li>消费进度在客户端维护，出现重复的概率稍大于集群模式。</li><li>广播模式下，消息队列 RocketMQ 保证每条消息至少被每台客户端消费一次，但是并不会对消费失败的消息进行失败重投，因此业务方需要关注消费失败的情况。</li><li>广播模式下，客户端每一次重启都会从最新消息消费。<strong>客户端在被停止期间发送至服务端的消息将会被自动跳过，请谨慎选择。</strong></li><li>广播模式下，每条消息都会被大量的客户端重复处理，因此推荐尽可能使用集群模式。</li><li>目前仅 Java 客户端支持广播模式。</li><li>广播模式下服务端不维护消费进度，所以消息队列RocketMQ控制台不支持消息堆积查询、消息堆积报警和订阅关系查询功能。</li></ol> 
<h4><a id="52__2896"></a>5.2 顺序消息</h4> 
<p>消息有序指的是可以按照消息的发送顺序来消费(FIFO)。RocketMQ 可以严格的保证消息有序，可以分为分区有序或者全局有序。</p> 
<p>顺序消费的原理解析，在默认的情况下消息发送会采取 Round Robin 轮询方式把消息发送到不同的 queue(分区队列)；而消费消息的时候从多个 queue<br> 上拉取消息，这种情况发送和消费是不能保证顺序。但是如果控制发送的顺序消息只依次发送到同一个 queue 中，消费的时候只从这个 queue 上依次拉<br> 取，则就保证了顺序。当发送和消费参与的 queue 只有一个，则是全局有序；如果多个 queue 参与，则为分区有序，即相对每个 queue，消息都是有序的。</p> 
<ul><li> <p>全局顺序消息<br> [外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-fDGwSZvq-1625329015945)(8EF91CFF098A4C4FA4AE63F5FD25E43C)]<br> 全局顺序只创建一个queqe 即可全局顺序 不做记录</p> </li><li> <p>部分顺序消息<br> [外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-HZc11GDt-1625329015946)(81E4B776AFDB4B67AB84C236497DCC34)]</p> </li></ul> 
<h5><a id="521__2913"></a>5.2.1 顺序消息生产</h5> 
<p>一个订单的顺序流程是：创建、付款、推送、完成。订单号相同的消息会被先后发送到同一个队列中，下面是订单进行分区有序的示例代码。</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @author Crazy.X
 * 部分顺序消息生产
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProducerInOrder</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 实例化消息生产者Producer</span>
        <span class="token class-name">DefaultMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">"OrderProducer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置NameServer的地址</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 启动Producer实例</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// tags数组 使用tag区分</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tags <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span><span class="token string">"TagA"</span><span class="token punctuation">,</span> <span class="token string">"TagC"</span><span class="token punctuation">,</span> <span class="token string">"TagD"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">// 订单列表 模拟订单数据</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> orderList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProducerInOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">buildOrders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Date</span> date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SimpleDateFormat</span> sdf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">"yyyy-MM-dd HH:mm:ss"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> dateStr <span class="token operator">=</span> sdf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 创建消息，并指定Topic，Tag和消息体</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> orderList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 加个时间前缀</span>
            <span class="token class-name">String</span> body <span class="token operator">=</span> dateStr <span class="token operator">+</span> <span class="token string">" Order:"</span> <span class="token operator">+</span> orderList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 指定tags组</span>
            <span class="token class-name">Message</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">"PartOrder"</span><span class="token punctuation">,</span> tags<span class="token punctuation">[</span>i <span class="token operator">%</span> tags<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"KEY"</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> body<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">SendResult</span> sendResult <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MessageQueueSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token class-name">MessageQueue</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> mqs<span class="token punctuation">,</span> <span class="token class-name">Message</span> msg<span class="token punctuation">,</span> <span class="token class-name">Object</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//根据订单id选择发送queue</span>
                    <span class="token class-name">Long</span> id <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">)</span> arg<span class="token punctuation">;</span>
                    <span class="token keyword">long</span> index <span class="token operator">=</span> id <span class="token operator">%</span> mqs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 返回</span>
                    <span class="token keyword">return</span> mqs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> orderList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//订单id</span>

            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"SendResult status:%s, queueId:%d, body:%s"</span><span class="token punctuation">,</span>
                    sendResult<span class="token punctuation">.</span><span class="token function">getSendStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    sendResult<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    body<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果不再发送消息，关闭Producer实例。</span>
        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 订单
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Order</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">private</span> <span class="token keyword">long</span> orderId<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> desc<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> orderId<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token keyword">long</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>orderId <span class="token operator">=</span> orderId<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> desc<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setDesc</span><span class="token punctuation">(</span><span class="token class-name">String</span> desc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>desc <span class="token operator">=</span> desc<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token string">"Order{"</span> <span class="token operator">+</span>
                    <span class="token string">"orderId="</span> <span class="token operator">+</span> orderId <span class="token operator">+</span>
                    <span class="token string">", desc='"</span> <span class="token operator">+</span> desc <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>
                    <span class="token string">'}'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 生成模拟订单数据
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> <span class="token function">buildOrders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> orderList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Order</span> orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token number">20210406001L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setDesc</span><span class="token punctuation">(</span><span class="token string">"创建"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token number">20210406002L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setDesc</span><span class="token punctuation">(</span><span class="token string">"创建"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token number">20210406001L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setDesc</span><span class="token punctuation">(</span><span class="token string">"付款"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token number">20210406003L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setDesc</span><span class="token punctuation">(</span><span class="token string">"创建"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token number">20210406002L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setDesc</span><span class="token punctuation">(</span><span class="token string">"付款"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token number">20210406003L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setDesc</span><span class="token punctuation">(</span><span class="token string">"付款"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token number">20210406002L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setDesc</span><span class="token punctuation">(</span><span class="token string">"推送"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token number">20210406003L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setDesc</span><span class="token punctuation">(</span><span class="token string">"推送"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token number">20210406002L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setDesc</span><span class="token punctuation">(</span><span class="token string">"完成"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token number">20210406001L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setDesc</span><span class="token punctuation">(</span><span class="token string">"推送"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token number">20210406003L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setDesc</span><span class="token punctuation">(</span><span class="token string">"完成"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token number">20210406001L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setDesc</span><span class="token punctuation">(</span><span class="token string">"完成"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> orderList<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-YzxLjOi2-1625329015947)(494F4EF9B5884E1C911324A04E9C0140)]</p> 
<h5><a id="522__3071"></a>5.2.2 顺序消息消费</h5> 
<p>消费时，同一个 OrderId 获取到的肯定是同一个队列。从而确保一个订单中处理的顺序。</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @author Crazy.X
 * 部分顺序消息消费
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConsumerInOrder</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">DefaultMQPushConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">"OrderConsumer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 设置Consumer第一次启动是从队列头部开始消费还是队列尾部开始消费&lt;br&gt;</span>
        <span class="token comment">// 如果非第一次启动，那么按照上次消费的位置继续消费</span>
        consumer<span class="token punctuation">.</span><span class="token function">setConsumeFromWhere</span><span class="token punctuation">(</span><span class="token class-name">ConsumeFromWhere</span><span class="token punctuation">.</span>CONSUME_FROM_FIRST_OFFSET<span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"PartOrder"</span><span class="token punctuation">,</span> <span class="token string">"TagA || TagC || TagD"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageListenerOrderly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">ConsumeOrderlyStatus</span> <span class="token function">consumeMessage</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">&gt;</span></span> msgs<span class="token punctuation">,</span> <span class="token class-name">ConsumeOrderlyContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                context<span class="token punctuation">.</span><span class="token function">setAutoCommit</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MessageExt</span> msg <span class="token operator">:</span> msgs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 可以看到每个queue有唯一的consume线程来消费, 订单对每个queue(分区)有序</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"consumeThread="</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                            <span class="token string">"queueId="</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                            <span class="token string">", content:"</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//模拟业务逻辑处理中...</span>
                    <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token class-name">ConsumeOrderlyStatus</span><span class="token punctuation">.</span>SUCCESS<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Consumer Started."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-Zvejeszb-1625329015947)(0607824793684878AED71186FBE084C6)]</p> 
<h4><a id="53__3118"></a>5.3 消息发送时的重要方法/属性（工作参考使用）</h4> 
<p>属性与方法是整个类，可以放到一个类下观看</p> 
<h5><a id="531__3122"></a>5.3.1 属性</h5> 
<pre><code class="prism language-java">        <span class="token comment">//  producerGroup：生产者所属组(针对 事务消息 高可用)</span>
        <span class="token class-name">DefaultMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">"produce_details"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//  默认主题在每一个Broker队列数量(对于新创建主题有效)</span>
        producer<span class="token punctuation">.</span><span class="token function">setDefaultTopicQueueNums</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//  发送消息默认超时时间，默认3s (3000ms)</span>
        producer<span class="token punctuation">.</span><span class="token function">setSendMsgTimeout</span><span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//  消息体超过该值则启用压缩，默认4k</span>
        producer<span class="token punctuation">.</span><span class="token function">setCompressMsgBodyOverHowmuch</span><span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//  同步方式发送消息重试次数，默认为2，总共执行3次</span>
        producer<span class="token punctuation">.</span><span class="token function">setRetryTimesWhenSendFailed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//  异步方式发送消息重试次数，默认为2，总共执行3次</span>
        producer<span class="token punctuation">.</span><span class="token function">setRetryTimesWhenSendAsyncFailed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//  消息重试时选择另外一个Broker时（消息没有存储成功是否发送到另外一个broker），默认为false</span>
        producer<span class="token punctuation">.</span><span class="token function">setRetryAnotherBrokerWhenNotStoreOK</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//  允许发送的最大消息长度，默认为4M</span>
        producer<span class="token punctuation">.</span><span class="token function">setMaxMessageSize</span><span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 设置NameServer的地址</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<h5><a id="532__3148"></a>5.3.2 方法</h5> 
<pre><code class="prism language-java">        <span class="token comment">// 启动Producer实例</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 如果不再发送消息，关闭Producer实例。（这行代码要放在最后）</span>
        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 查找该主题下所有消息队列</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">MessageQueue</span> <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">fetchPublishMessageQueues</span><span class="token punctuation">(</span><span class="token string">"TopicTest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MessageQueue</span> queue <span class="token operator">:</span> <span class="token class-name">MessageQueue</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>queue<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h6><a id="5321__3164"></a>5.3.2.1 单向发送</h6> 
<pre><code class="prism language-java">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> index <span class="token operator">=</span> i<span class="token punctuation">;</span>
            <span class="token comment">// 创建消息，并指定Topic，Tag和消息体</span>
            <span class="token class-name">Message</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span>
                    <span class="token string">"TopicTest"</span><span class="token punctuation">,</span>
                    <span class="token string">"TagA"</span><span class="token punctuation">,</span>
                    <span class="token string">"OrderID888"</span><span class="token punctuation">,</span>
                    <span class="token string">"Hello world"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">RemotingHelper</span><span class="token punctuation">.</span>DEFAULT_CHARSET<span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//  ------------  单向发送  ------------</span>
            <span class="token comment">//  1.1发送单向消息</span>
            producer<span class="token punctuation">.</span><span class="token function">sendOneway</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//  1.2指定队列单向发送消息(使用select方法)</span>
            producer<span class="token punctuation">.</span><span class="token function">sendOneway</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token punctuation">(</span>mqs<span class="token punctuation">,</span> msg1<span class="token punctuation">,</span> arg<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> mqs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//  1.3指定队列单向发送消息(根据之前查找出来的主题)</span>
            producer<span class="token punctuation">.</span><span class="token function">sendOneway</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token class-name">MessageQueue</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h6><a id="5333__3186"></a>5.3.3.3 同步发送</h6> 
<pre><code class="prism language-java">            <span class="token comment">//  2.1同步发送消息</span>
            <span class="token class-name">SendResult</span> sendResult0 <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//  2.1同步超时发送消息(属性设置：sendMsgTimeout 发送消息默认超时时间，默认3s (3000ms) )</span>
            <span class="token class-name">SendResult</span> sendResult1 <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//  2.2指定队列同步发送消息(使用select方法)</span>
            <span class="token class-name">SendResult</span> sendResult2 <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MessageQueueSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token class-name">MessageQueue</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> mqs<span class="token punctuation">,</span> <span class="token class-name">Message</span> msg<span class="token punctuation">,</span> <span class="token class-name">Object</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> mqs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//  2.3指定队列同步发送消息(根据之前查找出来的主题队列信息)</span>
            <span class="token class-name">SendResult</span> sendResult3 <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token class-name">MessageQueue</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h6><a id="5332__3204"></a>5.3.3.2 异步发送</h6> 
<pre><code class="prism language-java">            <span class="token comment">//  3.1异步发送消息</span>
            producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SendCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token class-name">SendResult</span> sendResult<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%-10d OK %s %n"</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> sendResult<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onException</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%-10d Exception %s %n"</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//  3.1异步超时发送消息</span>
            producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SendCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token class-name">SendResult</span> sendResult<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%-10d OK %s %n"</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> sendResult<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onException</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%-10d Exception %s %n"</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//  3.2选择指定队列异步发送消息(根据之前查找出来的主题队列信息)</span>
            producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token class-name">MessageQueue</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">SendCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token annotation punctuation">@Override</span>
                        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token class-name">SendResult</span> sendResult<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%-10d OK %s %n"</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> sendResult<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token annotation punctuation">@Override</span>
                        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onException</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%-10d Exception %s %n"</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//  3.3选择指定队列异步发送消息(使用select方法)</span>
            producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MessageQueueSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token annotation punctuation">@Override</span>
                        <span class="token keyword">public</span> <span class="token class-name">MessageQueue</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> mqs<span class="token punctuation">,</span> <span class="token class-name">Message</span> msg<span class="token punctuation">,</span> <span class="token class-name">Object</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">return</span> mqs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">SendCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token annotation punctuation">@Override</span>
                        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token class-name">SendResult</span> sendResult<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%-10d OK %s %n"</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> sendResult<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token annotation punctuation">@Override</span>
                        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onException</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%-10d Exception %s %n"</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="54__3269"></a>5.4 消息消费时的重要方法/属性（工作参考使用）</h4> 
<p>属性与方法是整个类，可以放到一个类下观看</p> 
<h5><a id="541__3273"></a>5.4.1 属性</h5> 
<pre><code class="prism language-java">        <span class="token comment">// consumerGroup：消费者组</span>
        <span class="token class-name">DefaultMQPushConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">"Faker"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定NameServer地址信息.</span>
        consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 消息消费模式（默认集群消费）</span>
        consumer<span class="token punctuation">.</span><span class="token function">setMessageModel</span><span class="token punctuation">(</span><span class="token class-name">MessageModel</span><span class="token punctuation">.</span>CLUSTERING<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定消费开始偏移量（上次消费偏移量、最大偏移量、最小偏移量、启动时间戳）开始消费</span>
        consumer<span class="token punctuation">.</span><span class="token function">setConsumeFromWhere</span><span class="token punctuation">(</span><span class="token class-name">ConsumeFromWhere</span><span class="token punctuation">.</span>CONSUME_FROM_LAST_OFFSET<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 消费者最小线程数量(默认20)</span>
        consumer<span class="token punctuation">.</span><span class="token function">setConsumeThreadMin</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 消费者最大线程数量(默认20)</span>
        consumer<span class="token punctuation">.</span><span class="token function">setConsumeThreadMax</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 推模式下任务间隔时间(推模式也是基于不断的轮训拉取的封装)</span>
        consumer<span class="token punctuation">.</span><span class="token function">setPullInterval</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 推模式下任务拉取的条数,默认32条(一批批拉)</span>
        consumer<span class="token punctuation">.</span><span class="token function">setPullBatchSize</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 消息重试次数,-1代表16次 （超过 次数成为死信消息）</span>
        consumer<span class="token punctuation">.</span><span class="token function">setMaxReconsumeTimes</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 消息消费超时时间(消息可能阻塞正在使用的线程的最大时间：以分钟为单位)</span>
        consumer<span class="token punctuation">.</span><span class="token function">setConsumeTimeout</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<h5><a id="542__3300"></a>5.4.2 方法</h5> 
<pre><code class="prism language-java">        <span class="token comment">// 方法-订阅</span>
        <span class="token comment">// 基于主题订阅消息，消息过滤使用表达式</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"TopicTest"</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//tag  tagA||TagB||TagC</span>
        <span class="token comment">// 基于主题订阅消息，消息过滤使用表达式</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"TopicTest"</span><span class="token punctuation">,</span> <span class="token class-name">MessageSelector</span><span class="token punctuation">.</span><span class="token function">bySql</span><span class="token punctuation">(</span><span class="token string">"a between 0 and 3"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 基于主题订阅消息，消息过滤使用表达式</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"TopicTest"</span><span class="token punctuation">,</span> <span class="token class-name">MessageSelector</span><span class="token punctuation">.</span><span class="token function">byTag</span><span class="token punctuation">(</span><span class="token string">"tagA||TagB"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 取消消息订阅</span>
        consumer<span class="token punctuation">.</span><span class="token function">unsubscribe</span><span class="token punctuation">(</span><span class="token string">"TopicTest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 注册监听器</span>
        <span class="token comment">// 注册并发事件监听器</span>
        consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>msgs<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MessageExt</span> msg <span class="token operator">:</span> msgs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">String</span> topic <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> msgBody <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> tags <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"收到消息："</span> <span class="token operator">+</span> <span class="token string">" topic :"</span> <span class="token operator">+</span> topic <span class="token operator">+</span> <span class="token string">" ,tags : "</span> <span class="token operator">+</span> tags <span class="token operator">+</span> <span class="token string">" ,msg : "</span> <span class="token operator">+</span> msgBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//没有成功  -- 到重试队列中来</span>
                <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span>RECONSUME_LATER<span class="token punctuation">;</span>

            <span class="token punctuation">}</span>
            <span class="token comment">//  // 未出现异常进行提交 成功</span>
            <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span>CONSUME_SUCCESS<span class="token punctuation">;</span>
            <span class="token comment">//todo</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 注册顺序消息事件监听器</span>
        consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageListenerOrderly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">ConsumeOrderlyStatus</span> <span class="token function">consumeMessage</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">&gt;</span></span> msgs<span class="token punctuation">,</span> <span class="token class-name">ConsumeOrderlyContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                context<span class="token punctuation">.</span><span class="token function">setAutoCommit</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MessageExt</span> msg <span class="token operator">:</span> msgs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 可以看到每个queue有唯一的consume线程来消费, 订单对每个queue(分区)有序</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"consumeThread="</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"queueId="</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", content:"</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//模拟业务逻辑处理中...</span>
                    <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 这个点要注意：意思是先等一会，一会儿再处理这批消息，而不是放到重试队列里</span>
                    <span class="token keyword">return</span> <span class="token class-name">ConsumeOrderlyStatus</span><span class="token punctuation">.</span>SUSPEND_CURRENT_QUEUE_A_MOMENT<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token class-name">ConsumeOrderlyStatus</span><span class="token punctuation">.</span>SUCCESS<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//启动消息者</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Consumer Started.%n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<h5><a id="543_ACK_3362"></a>5.4.3 消费确认(ACK)</h5> 
<ol><li>业务实现消费回调的时候，当且仅当此回调函数返回 ConsumeConcurrentlyStatus.CONSUME_SUCCESS，RocketMQ 才会认为这批消息（默认是 1 条）<br> 是消费完成的。中途断电，抛出异常等都不会认为成功——即都会重新投递。</li><li>返回 ConsumeConcurrentlyStatus.RECONSUME_LATER，RocketMQ 就会认为这批消息消费失败了。</li><li>如果业务的回调没有处理好而抛出异常，会认为是消费失败 ConsumeConcurrentlyStatus.RECONSUME_LATER 处理。</li><li>为了保证消息是肯定被至少消费成功一次，RocketMQ 会把这批消息重发回 Broker（topic 不是原 topic 而是这个消费组的 RETRY topic），在延迟的某<br> 个时间点（默认是 10 秒，业务可设置）后，再次投递到这个 ConsumerGroup。而如果一直这样重复消费都持续失败到一定次数（默认 16 次），就会投<br> 递到 DLQ 死信队列。应用可以监控死信队列来做人工干预。</li><li>另外如果使用顺序消费的回调 MessageListenerOrderly 时，由于顺序消费是要前者消费成功才能继续消费，所以没有 RECONSUME_LATER 的这个状态，<br> 只有 SUSPEND_CURRENT_QUEUE_A_MOMENT 来暂停队列的其余消费，直到原消息不断重试成功为止才能继续消</li></ol> 
<h4><a id="55__3374"></a>5.5 延时消息</h4> 
<h5><a id="551__3376"></a>5.5.1 概念介绍</h5> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-5Pstlr4L-1625329015948)(19AF7E0B6C8645B691DFAE0DA985DEFC)]</p> 
<p><strong>延时消息</strong>：Producer 将消息发送到消息队列 RocketMQ 服务端，但并不期望这条消息立马投递，而是延迟一定时间后才投递到 Consumer 进行消费，该消息即延时消息。</p> 
<h5><a id="552__3382"></a>5.5.2 适用场景</h5> 
<p>消息生产和消费有时间窗口要求：比如在电商交易中超时未支付关闭订单的场景，在订单创建时会发送一条延时消息。这条消息将会在 30 分钟以<br> 后投递给消费者，消费者收到此消息后需要判断对应的订单是否已完成支付。 如支付未完成，则关闭订单。如已完成支付则忽略。</p> 
<h5><a id="553__3387"></a>5.5.3 使用方式</h5> 
<p><strong>Apache RocketMQ</strong> 目前只支持固定精度的定时消息，因为如果要支持任意的时间精度，在 Broker 层面，必须要做消息排序，如果再涉及到持久化，<br> 那么消息排序要不可避免的产生巨大性能开销。<mark>（阿里云 RocketMQ 提供了任意时刻的定时消息功能，Apache 的 RocketMQ 并没有,阿里并没有开源）</mark></p> 
<p>发送延时消息时需要设定一个延时时间长度，消息将从当前发送时间点开始延迟固定时间之后才开始投递</p> 
<p>延迟消息是根据延迟队列的 level 来的，延迟队列默认</p> 
<p>msg.setDelayTimeLevel(3)代表延迟 10 秒<br> “1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h”</p> 
<p><strong>在源码org/apache/rocketmq/store/config/MessageStoreConfig.java</strong></p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-qCSCUDC7-1625329015948)(85F5AD2143684589A41D2023C0ECAA78)]</p> 
<p>是这 18 个等级（秒（s）、分（m）、小时（h）），level 为 1，表示延迟 1 秒后消费，level 为 5 表示延迟 1 分钟后消费，level 为 18 表示延迟 2 个<br> 小时消费。生产消息跟普通的生产消息类似，只需要在消息上设置延迟队列的 level 即可。消费消息跟普通的消费消息一致。</p> 
<ul><li>生产者</li></ul> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @author Crazy.X
 * 延时消息-生产者
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ScheduledMessageProducer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 实例化一个生产者来产生延时消息</span>
        <span class="token class-name">DefaultMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">"ScheduledProducer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定NameServer地址信息</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 启动Producer实例</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> totalMessagesToSend <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> totalMessagesToSend<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Message</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">"ScheduledTopic"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"Hello scheduled message "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 设置延时等级3,这个消息将在10s之后投递给消费者(详看delayTimeLevel)</span>
            <span class="token comment">// delayTimeLevel：(1~18个等级)"1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h"</span>
            <span class="token comment">// 4就是第四个等级 30s</span>
            message<span class="token punctuation">.</span><span class="token function">setDelayTimeLevel</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 发送消息</span>
            producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 关闭生产者</span>
        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>消费者</li></ul> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @author Crazy.X
 * 延时消息-消费者
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ScheduledMessageConsumer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 实例化消费者</span>
        <span class="token class-name">DefaultMQPushConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">"ScheduledConsumer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定NameServer地址信息</span>
        consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 订阅Topics</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"ScheduledTopic"</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 注册消息监听者</span>
        consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>messages<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MessageExt</span> message <span class="token operator">:</span> messages<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// msgId 消息ID</span>
                <span class="token comment">// getStoreTimestamp() 存储时间戳</span>
                <span class="token comment">// getBornTimestamp() 诞生时间戳</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Receive message[msgId="</span> <span class="token operator">+</span> message<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"] "</span>
                        <span class="token operator">+</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getStoreTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> message<span class="token punctuation">.</span><span class="token function">getBornTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"ms later"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 提交消费</span>
            <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span>CONSUME_SUCCESS<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 启动消费者</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-yERfyKIF-1625329015949)(5039A098A320407EB2A42833884F7865)]</p> 
<h4><a id="56__3470"></a>5.6 批量消息</h4> 
<p>批量发送消息能显著提高传递小消息的性能。限制是这些批量消息应该有相同的 topic，相同的 waitStoreMsgOK（集群时会细讲），而且不能是延<br> 时消息。此外，这一批消息的总大小不应超过 4MB</p> 
<ul><li>生产者</li></ul> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @author Crazy.X
 * 批量消息-生产者  list不要超过4m
 */</span>
<span class="token comment">/**
 * @author Crazy.X
 * 批量消息-生产者  list不要超过4m
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BatchProducer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 实例化消息生产者Producer</span>
        <span class="token class-name">DefaultMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">"BatchProducer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置NameServer的地址</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 启动Producer实例</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> topic <span class="token operator">=</span> <span class="token string">"BatchTest"</span><span class="token punctuation">;</span>
        <span class="token comment">// list不要超过4m</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span><span class="token punctuation">&gt;</span></span> messages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        messages<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> <span class="token string">"Tag"</span><span class="token punctuation">,</span> <span class="token string">"OrderID001"</span><span class="token punctuation">,</span> <span class="token string">"Hello world 0"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        messages<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> <span class="token string">"Tag"</span><span class="token punctuation">,</span> <span class="token string">"OrderID002"</span><span class="token punctuation">,</span> <span class="token string">"Hello world 1"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        messages<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> <span class="token string">"Tag"</span><span class="token punctuation">,</span> <span class="token string">"OrderID003"</span><span class="token punctuation">,</span> <span class="token string">"Hello world 2"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>messages<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果不再发送消息，关闭Producer实例。</span>
        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>消费者</li></ul> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @author Crazy.X
 * 批量消息-消费者 批量消费延迟较高
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BatchConsumer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 实例化消息消费者,指定组名</span>
        <span class="token class-name">DefaultMQPushConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">"BatchConsumer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置NameServer的地址</span>
        consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 订阅Topic</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"BatchTest"</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//负载均衡模式消费</span>
        consumer<span class="token punctuation">.</span><span class="token function">setMessageModel</span><span class="token punctuation">(</span><span class="token class-name">MessageModel</span><span class="token punctuation">.</span>CLUSTERING<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 注册回调函数，处理消息</span>
        consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>msgs<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s Receive New Messages: %s %n"</span><span class="token punctuation">,</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span>CONSUME_SUCCESS<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//启动消息者</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Consumer Started.%n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-tICKnjo1-1625329015949)(532759BF7B004CAEB98D63FA972D3DF9)]</p> 
<h5><a id="561__3543"></a>5.6.1 批量切分</h5> 
<p>如果消息的总长度可能大于 4MB 时，这时候最好把消息进行分割</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @author Crazy.X
 * 批量消息-超过4m-生产者
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SplitBatchProducer</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 实例化消息生产者Producer</span>
        <span class="token class-name">DefaultMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">"BatchProducer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置NameServer的地址</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 启动Producer实例</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//large batch</span>
        <span class="token class-name">String</span> topic <span class="token operator">=</span> <span class="token string">"BatchTest"</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span><span class="token punctuation">&gt;</span></span> messages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//10万元素的数组</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            messages<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> <span class="token string">"Tag"</span><span class="token punctuation">,</span> <span class="token string">"OrderID"</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"Hello world "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//把大的消息分裂成若干个小的消息（1M左右）</span>
        <span class="token class-name">ListSplitter</span> splitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ListSplitter</span><span class="token punctuation">(</span>messages<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>splitter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span><span class="token punctuation">&gt;</span></span> listItem <span class="token operator">=</span> splitter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>listItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果不再发送消息，关闭Producer实例。</span>
        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Consumer Started.%n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">ListSplitter</span> <span class="token keyword">implements</span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Message</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span><span class="token punctuation">&gt;</span></span> messages<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> currIndex<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ListSplitter</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span><span class="token punctuation">&gt;</span></span> messages<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>messages <span class="token operator">=</span> messages<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> currIndex <span class="token operator">&lt;</span> messages<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span><span class="token punctuation">&gt;</span></span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> nextIndex <span class="token operator">=</span> currIndex<span class="token punctuation">;</span>
        <span class="token keyword">int</span> totalSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> nextIndex <span class="token operator">&lt;</span> messages<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> nextIndex<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Message</span> message <span class="token operator">=</span> messages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>nextIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> tmpSize <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> properties <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> properties<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                tmpSize <span class="token operator">+=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 增加日志的开销20字节</span>
            tmpSize <span class="token operator">=</span> tmpSize <span class="token operator">+</span> <span class="token number">20</span><span class="token punctuation">;</span>
            <span class="token comment">//1M</span>
            <span class="token keyword">int</span> sizeLimit <span class="token operator">=</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tmpSize <span class="token operator">&gt;</span> sizeLimit<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//单个消息超过了最大的限制（1M）</span>
                <span class="token comment">//忽略,否则会阻塞分裂的进程</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>nextIndex <span class="token operator">-</span> currIndex <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//假如下一个子列表没有元素,则添加这个子列表然后退出循环,否则只是退出循环</span>
                    nextIndex<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tmpSize <span class="token operator">+</span> totalSize <span class="token operator">&gt;</span> sizeLimit<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                totalSize <span class="token operator">+=</span> tmpSize<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span><span class="token punctuation">&gt;</span></span> subList <span class="token operator">=</span> messages<span class="token punctuation">.</span><span class="token function">subList</span><span class="token punctuation">(</span>currIndex<span class="token punctuation">,</span> nextIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        currIndex <span class="token operator">=</span> nextIndex<span class="token punctuation">;</span>
        <span class="token keyword">return</span> subList<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token string">"Not allowed to remove"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="57__3639"></a>5.7 过滤消息</h4> 
<p><strong>注意事项：</strong> <mark>区分tag group一定要不同的组，否则变成负载均衡状态出现数据错误</mark></p> 
<h5><a id="571_Tag__3643"></a>5.7.1 Tag 过滤</h5> 
<p>在大多数情况下，TAG 是一个简单而有用的设计，其可以来选择您想要的消息。举例说明:JD电商电脑商品的只消费电脑,书籍商品的只消费书籍</p> 
<ul><li>生产者</li></ul> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @author Crazy.X
 * tag过滤-生产者
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TagFilterProducer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 实例化消息生产者Producer</span>
        <span class="token class-name">DefaultMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">"TagFilterProducer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置NameServer的地址</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建两个tags</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tags <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span><span class="token string">"computer"</span><span class="token punctuation">,</span> <span class="token string">"book"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Message</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">"TagFilterTest"</span><span class="token punctuation">,</span>
                    tags<span class="token punctuation">[</span>i <span class="token operator">%</span> tags<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token string">"Hello world"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">RemotingHelper</span><span class="token punctuation">.</span>DEFAULT_CHARSET<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">SendResult</span> sendResult <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s%n"</span><span class="token punctuation">,</span> sendResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果不再发送消息，关闭Producer实例</span>
        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>消费者-tag computer</li></ul> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @author Crazy.X
 * tag过滤computer-消费者
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TagComputerFilterConsumer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">MQClientException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 实例化消息消费者,指定组名-tag区分的话组一定不要设置重复</span>
        <span class="token class-name">DefaultMQPushConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">"TagComputerFilterConsumer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置NameServer的地址</span>
        consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// tag来区分,举例说明:JD电商电脑商品的只消费电脑,书籍商品的只消费书籍</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"TagFilterTest"</span><span class="token punctuation">,</span> <span class="token string">"computer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定消费开始偏移量 ConsumeFromWhere.CONSUME_FROM_LAST_OFFSET 也是默认值,可见源码</span>
        consumer<span class="token punctuation">.</span><span class="token function">setConsumeFromWhere</span><span class="token punctuation">(</span><span class="token class-name">ConsumeFromWhere</span><span class="token punctuation">.</span>CONSUME_FROM_LAST_OFFSET<span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>msgs<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MessageExt</span> msg <span class="token operator">:</span> msgs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">String</span> topic <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> msgBody <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> msgPro <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token class-name">String</span> tags <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"收到消息："</span> <span class="token operator">+</span> <span class="token string">" topic :"</span> <span class="token operator">+</span> topic <span class="token operator">+</span> <span class="token string">" ,tags : "</span> <span class="token operator">+</span> tags <span class="token operator">+</span> <span class="token string">" ,a : "</span> <span class="token operator">+</span> msgPro <span class="token operator">+</span> <span class="token string">" ,msg : "</span> <span class="token operator">+</span> msgBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span>RECONSUME_LATER<span class="token punctuation">;</span>

            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span>CONSUME_SUCCESS<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Consumer Started.%n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-LFCp3ooJ-1625329015949)(2332B98DD6A647888DCD3724C149E885)]</p> 
<ul><li>消费者-tag book</li></ul> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @author Crazy.X
 * tag过滤book-消费者
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TagBookFilterConsumer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">MQClientException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 实例化消息消费者,指定组名-tag区分的话组一定不要设置重复</span>
        <span class="token class-name">DefaultMQPushConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">"TagBookFilterConsumer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置NameServer的地址</span>
        consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// tag来区分,举例说明:JD电商电脑商品的只消费电脑,书籍商品的只消费书籍</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"TagFilterTest"</span><span class="token punctuation">,</span> <span class="token string">"book"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定消费开始偏移量 ConsumeFromWhere.CONSUME_FROM_LAST_OFFSET 也是默认值,可见源码</span>
        consumer<span class="token punctuation">.</span><span class="token function">setConsumeFromWhere</span><span class="token punctuation">(</span><span class="token class-name">ConsumeFromWhere</span><span class="token punctuation">.</span>CONSUME_FROM_LAST_OFFSET<span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>msgs<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MessageExt</span> msg <span class="token operator">:</span> msgs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">String</span> topic <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> msgBody <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> msgPro <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token class-name">String</span> tags <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"收到消息："</span> <span class="token operator">+</span> <span class="token string">" topic :"</span> <span class="token operator">+</span> topic <span class="token operator">+</span> <span class="token string">" ,tags : "</span> <span class="token operator">+</span> tags <span class="token operator">+</span> <span class="token string">" ,a : "</span> <span class="token operator">+</span> msgPro <span class="token operator">+</span> <span class="token string">" ,msg : "</span> <span class="token operator">+</span> msgBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span>RECONSUME_LATER<span class="token punctuation">;</span>

            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span>CONSUME_SUCCESS<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Consumer Started.%n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-Q2CdmRsV-1625329015950)(7FDE3BE518854BD5A19E7671DE250015)]</p> 
<h5><a id="572_Sql__3760"></a>5.7.2 Sql 过滤</h5> 
<p><strong>注意：</strong> <mark>开启sql过滤会影响性能（不建议使用）</mark></p> 
<p>sql过滤需要broker.conf配置文件添加配置</p> 
<pre><code class="prism language-xml">brokerClusterName = DefaultCluster
brokerName = broker-a
brokerId = 0
deleteWhen = 04
fileReservedTime = 48
brokerRole = ASYNC_MASTER
flushDiskType = ASYNC_FLUSH
brokerIP1=192.168.3.200
namesrvAddr=192.168.3.200:9876
# 加入开启过滤
enablePropertyFilter=true

</code></pre> 
<h6><a id="5721_SQL__3780"></a>5.7.2.1 SQL 基本语法</h6> 
<p>RocketMQ 定义了一些基本语法来支持这个特性。你也可以很容易地扩展它。</p> 
<ol><li>数值比较：比如：<code>&gt;</code>，<code>&gt;=</code>，<code>&lt;</code>，<code>&lt;=</code>，<code>BETWEEN</code>，<code>=</code>；</li><li>字符比较：比如：<code>=</code>，<code>&lt;&gt;</code>，<code>IN</code>；</li><li><code>IS NULL</code> 或者 <code>IS NOT NULL</code>；</li></ol> 
<ul><li>逻辑符号：<code>AND</code>，<code>OR</code>，<code>NOT</code>；</li></ul> 
<p>常量支持类型为：</p> 
<ol><li>数值，比如：123，3.1415；</li><li>字符，比如：‘abc’，必须用单引号包裹起来；</li><li><code>NULL</code>，特殊的常量</li><li>布尔值，<code>TRUE</code> 或 <code>FALSE</code></li></ol> 
<p>只有推送消费者才能通过 SQL92 选择消息。界面是：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">MessageSelector</span> messageSelector<span class="token punctuation">)</span>
</code></pre> 
<ul><li>生产者</li></ul> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @author Crazy.X
 * sql过滤 -消息生产者（加入消息属性)
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SqlFilterProducer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 实例化消息生产者Producer</span>
        <span class="token class-name">DefaultMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">"SqlFilterProducer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置NameServer的地址</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tags <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span><span class="token string">"TagA"</span><span class="token punctuation">,</span> <span class="token string">"TagB"</span><span class="token punctuation">,</span> <span class="token string">"TagC"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Message</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">"SqlFilterTest"</span><span class="token punctuation">,</span>
                    tags<span class="token punctuation">[</span>i <span class="token operator">%</span> tags<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token punctuation">(</span><span class="token string">"Hello RocketMQ "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">RemotingHelper</span><span class="token punctuation">.</span>DEFAULT_CHARSET<span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 设置一些属性</span>
            msg<span class="token punctuation">.</span><span class="token function">putUserProperty</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">SendResult</span> sendResult <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s%n"</span><span class="token punctuation">,</span> sendResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果不再发送消息，关闭Producer实例</span>
        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-gNbt2Feu-1625329015950)(F164F22ABFA84FFC8856FA67714EF23E)]</p> 
<ul><li>消费者</li></ul> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @author Crazy.X
 * sql过滤-消费者
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SqlFilterConsumer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 实例化消息消费者,指定组名</span>
        <span class="token class-name">DefaultMQPushConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">"SqlFilterConsumer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置NameServer的地址</span>
        consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Don't forget to set enablePropertyFilter=true in broker</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"SqlFilterTest"</span><span class="token punctuation">,</span>
                <span class="token class-name">MessageSelector</span><span class="token punctuation">.</span><span class="token function">bySql</span><span class="token punctuation">(</span><span class="token string">"(TAGS is not null and TAGS in ('TagA', 'TagB'))"</span> <span class="token operator">+</span>
                        <span class="token string">"and (a is not null and a between 0 and 3)"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>msgs<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MessageExt</span> msg <span class="token operator">:</span> msgs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">String</span> topic <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> msgBody <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> msgPro <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token class-name">String</span> tags <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"收到消息："</span> <span class="token operator">+</span> <span class="token string">" topic :"</span> <span class="token operator">+</span> topic <span class="token operator">+</span> <span class="token string">" ,tags : "</span> <span class="token operator">+</span> tags <span class="token operator">+</span> <span class="token string">" ,a : "</span> <span class="token operator">+</span> msgPro <span class="token operator">+</span> <span class="token string">" ,msg : "</span> <span class="token operator">+</span> msgBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span>RECONSUME_LATER<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span>CONSUME_SUCCESS<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Consumer Started.%n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-YnsOXScn-1625329015951)(D0F8B853E65B4966941D94625406F91D)]</p> 
<h4><a id="58__3877"></a>5.8 事务消息</h4> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-6p8xsA7q-1625329015951)(FA2B1AAA9C484353B1EA14A1DFC22F75)]</p> 
<p>其中分为两个流程：正常事务消息的发送及提交、事务消息的补偿流程。</p> 
<h5><a id="581__3883"></a>5.8.1 正常事务流程</h5> 
<p>(1) 发送消息（half 消息）：图中步骤 1。</p> 
<p>(2) 服务端响应消息写入结果：图中步骤 2。</p> 
<p>(3) 根据发送结果执行本地事务（如果写入失败，此时 half 消息对业务不可见，本地逻辑不执行）：图中步骤 3。</p> 
<p>(4) 根据本地事务状态执行 Commit 或者 Rollback（Commit 操作生成消息索引，消息对消费者可见）：图中步骤 4</p> 
<h5><a id="582__3893"></a>5.8.2 事务补偿流程</h5> 
<p>(1) 对没有 Commit/Rollback 的事务消息（pending 状态的消息），从服务端发起一次“回查”：图中步骤 5。</p> 
<p>(2) Producer 收到回查消息，检查回查消息对应的本地事务的状态：图中步骤 6。</p> 
<p>(3) 根据本地事务状态，重新 Commit 或者 Rollback：：图中步骤 6。</p> 
<p>其中，补偿阶段用于解决消息 Commit 或者 Rollback 发生超时或者失败的情况。</p> 
<h5><a id="583__3903"></a>5.8.3 事务消息状态</h5> 
<p>事务消息共有三种状态，提交状态、回滚状态、中间状态：</p> 
<ul><li>TransactionStatus.CommitTransaction: 提交状态，它允许消费者消费此消息（完成图中了 1，2,3,4 步，第 4 步是 Commit）。</li><li>TransactionStatus.RollbackTransaction: 回滚状态，它代表该消息将被删除，不允许被消费（完成图中了 1，2,3,4 步, 第 4 步是 Rollback）。</li><li>ransactionStatus.Unknown: 中间状态，它代表需要检查消息队列来确定状态（完成图中了 1，2,3 步, 但是没有 4 或者没有 7，无法 Commit</li></ul> 
<h5><a id="584__3911"></a>5.8.4 创建事务性生产者</h5> 
<p>使用 TransactionMQProducer 类创建生产者，并指定唯一的 ProducerGroup，就可以设置自定义线程池来处理这些检查请求。执行本地事务后、需<br> 要根据执行结果对消息队列进行回复</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @author Crazy.X
 * 事务消息-消息发送方
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransactionProducer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MQClientException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 创建事务监听器</span>
        <span class="token class-name">TransactionListener</span> transactionListener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransactionListenerImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建消息生产者</span>
        <span class="token class-name">TransactionMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransactionMQProducer</span><span class="token punctuation">(</span><span class="token string">"TransactionProducer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置NameServer的地址</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建线程池</span>
        <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>
                <span class="token number">2</span><span class="token punctuation">,</span>
                <span class="token number">5</span><span class="token punctuation">,</span>
                <span class="token number">100</span><span class="token punctuation">,</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            thread<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"client-transaction-msg-check-thread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> thread<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置生产者回查线程池</span>
        producer<span class="token punctuation">.</span><span class="token function">setExecutorService</span><span class="token punctuation">(</span>executorService<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 生产者设置监听器</span>
        producer<span class="token punctuation">.</span><span class="token function">setTransactionListener</span><span class="token punctuation">(</span>transactionListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 启动消息生产者</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tags <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span><span class="token string">"TagA"</span><span class="token punctuation">,</span> <span class="token string">"TagB"</span><span class="token punctuation">,</span> <span class="token string">"TagC"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Message</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span>
                        <span class="token string">"TransactionTopic"</span><span class="token punctuation">,</span>
                        tags<span class="token punctuation">[</span>i <span class="token operator">%</span> tags<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">,</span>
                        <span class="token string">"KEY"</span> <span class="token operator">+</span> i<span class="token punctuation">,</span>
                        <span class="token punctuation">(</span><span class="token string">"Hello RocketMQ "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">RemotingHelper</span><span class="token punctuation">.</span>DEFAULT_CHARSET<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//1,2步  半事务的发送，确认。</span>
                <span class="token class-name">SendResult</span> sendResult <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">sendMessageInTransaction</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s%n"</span><span class="token punctuation">,</span> sendResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MQClientException</span> <span class="token operator">|</span> <span class="token class-name">UnsupportedEncodingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="585__3971"></a>5.8.5 实现事务的监听接口</h5> 
<p>当发送半消息成功时，我们使用 executeLocalTransaction 方法来执行本地事务（<strong>步骤 3</strong>）。它返回前一节中提到的三个事务状态之一。<br> checkLocalTranscation 方法用于检查本地事务状态（<strong>步骤 5</strong>），并回应消息队列的检查请求。它也是返回前一节中提到的三个事务状态之一。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransactionListenerImpl</span> <span class="token keyword">implements</span> <span class="token class-name">TransactionListener</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 事务状态记录</span>
    <span class="token keyword">private</span> <span class="token class-name">AtomicInteger</span> transactionIndex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> localTrans <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//执行本地事务 3</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">LocalTransactionState</span> <span class="token function">executeLocalTransaction</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">,</span> <span class="token class-name">Object</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"执行本地事务"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> value <span class="token operator">=</span> transactionIndex<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//0,1,2</span>
        <span class="token keyword">int</span> status <span class="token operator">=</span> value <span class="token operator">%</span> <span class="token number">3</span><span class="token punctuation">;</span>
        localTrans<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getTransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//这里模拟的不进行步骤4  A系统不知道的--UNKNOW</span>
        <span class="token keyword">return</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span>UNKNOW<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//检查本地事务状态  默认是60s，一分钟检查一次</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">LocalTransactionState</span> <span class="token function">checkLocalTransaction</span><span class="token punctuation">(</span><span class="token class-name">MessageExt</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//打印每次回查的时间</span>
        <span class="token class-name">SimpleDateFormat</span> df <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">"yyyy-MM-dd HH:mm:ss"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置日期格式</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"checkLocalTransaction:"</span> <span class="token operator">+</span> df<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// new Date()为获取当前系统时间</span>
        <span class="token class-name">Integer</span> status <span class="token operator">=</span> localTrans<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getTransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> status<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"MQ检查消息【"</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span><span class="token function">getTransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"】事务状态【中间状态】"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span>UNKNOW<span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"MQ检查消息【"</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span><span class="token function">getTransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"】事务状态【提交状态】"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span>COMMIT_MESSAGE<span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"MQ检查消息【"</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span><span class="token function">getTransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"】事务状态【回滚状态】"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span>ROLLBACK_MESSAGE<span class="token punctuation">;</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"MQ检查消息【"</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span><span class="token function">getTransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"】事务状态【提交状态】"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span>COMMIT_MESSAGE<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//  System.out.println("MQ检查消息【"+msg.getTransactionId()+"】事务状态【提交状态】");</span>
        <span class="token keyword">return</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span>COMMIT_MESSAGE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="586__4025"></a>5.8.6 消息消费者</h5> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @author Crazy.X
 * 事务消息-消费者
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransactionalConsumer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 实例化消息生产者,指定组名</span>
        <span class="token class-name">DefaultMQPushConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">"TransactionalConsumer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置NameServer的地址</span>
        consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.3.200:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 订阅Topic</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"TransactionTopic"</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//负载均衡模式消费</span>
        consumer<span class="token punctuation">.</span><span class="token function">setMessageModel</span><span class="token punctuation">(</span><span class="token class-name">MessageModel</span><span class="token punctuation">.</span>CLUSTERING<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 注册回调函数，处理消息</span>
        consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>msgs<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MessageExt</span> msg <span class="token operator">:</span> msgs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">String</span> topic <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> msgBody <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> msgPro <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token class-name">String</span> tags <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"收到消息："</span> <span class="token operator">+</span> <span class="token string">" topic :"</span> <span class="token operator">+</span> topic <span class="token operator">+</span> <span class="token string">" ,tags : "</span> <span class="token operator">+</span> tags <span class="token operator">+</span> <span class="token string">" ,a : "</span> <span class="token operator">+</span> msgPro <span class="token operator">+</span> <span class="token string">" ,msg : "</span> <span class="token operator">+</span> msgBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span>RECONSUME_LATER<span class="token punctuation">;</span>

            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span>CONSUME_SUCCESS<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//启动消息者</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Consumer Started.%n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="587__4067"></a>5.8.7 使用场景</h5> 
<p>用户提交订单后，扣减库存成功、扣减优惠券成功、使用余额成功，但是在确认订单操作失败，需要对库存、库存、余额进行回退。如何保证数据<br> 的完整性？</p> 
<p>可以使用 RocketMQ 的分布式事务保证在下单失败后系统数据的完整性</p> 
<h5><a id="588__4074"></a>5.8.8 使用限制</h5> 
<ol><li>事务消息不支持延时消息和批量消息。</li><li>事务回查的间隔时间：BrokerConfig. transactionCheckInterval 通过 Broker 的配置文件设置好。3. 为了避免单个消息被检查太多次而导致半队列消息累积，我们默认将单个消息的检查次数限制为 15 次，但是用户可以通过 Broker 配置文件的<br> transactionCheckMax 参数来修改此限制。如果已经检查某条消息超过 N 次的话（ N = transactionCheckMax ） 则 Broker 将丢弃此消息，并在默认<br> 情况下同时打印错误日志。用户可以通过重写 AbstractTransactionCheckListener 类来修改这个行为。</li><li>事务消息将在 Broker 配置文件中的参数 transactionMsgTimeout 这样的特定时间长度之后被检查。当发送事务消息时，用户还可以通过设置用<br> 户属性 CHECK_IMMUNITY_TIME_IN_SECONDS 来改变这个限制，该参数优先于 transactionMsgTimeout 参数。</li><li>事务性消息可能不止一次被检查或消费。</li><li>事务性消息中用到了生产者群组，这种就是一种高可用机制，用来确保事务消息的可靠性。</li><li>提交给用户的目标主题消息可能会失败，目前这依日志的记录而定。它的高可用性通过 RocketMQ 本身的高可用性机制来保证，如果希望确保事<br> 务消息不丢失、并且事务完整性得到保证，建议使用同步的双重写入机制。</li><li>事务消息的生产者 ID 不能与其他类型消息的生产者 ID 共享。与其他类型的消息不同，事务消息允许反向查询、MQ 服务器能通过它们的生产者<br> ID 查询到消费者。</li></ol>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c491a9d7c4ad478b1f18abd2ca96099c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">IntentFilter详解</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a6617375181deaaee9106432808a408a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">java8 stream().map().collect()用法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>