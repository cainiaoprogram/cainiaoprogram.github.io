<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【云原生之k8s】k8s管理工具kubectl详解 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【云原生之k8s】k8s管理工具kubectl详解" />
<meta property="og:description" content="【云原生之k8s】k8s管理工具kubectl详解 前言一、陈述式管理(1)陈述式资源管理方法(2)k8s相关信息查看①查看版本信息②查看节点信息③查看资源对象简写④查看集群信息⑤配置kubectl自动补全⑥查看日志⑦基本信息查看1、查看master节点状态2、查看命名空间 ⑧命名空间操作1、查看default命名空间的所有资源2、创建命名空间3、删除命名空间 ⑨deployment/pod操作1、在命名空间kube-public创建副本控制器（deploment）来启动Pod（nginx-test）2、描述某个资源的详细信息3、查看命名空间kube-public中pod信息4、登录容器5、测试（重启）pod资源6、若无法删除，总是处于terminate状态，则要强行删除pod7、扩缩容7.1扩容7.2缩容 8、删除副本控制器 ⑩删除/增加label1、增加label2、删除label 二、声明式管理(1)声明式管理方法(2)查看资源配置清单(3)解释资源配置清单(4)修改资源配置清单并应用①离线修改1、修改yaml文件2、删除资源3、新建资源4、查看service资源 ②在线修改 (5)删除资源配置清单①陈述式删除②声明式删除 三、K8S模拟项目(1)项目的生命周期(2)创建kubectl run命令(3)发布kubectl expose命令①Service的作用②Service的类型③查看Pod网络状态详细信息和service暴露端口④查看关联后端的节点⑤查看service的描述信息 ⑥访问查看⑦查看访问日志 (4)更新kubectl set①获取修改模板②查看当前nginx的版本号③将nginx版本更新为1.15④监听pod状态⑤查看pod的ip变化 (5)回滚kubectl rollout①查看历史版本②执行回滚到上个版本③执行回滚到指定版本④检查回滚状态 (6)删除kubectl delete①删除副本控制器②删除service 四、金丝雀发布/灰度发布（Canary Release）(1)金丝雀发布简介(2)更新deployment的版本，并配置暂停deployment①创建pod②发布服务③查看nginx版本④定义版本change-cause1、查看历史版本2、定义版本3、再次查看历史版本4、更新nginx版本为1.15并配置暂停⑤观察更新状态⑥监控更新的过程⑦查看nginx版本⑧查看并更新历史版本change-cause⑨resume继续更新 前言 一、陈述式管理 (1)陈述式资源管理方法 kubernetes 集群管理集群资源的唯一入口是通过相应的方法调用 apiserver 的接口kubectl 是官方的 CLI 命令行工具，用于与 apiserver 进行通信，将用户在命令行输入的命令，组织并转化为apiserver 能识别的信息，进而实现管理 k8s 各种资源的一种有效途径kubectl 的命令大全
kubectl --helpk8s官方中文文档：http://docs.kubernetes.org.cn/683.html对资源的增、删、查操作比较容易，但对改的操作就不容易了 (2)k8s相关信息查看 ①查看版本信息 kubectl version ②查看节点信息 kubectl get nodes ③查看资源对象简写 kubectl api-resources ④查看集群信息 kubectl cluster-info ⑤配置kubectl自动补全 source &lt;(kubectl completion bash) 可通过TAB键实现命令补全，建议将其写入 /etc/profile
⑥查看日志 journalctl -u kubelet -f ⑦基本信息查看 kubectl get [-o wide|json|yaml] [-n namespace] 获取资源的相关信息，-n指定命名空间，-o指定输出格式" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/6de70e363787a409412ec57ee1612488/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-08T20:05:56+08:00" />
<meta property="article:modified_time" content="2022-08-08T20:05:56+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【云原生之k8s】k8s管理工具kubectl详解</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>【云原生之k8s】k8s管理工具kubectl详解</h4> 
 <ul><li><a href="#_1" rel="nofollow">前言</a></li><li><a href="#_3" rel="nofollow">一、陈述式管理</a></li><li><ul><li><a href="#1_4" rel="nofollow">(1)陈述式资源管理方法</a></li><li><a href="#2k8s_12" rel="nofollow">(2)k8s相关信息查看</a></li><li><ul><li><a href="#_13" rel="nofollow">①查看版本信息</a></li><li><a href="#_17" rel="nofollow">②查看节点信息</a></li><li><a href="#_21" rel="nofollow">③查看资源对象简写</a></li><li><a href="#_26" rel="nofollow">④查看集群信息</a></li><li><a href="#kubectl_29" rel="nofollow">⑤配置kubectl自动补全</a></li><li><a href="#_34" rel="nofollow">⑥查看日志</a></li><li><a href="#_38" rel="nofollow">⑦基本信息查看</a></li><li><ul><li><a href="#1master_49" rel="nofollow">1、查看master节点状态</a></li><li><a href="#2_56" rel="nofollow">2、查看命名空间</a></li></ul> 
    </li><li><a href="#_64" rel="nofollow">⑧命名空间操作</a></li><li><ul><li><a href="#1default_65" rel="nofollow">1、查看default命名空间的所有资源</a></li><li><a href="#2_72" rel="nofollow">2、创建命名空间</a></li><li><a href="#3_76" rel="nofollow">3、删除命名空间</a></li></ul> 
    </li><li><a href="#deploymentpod_80" rel="nofollow">⑨deployment/pod操作</a></li><li><ul><li><a href="#1kubepublicdeplomentPodnginxtest_81" rel="nofollow">1、在命名空间kube-public创建副本控制器（deploment）来启动Pod（nginx-test）</a></li><li><a href="#2_85" rel="nofollow">2、描述某个资源的详细信息</a></li><li><a href="#3kubepublicpod_93" rel="nofollow">3、查看命名空间kube-public中pod信息</a></li><li><a href="#4_97" rel="nofollow">4、登录容器</a></li><li><a href="#5pod_103" rel="nofollow">5、测试（重启）pod资源</a></li><li><a href="#6terminatepod_110" rel="nofollow">6、若无法删除，总是处于terminate状态，则要强行删除pod</a></li><li><a href="#7_118" rel="nofollow">7、扩缩容</a></li><li><ul><li><a href="#71_119" rel="nofollow">7.1扩容</a></li><li><a href="#72_123" rel="nofollow">7.2缩容</a></li></ul> 
     </li><li><a href="#8_127" rel="nofollow">8、删除副本控制器</a></li></ul> 
    </li><li><a href="#label_131" rel="nofollow">⑩删除/增加label</a></li><li><ul><li><a href="#1label_132" rel="nofollow">1、增加label</a></li><li><a href="#2label_137" rel="nofollow">2、删除label</a></li></ul> 
   </li></ul> 
  </li></ul> 
  </li><li><a href="#_141" rel="nofollow">二、声明式管理</a></li><li><ul><li><a href="#1_142" rel="nofollow">(1)声明式管理方法</a></li><li><a href="#2_149" rel="nofollow">(2)查看资源配置清单</a></li><li><a href="#3_157" rel="nofollow">(3)解释资源配置清单</a></li><li><a href="#4_165" rel="nofollow">(4)修改资源配置清单并应用</a></li><li><ul><li><a href="#_166" rel="nofollow">①离线修改</a></li><li><ul><li><a href="#1yaml_167" rel="nofollow">1、修改yaml文件</a></li><li><a href="#2_174" rel="nofollow">2、删除资源</a></li><li><a href="#3_178" rel="nofollow">3、新建资源</a></li><li><a href="#4service_182" rel="nofollow">4、查看service资源</a></li></ul> 
    </li><li><a href="#_186" rel="nofollow">②在线修改</a></li></ul> 
   </li><li><a href="#5_200" rel="nofollow">(5)删除资源配置清单</a></li><li><ul><li><a href="#_201" rel="nofollow">①陈述式删除</a></li><li><a href="#_205" rel="nofollow">②声明式删除</a></li></ul> 
  </li></ul> 
  </li><li><a href="#K8S_209" rel="nofollow">三、K8S模拟项目</a></li><li><ul><li><a href="#1_258" rel="nofollow">(1)项目的生命周期</a></li><li><a href="#2kubectl_run_260" rel="nofollow">(2)创建kubectl run命令</a></li><li><a href="#3kubectl_expose_284" rel="nofollow">(3)发布kubectl expose命令</a></li><li><ul><li><a href="#Service_293" rel="nofollow">①Service的作用</a></li><li><a href="#Service_299" rel="nofollow">②Service的类型</a></li><li><a href="#Podservice_304" rel="nofollow">③查看Pod网络状态详细信息和service暴露端口</a></li><li><a href="#_308" rel="nofollow">④查看关联后端的节点</a></li><li><ul><li><a href="#service_311" rel="nofollow">⑤查看service的描述信息</a></li></ul> 
    </li><li><a href="#_315" rel="nofollow">⑥访问查看</a></li><li><a href="#_322" rel="nofollow">⑦查看访问日志</a></li></ul> 
   </li><li><a href="#4kubectl_set_326" rel="nofollow">(4)更新kubectl set</a></li><li><ul><li><a href="#_331" rel="nofollow">①获取修改模板</a></li><li><a href="#nginx_335" rel="nofollow">②查看当前nginx的版本号</a></li><li><a href="#nginx115_338" rel="nofollow">③将nginx版本更新为1.15</a></li><li><a href="#pod_342" rel="nofollow">④监听pod状态</a></li><li><a href="#podip_351" rel="nofollow">⑤查看pod的ip变化</a></li></ul> 
   </li><li><a href="#5kubectl_rollout_357" rel="nofollow">(5)回滚kubectl rollout</a></li><li><ul><li><a href="#_362" rel="nofollow">①查看历史版本</a></li><li><a href="#_366" rel="nofollow">②执行回滚到上个版本</a></li><li><a href="#_373" rel="nofollow">③执行回滚到指定版本</a></li><li><a href="#_381" rel="nofollow">④检查回滚状态</a></li></ul> 
   </li><li><a href="#6kubectl_delete_386" rel="nofollow">(6)删除kubectl delete</a></li><li><ul><li><a href="#_387" rel="nofollow">①删除副本控制器</a></li><li><a href="#service_391" rel="nofollow">②删除service</a></li></ul> 
  </li></ul> 
  </li><li><a href="#Canary_Release_395" rel="nofollow">四、金丝雀发布/灰度发布（Canary Release）</a></li><li><ul><li><a href="#1_396" rel="nofollow">(1)金丝雀发布简介</a></li><li><a href="#2deploymentdeployment_398" rel="nofollow">(2)更新deployment的版本，并配置暂停deployment</a></li><li><ul><li><a href="#pod_399" rel="nofollow">①创建pod</a></li><li><a href="#_404" rel="nofollow">②发布服务</a></li><li><a href="#nginx_409" rel="nofollow">③查看nginx版本</a></li><li><a href="#changecause_414" rel="nofollow">④定义版本change-cause</a></li><li><ul><li><a href="#1_415" rel="nofollow">1、查看历史版本</a></li><li><a href="#2_421" rel="nofollow">2、定义版本</a></li><li><a href="#3_436" rel="nofollow">3、再次查看历史版本</a></li><li><a href="#4nginx115_440" rel="nofollow">4、更新nginx版本为1.15并配置暂停</a></li><li><a href="#_444" rel="nofollow">⑤观察更新状态</a></li><li><a href="#_448" rel="nofollow">⑥监控更新的过程</a></li><li><a href="#nginx_454" rel="nofollow">⑦查看nginx版本</a></li><li><a href="#changecause_459" rel="nofollow">⑧查看并更新历史版本change-cause</a></li><li><a href="#resume_476" rel="nofollow">⑨resume继续更新</a></li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>前言</h2> 
<h2><a id="_3"></a>一、陈述式管理</h2> 
<h3><a id="1_4"></a>(1)陈述式资源管理方法</h3> 
<ol><li>kubernetes 集群管理集群资源的唯一入口是通过相应的方法调用 apiserver 的接口</li><li>kubectl 是官方的 CLI 命令行工具，用于与 apiserver 进行通信，将用户在命令行输入的命令，组织并转化为apiserver 能识别的信息，进而实现管理 k8s 各种资源的一种有效途径</li><li>kubectl 的命令大全<br> kubectl --help</li><li>k8s官方中文文档：http://docs.kubernetes.org.cn/683.html</li><li>对资源的增、删、查操作比较容易，但对改的操作就不容易了</li></ol> 
<h3><a id="2k8s_12"></a>(2)k8s相关信息查看</h3> 
<h4><a id="_13"></a>①查看版本信息</h4> 
<pre><code>kubectl version
</code></pre> 
<p><img src="https://images2.imgbox.com/e4/d6/2pVeH8oW_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_17"></a>②查看节点信息</h4> 
<pre><code>kubectl get nodes
</code></pre> 
<p><img src="https://images2.imgbox.com/d7/d8/gJB9ll4c_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_21"></a>③查看资源对象简写</h4> 
<pre><code>kubectl api-resources
</code></pre> 
<p><img src="https://images2.imgbox.com/f2/09/ldZrbqa8_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_26"></a>④查看集群信息</h4> 
<pre><code>kubectl cluster-info
</code></pre> 
<p><img src="https://images2.imgbox.com/af/39/4uZaB4Mi_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="kubectl_29"></a>⑤配置kubectl自动补全</h4> 
<pre><code> source &lt;(kubectl completion bash)
</code></pre> 
<p><strong>可通过TAB键实现命令补全，建议将其写入 /etc/profile</strong></p> 
<h4><a id="_34"></a>⑥查看日志</h4> 
<pre><code>journalctl -u kubelet -f
</code></pre> 
<p><img src="https://images2.imgbox.com/95/19/k6buTSny_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_38"></a>⑦基本信息查看</h4> 
<pre><code>kubectl get [-o wide|json|yaml] [-n namespace]
</code></pre> 
<p>获取资源的相关信息，-n指定命名空间，-o指定输出格式<br> resource可以是具体资源名称，如"pod nhinx-xxx"；也可以是资源类型，如“pod,node,svc,deploy”多种资源使用逗号间隔；或者all（仅展示几种核心资源，并不完整）</p> 
<ol><li>–all-namespaces或-A：表示显示所有命名空间</li><li>–show-labels：显示所有标签</li><li>-l app：仅显示标签为app的资源</li><li>-l app=nginx：仅显示包含app标签，且值为nginx的资源</li></ol> 
<h5><a id="1master_49"></a>1、查看master节点状态</h5> 
<pre><code>kubectl get componentstatuses

#componentstatues可以缩写成cs
kubectl get cs
</code></pre> 
<p><img src="https://images2.imgbox.com/89/fd/d77XRtvs_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="2_56"></a>2、查看命名空间</h5> 
<pre><code>kubectl get namespace

#namespace可以缩写成ns
kubectl get ns
</code></pre> 
<p><img src="https://images2.imgbox.com/00/0c/UxsTaa1U_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_64"></a>⑧命名空间操作</h4> 
<h5><a id="1default_65"></a>1、查看default命名空间的所有资源</h5> 
<pre><code>kubectl get all [-n default]
</code></pre> 
<p><strong>由于deafult为缺省空间，当不指定命名空间时默认查看default命名空间</strong></p> 
<p><img src="https://images2.imgbox.com/e7/8d/07E38V9n_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="2_72"></a>2、创建命名空间</h5> 
<p>kubectl create ns lcdb</p> 
<p><img src="https://images2.imgbox.com/9f/20/fom7whie_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="3_76"></a>3、删除命名空间</h5> 
<pre><code>kubectl delete ns lcdb
</code></pre> 
<p><img src="https://images2.imgbox.com/e7/1d/22gx8Vre_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="deploymentpod_80"></a>⑨deployment/pod操作</h4> 
<h5><a id="1kubepublicdeplomentPodnginxtest_81"></a>1、在命名空间kube-public创建副本控制器（deploment）来启动Pod（nginx-test）</h5> 
<pre><code>kubectl create deployment nginx-test --image=nginx -n kube-public
</code></pre> 
<p><img src="https://images2.imgbox.com/33/7e/1LDWf2dN_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="2_85"></a>2、描述某个资源的详细信息</h5> 
<pre><code>kubectl describe deployment nginx-test -n kube-public
</code></pre> 
<p><img src="https://images2.imgbox.com/39/c0/ddtqe9ax_o.png" alt="在这里插入图片描述"></p> 
<pre><code>kubectl describe pod nginx-test -n kube-public
</code></pre> 
<p><img src="https://images2.imgbox.com/9d/b9/HKImo877_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="3kubepublicpod_93"></a>3、查看命名空间kube-public中pod信息</h5> 
<pre><code>kubectl get pods -n kube-public
</code></pre> 
<p><img src="https://images2.imgbox.com/38/1d/loZkcmq9_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="4_97"></a>4、登录容器</h5> 
<p><strong>kubectl exec 可以跨主机登录容器，docker exec 只能在容器所在主机登录</strong></p> 
<pre><code>kubectl exec -it nginx-test-795d659f45-lqjcb bash -n kube-public
</code></pre> 
<p><img src="https://images2.imgbox.com/b5/d6/DWSXZ5co_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="5pod_103"></a>5、测试（重启）pod资源</h5> 
<p><strong>由于存在 deployment/rc 之类的副本控制器，删除 pod 也会重新拉起来</strong></p> 
<pre><code>kubectl delete pod nginx-test-795d659f45-lqjcb -n kube-public
kubectl get pod -n kube-public
</code></pre> 
<p><img src="https://images2.imgbox.com/7c/d4/ilKSwl4x_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="6terminatepod_110"></a>6、若无法删除，总是处于terminate状态，则要强行删除pod</h5> 
<pre><code>kubectl delete pod [] -n [] --force --grace-period=0
</code></pre> 
<p><strong>grace-period表示过渡存活期，默认30s，在删除pod之前允许pod慢慢终止其上的容器进程，从而优雅的退出，0表示立即终止pod</strong></p> 
<p><img src="https://images2.imgbox.com/b1/2e/wBSPfLBN_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="7_118"></a>7、扩缩容</h5> 
<h6><a id="71_119"></a>7.1扩容</h6> 
<pre><code>kubectl scale deployment nginx-test --replicas=3 -n kube-public
</code></pre> 
<p><img src="https://images2.imgbox.com/70/3b/OKEOzcMQ_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="72_123"></a>7.2缩容</h6> 
<pre><code>kubectl scale deployment nginx-test --replicas=1 -n kube-public
</code></pre> 
<p><img src="https://images2.imgbox.com/35/ef/d0bNj5jN_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="8_127"></a>8、删除副本控制器</h5> 
<pre><code>kubectl delete deployment nginx-test -n kube-public
</code></pre> 
<p><img src="https://images2.imgbox.com/c7/ad/YMrairVG_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="label_131"></a>⑩删除/增加label</h4> 
<h5><a id="1label_132"></a>1、增加label</h5> 
<pre><code>kubectl label deploy nginx-test version=nginx1.14
</code></pre> 
<p><img src="https://images2.imgbox.com/07/61/vZnHwfPe_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="2label_137"></a>2、删除label</h5> 
<pre><code>kubectl label deploy nginx-test version-
</code></pre> 
<p><img src="https://images2.imgbox.com/9b/3e/aPTFltjM_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_141"></a>二、声明式管理</h2> 
<h3><a id="1_142"></a>(1)声明式管理方法</h3> 
<ol><li>适合于对资源的修改操作</li><li>声明式资源管理方法依赖于资源配置清明文件对资源进行管理</li><li>资源配置清单文件有两种格式：yaml（人性化，易读），json（易于api接口解析）</li><li>对资源的观念里，是通过实现定义在同一资源配置清单内，再通过陈述式命令应用到k8s集群里</li><li>语法格式：kubectl create/apply/delete -f -o yaml</li></ol> 
<h3><a id="2_149"></a>(2)查看资源配置清单</h3> 
<pre><code>kubectl get deploy/nginx -o yaml
</code></pre> 
<p><img src="https://images2.imgbox.com/15/82/dtgFVnQs_o.png" alt="在这里插入图片描述"></p> 
<pre><code>kubectl get service nginx -o yaml
</code></pre> 
<p><img src="https://images2.imgbox.com/46/85/I6dAig7x_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3_157"></a>(3)解释资源配置清单</h3> 
<pre><code>kubectl explain deployment.metadata
</code></pre> 
<p><img src="https://images2.imgbox.com/41/84/JOpExgcm_o.png" alt="在这里插入图片描述"></p> 
<pre><code>kubectl explain service.metadata
</code></pre> 
<p><img src="https://images2.imgbox.com/b3/62/NE3VQGfh_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="4_165"></a>(4)修改资源配置清单并应用</h3> 
<h4><a id="_166"></a>①离线修改</h4> 
<h5><a id="1yaml_167"></a>1、修改yaml文件</h5> 
<p>修改yaml文件：并用kubectl apply -f xxxx.yaml文件使之生效<br> 注意：当apply不生效时，先使用delete清除资源，再apply创建资源</p> 
<pre><code>kubectl get service nginx-service -o yaml &gt; nginx-svc.yaml
</code></pre> 
<p><img src="https://images2.imgbox.com/63/a0/0VxOpUgK_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="2_174"></a>2、删除资源</h5> 
<pre><code>kubectl delete -f nginx-svc.yaml
</code></pre> 
<p><img src="https://images2.imgbox.com/12/3c/N2d7F6s1_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="3_178"></a>3、新建资源</h5> 
<pre><code>kubectl apply -f nginx-svc.yaml
</code></pre> 
<p><img src="https://images2.imgbox.com/a8/94/vX2o6x9Q_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="4service_182"></a>4、查看service资源</h5> 
<pre><code>kubectl get svc
</code></pre> 
<p><img src="https://images2.imgbox.com/70/9b/svqAVlv8_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_186"></a>②在线修改</h4> 
<p>直接使用kubectl edit service nginx在线编辑配置资源清单并保存退出即时生效（如port: 888）</p> 
<p><strong>PS：此修改方式不会对yaml文件内容修改</strong></p> 
<pre><code>kubectl edit service nginx
</code></pre> 
<p><img src="https://images2.imgbox.com/29/5c/oVnHkoq4_o.png" alt="在这里插入图片描述"><br> 查看service资源</p> 
<pre><code>kubectl get svc
</code></pre> 
<p><img src="https://images2.imgbox.com/5d/30/Rjbe0kLe_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="5_200"></a>(5)删除资源配置清单</h3> 
<h4><a id="_201"></a>①陈述式删除</h4> 
<pre><code>kubectl delete service nginx-service
</code></pre> 
<p><img src="https://images2.imgbox.com/3e/51/FznRZg2d_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_205"></a>②声明式删除</h4> 
<pre><code>kubectl delete -f nginx-svc.yaml
</code></pre> 
<p><img src="https://images2.imgbox.com/7d/af/3DSKSXzN_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="K8S_209"></a>三、K8S模拟项目</h2> 
<p>Kubectl是管理k8s集群的命令行工具，通过生成的json格式传递给apiserver进行创建、查看、管理的操作。</p> 
<pre><code>//帮助信息
[root@localhost bin]# kubectl --help
kubectl controls the Kubernetes cluster manager. 

Find more information at: https://kubernetes.io/docs/reference/kubectl/overview/

Basic Commands (Beginner):
  create         Create a resource from a file or from stdin.
  expose         使用 replication controller, service, deployment 或者 pod
并暴露它作为一个 新的 Kubernetes Service
  run            在集群中运行一个指定的镜像
  set            为 objects 设置一个指定的特征

Basic Commands (Intermediate):
  explain        查看资源的文档
  get            显示一个或更多 resources
  edit           在服务器上编辑一个资源
  delete         Delete resources by filenames, stdin, resources and names, or by resources and
label selector

Deploy Commands:
  rollout        Manage the rollout of a resource
  scale          为 Deployment, ReplicaSet, Replication Controller 或者 Job
设置一个新的副本数量
  autoscale      自动调整一个 Deployment, ReplicaSet, 或者 ReplicationController的副本数量

Cluster Management Commands:
  certificate    修改 certificate 资源.
  cluster-info   显示集群信息
  top            Display Resource (CPU/Memory/Storage) usage.
  cordon         标记 node 为 unschedulable
  uncordon       标记 node 为 schedulable
  drain          Drain node in preparation for maintenance
  taint          更新一个或者多个 node 上的 taints

Troubleshooting and Debugging Commands:
  describe       显示一个指定 resource 或者 group 的 resources 详情
  logs           输出容器在 pod 中的日志
  attach         Attach 到一个运行中的 container
  exec           在一个 container 中执行一个命令
  port-forward   Forward one or more local ports to a pod
  proxy          运行一个 proxy 到 Kubernetes API server
  cp             复制 files 和 directories 到 containers 和从容器中复制 files 和
directories.
  auth           Inspect authorization
</code></pre> 
<h3><a id="1_258"></a>(1)项目的生命周期</h3> 
<p>创建–&gt;发布–&gt;更新–&gt;回滚–&gt;删除</p> 
<h3><a id="2kubectl_run_260"></a>(2)创建kubectl run命令</h3> 
<ol><li>创建并运行一个或多个容器镜像</li><li>创建一个deployment或job来管理容器</li><li>kubectl run --help查看使用帮助</li></ol> 
<p><strong>启动nginx实例，暴露容器端口80，设置副本数3</strong></p> 
<pre><code>kubectl run nginx-deployment --image=nginx:1.14 --port=80 --replicas=3
</code></pre> 
<p><img src="https://images2.imgbox.com/d4/1a/G8mEOMBO_o.png" alt="在这里插入图片描述"><br> <strong>使用run报错</strong><br> <strong>k8sv1.18.0以后的版本， --replicas以后弃用该命令，推荐使用deployment创建pods</strong><br> <mark>我这里用的是1.21.3版本</mark></p> 
<ol><li> <p>想创建多个实例时可以使用：kubectl create deployment pg102 --image=pg:12 –port=5432 --replicas=3 来进行创建；</p> </li><li> <p>查看pod: kubectl get pod，用来查看使用命令创建的所有实例</p> </li><li> <p>查看deploy：kubectl get deploy，用来查看实例所创建的数量；</p> </li><li> <p><strong>高于1.17版本的建议以后直接使用create deployment创建pod管理器方式创建pod;</strong></p> <pre><code>kubectl create deployment nginx --image=nginx:1.14 --port=80 --replicas=3
</code></pre> </li></ol> 
<p><img src="https://images2.imgbox.com/83/af/dn3E2e6W_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/64/db/GY7AdPEa_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3kubectl_expose_284"></a>(3)发布kubectl expose命令</h3> 
<p><strong>将资源暴露为新的service</strong></p> 
<p>为Deployment的nginx创建Service，并通过Service的80端口转发至容器的80端口上，Service的名称为nginx-service，类型为NodePort</p> 
<pre><code>kubectl expose deployment nginx2 --port=80 --target-port=80 --name=nginx-service --type=NodePort
</code></pre> 
<p><img src="https://images2.imgbox.com/f3/71/GOQJsnxO_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="Service_293"></a>①Service的作用</h4> 
<ol><li>Kubernetes之所以需要Service，一方面是因为Pod的IP不是固定的（Pod可能会重建），另一方面是因为一组Pod实例之间总会有负载均衡的需求。</li><li>Service通过Label Selector实现的对一组的Pod的访问。</li><li>对于容器应用而言，Kubernetes提供了基于VIP（虚拟IP）的网桥的方式访问Service，再由Service重定向到相应的Pod。</li></ol> 
<h4><a id="Service_299"></a>②Service的类型</h4> 
<ol><li><mark>ClusterIP</mark>:提供一个集群内部的虚拟IP以供Pod访问（Service默认类型）</li><li><mark>NodePort</mark>:在每个Node上打开一个端口以供外部访问，Kubernetes将会在每个Node上打开一个端口并且每个Node的端口都是一样的，通过NodeIP:NodePort的方式</li><li><mark>LoadBalancer</mark>:通过外部的负载均衡器来访问，通常在云平台部署LoadBalancer还需要额外的费用。</li></ol> 
<h4><a id="Podservice_304"></a>③查看Pod网络状态详细信息和service暴露端口</h4> 
<pre><code>kubectl get pods,svc -o wide
</code></pre> 
<p><img src="https://images2.imgbox.com/97/83/6J7zQZDW_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_308"></a>④查看关联后端的节点</h4> 
<pre><code>kubectl get endpoints
</code></pre> 
<p><img src="https://images2.imgbox.com/0a/6b/WCPAMTxZ_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="service_311"></a>⑤查看service的描述信息</h5> 
<pre><code>kubectl describe svc nginx
</code></pre> 
<p><img src="https://images2.imgbox.com/a9/03/KkxxIIEt_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_315"></a>⑥访问查看</h4> 
<p><img src="https://images2.imgbox.com/ea/16/H8b3gosS_o.png" alt="在这里插入图片描述"></p> 
<pre><code>kubectl describe svc nginx | grep NodePort
curl 192.168.159.230:32683
</code></pre> 
<p><img src="https://images2.imgbox.com/09/53/WdHkdvDG_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_322"></a>⑦查看访问日志</h4> 
<pre><code>kubectl logs []
</code></pre> 
<p><img src="https://images2.imgbox.com/61/f3/OyaDgQlM_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="4kubectl_set_326"></a>(4)更新kubectl set</h3> 
<ul><li>更改现有应用资源一些信息。</li></ul> 
<p>kubectl set --help查看使用帮助</p> 
<h4><a id="_331"></a>①获取修改模板</h4> 
<pre><code>kubectl set image --help获取
</code></pre> 
<p><img src="https://images2.imgbox.com/1c/9d/JPiA8ugD_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="nginx_335"></a>②查看当前nginx的版本号</h4> 
<p><img src="https://images2.imgbox.com/a7/95/c3vOrKpG_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="nginx115_338"></a>③将nginx版本更新为1.15</h4> 
<pre><code>kubectl set image deployment/nginx nginx=nginx:1.15
</code></pre> 
<p><img src="https://images2.imgbox.com/c1/41/8WFK3kgb_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="pod_342"></a>④监听pod状态</h4> 
<p>处于动态监听pod状态，由于使用的是滚动更新方式，所以会先生成一个新的pod，然后删除一个旧的pod，往后以此类推</p> 
<pre><code>kubectl get pods -w
</code></pre> 
<p><img src="https://images2.imgbox.com/f4/05/jORVLhjD_o.png" alt="在这里插入图片描述"><br> <strong>注：更新规则可通过“kubetl describe deployment nginx”的“RollingUpdateStrategy”查看，默认配置为“25% max unavailable, 25% max surge”，即按照25%的比例进行滚动更新。</strong></p> 
<p><img src="https://images2.imgbox.com/0e/08/EiR6YYKz_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="podip_351"></a>⑤查看pod的ip变化</h4> 
<pre><code>kubectl get pod -o wide
</code></pre> 
<p><img src="https://images2.imgbox.com/a1/18/ySxzUIRE_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="5kubectl_rollout_357"></a>(5)回滚kubectl rollout</h3> 
<ul><li>对资源进行回滚管理</li></ul> 
<p><strong>kubectl rollout --help查看使用帮助</strong></p> 
<h4><a id="_362"></a>①查看历史版本</h4> 
<pre><code>kubectl rollout history deployment/nginx
</code></pre> 
<p><img src="https://images2.imgbox.com/90/1e/K0zvvxIZ_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_366"></a>②执行回滚到上个版本</h4> 
<pre><code>kubectl rollout undo deployment/nginx
kubectl get pods -o wide
</code></pre> 
<p><img src="https://images2.imgbox.com/3d/10/OI2xGbTk_o.png" alt="在这里插入图片描述"><br> 查看nginx当前版本<br> <img src="https://images2.imgbox.com/19/6e/iYSVfDet_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_373"></a>③执行回滚到指定版本</h4> 
<p>查看历史版本<br> <img src="https://images2.imgbox.com/4b/b0/hn7ZkK8s_o.png" alt="在这里插入图片描述"><br> <strong>回到revison2，即1.15版本</strong></p> 
<pre><code>kubectl rollout undo deployment/nginx --to-revision=2
</code></pre> 
<p><img src="https://images2.imgbox.com/f3/28/jfTn76OK_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_381"></a>④检查回滚状态</h4> 
<pre><code>kubectl rollout status deployment/nginx
</code></pre> 
<p><img src="https://images2.imgbox.com/87/8c/hLgVvsQ7_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="6kubectl_delete_386"></a>(6)删除kubectl delete</h3> 
<h4><a id="_387"></a>①删除副本控制器</h4> 
<pre><code>kubectl delete deployment/nginx
</code></pre> 
<p><img src="https://images2.imgbox.com/4c/b1/iblLJG4g_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="service_391"></a>②删除service</h4> 
<pre><code>kubectl delete svc/nginx-service
</code></pre> 
<p><img src="https://images2.imgbox.com/5b/93/vudFnOWO_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="Canary_Release_395"></a>四、金丝雀发布/灰度发布（Canary Release）</h2> 
<h3><a id="1_396"></a>(1)金丝雀发布简介</h3> 
<p>Deployment控制器<strong>支持自定义控制更新过程中的滚动节奏</strong>，如“暂停（pause）”或“继续（resume）”更新操作。比如等待第一批新的Pod资源创建完成后立即暂停更新过程，此时，仅存在一部分新版本的应用，主体部分还是旧的版本。然后，在筛选一小部分的用户请求路由到新版本的Pod应用，继续观察能否稳定地按期望的方式运行。确定没问题之后再继续完成余下的Pod资源滚动更新，否则立即回滚更新操作。这就是所谓的金丝雀发布。</p> 
<h3><a id="2deploymentdeployment_398"></a>(2)更新deployment的版本，并配置暂停deployment</h3> 
<h4><a id="pod_399"></a>①创建pod</h4> 
<pre><code>kubectl create deployment nginx-test --image=nginx:1.14 --replicas=3
kubectl get pods,deploy -o wide
</code></pre> 
<p><img src="https://images2.imgbox.com/85/63/OAEBA486_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_404"></a>②发布服务</h4> 
<pre><code>kubectl expose deploy nginx-test --port=80 --target-port=80 --name=nginx-service --type=NodePort
kubectl get svc -o wide
</code></pre> 
<p><img src="https://images2.imgbox.com/23/22/nRRSF9Mk_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="nginx_409"></a>③查看nginx版本</h4> 
<pre><code>curl -I 192.168.159.230:31114
kubectl describe deployment nginx-test | grep Image
</code></pre> 
<p><img src="https://images2.imgbox.com/f1/b4/0ISly63T_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="changecause_414"></a>④定义版本change-cause</h4> 
<h5><a id="1_415"></a>1、查看历史版本</h5> 
<p>在不定义CHANGE-CAUSE的情况下，缺省值为，当历史版本较多时，不便于咱们回滚时辨认版本号。因此，建议定义CHANGE-CAUSE为服务版本以帮助咱们辨认当前服务。</p> 
<pre><code>kubectl rollout history deploy/nginx-test
</code></pre> 
<p><img src="https://images2.imgbox.com/1c/1d/PNg07bJT_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="2_421"></a>2、定义版本</h5> 
<p>一般通过修改配置的方式定义change-cause</p> 
<pre><code>kubectl edit deploy/nginx-test

......
kind: Deployment
metadata:
  annotations:
#下行可定义历史版本revision
    deployment.kubernetes.io/revision: "1"
#在Deployment的matadata项下的annotations中如下行定义change-cause
    kubernetes.io/change-cause: "nginx1.14"
......
</code></pre> 
<p><img src="https://images2.imgbox.com/d4/d6/ed1ga1u4_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="3_436"></a>3、再次查看历史版本</h5> 
<pre><code>kubectl rollout history deploy/nginx-test
</code></pre> 
<p><img src="https://images2.imgbox.com/b6/54/ggBFIRV7_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="4nginx115_440"></a>4、更新nginx版本为1.15并配置暂停</h5> 
<pre><code>kubectl set image deploy/nginx-test nginx=nginx:1.15 &amp;&amp; kubectl rollout pause deploy/nginx-test
</code></pre> 
<p><img src="https://images2.imgbox.com/5d/f6/tFvSv2HT_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_444"></a>⑤观察更新状态</h5> 
<pre><code>kubectl rollout status deploy/nginx-test
</code></pre> 
<p><img src="https://images2.imgbox.com/0e/bf/PnP2AtyW_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_448"></a>⑥监控更新的过程</h5> 
<p>可以看到已经新增了一个pod，但是并未按照预期的状态去删除一个旧的资源，就是因为使用了pause暂停命令</p> 
<pre><code>kubectl get pods -w
</code></pre> 
<p><img src="https://images2.imgbox.com/f6/cf/w5mOFdxx_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="nginx_454"></a>⑦查看nginx版本</h5> 
<pre><code>kubectl get pod -o wide
</code></pre> 
<p><img src="https://images2.imgbox.com/c0/bd/ij40wjXr_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="changecause_459"></a>⑧查看并更新历史版本change-cause</h5> 
<pre><code>kubectl rollout history deploy/nginx-test
</code></pre> 
<p><img src="https://images2.imgbox.com/ec/2c/n74vMbGf_o.png" alt="在这里插入图片描述"></p> 
<pre><code>kubectl edit deploy/nginx-test

kind: Deployment
metadata:
  annotations:
#下行的revison自动更新为2
    deployment.kubernetes.io/revision: "2"
#修改下行的change-cause为nginx1.15
    kubernetes.io/change-cause: nginx1.15
</code></pre> 
<p><img src="https://images2.imgbox.com/38/b8/We4IWNCA_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/5c/98/LrvMQYQU_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="resume_476"></a>⑨resume继续更新</h5> 
<p>测试版本没问题继续更新</p> 
<pre><code>kubectl rollout resume deploy/nginx-test
</code></pre> 
<p><img src="https://images2.imgbox.com/b3/82/isgqhkvZ_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/427564c8c33b22a5b947fb91d2a3d6c9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">BGP选路原则</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1c4ce30f2111ecc328de5ec150ee5fb1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【云原生】k8s(Kubernetes)中yaml文件快速阅读理解</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>