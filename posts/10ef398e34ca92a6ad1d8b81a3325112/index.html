<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>详解bookkeeper AutoRecovery机制 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="详解bookkeeper AutoRecovery机制" />
<meta property="og:description" content="引言小故事 张三在一家小型互联网公司上班，由于公司实行的996，因此经常有同事“不辞而别”，为了工作的正常推进，团队内达成了某种默契，这种默契就是通过某个规则来选出一个同事，这个同事除了工作之余还有额外看看每天是否有同事“不辞而别”，当发现有同事李四离职时，就会去把李四负责的工作的内容进行拆分给其他的同事进行处理。整个过程大致如下图
由上图可以看到这个公司通过一个签到本和工作进度表来完成整个流程，每个同事上班时都要在签到本上进行签到，每天下班前要在工作进度表上同步今天的工作进展；例如今天李四“不辞而别”溜了，张三在签到本上看到李四没有签到记录，就判定这家伙不干了同时在工作进度表中把李四的任务进行拆分给大狗和二狗来做…
通过上面的故事会发现有几个问题
张三是通过什么规则被选成“监督者”的？如果张三也不辞而别呢？为啥要通过签到本的方式，而不是张三直接去挨个挨个看？… 咱们可以带着这些种种心里的疑惑看下面的文章，这个故事其实是一个分布式存储组件的雏形，刚刚所讨论的那些问题也是这些组件所会遇到的且大部分都是有解法的，所以咱们接下来就来看看bookkeeper这个分布式存储组件是如何解决上述问题的
bookkeeper基础 “硬件无法保证不故障”，在这个大前提下，所有运行在硬件上的存储组件都一定会做一件很重要的事情，这件事就是数据恢复，要么是在组件内部来做，要么是在组件外部来做。
bk是一个具有容错的分布式存储组件，同一份数据会有多个副本，分别存在多个bookie中来提供容错保证，那么当一台bookie不可用时，其上面保存的数据都少了一个副本，如果不进行数据恢复/复制的话再有其他的bookie不可用就很容易造成数据的丢失。因此bk自身内部提供了数据恢复的机制，今天通篇大论都是围绕bk的这个机制进行展开的
数据恢复一般分为手动和自动，bk同时支持这两种方式，接下来就看看具体怎么操作的
手动恢复
bin/bookkeeper shell recover 192.168.1.10:3181 指定bookie机器来恢复 bin/bookkeeper shell recover 192.168.1.10:3181 --ledger ledgerID 指定bookie机器上的某个ledgerId进行恢复 在执行手动恢复时，会发生以下四个步骤
客户端从zookeeper读取Ledger信息根据Ledger信息确定需要做数据复制的Ledger(根据Ledger中存有被哪些bookie存储的元信息来确定)在客户端启动一个做数据恢复的进程，针对需要做数据复制的Ledger进行数据恢复一旦所有Ledger被标记为全副本了，则恢复动作完成 自动恢复
bin/bookkeeper autorecovery bookie 集群开启自动恢复机制 bin/bookkeeper shell autorecovery -disable 关闭自动恢复机制 bin/bookkeeper shell autorecovery -enable 关闭恢复后再重新开启 除了通过指令的方式启动，bk还支持配置的方式，只需要在bookie节点配置autoRecoveryDaemonEnabled为false，这个bookie节点在启动的时候也同样会启动autorecovery服务
autorecovery机制 上一章节讲了怎么使用，本章节主要讲明autorecovery这个机制
自动恢复机制中有两个角色Auditor和replication worker，在启动自动恢复机制后，会在每个bookie实例中启动这两个角色
Auditor
bk集群中的Auditor们会通过zookeeper选举产生一位leader，这个leader负责监听 zookeeper /ledgers/available 节点变化情况来判定是否要做数据恢复动作，因为所有节点启动都会注册在上面，如果有服务不可用由于zookeeper的临时目录机制，会自动删除在此目录下自己节点的信息，因此leader通过watch机制可以轻松感知到有节点不可用，当Auditor leader感知到有节点不可用时，会将此bookie所负责的所有Ledger加在zookeeper /ledgers/underreplicated 路径下，通过这种方式通知replication worker做数据恢复过程
replication worker
每个replication worker都会监听 /ledgers/underreplicated 地址，在监听到有数据恢复任务时，会在 /ledgers/underreplication/locks下添加锁从而避免并发问题；如果在开始恢复前发下当前Ledger的Fragment还处于写入中的状态，replication worker会先尝试等待它写完再做数据恢复动作，但如果等了一段时间还没写完会通过Fence机制处理再做复制，同时开启一个新的Fragment给客户端做数据的继续写入
启动工作流程
参照上图，在服务器节点上执行bin/bookkeeper autorecovery bookie 后会发生以下步骤
通过exec shell指令调用操作系统拉起AutoRecoveryMain 这个Java进程AutoRecoveryMain进程启动时会同时启动Auditor线程和ReplicationWorker线程，由于环境中可能会启动多个AutoRecoveryMain进程来做HA高可用，因此多个Auditor线程会通过zookeeper选举来产生一个Auditor Leader由于bookie集群用zookeeper来做集群感知，因此Auditor Leader只需要通过watch监听zookeeper上 bookie所注册的地址就能感知到是否有bookie节点不可用；当bookie节点不可用时一般就不会上报心跳给zookeeper，zookeeper就会将该节点创建的临时目录进行删除并告知添加watch的Auditor LeaderAuditor Leader收到通知后会去zookeeper查询该不可用bookie所负责的Ledger列表，理论上这些Ledger都是需要做数据恢复的，因此会将它们放在zookeeper的/ledgers/underreplicated 目录下来通知ReplicationWorkerReplicationWorker通过watch监听到此目录有需要做数据恢复的Ledger后，会先在zk加锁再进行数据恢复逻辑；通过将Ledger划分为多个Fragment来轮训进行数据恢复，通过读取其他正常bookie上该Ledger的数据并写到其他没有该数据的bookie的节点上从而保证每份数据都有多个副本，直到将/ledgers/underreplicated 下的所有Ledger进行复制完，本次 autorecovery就算完成了。而Auditor线程和ReplicationWorker线程会不停的监听zookeeper直到下一个bookie节点不可用 通过此机制给bookkeeper提高了稳定性以及高可用能力，在有个别节点挂掉的时候依然能自动做到数据完备不丢，这种设计是一个成熟的组件该具备的能力" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/10ef398e34ca92a6ad1d8b81a3325112/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-04T15:25:46+08:00" />
<meta property="article:modified_time" content="2024-01-04T15:25:46+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">详解bookkeeper AutoRecovery机制</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h5><a id="_0"></a>引言小故事</h5> 
<p>张三在一家小型互联网公司上班，由于公司实行的996，因此经常有同事“不辞而别”，为了工作的正常推进，团队内达成了某种默契，这种默契就是通过某个规则来选出一个同事，这个同事除了工作之余还有额外看看每天是否有同事“不辞而别”，当发现有同事李四离职时，就会去把李四负责的工作的内容进行拆分给其他的同事进行处理。整个过程大致如下图<br> <img src="https://images2.imgbox.com/fc/f4/u66O20nQ_o.png" alt="在这里插入图片描述"></p> 
<p>由上图可以看到这个公司通过一个签到本和工作进度表来完成整个流程，每个同事上班时都要在签到本上进行签到，每天下班前要在工作进度表上同步今天的工作进展；例如今天李四“不辞而别”溜了，张三在签到本上看到李四没有签到记录，就判定这家伙不干了同时在工作进度表中把李四的任务进行拆分给大狗和二狗来做…</p> 
<p>通过上面的故事会发现有几个问题</p> 
<ul><li>张三是通过什么规则被选成“监督者”的？</li><li>如果张三也不辞而别呢？</li><li>为啥要通过签到本的方式，而不是张三直接去挨个挨个看？</li><li>…</li></ul> 
<p>咱们可以带着这些种种心里的疑惑看下面的文章，这个故事其实是一个分布式存储组件的雏形，刚刚所讨论的那些问题也是这些组件所会遇到的且大部分都是有解法的，所以咱们接下来就来看看bookkeeper这个分布式存储组件是如何解决上述问题的</p> 
<h5><a id="bookkeeper_16"></a>bookkeeper基础</h5> 
<p>“硬件无法保证不故障”，在这个大前提下，所有运行在硬件上的存储组件都一定会做一件很重要的事情，这件事就是数据恢复，要么是在组件内部来做，要么是在组件外部来做。</p> 
<p>bk是一个具有容错的分布式存储组件，同一份数据会有多个副本，分别存在多个bookie中来提供容错保证，那么当一台bookie不可用时，其上面保存的数据都少了一个副本，如果不进行数据恢复/复制的话再有其他的bookie不可用就很容易造成数据的丢失。因此bk自身内部提供了数据恢复的机制，今天通篇大论都是围绕bk的这个机制进行展开的</p> 
<p>数据恢复一般分为手动和自动，bk同时支持这两种方式，接下来就看看具体怎么操作的</p> 
<p><strong>手动恢复</strong></p> 
<pre><code class="prism language-shell">bin/bookkeeper shell recover <span class="token number">192.168</span>.1.10:3181  指定bookie机器来恢复
bin/bookkeeper shell recover <span class="token number">192.168</span>.1.10:3181 <span class="token parameter variable">--ledger</span> ledgerID 指定bookie机器上的某个ledgerId进行恢复
</code></pre> 
<p>在执行手动恢复时，会发生以下四个步骤</p> 
<ol><li>客户端从zookeeper读取Ledger信息</li><li>根据Ledger信息确定需要做数据复制的Ledger(根据Ledger中存有被哪些bookie存储的元信息来确定)</li><li>在客户端启动一个做数据恢复的进程，针对需要做数据复制的Ledger进行数据恢复</li><li>一旦所有Ledger被标记为全副本了，则恢复动作完成</li></ol> 
<p><strong>自动恢复</strong></p> 
<pre><code class="prism language-java">bin<span class="token operator">/</span>bookkeeper autorecovery bookie 集群开启自动恢复机制
bin<span class="token operator">/</span>bookkeeper shell autorecovery <span class="token operator">-</span>disable 关闭自动恢复机制
bin<span class="token operator">/</span>bookkeeper shell autorecovery <span class="token operator">-</span>enable 关闭恢复后再重新开启
</code></pre> 
<p>除了通过指令的方式启动，bk还支持配置的方式，只需要在bookie节点配置autoRecoveryDaemonEnabled为false，这个bookie节点在启动的时候也同样会启动autorecovery服务</p> 
<h5><a id="autorecovery_48"></a>autorecovery机制</h5> 
<p><em>上一章节讲了怎么使用，本章节主要讲明autorecovery这个机制</em></p> 
<p>自动恢复机制中有两个角色Auditor和replication worker，在启动自动恢复机制后，会在每个bookie实例中启动这两个角色</p> 
<p><strong>Auditor</strong></p> 
<p>bk集群中的Auditor们会通过zookeeper选举产生一位leader，这个leader负责监听 zookeeper /ledgers/available 节点变化情况来判定是否要做数据恢复动作，因为所有节点启动都会注册在上面，如果有服务不可用由于zookeeper的临时目录机制，会自动删除在此目录下自己节点的信息，因此leader通过watch机制可以轻松感知到有节点不可用，当Auditor leader感知到有节点不可用时，会将此bookie所负责的所有Ledger加在zookeeper /ledgers/underreplicated 路径下，通过这种方式通知replication worker做数据恢复过程</p> 
<p><strong>replication worker</strong></p> 
<p>每个replication worker都会监听 /ledgers/underreplicated 地址，在监听到有数据恢复任务时，会在 /ledgers/underreplication/locks下添加锁从而避免并发问题；如果在开始恢复前发下当前Ledger的Fragment还处于写入中的状态，replication worker会先尝试等待它写完再做数据恢复动作，但如果等了一段时间还没写完会通过Fence机制处理再做复制，同时开启一个新的Fragment给客户端做数据的继续写入</p> 
<p><strong>启动工作流程</strong><br> <img src="https://images2.imgbox.com/36/a7/jyfvu2IZ_o.png" alt="在这里插入图片描述"></p> 
<p>参照上图，在服务器节点上执行<code>bin/bookkeeper autorecovery bookie </code>后会发生以下步骤</p> 
<ol><li>通过exec shell指令调用操作系统拉起AutoRecoveryMain 这个Java进程</li><li>AutoRecoveryMain进程启动时会同时启动Auditor线程和ReplicationWorker线程，由于环境中可能会启动多个AutoRecoveryMain进程来做HA高可用，因此多个Auditor线程会通过zookeeper选举来产生一个Auditor Leader</li><li>由于bookie集群用zookeeper来做集群感知，因此Auditor Leader只需要通过watch监听zookeeper上 bookie所注册的地址就能感知到是否有bookie节点不可用；当bookie节点不可用时一般就不会上报心跳给zookeeper，zookeeper就会将该节点创建的临时目录进行删除并告知添加watch的Auditor Leader</li><li>Auditor Leader收到通知后会去zookeeper查询该不可用bookie所负责的Ledger列表，理论上这些Ledger都是需要做数据恢复的，因此会将它们放在zookeeper的/ledgers/underreplicated 目录下来通知ReplicationWorker</li><li>ReplicationWorker通过watch监听到此目录有需要做数据恢复的Ledger后，会先在zk加锁再进行数据恢复逻辑；通过将Ledger划分为多个Fragment来轮训进行数据恢复，通过读取其他正常bookie上该Ledger的数据并写到其他没有该数据的bookie的节点上从而保证每份数据都有多个副本，直到将/ledgers/underreplicated 下的所有Ledger进行复制完，本次 autorecovery就算完成了。而Auditor线程和ReplicationWorker线程会不停的监听zookeeper直到下一个bookie节点不可用</li></ol> 
<p>通过此机制给bookkeeper提高了稳定性以及高可用能力，在有个别节点挂掉的时候依然能自动做到数据完备不丢，这种设计是一个成熟的组件该具备的能力</p> 
<h5><a id="autorecovery_75"></a>autorecovery启动源码</h5> 
<p>源码主要分 启动流程以及工作流程进行讲解，同时在这里给需要阅读的朋友提供一个可能会用上的“词典”</p> 
<pre><code>AutoRecoveryMain核心类, 主要负责启动AutoRecovery服务
AutoRecoveryService核心类，主要负责AutoRecovery相关的服务
LedgerManager 对外提供一个管理ledger的api，对内负责如何将ledger的元数据存储在kv存储上。提供增删、读写、注册/注销六个核心接口
AbstractZkLedgerManager 抽象类
LedgerIdGenerator：基于zk实现全局唯一递增的ledgerId
ZkLedgerUnderreplicationManager：管理未完成复制的Ledger
ZkLedgerAuditorManager：管理Auditor
ReplicationWorker：负责从ZkLedgerUnderreplicationManager中获取未完成复制的Ledger并进行复制，每隔rwRereplicateBackoffMs触发一次
LedgerFragment：组成Ledger的单元，也是恢复复制的单元
EmbeddedServer：启动bk实例的节点
</code></pre> 
<p>从现在开始跟踪启动的源码，在客户端执行 <code>bin/bookkeeper autorecovery bookie </code>后会走到 bookkeeper/bin/bookkeeper 这个脚本下面的这行逻辑</p> 
<pre><code class="prism language-shell"><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">${COMMAND}</span> <span class="token operator">==</span> <span class="token string">"autorecovery"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  <span class="token builtin class-name">exec</span> <span class="token string">"<span class="token variable">${JAVA}</span>"</span> <span class="token variable">${OPTS}</span> <span class="token variable">${JMX_ARGS}</span> org.apache.bookkeeper.replication.AutoRecoveryMain <span class="token parameter variable">--conf</span> <span class="token variable">${BOOKIE_CONF}</span> <span class="token variable">$@</span>
</code></pre> 
<p>逻辑非常清晰，其实就是通过shell启动AutoRecovery 这样一个独立的Java进程，专门负责做故障数据恢复。JVM会从启动类的main方法进行引导执行，因此咱们接下来从AutoRecoveryMain的main方法作为入口来看看后面会发生哪些事情</p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      	<span class="token comment">//调用真正执行的方法，开源项目中真正执行某个操作会以do前缀来进行修饰</span>
        <span class="token keyword">int</span> retCode <span class="token operator">=</span> <span class="token function">doMain</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">doMain</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ServerConfiguration</span> conf<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
          	<span class="token comment">//根据shell启动命令中指定的配置地址加载成配置对象</span>
            conf <span class="token operator">=</span> <span class="token function">parseArgs</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalArgumentException</span> iae<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">LifecycleComponent</span> server<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
          	<span class="token comment">//构建AutoRecoveryServer对象，比较重要的方法</span>
            server <span class="token operator">=</span> <span class="token function">buildAutoRecoveryServer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BookieConfiguration</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
      
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
          	<span class="token comment">//启动AutoRecoveryServer对象</span>
            <span class="token class-name">ComponentStarter</span><span class="token punctuation">.</span><span class="token function">startComponent</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ie<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">ExitCode</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>通过这里可以发现AutoRecoveryMain的main方法只是做一个引导的动作，最终启动的是AutoRecoveryServer对象。因此让我们深入看看这个服务的构造以及启动的流程</p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">LifecycleComponentStack</span> <span class="token function">buildAutoRecoveryServer</span><span class="token punctuation">(</span><span class="token class-name">BookieConfiguration</span> conf<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">LifecycleComponentStack<span class="token punctuation">.</span>Builder</span> serverBuilder <span class="token operator">=</span> <span class="token class-name">LifecycleComponentStack</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withName</span><span class="token punctuation">(</span><span class="token string">"autorecovery-server"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 1. 创建StatsProviderService对象，主要用来记录AutoRecovery服务的各项指标状态</span>
        <span class="token class-name">StatsProviderService</span> statsProviderService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StatsProviderService</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// 2. 通过构造函数的方式创建AutoRecoveryService对象，这是核心的代码</span>
        <span class="token class-name">AutoRecoveryService</span> autoRecoveryService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AutoRecoveryService</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> rootStatsLogger<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// 3. 创建BKHttpServiceProvider对象，主要用来对外提供http服务，支持通过http方式读取内部状态信息等</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>conf<span class="token punctuation">.</span><span class="token function">getServerConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isHttpServerEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">BKHttpServiceProvider</span> provider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BKHttpServiceProvider<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setAutoRecovery</span><span class="token punctuation">(</span>autoRecoveryService<span class="token punctuation">.</span><span class="token function">getAutoRecoveryServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setServerConfiguration</span><span class="token punctuation">(</span>conf<span class="token punctuation">.</span><span class="token function">getServerConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setStatsProvider</span><span class="token punctuation">(</span>statsProviderService<span class="token punctuation">.</span><span class="token function">getStatsProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">HttpService</span> httpService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpService</span><span class="token punctuation">(</span>provider<span class="token punctuation">,</span> conf<span class="token punctuation">,</span> rootStatsLogger<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> serverBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>再看AutoRecoveryService的构造函数</p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token class-name">AutoRecoveryService</span><span class="token punctuation">(</span><span class="token class-name">BookieConfiguration</span> conf<span class="token punctuation">,</span> <span class="token class-name">StatsLogger</span> statsLogger<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token constant">NAME</span><span class="token punctuation">,</span> conf<span class="token punctuation">,</span> statsLogger<span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token comment">//通过构造函数创建AutoRecoveryMain，AutoRecoveryMain是AutoRecoveryService的成员变量</span>
      	<span class="token comment">//进入看看它的实现</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>main <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AutoRecoveryMain</span><span class="token punctuation">(</span>
            conf<span class="token punctuation">.</span><span class="token function">getServerConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            statsLogger<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

		
    <span class="token keyword">public</span> <span class="token class-name">AutoRecoveryMain</span><span class="token punctuation">(</span><span class="token class-name">ServerConfiguration</span> conf<span class="token punctuation">,</span> <span class="token class-name">StatsLogger</span> statsLogger<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">KeeperException</span><span class="token punctuation">,</span> <span class="token class-name">UnavailableException</span><span class="token punctuation">,</span>
            <span class="token class-name">CompatibilityException</span> <span class="token punctuation">{<!-- --></span>
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">//创建AuditorElector对象，负责选举产生Auditor Leader</span>
        auditorElector <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AuditorElector</span><span class="token punctuation">(</span>
            <span class="token class-name">BookieImpl</span><span class="token punctuation">.</span><span class="token function">getBookieId</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            conf<span class="token punctuation">,</span>
            bkc<span class="token punctuation">,</span>
            statsLogger<span class="token punctuation">.</span><span class="token function">scope</span><span class="token punctuation">(</span><span class="token constant">AUDITOR_SCOPE</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//创建ReplicationWorker对象，负责做数据的拷贝工作</span>
        replicationWorker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReplicationWorker</span><span class="token punctuation">(</span>
            conf<span class="token punctuation">,</span>
            bkc<span class="token punctuation">,</span>
            <span class="token boolean">false</span><span class="token punctuation">,</span>
            statsLogger<span class="token punctuation">.</span><span class="token function">scope</span><span class="token punctuation">(</span><span class="token constant">REPLICATION_WORKER_SCOPE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        deathWatcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AutoRecoveryDeathWatcher</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>服务构造的逻辑差不多就跟到这了，我们知道最终是为了创建AuditorElector和ReplicationWorker这两个对象就够了。服务启动这块从上面的 <code>ComponentStarter.startComponent(server).get(); </code>进行跟踪</p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">startComponent</span><span class="token punctuation">(</span><span class="token class-name">LifecycleComponent</span> component<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">//调用start方法，这里涉及上采用了模版方法设计模式以及闭包，本质上就是就是调用创建的</span>
        <span class="token comment">//StatsProviderService、	AutoRecoveryService、HttpService这三个服务的doStart方法</span>
        component<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      	<span class="token comment">//还是调的AutoRecoveryMain方法的start方法</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>main<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      	<span class="token comment">//启动auditorElector服务</span>
        auditorElector<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token comment">//启动replicationWorker服务</span>
        replicationWorker<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        deathWatcher<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>结合上面的可以发现AutoRecovery的启动本质上就是启动AuditorElector和ReplicationWorker这两个服务，因此接下来咱们就来看看这两个服务的start过程，先来看看AuditorElector</p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        running<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token comment">//提交选举任务</span>
        <span class="token keyword">return</span> <span class="token function">submitElectionTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">submitElectionTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Runnable</span> r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
									<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                  <span class="token comment">//创建一个Auditor对象并进行启动</span>
                  auditor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Auditor</span><span class="token punctuation">(</span>bookieId<span class="token punctuation">,</span> conf<span class="token punctuation">,</span> bkc<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> statsLogger<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  auditor<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
          	<span class="token comment">//异步执行以上逻辑</span>
            <span class="token keyword">return</span> executor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RejectedExecutionException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>在这里其实就是对Auditor对象进行初始化以及启动，再进一步跟踪</p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token class-name">Auditor</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> bookieIdentifier<span class="token punctuation">,</span>
                   <span class="token class-name">ServerConfiguration</span> conf<span class="token punctuation">,</span>
                   <span class="token class-name">BookKeeper</span> bkc<span class="token punctuation">,</span>
                   <span class="token keyword">boolean</span> ownBkc<span class="token punctuation">,</span>
                   <span class="token class-name">BookKeeperAdmin</span> admin<span class="token punctuation">,</span>
                   <span class="token keyword">boolean</span> ownAdmin<span class="token punctuation">,</span>
                   <span class="token class-name">StatsLogger</span> statsLogger<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">UnavailableException</span> <span class="token punctuation">{<!-- --></span>
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">//调用初始化Auditor对象逻辑</span>
        <span class="token function">initialize</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> bkc<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token class-name">ServerConfiguration</span> conf<span class="token punctuation">,</span> <span class="token class-name">BookKeeper</span> bkc<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">UnavailableException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">LedgerManagerFactory</span> ledgerManagerFactory <span class="token operator">=</span> bkc<span class="token punctuation">.</span><span class="token function">getLedgerManagerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ledgerManager <span class="token operator">=</span> ledgerManagerFactory<span class="token punctuation">.</span><span class="token function">newLedgerManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>bookieLedgerIndexer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BookieLedgerIndexer</span><span class="token punctuation">(</span>ledgerManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>ledgerUnderreplicationManager <span class="token operator">=</span> ledgerManagerFactory
                    <span class="token punctuation">.</span><span class="token function">newLedgerUnderreplicationManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            lostBookieRecoveryDelayBeforeChange <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ledgerUnderreplicationManager<span class="token punctuation">.</span><span class="token function">getLostBookieRecoveryDelay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CompatibilityException</span> ce<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
						<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>看完了初始化逻辑，再继续看下Auditor的启动逻辑</p> 
<pre><code class="prism language-java">
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"I'm starting as Auditor Bookie. ID: {}"</span><span class="token punctuation">,</span> bookieIdentifier<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
              	<span class="token comment">//1. 监听bookie变更事件，本质上就是在zk /ledgers/available 目录下增加watch监听节点的变动</span>
              	<span class="token comment">//这里还会监听 只读bookie 节点的变动</span>
                <span class="token function">watchBookieChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              	<span class="token comment">//从zk获取处于可用的bk节点列表</span>
                knownBookies <span class="token operator">=</span> <span class="token function">getAvailableBookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BKException</span> bke<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
              	<span class="token comment">//1. 在感知到有bookie节点不可用时回调LostBookieRecoveryDelayChangedCb进行逻辑处理</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>ledgerUnderreplicationManager
                        <span class="token punctuation">.</span><span class="token function">notifyLostBookieRecoveryDelayChanged</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LostBookieRecoveryDelayChangedCb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnavailableException</span> ue<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
               <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
              	<span class="token comment">//1. 感知到有Ledger的副本少时触发，跟上面一样也是通过回调方式进行处理</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>ledgerUnderreplicationManager<span class="token punctuation">.</span><span class="token function">notifyUnderReplicationLedgerChanged</span><span class="token punctuation">(</span>
                        <span class="token keyword">new</span> <span class="token class-name">UnderReplicatedLedgersChangedCb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnavailableException</span> ue<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>

            <span class="token function">scheduleBookieCheckTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          	<span class="token comment">//启动一个线程检查Ledger的状态</span>
            <span class="token function">scheduleCheckAllLedgersTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">schedulePlacementPolicyCheckTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">scheduleReplicasCheckTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>这些就是Auditor启动的逻辑，接下来再看看ReplicationWorker的启动逻辑</p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      	<span class="token comment">//workerThread实际上就是一个BookieThread对象</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>workerThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        workerRunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>workerRunning<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
              	<span class="token comment">//核心逻辑就是循环调用rereplicate方法</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">rereplicate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"failed while replicating fragments"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">waitBackOffTime</span><span class="token punctuation">(</span>rwRereplicateBackoffMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
     						<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"ReplicationWorker exited loop!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">rereplicate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">BKException</span><span class="token punctuation">,</span>
            <span class="token class-name">UnavailableException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//获取需要做数据恢复的Ledger</span>
        <span class="token keyword">long</span> ledgerIdToReplicate <span class="token operator">=</span> underreplicationManager
                <span class="token punctuation">.</span><span class="token function">getLedgerToRereplicate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Stopwatch</span> stopwatch <span class="token operator">=</span> <span class="token class-name">Stopwatch</span><span class="token punctuation">.</span><span class="token function">createStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> success <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
          	<span class="token comment">//进行数据恢复</span>
            success <span class="token operator">=</span> <span class="token function">rereplicate</span><span class="token punctuation">(</span>ledgerIdToReplicate<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> success<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h5><a id="autorecovery_367"></a>autorecovery工作源码</h5> 
<p>这块由于逻辑相对较多，因此针对autorecovery工作流程单独开一章。经过上面我们可以清晰的知道在经过启动后都发生了哪些事情，接下来咱们看看autorecovery真正工作的逻辑。在Auditor start的时候，会通过监听zookeeper来感知数据的动态变化</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  	<span class="token comment">//感知bookie节点下线，将这些bookie上管理的Ledger标记为需要备份放到zookeeper上</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>ledgerUnderreplicationManager
                        <span class="token punctuation">.</span><span class="token function">notifyLostBookieRecoveryDelayChanged</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LostBookieRecoveryDelayChangedCb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">//感知Ledger副本变动，统计到指标里</span>
  	<span class="token keyword">this</span><span class="token punctuation">.</span>ledgerUnderreplicationManager<span class="token punctuation">.</span><span class="token function">notifyUnderReplicationLedgerChanged</span><span class="token punctuation">(</span>
                        <span class="token keyword">new</span> <span class="token class-name">UnderReplicatedLedgersChangedCb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上述两个唤醒方法主要是通过watch感知zookeeper事件，所以咱们主要看回调类里面的处理逻辑，先看下LostBookieRecoveryDelayChangedCb类</p> 
<pre><code class="prism language-java">    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">LostBookieRecoveryDelayChangedCb</span> <span class="token keyword">implements</span> <span class="token class-name">GenericCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operationComplete</span><span class="token punctuation">(</span><span class="token keyword">int</span> rc<span class="token punctuation">,</span> <span class="token class-name">Void</span> result<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token class-name">Auditor</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>ledgerUnderreplicationManager
                        <span class="token punctuation">.</span><span class="token function">notifyLostBookieRecoveryDelayChanged</span><span class="token punctuation">(</span><span class="token class-name">LostBookieRecoveryDelayChangedCb</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token comment">//提交事件变动处理任务，进去看看</span>
            <span class="token class-name">Auditor</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">submitLostBookieRecoveryDelayChangedEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">synchronized</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">submitLostBookieRecoveryDelayChangedEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> executor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> lostBookieRecoveryDelay <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">waitIfLedgerReplicationDisabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                lostBookieRecoveryDelay <span class="token operator">=</span> <span class="token class-name">Auditor</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>ledgerUnderreplicationManager
                        <span class="token punctuation">.</span><span class="token function">getLostBookieRecoveryDelay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
										<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
										<span class="token comment">//核心逻辑,进去看看都做了些什么</span>
                    auditorBookieCheckTask<span class="token punctuation">.</span><span class="token function">startAudit</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>auditTask <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"lostBookieRecoveryDelay has been set to {}, so rescheduling AuditTask accordingly"</span><span class="token punctuation">,</span>
                            lostBookieRecoveryDelay<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    auditTask <span class="token operator">=</span> executor<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                        auditorBookieCheckTask<span class="token punctuation">.</span><span class="token function">startAudit</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        auditTask <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                        bookiesToBeAudited<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span> lostBookieRecoveryDelay<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    auditorStats<span class="token punctuation">.</span><span class="token function">getNumBookieAuditsDelayed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ie<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>lostBookieRecoveryDelay <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    lostBookieRecoveryDelayBeforeChange <span class="token operator">=</span> lostBookieRecoveryDelay<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">startAudit</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> shutDownTask<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
          	<span class="token comment">//看起来是开始做Auditor的主要任务了，继续往下</span>
            <span class="token function">auditBookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            shutDownTask <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BKException</span> bke<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">auditBookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">ReplicationException<span class="token punctuation">.</span>BKAuditException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">BKException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> availableBookies <span class="token operator">=</span> <span class="token function">getAvailableBookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// find lost bookies</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> knownBookies <span class="token operator">=</span> ledgerDetails<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token comment">//通过之前内存中存的bookie集合减去 zk当前bookie集合即可得出都有哪些bookie节点不可用了</span>
        <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> lostBookies <span class="token operator">=</span> <span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>knownBookies<span class="token punctuation">,</span>
                availableBookies<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">//如果本次变动涉及到bookie节点不可用，则调用handleLostBookiesAsync方法处理不可用的节点</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lostBookies<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">FutureUtils</span><span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span>
                        <span class="token function">handleLostBookiesAsync</span><span class="token punctuation">(</span>lostBookies<span class="token punctuation">,</span> ledgerDetails<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ReplicationException</span><span class="token punctuation">.</span><span class="token constant">EXCEPTION_HANDLER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ReplicationException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">handleLostBookiesAsync</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> lostBookies<span class="token punctuation">,</span>
                                                        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> ledgerDetails<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Following are the failed bookies: {},"</span>
                <span class="token operator">+</span> <span class="token string">" and searching its ledgers for re-replication"</span><span class="token punctuation">,</span> lostBookies<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">FutureUtils</span><span class="token punctuation">.</span><span class="token function">processList</span><span class="token punctuation">(</span>
                <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>lostBookies<span class="token punctuation">)</span><span class="token punctuation">,</span>
          			<span class="token comment">//看方法名大概能猜得出来计算这些bookie上的Ledger，并针对这些Ledger进行数据恢复</span>
          			<span class="token comment">//由于之前有存节点跟Ledger的映射关系，因此直接通过ledgerDetails映射表来获取这些不可用节点所负责的Ledger</span>
                bookieIP <span class="token operator">-&gt;</span> <span class="token function">publishSuspectedLedgersAsync</span><span class="token punctuation">(</span>
                        <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>bookieIP<span class="token punctuation">)</span><span class="token punctuation">,</span> ledgerDetails<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>bookieIP<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">null</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">publishSuspectedLedgersAsync</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> missingBookies<span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> ledgers<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token class-name">LongAdder</span> underReplicatedSize <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LongAdder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FutureUtils</span><span class="token punctuation">.</span><span class="token function">processList</span><span class="token punctuation">(</span>
                <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>ledgers<span class="token punctuation">)</span><span class="token punctuation">,</span>
                ledgerId <span class="token operator">-&gt;</span>
          							<span class="token comment">//通过读取这些Ledger的元数据，方便后续的数据恢复动作</span>
                        ledgerManager<span class="token punctuation">.</span><span class="token function">readLedgerMetadata</span><span class="token punctuation">(</span>ledgerId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>metadata<span class="token punctuation">,</span> exception<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                underReplicatedSize<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>metadata<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">FutureUtils</span><span class="token punctuation">.</span><span class="token function">processList</span><span class="token punctuation">(</span>
                <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>ledgers<span class="token punctuation">)</span><span class="token punctuation">,</span>
          			<span class="token comment">//主流程，继续往下</span>
                ledgerId <span class="token operator">-&gt;</span> ledgerUnderreplicationManager<span class="token punctuation">.</span><span class="token function">markLedgerUnderreplicatedAsync</span><span class="token punctuation">(</span>ledgerId<span class="token punctuation">,</span> missingBookies<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">null</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">markLedgerUnderreplicatedAsync</span><span class="token punctuation">(</span><span class="token keyword">long</span> ledgerId<span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> missingReplicas<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> znode <span class="token operator">=</span> <span class="token function">getUrLedgerZnode</span><span class="token punctuation">(</span>ledgerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//标记需要做备份的Ledger</span>
        <span class="token function">tryMarkLedgerUnderreplicatedAsync</span><span class="token punctuation">(</span>znode<span class="token punctuation">,</span> missingReplicas<span class="token punctuation">,</span> zkAcls<span class="token punctuation">,</span> createFuture<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> createFuture<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">tryMarkLedgerUnderreplicatedAsync</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> znode<span class="token punctuation">,</span>
                                                   <span class="token keyword">final</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> missingReplicas<span class="token punctuation">,</span>
                                                   <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>ACL<span class="token punctuation">&gt;</span></span> zkAcls<span class="token punctuation">,</span>
                                                   <span class="token keyword">final</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> finalFuture<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">//将需要做数据恢复的副本进行进行proto编码</span>
        missingReplicas<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>builder<span class="token operator">::</span><span class="token function">addReplica</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token class-name">ZkUtils</span><span class="token punctuation">.</span><span class="token function">asyncCreateFullPathOptimistic</span><span class="token punctuation">(</span>
            zkc<span class="token punctuation">,</span> znode<span class="token punctuation">,</span> urLedgerData<span class="token punctuation">,</span> zkAcls<span class="token punctuation">,</span> <span class="token class-name">CreateMode</span><span class="token punctuation">.</span><span class="token constant">PERSISTENT</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span>rc<span class="token punctuation">,</span> path<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Code</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> rc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">FutureUtils</span><span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>finalFuture<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Code</span><span class="token punctuation">.</span><span class="token constant">NODEEXISTS</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> rc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//要在zookeeper将这些Ledger标记为需要做数据恢复</span>
                    <span class="token function">handleLedgerUnderreplicatedAlreadyMarked</span><span class="token punctuation">(</span>znode<span class="token punctuation">,</span> missingReplicas<span class="token punctuation">,</span> zkAcls<span class="token punctuation">,</span> finalFuture<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">FutureUtils</span><span class="token punctuation">.</span><span class="token function">completeExceptionally</span><span class="token punctuation">(</span>finalFuture<span class="token punctuation">,</span> <span class="token class-name">KeeperException</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Code</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>rc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleLedgerUnderreplicatedAlreadyMarked</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> znode<span class="token punctuation">,</span>
                                                          <span class="token keyword">final</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> missingReplicas<span class="token punctuation">,</span>
                                                          <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>ACL<span class="token punctuation">&gt;</span></span> zkAcls<span class="token punctuation">,</span>
                                                          <span class="token keyword">final</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> finalFuture<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// get the existing underreplicated ledger data</span>
        zkc<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span>znode<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>getRc<span class="token punctuation">,</span> getPath<span class="token punctuation">,</span> getCtx<span class="token punctuation">,</span> existingUrLedgerData<span class="token punctuation">,</span> getStat<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Code</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> getRc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// deserialize existing underreplicated ledger data</span>
                <span class="token keyword">final</span> <span class="token class-name">UnderreplicatedLedgerFormat<span class="token punctuation">.</span>Builder</span> builder <span class="token operator">=</span> <span class="token class-name">UnderreplicatedLedgerFormat</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">TextFormat</span><span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>existingUrLedgerData<span class="token punctuation">,</span> <span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">,</span> builder<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ParseException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">UnderreplicatedLedgerFormat</span> existingUrLedgerFormat <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">boolean</span> replicaAdded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> missingReplica <span class="token operator">:</span> missingReplicas<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>existingUrLedgerFormat<span class="token punctuation">.</span><span class="token function">getReplicaList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>missingReplica<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        builder<span class="token punctuation">.</span><span class="token function">addReplica</span><span class="token punctuation">(</span>missingReplica<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        replicaAdded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token comment">//盲猜这里在zk将Ledger标志为需要做数据同步</span>
                zkc<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>znode<span class="token punctuation">,</span> newUrLedgerData<span class="token punctuation">,</span> getStat<span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>setRc<span class="token punctuation">,</span> setPath<span class="token punctuation">,</span> setCtx<span class="token punctuation">,</span> setStat<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Code</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> setRc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token class-name">FutureUtils</span><span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>finalFuture<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Code</span><span class="token punctuation">.</span><span class="token constant">NONODE</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> setRc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token function">tryMarkLedgerUnderreplicatedAsync</span><span class="token punctuation">(</span>znode<span class="token punctuation">,</span> missingReplicas<span class="token punctuation">,</span> zkAcls<span class="token punctuation">,</span> finalFuture<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Code</span><span class="token punctuation">.</span><span class="token constant">BADVERSION</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> setRc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token function">handleLedgerUnderreplicatedAlreadyMarked</span><span class="token punctuation">(</span>znode<span class="token punctuation">,</span> missingReplicas<span class="token punctuation">,</span> zkAcls<span class="token punctuation">,</span> finalFuture<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token class-name">FutureUtils</span><span class="token punctuation">.</span><span class="token function">completeExceptionally</span><span class="token punctuation">(</span>finalFuture<span class="token punctuation">,</span> <span class="token class-name">KeeperException</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Code</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>setRc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Code</span><span class="token punctuation">.</span><span class="token constant">NONODE</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> getRc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">tryMarkLedgerUnderreplicatedAsync</span><span class="token punctuation">(</span>znode<span class="token punctuation">,</span> missingReplicas<span class="token punctuation">,</span> zkAcls<span class="token punctuation">,</span> finalFuture<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">FutureUtils</span><span class="token punctuation">.</span><span class="token function">completeExceptionally</span><span class="token punctuation">(</span>finalFuture<span class="token punctuation">,</span> <span class="token class-name">KeeperException</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Code</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>getRc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>从ReplicationWorker的rereplicate方法开始就是真正做数据恢复的过程</p> 
<pre><code class="prism language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">rereplicate</span><span class="token punctuation">(</span><span class="token keyword">long</span> ledgerIdToReplicate<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">BKException</span><span class="token punctuation">,</span>
            <span class="token class-name">UnavailableException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
				<span class="token comment">//获取需要做数据恢复的Ledger的处理对象LedgerHandle </span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">LedgerHandle</span> lh <span class="token operator">=</span> admin<span class="token punctuation">.</span><span class="token function">openLedgerNoRecovery</span><span class="token punctuation">(</span>ledgerIdToReplicate<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          	<span class="token comment">//通过对Ledger进行分解成更小数据恢复单位LedgerFragment，后续分别对LedgerFragment进行数据恢复</span>
            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LedgerFragment</span><span class="token punctuation">&gt;</span></span> fragments <span class="token operator">=</span> <span class="token function">getUnderreplicatedFragments</span><span class="token punctuation">(</span>lh<span class="token punctuation">,</span>
                    conf<span class="token punctuation">.</span><span class="token function">getAuditorLedgerVerificationPercentage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">LedgerFragment</span> ledgerFragment <span class="token operator">:</span> fragments<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
								<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                  	<span class="token comment">//对LedgerFragment进行数据恢复</span>
                    admin<span class="token punctuation">.</span><span class="token function">replicateLedgerFragment</span><span class="token punctuation">(</span>lh<span class="token punctuation">,</span> ledgerFragment<span class="token punctuation">,</span> onReadEntryFailureCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    numFragsReplicated<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>ledgerFragment<span class="token punctuation">.</span><span class="token function">getReplicateType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">LedgerFragment
                            <span class="token punctuation">.</span>ReplicateType</span><span class="token punctuation">.</span><span class="token constant">DATA_NOT_ADHERING_PLACEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        numNotAdheringPlacementFragsReplicated<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BKException<span class="token punctuation">.</span>BKBookieHandleNotAvailableException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
						<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            fragments <span class="token operator">=</span> <span class="token function">getUnderreplicatedFragments</span><span class="token punctuation">(</span>lh<span class="token punctuation">,</span> conf<span class="token punctuation">.</span><span class="token function">getAuditorLedgerVerificationPercentage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BKNoSuchLedgerExistsOnMetadataServerException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
						<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>继续进一步看admin.replicateLedgerFragment的实现</p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">replicateLedgerFragment</span><span class="token punctuation">(</span><span class="token class-name">LedgerHandle</span> lh<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">LedgerFragment</span> ledgerFragment<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token class-name">BiConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> onReadEntryFailureCallback<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">BKException</span> <span class="token punctuation">{<!-- --></span>
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">//继续往下跟踪</span>
        <span class="token function">replicateLedgerFragment</span><span class="token punctuation">(</span>lh<span class="token punctuation">,</span> ledgerFragment<span class="token punctuation">,</span> targetBookieAddresses<span class="token punctuation">,</span> onReadEntryFailureCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">replicateLedgerFragment</span><span class="token punctuation">(</span><span class="token class-name">LedgerHandle</span> lh<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token class-name">LedgerFragment</span> ledgerFragment<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">BookieId</span><span class="token punctuation">&gt;</span></span> targetBookieAddresses<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token class-name">BiConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> onReadEntryFailureCallback<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">BKException</span> <span class="token punctuation">{<!-- --></span>
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">//在这里看到这个恢复其实是异步处理的过程，继续往下</span>
        <span class="token function">asyncRecoverLedgerFragment</span><span class="token punctuation">(</span>lh<span class="token punctuation">,</span> ledgerFragment<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> targetBookieSet<span class="token punctuation">,</span> onReadEntryFailureCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">asyncRecoverLedgerFragment</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">LedgerHandle</span> lh<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token class-name">LedgerFragment</span> ledgerFragment<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token class-name">AsyncCallback<span class="token punctuation">.</span>VoidCallback</span> ledgerFragmentMcb<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BookieId</span><span class="token punctuation">&gt;</span></span> newBookies<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token class-name">BiConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> onReadEntryFailureCallback<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
      	<span class="token comment">//发现会调用LedgerFragmentReplicator对象进行数据恢复，继续往下</span>
        lfr<span class="token punctuation">.</span><span class="token function">replicate</span><span class="token punctuation">(</span>lh<span class="token punctuation">,</span> ledgerFragment<span class="token punctuation">,</span> ledgerFragmentMcb<span class="token punctuation">,</span> newBookies<span class="token punctuation">,</span> onReadEntryFailureCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">replicate</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">LedgerHandle</span> lh<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">LedgerFragment</span> lf<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token class-name">AsyncCallback<span class="token punctuation">.</span>VoidCallback</span> ledgerFragmentMcb<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BookieId</span><span class="token punctuation">&gt;</span></span> targetBookieAddresses<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token class-name">BiConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> onReadEntryFailureCallback<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LedgerFragment</span><span class="token punctuation">&gt;</span></span> partionedFragments <span class="token operator">=</span> <span class="token function">splitIntoSubFragments</span><span class="token punctuation">(</span>lh<span class="token punctuation">,</span> lf<span class="token punctuation">,</span>
                bkc<span class="token punctuation">.</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRereplicationEntryBatchSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">//继续往下看实现</span>
        <span class="token function">replicateNextBatch</span><span class="token punctuation">(</span>lh<span class="token punctuation">,</span> partionedFragments<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                ledgerFragmentMcb<span class="token punctuation">,</span> targetBookieAddresses<span class="token punctuation">,</span> onReadEntryFailureCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">replicateNextBatch</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">LedgerHandle</span> lh<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LedgerFragment</span><span class="token punctuation">&gt;</span></span> fragments<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token class-name">AsyncCallback<span class="token punctuation">.</span>VoidCallback</span> ledgerFragmentMcb<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BookieId</span><span class="token punctuation">&gt;</span></span> targetBookieAddresses<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token class-name">BiConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> onReadEntryFailureCallback<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fragments<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
              	<span class="token comment">//来了，一般有Internal的地方都会有实现的干货，继续进去</span>
                <span class="token function">replicateFragmentInternal</span><span class="token punctuation">(</span>lh<span class="token punctuation">,</span> fragments<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">AsyncCallback<span class="token punctuation">.</span>VoidCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token annotation punctuation">@Override</span>
                            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processResult</span><span class="token punctuation">(</span><span class="token keyword">int</span> rc<span class="token punctuation">,</span> <span class="token class-name">String</span> v<span class="token punctuation">,</span> <span class="token class-name">Object</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">!=</span> <span class="token class-name">BKException<span class="token punctuation">.</span>Code</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                    ledgerFragmentMcb<span class="token punctuation">.</span><span class="token function">processResult</span><span class="token punctuation">(</span>rc<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
                                            <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                                    <span class="token function">replicateNextBatch</span><span class="token punctuation">(</span>lh<span class="token punctuation">,</span> fragments<span class="token punctuation">,</span>
                                            ledgerFragmentMcb<span class="token punctuation">,</span>
                                            targetBookieAddresses<span class="token punctuation">,</span>
                                            onReadEntryFailureCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>

                        <span class="token punctuation">}</span><span class="token punctuation">,</span> targetBookieAddresses<span class="token punctuation">,</span> onReadEntryFailureCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            ledgerFragmentMcb<span class="token punctuation">.</span><span class="token function">processResult</span><span class="token punctuation">(</span><span class="token class-name">BKException<span class="token punctuation">.</span>Code</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">replicateFragmentInternal</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">LedgerHandle</span> lh<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token class-name">LedgerFragment</span> lf<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token class-name">AsyncCallback<span class="token punctuation">.</span>VoidCallback</span> ledgerFragmentMcb<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BookieId</span><span class="token punctuation">&gt;</span></span> newBookies<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token class-name">BiConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> onReadEntryFailureCallback<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">//针对每个Entry对象循环做数据恢复，Entry是BK里最小的数据单元</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Long</span> entryId <span class="token operator">:</span> entriesToReplicate<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">recoverLedgerFragmentEntry</span><span class="token punctuation">(</span>entryId<span class="token punctuation">,</span> lh<span class="token punctuation">,</span> ledgerFragmentEntryMcb<span class="token punctuation">,</span>
                    newBookies<span class="token punctuation">,</span> onReadEntryFailureCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">recoverLedgerFragmentEntry</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Long</span> entryId<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token class-name">LedgerHandle</span> lh<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token class-name">AsyncCallback<span class="token punctuation">.</span>VoidCallback</span> ledgerFragmentEntryMcb<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BookieId</span><span class="token punctuation">&gt;</span></span> newBookies<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token class-name">BiConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> onReadEntryFailureCallback<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">long</span> startReadEntryTime <span class="token operator">=</span> <span class="token class-name">MathUtils</span><span class="token punctuation">.</span><span class="token function">nowInNano</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*
         * Read the ledger entry using the LedgerHandle. This will allow us to
         * read the entry from one of the other replicated bookies other than
         * the dead one.
         */</span>
      	<span class="token comment">//到了真正读取Entry的逻辑，继续往下</span>
        lh<span class="token punctuation">.</span><span class="token function">asyncReadEntries</span><span class="token punctuation">(</span>entryId<span class="token punctuation">,</span> entryId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ReadCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    						<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">asyncReadEntries</span><span class="token punctuation">(</span><span class="token keyword">long</span> firstEntry<span class="token punctuation">,</span> <span class="token keyword">long</span> lastEntry<span class="token punctuation">,</span> <span class="token class-name">ReadCallback</span> cb<span class="token punctuation">,</span> <span class="token class-name">Object</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">//调用异步读取逻辑</span>
        <span class="token function">asyncReadEntriesInternal</span><span class="token punctuation">(</span>firstEntry<span class="token punctuation">,</span> lastEntry<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">asyncReadEntriesInternal</span><span class="token punctuation">(</span><span class="token keyword">long</span> firstEntry<span class="token punctuation">,</span> <span class="token keyword">long</span> lastEntry<span class="token punctuation">,</span> <span class="token class-name">ReadCallback</span> cb<span class="token punctuation">,</span>
                                  <span class="token class-name">Object</span> ctx<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isRecoveryRead<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>clientCtx<span class="token punctuation">.</span><span class="token function">isClientClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          	<span class="token comment">//继续往下跟踪</span>
            <span class="token function">readEntriesInternalAsync</span><span class="token punctuation">(</span>firstEntry<span class="token punctuation">,</span> lastEntry<span class="token punctuation">,</span> isRecoveryRead<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">whenCompleteAsync</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FutureEventListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LedgerEntries</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span> clientCtx<span class="token punctuation">.</span><span class="token function">getMainWorkerPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chooseThread</span><span class="token punctuation">(</span>ledgerId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            cb<span class="token punctuation">.</span><span class="token function">readComplete</span><span class="token punctuation">(</span><span class="token class-name">Code<span class="token punctuation">.</span>ClientClosedException</span><span class="token punctuation">,</span> <span class="token class-name">LedgerHandle</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LedgerEntries</span><span class="token punctuation">&gt;</span></span> <span class="token function">readEntriesInternalAsync</span><span class="token punctuation">(</span><span class="token keyword">long</span> firstEntry<span class="token punctuation">,</span>
                                                              <span class="token keyword">long</span> lastEntry<span class="token punctuation">,</span>
                                                              <span class="token keyword">boolean</span> isRecoveryRead<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      	<span class="token comment">//构造读数据的对象</span>
      	<span class="token class-name">PendingReadOp</span> op <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PendingReadOp</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> clientCtx<span class="token punctuation">,</span>
                                             firstEntry<span class="token punctuation">,</span> lastEntry<span class="token punctuation">,</span> isRecoveryRead<span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token comment">//运行起来，跟进去瞅瞅</span>
      	op<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> op<span class="token punctuation">.</span><span class="token function">future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      	<span class="token comment">//无他，继续往下</span>
        <span class="token function">initiate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">initiate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
						<span class="token comment">//决定是串行读取数据还是并行读取数据</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>parallelRead<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                entry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ParallelReadRequest</span><span class="token punctuation">(</span>ensemble<span class="token punctuation">,</span> lh<span class="token punctuation">.</span>ledgerId<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                entry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SequenceReadRequest</span><span class="token punctuation">(</span>ensemble<span class="token punctuation">,</span> lh<span class="token punctuation">.</span>ledgerId<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            seq<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> endEntryId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// read the entries.</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">LedgerEntryRequest</span> entry <span class="token operator">:</span> seq<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          	<span class="token comment">//核心逻辑，这里进行数据读取操作</span>
            entry<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//继续往下看</span>
    <span class="token function">sendNextRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

   <span class="token keyword">synchronized</span> <span class="token class-name">BookieId</span> <span class="token function">sendNextRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
						<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">BookieId</span> <span class="token keyword">to</span> <span class="token operator">=</span> ensemble<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>bookieIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
              	<span class="token comment">//发送读取请求的操作</span>
                <span class="token function">sendReadTo</span><span class="token punctuation">(</span>bookieIndex<span class="token punctuation">,</span> <span class="token keyword">to</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ie<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
								<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">sendReadTo</span><span class="token punctuation">(</span><span class="token keyword">int</span> bookieIndex<span class="token punctuation">,</span> <span class="token class-name">BookieId</span> <span class="token keyword">to</span><span class="token punctuation">,</span> <span class="token class-name">LedgerEntryRequest</span> entry<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> 
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isRecoveryRead<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          	<span class="token comment">//调用BK客户端进行数据的读取</span>
            clientCtx<span class="token punctuation">.</span><span class="token function">getBookieClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readEntry</span><span class="token punctuation">(</span><span class="token keyword">to</span><span class="token punctuation">,</span> lh<span class="token punctuation">.</span>ledgerId<span class="token punctuation">,</span> entry<span class="token punctuation">.</span>eId<span class="token punctuation">,</span>
                    <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ReadContext</span><span class="token punctuation">(</span>bookieIndex<span class="token punctuation">,</span> <span class="token keyword">to</span><span class="token punctuation">,</span> entry<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">BookieProtocol</span><span class="token punctuation">.</span><span class="token constant">FLAG_NONE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">readEntry</span><span class="token punctuation">(</span><span class="token class-name">BookieId</span> address<span class="token punctuation">,</span> <span class="token keyword">long</span> ledgerId<span class="token punctuation">,</span> <span class="token keyword">long</span> entryId<span class="token punctuation">,</span>
                           <span class="token class-name">ReadEntryCallback</span> cb<span class="token punctuation">,</span> <span class="token class-name">Object</span> ctx<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      	<span class="token comment">//继续往下</span>
        <span class="token function">readEntry</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> ledgerId<span class="token punctuation">,</span> entryId<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">readEntry</span><span class="token punctuation">(</span><span class="token class-name">BookieId</span> address<span class="token punctuation">,</span> <span class="token keyword">long</span> ledgerId<span class="token punctuation">,</span> <span class="token keyword">long</span> entryId<span class="token punctuation">,</span>
                           <span class="token class-name">ReadEntryCallback</span> cb<span class="token punctuation">,</span> <span class="token class-name">Object</span> ctx<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> masterKey<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      	<span class="token comment">//继续往下</span>
        <span class="token function">readEntry</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> ledgerId<span class="token punctuation">,</span> entryId<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> masterKey<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">readEntry</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">BookieId</span> addr<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> ledgerId<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> entryId<span class="token punctuation">,</span>
                          <span class="token keyword">final</span> <span class="token class-name">ReadEntryCallback</span> cb<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> ctx<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> masterKey<span class="token punctuation">,</span>
                          <span class="token keyword">final</span> <span class="token keyword">boolean</span> allowFastFail<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      	<span class="token comment">//获取要访问的客户端对象</span>
        <span class="token keyword">final</span> <span class="token class-name">PerChannelBookieClientPool</span> client <span class="token operator">=</span> <span class="token function">lookupClient</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        client<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">(</span>rc<span class="token punctuation">,</span> pcbc<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">!=</span> <span class="token class-name">BKException<span class="token punctuation">.</span>Code</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">completeRead</span><span class="token punctuation">(</span>rc<span class="token punctuation">,</span> ledgerId<span class="token punctuation">,</span> entryId<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> cb<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
              	<span class="token comment">//调用读取逻辑</span>
                pcbc<span class="token punctuation">.</span><span class="token function">readEntry</span><span class="token punctuation">(</span>ledgerId<span class="token punctuation">,</span> entryId<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> masterKey<span class="token punctuation">,</span> allowFastFail<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> ledgerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">readEntry</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> ledgerId<span class="token punctuation">,</span>
                          <span class="token keyword">final</span> <span class="token keyword">long</span> entryId<span class="token punctuation">,</span>
                          <span class="token class-name">ReadEntryCallback</span> cb<span class="token punctuation">,</span>
                          <span class="token class-name">Object</span> ctx<span class="token punctuation">,</span>
                          <span class="token keyword">int</span> flags<span class="token punctuation">,</span>
                          <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> masterKey<span class="token punctuation">,</span>
                          <span class="token keyword">boolean</span> allowFastFail<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      	<span class="token comment">//看到Internal就知道要有东西了，继续往下</span>
        <span class="token function">readEntryInternal</span><span class="token punctuation">(</span>ledgerId<span class="token punctuation">,</span> entryId<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                          cb<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> flags<span class="token punctuation">,</span> masterKey<span class="token punctuation">,</span> allowFastFail<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">readEntryInternal</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> ledgerId<span class="token punctuation">,</span>
                                   <span class="token keyword">final</span> <span class="token keyword">long</span> entryId<span class="token punctuation">,</span>
                                   <span class="token keyword">final</span> <span class="token class-name">Long</span> previousLAC<span class="token punctuation">,</span>
                                   <span class="token keyword">final</span> <span class="token class-name">Long</span> timeOutInMillis<span class="token punctuation">,</span>
                                   <span class="token keyword">final</span> <span class="token keyword">boolean</span> piggyBackEntry<span class="token punctuation">,</span>
                                   <span class="token keyword">final</span> <span class="token class-name">ReadEntryCallback</span> cb<span class="token punctuation">,</span>
                                   <span class="token keyword">final</span> <span class="token class-name">Object</span> ctx<span class="token punctuation">,</span>
                                   <span class="token keyword">int</span> flags<span class="token punctuation">,</span>
                                   <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> masterKey<span class="token punctuation">,</span>
                                   <span class="token keyword">boolean</span> allowFastFail<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token comment">//构造请求对象</span>
            <span class="token class-name">ReadRequest<span class="token punctuation">.</span>Builder</span> readBuilder <span class="token operator">=</span> <span class="token class-name">ReadRequest</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setLedgerId</span><span class="token punctuation">(</span>ledgerId<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setEntryId</span><span class="token punctuation">(</span>entryId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            request <span class="token operator">=</span> <span class="token function">withRequestContext</span><span class="token punctuation">(</span><span class="token class-name">Request</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span>headerBuilder<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setReadRequest</span><span class="token punctuation">(</span>readBuilder<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">//继续往下</span>
        <span class="token function">writeAndFlush</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> completionKey<span class="token punctuation">,</span> request<span class="token punctuation">,</span> allowFastFail<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

 <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">,</span>
                           <span class="token keyword">final</span> <span class="token class-name">CompletionKey</span> key<span class="token punctuation">,</span>
                           <span class="token keyword">final</span> <span class="token class-name">Object</span> request<span class="token punctuation">,</span>
                           <span class="token keyword">final</span> <span class="token keyword">boolean</span> allowFastFail<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
          	<span class="token comment">//跟到这里就知道最终调用了Netty的客户端来发起请求</span>
            channel<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>到这里数据就发出去了，我们也能知道AutoRecovery进程是通过Netty向BK的服务端进行数据读取，那么服务端在接收到请求后又是怎么处理的呢，这里咱们从服务端接收请求的逻辑开始跟，由于BK本身也是通过Netty实例进行网络请求处理的，因此可以轻松找到BookieRequestHandler的channelRead方法监听外部网络请求</p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      	<span class="token comment">//职责分离做得很好，BookieRequestHandler只负责接收请求，逻辑处理相关的全权交给requestProcessor对象</span>
        requestProcessor<span class="token punctuation">.</span><span class="token function">processRequest</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processRequest</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">BookieRequestHandler</span> requestHandler<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> requestHandler<span class="token punctuation">.</span><span class="token function">ctx</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">BookkeeperProtocol<span class="token punctuation">.</span>Request</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">BookkeeperProtocol<span class="token punctuation">.</span>Request</span> r <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">BookkeeperProtocol<span class="token punctuation">.</span>Request</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>
            <span class="token function">restoreMdcContextFromRequest</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">BookkeeperProtocol<span class="token punctuation">.</span>BKPacketHeader</span> header <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              	<span class="token comment">//非常好的一种设计，kafka的KafkaApis类里也是这样设计，服务端支持的操作在这里就能很清晰的看到</span>
                <span class="token keyword">switch</span> <span class="token punctuation">(</span>header<span class="token punctuation">.</span><span class="token function">getOperation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">case</span> <span class="token constant">ADD_ENTRY</span><span class="token operator">:</span>
                        <span class="token function">processAddRequestV3</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> requestHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> <span class="token constant">READ_ENTRY</span><span class="token operator">:</span>
                    		<span class="token comment">//在这里可以处理的读取请求，从这里进去看看</span>
                        <span class="token function">processReadRequestV3</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> requestHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> <span class="token constant">FORCE_LEDGER</span><span class="token operator">:</span>
                        <span class="token function">processForceLedgerRequestV3</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> requestHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
										<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token keyword">case</span> <span class="token constant">WRITE_LAC</span><span class="token operator">:</span>
                        <span class="token function">processWriteLacRequestV3</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> requestHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> <span class="token constant">READ_LAC</span><span class="token operator">:</span>
                        <span class="token function">processReadLacRequestV3</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> requestHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> <span class="token constant">GET_BOOKIE_INFO</span><span class="token operator">:</span>
                        <span class="token function">processGetBookieInfoRequestV3</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> requestHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> <span class="token constant">START_TLS</span><span class="token operator">:</span>
                        <span class="token function">processStartTLSRequestV3</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> requestHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> <span class="token constant">GET_LIST_OF_ENTRIES_OF_LEDGER</span><span class="token operator">:</span>
                        <span class="token function">processGetListOfEntriesOfLedgerProcessorV3</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> requestHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">default</span><span class="token operator">:</span>
												<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                <span class="token constant">MDC</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
  					<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processReadRequestV3</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">BookkeeperProtocol<span class="token punctuation">.</span>Request</span> r<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">BookieRequestHandler</span> requestHandler<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       
    		<span class="token comment">//能看到BK也同时支持长轮询的方式读取数据</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">RequestUtils</span><span class="token punctuation">.</span><span class="token function">isLongPollReadRequest</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">getReadRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            read <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LongPollReadEntryProcessorV3</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> requestHandler<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> fenceThread<span class="token punctuation">,</span>
                                                    lpThread<span class="token punctuation">,</span> requestTimer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            read <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReadEntryProcessorV3</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> requestHandler<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> fenceThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> threadPool<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          	<span class="token comment">//跟进去看看实现</span>
            read<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
						<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">//执行读取操作</span>
        <span class="token function">executeOp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">executeOp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      	<span class="token comment">//这里感觉设计得不是很清晰，应该先读取数据出来再构造返回对象的，你们觉得呢？</span>
        <span class="token class-name">ReadResponse</span> readResponse <span class="token operator">=</span> <span class="token function">getReadResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> readResponse<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">sendResponse</span><span class="token punctuation">(</span>readResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token class-name">ReadResponse</span> <span class="token function">getReadResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
						<span class="token comment">// 读取Entry数据的地方，在此处深入探索下</span>
            <span class="token keyword">return</span> <span class="token function">readEntry</span><span class="token punctuation">(</span>readResponse<span class="token punctuation">,</span> entryId<span class="token punctuation">,</span> startTimeSw<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Bookie<span class="token punctuation">.</span>NoLedgerException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
						<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token class-name">ReadResponse</span> <span class="token function">readEntry</span><span class="token punctuation">(</span><span class="token class-name">ReadResponse<span class="token punctuation">.</span>Builder</span> readResponseBuilder<span class="token punctuation">,</span>
                                     <span class="token keyword">long</span> entryId<span class="token punctuation">,</span>
                                     <span class="token class-name">Stopwatch</span> startTimeSw<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">BookieException</span> <span class="token punctuation">{<!-- --></span>
      	<span class="token comment">//继续深入</span>
        <span class="token keyword">return</span> <span class="token function">readEntry</span><span class="token punctuation">(</span>readResponseBuilder<span class="token punctuation">,</span> entryId<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> startTimeSw<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token class-name">ReadResponse</span> <span class="token function">readEntry</span><span class="token punctuation">(</span><span class="token class-name">ReadResponse<span class="token punctuation">.</span>Builder</span> readResponseBuilder<span class="token punctuation">,</span>
                                     <span class="token keyword">long</span> entryId<span class="token punctuation">,</span>
                                     <span class="token keyword">boolean</span> readLACPiggyBack<span class="token punctuation">,</span>
                                     <span class="token class-name">Stopwatch</span> startTimeSw<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">BookieException</span> <span class="token punctuation">{<!-- --></span>
      	<span class="token comment">//调用Bookie的readEntry来读取数据</span>
        <span class="token class-name">ByteBuf</span> entryBody <span class="token operator">=</span> requestProcessor<span class="token punctuation">.</span><span class="token function">getBookie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readEntry</span><span class="token punctuation">(</span>ledgerId<span class="token punctuation">,</span> entryId<span class="token punctuation">)</span><span class="token punctuation">;</span>
     		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token class-name">ByteBuf</span> <span class="token function">readEntry</span><span class="token punctuation">(</span><span class="token keyword">long</span> ledgerId<span class="token punctuation">,</span> <span class="token keyword">long</span> entryId<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">NoLedgerException</span><span class="token punctuation">,</span> <span class="token class-name">BookieException</span> <span class="token punctuation">{<!-- --></span>
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">LedgerDescriptor</span> handle <span class="token operator">=</span> handles<span class="token punctuation">.</span><span class="token function">getReadOnlyHandle</span><span class="token punctuation">(</span>ledgerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  					<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token comment">//调用真正读数据的逻辑，因为在这里能看到获取的值entry也是对外返回的</span>
            <span class="token comment">//这里调用的是LedgerDescriptor类的readEntry方法</span>
            <span class="token class-name">ByteBuf</span> entry <span class="token operator">=</span> handle<span class="token punctuation">.</span><span class="token function">readEntry</span><span class="token punctuation">(</span>entryId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">return</span> entry<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">ByteBuf</span> <span class="token function">readEntry</span><span class="token punctuation">(</span><span class="token keyword">long</span> entryId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">BookieException</span> <span class="token punctuation">{<!-- --></span>
      	<span class="token comment">//调用LedgerStorage接口，SingleDirectoryDbLedgerStorage实现类来读取Entry</span>
        <span class="token keyword">return</span> ledgerStorage<span class="token punctuation">.</span><span class="token function">getEntry</span><span class="token punctuation">(</span>ledgerId<span class="token punctuation">,</span> entryId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">ByteBuf</span> <span class="token function">getEntry</span><span class="token punctuation">(</span><span class="token keyword">long</span> ledgerId<span class="token punctuation">,</span> <span class="token keyword">long</span> entryId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">BookieException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">long</span> startTime <span class="token operator">=</span> <span class="token class-name">MathUtils</span><span class="token punctuation">.</span><span class="token function">nowInNano</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
          	<span class="token comment">//继续往下跟踪</span>
            <span class="token class-name">ByteBuf</span> entry <span class="token operator">=</span> <span class="token function">doGetEntry</span><span class="token punctuation">(</span>ledgerId<span class="token punctuation">,</span> entryId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">recordSuccessfulEvent</span><span class="token punctuation">(</span>dbLedgerStorageStats<span class="token punctuation">.</span><span class="token function">getReadEntryStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> entry<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

   <span class="token keyword">private</span> <span class="token class-name">ByteBuf</span> <span class="token function">doGetEntry</span><span class="token punctuation">(</span><span class="token keyword">long</span> ledgerId<span class="token punctuation">,</span> <span class="token keyword">long</span> entryId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">BookieException</span> <span class="token punctuation">{<!-- --></span>
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
				<span class="token comment">//尝试从BK本地缓存中读取数据</span>
        <span class="token class-name">ByteBuf</span> entry <span class="token operator">=</span> localWriteCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ledgerId<span class="token punctuation">,</span> entryId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//尝试从本地缓存flush中进行数据命中数据</span>
        entry <span class="token operator">=</span> localWriteCacheBeingFlushed<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ledgerId<span class="token punctuation">,</span> entryId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 尝试从读缓存中进行数据读取</span>
        entry <span class="token operator">=</span> readCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ledgerId<span class="token punctuation">,</span> entryId<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">//从磁盘文件中进行数据读取, 调用的是EntryLogger接口，DefaultEntryLogger对象的readEntry方法</span>
        entry <span class="token operator">=</span> entryLogger<span class="token punctuation">.</span><span class="token function">readEntry</span><span class="token punctuation">(</span>ledgerId<span class="token punctuation">,</span> entryId<span class="token punctuation">,</span> entryLocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">//写到读缓存中</span>
        readCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>ledgerId<span class="token punctuation">,</span> entryId<span class="token punctuation">,</span> entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> entry<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">ByteBuf</span> <span class="token function">readEntry</span><span class="token punctuation">(</span><span class="token keyword">long</span> ledgerId<span class="token punctuation">,</span> <span class="token keyword">long</span> entryId<span class="token punctuation">,</span> <span class="token keyword">long</span> entryLocation<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">Bookie<span class="token punctuation">.</span>NoEntryException</span> <span class="token punctuation">{<!-- --></span>
      	<span class="token comment">//再进一步探索</span>
        <span class="token keyword">return</span> <span class="token function">internalReadEntry</span><span class="token punctuation">(</span>ledgerId<span class="token punctuation">,</span> entryId<span class="token punctuation">,</span> entryLocation<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* validateEntry */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">ByteBuf</span> <span class="token function">internalReadEntry</span><span class="token punctuation">(</span><span class="token keyword">long</span> ledgerId<span class="token punctuation">,</span> <span class="token keyword">long</span> entryId<span class="token punctuation">,</span> <span class="token keyword">long</span> location<span class="token punctuation">,</span> <span class="token keyword">boolean</span> validateEntry<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">Bookie<span class="token punctuation">.</span>NoEntryException</span> <span class="token punctuation">{<!-- --></span>
      	<span class="token comment">//获取entry所在的LogId</span>
        <span class="token keyword">long</span> entryLogId <span class="token operator">=</span> <span class="token function">logIdForOffset</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> pos <span class="token operator">=</span> <span class="token function">posForOffset</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">BufferedReadChannel</span> fc <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> entrySize <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            fc <span class="token operator">=</span> <span class="token function">getFCForEntryInternal</span><span class="token punctuation">(</span>ledgerId<span class="token punctuation">,</span> entryId<span class="token punctuation">,</span> entryLogId<span class="token punctuation">,</span> pos<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">ByteBuf</span> sizeBuff <span class="token operator">=</span> <span class="token function">readEntrySize</span><span class="token punctuation">(</span>ledgerId<span class="token punctuation">,</span> entryId<span class="token punctuation">,</span> entryLogId<span class="token punctuation">,</span> pos<span class="token punctuation">,</span> fc<span class="token punctuation">)</span><span class="token punctuation">;</span>
            entrySize <span class="token operator">=</span> sizeBuff<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>validateEntry<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">validateEntry</span><span class="token punctuation">(</span>ledgerId<span class="token punctuation">,</span> entryId<span class="token punctuation">,</span> entryLogId<span class="token punctuation">,</span> pos<span class="token punctuation">,</span> sizeBuff<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">EntryLookupException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">ByteBuf</span> data <span class="token operator">=</span> allocator<span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span>entrySize<span class="token punctuation">,</span> entrySize<span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token comment">//进行数据读取</span>
        <span class="token keyword">int</span> rc <span class="token operator">=</span> <span class="token function">readFromLogChannel</span><span class="token punctuation">(</span>entryLogId<span class="token punctuation">,</span> fc<span class="token punctuation">,</span> data<span class="token punctuation">,</span> pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        data<span class="token punctuation">.</span><span class="token function">writerIndex</span><span class="token punctuation">(</span>entrySize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> data<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">readFromLogChannel</span><span class="token punctuation">(</span><span class="token keyword">long</span> entryLogId<span class="token punctuation">,</span> <span class="token class-name">BufferedReadChannel</span> channel<span class="token punctuation">,</span> <span class="token class-name">ByteBuf</span> buff<span class="token punctuation">,</span> <span class="token keyword">long</span> pos<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">BufferedLogChannel</span> bc <span class="token operator">=</span> entryLogManager<span class="token punctuation">.</span><span class="token function">getCurrentLogIfPresent</span><span class="token punctuation">(</span>entryLogId<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">//继续往下</span>
        <span class="token keyword">return</span> channel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buff<span class="token punctuation">,</span> pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token class-name">ByteBuf</span> dest<span class="token punctuation">,</span> <span class="token keyword">long</span> pos<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
      	<span class="token comment">//继续往下</span>
        <span class="token keyword">return</span> <span class="token function">read</span><span class="token punctuation">(</span>dest<span class="token punctuation">,</span> pos<span class="token punctuation">,</span> dest<span class="token punctuation">.</span><span class="token function">writableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">int</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token class-name">ByteBuf</span> dest<span class="token punctuation">,</span> <span class="token keyword">long</span> pos<span class="token punctuation">,</span> <span class="token keyword">int</span> length<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Check if the data is in the buffer, if so, copy it.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>readBufferStartPosition <span class="token operator">&lt;=</span> currentPosition
                    <span class="token operator">&amp;&amp;</span> currentPosition <span class="token operator">&lt;</span> readBufferStartPosition <span class="token operator">+</span> readBuffer<span class="token punctuation">.</span><span class="token function">readableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">int</span> posInBuffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>currentPosition <span class="token operator">-</span> readBufferStartPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> bytesToCopy <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>length<span class="token punctuation">,</span> readBuffer<span class="token punctuation">.</span><span class="token function">readableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> posInBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                dest<span class="token punctuation">.</span><span class="token function">writeBytes</span><span class="token punctuation">(</span>readBuffer<span class="token punctuation">,</span> posInBuffer<span class="token punctuation">,</span> bytesToCopy<span class="token punctuation">)</span><span class="token punctuation">;</span>
                currentPosition <span class="token operator">+=</span> bytesToCopy<span class="token punctuation">;</span>
                length <span class="token operator">-=</span> bytesToCopy<span class="token punctuation">;</span>
                cacheHitCount<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// We don't have it in the buffer, so put necessary data in the buffer</span>
                readBufferStartPosition <span class="token operator">=</span> currentPosition<span class="token punctuation">;</span>
                <span class="token keyword">int</span> readBytes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
              	<span class="token comment">//从磁盘读取数据到readBuffer中，再将readBuffer的数据写到 dest中作为返回值</span>
              	<span class="token comment">//这里调用的是Java NIO FileChannel类的read方法来从磁盘进行数据的读取</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>readBytes <span class="token operator">=</span> <span class="token function">validateAndGetFileChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>readBuffer<span class="token punctuation">.</span><span class="token function">internalNioBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> readCapacity<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        currentPosition<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"Reading from filechannel returned a non-positive value. Short read."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                readBuffer<span class="token punctuation">.</span><span class="token function">writerIndex</span><span class="token punctuation">(</span>readBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>currentPosition <span class="token operator">-</span> pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre> 
<h5><a id="_1128"></a>总结</h5> 
<p>在这里解答下引言小故事</p> 
<ul><li> <p>张三是通过什么规则被选成“监督者”的？</p> <p>张三是通过zookeeper的Paxos算法选举产生的</p> </li><li> <p>如果张三也不辞而别呢？</p> <p>大狗和二狗也会通过zookeeper监听张三的状态，如果张三不辞而别的话，大狗二狗会通过zookeeper选举成为新的“监督者”</p> </li><li> <p>为啥要通过签到本的方式，而不是张三直接去挨个挨个看？</p> <p>通过签到本的方式比较节约张三的时间，否则当员工比较多的时候并且对感知时间比较快的时候，张三就要每隔几分钟就要跑去挨个挨个看，这样没多久张三也要“不辞而别”了。通过签到本如果某个同事不签到了张三就能很轻松感知到并做相对应的处理了</p> </li></ul> 
<h5><a id="_1148"></a>参考资料</h5> 
<ol><li>https://bookkeeper.apache.org/docs/admin/autorecovery/</li><li>bk项目 site3/website/docs/admin/* 指令使用说明</li></ol>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c899cc49264e64f90899336ead319985/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Spring Boot中进行分库编程</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/003329dc546cb78c7b8e42bdda86c603/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">pandas保存style到excel文件中</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>