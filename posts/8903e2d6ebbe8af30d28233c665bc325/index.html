<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>nginx的全局配置和HTTP相关配置 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="nginx的全局配置和HTTP相关配置" />
<meta property="og:description" content="目录
资源类型：
网站访问量
网站访问量统计的重要指标
HTTP1.0和1.1的问题
HTTP2协议 HTTP 请求访问的完整过程
HTTP 请求报文 http协议状态码分类
http协议常用的!!状态码!! I/O 的具体实现方式 通过官方 yum 源安装nginx
Nginx 核心模块 Nginx的配置文件的组成部分：
systemctl start nginx: （组装启动，退出 ）systemctl stop nginx.
默认的nginx.conf 配置文件格式说明 绿色自己加的
location 的详细使用 #语法规则： Location @重定向 Nginx 四层访问控制
Nginx 账户认证功能
自定义错误页面（跳转）
检测文件是否存在 （可自行创建）
长连接配置 作为下载服务器配置
范例: 实现下载站点 限流限速 规则必须写入http语句块里
限制并发连接数 规则必须写入http语句块里
实现百度云盘非会员限度限流功能: Nginx 状态页 echo 模块实现信息显示 自定义变量
常用内置变量 server { 都在里面
自定义默认格式日志 自定义json格式日志 支持多个
json 格式的日志访问统计 关于 favicon.ico
Nginx 压缩功能" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/8903e2d6ebbe8af30d28233c665bc325/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-07T17:49:23+08:00" />
<meta property="article:modified_time" content="2023-11-07T17:49:23+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">nginx的全局配置和HTTP相关配置</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="%E8%B5%84%E6%BA%90%E7%B1%BB%E5%9E%8B%EF%BC%9A-toc" style="margin-left:80px;"><a href="#%E8%B5%84%E6%BA%90%E7%B1%BB%E5%9E%8B%EF%BC%9A" rel="nofollow">资源类型：</a></p> 
<p id="%C2%A0%E7%BD%91%E7%AB%99%E8%AE%BF%E9%97%AE%E9%87%8F-toc" style="margin-left:40px;"><a href="#%C2%A0%E7%BD%91%E7%AB%99%E8%AE%BF%E9%97%AE%E9%87%8F" rel="nofollow"> 网站访问量</a></p> 
<p id="%E7%BD%91%E7%AB%99%E8%AE%BF%E9%97%AE%E9%87%8F%E7%BB%9F%E8%AE%A1%E7%9A%84%E9%87%8D%E8%A6%81%E6%8C%87%E6%A0%87-toc" style="margin-left:80px;"><a href="#%E7%BD%91%E7%AB%99%E8%AE%BF%E9%97%AE%E9%87%8F%E7%BB%9F%E8%AE%A1%E7%9A%84%E9%87%8D%E8%A6%81%E6%8C%87%E6%A0%87" rel="nofollow">网站访问量统计的重要指标</a></p> 
<p id="HTTP1.0%E5%92%8C1.1%E7%9A%84%E9%97%AE%E9%A2%98-toc" style="margin-left:80px;"><a href="#HTTP1.0%E5%92%8C1.1%E7%9A%84%E9%97%AE%E9%A2%98" rel="nofollow">HTTP1.0和1.1的问题</a></p> 
<p id="HTTP2%E5%8D%8F%E8%AE%AE%C2%A0-toc" style="margin-left:40px;"><a href="#HTTP2%E5%8D%8F%E8%AE%AE%C2%A0" rel="nofollow">HTTP2协议 </a></p> 
<p id="HTTP%20%E8%AF%B7%E6%B1%82%E8%AE%BF%E9%97%AE%E7%9A%84%E5%AE%8C%E6%95%B4%E8%BF%87%E7%A8%8B-toc" style="margin-left:40px;"><a href="#HTTP%20%E8%AF%B7%E6%B1%82%E8%AE%BF%E9%97%AE%E7%9A%84%E5%AE%8C%E6%95%B4%E8%BF%87%E7%A8%8B" rel="nofollow">HTTP 请求访问的完整过程</a></p> 
<p id="HTTP%20%E8%AF%B7%E6%B1%82%E6%8A%A5%E6%96%87%C2%A0-toc" style="margin-left:40px;"><a href="#HTTP%20%E8%AF%B7%E6%B1%82%E6%8A%A5%E6%96%87%C2%A0" rel="nofollow">HTTP 请求报文 </a></p> 
<p id="%C2%A0http%E5%8D%8F%E8%AE%AE%E7%8A%B6%E6%80%81%E7%A0%81%E5%88%86%E7%B1%BB-toc" style="margin-left:40px;"><a href="#%C2%A0http%E5%8D%8F%E8%AE%AE%E7%8A%B6%E6%80%81%E7%A0%81%E5%88%86%E7%B1%BB" rel="nofollow"> http协议状态码分类</a></p> 
<p id="http%E5%8D%8F%E8%AE%AE%E5%B8%B8%E7%94%A8%E7%9A%84%E7%8A%B6%E6%80%81%E7%A0%81%C2%A0-toc" style="margin-left:0px;"><a href="#http%E5%8D%8F%E8%AE%AE%E5%B8%B8%E7%94%A8%E7%9A%84%E7%8A%B6%E6%80%81%E7%A0%81%C2%A0" rel="nofollow">http协议常用的!!状态码!! </a></p> 
<p id="%C2%A0I%2FO%20%E7%9A%84%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F%C2%A0-toc" style="margin-left:40px;"><a href="#%C2%A0I%2FO%20%E7%9A%84%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F%C2%A0" rel="nofollow"> I/O 的具体实现方式 </a></p> 
<p id="%C2%A0%E9%80%9A%E8%BF%87%E5%AE%98%E6%96%B9%20yum%20%E6%BA%90%E5%AE%89%E8%A3%85nginx-toc" style="margin-left:40px;"><a href="#%C2%A0%E9%80%9A%E8%BF%87%E5%AE%98%E6%96%B9%20yum%20%E6%BA%90%E5%AE%89%E8%A3%85nginx" rel="nofollow"> 通过官方 yum 源安装nginx</a></p> 
<p id="Nginx%20%E6%A0%B8%E5%BF%83%E6%A8%A1%E5%9D%97%C2%A0-toc" style="margin-left:0px;"><a href="#Nginx%20%E6%A0%B8%E5%BF%83%E6%A8%A1%E5%9D%97%C2%A0" rel="nofollow">Nginx 核心模块 </a></p> 
<p id="Nginx%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%9A%84%E7%BB%84%E6%88%90%E9%83%A8%E5%88%86%EF%BC%9A-toc" style="margin-left:80px;"><a href="#Nginx%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%9A%84%E7%BB%84%E6%88%90%E9%83%A8%E5%88%86%EF%BC%9A" rel="nofollow">Nginx的配置文件的组成部分：</a></p> 
<p id="systemctl%20start%20nginx%3A%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%EF%BC%88%E7%BB%84%E8%A3%85%E5%90%AF%E5%8A%A8%EF%BC%8C%E9%80%80%E5%87%BA%20%EF%BC%89systemctl%20stop%20nginx.-toc" style="margin-left:80px;"><a href="#systemctl%20start%20nginx%3A%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%EF%BC%88%E7%BB%84%E8%A3%85%E5%90%AF%E5%8A%A8%EF%BC%8C%E9%80%80%E5%87%BA%20%EF%BC%89systemctl%20stop%20nginx." rel="nofollow">systemctl start nginx:       （组装启动，退出 ）systemctl stop nginx.</a></p> 
<p id="%E9%BB%98%E8%AE%A4%E7%9A%84nginx.conf%20%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E8%AF%B4%E6%98%8E%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%E7%BB%BF%E8%89%B2%E8%87%AA%E5%B7%B1%E5%8A%A0%E7%9A%84-toc" style="margin-left:80px;"><a href="#%E9%BB%98%E8%AE%A4%E7%9A%84nginx.conf%20%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E8%AF%B4%E6%98%8E%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%E7%BB%BF%E8%89%B2%E8%87%AA%E5%B7%B1%E5%8A%A0%E7%9A%84" rel="nofollow">默认的nginx.conf 配置文件格式说明                                         绿色自己加的</a></p> 
<p id="location%20%E7%9A%84%E8%AF%A6%E7%BB%86%E4%BD%BF%E7%94%A8%C2%A0-toc" style="margin-left:40px;"><a href="#location%20%E7%9A%84%E8%AF%A6%E7%BB%86%E4%BD%BF%E7%94%A8%C2%A0" rel="nofollow">location 的详细使用 </a></p> 
<p id="%C2%A0%23%E8%AF%AD%E6%B3%95%E8%A7%84%E5%88%99%EF%BC%9A%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0-toc" style="margin-left:80px;"><a href="#%C2%A0%23%E8%AF%AD%E6%B3%95%E8%A7%84%E5%88%99%EF%BC%9A%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0" rel="nofollow"> #语法规则：                                                         </a></p> 
<p id="Location%20%40%E9%87%8D%E5%AE%9A%E5%90%91%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0-toc" style="margin-left:40px;"><a href="#Location%20%40%E9%87%8D%E5%AE%9A%E5%90%91%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0" rel="nofollow">Location @重定向         </a></p> 
<p id="%C2%A0Nginx%20%E5%9B%9B%E5%B1%82%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6-toc" style="margin-left:80px;"><a href="#%C2%A0Nginx%20%E5%9B%9B%E5%B1%82%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6" rel="nofollow"> Nginx 四层访问控制</a></p> 
<p id="%C2%A0Nginx%20%E8%B4%A6%E6%88%B7%E8%AE%A4%E8%AF%81%E5%8A%9F%E8%83%BD-toc" style="margin-left:80px;"><a href="#%C2%A0Nginx%20%E8%B4%A6%E6%88%B7%E8%AE%A4%E8%AF%81%E5%8A%9F%E8%83%BD" rel="nofollow"> Nginx 账户认证功能</a></p> 
<p id="%C2%A0%E8%87%AA%E5%AE%9A%E4%B9%89%E9%94%99%E8%AF%AF%E9%A1%B5%E9%9D%A2%EF%BC%88%E8%B7%B3%E8%BD%AC%EF%BC%89-toc" style="margin-left:80px;"><a href="#%C2%A0%E8%87%AA%E5%AE%9A%E4%B9%89%E9%94%99%E8%AF%AF%E9%A1%B5%E9%9D%A2%EF%BC%88%E8%B7%B3%E8%BD%AC%EF%BC%89" rel="nofollow"> 自定义错误页面（跳转）</a></p> 
<p id="%C2%A0%E6%A3%80%E6%B5%8B%E6%96%87%E4%BB%B6%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8%20%EF%BC%88%E5%8F%AF%E8%87%AA%E8%A1%8C%E5%88%9B%E5%BB%BA%EF%BC%89-toc" style="margin-left:80px;"><a href="#%C2%A0%E6%A3%80%E6%B5%8B%E6%96%87%E4%BB%B6%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8%20%EF%BC%88%E5%8F%AF%E8%87%AA%E8%A1%8C%E5%88%9B%E5%BB%BA%EF%BC%89" rel="nofollow"> 检测文件是否存在 （可自行创建）</a></p> 
<p id="%E9%95%BF%E8%BF%9E%E6%8E%A5%E9%85%8D%E7%BD%AE%C2%A0-toc" style="margin-left:40px;"><a href="#%E9%95%BF%E8%BF%9E%E6%8E%A5%E9%85%8D%E7%BD%AE%C2%A0" rel="nofollow">长连接配置 </a></p> 
<p id="%E4%BD%9C%E4%B8%BA%E4%B8%8B%E8%BD%BD%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE-toc" style="margin-left:80px;"><a href="#%E4%BD%9C%E4%B8%BA%E4%B8%8B%E8%BD%BD%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE" rel="nofollow">作为下载服务器配置</a></p> 
<p id="%E8%8C%83%E4%BE%8B%3A%20%E5%AE%9E%E7%8E%B0%E4%B8%8B%E8%BD%BD%E7%AB%99%E7%82%B9%C2%A0-toc" style="margin-left:80px;"><a href="#%E8%8C%83%E4%BE%8B%3A%20%E5%AE%9E%E7%8E%B0%E4%B8%8B%E8%BD%BD%E7%AB%99%E7%82%B9%C2%A0" rel="nofollow">范例: 实现下载站点 </a></p> 
<p id="%E9%99%90%E6%B5%81%E9%99%90%E9%80%9F%C2%A0%20%C2%A0%E8%A7%84%E5%88%99%E5%BF%85%E9%A1%BB%E5%86%99%E5%85%A5http%E8%AF%AD%E5%8F%A5%E5%9D%97%E9%87%8C-toc" style="margin-left:40px;"><a href="#%E9%99%90%E6%B5%81%E9%99%90%E9%80%9F%C2%A0%20%C2%A0%E8%A7%84%E5%88%99%E5%BF%85%E9%A1%BB%E5%86%99%E5%85%A5http%E8%AF%AD%E5%8F%A5%E5%9D%97%E9%87%8C" rel="nofollow">限流限速   规则必须写入http语句块里</a></p> 
<p id="%E9%99%90%E5%88%B6%E5%B9%B6%E5%8F%91%E8%BF%9E%E6%8E%A5%E6%95%B0%C2%A0%20%C2%A0%20%C2%A0%E8%A7%84%E5%88%99%E5%BF%85%E9%A1%BB%E5%86%99%E5%85%A5http%E8%AF%AD%E5%8F%A5%E5%9D%97%E9%87%8C-toc" style="margin-left:40px;"><a href="#%E9%99%90%E5%88%B6%E5%B9%B6%E5%8F%91%E8%BF%9E%E6%8E%A5%E6%95%B0%C2%A0%20%C2%A0%20%C2%A0%E8%A7%84%E5%88%99%E5%BF%85%E9%A1%BB%E5%86%99%E5%85%A5http%E8%AF%AD%E5%8F%A5%E5%9D%97%E9%87%8C" rel="nofollow">限制并发连接数     规则必须写入http语句块里</a></p> 
<p id="%E5%AE%9E%E7%8E%B0%E7%99%BE%E5%BA%A6%E4%BA%91%E7%9B%98%E9%9D%9E%E4%BC%9A%E5%91%98%E9%99%90%E5%BA%A6%E9%99%90%E6%B5%81%E5%8A%9F%E8%83%BD%3A%C2%A0-toc" style="margin-left:80px;"><a href="#%E5%AE%9E%E7%8E%B0%E7%99%BE%E5%BA%A6%E4%BA%91%E7%9B%98%E9%9D%9E%E4%BC%9A%E5%91%98%E9%99%90%E5%BA%A6%E9%99%90%E6%B5%81%E5%8A%9F%E8%83%BD%3A%C2%A0" rel="nofollow">实现百度云盘非会员限度限流功能: </a></p> 
<p id="Nginx%20%E7%8A%B6%E6%80%81%E9%A1%B5%C2%A0-toc" style="margin-left:80px;"><a href="#Nginx%20%E7%8A%B6%E6%80%81%E9%A1%B5%C2%A0" rel="nofollow">Nginx 状态页 </a></p> 
<p id="echo%20%E6%A8%A1%E5%9D%97%E5%AE%9E%E7%8E%B0%E4%BF%A1%E6%81%AF%E6%98%BE%E7%A4%BA%C2%A0-toc" style="margin-left:80px;"><a href="#echo%20%E6%A8%A1%E5%9D%97%E5%AE%9E%E7%8E%B0%E4%BF%A1%E6%81%AF%E6%98%BE%E7%A4%BA%C2%A0" rel="nofollow">echo 模块实现信息显示 </a></p> 
<p id="%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8F%98%E9%87%8F-toc" style="margin-left:80px;"><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8F%98%E9%87%8F" rel="nofollow">自定义变量</a></p> 
<p id="%E5%B8%B8%E7%94%A8%E5%86%85%E7%BD%AE%E5%8F%98%E9%87%8F%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0server%20%7B%C2%A0%20%C2%A0%20%E9%83%BD%E5%9C%A8%E9%87%8C%E9%9D%A2-toc" style="margin-left:40px;"><a href="#%E5%B8%B8%E7%94%A8%E5%86%85%E7%BD%AE%E5%8F%98%E9%87%8F%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0server%20%7B%C2%A0%20%C2%A0%20%E9%83%BD%E5%9C%A8%E9%87%8C%E9%9D%A2" rel="nofollow">常用内置变量       server {    都在里面</a></p> 
<p id="%E8%87%AA%E5%AE%9A%E4%B9%89%E9%BB%98%E8%AE%A4%E6%A0%BC%E5%BC%8F%E6%97%A5%E5%BF%97%C2%A0-toc" style="margin-left:80px;"><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%BB%98%E8%AE%A4%E6%A0%BC%E5%BC%8F%E6%97%A5%E5%BF%97%C2%A0" rel="nofollow">自定义默认格式日志 </a></p> 
<p id="%E8%87%AA%E5%AE%9A%E4%B9%89json%E6%A0%BC%E5%BC%8F%E6%97%A5%E5%BF%97%C2%A0%20%C2%A0%E6%94%AF%E6%8C%81%E5%A4%9A%E4%B8%AA-toc" style="margin-left:80px;"><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89json%E6%A0%BC%E5%BC%8F%E6%97%A5%E5%BF%97%C2%A0%20%C2%A0%E6%94%AF%E6%8C%81%E5%A4%9A%E4%B8%AA" rel="nofollow">自定义json格式日志   支持多个</a></p> 
<p id="json%20%E6%A0%BC%E5%BC%8F%E7%9A%84%E6%97%A5%E5%BF%97%E8%AE%BF%E9%97%AE%E7%BB%9F%E8%AE%A1%C2%A0-toc" style="margin-left:80px;"><a href="#json%20%E6%A0%BC%E5%BC%8F%E7%9A%84%E6%97%A5%E5%BF%97%E8%AE%BF%E9%97%AE%E7%BB%9F%E8%AE%A1%C2%A0" rel="nofollow">json 格式的日志访问统计 </a></p> 
<p id="%C2%A0%E5%85%B3%E4%BA%8E%20favicon.ico-toc" style="margin-left:80px;"><a href="#%C2%A0%E5%85%B3%E4%BA%8E%20favicon.ico" rel="nofollow"> 关于 favicon.ico</a></p> 
<p id="Nginx%20%E5%8E%8B%E7%BC%A9%E5%8A%9F%E8%83%BD-toc" style="margin-left:0px;"><a href="#Nginx%20%E5%8E%8B%E7%BC%A9%E5%8A%9F%E8%83%BD" rel="nofollow">Nginx 压缩功能</a></p> 
<p id="https%20%E5%8A%A0%E5%AF%86%C2%A0-toc" style="margin-left:40px;"><a href="#https%20%E5%8A%A0%E5%AF%86%C2%A0" rel="nofollow">https 加密 </a></p> 
<p id="%E5%B9%B3%E6%BB%91%E5%8D%87%E7%BA%A7%E5%92%8C%E5%9B%9E%E6%BB%9A-toc" style="margin-left:40px;"><a href="#%E5%B9%B3%E6%BB%91%E5%8D%87%E7%BA%A7%E5%92%8C%E5%9B%9E%E6%BB%9A" rel="nofollow">平滑升级和回滚</a></p> 
<hr id="hr-toc"> 
<p></p> 
<p>早期HTTP传输协议就是为了传输HTML（超文本协议）后来有了MIME（支持图片视频之类的）</p> 
<p>在页面按F12可以查看那个最慢 </p> 
<p>传输过程</p> 
<blockquote> 
 <p>1域名解析ip</p> 
 <p>DS解析</p> 
 <p>ip解析完之后就是三次握手 之后渲染，最后四次挥手</p> 
</blockquote> 
<p>HTTP协议分层 </p> 
<p><img alt="" height="590" src="https://images2.imgbox.com/dc/1d/Oj0YmK4J_o.png" width="905"></p> 
<p></p> 
<h4 id="%E8%B5%84%E6%BA%90%E7%B1%BB%E5%9E%8B%EF%BC%9A">资源类型：</h4> 
<ul><li>静态文件：无需服务端做出额外处理,服务器端和客户端的文件内容相同</li><li>常见文件后缀：.html, .txt, .jpg, .js, .css, .mp3, .avi</li><li>动态文件：服务端执行程序，返回执行的结果,服务器端和客户端的文件内容不相同</li><li>常见文件后缀：.php, .jsp ,.asp</li></ul> 
<p>&lt;scheme&gt;://&lt;user&gt;:&lt;password&gt;@&lt;host&gt;:&lt;port&gt;/&lt;path&gt;;&lt;params&gt;?&lt;query&gt;#&lt;frag&gt;</p> 
<p> URL组成<img alt="" height="101" src="https://images2.imgbox.com/9e/c6/wwjJCr2G_o.png" width="886"></p> 
<p> 参考链接</p> 
<blockquote> 
 <p>https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/Identifying_resources_on_the_Web </p> 
</blockquote> 
<blockquote> 
 <p>  scheme:方案，访问服务器以获取资源时要使用哪种协议\</p> 
</blockquote> 
<blockquote> 
 <p>user:用户，某些方案访问资源时需要的用户名<br> password:密码，用户对应的密码，中间用：分隔<br> Host:主机，资源宿主服务器的主机名或IP地址<br> port:端口,资源宿主服务器正在监听的端口号，很多方案有默认端口号<br> path:路径,服务器资源的本地名，由一个/将其与前面的URL组件分隔<br> params:参数，指定输入的参数，参数为名/值对，多个参数，用;分隔<br> query:查询，传递参数给程序，如数据库，用？分隔,多个查询用&amp;分隔<br> frag:片段,一小片或一部分资源的名字，此组件在客户端使用，用#分隔</p> 
</blockquote> 
<h3 id="%C2%A0%E7%BD%91%E7%AB%99%E8%AE%BF%E9%97%AE%E9%87%8F"> 网站访问量</h3> 
<h4 id="%E7%BD%91%E7%AB%99%E8%AE%BF%E9%97%AE%E9%87%8F%E7%BB%9F%E8%AE%A1%E7%9A%84%E9%87%8D%E8%A6%81%E6%8C%87%E6%A0%87">网站访问量统计的重要指标</h4> 
<ul><li>IP(独立IP)：即Internet Protocol,指独立IP数。一天内来自相同客户机IP 地址只计算一次，记录远程客户机IP地址的计算机访问网站的次数，是衡量网站流量的重要指标</li><li>PV(访问量)： 即Page View, 页面浏览量或点击量，用户每次刷新即被计算一次，PV反映的是浏览某网站的页面数，PV与来访者的数量成正比，PV并不是页面的来访者数量，而是网站被访问的页面数量</li><li>UV(独立访客)：即Unique Visitor,访问网站的一台电脑为一个访客。一天内相同的客户端只被计算一次。可以理解成访问某网站的电脑的数量。网站判断来访电脑的身份是通过cookies实现的。如果更换了IP后但不清除cookies，再访问相同网站，该网站的统计中UV数是不变的</li></ul> 
<h4 id="HTTP1.0%E5%92%8C1.1%E7%9A%84%E9%97%AE%E9%A2%98">HTTP1.0和1.1的问题</h4> 
<p>HTTP1.x在传输数据时，每次都需要重新建立连接，无疑增加了大量的延迟时间，特别是在移动端<br> 更为突出<br> HTTP1.x在传输数据时，所有传输的内容都是明文，客户端和服务器端都无法验证对方的身份，无<br> 法保证数据的安全性</p> 
<h3 id="HTTP2%E5%8D%8F%E8%AE%AE%C2%A0">HTTP2协议 </h3> 
<p>HTTP2协议抄的SPDY协议（谷歌发明） 解决了HTTP1的问题 还快自性选择是否加密</p> 
<h3 id="HTTP%20%E8%AF%B7%E6%B1%82%E8%AE%BF%E9%97%AE%E7%9A%84%E5%AE%8C%E6%95%B4%E8%BF%87%E7%A8%8B">HTTP 请求访问的完整过程</h3> 
<p><img alt="" height="508" src="https://images2.imgbox.com/fe/a0/0ybiaiH7_o.png" width="791"></p> 
<p></p> 
<h3 id="HTTP%20%E8%AF%B7%E6%B1%82%E6%8A%A5%E6%96%87%C2%A0">HTTP 请求报文 </h3> 
<p><img alt="" height="510" src="https://images2.imgbox.com/26/84/PRBIYrje_o.png" width="861"></p> 
<p></p> 
<p><img alt="" height="588" src="https://images2.imgbox.com/cf/9b/CvJlCZ6T_o.png" width="552"></p> 
<h3 id="%C2%A0http%E5%8D%8F%E8%AE%AE%E7%8A%B6%E6%80%81%E7%A0%81%E5%88%86%E7%B1%BB"> http协议状态码分类</h3> 
<blockquote> 
 <p>xx：100-101 信息提示<br> 2xx：200-206 成功<br> 3xx：300-307 重定向<br> 4xx：400-415 错误类信息，客户端错误<br> 5xx：500-505 错误类信息，服务器端错误</p> 
</blockquote> 
<h2 id="http%E5%8D%8F%E8%AE%AE%E5%B8%B8%E7%94%A8%E7%9A%84%E7%8A%B6%E6%80%81%E7%A0%81%C2%A0">http协议常用的!!状态码!! </h2> 
<blockquote> 
 <p>00： 成功，请求数据通过响应报文的entity-body部分发送;OK<br> 301： 请求的URL指向的资源已经被删除；但在响应报文中通过首部Location指明了资源现在所处的新位置；Moved Permanently<br> 302： 响应报文Location指明资源临时新位置 Moved Temporarily </p> 
 <p>304： 客户端发出了条件式请求，但服务器上的资源未曾发生改变，则通过响应此响应状态码通知客户端；<br> Not Modified<br> 307: 浏览器内部重定向<br> 401： 需要输入账号和密码认证方能访问资源；Unauthorized<br> 403： 请求被禁止；Forbidden,一般是因为权限错误或主页文件不存在<br> 404： 服务器无法找到客户端请求的资源；Not Found<br> 413: 上传的资源超过了最大限制值<br> 499： 客户端主动断开连接。然而在实际业务开发中，当出现 HTTP 499 状态码时，大部分都是由于服务端<br> 请求时间过长，导致客户端等的“不耐烦”了，因此断开了连接。比如：慢SQL问题，499是客户端读超时关闭<br> 连接造成的，推荐从超时时间或者优化响应速度入手,web服务器发现客户端主动关闭连接后，记录到access<br> 日志中的。可能是客户端接收响应超时了,可以先在客户端统计下是不是这个原因，再调查为什么会导致超时<br> 500： 服务器内部错误；Internal Server Error,比如:cgi程序没有执行权限,或连接数据库失<br> 败,rewrite死循环<br> 502： Bad Gateway,代理服务器从后端服务器收到了一条错误响应，如无法连接到网关；Bad Gateway,<br> 比如:后端服务端口没有打开,或后端服务不可用,iptable -j REJECT<br> 503： 服务不可用，临时服务器维护或过载，服务器无法处理请求,比如:超过连接数和连接频率<br> 504： Gateway Timeout,网关超时,或者后端服务器无回应报文,比如:服务端口虽然打开,但服务返回结果<br> 时间过长,iptable -j DROP</p> 
</blockquote> 
<h3 id="%C2%A0I%2FO%20%E7%9A%84%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F%C2%A0"> I/O 的具体实现方式 </h3> 
<blockquote> 
 <p>1、select：<br> select库是在linux和windows平台都基本支持的 事件驱动模型库，并且在接口的定义也基本相同，只是部分参数的含义略有差异，最大并发限制1024，是最早期的事件驱动模型。I/O多路复用这个概念被提出来以后， select于1983年第一个在BSD里面实现<br> 2、poll：<br> 在Linux 的基本驱动模型，windows不支持此驱动模型，是select的升级版，取消了最大的并发限制，在编译nginx的时候可以使用--with-poll_module和--without-poll_module这两个指定是否编译select库。poll出现在1997年<br> 3、epoll：<br> epoll是库是Nginx服务器支持的最高性能的事件驱动库之一，是公认的非常优秀的事件驱动模型，它和select和poll有很大的区别，epoll是poll的升级版，但是与poll有很大的区别.在2002年DavideLibenzi 实现了epoll.epoll的处理方式是创建一个待处理的事件列表，然后把这个列表发给内核，返回的时候在去轮询检查这个表，以判断事件是否发生，epoll支持一个进程打开的最大事件描述符的上限是系统可以打开的文件的最大数，同时epoll库的I/O效率不随描述符数目增加而线性下降，因为它只会对内核上报的“活跃”的描述符进行操作。<br> 4、kqueue：<br> 用于支持BSD系列平台的高校事件驱动模型，主要用在FreeBSD 4.1及以上版本、OpenBSD 2.0级以上版本，NetBSD级以上版本及Mac OS X 平台上，该模型也是poll库的变种，因此和epoll没有本质上的区别，<br> 效效率和epoll相似<br> 5、IOCP：<br> Windows系统上的实现方式，对应第5种（异步I/O）模型。<br> 6、/dev/poll:<br> 用于支持unix衍生平台的高效事件驱动模型，主要在Solaris 平台、HP/UX，该模型是sun公司在开发<br> Solaris系列平台的时候提出的用于完成事件驱动机制的方案，它使用了虚拟的/dev/poll设备，开发人员将<br> 要见识的文件描述符加入这个设备，然后通过ioctl()调用来获取事件通知，因此运行在以上系列平台的时候请使用/dev/poll事件驱动机制。效率和epoll相似<br> 7、rtsig：<br> 不是一个常用事件驱动，最大队列1024，不是很常用<br> 8、eventport：</p> 
 <p>该方案也是sun公司在开发Solaris的时候提出的事件驱动库，只是Solaris 10以上的版本，该驱动库可防止内核崩溃等情况的发生。</p> 
</blockquote> 
<p><img alt="" height="591" src="https://images2.imgbox.com/02/3d/EPbuSKTf_o.png" width="843"></p> 
<h3 id="%C2%A0%E9%80%9A%E8%BF%87%E5%AE%98%E6%96%B9%20yum%20%E6%BA%90%E5%AE%89%E8%A3%85nginx"> 通过官方 yum 源安装nginx最新版</h3> 
<p>vim /etc/yum.repos.d/nginx.repo             (创建写入)</p> 
<pre><code class="language-bash">[nginx-stable]
name=nginx stable repo
baseurl=http://nginx.org/packages/centos/$releasever/$basearch/
gpgcheck=1
enabled=1
gpgkey=https://nginx.org/keys/nginx_signing.key
module_hotfixes=true</code></pre> 
<p> [root@rocky8 ~]#yum list nginx                                    更新一下源</p> 
<p>#安装指定版本<br> [root@centos8 ~]#yum -y install nginx</p> 
<p>apt update    自动更新有可能有锁</p> 
<p>nginx -t 检查语法（建议经常用，损失无小事）</p> 
<p><img alt="" height="365" src="https://images2.imgbox.com/33/8e/UG6GYarh_o.png" width="822"></p> 
<p></p> 
<p></p> 
<h2 id="Nginx%20%E6%A0%B8%E5%BF%83%E6%A8%A1%E5%9D%97%C2%A0">Nginx 核心模块 </h2> 
<h4 id="Nginx%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%9A%84%E7%BB%84%E6%88%90%E9%83%A8%E5%88%86%EF%BC%9A">Nginx的配置文件的组成部分：</h4> 
<ul><li>主配置文件：nginx.conf</li><li>子配置文件: include conf.d/*.conf</li><li>fastcgi， uwsgi，scgi 等协议相关的配置文件</li><li>mime.types：支持的mime类型，MIME(Multipurpose Internet Mail Extensions)多用途互联网邮件扩展类型，MIME消息能包含文本、图像、音频、视频以及其他应用程序专用的数据，是设定某种扩展名的文件用一种应用程序来打开的方式类型，当该扩展名文件被访问的时候，浏览器会自动使用指定应用程序来打开。多用于指定一些客户端自定义的文件名，以及一些媒体文件打开方式。</li></ul> 
<p>Nginx 主配置文件的配置指令方式：</p> 
<blockquote> 
 <p>directive value [value2 ...];<br> 注意<br> (1) 指令必须以分号结尾<br> (2) 支持使用配置变量<br> 内建变量：由Nginx模块引入，可直接引用<br> 自定义变量：由用户使用set命令定义,格式: set variable_name value;<br> 引用变量：$variable_name</p> 
</blockquote> 
<p><strong>主配置文件结构：四部分 </strong></p> 
<blockquote> 
 <p>main block：主配置段，即全局配置段，对http,mail都有效<br> #事件驱动相关的配置<br> event {<!-- --><br> ...<br> }<br> #http/https 协议相关配置段<br> http {<!-- --><br> ...<br> }<br> #默认配置文件不包括下面两个块<br> #mail 协议相关配置段<br> mail {<!-- --><br> ...<br> }<br> #stream 服务器相关配置段<br> stream {<!-- --></p> 
 <p>...<br> }</p> 
</blockquote> 
<h4>两种组合启动退出</h4> 
<blockquote> 
 <h4 id="systemctl%20start%20nginx%3A%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%EF%BC%88%E7%BB%84%E8%A3%85%E5%90%AF%E5%8A%A8%EF%BC%8C%E9%80%80%E5%87%BA%20%EF%BC%89systemctl%20stop%20nginx.">systemctl start nginx:       （组装启动，退出 ）<br> systemctl stop nginx.</h4> 
</blockquote> 
<blockquote> 
 <p>nginx（启动）</p> 
 <p>nginx -s puit (循环退出，现有用户可以访问，后续用户连接不上，最后谁都连接不上)</p> 
</blockquote> 
<h4 id="%E9%BB%98%E8%AE%A4%E7%9A%84nginx.conf%20%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E8%AF%B4%E6%98%8E%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%E7%BB%BF%E8%89%B2%E8%87%AA%E5%B7%B1%E5%8A%A0%E7%9A%84"><strong>默认的nginx.conf 配置文件格式说明                                         绿色自己加的</strong></h4> 
<blockquote> 
 <p>#全局配置端，对全局生效，主要设置nginx的启动用户/组，启动的工作进程数量，工作模式，Nginx的PID       （设置账号的话需要给账号相关权限，不然没用） <br> 路径，日志路径等。 （普通账户是没有权限监听1023端口以下的）<br><strong>user nginx nginx; </strong>                                  启动Nginx工作进程的用户和</p> 
 <p><strong>orker_processes</strong> [number | auto]; #启动Nginx工作进程的数量,一般设为和CPU核心数相同;                                                                            最好设置为auto(自动改成cpu的核数)</p> 
 <p><span style="color:#1a439c;"><strong> worker_cpu_affinity</strong></span> 00000001 00000010 00000100 00001000 | auto ; #将Nginx工作进程绑定到指定的CPU核心，默认Nginx是不进行进程绑定的，绑定并不是意味着当前nginx进程独占以一核心CPU，但是可以保证此进程不会运行在其他核心上，这就极大减少了nginx的工作进程在不同的cpu核心上的来回跳转，减少了CPU对进程的资源分配与回收以及内存管理等，因此可以有效的提升nginx服务器的性能。<br> CPU MASK: 00000001：0号CPU<br> 00000010：1号CPU</p> 
 <p>100           :  2号CPU<br> 10000000：7号CPU</p> 
 <p></p> 
 <p>#error_log  logs/error.log;                   错误日志（可以自行盖）cat/apps/nginx/logs/error.log  <br> #error_log  logs/error.log  notice;<br> #error_log  logs/error.log  info;   </p> 
 <p><span style="color:#1a439c;"><strong>worker_priority</strong></span> 0; #工作进程优先级，-20~20(19)</p> 
 <p><strong><span style="color:#1a439c;">worker_rlimit_nofile</span> </strong>65536; #所有worker进程能打开的文件数量上限,包括:Nginx的所有连接（例如与代理服务器的连接等），而不仅仅是与客户端的连接,另一个考虑因素是实际的并发连接数不能超过系统级别的最大打开文件数的限制.最好与<strong>ulimit -n </strong>或者limits.conf的值保持一致,    （简单来说就是设置上线，防止忽然太多炸了）</p> 
 <p></p> 
 <p><span style="color:#1a439c;"><strong>daemon off;</strong></span> #前台运行Nginx服务用于测试、或者以容器运行时，需要设为off</p> 
 <p>守护进程一般都是开机自己启动的·后台进程，不需要用户登录</p> 
 <p><span style="color:#1a439c;"><strong>master_process </strong></span>off|on; #是否开启Nginx的master-worker工作模式，仅用于开发调试场景,默认为 on</p> 
 <p><span style="color:#1a439c;"><strong>worker_connections</strong></span> 65536; #设置单个工作进程的最大并发连接数   </p> 
 <p>（ 和·<strong><span style="color:#1a439c;">worker_rlimit_nofile有关，</span></strong>）</p> 
 <p><span style="color:#1a439c;"><strong>use epoll; </strong></span>#使用epoll事件驱动，Nginx支持众多的事件驱动，比如:select、poll、epoll，只<br> 能设置在events模块中设置。  </p> 
 <p><span style="color:#1a439c;"><strong>accept_mutex on</strong></span>; #on为同一时刻一个请求轮流由worker进程处理,而防止被同时唤醒所有<br> worker,避免多个睡眠进程被唤醒的设置，默认为off，新请求会唤醒所有worker进程,此过程也称为"<strong>惊群</strong>"，因此nginx刚安装完以后要进行适当的优化。建议设置为on</p> 
 <p><span style="color:#1a439c;"><strong>multi_accept </strong></span>on; #on时Nginx服务器的每个工作进程可以同时接受多个新的网络连接，此指令默认为off，即默认为一个工作进程只能一次接受一个新的网络连接，打开后几个同时接受多个。建议设置为on}</p> 
 <p>#<strong>如果systemd启动,则需要修改nginx.service文件中加LimitNOFILE=100000,才能有效</strong></p> 
 <p>[root@ubuntu2004 ~]#vim /lib/systemd/system/nginx.service</p> 
 <p><strong>#root@centos8 ~]#vim /etc/security/limits.conf</strong></p> 
 <p>root@centos8 ~]#vim /etc/security/limits.conf</p> 
</blockquote> 
<p>可以一个nginx下多个网站， 也可以多个nginx下一个文件</p> 
<p>是否在响应报文的Server首部显示nginx版本 http下（不显示版本信息显示软件名，可以自己改）<br> server_tokens on | off | build | string;</p> 
<p>nginx -s reload                重新加载文件</p> 
<p>1 把京东另存下来</p> 
<p>2 在vim /apps/nginx/conf/nginx.conf的最后的}写上路径 include /apps/nginx/conf/conf.d/*.conf;</p> 
<p>3 mkdir /apps/nginx/conf/conf.d/   创建文件路径</p> 
<p></p> 
<blockquote> 
 <p>server {                                                加在文件目录指定区<br>     listen 80 default_server;           default_server  设置监听地址和端口,多个虚拟机时当前是否是默认的虚拟主机<br>     server_name www.wang.org;<br>     root /data/nginx/html/pc/;<br> }</p> 
</blockquote> 
<blockquote> 
 <p>一个服务器上有多个网站他是通过ip头来确定你访问的是谁的，</p> 
 <p>你访问的域名他会转会成ip 而IP会把域名以Host（主机头的方式带走）去访问你指定的网站</p> 
 <p>访问IP号的话谁优先级高（在前面）先访问谁 ，也可以用IP地址端口号来区分  default_serve可以设置默认访问谁也可以指定访问 curl -H -v "host: www.wang.org" 10.0.0.100区分方法 1端口号 2 ip  3  主机头 server  一般主机头区分 合理</p> 
</blockquote> 
<h3 id="location%20%E7%9A%84%E8%AF%A6%E7%BB%86%E4%BD%BF%E7%94%A8%C2%A0">location 的详细使用 </h3> 
<blockquote> 
 <p> server {<!-- --><br>     listen 80 default_server;<br>     server_name www.wang.org;<br>     root /data/nginx/html/pc/;<br>   <strong>  location /test/ { </strong>                        #当访问www.wang.org/test/时 需要单独定义访问时需要在    location 下指定<br><strong>        alias /opt/pc/ ;                   #这样他就会去</strong>/test/找了<br>     <strong>}</strong></p> 
 <p>}</p> 
</blockquote> 
<h4 id="%C2%A0%23%E8%AF%AD%E6%B3%95%E8%A7%84%E5%88%99%EF%BC%9A%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0"> <strong>#语法规则：                                                         </strong></h4> 
<blockquote> 
 <p><strong>#语法规则：                                  用于动静分离 访问谁</strong><br> location [ = | ~ | ~* | ^~ ] uri { ... }<br> =         #用于标准uri前，需要请求字串与uri精确匹配，大小敏感,如果匹配成功就停止向下匹配并立即处理请求<br> ^~         #用于标准uri前，表示包含正则表达式,并且匹配以指定的正则表达式开头,对uri的最左边部分做匹配检查，不区分字符大小写<br> ~         #用于标准uri前，表示包含正则表达式,并且区分大小写<br> ~*         #用于标准uri前，表示包含则表达式,并且不区分大写</p> 
 <p>不带符号           #匹配起始于此uri的所有的uri<br> \         #用于标准uri前，表示包含正则表达式并且转义字符。可以将 . * ?等转义为普通符号<br> #        匹配优先级从高到低：<br> =, ^~, ~/~*, 不带符号 </p> 
</blockquote> 
<p>范例： </p> 
<pre><code># cat /etc/nginx/conf.d/www.wang.org.conf
server {
    listen 80;
    server_name location.wang.org;
    location = / {
        default_type text/html;
        return 200 'location = /';
    }
    location / {
        default_type text/html;
        return 200 'location /';
    }
    location /documents/ {
        default_type text/html;
        return 200 'location /documents/';
    }
    location ^~ /images/ {
        default_type text/html;
        return 200 'location ^~ /images/';
    }
    location ~* \.(gif|jpg|jpeg)$ {
        default_type text/html;
        return 200 'location ~* \.(gif|jpg|jpeg)';
        }
    }</code></pre> 
<blockquote> 
 <p> #测试结果如下,建议是curl测试<br> #1.请求 http://location.wang.org/ 会被 location =/ 匹配<br> #2.请求 http://location.wang.org/index.html 会被 location / 匹配<br> #3.请求 http://location.wang.org/documents/1.html 会被 location /documents/ 匹配<br> #4.请求 http://location.wang.org/images/1.gif 会被 location ^~ /images/ 匹配<br> #5.请求 http://location.wang.org/documents/1.jpg 会被 location ~* \.<br> (gif|jpg|jpeg)$匹配</p> 
</blockquote> 
<h3 id="Location%20%40%E9%87%8D%E5%AE%9A%E5%90%91%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0">Location @重定向         </h3> 
<blockquote> 
 <p>                                ngx_http_core_module      模块的上述大部分·指令都来源于这里</p> 
 <p>server {<!-- --><br>     listen 80 default_server;<br>     server_name www.wang.org;<br>     root /data/nginx/html/pc/;<br>     error_page 404 @error_404;      #如果出现异常,则重新定向到@error_404这个location上<br>         location @error_404 {              #就是自行指定错误输出<br>         default_type text/html;<br>         charset utf8;<br>         return 200 '你访问的页面可能走丢了!';<br>  }<br> }</p> 
</blockquote> 
<h4 id="%C2%A0Nginx%20%E5%9B%9B%E5%B1%82%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6"> Nginx 四层访问控制</h4> 
<blockquote> 
 <p>  server {                                        自己访问自己也不行<br>     listen 80 default_server;<br>     server_name www.wang.org;<br>     root /data/nginx/html/pc/;<br>     deny 10.0.0.1;                              拒绝访问<br>     allow 10.0.0.0/24;                         允许访问<br>     deny all;                                        拒绝所有访问 #按先小范围到大范围排序<br> }    </p> 
</blockquote> 
<h4 id="%C2%A0Nginx%20%E8%B4%A6%E6%88%B7%E8%AE%A4%E8%AF%81%E5%8A%9F%E8%83%BD"> Nginx 账户认证功能</h4> 
<p>[root@ubuntu2004 conf.d]#apt install apache2-utils    下载安装包</p> 
<p>[root@ubuntu2004 pc]#htpasswd -c -b /apps/nginx/conf/conf.d/.nginx_users wei 123456</p> 
<p>htpasswd    创建文件地址  c 指定用户名 b 指定密码   <br> [root@ubuntu2004 pc]#htpasswd  -b /apps/nginx/conf/conf.d/.nginx_users huahua 123456<br>   htpasswd    创建文件地址      第二次不要再下c 不然会覆盖    b 指定密码   </p> 
<p>curl http://wei:123456@www.wang.org/admin/     交互式登录</p> 
<blockquote> 
 <p>server {                                                可以抓包找到密码<br>     listen 80 default_server;<br>     server_name www.wang.org;<br>     root /data/nginx/html/pc/;<br>     location  /admin {<!-- --><br>     auth_basic   "login password";          指定提示符<br>     auth_basic_user_file /apps/nginx/conf/conf.d/.nginx_users; 指定认证的人文件（下载包）<br>     }<br> }        </p> 
</blockquote> 
<h4 id="%C2%A0%E8%87%AA%E5%AE%9A%E4%B9%89%E9%94%99%E8%AF%AF%E9%A1%B5%E9%9D%A2%EF%BC%88%E8%B7%B3%E8%BD%AC%EF%BC%89"> 自定义错误页面（跳转）</h4> 
<blockquote> 
 <p> server {<!-- --><br>     listen 80 default_server;<br>     server_name www.wang.org;<br>     root /data/nginx/html/pc/;<br>     error_page 500 502 503 404 =200 /index.html;       错误页面也跳转到正确页面<br>     location  /admin {<!-- --><br>     auth_basic   "login password";<br>     auth_basic_user_file /apps/nginx/conf/conf.d/.nginx_users;<br>     }<br> }        </p> 
 <p>error_page 500 502 503 504 404 /error.html;      错误页面跳转到指定页面（需要在错误页面的指定文件里创建/error.htm在里面创建错误页面）</p> 
 <p>error_log /apps/nginx/logs/www.wang.org-error.log; 自定此文件错误日志放这里</p> 
</blockquote> 
<h4 id="%C2%A0%E6%A3%80%E6%B5%8B%E6%96%87%E4%BB%B6%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8%20%EF%BC%88%E5%8F%AF%E8%87%AA%E8%A1%8C%E5%88%9B%E5%BB%BA%EF%BC%89"><strong> 检测文件是否存在 （可自行创建）</strong></h4> 
<blockquote> 
 <p>server {<!-- --><br>     listen 80 ;<br>     server_name www.wang.org;<br>     root /data/nginx/html/pc/;<br> #    error_log /apps/nginx/logs/www.wang.org-error.log;<br>     try_files $uri $uri/index.html $uri.html =489;   若文件不存在 则按要求搜索 直到489<br>     location  /admin {                                         也可手动创建访问xxx 就创建xxx.html 或什么<br>     auth_basic   "login password";<br>     auth_basic_user_file /apps/nginx/conf/conf.d/.nginx_users;<br>     } <br> }   <a href="http://www.wang.org/xxx" rel="nofollow" title="http://www.wang.org/xxx">http://www.wang.org/xxx</a>    </p> 
 <p>  <img alt="" height="155" src="https://images2.imgbox.com/4e/75/m8AiCXhX_o.png" width="342"></p> 
</blockquote> 
<h3 id="%E9%95%BF%E8%BF%9E%E6%8E%A5%E9%85%8D%E7%BD%AE%C2%A0">长连接配置 </h3> 
<blockquote> 
 <p>keepalive_time time; #限制对一个连接中请求处理的最长时间,到时间后续的再有新的请求会断开连接,默认1h<br> keepalive_timeout timeout [header_timeout]; #设置保持空闲的连接超时时长，0表示禁止长连接，默认为75s，通常配置在http字段作为站点全局配置<br> keepalive_requests number; #在一次长连接上所允许请求的资源的最大数量，默认为1000次</p> 
</blockquote> 
<h4 id="%E4%BD%9C%E4%B8%BA%E4%B8%8B%E8%BD%BD%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE">作为下载服务器配置</h4> 
<ul><li>[root@ubuntu2004 ~]#mkdir /data/nginx/html/mirrors/rockylinux/8 -p   创建相关目录下的链接</li><li>[root@ubuntu2004 conf.d]# vim mirrors.wang.org.conf</li><li> 
  <blockquote> 
   <p>server {<!-- --></p> 
   <p>    listen 80;</p> 
   <p>    server_name mirrors.wang.org;</p> 
   <p>     autoindex on;      默认不支持下载网站的功能  加上他才能把文件列出来，用户才能访问到</p> 
   <p>    root /data/nginx/html/mirrrors/;</p> 
   <p>}</p> 
  </blockquote> </li><li> [root@ubuntu2004 ~]#mount /dev/sr0 /data/nginx/html/m^Crors/rockylinux/8</li></ul> 
<p><img alt="" height="266" src="https://images2.imgbox.com/f5/c7/2KoROIrX_o.png" width="974"></p> 
<p></p> 
<p><strong>相关指令: </strong></p> 
<blockquote> 
 <p>utoindex on | off;#自动文件索引功能，默为off<br> autoindex_exact_size on | off; #计算文件确切大小（单位bytes），off 显示大概大小（单位<br> K、M)，默认on<br> autoindex_localtime on | off ; #显示本机时间而非GMT(格林威治)时间，默认off<br> charset charset | off; #指定字符编码,默认为off,中文会乱码,指定为utf8<br> autoindex_format html | xml | json | jsonp; #显示索引的页面文件风格，默认html<br> limit_rate rate; #限制响应客户端传输速率(除GET和HEAD以外的所有方法)，单位B/s,即<br> bytes/second，默认值0,表示无限制,此指令由ngx_http_core_module提供<br> set $limit_rate 4k; #也可以通变量限速,单位B/s,同时设置,此项优级高.Rate limit can also<br> be set in the $limit_rate variable, however, since version 1.17.0, this method is<br> not recommended:</p> 
</blockquote> 
<h4 id="%E8%8C%83%E4%BE%8B%3A%20%E5%AE%9E%E7%8E%B0%E4%B8%8B%E8%BD%BD%E7%AB%99%E7%82%B9%C2%A0"><strong>范例: 实现下载站点 </strong></h4> 
<blockquote> 
 <p>#注意:download不需要index.html文件<br> [root@centos8 ~]# mkdir -p /data/nginx/html/pc/download<br> [root@centos8 ~]# vim /apps/nginx/conf/conf.d/pc.conf<br> location /download {<!-- --><br> autoindex on;         #自动索引功能<br> autoindex_exact_size on;         #计算文件确切大小（单位bytes），此为默认值,off只显示大概大<br> 小（单位kb、mb、gb）<br> autoindex_localtime on;         #on表示显示本机时间而非GMT(格林威治)时间,默为为off显示GMT<br> 时间<br> charset utf8;         #支持中文<br> limit_rate 1024k;         #限速,默认不限速<br> root /data/nginx/html/pc;<br> }<br> [root@centos8 ~] # cp /root/anaconda-ks.cfg /data/nginx/html/pc/download/<br> #重启Nginx并访问测试下载页面<br> #可以从清华大学镜像源同步下载实现仓库功能<br> [root@centos8 ~]#rsync -avz rsync://mirrors.tuna.tsinghua.edu.cn/ubuntu<br> /download/ubuntu</p> 
</blockquote> 
<h3 id="%E9%99%90%E6%B5%81%E9%99%90%E9%80%9F%C2%A0%20%C2%A0%E8%A7%84%E5%88%99%E5%BF%85%E9%A1%BB%E5%86%99%E5%85%A5http%E8%AF%AD%E5%8F%A5%E5%9D%97%E9%87%8C">限流限速   规则必须写入http语句块里</h3> 
<p>限制下载速度</p> 
<blockquote> 
 <p># cat /etc/nginx/conf.d/mirrors.wang.conf<br> server {<!-- --><br> listen 80;<br> server_name mirrors.wang.org;<br> root /data/mirrors/;<br> charset utf8;<br> autoindex on;<br> autoindex_exact_size off;<br> autoindex_localtime on;<br> limit_rate_after 100m;         #下载达到100MB数据后开始限速<br> limit_rate 100k;                   #限速100k<br> location / {<!-- --><br> index index.html;<br> }</p> 
</blockquote> 
<p> <strong>#示例:</strong></p> 
<blockquote> 
 <p>http {<!-- --><br> limit_req_zone $binary_remote_addr zone=one:10m rate=10r/s;<br> ...<br> server {<!-- --><br> ...<br> location /search/ {<!-- --><br> limit_req zone=one burst=5;<br> limit_req_status 500; #默认503,可以指定其它状态码<br> }</p> 
 <p></p> 
 <p>limit_req是一个Nginx配置指令，用于限制客户端请求的速率。在这个例子中，limit_req指令的参数为zone=one burst=5，表示：<br><br> 1. zone=one：使用名为“one”的限制请求区域，该区域定义了请求速率限制的参数；<br> 2. burst=5：允许在限制时间内（由limit_req_zone指令定义）最多出现5个请求超过限制速率。<br><br> 此外，还有一个limit_req_status指令，用于指定当请求超过速率限制时返回的HTTP状态码。在这个例子中，limit_req_status指令的参数为500，表示当请求超过速率限制时返回HTTP状态码500。<br><br> 这个指令通常用于防止恶意攻击或过度使用资源，可以根据实际情况进行调整。</p> 
</blockquote> 
<blockquote> 
 <p>#参数说明<br> limit_req_zone定义在http块中，$binary_remote_addr表示以客户端IP地址的二进制形式为限流依据的key<br> Zone定义IP状态及URL访问频率的共享内存区域。zone=keyword标识区域的名字，以及冒号后面跟区域大小。8000个IP地址的状态信息约1MB，例子区域可以存储80000个IP地址。<br> Rate定义最大请求速率。示例中速率不能超过每秒10个请求。超过此速率的请求放入burst队列做延迟处理<br> burst表示队列大小,当此队列满后,会中断请求报错<br> nodelay表示超过请求速率并且缓存区满后不延迟处理,立即返回503错误 </p> 
</blockquote> 
<blockquote> 
 <p>#可以有几个limit_req指令。例如，以下配置将限制来自单个 IP 地址的请求的处理速率，同时限制虚拟服务器的请求处理速率<br> #示例:<br> limit_req_zone $binary_remote_addr zone=perip:10m rate=1r/s;<br> limit_req_zone $server_name zone=perserver:10m rate=10r/s;<br> server {<!-- --><br> ...<br> limit_req zone=perip burst=5 nodelay;<br> limit_req zone=perserver burst=10;<br> } </p> 
</blockquote> 
<p><strong>范例: 基于来源IP对下载速率限制，限制每秒处理1次请求，缓存区请求突发队列为10个</strong></p> 
<blockquote> 
 <p> # http标签段定义请求限制, rate限制速率，限制一秒钟最多一个IP请求<br> #注意:$remote_addr和$binary_remote_addr的不同<br> http {<!-- --><br>         limit_req_zone $binary_remote_addr zone=req_one:10m rate=1r/s;<br>     }<br>         server {<!-- --><br>         listen 80;<br>         server_name mirrors.wang.org;<br> #请求超过1r/s,剩下的将被延迟处理,请求数超过burst定义的数量，则返回503<br>         limit_req zone=req_one burst=10 nodelay;<br>         location / {<!-- --><br>         root /data/mirrors/;<br>         index index.html;<br>         }<br> }<br> limit_req_zone $binary_remote_addr zone=req_one:10m rate=1r/s;<br> #第一个参数：$binary_remote_addr表示通过这个标识来做限制，限制同一客户端ip地址。<br> #第二个参数：zone=req_one:10m表示生成一个大小为10M，名为req_one的内存区域用来存储访问频次信息<br> #第三个参数：rate=1r/s表示允许相同标识的客户端的访问频次，此处限制的是每秒1次。<br> limit_req zone=req_one burst=10 nodelay;<br> #第一个参数：zone=req_one 设置使用哪个配置区域来做限制，与上面limit_req_zone的name对应。<br> #第二个参数：burst=10，设置一个大小为10的缓冲区，当有大量请求过来时，超过了访问频次限制的请求可以先放到这个缓冲区内。<br> #第三个参数：nodelay，超过访问频次并且缓冲区也满了的时候，则会返回503，如果没有设置，则所有请求会等待排队。</p> 
</blockquote> 
<h3 id="%E9%99%90%E5%88%B6%E5%B9%B6%E5%8F%91%E8%BF%9E%E6%8E%A5%E6%95%B0%C2%A0%20%C2%A0%20%C2%A0%E8%A7%84%E5%88%99%E5%BF%85%E9%A1%BB%E5%86%99%E5%85%A5http%E8%AF%AD%E5%8F%A5%E5%9D%97%E9%87%8C">限制并发连接数     规则必须写入http语句块里</h3> 
<p>范例: 设置共享内存区域和给定键值的最大允许个连接数。超过此限制时服务器将返回503错误</p> 
<blockquote> 
 <p># cat /etc/nginx/conf.d/mirrors.wang.org.conf <br> limit_conn_zone $binary_remote_addr zone=conn_zone:10m;    同一个ip做依据，刚在10M的缓冲区<br> server {<!-- --><br>     listen 80 ;<br>     server_name www.wang.org;<br>     root /data/nginx/html/pc/;<br>     limit_conn conn_zone 2;        #限制并发2个连接<br> }</p> 
</blockquote> 
<h4 id="%E5%AE%9E%E7%8E%B0%E7%99%BE%E5%BA%A6%E4%BA%91%E7%9B%98%E9%9D%9E%E4%BC%9A%E5%91%98%E9%99%90%E5%BA%A6%E9%99%90%E6%B5%81%E5%8A%9F%E8%83%BD%3A%C2%A0">实现百度云盘非会员限度限流功能: </h4> 
<ul><li>当下载超过100M则限制下载速度为500k</li><li>限制web服务器请求数处理为1秒一个，触发值为5、限制用户仅可同时下载一个文件。</li><li>如果同时下载超过2个资源，则返回提示 "请联系管理员进行会员充值" 并跳转到其他页面</li></ul> 
<blockquote> 
 <p>#cat /etc/nginx/conf.d/mirrors.wang.conf<br> limit_req_zone $binary_remote_addr zone=req_zone:10m rate=1r/s;<br> limit_conn_zone $binary_remote_addr zone=conn_zone:10m;<br> server {<!-- --><br> listen 80;<br> server_name mirrors.wang.org;<br> root /data/mirrors/;<br> charset utf8;<br> autoindex on;<br> autoindex_exact_size off;<br> autoindex_localtime on;<br> limit_req zone=req_zone burst=5 nodelay;<br> limit_conn conn_zone 2;<br> limit_rate_after 100m;<br> limit_rate 500k;<br> error_page 503 @error_page;<br> location @error_page {<!-- --><br> default_type text/html;<br> return 200 '温馨提示:请联系管理员进行会员充值!';<br> #return https://pan.baidu.com/buy/center?tag=8&amp;from=loginpage#/svip ;<br> }<br> } </p> 
</blockquote> 
<h4 id="Nginx%20%E7%8A%B6%E6%80%81%E9%A1%B5%C2%A0">Nginx 状态页 </h4> 
<blockquote> 
 <p>server {<!-- --><br>     listen 80 ;<br>     server_name www.wang.org;<br>     root /data/nginx/html/pc/;<br>     location /status {           访问它就返回状态页<br>     stub_status;                        ~~~~<br>     }<br> }</p> 
 <p>#状态页用于输出nginx的基本状态信息：<br> #输出信息示例：<br> Active connections: 291<br> server accepts handled requests<br> 16630948 16630948 31070465<br> 上面三个数字分别对应accepts,handled,requests三个值<br> Reading: 6 Writing: 179 Waiting: 106<br> Active connections： #当前处于活动状态的客户端连接数，包括连接等待空闲连接数<br> =reading+writing+waiting<br> accepts：#统计总值，Nginx自启动后已经接受的客户端请求连接的总数。<br> handled：#统计总值，Nginx自启动后已经处理完成的客户端请求连接总数，通常等于accepts，除非有因<br> worker_connections限制等被拒绝的失败连接,即失败连接数=accepts-handled<br> requests：#统计总值，Nginx自启动后客户端发来的总的请求数。因为长连接的原因此值大于上面的<br> accept数<br> Reading：#当前状态，正在读取客户端请求报文首部的连接的连接数,数值越大,说明排队现象严重,性能不足<br> Writing：#当前状态，正在向客户端发送响应报文过程中的连接数,数值越大,说明访问量很大<br> Waiting：#当前状态，正在等待客户端发出请求的空闲连接数，开启keep-alive<br> 时,Waiting+reading+writing=active connections</p> 
 <p></p> 
 <p>curl -s http://www.wang.org/nginx_status | awk '/Active connections/{print $3}'   提去当前链接量</p> 
</blockquote> 
<p>nginx-module-vts 模块实现流量监控     </p> 
<p><a href="https://github.com/vozlt/nginx-module-vts" title="GitHub - vozlt/nginx-module-vts: Nginx virtual host traffic status module">GitHub - vozlt/nginx-module-vts: Nginx virtual host traffic status module</a>   官网下载</p> 
<blockquote> 
 <p>[root@centos8 ~]#cd /usr/local/src<br> [root@centos8 src]#git clone git://github.com/vozlt/nginx-module-vts.git<br> [root@centos8 src]#cd nginx-1.18.0/<br> [root@centos8 nginx-1.18.0]#./configure --prefix=/apps/nginx --add-<br> module=/usr/local/src/nginx-module-vts<br> [root@centos8 nginx-1.18.0]#make &amp;&amp; make install<br> [root@centos8 ~]#vim /apps/nginx/conf/nginx.conf<br> http {<!-- --><br> ......<br> vhost_traffic_status_zone;<br> ......<br> server {<!-- --><br> ......<br> location /status {<!-- --><br> vhost_traffic_status_display;<br> vhost_traffic_status_display_format html;<br> }<br> ......<br> }<br> }<br> [root@centos8 ~]#systemctl restart nginx<br> #浏览器访问:http://&lt;nginx_ip&gt;/status 可以看到下面显示 </p> 
</blockquote> 
<p><img alt="" height="306" src="https://images2.imgbox.com/d9/e0/kSaaG6IT_o.png" width="872"></p> 
<h4 id="echo%20%E6%A8%A1%E5%9D%97%E5%AE%9E%E7%8E%B0%E4%BF%A1%E6%81%AF%E6%98%BE%E7%A4%BA%C2%A0">echo 模块实现信息显示 </h4> 
<blockquote> 
 <p>[root@ubuntu2004 src]#unzip echo-nginx-module-master.zip         解压</p> 
 <p>[root@ubuntu2004 src]# cd nginx-1.22.0/</p> 
 <p>[root@ubuntu2004 conf.d]#vim www.wang.org.conf <br><strong>server {<!-- --><br>     listen 80 ;<br>     server_name www.wang.org;<br>     root /data/nginx/html/pc/;<br>     location /echo {<!-- --><br>      echo $request;            不会啥打印啥<br>     }<br> }</strong></p> 
 <p>systemctl restart nginx</p> 
 <p><strong>[root@centos8 ~]#nginx -V   出来变量</strong><br> nginx version: wanginx/1.68.9<br> built by gcc 8.3.1 20191121 (Red Hat 8.3.1-5) (GCC)<br> built with OpenSSL 1.1.1c FIPS 28 May 2019<br> TLS SNI support enabled<br> configure arguments: --prefix=/apps/nginx --user=nginx --group=nginx --with-<br> http_ssl_module --with-http_v2_module --with-http_realip_module --with-<br> http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream<br> --with-stream_ssl_module --with-stream_realip_module</p> 
 <p><strong>--add-module=/usr/local/src/echo-nginx-module-master</strong> 写入要增加的变量（路径加文件）<br> #测试查看结果<br><strong>[root@centos7 ~]#curl http://www.wang.org/echo</strong><br><img alt="" height="107" src="https://images2.imgbox.com/cc/c6/JU2keXFV_o.png" width="668"></p> 
</blockquote> 
<h4 id="%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8F%98%E9%87%8F">自定义变量</h4> 
<p>假如需要自定义变量名称和值，使用指令 set $variable value;<br> 语法格式：</p> 
<blockquote> 
 <p>Syntax: set $variable value;<br> Default: —<br> Context: server, location, if</p> 
</blockquote> 
<p>范例 </p> 
<blockquote> 
 <p>set $name magedu;<br> echo $name;<br> set $my_port $server_port;<br> echo $my_port;<br> echo "$server_name:$server_port";<br> #输出信息如下<br> [root@centos6 ~]#curl www.wang.org/main<br> magedu<br> 80<br> www.wang.org:80</p> 
</blockquote> 
<h3 id="%E5%B8%B8%E7%94%A8%E5%86%85%E7%BD%AE%E5%8F%98%E9%87%8F%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0server%20%7B%C2%A0%20%C2%A0%20%E9%83%BD%E5%9C%A8%E9%87%8C%E9%9D%A2">常用内置变量       server {    都在里面</h3> 
<blockquote> 
 <p>$remote_addr;<br> #存放了客户端的地址，注意是客户端的公网IP</p> 
 <p><br> $proxy_add_x_forwarded_for<br> #此变量表示将客户端IP追加请求报文中X-Forwarded-For首部字段,多个IP之间用逗号分隔,如果请求中没有X-Forwarded-For,就使用$remote_addr<br> the “X-Forwarded-For” client request header field with the $remote_addr variable<br> appended to it, separated by a comma. If the “X-Forwarded-For” field is not<br> present in the client request header, the $proxy_add_x_forwarded_for variable is<br> equal to the $remote_addr variable.</p> 
 <p><br> $args;<br> #变量中存放了URL中的所有参数，例如:http://www.wang.org/main/index.do?<br> id=20190221&amp;partner=search<br> #返回结果为: id=20190221&amp;partner=search</p> 
 <p><br> $is_args<br> #如果有参数为? 否则为空<br> “?” if a request line has arguments, or an empty string otherwise</p> 
 <p><br> $document_root;<br> #保存了针对当前资源的请求的系统根目录,例如:/apps/nginx/html。</p> 
 <p><br> $document_uri;<br> #保存了当前请求中不包含参数的URI，注意是不包含请求的指令，比<br> 如:http://www.wang.org/main/index.do?id=20190221&amp;partner=search会被定义<br> 为/main/index.do<br> #返回结果为:/main/index.do</p> 
 <p><br> $host;<br> #存放了请求的host名称</p> 
 <p><br> limit_rate 10240;</p> 
 <p></p> 
 <p>echo $limit_rate;<br> #如果nginx服务器使用limit_rate配置了显示网络速率，则会显示，如果没有设置， 则显示0</p> 
 <p></p> 
 <p>$remote_port;<br> #客户端请求Nginx服务器时随机打开的端口，这是每个客户端自己的端口</p> 
 <p></p> 
 <p>$remote_user;<br> #已经经过Auth Basic Module验证的用户名</p> 
 <p></p> 
 <p>$request_body_file;<br> #做反向代理时发给后端服务器的本地资源的名称</p> 
 <p><br> $request_method;<br> #请求资源的方式，GET/PUT/DELETE等</p> 
 <p><br> $request_filename;<br> #当前请求的资源文件的磁盘路径，由root或alias指令与URI请求生成的文件绝对路径，<br> 如:/apps/nginx/html/main/index.html</p> 
 <p><br> $request_uri;<br> #包含请求参数的原始URI，不包含主机名，相当于:$document_uri?$args,例如：/main/index.do?<br> id=20190221&amp;partner=search</p> 
 <p></p> 
 <p>$scheme;<br> #请求的协议，例如:http，https,ftp等</p> 
 <p></p> 
 <p>$server_protocol;<br> #保存了客户端请求资源使用的协议的版本，例如:HTTP/1.0，HTTP/1.1，HTTP/2.0等</p> 
 <p><br> $server_addr;<br> #保存了服务器的IP地址</p> 
 <p><br> $server_name;<br> #请求的服务器的主机名</p> 
 <p><br> $server_port;<br> #请求的服务器的端口号</p> 
 <p><br> $http_user_agent;<br> #客户端浏览器的详细信息</p> 
 <p><br> $http_cookie;<br> #客户端的所有cookie信息</p> 
 <p><br> $cookie_&lt;name&gt;<br> #name为任意请求报文首部字部cookie的key名</p> 
 <p><br> $http_&lt;name&gt;<br> #name为任意请求报文首部字段,表示记录请求报文的首部字段，ame的对应的首部字段名需要为小写，如果有横线需要替换为下划线<br> arbitrary request header field; the last part of a variable name is the field<br> name converted to lower case with dashes replaced by underscores #用下划线代替横线</p> 
 <p>#示例:<br> echo $http_user_agent;<br> echo $http_host;<br> $sent_http_&lt;name&gt;</p> 
 <p></p> 
 <p>#name为响应报文的首部字段，name的对应的首部字段名需要为小写，如果有横线需要替换为下划线,此变量有问题<br> echo $sent_http_server;</p> 
 <p></p> 
 <p>$arg_&lt;name&gt;<br> #此变量存放了URL中的指定参数，name为请求url中指定的参数<br> echo $arg_id;</p> 
</blockquote> 
<h4 id="%E8%87%AA%E5%AE%9A%E4%B9%89%E9%BB%98%E8%AE%A4%E6%A0%BC%E5%BC%8F%E6%97%A5%E5%BF%97%C2%A0">自定义默认格式日志 </h4> 
<blockquote> 
 <p>#注意:此指令只支持http块,不支持server块</p> 
 <p><strong>[root@ubuntu2004 conf.d]#vim www.wang.org.conf </strong></p> 
 <p><strong>log_format access_log_format '$remote_addr - $remote_user [$time_local] "$request" '<br> '$status $body_bytes_sent "$http_referer" '<br> '"$http_user_agent" "$http_x_forwarded_for"'<br> '$server_name:$server_port';</strong></p> 
 <p>server {<!-- --><br>     listen 80 ;<br>     server_name www.wang.org;<br>     root /data/nginx/html/pc/;<br><strong>    access_log /apps/nginx/logs/www.wang.org-access.log access_log_format;</strong><br> }</p> 
 <p>#注意:此指令一定要在放在log_format命令后<br> access_log logs/access.log access_log_format;</p> 
 <p>[root@ubuntu2004 logs]#tail -f www.wang.org-access.log    访问查看</p> 
</blockquote> 
<h4 id="%E8%87%AA%E5%AE%9A%E4%B9%89json%E6%A0%BC%E5%BC%8F%E6%97%A5%E5%BF%97%C2%A0%20%C2%A0%E6%94%AF%E6%8C%81%E5%A4%9A%E4%B8%AA">自定义json格式日志   支持多个</h4> 
<blockquote> 
 <p> log_format access_json '{"@timestamp":"$time_iso8601",'<br>         '"host":"$server_addr",'<br>         '"clientip":"$remote_addr",'<br>         '"size":$body_bytes_sent,'<br>         '"responsetime":$request_time,'        #总的处理时间<br>         '"upstreamtime":"$upstream_response_time",' #后端应用服务器处理时间<br>         '"upstreamhost":"$upstream_addr",'   <br>         '"http_host":"$host",'<br>         '"uri":"$uri",'<br>         '"xff":"$http_x_forwarded_for",'<br>         '"referer":"$http_referer",'<br>         '"tcp_xff":"$proxy_protocol_addr",'<br>         '"http_user_agent":"$http_user_agent",'<br>         '"status":"$status"}';<br>      access_log  /apps/nginx/logs/access_json.log  access_json;</p> 
</blockquote> 
<p> 和上面一样，看不懂可以去网上找一下JSON格式转换一堆呢   </p> 
<p>[root@ubuntu2004 logs]#apt install jq      格式装换<br> [root@ubuntu2004 logs]#cat www.wang.org-access-json.log |jq</p> 
<p><img alt="" height="290" src="https://images2.imgbox.com/43/a6/U3icXgRY_o.png" width="624"></p> 
<h4 id="json%20%E6%A0%BC%E5%BC%8F%E7%9A%84%E6%97%A5%E5%BF%97%E8%AE%BF%E9%97%AE%E7%BB%9F%E8%AE%A1%C2%A0">json 格式的日志访问统计 </h4> 
<p> #python3<br> [root@centos8 ~]#dnf -y install python3</p> 
<p>vim json_access.py </p> 
<pre><code>#!/usr/bin/env python3
#coding:utf-8

status_200= []
status_404= []
with open("/apps/nginx/logs/www.wang.org-access-json.log") as f:
    for line in f.readlines():
        line = eval(line)
        if line.get("status") == "200":
            status_200.append(line.get)
        elif line.get("status") == "404":
            status_404.append(line.get)
        else:
            print("状态码 ERROR")
        print((line.get("clientip")))
f.close()

print("状态码200的有--:",len(status_200))
print("状态码404的有--:",len(status_404))</code></pre> 
<p>python3  json_access.py  </p> 
<p><img alt="" height="199" src="https://images2.imgbox.com/7a/da/ma5CD5Xa_o.png" width="882"></p> 
<h4 id="%C2%A0%E5%85%B3%E4%BA%8E%20favicon.ico"> 关于 favicon.ico</h4> 
<p>favicon.ico 文件是浏览器收藏网址时显示的<strong>图标</strong>，当客户端使用浏览器问页面时，浏览器会自己主动发起请求获取页面的favicon.ico文件，但是当浏览器请求的favicon.ico文件不存在时，服务器会记录404日志，而且浏览器也会显示404报错</p> 
<blockquote> 
 <p>方法一：服务器不记录访问日志：<br> location = /favicon.ico {<!-- --><br> log_not_found off;<br> access_log off;<br> }<br> #方法二：将图标保存到指定目录访问：<br> #location ~ ^/favicon\.ico$ {<!-- --><br> location = /favicon.ico {<!-- --><br> root /data/nginx/html/pc/images;<br> expires 365d; #设置文件过期时间<br> access_log off;<br> }</p> 
 <p>#方法三：直接放在网页文件哪里</p> 
</blockquote> 
<h2 id="Nginx%20%E5%8E%8B%E7%BC%A9%E5%8A%9F%E8%83%BD">Nginx 压缩功能</h2> 
<p> Nginx对文件的压缩功能是依赖于模块 ngx_http_gzip_module,默认是内置模块<br> 官方文档： https://nginx.org/en/docs/http/ngx_http_gzip_module.html </p> 
<p>配置指令如下：</p> 
<blockquote> 
 <p>启用或禁用gzip压缩，默认关闭<br> gzip on | off;</p> 
 <p><br> #压缩比由低到高从1到9，默认为1<br> gzip_comp_level level;</p> 
 <p><br> #禁用IE6 gzip功能                        有的没有<br> gzip_disable "MSIE [1-6]\.";</p> 
 <p></p> 
 <p>#gzip压缩的最小文件，小于设置值的文件将不会压缩<br> gzip_min_length 1k;</p> 
 <p><br> #启用压缩功能时，协议的最小版本，默认HTTP/1.1<br> gzip_http_version 1.0 | 1.1;</p> 
 <p><br> #指定Nginx服务需要向服务器申请的缓存空间的个数和大小,平台不同,默认:32 4k或者16 8k;<br> gzip_buffers number size;</p> 
 <p><br> #指明仅对哪些类型的资源执行压缩操作;默认为gzip_types text/html，不用显示指定，否则出错<br> gzip_types mime-type ...;</p> 
 <p><br> #如果启用压缩，是否在响应报文首部插入“Vary: Accept-Encoding”,一般建议打开<br> gzip_vary on | off;</p> 
 <p><br> #预压缩，即直接从磁盘找到对应文件的gz后缀的式的压缩文件返回给用户，无需消耗服务器CPU<br> #注意: 来自于ngx_http_gzip_static_module模块<br> gzip_static on | off;</p> 
</blockquote> 
<p><strong> 配置指令如下：</strong></p> 
<blockquote> 
 <p>#启用或禁用gzip压缩，默认关闭<br> gzip on | off;<br> #压缩比由低到高从1到9，默认为1<br> gzip_comp_level level;<br> #禁用IE6 gzip功能<br> gzip_disable "MSIE [1-6]\.";<br> #gzip压缩的最小文件，小于设置值的文件将不会压缩<br> gzip_min_length 1k;<br> #启用压缩功能时，协议的最小版本，默认HTTP/1.1<br> gzip_http_version 1.0 | 1.1;<br> #指定Nginx服务需要向服务器申请的缓存空间的个数和大小,平台不同,默认:32 4k或者16 8k;<br> gzip_buffers number size;<br> #指明仅对哪些类型的资源执行压缩操作;默认为gzip_types text/html，不用显示指定，否则出错<br> gzip_types mime-type ...;<br> #如果启用压缩，是否在响应报文首部插入“Vary: Accept-Encoding”,一般建议打开<br> gzip_vary on | off;<br> #预压缩，即直接从磁盘找到对应文件的gz后缀的式的压缩文件返回给用户，无需消耗服务器CPU<br> #注意: 来自于ngx_http_gzip_static_module模块<br> gzip_static on | off;<br> #重启nginx并进行访问测试压缩功能<br> [root@centos8 ~]# cp /apps/nginx/logs/access.log /data/nginx/html/pc/m.txt<br> [root@centos8 ~]# echo "test" &gt; /data/nginx/html/pc/test.html #小于1k的文件测试是否<br> 会压缩<br><strong>[root@centos8 ~]# vim /apps/nginx/conf/nginx.conf</strong></p> 
 <p>server {<!-- --><br>     listen 80 ;<br>     server_name www.wang.org;<br>     root /data/nginx/html/pc/;</p> 
 <p><strong>gzip on;<br> gzip_comp_level 5;<br> gzip_min_length 1k;<br> gzip_types text/plain application/javascript application/x-javascript text/css<br> application/xml text/javascript application/x-httpd-php image/gif image/png;<br> gzip_vary on;</strong><br> }</p> 
</blockquote> 
<h3 id="https%20%E5%8A%A0%E5%AF%86%C2%A0">https 加密 </h3> 
<blockquote> 
 <p>server {<!-- --><br>     listen 80 ;  <br>     server_name 8467238_m50.wangxiaochun.com.pem;     （名字必须和加密文件一样）<br>     root /data/nginx/html/pc/;<br>     listen 443 ssl http2;<br>     ssl_certificate /apps/nginx/conf/conf.d/8467238_m50.wangxiaochun.com.pem;  <br>     ssl_certificate_key /apps/nginx/conf/conf.d/8467238_m50.wangxiaochun.com.key;<br> }   指定目录文件夹俩钥匙</p> 
 <p>DNS 也要改 域名改了嘛</p> 
 <p>https://8467238_m50.wangxiaochun.com/</p> 
</blockquote> 
<p> <img alt="" height="724" src="https://images2.imgbox.com/0b/a7/JwYOBXkG_o.png" width="1114"></p> 
<p> <img alt="" height="1034" src="https://images2.imgbox.com/7a/55/sDr0eu6f_o.png" width="1200"></p> 
<h3 id="%E5%B9%B3%E6%BB%91%E5%8D%87%E7%BA%A7%E5%92%8C%E5%9B%9E%E6%BB%9A">平滑升级和回滚</h3> 
<p> 有时候需要对Nginx版本进行升级以满足对其功能的需求，例如添加新模块，需要新功能，而此时Nginx又在跑着业务无法停止，这时就可以选择平滑升级</p> 
<p><strong>平滑升级四个阶段</strong></p> 
<ol><li>只有旧版nginx的master和worker进程</li><li>旧版和新版nginx的master和worker进程并存,由旧版nginx接收处理用户的新请求(注意:做快照方便测试回滚)</li><li>旧版和新版nginx的master和worker进程并存,由新版nginx接收处理用户的新请求</li><li>只有新版nginx的master和worker进程</li></ol> 
<p><strong> 下载最新稳定版</strong><br> [root@centos8 ~]#wget http://nginx.org/download/nginx-1.23.1tar.gz (本身22.0只能如此)[root@centos8 ~]#tar xvf nginx-1.23.1.tar.gz<br> [root@centos8 ~]#cd nginx-1.23.1</p> 
<p><strong>#查看当前使用的版本及编译选项。结果如下</strong>：</p> 
<p>[root@centos8 ~]/apps/nginx/sbin/nginx -V<br> nginx version: nginx/1.22.0<br> built by gcc 9.4.0 (Ubuntu 9.4.0-1ubuntu1~20.04.1) <br> built with OpenSSL 1.1.1f  31 Mar 2020<br> TLS SNI support enabled<br> configure arguments: --prefix=/apps/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module</p> 
<p>configure arguments    <strong>#后面是以前编译时的参数。现在编译使用一样的参数</strong><br><strong>#开始编译新版本</strong></p> 
<p>[root@centos8 nginx-1.22.0]#./configure     --prefix=/apps/nginx --user=nginx --<br> group=nginx --with-http_ssl_module --with-http_v2_module --with-<br> http_realip_module --with-http_stub_status_module --with-http_gzip_static_module<br> --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module</p> 
<p><strong>#只要make无需要make install</strong><br> [root@centos8 nginx-1.22.0]#make<br> [root@centos8 nginx-1.22.0]#objs/nginx -v<br> nginx version: nginx/1.22.0</p> 
<p><strong>#查看两个版本</strong><br> [root@centos8 nginx-1.22.0]#ll objs/nginx /apps/nginx/sbin/nginx<br> -rwxr-xr-x 1 nginx nginx 7591096 Jun 7 16:28 /apps/nginx/sbin/nginx<br> -rwxr-xr-x 1 root root 7723272 Jun 7 17:27 objs/nginx</p> 
<p><strong>#把之前的旧版的nginx命令备份     防止不兼容，可用来回滚</strong><br> [root@centos8 nginx-1.22.0]#cp /apps/nginx/sbin/nginx /opt/nginx.old</p> 
<p><strong>#把新版本的nginx命令复制过去覆盖旧版本程序文件,注意:需要加 -f 选项强制覆盖,否则会提示Text<br> file busy</strong><br> [root@centos8 nginx-1.22.0]#cp -f ./objs/nginx /apps/nginx/sbin/</p> 
<p><strong>#如果cp 不加-f 选项，会出现下面提示</strong><br> [root@rocky8 nginx-1.23.1]#cp objs/nginx /apps/nginx/sbin/<br> cp: overwrite '/apps/nginx/sbin/nginx'? y<br> cp: cannot create regular file '/apps/nginx/sbin/nginx': Text file busy</p> 
<p><strong>检测一下有没有问题</strong><br> [root@centos8 nginx-1.23.1]#/apps/nginx/sbin/nginx -t</p> 
<p>#发送信号USR2 平滑升级可执行程序,将存储有旧版本主进程PID的文件重命名为nginx.pid.oldbin，并启动新的nginx</p> 
<ul><li>#此时两个master的进程都在运行,只是旧的master不在监听,由新的master监听80</li><li>此时Nginx开启一个新的master进程，这个master进程会生成新的worker进程，这就是升级后的Nginx进程，此时老的进程不会自动退出，但是当接收到新的请求不作处理而是交给新的进程处理。</li></ul> 
<p>[root@centos8 nginx-1.23.1]#kill -USR2 `cat /apps/nginx/logs/nginx.pid`</p> 
<p><strong>#可以看到两个master,新的master是旧版master的子进程,并生成新版的worker进程</strong></p> 
<p>[root@centos8 nginx-1.23.1]#ps auxf|grep nginx</p> 
<ul><li>root       34825  0.0  0.0   9392   720 pts/1    S+   18:04   0:00          \_ grep --color=auto nginx</li><li>root         751  0.0  0.1   8624  3044 ?        Ss   06:06   0:00 nginx: master process /apps/nginx/sbin/nginx</li><li>nginx      34135  0.0  0.1   9292  3356 ?        S    17:38   0:00  \_ nginx: worker process</li></ul> 
<p></p> 
<p>#先关闭旧nginx的worker进程,而不关闭nginx主进程方便回滚</p> 
<ul><li>#向原Nginx主进程发送WINCH信号，它会逐步关闭旗下的工作进程（主进程不退出），这时所有请求都会由新版Nginx处理</li></ul> 
<p>[root@centos8 nginx-1.23.1]#kill -WINCH `cat /apps/nginx/logs/nginx.pid.oldbin` </p> 
<p>#如果旧版worker进程有用户的请求,会一直等待处理完后才会关闭</p> 
<p>[root@centos8 nginx-1.23.1]#pstree -p|grep nginx<br> |-nginx(8814)---nginx(12014)-+-nginx(12015)<br> | `-nginx(12016)<br><strong>#经过一段时间测试，新版本服务没问题，最后发送QUIT信号,退出老的master</strong></p> 
<p>[root@centos8 nginx-1.23.1]#kill -QUIT `cat /apps/nginx/logs/nginx.pid.oldbin`<br><strong>#查看版本是不是已经是新版了</strong><br> [root@centos8 nginx-1.23.1]#nginx -v</p> 
<p><strong>#回滚<br> #如果升级的版本发现问题需要回滚,可以发送HUP信号,重新拉起旧版本的worker</strong><br> [root@centos8 nginx-1.23.1]#kill -HUP `cat /apps/nginx/logs/nginx.pid.oldbin`<br> [root@centos8 nginx-1.23.1]#pstree -p |grep nginx</p> 
<p><strong>#最后关闭新版的master</strong><br> [root@centos8 nginx-1.23.1]#kill -QUIT `cat /apps/nginx/logs/nginx.pid`<br><strong>#恢复旧版的文件</strong><br> [root@rocky8 ~]#mv /opt/nginx.old /apps/nginx/sbin/</p> 
<p></p> 
<p>[root@ubuntu2004 ~]#rpm -qc nginx     #可以查看读取的配置文件适用于yum安装</p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/67d7c702fdd5a844492d8d40442adada/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">华为交换机镜像端口配置</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/012ae875482b0ecc205c7bf3c47aa201/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">ubuntu连接蓝牙耳机</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>