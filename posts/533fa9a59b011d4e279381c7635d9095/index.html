<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>nginx&#43;keepalived实现七层负载 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="nginx&#43;keepalived实现七层负载" />
<meta property="og:description" content="目录
一、部署nginx01、nginx02
二、keepalived配置（抢占模式、master- backup模式）
三、测试
四、非抢占模式（backup-backup模式）
nginx01 11.0.1.31nginx0211.0.1.32虚拟IP（VIP）11.0.1.30 一、部署nginx01、nginx02 部署nginx：Nginx、keepalived安装详细步骤_keepalive 安装-CSDN博客
先部署一台，另一台直接克隆改ip就可以
二、keepalived配置（抢占模式、master- backup模式） keepalived配置文件路径 /etc/keepalived/keepalived.conf
主机 11.0.1.31 需要更改的参数：router_id、interface ens33、真实IP mcast_src_ip 、虚拟IP11.0.1.30、优先级priority（master需要比backup高）
global_defs { router_id nginx-01 #标识本节点的名称，通常为hostname } ## keepalived会定时执行脚本并对脚本执行的结果进行分析,动态调整vrrp_instance的优先级。 ##如果脚本执行结果为0,并且weight配置的值大于0,则优先级相应的增加。如果脚本执行结果非0, ##并且weight配置的值小于 0,则优先级相应的减少。其他情况,维持原本配置的优先级,即配置文件中priority对应的值。 vrrp_script chk_nginx { script &#34;/etc/keepalived/nginx_check.sh&#34; interval 2 #每2秒检测一次nginx的运行状态 weight -20 #失败一次，将自己的优先级-20 } vrrp_instance VI_1 { state MASTER # 状态，主节点为MASTER，备份节点为BACKUP interface ens33 # 绑定VIP的网络接口，通过ifconfig查看自己的网络接口 virtual_router_id 51 # 虚拟路由的ID号,两个节点设置必须一样,可选IP最后一段使用,相同的VRID为一个组,他将决定多播的MAC地址 mcast_src_ip 11.0.1.31 # 本机IP地址 priority 100 # 节点优先级，值范围0～254，MASTER要比BACKUP高 advert_int 1 # 组播信息发送时间间隔，两个节点必须设置一样，默认为1秒 # 设置验证信息，两个节点必须一致 authentication { auth_type PASS auth_pass 1111 } # 虚拟IP，两个节点设置必须一样。可以设置多个，一行写一个 virtual_ipaddress { 11." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/533fa9a59b011d4e279381c7635d9095/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-30T15:06:39+08:00" />
<meta property="article:modified_time" content="2023-12-30T15:06:39+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">nginx&#43;keepalived实现七层负载</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p></p> 
<p id="%E4%B8%80%E3%80%81%E9%83%A8%E7%BD%B2nginx01%E3%80%81nginx02-toc" style="margin-left:0px;"><a href="#%E4%B8%80%E3%80%81%E9%83%A8%E7%BD%B2nginx01%E3%80%81nginx02" rel="nofollow">一、部署nginx01、nginx02</a></p> 
<p style="margin-left:0px;"></p> 
<p id="%E4%BA%8C%E3%80%81keepalived%E9%85%8D%E7%BD%AE%EF%BC%88%E6%8A%A2%E5%8D%A0%E6%A8%A1%E5%BC%8F%E3%80%81master-%C2%A0backup%E6%A8%A1%E5%BC%8F%EF%BC%89-toc" style="margin-left:0px;"><a href="#%E4%BA%8C%E3%80%81keepalived%E9%85%8D%E7%BD%AE%EF%BC%88%E6%8A%A2%E5%8D%A0%E6%A8%A1%E5%BC%8F%E3%80%81master-%C2%A0backup%E6%A8%A1%E5%BC%8F%EF%BC%89" rel="nofollow">二、keepalived配置（抢占模式、master- backup模式）</a></p> 
<p style="margin-left:0px;"></p> 
<p id="%E4%B8%89%E3%80%81%E6%B5%8B%E8%AF%95-toc" style="margin-left:0px;"><a href="#%E4%B8%89%E3%80%81%E6%B5%8B%E8%AF%95" rel="nofollow">三、测试</a></p> 
<p style="margin-left:0px;"></p> 
<p id="%E5%9B%9B%E3%80%81%E9%9D%9E%E6%8A%A2%E5%8D%A0%E6%A8%A1%E5%BC%8F%EF%BC%88backup-backup%E6%A8%A1%E5%BC%8F%EF%BC%89-toc" style="margin-left:0px;"><a href="#%E5%9B%9B%E3%80%81%E9%9D%9E%E6%8A%A2%E5%8D%A0%E6%A8%A1%E5%BC%8F%EF%BC%88backup-backup%E6%A8%A1%E5%BC%8F%EF%BC%89" rel="nofollow">四、非抢占模式（backup-backup模式）</a></p> 
<p style="margin-left:0px;"></p> 
<hr id="hr-toc"> 
<table border="1" cellpadding="1" cellspacing="1" style="width:400px;"><tbody><tr><td style="width:195px;"> <p>nginx01 </p> </td><td style="width:203px;">11.0.1.31</td></tr><tr><td style="width:195px;">nginx02</td><td style="width:203px;">11.0.1.32</td></tr><tr><td style="width:195px;">虚拟IP（VIP）</td><td style="width:203px;"><strong><span style="color:#fe2c24;">11.0.1.30</span></strong></td></tr></tbody></table> 
<h2 id="%E4%B8%80%E3%80%81%E9%83%A8%E7%BD%B2nginx01%E3%80%81nginx02">一、部署nginx01、nginx02</h2> 
<p>部署nginx：<a href="https://blog.csdn.net/weixin_48878440/article/details/122422845" title="Nginx、keepalived安装详细步骤_keepalive 安装-CSDN博客">Nginx、keepalived安装详细步骤_keepalive 安装-CSDN博客</a></p> 
<p>先部署一台，另一台直接克隆改ip就可以</p> 
<p><img alt="" height="419" src="https://images2.imgbox.com/c7/41/a0evjbNh_o.png" width="937"></p> 
<p></p> 
<h2 id="%E4%BA%8C%E3%80%81keepalived%E9%85%8D%E7%BD%AE%EF%BC%88%E6%8A%A2%E5%8D%A0%E6%A8%A1%E5%BC%8F%E3%80%81master-%C2%A0backup%E6%A8%A1%E5%BC%8F%EF%BC%89">二、keepalived配置（抢占模式、master- backup模式）</h2> 
<p>keepalived配置文件路径 /etc/keepalived/keepalived.conf</p> 
<p>主机 11.0.1.31 </p> 
<p>需要<strong><span style="color:#fe2c24;">更改</span></strong>的参数：router_id、interface ens33、真实IP mcast_src_ip 、虚拟IP11.0.1.30、优先级priority（master需要比backup高）</p> 
<pre><code>global_defs {
   router_id nginx-01  #标识本节点的名称，通常为hostname
}

## keepalived会定时执行脚本并对脚本执行的结果进行分析,动态调整vrrp_instance的优先级。
##如果脚本执行结果为0,并且weight配置的值大于0,则优先级相应的增加。如果脚本执行结果非0,
##并且weight配置的值小于 0,则优先级相应的减少。其他情况,维持原本配置的优先级,即配置文件中priority对应的值。
vrrp_script chk_nginx {
       script "/etc/keepalived/nginx_check.sh"
       interval 2  #每2秒检测一次nginx的运行状态
       weight -20  #失败一次，将自己的优先级-20
}

vrrp_instance VI_1 {
    state MASTER                  # 状态，主节点为MASTER，备份节点为BACKUP
    interface ens33              # 绑定VIP的网络接口，通过ifconfig查看自己的网络接口
    virtual_router_id 51          # 虚拟路由的ID号,两个节点设置必须一样,可选IP最后一段使用,相同的VRID为一个组,他将决定多播的MAC地址
    mcast_src_ip 11.0.1.31    # 本机IP地址    
    priority 100                  # 节点优先级，值范围0～254，MASTER要比BACKUP高
    advert_int 1                  # 组播信息发送时间间隔，两个节点必须设置一样，默认为1秒
    # 设置验证信息，两个节点必须一致
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    # 虚拟IP，两个节点设置必须一样。可以设置多个，一行写一个
    virtual_ipaddress {
        11.0.1.30
    }

    track_script {
       chk_nginx  # nginx存活状态检测脚本
    }
}
</code></pre> 
<p>备机 11.0.1.32</p> 
<pre><code>global_defs {
   router_id nginx-02
}

vrrp_script chk_nginx {
    script "/etc/keepalived/nginx_check.sh"
    interval 2
    weight -20
}

vrrp_instance VI_1 {
    state BACKUP
    interface ens33
    virtual_router_id 51
    mcast_src_ip 11.0.1.32
    priority 90
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
        11.0.1.30
    }

    track_script {
       chk_nginx
    }
}</code></pre> 
<p>检测nginx存活脚本，如果nginx进程不存在，尝试启动，如果nginx启动失败（服务器宕机），杀死主机的keepalived程序。主机的keepalived被杀死后VIP将转移到备机11.0.1.32。</p> 
<p>主备机都要有检测脚本</p> 
<pre><code>vi /etc/keepalived/nginx_check.sh
chmod +x /etc/keepalived/nginx_check.sh</code></pre> 
<p>注意许多教程的脚本是centos6的，需要注意“systemctl stop keepalived” 命令是否可以正常关闭keepalived进程。</p> 
<pre><code>#!/bin/bash
counter=$(ps -C nginx --no-heading|wc -l)
if [ "${counter}" = "0" ]; then
    /usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf
    sleep 2
    counter=$(ps -C nginx --no-heading|wc -l)
    if [ "${counter}" = "0" ]; then
        systemctl stop keepalived
    fi
fi
</code></pre> 
<p> 主机IP，此时VIP在主机上</p> 
<p><img alt="" height="330" src="https://images2.imgbox.com/15/a2/109mUNMO_o.png" width="954"></p> 
<p>备机IP</p> 
<p><img alt="" height="249" src="https://images2.imgbox.com/65/ae/dMWl2Xke_o.png" width="963"></p> 
<h2 id="%E4%B8%89%E3%80%81%E6%B5%8B%E8%AF%95">三、测试</h2> 
<p>VIP可以正常访问，主机正常</p> 
<p> <img alt="" height="256" src="https://images2.imgbox.com/54/1a/HKLyJlUq_o.png" width="515"></p> 
<p><span style="color:#fe2c24;"><strong>关闭</strong></span>主机nginx进程 </p> 
<pre><code>[root@nginx01 sbin]# ./nginx -s stop</code></pre> 
<p>访问正常</p> 
<p><img alt="" height="288" src="https://images2.imgbox.com/97/56/pQCV0egN_o.png" width="541"></p> 
<p>将主机11.0.1.31直接关机，再次测试 </p> 
<p><img alt="" height="93" src="https://images2.imgbox.com/03/ee/3NUc0z9r_o.png" width="221"></p> 
<p>VIP成功漂移到备机11.0.1.32 </p> 
<p><img alt="" height="638" src="https://images2.imgbox.com/fc/16/wOkjUaQ9_o.png" width="654"></p> 
<p>查看备机IP，VIP漂移到备机上</p> 
<p><img alt="" height="289" src="https://images2.imgbox.com/20/aa/mdKLkJpX_o.png" width="953"></p> 
<p>重启主机后VIP重新漂移回到主机11.0.1.31 </p> 
<p><img alt="" height="117" src="https://images2.imgbox.com/c3/42/WZRUrJJQ_o.png" width="232"></p> 
<p><img alt="" height="325" src="https://images2.imgbox.com/77/4e/aamcfguR_o.png" width="1005"></p> 
<p>不需要给nginx设置开机自启动，keepalived开机自启动即可，keepalived发现nginx没启动，会自动执行脚本启动nginx。</p> 
<h2 id="%E5%9B%9B%E3%80%81%E9%9D%9E%E6%8A%A2%E5%8D%A0%E6%A8%A1%E5%BC%8F%EF%BC%88backup-backup%E6%A8%A1%E5%BC%8F%EF%BC%89">四、非抢占模式（backup-backup模式）</h2> 
<p>两台主机均为backup，谁先启动谁就是临时master</p> 
<p>11.0.1.31 backup</p> 
<pre><code>global_defs {
   router_id nginx-01  #标识本节点的名称，通常为hostname
}

## keepalived会定时执行脚本并对脚本执行的结果进行分析,动态调整vrrp_instance的优先级。
##如果脚本执行结果为0,并且weight配置的值大于0,则优先级相应的增加。如果脚本执行结果非0,
##并且weight配置的值小于 0,则优先级相应的减少。其他情况,维持原本配置的优先级,即配置文件中priority对应的值。
vrrp_script chk_nginx {
       script "/etc/keepalived/nginx_check.sh"
       interval 2  #每2秒检测一次nginx的运行状态
       weight -20  #失败一次，将自己的优先级-20
}

vrrp_instance VI_1 {
    state BACKUP                  # 状态，主节点为MASTER，备份节点为BACKUP
    interface ens33              # 绑定VIP的网络接口，通过ifconfig查看自己的网络接口
    virtual_router_id 51          # 虚拟路由的ID号,两个节点设置必须一样,可选IP最后一段使用,相同的VRID为一个组,他将决定多播的MAC地址
    mcast_src_ip 11.0.1.31    # 本机IP地址
    priority 100                  # 节点优先级，值范围0～254，MASTER要比BACKUP高
    advert_int 1                  # 组播信息发送时间间隔，两个节点必须设置一样，默认为1秒
    nopreempt
    # 设置验证信息，两个节点必须一致
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    # 虚拟IP，两个节点设置必须一样。可以设置多个，一行写一个
    virtual_ipaddress {
        11.0.1.30
    }

    track_script {
       chk_nginx  # nginx存活状态检测脚本
    }
}</code></pre> 
<p>11.0.1.32 backup</p> 
<pre><code>global_defs {
   router_id nginx-02
}

vrrp_script chk_nginx {
    script "/etc/keepalived/nginx_check.sh"
    interval 2
    weight -20
}

vrrp_instance VI_1 {
    state BACKUP
    interface ens33
    virtual_router_id 51
    mcast_src_ip 11.0.1.32
    priority 90
    advert_int 1
    nopreempt
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
        11.0.1.30
    }

    track_script {
       chk_nginx
    }
}
</code></pre> 
<p>非抢占模式backup-backup模式，在此模式下，即使重启了主机11.0.1.31，VIP仍然保留在备机11.0.1.32。</p> 
<p>在非抢占模式下，也有优先级的高低，<span style="color:#fe2c24;"><strong>谁先启动谁就被选举为master，不看优先级（两台抖配配置nopreempt情况下</strong></span><span style="color:#fe2c24;"><strong>），并且不会被抢走VIP，除非master宕机，VIP漂移到backup（注意此时backup已经升级为master，而原先的master重启后已经变为backup）。</strong></span></p> 
<p><img alt="" height="320" src="https://images2.imgbox.com/5d/59/ty2Y8y2d_o.png" width="565"></p> 
<p>现在将11.0.1.32关机，VIP回到11.0.1.31</p> 
<p><img alt="" height="302" src="https://images2.imgbox.com/22/12/0sOjfLTz_o.png" width="541"></p> 
<p>重新将11.0.1.32开机，发现VIP不会回到11.0.1.32，<span style="color:#fe2c24;"><strong>因为11.0.1.32配置了nopreempt参数，所以“不会抢11.0.1.31的VIP”</strong></span></p> 
<p><img alt="" height="301" src="https://images2.imgbox.com/2e/ad/XL8PuZhA_o.png" width="492"></p> 
<p>和抢占模式的配置相比，只改了两个地方：</p> 
<p>1&gt; 在vrrp_instance块下<span style="color:#fe2c24;"><strong>两个节点各增加了nopreempt指令，表示不争抢vip</strong></span></p> 
<p>2&gt; <span style="color:#fe2c24;"><strong>节点的state都为BACKUP</strong></span></p> 
<p>两个keepalived节点都启动后，默认都是BACKUP状态，双方在发送组播信息后，keepalived会自动选举一个MASTER出来（不是根据优先级）。由于两者都配置了nopreempt，所以MASTER从故障中恢复后，不会抢占vip。这样会避免VIP切换可能造成的服务延迟。</p> 
<p>两台服务器都启用nopreempt后，必须修改角色状态统一为BACKUP，唯一的区分就是优先级。</p> 
<p>官方对nopreempt参数解释：高优先级VRRP实例通常会抢占低优先级VRRP实例，<br> "nopreempt"参数将停止优先级更高的机器在抢占vip，并允许较低优先级的机器保持为master。<br> 注意:要使nopreempt参数起作用，初始状态不能是MASTER。</p> 
<p><a href="https://www.cnblogs.com/lichunyang321/p/8889326.html" rel="nofollow" title="https://www.cnblogs.com/lichunyang321/p/8889326.html">https://www.cnblogs.com/lichunyang321/p/8889326.html</a></p> 
<p>非抢占模式与优先级关系：</p> 
<p><a href="https://blog.csdn.net/MssGuo/article/details/127336013" title="keepalived配置非抢占模式_keepalived非抢占模式-CSDN博客">keepalived配置非抢占模式_keepalived非抢占模式-CSDN博客</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c98913b7b575152199b45d4fc67facc1/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">C&#43;&#43;提高编程二(STL、Vector容器、string字符串)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ece1dd804928e1812ae2844fae034a15/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">MATLAB聚类及给无标签数据加标签</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>