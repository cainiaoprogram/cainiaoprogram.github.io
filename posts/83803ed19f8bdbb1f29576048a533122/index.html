<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Trino：分区表上的SQL提交 &amp; 查询流程浅析 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Trino：分区表上的SQL提交 &amp; 查询流程浅析" />
<meta property="og:description" content="Trino SQL执行过程的关键特性 Client、Coordinator、Worker之间的通讯，基于HTTP协议。SQL提交、解析、调度、执行等的流程全异步，最大化运行效率。逻辑计划树被在Coordinator侧被拆分成PlanFragment，可以对应于Spark中的Stage概念，会通过StageScheduler被调度。一个PlanFragment对应一个Stage，而一个Stage对应一个或多个Data Partition；一个Data Partition对应一个SqlTask，它是在Worker结点上处理数据的实体（容器）。一个Partition被拆分成一个或多个Split，是任务调度的最小单元，由Coordinator生成且数量确定。一个Split会由Worker负责处理，而一个Split会被分割成一个或多个Page，它是数据处理的最小单元。Worker可以并行处理Split，且按时间片的调度线程处理Split，如果执行线程超过时间片的限额或由于其它原因被阻塞，则线程会主动放弃当前Split的执行。（具体过程会在另外的文章中分析）Block是Trino集群中数据传输的最小单元，以列式的格式存储和压缩。默认情况下，如果资源足够，一个SQL作业的所有Stage会被同时调度和创建，此时作业的处理模型类似Flink，是一个流式的过程，一旦有一个Source Split生成，就可以流经所有的Stage产生最终的输出结果。默认情况下，所有的SQL作业共用一个Resource Group，一旦有一个可用的Worker，就会调度作业执行。SQL执行期间，每一个SqlTask的执行都是全内存的，意味着无法进行故障恢复，因此一旦某个任务失败，则最终整个作业的会失败。 SQL提交&amp;注册 通过/v1/statement/queued API向coordinator提交新的Query，会首先将此query放入QueryManager的缓存池中，然后返回给客户端下一次应该访问的地址。
客户端提交SQL成功后，会立即调用queued/{queryId}/{slug}/{token} REST API，轮询SQL的执行状态。
public class QueuedStatementResource { @ResourceSecurity(AUTHENTICATED_USER) @POST @Produces(APPLICATION_JSON) public Response postStatement( String statement, @Context HttpServletRequest servletRequest, @Context HttpHeaders httpHeaders, @Context UriInfo uriInfo) { if (isNullOrEmpty(statement)) { throw badRequest(BAD_REQUEST, &#34;SQL statement is empty&#34;); } // 注册新的query这里仅仅是创建Query实例，并添加到QueryManager的缓存池中 Query query = registerQuery(statement, servletRequest, httpHeaders); return createQueryResultsResponse(query.getQueryResults(query.getLastToken(), uriInfo)); } private Query registerQuery(String statement, HttpServletRequest servletRequest, HttpHeaders httpHeaders) { Optional&lt;String&gt; remoteAddress = Optional." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/83803ed19f8bdbb1f29576048a533122/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-05T14:38:20+08:00" />
<meta property="article:modified_time" content="2024-01-05T14:38:20+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Trino：分区表上的SQL提交 &amp; 查询流程浅析</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Trino_SQL_0"></a>Trino SQL执行过程的关键特性</h2> 
<ol><li><code>Client</code>、<code>Coordinator</code>、<code>Worker</code>之间的通讯，基于<code>HTTP协议</code>。</li><li>SQL提交、解析、调度、执行等的流程全异步，最大化运行效率。</li><li>逻辑计划树被在Coordinator侧被拆分成<code>PlanFragment</code>，可以对应于Spark中的<code>Stage</code>概念，会通过<code>StageScheduler</code>被调度。</li><li>一个PlanFragment对应一个Stage，而一个Stage对应一个或多个Data Partition；一个Data <code>Partition</code>对应一个<code>SqlTask</code>，它是在Worker结点上处理数据的实体（容器）。</li><li>一个<code>Partition</code>被拆分成一个或多个Split，是任务调度的最小单元，由Coordinator生成且数量确定。</li><li>一个<code>Split</code>会由Worker负责处理，而一个Split会被分割成一个或多个Page，它是数据处理的最小单元。</li><li>Worker可以并行处理<code>Split</code>，且<code>按时间片的调度线程处理Split，如果执行线程超过时间片的限额或由于其它原因被阻塞，则线程会主动放弃当前Split的执行</code>。（<font color="red">具体过程会在另外的文章中分析</font>）</li><li><code>Block</code>是Trino集群中数据传输的最小单元，以列式的格式存储和压缩。</li><li>默认情况下，如果资源足够，一个SQL作业的所有Stage会被同时调度和创建，<code>此时作业的处理模型类似Flink，是一个流式的过程，一旦有一个Source Split生成，就可以流经所有的Stage产生最终的输出结果</code>。</li><li>默认情况下，所有的SQL作业共用一个<code>Resource Group</code>，一旦有一个可用的Worker，就会调度作业执行。</li><li>SQL执行期间，每一个SqlTask的<code>执行都是全内存的</code>，意味着<code>无法进行故障恢复</code>，因此一旦某个任务失败，则最终整个作业的会失败。</li></ol> 
<h2><a id="SQL_12"></a>SQL提交&amp;注册</h2> 
<blockquote> 
 <p>通过<code>/v1/statement/queued</code> API向coordinator提交新的Query，会首先将此query放入QueryManager的缓存池中，然后返回给客户端下一次应该访问的地址。<br> 客户端提交SQL成功后，会立即调用<code>queued/{queryId}/{slug}/{token}</code> REST API，轮询SQL的执行状态。</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QueuedStatementResource</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@ResourceSecurity</span><span class="token punctuation">(</span><span class="token constant">AUTHENTICATED_USER</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@POST</span>
    <span class="token annotation punctuation">@Produces</span><span class="token punctuation">(</span><span class="token constant">APPLICATION_JSON</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Response</span> <span class="token function">postStatement</span><span class="token punctuation">(</span>
            <span class="token class-name">String</span> statement<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Context</span> <span class="token class-name">HttpServletRequest</span> servletRequest<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Context</span> <span class="token class-name">HttpHeaders</span> httpHeaders<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Context</span> <span class="token class-name">UriInfo</span> uriInfo<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isNullOrEmpty</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token function">badRequest</span><span class="token punctuation">(</span><span class="token constant">BAD_REQUEST</span><span class="token punctuation">,</span> <span class="token string">"SQL statement is empty"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 注册新的query这里仅仅是创建Query实例，并添加到QueryManager的缓存池中</span>
        <span class="token class-name">Query</span> query <span class="token operator">=</span> <span class="token function">registerQuery</span><span class="token punctuation">(</span>statement<span class="token punctuation">,</span> servletRequest<span class="token punctuation">,</span> httpHeaders<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token function">createQueryResultsResponse</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span><span class="token function">getQueryResults</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span><span class="token function">getLastToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> uriInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">Query</span> <span class="token function">registerQuery</span><span class="token punctuation">(</span><span class="token class-name">String</span> statement<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> servletRequest<span class="token punctuation">,</span> <span class="token class-name">HttpHeaders</span> httpHeaders<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> remoteAddress <span class="token operator">=</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>servletRequest<span class="token punctuation">.</span><span class="token function">getRemoteAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Identity</span><span class="token punctuation">&gt;</span></span> identity <span class="token operator">=</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Identity</span><span class="token punctuation">)</span> servletRequest<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token constant">AUTHENTICATED_IDENTITY</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MultivaluedMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> headers <span class="token operator">=</span> httpHeaders<span class="token punctuation">.</span><span class="token function">getRequestHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">SessionContext</span> sessionContext <span class="token operator">=</span> sessionContextFactory<span class="token punctuation">.</span><span class="token function">createSessionContext</span><span class="token punctuation">(</span>headers<span class="token punctuation">,</span> alternateHeaderName<span class="token punctuation">,</span> remoteAddress<span class="token punctuation">,</span> identity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建一个SQL实例，维护当前SQL生命周期内的各种信息</span>
        <span class="token class-name">Query</span> query <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Query</span><span class="token punctuation">(</span>statement<span class="token punctuation">,</span> sessionContext<span class="token punctuation">,</span> dispatchManager<span class="token punctuation">,</span> queryInfoUrlFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将Query实例注册到QueryManager</span>
        queryManager<span class="token punctuation">.</span><span class="token function">registerQuery</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// let authentication filter know that identity lifecycle has been handed off</span>
        servletRequest<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token constant">AUTHENTICATED_IDENTITY</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> query<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="Query_56"></a>Query类</h3> 
<blockquote> 
 <p>维护SQL运行时状态，可以通过此类获取SQL运行期间的状态信息；同时也负责与Client交互，提供对SQL任务的管理能力。</p> 
</blockquote> 
<pre><code class="prism language-java">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Query</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> query<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SessionContext</span> sessionContext<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">DispatchManager</span> dispatchManager<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">QueryId</span> queryId<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span>URI<span class="token punctuation">&gt;</span></span> queryInfoUrl<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Slug</span> slug <span class="token operator">=</span> <span class="token class-name">Slug</span><span class="token punctuation">.</span><span class="token function">createNew</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicLong</span> lastToken <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> initTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> submissionGate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SettableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> creationFuture <span class="token operator">=</span> <span class="token class-name">SettableFuture</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">Query</span><span class="token punctuation">(</span><span class="token class-name">String</span> query<span class="token punctuation">,</span> <span class="token class-name">SessionContext</span> sessionContext<span class="token punctuation">,</span> <span class="token class-name">DispatchManager</span> dispatchManager<span class="token punctuation">,</span> <span class="token class-name">QueryInfoUrlFactory</span> queryInfoUrlFactory<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>query <span class="token operator">=</span> <span class="token function">requireNonNull</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> <span class="token string">"query is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>sessionContext <span class="token operator">=</span> <span class="token function">requireNonNull</span><span class="token punctuation">(</span>sessionContext<span class="token punctuation">,</span> <span class="token string">"sessionContext is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>dispatchManager <span class="token operator">=</span> <span class="token function">requireNonNull</span><span class="token punctuation">(</span>dispatchManager<span class="token punctuation">,</span> <span class="token string">"dispatchManager is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>queryId <span class="token operator">=</span> dispatchManager<span class="token punctuation">.</span><span class="token function">createQueryId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">requireNonNull</span><span class="token punctuation">(</span>queryInfoUrlFactory<span class="token punctuation">,</span> <span class="token string">"queryInfoUrlFactory is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>queryInfoUrl <span class="token operator">=</span> queryInfoUrlFactory<span class="token punctuation">.</span><span class="token function">getQueryInfoUrl</span><span class="token punctuation">(</span>queryId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isCreated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> creationFuture<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">private</span> <span class="token class-name">ListenableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">waitForDispatched</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 只能调用`queued/{queryId}/{slug}/{token}` REST API，获取SQL任务的状态时，才会调用此方法，触发当前SQL任务的提交</span>
            <span class="token function">submitIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>creationFuture<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token function">nonCancellationPropagating</span><span class="token punctuation">(</span>creationFuture<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// otherwise, wait for the query to finish</span>
            <span class="token keyword">return</span> dispatchManager<span class="token punctuation">.</span><span class="token function">waitForDispatched</span><span class="token punctuation">(</span>queryId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">submitIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>submissionGate<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 尝试向dispatcherManager提交一个SQL任务</span>
                creationFuture<span class="token punctuation">.</span><span class="token function">setFuture</span><span class="token punctuation">(</span>dispatchManager<span class="token punctuation">.</span><span class="token function">createQuery</span><span class="token punctuation">(</span>queryId<span class="token punctuation">,</span> slug<span class="token punctuation">,</span> sessionContext<span class="token punctuation">,</span> query<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">public</span> <span class="token class-name">QueryResults</span> <span class="token function">getQueryResults</span><span class="token punctuation">(</span><span class="token keyword">long</span> token<span class="token punctuation">,</span> <span class="token class-name">UriInfo</span> uriInfo<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
           <span class="token comment">// 客户端获取结果</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            creationFuture<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> dispatchManager<span class="token punctuation">.</span><span class="token function">cancelQuery</span><span class="token punctuation">(</span>queryId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">directExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            sessionContext<span class="token punctuation">.</span><span class="token function">getIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="QueuedStatementResourceQueryManager_124"></a>QueuedStatementResource.QueryManager类</h3> 
<blockquote> 
 <p>负责维护所有活着的Query实例，为REST API提供快速获取Query功能；同时也负责检查客户端提交超时逻辑，详见tryAbandonSubmissionWithTimeout(clientTimeout)的检查条件。<br> 对于Server来说，只有触发了<code>Query::waitForDispatched()</code>方法，才将任务的状态设置为<code>submitted</code>。那如果客户端提交一个SQL执行后失联，肯定不会再调用REST API获取SQL的执行状态了，因此就不可能触发这个方法，这个期间段就被算作提交时间。</p> 
</blockquote> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@ThreadSafe</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">QueryManager</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">QueryId</span><span class="token punctuation">,</span> <span class="token class-name">Query</span><span class="token punctuation">&gt;</span></span> queries <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ScheduledExecutorService</span> scheduledExecutorService <span class="token operator">=</span> <span class="token function">newSingleThreadScheduledExecutor</span><span class="token punctuation">(</span><span class="token function">daemonThreadsNamed</span><span class="token punctuation">(</span><span class="token string">"drain-state-query-manager"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Duration</span> querySubmissionTimeout<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">QueryManager</span><span class="token punctuation">(</span><span class="token class-name">Duration</span> querySubmissionTimeout<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>querySubmissionTimeout <span class="token operator">=</span> <span class="token function">requireNonNull</span><span class="token punctuation">(</span>querySubmissionTimeout<span class="token punctuation">,</span> <span class="token string">"querySubmissionTimeout is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token class-name">DispatchManager</span> dispatchManager<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            scheduledExecutorService<span class="token punctuation">.</span><span class="token function">scheduleWithFixedDelay</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">syncWith</span><span class="token punctuation">(</span>dispatchManager<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">syncWith</span><span class="token punctuation">(</span><span class="token class-name">DispatchManager</span> dispatchManager<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            queries<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>queryId<span class="token punctuation">,</span> query<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldBePurged</span><span class="token punctuation">(</span>dispatchManager<span class="token punctuation">,</span> query<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">removeQuery</span><span class="token punctuation">(</span>queryId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">shouldBePurged</span><span class="token punctuation">(</span><span class="token class-name">DispatchManager</span> dispatchManager<span class="token punctuation">,</span> <span class="token class-name">Query</span> query<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>query<span class="token punctuation">.</span><span class="token function">isSubmissionAbandoned</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Query submission was explicitly abandoned</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>query<span class="token punctuation">.</span><span class="token function">tryAbandonSubmissionWithTimeout</span><span class="token punctuation">(</span>querySubmissionTimeout<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Query took too long to be submitted by the client</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>query<span class="token punctuation">.</span><span class="token function">isCreated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>dispatchManager<span class="token punctuation">.</span><span class="token function">isQueryRegistered</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span><span class="token function">getQueryId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Query was created in the DispatchManager, and DispatchManager has already purged the query</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">removeQuery</span><span class="token punctuation">(</span><span class="token class-name">QueryId</span> queryId<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>queries<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>queryId<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span><span class="token class-name">QueryManager</span><span class="token operator">::</span><span class="token function">destroyQuietly</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerQuery</span><span class="token punctuation">(</span><span class="token class-name">Query</span> query<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Query</span> existingQuery <span class="token operator">=</span> queries<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span><span class="token function">getQueryId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> query<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">checkState</span><span class="token punctuation">(</span>existingQuery <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"Query already registered"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Nullable</span>
        <span class="token keyword">public</span> <span class="token class-name">Query</span> <span class="token function">getQuery</span><span class="token punctuation">(</span><span class="token class-name">QueryId</span> queryId<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> queries<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>queryId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h2><a id="Query_193"></a>Query实例的调度</h2> 
<blockquote> 
 <p>只有当前客户端尝试获取SQL的执行状态时，才会触发SQL任务的提交，提交到。</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DispatchManager</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token class-name">ListenableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">createQuery</span><span class="token punctuation">(</span><span class="token class-name">QueryId</span> queryId<span class="token punctuation">,</span> <span class="token class-name">Slug</span> slug<span class="token punctuation">,</span> <span class="token class-name">SessionContext</span> sessionContext<span class="token punctuation">,</span> <span class="token class-name">String</span> query<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">requireNonNull</span><span class="token punctuation">(</span>queryId<span class="token punctuation">,</span> <span class="token string">"queryId is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">requireNonNull</span><span class="token punctuation">(</span>sessionContext<span class="token punctuation">,</span> <span class="token string">"sessionContext is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">requireNonNull</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> <span class="token string">"query is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">checkArgument</span><span class="token punctuation">(</span><span class="token operator">!</span>query<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"query must not be empty string"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">checkArgument</span><span class="token punctuation">(</span>queryTracker<span class="token punctuation">.</span><span class="token function">tryGetQuery</span><span class="token punctuation">(</span>queryId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"query %s already exists"</span><span class="token punctuation">,</span> queryId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// It is important to return a future implementation which ignores cancellation request.</span>
        <span class="token comment">// Using NonCancellationPropagatingFuture is not enough; it does not propagate cancel to wrapped future</span>
        <span class="token comment">// but it would still return true on call to isCancelled() after cancel() is called on it.</span>
        <span class="token class-name">DispatchQueryCreationFuture</span> queryCreationFuture <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DispatchQueryCreationFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 异步创建</span>
        dispatchExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">createQueryInternal</span><span class="token punctuation">(</span>queryId<span class="token punctuation">,</span> slug<span class="token punctuation">,</span> sessionContext<span class="token punctuation">,</span> query<span class="token punctuation">,</span> resourceGroupManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                queryCreationFuture<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> queryCreationFuture<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">C</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">createQueryInternal</span><span class="token punctuation">(</span><span class="token class-name">QueryId</span> queryId<span class="token punctuation">,</span> <span class="token class-name">Slug</span> slug<span class="token punctuation">,</span> <span class="token class-name">SessionContext</span> sessionContext<span class="token punctuation">,</span> <span class="token class-name">String</span> query<span class="token punctuation">,</span> <span class="token class-name">ResourceGroupManager</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">C</span><span class="token punctuation">&gt;</span></span> resourceGroupManager<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Session</span> session <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">PreparedQuery</span> preparedQuery <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>query<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> maxQueryLength<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">int</span> queryLength <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                query <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> maxQueryLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TrinoException</span><span class="token punctuation">(</span><span class="token constant">QUERY_TEXT_TOO_LARGE</span><span class="token punctuation">,</span> <span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"Query text length (%s) exceeds the maximum length (%s)"</span><span class="token punctuation">,</span> queryLength<span class="token punctuation">,</span> maxQueryLength<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// decode session</span>
            session <span class="token operator">=</span> sessionSupplier<span class="token punctuation">.</span><span class="token function">createSession</span><span class="token punctuation">(</span>queryId<span class="token punctuation">,</span> sessionContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// check query execute permissions</span>
            accessControl<span class="token punctuation">.</span><span class="token function">checkCanExecuteQuery</span><span class="token punctuation">(</span>sessionContext<span class="token punctuation">.</span><span class="token function">getIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// prepare query</span>
            <span class="token comment">// 对用户SQL进行Parsing，产生AST实例</span>
            preparedQuery <span class="token operator">=</span> queryPreparer<span class="token punctuation">.</span><span class="token function">prepareQuery</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> query<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// select resource group</span>
            <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> queryType <span class="token operator">=</span> <span class="token function">getQueryType</span><span class="token punctuation">(</span>preparedQuery<span class="token punctuation">.</span><span class="token function">getStatement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Enum</span><span class="token operator">::</span><span class="token function">name</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 如果没有配置ResourceGroup的分配策略，则默认会将当前SQL分析到全局队列中，所有的SQL共享集群</span>
            <span class="token class-name">SelectionContext</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">C</span><span class="token punctuation">&gt;</span></span> selectionContext <span class="token operator">=</span> resourceGroupManager<span class="token punctuation">.</span><span class="token function">selectGroup</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SelectionCriteria</span><span class="token punctuation">(</span>
                    sessionContext<span class="token punctuation">.</span><span class="token function">getIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    sessionContext<span class="token punctuation">.</span><span class="token function">getIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    sessionContext<span class="token punctuation">.</span><span class="token function">getIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getGroups</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    sessionContext<span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    sessionContext<span class="token punctuation">.</span><span class="token function">getClientTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    sessionContext<span class="token punctuation">.</span><span class="token function">getResourceEstimates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    queryType<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// apply system default session properties (does not override user set properties)</span>
            session <span class="token operator">=</span> sessionPropertyDefaults<span class="token punctuation">.</span><span class="token function">newSessionWithDefaultProperties</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> queryType<span class="token punctuation">,</span> selectionContext<span class="token punctuation">.</span><span class="token function">getResourceGroupId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// mark existing transaction as active</span>
            transactionManager<span class="token punctuation">.</span><span class="token function">activateTransaction</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> <span class="token function">isTransactionControlStatement</span><span class="token punctuation">(</span>preparedQuery<span class="token punctuation">.</span><span class="token function">getStatement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> accessControl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 将query和preparedQuery封装成一个DispatchQuery实例，实际上是一个LocalDispatchQuery类的实例，这个过程是异步的。</span>
            <span class="token comment">// 它提供了如下的方法，帮助上层获取任务的调度状态。</span>
            <span class="token comment">//     ListenableFuture&lt;Void&gt; getDispatchedFuture();</span>
            <span class="token comment">//     DispatchInfo getDispatchInfo();</span>
            <span class="token comment">//</span>
            <span class="token comment">// Trino中SQL执行的每一个阶段基本上都是异步的，为了能够在异步情况下正确管理Query的生命周期，都需要在相应的阶段创建一个</span>
            <span class="token comment">// 对应的实例，例如这里的DispatchQuery。</span>
            <span class="token class-name">DispatchQuery</span> dispatchQuery <span class="token operator">=</span> dispatchQueryFactory<span class="token punctuation">.</span><span class="token function">createDispatchQuery</span><span class="token punctuation">(</span>
                    session<span class="token punctuation">,</span>
                    query<span class="token punctuation">,</span>
                    preparedQuery<span class="token punctuation">,</span>
                    slug<span class="token punctuation">,</span>
                    selectionContext<span class="token punctuation">.</span><span class="token function">getResourceGroupId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// DispatchQuery一旦创建成功，就会将这个对象添加到QueryTracker对象中的，由它管理SQL的执行生命周期</span>
            <span class="token keyword">boolean</span> queryAdded <span class="token operator">=</span> <span class="token function">queryCreated</span><span class="token punctuation">(</span>dispatchQuery<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>queryAdded <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>dispatchQuery<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 如果SQL成功被添加进了QueryTracker，但是dispatchQuery还没有完成创建，则先将它放进提交到resource group中，等待被调度</span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    resourceGroupManager<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>dispatchQuery<span class="token punctuation">,</span> selectionContext<span class="token punctuation">,</span> dispatchExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// dispatch query has already been registered, so just fail it directly</span>
                    dispatchQuery<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// creation must never fail, so register a failed query in this case</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>session <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                session <span class="token operator">=</span> <span class="token class-name">Session</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>sessionPropertyManager<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setQueryId</span><span class="token punctuation">(</span>queryId<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setIdentity</span><span class="token punctuation">(</span>sessionContext<span class="token punctuation">.</span><span class="token function">getIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span>sessionContext<span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 如果发生了任务异常，会创建一个FailedDispatchQuery的实例，记录失败的种信息。</span>
            <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> preparedSql <span class="token operator">=</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>preparedQuery<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token class-name">PreparedQuery</span><span class="token operator">::</span><span class="token function">getPrepareSql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">DispatchQuery</span> failedDispatchQuery <span class="token operator">=</span> failedDispatchQueryFactory<span class="token punctuation">.</span><span class="token function">createFailedDispatchQuery</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> query<span class="token punctuation">,</span> preparedSql<span class="token punctuation">,</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">queryCreated</span><span class="token punctuation">(</span>failedDispatchQuery<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="LocalDispatchQuery_303"></a>创建LocalDispatchQuery实例</h3> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LocalDispatchQueryFactory</span>
        <span class="token keyword">implements</span> <span class="token class-name">DispatchQueryFactory</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">DispatchQuery</span> <span class="token function">createDispatchQuery</span><span class="token punctuation">(</span>
            <span class="token class-name">Session</span> session<span class="token punctuation">,</span>
            <span class="token class-name">String</span> query<span class="token punctuation">,</span>
            <span class="token class-name">PreparedQuery</span> preparedQuery<span class="token punctuation">,</span>
            <span class="token class-name">Slug</span> slug<span class="token punctuation">,</span>
            <span class="token class-name">ResourceGroupId</span> resourceGroup<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">WarningCollector</span> warningCollector <span class="token operator">=</span> warningCollectorFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 为新提交的Query实例，创建一个新的状态机</span>
        <span class="token class-name">QueryStateMachine</span> stateMachine <span class="token operator">=</span> <span class="token class-name">QueryStateMachine</span><span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span>
                query<span class="token punctuation">,</span>
                preparedQuery<span class="token punctuation">.</span><span class="token function">getPrepareSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                session<span class="token punctuation">,</span>
                locationFactory<span class="token punctuation">.</span><span class="token function">createQueryLocation</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span><span class="token function">getQueryId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                resourceGroup<span class="token punctuation">,</span>
                <span class="token function">isTransactionControlStatement</span><span class="token punctuation">(</span>preparedQuery<span class="token punctuation">.</span><span class="token function">getStatement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                transactionManager<span class="token punctuation">,</span>
                accessControl<span class="token punctuation">,</span>
                executor<span class="token punctuation">,</span>
                metadata<span class="token punctuation">,</span>
                warningCollector<span class="token punctuation">,</span>
                <span class="token function">getQueryType</span><span class="token punctuation">(</span>preparedQuery<span class="token punctuation">.</span><span class="token function">getStatement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// It is important that `queryCreatedEvent` is called here. Moving it past the `executor.submit` below</span>
        <span class="token comment">// can result in delivering query-created event after query analysis has already started.</span>
        <span class="token comment">// That can result in misbehaviour of plugins called during analysis phase (e.g. access control auditing)</span>
        <span class="token comment">// which depend on the contract that event was already delivered.</span>
        <span class="token comment">//</span>
        <span class="token comment">// Note that for immediate and in-order delivery of query events we depend on synchronous nature of</span>
        <span class="token comment">// QueryMonitor and EventListenerManager.</span>
        queryMonitor<span class="token punctuation">.</span><span class="token function">queryCreatedEvent</span><span class="token punctuation">(</span>stateMachine<span class="token punctuation">.</span><span class="token function">getBasicQueryInfo</span><span class="token punctuation">(</span><span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 异步的方式，创建QueryExecution实例，实际上是SqlQueryExecution的实例</span>
        <span class="token class-name">ListenableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">QueryExecution</span><span class="token punctuation">&gt;</span></span> queryExecutionFuture <span class="token operator">=</span> executor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">QueryExecutionFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> queryExecutionFactory <span class="token operator">=</span> executionFactories<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>preparedQuery<span class="token punctuation">.</span><span class="token function">getStatement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>queryExecutionFactory <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TrinoException</span><span class="token punctuation">(</span><span class="token constant">NOT_SUPPORTED</span><span class="token punctuation">,</span> <span class="token string">"Unsupported statement type: "</span> <span class="token operator">+</span> preparedQuery<span class="token punctuation">.</span><span class="token function">getStatement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 创建</span>
                <span class="token keyword">return</span> queryExecutionFactory<span class="token punctuation">.</span><span class="token function">createQueryExecution</span><span class="token punctuation">(</span>preparedQuery<span class="token punctuation">,</span> stateMachine<span class="token punctuation">,</span> slug<span class="token punctuation">,</span> warningCollector<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">Error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">StackOverflowError</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token string">"Unhandled StackOverFlowError; should be handled earlier; to investigate full stacktrace you may need to enable -XX:MaxJavaStackTraceDepth=0 JVM flag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token string">"Unhandled Error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// wrapping as RuntimeException to guard us from problem that code downstream which investigates queryExecutionFuture may not necessarily handle</span>
                    <span class="token comment">// Error subclass of Throwable well.</span>
                    <span class="token class-name">RuntimeException</span> wrappedError <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    stateMachine<span class="token punctuation">.</span><span class="token function">transitionToFailed</span><span class="token punctuation">(</span>wrappedError<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">throw</span> wrappedError<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                stateMachine<span class="token punctuation">.</span><span class="token function">transitionToFailed</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 返回LocalDispatchQuery的实例，可以看到这个实例，会有接收queryExecutionFuture变量，意味着只有当queryExecutionFuture.isDone()时，</span>
        <span class="token comment">// 才标识着此实例创建完成。</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LocalDispatchQuery</span><span class="token punctuation">(</span>
                stateMachine<span class="token punctuation">,</span>
                queryExecutionFuture<span class="token punctuation">,</span>
                queryMonitor<span class="token punctuation">,</span>
                clusterSizeMonitor<span class="token punctuation">,</span>
                executor<span class="token punctuation">,</span>
                <span class="token comment">// queryManager是一个SqlQueryManager的实例对象，它内部维护着QueryTracker的引用，因此可以在更上层管理SQL任务的生命周期</span>
                queryManager<span class="token operator">::</span><span class="token function">createQuery</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="SqlQueryExecution_383"></a>创建SqlQueryExecution实例</h3> 
<blockquote> 
 <p>通过SqlQueryExecutionFactory.createQueryExecution()创建对象。</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@ThreadSafe</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SqlQueryExecution</span>
        <span class="token keyword">implements</span> <span class="token class-name">QueryExecution</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">SqlQueryExecution</span><span class="token punctuation">(</span>
            <span class="token class-name">PreparedQuery</span> preparedQuery<span class="token punctuation">,</span>
            <span class="token class-name">QueryStateMachine</span> stateMachine<span class="token punctuation">,</span>
            <span class="token class-name">Slug</span> slug<span class="token punctuation">,</span>
            <span class="token class-name">PlannerContext</span> plannerContext<span class="token punctuation">,</span>
            <span class="token class-name">AnalyzerFactory</span> analyzerFactory<span class="token punctuation">,</span>
            <span class="token class-name">SplitSourceFactory</span> splitSourceFactory<span class="token punctuation">,</span>
            <span class="token class-name">NodePartitioningManager</span> nodePartitioningManager<span class="token punctuation">,</span>
            <span class="token class-name">NodeScheduler</span> nodeScheduler<span class="token punctuation">,</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PlanOptimizer</span><span class="token punctuation">&gt;</span></span> planOptimizers<span class="token punctuation">,</span>
            <span class="token class-name">PlanFragmenter</span> planFragmenter<span class="token punctuation">,</span>
            <span class="token class-name">RemoteTaskFactory</span> remoteTaskFactory<span class="token punctuation">,</span>
            <span class="token keyword">int</span> scheduleSplitBatchSize<span class="token punctuation">,</span>
            <span class="token class-name">ExecutorService</span> queryExecutor<span class="token punctuation">,</span>
            <span class="token class-name">ScheduledExecutorService</span> schedulerExecutor<span class="token punctuation">,</span>
            <span class="token class-name">FailureDetector</span> failureDetector<span class="token punctuation">,</span>
            <span class="token class-name">NodeTaskMap</span> nodeTaskMap<span class="token punctuation">,</span>
            <span class="token class-name">ExecutionPolicy</span> executionPolicy<span class="token punctuation">,</span>
            <span class="token class-name">SplitSchedulerStats</span> schedulerStats<span class="token punctuation">,</span>
            <span class="token class-name">StatsCalculator</span> statsCalculator<span class="token punctuation">,</span>
            <span class="token class-name">CostCalculator</span> costCalculator<span class="token punctuation">,</span>
            <span class="token class-name">DynamicFilterService</span> dynamicFilterService<span class="token punctuation">,</span>
            <span class="token class-name">WarningCollector</span> warningCollector<span class="token punctuation">,</span>
            <span class="token class-name">TableExecuteContextManager</span> tableExecuteContextManager<span class="token punctuation">,</span>
            <span class="token class-name">TypeAnalyzer</span> typeAnalyzer<span class="token punctuation">,</span>
            <span class="token class-name">TaskManager</span> coordinatorTaskManager<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">SetThreadName</span> ignored <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SetThreadName</span><span class="token punctuation">(</span><span class="token string">"Query-%s"</span><span class="token punctuation">,</span> stateMachine<span class="token punctuation">.</span><span class="token function">getQueryId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>slug <span class="token operator">=</span> <span class="token function">requireNonNull</span><span class="token punctuation">(</span>slug<span class="token punctuation">,</span> <span class="token string">"slug is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>plannerContext <span class="token operator">=</span> <span class="token function">requireNonNull</span><span class="token punctuation">(</span>plannerContext<span class="token punctuation">,</span> <span class="token string">"plannerContext is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>splitSourceFactory <span class="token operator">=</span> <span class="token function">requireNonNull</span><span class="token punctuation">(</span>splitSourceFactory<span class="token punctuation">,</span> <span class="token string">"splitSourceFactory is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>nodePartitioningManager <span class="token operator">=</span> <span class="token function">requireNonNull</span><span class="token punctuation">(</span>nodePartitioningManager<span class="token punctuation">,</span> <span class="token string">"nodePartitioningManager is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>nodeScheduler <span class="token operator">=</span> <span class="token function">requireNonNull</span><span class="token punctuation">(</span>nodeScheduler<span class="token punctuation">,</span> <span class="token string">"nodeScheduler is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>planOptimizers <span class="token operator">=</span> <span class="token function">requireNonNull</span><span class="token punctuation">(</span>planOptimizers<span class="token punctuation">,</span> <span class="token string">"planOptimizers is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>planFragmenter <span class="token operator">=</span> <span class="token function">requireNonNull</span><span class="token punctuation">(</span>planFragmenter<span class="token punctuation">,</span> <span class="token string">"planFragmenter is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>queryExecutor <span class="token operator">=</span> <span class="token function">requireNonNull</span><span class="token punctuation">(</span>queryExecutor<span class="token punctuation">,</span> <span class="token string">"queryExecutor is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>schedulerExecutor <span class="token operator">=</span> <span class="token function">requireNonNull</span><span class="token punctuation">(</span>schedulerExecutor<span class="token punctuation">,</span> <span class="token string">"schedulerExecutor is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>failureDetector <span class="token operator">=</span> <span class="token function">requireNonNull</span><span class="token punctuation">(</span>failureDetector<span class="token punctuation">,</span> <span class="token string">"failureDetector is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>nodeTaskMap <span class="token operator">=</span> <span class="token function">requireNonNull</span><span class="token punctuation">(</span>nodeTaskMap<span class="token punctuation">,</span> <span class="token string">"nodeTaskMap is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>executionPolicy <span class="token operator">=</span> <span class="token function">requireNonNull</span><span class="token punctuation">(</span>executionPolicy<span class="token punctuation">,</span> <span class="token string">"executionPolicy is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>schedulerStats <span class="token operator">=</span> <span class="token function">requireNonNull</span><span class="token punctuation">(</span>schedulerStats<span class="token punctuation">,</span> <span class="token string">"schedulerStats is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>statsCalculator <span class="token operator">=</span> <span class="token function">requireNonNull</span><span class="token punctuation">(</span>statsCalculator<span class="token punctuation">,</span> <span class="token string">"statsCalculator is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>costCalculator <span class="token operator">=</span> <span class="token function">requireNonNull</span><span class="token punctuation">(</span>costCalculator<span class="token punctuation">,</span> <span class="token string">"costCalculator is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>dynamicFilterService <span class="token operator">=</span> <span class="token function">requireNonNull</span><span class="token punctuation">(</span>dynamicFilterService<span class="token punctuation">,</span> <span class="token string">"dynamicFilterService is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>tableExecuteContextManager <span class="token operator">=</span> <span class="token function">requireNonNull</span><span class="token punctuation">(</span>tableExecuteContextManager<span class="token punctuation">,</span> <span class="token string">"tableExecuteContextManager is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">checkArgument</span><span class="token punctuation">(</span>scheduleSplitBatchSize <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"scheduleSplitBatchSize must be greater than 0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>scheduleSplitBatchSize <span class="token operator">=</span> scheduleSplitBatchSize<span class="token punctuation">;</span>
            <span class="token comment">// 保存状态机的引用</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>stateMachine <span class="token operator">=</span> <span class="token function">requireNonNull</span><span class="token punctuation">(</span>stateMachine<span class="token punctuation">,</span> <span class="token string">"stateMachine is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// analyze query</span>
            <span class="token comment">// preparedQuery保存了SQL文本Parsing后的Statement（AST），因此这里基于此对象，对AST进行解析</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>analysis <span class="token operator">=</span> <span class="token function">analyze</span><span class="token punctuation">(</span>preparedQuery<span class="token punctuation">,</span> stateMachine<span class="token punctuation">,</span> warningCollector<span class="token punctuation">,</span> analyzerFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 向状态机注册Listener，一旦状态机的状态被设置为完成状态，就注销dynamicFilterService服务，这个服务的任务会在其它文章中详解。</span>
            stateMachine<span class="token punctuation">.</span><span class="token function">addStateChangeListener</span><span class="token punctuation">(</span>state <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>state<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">unregisterDynamicFilteringQuery</span><span class="token punctuation">(</span>
                        dynamicFilterService<span class="token punctuation">.</span><span class="token function">getDynamicFilteringStats</span><span class="token punctuation">(</span>stateMachine<span class="token punctuation">.</span><span class="token function">getQueryId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stateMachine<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                tableExecuteContextManager<span class="token punctuation">.</span><span class="token function">unregisterTableExecuteContextForQuery</span><span class="token punctuation">(</span>stateMachine<span class="token punctuation">.</span><span class="token function">getQueryId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// when the query finishes cache the final query info, and clear the reference to the output stage</span>
            <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SqlQueryScheduler</span><span class="token punctuation">&gt;</span></span> queryScheduler <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>queryScheduler<span class="token punctuation">;</span>
            stateMachine<span class="token punctuation">.</span><span class="token function">addStateChangeListener</span><span class="token punctuation">(</span>state <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>state<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// query is now done, so abort any work that is still running</span>
                <span class="token comment">// 失败是完成状态的一种</span>
                <span class="token class-name">SqlQueryScheduler</span> scheduler <span class="token operator">=</span> queryScheduler<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>scheduler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    scheduler<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>remoteTaskFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemoryTrackingRemoteTaskFactory</span><span class="token punctuation">(</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>remoteTaskFactory<span class="token punctuation">,</span> <span class="token string">"remoteTaskFactory is null"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stateMachine<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>typeAnalyzer <span class="token operator">=</span> <span class="token function">requireNonNull</span><span class="token punctuation">(</span>typeAnalyzer<span class="token punctuation">,</span> <span class="token string">"typeAnalyzer is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>coordinatorTaskManager <span class="token operator">=</span> <span class="token function">requireNonNull</span><span class="token punctuation">(</span>coordinatorTaskManager<span class="token punctuation">,</span> <span class="token string">"coordinatorTaskManager is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="LocalDispatchQuery_479"></a>LocalDispatchQuery的创建及执行</h2> 
<blockquote> 
 <p>实际上就是QueryExecution实例的执行，进入这个过程，实际上还需要经过ResourceGroup的筛选，筛选细节不是这里的重点，<br> 因此略过，只需要知道ResourceGroup最终会调用<code>LocalDispatchQuery::startWaitingForResources</code>方法。</p> 
</blockquote> 
<h3><a id="_483"></a>资源检测</h3> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LocalDispatchQuery</span>
        <span class="token keyword">implements</span> <span class="token class-name">DispatchQuery</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startWaitingForResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 将状态机的状态设置为WAITING_RESOURCES</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stateMachine<span class="token punctuation">.</span><span class="token function">transitionToWaitingForResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">waitForMinimumWorkers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">waitForMinimumWorkers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 只有当有足够的Workers结点时，才会开始执行queryExecution实例，但由于我们没有修改默认的参数</span>
        <span class="token comment">// 因此这里的限制条件是，一旦有1个Worker可用，就会触发startExecution(queryExecution)的调用。</span>
        <span class="token comment">// wait for query execution to finish construction</span>
        <span class="token function">addSuccessCallback</span><span class="token punctuation">(</span>queryExecutionFuture<span class="token punctuation">,</span> queryExecution <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Session</span> session <span class="token operator">=</span> stateMachine<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> executionMinCount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// always wait for 1 node to be up</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>queryExecution<span class="token punctuation">.</span><span class="token function">shouldWaitForMinWorkers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                executionMinCount <span class="token operator">=</span> <span class="token function">getRequiredWorkers</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">ListenableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> minimumWorkerFuture <span class="token operator">=</span> clusterSizeMonitor<span class="token punctuation">.</span><span class="token function">waitForMinimumWorkers</span><span class="token punctuation">(</span>executionMinCount<span class="token punctuation">,</span> <span class="token function">getRequiredWorkersMaxWait</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// when worker requirement is met, start the execution</span>
            <span class="token function">addSuccessCallback</span><span class="token punctuation">(</span>minimumWorkerFuture<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">startExecution</span><span class="token punctuation">(</span>queryExecution<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">addExceptionCallback</span><span class="token punctuation">(</span>minimumWorkerFuture<span class="token punctuation">,</span> throwable <span class="token operator">-&gt;</span> queryExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> stateMachine<span class="token punctuation">.</span><span class="token function">transitionToFailed</span><span class="token punctuation">(</span>throwable<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// cancel minimumWorkerFuture if query fails for some reason or is cancelled by user</span>
            stateMachine<span class="token punctuation">.</span><span class="token function">addStateChangeListener</span><span class="token punctuation">(</span>state <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    minimumWorkerFuture<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startExecution</span><span class="token punctuation">(</span><span class="token class-name">QueryExecution</span> queryExecution<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        queryExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 将状态机的状态设置为DISPATCHING</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>stateMachine<span class="token punctuation">.</span><span class="token function">transitionToDispatching</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 提交给querySubmitter，就是在前面提到的queryManager::createQuery方法，最终会路由到SqlQueryExecution::start方法</span>
                    querySubmitter<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>queryExecution<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>notificationSentOrGuaranteed<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        queryExecution<span class="token punctuation">.</span><span class="token function">addFinalQueryInfoListener</span><span class="token punctuation">(</span>queryMonitor<span class="token operator">::</span><span class="token function">queryCompletedEvent</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// this should never happen but be safe</span>
                    stateMachine<span class="token punctuation">.</span><span class="token function">transitionToFailed</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">"query submitter threw exception"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">throw</span> t<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                    submitted<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="SqlQueryExecutionstart_549"></a>SqlQueryExecution::start()</h3> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@ThreadSafe</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SqlQueryExecution</span>
        <span class="token keyword">implements</span> <span class="token class-name">QueryExecution</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">SetThreadName</span> ignored <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SetThreadName</span><span class="token punctuation">(</span><span class="token string">"Query-%s"</span><span class="token punctuation">,</span> stateMachine<span class="token punctuation">.</span><span class="token function">getQueryId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 将状态机的状态设置为PlANNING</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>stateMachine<span class="token punctuation">.</span><span class="token function">transitionToPlanning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// query already started or finished</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 启动监听线程，一旦在发现状态机的状态处理失败状态，则强制中止PLANNING</span>
                <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Thread</span><span class="token punctuation">&gt;</span></span> planningThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                stateMachine<span class="token punctuation">.</span><span class="token function">getStateChange</span><span class="token punctuation">(</span><span class="token constant">PLANNING</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>stateMachine<span class="token punctuation">.</span><span class="token function">getQueryState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">FAILED</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token class-name">Thread</span> thread <span class="token operator">=</span> planningThread<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>thread <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                thread<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">directExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 优化逻辑计划树，并切分为PlanFragments，以便能够调度Plan片段执行</span>
                    <span class="token class-name">PlanRoot</span> plan <span class="token operator">=</span> <span class="token function">planQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// DynamicFilterService needs plan for query to be registered.</span>
                    <span class="token comment">// Query should be registered before dynamic filter suppliers are requested in distribution planning.</span>
                    <span class="token comment">// 注册动态裁剪服务</span>
                    <span class="token function">registerDynamicFilteringQuery</span><span class="token punctuation">(</span>plan<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 调度plan执行，内部会创建SqlQueryScheduler实例，负责调度PlanFragments的分发和状态管理，这个过程是异步的</span>
                    <span class="token function">planDistribution</span><span class="token punctuation">(</span>plan<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        planningThread<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// Clear the interrupted flag in case there was a race condition where</span>
                        <span class="token comment">// the planning thread was interrupted right after planning completes above</span>
                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                tableExecuteContextManager<span class="token punctuation">.</span><span class="token function">registerTableExecuteContextForQuery</span><span class="token punctuation">(</span><span class="token function">getQueryId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 将状态机的状态设置为STARTING</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>stateMachine<span class="token punctuation">.</span><span class="token function">transitionToStarting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// query already started or finished</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// if query is not finished, start the scheduler, otherwise cancel it</span>
                <span class="token class-name">SqlQueryScheduler</span> scheduler <span class="token operator">=</span> queryScheduler<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>stateMachine<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 调用SqlQueryScheduler::start()方法，开始调度执行</span>
                    scheduler<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">fail</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">throwIfInstanceOf</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="SqlQueryExecutionplanDistribution_621"></a>SqlQueryExecution::planDistribution</h4> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@ThreadSafe</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SqlQueryExecution</span>
        <span class="token keyword">implements</span> <span class="token class-name">QueryExecution</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">planDistribution</span><span class="token punctuation">(</span><span class="token class-name">PlanRoot</span> plan<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// if query was canceled, skip creating scheduler</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stateMachine<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// record output field</span>
        <span class="token class-name">PlanFragment</span> rootFragment <span class="token operator">=</span> plan<span class="token punctuation">.</span><span class="token function">getRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stateMachine<span class="token punctuation">.</span><span class="token function">setColumns</span><span class="token punctuation">(</span>
                <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">OutputNode</span><span class="token punctuation">)</span> rootFragment<span class="token punctuation">.</span><span class="token function">getRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getColumnNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                rootFragment<span class="token punctuation">.</span><span class="token function">getTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// build the stage execution objects (this doesn't schedule execution)</span>
        <span class="token class-name">SqlQueryScheduler</span> scheduler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SqlQueryScheduler</span><span class="token punctuation">(</span>
                stateMachine<span class="token punctuation">,</span>
                plan<span class="token punctuation">.</span><span class="token function">getRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                nodePartitioningManager<span class="token punctuation">,</span>
                nodeScheduler<span class="token punctuation">,</span>
                remoteTaskFactory<span class="token punctuation">,</span>
                plan<span class="token punctuation">.</span><span class="token function">isSummarizeTaskInfos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                scheduleSplitBatchSize<span class="token punctuation">,</span>
                queryExecutor<span class="token punctuation">,</span>
                schedulerExecutor<span class="token punctuation">,</span>
                failureDetector<span class="token punctuation">,</span>
                nodeTaskMap<span class="token punctuation">,</span>
                executionPolicy<span class="token punctuation">,</span>
                schedulerStats<span class="token punctuation">,</span>
                dynamicFilterService<span class="token punctuation">,</span>
                tableExecuteContextManager<span class="token punctuation">,</span>
                plannerContext<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                splitSourceFactory<span class="token punctuation">,</span>
                coordinatorTaskManager<span class="token punctuation">)</span><span class="token punctuation">;</span>

        queryScheduler<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>scheduler<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// if query was canceled during scheduler creation, abort the scheduler</span>
        <span class="token comment">// directly since the callback may have already fired</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stateMachine<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            scheduler<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            queryScheduler<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="StageManagerPlanFragmentSqlStage_672"></a>生成StageManager实例，同时为每一个PlanFragment生成SqlStage实例</h5> 
<blockquote> 
 <p>SqlStage负责维护跟踪所有归属它的任务的生命周期管理，以及状态维护</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SqlQueryScheduler</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">StageManager</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">StageManager</span> <span class="token function">create</span><span class="token punctuation">(</span>
                <span class="token class-name">QueryStateMachine</span> queryStateMachine<span class="token punctuation">,</span>
                <span class="token class-name">Session</span> session<span class="token punctuation">,</span>
                <span class="token class-name">Metadata</span> metadata<span class="token punctuation">,</span>
                <span class="token class-name">RemoteTaskFactory</span> taskFactory<span class="token punctuation">,</span>
                <span class="token class-name">NodeTaskMap</span> nodeTaskMap<span class="token punctuation">,</span>
                <span class="token class-name">ExecutorService</span> executor<span class="token punctuation">,</span>
                <span class="token class-name">SplitSchedulerStats</span> schedulerStats<span class="token punctuation">,</span>
                <span class="token class-name">SubPlan</span> planTree<span class="token punctuation">,</span>
                <span class="token keyword">boolean</span> summarizeTaskInfo<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">ImmutableMap<span class="token punctuation">.</span>Builder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StageId</span><span class="token punctuation">,</span> <span class="token class-name">SqlStage</span><span class="token punctuation">&gt;</span></span> stages <span class="token operator">=</span> <span class="token class-name">ImmutableMap</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ImmutableList<span class="token punctuation">.</span>Builder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SqlStage</span><span class="token punctuation">&gt;</span></span> coordinatorStagesInTopologicalOrder <span class="token operator">=</span> <span class="token class-name">ImmutableList</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ImmutableList<span class="token punctuation">.</span>Builder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SqlStage</span><span class="token punctuation">&gt;</span></span> distributedStagesInTopologicalOrder <span class="token operator">=</span> <span class="token class-name">ImmutableList</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">StageId</span> rootStageId <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token class-name">ImmutableMap<span class="token punctuation">.</span>Builder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StageId</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">StageId</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> children <span class="token operator">=</span> <span class="token class-name">ImmutableMap</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ImmutableMap<span class="token punctuation">.</span>Builder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StageId</span><span class="token punctuation">,</span> <span class="token class-name">StageId</span><span class="token punctuation">&gt;</span></span> parents <span class="token operator">=</span> <span class="token class-name">ImmutableMap</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 从Root Plan自顶向下、广度优先遍历，获取所有的SubPlans</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SubPlan</span> planNode <span class="token operator">:</span> <span class="token class-name">Traverser</span><span class="token punctuation">.</span><span class="token function">forTree</span><span class="token punctuation">(</span><span class="token class-name">SubPlan</span><span class="token operator">::</span><span class="token function">getChildren</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">breadthFirst</span><span class="token punctuation">(</span>planTree<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">PlanFragment</span> fragment <span class="token operator">=</span> planNode<span class="token punctuation">.</span><span class="token function">getFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 一个SubPlan或是PlanFragment就是一个Stage（同Spark中的概念相近），StageId的取值为{queryId}-{fragmentId}</span>
                <span class="token class-name">SqlStage</span> stage <span class="token operator">=</span> <span class="token function">createSqlStage</span><span class="token punctuation">(</span>
                        <span class="token function">getStageId</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span><span class="token function">getQueryId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fragment<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        fragment<span class="token punctuation">,</span>
                        <span class="token function">extractTableInfo</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> metadata<span class="token punctuation">,</span> fragment<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        taskFactory<span class="token punctuation">,</span>
                        session<span class="token punctuation">,</span>
                        summarizeTaskInfo<span class="token punctuation">,</span>
                        nodeTaskMap<span class="token punctuation">,</span>
                        executor<span class="token punctuation">,</span>
                        schedulerStats<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">StageId</span> stageId <span class="token operator">=</span> stage<span class="token punctuation">.</span><span class="token function">getStageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                stages<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>stageId<span class="token punctuation">,</span> stage<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 以拓扑序，维护所有的Stages</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>fragment<span class="token punctuation">.</span><span class="token function">getPartitioning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isCoordinatorOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    coordinatorStagesInTopologicalOrder<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>stage<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    distributedStagesInTopologicalOrder<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>stage<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 由于外层遍历是自顶向下的，因此每一个Stage就是最上游的Stage，即root stage</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>rootStageId <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    rootStageId <span class="token operator">=</span> stageId<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 维护Stages之间的依赖关系</span>
                <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StageId</span><span class="token punctuation">&gt;</span></span> childStageIds <span class="token operator">=</span> planNode<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>childStage <span class="token operator">-&gt;</span> <span class="token function">getStageId</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span><span class="token function">getQueryId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> childStage<span class="token punctuation">.</span><span class="token function">getFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token function">toImmutableSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                children<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>stageId<span class="token punctuation">,</span> childStageIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
                childStageIds<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>child <span class="token operator">-&gt;</span> parents<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> stageId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          
            <span class="token class-name">StageManager</span> stageManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StageManager</span><span class="token punctuation">(</span>
                    queryStateMachine<span class="token punctuation">,</span>
                    stages<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    coordinatorStagesInTopologicalOrder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    distributedStagesInTopologicalOrder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    rootStageId<span class="token punctuation">,</span>
                    children<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    parents<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            stageManager<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> stageManager<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="SqlQuerySchedulerstart_747"></a>SqlQueryScheduler::start()</h3> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SqlQueryScheduler</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>started<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        started <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>queryStateMachine<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// when query is done or any time a stage completes, attempt to transition query to "final query info ready"</span>
        queryStateMachine<span class="token punctuation">.</span><span class="token function">addStateChangeListener</span><span class="token punctuation">(</span>state <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>state<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">DistributedStagesScheduler</span> distributedStagesScheduler<span class="token punctuation">;</span>
            <span class="token comment">// synchronize to wait on distributed scheduler creation if it is currently in process</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                distributedStagesScheduler <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>distributedStagesScheduler<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> <span class="token class-name">QueryState</span><span class="token punctuation">.</span><span class="token constant">FINISHED</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 如果状态机的状态被设置为FINISHED，就取消所有正在调度的Stages</span>
                coordinatorStagesScheduler<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>distributedStagesScheduler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    distributedStagesScheduler<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 通过StageManager完成</span>
                stageManager<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> <span class="token class-name">QueryState</span><span class="token punctuation">.</span><span class="token constant">FAILED</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                coordinatorStagesScheduler<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>distributedStagesScheduler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    distributedStagesScheduler<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                stageManager<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            queryStateMachine<span class="token punctuation">.</span><span class="token function">updateQueryInfo</span><span class="token punctuation">(</span><span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span><span class="token function">getStageInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 调度Stages执行</span>
        coordinatorStagesScheduler<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DistributedStagesScheduler</span><span class="token punctuation">&gt;</span></span> distributedStagesScheduler <span class="token operator">=</span> <span class="token function">createDistributedStagesScheduler</span><span class="token punctuation">(</span>currentAttempt<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        distributedStagesScheduler<span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span>scheduler <span class="token operator">-&gt;</span> distributedStagesSchedulingTask <span class="token operator">=</span> executor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>scheduler<span class="token operator">::</span><span class="token function">schedule</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="DistributedStagesSchedulerschedule_802"></a>DistributedStagesScheduler::schedule()</h3> 
<h4><a id="DistributedStagesScheduler_803"></a>DistributedStagesScheduler的创建</h4> 
<blockquote> 
 <p>负责调度所有的SqlStages执行。</p> 
</blockquote> 
<pre><code class="prism language-java">        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">PipelinedDistributedStagesScheduler</span> <span class="token function">create</span><span class="token punctuation">(</span>
                <span class="token class-name">QueryStateMachine</span> queryStateMachine<span class="token punctuation">,</span> <span class="token comment">// Query级别的状态机</span>
                <span class="token class-name">SplitSchedulerStats</span> schedulerStats<span class="token punctuation">,</span> <span class="token comment">// 记录Splits的调度信息</span>
                <span class="token class-name">NodeScheduler</span> nodeScheduler<span class="token punctuation">,</span>        <span class="token comment">// 负责为Split分配合适的Worker Node</span>
                <span class="token class-name">NodePartitioningManager</span> nodePartitioningManager<span class="token punctuation">,</span> <span class="token comment">// 提供获取对数据页Page进行Partitioning相关信息</span>
                <span class="token class-name">StageManager</span> stageManager<span class="token punctuation">,</span>          <span class="token comment">// 管理所有的Stages</span>
                <span class="token class-name">CoordinatorStagesScheduler</span> coordinatorStagesScheduler<span class="token punctuation">,</span> <span class="token comment">// 负责调度所有的Stages到Coordinator结点</span>
                <span class="token class-name">ExecutionPolicy</span> executionPolicy<span class="token punctuation">,</span>    <span class="token comment">// 执行策略器，AllAtOnceExecutionPolicy和PhasedExecutionPolicy</span>
                <span class="token class-name">FailureDetector</span> failureDetector<span class="token punctuation">,</span>
                <span class="token class-name">ScheduledExecutorService</span> executor<span class="token punctuation">,</span>  <span class="token comment">// Stages调度时的线程池</span>
                <span class="token class-name">SplitSourceFactory</span> splitSourceFactory<span class="token punctuation">,</span> <span class="token comment">// 创建Source Splits的工厂类</span>
                <span class="token keyword">int</span> splitBatchSize<span class="token punctuation">,</span>                    <span class="token comment">// 一次调度的最大Splits数量</span>
                <span class="token class-name">DynamicFilterService</span> dynamicFilterService<span class="token punctuation">,</span>
                <span class="token class-name">TableExecuteContextManager</span> tableExecuteContextManager<span class="token punctuation">,</span>
                <span class="token class-name">RetryPolicy</span> retryPolicy<span class="token punctuation">,</span>
                <span class="token keyword">int</span> attempt<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 由于DistributedStagesScheduler是负责Stages的调度器，这有别与QueryStateMachine的状态，因此这里要创建一个独立的状态机</span>
            <span class="token comment">// 负责维护PipelinedDistributedStagesScheduler的状态</span>
            <span class="token class-name">DistributedStagesSchedulerStateMachine</span> stateMachine <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DistributedStagesSchedulerStateMachine</span><span class="token punctuation">(</span>queryStateMachine<span class="token punctuation">.</span><span class="token function">getQueryId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 使用Map以PartitioningHandle缓存所有的NodePartitionMap实例，由于PlanFragment对应的PartitioningHandle实例相同</span>
            <span class="token comment">// 因此可以避免干次生成NodePartitionMap实例</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PartitioningHandle</span><span class="token punctuation">,</span> <span class="token class-name">NodePartitionMap</span><span class="token punctuation">&gt;</span></span> partitioningCacheMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 根据具体的Connector提供的PartitioningHandle，生成NodePartitonMap:</span>
            <span class="token comment">//     NodePartitonMap记录了WorkerNode -&gt; PartitionId的映射关系，它的生成可以由Connector提供，</span>
            <span class="token comment">//     例如IcebergPartitioningHandle，也可以使用系统默认的实现SystemPartitioningHandle。</span>
            <span class="token comment">// 如何生成NodePartitionMap实例，见后面的子章节。</span>
            <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PartitioningHandle</span><span class="token punctuation">,</span> <span class="token class-name">NodePartitionMap</span><span class="token punctuation">&gt;</span></span> partitioningCache <span class="token operator">=</span> partitioningHandle <span class="token operator">-&gt;</span>
                    partitioningCacheMap<span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>partitioningHandle<span class="token punctuation">,</span> handle <span class="token operator">-&gt;</span> nodePartitioningManager<span class="token punctuation">.</span><span class="token function">getNodePartitioningMap</span><span class="token punctuation">(</span>queryStateMachine<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> handle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 为每一个PlanFragment实例，创建Bucket -&gt; PartitionId的映射</span>
            <span class="token comment">// Butcket即桶，类似Hive中的Bucket概念，是对一个数据Partition中的数据的进一步细化，因此一个Partition会包含多个buckets</span>
            <span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token class-name">PlanFragmentId</span><span class="token punctuation">,</span> <span class="token class-name">Optional</span><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;&gt;</span> bucketToPartitionMap <span class="token operator">=</span> <span class="token function">createBucketToPartitionMap</span><span class="token punctuation">(</span>
                    coordinatorStagesScheduler<span class="token punctuation">.</span><span class="token function">getBucketToPartitionForStagesConsumedByCoordinator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    stageManager<span class="token punctuation">,</span>
                    partitioningCache<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 为每一个PlanFragment创建OutputBufferManager实例，用于创建和维护这个Fragment的输出缓存区</span>
            <span class="token comment">// OutputBufferManager分根据PartitioningHandle的不同类型，创建不一样的OutputBuffers，一共有如下三种：</span>
            <span class="token comment">// BufferType type = </span>
            <span class="token comment">//   if partitioningHandle.equals(FIXED_BROADCAST_DISTRIBUTION) then BROADCAST;</span>
            <span class="token comment">//   else if (partitioningHandle.equals(FIXED_ARBITRARY_DISTRIBUTION) then ARBITRARY;</span>
            <span class="token comment">//   else PARTITIONED;</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PlanFragmentId</span><span class="token punctuation">,</span> <span class="token class-name">OutputBufferManager</span><span class="token punctuation">&gt;</span></span> outputBufferManagers <span class="token operator">=</span> <span class="token function">createOutputBufferManagers</span><span class="token punctuation">(</span>
                    coordinatorStagesScheduler<span class="token punctuation">.</span><span class="token function">getOutputBuffersForStagesConsumedByCoordinator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    stageManager<span class="token punctuation">,</span>
                    bucketToPartitionMap<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">TaskLifecycleListener</span> coordinatorTaskLifecycleListener <span class="token operator">=</span> coordinatorStagesScheduler<span class="token punctuation">.</span><span class="token function">getTaskLifecycleListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>retryPolicy <span class="token operator">!=</span> <span class="token class-name">RetryPolicy</span><span class="token punctuation">.</span><span class="token constant">NONE</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// when retries are enabled only close exchange clients on coordinator when the query is finished</span>
                <span class="token class-name">TaskLifecycleListenerBridge</span> taskLifecycleListenerBridge <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TaskLifecycleListenerBridge</span><span class="token punctuation">(</span>coordinatorTaskLifecycleListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
                coordinatorTaskLifecycleListener <span class="token operator">=</span> taskLifecycleListenerBridge<span class="token punctuation">;</span>
                stateMachine<span class="token punctuation">.</span><span class="token function">addStateChangeListener</span><span class="token punctuation">(</span>state <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> <span class="token class-name">DistributedStagesSchedulerState</span><span class="token punctuation">.</span><span class="token constant">FINISHED</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        taskLifecycleListenerBridge<span class="token punctuation">.</span><span class="token function">notifyNoMoreSourceTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
			<span class="token comment">// 为所有的要调度的Stages创建对应的PipelinedStageExecution实例，每一个PipelinedStageExecution实例则负责各自的Stage的生命周期管理</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StageId</span><span class="token punctuation">,</span> <span class="token class-name">PipelinedStageExecution</span><span class="token punctuation">&gt;</span></span> stageExecutions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SqlStage</span> stage <span class="token operator">:</span> stageManager<span class="token punctuation">.</span><span class="token function">getDistributedStagesInTopologicalOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SqlStage</span><span class="token punctuation">&gt;</span></span> parentStage <span class="token operator">=</span> stageManager<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span>stage<span class="token punctuation">.</span><span class="token function">getStageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// TaskLifecycleListener提供了为Stage创建任务的接口</span>
                <span class="token class-name">TaskLifecycleListener</span> taskLifecycleListener<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>parentStage<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> parentStage<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPartitioning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isCoordinatorOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// output will be consumed by coordinator</span>
                    <span class="token comment">// parentStage是Root或是PlanFragment的分区策略是仅位于Coordiantor时，设置这个Stage的生命周期为Coordiator</span>
                    taskLifecycleListener <span class="token operator">=</span> coordinatorTaskLifecycleListener<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 非Root Stage时，则获取已经绑定了的实例</span>
                    <span class="token class-name">StageId</span> parentStageId <span class="token operator">=</span> parentStage<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">PipelinedStageExecution</span> parentStageExecution <span class="token operator">=</span> <span class="token function">requireNonNull</span><span class="token punctuation">(</span>stageExecutions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>parentStageId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">"execution is null for stage: "</span> <span class="token operator">+</span> parentStageId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    taskLifecycleListener <span class="token operator">=</span> parentStageExecution<span class="token punctuation">.</span><span class="token function">getTaskLifecycleListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token class-name">PlanFragment</span> fragment <span class="token operator">=</span> stage<span class="token punctuation">.</span><span class="token function">getFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 创建PipelinedStageExecution，负责执行调度&amp;执行当前Stage，会为每一个Partition创建RemoteTask实例，并调度到相应的Worker Node执行</span>
                <span class="token class-name">PipelinedStageExecution</span> stageExecution <span class="token operator">=</span> <span class="token function">createPipelinedStageExecution</span><span class="token punctuation">(</span>
                        stageManager<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>fragment<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        outputBufferManagers<span class="token punctuation">,</span>
                        taskLifecycleListener<span class="token punctuation">,</span>
                        failureDetector<span class="token punctuation">,</span>
                        executor<span class="token punctuation">,</span>
                        bucketToPartitionMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>fragment<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        attempt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                stageExecutions<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>stage<span class="token punctuation">.</span><span class="token function">getStageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stageExecution<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">ImmutableMap<span class="token punctuation">.</span>Builder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StageId</span><span class="token punctuation">,</span> <span class="token class-name">StageScheduler</span><span class="token punctuation">&gt;</span></span> stageSchedulers <span class="token operator">=</span> <span class="token class-name">ImmutableMap</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">PipelinedStageExecution</span> stageExecution <span class="token operator">:</span> stageExecutions<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PipelinedStageExecution</span><span class="token punctuation">&gt;</span></span> children <span class="token operator">=</span> stageManager<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span>stageExecution<span class="token punctuation">.</span><span class="token function">getStageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>stage <span class="token operator">-&gt;</span> <span class="token function">requireNonNull</span><span class="token punctuation">(</span>stageExecutions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>stage<span class="token punctuation">.</span><span class="token function">getStageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">"stage execution not found for stage: "</span> <span class="token operator">+</span> stage<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token function">toImmutableList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 每一个StageExecution实例，创建对应的StageScheduler实例，负责当前Stage的调度执行，Trino实现了几个不同实现类：</span>
                <span class="token comment">//  FixedSourcePartitionedScheduler</span>
                <span class="token comment">//  FixedCountScheduler</span>
                <span class="token comment">//  () -&gt; SourcePartitionedScheduler</span>
                <span class="token class-name">StageScheduler</span> scheduler <span class="token operator">=</span> <span class="token function">createStageScheduler</span><span class="token punctuation">(</span>
                        queryStateMachine<span class="token punctuation">,</span>
                        stageExecution<span class="token punctuation">,</span>
                        splitSourceFactory<span class="token punctuation">,</span>
                        children<span class="token punctuation">,</span>
                        partitioningCache<span class="token punctuation">,</span>
                        nodeScheduler<span class="token punctuation">,</span>
                        nodePartitioningManager<span class="token punctuation">,</span>
                        splitBatchSize<span class="token punctuation">,</span>
                        dynamicFilterService<span class="token punctuation">,</span>
                        executor<span class="token punctuation">,</span>
                        tableExecuteContextManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
                stageSchedulers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>stageExecution<span class="token punctuation">.</span><span class="token function">getStageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> scheduler<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 创建PipelinedDistributedStagesScheduler实例，负责所有的Stages的调度执行</span>
            <span class="token class-name">PipelinedDistributedStagesScheduler</span> distributedStagesScheduler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PipelinedDistributedStagesScheduler</span><span class="token punctuation">(</span>
                    stateMachine<span class="token punctuation">,</span>
                    queryStateMachine<span class="token punctuation">,</span>
                    schedulerStats<span class="token punctuation">,</span>
                    stageManager<span class="token punctuation">,</span>
                    executionPolicy<span class="token punctuation">.</span><span class="token function">createExecutionSchedule</span><span class="token punctuation">(</span>stageExecutions<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    stageSchedulers<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token class-name">ImmutableMap</span><span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>stageExecutions<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    dynamicFilterService<span class="token punctuation">)</span><span class="token punctuation">;</span>
            distributedStagesScheduler<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> distributedStagesScheduler<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">/**
         * 为每一个PlanFragment计算bucketToPartition的映射关系。
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token class-name">PlanFragmentId</span><span class="token punctuation">,</span> <span class="token class-name">Optional</span><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;&gt;</span> <span class="token function">createBucketToPartitionMap</span><span class="token punctuation">(</span>
                <span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token class-name">PlanFragmentId</span><span class="token punctuation">,</span> <span class="token class-name">Optional</span><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;&gt;</span> bucketToPartitionForStagesConsumedByCoordinator<span class="token punctuation">,</span>
                <span class="token class-name">StageManager</span> stageManager<span class="token punctuation">,</span>
                <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PartitioningHandle</span><span class="token punctuation">,</span> <span class="token class-name">NodePartitionMap</span><span class="token punctuation">&gt;</span></span> partitioningCache<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">ImmutableMap<span class="token punctuation">.</span>Builder</span><span class="token operator">&lt;</span><span class="token class-name">PlanFragmentId</span><span class="token punctuation">,</span> <span class="token class-name">Optional</span><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;&gt;</span> result <span class="token operator">=</span> <span class="token class-name">ImmutableMap</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 忽略，只有在Coordinator上调度时，才会有值</span>
            result<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>bucketToPartitionForStagesConsumedByCoordinator<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SqlStage</span> stage <span class="token operator">:</span> stageManager<span class="token punctuation">.</span><span class="token function">getDistributedStagesInTopologicalOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">PlanFragment</span> fragment <span class="token operator">=</span> stage<span class="token punctuation">.</span><span class="token function">getFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// </span>
                <span class="token class-name">Optional</span><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> bucketToPartition <span class="token operator">=</span> <span class="token function">getBucketToPartition</span><span class="token punctuation">(</span>fragment<span class="token punctuation">.</span><span class="token function">getPartitioning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> partitioningCache<span class="token punctuation">,</span> fragment<span class="token punctuation">.</span><span class="token function">getRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fragment<span class="token punctuation">.</span><span class="token function">getRemoteSourceNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SqlStage</span> childStage <span class="token operator">:</span> stageManager<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span>stage<span class="token punctuation">.</span><span class="token function">getStageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>childStage<span class="token punctuation">.</span><span class="token function">getFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bucketToPartition<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Optional</span><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token function">getBucketToPartition</span><span class="token punctuation">(</span>
                <span class="token class-name">PartitioningHandle</span> partitioningHandle<span class="token punctuation">,</span>
                <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PartitioningHandle</span><span class="token punctuation">,</span> <span class="token class-name">NodePartitionMap</span><span class="token punctuation">&gt;</span></span> partitioningCache<span class="token punctuation">,</span>
                <span class="token class-name">PlanNode</span> fragmentRoot<span class="token punctuation">,</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RemoteSourceNode</span><span class="token punctuation">&gt;</span></span> remoteSourceNodes<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>partitioningHandle<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token constant">SOURCE_DISTRIBUTION</span><span class="token punctuation">)</span> <span class="token operator">||</span> partitioningHandle<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token constant">SCALED_WRITER_DISTRIBUTION</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// SOURCE_DISTRIBUTION表示一个TableScan算子，而SCALED_WRITER_DISTRIBUTION表示Table Write算子</span>
                <span class="token comment">// 因此这种类型的PlanFragment只会有一个分桶</span>
                <span class="token keyword">return</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">searchFrom</span><span class="token punctuation">(</span>fragmentRoot<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>node <span class="token operator">-&gt;</span> node <span class="token keyword">instanceof</span> <span class="token class-name">TableScanNode</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>remoteSourceNodes<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">allMatch</span><span class="token punctuation">(</span>node <span class="token operator">-&gt;</span> node<span class="token punctuation">.</span><span class="token function">getExchangeType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">REPLICATE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// remote source requires nodePartitionMap</span>
                    <span class="token comment">// remote source类型的算子，需要从上游的PlanFragment读取分区的数据，因此bucket到partition的映射关系，需要</span>
                    <span class="token comment">// 根据绑定的partitioningHandle得到，partitioningCache在之前已经被初始化过了</span>
                    <span class="token class-name">NodePartitionMap</span> nodePartitionMap <span class="token operator">=</span> partitioningCache<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>partitioningHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>nodePartitionMap<span class="token punctuation">.</span><span class="token function">getBucketToPartition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 其它类型，例如ARBITRARY_DISTRIBUTION、FIXED_HASH_DISTRIBUTION等，计算过程同remote source相似</span>
                <span class="token class-name">NodePartitionMap</span> nodePartitionMap <span class="token operator">=</span> partitioningCache<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>partitioningHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InternalNode</span><span class="token punctuation">&gt;</span></span> partitionToNode <span class="token operator">=</span> nodePartitionMap<span class="token punctuation">.</span><span class="token function">getPartitionToNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// todo this should asynchronously wait a standard timeout period before failing</span>
                <span class="token function">checkCondition</span><span class="token punctuation">(</span><span class="token operator">!</span>partitionToNode<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NO_NODES_AVAILABLE</span><span class="token punctuation">,</span> <span class="token string">"No worker nodes available"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>nodePartitionMap<span class="token punctuation">.</span><span class="token function">getBucketToPartition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="NodePartitioningMapbucket__Partition__Node_988"></a>创建NodePartitioningMap实例，维护bucket -&gt; Partition -&gt; Node的映射关系</h5> 
<blockquote> 
 <p>此实例保存了两个重要的数据结构：<br> partitionToNode：Data Partition -&gt; Worker Node的映射集合<br> bucketToPartition：Data Bucket -&gt; Data Partition的映射集合<br> 根据上面两个Map变量，可以做到根据分区键，计算每一个数据行的Bucket ID，就可以知道这一行数据归于哪个Partition，<br> 进而知道应该分布到哪个Worker Node上</p> 
</blockquote> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token class-name">NodePartitionMap</span> <span class="token function">getNodePartitioningMap</span><span class="token punctuation">(</span><span class="token class-name">Session</span> session<span class="token punctuation">,</span> <span class="token class-name">PartitioningHandle</span> partitioningHandle<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">requireNonNull</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> <span class="token string">"session is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">requireNonNull</span><span class="token punctuation">(</span>partitioningHandle<span class="token punctuation">,</span> <span class="token string">"partitioningHandle is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>partitioningHandle<span class="token punctuation">.</span><span class="token function">getConnectorHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">SystemPartitioningHandle</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 返回系统默认的对象</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">SystemPartitioningHandle</span><span class="token punctuation">)</span> partitioningHandle<span class="token punctuation">.</span><span class="token function">getConnectorHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNodePartitionMap</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> nodeScheduler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 获取Connector自己实现的Bucket -&gt; Node的映射集合，Connector可以实现接口，定义buckets的数量，以及构建bucket到worker node映射</span>
        <span class="token comment">// 由于我们讨论的Iceberg Connector，因此会createArbitraryBucketToNode(...)方法得到实例</span>
        <span class="token class-name">ConnectorBucketNodeMap</span> connectorBucketNodeMap <span class="token operator">=</span> <span class="token function">getConnectorBucketNodeMap</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> partitioningHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// safety check for crazy partitioning</span>
        <span class="token function">checkArgument</span><span class="token punctuation">(</span>connectorBucketNodeMap<span class="token punctuation">.</span><span class="token function">getBucketCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1_000_000</span><span class="token punctuation">,</span> <span class="token string">"Too many buckets in partitioning: %s"</span><span class="token punctuation">,</span> connectorBucketNodeMap<span class="token punctuation">.</span><span class="token function">getBucketCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InternalNode</span><span class="token punctuation">&gt;</span></span> bucketToNode<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>connectorBucketNodeMap<span class="token punctuation">.</span><span class="token function">hasFixedMapping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            bucketToNode <span class="token operator">=</span> <span class="token function">getFixedMapping</span><span class="token punctuation">(</span>connectorBucketNodeMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">CatalogName</span> catalogName <span class="token operator">=</span> partitioningHandle<span class="token punctuation">.</span><span class="token function">getConnectorId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"No connector ID for partitioning handle: "</span> <span class="token operator">+</span> partitioningHandle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Create a bucket to node mapping. Consecutive buckets are assigned</span>
            <span class="token comment">// to shuffled nodes (e.g "1 -&gt; node2, 2 -&gt; node1, 3 -&gt; node2, 4 -&gt; node1, ...").</span>
            <span class="token comment">// 这里必然有这样的不等式：buckets的数量 &gt;= 可用的Workers的数量</span>
            <span class="token comment">// Iceberg Connector仅仅定义了buckets数量，没有定义bucket到node映射关系，并且buckets的数量=活跃worker数量</span>
            bucketToNode <span class="token operator">=</span> <span class="token function">createArbitraryBucketToNode</span><span class="token punctuation">(</span>
                    nodeScheduler<span class="token punctuation">.</span><span class="token function">createNodeSelector</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>catalogName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">allNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    connectorBucketNodeMap<span class="token punctuation">.</span><span class="token function">getBucketCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 前面创建了bucket到worker的映射关系，下面就要构建Bucket与Partition的关系</span>
        <span class="token comment">// 创建一个数组，大小为Buckets的数量，同时bucketToPartition[i]存放的是对应的PartitionId</span>
        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bucketToPartition <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>connectorBucketNodeMap<span class="token punctuation">.</span><span class="token function">getBucketCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// BiMap，保证keys和values都各自不重复，也就意味着一个Worker Node唯一对应一个Partition</span>
        <span class="token class-name">BiMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InternalNode</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> nodeToPartition <span class="token operator">=</span> <span class="token class-name">HashBiMap</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> nextPartitionId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 初始值</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> bucket <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> bucket <span class="token operator">&lt;</span> bucketToNode<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> bucket<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">InternalNode</span> node <span class="token operator">=</span> bucketToNode<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// bucketToNode中可能会存在重复的Value，即多个Bucket映射到多个Worker Node</span>
            <span class="token class-name">Integer</span> partitionId <span class="token operator">=</span> nodeToPartition<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>partitionId <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 如果partitionId不存在，即找到了一个新的Worker，那么就递增partitionId</span>
                <span class="token comment">// 不难看出在Trino内部，一个WorkerNode就是一个Partition</span>
                partitionId <span class="token operator">=</span> nextPartitionId<span class="token operator">++</span><span class="token punctuation">;</span>
                nodeToPartition<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> partitionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 记录bucketId到PartitionId的映射</span>
            bucketToPartition<span class="token punctuation">[</span>bucket<span class="token punctuation">]</span> <span class="token operator">=</span> partitionId<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 收集所有的WorkerNode</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InternalNode</span><span class="token punctuation">&gt;</span></span> partitionToNode <span class="token operator">=</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> nodeToPartition<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">mapToObj</span><span class="token punctuation">(</span>partitionId <span class="token operator">-&gt;</span> nodeToPartition<span class="token punctuation">.</span><span class="token function">inverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>partitionId<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token function">toImmutableList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 返回实例</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">NodePartitionMap</span><span class="token punctuation">(</span>partitionToNode<span class="token punctuation">,</span> bucketToPartition<span class="token punctuation">,</span> <span class="token function">getSplitToBucket</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> partitioningHandle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h5><a id="StageSchedulerStage_1052"></a>创建StageScheduler实例，负责一个Stage的调度执行</h5> 
<pre><code class="prism language-java">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">PipelinedDistributedStagesScheduler</span>
            <span class="token keyword">implements</span> <span class="token class-name">DistributedStagesScheduler</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">StageScheduler</span> <span class="token function">createStageScheduler</span><span class="token punctuation">(</span>
                <span class="token class-name">QueryStateMachine</span> queryStateMachine<span class="token punctuation">,</span>
                <span class="token class-name">PipelinedStageExecution</span> stageExecution<span class="token punctuation">,</span>
                <span class="token class-name">SplitSourceFactory</span> splitSourceFactory<span class="token punctuation">,</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PipelinedStageExecution</span><span class="token punctuation">&gt;</span></span> childStageExecutions<span class="token punctuation">,</span>
                <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PartitioningHandle</span><span class="token punctuation">,</span> <span class="token class-name">NodePartitionMap</span><span class="token punctuation">&gt;</span></span> partitioningCache<span class="token punctuation">,</span>
                <span class="token class-name">NodeScheduler</span> nodeScheduler<span class="token punctuation">,</span>
                <span class="token class-name">NodePartitioningManager</span> nodePartitioningManager<span class="token punctuation">,</span>
                <span class="token keyword">int</span> splitBatchSize<span class="token punctuation">,</span>
                <span class="token class-name">DynamicFilterService</span> dynamicFilterService<span class="token punctuation">,</span>
                <span class="token class-name">ScheduledExecutorService</span> executor<span class="token punctuation">,</span>
                <span class="token class-name">TableExecuteContextManager</span> tableExecuteContextManager<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Session</span> session <span class="token operator">=</span> queryStateMachine<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">PlanFragment</span> fragment <span class="token operator">=</span> stageExecution<span class="token punctuation">.</span><span class="token function">getFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">PartitioningHandle</span> partitioningHandle <span class="token operator">=</span> fragment<span class="token punctuation">.</span><span class="token function">getPartitioning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 尝试为当前的Fragment，为每一个TableScanNode创建一个SplitSource实例，用于对数据源的数据进行切分，生成一系列的数据片段。</span>
            <span class="token comment">// 对于Iceberg Connector来说，就是对DataFile进行切分，返回一批IcebergSplit。</span>
            <span class="token comment">// SplitSource的提供的接口的最终调用会代理到IcebergSplitSource。</span>
            <span class="token comment">// 在创建的过程中还会涉及到SplitManager的对象，不过不在这里解析了。</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PlanNodeId</span><span class="token punctuation">,</span> <span class="token class-name">SplitSource</span><span class="token punctuation">&gt;</span></span> splitSources <span class="token operator">=</span> splitSourceFactory<span class="token punctuation">.</span><span class="token function">createSplitSources</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> fragment<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>splitSources<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                queryStateMachine<span class="token punctuation">.</span><span class="token function">addStateChangeListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StateChangeListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Collection</span><span class="token punctuation">&lt;</span><span class="token class-name">SplitSource</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> splitSourcesReference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>splitSources<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">stateChanged</span><span class="token punctuation">(</span><span class="token class-name">QueryState</span> newState<span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>newState<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">// ensure split sources are closed and release memory</span>
                            <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SplitSource</span><span class="token punctuation">&gt;</span></span> sources <span class="token operator">=</span> splitSourcesReference<span class="token punctuation">.</span><span class="token function">getAndSet</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>sources <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token function">closeSplitSources</span><span class="token punctuation">(</span>sources<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>partitioningHandle<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token constant">SOURCE_DISTRIBUTION</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 如果当前PlanFragment的分区类型是SOURCE_DISTRIBUTION，说明这个Fragment是上游的SubPlan，负责从数据源加载数据</span>
                <span class="token comment">// nodes are selected dynamically based on the constraints of the splits and the system load</span>
                <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PlanNodeId</span><span class="token punctuation">,</span> <span class="token class-name">SplitSource</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">=</span> <span class="token function">getOnlyElement</span><span class="token punctuation">(</span>splitSources<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">PlanNodeId</span> planNodeId <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">SplitSource</span> splitSource <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CatalogName</span><span class="token punctuation">&gt;</span></span> catalogName <span class="token operator">=</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>splitSource<span class="token punctuation">.</span><span class="token function">getCatalogName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>catalog <span class="token operator">-&gt;</span> <span class="token operator">!</span><span class="token function">isInternalSystemConnector</span><span class="token punctuation">(</span>catalog<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">NodeSelector</span> nodeSelector <span class="token operator">=</span> nodeScheduler<span class="token punctuation">.</span><span class="token function">createNodeSelector</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> catalogName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// placementPolicy负责根据nodelSelector的实现，为Split分配合适的WorkerNode，</span>
                <span class="token class-name">SplitPlacementPolicy</span> placementPolicy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DynamicSplitPlacementPolicy</span><span class="token punctuation">(</span>nodeSelector<span class="token punctuation">,</span> stageExecution<span class="token operator">::</span><span class="token function">getAllTasks</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token function">checkArgument</span><span class="token punctuation">(</span><span class="token operator">!</span>fragment<span class="token punctuation">.</span><span class="token function">getStageExecutionDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isStageGroupedExecution</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 返回一个封装了SourcePartitionedScheduler实例的对象</span>
                <span class="token keyword">return</span> <span class="token function">newSourcePartitionedSchedulerAsStageScheduler</span><span class="token punctuation">(</span>
                        stageExecution<span class="token punctuation">,</span>
                        planNodeId<span class="token punctuation">,</span>
                        splitSource<span class="token punctuation">,</span>
                        placementPolicy<span class="token punctuation">,</span>
                        splitBatchSize<span class="token punctuation">,</span>
                        dynamicFilterService<span class="token punctuation">,</span>
                        tableExecuteContextManager<span class="token punctuation">,</span>
                        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> childStageExecutions<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">anyMatch</span><span class="token punctuation">(</span><span class="token class-name">PipelinedStageExecution</span><span class="token operator">::</span><span class="token function">isAnyTaskBlocked</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>partitioningHandle<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token constant">SCALED_WRITER_DISTRIBUTION</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// ...</span>
                <span class="token keyword">return</span> scheduler<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 如果不是包含TableScan的PlanFragment，比如是一个JOIN类型的Fragment，它存在如下三种情况</span>
                <span class="token comment">//    left is Source, right is RemoteSource</span>
                <span class="token comment">//    left is RemoteSource, right is RemoteSource</span>
                <span class="token comment">//    left is Source, right is Source</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>splitSources<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// contains local source</span>
                    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PlanNodeId</span><span class="token punctuation">&gt;</span></span> schedulingOrder <span class="token operator">=</span> fragment<span class="token punctuation">.</span><span class="token function">getPartitionedSources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CatalogName</span><span class="token punctuation">&gt;</span></span> catalogName <span class="token operator">=</span> partitioningHandle<span class="token punctuation">.</span><span class="token function">getConnectorId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">checkArgument</span><span class="token punctuation">(</span>catalogName<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"No connector ID for partitioning handle: %s"</span><span class="token punctuation">,</span> partitioningHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConnectorPartitionHandle</span><span class="token punctuation">&gt;</span></span> connectorPartitionHandles<span class="token punctuation">;</span>
                    <span class="token keyword">boolean</span> groupedExecutionForStage <span class="token operator">=</span> fragment<span class="token punctuation">.</span><span class="token function">getStageExecutionDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isStageGroupedExecution</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 如果一个Stage被标记为Grouped，这个Stage必须是被Partitioning了，因此可以等价地认为</span>
                    <span class="token comment">// 一个Group就是一个Bucket，因此这个Group中的Splits都对应同一个Partition，又对应同一个Worker Node</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>groupedExecutionForStage<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        connectorPartitionHandles <span class="token operator">=</span> nodePartitioningManager<span class="token punctuation">.</span><span class="token function">listPartitionHandles</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> partitioningHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">checkState</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">ImmutableList</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token constant">NOT_PARTITIONED</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>connectorPartitionHandles<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// 如果不是分组</span>
                        connectorPartitionHandles <span class="token operator">=</span> <span class="token class-name">ImmutableList</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token constant">NOT_PARTITIONED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token class-name">BucketNodeMap</span> bucketNodeMap<span class="token punctuation">;</span>
                    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InternalNode</span><span class="token punctuation">&gt;</span></span> stageNodeList<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>fragment<span class="token punctuation">.</span><span class="token function">getRemoteSourceNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">allMatch</span><span class="token punctuation">(</span>node <span class="token operator">-&gt;</span> node<span class="token punctuation">.</span><span class="token function">getExchangeType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">REPLICATE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// no remote source</span>
                        <span class="token keyword">boolean</span> dynamicLifespanSchedule <span class="token operator">=</span> fragment<span class="token punctuation">.</span><span class="token function">getStageExecutionDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isDynamicLifespanSchedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        bucketNodeMap <span class="token operator">=</span> nodePartitioningManager<span class="token punctuation">.</span><span class="token function">getBucketNodeMap</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> partitioningHandle<span class="token punctuation">,</span> dynamicLifespanSchedule<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token comment">// verify execution is consistent with planner's decision on dynamic lifespan schedule</span>
                        <span class="token function">verify</span><span class="token punctuation">(</span>bucketNodeMap<span class="token punctuation">.</span><span class="token function">isDynamic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> dynamicLifespanSchedule<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// 如果Fragment仅包含本地的TableScanNode，那么所有可用的Worker结点，都是当前Stage可以被调度执行的结点</span>
                        <span class="token comment">// 因此</span>
                        stageNodeList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>nodeScheduler<span class="token punctuation">.</span><span class="token function">createNodeSelector</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> catalogName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">allNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">shuffle</span><span class="token punctuation">(</span>stageNodeList<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// cannot use dynamic lifespan schedule</span>
                        <span class="token function">verify</span><span class="token punctuation">(</span><span class="token operator">!</span>fragment<span class="token punctuation">.</span><span class="token function">getStageExecutionDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isDynamicLifespanSchedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token comment">// remote source requires nodePartitionMap</span>
                        <span class="token class-name">NodePartitionMap</span> nodePartitionMap <span class="token operator">=</span> partitioningCache<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>partitioningHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>groupedExecutionForStage<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">// 如果是Grouped Stage，则需要M个不同的ConnectorPartitionHandle实例，用来计算BucketID，</span>
                            <span class="token comment">// 同时M == Buckets的数量，才能保存每一个BucketId都对应不同的分区。</span>
                            <span class="token function">checkState</span><span class="token punctuation">(</span>connectorPartitionHandles<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> nodePartitionMap<span class="token punctuation">.</span><span class="token function">getBucketToPartition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        stageNodeList <span class="token operator">=</span> nodePartitionMap<span class="token punctuation">.</span><span class="token function">getPartitionToNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        bucketNodeMap <span class="token operator">=</span> nodePartitionMap<span class="token punctuation">.</span><span class="token function">asBucketNodeMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// 在这种情况下，Buckets的数量是固定的，因此数据源的分区数量也是固定的，因此创建FixedSourcePartitionedScheduler实例</span>
                    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FixedSourcePartitionedScheduler</span><span class="token punctuation">(</span>
                            stageExecution<span class="token punctuation">,</span>
                            splitSources<span class="token punctuation">,</span>
                            fragment<span class="token punctuation">.</span><span class="token function">getStageExecutionDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            schedulingOrder<span class="token punctuation">,</span>
                            stageNodeList<span class="token punctuation">,</span>
                            bucketNodeMap<span class="token punctuation">,</span>
                            splitBatchSize<span class="token punctuation">,</span>
                            <span class="token function">getConcurrentLifespansPerNode</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">,</span>
                            nodeScheduler<span class="token punctuation">.</span><span class="token function">createNodeSelector</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> catalogName<span class="token punctuation">)</span><span class="token punctuation">,</span>
                            connectorPartitionHandles<span class="token punctuation">,</span>
                            dynamicFilterService<span class="token punctuation">,</span>
                            tableExecuteContextManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// all sources are remote</span>
                    <span class="token comment">// 如果都是RemoteSources Plan Node，即要读取的数据来自上游的OutputBufers，</span>
                    <span class="token comment">// 因此这里Partitions的数量，取决于上游，为当前的Stage创建分区任务的数量也是确定的</span>
                    <span class="token comment">// 例如当Buckets数量 == Partitions数量 == Node数量时，同一个Stage的不同分区上的任务，会发送到不同的WorkerNode；</span>
                    <span class="token comment">// 但如果Buckets数量多于node数量，一个Stage的多个分区可能会同时运行在一个Node上面</span>
                    <span class="token class-name">NodePartitionMap</span> nodePartitionMap <span class="token operator">=</span> partitioningCache<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>partitioningHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InternalNode</span><span class="token punctuation">&gt;</span></span> partitionToNode <span class="token operator">=</span> nodePartitionMap<span class="token punctuation">.</span><span class="token function">getPartitionToNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// todo this should asynchronously wait a standard timeout period before failing</span>
                    <span class="token function">checkCondition</span><span class="token punctuation">(</span><span class="token operator">!</span>partitionToNode<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NO_NODES_AVAILABLE</span><span class="token punctuation">,</span> <span class="token string">"No worker nodes available"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FixedCountScheduler</span><span class="token punctuation">(</span>stageExecution<span class="token punctuation">,</span> partitionToNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="DistributedStagesScheduler_1206"></a>DistributedStagesScheduler的调度</h4> 
<pre><code class="prism language-java">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">PipelinedDistributedStagesScheduler</span>
            <span class="token keyword">implements</span> <span class="token class-name">DistributedStagesScheduler</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 调度开始</span>
            <span class="token function">checkState</span><span class="token punctuation">(</span>started<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"already started"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">SetThreadName</span> ignored <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SetThreadName</span><span class="token punctuation">(</span><span class="token string">"Query-%s"</span><span class="token punctuation">,</span> queryStateMachine<span class="token punctuation">.</span><span class="token function">getQueryId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>executionSchedule<span class="token punctuation">.</span><span class="token function">isFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ListenableFuture</span><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> blockedStages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 获取要调度的Stages，默认配置下，会调度所有的Stages运行，而不考虑Stages之间的依赖</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">PipelinedStageExecution</span> stageExecution <span class="token operator">:</span> executionSchedule<span class="token punctuation">.</span><span class="token function">getStagesToSchedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// 由StageExecution实例代理调度绑定的Stage执行</span>
                        stageExecution<span class="token punctuation">.</span><span class="token function">beginScheduling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token comment">// perform some scheduling work，异步</span>
                        <span class="token class-name">ScheduleResult</span> result <span class="token operator">=</span> stageSchedulers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>stageExecution<span class="token punctuation">.</span><span class="token function">getStageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token comment">// modify parent and children based on the results of the scheduling</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">isFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">// 如果Stage完成了，那么就设置完成状态</span>
                            stageExecution<span class="token punctuation">.</span><span class="token function">schedulingComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span><span class="token function">getBlocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">// 如果Stage的状态为BLOCKED，可能是由于前置Stage还没有数据输出</span>
                            blockedStages<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getBlocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        schedulerStats<span class="token punctuation">.</span><span class="token function">getSplitsScheduledPerIteration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getSplitsScheduled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getBlockedReason</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">switch</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getBlockedReason</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token keyword">case</span> <span class="token constant">WRITER_SCALING</span><span class="token operator">:</span>
                                    <span class="token comment">// no-op</span>
                                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                                <span class="token keyword">case</span> <span class="token constant">WAITING_FOR_SOURCE</span><span class="token operator">:</span>
                                    schedulerStats<span class="token punctuation">.</span><span class="token function">getWaitingForSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                                <span class="token keyword">case</span> <span class="token constant">SPLIT_QUEUES_FULL</span><span class="token operator">:</span>
                                    schedulerStats<span class="token punctuation">.</span><span class="token function">getSplitQueuesFull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                                <span class="token keyword">case</span> <span class="token constant">MIXED_SPLIT_QUEUES_FULL_AND_WAITING_FOR_SOURCE</span><span class="token operator">:</span>
                                <span class="token keyword">case</span> <span class="token constant">NO_ACTIVE_DRIVER_GROUP</span><span class="token operator">:</span>
                                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                                <span class="token keyword">default</span><span class="token operator">:</span>
                                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token string">"Unknown blocked reason: "</span> <span class="token operator">+</span> result<span class="token punctuation">.</span><span class="token function">getBlockedReason</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>

                    <span class="token comment">// wait for a state change and then schedule again，如果还有被BLOCKED的Stage，则需要进行超时检测</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>blockedStages<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">TimeStat<span class="token punctuation">.</span>BlockTimer</span> timer <span class="token operator">=</span> schedulerStats<span class="token punctuation">.</span><span class="token function">getSleepTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token function">tryGetFutureValue</span><span class="token punctuation">(</span><span class="token function">whenAnyComplete</span><span class="token punctuation">(</span>blockedStages<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ListenableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> blockedStage <span class="token operator">:</span> blockedStages<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            blockedStage<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">PipelinedStageExecution</span> stageExecution <span class="token operator">:</span> stageExecutions<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">PipelinedStageExecution<span class="token punctuation">.</span>State</span> state <span class="token operator">=</span> stageExecution<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">!=</span> <span class="token constant">SCHEDULED</span> <span class="token operator">&amp;&amp;</span> state <span class="token operator">!=</span> <span class="token constant">RUNNING</span> <span class="token operator">&amp;&amp;</span> state <span class="token operator">!=</span> <span class="token constant">FLUSHING</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>state<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TrinoException</span><span class="token punctuation">(</span><span class="token constant">GENERIC_INTERNAL_ERROR</span><span class="token punctuation">,</span> <span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"Scheduling is complete, but stage %s is in state %s"</span><span class="token punctuation">,</span> stageExecution<span class="token punctuation">.</span><span class="token function">getStageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">fail</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">RuntimeException</span> closeError <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">StageScheduler</span> scheduler <span class="token operator">:</span> stageSchedulers<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                        scheduler<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token function">fail</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// Self-suppression not permitted</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>closeError <span class="token operator">!=</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            closeError<span class="token punctuation">.</span><span class="token function">addSuppressed</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="FixedSourcePartitionedSchedulerschedule_1299"></a>FixedSourcePartitionedScheduler::schedule()</h4> 
<blockquote> 
 <p>GROUP_WIDE，Split的Life Cycle为Task Group级别，只会由中继Stage/PlanFragment的产生，其对应的Split用于读取上游已经被Partitioned的数据（因此可以简单地认为一个Group，就是一个Data Partition）。当有多个SourceScheduler调度Splits时，同一个Source上<br> 的调度策略是按GroupId顺序高度，且同一个时刻只能调度一个Group的Splits执行；而其它SourceScheduler可以并行地调度不同的Group。</p> 
 <p>TASK_WIDE，Split的Life Cycle为Task级别，可以先简单地认为就是Table Scan Stage执行时的Split的LifeCycle。每一个SourceScheduler之间互相不影响，只看当前SqlTask的剩余资源来决定是否要调度新的Splits。</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FixedSourcePartitionedScheduler</span>
        <span class="token keyword">implements</span> <span class="token class-name">StageScheduler</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ScheduleResult</span> <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// schedule a task on every node in the distribution</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RemoteTask</span><span class="token punctuation">&gt;</span></span> newTasks <span class="token operator">=</span> <span class="token class-name">ImmutableList</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>scheduledTasks<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 如果这个Stage还没有调度过任务，就为所有的分区创建RemoteTask任务</span>
            <span class="token class-name">ImmutableList<span class="token punctuation">.</span>Builder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RemoteTask</span><span class="token punctuation">&gt;</span></span> newTasksBuilder <span class="token operator">=</span> <span class="token class-name">ImmutableList</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">InternalNode</span> node <span class="token operator">:</span> nodes<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 遍历当前Stage所有可用的Worker Nodes</span>
                <span class="token comment">// 一个Node，就对应唯一一个分区</span>
                <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RemoteTask</span><span class="token punctuation">&gt;</span></span> task <span class="token operator">=</span> stageExecution<span class="token punctuation">.</span><span class="token function">scheduleTask</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> partitionIdAllocator<span class="token punctuation">.</span><span class="token function">getNextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ImmutableMultimap</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ImmutableMultimap</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    scheduledTasks<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> task<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    newTasksBuilder<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            newTasks <span class="token operator">=</span> newTasksBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">boolean</span> allBlocked <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ListenableFuture</span><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> blocked <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BlockedReason</span> blockedReason <span class="token operator">=</span> <span class="token class-name">BlockedReason</span><span class="token punctuation">.</span><span class="token constant">NO_ACTIVE_DRIVER_GROUP</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>groupedLifespanScheduler<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Start new driver groups on the first scheduler if necessary,</span>
            <span class="token comment">// i.e. when previous ones have finished execution (not finished scheduling).</span>
            <span class="token comment">//</span>
            <span class="token comment">// Invoke schedule method to get a new SettableFuture every time.</span>
            <span class="token comment">// Reusing previously returned SettableFuture could lead to the ListenableFuture retaining too many listeners.</span>
            blocked<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>groupedLifespanScheduler<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span>sourceSchedulers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">int</span> splitsScheduled <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">// SourceSchedulers保存了每一个Source的调度器实例，即SourcePartitionedScheduler实例，它们负责调度各自的Splits</span>
        <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SourceScheduler</span><span class="token punctuation">&gt;</span></span> schedulerIterator <span class="token operator">=</span> sourceSchedulers<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Lifespan</span><span class="token punctuation">&gt;</span></span> driverGroupsToStart <span class="token operator">=</span> <span class="token class-name">ImmutableList</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> shouldInvokeNoMoreDriverGroups <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>schedulerIterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">SourceScheduler</span> sourceScheduler <span class="token operator">=</span> schedulerIterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 如果是分组调度，意味着底层调度Splits的策略是按分组来的，只有当一个SourceScheduler某个分组的Splits调度完成了，</span>
            <span class="token comment">// 下一个SourceScheduler才能调度相应分组的Splits，而其它的分组被BLOCKED，真正第一个SourceScheduler又完成有其它分组上的调度</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Lifespan</span> lifespan <span class="token operator">:</span> driverGroupsToStart<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                sourceScheduler<span class="token punctuation">.</span><span class="token function">startLifespan</span><span class="token punctuation">(</span>lifespan<span class="token punctuation">,</span> <span class="token function">partitionHandleFor</span><span class="token punctuation">(</span>lifespan<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldInvokeNoMoreDriverGroups<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                sourceScheduler<span class="token punctuation">.</span><span class="token function">noMoreLifespans</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 调用FixedSourcePartitionedScheduler::schedule()方法</span>
            <span class="token class-name">ScheduleResult</span> schedule <span class="token operator">=</span> sourceScheduler<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 累加当前Stage总共调度的Splits数量</span>
            splitsScheduled <span class="token operator">+=</span> schedule<span class="token punctuation">.</span><span class="token function">getSplitsScheduled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>schedule<span class="token punctuation">.</span><span class="token function">getBlockedReason</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                blocked<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>schedule<span class="token punctuation">.</span><span class="token function">getBlocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                blockedReason <span class="token operator">=</span> blockedReason<span class="token punctuation">.</span><span class="token function">combineWith</span><span class="token punctuation">(</span>schedule<span class="token punctuation">.</span><span class="token function">getBlockedReason</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">verify</span><span class="token punctuation">(</span>schedule<span class="token punctuation">.</span><span class="token function">getBlocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"blockedReason not provided when scheduler is blocked"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                allBlocked <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 如果SourceScheduler instanceOf AsGroupedSourceScheduler，那么drainCompletedLifespans()方法总是会返回对应的LifeSpan对象</span>
            driverGroupsToStart <span class="token operator">=</span> sourceScheduler<span class="token punctuation">.</span><span class="token function">drainCompletedLifespans</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>schedule<span class="token punctuation">.</span><span class="token function">isFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                stageExecution<span class="token punctuation">.</span><span class="token function">schedulingComplete</span><span class="token punctuation">(</span>sourceScheduler<span class="token punctuation">.</span><span class="token function">getPlanNodeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                schedulerIterator<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                sourceScheduler<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                shouldInvokeNoMoreDriverGroups <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                shouldInvokeNoMoreDriverGroups <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>allBlocked<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 如果所有的SourcePartitionedScheduler被BLOCKED了，那么就返回Blocked信息</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ScheduleResult</span><span class="token punctuation">(</span>sourceSchedulers<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> newTasks<span class="token punctuation">,</span> <span class="token function">whenAnyComplete</span><span class="token punctuation">(</span>blocked<span class="token punctuation">)</span><span class="token punctuation">,</span> blockedReason<span class="token punctuation">,</span> splitsScheduled<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 有正在运行的SourcePartitionedScheduler，就返回已经调度的Splits信息</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ScheduleResult</span><span class="token punctuation">(</span>sourceSchedulers<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> newTasks<span class="token punctuation">,</span> splitsScheduled<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="SourcePartitionedSchedulerschedule_1392"></a>SourcePartitionedScheduler::schedule()</h5> 
<blockquote> 
 <p>最底层的Splits调度器，负责调度、执行SOURCE类型的Stage。</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SourcePartitionedScheduler</span>
        <span class="token keyword">implements</span> <span class="token class-name">SourceScheduler</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token class-name">ScheduleResult</span> <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">dropListenersFromWhenFinishedOrNewLifespansAdded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> overallSplitAssignmentCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token class-name">ImmutableSet<span class="token punctuation">.</span>Builder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RemoteTask</span><span class="token punctuation">&gt;</span></span> overallNewTasks <span class="token operator">=</span> <span class="token class-name">ImmutableSet</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ListenableFuture</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> overallBlockedFutures <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> anyBlockedOnPlacements <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> anyBlockedOnNextSplitBatch <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> anyNotBlocked <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">// 遍历每一个ScheduleGroup实例，一个ScheduleGroup对应了</span>
        <span class="token comment">// </span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Lifespan</span><span class="token punctuation">,</span> <span class="token class-name">ScheduleGroup</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> scheduleGroups<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Lifespan</span> lifespan <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ScheduleGroup</span> scheduleGroup <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Split</span><span class="token punctuation">&gt;</span></span> pendingSplits <span class="token operator">=</span> scheduleGroup<span class="token punctuation">.</span>pendingSplits<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>scheduleGroup<span class="token punctuation">.</span>state <span class="token operator">==</span> <span class="token class-name">ScheduleGroupState</span><span class="token punctuation">.</span><span class="token constant">NO_MORE_SPLITS</span> <span class="token operator">||</span> scheduleGroup<span class="token punctuation">.</span>state <span class="token operator">==</span> <span class="token class-name">ScheduleGroupState</span><span class="token punctuation">.</span><span class="token constant">DONE</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">verify</span><span class="token punctuation">(</span>scheduleGroup<span class="token punctuation">.</span>nextSplitBatchFuture <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingSplits<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// try to get the next batch</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>scheduleGroup<span class="token punctuation">.</span>nextSplitBatchFuture <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 实际上是通过IcebergConnectorSplitSource获取下一批要调度处理的Splits，</span>
                    <span class="token comment">// 注意通过splitBatchSize - pendingSplits.size()限制了最大被调度的Splits数量</span>
                    scheduleGroup<span class="token punctuation">.</span>nextSplitBatchFuture <span class="token operator">=</span> splitSource<span class="token punctuation">.</span><span class="token function">getNextBatch</span><span class="token punctuation">(</span>scheduleGroup<span class="token punctuation">.</span>partitionHandle<span class="token punctuation">,</span> lifespan<span class="token punctuation">,</span> splitBatchSize <span class="token operator">-</span> pendingSplits<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">addSuccessCallback</span><span class="token punctuation">(</span>scheduleGroup<span class="token punctuation">.</span>nextSplitBatchFuture<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> stageExecution<span class="token punctuation">.</span><span class="token function">recordGetSplitTime</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>scheduleGroup<span class="token punctuation">.</span>nextSplitBatchFuture<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 如果nextSplitBatchFuture完成，意味着拿到了Splits实例，因此就可以立即调度了</span>
                    <span class="token class-name">SplitBatch</span> nextSplits <span class="token operator">=</span> <span class="token function">getFutureValue</span><span class="token punctuation">(</span>scheduleGroup<span class="token punctuation">.</span>nextSplitBatchFuture<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    scheduleGroup<span class="token punctuation">.</span>nextSplitBatchFuture <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token comment">// 将所有的Splits添加到等待队列中</span>
                    pendingSplits<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>nextSplits<span class="token punctuation">.</span><span class="token function">getSplits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextSplits<span class="token punctuation">.</span><span class="token function">isLastBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// 如果是最后一批要调度的Splits，则追加一个EmptySplit的实例，以便通知Worker Node上的SqlTask任务停止运行</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>scheduleGroup<span class="token punctuation">.</span>state <span class="token operator">==</span> <span class="token class-name">ScheduleGroupState</span><span class="token punctuation">.</span><span class="token constant">INITIALIZED</span> <span class="token operator">&amp;&amp;</span> pendingSplits<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">// Add an empty split in case no splits have been produced for the source.</span>
                            <span class="token comment">// For source operators, they never take input, but they may produce output.</span>
                            <span class="token comment">// This is well handled by the execution engine.</span>
                            <span class="token comment">// However, there are certain non-source operators that may produce output without any input,</span>
                            <span class="token comment">// for example, 1) an AggregationOperator, 2) a HashAggregationOperator where one of the grouping sets is ().</span>
                            <span class="token comment">// Scheduling an empty split kicks off necessary driver instantiation to make this work.</span>
                            pendingSplits<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Split</span><span class="token punctuation">(</span>
                                    splitSource<span class="token punctuation">.</span><span class="token function">getCatalogName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                    <span class="token keyword">new</span> <span class="token class-name">EmptySplit</span><span class="token punctuation">(</span>splitSource<span class="token punctuation">.</span><span class="token function">getCatalogName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                    lifespan<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment">// 通知当前的SourceScheduler，不需要再调度了</span>
                        scheduleGroup<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token class-name">ScheduleGroupState</span><span class="token punctuation">.</span><span class="token constant">NO_MORE_SPLITS</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    overallBlockedFutures<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>scheduleGroup<span class="token punctuation">.</span>nextSplitBatchFuture<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    anyBlockedOnNextSplitBatch <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">Multimap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InternalNode</span><span class="token punctuation">,</span> <span class="token class-name">Split</span><span class="token punctuation">&gt;</span></span> splitAssignment <span class="token operator">=</span> <span class="token class-name">ImmutableMultimap</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pendingSplits<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>scheduleGroup<span class="token punctuation">.</span>placementFuture<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    anyBlockedOnPlacements <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>scheduleGroup<span class="token punctuation">.</span>state <span class="token operator">==</span> <span class="token class-name">ScheduleGroupState</span><span class="token punctuation">.</span><span class="token constant">INITIALIZED</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    scheduleGroup<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token class-name">ScheduleGroupState</span><span class="token punctuation">.</span><span class="token constant">SPLITS_ADDED</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> <span class="token class-name">State</span><span class="token punctuation">.</span><span class="token constant">INITIALIZED</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    state <span class="token operator">=</span> <span class="token class-name">State</span><span class="token punctuation">.</span><span class="token constant">SPLITS_ADDED</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// calculate placements for splits，为每一个Split计算应该被分发到哪个Worker Node</span>
                <span class="token class-name">SplitPlacementResult</span> splitPlacementResult <span class="token operator">=</span> splitPlacementPolicy<span class="token punctuation">.</span><span class="token function">computeAssignments</span><span class="token punctuation">(</span>pendingSplits<span class="token punctuation">)</span><span class="token punctuation">;</span>
                splitAssignment <span class="token operator">=</span> splitPlacementResult<span class="token punctuation">.</span><span class="token function">getAssignments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// remove splits with successful placements</span>
                splitAssignment<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>pendingSplits<span class="token operator">::</span><span class="token function">remove</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// AbstractSet.removeAll performs terribly here.</span>
                overallSplitAssignmentCount <span class="token operator">+=</span> splitAssignment<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// if not completed placed, mark scheduleGroup as blocked on placement</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pendingSplits<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    scheduleGroup<span class="token punctuation">.</span>placementFuture <span class="token operator">=</span> splitPlacementResult<span class="token punctuation">.</span><span class="token function">getBlocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    overallBlockedFutures<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>scheduleGroup<span class="token punctuation">.</span>placementFuture<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    anyBlockedOnPlacements <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// if no new splits will be assigned, update state and attach completion event</span>
            <span class="token class-name">Multimap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InternalNode</span><span class="token punctuation">,</span> <span class="token class-name">Lifespan</span><span class="token punctuation">&gt;</span></span> noMoreSplitsNotification <span class="token operator">=</span> <span class="token class-name">ImmutableMultimap</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingSplits<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> scheduleGroup<span class="token punctuation">.</span>state <span class="token operator">==</span> <span class="token class-name">ScheduleGroupState</span><span class="token punctuation">.</span><span class="token constant">NO_MORE_SPLITS</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                scheduleGroup<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token class-name">ScheduleGroupState</span><span class="token punctuation">.</span><span class="token constant">DONE</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lifespan<span class="token punctuation">.</span><span class="token function">isTaskWide</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">InternalNode</span> node <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">BucketedSplitPlacementPolicy</span><span class="token punctuation">)</span> splitPlacementPolicy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNodeForBucket</span><span class="token punctuation">(</span>lifespan<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    noMoreSplitsNotification <span class="token operator">=</span> <span class="token class-name">ImmutableMultimap</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> lifespan<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// assign the splits with successful placements</span>
            overallNewTasks<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token function">assignSplits</span><span class="token punctuation">(</span>splitAssignment<span class="token punctuation">,</span> noMoreSplitsNotification<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Assert that "placement future is not done" implies "pendingSplits is not empty".</span>
            <span class="token comment">// The other way around is not true. One obvious reason is (un)lucky timing, where the placement is unblocked between `computeAssignments` and this line.</span>
            <span class="token comment">// However, there are other reasons that could lead to this.</span>
            <span class="token comment">// Note that `computeAssignments` is quite broken:</span>
            <span class="token comment">// 1. It always returns a completed future when there are no tasks, regardless of whether all nodes are blocked.</span>
            <span class="token comment">// 2. The returned future will only be completed when a node with an assigned task becomes unblocked. Other nodes don't trigger future completion.</span>
            <span class="token comment">// As a result, to avoid busy loops caused by 1, we check pendingSplits.isEmpty() instead of placementFuture.isDone() here.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>scheduleGroup<span class="token punctuation">.</span>nextSplitBatchFuture <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> scheduleGroup<span class="token punctuation">.</span>pendingSplits<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> scheduleGroup<span class="token punctuation">.</span>state <span class="token operator">!=</span> <span class="token class-name">ScheduleGroupState</span><span class="token punctuation">.</span><span class="token constant">DONE</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                anyNotBlocked <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// * `splitSource.isFinished` invocation may fail after `splitSource.close` has been invoked.</span>
        <span class="token comment">//   If state is NO_MORE_SPLITS/FINISHED, splitSource.isFinished has previously returned true, and splitSource is closed now.</span>
        <span class="token comment">// * Even if `splitSource.isFinished()` return true, it is not necessarily safe to tear down the split source.</span>
        <span class="token comment">//   * If anyBlockedOnNextSplitBatch is true, it means we have not checked out the recently completed nextSplitBatch futures,</span>
        <span class="token comment">//     which may contain recently published splits. We must not ignore those.</span>
        <span class="token comment">//   * If any scheduleGroup is still in DISCOVERING_SPLITS state, it means it hasn't realized that there will be no more splits.</span>
        <span class="token comment">//     Next time it invokes getNextBatch, it will realize that. However, the invocation will fail we tear down splitSource now.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>state <span class="token operator">==</span> <span class="token class-name">State</span><span class="token punctuation">.</span><span class="token constant">NO_MORE_SPLITS</span> <span class="token operator">||</span> state <span class="token operator">==</span> <span class="token class-name">State</span><span class="token punctuation">.</span><span class="token constant">FINISHED</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>noMoreScheduleGroups <span class="token operator">&amp;&amp;</span> scheduleGroups<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> splitSource<span class="token punctuation">.</span><span class="token function">isFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">case</span> <span class="token constant">INITIALIZED</span><span class="token operator">:</span>
                    <span class="token comment">// We have not scheduled a single split so far.</span>
                    <span class="token comment">// But this shouldn't be possible. See usage of EmptySplit in this method.</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"At least 1 split should have been scheduled for this plan node"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token constant">SPLITS_ADDED</span><span class="token operator">:</span>
                    state <span class="token operator">=</span> <span class="token class-name">State</span><span class="token punctuation">.</span><span class="token constant">NO_MORE_SPLITS</span><span class="token punctuation">;</span>

                    <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> tableExecuteSplitsInfo <span class="token operator">=</span> splitSource<span class="token punctuation">.</span><span class="token function">getTableExecuteSplitsInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// Here we assume that we can get non-empty tableExecuteSplitsInfo only for queries which facilitate single split source.</span>
                    <span class="token comment">// TODO support grouped execution</span>
                    tableExecuteSplitsInfo<span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span>info <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token class-name">TableExecuteContext</span> tableExecuteContext <span class="token operator">=</span> tableExecuteContextManager<span class="token punctuation">.</span><span class="token function">getTableExecuteContextForQuery</span><span class="token punctuation">(</span>stageExecution<span class="token punctuation">.</span><span class="token function">getStageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueryId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        tableExecuteContext<span class="token punctuation">.</span><span class="token function">setSplitsInfo</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    splitSource<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// fall through</span>
                <span class="token keyword">case</span> <span class="token constant">NO_MORE_SPLITS</span><span class="token operator">:</span>
                    state <span class="token operator">=</span> <span class="token class-name">State</span><span class="token punctuation">.</span><span class="token constant">FINISHED</span><span class="token punctuation">;</span>
                    whenFinishedOrNewLifespanAdded<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// fall through</span>
                <span class="token keyword">case</span> <span class="token constant">FINISHED</span><span class="token operator">:</span>
                    splitSource<span class="token punctuation">.</span><span class="token function">getMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span>stageExecution<span class="token operator">::</span><span class="token function">updateConnectorMetrics</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ScheduleResult</span><span class="token punctuation">(</span>
                            <span class="token boolean">true</span><span class="token punctuation">,</span>
                            overallNewTasks<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            overallSplitAssignmentCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Unknown state"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>anyNotBlocked<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ScheduleResult</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> overallNewTasks<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> overallSplitAssignmentCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>anyBlockedOnNextSplitBatch
                <span class="token operator">&amp;&amp;</span> scheduledTasks<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> dynamicFilterService<span class="token punctuation">.</span><span class="token function">isCollectingTaskNeeded</span><span class="token punctuation">(</span>stageExecution<span class="token punctuation">.</span><span class="token function">getStageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueryId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stageExecution<span class="token punctuation">.</span><span class="token function">getFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// schedule a task for collecting dynamic filters in case probe split generator is waiting for them</span>
            <span class="token function">createTaskOnRandomNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span>overallNewTasks<span class="token operator">::</span><span class="token function">add</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">boolean</span> anySourceTaskBlocked <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>anySourceTaskBlocked<span class="token punctuation">.</span><span class="token function">getAsBoolean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>anySourceTaskBlocked<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Dynamic filters might not be collected due to build side source tasks being blocked on full buffer.</span>
            <span class="token comment">// In such case probe split generation that is waiting for dynamic filters should be unblocked to prevent deadlock.</span>
            dynamicFilterService<span class="token punctuation">.</span><span class="token function">unblockStageDynamicFilters</span><span class="token punctuation">(</span>stageExecution<span class="token punctuation">.</span><span class="token function">getStageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueryId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stageExecution<span class="token punctuation">.</span><span class="token function">getAttemptId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stageExecution<span class="token punctuation">.</span><span class="token function">getFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>groupedExecution<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            overallNewTasks<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token function">finalizeTaskCreationIfNecessary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>anyBlockedOnPlacements <span class="token operator">&amp;&amp;</span> anySourceTaskBlocked<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// In a broadcast join, output buffers of the tasks in build source stage have to</span>
            <span class="token comment">// hold onto all data produced before probe side task scheduling finishes,</span>
            <span class="token comment">// even if the data is acknowledged by all known consumers. This is because</span>
            <span class="token comment">// new consumers may be added until the probe side task scheduling finishes.</span>
            <span class="token comment">//</span>
            <span class="token comment">// As a result, the following line is necessary to prevent deadlock</span>
            <span class="token comment">// due to neither build nor probe can make any progress.</span>
            <span class="token comment">// The build side blocks due to a full output buffer.</span>
            <span class="token comment">// In the meantime the probe side split cannot be consumed since</span>
            <span class="token comment">// builder side hash table construction has not finished.</span>
            overallNewTasks<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token function">finalizeTaskCreationIfNecessary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">ScheduleResult<span class="token punctuation">.</span>BlockedReason</span> blockedReason<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>anyBlockedOnNextSplitBatch<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            blockedReason <span class="token operator">=</span> anyBlockedOnPlacements <span class="token operator">?</span> <span class="token constant">MIXED_SPLIT_QUEUES_FULL_AND_WAITING_FOR_SOURCE</span> <span class="token operator">:</span> <span class="token constant">WAITING_FOR_SOURCE</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            blockedReason <span class="token operator">=</span> anyBlockedOnPlacements <span class="token operator">?</span> <span class="token constant">SPLIT_QUEUES_FULL</span> <span class="token operator">:</span> <span class="token constant">NO_ACTIVE_DRIVER_GROUP</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        overallBlockedFutures<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>whenFinishedOrNewLifespanAdded<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ScheduleResult</span><span class="token punctuation">(</span>
                <span class="token boolean">false</span><span class="token punctuation">,</span>
                overallNewTasks<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">nonCancellationPropagating</span><span class="token punctuation">(</span><span class="token function">asVoid</span><span class="token punctuation">(</span><span class="token function">whenAnyComplete</span><span class="token punctuation">(</span>overallBlockedFutures<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                blockedReason<span class="token punctuation">,</span>
                overallSplitAssignmentCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="SqlTask_1612"></a>SqlTask的创建</h3> 
<blockquote> 
 <p>SqlTask，运行在Worker Node上，每一个SqlTask对应 一个Stage中的一个分区，它负责处理这个分区上的所有Splits。<br> 客户端通过<code>/v1/task/{taskId}</code>，请求对应的Worker Node创建相应的任务实例。</p> 
</blockquote> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@ResourceSecurity</span><span class="token punctuation">(</span><span class="token constant">INTERNAL_ONLY</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@POST</span>
    <span class="token annotation punctuation">@Path</span><span class="token punctuation">(</span><span class="token string">"{taskId}"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Consumes</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_JSON</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Produces</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_JSON</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createOrUpdateTask</span><span class="token punctuation">(</span>
            <span class="token annotation punctuation">@PathParam</span><span class="token punctuation">(</span><span class="token string">"taskId"</span><span class="token punctuation">)</span> <span class="token class-name">TaskId</span> taskId<span class="token punctuation">,</span>
            <span class="token class-name">TaskUpdateRequest</span> taskUpdateRequest<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Context</span> <span class="token class-name">UriInfo</span> uriInfo<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Suspended</span> <span class="token class-name">AsyncResponse</span> asyncResponse<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">requireNonNull</span><span class="token punctuation">(</span>taskUpdateRequest<span class="token punctuation">,</span> <span class="token string">"taskUpdateRequest is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Session</span> session <span class="token operator">=</span> taskUpdateRequest<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toSession</span><span class="token punctuation">(</span>sessionPropertyManager<span class="token punctuation">,</span> taskUpdateRequest<span class="token punctuation">.</span><span class="token function">getExtraCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">injectFailure</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span><span class="token function">getTraceToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> taskId<span class="token punctuation">,</span> <span class="token class-name">RequestType</span><span class="token punctuation">.</span><span class="token constant">CREATE_OR_UPDATE_TASK</span><span class="token punctuation">,</span> asyncResponse<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 创建任务</span>
        <span class="token class-name">TaskInfo</span> taskInfo <span class="token operator">=</span> taskManager<span class="token punctuation">.</span><span class="token function">updateTask</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span>
                taskId<span class="token punctuation">,</span>
                taskUpdateRequest<span class="token punctuation">.</span><span class="token function">getFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                taskUpdateRequest<span class="token punctuation">.</span><span class="token function">getSources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                taskUpdateRequest<span class="token punctuation">.</span><span class="token function">getOutputIds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                taskUpdateRequest<span class="token punctuation">.</span><span class="token function">getDynamicFilterDomains</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldSummarize</span><span class="token punctuation">(</span>uriInfo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            taskInfo <span class="token operator">=</span> taskInfo<span class="token punctuation">.</span><span class="token function">summarize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        asyncResponse<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entity</span><span class="token punctuation">(</span>taskInfo<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="SqlTaskManagerupdateTask_1650"></a>SqlTaskManager::updateTask</h4> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SqlTaskManager</span>
        <span class="token keyword">implements</span> <span class="token class-name">TaskManager</span><span class="token punctuation">,</span> <span class="token class-name">Closeable</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">LoadingCache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TaskId</span><span class="token punctuation">,</span> <span class="token class-name">SqlTask</span><span class="token punctuation">&gt;</span></span> tasks <span class="token operator">=</span> <span class="token class-name">CacheBuilder</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">CacheLoader</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>
                taskId <span class="token operator">-&gt;</span> <span class="token function">createSqlTask</span><span class="token punctuation">(</span>
                        taskId<span class="token punctuation">,</span>
                        locationFactory<span class="token punctuation">.</span><span class="token function">createLocalTaskLocation</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        nodeInfo<span class="token punctuation">.</span><span class="token function">getNodeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        queryContexts<span class="token punctuation">.</span><span class="token function">getUnchecked</span><span class="token punctuation">(</span>taskId<span class="token punctuation">.</span><span class="token function">getQueryId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        sqlTaskExecutionFactory<span class="token punctuation">,</span>
                        taskNotificationExecutor<span class="token punctuation">,</span>
                        sqlTask <span class="token operator">-&gt;</span> finishedTaskStats<span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span>sqlTask<span class="token punctuation">.</span><span class="token function">getIoStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        maxBufferSize<span class="token punctuation">,</span>
                        maxBroadcastBufferSize<span class="token punctuation">,</span>
                        failedTasks<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">TaskInfo</span> <span class="token function">updateTask</span><span class="token punctuation">(</span>
            <span class="token class-name">Session</span> session<span class="token punctuation">,</span>
            <span class="token class-name">TaskId</span> taskId<span class="token punctuation">,</span>
            <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PlanFragment</span><span class="token punctuation">&gt;</span></span> fragment<span class="token punctuation">,</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TaskSource</span><span class="token punctuation">&gt;</span></span> sources<span class="token punctuation">,</span>
            <span class="token class-name">OutputBuffers</span> outputBuffers<span class="token punctuation">,</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DynamicFilterId</span><span class="token punctuation">,</span> <span class="token class-name">Domain</span><span class="token punctuation">&gt;</span></span> dynamicFilterDomains<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> versionEmbedder<span class="token punctuation">.</span><span class="token function">embedVersion</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">doUpdateTask</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> taskId<span class="token punctuation">,</span> fragment<span class="token punctuation">,</span> sources<span class="token punctuation">,</span> outputBuffers<span class="token punctuation">,</span> dynamicFilterDomains<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">throwIfUnchecked</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// impossible, doUpdateTask does not throw checked exceptions</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">TaskInfo</span> <span class="token function">doUpdateTask</span><span class="token punctuation">(</span>
            <span class="token class-name">Session</span> session<span class="token punctuation">,</span>
            <span class="token class-name">TaskId</span> taskId<span class="token punctuation">,</span>
            <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PlanFragment</span><span class="token punctuation">&gt;</span></span> fragment<span class="token punctuation">,</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TaskSource</span><span class="token punctuation">&gt;</span></span> sources<span class="token punctuation">,</span>
            <span class="token class-name">OutputBuffers</span> outputBuffers<span class="token punctuation">,</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DynamicFilterId</span><span class="token punctuation">,</span> <span class="token class-name">Domain</span><span class="token punctuation">&gt;</span></span> dynamicFilterDomains<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">requireNonNull</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> <span class="token string">"session is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">requireNonNull</span><span class="token punctuation">(</span>taskId<span class="token punctuation">,</span> <span class="token string">"taskId is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">requireNonNull</span><span class="token punctuation">(</span>fragment<span class="token punctuation">,</span> <span class="token string">"fragment is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">requireNonNull</span><span class="token punctuation">(</span>sources<span class="token punctuation">,</span> <span class="token string">"sources is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">requireNonNull</span><span class="token punctuation">(</span>outputBuffers<span class="token punctuation">,</span> <span class="token string">"outputBuffers is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">SqlTask</span> sqlTask <span class="token operator">=</span> tasks<span class="token punctuation">.</span><span class="token function">getUnchecked</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建一个新的SqlTask实例</span>
        <span class="token class-name">QueryContext</span> queryContext <span class="token operator">=</span> sqlTask<span class="token punctuation">.</span><span class="token function">getQueryContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>queryContext<span class="token punctuation">.</span><span class="token function">isMemoryLimitsInitialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 如果限制了当前Query运行时的内存，则需要更新相关的属性</span>
            <span class="token keyword">long</span> sessionQueryMaxMemoryPerNode <span class="token operator">=</span> <span class="token function">getQueryMaxMemoryPerNode</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> sessionQueryTotalMaxMemoryPerNode <span class="token operator">=</span> <span class="token function">getQueryMaxTotalMemoryPerNode</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Session properties are only allowed to decrease memory limits, not increase them</span>
            queryContext<span class="token punctuation">.</span><span class="token function">initializeMemoryLimits</span><span class="token punctuation">(</span>
                    <span class="token function">resourceOvercommit</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token function">min</span><span class="token punctuation">(</span>sessionQueryMaxMemoryPerNode<span class="token punctuation">,</span> queryMaxMemoryPerNode<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token function">min</span><span class="token punctuation">(</span>sessionQueryTotalMaxMemoryPerNode<span class="token punctuation">,</span> queryMaxTotalMemoryPerNode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 更新SqlTask的心跳信息，实际上就是系统当前的时间</span>
        <span class="token comment">// 每一个SqlTask的心跳信息，都会在查找或更新时，被更新，以保证能够根据上一次的心跳时间，判断它是不是失联了</span>
        sqlTask<span class="token punctuation">.</span><span class="token function">recordHeartbeat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 更新SqlTask实例运行时的参数</span>
        <span class="token keyword">return</span> sqlTask<span class="token punctuation">.</span><span class="token function">updateTask</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> fragment<span class="token punctuation">,</span> sources<span class="token punctuation">,</span> outputBuffers<span class="token punctuation">,</span> dynamicFilterDomains<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="SqlTask_1721"></a>SqlTask的更新</h4> 
<blockquote> 
 <p>创建SqlTask实例时，或是Coordinator调了新的Splits时，会执行更新过程。</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SqlTask</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * 此方法的所有参数，都来自客户端发送的TaskUpdateRequest的对象，因此在生成Worker端的执行任务时，此Fragment上的输入(Split)、
     * 输出（outputBuffers）都已经确定了。
     * session: 保存了Sql执行时的客户端侧会话信息
     * fragment: 当前SqlTask要执行的逻辑计划片段
     * sources: 当前SqlTask要读取的数据源的Split描述信息，这些Split要么读取remote source，要么读取table。
     * outputBuffers: SqlTask的输出缓存区队列，在Coordinator侧创建PipelinedStageExecution实例时就已经被确定了，一共有如下三种类型：
     *     BroadcastOutputBufferManager：广播输出数据，只有一个Partition，因此只有一个buffer
     *     ScaledOutputBufferManager：动态扩展输出Buffer的数量，因此buffers数量是不固定的，被用于写出数据的任务
     *     PartitionedOutputBufferManager：按分区数量创建相同数量的outputBuffer，因此每一个Buffer都对应一个分区ID，供下游Stage
     *                                     消费。在当前的执行流程分析场景下，用到的是此类的实例。
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">TaskInfo</span> <span class="token function">updateTask</span><span class="token punctuation">(</span>
            <span class="token class-name">Session</span> session<span class="token punctuation">,</span>
            <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PlanFragment</span><span class="token punctuation">&gt;</span></span> fragment<span class="token punctuation">,</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TaskSource</span><span class="token punctuation">&gt;</span></span> sources<span class="token punctuation">,</span>
            <span class="token class-name">OutputBuffers</span> outputBuffers<span class="token punctuation">,</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DynamicFilterId</span><span class="token punctuation">,</span> <span class="token class-name">Domain</span><span class="token punctuation">&gt;</span></span> dynamicFilterDomains<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// trace token must be set first to make sure failure injection for getTaskResults requests works as expected</span>
            session<span class="token punctuation">.</span><span class="token function">getTraceToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span>traceToken<span class="token operator">::</span><span class="token function">set</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// The LazyOutput buffer does not support write methods, so the actual</span>
            <span class="token comment">// output buffer must be established before drivers are created (e.g.</span>
            <span class="token comment">// a VALUES query).</span>
            outputBuffer<span class="token punctuation">.</span><span class="token function">setOutputBuffers</span><span class="token punctuation">(</span>outputBuffers<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// assure the task execution is only created once</span>
            <span class="token class-name">SqlTaskExecution</span> taskExecution<span class="token punctuation">;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// is task already complete?</span>
                <span class="token class-name">TaskHolder</span> taskHolder <span class="token operator">=</span> taskHolderReference<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>taskHolder<span class="token punctuation">.</span><span class="token function">isFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> taskHolder<span class="token punctuation">.</span><span class="token function">getFinalTaskInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                taskExecution <span class="token operator">=</span> taskHolder<span class="token punctuation">.</span><span class="token function">getTaskExecution</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>taskExecution <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">checkState</span><span class="token punctuation">(</span>fragment<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"fragment must be present"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 创建SqlTaskExecution实例，负责在当前的Worker结点分析和执行fragment    </span>
                    taskExecution <span class="token operator">=</span> sqlTaskExecutionFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>
                            session<span class="token punctuation">,</span>
                            queryContext<span class="token punctuation">,</span>
                            taskStateMachine<span class="token punctuation">,</span>
                            outputBuffer<span class="token punctuation">,</span>
                            fragment<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token keyword">this</span><span class="token operator">::</span><span class="token function">notifyStatusChanged</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    taskHolderReference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>taskHolder<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TaskHolder</span><span class="token punctuation">(</span>taskExecution<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    needsPlan<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>taskExecution <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 一旦发现taskExecution实例，就将要处理的数据源Splits添加到等待队列中</span>
                taskExecution<span class="token punctuation">.</span><span class="token function">addSources</span><span class="token punctuation">(</span>sources<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 同时更新dynamicFilter产生的（可以在处理Split时用于过滤数据的值集合）。</span>
                taskExecution<span class="token punctuation">.</span><span class="token function">getTaskContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addDynamicFilter</span><span class="token punctuation">(</span>dynamicFilterDomains<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Error</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">failed</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">failed</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token function">getTaskInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="SqlTaskExecution_1799"></a>SqlTaskExecution的创建</h5> 
<blockquote> 
 <p>创建此实例时，会在创建过程中，生成真正可执行的物理执行计划实例LocalExecutionPlan。</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SqlTaskExecutionFactory</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token class-name">SqlTaskExecution</span> <span class="token function">create</span><span class="token punctuation">(</span>
            <span class="token class-name">Session</span> session<span class="token punctuation">,</span>
            <span class="token class-name">QueryContext</span> queryContext<span class="token punctuation">,</span>
            <span class="token class-name">TaskStateMachine</span> taskStateMachine<span class="token punctuation">,</span>
            <span class="token class-name">OutputBuffer</span> outputBuffer<span class="token punctuation">,</span>
            <span class="token class-name">PlanFragment</span> fragment<span class="token punctuation">,</span>
            <span class="token class-name">Runnable</span> notifyStatusChanged<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 创建TaskContext实例，维护了当前SqlTask运行时的各种信息，例如各种metrics</span>
        <span class="token class-name">TaskContext</span> taskContext <span class="token operator">=</span> queryContext<span class="token punctuation">.</span><span class="token function">addTaskContext</span><span class="token punctuation">(</span>
                taskStateMachine<span class="token punctuation">,</span>
                session<span class="token punctuation">,</span>
                notifyStatusChanged<span class="token punctuation">,</span>
                perOperatorCpuTimerEnabled<span class="token punctuation">,</span>
                cpuTimerEnabled<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">LocalExecutionPlan</span> localExecutionPlan<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">SetThreadName</span> ignored <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SetThreadName</span><span class="token punctuation">(</span><span class="token string">"Task-%s"</span><span class="token punctuation">,</span> taskStateMachine<span class="token punctuation">.</span><span class="token function">getTaskId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// planner是一个LocalExecutionPlanner类型的实例，用于将逻辑计划PlanFragment转换成本地可执行的</span>
                <span class="token comment">// 物理执行计划LocalExecutionPlan</span>
                localExecutionPlan <span class="token operator">=</span> planner<span class="token punctuation">.</span><span class="token function">plan</span><span class="token punctuation">(</span>
                        taskContext<span class="token punctuation">,</span>
                        fragment<span class="token punctuation">.</span><span class="token function">getRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token class-name">TypeProvider</span><span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>fragment<span class="token punctuation">.</span><span class="token function">getSymbols</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        fragment<span class="token punctuation">.</span><span class="token function">getPartitioningScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        fragment<span class="token punctuation">.</span><span class="token function">getStageExecutionDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        fragment<span class="token punctuation">.</span><span class="token function">getPartitionedSources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        outputBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// planning failed</span>
                taskStateMachine<span class="token punctuation">.</span><span class="token function">failed</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">throwIfUnchecked</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">createSqlTaskExecution</span><span class="token punctuation">(</span>
                taskStateMachine<span class="token punctuation">,</span>
                taskContext<span class="token punctuation">,</span>
                outputBuffer<span class="token punctuation">,</span>
                localExecutionPlan<span class="token punctuation">,</span>
                taskExecutor<span class="token punctuation">,</span>
                taskNotificationExecutor<span class="token punctuation">,</span>
                splitMonitor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="LocalExecutionPlannerplan_1854"></a>LocalExecutionPlanner::plan</h6> 
<blockquote> 
 <p>将PlanFragment转换成本地可执行的物理计划LocalExecutionPlan。</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LocalExecutionPlanner</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token class-name">LocalExecutionPlan</span> <span class="token function">plan</span><span class="token punctuation">(</span>
            <span class="token class-name">TaskContext</span> taskContext<span class="token punctuation">,</span>
            <span class="token class-name">PlanNode</span> plan<span class="token punctuation">,</span>
            <span class="token class-name">TypeProvider</span> types<span class="token punctuation">,</span>
            <span class="token class-name">PartitioningScheme</span> partitioningScheme<span class="token punctuation">,</span>
            <span class="token class-name">StageExecutionDescriptor</span> stageExecutionDescriptor<span class="token punctuation">,</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PlanNodeId</span><span class="token punctuation">&gt;</span></span> partitionedSourceOrder<span class="token punctuation">,</span>
            <span class="token class-name">OutputBuffer</span> outputBuffer<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 得到当前Fragment的输出布局（layout）</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Symbol</span><span class="token punctuation">&gt;</span></span> outputLayout <span class="token operator">=</span> partitioningScheme<span class="token punctuation">.</span><span class="token function">getOutputLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>partitioningScheme<span class="token punctuation">.</span><span class="token function">getPartitioning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token constant">FIXED_BROADCAST_DISTRIBUTION</span><span class="token punctuation">)</span> <span class="token operator">||</span>
                partitioningScheme<span class="token punctuation">.</span><span class="token function">getPartitioning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token constant">FIXED_ARBITRARY_DISTRIBUTION</span><span class="token punctuation">)</span> <span class="token operator">||</span>
                partitioningScheme<span class="token punctuation">.</span><span class="token function">getPartitioning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token constant">SCALED_WRITER_DISTRIBUTION</span><span class="token punctuation">)</span> <span class="token operator">||</span>
                partitioningScheme<span class="token punctuation">.</span><span class="token function">getPartitioning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token constant">SINGLE_DISTRIBUTION</span><span class="token punctuation">)</span> <span class="token operator">||</span>
                partitioningScheme<span class="token punctuation">.</span><span class="token function">getPartitioning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token constant">COORDINATOR_DISTRIBUTION</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 由于数据是基于Partition的，因此跳过</span>
            <span class="token keyword">return</span> <span class="token function">plan</span><span class="token punctuation">(</span>taskContext<span class="token punctuation">,</span> stageExecutionDescriptor<span class="token punctuation">,</span> plan<span class="token punctuation">,</span> outputLayout<span class="token punctuation">,</span> types<span class="token punctuation">,</span> partitionedSourceOrder<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TaskOutputFactory</span><span class="token punctuation">(</span>outputBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// We can convert the symbols directly into channels, because the root must be a sink and therefore the layout is fixed</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> partitionChannels<span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Optional</span><span class="token punctuation">&lt;</span><span class="token class-name">NullableValue</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> partitionConstants<span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Type</span><span class="token punctuation">&gt;</span></span> partitionChannelTypes<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>partitioningScheme<span class="token punctuation">.</span><span class="token function">getHashColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            partitionChannels <span class="token operator">=</span> <span class="token class-name">ImmutableList</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>outputLayout<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>partitioningScheme<span class="token punctuation">.</span><span class="token function">getHashColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            partitionConstants <span class="token operator">=</span> <span class="token class-name">ImmutableList</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            partitionChannelTypes <span class="token operator">=</span> <span class="token class-name">ImmutableList</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token constant">BIGINT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 收集分区列的下标。对于常量分区值，则赋值-1</span>
            partitionChannels <span class="token operator">=</span> partitioningScheme<span class="token punctuation">.</span><span class="token function">getPartitioning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>argument <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>argument<span class="token punctuation">.</span><span class="token function">isConstant</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">return</span> outputLayout<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>argument<span class="token punctuation">.</span><span class="token function">getColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token function">toImmutableList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 收集分区常量值</span>
            partitionConstants <span class="token operator">=</span> partitioningScheme<span class="token punctuation">.</span><span class="token function">getPartitioning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>argument <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>argument<span class="token punctuation">.</span><span class="token function">isConstant</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">return</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>argument<span class="token punctuation">.</span><span class="token function">getConstant</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">return</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">NullableValue</span><span class="token punctuation">&gt;</span></span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token function">toImmutableList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 收集分区字段的类型</span>
            partitionChannelTypes <span class="token operator">=</span> partitioningScheme<span class="token punctuation">.</span><span class="token function">getPartitioning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>argument <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>argument<span class="token punctuation">.</span><span class="token function">isConstant</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">return</span> argument<span class="token punctuation">.</span><span class="token function">getConstant</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">return</span> types<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>argument<span class="token punctuation">.</span><span class="token function">getColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token function">toImmutableList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 得到计算分区ID的函数，一般地，执行Read SQL时，它是一个BucketPartitionFunction的实例</span>
        <span class="token comment">// PartitionFunction提供了计算分区ID的方法，getPartition(Page page, int position)，即给定一个数据页中的某一行数据，</span>
        <span class="token comment">// 而计算PartitionId的算法，一共内置如下几类：</span>
        <span class="token comment">//    SINGLE: Single partition can only have one bucket</span>
        <span class="token comment">//    HASH: HashBucketFunction，根据分区字段，计算得到HASH值，后面再将HASH值对partitions数量取余得到某行数据对应的分区ID</span>
        <span class="token comment">//    ROUND_ROBIN: 净某一行数据以顺序遍历地方式，分区分区ID</span>
        <span class="token class-name">PartitionFunction</span> partitionFunction <span class="token operator">=</span> nodePartitioningManager<span class="token punctuation">.</span><span class="token function">getPartitionFunction</span><span class="token punctuation">(</span>taskContext<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> partitioningScheme<span class="token punctuation">,</span> partitionChannelTypes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">OptionalInt</span> nullChannel <span class="token operator">=</span> <span class="token class-name">OptionalInt</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Symbol</span><span class="token punctuation">&gt;</span></span> partitioningColumns <span class="token operator">=</span> partitioningScheme<span class="token punctuation">.</span><span class="token function">getPartitioning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getColumns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// partitioningColumns expected to have one column in the normal case, and zero columns when partitioning on a constant</span>
        <span class="token comment">// 对于常量分区，则不需要额外的列；对于指定了分区字段的情况，则需要一个额外的分区列，来保存每一行的分区值（例如对于HASH分区算法，存储</span>
        <span class="token comment">// 的是HASH值）。</span>
        <span class="token function">checkArgument</span><span class="token punctuation">(</span><span class="token operator">!</span>partitioningScheme<span class="token punctuation">.</span><span class="token function">isReplicateNullsAndAny</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> partitioningColumns<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>partitioningScheme<span class="token punctuation">.</span><span class="token function">isReplicateNullsAndAny</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> partitioningColumns<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            nullChannel <span class="token operator">=</span> <span class="token class-name">OptionalInt</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>outputLayout<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token function">getOnlyElement</span><span class="token punctuation">(</span>partitioningColumns<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">return</span> <span class="token function">plan</span><span class="token punctuation">(</span>
                taskContext<span class="token punctuation">,</span>
                stageExecutionDescriptor<span class="token punctuation">,</span>
                plan<span class="token punctuation">,</span>
                outputLayout<span class="token punctuation">,</span>
                types<span class="token punctuation">,</span>
                partitionedSourceOrder<span class="token punctuation">,</span>
                <span class="token comment">// 创建一个PartitionedOutputFactory类型的实例，它提供了创建PartitionedOutputOperator实例的方法。</span>
                <span class="token comment">// 而PartitionedOutputOperator是此PlanFragment上一系列执行算子的最后一个，负责对Data Page按PartitioningColumns</span>
                <span class="token comment">// 计算PartitionID，并扔进OutputBuffer中。</span>
                operatorFactories<span class="token punctuation">.</span><span class="token function">partitionedOutput</span><span class="token punctuation">(</span>
                        taskContext<span class="token punctuation">,</span>
                        partitionFunction<span class="token punctuation">,</span>
                        partitionChannels<span class="token punctuation">,</span>
                        partitionConstants<span class="token punctuation">,</span>
                        partitioningScheme<span class="token punctuation">.</span><span class="token function">isReplicateNullsAndAny</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        nullChannel<span class="token punctuation">,</span>
                        outputBuffer<span class="token punctuation">,</span>
                        maxPagePartitioningBufferSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">LocalExecutionPlan</span> <span class="token function">plan</span><span class="token punctuation">(</span>
            <span class="token class-name">TaskContext</span> taskContext<span class="token punctuation">,</span>
            <span class="token class-name">StageExecutionDescriptor</span> stageExecutionDescriptor<span class="token punctuation">,</span>
            <span class="token class-name">PlanNode</span> plan<span class="token punctuation">,</span> <span class="token comment">// PlanFragment的根结点，对应于此逻辑子计划的最上层Node</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Symbol</span><span class="token punctuation">&gt;</span></span> outputLayout<span class="token punctuation">,</span> <span class="token comment">// 此PlanFragment的结果的布局信息，实际上就是要输出的列符号</span>
            <span class="token class-name">TypeProvider</span> types<span class="token punctuation">,</span>        <span class="token comment">// 用于描述 每一个Symbol的类型</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PlanNodeId</span><span class="token punctuation">&gt;</span></span> partitionedSourceOrder<span class="token punctuation">,</span> <span class="token comment">// 保存了所有要输出的Source源的PlanNodeId，例如JOIN，有左、右两个Source</span>
            <span class="token class-name">OutputFactory</span> outputOperatorFactory<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Session</span> session <span class="token operator">=</span> taskContext<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 保存了本地物理执行计划运行时的上下文信息</span>
        <span class="token class-name">LocalExecutionPlanContext</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalExecutionPlanContext</span><span class="token punctuation">(</span>taskContext<span class="token punctuation">,</span> types<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 从PlanFragment的根逻辑计划结点plan开始访问，构建物理执行计划树，实际上就是一组作用于Split之上的Operators（Driver）</span>
        <span class="token class-name">PhysicalOperation</span> physicalOperation <span class="token operator">=</span> plan<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Visitor</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> stageExecutionDescriptor<span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 对齐逻辑计划的outputLayout和物理执行计划的输出layoutput</span>
        <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Page</span><span class="token punctuation">,</span> <span class="token class-name">Page</span><span class="token punctuation">&gt;</span></span> pagePreprocessor <span class="token operator">=</span> <span class="token function">enforceLoadedLayoutProcessor</span><span class="token punctuation">(</span>outputLayout<span class="token punctuation">,</span> physicalOperation<span class="token punctuation">.</span><span class="token function">getLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 收集逻辑逻辑计划的输出字段的类型</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Type</span><span class="token punctuation">&gt;</span></span> outputTypes <span class="token operator">=</span> outputLayout<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>types<span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token function">toImmutableList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建一个新的Driver。需要将OutputOperator与physicalOperaton串联到一个物理执行流水线中，分配一个新的PipelineId。</span>
        <span class="token comment">// 其中physicalOperaton作为流水线的Source Operator，而OutputOperator作为流水线中的Output Operator。</span>
        context<span class="token punctuation">.</span><span class="token function">addDriverFactory</span><span class="token punctuation">(</span>
                context<span class="token punctuation">.</span><span class="token function">isInputDriver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 标识新的Driver的类型为，Output</span>
                <span class="token keyword">new</span> <span class="token class-name">PhysicalOperation</span><span class="token punctuation">(</span>
                        outputOperatorFactory<span class="token punctuation">.</span><span class="token function">createOutputOperator</span><span class="token punctuation">(</span>
                                context<span class="token punctuation">.</span><span class="token function">getNextOperatorId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                plan<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                outputTypes<span class="token punctuation">,</span>
                                pagePreprocessor<span class="token punctuation">,</span>
                                <span class="token keyword">new</span> <span class="token class-name">PagesSerdeFactory</span><span class="token punctuation">(</span>plannerContext<span class="token punctuation">.</span><span class="token function">getBlockEncodingSerde</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">isExchangeCompressionEnabled</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        physicalOperation<span class="token punctuation">)</span><span class="token punctuation">,</span>
                context<span class="token punctuation">.</span><span class="token function">getDriverInstanceCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// notify operator factories that planning has completed</span>
        context<span class="token punctuation">.</span><span class="token function">getDriverFactories</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">DriverFactory</span><span class="token operator">::</span><span class="token function">getOperatorFactories</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token operator">::</span><span class="token function">stream</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">LocalPlannerAware</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token operator">::</span><span class="token function">isInstance</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">LocalPlannerAware</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token operator">::</span><span class="token function">cast</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">LocalPlannerAware</span><span class="token operator">::</span><span class="token function">localPlannerComplete</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LocalExecutionPlan</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getDriverFactories</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> partitionedSourceOrder<span class="token punctuation">,</span> stageExecutionDescriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="SqlTaskExecution_2004"></a>SqlTaskExecution的构建</h6> 
<pre><code class="prism language-java">    <span class="token keyword">private</span> <span class="token class-name">SqlTaskExecution</span><span class="token punctuation">(</span>
            <span class="token class-name">TaskStateMachine</span> taskStateMachine<span class="token punctuation">,</span>
            <span class="token class-name">TaskContext</span> taskContext<span class="token punctuation">,</span>
            <span class="token class-name">OutputBuffer</span> outputBuffer<span class="token punctuation">,</span>
            <span class="token class-name">LocalExecutionPlan</span> localExecutionPlan<span class="token punctuation">,</span>
            <span class="token class-name">TaskExecutor</span> taskExecutor<span class="token punctuation">,</span>
            <span class="token class-name">SplitMonitor</span> splitMonitor<span class="token punctuation">,</span>
            <span class="token class-name">Executor</span> notificationExecutor<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>taskStateMachine <span class="token operator">=</span> <span class="token function">requireNonNull</span><span class="token punctuation">(</span>taskStateMachine<span class="token punctuation">,</span> <span class="token string">"taskStateMachine is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>taskId <span class="token operator">=</span> taskStateMachine<span class="token punctuation">.</span><span class="token function">getTaskId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>taskContext <span class="token operator">=</span> <span class="token function">requireNonNull</span><span class="token punctuation">(</span>taskContext<span class="token punctuation">,</span> <span class="token string">"taskContext is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>outputBuffer <span class="token operator">=</span> <span class="token function">requireNonNull</span><span class="token punctuation">(</span>outputBuffer<span class="token punctuation">,</span> <span class="token string">"outputBuffer is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>taskExecutor <span class="token operator">=</span> <span class="token function">requireNonNull</span><span class="token punctuation">(</span>taskExecutor<span class="token punctuation">,</span> <span class="token string">"taskExecutor is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>notificationExecutor <span class="token operator">=</span> <span class="token function">requireNonNull</span><span class="token punctuation">(</span>notificationExecutor<span class="token punctuation">,</span> <span class="token string">"notificationExecutor is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>splitMonitor <span class="token operator">=</span> <span class="token function">requireNonNull</span><span class="token punctuation">(</span>splitMonitor<span class="token punctuation">,</span> <span class="token string">"splitMonitor is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">SetThreadName</span> ignored <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SetThreadName</span><span class="token punctuation">(</span><span class="token string">"Task-%s"</span><span class="token punctuation">,</span> taskId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// index driver factories</span>
            <span class="token comment">// 从执行计划，得到Source结点ID</span>
            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PlanNodeId</span><span class="token punctuation">&gt;</span></span> partitionedSources <span class="token operator">=</span> <span class="token class-name">ImmutableSet</span><span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>localExecutionPlan<span class="token punctuation">.</span><span class="token function">getPartitionedSourceOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 保存所有生成周期为Split级别的DriverSplitRunnerFactory实例</span>
            <span class="token class-name">ImmutableMap<span class="token punctuation">.</span>Builder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PlanNodeId</span><span class="token punctuation">,</span> <span class="token class-name">DriverSplitRunnerFactory</span><span class="token punctuation">&gt;</span></span> driverRunnerFactoriesWithSplitLifeCycle <span class="token operator">=</span> <span class="token class-name">ImmutableMap</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 保存所有生命周期为Task级别的DriverSplitRunnerFactory的实例</span>
            <span class="token class-name">ImmutableList<span class="token punctuation">.</span>Builder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DriverSplitRunnerFactory</span><span class="token punctuation">&gt;</span></span> driverRunnerFactoriesWithTaskLifeCycle <span class="token operator">=</span> <span class="token class-name">ImmutableList</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 保存所有生命周期为Group级别的DriverSplitRunnerFactory实例</span>
            <span class="token class-name">ImmutableList<span class="token punctuation">.</span>Builder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DriverSplitRunnerFactory</span><span class="token punctuation">&gt;</span></span> driverRunnerFactoriesWithDriverGroupLifeCycle <span class="token operator">=</span> <span class="token class-name">ImmutableList</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">DriverFactory</span> driverFactory <span class="token operator">:</span> localExecutionPlan<span class="token punctuation">.</span><span class="token function">getDriverFactories</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 获取当前Driver的最上游的PlanNodeId</span>
                <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PlanNodeId</span><span class="token punctuation">&gt;</span></span> sourceId <span class="token operator">=</span> driverFactory<span class="token punctuation">.</span><span class="token function">getSourceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>sourceId<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> partitionedSources<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>sourceId<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 如果这个Driver有输入，同时是一个分区类型的Source Node，那么这个Driver的生命周期就是与Split绑定的，即</span>
                    <span class="token comment">// 绑定的Split被处理完，那么这个Driver就没用了。</span>
                    driverRunnerFactoriesWithSplitLifeCycle<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>sourceId<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DriverSplitRunnerFactory</span><span class="token punctuation">(</span>driverFactory<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 如果这个Driver是一个下游的Driver实例，</span>
                    <span class="token keyword">switch</span> <span class="token punctuation">(</span>driverFactory<span class="token punctuation">.</span><span class="token function">getPipelineExecutionStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">case</span> <span class="token constant">GROUPED_EXECUTION</span><span class="token operator">:</span>
                            <span class="token comment">// 如果是GROUP LifeSpan，那么就需要每一个Drvier创建一个Runner Factory，添加到相应的等待队列中</span>
                            driverRunnerFactoriesWithDriverGroupLifeCycle<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DriverSplitRunnerFactory</span><span class="token punctuation">(</span>driverFactory<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token keyword">case</span> <span class="token constant">UNGROUPED_EXECUTION</span><span class="token operator">:</span>
                            <span class="token comment">// 如果是GROUP LifeSpan，那么就需要每一个Drvier创建一个Runner</span>
                            driverRunnerFactoriesWithTaskLifeCycle<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DriverSplitRunnerFactory</span><span class="token punctuation">(</span>driverFactory<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token keyword">default</span><span class="token operator">:</span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>driverRunnerFactoriesWithSplitLifeCycle <span class="token operator">=</span> driverRunnerFactoriesWithSplitLifeCycle<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>driverRunnerFactoriesWithDriverGroupLifeCycle <span class="token operator">=</span> driverRunnerFactoriesWithDriverGroupLifeCycle<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>driverRunnerFactoriesWithTaskLifeCycle <span class="token operator">=</span> driverRunnerFactoriesWithTaskLifeCycle<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>pendingSplitsByPlanNode <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>driverRunnerFactoriesWithSplitLifeCycle<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token function">toImmutableMap</span><span class="token punctuation">(</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ignore <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">PendingSplitsForPlanNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span>
                    taskContext<span class="token punctuation">,</span>
                    localExecutionPlan<span class="token punctuation">.</span><span class="token function">getDriverFactories</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token function">toImmutableMap</span><span class="token punctuation">(</span><span class="token class-name">DriverFactory</span><span class="token operator">::</span><span class="token function">getPipelineId</span><span class="token punctuation">,</span> <span class="token class-name">DriverFactory</span><span class="token operator">::</span><span class="token function">getPipelineExecutionStrategy</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>schedulingLifespanManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SchedulingLifespanManager</span><span class="token punctuation">(</span>localExecutionPlan<span class="token punctuation">.</span><span class="token function">getPartitionedSourceOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> localExecutionPlan<span class="token punctuation">.</span><span class="token function">getStageExecutionDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">checkArgument</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>driverRunnerFactoriesWithSplitLifeCycle<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>partitionedSources<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token string">"Fragment is partitioned, but not all partitioned drivers were found"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Pre-register Lifespans for ungrouped partitioned drivers in case they end up get no splits.</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PlanNodeId</span><span class="token punctuation">,</span> <span class="token class-name">DriverSplitRunnerFactory</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>driverRunnerFactoriesWithSplitLifeCycle<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">PlanNodeId</span> planNodeId <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">DriverSplitRunnerFactory</span> driverSplitRunnerFactory <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>driverSplitRunnerFactory<span class="token punctuation">.</span><span class="token function">getPipelineExecutionStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">UNGROUPED_EXECUTION</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>schedulingLifespanManager<span class="token punctuation">.</span><span class="token function">addLifespanIfAbsent</span><span class="token punctuation">(</span><span class="token class-name">Lifespan</span><span class="token punctuation">.</span><span class="token function">taskWide</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>pendingSplitsByPlanNode<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>planNodeId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLifespan</span><span class="token punctuation">(</span><span class="token class-name">Lifespan</span><span class="token punctuation">.</span><span class="token function">taskWide</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// don't register the task if it is already completed (most likely failed during planning above)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>taskStateMachine<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                taskHandle <span class="token operator">=</span> <span class="token function">createTaskHandle</span><span class="token punctuation">(</span>taskStateMachine<span class="token punctuation">,</span> taskContext<span class="token punctuation">,</span> outputBuffer<span class="token punctuation">,</span> localExecutionPlan<span class="token punctuation">,</span> taskExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                taskHandle <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 追加一个Listener，当前Outputbuffer处于FINISHED状态时，检查当前的SqkTaskExecution是否完成了。</span>
            outputBuffer<span class="token punctuation">.</span><span class="token function">addStateChangeListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CheckTaskCompletionOnBufferFinish</span><span class="token punctuation">(</span><span class="token class-name">SqlTaskExecution</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h5><a id="SqlTaskExecutionaddSources_2094"></a>SqlTaskExecution::addSources</h5> 
<blockquote> 
 <p>addSources()方法，用于将客户端（Coordinator）发送的新Splits，按类型添加到相应调度队列中，并尝试调度之。</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SqlTaskExecution</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addSources</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TaskSource</span><span class="token punctuation">&gt;</span></span> sources<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">requireNonNull</span><span class="token punctuation">(</span>sources<span class="token punctuation">,</span> <span class="token string">"sources is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">checkState</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">holdsLock</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Cannot add sources while holding a lock on the %s"</span><span class="token punctuation">,</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">SetThreadName</span> ignored <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SetThreadName</span><span class="token punctuation">(</span><span class="token string">"Task-%s"</span><span class="token punctuation">,</span> taskId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// update our record of sources and schedule drivers for new partitioned splits</span>
            <span class="token comment">// 返回的updatedUnpartitionedSources集合，包含了所有非分区类型的、未处理完成的Splits</span>
            <span class="token comment">// 而分区类型的Splits则通过SqlTaskExecution::schedulePartitionedSource(..)方法被调度</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PlanNodeId</span><span class="token punctuation">,</span> <span class="token class-name">TaskSource</span><span class="token punctuation">&gt;</span></span> updatedUnpartitionedSources <span class="token operator">=</span> <span class="token function">updateSources</span><span class="token punctuation">(</span>sources<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 调度所有的非分区类型的Splits</span>
            <span class="token comment">// tell existing drivers about the new splits; it is safe to update drivers</span>
            <span class="token comment">// multiple times and out of order because sources contain full record of</span>
            <span class="token comment">// the unpartitioned splits</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Driver</span><span class="token punctuation">&gt;</span></span> driverReference <span class="token operator">:</span> drivers<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Driver</span> driver <span class="token operator">=</span> driverReference<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// the driver can be GCed due to a failure or a limit</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>driver <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// remove the weak reference from the list to avoid a memory leak</span>
                    <span class="token comment">// NOTE: this is a concurrent safe operation on a CopyOnWriteArrayList</span>
                    drivers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>driverReference<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PlanNodeId</span><span class="token punctuation">&gt;</span></span> sourceId <span class="token operator">=</span> driver<span class="token punctuation">.</span><span class="token function">getSourceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>sourceId<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">TaskSource</span> sourceUpdate <span class="token operator">=</span> updatedUnpartitionedSources<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>sourceId<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>sourceUpdate <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                driver<span class="token punctuation">.</span><span class="token function">updateSource</span><span class="token punctuation">(</span>sourceUpdate<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// we may have transitioned to no more splits, so check for completion</span>
            <span class="token function">checkTaskCompletion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="SqlTask_2142"></a>SqlTask的调度&amp;执行</h3> 
<h4><a id="SqlTaskExecutionschedulePartitionedSource_2143"></a>SqlTaskExecution::schedulePartitionedSource</h4> 
<blockquote> 
 <p>SqlTask每收到新的Splits，就调用<code>schedulePartitionedSource(TaskSource)</code>方法调度Splits。</p> 
</blockquote> 
<pre><code class="prism language-java">    <span class="token keyword">private</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">schedulePartitionedSource</span><span class="token punctuation">(</span><span class="token class-name">TaskSource</span> sourceUpdate<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">mergeIntoPendingSplits</span><span class="token punctuation">(</span>sourceUpdate<span class="token punctuation">.</span><span class="token function">getPlanNodeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sourceUpdate<span class="token punctuation">.</span><span class="token function">getSplits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sourceUpdate<span class="token punctuation">.</span><span class="token function">getNoMoreSplitsForLifespan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sourceUpdate<span class="token punctuation">.</span><span class="token function">isNoMoreSplits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// SchedulingLifespanManager tracks how far each Lifespan has been scheduled. Here is an example.</span>
            <span class="token comment">// Let's say there are 4 source pipelines/nodes: A, B, C, and D, in scheduling order.</span>
            <span class="token comment">// And we're processing 3 concurrent lifespans at a time. In this case, we could have</span>
            <span class="token comment">//</span>
            <span class="token comment">// * Lifespan 10:  A   B  [C]  D; i.e. Pipeline A and B has finished scheduling (but not necessarily finished running).</span>
            <span class="token comment">// * Lifespan 20: [A]  B   C   D</span>
            <span class="token comment">// * Lifespan 30:  A  [B]  C   D</span>
            <span class="token comment">//</span>
            <span class="token comment">// To recap, SchedulingLifespanManager records the next scheduling source node for each lifespan.</span>
            <span class="token comment">// schedulingLifespanManager维护了两种类型的LifeSpan：</span>
            <span class="token comment">//   Task Wide：Split的运行时辐射范围对应于split/task lifecycle，与Group的Source Pipeline是互斥的，</span>
            <span class="token comment">//              同一时刻只能有一个task wide的pipeline和一个group wide的pipeline并行调度执行。</span>
            <span class="token comment">//   Task Group Wide：Split的运行辐射范围对应于Driver Group lifecycle，如果有多个Source Pipeline，那么对于</span>
            <span class="token comment">//                    相同的Group（就是一个Partition)，同一时刻只能有一个在调度&amp;执行的Source Pipeline；对于</span>
            <span class="token comment">//                    不同的Group，可以并行调度。</span>
            <span class="token comment">//</span>
            <span class="token comment">// 获取还需要调度执行的LifeSpan，调度属于这个范围内的Splits执行。</span>
            <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SchedulingLifespan</span><span class="token punctuation">&gt;</span></span> activeLifespans <span class="token operator">=</span> schedulingLifespanManager<span class="token punctuation">.</span><span class="token function">getActiveLifespans</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">boolean</span> madeProgress <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

            <span class="token keyword">while</span> <span class="token punctuation">(</span>activeLifespans<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">SchedulingLifespan</span> schedulingLifespan <span class="token operator">=</span> activeLifespans<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Lifespan</span> lifespan <span class="token operator">=</span> schedulingLifespan<span class="token punctuation">.</span><span class="token function">getLifespan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// Continue using the example from above. Let's say the sourceUpdate adds some new splits for source node B.</span>
                <span class="token comment">//</span>
                <span class="token comment">// For lifespan 30, it could start new drivers and assign a pending split to each.</span>
                <span class="token comment">// Pending splits could include both pre-existing pending splits, and the new ones from sourceUpdate.</span>
                <span class="token comment">// If there is enough driver slots to deplete pending splits, one of the below would happen.</span>
                <span class="token comment">// * If it is marked that all splits for node B in lifespan 30 has been received, SchedulingLifespanManager</span>
                <span class="token comment">//   will be updated so that lifespan 30 now processes source node C. It will immediately start processing them.</span>
                <span class="token comment">// * Otherwise, processing of lifespan 30 will be shelved for now.</span>
                <span class="token comment">//</span>
                <span class="token comment">// It is possible that the following loop would be a no-op for a particular lifespan.</span>
                <span class="token comment">// It is also possible that a single lifespan can proceed through multiple source nodes in one run.</span>
                <span class="token comment">//</span>
                <span class="token comment">// When different drivers in the task has different pipelineExecutionStrategy, it adds additional complexity.</span>
                <span class="token comment">// For example, when driver B is ungrouped and driver A, C, D is grouped, you could have something like this:</span>
                <span class="token comment">//     TaskWide   :     [B]</span>
                <span class="token comment">//     Lifespan 10:  A  [ ]  C   D</span>
                <span class="token comment">//     Lifespan 20: [A]      C   D</span>
                <span class="token comment">//     Lifespan 30:  A  [ ]  C   D</span>
                <span class="token comment">// In this example, Lifespan 30 cannot start executing drivers in pipeline C because pipeline B</span>
                <span class="token comment">// hasn't finished scheduling yet (albeit in a different lifespan).</span>
                <span class="token comment">// Similarly, it wouldn't make sense for TaskWide to start executing drivers in pipeline B until at least</span>
                <span class="token comment">// one lifespan has finished scheduling pipeline A.</span>
                <span class="token comment">// This is why getSchedulingPlanNode returns an Optional.</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PlanNodeId</span><span class="token punctuation">&gt;</span></span> optionalSchedulingPlanNode <span class="token operator">=</span> schedulingLifespan<span class="token punctuation">.</span><span class="token function">getSchedulingPlanNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>optionalSchedulingPlanNode<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token class-name">PlanNodeId</span> schedulingPlanNode <span class="token operator">=</span> optionalSchedulingPlanNode<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// driverRunnerFactoriesWithSplitLifeCycle存储的PlanNode实际上就是Source Node类型，因此这些Split</span>
                    <span class="token comment">// 对应了数据源的数据，因此需要被Repartitioning，以便能够被Trino对数据进行分桶（重分区），满足在之前章节讲到的</span>
                    <span class="token comment">// PartitionId -&gt; WorkNode的数据分发策略。</span>
                    <span class="token class-name">DriverSplitRunnerFactory</span> partitionedDriverRunnerFactory <span class="token operator">=</span> driverRunnerFactoriesWithSplitLifeCycle<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>schedulingPlanNode<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token class-name">PendingSplits</span> pendingSplits <span class="token operator">=</span> pendingSplitsByPlanNode<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>schedulingPlanNode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLifespan</span><span class="token punctuation">(</span>lifespan<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// Enqueue driver runners with driver group lifecycle for this driver life cycle, if not already enqueued.</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lifespan<span class="token punctuation">.</span><span class="token function">isTaskWide</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>schedulingLifespan<span class="token punctuation">.</span><span class="token function">getAndSetDriversForDriverGroupLifeCycleScheduled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// 如果当前要调度的LifeSpan的类型为Grouped，同时还没有被调度，就走这里，为当前SqlTask的所有的Pipeline</span>
                        <span class="token comment">// 创建DriverRunner。</span>
                        <span class="token comment">// 此时，这个SqlTask是某个一个中继Stage/PlanFragment的某个分区的任务实例，因此属于这个LifSpan的Split的</span>
                        <span class="token comment">// 信息已经确定了，而且已经被分区过了，因此内部会调用enqueueDriverSplitRunner(true, runners);方法，</span>
                        <span class="token comment">// 直接唤起每一个DriverRunner</span>
                        <span class="token function">scheduleDriversForDriverGroupLifeCycle</span><span class="token punctuation">(</span>lifespan<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token comment">// Enqueue driver runners with split lifecycle for this plan node and driver life cycle combination.</span>
                    <span class="token comment">// 如果lifespan是TASK WIDE，那么这些Split是叶子Split，即TableScan Splits，因此不能直接唤起它们的Runner，</span>
                    <span class="token comment">// 需要根据当前Worker Node的负载进行调度</span>
                    <span class="token class-name">ImmutableList<span class="token punctuation">.</span>Builder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DriverSplitRunner</span><span class="token punctuation">&gt;</span></span> runners <span class="token operator">=</span> <span class="token class-name">ImmutableList</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ScheduledSplit</span> scheduledSplit <span class="token operator">:</span> pendingSplits<span class="token punctuation">.</span><span class="token function">removeAllSplits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// create a new driver for the split</span>
                        runners<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>partitionedDriverRunnerFactory<span class="token punctuation">.</span><span class="token function">createDriverRunner</span><span class="token punctuation">(</span>scheduledSplit<span class="token punctuation">,</span> lifespan<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token function">enqueueDriverSplitRunner</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> runners<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// If all driver runners have been enqueued for this plan node and driver life cycle combination,</span>
                    <span class="token comment">// move on to the next plan node.</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingSplits<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NO_MORE_SPLITS</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// 到这里，不会再有新的Split了，那么就进当前的SqlTaskExecution实例进行清理</span>
                    partitionedDriverRunnerFactory<span class="token punctuation">.</span><span class="token function">noMoreDriverRunner</span><span class="token punctuation">(</span><span class="token class-name">ImmutableList</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>lifespan<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    pendingSplits<span class="token punctuation">.</span><span class="token function">markAsCleanedUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    schedulingLifespan<span class="token punctuation">.</span><span class="token function">nextPlanNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    madeProgress <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>schedulingLifespan<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>madeProgress<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>sourceUpdate<span class="token punctuation">.</span><span class="token function">isNoMoreSplits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 通知SchedulingLifespanManager，当前TaskSource对应的PlanNode的工作已经完成。</span>
            schedulingLifespanManager<span class="token punctuation">.</span><span class="token function">noMoreSplits</span><span class="token punctuation">(</span>sourceUpdate<span class="token punctuation">.</span><span class="token function">getPlanNodeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="SqlTaskExecutionscheduleDriversForTaskLifeCycle_2261"></a>SqlTaskExecution::scheduleDriversForTaskLifeCycle</h4> 
<blockquote> 
 <p>SqlTask接收到创建请求时，会尝试创建SqlTaskExecution，作为此SqlTask的执行实体，并在完成实例创建后，调用<br> scheduleDriversForTaskLifeCycle()方法开始调度。</p> 
</blockquote> 
<pre><code class="prism language-java">    <span class="token comment">// scheduleDriversForTaskLifeCycle and scheduleDriversForDriverGroupLifeCycle are similar.</span>
    <span class="token comment">// They are invoked under different circumstances, and schedules a disjoint set of drivers, as suggested by their names.</span>
    <span class="token comment">// They also have a few differences, making it more convenient to keep the two methods separate.</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">scheduleDriversForTaskLifeCycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// This method is called at the beginning of the task.</span>
        <span class="token comment">// It schedules drivers for all the pipelines that have task life cycle.</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DriverSplitRunner</span><span class="token punctuation">&gt;</span></span> runners <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">DriverSplitRunnerFactory</span> driverRunnerFactory <span class="token operator">:</span> driverRunnerFactoriesWithTaskLifeCycle<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> driverRunnerFactory<span class="token punctuation">.</span><span class="token function">getDriverInstances</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                runners<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>driverRunnerFactory<span class="token punctuation">.</span><span class="token function">createDriverRunner</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">Lifespan</span><span class="token punctuation">.</span><span class="token function">taskWide</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// driverRunnerFactoriesWithTaskLifeCycle存储的是中继续Stage/PlanFragment对应的某个分区的DriverSplitRunners，因此可以立即执行</span>
        <span class="token function">enqueueDriverSplitRunner</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> runners<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">DriverSplitRunnerFactory</span> driverRunnerFactory <span class="token operator">:</span> driverRunnerFactoriesWithTaskLifeCycle<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            driverRunnerFactory<span class="token punctuation">.</span><span class="token function">noMoreDriverRunner</span><span class="token punctuation">(</span><span class="token class-name">ImmutableList</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Lifespan</span><span class="token punctuation">.</span><span class="token function">taskWide</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">verify</span><span class="token punctuation">(</span>driverRunnerFactory<span class="token punctuation">.</span><span class="token function">isNoMoreDriverRunner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="SqlTaskExecutionscheduleDriversForDriverGroupLifeCycle_2287"></a>SqlTaskExecution::scheduleDriversForDriverGroupLifeCycle</h4> 
<pre><code class="prism language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">scheduleDriversForDriverGroupLifeCycle</span><span class="token punctuation">(</span><span class="token class-name">Lifespan</span> lifespan<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// This method is called when a split that belongs to a previously unseen driver group is scheduled.</span>
        <span class="token comment">// It schedules drivers for all the pipelines that have driver group life cycle.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lifespan<span class="token punctuation">.</span><span class="token function">isTaskWide</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">checkArgument</span><span class="token punctuation">(</span>driverRunnerFactoriesWithDriverGroupLifeCycle<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Instantiating pipeline of driver group lifecycle at task level is not allowed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DriverSplitRunner</span><span class="token punctuation">&gt;</span></span> runners <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">DriverSplitRunnerFactory</span> driverSplitRunnerFactory <span class="token operator">:</span> driverRunnerFactoriesWithDriverGroupLifeCycle<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> driverSplitRunnerFactory<span class="token punctuation">.</span><span class="token function">getDriverInstances</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                runners<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>driverSplitRunnerFactory<span class="token punctuation">.</span><span class="token function">createDriverRunner</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> lifespan<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 与scheduleDriversForTaskLifeCycle方法类似，这里的DriverSplitRunners是属于某个中继Stage/PlanFragment，可以立即执行</span>
        <span class="token function">enqueueDriverSplitRunner</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> runners<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">DriverSplitRunnerFactory</span> driverRunnerFactory <span class="token operator">:</span> driverRunnerFactoriesWithDriverGroupLifeCycle<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            driverRunnerFactory<span class="token punctuation">.</span><span class="token function">noMoreDriverRunner</span><span class="token punctuation">(</span><span class="token class-name">ImmutableList</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>lifespan<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h2><a id="DriverSplitRunnerSplit_2312"></a>DriverSplitRunner的执行，基于时间片的Split调度</h2> 
<blockquote> 
 <p>DriverSplitRunner，负责应用一组物理<code>Operators到一个Split上</code>，表示一段完整的数据处理过程，且数据处理的最小单元是<code>Page</code>。</p> 
</blockquote> 
<p><font color="red">待后续的文章中详解，放在这里，篇幅过长了。</font></p> 
<h3><a id="PipelineOperators_2316"></a>Pipeline，就是一组可独立运行的Operators的描述</h3> 
<h3><a id="DriverPipelinePipelineDrivers_2317"></a>Driver是对Pipeline的执行实例，因此一个Pipeline可以由多个Drivers并行执行</h3> 
<h3><a id="_2318"></a>时间片</h3>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8c92c7c18e935539087c814ba4b3f0a6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">C&#43;&#43;获取GIF图片的长和宽</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6d1533ea935b0e958a7dde2baae402ff/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">支持向量机（Support Vector Machines，SVM）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>