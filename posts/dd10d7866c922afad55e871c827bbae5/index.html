<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>树莓派ROS stm32 slam Freertos VFH&#43;A*避障路径规划-智能平衡计划（四） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="树莓派ROS stm32 slam Freertos VFH&#43;A*避障路径规划-智能平衡计划（四）" />
<meta property="og:description" content="基于树莓派ROSstm32搭载Freertos智能平衡车Day4 前言一、PID控制功能小车直立行走任务分解平衡控制PID控制理论 start结构直立环速度环转向环PID控制原理以及实现小车直立环调节小车速度环调节小车转向环调节 实现代码 前言 PID控制功能原理与实现
提示：以下是本篇文章正文内容，下面案例可供参考
一、PID控制功能 小车直立行走任务分解 我们要求车模在直立的状态下以两个轮子在地面上随意行走，相比四轮
着地状态，车模控制任务更为复杂。为了能够方便找到解决问题的办法，首先将复杂的问题分解成简单的问题进行讨论。
从控制角度来看，车模作为一个控制对象，它的控制输入量是两个电机的转动速度。车模运动控制任务可以分解成以下三个基本控制任务
（1） 控制车模平衡：通过控制两个电机正反向运动保持车模直立平衡状态；
（2） 控制车模速度：通过调节车模的倾角来实现车模速度控制，实际上最后还是演变成通过控制电机的转速来实现车轮速度的控制。
（3） 控制车模方向：通过控制两个电机之间的转动差速实现车模转向控制
平衡控制 控制车模平衡的直观经验来自于人们日常生活经验。一般的人通过简单练习就可以让一个直木棒在手指尖上保持直立。这需要两个条件：一个是托着木棒的手掌可以移动；另一个是眼睛可以观察到木棒的倾斜角度和倾斜趋势（角速度）。通过手掌移动抵消木棒的倾斜角度和趋势，从而保持木棒的直立。这两个条件缺一不可，实际上就是控制中的负反馈机制。 PID控制理论 所谓PID算法，是一种在工程应用领域被使用最为广泛的反馈调节方法，通过PID算法中比例、积分、微分三个部分的作用，达到使系统稳定的效果
（1）比例调节：反应系统的基本（当前）偏差 e(t)，系数大，可以加快调节，减小误差，但过大的比例使系统稳定性下降，甚至造成系统不稳定；
（2）积分调节：反应系统的累计偏差，使系统消除稳态误差，提高无差度，因为有误差，积分调节就进行，直至无误差；
（3）微分调节：反映系统偏差信号的变化率 e(t)-e(t-1)，具有预见性，能预见偏差变化的趋势，产生超前的控制作用，在偏差还没有形成之前，已被微分调节作用消除，因此可以改善系统的动态性能。但是微分对噪声干扰有放大作用，加强微分对系统抗干扰不利。
注：积分和微分都不能单独起作用，必须与比例控制配合。
PID调节
根据直立小车平衡任务分解：
直立环
速度环
方向环
start 配置参考
树莓派ROS stm32 slam Freertos VFH&#43;A避障路径规划-智能平衡计划
树莓派ROS stm32 slam Freertos VFH&#43;A避障路径规划-智能平衡计划（三）
控制GPIO原理图也是参考以上
控制库代码contrl.c：
#include &#34;math.h&#34; #include &#34;stdlib.h&#34; #include &#34;stm32f4xx_hal.h&#34; #include &#34;contrl.h&#34; int Dead_Zone=1200; //电机死区 int control_turn=64; //转向控制 //PID调节参数 struct pid_arg PID = { .Balance_Kp=200, .Balance_Kd=1, ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/dd10d7866c922afad55e871c827bbae5/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-02-06T19:42:01+08:00" />
<meta property="article:modified_time" content="2021-02-06T19:42:01+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">树莓派ROS stm32 slam Freertos VFH&#43;A*避障路径规划-智能平衡计划（四）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>基于树莓派ROSstm32搭载Freertos智能平衡车Day4</h4> 
 <ul><li><a href="#_4" rel="nofollow">前言</a></li><li><a href="#PID_13" rel="nofollow">一、PID控制功能</a></li><li><ul><li><a href="#_14" rel="nofollow">小车直立行走任务分解</a></li><li><a href="#_24" rel="nofollow">平衡控制</a></li><li><ul><li><a href="#PID_28" rel="nofollow">PID控制理论</a></li></ul> 
   </li><li><a href="#start_44" rel="nofollow">start</a></li><li><a href="#_284" rel="nofollow">结构</a></li><li><a href="#PID_286" rel="nofollow">直立环速度环转向环PID控制原理以及实现</a></li><li><ul><li><a href="#_288" rel="nofollow">小车直立环调节</a></li><li><a href="#_327" rel="nofollow">小车速度环调节</a></li><li><a href="#_375" rel="nofollow">小车转向环调节</a></li></ul> 
   </li><li><a href="#_388" rel="nofollow">实现代码</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<hr color="#000000" size='1"'> 
<h2><a id="_4"></a>前言</h2> 
<p><font color="#999AAA">PID控制功能原理与实现</font></p> 
<hr color="#000000" size='1"'> 
<p><font color="#999AAA">提示：以下是本篇文章正文内容，下面案例可供参考</font></p> 
<h2><a id="PID_13"></a>一、PID控制功能</h2> 
<h3><a id="_14"></a>小车直立行走任务分解</h3> 
<p>我们要求车模在直立的状态下以两个轮子在地面上随意行走，相比四轮<br> 着地状态，车模控制任务更为复杂。为了能够方便找到解决问题的办法，首先将复杂的问题分解成简单的问题进行讨论。<br> 从控制角度来看，车模作为一个控制对象，它的控制输入量是两个电机的转动速度。车模运动控制任务可以分解成以下三个基本控制任务<br> （1） 控制车模平衡：通过控制两个电机正反向运动保持车模直立平衡状态；<br> （2） 控制车模速度：通过调节车模的倾角来实现车模速度控制，实际上最后还是演变成通过控制电机的转速来实现车轮速度的控制。<br> （3） 控制车模方向：通过控制两个电机之间的转动差速实现车模转向控制<br> <img src="https://images2.imgbox.com/d1/c7/8HeluVCJ_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/a1/e6/ogSjBGZt_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_24"></a>平衡控制</h3> 
<pre><code>    控制车模平衡的直观经验来自于人们日常生活经验。一般的人通过简单练习就可以让一个直木棒在手指尖上保持直立。这需要两个条件：一个是托着木棒的手掌可以移动；另一个是眼睛可以观察到木棒的倾斜角度和倾斜趋势（角速度）。通过手掌移动抵消木棒的倾斜角度和趋势，从而保持木棒的直立。这两个条件缺一不可，实际上就是控制中的负反馈机制。
</code></pre> 
<p><img src="https://images2.imgbox.com/8a/60/PSbX1YMT_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="PID_28"></a>PID控制理论</h4> 
<p>所谓PID算法，是一种在工程应用领域被使用最为广泛的反馈调节方法，通过PID算法中比例、积分、微分三个部分的作用，达到使系统稳定的效果<br> <img src="https://images2.imgbox.com/c6/65/2nD6axTN_o.png" alt="在这里插入图片描述"></p> 
<p>（1）比例调节：反应系统的基本（当前）偏差 e(t)，系数大，可以加快调节，减小误差，但过大的比例使系统稳定性下降，甚至造成系统不稳定；<br> （2）积分调节：反应系统的累计偏差，使系统消除稳态误差，提高无差度，因为有误差，积分调节就进行，直至无误差；<br> （3）微分调节：反映系统偏差信号的变化率 e(t)-e(t-1)，具有预见性，能预见偏差变化的趋势，产生超前的控制作用，在偏差还没有形成之前，已被微分调节作用消除，因此可以改善系统的动态性能。但是微分对噪声干扰有放大作用，加强微分对系统抗干扰不利。<br> 注：积分和微分都不能单独起作用，必须与比例控制配合。</p> 
<p>PID调节<br> <img src="https://images2.imgbox.com/33/4a/wuxfdtoz_o.png" alt="在这里插入图片描述"><br> 根据直立小车平衡任务分解：<br> 直立环<br> 速度环<br> 方向环</p> 
<h3><a id="start_44"></a>start</h3> 
<p>配置参考<br> <a href="https://blog.csdn.net/qq_44691051/article/details/113643902">树莓派ROS stm32 slam Freertos VFH+A<em>避障路径规划-智能平衡计划</em></a><br> <a href="https://blog.csdn.net/qq_44691051/article/details/113696438">树莓派ROS stm32 slam Freertos VFH+A避障路径规划-智能平衡计划（三）</a><br> 控制GPIO原理图也是参考以上</p> 
<p><font color="#999AAA">控制库代码contrl.c：</font></p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"math.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stdlib.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f4xx_hal.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"contrl.h"</span></span>

 



<span class="token keyword">int</span>   Dead_Zone<span class="token operator">=</span><span class="token number">1200</span><span class="token punctuation">;</span>    <span class="token comment">//电机死区</span>
<span class="token keyword">int</span>   control_turn<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">;</span>                             <span class="token comment">//转向控制</span>


<span class="token comment">//PID调节参数</span>
<span class="token keyword">struct</span> <span class="token class-name">pid_arg</span> PID <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span>Balance_Kp<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>Balance_Kd<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>Velocity_Kp<span class="token operator">=</span><span class="token operator">-</span><span class="token number">52</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>Velocity_Ki<span class="token operator">=</span><span class="token operator">-</span><span class="token number">0.26</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>Turn_Kp <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>Turn_Kd <span class="token operator">=</span> <span class="token number">0.18</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/**************************************************************************************************************
*函数名:Read_Encoder()
*功能:读取编码器值(当作小车当前前进的速度)
*形参:(u8 TIMX):x为编码器1或者2
*返回值:无
*************************************************************************************************************/</span>
<span class="token keyword">int</span> <span class="token function">Read_Encoder</span><span class="token punctuation">(</span>u8 TIMX<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> Encoder_TIM<span class="token punctuation">;</span>  
		
   <span class="token keyword">switch</span><span class="token punctuation">(</span>TIMX<span class="token punctuation">)</span>
	 <span class="token punctuation">{<!-- --></span>
	   <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>  Encoder_TIM<span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span>TIM1 <span class="token operator">-&gt;</span> CNT<span class="token punctuation">;</span>  TIM1 <span class="token operator">-&gt;</span> CNT<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>
		 <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>  Encoder_TIM<span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span>TIM2 <span class="token operator">-&gt;</span> CNT<span class="token punctuation">;</span>  TIM2 <span class="token operator">-&gt;</span> CNT<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>
		 <span class="token keyword">default</span><span class="token operator">:</span>  Encoder_TIM<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	 <span class="token punctuation">}</span>
		<span class="token keyword">return</span> Encoder_TIM<span class="token punctuation">;</span>
<span class="token punctuation">}</span>



<span class="token comment">/**************************************************************************************************************
*函数名:Vertical_Ring_PD()
*功能:直立环PD控制
*形参:(float Angle):x轴的角度/(float Gyro):x轴的角速度
*返回值:经过PID转换之后的PWM值
**************************************************************************************************************/</span>
<span class="token comment">//直立环的PD</span>


<span class="token keyword">int</span>	<span class="token function">Vertical_Ring_PD</span><span class="token punctuation">(</span><span class="token keyword">float</span> Angle<span class="token punctuation">,</span><span class="token keyword">float</span> Gyro<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	 <span class="token keyword">float</span> Bias<span class="token punctuation">;</span>
	 <span class="token keyword">int</span> balance<span class="token punctuation">;</span>
   Bias<span class="token operator">=</span>Angle<span class="token operator">-</span>Mechanical_balance<span class="token punctuation">;</span>
   balance<span class="token operator">=</span>PID<span class="token punctuation">.</span>Balance_Kp<span class="token operator">*</span>Bias<span class="token operator">+</span> Gyro<span class="token operator">*</span>PID<span class="token punctuation">.</span>Balance_Kd<span class="token punctuation">;</span>
	
	<span class="token keyword">return</span> balance<span class="token punctuation">;</span>
		
	 <span class="token comment">//printf("balance = %f\n",balance);</span>
<span class="token punctuation">}</span>


<span class="token comment">/**************************************************************************************************************
*函数名:Vertical_speed_PI()
*功能；速度环PI控制
*形参:(int encoder_left):左轮编码器值/(int encoder_right):编码器右轮的值/(float Angle):x轴角度值
*返回值:
**************************************************************************************************************/</span>

<span class="token keyword">int</span> <span class="token function">Vertical_speed_PI</span><span class="token punctuation">(</span><span class="token keyword">int</span> encoder_left<span class="token punctuation">,</span><span class="token keyword">int</span> encoder_right<span class="token punctuation">,</span><span class="token keyword">float</span> Angle<span class="token punctuation">,</span><span class="token keyword">float</span> Movement <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">static</span> <span class="token keyword">float</span> Velocity<span class="token punctuation">,</span>Encoder_Least<span class="token punctuation">,</span>Encoder<span class="token punctuation">;</span>
	<span class="token keyword">static</span> <span class="token keyword">float</span> Encoder_Integral<span class="token punctuation">;</span>
	Encoder_Least <span class="token operator">=</span><span class="token punctuation">(</span>encoder_left<span class="token operator">+</span>encoder_right<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">//获取最新速度偏差=测量速度（左右编码器之和）-目标速度（此处为零）</span>
	Encoder <span class="token operator">*=</span> <span class="token number">0.8f</span><span class="token punctuation">;</span>																	<span class="token comment">//一阶低通滤波器 ，上次的速度占85%</span>
	Encoder <span class="token operator">+=</span> Encoder_Least<span class="token operator">*</span><span class="token number">0.2f</span><span class="token punctuation">;</span>                   <span class="token comment">//一阶低通滤波器， 本次的速度占15% </span>
	Encoder_Integral <span class="token operator">+=</span>Encoder<span class="token punctuation">;</span>                       <span class="token comment">//积分出位移 积分时间：10ms</span>
	Encoder_Integral<span class="token operator">=</span>Encoder_Integral<span class="token operator">-</span>Movement<span class="token punctuation">;</span> 
	
	<span class="token keyword">if</span><span class="token punctuation">(</span>Encoder_Integral<span class="token operator">&gt;</span><span class="token number">10000</span><span class="token punctuation">)</span>  	Encoder_Integral<span class="token operator">=</span><span class="token number">10000</span><span class="token punctuation">;</span>           <span class="token comment">//积分限幅</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>Encoder_Integral<span class="token operator">&lt;</span><span class="token operator">-</span><span class="token number">10000</span><span class="token punctuation">)</span>	  Encoder_Integral<span class="token operator">=</span><span class="token operator">-</span><span class="token number">10000</span><span class="token punctuation">;</span>            <span class="token comment">//积分限幅</span>

	Velocity<span class="token operator">=</span>Encoder<span class="token operator">*</span>PID<span class="token punctuation">.</span>Velocity_Kp<span class="token operator">+</span>Encoder_Integral<span class="token operator">*</span>PID<span class="token punctuation">.</span>Velocity_Ki<span class="token punctuation">;</span>      <span class="token comment">//速度控制</span>
	
	
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">Turn_off</span><span class="token punctuation">(</span>Angle<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>   Encoder_Integral<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>            <span class="token comment">//电机关闭后清除积分</span>
	<span class="token keyword">return</span> Velocity<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/**************************************************************************************************************
*函数名:Vertical_turn_PD()
*功能:转向环PD
*形参:无  CCD小于34左转、CCD大于64右转。 yaw = z轴陀螺仪数值
*返回值:无
***************************************************************************************************************/</span>
<span class="token keyword">int</span> <span class="token function">Vertical_turn_PD</span><span class="token punctuation">(</span>u8 CCD<span class="token punctuation">,</span><span class="token keyword">short</span> yaw<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">float</span> Turn<span class="token punctuation">;</span>     
    <span class="token keyword">float</span> Bias<span class="token punctuation">;</span>	  
	  Bias<span class="token operator">=</span>CCD<span class="token operator">-</span><span class="token number">64</span><span class="token punctuation">;</span>
	  Turn<span class="token operator">=</span><span class="token operator">-</span>Bias<span class="token operator">*</span>PID<span class="token punctuation">.</span>Turn_Kp<span class="token operator">-</span>yaw<span class="token operator">*</span>PID<span class="token punctuation">.</span>Turn_Kd<span class="token punctuation">;</span>
	  <span class="token keyword">return</span> Turn<span class="token punctuation">;</span>
<span class="token punctuation">}</span>



<span class="token comment">/**************************************************************************************************************
*函数名:PWM_Limiting()
*功能:PWM限幅函数
*形参:无
*返回值:无
***************************************************************************************************************/</span>
<span class="token keyword">void</span> <span class="token function">PWM_Limiting</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>motor1<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>motor2<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> Amplitude<span class="token operator">=</span><span class="token number">5800</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>motor1<span class="token operator">&lt;</span><span class="token operator">-</span>Amplitude<span class="token punctuation">)</span> <span class="token operator">*</span>motor1<span class="token operator">=</span><span class="token operator">-</span>Amplitude<span class="token punctuation">;</span>	
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>motor1<span class="token operator">&gt;</span>Amplitude<span class="token punctuation">)</span>  <span class="token operator">*</span>motor1<span class="token operator">=</span>Amplitude<span class="token punctuation">;</span>	
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>motor2<span class="token operator">&lt;</span><span class="token operator">-</span>Amplitude<span class="token punctuation">)</span> <span class="token operator">*</span>motor2<span class="token operator">=</span><span class="token operator">-</span>Amplitude<span class="token punctuation">;</span>	
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>motor2<span class="token operator">&gt;</span>Amplitude<span class="token punctuation">)</span>  <span class="token operator">*</span>motor2<span class="token operator">=</span>Amplitude<span class="token punctuation">;</span>		
<span class="token punctuation">}</span>


<span class="token comment">/**************************************************************************************************************
*函数名:Turn_off()
*功能:关闭电机
*形参:(const float Angle):x轴角度值
*返回值:1:小车当前处于停止状态/0:小车当前处于正常状态
***************************************************************************************************************/</span>
u8 FS_state<span class="token punctuation">;</span>

u8 <span class="token function">Turn_off</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">float</span> Angle<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u8 temp<span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">fabs</span><span class="token punctuation">(</span>Angle<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		FS_state<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
		temp<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token function">AIN2</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>			<span class="token function">AIN1</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">BIN1</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>			<span class="token function">BIN2</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> 
		temp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
		FS_state<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> temp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**************************************************************************************************************
*函数名:Set_PWM()
*功能:输出PWM控制电机
*形参；(int motor1):电机1对应的PWM值/(int motor2):电机2对应的PWM值
*返回值:无
*************************************************************************************************************/</span>


<span class="token keyword">void</span> <span class="token function">Set_PWM</span><span class="token punctuation">(</span><span class="token keyword">int</span> motor1<span class="token punctuation">,</span><span class="token keyword">int</span> motor2<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>motor1<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span>			<span class="token function">AIN2</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>			<span class="token function">AIN1</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span> 	          	<span class="token function">AIN2</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>			<span class="token function">AIN1</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	PWMA<span class="token operator">=</span>Dead_Zone<span class="token operator">+</span><span class="token punctuation">(</span><span class="token function">abs</span><span class="token punctuation">(</span>motor1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1.17</span><span class="token punctuation">;</span>
	
	
	<span class="token keyword">if</span><span class="token punctuation">(</span>motor2<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span>			<span class="token function">BIN1</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>			<span class="token function">BIN2</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span>       		 		<span class="token function">BIN1</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>			<span class="token function">BIN2</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	PWMB<span class="token operator">=</span>Dead_Zone<span class="token operator">+</span><span class="token punctuation">(</span><span class="token function">abs</span><span class="token punctuation">(</span>motor2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1.17</span><span class="token punctuation">;</span>	
	
<span class="token comment">//	printf("PWMA = %d\n",PWMA);</span>
<span class="token comment">//	printf("PWMB = %d\n",PWMB);</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><font color="#999AAA">控制库代码contrl.h：</font></p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_CONTRIL_H_</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_CONTRIL_H_</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sys.h"</span></span>


<span class="token comment">//机械0点</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">Mechanical_balance</span> <span class="token expression"><span class="token number">0</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">AIN1</span><span class="token expression"><span class="token punctuation">(</span>PinState<span class="token punctuation">)</span>    <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span> GPIOE<span class="token punctuation">,</span> GPIO_PIN_13<span class="token punctuation">,</span> <span class="token punctuation">(</span>GPIO_PinState<span class="token punctuation">)</span>PinState<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">AIN2</span><span class="token expression"><span class="token punctuation">(</span>PinState<span class="token punctuation">)</span>    <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span> GPIOE<span class="token punctuation">,</span> GPIO_PIN_15<span class="token punctuation">,</span> <span class="token punctuation">(</span>GPIO_PinState<span class="token punctuation">)</span>PinState<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">BIN1</span><span class="token expression"><span class="token punctuation">(</span>PinState<span class="token punctuation">)</span>    <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span> GPIOC<span class="token punctuation">,</span> GPIO_PIN_3<span class="token punctuation">,</span> <span class="token punctuation">(</span>GPIO_PinState<span class="token punctuation">)</span>PinState<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">BIN2</span><span class="token expression"><span class="token punctuation">(</span>PinState<span class="token punctuation">)</span>    <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span> GPIOA<span class="token punctuation">,</span> GPIO_PIN_3<span class="token punctuation">,</span> <span class="token punctuation">(</span>GPIO_PinState<span class="token punctuation">)</span>PinState<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PWMA</span>   <span class="token expression">TIM4<span class="token operator">-&gt;</span>CCR1 </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PWMB</span>   <span class="token expression">TIM5<span class="token operator">-&gt;</span>CCR3</span></span>



<span class="token keyword">extern</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> Encoder_Left<span class="token punctuation">,</span>Encoder_Right<span class="token punctuation">;</span>		      <span class="token comment">//编码器左右速度值</span>

<span class="token keyword">struct</span> <span class="token class-name">pid_arg</span><span class="token punctuation">{<!-- --></span>
	
	<span class="token keyword">float</span> Balance_Kp<span class="token punctuation">;</span>
	<span class="token keyword">float</span> Balance_Ki<span class="token punctuation">;</span>
	<span class="token keyword">float</span> Balance_Kd<span class="token punctuation">;</span>
	
	<span class="token keyword">float</span> Velocity_Kp<span class="token punctuation">;</span>
	<span class="token keyword">float</span> Velocity_Ki<span class="token punctuation">;</span>
	<span class="token keyword">float</span> Velocity_Kd<span class="token punctuation">;</span>
	
	<span class="token keyword">float</span>  Turn_Kp<span class="token punctuation">;</span>
	<span class="token keyword">float</span>  Turn_Ki<span class="token punctuation">;</span>
	<span class="token keyword">float</span>  Turn_Kd<span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">struct</span> <span class="token class-name">pid_arg</span> PID<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">Read_Encoder</span><span class="token punctuation">(</span>u8 TIMX<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>	<span class="token function">Vertical_Ring_PD</span><span class="token punctuation">(</span><span class="token keyword">float</span> Angle<span class="token punctuation">,</span><span class="token keyword">float</span> Gyro<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">Vertical_speed_PI</span><span class="token punctuation">(</span><span class="token keyword">int</span> encoder_left<span class="token punctuation">,</span><span class="token keyword">int</span> encoder_right<span class="token punctuation">,</span><span class="token keyword">float</span> Angle<span class="token punctuation">,</span><span class="token keyword">float</span> Movement <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">Vertical_turn_PD</span><span class="token punctuation">(</span>u8 CCD<span class="token punctuation">,</span><span class="token keyword">short</span> yaw<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">void</span> <span class="token function">PWM_Limiting</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>motor1<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>motor2<span class="token punctuation">)</span><span class="token punctuation">;</span>
u8 <span class="token function">Turn_off</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">float</span> Angle<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">Set_PWM</span><span class="token punctuation">(</span><span class="token keyword">int</span> motor1<span class="token punctuation">,</span><span class="token keyword">int</span> motor2<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>


</code></pre> 
<h3><a id="_284"></a>结构</h3> 
<p><img src="https://images2.imgbox.com/90/0c/FfqEsvb1_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="PID_286"></a>直立环速度环转向环PID控制原理以及实现</h3> 
<h4><a id="_288"></a>小车直立环调节</h4> 
<pre><code class="prism language-c">    平衡小车直立环使用PD（比例微分）控制器，其实一般的控制系统单纯的P控制或者PI控制就可以了，但是那些对干扰要做出迅速响应的控制过程需要D（微分）控制。

<span class="token comment">//形参:(float Angle):小车的俯仰角 /(float Gyro):x轴的角速度</span>
Int    <span class="token function">Vertical_Ring_PD</span><span class="token punctuation">(</span><span class="token keyword">float</span> Angle<span class="token punctuation">,</span> <span class="token keyword">float</span> Gyro<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	 <span class="token keyword">float</span> Bias<span class="token punctuation">;</span>
	 <span class="token keyword">int</span> balance<span class="token punctuation">;</span>
   	 Bias<span class="token operator">=</span>Angle<span class="token operator">-</span>Mechanical_balance<span class="token punctuation">;</span>                                         <span class="token comment">//计算直立偏差</span>
  	 balance<span class="token operator">=</span>PID<span class="token punctuation">.</span>Balance_Kp<span class="token operator">*</span>Bias <span class="token operator">+</span>  Gyro<span class="token operator">*</span>PID<span class="token punctuation">.</span>Balance_Kd<span class="token punctuation">;</span>       <span class="token comment">//计算直立PWM</span>
	
	<span class="token keyword">return</span> balance<span class="token punctuation">;</span>                                                                       <span class="token comment">//返回直立PWM</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>直立环的调试过程包括确定平衡小车的机械中值、确定kp值的极性（也就是正负号）和大小、kd值的极性和大小等步骤。</p> 
<p>1、确定平衡车的机械中值：<br> 把平衡小车放在地面上，绕电机轴旋转平衡小车，记录能让小车接近平衡的角度，一般都在0°附近的。我们调试的小车正好是0度，所以就是Bias=Angle-0<br> 2_1、确定kp值的极性（令kd=0）<br> 首先我们估计kp的取值范围。我们的PWM设置的是8000代表占空比100%，再考虑避免电机的死区，我们直立环返回的PWM在6000左右的时候电机就会满载。<br> 假如我们设定kp值为800，那么平衡小车在±10°的时候就会满转。根据我们的感性认识，这显然太大了，那我们就可以估计kp值在0~800之间。<br> 首先大概我们给一个值kp=-200,我们可以观察到，小车往哪边倒，电机会往那边加速让小车到下，就是一个我们不愿看到的正反馈的效果。说明kp值的极性反了，接下来我们设定kp=200,这个时候可以看到平衡小车有直立的趋势，虽然响应太慢，但是，我们可以确定kp值是正的。具体的数据接下来再仔细调试。</p> 
<p>2_2 、确定kp值的大小（令kd=0）</p> 
<p>设定kp=100,这个时候我们可以看到，小车虽然有平衡的趋势，但是显然响应有点慢了。<br> 设定kp=250,这个时候我们可以看到，小车虽然有平衡的趋势，而且响应有所加快，总体感觉良好。<br> 设定kp=400,这个时候我们可以看到，小车的响应明显加快，而且来回推动小车的时候，会有一定幅度的低频抖动。说明这个时候kp值已经足够大了，需要增加微分控制削弱p控制，抑制低频抖动。</p> 
<pre><code>经过总体比较： 我们选择参数为kp = 200；
3_1、确定kd值的极性（令kp=0）
  我们得到的MPU6050输出的陀螺仪的原始数据，通过观察数据，我们发现最大值不会超过4位数，再根据8000代表占空比100%，所以我们估算kd值应该在0~2之间
  我们先设定kd=-0.5，当我们拿起小车旋转的时候，车轮会反向转动，并没有能够实现跟随效果。这说明了kd的极性反了。
  接下来，我们设定kd=0.5,这个时候我们可以看到，当我们旋转小车的时候，车轮会同向以相同的速度跟随转动，这说明我们实现了角速度闭环，至此，我们可以确定kd的极性是正的。具体的数据接下来再仔细调试。
</code></pre> 
<p>最终我们选择kd = 1;</p> 
<h4><a id="_327"></a>小车速度环调节</h4> 
<p>为什么要PID速度调节？<br> （1）假设车模在上面直立控制调节下已经能够保持平衡了，但是由于安装误差，传感器实际测量的角度与车模角度有偏差，因此车模实际不是保持与地面垂直，而是存在一个倾角。在重力的作用下，车模就会朝倾斜的方向加速前进。如果没有速度调节是难以维持0速度的<br> （2）对于直立车模速度的控制相对于普通车模的速度控制则比较复杂。由于在速度控制过程中需要始终保持车模的平衡，因此车模速度控制不能够直接通过改变电机转速来实现。也是需要通过PID速度调节来实现<br> <img src="https://images2.imgbox.com/3b/fa/cZkUtPq1_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">Vertical_speed_PI</span><span class="token punctuation">(</span><span class="token keyword">int</span> encoder_left<span class="token punctuation">,</span><span class="token keyword">int</span> encoder_right<span class="token punctuation">,</span><span class="token keyword">float</span> Angle<span class="token punctuation">,</span><span class="token keyword">float</span> Movement <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">static</span> <span class="token keyword">float</span> Velocity<span class="token punctuation">,</span>Encoder_Least<span class="token punctuation">,</span>Encoder<span class="token punctuation">;</span>
	<span class="token keyword">static</span> <span class="token keyword">float</span> Encoder_Integral<span class="token punctuation">;</span>
                    <span class="token comment">//获取最新速度偏差=测量速度（左右编码器之和）-目标速度（此处为零）</span>
	Encoder_Least <span class="token operator">=</span><span class="token punctuation">(</span>encoder_left<span class="token operator">+</span>encoder_right<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0</span><span class="token punctuation">;</span> 
	Encoder <span class="token operator">*=</span> <span class="token number">0.85f</span><span class="token punctuation">;</span>	                                        <span class="token comment">//一阶低通滤波器 ，上次的速度占85%				Encoder += Encoder_Least*0.15f;                          //一阶低通滤波器， 本次的速度占15% ，减缓速度突变对直立的干扰</span>
	Encoder_Integral <span class="token operator">+=</span>Encoder<span class="token punctuation">;</span>                                 <span class="token comment">//积分出位移 积分时间：10ms</span>
	Encoder_Integral<span class="token operator">=</span>Encoder_Integral<span class="token operator">-</span>Movement<span class="token punctuation">;</span> 
	
	<span class="token keyword">if</span><span class="token punctuation">(</span>Encoder_Integral<span class="token operator">&gt;</span><span class="token number">10000</span><span class="token punctuation">)</span>  	Encoder_Integral<span class="token operator">=</span><span class="token number">10000</span><span class="token punctuation">;</span>             <span class="token comment">//积分限幅</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>Encoder_Integral<span class="token operator">&lt;</span><span class="token operator">-</span><span class="token number">10000</span><span class="token punctuation">)</span>	Encoder_Integral<span class="token operator">=</span><span class="token operator">-</span><span class="token number">10000</span><span class="token punctuation">;</span>            <span class="token comment">//积分限幅</span>

	Velocity<span class="token operator">=</span>Encoder<span class="token operator">*</span>PID<span class="token punctuation">.</span>Velocity_Kp<span class="token operator">+</span>Encoder_Integral<span class="token operator">*</span>PID<span class="token punctuation">.</span>Velocity_Ki<span class="token punctuation">;</span>      <span class="token comment">//速度控制</span>
	
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">Turn_off</span><span class="token punctuation">(</span>Angle<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>   Encoder_Integral<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>            <span class="token comment">//电机关闭后清除积分</span>
	<span class="token keyword">return</span> Velocity<span class="token punctuation">;</span>                                                            <span class="token comment">//返回速度环PWM</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>确定kp的范围：<br> 积分项由偏差的积分得到,所以积分控制和比例控制的极性相同的,而根据工程经验,在不同的系统中,PID 参数相互之间会有一定的比例关系。在我们的平衡小车速度控制系统里面,一般我们可以把ki 值设置为<br> ki = kp/200<br> 这样,只要我们可以得到kp 值的大小和极性,就可以完成速度控制部分的参数整定了。显然,这样大大缩短了PID 参数整定的时间。<br> 我们通过STM32定时器的编码器接口模式对编码器进行四倍频,并使用M 法测速(每10ms 的脉冲数)得到小车的速度信息,通过观察数据,我们发现两路编码器相加最大值在160左右,而由经验可知,一般平衡小车行驶的最快速度不会超过电机最大速度的40%,再根据PWM = 6000时，在加上电机死区、占空比接近100%,我们可以大概估算<br> kp 最大值=6000/(160*40%)=93.75</p> 
<p>2_1、确定kp值的极性（关闭直立环）<br> 确定速度环调节为正负馈的调节：<br> 当小车以一定的速度运行的时候,我们要让小车停下来,小车需要行驶更快的速度去“追”,小车运行的速度越快,去“追”的速度也就越快,所以这是一个正反馈的效果。如果使用常规的速度负反馈,当小车以一定的速度运行的时候,我们通过减速让小车慢下来,小车会因为惯性向前倒下。<br> 判断速度控制是正反馈还是负反馈：<br> 根据之前的估计,先设定kp=50,ki=kp/200,当我们拿起小车,旋转其中一个小车轮胎的时候,根据我们设定的速度偏差<br> Encoder_Least =(Encoder_Left+Encoder_Right)-0;<br> 另外一个车轮会反向转动,让偏差趋向于零。这就是常规的速度控制里面的负反馈,不是我们需要的效果。接下来设定kp=-50,ki=kp/200,此时,当我们旋转其中一个小车轮胎的时候,两个轮胎会往相同的方向加速,直至电机的最大速度,这是典型的正反馈效果,也是我们期望看到的。至此,我们可以确定kp,ki<br> 2_1、确定kp值的极性（打开直立环）</p> 
<pre><code>首先,设定kp=-30,ki=kp/200这个时候我们可以看到,小车的速度控制比较弱,很难让速度恒定。
设定kp=-50,ki=kp/200这个时候我们可以看到,小车的速度控制的响应有所加快, 静止抖动可接受。
设定kp=-70,ki=kp/200这个时候我们可以看到,小车虽然回正力度增大了,而且响应更加快了,但是稍微加入一点的干扰都会让小车大幅度摆动,抗干扰能力明显不足,所以这组参数不可取。

至此,速度控制调试部分就告一段落了
</code></pre> 
<h4><a id="_375"></a>小车转向环调节</h4> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">Vertical_turn_PD</span><span class="token punctuation">(</span>u8 CCD<span class="token punctuation">,</span><span class="token keyword">short</span> yaw<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	 <span class="token keyword">float</span> Turn<span class="token punctuation">;</span>     
    	 <span class="token keyword">float</span> Bias<span class="token punctuation">;</span>	                                          <span class="token comment">//目标角度</span>
	  Bias<span class="token operator">=</span>CCD<span class="token operator">-</span><span class="token number">64</span><span class="token punctuation">;</span>
	  Turn<span class="token operator">=</span><span class="token operator">-</span>Bias<span class="token operator">*</span>PID<span class="token punctuation">.</span>Turn_Kp<span class="token operator">-</span>yaw<span class="token operator">*</span>PID<span class="token punctuation">.</span>Turn_Kd<span class="token punctuation">;</span>
	  <span class="token keyword">return</span> Turn<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre> 
<h3><a id="_388"></a>实现代码</h3> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"car_task.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mpu6050.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"inv_mpu_user.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"contrl.h"</span></span>


<span class="token keyword">int</span>  Balance_Pwm<span class="token punctuation">,</span>Velocity_Pwm<span class="token punctuation">,</span>Turn_Pwm<span class="token punctuation">;</span>        <span class="token comment">//PID计算的PWM值</span>
<span class="token keyword">int</span>  Motor1<span class="token punctuation">,</span> Motor2<span class="token punctuation">;</span>                  <span class="token comment">//左右电机PWM值</span>
<span class="token keyword">int</span>  Encoder_left<span class="token punctuation">,</span> Encoder_right<span class="token punctuation">;</span>     <span class="token comment">//检测速度</span>
<span class="token keyword">float</span> Movement <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                   <span class="token comment">//速度调节  </span>
<span class="token keyword">int</span>  Contrl_Turn <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">;</span>                <span class="token comment">//转向调节变量</span>

<span class="token comment">//环境数据采集任务</span>
<span class="token keyword">void</span> <span class="token function">Car_Task_200HZ</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">mpu6050_data</span> Last_Data<span class="token punctuation">;</span>
	
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">mpu_dmp_get_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span><span class="token number">0</span> <span class="token punctuation">)</span>
			OutMpu <span class="token operator">=</span> Last_Data<span class="token punctuation">;</span>
		<span class="token keyword">else</span>
			 Last_Data <span class="token operator">=</span> OutMpu<span class="token punctuation">;</span>
			
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Car_Task_100HZ</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	
	Encoder_left  <span class="token operator">=</span> <span class="token function">Read_Encoder</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	Encoder_right <span class="token operator">=</span> <span class="token operator">-</span><span class="token function">Read_Encoder</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//1、确定直立环PWM</span>
	
		Balance_Pwm <span class="token operator">=</span> <span class="token function">Vertical_Ring_PD</span><span class="token punctuation">(</span>OutMpu<span class="token punctuation">.</span>pitch<span class="token punctuation">,</span> OutMpu<span class="token punctuation">.</span>gyro_x<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//2、确定速度环PWM</span>
	
	  Velocity_Pwm <span class="token operator">=</span> <span class="token function">Vertical_speed_PI</span><span class="token punctuation">(</span>Encoder_left<span class="token punctuation">,</span>Encoder_right<span class="token punctuation">,</span>OutMpu<span class="token punctuation">.</span>pitch<span class="token punctuation">,</span> Movement <span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	
	<span class="token comment">//3、确定转向环PWM</span>
	
		Turn_Pwm <span class="token operator">=</span> <span class="token function">Vertical_turn_PD</span><span class="token punctuation">(</span>Contrl_Turn<span class="token punctuation">,</span> OutMpu<span class="token punctuation">.</span>gyro_z<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//4、确定最终左右电机的PWM</span>
		Motor1 <span class="token operator">=</span> Balance_Pwm <span class="token operator">+</span> Velocity_Pwm <span class="token operator">+</span> Turn_Pwm<span class="token punctuation">;</span>
	  Motor2 <span class="token operator">=</span> Balance_Pwm <span class="token operator">+</span> Velocity_Pwm <span class="token operator">-</span> Turn_Pwm<span class="token punctuation">;</span>
	
		<span class="token function">PWM_Limiting</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Motor1<span class="token punctuation">,</span><span class="token operator">&amp;</span>Motor2<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	
	<span class="token comment">//5、设置电机</span>
		<span class="token function">Set_PWM</span><span class="token punctuation">(</span>Motor1<span class="token punctuation">,</span>Motor2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span> <span class="token function">Car_Task_5HZ</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token comment">//		printf("acc_x = %d\n",OutMpu.acc_x);</span>
<span class="token comment">//		printf("acc_y = %d\n",OutMpu.acc_y);</span>
<span class="token comment">//		printf("acc_z = %d\n",OutMpu.acc_z);</span>
<span class="token comment">//		printf("gyro_x = %d\n",OutMpu.gyro_x);</span>
<span class="token comment">//		printf("gyro_y = %d\n",OutMpu.gyro_y);</span>
<span class="token comment">//		printf("gyro_z = %d\n",OutMpu.gyro_z);</span>
<span class="token comment">//	  printf("pitch = %f\n",OutMpu.pitch);</span>
<span class="token comment">//	  printf("roll = %f\n",OutMpu.roll);</span>
<span class="token comment">//	  printf("yaw = %f\n",OutMpu.yaw);</span>
	
	 <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Encoder_left = %d\n"</span><span class="token punctuation">,</span>Encoder_left<span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Encoder_left = %d\n"</span><span class="token punctuation">,</span>Encoder_right<span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>



</code></pre> 
<p><font color="#999AAA">控制库代码freertos.c：</font></p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">StartTask_200HZ</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token keyword">const</span> <span class="token operator">*</span> argument<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

  <span class="token comment">/* USER CODE BEGIN StartTask_200HZ */</span>
	
	<span class="token comment">//printf("环境采集进程运行\n");</span>
	
	
	<span class="token function">MPU_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">mpu_dmp_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
  <span class="token comment">/* Infinite loop */</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
		
		<span class="token function">Car_Task_200HZ</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
    <span class="token function">osDelay</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/* USER CODE END StartTask_200HZ */</span>
<span class="token punctuation">}</span>

<span class="token comment">/* StartTask_100HZ function */</span>
<span class="token keyword">void</span> <span class="token function">StartTask_100HZ</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token keyword">const</span> <span class="token operator">*</span> argument<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token comment">/* USER CODE BEGIN StartTask_100HZ */</span>
	
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"PID控制进程运行\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	
  <span class="token comment">/* Infinite loop */</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
		
		<span class="token function">Car_Task_100HZ</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">osDelay</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/* USER CODE END StartTask_100HZ */</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>其中PID控制理论见大学课本</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/dd180f2bb86da19e15fb1aafaab17e69/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">使用python tkinter开发一个爬取B站直播弹幕的工具</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ec7733f09928d95e453c515b440eb0b5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">HTML5-11【audio标签与video标签及基本应用】</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>