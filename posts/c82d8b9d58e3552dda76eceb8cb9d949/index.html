<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>三、MongoDB的聚合操作-笔记 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="三、MongoDB的聚合操作-笔记" />
<meta property="og:description" content="MongoDB的聚合操作 一、MongoDB聚合二、单一作用聚合三、聚合管道3.1 什么是MongoDB聚合框架3.2 管道（Pipeline）和阶段（Stage）3.3 常用的管道聚合阶段3.3.1 聚合表达式3.3.2 $project3.3.2 $match3.3.2 $count3.3.3 $group3.3.4 $unwind3.3.5 $limit3.3.6 $skip3.3.7 $sort3.3.8 $lookup 3.4 聚合操作案例13.5 聚合操作案例23.5.1 返回人口超过500万的州3.5.2 返回各州平均城市人口 四、MapReduce操作 一、MongoDB聚合 MongoDB 中聚合(aggregate)主要用于处理数据(诸如统计平均值，求和等)，并返回计算后的数据结果。 类似 S Q L 语句中的 c o u n t ( ∗ ) 。 \color{red}{类似 SQL 语句中的 count(*)。} 类似SQL语句中的count(∗)。
聚合操作处理数据记录并返回计算结果 \color{red}{聚合操作处理数据记录并返回计算结果} 聚合操作处理数据记录并返回计算结果。聚合操作组值来自多个文档，可以对分组数据执行各种操作以返回单个结果聚合操作包含三类： 单一作用聚合、聚合管道、 M a p R e d u c e 。 \color{red}{单一作用聚合、聚合管道、MapReduce。} 单一作用聚合、聚合管道、MapReduce。 单一作用聚合：提供了对常见聚合过程的简单访问， 操作单个集合聚合文档 \color{red}{操作单个集合聚合文档} 操作单个集合聚合文档 聚合管道是一个数据聚合的框架，模型基于数据处理流水线的概念 \color{red}{聚合管道是一个数据聚合的框架，模型基于数据处理流水线的概念} 聚合管道是一个数据聚合的框架，模型基于数据处理流水线的概念。文档进入多级管道，将文档转换为聚合结果MapReduce操作具有两个阶段： 处理每个文档并向每个输入文档发射一个或多个对象的 m a p 阶段 \color{red}{处理每个文档并向每个输入文档发射一个或多个对象的map阶段} 处理每个文档并向每个输入文档发射一个或多个对象的map阶段， 以及 r e d u c e 组合 m a p 操作的输出阶段。 \color{red}{以及reduce组合map操作的输出阶段。} 以及reduce组合map操作的输出阶段。 语法" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/c82d8b9d58e3552dda76eceb8cb9d949/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-01T18:41:39+08:00" />
<meta property="article:modified_time" content="2023-03-01T18:41:39+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">三、MongoDB的聚合操作-笔记</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>MongoDB的聚合操作</h4> 
 <ul><li><a href="#MongoDB_1" rel="nofollow">一、MongoDB聚合</a></li><li><a href="#_18" rel="nofollow">二、单一作用聚合</a></li><li><a href="#_47" rel="nofollow">三、聚合管道</a></li><li><ul><li><a href="#31_MongoDB_48" rel="nofollow">3.1 什么是MongoDB聚合框架</a></li><li><a href="#32_PipelineStage_56" rel="nofollow">3.2 管道（Pipeline）和阶段（Stage）</a></li><li><a href="#33__81" rel="nofollow">3.3 常用的管道聚合阶段</a></li><li><ul><li><a href="#331__102" rel="nofollow">3.3.1 聚合表达式</a></li><li><a href="#332_project_140" rel="nofollow">3.3.2 $project</a></li><li><a href="#332_match_234" rel="nofollow">3.3.2 $match</a></li><li><a href="#332_count_254" rel="nofollow">3.3.2 $count</a></li><li><a href="#333_group_263" rel="nofollow">3.3.3 $group</a></li><li><a href="#334_unwind_352" rel="nofollow">3.3.4 $unwind</a></li><li><a href="#335_limit_493" rel="nofollow">3.3.5 $limit</a></li><li><a href="#336_skip_505" rel="nofollow">3.3.6 $skip</a></li><li><a href="#337_sort_514" rel="nofollow">3.3.7 $sort</a></li><li><a href="#338_lookup_528" rel="nofollow">3.3.8 $lookup</a></li></ul> 
   </li><li><a href="#34_1_655" rel="nofollow">3.4 聚合操作案例1</a></li><li><a href="#35_2_701" rel="nofollow">3.5 聚合操作案例2</a></li><li><ul><li><a href="#351_500_721" rel="nofollow">3.5.1 返回人口超过500万的州</a></li><li><a href="#352__754" rel="nofollow">3.5.2 返回各州平均城市人口</a></li></ul> 
  </li></ul> 
  </li><li><a href="#MapReduce_936" rel="nofollow">四、MapReduce操作</a></li></ul> 
</div> 
<p></p> 
<h2><a id="MongoDB_1"></a>一、MongoDB聚合</h2> 
<hr> 
<ul><li>MongoDB 中聚合(aggregate)主要用于处理数据(诸如统计平均值，求和等)，并返回计算后的数据结果。</li></ul> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
         
         
           类似 
          
         
           S 
          
         
           Q 
          
         
           L 
          
         
           语句中的 
          
         
           c 
          
         
           o 
          
         
           u 
          
         
           n 
          
         
           t 
          
         
           ( 
          
         
           ∗ 
          
         
           ) 
          
         
           。 
          
         
        
       
      
        \color{red}{类似 SQL 语句中的 count(*)。} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">类似</span><span class="mord mathnormal" style="color: red;">SQ</span><span class="mord mathnormal" style="color: red;">L</span><span class="mord cjk_fallback" style="color: red;">语句中的</span><span class="mord mathnormal" style="color: red;">co</span><span class="mord mathnormal" style="color: red;">u</span><span class="mord mathnormal" style="color: red;">n</span><span class="mord mathnormal" style="color: red;">t</span><span class="mopen" style="color: red;">(</span><span class="mord" style="color: red;">∗</span><span class="mclose" style="color: red;">)</span><span class="mord cjk_fallback" style="color: red;">。</span></span></span></span></span></span></p> 
<ul><li><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           聚合操作处理数据记录并返回计算结果 
          
         
        
       
         \color{red}{聚合操作处理数据记录并返回计算结果} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">聚合操作处理数据记录并返回计算结果</span></span></span></span></span></span>。聚合操作组值来自多个文档，可以对分组数据执行各种操作以返回单个结果</li><li>聚合操作包含三类：<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
          
            单一作用聚合、聚合管道、 
           
          
            M 
           
          
            a 
           
          
            p 
           
          
            R 
           
          
            e 
           
          
            d 
           
          
            u 
           
          
            c 
           
          
            e 
           
          
            。 
           
          
         
        
       
         \color{red}{单一作用聚合、聚合管道、MapReduce。} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">单一作用聚合、聚合管道、</span><span class="mord mathnormal" style="margin-right: 0.109em; color: red;">M</span><span class="mord mathnormal" style="color: red;">a</span><span class="mord mathnormal" style="margin-right: 0.0077em; color: red;">pR</span><span class="mord mathnormal" style="color: red;">e</span><span class="mord mathnormal" style="color: red;">d</span><span class="mord mathnormal" style="color: red;">u</span><span class="mord mathnormal" style="color: red;">ce</span><span class="mord cjk_fallback" style="color: red;">。</span></span></span></span></span></span> 
  <ul><li>单一作用聚合：提供了对常见聚合过程的简单访问，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
        
         
          
           
           
             操作单个集合聚合文档 
            
           
          
         
           \color{red}{操作单个集合聚合文档} 
          
         
       </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">操作单个集合聚合文档</span></span></span></span></span></span></li><li><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
        
         
          
           
           
             聚合管道是一个数据聚合的框架，模型基于数据处理流水线的概念 
            
           
          
         
           \color{red}{聚合管道是一个数据聚合的框架，模型基于数据处理流水线的概念} 
          
         
       </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">聚合管道是一个数据聚合的框架，模型基于数据处理流水线的概念</span></span></span></span></span></span>。文档进入多级管道，将文档转换为聚合结果</li><li>MapReduce操作具有两个阶段：<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
        
         
          
           
            
            
              处理每个文档并向每个输入文档发射一个或多个对象的 
             
            
              m 
             
            
              a 
             
            
              p 
             
            
              阶段 
             
            
           
          
         
           \color{red}{处理每个文档并向每个输入文档发射一个或多个对象的map阶段} 
          
         
       </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">处理每个文档并向每个输入文档发射一个或多个对象的</span><span class="mord mathnormal" style="color: red;">ma</span><span class="mord mathnormal" style="color: red;">p</span><span class="mord cjk_fallback" style="color: red;">阶段</span></span></span></span></span></span>，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
        
         
          
           
            
            
              以及 
             
            
              r 
             
            
              e 
             
            
              d 
             
            
              u 
             
            
              c 
             
            
              e 
             
            
              组合 
             
            
              m 
             
            
              a 
             
            
              p 
             
            
              操作的输出阶段。 
             
            
           
          
         
           \color{red}{以及reduce组合map操作的输出阶段。} 
          
         
       </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">以及</span><span class="mord mathnormal" style="color: red;">re</span><span class="mord mathnormal" style="color: red;">d</span><span class="mord mathnormal" style="color: red;">u</span><span class="mord mathnormal" style="color: red;">ce</span><span class="mord cjk_fallback" style="color: red;">组合</span><span class="mord mathnormal" style="color: red;">ma</span><span class="mord mathnormal" style="color: red;">p</span><span class="mord cjk_fallback" style="color: red;">操作的输出阶段。</span></span></span></span></span></span></li></ul> </li></ul> 
<p><strong>语法</strong></p> 
<pre><code class="prism language-js">db<span class="token punctuation">.</span><span class="token constant">COLLECTION_NAME</span><span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token constant">AGGREGATE_OPERATION</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="_18"></a>二、单一作用聚合</h2> 
<p>MongoDB提供 <strong>db.collection.estimatedDocumentCount(), db.collection.count(), db.collection.distinct()</strong> 这类单一作用的聚合函数。<br> 所有这些操作都聚合来自单个集合的文档。<br> 虽然这些操作提供了对公共聚合过程的简单访问，但它们缺乏聚合管道和map-Reduce的灵活性和功能。</p> 
<table><thead><tr><th align="left">函数</th><th align="left">功能</th></tr></thead><tbody><tr><td align="left">db.collection.estimatedDocumentCount()</td><td align="left">返回集合或视图中所有文档的计数</td></tr><tr><td align="left">db.collection.count()</td><td align="left">返回与find()集合或视图的查询匹配的文档计数 <br>等同于 db.collection.find(query).count()构造</td></tr><tr><td align="left">db.collection.distinct()</td><td align="left">在单个集合或视图中查找指定字段的不同值，并在数组中返回结果</td></tr></tbody></table> 
<pre><code class="prism language-js"><span class="token comment">//检索集合中所有文档的计数</span>
testdb<span class="token operator">&gt;</span> db<span class="token punctuation">.</span>testCollection<span class="token punctuation">.</span><span class="token function">estimatedDocumentCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">49</span>
<span class="token comment">//计算与查询匹配的所有文档</span>
testdb<span class="token operator">&gt;</span> db<span class="token punctuation">.</span>testCollection<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">favCount</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$gt</span><span class="token operator">:</span><span class="token number">50</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token literal-property property">DeprecationWarning</span><span class="token operator">:</span> Collection<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> is deprecated<span class="token punctuation">.</span> Use countDocuments or estimatedDocumentCount<span class="token punctuation">.</span>
<span class="token number">32</span>
testdb<span class="token operator">&gt;</span> db<span class="token punctuation">.</span>testCollection<span class="token punctuation">.</span><span class="token function">countDocuments</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">favCount</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$gt</span><span class="token operator">:</span><span class="token number">50</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">32</span>
<span class="token comment">//返回不同type的数组</span>
testdb<span class="token operator">&gt;</span> db<span class="token punctuation">.</span>testCollection<span class="token punctuation">.</span><span class="token function">distinct</span><span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span> <span class="token string">'literature'</span><span class="token punctuation">,</span> <span class="token string">'none'</span><span class="token punctuation">,</span> <span class="token string">'novel'</span><span class="token punctuation">,</span> <span class="token string">'sociality'</span><span class="token punctuation">,</span> <span class="token string">'technology'</span><span class="token punctuation">,</span> <span class="token string">'travel'</span> <span class="token punctuation">]</span>
返回收藏数小于等于<span class="token number">80</span>的文档不同type的数组
testdb<span class="token operator">&gt;</span> db<span class="token punctuation">.</span>testCollection<span class="token punctuation">.</span><span class="token function">distinct</span><span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">favCount</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$lte</span><span class="token operator">:</span><span class="token number">80</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span> <span class="token string">'literature'</span><span class="token punctuation">,</span> <span class="token string">'none'</span><span class="token punctuation">,</span> <span class="token string">'novel'</span><span class="token punctuation">,</span> <span class="token string">'sociality'</span><span class="token punctuation">,</span> <span class="token string">'technology'</span><span class="token punctuation">,</span> <span class="token string">'travel'</span> <span class="token punctuation">]</span>
testdb<span class="token operator">&gt;</span>
</code></pre> 
<h2><a id="_47"></a>三、聚合管道</h2> 
<h3><a id="31_MongoDB_48"></a>3.1 什么是MongoDB聚合框架</h3> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
         
         
           M 
          
         
           o 
          
         
           n 
          
         
           g 
          
         
           o 
          
         
           D 
          
         
           B 
          
         
           聚合框架（ 
          
         
           A 
          
         
           g 
          
         
           g 
          
         
           r 
          
         
           e 
          
         
           g 
          
         
           a 
          
         
           t 
          
         
           i 
          
         
           o 
          
         
           n 
          
         
           F 
          
         
           r 
          
         
           a 
          
         
           m 
          
         
           e 
          
         
           w 
          
         
           o 
          
         
           r 
          
         
           k 
          
         
           ）是一个计算框架 
          
         
        
       
      
        \color{red}{MongoDB 聚合框架（Aggregation Framework）是一个计算框架} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord" style="color: red;"><span class="mord mathnormal" style="margin-right: 0.109em; color: red;">M</span><span class="mord mathnormal" style="color: red;">o</span><span class="mord mathnormal" style="color: red;">n</span><span class="mord mathnormal" style="margin-right: 0.0359em; color: red;">g</span><span class="mord mathnormal" style="margin-right: 0.0278em; color: red;">oD</span><span class="mord mathnormal" style="margin-right: 0.0502em; color: red;">B</span><span class="mord cjk_fallback" style="color: red;">聚合框架（</span><span class="mord mathnormal" style="color: red;">A</span><span class="mord mathnormal" style="margin-right: 0.0359em; color: red;">gg</span><span class="mord mathnormal" style="color: red;">re</span><span class="mord mathnormal" style="margin-right: 0.0359em; color: red;">g</span><span class="mord mathnormal" style="color: red;">a</span><span class="mord mathnormal" style="color: red;">t</span><span class="mord mathnormal" style="color: red;">i</span><span class="mord mathnormal" style="color: red;">o</span><span class="mord mathnormal" style="color: red;">n</span><span class="mord mathnormal" style="margin-right: 0.1389em; color: red;">F</span><span class="mord mathnormal" style="margin-right: 0.0278em; color: red;">r</span><span class="mord mathnormal" style="color: red;">am</span><span class="mord mathnormal" style="color: red;">e</span><span class="mord mathnormal" style="margin-right: 0.0269em; color: red;">w</span><span class="mord mathnormal" style="margin-right: 0.0278em; color: red;">or</span><span class="mord mathnormal" style="margin-right: 0.0315em; color: red;">k</span><span class="mord cjk_fallback" style="color: red;">）是一个计算框架</span></span></span></span></span></span></p> 
<ul><li><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           作用在一个或几个集合上 
          
         
        
       
         \color{red}{作用在一个或几个集合上} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">作用在一个或几个集合上</span></span></span></span></span></span></li><li><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
          
            对集合中的数据进行的一系列运算 
           
          
            , 
           
          
            将这些数据转化为期望的形式 
           
          
         
        
       
         \color{red}{对集合中的数据进行的一系列运算,将这些数据转化为期望的形式} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">对集合中的数据进行的一系列运算</span><span class="mpunct" style="color: red;">,</span><span class="mspace" style="color: red; margin-right: 0.1667em;"></span><span class="mord cjk_fallback" style="color: red;">将这些数据转化为期望的形式</span></span></span></span></span></span></li></ul> 
<p><strong>从效果而言，聚合框架相当于 SQL 查询中的GROUP BY、 LEFT OUTER JOIN 、 AS等</strong></p> 
<h3><a id="32_PipelineStage_56"></a>3.2 管道（Pipeline）和阶段（Stage）</h3> 
<p>管道在Unix和Linux中一般用于将当前命令的输出结果作为下一个命令的参数。</p> 
<p>MongoDB的聚合管道将MongoDB文档在一个管道处理完毕后将结果传递给下一个管道处理。管道操作是可以重复的。</p> 
<p>表达式：处理输入文档并输出。表达式是无状态的，只能用于计算当前聚合管道的文档，不能处理其它的文档。</p> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
         
         
           整个聚合运算过程称为管道（ 
          
         
           P 
          
         
           i 
          
         
           p 
          
         
           e 
          
         
           l 
          
         
           i 
          
         
           n 
          
         
           e 
          
         
           ），它是由多个阶段（ 
          
         
           S 
          
         
           t 
          
         
           a 
          
         
           g 
          
         
           e 
          
         
           ）组成的 
          
         
        
       
      
        \color{red}{整个聚合运算过程称为管道（Pipeline），它是由多个阶段（Stage）组成的} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">整个聚合运算过程称为管道（</span><span class="mord mathnormal" style="margin-right: 0.1389em; color: red;">P</span><span class="mord mathnormal" style="color: red;">i</span><span class="mord mathnormal" style="color: red;">p</span><span class="mord mathnormal" style="color: red;">e</span><span class="mord mathnormal" style="margin-right: 0.0197em; color: red;">l</span><span class="mord mathnormal" style="color: red;">in</span><span class="mord mathnormal" style="color: red;">e</span><span class="mord cjk_fallback" style="color: red;">），它是由多个阶段（</span><span class="mord mathnormal" style="color: red;">St</span><span class="mord mathnormal" style="color: red;">a</span><span class="mord mathnormal" style="margin-right: 0.0359em; color: red;">g</span><span class="mord mathnormal" style="color: red;">e</span><span class="mord cjk_fallback" style="color: red;">）组成的</span></span></span></span></span></span></p> 
<ul><li><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           接受一系列文档（原始数据） 
          
         
        
       
         \color{red}{接受一系列文档（原始数据）} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">接受一系列文档（原始数据）</span></span></span></span></span></span></li><li><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           每个阶段对这些文档进行一系列运算 
          
         
        
       
         \color{red}{每个阶段对这些文档进行一系列运算} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">每个阶段对这些文档进行一系列运算</span></span></span></span></span></span></li><li><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           结果文档输出给下一个阶段 
          
         
        
       
         \color{red}{结果文档输出给下一个阶段} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">结果文档输出给下一个阶段</span></span></span></span></span></span><br> <img src="https://images2.imgbox.com/81/f5/f3MR4V9E_o.png" alt="在这里插入图片描述"></li></ul> 
<p><strong>聚合管道操作语法</strong></p> 
<pre><code class="prism language-js">pipeline <span class="token operator">=</span> <span class="token punctuation">[</span>$stage1<span class="token punctuation">,</span> $stage2<span class="token punctuation">,</span> <span class="token operator">...</span>$stageN<span class="token punctuation">]</span><span class="token punctuation">;</span>
db<span class="token punctuation">.</span>collection<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span>pipeline<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>options<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li>pipelines 一组数据聚合阶段。除$out、$Merge和$geonear阶段之外，每个阶段都可以在管道中出现多次。</li><li>options 可选，聚合操作的其他参数。包含：查询计划、是否使用临时文件、 游标、最大操作时间、读写策略、强制索引等等<br> <img src="https://images2.imgbox.com/d4/05/HyEpzYUm_o.png" alt="在这里插入图片描述"></li></ul> 
<h3><a id="33__81"></a>3.3 常用的管道聚合阶段</h3> 
<table><thead><tr><th align="left">阶段</th><th align="left">描述</th><th align="left">SQL等价运算符</th></tr></thead><tbody><tr><td align="left">$match</td><td align="left">筛选条件</td><td align="left">WHERE</td></tr><tr><td align="left">$project</td><td align="left">投影</td><td align="left">AS</td></tr><tr><td align="left">$lookup</td><td align="left">左外连接</td><td align="left">LEFT OUTER JOIN</td></tr><tr><td align="left">$sort</td><td align="left">排序</td><td align="left">ORDER BY</td></tr><tr><td align="left">$sum</td><td align="left">计算总和</td><td align="left">db.mycol.aggregate([{$group : {_id : “$by_user”, num_tutorial : {$sum : “$likes”}}}])</td></tr><tr><td align="left">$avg</td><td align="left">计算平均值</td><td align="left">db.mycol.aggregate([{$group : {_id : “$by_user”, num_tutorial : {$avg : “$likes”}}}])</td></tr><tr><td align="left">$min/max</td><td align="left">获取集合中所有文档对应值得最小/最大值。</td><td align="left">db.mycol.aggregate([{$group : {_id : “$by_user”, num_tutorial : {$min/max : “$likes”}}}])</td></tr><tr><td align="left">$push</td><td align="left">将值加入一个数组中，不会判断是否有重复的值</td><td align="left">db.mycol.aggregate([{$group : {_id : “$by_user”, url : {$push: “$url”}}}])</td></tr><tr><td align="left">$addToSet</td><td align="left">将值加入一个数组中，会判断是否有重复的值，若相同的值在数组中已经存在了，则不加入。</td><td align="left">db.mycol.aggregate([{$group : {_id : “$by_user”, url : {$addToSet : “$url”}}}])</td></tr><tr><td align="left">$first/last</td><td align="left">根据资源文档的排序获取第一个/最后一个文档数据</td><td align="left">db.mycol.aggregate([{$group : {_id : “$by_user”, url : {$first : “$url”}}}])</td></tr><tr><td align="left">$group</td><td align="left">分组</td><td align="left">GROUP BY</td></tr><tr><td align="left">$skip/$limit</td><td align="left">分页</td><td align="left"></td></tr><tr><td align="left">$unwind</td><td align="left">展开数组</td><td align="left"></td></tr><tr><td align="left">$graphLookup</td><td align="left">图搜索</td><td align="left"></td></tr><tr><td align="left">$facet/$bucket</td><td align="left">分面搜索</td><td align="left"></td></tr></tbody></table> 
<p><a href="https://www.mongodb.com/docs/manual/reference/operator/aggregation-pipeline/" rel="nofollow">管道聚合文档：</a></p> 
<h4><a id="331__102"></a>3.3.1 聚合表达式</h4> 
<ul><li><strong>获取字段信息</strong> 
  <blockquote> 
   <p>$&lt;field&gt; ： 用 $ 指示字段路径<br> $&lt;field&gt;.&lt;subfield&gt; ： 使用 $ 和 . 来指示内嵌文档的路径</p> 
  </blockquote> </li><li><strong>常量表达式</strong></li></ul> 
<blockquote> 
 <p>$literal :&lt;value&gt; ： 指示常量 </p> 
</blockquote> 
<ul><li><strong>系统变量表达式</strong></li></ul> 
<blockquote> 
 <p>$$&lt;variable&gt; 使用 $$ 指示系统变量<br> $$CURRENT 指示管道中当前操作的文档</p> 
</blockquote> 
<p><strong>准备数据</strong></p> 
<pre><code class="prism language-js"><span class="token keyword">var</span> tags <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"nosql"</span><span class="token punctuation">,</span><span class="token string">"mongodb"</span><span class="token punctuation">,</span><span class="token string">"document"</span><span class="token punctuation">,</span><span class="token string">"developer"</span><span class="token punctuation">,</span><span class="token string">"popular"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> types <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"technology"</span><span class="token punctuation">,</span><span class="token string">"sociality"</span><span class="token punctuation">,</span><span class="token string">"travel"</span><span class="token punctuation">,</span><span class="token string">"novel"</span><span class="token punctuation">,</span><span class="token string">"literature"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> books<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">500</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> typeIdx <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span>types<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> tagIdx <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span>tags<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> tagIdx2 <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span>tags<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> favCount <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> username <span class="token operator">=</span> <span class="token string">"xx00"</span><span class="token operator">+</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> age <span class="token operator">=</span> <span class="token number">30</span> <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> book <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">"book-"</span><span class="token operator">+</span>i<span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> types<span class="token punctuation">[</span>typeIdx<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token punctuation">[</span>tags<span class="token punctuation">[</span>tagIdx<span class="token punctuation">]</span><span class="token punctuation">,</span>tags<span class="token punctuation">[</span>tagIdx2<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">favCount</span><span class="token operator">:</span> favCount<span class="token punctuation">,</span>
        <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token literal-property property">name</span><span class="token operator">:</span>username<span class="token punctuation">,</span><span class="token literal-property property">age</span><span class="token operator">:</span>age<span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    books<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>book<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
db<span class="token punctuation">.</span>books<span class="token punctuation">.</span><span class="token function">insertMany</span><span class="token punctuation">(</span>books<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 加载js</span>
testdb<span class="token operator">&gt;</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token string">"C:\\xx\\xxxx\\xxx\\test.js"</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="332_project_140"></a>3.3.2 $project</h4> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          投影操作，将原始字段投影成指定名称 
         
        
       
      
        \color{red}{投影操作， 将原始字段投影成指定名称} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">投影操作，将原始字段投影成指定名称</span></span></span></span></span></span>， 如将集合中的 title 投影成 name</p> 
<pre><code class="prism language-powershell">testdb&gt; db<span class="token punctuation">.</span>testCollection<span class="token punctuation">.</span>aggregate<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token variable">$project</span>:<span class="token punctuation">{<!-- --></span>name:<span class="token string">"<span class="token variable">$title</span>"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>
  <span class="token punctuation">{<!-- --></span> _id: ObjectId<span class="token punctuation">(</span><span class="token string">"63f884d67b9fcb1f8bf84df1"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> _id: ObjectId<span class="token punctuation">(</span><span class="token string">"63f88c0b7b9fcb1f8bf84df4"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name: <span class="token string">'book-2'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> _id: ObjectId<span class="token punctuation">(</span><span class="token string">"63f88c0b7b9fcb1f8bf84df5"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name: <span class="token string">'book-3'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> _id: ObjectId<span class="token punctuation">(</span><span class="token string">"63f88c0b7b9fcb1f8bf84df6"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name: <span class="token string">'book-4'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> _id: ObjectId<span class="token punctuation">(</span><span class="token string">"63f88c0b7b9fcb1f8bf84df7"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name: <span class="token string">'book-5'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> _id: ObjectId<span class="token punctuation">(</span><span class="token string">"63f88c0b7b9fcb1f8bf84df8"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name: <span class="token string">'book-6'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> _id: ObjectId<span class="token punctuation">(</span><span class="token string">"63f88c0b7b9fcb1f8bf84df9"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name: <span class="token string">'book-7'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> _id: ObjectId<span class="token punctuation">(</span><span class="token string">"63f88c0b7b9fcb1f8bf84dfa"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name: <span class="token string">'book-8'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> _id: ObjectId<span class="token punctuation">(</span><span class="token string">"63f88c0b7b9fcb1f8bf84dfb"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name: <span class="token string">'book-9'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> _id: ObjectId<span class="token punctuation">(</span><span class="token string">"63f88c0b7b9fcb1f8bf84dfc"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name: <span class="token string">'book-10'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> _id: ObjectId<span class="token punctuation">(</span><span class="token string">"63f88c0b7b9fcb1f8bf84dfd"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name: <span class="token string">'book-11'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> _id: ObjectId<span class="token punctuation">(</span><span class="token string">"63f88c0b7b9fcb1f8bf84dfe"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name: <span class="token string">'book-12'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> _id: ObjectId<span class="token punctuation">(</span><span class="token string">"63f88c0b7b9fcb1f8bf84dff"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name: <span class="token string">'book-13'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> _id: ObjectId<span class="token punctuation">(</span><span class="token string">"63f88c0b7b9fcb1f8bf84e00"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name: <span class="token string">'book-14'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> _id: ObjectId<span class="token punctuation">(</span><span class="token string">"63f88c0b7b9fcb1f8bf84e01"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name: <span class="token string">'book-15'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> _id: ObjectId<span class="token punctuation">(</span><span class="token string">"63f88c0b7b9fcb1f8bf84e02"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name: <span class="token string">'book-16'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> _id: ObjectId<span class="token punctuation">(</span><span class="token string">"63f88c0b7b9fcb1f8bf84e03"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name: <span class="token string">'book-17'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> _id: ObjectId<span class="token punctuation">(</span><span class="token string">"63f88c0b7b9fcb1f8bf84e04"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name: <span class="token string">'book-18'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> _id: ObjectId<span class="token punctuation">(</span><span class="token string">"63f88c0b7b9fcb1f8bf84e05"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name: <span class="token string">'book-19'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> _id: ObjectId<span class="token punctuation">(</span><span class="token string">"63f88c0b7b9fcb1f8bf84e06"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name: <span class="token string">'book-20'</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
<span class="token function">Type</span> <span class="token string">"it"</span> <span class="token keyword">for</span> more
</code></pre> 
<p>$project <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          可以灵活控制输出文档的格式，也可以剔除不需要的字段 
         
        
       
      
        \color{red}{可以灵活控制输出文档的格式，也可以剔除不需要的字段} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">可以灵活控制输出文档的格式，也可以剔除不需要的字段</span></span></span></span></span></span></p> 
<pre><code class="prism language-js">testdb<span class="token operator">&gt;</span> db<span class="token punctuation">.</span>testCollection<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$project</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">"$title"</span><span class="token punctuation">,</span><span class="token literal-property property">_id</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token literal-property property">author</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>
  <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'novel'</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token string">'xxw2'</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'book-2'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'travel'</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token string">'xxw3'</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'book-3'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'novel'</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token string">'xxw4'</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'book-4'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'sociality'</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token string">'xxw5'</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'book-5'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'novel'</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token string">'xxw6'</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'book-6'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'novel'</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token string">'xxw7'</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'book-7'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'sociality'</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token string">'xxw8'</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'book-8'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'sociality'</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token string">'xxw9'</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'book-9'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'travel'</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token string">'xxw10'</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'book-10'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'travel'</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token string">'xxw11'</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'book-11'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'literature'</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token string">'xxw12'</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'book-12'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'travel'</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token string">'xxw13'</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'book-13'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'sociality'</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token string">'xxw14'</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'book-14'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'travel'</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token string">'xxw15'</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'book-15'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'novel'</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token string">'xxw16'</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'book-16'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'travel'</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token string">'xxw17'</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'book-17'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'technology'</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token string">'xxw18'</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'book-18'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'novel'</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token string">'xxw19'</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'book-19'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'novel'</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token string">'xxw20'</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'book-20'</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
Type <span class="token string">"it"</span> <span class="token keyword">for</span> more
</code></pre> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          从嵌套文档中排除字段 
         
        
       
      
        \color{red}{从嵌套文档中排除字段} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">从嵌套文档中排除字段</span></span></span></span></span></span></p> 
<pre><code class="prism language-js">testdb<span class="token operator">&gt;</span> db<span class="token punctuation">.</span>books<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
<span class="token operator">...</span>     <span class="token punctuation">{<!-- --></span><span class="token literal-property property">$project</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">"$title"</span><span class="token punctuation">,</span><span class="token literal-property property">_id</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string-property property">"author.name"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token operator">...</span> <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'literature'</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx000'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'book-0'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'literature'</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx009'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'book-1'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'technology'</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx007'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'book-2'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'technology'</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx007'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'book-3'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'sociality'</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx007'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'book-4'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'travel'</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx002'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'book-5'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'travel'</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx007'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'book-6'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'literature'</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx004'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'book-7'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'travel'</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx002'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'book-8'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'travel'</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx002'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'book-9'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'sociality'</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx009'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'book-10'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'novel'</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx003'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'book-11'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'travel'</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx008'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'book-12'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'novel'</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx006'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'book-13'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'novel'</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx007'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'book-14'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'travel'</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx001'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'book-15'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'technology'</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx001'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'book-16'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'literature'</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx004'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'book-17'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'novel'</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx008'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'book-18'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'travel'</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx003'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'book-19'</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span>


testdb<span class="token operator">&gt;</span> db<span class="token punctuation">.</span>books<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
<span class="token operator">...</span>     <span class="token punctuation">{<!-- --></span><span class="token literal-property property">$project</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">"$title"</span><span class="token punctuation">,</span><span class="token literal-property property">_id</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token literal-property property">author</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token operator">...</span> <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'literature'</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx000'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'book-0'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'literature'</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx009'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'book-1'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> 
<h4><a id="332_match_234"></a>3.3.2 $match</h4> 
<p>$match用于对文档进行筛选，之后可以在得到的文档子集上做聚合，<br> $match<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          可以使用除了地理空间之外的所有常规查询操作符 
         
        
       
      
        \color{red}{可以使用除了地理空间之外的所有常规查询操作符} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">可以使用除了地理空间之外的所有常规查询操作符</span></span></span></span></span></span></p> 
<p><strong>在实际应用中尽可能将$match放在管道的前面位置。</strong><br> 这样有两个好处：</p> 
<ul><li>可以快速将不需要的文档过滤掉，以减少管道的工作量；</li><li>如果再投射和分组之前执行$match，查询可以使用索引。</li></ul> 
<pre><code class="prism language-js">db<span class="token punctuation">.</span>books<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$match</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token string">"technology"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          筛选管道操作和其他管道操作配合时候时，尽量放到开始阶段 
         
        
       
      
        \color{red}{筛选管道操作和其他管道操作配合时候时，尽量放到开始阶段} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">筛选管道操作和其他管道操作配合时候时，尽量放到开始阶段</span></span></span></span></span></span>，这样可以<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          减少后续管道操作符要操作的文档数，提升效率 
         
        
       
      
        \color{red}{减少后续管道操作符要操作的文档数，提升效率} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">减少后续管道操作符要操作的文档数，提升效率</span></span></span></span></span></span></p> 
<pre><code class="prism language-js">db<span class="token punctuation">.</span>books<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span><span class="token literal-property property">$match</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token string">"technology"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token literal-property property">$project</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">"$title"</span><span class="token punctuation">,</span><span class="token literal-property property">_id</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token literal-property property">author</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="332_count_254"></a>3.3.2 $count</h4> 
<p><strong>计数并返回与查询匹配的结果数</strong></p> 
<pre><code class="prism language-js">testdb<span class="token operator">&gt;</span> db<span class="token punctuation">.</span>books<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
<span class="token punctuation">{<!-- --></span><span class="token literal-property property">$match</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token string">"travel"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token comment">//$match阶段筛选出type匹配travel的文档，并传到下一阶段；</span>
<span class="token punctuation">{<!-- --></span><span class="token literal-property property">$count</span><span class="token operator">:</span><span class="token string">"travel_count"</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment">//$count阶段返回聚合管道中剩余文档的计数，并将该值分配给travel_count</span>
<span class="token punctuation">[</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">travel_count</span><span class="token operator">:</span> <span class="token number">99</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span>
</code></pre> 
<h4><a id="333_group_263"></a>3.3.3 $group</h4> 
<ul><li><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           按指定的表达式对文档进行分组，并将每个不同分组的文档输出到下一个阶段 
          
         
        
       
         \color{red}{按指定的表达式对文档进行分组，并将每个不同分组的文档输出到下一个阶段} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">按指定的表达式对文档进行分组，并将每个不同分组的文档输出到下一个阶段</span></span></span></span></span></span></li><li>输出文档包含一个_id字段，该字段按键包含不同的组。</li><li>输出文档还可以包含计算字段，该字段保存由$group的_id字段分组的一些accumulator表达式的值。</li><li>$group <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           不会输出具体的文档而只是统计信息 
          
         
        
       
         \color{red}{不会输出具体的文档而只是统计信息} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">不会输出具体的文档而只是统计信息</span></span></span></span></span></span></li></ul> 
<pre><code class="prism language-js"><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">$group</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token operator">&lt;</span>expression<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>field1<span class="token operator">&gt;</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token operator">&lt;</span>accumulator1<span class="token operator">&gt;</span> <span class="token operator">:</span> <span class="token operator">&lt;</span>expression1<span class="token operator">&gt;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">...</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre> 
<ul><li><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
          
            _ 
           
          
            i 
           
          
            d 
           
          
            字段是必填的 
           
          
            ; 
           
          
            但是，可以指 
           
           
           
             定 
            
           
             i 
            
           
          
            d 
           
          
            值为 
           
          
            n 
           
          
            u 
           
          
            l 
           
          
            l 
           
          
            来为整个输入文档计算累计 
           
          
         
        
       
         \color{red}{\_id字段是必填的;但是，可以指定_id值为null来为整个输入文档计算累计} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0044em; vertical-align: -0.31em;"></span><span class="mord" style="color: red;"><span class="mord" style="margin-right: 0.0278em; color: red;">_</span><span class="mord mathnormal" style="color: red;">i</span><span class="mord mathnormal" style="color: red;">d</span><span class="mord cjk_fallback" style="color: red;">字段是必填的</span><span class="mpunct" style="color: red;">;</span><span class="mspace" style="color: red; margin-right: 0.1667em;"></span><span class="mord cjk_fallback" style="color: red;">但是，可以指</span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">定</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight" style="color: red;"><span class="mord mathnormal mtight" style="color: red;">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathnormal" style="color: red;">d</span><span class="mord cjk_fallback" style="color: red;">值为</span><span class="mord mathnormal" style="color: red;">n</span><span class="mord mathnormal" style="color: red;">u</span><span class="mord mathnormal" style="margin-right: 0.0197em; color: red;">ll</span><span class="mord cjk_fallback" style="color: red;">来为整个输入文档计算累计</span></span></span></span></span></span></li><li>剩余的计算字段是可选的，并使用运算符进行计算</li><li>_id和表达式可以接受任何有效的<a href="https://www.mongodb.com/docs/manual/meta/aggregation-quick-reference/#aggregation-expressions" rel="nofollow">表达式</a><br> <img src="https://images2.imgbox.com/9c/a4/uicD8LAI_o.png" alt="在这里插入图片描述"><br> $group <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
          
            阶段的内存限制为 
           
          
            100 
           
          
            M 
           
          
         
        
       
         \color{red}{阶段的内存限制为100M} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">阶段的内存限制为</span><span class="mord" style="color: red;">100</span><span class="mord mathnormal" style="margin-right: 0.109em; color: red;">M</span></span></span></span></span></span>。<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
          
            默认情况下，如果 
           
          
            s 
           
          
            t 
           
          
            a 
           
          
            g 
           
          
            e 
           
          
            超过此限制， 
           
          
         
        
       
         \color{red}{默认情况下，如果stage超过此限制，} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">默认情况下，如果</span><span class="mord mathnormal" style="color: red;">s</span><span class="mord mathnormal" style="color: red;">t</span><span class="mord mathnormal" style="color: red;">a</span><span class="mord mathnormal" style="margin-right: 0.0359em; color: red;">g</span><span class="mord mathnormal" style="color: red;">e</span><span class="mord cjk_fallback" style="color: red;">超过此限制，</span></span></span></span></span></span> $group <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           将产生错误 
          
         
        
       
         \color{red}{将产生错误} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">将产生错误</span></span></span></span></span></span>。但是，要允许处理大型数据集，请将<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
          
            a 
           
          
            l 
           
          
            l 
           
          
            o 
           
          
            w 
           
          
            D 
           
          
            i 
           
          
            s 
           
          
            k 
           
          
            U 
           
          
            s 
           
          
            e 
           
          
            选项设置为 
           
          
            t 
           
          
            r 
           
          
            u 
           
          
            e 
           
          
            以启用 
           
          
         
        
       
         \color{red}{allowDiskUse选项设置为true以启用} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6944em;"></span><span class="mord" style="color: red;"><span class="mord mathnormal" style="color: red;">a</span><span class="mord mathnormal" style="margin-right: 0.0197em; color: red;">ll</span><span class="mord mathnormal" style="color: red;">o</span><span class="mord mathnormal" style="margin-right: 0.0269em; color: red;">w</span><span class="mord mathnormal" style="margin-right: 0.0278em; color: red;">D</span><span class="mord mathnormal" style="color: red;">i</span><span class="mord mathnormal" style="color: red;">s</span><span class="mord mathnormal" style="margin-right: 0.0315em; color: red;">k</span><span class="mord mathnormal" style="margin-right: 0.109em; color: red;">U</span><span class="mord mathnormal" style="color: red;">se</span><span class="mord cjk_fallback" style="color: red;">选项设置为</span><span class="mord mathnormal" style="color: red;">t</span><span class="mord mathnormal" style="margin-right: 0.0278em; color: red;">r</span><span class="mord mathnormal" style="color: red;">u</span><span class="mord mathnormal" style="color: red;">e</span><span class="mord cjk_fallback" style="color: red;">以启用</span></span></span></span></span></span> $group<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           操作以写入临时文件 
          
         
        
       
         \color{red}{操作以写入临时文件} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">操作以写入临时文件</span></span></span></span></span></span></li></ul> 
<p><strong>book的数量，收藏总数和平均值</strong></p> 
<pre><code class="prism language-javascript">testdb<span class="token operator">&gt;</span> db<span class="token punctuation">.</span>books<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$match</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token string">"travel"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$count</span><span class="token operator">:</span><span class="token string">"travel_count"</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">travel_count</span><span class="token operator">:</span> <span class="token number">99</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span>
testdb<span class="token operator">&gt;</span> db<span class="token punctuation">.</span>books<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
<span class="token operator">...</span>     <span class="token punctuation">{<!-- --></span><span class="token literal-property property">$group</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">_id</span><span class="token operator">:</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token literal-property property">count</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$sum</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token literal-property property">pop</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$sum</span><span class="token operator">:</span><span class="token string">"$favCount"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token literal-property property">avg</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$avg</span><span class="token operator">:</span><span class="token string">"$favCount"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token operator">...</span> <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">25999</span><span class="token punctuation">,</span> <span class="token literal-property property">avg</span><span class="token operator">:</span> <span class="token number">51.998</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span>
</code></pre> 
<p><strong>统计每个作者的book收藏总数</strong></p> 
<pre><code class="prism language-javascript">testdb<span class="token operator">&gt;</span> db<span class="token punctuation">.</span>books<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
<span class="token punctuation">{<!-- --></span>
<span class="token literal-property property">$group</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">_id</span><span class="token operator">:</span><span class="token string">"$author.name"</span><span class="token punctuation">,</span><span class="token literal-property property">pop</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$sum</span><span class="token operator">:</span><span class="token string">"$favCount"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'xx004'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">2320</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'xx003'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">3199</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'xx001'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">2572</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'xx007'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">2825</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'xx005'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">2578</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'xx009'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">2755</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'xx006'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">2698</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'xx002'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">2093</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'xx008'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">2269</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'xx000'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">2690</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> 
<p><strong>统计每个作者的每本book的收藏数</strong></p> 
<pre><code class="prism language-javascript">testdb<span class="token operator">&gt;</span> db<span class="token punctuation">.</span>books<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$group</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">_id</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">"$author.name"</span><span class="token punctuation">,</span><span class="token literal-property property">title</span><span class="token operator">:</span><span class="token string">"$title"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token literal-property property">pop</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$sum</span><span class="token operator">:</span><span class="token string">"$favCount"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx003'</span><span class="token punctuation">,</span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'book-19'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">84</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx008'</span><span class="token punctuation">,</span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'book-450'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">28</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx006'</span><span class="token punctuation">,</span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'book-201'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">18</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx004'</span><span class="token punctuation">,</span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'book-207'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">89</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx009'</span><span class="token punctuation">,</span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'book-400'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">47</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx004'</span><span class="token punctuation">,</span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'book-330'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">80</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx005'</span><span class="token punctuation">,</span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'book-448'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">24</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx001'</span><span class="token punctuation">,</span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'book-159'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">50</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx002'</span><span class="token punctuation">,</span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'book-63'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">19</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx003'</span><span class="token punctuation">,</span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'book-301'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">94</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx000'</span><span class="token punctuation">,</span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'book-308'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">82</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx005'</span><span class="token punctuation">,</span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'book-395'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">37</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx002'</span><span class="token punctuation">,</span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'book-220'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">5</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx007'</span><span class="token punctuation">,</span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'book-127'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">39</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx008'</span><span class="token punctuation">,</span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'book-50'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">90</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx003'</span><span class="token punctuation">,</span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'book-303'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">12</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx003'</span><span class="token punctuation">,</span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'book-37'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">38</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx004'</span><span class="token punctuation">,</span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'book-17'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">82</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx007'</span><span class="token punctuation">,</span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'book-252'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">76</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'xx001'</span><span class="token punctuation">,</span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'book-445'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">29</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> 
<p><strong>每个作者的book的type合集</strong></p> 
<pre><code class="prism language-javascript">testdb<span class="token operator">&gt;</span> db<span class="token punctuation">.</span>books<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span>
<span class="token operator">...</span> <span class="token punctuation">[</span>
<span class="token operator">...</span> <span class="token punctuation">{<!-- --></span><span class="token literal-property property">$group</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">_id</span><span class="token operator">:</span><span class="token string">"$author.name"</span><span class="token punctuation">,</span><span class="token literal-property property">typeSet</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$addToSet</span><span class="token operator">:</span><span class="token string">"$type"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token operator">...</span> <span class="token punctuation">]</span>
<span class="token operator">...</span> <span class="token punctuation">)</span>
<span class="token punctuation">[</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'xx005'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">typeSet</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">'technology'</span><span class="token punctuation">,</span> <span class="token string">'literature'</span><span class="token punctuation">,</span> <span class="token string">'novel'</span><span class="token punctuation">,</span> <span class="token string">'sociality'</span><span class="token punctuation">,</span> <span class="token string">'travel'</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> 
<h4><a id="334_unwind_352"></a>3.3.4 $unwind</h4> 
<p><strong>可以将数组拆分为单独的文档<br> v3.2+支持如下语法：</strong></p> 
<pre><code class="prism language-javascript"><span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">$unwind</span><span class="token operator">:</span>
    <span class="token punctuation">{<!-- --></span>
     #要指定字段路径，在字段名称前加上$符并用引号括起来。
      <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token operator">&lt;</span>field path<span class="token operator">&gt;</span><span class="token punctuation">,</span>
      #可选<span class="token punctuation">,</span>一个新字段的名称用于存放元素的数组索引。该名称不能以$开头。
      <span class="token literal-property property">includeArrayIndex</span><span class="token operator">:</span> <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">,</span>  
      #可选，<span class="token keyword">default</span> <span class="token operator">:</span><span class="token boolean">false</span>，若为<span class="token boolean">true</span><span class="token punctuation">,</span>如果路径为空，缺少或为空数组，则$unwind输出文档
      <span class="token literal-property property">preserveNullAndEmptyArrays</span><span class="token operator">:</span> <span class="token operator">&lt;</span>boolean<span class="token operator">&gt;</span> 
 <span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre> 
<p><strong>姓名为xx006的作者的book的tag数组拆分为多个文档</strong></p> 
<pre><code class="prism language-javascript">db<span class="token punctuation">.</span>books<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span><span class="token literal-property property">$match</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token string-property property">"author.name"</span><span class="token operator">:</span><span class="token string">"xx006"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token literal-property property">$unwind</span><span class="token operator">:</span><span class="token string">"$tag"</span><span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

db<span class="token punctuation">.</span>books<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span><span class="token literal-property property">$match</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token string-property property">"author.name"</span><span class="token operator">:</span><span class="token string">"xx006"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>每个作者的book的tag合集</strong></p> 
<pre><code class="prism language-javascript">db<span class="token punctuation">.</span>books<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span><span class="token literal-property property">$unwind</span><span class="token operator">:</span><span class="token string">"$tag"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token literal-property property">$group</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">_id</span><span class="token operator">:</span><span class="token string">"$author.name"</span><span class="token punctuation">,</span><span class="token literal-property property">types</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$addToSet</span><span class="token operator">:</span><span class="token string">"$tag"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<hr> 
<p><strong>案例</strong></p> 
<pre><code class="prism language-javascript">db<span class="token punctuation">.</span>books<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token string-property property">"title"</span> <span class="token operator">:</span> <span class="token string">"book-51"</span><span class="token punctuation">,</span>
	<span class="token string-property property">"type"</span> <span class="token operator">:</span> <span class="token string">"technology"</span><span class="token punctuation">,</span>
	<span class="token string-property property">"favCount"</span> <span class="token operator">:</span> <span class="token number">110</span><span class="token punctuation">,</span>
     <span class="token string-property property">"tag"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token string-property property">"author"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
		<span class="token string-property property">"name"</span> <span class="token operator">:</span> <span class="token string">"weljy"</span><span class="token punctuation">,</span>
		<span class="token string-property property">"age"</span> <span class="token operator">:</span> <span class="token number">30</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span>
	<span class="token string-property property">"title"</span> <span class="token operator">:</span> <span class="token string">"book-52"</span><span class="token punctuation">,</span>
	<span class="token string-property property">"type"</span> <span class="token operator">:</span> <span class="token string">"technology"</span><span class="token punctuation">,</span>
	<span class="token string-property property">"favCount"</span> <span class="token operator">:</span> <span class="token number">150</span><span class="token punctuation">,</span>
	<span class="token string-property property">"author"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
		<span class="token string-property property">"name"</span> <span class="token operator">:</span> <span class="token string">"weljy"</span><span class="token punctuation">,</span>
		<span class="token string-property property">"age"</span> <span class="token operator">:</span> <span class="token number">30</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span>
	<span class="token string-property property">"title"</span> <span class="token operator">:</span> <span class="token string">"book-53"</span><span class="token punctuation">,</span>
	<span class="token string-property property">"type"</span> <span class="token operator">:</span> <span class="token string">"technology"</span><span class="token punctuation">,</span>
	<span class="token string-property property">"tag"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
		<span class="token string">"nosql"</span><span class="token punctuation">,</span>
		<span class="token string">"document"</span>
	<span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token string-property property">"favCount"</span> <span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
	<span class="token string-property property">"author"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
		<span class="token string-property property">"name"</span> <span class="token operator">:</span> <span class="token string">"weljy"</span><span class="token punctuation">,</span>
		<span class="token string-property property">"age"</span> <span class="token operator">:</span> <span class="token number">30</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>测试</strong></p> 
<pre><code class="prism language-javascript"><span class="token comment">// 使用includeArrayIndex选项来输出数组元素的数组索引</span>
testdb<span class="token operator">&gt;</span> db<span class="token punctuation">.</span>books<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$match</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token string-property property">"author.name"</span><span class="token operator">:</span><span class="token string">"weljy"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$unwind</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">path</span><span class="token operator">:</span><span class="token string">"$tag"</span><span class="token punctuation">,</span><span class="token literal-property property">includeArrayIndex</span><span class="token operator">:</span><span class="token string">"arrayIndex"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">"63fd6e507b9fcb1f8bf8501a"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'book-53'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'technology'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">'nosql'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">favCount</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
    <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'weljy'</span><span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">30</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">arrayIndex</span><span class="token operator">:</span> <span class="token function">Long</span><span class="token punctuation">(</span><span class="token string">"0"</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">"63fd6e507b9fcb1f8bf8501a"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'book-53'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'technology'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">'document'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">favCount</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
    <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'weljy'</span><span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">30</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">arrayIndex</span><span class="token operator">:</span> <span class="token function">Long</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> 
<pre><code class="prism language-javascript"><span class="token comment">//使用preserveNullAndEmptyArrays选项在输出中包含缺少size字段，null或空数组的文档</span>
testdb<span class="token operator">&gt;</span> db<span class="token punctuation">.</span>books<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
<span class="token operator">...</span>     <span class="token punctuation">{<!-- --></span><span class="token literal-property property">$match</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token string-property property">"author.name"</span><span class="token operator">:</span><span class="token string">"weljy"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token operator">...</span>     <span class="token punctuation">{<!-- --></span><span class="token literal-property property">$unwind</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">path</span><span class="token operator">:</span><span class="token string">"$tag"</span><span class="token punctuation">,</span> <span class="token literal-property property">preserveNullAndEmptyArrays</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token operator">...</span> <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">"63fd6e507b9fcb1f8bf85018"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'book-51'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'technology'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">favCount</span><span class="token operator">:</span> <span class="token number">110</span><span class="token punctuation">,</span>
    <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'weljy'</span><span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">30</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">"63fd6e507b9fcb1f8bf85019"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'book-52'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'technology'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">favCount</span><span class="token operator">:</span> <span class="token number">150</span><span class="token punctuation">,</span>
    <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'weljy'</span><span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">30</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">"63fd6e507b9fcb1f8bf8501a"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'book-53'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'technology'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">'nosql'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">favCount</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
    <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'weljy'</span><span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">30</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">"63fd6e507b9fcb1f8bf8501a"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'book-53'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'technology'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">'document'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">favCount</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
    <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'weljy'</span><span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">30</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> 
<h4><a id="335_limit_493"></a>3.3.5 $limit</h4> 
<p><strong>限制传递到管道中下一阶段的文档数</strong></p> 
<pre><code class="prism language-javascript">db<span class="token punctuation">.</span>books<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span><span class="token literal-property property">$limit</span> <span class="token operator">:</span> <span class="token number">5</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p>此操作仅返回管道传递给它的前5个文档。$limit对其传递的文档内容没有影响。<br> <strong>注意：当$sort在管道中的$limit之前立即出现时，$sort操作只会在过程中维持前n个结果，其中n是指定的限制，而MongoDB只需要将n个项存储在内存中。</strong></p> 
<h4><a id="336_skip_505"></a>3.3.6 $skip</h4> 
<p><strong>跳过进入stage的指定数量的文档，并将其余文档传递到管道中的下一个阶段</strong></p> 
<pre><code class="prism language-javascript">db<span class="token punctuation">.</span>books<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span><span class="token literal-property property">$skip</span> <span class="token operator">:</span> <span class="token number">5</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>此操作将跳过管道传递给它的前5个文档。 $skip对沿着管道传递的文档的内容没有影响。</strong></p> 
<h4><a id="337_sort_514"></a>3.3.7 $sort</h4> 
<p><strong>对所有输入文档进行排序，并按排序顺序将它们返回到管道。</strong><br> 语法：</p> 
<pre><code class="prism language-javascript"><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">$sort</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token operator">&lt;</span>field1<span class="token operator">&gt;</span><span class="token operator">:</span> <span class="token operator">&lt;</span>sort order<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>field2<span class="token operator">&gt;</span><span class="token operator">:</span> <span class="token operator">&lt;</span>sort order<span class="token operator">&gt;</span> <span class="token operator">...</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre> 
<p><strong>要对字段进行排序，请将排序顺序设置为1或-1，以分别指定升序或降序排序，如下例所示：</strong></p> 
<pre><code class="prism language-javascript">db<span class="token punctuation">.</span>books<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span><span class="token literal-property property">$sort</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token literal-property property">favCount</span><span class="token operator">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token literal-property property">title</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="338_lookup_528"></a>3.3.8 $lookup</h4> 
<p>Mongodb 3.2版本新增， <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          主要用来实现多表关联查询 
         
        
       
      
        \color{red}{主要用来实现多表关联查询} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">主要用来实现多表关联查询</span></span></span></span></span></span>， 相当关系型数据库中多表关联查询。<strong>每个输入待处理的文档，经过$lookup 阶段的处理，输出的新文档中会包含一个新生成的数组（可根据需要命名新key ）</strong>。数组列存放的数据是来自被Join集合的适配文档，如果没有，集合为空（即 为[ ])</p> 
<p>语法：</p> 
<pre><code class="prism language-javascript">db<span class="token punctuation">.</span>collection<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">$lookup</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
             <span class="token literal-property property">from</span><span class="token operator">:</span> <span class="token string">"&lt;collection to join&gt;"</span><span class="token punctuation">,</span>
             <span class="token literal-property property">localField</span><span class="token operator">:</span> <span class="token string">"&lt;field from the input documents&gt;"</span><span class="token punctuation">,</span>
             <span class="token literal-property property">foreignField</span><span class="token operator">:</span> <span class="token string">"&lt;field from the documents of the from collection&gt;"</span><span class="token punctuation">,</span>
             <span class="token keyword">as</span><span class="token operator">:</span> <span class="token string">"&lt;output array field&gt;"</span>
           <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>


</code></pre> 
<ul><li><strong>from</strong> 同一个数据库下等待被Join的集合。</li><li><strong>localField</strong> 源集合中的match值，如果输入的集合中，某文档没有 localField这个Key（Field），在处理的过程中，会默认为此文档含有 localField：null的键值对。</li><li><strong>foreignField</strong> 待Join的集合的match值，如果待Join的集合中，文档没有foreignField值，在处理的过程中，会默认为此文档含有 foreignField：null的键值对。as为输出文档的新增值命名。如果输入的集合中已存在该值，则会覆盖掉</li></ul> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
         
         
           注意： 
          
         
           n 
          
         
           u 
          
         
           l 
          
         
           l 
          
         
           = 
          
         
           n 
          
         
           u 
          
         
           l 
          
         
           l 
          
         
           此为真 
          
         
        
       
      
        \color{red}{ 注意：null = null 此为真} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6944em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">注意：</span><span class="mord mathnormal" style="color: red;">n</span><span class="mord mathnormal" style="color: red;">u</span><span class="mord mathnormal" style="margin-right: 0.0197em; color: red;">ll</span><span class="mspace" style="color: red; margin-right: 0.2778em;"></span><span class="mrel" style="color: red;">=</span><span class="mspace" style="color: red; margin-right: 0.2778em;"></span><span class="mord mathnormal" style="color: red;">n</span><span class="mord mathnormal" style="color: red;">u</span><span class="mord mathnormal" style="margin-right: 0.0197em; color: red;">ll</span><span class="mord cjk_fallback" style="color: red;">此为真</span></span></span></span></span></span><br> 其语法功能类似于下面的伪SQL语句：</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>output array field<span class="token operator">&gt;</span>
<span class="token keyword">FROM</span> collection
<span class="token keyword">WHERE</span> <span class="token operator">&lt;</span>output array field<span class="token operator">&gt;</span> <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token operator">*</span>
                               <span class="token keyword">FROM</span> <span class="token operator">&lt;</span>collection <span class="token keyword">to</span> <span class="token keyword">join</span><span class="token operator">&gt;</span>
                               <span class="token keyword">WHERE</span> <span class="token operator">&lt;</span>foreignField<span class="token operator">&gt;=</span> <span class="token operator">&lt;</span>collection<span class="token punctuation">.</span>localField<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>案例 数据准备</strong></p> 
<pre><code class="prism language-javascript">db<span class="token punctuation">.</span>customer<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">customerCode</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">"customer1"</span><span class="token punctuation">,</span><span class="token literal-property property">phone</span><span class="token operator">:</span><span class="token string">"13112345678"</span><span class="token punctuation">,</span><span class="token literal-property property">address</span><span class="token operator">:</span><span class="token string">"test1"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span>customer<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">customerCode</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">"customer2"</span><span class="token punctuation">,</span><span class="token literal-property property">phone</span><span class="token operator">:</span><span class="token string">"13112345679"</span><span class="token punctuation">,</span><span class="token literal-property property">address</span><span class="token operator">:</span><span class="token string">"test2"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

db<span class="token punctuation">.</span>order<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">orderId</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token literal-property property">orderCode</span><span class="token operator">:</span><span class="token string">"order001"</span><span class="token punctuation">,</span><span class="token literal-property property">customerCode</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token literal-property property">price</span><span class="token operator">:</span><span class="token number">200</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span>order<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">orderId</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token literal-property property">orderCode</span><span class="token operator">:</span><span class="token string">"order002"</span><span class="token punctuation">,</span><span class="token literal-property property">customerCode</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token literal-property property">price</span><span class="token operator">:</span><span class="token number">400</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

db<span class="token punctuation">.</span>orderItem<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">itemId</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token literal-property property">productName</span><span class="token operator">:</span><span class="token string">"apples"</span><span class="token punctuation">,</span><span class="token literal-property property">qutity</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token literal-property property">orderId</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span>orderItem<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">itemId</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token literal-property property">productName</span><span class="token operator">:</span><span class="token string">"oranges"</span><span class="token punctuation">,</span><span class="token literal-property property">qutity</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token literal-property property">orderId</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span>orderItem<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">itemId</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token literal-property property">productName</span><span class="token operator">:</span><span class="token string">"mangoes"</span><span class="token punctuation">,</span><span class="token literal-property property">qutity</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token literal-property property">orderId</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span>orderItem<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">itemId</span><span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token literal-property property">productName</span><span class="token operator">:</span><span class="token string">"apples"</span><span class="token punctuation">,</span><span class="token literal-property property">qutity</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token literal-property property">orderId</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span>orderItem<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">itemId</span><span class="token operator">:</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token literal-property property">productName</span><span class="token operator">:</span><span class="token string">"oranges"</span><span class="token punctuation">,</span><span class="token literal-property property">qutity</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token literal-property property">orderId</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span>orderItem<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">itemId</span><span class="token operator">:</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token literal-property property">productName</span><span class="token operator">:</span><span class="token string">"mangoes"</span><span class="token punctuation">,</span><span class="token literal-property property">qutity</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token literal-property property">orderId</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>关联查询</strong></p> 
<pre><code class="prism language-javascript">testdb<span class="token operator">&gt;</span> db<span class="token punctuation">.</span>customer<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$lookup</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">from</span><span class="token operator">:</span><span class="token string">"order"</span><span class="token punctuation">,</span><span class="token literal-property property">localField</span><span class="token operator">:</span><span class="token string">"customerCode"</span><span class="token punctuation">,</span><span class="token literal-property property">foreignField</span><span class="token operator">:</span><span class="token string">"customerCode"</span><span class="token punctuation">,</span><span class="token keyword">as</span><span class="token operator">:</span><span class="token string">"customerOrder"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">"63fd78e27b9fcb1f8bf8501b"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">customerCode</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'customer1'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">phone</span><span class="token operator">:</span> <span class="token string">'13112345678'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">address</span><span class="token operator">:</span> <span class="token string">'test1'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">customerOrder</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{<!-- --></span>
        <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">"63fd78e27b9fcb1f8bf8501d"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">orderId</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token literal-property property">orderCode</span><span class="token operator">:</span> <span class="token string">'order001'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">customerCode</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token literal-property property">price</span><span class="token operator">:</span> <span class="token number">200</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">"63fd78e27b9fcb1f8bf8501c"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">customerCode</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'customer2'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">phone</span><span class="token operator">:</span> <span class="token string">'13112345679'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">address</span><span class="token operator">:</span> <span class="token string">'test2'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">customerOrder</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{<!-- --></span>
        <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">"63fd78e27b9fcb1f8bf8501e"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">orderId</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token literal-property property">orderCode</span><span class="token operator">:</span> <span class="token string">'order002'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">customerCode</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token literal-property property">price</span><span class="token operator">:</span> <span class="token number">400</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> 
<pre><code class="prism language-javascript">testdb<span class="token operator">&gt;</span> db<span class="token punctuation">.</span>customer<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$lookup</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">from</span><span class="token operator">:</span><span class="token string">"order"</span><span class="token punctuation">,</span><span class="token literal-property property">localField</span><span class="token operator">:</span><span class="token string">"customerCode"</span><span class="token punctuation">,</span><span class="token literal-property property">foreignField</span><span class="token operator">:</span><span class="token string">"customerCode"</span><span class="token punctuation">,</span><span class="token keyword">as</span><span class="token operator">:</span><span class="token string">"customerOrder"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$lookup</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">from</span><span class="token operator">:</span><span class="token string">"orderItem"</span><span class="token punctuation">,</span><span class="token literal-property property">localField</span><span class="token operator">:</span><span class="token string">"orderId"</span><span class="token punctuation">,</span><span class="token literal-property property">foreignField</span><span class="token operator">:</span><span class="token string">"orderId"</span><span class="token punctuation">,</span><span class="token keyword">as</span><span class="token operator">:</span><span class="token string">"orderItem"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">"63fd78e27b9fcb1f8bf8501b"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">customerCode</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'customer1'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">phone</span><span class="token operator">:</span> <span class="token string">'13112345678'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">address</span><span class="token operator">:</span> <span class="token string">'test1'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">customerOrder</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{<!-- --></span>
        <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">"63fd78e27b9fcb1f8bf8501d"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">orderId</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token literal-property property">orderCode</span><span class="token operator">:</span> <span class="token string">'order001'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">customerCode</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token literal-property property">price</span><span class="token operator">:</span> <span class="token number">200</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">orderItem</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">"63fd78e27b9fcb1f8bf8501c"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">customerCode</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'customer2'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">phone</span><span class="token operator">:</span> <span class="token string">'13112345679'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">address</span><span class="token operator">:</span> <span class="token string">'test2'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">customerOrder</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{<!-- --></span>
        <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">"63fd78e27b9fcb1f8bf8501e"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">orderId</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token literal-property property">orderCode</span><span class="token operator">:</span> <span class="token string">'order002'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">customerCode</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token literal-property property">price</span><span class="token operator">:</span> <span class="token number">400</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">orderItem</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> 
<h3><a id="34_1_655"></a>3.4 聚合操作案例1</h3> 
<p><strong>统计每个分类的book文档数量</strong></p> 
<pre><code class="prism language-javascript">testdb<span class="token operator">&gt;</span> db<span class="token punctuation">.</span>books<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$group</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">_id</span><span class="token operator">:</span><span class="token string">"$type"</span><span class="token punctuation">,</span><span class="token literal-property property">total</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$sum</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$sort</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">total</span><span class="token operator">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'technology'</span><span class="token punctuation">,</span> <span class="token literal-property property">total</span><span class="token operator">:</span> <span class="token number">112</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'literature'</span><span class="token punctuation">,</span> <span class="token literal-property property">total</span><span class="token operator">:</span> <span class="token number">105</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'travel'</span><span class="token punctuation">,</span> <span class="token literal-property property">total</span><span class="token operator">:</span> <span class="token number">99</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'novel'</span><span class="token punctuation">,</span> <span class="token literal-property property">total</span><span class="token operator">:</span> <span class="token number">99</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'sociality'</span><span class="token punctuation">,</span> <span class="token literal-property property">total</span><span class="token operator">:</span> <span class="token number">88</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> 
<p><strong>标签的热度排行，标签的热度则按其关联book文档的收藏数（favCount）来计算</strong></p> 
<pre><code class="prism language-javascript">testdb<span class="token operator">&gt;</span> db<span class="token punctuation">.</span>books<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span>
<span class="token punctuation">{<!-- --></span><span class="token literal-property property">$match</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">favCount</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$gt</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{<!-- --></span><span class="token literal-property property">$unwind</span><span class="token operator">:</span><span class="token string">"$tag"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{<!-- --></span><span class="token literal-property property">$group</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">_id</span><span class="token operator">:</span><span class="token string">"$tag"</span><span class="token punctuation">,</span><span class="token literal-property property">total</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$sum</span><span class="token operator">:</span><span class="token string">"$favCount"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{<!-- --></span><span class="token literal-property property">$sort</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">total</span><span class="token operator">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'nosql'</span><span class="token punctuation">,</span> <span class="token literal-property property">total</span><span class="token operator">:</span> <span class="token number">11861</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'document'</span><span class="token punctuation">,</span> <span class="token literal-property property">total</span><span class="token operator">:</span> <span class="token number">10766</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'popular'</span><span class="token punctuation">,</span> <span class="token literal-property property">total</span><span class="token operator">:</span> <span class="token number">10141</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'developer'</span><span class="token punctuation">,</span> <span class="token literal-property property">total</span><span class="token operator">:</span> <span class="token number">10016</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'mongodb'</span><span class="token punctuation">,</span> <span class="token literal-property property">total</span><span class="token operator">:</span> <span class="token number">9254</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> 
<ul><li>$match阶段：用于过滤favCount=0的文档。</li><li>$unwind阶段：用于将标签数组进行展开，这样一个包含3个标签的文档会被拆解为3个条目。</li><li>$group阶段：对拆解后的文档进行分组计算，$sum："$favCount"表示按favCount字段进行累加。</li><li>$sort阶段：接收分组计算的输出，按total得分进行排序</li></ul> 
<p><strong>统计book文档收藏数[0,10),[10,60),[60,80),[80,100),[100,+∞）</strong></p> 
<pre><code class="prism language-javascript">testdb<span class="token operator">&gt;</span> db<span class="token punctuation">.</span>books<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$bucket</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">groupBy</span><span class="token operator">:</span><span class="token string">"$favCount"</span><span class="token punctuation">,</span><span class="token literal-property property">boundaries</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">60</span><span class="token punctuation">,</span><span class="token number">80</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token keyword">default</span><span class="token operator">:</span><span class="token string">"other"</span><span class="token punctuation">,</span><span class="token literal-property property">output</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token string-property property">"count"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$sum</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token number">48</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token number">234</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token number">103</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token number">116</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'other'</span><span class="token punctuation">,</span> <span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> 
<h3><a id="35_2_701"></a>3.5 聚合操作案例2</h3> 
<p><a href="https://media.mongodb.org/zips.json" rel="nofollow">邮政编码数据</a><br> <a href="https://www.mongodb.com/try/download/database-tools" rel="nofollow">MongoDB Database Tools</a></p> 
<p><strong>使用mongoimport工具导入数据</strong></p> 
<pre><code class="prism language-shell">mongoimport <span class="token parameter variable">-h</span> <span class="token number">192.168</span>.65.174 <span class="token parameter variable">-d</span> <span class="token builtin class-name">test</span> <span class="token parameter variable">-u</span> weljy <span class="token parameter variable">-p</span> weljy <span class="token parameter variable">--authenticationDatabase</span><span class="token operator">=</span>admin <span class="token parameter variable">-c</span> zips <span class="token parameter variable">--file</span> C:<span class="token punctuation">\</span>ProgramData<span class="token punctuation">\</span>zips.json  
</code></pre> 
<p>h,–host ：代表远程连接的数据库地址，默认连接本地Mongo数据库；<br> –port：代表远程连接的数据库的端口，默认连接的远程端口27017；<br> -u,–username：代表连接远程数据库的账号，如果设置数据库的认证，需要指定用户账号；<br> -p,–password：代表连接数据库的账号对应的密码；<br> -d,–db：代表连接的数据库；<br> -c,–collection：代表连接数据库中的集合；<br> -f, --fields：代表导入集合中的字段；<br> –type：代表导入的文件类型，包括csv和json,tsv文件，默认json格式；<br> –file：导入的文件名称<br> –headerline：导入csv文件时，指明第一行是列名，不需要导入</p> 
<h4><a id="351_500_721"></a>3.5.1 返回人口超过500万的州</h4> 
<pre><code class="prism language-javascript">test<span class="token operator">&gt;</span> db<span class="token punctuation">.</span>zips<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
<span class="token punctuation">{<!-- --></span><span class="token literal-property property">$group</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">_id</span><span class="token operator">:</span><span class="token string">"$state"</span><span class="token punctuation">,</span><span class="token literal-property property">totalPop</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$sum</span><span class="token operator">:</span><span class="token string">"$pop"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{<!-- --></span><span class="token literal-property property">$match</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">totalPop</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$gte</span><span class="token operator">:</span><span class="token number">10000</span><span class="token operator">*</span><span class="token number">500</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'MI'</span><span class="token punctuation">,</span> <span class="token literal-property property">totalPop</span><span class="token operator">:</span> <span class="token number">9295297</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'PA'</span><span class="token punctuation">,</span> <span class="token literal-property property">totalPop</span><span class="token operator">:</span> <span class="token number">11881643</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'NC'</span><span class="token punctuation">,</span> <span class="token literal-property property">totalPop</span><span class="token operator">:</span> <span class="token number">6628637</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'OH'</span><span class="token punctuation">,</span> <span class="token literal-property property">totalPop</span><span class="token operator">:</span> <span class="token number">10846517</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'VA'</span><span class="token punctuation">,</span> <span class="token literal-property property">totalPop</span><span class="token operator">:</span> <span class="token number">6181479</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'IL'</span><span class="token punctuation">,</span> <span class="token literal-property property">totalPop</span><span class="token operator">:</span> <span class="token number">11427576</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'FL'</span><span class="token punctuation">,</span> <span class="token literal-property property">totalPop</span><span class="token operator">:</span> <span class="token number">12686644</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'IN'</span><span class="token punctuation">,</span> <span class="token literal-property property">totalPop</span><span class="token operator">:</span> <span class="token number">5544136</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'GA'</span><span class="token punctuation">,</span> <span class="token literal-property property">totalPop</span><span class="token operator">:</span> <span class="token number">6478216</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'MO'</span><span class="token punctuation">,</span> <span class="token literal-property property">totalPop</span><span class="token operator">:</span> <span class="token number">5110648</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'NJ'</span><span class="token punctuation">,</span> <span class="token literal-property property">totalPop</span><span class="token operator">:</span> <span class="token number">7730188</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'NY'</span><span class="token punctuation">,</span> <span class="token literal-property property">totalPop</span><span class="token operator">:</span> <span class="token number">17990402</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'MA'</span><span class="token punctuation">,</span> <span class="token literal-property property">totalPop</span><span class="token operator">:</span> <span class="token number">6016425</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'TX'</span><span class="token punctuation">,</span> <span class="token literal-property property">totalPop</span><span class="token operator">:</span> <span class="token number">16984601</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'CA'</span><span class="token punctuation">,</span> <span class="token literal-property property">totalPop</span><span class="token operator">:</span> <span class="token number">29754890</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> 
<p><strong>这个聚合操作的等价SQL是：</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> state<span class="token punctuation">,</span> <span class="token function">SUM</span><span class="token punctuation">(</span>pop<span class="token punctuation">)</span> <span class="token keyword">AS</span> totalPop
<span class="token keyword">FROM</span> zips
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> state
<span class="token keyword">HAVING</span> totalPop <span class="token operator">&gt;=</span> <span class="token punctuation">(</span><span class="token number">10000</span><span class="token operator">*</span><span class="token number">500</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="352__754"></a>3.5.2 返回各州平均城市人口</h4> 
<pre><code class="prism language-javascript">db<span class="token punctuation">.</span>zips<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span> <span class="token punctuation">[</span>
   <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">$group</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">"$state"</span><span class="token punctuation">,</span> <span class="token literal-property property">city</span><span class="token operator">:</span> <span class="token string">"$city"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">cityPop</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">$sum</span><span class="token operator">:</span> <span class="token string">"$pop"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span> <span class="token punctuation">)</span>
<span class="token punctuation">[</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'MI'</span><span class="token punctuation">,</span> <span class="token literal-property property">city</span><span class="token operator">:</span> <span class="token string">'BELLEVILLE'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">cityPop</span><span class="token operator">:</span> <span class="token number">35436</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'MI'</span><span class="token punctuation">,</span> <span class="token literal-property property">city</span><span class="token operator">:</span> <span class="token string">'GRAND JUNCTION'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">cityPop</span><span class="token operator">:</span> <span class="token number">2100</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'CA'</span><span class="token punctuation">,</span> <span class="token literal-property property">city</span><span class="token operator">:</span> <span class="token string">'SEIAD VALLEY'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">cityPop</span><span class="token operator">:</span> <span class="token number">311</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'OR'</span><span class="token punctuation">,</span> <span class="token literal-property property">city</span><span class="token operator">:</span> <span class="token string">'NORTH POWDER'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">cityPop</span><span class="token operator">:</span> <span class="token number">571</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'WY'</span><span class="token punctuation">,</span> <span class="token literal-property property">city</span><span class="token operator">:</span> <span class="token string">'COLTER BAY'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">cityPop</span><span class="token operator">:</span> <span class="token number">9078</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'GA'</span><span class="token punctuation">,</span> <span class="token literal-property property">city</span><span class="token operator">:</span> <span class="token string">'CRAWFORDVILLE'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">cityPop</span><span class="token operator">:</span> <span class="token number">1915</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'CA'</span><span class="token punctuation">,</span> <span class="token literal-property property">city</span><span class="token operator">:</span> <span class="token string">'DUNLAP'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">cityPop</span><span class="token operator">:</span> <span class="token number">94</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'IL'</span><span class="token punctuation">,</span> <span class="token literal-property property">city</span><span class="token operator">:</span> <span class="token string">'COLLISON'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">cityPop</span><span class="token operator">:</span> <span class="token number">421</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'MI'</span><span class="token punctuation">,</span> <span class="token literal-property property">city</span><span class="token operator">:</span> <span class="token string">'PLEASANT RIDGE'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">cityPop</span><span class="token operator">:</span> <span class="token number">2895</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'NJ'</span><span class="token punctuation">,</span> <span class="token literal-property property">city</span><span class="token operator">:</span> <span class="token string">'ROSELLE'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">cityPop</span><span class="token operator">:</span> <span class="token number">20159</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'PA'</span><span class="token punctuation">,</span> <span class="token literal-property property">city</span><span class="token operator">:</span> <span class="token string">'ALUM BANK'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">cityPop</span><span class="token operator">:</span> <span class="token number">2175</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'WI'</span><span class="token punctuation">,</span> <span class="token literal-property property">city</span><span class="token operator">:</span> <span class="token string">'IRON BELT'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">cityPop</span><span class="token operator">:</span> <span class="token number">265</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'NY'</span><span class="token punctuation">,</span> <span class="token literal-property property">city</span><span class="token operator">:</span> <span class="token string">'HEWLETT'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">cityPop</span><span class="token operator">:</span> <span class="token number">8023</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'OH'</span><span class="token punctuation">,</span> <span class="token literal-property property">city</span><span class="token operator">:</span> <span class="token string">'MONTPELIER'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">cityPop</span><span class="token operator">:</span> <span class="token number">7569</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'WA'</span><span class="token punctuation">,</span> <span class="token literal-property property">city</span><span class="token operator">:</span> <span class="token string">'TENINO'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">cityPop</span><span class="token operator">:</span> <span class="token number">6451</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'MI'</span><span class="token punctuation">,</span> <span class="token literal-property property">city</span><span class="token operator">:</span> <span class="token string">'BENTON HARBOR'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">cityPop</span><span class="token operator">:</span> <span class="token number">37550</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'KY'</span><span class="token punctuation">,</span> <span class="token literal-property property">city</span><span class="token operator">:</span> <span class="token string">'BRANDENBURG'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">cityPop</span><span class="token operator">:</span> <span class="token number">6480</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'NJ'</span><span class="token punctuation">,</span> <span class="token literal-property property">city</span><span class="token operator">:</span> <span class="token string">'CRANFORD'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">cityPop</span><span class="token operator">:</span> <span class="token number">22866</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'MO'</span><span class="token punctuation">,</span> <span class="token literal-property property">city</span><span class="token operator">:</span> <span class="token string">'BERKELEY'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">cityPop</span><span class="token operator">:</span> <span class="token number">20546</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'AR'</span><span class="token punctuation">,</span> <span class="token literal-property property">city</span><span class="token operator">:</span> <span class="token string">'NATURAL DAM'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">cityPop</span><span class="token operator">:</span> <span class="token number">497</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span>


test<span class="token operator">&gt;</span> db<span class="token punctuation">.</span>zips<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$group</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">_id</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">state</span><span class="token operator">:</span><span class="token string">"$state"</span><span class="token punctuation">,</span><span class="token literal-property property">city</span><span class="token operator">:</span><span class="token string">"$city"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token literal-property property">cityPop</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$sum</span><span class="token operator">:</span><span class="token string">"$pop"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$group</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">_id</span><span class="token operator">:</span><span class="token string">"$_id.state"</span><span class="token punctuation">,</span><span class="token literal-property property">avgCityPop</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$avg</span><span class="token operator">:</span><span class="token string">"$cityPop"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'NV'</span><span class="token punctuation">,</span> <span class="token literal-property property">avgCityPop</span><span class="token operator">:</span> <span class="token number">18209.590909090908</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'OK'</span><span class="token punctuation">,</span> <span class="token literal-property property">avgCityPop</span><span class="token operator">:</span> <span class="token number">6155.743639921722</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'MI'</span><span class="token punctuation">,</span> <span class="token literal-property property">avgCityPop</span><span class="token operator">:</span> <span class="token number">12087.512353706112</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'PA'</span><span class="token punctuation">,</span> <span class="token literal-property property">avgCityPop</span><span class="token operator">:</span> <span class="token number">8679.067202337472</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'OH'</span><span class="token punctuation">,</span> <span class="token literal-property property">avgCityPop</span><span class="token operator">:</span> <span class="token number">12700.839578454332</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'NC'</span><span class="token punctuation">,</span> <span class="token literal-property property">avgCityPop</span><span class="token operator">:</span> <span class="token number">10622.815705128205</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'SC'</span><span class="token punctuation">,</span> <span class="token literal-property property">avgCityPop</span><span class="token operator">:</span> <span class="token number">11139.626198083068</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'VA'</span><span class="token punctuation">,</span> <span class="token literal-property property">avgCityPop</span><span class="token operator">:</span> <span class="token number">8526.177931034483</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'LA'</span><span class="token punctuation">,</span> <span class="token literal-property property">avgCityPop</span><span class="token operator">:</span> <span class="token number">10465.496277915632</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'NM'</span><span class="token punctuation">,</span> <span class="token literal-property property">avgCityPop</span><span class="token operator">:</span> <span class="token number">5872.360465116279</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'AZ'</span><span class="token punctuation">,</span> <span class="token literal-property property">avgCityPop</span><span class="token operator">:</span> <span class="token number">20591.16853932584</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'OR'</span><span class="token punctuation">,</span> <span class="token literal-property property">avgCityPop</span><span class="token operator">:</span> <span class="token number">8262.561046511628</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'SD'</span><span class="token punctuation">,</span> <span class="token literal-property property">avgCityPop</span><span class="token operator">:</span> <span class="token number">1839.6746031746031</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'IA'</span><span class="token punctuation">,</span> <span class="token literal-property property">avgCityPop</span><span class="token operator">:</span> <span class="token number">3123.0821147356583</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'WV'</span><span class="token punctuation">,</span> <span class="token literal-property property">avgCityPop</span><span class="token operator">:</span> <span class="token number">2771.4775888717154</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'WI'</span><span class="token punctuation">,</span> <span class="token literal-property property">avgCityPop</span><span class="token operator">:</span> <span class="token number">7323.00748502994</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'VT'</span><span class="token punctuation">,</span> <span class="token literal-property property">avgCityPop</span><span class="token operator">:</span> <span class="token number">2315.8765432098767</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'HI'</span><span class="token punctuation">,</span> <span class="token literal-property property">avgCityPop</span><span class="token operator">:</span> <span class="token number">15831.842857142858</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'KS'</span><span class="token punctuation">,</span> <span class="token literal-property property">avgCityPop</span><span class="token operator">:</span> <span class="token number">3819.884259259259</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">'DE'</span><span class="token punctuation">,</span> <span class="token literal-property property">avgCityPop</span><span class="token operator">:</span> <span class="token number">14481.91304347826</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> 
<p><strong>按州返回最大和最小的城市</strong></p> 
<pre><code class="prism language-javascript">test<span class="token operator">&gt;</span> db<span class="token punctuation">.</span>zips<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
<span class="token operator">...</span>     <span class="token punctuation">{<!-- --></span><span class="token literal-property property">$group</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">_id</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">state</span><span class="token operator">:</span><span class="token string">"$state"</span><span class="token punctuation">,</span><span class="token literal-property property">city</span><span class="token operator">:</span><span class="token string">"$city"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token literal-property property">pop</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$sum</span><span class="token operator">:</span><span class="token string">"$pop"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token operator">...</span>     <span class="token punctuation">{<!-- --></span><span class="token literal-property property">$sort</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">pop</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token operator">...</span>     <span class="token punctuation">{<!-- --></span><span class="token literal-property property">$group</span><span class="token operator">:</span>
<span class="token operator">...</span>             <span class="token punctuation">{<!-- --></span>
<span class="token operator">...</span>                     _id<span class="token operator">:</span><span class="token string">"$_id.state"</span><span class="token punctuation">,</span>
<span class="token operator">...</span>                     biggestCity<span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$last</span><span class="token operator">:</span><span class="token string">"$_id.city"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token operator">...</span>                     biggestPop<span class="token operator">:</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">$last</span><span class="token operator">:</span> <span class="token string">"$pop"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token operator">...</span>                     smallestCity<span class="token operator">:</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">$first</span><span class="token operator">:</span> <span class="token string">"$_id.city"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token operator">...</span>                     smallestPop<span class="token operator">:</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">$first</span><span class="token operator">:</span> <span class="token string">"$pop"</span> <span class="token punctuation">}</span>
<span class="token operator">...</span>             <span class="token punctuation">}</span>
<span class="token operator">...</span>     <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token operator">...</span>     <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">$project</span><span class="token operator">:</span>
<span class="token operator">...</span>             <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
<span class="token operator">...</span>               state<span class="token operator">:</span> <span class="token string">"$_id"</span><span class="token punctuation">,</span>
<span class="token operator">...</span>               biggestCity<span class="token operator">:</span>  <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"$biggestCity"</span><span class="token punctuation">,</span>  <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token string">"$biggestPop"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token operator">...</span>               smallestCity<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"$smallestCity"</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token string">"$smallestPop"</span> <span class="token punctuation">}</span>
<span class="token operator">...</span>             <span class="token punctuation">}</span>
<span class="token operator">...</span>     <span class="token punctuation">}</span>
<span class="token operator">...</span> <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">biggestCity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'DES MOINES'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">148155</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">smallestCity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'DOUDS'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">15</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'IA'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">biggestCity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'HUNTINGTON'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">75343</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">smallestCity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'MOUNT CARBON'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'WV'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">biggestCity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'SIOUX FALLS'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">102046</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">smallestCity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'ZEONA'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">8</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'SD'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">biggestCity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'PORTLAND'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">518543</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">smallestCity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'ODELL'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'OR'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">biggestCity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'MANCHESTER'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">106452</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">smallestCity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'WEST NOTTINGHAM'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">27</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'NH'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">biggestCity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'BALTIMORE'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">733081</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">smallestCity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'ANNAPOLIS JUNCTI'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">32</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'MD'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">biggestCity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'ALBUQUERQUE'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">449584</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">smallestCity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'ALGODONES'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'NM'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">biggestCity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'VIRGINIA BEACH'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">385080</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">smallestCity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'WALLOPS ISLAND'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'VA'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">biggestCity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'NEW ORLEANS'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">496937</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">smallestCity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'FORDOCHE'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'LA'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">biggestCity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'COLUMBIA'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">269521</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">smallestCity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'QUINBY'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'SC'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">biggestCity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'PHILADELPHIA'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">1610956</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">smallestCity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'HAMILTON'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'PA'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">biggestCity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'CHARLOTTE'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">465833</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">smallestCity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'GLOUCESTER'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'NC'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">biggestCity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'DETROIT'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">963243</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">smallestCity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'LELAND'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'MI'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">biggestCity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'PHOENIX'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">890853</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">smallestCity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'HUALAPAI'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'AZ'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">biggestCity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'LAS VEGAS'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">597557</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">smallestCity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'TUSCARORA'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'NV'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">biggestCity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'TULSA'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">389072</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">smallestCity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'SOUTHARD'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">8</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'OK'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">biggestCity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'CLEVELAND'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">536759</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">smallestCity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'ISLE SAINT GEORG'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">38</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'OH'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">biggestCity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'ANCHORAGE'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">183987</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">smallestCity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'SELAWIK'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'AK'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">biggestCity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'INDIANAPOLIS'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">348868</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">smallestCity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'WESTPOINT'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">145</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'IN'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">biggestCity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'MIAMI'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">825232</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">smallestCity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'CECIL FIELD NAS'</span><span class="token punctuation">,</span> <span class="token literal-property property">pop</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">'FL'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> 
<h2><a id="MapReduce_936"></a>四、MapReduce操作</h2> 
<p>MapReduce操作将大量的数据处理工作拆分成多个线程并行处理，然后将结果合并在一起。MongoDB提供的Map-Reduce非常灵活，对于大规模数据分析也相当实用。</p> 
<p><strong>MapReduce具有两个阶段：</strong></p> 
<ol><li>将具有相同Key的文档数据整合在一起的map阶段</li><li>组合map操作的结果进行统计输出的reduce阶段</li></ol> 
<p>**MapReduce的基本语法 **</p> 
<pre><code class="prism language-javascript">db<span class="token punctuation">.</span>collection<span class="token punctuation">.</span><span class="token function">mapReduce</span><span class="token punctuation">(</span>
   <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token function">emit</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment">//map 函数</span>
   <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span>values</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token keyword">return</span> reduceFunction<span class="token punctuation">}</span><span class="token punctuation">,</span>   <span class="token comment">//reduce 函数</span>
   <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">out</span><span class="token operator">:</span> <span class="token operator">&lt;</span>collection<span class="token operator">&gt;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">query</span><span class="token operator">:</span> <span class="token operator">&lt;</span>document<span class="token operator">&gt;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">sort</span><span class="token operator">:</span> <span class="token operator">&lt;</span>document<span class="token operator">&gt;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">limit</span><span class="token operator">:</span> <span class="token operator">&lt;</span>number<span class="token operator">&gt;</span><span class="token punctuation">,</span>
     <span class="token literal-property property">finalize</span><span class="token operator">:</span> <span class="token operator">&lt;</span><span class="token keyword">function</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> 
     <span class="token literal-property property">scope</span><span class="token operator">:</span> <span class="token operator">&lt;</span>document<span class="token operator">&gt;</span><span class="token punctuation">,</span>
     <span class="token literal-property property">jsMode</span><span class="token operator">:</span> <span class="token operator">&lt;</span>boolean<span class="token operator">&gt;</span><span class="token punctuation">,</span>
     <span class="token literal-property property">verbose</span><span class="token operator">:</span> <span class="token operator">&lt;</span>boolean<span class="token operator">&gt;</span><span class="token punctuation">,</span>
     <span class="token literal-property property">bypassDocumentValidation</span><span class="token operator">:</span> <span class="token operator">&lt;</span>boolean<span class="token operator">&gt;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">)</span>


</code></pre> 
<ul><li>map，将数据拆分成键值对，交给reduce函数</li><li>reduce，根据键将值做统计运算</li><li>out，可选，将结果汇入指定表</li><li>quey，可选筛选数据的条件，筛选的数据送入map</li><li>sort，排序完后，送入map</li><li>limit，限制送入map的文档数</li><li>finalize，可选，修改reduce的结果后进行输出</li><li>scope，可选，指定map、reduce、finalize的全局变量</li><li>jsMode，可选，默认false。在mapreduce过程中是否将数 据转换成bson格式。</li><li>verbose，可选，是否在结果中显示时间，默认false</li><li>bypassDocmentValidation，可选，是否略过数据校验</li></ul> 
<p><strong>统计type为travel的不同作者的book文档收藏数</strong></p> 
<pre><code class="prism language-javascript">db<span class="token punctuation">.</span>books<span class="token punctuation">.</span><span class="token function">mapReduce</span><span class="token punctuation">(</span>
    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>type<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>favCount<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span>values</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token keyword">return</span> Array<span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token literal-property property">query</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token string">"travel"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">out</span><span class="token operator">:</span> <span class="token string">"books_favCount"</span>
    <span class="token punctuation">}</span>
 <span class="token punctuation">)</span>
</code></pre> 
<p><strong>从MongoDB 5.0开始，map-reduce操作已被弃用。</strong> 聚合管道比映射-reduce操作提供更好的性能和可用性。Map-reduce操作可以使用聚合管道操作符重写，例如<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         g 
        
       
         r 
        
       
         o 
        
       
         u 
        
       
         p 
        
       
         、 
        
       
      
        group、 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">g</span><span class="mord mathnormal">ro</span><span class="mord mathnormal">u</span><span class="mord mathnormal">p</span><span class="mord cjk_fallback">、</span></span></span></span></span>merge等。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9a866e26aec3cb136bd8b0bcb31a3ef4/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">机器学习与目标检测作业（数组相加:形状需要满足哪些条件）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/80af9e70e6713e332911015bb02f5786/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">JavaScript 俄罗斯方块 - setTimeout和rAF</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>