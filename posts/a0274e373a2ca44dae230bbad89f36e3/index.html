<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>第十二章 Logstash入门 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="第十二章 Logstash入门" />
<meta property="og:description" content="一、概念介绍 Logstash是一个类似实时流水线的开源数据传输引擎，它像一个两头连接不 同数据源的数据传输管道，将数据实时地从一个数据源传输到另一个数据源中。在数据传输的过程中，Logstash还可以对数据进行清洗、加工和整理，使数据在 到达目的地时直接可用或接近可用，为更复杂的数据分析、处理以及可视化做准备。
既然需要将数据搬运到指定的地点，为什么不在数据产生时就将数据写到需要的地方呢?这个问题可以从以下几个方面理解。首先，许多数据在产生时并不支持直接写入到除本地文件以外的其他数据源。比如大多数第三方软件在运行中产生的日志，都以文本形式写到本地文件中。其次，在分布式环境下许多数据都分散在不同容器甚至不同机器上，而在处理这些数据时往往需要将数据收集到一起统一处理。 最后，即使软件支持将数据写入到指定的地点，但随着人们对数据理解的深人和新技术的诞生又会有新的数据分析需求出现，总会有一些接入需来是原生软件无法满足的。综上，Logstash的核心价值就在于它将业务系统与数摆处现系统隔离开来，屏蔽了各自系统变化对彼此的影响，使系统之间的依赖降低并可独自进化发展。
Logstash可以从多个数据源提取数据，然后再清洗过滤并发送到指定的目标 数据源。目标数据源也可以是多个，而且只要修改Logstash管道配置就可以轻松扩展数据的源头和目标。这在实际应用中非常有价值，尤其是在提取或发送的数据源发生变更时更为明显。比如原来只将数据提取到Elasticsearch中做检索，但 现在需要将它们同时传给Spark做实时分析。如果事先没有使用Logstash就必须设计新代码向Spark发送数据，而如果预先使用了Logstash则只需要在管道配置中添加新的输出配置。这极大增强了数据传输的灵活性。
Logstash负责日志收集和转发，支持日志过滤，支持普通log、自定义json格式的日志解析。
1、部署规划 计划在三台CentOS7机器上部署ELK，其中一台机器作为ELK的服务节点，IP为192.168.0.101；另外两台作为客户节点，IP为192.168.0.102/103。其中服务节点部署Elasticsearch、Logstash和Kibana三个组件，客户节点部署Logstash，Nginx等。
2、服务节点部署 2.1、环境准备 默认root用户下操作，其他用户请自觉添加sudo。
1）安装JDK，省略
2）关闭防火墙，关闭selinux
systemctl stop firewalld
systemctl disable firewalld
或者设置防火墙规则：
firewall-cmd --add-port=9200/tcp --permanent
firewall-cmd --add-port=9300/tcp --permanent
firewall-cmd --add-port=5601/tcp --permanent
firewall-cmd --reload
2.2、添加ELK仓库 Add the following in your `/etc/yum.repos.d/` directory in a file with a `.repo` suffix, for example `logstash.repo`
cat &lt;&lt;EOF | tee /etc/yum.repos.d/elasticsearch.repo
[elasticsearch-7.x]
name=Elasticsearch repository for 7.x packages
baseurl=https://artifacts.elastic.co/packages/7.x/yum
gpgcheck=1
gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch
enabled=1
autorefresh=1" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/a0274e373a2ca44dae230bbad89f36e3/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-07-28T09:18:09+08:00" />
<meta property="article:modified_time" content="2020-07-28T09:18:09+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">第十二章 Logstash入门</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2 style="margin-left:0pt;"><strong><strong><strong>一、概念介绍</strong></strong></strong></h2> 
<p style="margin-left:0pt;">Logstash是一个类似实时流水线的开源数据传输引擎，它像一个两头连接不 同数据源的数据传输管道，将数据实时地从一个数据源传输到另一个数据源中。在数据传输的过程中，Logstash还可以对数据进行清洗、加工和整理，使数据在 到达目的地时直接可用或接近可用，为更复杂的数据分析、处理以及可视化做准备。</p> 
<p style="margin-left:0pt;">既然需要将数据搬运到指定的地点，为什么不在数据产生时就将数据写到需要的地方呢?这个问题可以从以下几个方面理解。首先，许多数据在产生时并不支持直接写入到除本地文件以外的其他数据源。比如大多数第三方软件在运行中产生的日志，都以文本形式写到本地文件中。其次，在分布式环境下许多数据都分散在不同容器甚至不同机器上，而在处理这些数据时往往需要将数据收集到一起统一处理。 最后，即使软件支持将数据写入到指定的地点，但随着人们对数据理解的深人和新技术的诞生又会有新的数据分析需求出现，总会有一些接入需来是原生软件无法满足的。综上，Logstash的核心价值就在于它将业务系统与数摆处现系统隔离开来，屏蔽了各自系统变化对彼此的影响，使系统之间的依赖降低并可独自进化发展。</p> 
<p style="margin-left:0pt;">Logstash可以从多个数据源提取数据，然后再清洗过滤并发送到指定的目标 数据源。目标数据源也可以是多个，而且只要修改Logstash管道配置就可以轻松扩展数据的源头和目标。这在实际应用中非常有价值，尤其是在提取或发送的数据源发生变更时更为明显。比如原来只将数据提取到Elasticsearch中做检索，但 现在需要将它们同时传给Spark做实时分析。如果事先没有使用Logstash就必须设计新代码向Spark发送数据，而如果预先使用了Logstash则只需要在管道配置中添加新的输出配置。这极大增强了数据传输的灵活性。</p> 
<p style="margin-left:0pt;">Logstash负责日志收集和转发，支持日志过滤，支持普通log、自定义json格式的日志解析。</p> 
<h3><strong><strong><strong>1、</strong></strong><strong><strong>部署规划</strong></strong></strong></h3> 
<p style="margin-left:0pt;">计划在三台CentOS7机器上部署ELK，其中一台机器作为ELK的服务节点，IP为192.168.0.101；另外两台作为客户节点，IP为192.168.0.102/103。其中服务节点部署Elasticsearch、Logstash和Kibana三个组件，客户节点部署Logstash，Nginx等。</p> 
<h3><strong><strong><strong>2、</strong></strong><strong><strong>服务节点部署</strong></strong></strong></h3> 
<h4><strong><strong><strong>2.1、</strong></strong><strong><strong>环境准备</strong></strong></strong></h4> 
<p style="margin-left:0pt;">默认root用户下操作，其他用户请自觉添加sudo。</p> 
<p style="margin-left:0pt;"><strong><strong>1</strong></strong><strong><strong>）</strong></strong><strong><strong>安装JDK，</strong></strong><strong><strong>省略</strong></strong></p> 
<p style="margin-left:0pt;"><strong><strong>2</strong></strong><strong><strong>）</strong></strong><strong><strong>关闭防火墙</strong></strong><strong><strong>，</strong></strong><strong><strong>关闭selinux</strong></strong></p> 
<blockquote> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">systemctl stop firewalld</span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">systemctl disable firewalld</span></p> 
</blockquote> 
<p style="margin-left:0pt;"><strong><strong>或者设置防火墙规则：</strong></strong></p> 
<blockquote> 
 <p style="margin-left:0pt;">firewall-cmd --add-port=9200/tcp --permanent</p> 
 <p style="margin-left:0pt;">firewall-cmd --add-port=9300/tcp --permanent</p> 
 <p style="margin-left:0pt;">firewall-cmd --add-port=5601/tcp --permanent</p> 
 <p style="margin-left:0pt;">firewall-cmd --reload</p> 
</blockquote> 
<h4><strong><strong><strong>2.2</strong></strong><strong><strong>、添加ELK仓库</strong></strong></strong></h4> 
<blockquote> 
 <p style="margin-left:0pt;">Add the following in your `/etc/yum.repos.d/` directory in a file with a `.repo` suffix, for example `logstash.repo`</p> 
 <p style="margin-left:0pt;">cat &lt;&lt;EOF | tee /etc/yum.repos.d/elasticsearch.repo</p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">[elasticsearch-7.x]</span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">name=Elasticsearch repository for 7.x packages</span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">baseurl=https://artifacts.elastic.co/packages/7.x/yum</span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">gpgcheck=1</span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch</span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">enabled=1</span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">autorefresh=1</span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">type=rpm-md</span></p> 
 <p style="margin-left:0pt;">EOF</p> 
</blockquote> 
<p style="margin-left:0pt;">本文参考博文：https://www.voidking.com/dev-centos7-install-elk/</p> 
<h2 style="margin-left:0pt;"><strong><strong><strong>二、ES服务器部署</strong></strong><strong><strong>logstash</strong></strong></strong></h2> 
<p style="margin-left:0pt;">Logstash是基于Java生态圈的语言开发的，所以安装Logstash之前需要先安装JDK。Logstash 7目前只支持Java8或Java 11，所以安装前要检查安装JDK的版本是否正确。Logstash提供了DEBh和RPM安装包，还提供了tar. gz和zip压缩包，也可以直接通过Docker启动Logstash。安装过程比较简单，直接解压缩文件是最简单的办法。</p> 
<p style="margin-left:0pt;">Logstash 的启动命令位于安装路径的 bin 目录中，直接运行 logstash 不行， 需要按如下方式提供参数: ./logstash -e "input {stdin {}} output {stdout{}}" 启动时应注意: -e 参数后要使用双引号。如果在命令行启动日志中看到 “Successfully started Logstash API end-point l:port= &gt;9600”，就证明启动成功</p> 
<p style="margin-left:0pt;">在上面的命令行中，-e 代表输入配置字符串，定义了一个标准输入插件( 即 stdin) 和一个标准输出插件( 即 stdout),意思就是从命令行提取输入，并在命令行直接 将提取的数据输出。如果想要更换输入或输出，只要将 input 或 output 中的插 件名称更改即可，这充分体现了 Logstash 管道配置的灵活性。按示例启动 Logstash，命令行将会等待输入，键人“Hello, World!"后会在命令行返回结果如 下:</p> 
<p style="margin-left:0pt;"> </p> 
<p style="margin-left:0pt;"><img alt="" height="149" src="https://images2.imgbox.com/df/29/zPho0vgt_o.png" width="1105"></p> 
<p style="margin-left:0pt;">在默认情况下，stdout 输出插件的编解码器为 rubydebug,所以输出内容中 包含了版本、时间等信息，其中 message 属性包含的就是在命令行输入的内容。 试着将输出插件的编码器更换为 plain 或 line，则输入的结果将会发生变化: ./logstash -e "input {stdin {}} output {stdout{codec =&gt; plain}}"</p> 
<h3><strong><strong><strong>1</strong></strong><strong><strong>、</strong></strong><strong><strong>RPM方式</strong></strong><strong><strong>安装logstash</strong></strong></strong></h3> 
<h4><strong><strong><strong>1</strong></strong><strong><strong>.1</strong></strong><strong><strong>、</strong></strong><strong><strong>下载下载RPM安装包</strong></strong></strong></h4> 
<p style="margin-left:0pt;"><strong><strong>1）</strong></strong><strong><strong>192.168.</strong></strong><strong><strong>0</strong></strong><strong><strong>.</strong></strong><strong><strong>101</strong></strong><strong><strong>上执行</strong></strong><strong><strong>：</strong></strong></p> 
<blockquote> 
 <p style="margin-left:0pt;">wget <a href="https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.7.0-x86_64.rpm" rel="nofollow"><u><span style="color:#0000ff;"><u>https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.7.0-x86_64.rpm</u></span></u></a></p> 
 <p style="margin-left:0pt;">wget <a href="https://artifacts.elastic.co/downloads/kibana/kibana-7.7.0-x86_64.rpm" rel="nofollow"><u><span style="color:#0000ff;"><u>https://artifacts.elastic.co/downloads/kibana/kibana-7.7.0-x86_64.rpm</u></span></u></a></p> 
 <p style="margin-left:0pt;">wget <a href="https://artifacts.elastic.co/downloads/logstash/logstash-7.7.0.rpm" rel="nofollow"><u><span style="color:#0000ff;"><u>https://artifacts.elastic.co/downloads/logstash/logstash-7.7.0.rpm</u></span></u></a></p> 
</blockquote> 
<p style="margin-left:0pt;"><strong><strong>2）</strong></strong><strong><strong>192.168.</strong></strong><strong><strong>0</strong></strong><strong><strong>.</strong></strong><strong><strong>102</strong></strong><strong><strong>上执行</strong></strong><strong><strong>：</strong></strong></p> 
<blockquote> 
 <p style="margin-left:0pt;">wget <a href="https://artifacts.elastic.co/downloads/logstash/logstash-7.7.0.rpm" rel="nofollow"><u><span style="color:#0000ff;"><u>https://artifacts.elastic.co/downloads/logstash/logstash-7.7.0.rpm</u></span></u></a></p> 
 <p style="margin-left:0pt;">wget <a href="https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.7.0-x86_64.rpm" rel="nofollow"><strong><u><span style="color:#0000ff;"><strong><u>https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.7.0-x86_64.rpm</u></strong></span></u></strong></a></p> 
 <p style="margin-left:0pt;">wget <a href="http://nginx.org/packages/rhel/7/x86_64/RPMS/nginx-1.8.1-1.el7.ngx.x86_64.rpm" rel="nofollow"><u><span style="color:#0000ff;"><u>http://nginx.org/packages/rhel/7/x86_64/RPMS/nginx-1.8.1-1.el7.ngx.x86_64.rpm</u></span></u></a></p> 
</blockquote> 
<h4><strong><strong><strong>1.2、</strong></strong><strong><strong>RPM方式安装：</strong></strong></strong></h4> 
<p style="margin-left:0pt;"><strong><strong>1）</strong></strong><strong><strong>下载并安装公共签名密钥</strong></strong></p> 
<blockquote> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">sudo rpm --import </span><a href="https://artifacts.elastic.co/GPG-KEY-elasticsearch" rel="nofollow"><u><span style="color:#ff0000;"><u>https://artifacts.elastic.co/GPG-KEY-elasticsearch</u></span></u></a></p> 
</blockquote> 
<p style="margin-left:0pt;">2）安装logstash-7.7.0.rpm</p> 
<blockquote> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">sudo rpm --install logstash-7.7.0.rpm</span></p> 
</blockquote> 
<p style="margin-left:0pt;"><strong><strong>3）</strong></strong><strong><strong>设置Logstash开机自启动</strong></strong></p> 
<blockquote> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">sudo systemctl daemon-reload</span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">sudo systemctl enable logstash</span></p> 
</blockquote> 
<p style="margin-left:0pt;">确认Logstash的安装信息：</p> 
<blockquote> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">rpm -qi logstash</span></p> 
</blockquote> 
<p style="margin-left:0pt;"><strong><strong>4）</strong></strong><strong><strong>测试</strong></strong></p> 
<blockquote> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">/usr/share/logstash/bin/logstash -e 'input{stdin{}}output{stdout{codec=&gt;rubydebug}}'</span></p> 
</blockquote> 
<p style="margin-left:0pt;"><strong><strong>备注：具体配置参见后面步骤详述</strong></strong></p> 
<h3><strong><strong><strong>2、</strong></strong><strong><strong>yum方式部署logstash</strong></strong></strong></h3> 
<p style="margin-left:0pt;">官方安装手册: <a href="https://www.elastic.co/guide/en/logstash/current/installing-logstash.html" rel="nofollow"><u><span style="color:#4183c4;"><u>https://www.elastic.co/guide/en/logstash/current/installing-logstash.html</u></span></u></a></p> 
<h4><strong><strong><strong>2.1、</strong></strong><strong><strong>下载yum源的密钥认证：</strong></strong></strong></h4> 
<blockquote> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">rpm --import </span><a href="https://artifacts.elastic.co/GPG-KEY-elasticsearch" rel="nofollow"><u><span style="color:#ff0000;"><u>https://artifacts.elastic.co/GPG-KEY-elasticsearch</u></span></u></a></p> 
</blockquote> 
<h4><strong><strong><strong>2.2、</strong></strong><strong><strong>利用yum安装logstash</strong></strong></strong></h4> 
<blockquote> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">yum install -y logstash</span></p> 
</blockquote> 
<p style="margin-left:0pt;">查看下logstash的安装目录：</p> 
<blockquote> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">rpm -ql logstash</span></p> 
</blockquote> 
<p style="margin-left:0pt;">创建一个软连接，每次执行命令的时候不用在写安装路劲（默认安装在/usr/share下）</p> 
<blockquote> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">ln -s /usr/share/logstash/bin/logstash /bin/</span></p> 
</blockquote> 
<h4><strong><strong><strong>2.3、</strong></strong><strong><strong>启动测试执行logstash的命令</strong></strong></strong></h4> 
<p style="margin-left:0pt;"><strong><strong>1）通过rubydebug来输出下更详细的信息 :</strong></strong></p> 
<blockquote> 
 <p style="margin-left:0pt;">logstash -e 'input { stdin { } } output { stdout {codec =&gt; rubydebug} }'</p> 
</blockquote> 
<p style="margin-left:0pt;">执行成功输入: <span style="color:#ff0000;">hello logstash</span></p> 
<p style="margin-left:0pt;"><strong><strong>2）</strong></strong><strong><strong>stdout输出的结果:</strong></strong></p> 
<blockquote> 
 <p style="margin-left:0pt;">hello logstash { "message" =&gt; "hello logstash", "host" =&gt; "localhost.localdomain", "@time<span style="color:#333333;">stamp" =&gt; 2020-07-08T15:24:35.594Z, "@version" =&gt; "1" }</span></p> 
</blockquote> 
<h3><strong><strong><strong>3、压缩包方式部署</strong></strong><strong><strong>logstash</strong></strong></strong></h3> 
<h4><strong><strong><strong>3.1、下载安装包</strong></strong></strong></h4> 
<p style="margin-left:0pt;">到官方release发布也下载：</p> 
<blockquote> 
 <p style="margin-left:0pt;"><a href="https://www.elastic.co/cn/downloads/past-releases#kibana" rel="nofollow"><strong><u><span style="color:#0000ff;"><strong><u>https://www.elastic.co/cn/downloads/past-releases</u></strong></span></u></strong></a></p> 
 <p style="margin-left:0pt;">例如：<a href="https://artifacts.elastic.co/downloads/kibana/kibana-7.7.0-linux-x86_64.tar.gz" rel="nofollow"><strong><u><span style="color:#0000ff;"><strong><u>https://artifacts.elastic.co/downloads/kibana/kibana-7.7.0-linux-x86_64.tar.gz</u></strong></span></u></strong></a></p> 
</blockquote> 
<h4><strong><strong><strong>3.2、上传安装包并解压</strong></strong></strong></h4> 
<p style="margin-left:0pt;">这里安装目录为：</p> 
<p style="margin-left:0pt;">安装包目录：<span style="color:#ff0000;">/usr/local/elk</span></p> 
<p style="margin-left:0pt;">解压：<span style="color:#ff0000;">tar -zxvf logstash-7.7.0.tar.gz</span></p> 
<h4><strong><strong><strong>3.3、修改配置</strong></strong></strong></h4> 
<p style="margin-left:0pt;">在安装包目录config下面添加配置：</p> 
<p style="margin-left:0pt;">安装路劲：<span style="color:#ff0000;">/usr/local/elk/logstash-7.7.0</span></p> 
<h3><strong><strong><strong>4、配置logsash并启动测试</strong></strong></strong></h3> 
<p style="margin-left:0pt;">官方指南: <a href="https://www.elastic.co/guide/en/logstash/current/configuration.html" rel="nofollow"><u><span style="color:#4183c4;"><u>https://www.elastic.co/guide/en/logstash/current/configuration.html</u></span></u></a></p> 
<h4><strong><strong><strong>4.1、</strong></strong><strong><strong>创建配置文件</strong></strong><strong><strong>elk</strong></strong><strong><strong>.conf</strong></strong></strong></h4> 
<p style="margin-left:0pt;"><strong><strong>1）如果是RPM或者yum安装方式，新建命令：</strong></strong></p> 
<blockquote> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">vim /etc/logstash/conf.d/elk.conf</span></p> 
</blockquote> 
<p style="margin-left:0pt;">2）如果是手动安装压缩包方式：则在config目录下面找到对应的logstash-sample.conf文件复制一个elk.conf文件，然后编辑。</p> 
<h4><strong><strong><strong>4.2、</strong></strong><strong><strong>文件中添加以下内容</strong></strong><strong><strong>：</strong></strong></strong></h4> 
<p style="margin-left:0pt;">测试收集elasticsearch的日志并且将日志输出到elasticsearch，配置如下所示：</p> 
<blockquote> 
 <p style="margin-left:0pt;">[es@localhost config]$ <span style="color:#ff0000;">vim </span><span style="color:#ff0000;">elk.conf </span></p> 
 <p style="margin-left:0pt;"># Sample Logstash configuration for creating a simple</p> 
 <p style="margin-left:0pt;"># Beats -&gt; Logstash -&gt; Elasticsearch pipeline.</p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">input {<!-- --></span></p> 
 <p style="margin-left:0pt;">  file {<!-- --></p> 
 <p style="margin-left:0pt;">   <span style="color:#ff0000;"> path =&gt; "/var/log/elasticsearch</span><span style="color:#ff0000;">/</span><span style="color:#ff0000;">my-application.log"</span></p> 
 <p style="margin-left:0pt;">   <span style="color:#ff0000;"> type =&gt; "elasticsearch"</span></p> 
 <p style="margin-left:0pt;">    start_position =&gt; "beginning"</p> 
 <p style="margin-left:0pt;">  }</p> 
 <p style="margin-left:0pt;">}</p> 
 <p style="margin-left:0pt;">filter {<!-- --></p> 
 <p style="margin-left:0pt;">}</p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">output {<!-- --></span></p> 
 <p style="margin-left:0pt;">  elasticsearch {<!-- --></p> 
 <p style="margin-left:0pt;">    <span style="color:#ff0000;">hosts =&gt; ["http://192.168.0.101:9200"]</span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">    index =&gt; "elasticsearch-%{+YYYY.MM.dd}"</span></p> 
 <p style="margin-left:0pt;">  }</p> 
 <p style="margin-left:0pt;">}</p> 
</blockquote> 
<h4><strong><strong><strong>4.3、配置</strong></strong><strong><strong>logstash.yml</strong></strong><strong><strong>（可选）</strong></strong></strong></h4> 
<p style="margin-left:0pt;"><strong><strong>1）</strong></strong><strong><strong>在/etc/logstash/logstash.yml文件最后加入以下几行</strong></strong></p> 
<p style="margin-left:0pt;">作用：加入以下配置后，可在kibana上上查看logstash的性能</p> 
<blockquote> 
 <p style="margin-left:0pt;">xpack.monitoring.elasticsearch.username: <span style="color:#ff0000;">es</span></p> 
 <p style="margin-left:0pt;">xpack.monitoring.elasticsearch.password:<span style="color:#ff0000;"> chenhuajing710</span></p> 
 <p style="margin-left:0pt;">xpack.monitoring.enabled: <span style="color:#ff0000;">true</span></p> 
 <p style="margin-left:0pt;">xpack.monitoring.elasticsearch.hosts: <span style="color:#ff0000;">["http://192.168.0.101:9200"]</span></p> 
</blockquote> 
<p style="margin-left:0pt;"><strong><strong>2）</strong></strong><strong><strong>配置堆内存</strong></strong><strong><strong>（</strong></strong><strong><strong>建议配置</strong></strong><strong><strong>）</strong></strong></p> 
<p style="margin-left:0pt;">修改<span style="color:#ff0000;">/etc/logstash/jvm.options</span>配置文件</p> 
<blockquote> 
 <p style="margin-left:0pt;"># Xms represents the initial size of total heap space</p> 
 <p style="margin-left:0pt;"># Xmx represents the maximum size of total heap space</p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">-Xms4g</span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">-Xmx4g</span></p> 
</blockquote> 
<p style="margin-left:0pt;"><strong><strong>3）</strong></strong><strong><strong> logstash的安装目录和日志目录</strong></strong></p> 
<p style="margin-left:0pt;"><strong><strong>rpm包安装的目录：</strong></strong><span style="color:#ff0000;">/etc/logstash</span></p> 
<p style="margin-left:0pt;"><strong><strong>日志目录</strong></strong>：<span style="color:#ff0000;">/var/log/logstash </span>(可在配置文件中elasticsearch.yml自定义)</p> 
<p style="margin-left:0pt;">创建一个软连接，每次执行命令的时候不用在写安装路劲（<span style="color:#ff0000;">默认安装在/usr/share下</span>）</p> 
<blockquote> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">ln -s /usr/share/logstash/bin/logstash</span> <span style="color:#ff0000;">/bin/</span></p> 
</blockquote> 
<h4><strong><strong><strong>4.4、</strong></strong><strong><strong>使用配置文件运行logstash</strong></strong></strong></h4> 
<p style="margin-left:0pt;"><strong><strong>1）手动安装方式启动：</strong></strong></p> 
<blockquote> 
 <p style="margin-left:0pt;">cd /usr/local/elk/logstash-7.7.0</p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">./bin/logstash -f ./config/elk.conf</span></p> 
</blockquote> 
<p style="margin-left:0pt;">运行成功以后输入以及标准输出结果：</p> 
<p style="margin-left:0pt;"> </p> 
<p style="margin-left:0pt;"><img alt="" height="565" src="https://images2.imgbox.com/82/2e/VGSiTfOp_o.png" width="1109"></p> 
<p style="margin-left:0pt;"><strong><strong>2）RPM方式安装启动</strong></strong></p> 
<p style="margin-left:0pt;">启动Logstash：</p> 
<blockquote> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">systemctl start logstash</span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">systemctl restart logstash</span></p> 
</blockquote> 
<p style="margin-left:0pt;"><strong><strong>3</strong></strong><strong><strong>）</strong></strong><strong><strong>以配置文件方式</strong></strong><strong><strong>启动logstash</strong></strong><strong><strong>(rpm安装)</strong></strong><strong><strong>：</strong></strong></p> 
<p style="margin-left:0pt;">主要配置文件路劲：<span style="color:#ff0000;">cd </span><span style="color:#ff0000;">/etc/logstash/conf.d/</span></p> 
<blockquote> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">/usr/share/logstash/bin/logstash -f </span><span style="color:#ff0000;">.</span><span style="color:#ff0000;">/</span><span style="color:#ff0000;">elk</span><span style="color:#ff0000;">.conf</span></p> 
</blockquote> 
<p style="margin-left:0pt;"><strong><strong>查看Logstash运行状态</strong></strong><strong><strong>：</strong></strong></p> 
<blockquote> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">systemctl status logstash</span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">ps -ef | grep logstash</span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">netstat -nlpt</span></p> 
</blockquote> 
<h4><strong><strong><strong>4.5、</strong></strong><strong><strong>通过rubydebug来输出下更详细的信息:</strong></strong></strong></h4> 
<blockquote> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">logstash -e 'input { stdin { } } output { stdout {codec =&gt; rubydebug} }' </span></p> 
 <p style="margin-left:0pt;">执行成功输入: <span style="color:#ff0000;">hello logstash</span>，</p> 
</blockquote> 
<p style="margin-left:0pt;"><strong><strong>stdout输出的结果</strong></strong><strong><strong>：</strong></strong></p> 
<blockquote> 
 <p style="margin-left:0pt;">hello logstash { "message" =&gt; "hello logstash", "host" =&gt; "localhost.localdomain", "@timestamp" =&gt; 2020-07-08T15:24:35.594Z, "@version" =&gt; "1" }</p> 
</blockquote> 
<h4><strong><strong><strong>4.6、Logstash配置文件以服务方式运行</strong></strong></strong></h4> 
<p style="margin-left:0pt;">在安装目录下修改startip.optins文件</p> 
<p style="margin-left:0pt;"><strong><strong>1）查看默认启动项配置：</strong></strong></p> 
<blockquote> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">vi</span><span style="color:#ff0000;">m</span><span style="color:#ff0000;"> /</span><span style="color:#ff0000;">etc</span><span style="color:#ff0000;">/logstash/config/startup.options</span></p> 
 <p style="margin-left:0pt;"># Set a home directory</p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">LS_HOME=/usr/share/logstash</span></p> 
 <p style="margin-left:0pt;"># logstash settings directory, the path which contains logstash.yml</p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">LS_SETTINGS_DIR=/etc/logstash</span></p> 
 <p style="margin-left:0pt;"><strong><strong>LS_OPTS="--path.settings ${LS_SETTINGS_DIR}</strong></strong><strong><span style="color:#ff0000;"><strong> --path.config /etc/logstash</strong></span></strong><strong><span style="color:#ff0000;"><strong>/conf.d</strong></span></strong><strong><span style="color:#ff0000;"><strong>"</strong></span></strong></p> 
 <p style="margin-left:0pt;">LS_JAVA_OPTS=""</p> 
 <p style="margin-left:0pt;">LS_USER=logstash</p> 
 <p style="margin-left:0pt;">LS_GROUP=logstash</p> 
 <p style="margin-left:0pt;">LS_GC_LOG_FILE=/var/log/logstash/gc.log</p> 
</blockquote> 
<p style="margin-left:0pt;">之后我们编辑logstash.conf 配置文件，下面的例子将heartbeat写到磁盘上</p> 
<blockquote> 
 <p style="margin-left:0pt;">input {<!-- --></p> 
 <p style="margin-left:0pt;">  beats {<!-- --></p> 
 <p style="margin-left:0pt;">    port =&gt; 5044</p> 
 <p style="margin-left:0pt;">  }</p> 
 <p style="margin-left:0pt;">  file {<!-- --></p> 
 <p style="margin-left:0pt;">  <span style="color:#ff0000;">  path =&gt; "/var/log/elasticsearch/my-application.log"</span></p> 
 <p style="margin-left:0pt;">    <span style="color:#ff0000;">type =&gt; "elasticsearch"</span></p> 
 <p style="margin-left:0pt;">    start_position =&gt; "beginning"</p> 
 <p style="margin-left:0pt;">  }</p> 
 <p style="margin-left:0pt;">}</p> 
 <p style="margin-left:0pt;">output {<!-- --></p> 
 <p style="margin-left:0pt;">  elasticsearch {<!-- --></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">    hosts =&gt; ["http://192.168.0.209:9200"]</span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">    index =&gt; "elasticsearch-%{+YYYY.MM.dd}"</span></p> 
 <p style="margin-left:0pt;">  }</p> 
 <p style="margin-left:0pt;">}</p> 
</blockquote> 
<p style="margin-left:0pt;"><strong><strong>2）修改启动</strong></strong><strong><strong>服务</strong></strong></p> 
<p style="margin-left:0pt;">以root身份执行logstash命令创建服务：</p> 
<blockquote> 
 <p style="margin-left:0pt;">vim /etc/systemd/system/logstash.service</p> 
 <p style="margin-left:0pt;">添加：<span style="color:#ff0000;">"--path.config" "</span><span style="color:#ff0000;">/etc/logstash</span><span style="color:#ff0000;">/conf.d</span><span style="color:#ff0000;">"</span></p> 
</blockquote> 
<p style="margin-left:0pt;"> </p> 
<p style="margin-left:0pt;"><img alt="" height="511" src="https://images2.imgbox.com/3c/dc/sMb1YheV_o.png" width="1110"></p> 
<p style="margin-left:0pt;">注意修改完启动文件需要重新启动系统：</p> 
<blockquote> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">systemctl daemon-reload</span></p> 
</blockquote> 
<p style="margin-left:0pt;"><strong><strong>3）以</strong></strong><strong><strong>nohup方式</strong></strong><strong><strong>后台启动运行：</strong></strong></p> 
<blockquote> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">nohup</span> <span style="color:#ff0000;">/usr/share/logstash/bin/logstash -f </span><span style="color:#ff0000;">/etc/logstash/conf.d</span><span style="color:#ff0000;">/</span><span style="color:#ff0000;">elk</span><span style="color:#ff0000;">.conf</span><span style="color:#ff0000;">&gt;/dev/null &amp;</span></p> 
 <p style="margin-left:0pt;">nohup /usr/<span style="color:#ff0000;">share</span>/logstash/bin/logstash -f /etc/logstash/conf.d/<span style="color:#ff0000;">elk</span>.conf -w 8 -b 1000 &gt; /dev/null 2&gt;&amp;1 &amp;</p> 
</blockquote> 
<h3><strong><strong><strong>5、测试日志搜集与输出</strong></strong></strong></h3> 
<p style="margin-left:0pt;">完成上述安装配置并启动成功以后，我们可以通过查看es的索引管理接口，来确认我们前面配置的索引<span style="color:#ff0000;">elasticsearch-*</span>是否输入到Elasticsearch。</p> 
<p style="margin-left:0pt;">查看路劲：<span style="color:#ff0000;">http://192.168.0.101:9200/_cat/indices</span>，内容如下所示：</p> 
<p style="margin-left:0pt;"> </p> 
<p style="margin-left:0pt;"><img alt="" height="245" src="https://images2.imgbox.com/00/85/chzxEMLo_o.png" width="787"></p> 
<p style="margin-left:0pt;">索引保存成功以后我们就可以在ES的可视化界面Kibana页面创建索引，如下如所示：</p> 
<p style="margin-left:0pt;">展开左侧菜单，点击<span style="color:#ff0000;">management</span>，Kibana区块点击<span style="color:#ff0000;">索引模式</span><span style="color:#ff0000;">（index Patterns）</span>，点击“创建索引模式”按钮，输入<span style="color:#ff0000;">elasticsearch-*</span></p> 
<p style="margin-left:0pt;"> </p> 
<p style="margin-left:0pt;"><img alt="" height="475" src="https://images2.imgbox.com/ff/41/0kccIsN4_o.png" width="1105"></p> 
<p style="margin-left:0pt;">点击“下一步”，选择时间字段为<span style="color:#ff0000;">@timestamp</span>，点击“创建索引模式”按钮：</p> 
<p style="margin-left:0pt;"> </p> 
<p style="margin-left:0pt;"><img alt="" height="432" src="https://images2.imgbox.com/58/83/uDheycGK_o.png" width="1107"></p> 
<p style="margin-left:0pt;">展开左侧菜单，点击“Discover”，选择我们刚才创建的索引：</p> 
<p style="margin-left:0pt;"> </p> 
<p style="margin-left:0pt;"><img alt="" height="735" src="https://images2.imgbox.com/49/9b/VT9CSyq9_o.png" width="1133"></p> 
<p style="margin-left:0pt;">搜索出来的日志信息即为<span style="color:#ff0000;">elasticsearch</span>打印的日志信息。</p> 
<h2 style="margin-left:0pt;"><strong><strong><strong>三、</strong></strong><strong><strong>客户节点部署</strong></strong><strong><strong>logsash</strong></strong></strong></h2> 
<h3><strong><strong><strong>1、安装nginx服务</strong></strong></strong></h3> 
<h4><strong><strong><strong>1.1、</strong></strong><strong><strong>nginx</strong></strong><strong><strong>安装运行</strong></strong></strong></h4> 
<p style="margin-left:0pt;">安装Nginx(192.168.0.102)(为测试Logstash收集日志，本步骤非必须)</p> 
<p style="margin-left:0pt;"><strong><strong>1）下载安装包：</strong></strong></p> 
<blockquote> 
 <p style="margin-left:0pt;">wget <a href="http://nginx.org/packages/rhel/7/x86_64/RPMS/nginx-1.18.0-1.el7.ngx.x86_64.rpm" rel="nofollow"><u><span style="color:#0000ff;"><u>http://nginx.org/packages/rhel/7/x86_64/RPMS/nginx-1.18.0-1.el7.ngx.x86_64.rpm</u></span></u></a></p> 
</blockquote> 
<p style="margin-left:0pt;"><strong><strong>2）Rpm安装：</strong></strong></p> 
<blockquote> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">rpm --install nginx-1.18.0-1.el7.ngx.x86_64.rpm</span></p> 
</blockquote> 
<p style="margin-left:0pt;"><strong><strong>3）</strong></strong><strong><strong>设置开机自启动</strong></strong></p> 
<blockquote> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">systemctl daemon-reload</span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">systemctl enable nginx</span></p> 
</blockquote> 
<p style="margin-left:0pt;"><strong><strong>4）</strong></strong><strong><strong>启动Nginx</strong></strong></p> 
<blockquote> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">systemctl start nginx</span></p> 
</blockquote> 
<p style="margin-left:0pt;">备注：</p> 
<p style="margin-left:0pt;">Nginx启停命令：</p> 
<blockquote> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">./nginx -c /usr/local/nginx/conf/nginx.conf</span></p> 
</blockquote> 
<p style="margin-left:0pt;">如果不指定<span style="color:#ff0000;">nginx.conf</span>，默认为NGINX_HOME/conf/nginx.conf</p> 
<blockquote> 
 <p style="margin-left:0pt;">./nginx -s stop 停止</p> 
 <p style="margin-left:0pt;">./nginx -s quit 退出</p> 
 <p style="margin-left:0pt;">./nginx -s reload 重新加载nginx.conf</p> 
</blockquote> 
<p style="margin-left:0pt;">浏览器访问Nginx：<a href="http://192.168.0.102/index.html" rel="nofollow"><u><span style="color:#0000ff;"><u>http://192.168.0.102/index.html</u></span></u></a></p> 
<p style="margin-left:0pt;"> </p> 
<p style="margin-left:0pt;"><img alt="" height="244" src="https://images2.imgbox.com/23/be/JL6ZJdUT_o.png" width="608"></p> 
<h4><strong><strong><strong>1.2、Nginx配置：</strong></strong></strong></h4> 
<p style="margin-left:0pt;"><strong><strong>1）编辑nginx默认的配置文件</strong></strong></p> 
<p style="margin-left:0pt;">主要是将日志配置信息打开，为logstash收集日志提供数据。</p> 
<p style="margin-left:0pt;">然后修改<span style="color:#ff0000;">/etc/nginx/nginx.conf</span>配置，在http配置块中加入如下配置：</p> 
<blockquote> 
 <p style="margin-left:0pt;">log_format <span style="color:#ff0000;">access_log_json </span>'{"user_ip":"$http_x_forwarded_for","lan_ip":"$remote_addr","log_time":"$time_iso8601","user_rqp":"$request","http_code":"$status","body_bytes_sent":"$body_bytes_sent","req_time":"$request_time","user_ua":"$http_user_agent"}';</p> 
 <p style="margin-left:0pt;">   access_log  /var/log/nginx/access.log  <span style="color:#ff0000;">access_log_json</span>;</p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">vim </span><span style="color:#ff0000;">/etc/nginx/nginx.conf</span></p> 
 <p style="margin-left:0pt;"><strong><span style="color:#ff0000;">默认配置内容如下所示：</span></strong></p> 
 <p style="margin-left:0pt;">user  nginx;</p> 
 <p style="margin-left:0pt;">worker_processes  1;</p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">error_log  /var/log/nginx/error.log warn;</span></p> 
 <p style="margin-left:0pt;">pid        /var/run/nginx.pid;</p> 
 <p style="margin-left:0pt;">events {<!-- --></p> 
 <p style="margin-left:0pt;">    worker_connections  1024;</p> 
 <p style="margin-left:0pt;">}</p> 
 <p style="margin-left:0pt;">http {<!-- --></p> 
 <p style="margin-left:0pt;">    include       /etc/nginx/mime.types;</p> 
 <p style="margin-left:0pt;">    default_type  application/octet-stream;</p> 
 <p style="margin-left:0pt;">   <span style="color:#ff0000;"> log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '</span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">                      '$status $body_bytes_sent "$http_referer" '</span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">                      '"$http_user_agent" "$http_x_forwarded_for"';</span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">    access_log  /var/log/nginx/access.log  main;</span></p> 
 <p style="margin-left:0pt;">    sendfile        on;</p> 
 <p style="margin-left:0pt;">    #tcp_nopush     on;</p> 
 <p style="margin-left:0pt;">    keepalive_timeout  65;</p> 
 <p style="margin-left:0pt;">    #gzip  on;</p> 
 <p style="margin-left:0pt;">    include /etc/nginx/conf.d/*.conf;</p> 
 <p style="margin-left:0pt;">}</p> 
</blockquote> 
<p style="margin-left:0pt;"><strong><strong>2）</strong></strong><strong><strong>设置日志文件权限</strong></strong><strong><strong>：</strong></strong></p> 
<blockquote> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">chmod -R 755 /var/log/nginx/access.log</span></p> 
</blockquote> 
<h4><strong><strong><strong>1.3、重启访问nginx</strong></strong></strong></h4> 
<p style="margin-left:0pt;">访问地址：http://192.168.0.102/index.html</p> 
<h3><strong><strong><strong>2、安装logstash(略)</strong></strong></strong></h3> 
<p style="margin-left:0pt;">安装步骤参考前面的安装说明即可。</p> 
<h4><strong><strong><strong>2.1、</strong></strong><strong><strong>创建Logstash配置文件</strong></strong><strong><strong>：</strong></strong></strong></h4> 
<blockquote> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">vim /etc/logstash/conf.d/</span><span style="color:#ff0000;">elk</span><span style="color:#ff0000;">.conf</span></p> 
</blockquote> 
<p style="margin-left:0pt;"><strong><strong>输入以下配置</strong></strong><strong><strong>：</strong></strong></p> 
<blockquote> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">input {<!-- --></span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">  file {<!-- --></span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">    path =&gt; "/usr/local/nginx/logs/host.access.log"</span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">    type =&gt; "nginx"</span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">    start_position =&gt; "beginning"</span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">  }</span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">}</span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">filter {<!-- --></span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">}</span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">output {<!-- --></span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">  elasticsearch {<!-- --></span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">    hosts =&gt; ["http://192.168.0.101:9200"]</span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">    index =&gt; "</span><span style="color:#ff0000;">nginx</span><span style="color:#ff0000;">-%{+YYYY.MM.dd}"</span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">    user =&gt; "es"</span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">    password =&gt; "chenhuajing710"</span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">  }</span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">}</span></p> 
</blockquote> 
<h4><strong><strong><strong>2.2、</strong></strong><strong><strong>重启Logstash</strong></strong></strong></h4> 
<blockquote> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">systemctl restart logstash</span></p> 
 <p style="margin-left:0pt;">或者：<span style="color:#ff0000;">./bin/logstash -f ./config/elk.conf </span></p> 
</blockquote> 
<p style="margin-left:0pt;"><strong><strong>查看运行状态</strong></strong><strong><strong>：</strong></strong></p> 
<blockquote> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">systemctl status logstash</span></p> 
</blockquote> 
<p style="margin-left:0pt;">完成上述安装配置并启动成功以后，我们可以通过查看es的索引管理接口，来确认我们前面配置的索引<span style="color:#ff0000;">elasticsearch-*</span>是否输入到Elasticsearch。</p> 
<p style="margin-left:0pt;">查看路劲：<span style="color:#ff0000;">http://192.168.0.101:9200/_cat/indices</span>，内容如下所示：</p> 
<p style="margin-left:0pt;"> </p> 
<p style="margin-left:0pt;"><img alt="" height="242" src="https://images2.imgbox.com/58/71/Xj2MzsW0_o.png" width="761"></p> 
<p style="margin-left:0pt;">然后在kibana页面创建nginx-*索引，最后在Discover页面选择nginx索引查看日志数据：</p> 
<p style="margin-left:0pt;"> </p> 
<p style="margin-left:0pt;"><img alt="" height="668" src="https://images2.imgbox.com/8c/42/VXsao5dy_o.png" width="1109"></p> 
<h3><strong><strong><strong>3、</strong></strong><strong><strong>收集Nginx的access.log和error.log</strong></strong></strong></h3> 
<h4><strong><strong><strong>3.1、</strong></strong><strong><strong>创建Logstash配置</strong></strong></strong></h4> 
<blockquote> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">vim /etc/logstash/conf.d/nginx_log.conf</span></p> 
 <p style="margin-left:0pt;">配置如下：</p> 
 <p style="margin-left:0pt;">[root@localhost config]# <span style="color:#ff0000;">cat nginx_log.conf </span></p> 
 <p style="margin-left:0pt;">input {<!-- --></p> 
 <p style="margin-left:0pt;">  file {<!-- --></p> 
 <p style="margin-left:0pt;">    <span style="color:#ff0000;">path =&gt; "/var/log/nginx/access.log"</span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">    type =&gt; "nginx-access"</span></p> 
 <p style="margin-left:0pt;">    start_position =&gt; "beginning"</p> 
 <p style="margin-left:0pt;">  }</p> 
 <p style="margin-left:0pt;">  file {<!-- --></p> 
 <p style="margin-left:0pt;">   <span style="color:#ff0000;"> path =&gt; "/var/log/nginx/error.log"</span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">    type =&gt; "nginx-error"</span></p> 
 <p style="margin-left:0pt;">    start_position =&gt; "beginning"</p> 
 <p style="margin-left:0pt;">  }</p> 
 <p style="margin-left:0pt;">}</p> 
 <p style="margin-left:0pt;">filter {<!-- --></p> 
 <p style="margin-left:0pt;">}</p> 
 <p style="margin-left:0pt;">output {<!-- --></p> 
 <p style="margin-left:0pt;"> <span style="color:#ff0000;">if [type] == "nginx-access"{<!-- --></span></p> 
 <p style="margin-left:0pt;">   elasticsearch {<!-- --></p> 
 <p style="margin-left:0pt;">     hosts =&gt; ["http://192.168.0.101:9200"]</p> 
 <p style="margin-left:0pt;">     <span style="color:#ff0000;">index =&gt; "nginx-log-access-%{+YYYY.MM.dd}"</span></p> 
 <p style="margin-left:0pt;">     user =&gt; "es"</p> 
 <p style="margin-left:0pt;">     password =&gt; "chenhuajing710"</p> 
 <p style="margin-left:0pt;">    }</p> 
 <p style="margin-left:0pt;"> }</p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;"> if [type] == "nginx-error"{<!-- --></span></p> 
 <p style="margin-left:0pt;">   elasticsearch {<!-- --></p> 
 <p style="margin-left:0pt;">      hosts =&gt; ["http://192.168.0.101:9200"]</p> 
 <p style="margin-left:0pt;">      <span style="color:#ff0000;">index =&gt; "nginx-log-error-%{+YYYY.MM.dd}"</span></p> 
 <p style="margin-left:0pt;">      user =&gt; "es"</p> 
 <p style="margin-left:0pt;">      password =&gt; "chenhuajing710"</p> 
 <p style="margin-left:0pt;">    }</p> 
 <p style="margin-left:0pt;"> }</p> 
 <p style="margin-left:0pt;">}</p> 
</blockquote> 
<p style="margin-left:0pt;"> </p> 
<p style="margin-left:0pt;"><img alt="" height="481" src="https://images2.imgbox.com/48/b0/uh6ww2nl_o.png" width="759"></p> 
<p style="margin-left:0pt;"><strong><strong>关于filter的配置参考如下：</strong></strong></p> 
<blockquote> 
 <p style="margin-left:0pt;">filter {<!-- --></p> 
 <p style="margin-left:0pt;">if [type] == "nginx-access"{<!-- --></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">grok {<!-- --></span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">match =&gt; ["message","%{IPORHOST:remote_addr} - %{HTTPDUSER:remote_user} \[%{HTTPDATE:time_local}\] \"(?:%{WORD:method} %{NOTSPACE:request}(?: HTTP/%{NUMBER:httpversion})?|%{DATA:rawrequest})\" %{NUMBER:status} (?:%{NUMBER:body_bytes}|-) %{QS:referrer} %{QS:user_agent} %{QS:x_forward_for}"]</span></p> 
 <p style="margin-left:0pt;">}</p> 
 <p style="margin-left:0pt;">}</p> 
 <p style="margin-left:0pt;">if [type] == "nginx-error"{<!-- --></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">grok {<!-- --></span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">match =&gt; [</span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">    "message", "(?&lt;time_local&gt;%{YEAR}[./-]%{MONTHNUM}[./-]%{MONTHDAY}[- ]%{TIME}) \[%{LOGLEVEL:log_level}\] %{POSINT:pid}#%{NUMBER}: %{GREEDYDATA:error_message}(?:, client: (?&lt;client&gt;%{IP}|%{HOSTNAME}))(?:, server: %{IPORHOST:server}?)(?:, request: %{QS:request})?(?:, upstream: (?&lt;upstream&gt;\"%{URI}\"|%{QS}))?(?:, host: %{QS:request_host})?(?:, referrer: \"%{URI:referrer}\")?",</span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">"message", "(?&lt;time_local&gt;%{YEAR}[./-]%{MONTHNUM}[./-]%{MONTHDAY}[- ]%{TIME}) \[%{LOGLEVEL:log_level}\]\s{1,}%{GREEDYDATA:error_message}"</span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">]</span></p> 
 <p style="margin-left:0pt;">}</p> 
 <p style="margin-left:0pt;">}</p> 
 <p style="margin-left:0pt;">date {<!-- --></p> 
 <p style="margin-left:0pt;">match =&gt; [ "timestamp" , "dd/MMM/yyyy:HH:mm:ss Z" ]</p> 
 <p style="margin-left:0pt;">}</p> 
 <p style="margin-left:0pt;">    mutate {<!-- --></p> 
 <p style="margin-left:0pt;">        convert =&gt; [ "status", "integer" ]</p> 
 <p style="margin-left:0pt;">        convert =&gt; [ "body_bytes","integer" ]</p> 
 <p style="margin-left:0pt;">    }</p> 
 <p style="margin-left:0pt;">ruby {<!-- --></p> 
 <p style="margin-left:0pt;">code =&gt; "event.set('log_day', event.get('@timestamp').time.localtime.strftime('%Y%m%d'))"</p> 
 <p style="margin-left:0pt;">}</p> 
 <p style="margin-left:0pt;">}</p> 
</blockquote> 
<p style="margin-left:0pt;"><strong><strong>检查配置</strong></strong><strong><strong>：</strong></strong></p> 
<h4 style="margin-left:0pt;"><span style="color:#ff0000;">/usr/share/logstash/bin/logstash --config.test_and_exit -f /etc/logstash/conf.d/nginx_log.conf</span></h4> 
<h4><strong><strong><strong>3.2、</strong></strong><strong><strong>测试收集和解析日志</strong></strong></strong></h4> 
<p style="margin-left:0pt;"><strong><strong>1）</strong></strong><strong><strong>如果Logstash当前正在运行，先停掉</strong></strong></p> 
<blockquote> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">systemctl stop logstash</span></p> 
</blockquote> 
<p style="margin-left:0pt;"><strong><strong>2）</strong></strong><strong><strong>指定配置文件执行，测试终端输出结果</strong></strong></p> 
<blockquote> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">/usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/nginx_log.conf</span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">nohup sh /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/nginx_log.conf &amp;</span></p> 
</blockquote> 
<p style="margin-left:0pt;">systemd启动Logstash并查看运行状态</p> 
<blockquote> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">systemctl status logstash</span></p> 
</blockquote> 
<p style="margin-left:0pt;"><strong><strong>3）</strong></strong><strong><strong>生产错误日志：把Nginx配置文件改错，</strong></strong><strong><strong>重启</strong></strong><strong><strong>Nginx</strong></strong></p> 
<blockquote> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">systemctl </span><span style="color:#ff0000;">restart </span><span style="color:#ff0000;">nginx</span></p> 
</blockquote> 
<p style="margin-left:0pt;"><strong><strong>4）查看ES索引存储情况：</strong></strong></p> 
<p style="margin-left:0pt;"> </p> 
<p style="margin-left:0pt;"><img alt="" height="305" src="https://images2.imgbox.com/47/54/xwf357QV_o.png" width="790"></p> 
<p style="margin-left:0pt;">在kibana页面创建access和error log的索引，然后查看错误信息：</p> 
<p style="margin-left:0pt;"> </p> 
<p style="margin-left:0pt;"><img alt="" height="191" src="https://images2.imgbox.com/c0/a8/0gPOwH4h_o.png" width="1102"></p> 
<p style="margin-left:0pt;">改回正确配置，启动Nginx，浏览器访问Nginx，访问一个不存在的页面，生产错误日志：</p> 
<p style="margin-left:0pt;">访问：<a href="http://192.168.0.102/inde.html" rel="nofollow"><u><span style="color:#0000ff;"><u>http://192.168.0.102/inde.html</u></span></u></a><span style="color:#ff0000;"> （将index.html改为inde.html）</span></p> 
<p style="margin-left:0pt;"> </p> 
<p style="margin-left:0pt;"><img alt="" height="416" src="https://images2.imgbox.com/56/a0/D434UZrp_o.png" width="1067"></p> 
<p style="margin-left:0pt;"><span style="color:#252525;">生产访问日志：浏览器访问Nginx，访问一个存在的页面</span><span style="color:#252525;">，</span><span style="color:#252525;">可以看到正常的日志访问信息</span><span style="color:#252525;">：</span></p> 
<p style="margin-left:0pt;"> </p> 
<p style="margin-left:0pt;"><img alt="" height="494" src="https://images2.imgbox.com/ab/7a/V4P0mOe9_o.png" width="1110"></p> 
<h2 style="margin-left:0pt;"><strong><strong><strong>四、</strong></strong><strong><strong>日志采集系统构建实战</strong></strong></strong></h2> 
<h3><strong><strong><strong>1、环境准备</strong></strong></strong></h3> 
<p style="margin-left:0pt;">1）首先确保服务器已经运行了ES集群与Kibana组件。</p> 
<p style="margin-left:0pt;">2）确保服务器上已经安装部署了logstash。</p> 
<p style="margin-left:0pt;">备注：具体安装步骤参考前面章节。</p> 
<h3><strong><strong><strong>2、配置与测试</strong></strong></strong></h3> 
<h4><strong><strong><strong>2.1、Logstash配置</strong></strong></strong></h4> 
<p style="margin-left:0pt;">在Logstash安装路径下的config目录中，新建一个conf文件，取名为es_log.conf，并且填入以下内容：</p> 
<blockquote> 
 <p style="margin-left:0pt;">input {<!-- --></p> 
 <p style="margin-left:0pt;">  file {<!-- --></p> 
 <p style="margin-left:0pt;">    <span style="color:#0000ff;">path =&gt; "/opt/unimeta/uni-meta-getway/uni-meta-getway-1.0.log"</span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">    type =&gt; "uni-meta-getway"</span></p> 
 <p style="margin-left:0pt;">    start_position =&gt; "beginning"</p> 
 <p style="margin-left:0pt;">    codec =&gt; multiline {<!-- --></p> 
 <p style="margin-left:0pt;">      pattern =&gt; "^\["</p> 
 <p style="margin-left:0pt;">      negate =&gt; true</p> 
 <p style="margin-left:0pt;">      what =&gt; "previous"</p> 
 <p style="margin-left:0pt;">    }</p> 
 <p style="margin-left:0pt;">  }</p> 
 <p style="margin-left:0pt;">  file {<!-- --></p> 
 <p style="margin-left:0pt;">   <span style="color:#0000ff;"> path =&gt; "/opt/unimeta/uni-meta-auth/uni-meta-auth-1.0.log"</span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">    type =&gt; "uni-meta-auth"</span></p> 
 <p style="margin-left:0pt;">    start_position =&gt; "beginning"</p> 
 <p style="margin-left:0pt;">    codec =&gt; multiline {<!-- --></p> 
 <p style="margin-left:0pt;">      pattern =&gt; "^\["</p> 
 <p style="margin-left:0pt;">      negate =&gt; true</p> 
 <p style="margin-left:0pt;">      what =&gt; "previous"</p> 
 <p style="margin-left:0pt;">    }</p> 
 <p style="margin-left:0pt;">  }</p> 
 <p style="margin-left:0pt;">  file {<!-- --></p> 
 <p style="margin-left:0pt;">   <span style="color:#0000ff;"> path =&gt; "/opt/unimeta/uni-meta-manage/uni-meta-manage-1.0.log"</span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">    type =&gt; "uni-meta-manage"</span></p> 
 <p style="margin-left:0pt;">    start_position =&gt; "beginning"</p> 
 <p style="margin-left:0pt;">    codec =&gt; multiline {<!-- --></p> 
 <p style="margin-left:0pt;">      pattern =&gt; "^\["</p> 
 <p style="margin-left:0pt;">      negate =&gt; true</p> 
 <p style="margin-left:0pt;">      what =&gt; "previous"</p> 
 <p style="margin-left:0pt;">    }</p> 
 <p style="margin-left:0pt;">  }</p> 
 <p style="margin-left:0pt;">}</p> 
 <p style="margin-left:0pt;">filter {<!-- --></p> 
 <p style="margin-left:0pt;">}</p> 
 <p style="margin-left:0pt;">output {<!-- --></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;"> if [type] == "uni-meta-getway"{<!-- --></span></p> 
 <p style="margin-left:0pt;">   elasticsearch {<!-- --></p> 
 <p style="margin-left:0pt;">   <span style="color:#0000ff;">  hosts =&gt; ["http://192.168.0.209:9200"]</span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">     index =&gt; "uni-meta-getway-%{+YYYY.MM.dd}"</span></p> 
 <p style="margin-left:0pt;">    }</p> 
 <p style="margin-left:0pt;"> }</p> 
 <p style="margin-left:0pt;"> <span style="color:#0000ff;">if [type] == "uni-meta-auth"{<!-- --></span></p> 
 <p style="margin-left:0pt;">   elasticsearch {<!-- --></p> 
 <p style="margin-left:0pt;">     <span style="color:#0000ff;"> hosts =&gt; ["http://192.168.0.209:9200"]</span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">      index =&gt; "uni-meta-auth-%{+YYYY.MM.dd}</span>"</p> 
 <p style="margin-left:0pt;">    }</p> 
 <p style="margin-left:0pt;"> }</p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;"> if [type] == "uni-meta-manage"{<!-- --></span></p> 
 <p style="margin-left:0pt;">   elasticsearch {<!-- --></p> 
 <p style="margin-left:0pt;">     <span style="color:#0000ff;"> hosts =&gt; ["http://192.168.0.209:9200"]</span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">      index =&gt; "uni-meta-manage-%{+YYYY.MM.dd}"</span></p> 
 <p style="margin-left:0pt;">    }</p> 
 <p style="margin-left:0pt;"> }</p> 
 <p style="margin-left:0pt;"> stdout{}</p> 
 <p style="margin-left:0pt;">}</p> 
</blockquote> 
<h4><strong><strong><strong>2.2、以配置文件方式启动测试</strong></strong></strong></h4> 
<p style="margin-left:0pt;">进入Logstash的bin目录执行</p> 
<blockquote> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">./</span><span style="color:#0000ff;">usr/share/logstash/bin/logstash</span> <span style="color:#0000ff;">-f .</span><span style="color:#0000ff;">/</span><span style="color:#0000ff;">etc/logstash/conf.d</span><span style="color:#0000ff;">/</span><span style="color:#0000ff;">elk</span><span style="color:#0000ff;">.conf</span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">nohup</span> <span style="color:#0000ff;">/usr/share/logstash/bin/logstash -f </span><span style="color:#0000ff;">/etc/logstash/conf.d</span><span style="color:#0000ff;">/</span><span style="color:#0000ff;">elk</span><span style="color:#0000ff;">.conf</span><span style="color:#0000ff;">&gt;/dev/null &amp;</span></p> 
</blockquote> 
<p style="margin-left:0pt;"><strong><strong>控制台会输出：</strong></strong></p> 
<p style="margin-left:0pt;"> </p> 
<p style="margin-left:0pt;"><img alt="" height="358" src="https://images2.imgbox.com/fb/1c/8T2cipFp_o.png" width="1111"></p> 
<p style="margin-left:0pt;">我们到浏览器查询，发现ES中确实创建了一个索引es-log-2020.07.08</p> 
<p style="margin-left:0pt;">然后在在ES中查询这个索引的内容：</p> 
<p style="margin-left:0pt;"> </p> 
<p style="margin-left:0pt;"><img alt="" height="521" src="https://images2.imgbox.com/35/6d/9iwUraYY_o.png" width="1111"></p> 
<p style="margin-left:0pt;">仔细检查存入的日志内容，发现日志信息是作为整体存入message字段的，有没有办法存入的更细粒些呢？仔细分析es的日志，呈现了一定的结构化特征，日志内容总是：<span style="color:#ff0000;">“[时间戳][日志级别][输出信息的类名][节点名]具体的日志信息 ”</span>这种格式，所以我们完全可以考虑使用过滤器插件对文本进行分析后再存入es，怎么分析？可以用grok过滤器。</p> 
<h3><strong><strong><strong>3、使用</strong></strong><strong><strong>grok过滤器</strong></strong></strong></h3> 
<h4><strong><strong><strong>3.1、配置</strong></strong><strong><strong>grok过滤器</strong></strong></strong></h4> 
<p style="margin-left:0pt;">在Logstash安装路径下的config目录中，新建conf文件，取名为<span style="color:#ff0000;">log_grok.conf</span>，并且填入以下内容：</p> 
<blockquote> 
 <p style="margin-left:0pt;">input {<!-- --></p> 
 <p style="margin-left:0pt;">  file {<!-- --></p> 
 <p style="margin-left:0pt;">    <span style="color:#0000ff;">path =&gt; "/opt/unimeta/uni-meta-getway/uni-meta-getway-1.0.log"</span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">    type =&gt; "uni-meta-getway"</span></p> 
 <p style="margin-left:0pt;">    start_position =&gt; "beginning"</p> 
 <p style="margin-left:0pt;">    codec =&gt; multiline {<!-- --></p> 
 <p style="margin-left:0pt;">      pattern =&gt; "^\["</p> 
 <p style="margin-left:0pt;">      negate =&gt; true</p> 
 <p style="margin-left:0pt;">      what =&gt; "previous"</p> 
 <p style="margin-left:0pt;">    }</p> 
 <p style="margin-left:0pt;">  }</p> 
 <p style="margin-left:0pt;">  file {<!-- --></p> 
 <p style="margin-left:0pt;">   <span style="color:#0000ff;"> path =&gt; "/opt/unimeta/uni-meta-auth/uni-meta-auth-1.0.log"</span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">    type =&gt; "uni-meta-auth"</span></p> 
 <p style="margin-left:0pt;">    start_position =&gt; "beginning"</p> 
 <p style="margin-left:0pt;">    codec =&gt; multiline {<!-- --></p> 
 <p style="margin-left:0pt;">      pattern =&gt; "^\["</p> 
 <p style="margin-left:0pt;">      negate =&gt; true</p> 
 <p style="margin-left:0pt;">      what =&gt; "previous"</p> 
 <p style="margin-left:0pt;">    }</p> 
 <p style="margin-left:0pt;">  }</p> 
 <p style="margin-left:0pt;">  file {<!-- --></p> 
 <p style="margin-left:0pt;">   <span style="color:#0000ff;"> path =&gt; "/opt/unimeta/uni-meta-manage/uni-meta-manage-1.0.log"</span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">    type =&gt; "uni-meta-manage"</span></p> 
 <p style="margin-left:0pt;">    start_position =&gt; "beginning"</p> 
 <p style="margin-left:0pt;">    codec =&gt; multiline {<!-- --></p> 
 <p style="margin-left:0pt;">      pattern =&gt; "^\["</p> 
 <p style="margin-left:0pt;">      negate =&gt; true</p> 
 <p style="margin-left:0pt;">      what =&gt; "previous"</p> 
 <p style="margin-left:0pt;">    }</p> 
 <p style="margin-left:0pt;">  }</p> 
 <p style="margin-left:0pt;">}</p> 
 <p style="margin-left:0pt;">filter {<!-- --></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">  grok {<!-- --></span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">    match=&gt;{message=&gt;"%{TIMESTAMP_ISO8601:time}%{SPACE}%{LOGLEVEL:level}%{SPACE}%{NOT SPACE:loggerclass}%{SPACE}%{<!-- --></span>GREEDYDATA:<span style="color:#ff0000;">char}%{SPACE}%{GREEDYDATA:msg}"</span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">}</span></p> 
 <p style="margin-left:0pt;">}</p> 
 <p style="margin-left:0pt;">output {<!-- --></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;"> if [type] == "uni-meta-getway"{<!-- --></span></p> 
 <p style="margin-left:0pt;">   elasticsearch {<!-- --></p> 
 <p style="margin-left:0pt;">   <span style="color:#0000ff;">  hosts =&gt; ["http://192.168.0.209:9200"]</span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">     index =&gt; "uni-meta-getway-%{+YYYY.MM.dd}"</span></p> 
 <p style="margin-left:0pt;">    }</p> 
 <p style="margin-left:0pt;"> }</p> 
 <p style="margin-left:0pt;"> <span style="color:#0000ff;">if [type] == "uni-meta-auth"{<!-- --></span></p> 
 <p style="margin-left:0pt;">   elasticsearch {<!-- --></p> 
 <p style="margin-left:0pt;">     <span style="color:#0000ff;"> hosts =&gt; ["http://192.168.0.209:9200"]</span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">      index =&gt; "uni-meta-auth-%{+YYYY.MM.dd}</span>"</p> 
 <p style="margin-left:0pt;">    }</p> 
 <p style="margin-left:0pt;"> }</p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;"> if [type] == "uni-meta-manage"{<!-- --></span></p> 
 <p style="margin-left:0pt;">   elasticsearch {<!-- --></p> 
 <p style="margin-left:0pt;">     <span style="color:#0000ff;"> hosts =&gt; ["http://192.168.0.209:9200"]</span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">      index =&gt; "uni-meta-manage-%{+YYYY.MM.dd}"</span></p> 
 <p style="margin-left:0pt;">    }</p> 
 <p style="margin-left:0pt;"> }</p> 
 <p style="margin-left:0pt;"> stdout{}</p> 
 <p style="margin-left:0pt;">}</p> 
</blockquote> 
<p style="margin-left:0pt;">如果担心自己写的conf有语法问题，可以执行：</p> 
<blockquote> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">./</span><span style="color:#ff0000;">usr/share/logstash/bin/logstash</span> <span style="color:#ff0000;">-f </span><span style="color:#ff0000;">/</span><span style="color:#ff0000;">etc/logstash/conf.d</span><span style="color:#ff0000;">/</span><span style="color:#ff0000;">elk</span><span style="color:#ff0000;">.conf</span><span style="color:#ff0000;"> -t</span></p> 
</blockquote> 
<p style="margin-left:0pt;">检查conf，当然只能检查语法，不能检查诸如正则表达式是否正确这类问题。</p> 
<p style="margin-left:0pt;">然后再次执行：</p> 
<blockquote> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">/</span><span style="color:#0000ff;">usr/share/logstash/bin/logstash</span> <span style="color:#0000ff;">-f </span><span style="color:#0000ff;">/</span><span style="color:#0000ff;">etc/logstash/conf.d</span><span style="color:#0000ff;">/</span><span style="color:#0000ff;">elk</span><span style="color:#0000ff;">.conf</span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">ps -ef | grep logstash</span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">netstat -nlpt</span></p> 
</blockquote> 
<p style="margin-left:0pt;">如果发现程序没有输出，有可能是elk的日志文件已经被处理过，logstash不会重复处理，这时可以到logstash的/data/plugins/inputs/file目录下，删除.sincedb文件（这个文件是个隐藏文件），再执行启动命令。</p> 
<p style="margin-left:0pt;"> </p> 
<p style="margin-left:0pt;"><img alt="" height="308" src="https://images2.imgbox.com/34/e2/LEekyYAm_o.png" width="1101"></p> 
<p style="margin-left:0pt;">可以看见，每条日志已经成功的被解析了。</p> 
<h4><strong><strong><strong>3.2、使用ES模板配置</strong></strong></strong></h4> 
<p style="margin-left:0pt;">现在考虑如何存入es，按照原来的方式配置是不行的，必须还要做点改变，在config目录下创建一个 <span style="color:#ff0000;">es_template.json</span>，配置内容如下所示：</p> 
<blockquote> 
 <p style="margin-left:0pt;">vim /etc/logstash/<span style="color:#ff0000;">es_template.json</span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">{<!-- --></span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">  "template":"es-log-text-%{+YYYY.MM.dd}",</span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">  "settings": {<!-- --></span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">    "index.refresh_interval":"1s"</span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">  },</span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">  "mappings":{<!-- --></span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">     "properties":{<!-- --></span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">       "time":{<!-- --></span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">         "type":"date"</span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">       },</span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">       "level":{<!-- --></span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">          "type":"keyword"</span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">       },</span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">       "loggerclass":{<!-- --></span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">          "type":"keyword"</span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">       },</span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">       "nodename":{<!-- --></span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">         "type":"keyword"</span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">       },</span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">       "msg":{<!-- --></span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">         "type":"text"</span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">       },</span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">       "message":{<!-- --></span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">         "type":"text"</span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">      }</span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">    }</span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">  }</span></p> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">}</span></p> 
</blockquote> 
<p style="margin-left:0pt;">定义好索引的 mapping（映射），注意要和我们对日志的分解一一对应。</p> 
<h4><strong><strong><strong>3.3、创建新的配置文件并启动</strong></strong></strong></h4> 
<p style="margin-left:0pt;">创建一个新的conf文件，取名elk-grok.conf，内容如下：</p> 
<blockquote> 
 <p style="margin-left:0pt;">input {<!-- --></p> 
 <p style="margin-left:0pt;">  file {<!-- --></p> 
 <p style="margin-left:0pt;">    path =&gt; "/opt/unimeta/uni-meta-getway/uni-meta-getway-1.0.log"</p> 
 <p style="margin-left:0pt;">    type =&gt; "uni-meta-getway"</p> 
 <p style="margin-left:0pt;">    start_position =&gt; "beginning"</p> 
 <p style="margin-left:0pt;">    codec =&gt; multiline {<!-- --></p> 
 <p style="margin-left:0pt;">      pattern =&gt; "^\["</p> 
 <p style="margin-left:0pt;">      negate =&gt; true</p> 
 <p style="margin-left:0pt;">      what =&gt; "previous"</p> 
 <p style="margin-left:0pt;">    }</p> 
 <p style="margin-left:0pt;">  }</p> 
 <p style="margin-left:0pt;">  file {<!-- --></p> 
 <p style="margin-left:0pt;">    path =&gt; "/opt/unimeta/uni-meta-auth/uni-meta-auth-1.0.log"</p> 
 <p style="margin-left:0pt;">    type =&gt; "uni-meta-auth"</p> 
 <p style="margin-left:0pt;">    start_position =&gt; "beginning"</p> 
 <p style="margin-left:0pt;">    codec =&gt; multiline {<!-- --></p> 
 <p style="margin-left:0pt;">      pattern =&gt; "^\["</p> 
 <p style="margin-left:0pt;">      negate =&gt; true</p> 
 <p style="margin-left:0pt;">      what =&gt; "previous"</p> 
 <p style="margin-left:0pt;">    }</p> 
 <p style="margin-left:0pt;">  }</p> 
 <p style="margin-left:0pt;">  file {<!-- --></p> 
 <p style="margin-left:0pt;">    path =&gt; "/opt/unimeta/uni-meta-manage/uni-meta-manage-1.0.log"</p> 
 <p style="margin-left:0pt;">    type =&gt; "uni-meta-manage"</p> 
 <p style="margin-left:0pt;">    start_position =&gt; "beginning"</p> 
 <p style="margin-left:0pt;">    codec =&gt; multiline {<!-- --></p> 
 <p style="margin-left:0pt;">      pattern =&gt; "^\["</p> 
 <p style="margin-left:0pt;">      negate =&gt; true</p> 
 <p style="margin-left:0pt;">      what =&gt; "previous"</p> 
 <p style="margin-left:0pt;">    }</p> 
 <p style="margin-left:0pt;">  }</p> 
 <p style="margin-left:0pt;">}</p> 
 <p style="margin-left:0pt;">filter {<!-- --></p> 
 <p style="margin-left:0pt;"> grok {<!-- --></p> 
 <p style="margin-left:0pt;"> <span style="color:#ff0000;"> match=&gt;{message=&gt;"%{TIMESTAMP_ISO8601:time}%{SPACE}%{LOGLEVEL:level}%{SPACE}%{NOT SPACE:loggerclass}%{SPACE}%{<!-- --></span><span style="color:#ff0000;">-</span><span style="color:#ff0000;">}%{SPACE}%{GREEDYDATA:msg}"</span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">}</span></p> 
 <p style="margin-left:0pt;">}</p> 
 <p style="margin-left:0pt;">output {<!-- --></p> 
 <p style="margin-left:0pt;"> if [type] == "uni-meta-getway"{<!-- --></p> 
 <p style="margin-left:0pt;">   elasticsearch {<!-- --></p> 
 <p style="margin-left:0pt;">     hosts =&gt; ["http://192.168.0.209:9200"]</p> 
 <p style="margin-left:0pt;">     index =&gt; "uni-meta-getway-%{+YYYY.MM.dd}"</p> 
 <p style="margin-left:0pt;">     <span style="color:#ff0000;"> template_name =&gt; "es_template*"</span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">      template =&gt; "/etc/logstash/"</span></p> 
 <p style="margin-left:0pt;">    }</p> 
 <p style="margin-left:0pt;"> }</p> 
 <p style="margin-left:0pt;"> if [type] == "uni-meta-auth"{<!-- --></p> 
 <p style="margin-left:0pt;">   elasticsearch {<!-- --></p> 
 <p style="margin-left:0pt;">      hosts =&gt; ["http://192.168.0.209:9200"]</p> 
 <p style="margin-left:0pt;">      index =&gt; "uni-meta-auth-%{+YYYY.MM.dd}"</p> 
 <p style="margin-left:0pt;">    <span style="color:#ff0000;">  template_name =&gt; "es_template*"</span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">      template =&gt; "/etc/logstash/"</span></p> 
 <p style="margin-left:0pt;">    }</p> 
 <p style="margin-left:0pt;"> }</p> 
 <p style="margin-left:0pt;"> if [type] == "uni-meta-manage"{<!-- --></p> 
 <p style="margin-left:0pt;">   elasticsearch {<!-- --></p> 
 <p style="margin-left:0pt;">      hosts =&gt; ["http://192.168.0.209:9200"]</p> 
 <p style="margin-left:0pt;">      index =&gt; "uni-meta-manage-%{+YYYY.MM.dd}"</p> 
 <p style="margin-left:0pt;">      <span style="color:#ff0000;">template_name =&gt; "es_template*" </span></p> 
 <p style="margin-left:0pt;"><span style="color:#ff0000;">      template =&gt; "/etc/logstash/"</span></p> 
 <p style="margin-left:0pt;">    }</p> 
 <p style="margin-left:0pt;"> }</p> 
 <p style="margin-left:0pt;"> stdout{}</p> 
 <p style="margin-left:0pt;">}</p> 
</blockquote> 
<p style="margin-left:0pt;"><strong><strong>主要是在elasticsearch插件中增加了对刚才新增的json文件的读取。</strong></strong></p> 
<p style="margin-left:0pt;"><strong><strong>执行</strong></strong><strong><strong>启动命令：</strong></strong></p> 
<blockquote> 
 <p style="margin-left:0pt;"><span style="color:#0000ff;">./</span><span style="color:#0000ff;">usr/share/logstash/bin/logstash</span> <span style="color:#0000ff;">-f .</span><span style="color:#0000ff;">/</span><span style="color:#0000ff;">etc/logstash/conf.d</span><span style="color:#0000ff;">/</span><span style="color:#0000ff;">elk</span><span style="color:#0000ff;">.conf</span></p> 
</blockquote> 
<p style="margin-left:0pt;">会看到控制台的输出，同时在浏览器中，也会看到解析后的日志：</p> 
<p style="margin-left:0pt;"> </p> 
<p style="margin-left:0pt;"><img alt="" height="516" src="https://images2.imgbox.com/1e/37/kdHytlNF_o.png" width="1113"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5d74870592ea4e7bc191f81d06d6a30b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">tkinter-listbox详解</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a983b68e85f93f819a86a8ca55d6c365/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">RK1808 uboot的编译分析</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>