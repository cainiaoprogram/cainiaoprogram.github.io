<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Arduino Uno &#43; APDS9930 实现手势控制LED灯亮灭、调光等 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Arduino Uno &#43; APDS9930 实现手势控制LED灯亮灭、调光等" />
<meta property="og:description" content="目录 前言功能介绍：1、靠近亮灯、距离保持约10cm常亮，远离延时熄灭2、靠近点亮/熄灭LED，延时期间操作不响应3、挥手点亮/熄灭LED，悬停进行非无极pwm调光 接线效果图源码通用部分APDS9930.cppAPDS9930.h 1、靠近亮灯、距离保持约10cm常亮，远离延时熄灭2、点亮/熄灭LED，延时期间操作不响应3、挥手点亮/熄灭LED，悬停进行非无极pwm调光 参考图 前言 开发板：Arduino Uno Rev3 创客主板
开发环境：Arduino IDE
开发语言：Arduino 语言（类C语言）
模块：APDS9930
源码参考：https://github.com/Depau/APDS9930
功能介绍： 1、靠近亮灯、距离保持约10cm常亮，远离延时熄灭 当有物体靠近传感器约10cm的位置时，触发中断，点亮LED LIGHT_TIME毫秒，持续触发则常亮，无则灭灯。 通过修改 宏定义 LIGHT_TIME调节延时，LED负极接在数字10口（正极 3.3V供电）
2、靠近点亮/熄灭LED，延时期间操作不响应 当有物体靠近传感器约10cm的位置时，触发中断，点亮/熄灭LED，延时RESPONSE_TIME毫秒，延时期间操作不响应。 通过修改 宏定义 RESPONSE_TIME调节延时响应。
3、挥手点亮/熄灭LED，悬停进行非无极pwm调光 当有物体靠近传感器约10cm的位置时，可以触发中断。
如果4RESPONSE_TIME毫秒内 没有触发4次中断，即4RESPONSE_TIME毫秒内，划过传感区域，则为开关模式，会进行LED的亮灭操作（亮到设定的pwm_val)如果4RESPONSE_TIME毫秒内 触发了4次中断，即4RESPONSE_TIME毫秒以上，物体一直停留在传感区域内，则为pwm调光模式，会进行LED的pwm非无极调光（每次在当前基础上增加PWM_CHANGE_VAL）如果在pwm调光模式下，物体移出了传感区域，则会结束pwm值的调节。若下次继续快划，则进行开关，若继续悬停，则继续调光。单位延时RESPONSE_TIME毫秒，延时期间操作不响应。通过修改 宏定义 RESPONSE_TIME调节延时响应，若想增加调光速率，可减小此值。通过修改 宏定义 PWM_CHANGE_VAL，调节单次pwm调光的大小，范围1-255。若想要更细致的调光，可减小此值。 接线 Arduino Pin APDS-9930 Board Function 3.3V VL 据说用作参考电压，得接上 3.3V VCC Power GND GND Ground A4 SDA I2C Data A5 SCL I2C Clock 2 INT Interrupt 10 - LED 效果图 Arduino&#43;APDS9930 实现手势控制灯亮灭、调光等" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/b934bc46db5602bc533e494014c3cb72/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-10-22T09:05:12+08:00" />
<meta property="article:modified_time" content="2021-10-22T09:05:12+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Arduino Uno &#43; APDS9930 实现手势控制LED灯亮灭、调光等</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#_1" rel="nofollow">前言</a></li><li><ul><li><a href="#_10" rel="nofollow">功能介绍：</a></li><li><ul><li><a href="#110cm_11" rel="nofollow">1、靠近亮灯、距离保持约10cm常亮，远离延时熄灭</a></li><li><a href="#2LED_13" rel="nofollow">2、靠近点亮/熄灭LED，延时期间操作不响应</a></li><li><a href="#3LEDpwm_15" rel="nofollow">3、挥手点亮/熄灭LED，悬停进行非无极pwm调光</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_23" rel="nofollow">接线</a></li><li><a href="#_38" rel="nofollow">效果图</a></li><li><a href="#_42" rel="nofollow">源码</a></li><li><ul><li><a href="#_44" rel="nofollow">通用部分</a></li><li><ul><li><a href="#APDS9930cpp_45" rel="nofollow">APDS9930.cpp</a></li><li><a href="#APDS9930h_1196" rel="nofollow">APDS9930.h</a></li></ul> 
   </li><li><a href="#110cm_1431" rel="nofollow">1、靠近亮灯、距离保持约10cm常亮，远离延时熄灭</a></li><li><a href="#2LED_1599" rel="nofollow">2、点亮/熄灭LED，延时期间操作不响应</a></li><li><a href="#3LEDpwm_1774" rel="nofollow">3、挥手点亮/熄灭LED，悬停进行非无极pwm调光</a></li></ul> 
  </li><li><a href="#_2036" rel="nofollow">参考图</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>前言</h2> 
<p><strong>开发板</strong>：Arduino Uno Rev3 创客主板<br> <strong>开发环境</strong>：Arduino IDE<br> <strong>开发语言</strong>：Arduino 语言（类C语言）<br> <strong>模块</strong>：APDS9930<br> <img src="https://images2.imgbox.com/b8/95/h1pYMmqa_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/dd/57/uyd9ptnT_o.png" alt="在这里插入图片描述"></p> 
<p>源码参考：<a href="https://github.com/Depau/APDS9930">https://github.com/Depau/APDS9930</a></p> 
<h3><a id="_10"></a>功能介绍：</h3> 
<h4><a id="110cm_11"></a>1、靠近亮灯、距离保持约10cm常亮，远离延时熄灭</h4> 
<p>当有物体靠近传感器约10cm的位置时，触发中断，点亮LED LIGHT_TIME毫秒，持续触发则常亮，无则灭灯。 通过修改 宏定义 LIGHT_TIME调节延时，LED负极接在数字10口（正极 3.3V供电）</p> 
<h4><a id="2LED_13"></a>2、靠近点亮/熄灭LED，延时期间操作不响应</h4> 
<p>当有物体靠近传感器约10cm的位置时，触发中断，点亮/熄灭LED，延时RESPONSE_TIME毫秒，延时期间操作不响应。 通过修改 宏定义 RESPONSE_TIME调节延时响应。</p> 
<h4><a id="3LEDpwm_15"></a>3、挥手点亮/熄灭LED，悬停进行非无极pwm调光</h4> 
<p>当有物体靠近传感器约10cm的位置时，可以触发中断。</p> 
<ul><li>如果4<em>RESPONSE_TIME毫秒内 没有触发4次中断，即4</em>RESPONSE_TIME毫秒内，划过传感区域，则为开关模式，会进行LED的亮灭操作（亮到设定的pwm_val)</li><li>如果4<em>RESPONSE_TIME毫秒内 触发了4次中断，即4</em>RESPONSE_TIME毫秒以上，物体一直停留在传感区域内，则为pwm调光模式，会进行LED的pwm非无极调光（每次在当前基础上增加PWM_CHANGE_VAL）</li><li>如果在pwm调光模式下，物体移出了传感区域，则会结束pwm值的调节。若下次继续快划，则进行开关，若继续悬停，则继续调光。</li><li>单位延时RESPONSE_TIME毫秒，延时期间操作不响应。</li><li>通过修改 宏定义 RESPONSE_TIME调节延时响应，若想增加调光速率，可减小此值。</li><li>通过修改 宏定义 PWM_CHANGE_VAL，调节单次pwm调光的大小，范围1-255。若想要更细致的调光，可减小此值。</li></ul> 
<h2><a id="_23"></a>接线</h2> 
<pre><code class="prism language-c"> Arduino Pin  APDS<span class="token operator">-</span><span class="token number">9930</span> Board  Function
 
 <span class="token number">3.3</span>V         VL               据说用作参考电压，得接上
 <span class="token number">3.3</span>V         VCC              Power
 GND          GND              Ground
 A4           SDA              I2C Data
 A5           SCL              I2C Clock
 <span class="token number">2</span>            INT              Interrupt
 <span class="token number">10</span>           <span class="token operator">-</span>                LED
</code></pre> 
<p><img src="https://images2.imgbox.com/1a/f6/6syteBWr_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_38"></a>效果图</h2> 
<p></p> 
<div class="csdn-video-box"> 
 <iframe id="7PL96eKM-1634864489359" frameborder="0" src="https://live.csdn.net/v/embed/178981" allowfullscreen="true" data-mediaembed="csdn"></iframe> 
 <p>Arduino+APDS9930 实现手势控制灯亮灭、调光等</p> 
</div> 
<p></p> 
<h2><a id="_42"></a>源码</h2> 
<p><img src="https://images2.imgbox.com/be/7e/qS06A7z8_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_44"></a>通用部分</h3> 
<h4><a id="APDS9930cpp_45"></a>APDS9930.cpp</h4> 
<pre><code class="prism language-cpp"><span class="token comment">/**
   @file    APDS-9930.cpp
   @brief   Library for the SparkFun APDS-9930 breakout board
   @author  Shawn Hymel (SparkFun Electronics)

   @copyright	This code is public domain but you buy me a beer if you use
   this and we meet someday (Beerware license).

   This library interfaces the Avago APDS-9930 to Arduino over I2C. The library
   relies on the Arduino Wire (I2C) library. to use the library, instantiate an
   APDS9930 object, call init(), and call the appropriate functions.

   APDS-9930 current draw tests (default parameters):
     Off:                   1mA
     Waiting for gesture:   14mA
     Gesture in progress:   35mA
*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Arduino.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Wire.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"APDS9930.h"</span></span>

<span class="token comment">/**
   @brief Constructor - Instantiates APDS9930 object
*/</span>
<span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">APDS9930</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span>

<span class="token comment">/**
   @brief Destructor
*/</span>
<span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token operator">~</span><span class="token function">APDS9930</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span>

<span class="token comment">/**
   @brief Configures I2C communications and initializes registers to defaults

   @return True if initialized successfully. False otherwise.
*/</span>
<span class="token keyword">bool</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">uint8_t</span> id<span class="token punctuation">;</span>

  <span class="token comment">/* Initialize I2C */</span>
  Wire<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Read ID register and check against known values for APDS-9930 */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireReadDataByte</span><span class="token punctuation">(</span>APDS9930_ID<span class="token punctuation">,</span> id<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">F</span><span class="token punctuation">(</span><span class="token string">"ID read"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token punctuation">(</span>id <span class="token operator">==</span> APDS9930_ID_1 <span class="token operator">||</span> id <span class="token operator">==</span> APDS9930_ID_2<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">F</span><span class="token punctuation">(</span><span class="token string">"ID check"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"ID is "</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">String</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> HEX<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//return false;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* Set ENABLE register to 0 (disable all features) */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">setMode</span><span class="token punctuation">(</span>ALL<span class="token punctuation">,</span> OFF<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">F</span><span class="token punctuation">(</span><span class="token string">"Regs off"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* Set default values for ambient light and proximity registers */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireWriteDataByte</span><span class="token punctuation">(</span>APDS9930_ATIME<span class="token punctuation">,</span> DEFAULT_ATIME<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireWriteDataByte</span><span class="token punctuation">(</span>APDS9930_WTIME<span class="token punctuation">,</span> DEFAULT_WTIME<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireWriteDataByte</span><span class="token punctuation">(</span>APDS9930_PPULSE<span class="token punctuation">,</span> DEFAULT_PPULSE<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireWriteDataByte</span><span class="token punctuation">(</span>APDS9930_POFFSET<span class="token punctuation">,</span> DEFAULT_POFFSET<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireWriteDataByte</span><span class="token punctuation">(</span>APDS9930_CONFIG<span class="token punctuation">,</span> DEFAULT_CONFIG<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">setLEDDrive</span><span class="token punctuation">(</span>DEFAULT_PDRIVE<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">setProximityGain</span><span class="token punctuation">(</span>DEFAULT_PGAIN<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">setAmbientLightGain</span><span class="token punctuation">(</span>DEFAULT_AGAIN<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">setProximityDiode</span><span class="token punctuation">(</span>DEFAULT_PDIODE<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">setProximityIntLowThreshold</span><span class="token punctuation">(</span>DEFAULT_PILT<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">setProximityIntHighThreshold</span><span class="token punctuation">(</span>DEFAULT_PIHT<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">setLightIntLowThreshold</span><span class="token punctuation">(</span>DEFAULT_AILT<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">setLightIntHighThreshold</span><span class="token punctuation">(</span>DEFAULT_AIHT<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireWriteDataByte</span><span class="token punctuation">(</span>APDS9930_PERS<span class="token punctuation">,</span> DEFAULT_PERS<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*******************************************************************************
   Public methods for controlling the APDS-9930
 ******************************************************************************/</span>

<span class="token comment">/**
   @brief Reads and returns the contents of the ENABLE register

   @return Contents of the ENABLE register. 0xFF if error.
*/</span>
<span class="token keyword">uint8_t</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">getMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">uint8_t</span> enable_value<span class="token punctuation">;</span>

  <span class="token comment">/* Read current ENABLE register */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireReadDataByte</span><span class="token punctuation">(</span>APDS9930_ENABLE<span class="token punctuation">,</span> enable_value<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> ERROR<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> enable_value<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
   @brief Enables or disables a feature in the APDS-9930

   @param[in] mode which feature to enable
   @param[in] enable ON (1) or OFF (0)
   @return True if operation success. False otherwise.
*/</span>
<span class="token keyword">bool</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">setMode</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span> mode<span class="token punctuation">,</span> <span class="token keyword">uint8_t</span> enable<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">uint8_t</span> reg_val<span class="token punctuation">;</span>

  <span class="token comment">/* Read current ENABLE register */</span>
  reg_val <span class="token operator">=</span> <span class="token function">getMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> reg_val <span class="token operator">==</span> ERROR <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* Change bit(s) in ENABLE register */</span>
  enable <span class="token operator">=</span> enable <span class="token operator">&amp;</span> <span class="token number">0x01</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> mode <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> mode <span class="token operator">&lt;=</span> <span class="token number">6</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>enable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      reg_val <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      reg_val <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> mode <span class="token operator">==</span> ALL <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>enable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      reg_val <span class="token operator">=</span> <span class="token number">0x7F</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      reg_val <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* Write value back to ENABLE register */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireWriteDataByte</span><span class="token punctuation">(</span>APDS9930_ENABLE<span class="token punctuation">,</span> reg_val<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
   @brief Starts the light (Ambient/IR) sensor on the APDS-9930

   @param[in] interrupts true to enable hardware interrupt on high or low light
   @return True if sensor enabled correctly. False on error.
*/</span>
<span class="token keyword">bool</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">enableLightSensor</span><span class="token punctuation">(</span><span class="token keyword">bool</span> interrupts<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

  <span class="token comment">/* Set default gain, interrupts, enable power, and enable sensor */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">setAmbientLightGain</span><span class="token punctuation">(</span>DEFAULT_AGAIN<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> interrupts <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">setAmbientLightIntEnable</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">setAmbientLightIntEnable</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">enablePower</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">setMode</span><span class="token punctuation">(</span>AMBIENT_LIGHT<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token comment">/**
   @brief Ends the light sensor on the APDS-9930

   @return True if sensor disabled correctly. False on error.
*/</span>
<span class="token keyword">bool</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">disableLightSensor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">setAmbientLightIntEnable</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">setMode</span><span class="token punctuation">(</span>AMBIENT_LIGHT<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
   @brief Starts the proximity sensor on the APDS-9930

   @param[in] interrupts true to enable hardware external interrupt on proximity
   @return True if sensor enabled correctly. False on error.
*/</span>
<span class="token keyword">bool</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">enableProximitySensor</span><span class="token punctuation">(</span><span class="token keyword">bool</span> interrupts<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token comment">/* Set default gain, LED, interrupts, enable power, and enable sensor */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">setProximityGain</span><span class="token punctuation">(</span>DEFAULT_PGAIN<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">setLEDDrive</span><span class="token punctuation">(</span>DEFAULT_PDRIVE<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> interrupts <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">setProximityIntEnable</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">setProximityIntEnable</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">enablePower</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">setMode</span><span class="token punctuation">(</span>PROXIMITY<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
   @brief Ends the proximity sensor on the APDS-9930

   @return True if sensor disabled correctly. False on error.
*/</span>
<span class="token keyword">bool</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">disableProximitySensor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">setProximityIntEnable</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">setMode</span><span class="token punctuation">(</span>PROXIMITY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
   Turn the APDS-9930 on

   @return True if operation successful. False otherwise.
*/</span>
<span class="token keyword">bool</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">enablePower</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">setMode</span><span class="token punctuation">(</span>POWER<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
   Turn the APDS-9930 off

   @return True if operation successful. False otherwise.
*/</span>
<span class="token keyword">bool</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">disablePower</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">setMode</span><span class="token punctuation">(</span>POWER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*******************************************************************************
   Ambient light sensor controls
 ******************************************************************************/</span>

<span class="token comment">/**
   @brief Reads the ambient (clear) light level as a 16-bit value

   @param[out] val value of the light sensor.
   @return True if operation successful. False otherwise.
*/</span>
<span class="token keyword">bool</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">readAmbientLightLux</span><span class="token punctuation">(</span><span class="token keyword">float</span> <span class="token operator">&amp;</span>val<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">uint16_t</span> Ch0<span class="token punctuation">;</span>
  <span class="token keyword">uint16_t</span> Ch1<span class="token punctuation">;</span>

  <span class="token comment">/* Read value from channel 0 */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">readCh0Light</span><span class="token punctuation">(</span>Ch0<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* Read value from channel 1 */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">readCh1Light</span><span class="token punctuation">(</span>Ch1<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  val <span class="token operator">=</span> <span class="token function">floatAmbientToLux</span><span class="token punctuation">(</span>Ch0<span class="token punctuation">,</span> Ch1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">readAmbientLightLux</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>val<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">uint16_t</span> Ch0<span class="token punctuation">;</span>
  <span class="token keyword">uint16_t</span> Ch1<span class="token punctuation">;</span>

  <span class="token comment">/* Read value from channel 0 */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">readCh0Light</span><span class="token punctuation">(</span>Ch0<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* Read value from channel 1 */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">readCh1Light</span><span class="token punctuation">(</span>Ch1<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  val <span class="token operator">=</span> <span class="token function">ulongAmbientToLux</span><span class="token punctuation">(</span>Ch0<span class="token punctuation">,</span> Ch1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">float</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">floatAmbientToLux</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span> Ch0<span class="token punctuation">,</span> <span class="token keyword">uint16_t</span> Ch1<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">uint8_t</span> x<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">float</span> ALSIT <span class="token operator">=</span> <span class="token number">2.73</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">256</span> <span class="token operator">-</span> DEFAULT_ATIME<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">float</span> iac  <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>Ch0 <span class="token operator">-</span> ALS_B <span class="token operator">*</span> Ch1<span class="token punctuation">,</span> ALS_C <span class="token operator">*</span> Ch0 <span class="token operator">-</span> ALS_D <span class="token operator">*</span> Ch1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iac <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> iac <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">float</span> lpc  <span class="token operator">=</span> GA <span class="token operator">*</span> DF <span class="token operator">/</span> <span class="token punctuation">(</span>ALSIT <span class="token operator">*</span> x<span class="token punctuation">[</span><span class="token function">getAmbientLightGain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> iac <span class="token operator">*</span> lpc<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">ulongAmbientToLux</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span> Ch0<span class="token punctuation">,</span> <span class="token keyword">uint16_t</span> Ch1<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">uint8_t</span> x<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> ALSIT <span class="token operator">=</span> <span class="token number">2.73</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">256</span> <span class="token operator">-</span> DEFAULT_ATIME<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> iac  <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>Ch0 <span class="token operator">-</span> ALS_B <span class="token operator">*</span> Ch1<span class="token punctuation">,</span> ALS_C <span class="token operator">*</span> Ch0 <span class="token operator">-</span> ALS_D <span class="token operator">*</span> Ch1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iac <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> iac <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> lpc  <span class="token operator">=</span> GA <span class="token operator">*</span> DF <span class="token operator">/</span> <span class="token punctuation">(</span>ALSIT <span class="token operator">*</span> x<span class="token punctuation">[</span><span class="token function">getAmbientLightGain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> iac <span class="token operator">*</span> lpc<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">readCh0Light</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span> <span class="token operator">&amp;</span>val<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">uint8_t</span> val_byte<span class="token punctuation">;</span>
  val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment">/* Read value from channel 0 */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireReadDataByte</span><span class="token punctuation">(</span>APDS9930_Ch0DATAL<span class="token punctuation">,</span> val_byte<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  val <span class="token operator">=</span> val_byte<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireReadDataByte</span><span class="token punctuation">(</span>APDS9930_Ch0DATAH<span class="token punctuation">,</span> val_byte<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  val <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span><span class="token punctuation">)</span>val_byte <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">readCh1Light</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span> <span class="token operator">&amp;</span>val<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">uint8_t</span> val_byte<span class="token punctuation">;</span>
  val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment">/* Read value from channel 0 */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireReadDataByte</span><span class="token punctuation">(</span>APDS9930_Ch1DATAL<span class="token punctuation">,</span> val_byte<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  val <span class="token operator">=</span> val_byte<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireReadDataByte</span><span class="token punctuation">(</span>APDS9930_Ch1DATAH<span class="token punctuation">,</span> val_byte<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  val <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span><span class="token punctuation">)</span>val_byte <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*******************************************************************************
   Proximity sensor controls
 ******************************************************************************/</span>

<span class="token comment">/**
   @brief Reads the proximity level as an 8-bit value

   @param[out] val value of the proximity sensor.
   @return True if operation successful. False otherwise.
*/</span>
<span class="token keyword">bool</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">readProximity</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span> <span class="token operator">&amp;</span>val<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">uint8_t</span> val_byte<span class="token punctuation">;</span>

  <span class="token comment">/* Read value from proximity data register */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireReadDataByte</span><span class="token punctuation">(</span>APDS9930_PDATAL<span class="token punctuation">,</span> val_byte<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  val <span class="token operator">=</span> val_byte<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireReadDataByte</span><span class="token punctuation">(</span>APDS9930_PDATAH<span class="token punctuation">,</span> val_byte<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  val <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span><span class="token punctuation">)</span>val_byte <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*******************************************************************************
   Getters and setters for register values
 ******************************************************************************/</span>

<span class="token comment">/**
   @brief Returns the lower threshold for proximity detection

   @return lower threshold
*/</span>
<span class="token keyword">uint16_t</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">getProximityIntLowThreshold</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">uint16_t</span> val<span class="token punctuation">;</span>
  <span class="token keyword">uint8_t</span> val_byte<span class="token punctuation">;</span>

  <span class="token comment">/* Read value from PILT register */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireReadDataByte</span><span class="token punctuation">(</span>APDS9930_PILTL<span class="token punctuation">,</span> val_byte<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  val <span class="token operator">=</span> val_byte<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireReadDataByte</span><span class="token punctuation">(</span>APDS9930_PILTH<span class="token punctuation">,</span> val_byte<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  val <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span><span class="token punctuation">)</span>val_byte <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> val<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
   @brief Sets the lower threshold for proximity detection

   @param[in] threshold the lower proximity threshold
   @return True if operation successful. False otherwise.
*/</span>
<span class="token keyword">bool</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">setProximityIntLowThreshold</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span> threshold<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">uint8_t</span> lo<span class="token punctuation">;</span>
  <span class="token keyword">uint8_t</span> hi<span class="token punctuation">;</span>
  hi <span class="token operator">=</span> threshold <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">;</span>
  lo <span class="token operator">=</span> threshold <span class="token operator">&amp;</span> <span class="token number">0x00FF</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireWriteDataByte</span><span class="token punctuation">(</span>APDS9930_PILTL<span class="token punctuation">,</span> lo<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireWriteDataByte</span><span class="token punctuation">(</span>APDS9930_PILTH<span class="token punctuation">,</span> hi<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
   @brief Returns the high threshold for proximity detection

   @return high threshold
*/</span>
<span class="token keyword">uint16_t</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">getProximityIntHighThreshold</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">uint16_t</span> val<span class="token punctuation">;</span>
  <span class="token keyword">uint8_t</span> val_byte<span class="token punctuation">;</span>

  <span class="token comment">/* Read value from PILT register */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireReadDataByte</span><span class="token punctuation">(</span>APDS9930_PIHTL<span class="token punctuation">,</span> val_byte<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  val <span class="token operator">=</span> val_byte<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireReadDataByte</span><span class="token punctuation">(</span>APDS9930_PIHTH<span class="token punctuation">,</span> val_byte<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  val <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span><span class="token punctuation">)</span>val_byte <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> val<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
   @brief Sets the high threshold for proximity detection

   @param[in] threshold the high proximity threshold
   @return True if operation successful. False otherwise.
*/</span>
<span class="token keyword">bool</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">setProximityIntHighThreshold</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span> threshold<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">uint8_t</span> lo<span class="token punctuation">;</span>
  <span class="token keyword">uint8_t</span> hi<span class="token punctuation">;</span>
  hi <span class="token operator">=</span> threshold <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">;</span>
  lo <span class="token operator">=</span> threshold <span class="token operator">&amp;</span> <span class="token number">0x00FF</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireWriteDataByte</span><span class="token punctuation">(</span>APDS9930_PIHTL<span class="token punctuation">,</span> lo<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireWriteDataByte</span><span class="token punctuation">(</span>APDS9930_PIHTH<span class="token punctuation">,</span> hi<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
   @brief Returns LED drive strength for proximity and ALS

   Value    LED Current
     0        100 mA
     1         50 mA
     2         25 mA
     3         12.5 mA

   @return the value of the LED drive strength. 0xFF on failure.
*/</span>
<span class="token keyword">uint8_t</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">getLEDDrive</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">uint8_t</span> val<span class="token punctuation">;</span>

  <span class="token comment">/* Read value from CONTROL register */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireReadDataByte</span><span class="token punctuation">(</span>APDS9930_CONTROL<span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> ERROR<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* Shift and mask out LED drive bits */</span>
  val <span class="token operator">=</span> <span class="token punctuation">(</span>val <span class="token operator">&gt;&gt;</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0b00000011</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> val<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
   @brief Sets the LED drive strength for proximity and ALS

   Value    LED Current
     0        100 mA
     1         50 mA
     2         25 mA
     3         12.5 mA

   @param[in] drive the value (0-3) for the LED drive strength
   @return True if operation successful. False otherwise.
*/</span>
<span class="token keyword">bool</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">setLEDDrive</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span> drive<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">uint8_t</span> val<span class="token punctuation">;</span>

  <span class="token comment">/* Read value from CONTROL register */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireReadDataByte</span><span class="token punctuation">(</span>APDS9930_CONTROL<span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* Set bits in register to given value */</span>
  drive <span class="token operator">&amp;=</span> <span class="token number">0b00000011</span><span class="token punctuation">;</span>
  drive <span class="token operator">=</span> drive <span class="token operator">&lt;&lt;</span> <span class="token number">6</span><span class="token punctuation">;</span>
  val <span class="token operator">&amp;=</span> <span class="token number">0b00111111</span><span class="token punctuation">;</span>
  val <span class="token operator">|=</span> drive<span class="token punctuation">;</span>

  <span class="token comment">/* Write register value back into CONTROL register */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireWriteDataByte</span><span class="token punctuation">(</span>APDS9930_CONTROL<span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
   @brief Returns receiver gain for proximity detection

   Value    Gain
     0       1x
     1       2x
     2       4x
     3       8x

   @return the value of the proximity gain. 0xFF on failure.
*/</span>
<span class="token keyword">uint8_t</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">getProximityGain</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">uint8_t</span> val<span class="token punctuation">;</span>

  <span class="token comment">/* Read value from CONTROL register */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireReadDataByte</span><span class="token punctuation">(</span>APDS9930_CONTROL<span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> ERROR<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* Shift and mask out PDRIVE bits */</span>
  val <span class="token operator">=</span> <span class="token punctuation">(</span>val <span class="token operator">&gt;&gt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0b00000011</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> val<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
   @brief Sets the receiver gain for proximity detection

   Value    Gain
     0       1x
     1       2x
     2       4x
     3       8x

   @param[in] drive the value (0-3) for the gain
   @return True if operation successful. False otherwise.
*/</span>
<span class="token keyword">bool</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">setProximityGain</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span> drive<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">uint8_t</span> val<span class="token punctuation">;</span>

  <span class="token comment">/* Read value from CONTROL register */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireReadDataByte</span><span class="token punctuation">(</span>APDS9930_CONTROL<span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* Set bits in register to given value */</span>
  drive <span class="token operator">&amp;=</span> <span class="token number">0b00000011</span><span class="token punctuation">;</span>
  drive <span class="token operator">=</span> drive <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span>
  val <span class="token operator">&amp;=</span> <span class="token number">0b11110011</span><span class="token punctuation">;</span>
  val <span class="token operator">|=</span> drive<span class="token punctuation">;</span>

  <span class="token comment">/* Write register value back into CONTROL register */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireWriteDataByte</span><span class="token punctuation">(</span>APDS9930_CONTROL<span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
   @brief Returns the proximity diode

   Value    Diode selection
     0       Reserved
     1       Reserved
     2       Use Ch1 diode
     3       Reserved

   @return the selected diode. 0xFF on failure.
*/</span>
<span class="token keyword">uint8_t</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">getProximityDiode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">uint8_t</span> val<span class="token punctuation">;</span>

  <span class="token comment">/* Read value from CONTROL register */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireReadDataByte</span><span class="token punctuation">(</span>APDS9930_CONTROL<span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> ERROR<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* Shift and mask out PDRIVE bits */</span>
  val <span class="token operator">=</span> <span class="token punctuation">(</span>val <span class="token operator">&gt;&gt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0b00000011</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> val<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
   @brief Selects the proximity diode

   Value    Diode selection
     0       Reserved
     1       Reserved
     2       Use Ch1 diode
     3       Reserved

   @param[in] drive the value (0-3) for the diode
   @return True if operation successful. False otherwise.
*/</span>
<span class="token keyword">bool</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">setProximityDiode</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span> drive<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">uint8_t</span> val<span class="token punctuation">;</span>

  <span class="token comment">/* Read value from CONTROL register */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireReadDataByte</span><span class="token punctuation">(</span>APDS9930_CONTROL<span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* Set bits in register to given value */</span>
  drive <span class="token operator">&amp;=</span> <span class="token number">0b00000011</span><span class="token punctuation">;</span>
  drive <span class="token operator">=</span> drive <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span>
  val <span class="token operator">&amp;=</span> <span class="token number">0b11001111</span><span class="token punctuation">;</span>
  val <span class="token operator">|=</span> drive<span class="token punctuation">;</span>

  <span class="token comment">/* Write register value back into CONTROL register */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireWriteDataByte</span><span class="token punctuation">(</span>APDS9930_CONTROL<span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
   @brief Returns receiver gain for the ambient light sensor (ALS)

   Value    Gain
     0        1x
     1        4x
     2       16x
     3      120x

   @return the value of the ALS gain. 0xFF on failure.
*/</span>
<span class="token keyword">uint8_t</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">getAmbientLightGain</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">uint8_t</span> val<span class="token punctuation">;</span>

  <span class="token comment">/* Read value from CONTROL register */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireReadDataByte</span><span class="token punctuation">(</span>APDS9930_CONTROL<span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> ERROR<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* Shift and mask out ADRIVE bits */</span>
  val <span class="token operator">&amp;=</span> <span class="token number">0b00000011</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> val<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
   @brief Sets the receiver gain for the ambient light sensor (ALS)

   Value    Gain
     0        1x
     1        4x
     2       16x
     3       64x

   @param[in] drive the value (0-3) for the gain
   @return True if operation successful. False otherwise.
*/</span>
<span class="token keyword">bool</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">setAmbientLightGain</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span> drive<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">uint8_t</span> val<span class="token punctuation">;</span>

  <span class="token comment">/* Read value from CONTROL register */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireReadDataByte</span><span class="token punctuation">(</span>APDS9930_CONTROL<span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* Set bits in register to given value */</span>
  drive <span class="token operator">&amp;=</span> <span class="token number">0b00000011</span><span class="token punctuation">;</span>
  val <span class="token operator">&amp;=</span> <span class="token number">0b11111100</span><span class="token punctuation">;</span>
  val <span class="token operator">|=</span> drive<span class="token punctuation">;</span>

  <span class="token comment">/* Write register value back into CONTROL register */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireWriteDataByte</span><span class="token punctuation">(</span>APDS9930_CONTROL<span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
   @brief Gets the low threshold for ambient light interrupts

   @param[out] threshold current low threshold stored on the APDS-9930
   @return True if operation successful. False otherwise.
*/</span>
<span class="token keyword">bool</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">getLightIntLowThreshold</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span> <span class="token operator">&amp;</span>threshold<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">uint8_t</span> val_byte<span class="token punctuation">;</span>
  threshold <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment">/* Read value from ambient light low threshold, low byte register */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireReadDataByte</span><span class="token punctuation">(</span>APDS9930_AILTL<span class="token punctuation">,</span> val_byte<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  threshold <span class="token operator">=</span> val_byte<span class="token punctuation">;</span>

  <span class="token comment">/* Read value from ambient light low threshold, high byte register */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireReadDataByte</span><span class="token punctuation">(</span>APDS9930_AILTH<span class="token punctuation">,</span> val_byte<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  threshold <span class="token operator">=</span> threshold <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span><span class="token punctuation">)</span>val_byte <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
   @brief Sets the low threshold for ambient light interrupts

   @param[in] threshold low threshold value for interrupt to trigger
   @return True if operation successful. False otherwise.
*/</span>
<span class="token keyword">bool</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">setLightIntLowThreshold</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span> threshold<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">uint8_t</span> val_low<span class="token punctuation">;</span>
  <span class="token keyword">uint8_t</span> val_high<span class="token punctuation">;</span>

  <span class="token comment">/* Break 16-bit threshold into 2 8-bit values */</span>
  val_low <span class="token operator">=</span> threshold <span class="token operator">&amp;</span> <span class="token number">0x00FF</span><span class="token punctuation">;</span>
  val_high <span class="token operator">=</span> <span class="token punctuation">(</span>threshold <span class="token operator">&amp;</span> <span class="token number">0xFF00</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">;</span>

  <span class="token comment">/* Write low byte */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireWriteDataByte</span><span class="token punctuation">(</span>APDS9930_AILTL<span class="token punctuation">,</span> val_low<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* Write high byte */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireWriteDataByte</span><span class="token punctuation">(</span>APDS9930_AILTH<span class="token punctuation">,</span> val_high<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
   @brief Gets the high threshold for ambient light interrupts

   @param[out] threshold current low threshold stored on the APDS-9930
   @return True if operation successful. False otherwise.
*/</span>
<span class="token keyword">bool</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">getLightIntHighThreshold</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span> <span class="token operator">&amp;</span>threshold<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">uint8_t</span> val_byte<span class="token punctuation">;</span>
  threshold <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment">/* Read value from ambient light high threshold, low byte register */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireReadDataByte</span><span class="token punctuation">(</span>APDS9930_AIHTL<span class="token punctuation">,</span> val_byte<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  threshold <span class="token operator">=</span> val_byte<span class="token punctuation">;</span>

  <span class="token comment">/* Read value from ambient light high threshold, high byte register */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireReadDataByte</span><span class="token punctuation">(</span>APDS9930_AIHTH<span class="token punctuation">,</span> val_byte<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  threshold <span class="token operator">=</span> threshold <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span><span class="token punctuation">)</span>val_byte <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
   @brief Sets the high threshold for ambient light interrupts

   @param[in] threshold high threshold value for interrupt to trigger
   @return True if operation successful. False otherwise.
*/</span>
<span class="token keyword">bool</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">setLightIntHighThreshold</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span> threshold<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">uint8_t</span> val_low<span class="token punctuation">;</span>
  <span class="token keyword">uint8_t</span> val_high<span class="token punctuation">;</span>

  <span class="token comment">/* Break 16-bit threshold into 2 8-bit values */</span>
  val_low <span class="token operator">=</span> threshold <span class="token operator">&amp;</span> <span class="token number">0x00FF</span><span class="token punctuation">;</span>
  val_high <span class="token operator">=</span> <span class="token punctuation">(</span>threshold <span class="token operator">&amp;</span> <span class="token number">0xFF00</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">;</span>

  <span class="token comment">/* Write low byte */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireWriteDataByte</span><span class="token punctuation">(</span>APDS9930_AIHTL<span class="token punctuation">,</span> val_low<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* Write high byte */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireWriteDataByte</span><span class="token punctuation">(</span>APDS9930_AIHTH<span class="token punctuation">,</span> val_high<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/**
   @brief Gets if ambient light interrupts are enabled or not

   @return 1 if interrupts are enabled, 0 if not. 0xFF on error.
*/</span>
<span class="token keyword">uint8_t</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">getAmbientLightIntEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">uint8_t</span> val<span class="token punctuation">;</span>

  <span class="token comment">/* Read value from ENABLE register */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireReadDataByte</span><span class="token punctuation">(</span>APDS9930_ENABLE<span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> ERROR<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* Shift and mask out AIEN bit */</span>
  val <span class="token operator">=</span> <span class="token punctuation">(</span>val <span class="token operator">&gt;&gt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0b00000001</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> val<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
   @brief Turns ambient light interrupts on or off

   @param[in] enable 1 to enable interrupts, 0 to turn them off
   @return True if operation successful. False otherwise.
*/</span>
<span class="token keyword">bool</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">setAmbientLightIntEnable</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span> enable<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">uint8_t</span> val<span class="token punctuation">;</span>

  <span class="token comment">/* Read value from ENABLE register */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireReadDataByte</span><span class="token punctuation">(</span>APDS9930_ENABLE<span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* Set bits in register to given value */</span>
  enable <span class="token operator">&amp;=</span> <span class="token number">0b00000001</span><span class="token punctuation">;</span>
  enable <span class="token operator">=</span> enable <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span>
  val <span class="token operator">&amp;=</span> <span class="token number">0b11101111</span><span class="token punctuation">;</span>
  val <span class="token operator">|=</span> enable<span class="token punctuation">;</span>

  <span class="token comment">/* Write register value back into ENABLE register */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireWriteDataByte</span><span class="token punctuation">(</span>APDS9930_ENABLE<span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
   @brief Gets if proximity interrupts are enabled or not

   @return 1 if interrupts are enabled, 0 if not. 0xFF on error.
*/</span>
<span class="token keyword">uint8_t</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">getProximityIntEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">uint8_t</span> val<span class="token punctuation">;</span>

  <span class="token comment">/* Read value from ENABLE register */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireReadDataByte</span><span class="token punctuation">(</span>APDS9930_ENABLE<span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> ERROR<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* Shift and mask out PIEN bit */</span>
  val <span class="token operator">=</span> <span class="token punctuation">(</span>val <span class="token operator">&gt;&gt;</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0b00000001</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> val<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
   @brief Turns proximity interrupts on or off

   @param[in] enable 1 to enable interrupts, 0 to turn them off
   @return True if operation successful. False otherwise.
*/</span>
<span class="token keyword">bool</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">setProximityIntEnable</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span> enable<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">uint8_t</span> val<span class="token punctuation">;</span>

  <span class="token comment">/* Read value from ENABLE register */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireReadDataByte</span><span class="token punctuation">(</span>APDS9930_ENABLE<span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* Set bits in register to given value */</span>
  enable <span class="token operator">&amp;=</span> <span class="token number">0b00000001</span><span class="token punctuation">;</span>
  enable <span class="token operator">=</span> enable <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span>
  val <span class="token operator">&amp;=</span> <span class="token number">0b11011111</span><span class="token punctuation">;</span>
  val <span class="token operator">|=</span> enable<span class="token punctuation">;</span>

  <span class="token comment">/* Write register value back into ENABLE register */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireWriteDataByte</span><span class="token punctuation">(</span>APDS9930_ENABLE<span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
   @brief Clears the ambient light interrupt

   @return True if operation completed successfully. False otherwise.
*/</span>
<span class="token keyword">bool</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">clearAmbientLightInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireWriteByte</span><span class="token punctuation">(</span>CLEAR_ALS_INT<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
   @brief Clears the proximity interrupt

   @return True if operation completed successfully. False otherwise.
*/</span>
<span class="token keyword">bool</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">clearProximityInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireWriteByte</span><span class="token punctuation">(</span>CLEAR_PROX_INT<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
   @brief Clears all interrupts

   @return True if operation completed successfully. False otherwise.
*/</span>
<span class="token keyword">bool</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">clearAllInts</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">wireWriteByte</span><span class="token punctuation">(</span>CLEAR_ALL_INTS<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*******************************************************************************
   Raw I2C Reads and Writes
 ******************************************************************************/</span>

<span class="token comment">/**
   @brief Writes a single byte to the I2C device (no register)

   @param[in] val the 1-byte value to write to the I2C device
   @return True if successful write operation. False otherwise.
*/</span>
<span class="token keyword">bool</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">wireWriteByte</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span> val<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  Wire<span class="token punctuation">.</span><span class="token function">beginTransmission</span><span class="token punctuation">(</span>APDS9930_I2C_ADDR<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Wire<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> Wire<span class="token punctuation">.</span><span class="token function">endTransmission</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
   @brief Writes a single byte to the I2C device and specified register

   @param[in] reg the register in the I2C device to write to
   @param[in] val the 1-byte value to write to the I2C device
   @return True if successful write operation. False otherwise.
*/</span>
<span class="token keyword">bool</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">wireWriteDataByte</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span> reg<span class="token punctuation">,</span> <span class="token keyword">uint8_t</span> val<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  Wire<span class="token punctuation">.</span><span class="token function">beginTransmission</span><span class="token punctuation">(</span>APDS9930_I2C_ADDR<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Wire<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>reg <span class="token operator">|</span> AUTO_INCREMENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Wire<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> Wire<span class="token punctuation">.</span><span class="token function">endTransmission</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
   @brief Writes a block (array) of bytes to the I2C device and register

   @param[in] reg the register in the I2C device to write to
   @param[in] val pointer to the beginning of the data byte array
   @param[in] len the length (in bytes) of the data to write
   @return True if successful write operation. False otherwise.
*/</span>
<span class="token keyword">bool</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">wireWriteDataBlock</span><span class="token punctuation">(</span>  <span class="token keyword">uint8_t</span> reg<span class="token punctuation">,</span>
                                    <span class="token keyword">uint8_t</span> <span class="token operator">*</span>val<span class="token punctuation">,</span>
                                    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span>

  Wire<span class="token punctuation">.</span><span class="token function">beginTransmission</span><span class="token punctuation">(</span>APDS9930_I2C_ADDR<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Wire<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>reg <span class="token operator">|</span> AUTO_INCREMENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Wire<span class="token punctuation">.</span><span class="token function">beginTransmission</span><span class="token punctuation">(</span>APDS9930_I2C_ADDR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Wire<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>val<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> Wire<span class="token punctuation">.</span><span class="token function">endTransmission</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
   @brief Reads a single byte from the I2C device and specified register

   @param[in] reg the register to read from
   @param[out] the value returned from the register
   @return True if successful read operation. False otherwise.
*/</span>
<span class="token keyword">bool</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">wireReadDataByte</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span> reg<span class="token punctuation">,</span> <span class="token keyword">uint8_t</span> <span class="token operator">&amp;</span>val<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

  <span class="token comment">/* Indicate which register we want to read from */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">wireWriteByte</span><span class="token punctuation">(</span>reg <span class="token operator">|</span> AUTO_INCREMENT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* Read from register */</span>
  Wire<span class="token punctuation">.</span><span class="token function">requestFrom</span><span class="token punctuation">(</span>APDS9930_I2C_ADDR<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>Wire<span class="token punctuation">.</span><span class="token function">available</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    val <span class="token operator">=</span> Wire<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/**
   @brief Reads a block (array) of bytes from the I2C device and register

   @param[in] reg the register to read from
   @param[out] val pointer to the beginning of the data
   @param[in] len number of bytes to read
   @return Number of bytes read. -1 on read error.
*/</span>
<span class="token keyword">int</span> <span class="token class-name">APDS9930</span><span class="token operator">::</span><span class="token function">wireReadDataBlock</span><span class="token punctuation">(</span>   <span class="token keyword">uint8_t</span> reg<span class="token punctuation">,</span>
                                   <span class="token keyword">uint8_t</span> <span class="token operator">*</span>val<span class="token punctuation">,</span>
                                   <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment">/* Indicate which register we want to read from */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">wireWriteByte</span><span class="token punctuation">(</span>reg <span class="token operator">|</span> AUTO_INCREMENT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* Read block data */</span>
  Wire<span class="token punctuation">.</span><span class="token function">requestFrom</span><span class="token punctuation">(</span>APDS9930_I2C_ADDR<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>Wire<span class="token punctuation">.</span><span class="token function">available</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> len<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    val<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> Wire<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    i<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> i<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="APDS9930h_1196"></a>APDS9930.h</h4> 
<pre><code class="prism language-cpp"><span class="token comment">/**
   @file    APDS-9930.h
   @brief   Library for the SparkFun APDS-9930 breakout board
   @author  Shawn Hymel (SparkFun Electronics)

   @copyright	This code is public domain but you buy me a beer if you use
   this and we meet someday (Beerware license).

   This library interfaces the Avago APDS-9930 to Arduino over I2C. The library
   relies on the Arduino Wire (I2C) library. to use the library, instantiate an
   APDS9930 object, call init(), and call the appropriate functions.
*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">APDS9930_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APDS9930_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Arduino.h&gt;</span></span>

<span class="token comment">/* Debug */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEBUG</span>                   <span class="token expression"><span class="token number">0</span></span></span>

<span class="token comment">/* APDS-9930 I2C address */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APDS9930_I2C_ADDR</span>       <span class="token expression"><span class="token number">0x39</span></span></span>

<span class="token comment">/* Command register modes */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">REPEATED_BYTE</span>           <span class="token expression"><span class="token number">0x80</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AUTO_INCREMENT</span>          <span class="token expression"><span class="token number">0xA0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SPECIAL_FN</span>              <span class="token expression"><span class="token number">0xE0</span></span></span>

<span class="token comment">/* Error code for returned values */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ERROR</span>                   <span class="token expression"><span class="token number">0xFF</span></span></span>

<span class="token comment">/* Acceptable device IDs */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APDS9930_ID_1</span>           <span class="token expression"><span class="token number">0x12</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APDS9930_ID_2</span>           <span class="token expression"><span class="token number">0x39</span></span></span>

<span class="token comment">/* Misc parameters */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FIFO_PAUSE_TIME</span>         <span class="token expression"><span class="token number">30</span>      </span><span class="token comment">// Wait period (ms) between FIFO reads</span></span>

<span class="token comment">/* APDS-9930 register addresses */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APDS9930_ENABLE</span>         <span class="token expression"><span class="token number">0x00</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APDS9930_ATIME</span>          <span class="token expression"><span class="token number">0x01</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APDS9930_PTIME</span>          <span class="token expression"><span class="token number">0x02</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APDS9930_WTIME</span>          <span class="token expression"><span class="token number">0x03</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APDS9930_AILTL</span>          <span class="token expression"><span class="token number">0x04</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APDS9930_AILTH</span>          <span class="token expression"><span class="token number">0x05</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APDS9930_AIHTL</span>          <span class="token expression"><span class="token number">0x06</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APDS9930_AIHTH</span>          <span class="token expression"><span class="token number">0x07</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APDS9930_PILTL</span>          <span class="token expression"><span class="token number">0x08</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APDS9930_PILTH</span>          <span class="token expression"><span class="token number">0x09</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APDS9930_PIHTL</span>          <span class="token expression"><span class="token number">0x0A</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APDS9930_PIHTH</span>          <span class="token expression"><span class="token number">0x0B</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APDS9930_PERS</span>           <span class="token expression"><span class="token number">0x0C</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APDS9930_CONFIG</span>         <span class="token expression"><span class="token number">0x0D</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APDS9930_PPULSE</span>         <span class="token expression"><span class="token number">0x0E</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APDS9930_CONTROL</span>        <span class="token expression"><span class="token number">0x0F</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APDS9930_ID</span>             <span class="token expression"><span class="token number">0x12</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APDS9930_STATUS</span>         <span class="token expression"><span class="token number">0x13</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APDS9930_Ch0DATAL</span>       <span class="token expression"><span class="token number">0x14</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APDS9930_Ch0DATAH</span>       <span class="token expression"><span class="token number">0x15</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APDS9930_Ch1DATAL</span>       <span class="token expression"><span class="token number">0x16</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APDS9930_Ch1DATAH</span>       <span class="token expression"><span class="token number">0x17</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APDS9930_PDATAL</span>         <span class="token expression"><span class="token number">0x18</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APDS9930_PDATAH</span>         <span class="token expression"><span class="token number">0x19</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APDS9930_POFFSET</span>        <span class="token expression"><span class="token number">0x1E</span></span></span>


<span class="token comment">/* Bit fields */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APDS9930_PON</span>            <span class="token expression"><span class="token number">0b00000001</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APDS9930_AEN</span>            <span class="token expression"><span class="token number">0b00000010</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APDS9930_PEN</span>            <span class="token expression"><span class="token number">0b00000100</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APDS9930_WEN</span>            <span class="token expression"><span class="token number">0b00001000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APSD9930_AIEN</span>           <span class="token expression"><span class="token number">0b00010000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APDS9930_PIEN</span>           <span class="token expression"><span class="token number">0b00100000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APDS9930_SAI</span>            <span class="token expression"><span class="token number">0b01000000</span></span></span>

<span class="token comment">/* On/Off definitions */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OFF</span>                     <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ON</span>                      <span class="token expression"><span class="token number">1</span></span></span>

<span class="token comment">/* Acceptable parameters for setMode */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">POWER</span>                   <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AMBIENT_LIGHT</span>           <span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PROXIMITY</span>               <span class="token expression"><span class="token number">2</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">WAIT</span>                    <span class="token expression"><span class="token number">3</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AMBIENT_LIGHT_INT</span>       <span class="token expression"><span class="token number">4</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PROXIMITY_INT</span>           <span class="token expression"><span class="token number">5</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SLEEP_AFTER_INT</span>         <span class="token expression"><span class="token number">6</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ALL</span>                     <span class="token expression"><span class="token number">7</span></span></span>

<span class="token comment">/* LED Drive values */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LED_DRIVE_100MA</span>         <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LED_DRIVE_50MA</span>          <span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LED_DRIVE_25MA</span>          <span class="token expression"><span class="token number">2</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LED_DRIVE_12_5MA</span>        <span class="token expression"><span class="token number">3</span></span></span>

<span class="token comment">/* Proximity Gain (PGAIN) values */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PGAIN_1X</span>                <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PGAIN_2X</span>                <span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PGAIN_4X</span>                <span class="token expression"><span class="token number">2</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PGAIN_8X</span>                <span class="token expression"><span class="token number">3</span></span></span>

<span class="token comment">/* ALS Gain (AGAIN) values */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AGAIN_1X</span>                <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AGAIN_8X</span>                <span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AGAIN_16X</span>               <span class="token expression"><span class="token number">2</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AGAIN_120X</span>              <span class="token expression"><span class="token number">3</span></span></span>

<span class="token comment">/* Interrupt clear values */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CLEAR_PROX_INT</span>          <span class="token expression"><span class="token number">0xE5</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CLEAR_ALS_INT</span>           <span class="token expression"><span class="token number">0xE6</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CLEAR_ALL_INTS</span>          <span class="token expression"><span class="token number">0xE7</span></span></span>

<span class="token comment">/* Default values */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEFAULT_ATIME</span>           <span class="token expression"><span class="token number">0xED</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEFAULT_WTIME</span>           <span class="token expression"><span class="token number">0xFF</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEFAULT_PTIME</span>           <span class="token expression"><span class="token number">0xFF</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEFAULT_PPULSE</span>          <span class="token expression"><span class="token number">0x08</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEFAULT_POFFSET</span>         <span class="token expression"><span class="token number">0</span>       </span><span class="token comment">// 0 offset</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEFAULT_CONFIG</span>          <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEFAULT_PDRIVE</span>          <span class="token expression">LED_DRIVE_100MA</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEFAULT_PDIODE</span>          <span class="token expression"><span class="token number">2</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEFAULT_PGAIN</span>           <span class="token expression">PGAIN_8X</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEFAULT_AGAIN</span>           <span class="token expression">AGAIN_1X</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEFAULT_PILT</span>            <span class="token expression"><span class="token number">0</span>       </span><span class="token comment">// Low proximity threshold</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEFAULT_PIHT</span>            <span class="token expression"><span class="token number">50</span>      </span><span class="token comment">// High proximity threshold</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEFAULT_AILT</span>            <span class="token expression"><span class="token number">0xFFFF</span>  </span><span class="token comment">// Force interrupt for calibration</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEFAULT_AIHT</span>            <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEFAULT_PERS</span>            <span class="token expression"><span class="token number">0x22</span>    </span><span class="token comment">// 2 consecutive prox or ALS for int.</span></span>

<span class="token comment">/* ALS coefficients */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DF</span>                      <span class="token expression"><span class="token number">52</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GA</span>                      <span class="token expression"><span class="token number">0.49</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ALS_B</span>                       <span class="token expression"><span class="token number">1.862</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ALS_C</span>                       <span class="token expression"><span class="token number">0.746</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ALS_D</span>                       <span class="token expression"><span class="token number">1.291</span></span></span>

<span class="token comment">/* State definitions */</span>
<span class="token keyword">enum</span> <span class="token punctuation">{<!-- --></span>
  NOTAVAILABLE_STATE<span class="token punctuation">,</span>
  NEAR_STATE<span class="token punctuation">,</span>
  FAR_STATE<span class="token punctuation">,</span>
  ALL_STATE
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_AVR_IO_H_</span></span>
<span class="token comment">// Do not use this alias as it's deprecated</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NA_STATE</span> <span class="token expression">NOTAVAILABLE_STATE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/* APDS9930 Class */</span>
<span class="token keyword">class</span> <span class="token class-name">APDS9930</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">public</span><span class="token operator">:</span>

    <span class="token comment">/* Initialization methods */</span>
    <span class="token function">APDS9930</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">~</span><span class="token function">APDS9930</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">uint8_t</span> <span class="token function">getMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">setMode</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span> mode<span class="token punctuation">,</span> <span class="token keyword">uint8_t</span> enable<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Turn the APDS-9930 on and off */</span>
    <span class="token keyword">bool</span> <span class="token function">enablePower</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">disablePower</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Enable or disable specific sensors */</span>
    <span class="token keyword">bool</span> <span class="token function">enableLightSensor</span><span class="token punctuation">(</span><span class="token keyword">bool</span> interrupts <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">disableLightSensor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">enableProximitySensor</span><span class="token punctuation">(</span><span class="token keyword">bool</span> interrupts <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">disableProximitySensor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* LED drive strength control */</span>
    <span class="token keyword">uint8_t</span> <span class="token function">getLEDDrive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">setLEDDrive</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span> drive<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// uint8_t getGestureLEDDrive();</span>
    <span class="token comment">// bool setGestureLEDDrive(uint8_t drive);</span>

    <span class="token comment">/* Gain control */</span>
    <span class="token keyword">uint8_t</span> <span class="token function">getAmbientLightGain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">setAmbientLightGain</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span> gain<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">uint8_t</span> <span class="token function">getProximityGain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">setProximityGain</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span> gain<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">setProximityDiode</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span> drive<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">uint8_t</span> <span class="token function">getProximityDiode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">/* Get and set light interrupt thresholds */</span>
    <span class="token keyword">bool</span> <span class="token function">getLightIntLowThreshold</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span> <span class="token operator">&amp;</span>threshold<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">setLightIntLowThreshold</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span> threshold<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">getLightIntHighThreshold</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span> <span class="token operator">&amp;</span>threshold<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">setLightIntHighThreshold</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span> threshold<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Get and set interrupt enables */</span>
    <span class="token keyword">uint8_t</span> <span class="token function">getAmbientLightIntEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">setAmbientLightIntEnable</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span> enable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">uint8_t</span> <span class="token function">getProximityIntEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">setProximityIntEnable</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span> enable<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Clear interrupts */</span>
    <span class="token keyword">bool</span> <span class="token function">clearAmbientLightInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">clearProximityInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">clearAllInts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Proximity methods */</span>
    <span class="token keyword">bool</span> <span class="token function">readProximity</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span> <span class="token operator">&amp;</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Ambient light methods */</span>
    <span class="token keyword">bool</span> <span class="token function">readAmbientLightLux</span><span class="token punctuation">(</span><span class="token keyword">float</span> <span class="token operator">&amp;</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">readAmbientLightLux</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">&amp;</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> <span class="token function">floatAmbientToLux</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span> Ch0<span class="token punctuation">,</span> <span class="token keyword">uint16_t</span> Ch1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token function">ulongAmbientToLux</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span> Ch0<span class="token punctuation">,</span> <span class="token keyword">uint16_t</span> Ch1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">readCh0Light</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span> <span class="token operator">&amp;</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">readCh1Light</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span> <span class="token operator">&amp;</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//private:</span>

    <span class="token comment">/* Proximity Interrupt Threshold */</span>
    <span class="token keyword">uint16_t</span> <span class="token function">getProximityIntLowThreshold</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">setProximityIntLowThreshold</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span> threshold<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">uint16_t</span> <span class="token function">getProximityIntHighThreshold</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">setProximityIntHighThreshold</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span> threshold<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Raw I2C Commands */</span>
    <span class="token keyword">bool</span> <span class="token function">wireWriteByte</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">wireWriteDataByte</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span> reg<span class="token punctuation">,</span> <span class="token keyword">uint8_t</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">wireWriteDataBlock</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span> reg<span class="token punctuation">,</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span>val<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">wireReadDataByte</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span> reg<span class="token punctuation">,</span> <span class="token keyword">uint8_t</span> <span class="token operator">&amp;</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token function">wireReadDataBlock</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span> reg<span class="token punctuation">,</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span>val<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> 
<h3><a id="110cm_1431"></a>1、靠近亮灯、距离保持约10cm常亮，远离延时熄灭</h3> 
<p><strong>ProximityInterrupt.ino</strong></p> 
<pre><code class="prism language-c"><span class="token comment">/****************************************************************
ProximityInterrupt.ino
APDS-9930 Ambient light and proximity sensor
Davide Depau
December 11, 2015
https://github.com/Davideddu/APDS9930

Shawn Hymel @ SparkFun Electronics
October 24, 2014
https://github.com/sparkfun/APDS-9930_RGB_and_Gesture_Sensor

Tests the proximity interrupt abilities of the APDS-9930.
Configures the APDS-9930 over I2C and waits for an external
interrupt based on high or low proximity conditions. Move your
hand near the sensor and watch the LED on pin 13.

Hardware Connections:

IMPORTANT: The APDS-9930 can only accept 3.3V!
 
 Arduino Pin  APDS-9930 Board  Function
 
 3.3V         VCC              Power
 GND          GND              Ground
 A4           SDA              I2C Data
 A5           SCL              I2C Clock
 2            INT              Interrupt
 10           -                LED

Resources:
Include Wire.h and APDS9930.h

Development environment specifics:
Written in Arduino 1.6.5
Tested with Arduino Uno and Mega

This code is beerware; if you see me (or any other SparkFun 
employee) at the local, and you've found our code helpful, please
buy us a round!

Distributed as-is; no warranty is given.
****************************************************************/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DUMP_REGS</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Wire.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"APDS9930.h"</span></span>

<span class="token comment">// Pins</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APDS9930_INT</span>    <span class="token expression"><span class="token number">2</span>  </span><span class="token comment">// Needs to be an interrupt pin</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LED_PIN</span>         <span class="token expression"><span class="token number">10</span> </span><span class="token comment">// LED for showing interrupt</span></span>

<span class="token comment">// Constants</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PROX_INT_HIGH</span>   <span class="token expression"><span class="token number">600</span> </span><span class="token comment">// Proximity level for interrupt</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PROX_INT_LOW</span>    <span class="token expression"><span class="token number">0</span>  </span><span class="token comment">// No far interrupt</span></span>

<span class="token comment">// 亮灯延时</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LIGHT_TIME</span> <span class="token expression"><span class="token number">5000</span></span></span>

<span class="token comment">// Global variables</span>
APDS9930 apds <span class="token operator">=</span> <span class="token function">APDS9930</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">uint16_t</span> proximity_data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">volatile</span> bool isr_flag <span class="token operator">=</span> false<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// Set LED as output</span>
  <span class="token function">pinMode</span><span class="token punctuation">(</span>LED_PIN<span class="token punctuation">,</span> OUTPUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">pinMode</span><span class="token punctuation">(</span>APDS9930_INT<span class="token punctuation">,</span> INPUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// Initialize Serial port</span>
  Serial<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token number">9600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">F</span><span class="token punctuation">(</span><span class="token string">"------------------------------"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">F</span><span class="token punctuation">(</span><span class="token string">"APDS-9930 - ProximityInterrupt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">F</span><span class="token punctuation">(</span><span class="token string">"------------------------------"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// Initialize interrupt service routine</span>
  <span class="token function">attachInterrupt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> interruptRoutine<span class="token punctuation">,</span> FALLING<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// Initialize APDS-9930 (configure I2C and initial values)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> apds<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">F</span><span class="token punctuation">(</span><span class="token string">"APDS-9930 initialization complete"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">F</span><span class="token punctuation">(</span><span class="token string">"Something went wrong during APDS-9930 init!"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// Adjust the Proximity sensor gain</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>apds<span class="token punctuation">.</span><span class="token function">setProximityGain</span><span class="token punctuation">(</span>PGAIN_2X<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">F</span><span class="token punctuation">(</span><span class="token string">"Something went wrong trying to set PGAIN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// Set proximity interrupt thresholds</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>apds<span class="token punctuation">.</span><span class="token function">setProximityIntLowThreshold</span><span class="token punctuation">(</span>PROX_INT_LOW<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">F</span><span class="token punctuation">(</span><span class="token string">"Error writing low threshold"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>apds<span class="token punctuation">.</span><span class="token function">setProximityIntHighThreshold</span><span class="token punctuation">(</span>PROX_INT_HIGH<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">F</span><span class="token punctuation">(</span><span class="token string">"Error writing high threshold"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// Start running the APDS-9930 proximity sensor (interrupts)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> apds<span class="token punctuation">.</span><span class="token function">enableProximitySensor</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">F</span><span class="token punctuation">(</span><span class="token string">"Proximity sensor is now running"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">F</span><span class="token punctuation">(</span><span class="token string">"Something went wrong during sensor init!"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">DUMP_REGS</span></span>
  <span class="token comment">/* Register dump */</span>
  <span class="token class-name">uint8_t</span> reg<span class="token punctuation">;</span>
  <span class="token class-name">uint8_t</span> val<span class="token punctuation">;</span>

  <span class="token keyword">for</span><span class="token punctuation">(</span>reg <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span> reg <span class="token operator">&lt;=</span> <span class="token number">0x19</span><span class="token punctuation">;</span> reg<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>reg <span class="token operator">!=</span> <span class="token number">0x10</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> \
        <span class="token punctuation">(</span>reg <span class="token operator">!=</span> <span class="token number">0x11</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      apds<span class="token punctuation">.</span><span class="token function">wireReadDataByte</span><span class="token punctuation">(</span>reg<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
      Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>reg<span class="token punctuation">,</span> HEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
      Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">": 0x"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> HEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  apds<span class="token punctuation">.</span><span class="token function">wireReadDataByte</span><span class="token punctuation">(</span><span class="token number">0x1E</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token number">0x1E</span><span class="token punctuation">,</span> HEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">": 0x"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> HEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token punctuation">}</span>

<span class="token comment">/*
 * 主循环
 * 功能介绍：当有物体靠近传感器约10cm的位置时，触发中断，点亮LED LIGHT_TIME毫秒，持续触发则常亮，无则灭灯。 
 * 说明：通过修改 宏定义 LIGHT_TIME调节延时，LED负极接在数字10口（正极 3.3V供电）
*/</span>
<span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
  <span class="token comment">// If interrupt occurs, print out the proximity level</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> isr_flag <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Read proximity level and print it out</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>apds<span class="token punctuation">.</span><span class="token function">readProximity</span><span class="token punctuation">(</span>proximity_data<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Error reading proximity value"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Proximity detected! Level: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>proximity_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// Reset flag and clear APDS-9930 interrupt (IMPORTANT!)</span>
    isr_flag <span class="token operator">=</span> false<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>apds<span class="token punctuation">.</span><span class="token function">clearProximityInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Error clearing interrupt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 点亮和延时放在清除中断后面，可以避免连续中断之间的LED闪烁问题</span>
    <span class="token function">digitalWrite</span><span class="token punctuation">(</span>LED_PIN<span class="token punctuation">,</span> LOW<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay</span><span class="token punctuation">(</span>LIGHT_TIME<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 无中断则熄灭LED</span>
    <span class="token function">digitalWrite</span><span class="token punctuation">(</span>LED_PIN<span class="token punctuation">,</span> HIGH<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">interruptRoutine</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  isr_flag <span class="token operator">=</span> true<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="2LED_1599"></a>2、点亮/熄灭LED，延时期间操作不响应</h3> 
<p><strong>ProximityInterrupt.ino</strong></p> 
<pre><code class="prism language-c"><span class="token comment">/****************************************************************
ProximityInterrupt.ino
APDS-9930 Ambient light and proximity sensor
Davide Depau
December 11, 2015
https://github.com/Davideddu/APDS9930

Shawn Hymel @ SparkFun Electronics
October 24, 2014
https://github.com/sparkfun/APDS-9930_RGB_and_Gesture_Sensor

Tests the proximity interrupt abilities of the APDS-9930.
Configures the APDS-9930 over I2C and waits for an external
interrupt based on high or low proximity conditions. Move your
hand near the sensor and watch the LED on pin 13.

Hardware Connections:

IMPORTANT: The APDS-9930 can only accept 3.3V!
 
 Arduino Pin  APDS-9930 Board  Function
 
 3.3V         VCC              Power
 GND          GND              Ground
 A4           SDA              I2C Data
 A5           SCL              I2C Clock
 2            INT              Interrupt
 10           -                LED

Resources:
Include Wire.h and APDS9930.h

Development environment specifics:
Written in Arduino 1.6.5
Tested with Arduino Uno and Mega

This code is beerware; if you see me (or any other SparkFun 
employee) at the local, and you've found our code helpful, please
buy us a round!

Distributed as-is; no warranty is given.
****************************************************************/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DUMP_REGS</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Wire.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"APDS9930.h"</span></span>

<span class="token comment">// Pins</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APDS9930_INT</span>    <span class="token expression"><span class="token number">2</span>  </span><span class="token comment">// Needs to be an interrupt pin</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LED_PIN</span>         <span class="token expression"><span class="token number">10</span> </span><span class="token comment">// LED for showing interrupt</span></span>

<span class="token comment">// Constants</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PROX_INT_HIGH</span>   <span class="token expression"><span class="token number">600</span> </span><span class="token comment">// Proximity level for interrupt</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PROX_INT_LOW</span>    <span class="token expression"><span class="token number">0</span>  </span><span class="token comment">// No far interrupt</span></span>

<span class="token comment">// 亮灯延时</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LIGHT_TIME</span> <span class="token expression"><span class="token number">5000</span></span></span>
<span class="token comment">// 响应延时</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RESPONSE_TIME</span> <span class="token expression"><span class="token number">2000</span></span></span>

<span class="token comment">// Global variables</span>
APDS9930 apds <span class="token operator">=</span> <span class="token function">APDS9930</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">uint16_t</span> proximity_data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">volatile</span> bool isr_flag <span class="token operator">=</span> false<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// Set LED as output</span>
  <span class="token function">pinMode</span><span class="token punctuation">(</span>LED_PIN<span class="token punctuation">,</span> OUTPUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">pinMode</span><span class="token punctuation">(</span>APDS9930_INT<span class="token punctuation">,</span> INPUT<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 先熄灭LED</span>
  <span class="token function">digitalWrite</span><span class="token punctuation">(</span>LED_PIN<span class="token punctuation">,</span> HIGH<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// Initialize Serial port</span>
  Serial<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token number">9600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">F</span><span class="token punctuation">(</span><span class="token string">"------------------------------"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">F</span><span class="token punctuation">(</span><span class="token string">"APDS-9930 - ProximityInterrupt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">F</span><span class="token punctuation">(</span><span class="token string">"------------------------------"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// Initialize interrupt service routine</span>
  <span class="token function">attachInterrupt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> interruptRoutine<span class="token punctuation">,</span> FALLING<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// Initialize APDS-9930 (configure I2C and initial values)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> apds<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">F</span><span class="token punctuation">(</span><span class="token string">"APDS-9930 initialization complete"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">F</span><span class="token punctuation">(</span><span class="token string">"Something went wrong during APDS-9930 init!"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// Adjust the Proximity sensor gain</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>apds<span class="token punctuation">.</span><span class="token function">setProximityGain</span><span class="token punctuation">(</span>PGAIN_2X<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">F</span><span class="token punctuation">(</span><span class="token string">"Something went wrong trying to set PGAIN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// Set proximity interrupt thresholds</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>apds<span class="token punctuation">.</span><span class="token function">setProximityIntLowThreshold</span><span class="token punctuation">(</span>PROX_INT_LOW<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">F</span><span class="token punctuation">(</span><span class="token string">"Error writing low threshold"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>apds<span class="token punctuation">.</span><span class="token function">setProximityIntHighThreshold</span><span class="token punctuation">(</span>PROX_INT_HIGH<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">F</span><span class="token punctuation">(</span><span class="token string">"Error writing high threshold"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// Start running the APDS-9930 proximity sensor (interrupts)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> apds<span class="token punctuation">.</span><span class="token function">enableProximitySensor</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">F</span><span class="token punctuation">(</span><span class="token string">"Proximity sensor is now running"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">F</span><span class="token punctuation">(</span><span class="token string">"Something went wrong during sensor init!"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">DUMP_REGS</span></span>
  <span class="token comment">/* Register dump */</span>
  <span class="token class-name">uint8_t</span> reg<span class="token punctuation">;</span>
  <span class="token class-name">uint8_t</span> val<span class="token punctuation">;</span>

  <span class="token keyword">for</span><span class="token punctuation">(</span>reg <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span> reg <span class="token operator">&lt;=</span> <span class="token number">0x19</span><span class="token punctuation">;</span> reg<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>reg <span class="token operator">!=</span> <span class="token number">0x10</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> \
        <span class="token punctuation">(</span>reg <span class="token operator">!=</span> <span class="token number">0x11</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      apds<span class="token punctuation">.</span><span class="token function">wireReadDataByte</span><span class="token punctuation">(</span>reg<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
      Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>reg<span class="token punctuation">,</span> HEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
      Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">": 0x"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> HEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  apds<span class="token punctuation">.</span><span class="token function">wireReadDataByte</span><span class="token punctuation">(</span><span class="token number">0x1E</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token number">0x1E</span><span class="token punctuation">,</span> HEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">": 0x"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> HEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token punctuation">}</span>

<span class="token comment">/*
 * 主循环
 * 功能介绍：当有物体靠近传感器约10cm的位置时，触发中断，点亮/熄灭LED，延时RESPONSE_TIME毫秒，延时期间操作不响应。 
 * 说明：通过修改 宏定义 RESPONSE_TIME调节延时响应，LED负极接在数字10口（正极 3.3V供电）
*/</span>
<span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 临时变量</span>
  <span class="token class-name">uint8_t</span> temp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  
  <span class="token comment">// If interrupt occurs, print out the proximity level</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> isr_flag <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Read proximity level and print it out</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>apds<span class="token punctuation">.</span><span class="token function">readProximity</span><span class="token punctuation">(</span>proximity_data<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Error reading proximity value"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Proximity detected! Level: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>proximity_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 读取LED_PIN电平，反转电平</span>
    temp <span class="token operator">=</span> <span class="token function">digitalRead</span><span class="token punctuation">(</span>LED_PIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>temp <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">digitalWrite</span><span class="token punctuation">(</span>LED_PIN<span class="token punctuation">,</span> HIGH<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token function">digitalWrite</span><span class="token punctuation">(</span>LED_PIN<span class="token punctuation">,</span> LOW<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay</span><span class="token punctuation">(</span>RESPONSE_TIME<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Reset flag and clear APDS-9930 interrupt (IMPORTANT!)</span>
    isr_flag <span class="token operator">=</span> false<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>apds<span class="token punctuation">.</span><span class="token function">clearProximityInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Error clearing interrupt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">interruptRoutine</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  isr_flag <span class="token operator">=</span> true<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="3LEDpwm_1774"></a>3、挥手点亮/熄灭LED，悬停进行非无极pwm调光</h3> 
<p><strong>ProximityInterrupt.ino</strong></p> 
<pre><code class="prism language-c"><span class="token comment">/****************************************************************
ProximityInterrupt.ino
APDS-9930 Ambient light and proximity sensor
Davide Depau
December 11, 2015
https://github.com/Davideddu/APDS9930

Shawn Hymel @ SparkFun Electronics
October 24, 2014
https://github.com/sparkfun/APDS-9930_RGB_and_Gesture_Sensor

Tests the proximity interrupt abilities of the APDS-9930.
Configures the APDS-9930 over I2C and waits for an external
interrupt based on high or low proximity conditions. Move your
hand near the sensor and watch the LED on pin 13.

Hardware Connections:

IMPORTANT: The APDS-9930 can only accept 3.3V!
 
 Arduino Pin  APDS-9930 Board  Function
 
 3.3V         VCC              Power
 GND          GND              Ground
 A4           SDA              I2C Data
 A5           SCL              I2C Clock
 2            INT              Interrupt
 10           -                LED

Resources:
Include Wire.h and APDS9930.h

Development environment specifics:
Written in Arduino 1.6.5
Tested with Arduino Uno and Mega

This code is beerware; if you see me (or any other SparkFun 
employee) at the local, and you've found our code helpful, please
buy us a round!

Distributed as-is; no warranty is given.
****************************************************************/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DUMP_REGS</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Wire.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"APDS9930.h"</span></span>

<span class="token comment">// Pins</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APDS9930_INT</span>    <span class="token expression"><span class="token number">2</span>  </span><span class="token comment">// Needs to be an interrupt pin</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LED_PIN</span>         <span class="token expression"><span class="token number">10</span> </span><span class="token comment">// LED for showing interrupt</span></span>

<span class="token comment">// Constants</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PROX_INT_HIGH</span>   <span class="token expression"><span class="token number">600</span> </span><span class="token comment">// Proximity level for interrupt</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PROX_INT_LOW</span>    <span class="token expression"><span class="token number">0</span>  </span><span class="token comment">// No far interrupt</span></span>

<span class="token comment">// 亮灯延时</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LIGHT_TIME</span> <span class="token expression"><span class="token number">5000</span></span></span>
<span class="token comment">// 响应延时</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RESPONSE_TIME</span> <span class="token expression"><span class="token number">300</span></span></span>
<span class="token comment">// pwm每次变动的值</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PWM_CHANGE_VAL</span> <span class="token expression"><span class="token number">32</span></span></span>

<span class="token comment">// Global variables</span>
APDS9930 apds <span class="token operator">=</span> <span class="token function">APDS9930</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">uint16_t</span> proximity_data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">volatile</span> bool isr_flag <span class="token operator">=</span> false<span class="token punctuation">;</span>

<span class="token comment">// 中断计数</span>
<span class="token class-name">uint8_t</span> interrupt_num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">// 循环计数</span>
<span class="token class-name">uint8_t</span> loop_num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">// 0为开关模式 1为pwm调光模式</span>
<span class="token class-name">uint8_t</span> mode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">// pwm值</span>
<span class="token class-name">uint8_t</span> pwm_val <span class="token operator">=</span> <span class="token number">255</span><span class="token punctuation">;</span>
<span class="token comment">// LED亮标志位 0灭 1亮</span>
<span class="token class-name">uint8_t</span> led_on_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// Set LED as output</span>
  <span class="token function">pinMode</span><span class="token punctuation">(</span>LED_PIN<span class="token punctuation">,</span> OUTPUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">pinMode</span><span class="token punctuation">(</span>APDS9930_INT<span class="token punctuation">,</span> INPUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// Initialize Serial port</span>
  Serial<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token number">9600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">F</span><span class="token punctuation">(</span><span class="token string">"------------------------------"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">F</span><span class="token punctuation">(</span><span class="token string">"APDS-9930 - ProximityInterrupt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">F</span><span class="token punctuation">(</span><span class="token string">"------------------------------"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// Initialize interrupt service routine</span>
  <span class="token function">attachInterrupt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> interruptRoutine<span class="token punctuation">,</span> FALLING<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// Initialize APDS-9930 (configure I2C and initial values)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> apds<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">F</span><span class="token punctuation">(</span><span class="token string">"APDS-9930 initialization complete"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">F</span><span class="token punctuation">(</span><span class="token string">"Something went wrong during APDS-9930 init!"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// Adjust the Proximity sensor gain</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>apds<span class="token punctuation">.</span><span class="token function">setProximityGain</span><span class="token punctuation">(</span>PGAIN_2X<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">F</span><span class="token punctuation">(</span><span class="token string">"Something went wrong trying to set PGAIN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// Set proximity interrupt thresholds</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>apds<span class="token punctuation">.</span><span class="token function">setProximityIntLowThreshold</span><span class="token punctuation">(</span>PROX_INT_LOW<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">F</span><span class="token punctuation">(</span><span class="token string">"Error writing low threshold"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>apds<span class="token punctuation">.</span><span class="token function">setProximityIntHighThreshold</span><span class="token punctuation">(</span>PROX_INT_HIGH<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">F</span><span class="token punctuation">(</span><span class="token string">"Error writing high threshold"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// Start running the APDS-9930 proximity sensor (interrupts)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> apds<span class="token punctuation">.</span><span class="token function">enableProximitySensor</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">F</span><span class="token punctuation">(</span><span class="token string">"Proximity sensor is now running"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">F</span><span class="token punctuation">(</span><span class="token string">"Something went wrong during sensor init!"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">DUMP_REGS</span></span>
  <span class="token comment">/* Register dump */</span>
  <span class="token class-name">uint8_t</span> reg<span class="token punctuation">;</span>
  <span class="token class-name">uint8_t</span> val<span class="token punctuation">;</span>

  <span class="token keyword">for</span><span class="token punctuation">(</span>reg <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span> reg <span class="token operator">&lt;=</span> <span class="token number">0x19</span><span class="token punctuation">;</span> reg<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>reg <span class="token operator">!=</span> <span class="token number">0x10</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> \
        <span class="token punctuation">(</span>reg <span class="token operator">!=</span> <span class="token number">0x11</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      apds<span class="token punctuation">.</span><span class="token function">wireReadDataByte</span><span class="token punctuation">(</span>reg<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
      Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>reg<span class="token punctuation">,</span> HEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
      Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">": 0x"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> HEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  apds<span class="token punctuation">.</span><span class="token function">wireReadDataByte</span><span class="token punctuation">(</span><span class="token number">0x1E</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token number">0x1E</span><span class="token punctuation">,</span> HEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">": 0x"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> HEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

  <span class="token comment">// 先熄灭LED</span>
  <span class="token function">digitalWrite</span><span class="token punctuation">(</span>LED_PIN<span class="token punctuation">,</span> HIGH<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * 主循环
 * 功能介绍：
 *    当有物体靠近传感器约10cm的位置时，可以触发中断。
 *    如果4*RESPONSE_TIME毫秒内 没有触发4次中断，即4*RESPONSE_TIME毫秒内，划过传感区域，则为开关模式，会进行LED的亮灭操作（亮到设定的pwm_val)
 *    如果4*RESPONSE_TIME毫秒内 触发了4次中断，即4*RESPONSE_TIME毫秒以上，物体一直停留在传感区域内，则为pwm调光模式，会进行LED的pwm非无极调光（每次在当前基础上增加PWM_CHANGE_VAL）
 *    如果在pwm调光模式下，物体移出了传感区域，则会结束pwm值的调节。若下次继续快划，则进行开关，若继续悬停，则继续调光。
 *    单位延时RESPONSE_TIME毫秒，延时期间操作不响应。 
 * 说明：
 *    通过修改 宏定义 RESPONSE_TIME调节延时响应，若想增加调光速率，可减小此值。
 *    通过修改 宏定义 PWM_CHANGE_VAL，调节单次pwm调光的大小，范围1-255。若想要更细致的调光，可减小此值。
 *    LED负极接在数字10口（正极 3.3V供电）
*/</span>
<span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 临时变量</span>
  <span class="token class-name">uint8_t</span> temp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  loop_num<span class="token operator">++</span><span class="token punctuation">;</span>
  
  <span class="token comment">// If interrupt occurs, print out the proximity level</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> isr_flag <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    interrupt_num<span class="token operator">++</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Read proximity level and print it out</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>apds<span class="token punctuation">.</span><span class="token function">readProximity</span><span class="token punctuation">(</span>proximity_data<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Error reading proximity value"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Proximity detected! Level: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>proximity_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// Reset flag and clear APDS-9930 interrupt (IMPORTANT!)</span>
    isr_flag <span class="token operator">=</span> false<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>apds<span class="token punctuation">.</span><span class="token function">clearProximityInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Error clearing interrupt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">delay</span><span class="token punctuation">(</span>RESPONSE_TIME<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">delay</span><span class="token punctuation">(</span>RESPONSE_TIME<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 4次循环即 4*RESPONSE_TIME毫秒</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">==</span> loop_num<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Serial.println("loop_num == 4");</span>
    loop_num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 触发中断数小于4，认为是划过，非悬停状态。</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>interrupt_num <span class="token operator">&lt;</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span> interrupt_num <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"interrupt_num &lt; 4 &amp;&amp; interrupt_num &gt; 0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 如果是开关模式</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>mode <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 读取LED_PIN电平</span>
        temp <span class="token operator">=</span> <span class="token function">digitalRead</span><span class="token punctuation">(</span>LED_PIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"temp:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// temp&gt;0 为 熄灭 或 pwm&lt;255亮灯 状态</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>temp <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// pwm==255则点亮LED</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>pwm_val <span class="token operator">==</span> <span class="token number">255</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">analogWrite</span><span class="token punctuation">(</span>LED_PIN<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            led_on_flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token comment">// pwm!=255</span>
          <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 如果灯是熄灭状态，点亮至之前设定的pwm_val</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>led_on_flag <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token function">analogWrite</span><span class="token punctuation">(</span>LED_PIN<span class="token punctuation">,</span> pwm_val<span class="token punctuation">)</span><span class="token punctuation">;</span>
              led_on_flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 如果灯是点亮状态，则熄灭</span>
            <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
              <span class="token function">analogWrite</span><span class="token punctuation">(</span>LED_PIN<span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              led_on_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 熄灭LED</span>
          <span class="token function">analogWrite</span><span class="token punctuation">(</span>LED_PIN<span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          led_on_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 切换为开关模式</span>
        mode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"pwm_val:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>pwm_val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>interrupt_num <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"interrupt_num == 4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 切换为pwm调光模式</span>
      mode <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      pwm_val <span class="token operator">+=</span> PWM_CHANGE_VAL<span class="token punctuation">;</span>
      <span class="token comment">// 0到255之间的PWM频率值</span>
      <span class="token function">analogWrite</span><span class="token punctuation">(</span>LED_PIN<span class="token punctuation">,</span> pwm_val<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>pwm_val <span class="token operator">==</span> <span class="token number">255</span><span class="token punctuation">)</span> led_on_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">else</span> led_on_flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

      Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"pwm_val:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>pwm_val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 清零</span>
    loop_num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    interrupt_num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">interruptRoutine</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  isr_flag <span class="token operator">=</span> true<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="_2036"></a>参考图</h2> 
<p><img src="https://images2.imgbox.com/c0/de/GOMMGDck_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/80/d9/egJ6Iluu_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/da/f5/zIdQ9qAF_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/05/99/zvMdNNZb_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6696935f29492c41b28cba1c6a8d7294/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">YOLO v3网络结构分析</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/de675ca983ae1d7d574b433a86f6968f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">博文翻译系列——如何入门数据科学 without spending a penny</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>