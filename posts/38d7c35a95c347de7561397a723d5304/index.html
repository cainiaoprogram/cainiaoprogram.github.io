<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>二、MongoDB数据模型和文档操作 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="二、MongoDB数据模型和文档操作" />
<meta property="og:description" content="MongoDB数据模型和文档操作 1、MongoDB数据模型1.1 BSON协议与数据类型1.1.1 JSON1.1.2 BSON 2、插入文档2.1 新增单个文档2.2 批量新增文档 3、查询文档3.1 条件查询3.1.1 MongoDB 与 SQL 语法区分3.1.2 MongoDB 查询实例3.1.2 MongoDB 排序与分页（Limit、sort与Skip方法）3.1.3 分页问题的处理3.1.4 正则表达式匹配查询 4、更新文档4.1 更新操作符4.1.1 更新单个文档4.1.2 更新多个文档4.1.3 使用upsert命令4.1.4 findAndModify命令 5、删除文档5.1 使用 remove 删除文档5.2 使用 delete 删除文档5.2.1 返回被删除文档 6、总结 1、MongoDB数据模型 问题： M o n g o D B 为什么会使用 B S O N ？ \color{red}{问题：MongoDB为什么会使用BSON？} 问题：MongoDB为什么会使用BSON？
1.1 BSON协议与数据类型 1.1.1 JSON JSON是当今非常通用的一种跨语言Web数据交互格式，属于ECMAScript标准规范的一个子集。 J S O N （ J a v a S c r i p t O b j e c t N o t a t i o n , J S 对象简谱）即 J a v a S c r i p t 对象表示法， \color{red}{JSON（JavaScript Object Notation, JS对象简谱）即JavaScript对象表示法，} JSON（JavaScriptObjectNotation,JS对象简谱）即JavaScript对象表示法，它是JavaScript对象的一种文本表现形式。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/38d7c35a95c347de7561397a723d5304/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-27T17:04:51+08:00" />
<meta property="article:modified_time" content="2023-02-27T17:04:51+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">二、MongoDB数据模型和文档操作</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>MongoDB数据模型和文档操作</h4> 
 <ul><li><a href="#1MongoDB_1" rel="nofollow">1、MongoDB数据模型</a></li><li><ul><li><a href="#11_BSON_3" rel="nofollow">1.1 BSON协议与数据类型</a></li><li><ul><li><a href="#111_JSON_4" rel="nofollow">1.1.1 JSON</a></li><li><a href="#112_BSON_27" rel="nofollow">1.1.2 BSON</a></li></ul> 
  </li></ul> 
  </li><li><a href="#2_55" rel="nofollow">2、插入文档</a></li><li><ul><li><a href="#21__67" rel="nofollow">2.1 新增单个文档</a></li><li><a href="#22__95" rel="nofollow">2.2 批量新增文档</a></li></ul> 
  </li><li><a href="#3_141" rel="nofollow">3、查询文档</a></li><li><ul><li><a href="#31__168" rel="nofollow">3.1 条件查询</a></li><li><ul><li><a href="#311_MongoDB__SQL___169" rel="nofollow">3.1.1 MongoDB 与 SQL 语法区分</a></li><li><a href="#312_MongoDB__200" rel="nofollow">3.1.2 MongoDB 查询实例</a></li><li><a href="#312_MongoDB_LimitsortSkip_250" rel="nofollow">3.1.2 MongoDB 排序与分页（Limit、sort与Skip方法）</a></li><li><a href="#313__314" rel="nofollow">3.1.3 分页问题的处理</a></li><li><a href="#314__334" rel="nofollow">3.1.4 正则表达式匹配查询</a></li></ul> 
  </li></ul> 
  </li><li><a href="#4_344" rel="nofollow">4、更新文档</a></li><li><ul><li><a href="#41__356" rel="nofollow">4.1 更新操作符</a></li><li><ul><li><a href="#411__369" rel="nofollow">4.1.1 更新单个文档</a></li><li><a href="#412__396" rel="nofollow">4.1.2 更新多个文档</a></li><li><a href="#413_upsert_409" rel="nofollow">4.1.3 使用upsert命令</a></li><li><a href="#414_findAndModify_429" rel="nofollow">4.1.4 findAndModify命令</a></li></ul> 
  </li></ul> 
  </li><li><a href="#5_469" rel="nofollow">5、删除文档</a></li><li><ul><li><a href="#51__remove__471" rel="nofollow">5.1 使用 remove 删除文档</a></li><li><a href="#52__delete__495" rel="nofollow">5.2 使用 delete 删除文档</a></li><li><ul><li><a href="#521__507" rel="nofollow">5.2.1 返回被删除文档</a></li></ul> 
  </li></ul> 
  </li><li><a href="#6_538" rel="nofollow">6、总结</a></li></ul> 
</div> 
<p></p> 
<h2><a id="1MongoDB_1"></a>1、MongoDB数据模型</h2> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
         
         
           问题： 
          
         
           M 
          
         
           o 
          
         
           n 
          
         
           g 
          
         
           o 
          
         
           D 
          
         
           B 
          
         
           为什么会使用 
          
         
           B 
          
         
           S 
          
         
           O 
          
         
           N 
          
         
           ？ 
          
         
        
       
      
        \color{red}{问题：MongoDB为什么会使用BSON？} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">问题：</span><span class="mord mathnormal" style="margin-right: 0.109em; color: red;">M</span><span class="mord mathnormal" style="color: red;">o</span><span class="mord mathnormal" style="color: red;">n</span><span class="mord mathnormal" style="margin-right: 0.0359em; color: red;">g</span><span class="mord mathnormal" style="margin-right: 0.0278em; color: red;">oD</span><span class="mord mathnormal" style="margin-right: 0.0502em; color: red;">B</span><span class="mord cjk_fallback" style="color: red;">为什么会使用</span><span class="mord mathnormal" style="margin-right: 0.109em; color: red;">BSON</span><span class="mord cjk_fallback" style="color: red;">？</span></span></span></span></span></span></p> 
<h3><a id="11_BSON_3"></a>1.1 BSON协议与数据类型</h3> 
<h4><a id="111_JSON_4"></a>1.1.1 JSON</h4> 
<p>JSON是当今非常通用的一种跨语言Web数据交互格式，属于ECMAScript标准规范的一个子集。<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
         
         
           J 
          
         
           S 
          
         
           O 
          
         
           N 
          
         
           （ 
          
         
           J 
          
         
           a 
          
         
           v 
          
         
           a 
          
         
           S 
          
         
           c 
          
         
           r 
          
         
           i 
          
         
           p 
          
         
           t 
          
         
           O 
          
         
           b 
          
         
           j 
          
         
           e 
          
         
           c 
          
         
           t 
          
         
           N 
          
         
           o 
          
         
           t 
          
         
           a 
          
         
           t 
          
         
           i 
          
         
           o 
          
         
           n 
          
         
           , 
          
         
           J 
          
         
           S 
          
         
           对象简谱）即 
          
         
           J 
          
         
           a 
          
         
           v 
          
         
           a 
          
         
           S 
          
         
           c 
          
         
           r 
          
         
           i 
          
         
           p 
          
         
           t 
          
         
           对象表示法， 
          
         
        
       
      
        \color{red}{JSON（JavaScript Object Notation, JS对象简谱）即JavaScript对象表示法，} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord" style="color: red;"><span class="mord mathnormal" style="margin-right: 0.0962em; color: red;">J</span><span class="mord mathnormal" style="margin-right: 0.109em; color: red;">SON</span><span class="mord cjk_fallback" style="color: red;">（</span><span class="mord mathnormal" style="margin-right: 0.0962em; color: red;">J</span><span class="mord mathnormal" style="color: red;">a</span><span class="mord mathnormal" style="margin-right: 0.0359em; color: red;">v</span><span class="mord mathnormal" style="color: red;">a</span><span class="mord mathnormal" style="margin-right: 0.0576em; color: red;">S</span><span class="mord mathnormal" style="margin-right: 0.0278em; color: red;">cr</span><span class="mord mathnormal" style="color: red;">i</span><span class="mord mathnormal" style="margin-right: 0.0278em; color: red;">ptO</span><span class="mord mathnormal" style="margin-right: 0.0572em; color: red;">bj</span><span class="mord mathnormal" style="color: red;">ec</span><span class="mord mathnormal" style="margin-right: 0.109em; color: red;">tN</span><span class="mord mathnormal" style="color: red;">o</span><span class="mord mathnormal" style="color: red;">t</span><span class="mord mathnormal" style="color: red;">a</span><span class="mord mathnormal" style="color: red;">t</span><span class="mord mathnormal" style="color: red;">i</span><span class="mord mathnormal" style="color: red;">o</span><span class="mord mathnormal" style="color: red;">n</span><span class="mpunct" style="color: red;">,</span><span class="mspace" style="color: red; margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.0962em; color: red;">J</span><span class="mord mathnormal" style="margin-right: 0.0576em; color: red;">S</span><span class="mord cjk_fallback" style="color: red;">对象简谱）即</span><span class="mord mathnormal" style="margin-right: 0.0962em; color: red;">J</span><span class="mord mathnormal" style="color: red;">a</span><span class="mord mathnormal" style="margin-right: 0.0359em; color: red;">v</span><span class="mord mathnormal" style="color: red;">a</span><span class="mord mathnormal" style="margin-right: 0.0576em; color: red;">S</span><span class="mord mathnormal" style="margin-right: 0.0278em; color: red;">cr</span><span class="mord mathnormal" style="color: red;">i</span><span class="mord mathnormal" style="color: red;">pt</span><span class="mord cjk_fallback" style="color: red;">对象表示法，</span></span></span></span></span></span>它是JavaScript对象的一种文本表现形式。</p> 
<p><em>作为一种轻量级的数据交换格式</em>，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
         
         
           J 
          
         
           S 
          
         
           O 
          
         
           N 
          
         
           的可读性非常好，而且非常便于系统生成和解析 
          
         
        
       
      
        \color{red}{JSON的可读性非常好，而且非常便于系统生成和解析} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord" style="color: red;"><span class="mord mathnormal" style="margin-right: 0.0962em; color: red;">J</span><span class="mord mathnormal" style="margin-right: 0.109em; color: red;">SON</span><span class="mord cjk_fallback" style="color: red;">的可读性非常好，而且非常便于系统生成和解析</span></span></span></span></span></span>，这些优势也让它逐渐取代了XML标准在Web领域的地位，当今许多流行的Web应用开发框架，如SpringBoot都选择了JSON作为默认的数据编/解码格式</p> 
<p>JSON定义了6种数据类型：</p> 
<table><thead><tr><th align="left">Type</th><th align="left">解释</th></tr></thead><tbody><tr><td align="left">string</td><td align="left">字符串</td></tr><tr><td align="left">number</td><td align="left">数值</td></tr><tr><td align="left">object</td><td align="left">js的对象形式，用{key:value}表示，可嵌套</td></tr><tr><td align="left">array</td><td align="left">数组，可嵌套</td></tr><tr><td align="left">true|false</td><td align="left">布尔类型</td></tr><tr><td align="left">null</td><td align="left">空值</td></tr></tbody></table> 
<p>大多数情况下，使用JSON作为数据交互格式已经是理想的选择，<br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
         
         
           J 
          
         
           S 
          
         
           O 
          
         
           N 
          
         
           基于文本的解析效率并不是最好的，在某些场景下往往会考虑选择更合适的编 
          
         
           / 
          
         
           解码格式 
          
         
        
       
      
        \color{red}{JSON基于文本的解析效率并不是最好的，在某些场景下往往会考虑选择更合适的编/解码格式} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord" style="color: red;"><span class="mord mathnormal" style="margin-right: 0.0962em; color: red;">J</span><span class="mord mathnormal" style="margin-right: 0.109em; color: red;">SON</span><span class="mord cjk_fallback" style="color: red;">基于文本的解析效率并不是最好的，在某些场景下往往会考虑选择更合适的编</span><span class="mord" style="color: red;">/</span><span class="mord cjk_fallback" style="color: red;">解码格式</span></span></span></span></span></span></p> 
<ul><li>在微服务架构中，使用gRPC（基于Google的Protobuf）可以获得更好的网络利用率</li><li>分布式中间件、数据库，使用私有定制的TCP数据包格式来提供高性能、低延时的计算能力</li></ul> 
<h4><a id="112_BSON_27"></a>1.1.2 BSON</h4> 
<ul><li>BSON由10gen团队设计并开源，目前主要用于MongoDB数据库</li><li>BSON（Binary JSON）是二进制版本的JSON，其在性能方面有更优的表现</li><li>BSON在许多方面和JSON保持一致，其同样也支持内嵌的文档对象和数组结构</li></ul> 
<p><mark>对比：</mark></p> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
         
         
           J 
          
         
           S 
          
         
           O 
          
         
           N 
          
         
           是基于文本的，而 
          
         
           B 
          
         
           S 
          
         
           O 
          
         
           N 
          
         
           则是二进制（字节流）编 
          
         
           / 
          
         
           解码的形式 
          
         
        
       
      
        \color{red}{JSON是基于文本的，而BSON则是二进制（字节流）编/解码的形式} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord" style="color: red;"><span class="mord mathnormal" style="margin-right: 0.0962em; color: red;">J</span><span class="mord mathnormal" style="margin-right: 0.109em; color: red;">SON</span><span class="mord cjk_fallback" style="color: red;">是基于文本的，而</span><span class="mord mathnormal" style="margin-right: 0.109em; color: red;">BSON</span><span class="mord cjk_fallback" style="color: red;">则是二进制（字节流）编</span><span class="mord" style="color: red;">/</span><span class="mord cjk_fallback" style="color: red;">解码的形式</span></span></span></span></span></span><br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
         
         
           在空间的使用上， 
          
         
           B 
          
         
           S 
          
         
           O 
          
         
           N 
          
         
           相比 
          
         
           J 
          
         
           S 
          
         
           O 
          
         
           N 
          
         
           并没有明显的优势 
          
         
        
       
      
        \color{red}{在空间的使用上，BSON相比JSON并没有明显的优势} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">在空间的使用上，</span><span class="mord mathnormal" style="margin-right: 0.109em; color: red;">BSON</span><span class="mord cjk_fallback" style="color: red;">相比</span><span class="mord mathnormal" style="margin-right: 0.0962em; color: red;">J</span><span class="mord mathnormal" style="margin-right: 0.109em; color: red;">SON</span><span class="mord cjk_fallback" style="color: red;">并没有明显的优势</span></span></span></span></span></span></p> 
<p><strong>MongoDB在文档存储、命令协议上都采用了BSON作为编/解码格式，主要具有如下优势：</strong></p> 
<ul><li>类JSON的轻量级语义，支持简单清晰的嵌套、数组层次结构，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           可以实现模式灵活的文档结构 
          
         
        
       
         \color{red}{可以实现模式灵活的文档结构} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">可以实现模式灵活的文档结构</span></span></span></span></span></span></li><li><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           更高效的遍历 
          
         
        
       
         \color{red}{更高效的遍历} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">更高效的遍历</span></span></span></span></span></span>，BSON在编码时会记录每个元素的长度，可以直接通过seek操作进行元素的内容读取，相对JSON解析来说，遍历速度更快</li><li><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           更丰富的数据类型 
          
         
        
       
         \color{red}{更丰富的数据类型} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">更丰富的数据类型</span></span></span></span></span></span>，除了JSON的基本数据类型，BSON还提供了MongoDB所需的一些扩展类型，比如日期、二进制数据等，这更加方便数据的表示和操作</li><li><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
          
            M 
           
          
            o 
           
          
            n 
           
          
            g 
           
          
            o 
           
          
            D 
           
          
            B 
           
          
            中，一个 
           
          
            B 
           
          
            S 
           
          
            O 
           
          
            N 
           
          
            文档最大大小为 
           
          
            16 
           
          
            M 
           
          
            ，文档嵌套的级别不超过 
           
          
            100 
           
          
         
        
       
         \color{red}{MongoDB中，一个BSON文档最大大小为16M，文档嵌套的级别不超过100} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;"></span><span class="mord" style="color: red;"><span class="mord mathnormal" style="margin-right: 0.109em; color: red;">M</span><span class="mord mathnormal" style="color: red;">o</span><span class="mord mathnormal" style="color: red;">n</span><span class="mord mathnormal" style="margin-right: 0.0359em; color: red;">g</span><span class="mord mathnormal" style="margin-right: 0.0278em; color: red;">oD</span><span class="mord mathnormal" style="margin-right: 0.0502em; color: red;">B</span><span class="mord cjk_fallback" style="color: red;">中，一个</span><span class="mord mathnormal" style="margin-right: 0.109em; color: red;">BSON</span><span class="mord cjk_fallback" style="color: red;">文档最大大小为</span><span class="mord" style="color: red;">16</span><span class="mord mathnormal" style="margin-right: 0.109em; color: red;">M</span><span class="mord cjk_fallback" style="color: red;">，文档嵌套的级别不超过</span><span class="mord" style="color: red;">100</span></span></span></span></span></span></li></ul> 
<p><strong>BSON的数据类型</strong><br> <a href="https://www.mongodb.com/docs/v6.0/reference/bson-types/" rel="nofollow">BsonType</a><br> <img src="https://images2.imgbox.com/82/5a/s6bZnNFh_o.png" alt="MongoDB-BSON-DATATYPE"><br> <strong>$type操作符：基于BSON类型来检索集合中匹配的数据类型</strong></p> 
<pre><code class="prism language-powershell">db<span class="token punctuation">.</span>test<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"title"</span> : <span class="token punctuation">{<!-- --></span><span class="token variable">$type</span> : 2<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">## 或者</span>
db<span class="token punctuation">.</span>test<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"title"</span> : <span class="token punctuation">{<!-- --></span><span class="token variable">$type</span> : <span class="token string">"string"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="2_55"></a>2、插入文档</h2> 
<p>MongoDB 使用 insert() 或 save() 方法向集合中插入文档，语法如下：</p> 
<pre><code class="prism language-powershell">db<span class="token punctuation">.</span>COLLECTION_NAME<span class="token punctuation">.</span>insert<span class="token punctuation">(</span>document<span class="token punctuation">)</span>
<span class="token comment">#或</span>
db<span class="token punctuation">.</span>COLLECTION_NAME<span class="token punctuation">.</span>save<span class="token punctuation">(</span>document<span class="token punctuation">)</span>
</code></pre> 
<ul><li>save()：如果 _id 主键存在则更新数据，如果不存在就插入数据。<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           该方法新版本中已废弃 
          
         
        
       
         \color{red}{该方法新版本中已废弃} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">该方法新版本中已废弃</span></span></span></span></span></span>，可以使用 db.collection.insertOne() 或 db.collection.replaceOne() 来代替。</li><li>insert(): 若插入的数据主键已经存在，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
          
            则会抛 
           
          
            o 
           
          
            r 
           
          
            g 
           
          
            . 
           
          
            s 
           
          
            p 
           
          
            r 
           
          
            i 
           
          
            n 
           
          
            g 
           
          
            f 
           
          
            r 
           
          
            a 
           
          
            m 
           
          
            e 
           
          
            w 
           
          
            o 
           
          
            r 
           
          
            k 
           
          
            . 
           
          
            d 
           
          
            a 
           
          
            o 
           
          
            . 
           
          
            D 
           
          
            u 
           
          
            p 
           
          
            l 
           
          
            i 
           
          
            c 
           
          
            a 
           
          
            t 
           
          
            e 
           
          
            K 
           
          
            e 
           
          
            y 
           
          
            E 
           
          
            x 
           
          
            c 
           
          
            e 
           
          
            p 
           
          
            t 
           
          
            i 
           
          
            o 
           
          
            n 
           
          
            异常 
           
          
         
        
       
         \color{red}{则会抛 org.springframework.dao.DuplicateKeyException 异常} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">则会抛</span><span class="mord mathnormal" style="margin-right: 0.0278em; color: red;">or</span><span class="mord mathnormal" style="margin-right: 0.0359em; color: red;">g</span><span class="mord" style="color: red;">.</span><span class="mord mathnormal" style="color: red;">s</span><span class="mord mathnormal" style="color: red;">p</span><span class="mord mathnormal" style="margin-right: 0.0278em; color: red;">r</span><span class="mord mathnormal" style="color: red;">in</span><span class="mord mathnormal" style="margin-right: 0.0359em; color: red;">g</span><span class="mord mathnormal" style="margin-right: 0.1076em; color: red;">f</span><span class="mord mathnormal" style="margin-right: 0.0278em; color: red;">r</span><span class="mord mathnormal" style="color: red;">am</span><span class="mord mathnormal" style="color: red;">e</span><span class="mord mathnormal" style="margin-right: 0.0269em; color: red;">w</span><span class="mord mathnormal" style="margin-right: 0.0278em; color: red;">or</span><span class="mord mathnormal" style="margin-right: 0.0315em; color: red;">k</span><span class="mord" style="color: red;">.</span><span class="mord mathnormal" style="color: red;">d</span><span class="mord mathnormal" style="color: red;">a</span><span class="mord mathnormal" style="color: red;">o</span><span class="mord" style="color: red;">.</span><span class="mord mathnormal" style="margin-right: 0.0278em; color: red;">D</span><span class="mord mathnormal" style="color: red;">u</span><span class="mord mathnormal" style="margin-right: 0.0197em; color: red;">pl</span><span class="mord mathnormal" style="color: red;">i</span><span class="mord mathnormal" style="color: red;">c</span><span class="mord mathnormal" style="color: red;">a</span><span class="mord mathnormal" style="color: red;">t</span><span class="mord mathnormal" style="margin-right: 0.0359em; color: red;">eKey</span><span class="mord mathnormal" style="margin-right: 0.0576em; color: red;">E</span><span class="mord mathnormal" style="color: red;">x</span><span class="mord mathnormal" style="color: red;">ce</span><span class="mord mathnormal" style="color: red;">pt</span><span class="mord mathnormal" style="color: red;">i</span><span class="mord mathnormal" style="color: red;">o</span><span class="mord mathnormal" style="color: red;">n</span><span class="mord cjk_fallback" style="color: red;">异常</span></span></span></span></span></span>，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           提示主键重复，不保存当前数据 
          
         
        
       
         \color{red}{提示主键重复，不保存当前数据} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">提示主键重复，不保存当前数据</span></span></span></span></span></span></li></ul> 
<p><strong>3.2 版本之后新增了 db.collection.insertOne() 和 db.collection.insertMany()</strong></p> 
<h3><a id="21__67"></a>2.1 新增单个文档</h3> 
<p><strong>db.collection.insertOne() 用于向集合插入一个新文档，语法格式如下：</strong></p> 
<pre><code class="prism language-powershell">db<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>insertOne<span class="token punctuation">(</span>
   &lt;document&gt;<span class="token punctuation">,</span>
   <span class="token punctuation">{<!-- --></span>
      writeConcern: &lt;document&gt;
   <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
         
         
           w 
          
         
           r 
          
         
           i 
          
         
           t 
          
         
           e 
          
         
           C 
          
         
           o 
          
         
           n 
          
         
           c 
          
         
           e 
          
         
           r 
          
         
           n 
          
         
           决定一个写操作落到多少个节点上才算成功。 
          
         
           w 
          
         
           r 
          
         
           i 
          
         
           t 
          
         
           e 
          
         
           C 
          
         
           o 
          
         
           n 
          
         
           c 
          
         
           e 
          
         
           r 
          
         
           n 
          
         
           的取值包括： 
          
         
        
       
      
        \color{red}{writeConcern 决定一个写操作落到多少个节点上才算成功。writeConcern 的取值包括： } 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord" style="color: red;"><span class="mord mathnormal" style="margin-right: 0.0269em; color: red;">w</span><span class="mord mathnormal" style="margin-right: 0.0278em; color: red;">r</span><span class="mord mathnormal" style="color: red;">i</span><span class="mord mathnormal" style="color: red;">t</span><span class="mord mathnormal" style="color: red;">e</span><span class="mord mathnormal" style="margin-right: 0.0715em; color: red;">C</span><span class="mord mathnormal" style="color: red;">o</span><span class="mord mathnormal" style="color: red;">n</span><span class="mord mathnormal" style="margin-right: 0.0278em; color: red;">cer</span><span class="mord mathnormal" style="color: red;">n</span><span class="mord cjk_fallback" style="color: red;">决定一个写操作落到多少个节点上才算成功。</span><span class="mord mathnormal" style="margin-right: 0.0269em; color: red;">w</span><span class="mord mathnormal" style="margin-right: 0.0278em; color: red;">r</span><span class="mord mathnormal" style="color: red;">i</span><span class="mord mathnormal" style="color: red;">t</span><span class="mord mathnormal" style="color: red;">e</span><span class="mord mathnormal" style="margin-right: 0.0715em; color: red;">C</span><span class="mord mathnormal" style="color: red;">o</span><span class="mord mathnormal" style="color: red;">n</span><span class="mord mathnormal" style="margin-right: 0.0278em; color: red;">cer</span><span class="mord mathnormal" style="color: red;">n</span><span class="mord cjk_fallback" style="color: red;">的取值包括：</span></span></span></span></span></span></p> 
<ul><li>0：发起写操作，不关心是否成功；</li><li>1~集群最大数据节点数：写操作需要被复制到指定节点数才算成功；</li><li>majority：写操作需要被复制到大多数节点上才算成功。</li></ul> 
<pre><code class="prism language-powershell">testdb&gt; use testdb
already on db testdb
testdb&gt; db<span class="token punctuation">.</span>testCollection<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>x:1<span class="token punctuation">}</span><span class="token punctuation">)</span>
TypeError: db<span class="token punctuation">.</span>testCollection<span class="token punctuation">.</span>save is not a <span class="token keyword">function</span>
testdb&gt; db<span class="token punctuation">.</span>testCollection<span class="token punctuation">.</span>insertOne<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>x:1<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  acknowledged: true<span class="token punctuation">,</span>
  insertedId: ObjectId<span class="token punctuation">(</span><span class="token string">"63f884d67b9fcb1f8bf84df1"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="22__95"></a>2.2 批量新增文档</h3> 
<pre><code class="prism language-powershell">db<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>insertMany<span class="token punctuation">(</span>
   <span class="token punctuation">[</span> &lt;document 1&gt; <span class="token punctuation">,</span> &lt;document 2&gt;<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">{<!-- --></span>
      writeConcern: &lt;document&gt;<span class="token punctuation">,</span>
      ordered: &lt;boolean&gt;
   <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          参数说明： 
         
        
       
      
        \color{red}{参数说明：} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">参数说明：</span></span></span></span></span></span></p> 
<ul><li>document：要写入的文档。</li><li>writeConcern：写入策略，默认为 1，即要求确认写操作，0 是不要求。</li><li>ordered：指定是否按顺序写入，默认 true，按顺序写入。</li></ul> 
<p><strong>测试：批量插入100条随机数据</strong></p> 
<p>编辑脚本testCollection.js</p> 
<pre><code class="prism language-js"><span class="token keyword">var</span> tags <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"nosql"</span><span class="token punctuation">,</span><span class="token string">"mongodb"</span><span class="token punctuation">,</span><span class="token string">"document"</span><span class="token punctuation">,</span><span class="token string">"developer"</span><span class="token punctuation">,</span><span class="token string">"popular"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> types <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"technology"</span><span class="token punctuation">,</span><span class="token string">"sociality"</span><span class="token punctuation">,</span><span class="token string">"travel"</span><span class="token punctuation">,</span><span class="token string">"novel"</span><span class="token punctuation">,</span><span class="token string">"literature"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> books<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">100</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> typeIdx <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span>types<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> tagIdx <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span>tags<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> favCount <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> book <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">"book-"</span><span class="token operator">+</span>i<span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> types<span class="token punctuation">[</span>typeIdx<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">tag</span><span class="token operator">:</span> tags<span class="token punctuation">[</span>tagIdx<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">favCount</span><span class="token operator">:</span> favCount<span class="token punctuation">,</span>
        <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token string">"xxw"</span><span class="token operator">+</span>i
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    books<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>book<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
db<span class="token punctuation">.</span>testCollection<span class="token punctuation">.</span><span class="token function">insertMany</span><span class="token punctuation">(</span>books<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>进入mongo shell，执行</p> 
<pre><code class="prism language-powershell">load<span class="token punctuation">(</span><span class="token string">"testCollection.js"</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="3_141"></a>3、查询文档</h2> 
<p>MongoDB 查询数据的语法格式如下：</p> 
<pre><code class="prism language-js">db<span class="token punctuation">.</span>collection<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> projection<span class="token punctuation">)</span>
<span class="token comment">//findOne查询集合中的第一个文档</span>
db<span class="token punctuation">.</span>collection<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> projection<span class="token punctuation">)</span>
</code></pre> 
<ul><li>query ：可选，使用查询操作符指定查询条件</li><li>projection ：可选，使用投影操作符指定返回的键。查询时返回文档中所有键值， 只需省略该参数即可（默认省略）。</li></ul> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
         
         
           投影时， 
          
         
           _ 
          
         
           i 
          
         
           d 
          
         
           为 
          
         
           1 
          
         
           的时候，其他字段必须是 
          
         
           1 
          
         
        
       
      
        \color{red}{投影时，\_id为1的时候，其他字段必须是1} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0044em; vertical-align: -0.31em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">投影时，</span><span class="mord" style="margin-right: 0.0278em; color: red;">_</span><span class="mord mathnormal" style="color: red;">i</span><span class="mord mathnormal" style="color: red;">d</span><span class="mord cjk_fallback" style="color: red;">为</span><span class="mord" style="color: red;">1</span><span class="mord cjk_fallback" style="color: red;">的时候，其他字段必须是</span><span class="mord" style="color: red;">1</span></span></span></span></span></span><br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
         
         
           _ 
          
         
           i 
          
         
           d 
          
         
           是 
          
         
           0 
          
         
           的时候，其他字段可以是 
          
         
           0 
          
         
        
       
      
        \color{red}{ \_id是0的时候，其他字段可以是0} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0044em; vertical-align: -0.31em;"></span><span class="mord" style="color: red;"><span class="mord" style="margin-right: 0.0278em; color: red;">_</span><span class="mord mathnormal" style="color: red;">i</span><span class="mord mathnormal" style="color: red;">d</span><span class="mord cjk_fallback" style="color: red;">是</span><span class="mord" style="color: red;">0</span><span class="mord cjk_fallback" style="color: red;">的时候，其他字段可以是</span><span class="mord" style="color: red;">0</span></span></span></span></span></span><br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
         
         
           如果没有 
          
         
           _ 
          
         
           i 
          
         
           d 
          
         
           字段约束，多个其他字段必须同为 
          
         
           0 
          
         
           或同为 
          
         
           1 
          
         
        
       
      
        \color{red}{ 如果没有\_id字段约束，多个其他字段必须同为0或同为1} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0044em; vertical-align: -0.31em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">如果没有</span><span class="mord" style="margin-right: 0.0278em; color: red;">_</span><span class="mord mathnormal" style="color: red;">i</span><span class="mord mathnormal" style="color: red;">d</span><span class="mord cjk_fallback" style="color: red;">字段约束，多个其他字段必须同为</span><span class="mord" style="color: red;">0</span><span class="mord cjk_fallback" style="color: red;">或同为</span><span class="mord" style="color: red;">1</span></span></span></span></span></span></p> 
<p><img src="https://images2.imgbox.com/cf/d2/SG1JXDZ4_o.png" alt="在这里插入图片描述"><br> <strong>如果查询返回的条目数量较多，mongo shell则会自动实现分批显示。默认情况下每次只显示20条，可以输入it命令读取下一批</strong></p> 
<p>如果你需要以易读的方式来读取数据，可以使用 pretty() 方法，语法格式如下：</p> 
<pre><code class="prism language-js">db<span class="token punctuation">.</span>collection<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pretty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>pretty() 方法以格式化的方式来显示所有文档</p> 
<h3><a id="31__168"></a>3.1 条件查询</h3> 
<h4><a id="311_MongoDB__SQL___169"></a>3.1.1 MongoDB 与 SQL 语法区分</h4> 
<p><strong>MongoDB 与 RDBMS Where 语句比较</strong></p> 
<table><thead><tr><th align="left">操作</th><th align="left">格式</th><th align="left">范例</th><th align="left">RDBMS中类似语句</th></tr></thead><tbody><tr><td align="left">等于</td><td align="left">{&lt;key&gt;:&lt;value&gt;}</td><td align="left">db.testCollection.find({“title”:“book-18”}).pretty()</td><td align="left">where title = “book-18”</td></tr><tr><td align="left">小于</td><td align="left">{&lt;key&gt;:{$lt:&lt;value&gt;}}</td><td align="left">db.testCollection.find({“favCount”:{$lt:2}}).pretty()</td><td align="left">where favCount &lt; 2</td></tr><tr><td align="left">小于等于</td><td align="left">{&lt;key&gt;:{$lte:&lt;value&gt;}}</td><td align="left">db.testCollection.find({“favCount”:{$lte:2}}).pretty()</td><td align="left">where favCount &lt;= 2</td></tr><tr><td align="left">大于</td><td align="left">{&lt;key&gt;:{$gt:&lt;value&gt;}}</td><td align="left">db.testCollection.find({“favCount”:{$gt:2}}).pretty()</td><td align="left">where favCount &gt; 2</td></tr><tr><td align="left">大于等于</td><td align="left">{&lt;key&gt;:{$gte:&lt;value&gt;}}</td><td align="left">db.testCollection.find({“favCount”:{$gte:6}}).pretty()</td><td align="left">where favCount &gt;= 6</td></tr><tr><td align="left">不等于</td><td align="left">{&lt;key&gt;:{$ne:&lt;value&gt;}}</td><td align="left">db.testCollection.find({“favCount”:{$ne:6}}).pretty()</td><td align="left">where favCount != 6</td></tr></tbody></table> 
<p><strong>查询逻辑对照表</strong></p> 
<table><thead><tr><th align="left">SQL</th><th align="left">MQL</th></tr></thead><tbody><tr><td align="left">a=1 and b=1</td><td align="left">{a:1,b:1} 或者 {$and:[{a:1},{b:1}]}</td></tr><tr><td align="left">a=2 or b=3</td><td align="left">{$or:[{a:2},{b:3}]}</td></tr><tr><td align="left">a is null</td><td align="left">{a:{$exists:false}}</td></tr><tr><td align="left">a in (3,2,1)</td><td align="left">{a:$in:[1,2,3]}</td></tr></tbody></table> 
<p><strong>查询逻辑运算符</strong></p> 
<ul><li>$lt: 存在并小于</li><li>$lte: 存在并小于等于</li><li>$gt: 存在并大于</li><li>$gte: 存在并大于等于</li><li>$ne: 不存在或存在但不等于</li><li>$in: 存在并在指定数组中</li><li>$nin: 不存在或不在指定数组中</li><li>$or: 匹配两个或多个条件中的一个</li><li>$and: 匹配全部条件</li></ul> 
<h4><a id="312_MongoDB__200"></a>3.1.2 MongoDB 查询实例</h4> 
<p><strong>MongoDB AND 条件</strong></p> 
<pre><code class="prism language-js">db<span class="token punctuation">.</span>col<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">key1</span><span class="token operator">:</span>value1<span class="token punctuation">,</span> <span class="token literal-property property">key2</span><span class="token operator">:</span>value2<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pretty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>MongoDB OR 条件</strong></p> 
<pre><code class="prism language-js">db<span class="token punctuation">.</span>col<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>
   <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">$or</span><span class="token operator">:</span> <span class="token punctuation">[</span>
         <span class="token punctuation">{<!-- --></span><span class="token literal-property property">key1</span><span class="token operator">:</span> value1<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token literal-property property">key2</span><span class="token operator">:</span>value2<span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pretty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>AND 和 OR 联合使用</strong><br> 以下实例演示了 AND 和 OR 联合使用，类似常规 SQL 语句为： ’ title = “book-18” AND (favCount &lt;10 OR favCount != 6)’</p> 
<pre><code class="prism language-js">db<span class="token punctuation">.</span>testCollection<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
<span class="token string-property property">"title"</span><span class="token operator">:</span><span class="token string">"book-18"</span><span class="token punctuation">,</span>
<span class="token literal-property property">$or</span><span class="token operator">:</span><span class="token punctuation">[</span>
<span class="token punctuation">{<!-- --></span><span class="token string-property property">"favCount"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$lte</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{<!-- --></span><span class="token string-property property">"favCount"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$ne</span><span class="token operator">:</span><span class="token number">6</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pretty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-powershell">testdb&gt; db<span class="token punctuation">.</span>testCollection<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token string">"title"</span>:<span class="token string">"book-18"</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token variable">$or</span>:<span class="token punctuation">[</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">{<!-- --></span><span class="token string">"favCount"</span>:<span class="token punctuation">{<!-- --></span><span class="token variable">$lte</span>:10<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">{<!-- --></span><span class="token string">"favCount"</span>:<span class="token punctuation">{<!-- --></span><span class="token variable">$ne</span>:6<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">]</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>pretty<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>
  <span class="token punctuation">{<!-- --></span>
    _id: ObjectId<span class="token punctuation">(</span><span class="token string">"63f88c0b7b9fcb1f8bf84e04"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    title: <span class="token string">'book-18'</span><span class="token punctuation">,</span>
    <span class="token function">type</span>: <span class="token string">'technology'</span><span class="token punctuation">,</span>
    tag: <span class="token string">'document'</span><span class="token punctuation">,</span>
    favCount: 52<span class="token punctuation">,</span>
    author: <span class="token string">'xxw18'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> 
<h4><a id="312_MongoDB_LimitsortSkip_250"></a>3.1.2 MongoDB 排序与分页（Limit、sort与Skip方法）</h4> 
<ul><li>如果你需要在MongoDB中读取指定数量的数据记录，可以使用MongoDB的Limit方法，limit()方法接受一个数字参数，该参数指定从MongoDB中读取的记录条数</li></ul> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
         
         
           注：如果没有指定 
          
         
           l 
          
         
           i 
          
         
           m 
          
         
           i 
          
         
           t 
          
         
           ( 
          
         
           ) 
          
         
           方法中的参数则显示集合中的所有数据 
          
         
        
       
      
        \color{red}{注：如果没有指定limit()方法中的参数则显示集合中的所有数据} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">注：如果没有指定</span><span class="mord mathnormal" style="margin-right: 0.0197em; color: red;">l</span><span class="mord mathnormal" style="color: red;">imi</span><span class="mord mathnormal" style="color: red;">t</span><span class="mopen" style="color: red;">(</span><span class="mclose" style="color: red;">)</span><span class="mord cjk_fallback" style="color: red;">方法中的参数则显示集合中的所有数据</span></span></span></span></span></span></p> 
<pre><code class="prism language-js">db<span class="token punctuation">.</span><span class="token constant">COLLECTION_NAME</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token constant">NUMBER</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li>我们除了可以使用limit()方法来读取指定数量的数据外，还可以使用skip()方法来跳过指定数量的数据，skip方法同样接受一个数字参数作为跳过的记录条数</li></ul> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
         
         
           注 
          
         
           : 
          
         
           s 
          
         
           k 
          
         
           i 
          
         
           p 
          
         
           ( 
          
         
           ) 
          
         
           方法默认参数为 
          
         
           0 
          
         
        
       
      
        \color{red}{ 注:skip()方法默认参数为 0} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">注</span><span class="mspace" style="color: red; margin-right: 0.2778em;"></span><span class="mrel" style="color: red;">:</span><span class="mspace" style="color: red; margin-right: 0.2778em;"></span><span class="mord mathnormal" style="color: red;">s</span><span class="mord mathnormal" style="color: red;">ki</span><span class="mord mathnormal" style="color: red;">p</span><span class="mopen" style="color: red;">(</span><span class="mclose" style="color: red;">)</span><span class="mord cjk_fallback" style="color: red;">方法默认参数为</span><span class="mord" style="color: red;">0</span></span></span></span></span></span></p> 
<pre><code class="prism language-js">db<span class="token punctuation">.</span><span class="token constant">COLLECTION_NAME</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token constant">NUMBER</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span><span class="token constant">NUMBER</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-powershell">testdb&gt; db<span class="token punctuation">.</span>testCollection<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"favCount"</span>:<span class="token punctuation">{<!-- --></span><span class="token variable">$lte</span>:200<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>limit<span class="token punctuation">(</span>1<span class="token punctuation">)</span><span class="token punctuation">.</span>skip<span class="token punctuation">(</span>1<span class="token punctuation">)</span><span class="token punctuation">.</span>pretty<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>
  <span class="token punctuation">{<!-- --></span>
    _id: ObjectId<span class="token punctuation">(</span><span class="token string">"63f88c0b7b9fcb1f8bf84df3"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    title: <span class="token string">'book-1'</span><span class="token punctuation">,</span>
    <span class="token function">type</span>: <span class="token string">'novel'</span><span class="token punctuation">,</span>
    tag: <span class="token string">'mongodb'</span><span class="token punctuation">,</span>
    favCount: 20<span class="token punctuation">,</span>
    author: <span class="token string">'xxw1'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> 
<ul><li>在 MongoDB 中使用 sort() 方法对数据进行排序，sort() 方法可以通过参数指定排序的字段，并使用 1 和 -1 来指定排序的方式，其中 1 为升序排列，而 -1 是用于降序排列</li></ul> 
<pre><code class="prism language-js">db<span class="token punctuation">.</span><span class="token constant">COLLECTION_NAME</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token constant">KEY</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-powershell">testdb&gt; db<span class="token punctuation">.</span>testCollection<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"favCount"</span>:<span class="token punctuation">{<!-- --></span><span class="token variable">$lte</span>:200<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>limit<span class="token punctuation">(</span>3<span class="token punctuation">)</span><span class="token punctuation">.</span>skip<span class="token punctuation">(</span>1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"favCount"</span>:1<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>pretty<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>
  <span class="token punctuation">{<!-- --></span>
    _id: ObjectId<span class="token punctuation">(</span><span class="token string">"63f88c0b7b9fcb1f8bf84e0f"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    title: <span class="token string">'book-29'</span><span class="token punctuation">,</span>
    <span class="token function">type</span>: <span class="token string">'sociality'</span><span class="token punctuation">,</span>
    tag: <span class="token string">'developer'</span><span class="token punctuation">,</span>
    favCount: 6<span class="token punctuation">,</span>
    author: <span class="token string">'xxw29'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    _id: ObjectId<span class="token punctuation">(</span><span class="token string">"63f88c0b7b9fcb1f8bf84df7"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    title: <span class="token string">'book-5'</span><span class="token punctuation">,</span>
    <span class="token function">type</span>: <span class="token string">'sociality'</span><span class="token punctuation">,</span>
    tag: <span class="token string">'mongodb'</span><span class="token punctuation">,</span>
    favCount: 11<span class="token punctuation">,</span>
    author: <span class="token string">'xxw5'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    _id: ObjectId<span class="token punctuation">(</span><span class="token string">"63f88c0b7b9fcb1f8bf84e08"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    title: <span class="token string">'book-22'</span><span class="token punctuation">,</span>
    <span class="token function">type</span>: <span class="token string">'novel'</span><span class="token punctuation">,</span>
    tag: <span class="token string">'nosql'</span><span class="token punctuation">,</span>
    favCount: 12<span class="token punctuation">,</span>
    author: <span class="token string">'xxw22'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> 
<h4><a id="313__314"></a>3.1.3 分页问题的处理</h4> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
         
         
           数据量大的时候，应该避免使用 
          
         
           s 
          
         
           k 
          
         
           i 
          
         
           p 
          
         
           / 
          
         
           l 
          
         
           i 
          
         
           m 
          
         
           i 
          
         
           t 
          
         
           形式的分页 
          
         
        
       
      
        \color{red}{ 数据量大的时候，应该避免使用skip/limit形式的分页} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">数据量大的时候，应该避免使用</span><span class="mord mathnormal" style="color: red;">s</span><span class="mord mathnormal" style="color: red;">ki</span><span class="mord mathnormal" style="color: red;">p</span><span class="mord" style="color: red;">/</span><span class="mord mathnormal" style="margin-right: 0.0197em; color: red;">l</span><span class="mord mathnormal" style="color: red;">imi</span><span class="mord mathnormal" style="color: red;">t</span><span class="mord cjk_fallback" style="color: red;">形式的分页</span></span></span></span></span></span><br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
         
         
           替代方案：使用查询条件 
          
         
           + 
          
         
           唯一排序条件 
          
         
        
       
      
        \color{red}{ 替代方案：使用查询条件+唯一排序条件} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.7667em; vertical-align: -0.0833em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">替代方案：使用查询条件</span><span class="mspace" style="color: red; margin-right: 0.2222em;"></span><span class="mbin" style="color: red;">+</span><span class="mspace" style="color: red; margin-right: 0.2222em;"></span><span class="mord cjk_fallback" style="color: red;">唯一排序条件</span></span></span></span></span></span></p> 
<p>第一页：db.testCollection.find({}).sort({_id: 1}).limit(20);<br> 第二页：db.testCollection.find({_id: {<!-- --><span class="katex--inline">KaTeX parse error: Expected 'EOF', got '}' at position 17: …t: &lt;第一页最后一个_id&gt;}̲}).sort({_id: 1…</span>gt: &lt;第二页最后一个_id&gt;}}).sort({_id: 1}).limit(20);</p> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
         
         
           处理分页问题–避免使用 
          
         
           c 
          
         
           o 
          
         
           u 
          
         
           n 
          
         
           t 
          
         
        
       
      
        \color{red}{ 处理分页问题 – 避免使用 count } 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">处理分页问题</span><span class="mord" style="color: red;">–</span><span class="mord cjk_fallback" style="color: red;">避免使用</span><span class="mord mathnormal" style="color: red;">co</span><span class="mord mathnormal" style="color: red;">u</span><span class="mord mathnormal" style="color: red;">n</span><span class="mord mathnormal" style="color: red;">t</span></span></span></span></span></span><br> 尽可能不要计算总页数，特别是数据量大和查询条件不能完整命中索引时。<br> 考虑以下场景：假设集合总共有 1000w 条数据，在没有索引的情况下考虑以下查询：</p> 
<pre><code class="prism language-js"><span class="token comment">//只需要遍历前 n 条，直到找到 50 条 x=100 的文档即可结束</span>
db<span class="token punctuation">.</span>testCollection<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 需要遍历完 1000w 条找到所有符合要求的文档才能得到结果。 为了计算总页数而进行的 count() 往往是拖慢页面整体加载速度的原因</span>
db<span class="token punctuation">.</span>testCollection<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="314__334"></a>3.1.4 正则表达式匹配查询</h4> 
<p><strong>MongoDB 使用 $regex 操作符来设置匹配字符串的正则表达式</strong></p> 
<pre><code class="prism language-js"><span class="token comment">//使用正则表达式查找type包含 so 字符串的book</span>
db<span class="token punctuation">.</span>col<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$regex</span><span class="token operator">:</span><span class="token string">"so"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//或者</span>
db<span class="token punctuation">.</span>col<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">so</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="4_344"></a>4、更新文档</h2> 
<p>可以用update命令对指定的数据进行更新，命令的格式如下：</p> 
<pre><code class="prism language-js">db<span class="token punctuation">.</span>collection<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span>update<span class="token punctuation">,</span>options<span class="token punctuation">)</span>
</code></pre> 
<ul><li>query：描述更新的查询条件；</li><li>update：描述更新的动作及新的内容；</li><li>options：描述更新的选项 
  <ul><li>upsert: 可选，如果不存在update的记录，是否插入新的记录。默认false，不插入</li><li>multi: 可选，是否按条件查询出的多条记录全部更新。 默认false,只更新找到的第一条记录</li><li>writeConcern :可选，决定一个写操作落到多少个节点上才算成功。</li></ul> </li></ul> 
<h3><a id="41__356"></a>4.1 更新操作符</h3> 
<table><thead><tr><th align="left">操作符</th><th align="left">格式</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left">$set</td><td align="left">{$set:{filed:value}}</td><td align="left">指定一个键并更新值，若键不存在则创建</td></tr><tr><td align="left">$unset</td><td align="left">{$unset:{filed:value}}</td><td align="left">删除一个键</td></tr><tr><td align="left">$inc</td><td align="left">{$inc:{f:v}}</td><td align="left">对数值类型进行增减</td></tr><tr><td align="left">$rname</td><td align="left">{$rname:{old_f_name:new_f_name}}</td><td align="left">修改字段名</td></tr><tr><td align="left">$push</td><td align="left">{$push:{f:v}}</td><td align="left">将数值追加到数组中，若数组不存在则会进行初始化</td></tr><tr><td align="left">$pushAll</td><td align="left">{$pushAll:{f:v}}</td><td align="left">追加多个值到一个数组字段内</td></tr><tr><td align="left">$pull</td><td align="left">{$pull:{f:_v}}</td><td align="left">从数组中删除指定元素</td></tr><tr><td align="left">$addToSet</td><td align="left">{$addToSet:{f:v}}</td><td align="left">添加元素到数组中，具有排重功能</td></tr><tr><td align="left">$pop</td><td align="left">{$pop:{filed:1}}</td><td align="left">删除数组的第一个或最后一个元素</td></tr></tbody></table> 
<h4><a id="411__369"></a>4.1.1 更新单个文档</h4> 
<p>文档的favCount字段自增</p> 
<pre><code class="prism language-js">testdb<span class="token operator">&gt;</span> db<span class="token punctuation">.</span>testCollection<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">_id</span><span class="token operator">:</span><span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">"63f88c0b7b9fcb1f8bf84e08"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$inc</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">favCount</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token literal-property property">DeprecationWarning</span><span class="token operator">:</span> Collection<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> is deprecated<span class="token punctuation">.</span> Use updateOne<span class="token punctuation">,</span> updateMany<span class="token punctuation">,</span> or bulkWrite<span class="token punctuation">.</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">acknowledged</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">insertedId</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">matchedCount</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token literal-property property">modifiedCount</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token literal-property property">upsertedCount</span><span class="token operator">:</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>DeprecationWarning: Collection.update() is deprecated. Use updateOne, updateMany, or bulkWrite.</strong><br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
         
         
           u 
          
         
           p 
          
         
           d 
          
         
           a 
          
         
           t 
          
         
           e 
          
         
           方法已被过时，请使用： 
          
         
           u 
          
         
           p 
          
         
           d 
          
         
           a 
          
         
           t 
          
         
           e 
          
         
           O 
          
         
           n 
          
         
           e 
          
         
           ， 
          
         
           u 
          
         
           p 
          
         
           d 
          
         
           a 
          
         
           t 
          
         
           e 
          
         
           M 
          
         
           a 
          
         
           n 
          
         
           y 
          
         
           或 
          
         
           b 
          
         
           u 
          
         
           l 
          
         
           k 
          
         
           W 
          
         
           r 
          
         
           i 
          
         
           t 
          
         
           e 
          
         
        
       
      
        \color{red}{ update方法已被过时，请使用：updateOne，updateMany 或 bulkWrite} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord" style="color: red;"><span class="mord mathnormal" style="color: red;">u</span><span class="mord mathnormal" style="color: red;">p</span><span class="mord mathnormal" style="color: red;">d</span><span class="mord mathnormal" style="color: red;">a</span><span class="mord mathnormal" style="color: red;">t</span><span class="mord mathnormal" style="color: red;">e</span><span class="mord cjk_fallback" style="color: red;">方法已被过时，请使用：</span><span class="mord mathnormal" style="color: red;">u</span><span class="mord mathnormal" style="color: red;">p</span><span class="mord mathnormal" style="color: red;">d</span><span class="mord mathnormal" style="color: red;">a</span><span class="mord mathnormal" style="color: red;">t</span><span class="mord mathnormal" style="color: red;">e</span><span class="mord mathnormal" style="margin-right: 0.0278em; color: red;">O</span><span class="mord mathnormal" style="color: red;">n</span><span class="mord mathnormal" style="color: red;">e</span><span class="mord cjk_fallback" style="color: red;">，</span><span class="mord mathnormal" style="color: red;">u</span><span class="mord mathnormal" style="color: red;">p</span><span class="mord mathnormal" style="color: red;">d</span><span class="mord mathnormal" style="color: red;">a</span><span class="mord mathnormal" style="color: red;">t</span><span class="mord mathnormal" style="color: red;">e</span><span class="mord mathnormal" style="margin-right: 0.109em; color: red;">M</span><span class="mord mathnormal" style="color: red;">an</span><span class="mord mathnormal" style="margin-right: 0.0359em; color: red;">y</span><span class="mord cjk_fallback" style="color: red;">或</span><span class="mord mathnormal" style="color: red;">b</span><span class="mord mathnormal" style="color: red;">u</span><span class="mord mathnormal" style="margin-right: 0.0197em; color: red;">l</span><span class="mord mathnormal" style="margin-right: 0.1389em; color: red;">kW</span><span class="mord mathnormal" style="margin-right: 0.0278em; color: red;">r</span><span class="mord mathnormal" style="color: red;">i</span><span class="mord mathnormal" style="color: red;">t</span><span class="mord mathnormal" style="color: red;">e</span></span></span></span></span></span></p> 
<pre><code class="prism language-js">testdb<span class="token operator">&gt;</span> db<span class="token punctuation">.</span>testCollection<span class="token punctuation">.</span><span class="token function">updateOne</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">_id</span><span class="token operator">:</span><span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">"63f88c0b7b9fcb1f8bf84e08"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$inc</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">favCount</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">acknowledged</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">insertedId</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">matchedCount</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token literal-property property">modifiedCount</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token literal-property property">upsertedCount</span><span class="token operator">:</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="412__396"></a>4.1.2 更新多个文档</h4> 
<p>默认情况下，update命令只在更新第一个文档之后返回，如果需要更新多个文档，则可以使用multi选项。<br> 将分类为“novel”的文档的增加发布时间（publishedDate）</p> 
<pre><code class="prism language-powershell">db<span class="token punctuation">.</span>testCollection<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token function">type</span>:<span class="token string">"novel"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token variable">$set</span>:<span class="token punctuation">{<!-- --></span>publishedDate:new Date<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token string">"multi"</span>:true<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
         
         
           m 
          
         
           u 
          
         
           l 
          
         
           t 
          
         
           i 
          
         
           : 
          
         
           可选， 
          
         
           m 
          
         
           o 
          
         
           n 
          
         
           g 
          
         
           o 
          
         
           d 
          
         
           b 
          
         
           默认是 
          
         
           f 
          
         
           a 
          
         
           l 
          
         
           s 
          
         
           e 
          
         
           , 
          
         
           只更新找到的第一条记录，如果这个参数为 
          
         
           t 
          
         
           r 
          
         
           u 
          
         
           e 
          
         
           , 
          
         
           就把按条件查出来多条记录全部更新 
          
         
        
       
      
        \color{red}{ multi : 可选，mongodb 默认是false,只更新找到的第一条记录，如果这个参数为true,就把按条件查出来多条记录全部更新} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord" style="color: red;"><span class="mord mathnormal" style="color: red;">m</span><span class="mord mathnormal" style="color: red;">u</span><span class="mord mathnormal" style="color: red;">lt</span><span class="mord mathnormal" style="color: red;">i</span><span class="mspace" style="color: red; margin-right: 0.2778em;"></span><span class="mrel" style="color: red;">:</span><span class="mspace" style="color: red; margin-right: 0.2778em;"></span><span class="mord cjk_fallback" style="color: red;">可选，</span><span class="mord mathnormal" style="color: red;">m</span><span class="mord mathnormal" style="color: red;">o</span><span class="mord mathnormal" style="color: red;">n</span><span class="mord mathnormal" style="margin-right: 0.0359em; color: red;">g</span><span class="mord mathnormal" style="color: red;">o</span><span class="mord mathnormal" style="color: red;">d</span><span class="mord mathnormal" style="color: red;">b</span><span class="mord cjk_fallback" style="color: red;">默认是</span><span class="mord mathnormal" style="margin-right: 0.1076em; color: red;">f</span><span class="mord mathnormal" style="color: red;">a</span><span class="mord mathnormal" style="margin-right: 0.0197em; color: red;">l</span><span class="mord mathnormal" style="color: red;">se</span><span class="mpunct" style="color: red;">,</span><span class="mspace" style="color: red; margin-right: 0.1667em;"></span><span class="mord cjk_fallback" style="color: red;">只更新找到的第一条记录，如果这个参数为</span><span class="mord mathnormal" style="color: red;">t</span><span class="mord mathnormal" style="margin-right: 0.0278em; color: red;">r</span><span class="mord mathnormal" style="color: red;">u</span><span class="mord mathnormal" style="color: red;">e</span><span class="mpunct" style="color: red;">,</span><span class="mspace" style="color: red; margin-right: 0.1667em;"></span><span class="mord cjk_fallback" style="color: red;">就把按条件查出来多条记录全部更新</span></span></span></span></span></span></p> 
<p><strong>update命令的选项配置较多，为了简化使用还可以使用一些快捷命令:</strong></p> 
<ul><li>updateOne：更新单个文档。</li><li>updateMany：更新多个文档。</li><li>replaceOne：替换单个文档。</li></ul> 
<h4><a id="413_upsert_409"></a>4.1.3 使用upsert命令</h4> 
<p><strong>upsert是一种特殊的更新，其表现为如果目标文档不存在，则执行插入命令</strong></p> 
<pre><code class="prism language-js">testdb<span class="token operator">&gt;</span> db<span class="token punctuation">.</span>testCollection<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>
<span class="token operator">...</span>     <span class="token punctuation">{<!-- --></span><span class="token literal-property property">title</span><span class="token operator">:</span><span class="token string">"my book"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token operator">...</span>     <span class="token punctuation">{<!-- --></span><span class="token literal-property property">$set</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">tags</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">"nosql"</span><span class="token punctuation">,</span><span class="token string">"mongodb"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token string">"none"</span><span class="token punctuation">,</span><span class="token literal-property property">author</span><span class="token operator">:</span><span class="token string">"xxx"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token operator">...</span>     <span class="token punctuation">{<!-- --></span><span class="token literal-property property">upsert</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span>
<span class="token operator">...</span> <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">acknowledged</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">insertedId</span><span class="token operator">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">"63f8e4bb605acd95f5b3ffcd"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">matchedCount</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token literal-property property">modifiedCount</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token literal-property property">upsertedCount</span><span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
         
         
           m 
          
         
           a 
          
         
           t 
          
         
           c 
          
         
           h 
          
         
           e 
          
         
           d 
          
         
           C 
          
         
           o 
          
         
           u 
          
         
           n 
          
         
           t 
          
         
           、 
          
         
           m 
          
         
           o 
          
         
           d 
          
         
           i 
          
         
           f 
          
         
           i 
          
         
           e 
          
         
           d 
          
         
           C 
          
         
           o 
          
         
           u 
          
         
           n 
          
         
           t 
          
         
           都为 
          
         
           0 
          
         
           ，表示没有文档被匹配及更新， 
          
         
           u 
          
         
           p 
          
         
           s 
          
         
           e 
          
         
           r 
          
         
           t 
          
         
           e 
          
         
           d 
          
         
           C 
          
         
           o 
          
         
           u 
          
         
           n 
          
         
           t 
          
         
           = 
          
         
           1 
          
         
           提示执行了 
          
         
           u 
          
         
           p 
          
         
           s 
          
         
           e 
          
         
           r 
          
         
           t 
          
         
           动作 
          
         
        
       
      
        \color{red}{matchedCount、modifiedCount都为0，表示没有文档被匹配及更新，upsertedCount=1提示执行了upsert动作} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord" style="color: red;"><span class="mord mathnormal" style="color: red;">ma</span><span class="mord mathnormal" style="color: red;">t</span><span class="mord mathnormal" style="color: red;">c</span><span class="mord mathnormal" style="color: red;">h</span><span class="mord mathnormal" style="color: red;">e</span><span class="mord mathnormal" style="color: red;">d</span><span class="mord mathnormal" style="margin-right: 0.0715em; color: red;">C</span><span class="mord mathnormal" style="color: red;">o</span><span class="mord mathnormal" style="color: red;">u</span><span class="mord mathnormal" style="color: red;">n</span><span class="mord mathnormal" style="color: red;">t</span><span class="mord cjk_fallback" style="color: red;">、</span><span class="mord mathnormal" style="color: red;">m</span><span class="mord mathnormal" style="color: red;">o</span><span class="mord mathnormal" style="color: red;">d</span><span class="mord mathnormal" style="color: red;">i</span><span class="mord mathnormal" style="margin-right: 0.1076em; color: red;">f</span><span class="mord mathnormal" style="color: red;">i</span><span class="mord mathnormal" style="color: red;">e</span><span class="mord mathnormal" style="color: red;">d</span><span class="mord mathnormal" style="margin-right: 0.0715em; color: red;">C</span><span class="mord mathnormal" style="color: red;">o</span><span class="mord mathnormal" style="color: red;">u</span><span class="mord mathnormal" style="color: red;">n</span><span class="mord mathnormal" style="color: red;">t</span><span class="mord cjk_fallback" style="color: red;">都为</span><span class="mord" style="color: red;">0</span><span class="mord cjk_fallback" style="color: red;">，表示没有文档被匹配及更新，</span><span class="mord mathnormal" style="color: red;">u</span><span class="mord mathnormal" style="color: red;">p</span><span class="mord mathnormal" style="margin-right: 0.0278em; color: red;">ser</span><span class="mord mathnormal" style="color: red;">t</span><span class="mord mathnormal" style="color: red;">e</span><span class="mord mathnormal" style="color: red;">d</span><span class="mord mathnormal" style="margin-right: 0.0715em; color: red;">C</span><span class="mord mathnormal" style="color: red;">o</span><span class="mord mathnormal" style="color: red;">u</span><span class="mord mathnormal" style="color: red;">n</span><span class="mord mathnormal" style="color: red;">t</span><span class="mspace" style="color: red; margin-right: 0.2778em;"></span><span class="mrel" style="color: red;">=</span><span class="mspace" style="color: red; margin-right: 0.2778em;"></span><span class="mord" style="color: red;">1</span><span class="mord cjk_fallback" style="color: red;">提示执行了</span><span class="mord mathnormal" style="color: red;">u</span><span class="mord mathnormal" style="color: red;">p</span><span class="mord mathnormal" style="margin-right: 0.0278em; color: red;">ser</span><span class="mord mathnormal" style="color: red;">t</span><span class="mord cjk_fallback" style="color: red;">动作</span></span></span></span></span></span></p> 
<h4><a id="414_findAndModify_429"></a>4.1.4 findAndModify命令</h4> 
<p><strong>findAndModify兼容了查询和修改指定文档的功能，findAndModify只能更新单个文档</strong></p> 
<pre><code class="prism language-js"><span class="token comment">//将某个book文档的收藏数（favCount）加1</span>
db<span class="token punctuation">.</span>testCollection<span class="token punctuation">.</span><span class="token function">findAndModify</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">query</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">_id</span><span class="token operator">:</span><span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">"63f8e4bb605acd95f5b3ffcd"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">update</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$inc</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">favCount</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//该操作会返回符合查询条件的文档数据，并完成对文档的修改。</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">"63f8e4bb605acd95f5b3ffcd"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'my book'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token string">'xxx'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">tags</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">'nosql'</span><span class="token punctuation">,</span> <span class="token string">'mongodb'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'none'</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
         
         
           默认情况下， 
          
         
           f 
          
         
           i 
          
         
           n 
          
         
           d 
          
         
           A 
          
         
           n 
          
         
           d 
          
         
           M 
          
         
           o 
          
         
           d 
          
         
           i 
          
         
           f 
          
         
           y 
          
         
           会返回修改前的“旧”数据。 
          
         
        
       
      
        \color{red}{默认情况下，findAndModify会返回修改前的“旧”数据。} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">默认情况下，</span><span class="mord mathnormal" style="margin-right: 0.1076em; color: red;">f</span><span class="mord mathnormal" style="color: red;">in</span><span class="mord mathnormal" style="color: red;">d</span><span class="mord mathnormal" style="color: red;">A</span><span class="mord mathnormal" style="color: red;">n</span><span class="mord mathnormal" style="color: red;">d</span><span class="mord mathnormal" style="margin-right: 0.109em; color: red;">M</span><span class="mord mathnormal" style="color: red;">o</span><span class="mord mathnormal" style="color: red;">d</span><span class="mord mathnormal" style="color: red;">i</span><span class="mord mathnormal" style="margin-right: 0.1076em; color: red;">f</span><span class="mord mathnormal" style="margin-right: 0.0359em; color: red;">y</span><span class="mord cjk_fallback" style="color: red;">会返回修改前的</span><span class="mord" style="color: red;">“</span><span class="mord cjk_fallback" style="color: red;">旧</span><span class="mord" style="color: red;">”</span><span class="mord cjk_fallback" style="color: red;">数据。</span></span></span></span></span></span><br> 如果希望返回修改后的数据，则可以指定new选项</p> 
<pre><code class="prism language-js">db<span class="token punctuation">.</span>testCollection<span class="token punctuation">.</span><span class="token function">findAndModify</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">query</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">_id</span><span class="token operator">:</span><span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">"63f8e4bb605acd95f5b3ffcd"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">update</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$inc</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">favCount</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span><span class="token operator">:</span><span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">"63f8e4bb605acd95f5b3ffcd"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'my book'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token string">'xxx'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">tags</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">'nosql'</span><span class="token punctuation">,</span> <span class="token string">'mongodb'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'none'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">favCount</span><span class="token operator">:</span> <span class="token number">2</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>与findAndModify语义相近的命令如下：</strong></p> 
<ul><li>findOneAndUpdate：更新单个文档并返回更新前（或更新后）的文档。</li><li>findOneAndReplace：替换单个文档并返回替换前（或替换后）的文档。</li></ul> 
<h2><a id="5_469"></a>5、删除文档</h2> 
<h3><a id="51__remove__471"></a>5.1 使用 remove 删除文档</h3> 
<ul><li>remove 命令需要配合查询条件使用；</li><li>匹配查询条件的文档会被删除；</li><li>指定一个空文档条件会删除所有文档；</li></ul> 
<p>示例：</p> 
<pre><code class="prism language-js">db<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">age</span><span class="token operator">:</span><span class="token number">28</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment">// 删除age 等于28的记录</span>
db<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">age</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">$lt</span><span class="token operator">:</span><span class="token number">25</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>   <span class="token comment">// 删除age 小于25的记录</span>
db<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span> <span class="token punctuation">)</span> <span class="token comment">// 删除所有记录</span>
db<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//报错</span>
</code></pre> 
<p><strong>remove命令会删除匹配条件的全部文档，如果希望明确限定只删除一个文档，则需要指定justOne参数，命令格式如下：</strong></p> 
<pre><code class="prism language-js">db<span class="token punctuation">.</span>collection<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span>justOne<span class="token punctuation">)</span>


testdb<span class="token operator">&gt;</span> db<span class="token punctuation">.</span>testCollection<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token string">"novel"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token literal-property property">DeprecationWarning</span><span class="token operator">:</span> Collection<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span> is deprecated<span class="token punctuation">.</span> Use deleteOne<span class="token punctuation">,</span> deleteMany<span class="token punctuation">,</span> findOneAndDelete<span class="token punctuation">,</span> or bulkWrite<span class="token punctuation">.</span>
<span class="token punctuation">{<!-- --></span> <span class="token literal-property property">acknowledged</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">deletedCount</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="52__delete__495"></a>5.2 使用 delete 删除文档</h3> 
<p><strong>官方推荐使用 deleteOne() 和 deleteMany() 方法删除文档，语法格式如下：</strong></p> 
<pre><code class="prism language-js">db<span class="token punctuation">.</span>testCollection<span class="token punctuation">.</span><span class="token function">deleteMany</span> <span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">//删除集合下全部文档</span>
db<span class="token punctuation">.</span>testCollection<span class="token punctuation">.</span><span class="token function">deleteMany</span> <span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span><span class="token string">"novel"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">//删除 type等于 novel 的全部文档</span>
db<span class="token punctuation">.</span>testCollection<span class="token punctuation">.</span><span class="token function">deleteOne</span> <span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span><span class="token string">"novel"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">//删除 type等于novel 的一个文档</span>
</code></pre> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
         
         
           注意： 
          
         
           r 
          
         
           e 
          
         
           m 
          
         
           o 
          
         
           v 
          
         
           e 
          
         
           、 
          
         
           d 
          
         
           e 
          
         
           l 
          
         
           e 
          
         
           t 
          
         
           e 
          
         
           M 
          
         
           a 
          
         
           n 
          
         
           y 
          
         
           等命令需要对查询范围内的文档逐个删除 
          
         
        
       
      
        \color{red}{注意： remove、deleteMany等命令需要对查询范围内的文档逐个删除} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">注意：</span><span class="mord mathnormal" style="color: red;">re</span><span class="mord mathnormal" style="color: red;">m</span><span class="mord mathnormal" style="color: red;">o</span><span class="mord mathnormal" style="margin-right: 0.0359em; color: red;">v</span><span class="mord mathnormal" style="color: red;">e</span><span class="mord cjk_fallback" style="color: red;">、</span><span class="mord mathnormal" style="color: red;">d</span><span class="mord mathnormal" style="color: red;">e</span><span class="mord mathnormal" style="margin-right: 0.0197em; color: red;">l</span><span class="mord mathnormal" style="color: red;">e</span><span class="mord mathnormal" style="color: red;">t</span><span class="mord mathnormal" style="color: red;">e</span><span class="mord mathnormal" style="margin-right: 0.109em; color: red;">M</span><span class="mord mathnormal" style="color: red;">an</span><span class="mord mathnormal" style="margin-right: 0.0359em; color: red;">y</span><span class="mord cjk_fallback" style="color: red;">等命令需要对查询范围内的文档逐个删除</span></span></span></span></span></span><br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
         
         
           ，如果希望删除整个集合，则使用 
          
         
           d 
          
         
           r 
          
         
           o 
          
         
           p 
          
         
           命令会更加高效 
          
         
        
       
      
        \color{red}{，如果希望删除整个集合，则使用drop命令会更加高效} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">，如果希望删除整个集合，则使用</span><span class="mord mathnormal" style="color: red;">d</span><span class="mord mathnormal" style="color: red;">ro</span><span class="mord mathnormal" style="color: red;">p</span><span class="mord cjk_fallback" style="color: red;">命令会更加高效</span></span></span></span></span></span></p> 
<h4><a id="521__507"></a>5.2.1 返回被删除文档</h4> 
<p><strong>remove、deleteOne等命令在删除文档后只会返回确认性的信息，如果希望获得被删除的文档，则可以使用findOneAndDelete命令</strong></p> 
<pre><code class="prism language-js">db<span class="token punctuation">.</span>testCollection<span class="token punctuation">.</span><span class="token function">findOneAndDelete</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token string">"novel"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">"63f88c0b7b9fcb1f8bf84df3"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'book-1'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'novel'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">'mongodb'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">favCount</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
  <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token string">'xxw1'</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>除了在结果中返回删除文档，findOneAndDelete命令还允许定义“删除的顺序”，即按照指定顺序删除找到的第一个文档</strong></p> 
<pre><code class="prism language-js">db<span class="token punctuation">.</span>testCollection<span class="token punctuation">.</span><span class="token function">findOneAndDelete</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token string">"novel"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">sort</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">favCount</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">"63f88c0b7b9fcb1f8bf84e08"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'book-22'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'novel'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">'nosql'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">favCount</span><span class="token operator">:</span> <span class="token number">14</span><span class="token punctuation">,</span>
  <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token string">'xxw22'</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>remove、deleteOne等命令只能按默认顺序删除，利用这个特性，<br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
         
         
           f 
          
         
           i 
          
         
           n 
          
         
           d 
          
         
           O 
          
         
           n 
          
         
           e 
          
         
           A 
          
         
           n 
          
         
           d 
          
         
           D 
          
         
           e 
          
         
           l 
          
         
           e 
          
         
           t 
          
         
           e 
          
         
           可以实现队列的先进先出 
          
         
        
       
      
        \color{red}{findOneAndDelete可以实现队列的先进先出} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord" style="color: red;"><span class="mord mathnormal" style="margin-right: 0.1076em; color: red;">f</span><span class="mord mathnormal" style="color: red;">in</span><span class="mord mathnormal" style="color: red;">d</span><span class="mord mathnormal" style="margin-right: 0.0278em; color: red;">O</span><span class="mord mathnormal" style="color: red;">n</span><span class="mord mathnormal" style="color: red;">e</span><span class="mord mathnormal" style="color: red;">A</span><span class="mord mathnormal" style="color: red;">n</span><span class="mord mathnormal" style="color: red;">d</span><span class="mord mathnormal" style="color: red;">De</span><span class="mord mathnormal" style="margin-right: 0.0197em; color: red;">l</span><span class="mord mathnormal" style="color: red;">e</span><span class="mord mathnormal" style="color: red;">t</span><span class="mord mathnormal" style="color: red;">e</span><span class="mord cjk_fallback" style="color: red;">可以实现队列的先进先出</span></span></span></span></span></span></p> 
<h2><a id="6_538"></a>6、总结</h2> 
<p><strong>文档操作最佳实践</strong></p> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          关于文档结构 
         
        
       
      
        \color{red}{关于文档结构 } 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">关于文档结构</span></span></span></span></span></span></p> 
<ul><li> <p>防止使用太长的字段名（浪费空间）</p> </li><li> <p>防止使用太深的数组嵌套（超过2层操作比较复杂）</p> </li><li> <p>不使用中文，标点符号等非拉丁字母作为字段名<br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
       
        
         
          
          
            关于写操作 
           
          
         
        
          \color{red}{关于写操作} 
         
        
      </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord" style="color: red;"><span class="mord cjk_fallback" style="color: red;">关于写操作</span></span></span></span></span></span></p> </li><li> <p>update 语句里只包括需要更新的字段</p> </li><li> <p>尽可能使用批量插入来提升写入性能</p> </li><li> <p>使用TTL自动过期日志类型的数据</p> </li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3054258b497371f87e3968c9ead8b721/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">mysql清空表命令truncate和delete的区别</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9dc6e10013413aa0382aded931f5e157/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Linux基础--权限介绍&amp;chmod&amp;chown</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>