<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>sentinel整合feign - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="sentinel整合feign" />
<meta property="og:description" content="文章目录 前言一、未处理的时候返回二、操作步骤1.引入库2.编写代码服务提供者：服务消费者： 3.效果 三、处理思路①: 第一步②: 第二步③: 第三步④: 第四步⑤: 第五步 前言 sentinel整合feign, 主要处理限流熔断等异常的处理主要实现能够正常判断出是限流还是熔断等导致Spring Cloud Alibaba: 2.2.1.RELEASEsentinel: 1.7.1以及总结了一下我的处理思路 一、未处理的时候返回 二、操作步骤 1.引入库 &lt;dependency&gt; &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-alibaba-sentinel&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt; &lt;/dependency&gt; 2.编写代码 服务提供者： package com.chaim.common.sentinel.provider; import com.alibaba.csp.sentinel.adapter.spring.webmvc.callback.BlockExceptionHandler; import com.alibaba.csp.sentinel.slots.block.BlockException; import com.alibaba.csp.sentinel.slots.block.authority.AuthorityException; import com.alibaba.csp.sentinel.slots.block.degrade.DegradeException; import com.alibaba.csp.sentinel.slots.block.flow.FlowException; import com.alibaba.csp.sentinel.slots.block.flow.param.ParamFlowException; import com.alibaba.csp.sentinel.slots.system.SystemBlockException; import com.alibaba.fastjson.JSONObject; import com.chaim.common.core.util.CommonResult; import lombok.extern.slf4j.Slf4j; import org.springframework.stereotype.Component; import javax.servlet.http.HttpServletRequest; import javax.servlet.http.HttpServletResponse; import static com.chaim.common.core.constant.HttpStatus.SentinelConstants.*; /** * 由于: * 服务提供者在经过sentinel限流等操作后, 返回数据不符合我们要求, 同时消费者无法区分是限流还是熔断等操作(FeignException.errorStatus) * 故: * 实现BlockExceptionHandler, 对返回数据进行重写, 从而符合我们的要求 * 注: * 返回状态码需为 STATUS, 否者消费者那边不会进行处理 * * @author Chaim * @date 2021/11/4 15:11 */ @Component @Slf4j public class MyBlockExceptionHandler implements BlockExceptionHandler { # 这个只是我这边的定义 public static final int STATUS = 606; @Override public void handle(HttpServletRequest httpServletRequest, HttpServletResponse response, BlockException ex) throws Exception { CommonResult commonResult = CommonResult." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/a33ef69eaafcf0ecb6edb348ab1dea5f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-11-18T01:56:53+08:00" />
<meta property="article:modified_time" content="2021-11-18T01:56:53+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">sentinel整合feign</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_6" rel="nofollow">前言</a></li><li><a href="#_18" rel="nofollow">一、未处理的时候返回</a></li><li><a href="#_21" rel="nofollow">二、操作步骤</a></li><li><ul><li><a href="#1_22" rel="nofollow">1.引入库</a></li><li><a href="#2_35" rel="nofollow">2.编写代码</a></li><li><ul><li><a href="#font_color999AAA__36" rel="nofollow"><font color="#999AAA">服务提供者：</font></a></li><li><a href="#font_color999AAA__106" rel="nofollow"><font color="#999AAA">服务消费者：</font></a></li></ul> 
   </li><li><a href="#3_302" rel="nofollow">3.效果</a></li></ul> 
  </li><li><a href="#_308" rel="nofollow">三、处理思路</a></li><li><ul><li><ul><li><a href="#font_color999AAA___309" rel="nofollow"><font color="#999AAA">①: 第一步</font></a></li><li><a href="#font_color999AAA___322" rel="nofollow"><font color="#999AAA">②: 第二步</font></a></li><li><a href="#font_color999AAA___334" rel="nofollow"><font color="#999AAA">③: 第三步</font></a></li><li><a href="#font_color999AAA___347" rel="nofollow"><font color="#999AAA">④: 第四步</font></a></li><li><a href="#font_color999AAA___365" rel="nofollow"><font color="#999AAA">⑤: 第五步</font></a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<hr color="#000000" size='1"'> 
<h2><a id="_6"></a>前言</h2> 
<font color="#999AAA"> </font> 
<ol><li>sentinel整合feign, 主要处理限流熔断等异常的处理</li><li>主要实现能够正常判断出是限流还是熔断等导致</li><li>Spring Cloud Alibaba: 2.2.1.RELEASE</li><li>sentinel: 1.7.1</li><li>以及总结了一下我的处理思路</li></ol> 
<hr color="#000000" size='1"'> 
<h2><a id="_18"></a>一、未处理的时候返回</h2> 
<p><img src="https://images2.imgbox.com/e1/48/UYdbGZgb_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_21"></a>二、操作步骤</h2> 
<h3><a id="1_22"></a>1.引入库</h3> 
<pre><code class="prism language-bash"><span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>com.alibaba.cloud<span class="token operator">&lt;</span>/groupId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="token operator">&lt;</span>/artifactId<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/dependency<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org.springframework.cloud<span class="token operator">&lt;</span>/groupId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>spring-cloud-starter-openfeign<span class="token operator">&lt;</span>/artifactId<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/dependency<span class="token operator">&gt;</span>
</code></pre> 
<h3><a id="2_35"></a>2.编写代码</h3> 
<h4><a id="font_color999AAA__36"></a><font color="#999AAA">服务提供者：</font></h4> 
<pre><code class="prism language-bash">package com.chaim.common.sentinel.provider<span class="token punctuation">;</span>

<span class="token function">import</span> com.alibaba.csp.sentinel.adapter.spring.webmvc.callback.BlockExceptionHandler<span class="token punctuation">;</span>
<span class="token function">import</span> com.alibaba.csp.sentinel.slots.block.BlockException<span class="token punctuation">;</span>
<span class="token function">import</span> com.alibaba.csp.sentinel.slots.block.authority.AuthorityException<span class="token punctuation">;</span>
<span class="token function">import</span> com.alibaba.csp.sentinel.slots.block.degrade.DegradeException<span class="token punctuation">;</span>
<span class="token function">import</span> com.alibaba.csp.sentinel.slots.block.flow.FlowException<span class="token punctuation">;</span>
<span class="token function">import</span> com.alibaba.csp.sentinel.slots.block.flow.param.ParamFlowException<span class="token punctuation">;</span>
<span class="token function">import</span> com.alibaba.csp.sentinel.slots.system.SystemBlockException<span class="token punctuation">;</span>
<span class="token function">import</span> com.alibaba.fastjson.JSONObject<span class="token punctuation">;</span>
<span class="token function">import</span> com.chaim.common.core.util.CommonResult<span class="token punctuation">;</span>
<span class="token function">import</span> lombok.extern.slf4j.Slf4j<span class="token punctuation">;</span>
<span class="token function">import</span> org.springframework.stereotype.Component<span class="token punctuation">;</span>

<span class="token function">import</span> javax.servlet.http.HttpServletRequest<span class="token punctuation">;</span>
<span class="token function">import</span> javax.servlet.http.HttpServletResponse<span class="token punctuation">;</span>


<span class="token function">import</span> static com.chaim.common.core.constant.HttpStatus.SentinelConstants.*<span class="token punctuation">;</span>

/**
 * 由于:
 * 服务提供者在经过sentinel限流等操作后, 返回数据不符合我们要求, 同时消费者无法区分是限流还是熔断等操作<span class="token punctuation">(</span>FeignException.errorStatus<span class="token punctuation">)</span>
 * 故:
 * 实现BlockExceptionHandler, 对返回数据进行重写, 从而符合我们的要求
 * 注:
 * 返回状态码需为 STATUS, 否者消费者那边不会进行处理
 *
 * @author Chaim
 * @date <span class="token number">2021</span>/11/4 <span class="token number">15</span>:11
 */
@Component
@Slf4j
public class MyBlockExceptionHandler implements BlockExceptionHandler <span class="token punctuation">{<!-- --></span>
    <span class="token comment"># 这个只是我这边的定义</span>
    public static final int STATUS <span class="token operator">=</span> <span class="token number">606</span><span class="token punctuation">;</span>

    @Override
    public void handle<span class="token punctuation">(</span>HttpServletRequest httpServletRequest, HttpServletResponse response, BlockException ex<span class="token punctuation">)</span> throws Exception <span class="token punctuation">{<!-- --></span>
        CommonResult commonResult <span class="token operator">=</span> CommonResult.fail<span class="token punctuation">(</span>DATA_LOGIC_FAIL, <span class="token string">"FEIGN_SENTINEL_FAIL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ex instanceof FlowException<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log.debug<span class="token punctuation">(</span><span class="token string">"限流: "</span>, ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            commonResult <span class="token operator">=</span> CommonResult.fail<span class="token punctuation">(</span>DATA_CURRENT_LIMITING_FAIL, <span class="token string">"请稍后再试!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ex instanceof DegradeException<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log.debug<span class="token punctuation">(</span><span class="token string">"降级"</span>, ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            commonResult <span class="token operator">=</span> CommonResult.fail<span class="token punctuation">(</span>DATA_RELEGATION_FAIL, <span class="token string">"请稍后再试!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ex instanceof ParamFlowException<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log.debug<span class="token punctuation">(</span><span class="token string">"热点参数限流"</span>, ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            commonResult <span class="token operator">=</span> CommonResult.fail<span class="token punctuation">(</span>HOTSPOT_PARAMETER_FAIL, <span class="token string">"请稍后再试!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ex instanceof SystemBlockException<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log.debug<span class="token punctuation">(</span><span class="token string">"系统规则(负载/...不满足要求)"</span>, ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            commonResult <span class="token operator">=</span> CommonResult.fail<span class="token punctuation">(</span>SYSTEM_RULES_FAIL, <span class="token string">"请稍后再试!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ex instanceof AuthorityException<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log.debug<span class="token punctuation">(</span><span class="token string">"授权规则不通过"</span>, ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            commonResult <span class="token operator">=</span> CommonResult.fail<span class="token punctuation">(</span>AUTHORIZATION_RULES_FAIL, <span class="token string">"请稍后再试!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        // http状态码
        response.setStatus<span class="token punctuation">(</span>STATUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        response.setCharacterEncoding<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response.setHeader<span class="token punctuation">(</span><span class="token string">"Content-Type"</span>, <span class="token string">"application/json;charset=utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response.setContentType<span class="token punctuation">(</span><span class="token string">"application/json;charset=utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response.getWriter<span class="token punctuation">(</span><span class="token punctuation">)</span>.write<span class="token punctuation">(</span>JSONObject.toJSONString<span class="token punctuation">(</span>commonResult<span class="token punctuation">))</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h4><a id="font_color999AAA__106"></a><font color="#999AAA">服务消费者：</font></h4> 
<pre><code class="prism language-bash">feign:
  <span class="token comment"># 为feign整合sentinel</span>
  sentinel:
    enabled: <span class="token boolean">true</span>
</code></pre> 
<pre><code class="prism language-bash">@FeignClient<span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"test"</span>, fallbackFactory <span class="token operator">=</span> TestServiceFallbackFactory.class<span class="token punctuation">)</span>
public interface TestFeignClient extends TestService <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-bash">package com.chaim.feign.ali.fallback.factory<span class="token punctuation">;</span>

<span class="token function">import</span> com.alibaba.fastjson.JSONObject<span class="token punctuation">;</span>
<span class="token function">import</span> com.chaim.common.core.util.CommonResult<span class="token punctuation">;</span>
<span class="token function">import</span> com.chaim.common.sentinel.consumer.FallbackFactoryFlowException<span class="token punctuation">;</span>
<span class="token function">import</span> com.chaim.feign.ali.POJO.DTO.*<span class="token punctuation">;</span>
<span class="token function">import</span> com.chaim.feign.ali.service.TestService<span class="token punctuation">;</span>
<span class="token function">import</span> feign.hystrix.FallbackFactory<span class="token punctuation">;</span>
<span class="token function">import</span> lombok.extern.slf4j.Slf4j<span class="token punctuation">;</span>
<span class="token function">import</span> org.springframework.stereotype.Component<span class="token punctuation">;</span>

<span class="token function">import</span> static com.chaim.common.core.constant.HttpStatus.SentinelConstants.DATA_LOGIC_FAIL<span class="token punctuation">;</span>

/**
 * 指定feign的FallbackFactory, 对调用失败的接口, 进行逻辑处理
 *
 * @author Chaim
 * @date <span class="token number">2021</span>/11/3 <span class="token number">14</span>:46
 */
@Component
@Slf4j
public class TestServiceFallbackFactory implements FallbackFactory<span class="token operator">&lt;</span>TestService<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>

    @Override
    public TestService create<span class="token punctuation">(</span>Throwable throwable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token builtin class-name">return</span> new <span class="token function-name function">TestService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            @Override
            public CommonResult test<span class="token punctuation">(</span>TestScanPayDTO testScanPayDTO<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                CommonResult commonResult <span class="token operator">=</span> CommonResult.fail<span class="token punctuation">(</span>DATA_LOGIC_FAIL, <span class="token string">"FEIGN_SENTINEL_FAIL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                try <span class="token punctuation">{<!-- --></span>
                    String message <span class="token operator">=</span> throwable.getMessage<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    log.debug<span class="token punctuation">(</span><span class="token string">"sentinel 限流熔断等: {}"</span>, message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    JSONObject jsonObject <span class="token operator">=</span> JSONObject.parseObject<span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    JSONObject body <span class="token operator">=</span> jsonObject.getJSONObject<span class="token punctuation">(</span><span class="token string">"body"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token builtin class-name">return</span> CommonResult.fail<span class="token punctuation">(</span>body.getInteger<span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">)</span>, body.getString<span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> catch <span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    log.error<span class="token punctuation">(</span><span class="token string">"异常_FallbackFactoryFlowException: "</span>, e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token builtin class-name">return</span> commonResult<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<pre><code class="prism language-bash">package com.chaim.common.sentinel.consumer<span class="token punctuation">;</span>

<span class="token function">import</span> com.alibaba.fastjson.JSONObject<span class="token punctuation">;</span>
<span class="token function">import</span> com.chaim.common.sentinel.provider.MyBlockExceptionHandler<span class="token punctuation">;</span>
<span class="token function">import</span> feign.*<span class="token punctuation">;</span>
<span class="token function">import</span> feign.codec.ErrorDecoder<span class="token punctuation">;</span>
<span class="token function">import</span> org.springframework.stereotype.Component<span class="token punctuation">;</span>

<span class="token function">import</span> java.io.IOException<span class="token punctuation">;</span>
<span class="token function">import</span> java.text.DateFormat<span class="token punctuation">;</span>
<span class="token function">import</span> java.text.ParseException<span class="token punctuation">;</span>
<span class="token function">import</span> java.text.SimpleDateFormat<span class="token punctuation">;</span>
<span class="token function">import</span> java.util.Collection<span class="token punctuation">;</span>
<span class="token function">import</span> java.util.Date<span class="token punctuation">;</span>
<span class="token function">import</span> java.util.HashMap<span class="token punctuation">;</span>
<span class="token function">import</span> java.util.Map<span class="token punctuation">;</span>

<span class="token function">import</span> static feign.Util.RETRY_AFTER<span class="token punctuation">;</span>
<span class="token function">import</span> static feign.Util.checkNotNull<span class="token punctuation">;</span>
<span class="token function">import</span> static java.util.Locale.US<span class="token punctuation">;</span>
<span class="token function">import</span> static java.util.concurrent.TimeUnit.<span class="token environment constant">SECONDS</span><span class="token punctuation">;</span>

/**
 * 由于:
 * 当服务提供者通过sentinel进行限流等操作, 消费者这边无法捕获到对应的异常
 * 故:
 * 实现 ErrorDecoder, 对服务提供者返回的异常进行处理
 * 注:
 * 只会处理sentinel限制后的操作, 同时 response status <span class="token operator">==</span> MyBlockExceptionHandler.STATUS, 才进行处理, 其余依旧通过sentinel进行处理
 *
 * @author Chaim
 * @date <span class="token number">2021</span>/11/5 <span class="token number">12</span>:20
 */
@Component
public class MyErrorDecoder implements ErrorDecoder <span class="token punctuation">{<!-- --></span>
    private final RetryAfterDecoder retryAfterDecoder <span class="token operator">=</span> new RetryAfterDecoder<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    @Override
    public Exception decode<span class="token punctuation">(</span>String methodKey, Response response<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        FeignException exception <span class="token operator">=</span> errorStatus<span class="token punctuation">(</span>methodKey, response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Date retryAfter <span class="token operator">=</span> retryAfterDecoder.apply<span class="token punctuation">(</span>firstOrNull<span class="token punctuation">(</span>response.headers<span class="token punctuation">(</span><span class="token punctuation">)</span>, RETRY_AFTER<span class="token punctuation">))</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>retryAfter <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token builtin class-name">return</span> new RetryableException<span class="token punctuation">(</span>
                    response.status<span class="token punctuation">(</span><span class="token punctuation">)</span>,
                    exception.getMessage<span class="token punctuation">(</span><span class="token punctuation">)</span>,
                    response.request<span class="token punctuation">(</span><span class="token punctuation">)</span>.httpMethod<span class="token punctuation">(</span><span class="token punctuation">)</span>,
                    exception,
                    retryAfter,
                    response.request<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token builtin class-name">return</span> exception<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    public static FeignException errorStatus<span class="token punctuation">(</span>String methodKey, Response response<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        byte<span class="token punctuation">[</span><span class="token punctuation">]</span> body <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        try <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>response.body<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                body <span class="token operator">=</span> Util.toByteArray<span class="token punctuation">(</span>response.body<span class="token punctuation">(</span><span class="token punctuation">)</span>.asInputStream<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> catch <span class="token punctuation">(</span>IOException ignored<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> // NOPMD
        <span class="token punctuation">}</span>

        Map<span class="token operator">&lt;</span>String, Object<span class="token operator">&gt;</span> map <span class="token operator">=</span> new HashMap<span class="token operator">&lt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map.put<span class="token punctuation">(</span><span class="token string">"status"</span>, response.status<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>response.reason<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            map.put<span class="token punctuation">(</span><span class="token string">"reason"</span>, response.reason<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        map.put<span class="token punctuation">(</span><span class="token string">"method"</span>, response.request<span class="token punctuation">(</span><span class="token punctuation">)</span>.httpMethod<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
        map.put<span class="token punctuation">(</span><span class="token string">"url"</span>, response.request<span class="token punctuation">(</span><span class="token punctuation">)</span>.url<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
        map.put<span class="token punctuation">(</span><span class="token string">"methodKey"</span>, methodKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        map.put<span class="token punctuation">(</span><span class="token string">"body"</span>, new String<span class="token punctuation">(</span>body<span class="token punctuation">))</span><span class="token punctuation">;</span>

        // 只对返回码为606进行处理
        <span class="token keyword">if</span> <span class="token punctuation">(</span>response.status<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> MyBlockExceptionHandler.STATUS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token builtin class-name">return</span> new FeignException.FeignServerException<span class="token punctuation">(</span>response.status<span class="token punctuation">(</span><span class="token punctuation">)</span>, JSONObject.toJSONString<span class="token punctuation">(</span>map<span class="token punctuation">)</span>, response.request<span class="token punctuation">(</span><span class="token punctuation">)</span>, body<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token builtin class-name">return</span> FeignException.errorStatus<span class="token punctuation">(</span>methodKey, response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    private <span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> T firstOrNull<span class="token punctuation">(</span>Map<span class="token operator">&lt;</span>String, Collection<span class="token operator">&lt;</span>T<span class="token operator">&gt;&gt;</span> map, String key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>map.containsKey<span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>map.get<span class="token punctuation">(</span>key<span class="token punctuation">)</span>.isEmpty<span class="token punctuation">(</span><span class="token punctuation">))</span> <span class="token punctuation">{<!-- --></span>
            <span class="token builtin class-name">return</span> map.get<span class="token punctuation">(</span>key<span class="token punctuation">)</span>.iterator<span class="token punctuation">(</span><span class="token punctuation">)</span>.next<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token builtin class-name">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    /**
     * 由于ErrorDecoder中的方法无法直接使用, 故复制一份出来
     */
    static class RetryAfterDecoder <span class="token punctuation">{<!-- --></span>

        static final DateFormat RFC822_FORMAT <span class="token operator">=</span>
                new SimpleDateFormat<span class="token punctuation">(</span><span class="token string">"EEE, dd MMM yyyy HH:mm:ss 'GMT'"</span>, US<span class="token punctuation">)</span><span class="token punctuation">;</span>
        private final DateFormat rfc822Format<span class="token punctuation">;</span>

        <span class="token function-name function">RetryAfterDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            this<span class="token punctuation">(</span>RFC822_FORMAT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        RetryAfterDecoder<span class="token punctuation">(</span>DateFormat rfc822Format<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            this.rfc822Format <span class="token operator">=</span> checkNotNull<span class="token punctuation">(</span>rfc822Format, <span class="token string">"rfc822Format"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        protected long <span class="token function-name function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token builtin class-name">return</span> System.currentTimeMillis<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        /**
         * returns a <span class="token function">date</span> that corresponds to the first <span class="token function">time</span> a request can be retried.
         *
         * @param retryAfter String <span class="token keyword">in</span>
         *                   <span class="token operator">&lt;</span>a <span class="token assign-left variable">href</span><span class="token operator">=</span><span class="token string">"https://tools.ietf.org/html/rfc2616#section-14.37"</span> <span class="token operator">&gt;</span>Retry-After format<span class="token operator">&lt;</span>/a<span class="token operator">&gt;</span>
         */
        public Date apply<span class="token punctuation">(</span>String retryAfter<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>retryAfter <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token builtin class-name">return</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>retryAfter.matches<span class="token punctuation">(</span><span class="token string">"^[0-9]+<span class="token entity" title="\\">\\</span>.?0*$"</span><span class="token punctuation">))</span> <span class="token punctuation">{<!-- --></span>
                retryAfter <span class="token operator">=</span> retryAfter.replaceAll<span class="token punctuation">(</span><span class="token string">"<span class="token entity" title="\\">\\</span>.0*$"</span>, <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                long deltaMillis <span class="token operator">=</span> <span class="token environment constant">SECONDS</span>.toMillis<span class="token punctuation">(</span>Long.parseLong<span class="token punctuation">(</span>retryAfter<span class="token punctuation">))</span><span class="token punctuation">;</span>
                <span class="token builtin class-name">return</span> new Date<span class="token punctuation">(</span>currentTimeMillis<span class="token punctuation">(</span><span class="token punctuation">)</span> + deltaMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            synchronized <span class="token punctuation">(</span>rfc822Format<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                try <span class="token punctuation">{<!-- --></span>
                    <span class="token builtin class-name">return</span> rfc822Format.parse<span class="token punctuation">(</span>retryAfter<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> catch <span class="token punctuation">(</span>ParseException ignored<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token builtin class-name">return</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre> 
<h3><a id="3_302"></a>3.效果</h3> 
<p><img src="https://images2.imgbox.com/7a/2e/gJF6C01F_o.png" alt="该处使用的url网络请求的数据。"></p> 
<hr color="#000000" size='1"'> 
<h2><a id="_308"></a>三、处理思路</h2> 
<h4><a id="font_color999AAA___309"></a><font color="#999AAA">①: 第一步</font></h4> 
<p>首先分析一下, 按我的流程分析: sentinel限流是对服务提供者做的操作<br> 那么限流之后肯定是有一个返回的, 返回的结果是什么了?<br> postman直接请求服务提供者, 返回状态码429, 因为sentinel是对提供者做的限流<br> <img src="https://images2.imgbox.com/ef/58/P9JXH6IJ_o.png" alt="在这里插入图片描述"><br> 然后我们在通过消费者来调用提供者:<br> <img src="https://images2.imgbox.com/ee/51/DVl2JL4c_o.png" alt="在这里插入图片描述"><br> 对应的源码是在: feign-core: feign.SynchronousMethodHandler.executeAndDecode, (正常处理: response.status() &gt;= 200 &amp;&amp; response.status() &lt; 300)<br> <img src="https://images2.imgbox.com/41/e9/favXIFh0_o.png" alt="在这里插入图片描述"></p> 
<hr color="#000000" size='1"'> 
<h4><a id="font_color999AAA___322"></a><font color="#999AAA">②: 第二步</font></h4> 
<p>通过上面的我们可以确定了, 只要处理提供者的返回状态码, 就可以解决问题了!<br> 于是就有了:</p> 
<pre><code class="prism language-bash">// 以前的版本好像是 UrlBlockHandler
public class MyBlockExceptionHandler implements BlockExceptionHandler
</code></pre> 
<p>到这一步, 其实我们只需要将response.setStatus(200) 设置成200, 就到此结束!</p> 
<hr color="#000000" size='1"'> 
<h4><a id="font_color999AAA___334"></a><font color="#999AAA">③: 第三步</font></h4> 
<p>但是我们可能想, 限流了就是限流了嘛, 标个200不符合我的出发思路, 继续处理<br> 这是看下消费者的日志:</p> 
<p><img src="https://images2.imgbox.com/b0/58/uImXNpVE_o.png" alt="在这里插入图片描述"><br> 服务提供者返回的body已经符合了我的想法.</p> 
<p>程序到这一步, 就由feign接管处理, 看了一下源码feign是没有处理sentinel返回的异常类型(feign是根据状态码进行的处理)</p> 
<p>对应的处理源码: feign-core: feign.FeignException.errorStatus<br> <img src="https://images2.imgbox.com/e2/17/ueQRQdii_o.png" alt="在这里插入图片描述"></p> 
<hr color="#000000" size='1"'> 
<h4><a id="font_color999AAA___347"></a><font color="#999AAA">④: 第四步</font></h4> 
<p>这里就得说一下<br> FallbackFactory</p> 
<pre><code class="prism language-bash">public class TestServiceFallbackFactory implements FallbackFactory<span class="token operator">&lt;</span>TestService<span class="token operator">&gt;</span>
</code></pre> 
<p>这里能拿到Throwable<br> 但是就目前的Throwable也不符合我们的要求:</p> 
<pre><code class="prism language-bash">feign.FeignException: <span class="token punctuation">[</span><span class="token number">606</span><span class="token punctuation">]</span> during <span class="token punctuation">[</span>POST<span class="token punctuation">]</span> to <span class="token punctuation">[</span>http://***/pay/scan<span class="token punctuation">]</span> <span class="token punctuation">[</span>TestFeignClient<span class="token comment">#123(TestPayDTO)]: [{"code":5504,"message":"请稍后再试!"}]</span>
</code></pre> 
<hr color="#000000" size='1"'> 
<h4><a id="font_color999AAA___365"></a><font color="#999AAA">⑤: 第五步</font></h4> 
<p>于是就有了:</p> 
<pre><code class="prism language-bash">public class MyErrorDecoder implements ErrorDecoder
</code></pre> 
<p>那我就从写一下throwableMessage 让符合我的要求<br> 但是我只想处理sentinel我定义的状态为606的<br> 于是就有了:</p> 
<pre><code class="prism language-bash"><span class="token keyword">if</span> <span class="token punctuation">(</span>response.status<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> MyBlockExceptionHandler.STATUS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token builtin class-name">return</span> new FeignException.FeignServerException<span class="token punctuation">(</span>response.status<span class="token punctuation">(</span><span class="token punctuation">)</span>, JSONObject.toJSONString<span class="token punctuation">(</span>map<span class="token punctuation">)</span>, response.request<span class="token punctuation">(</span><span class="token punctuation">)</span>, body<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
// 不是我定义的606, 还是走 FeignException.errorStatus
<span class="token builtin class-name">return</span> FeignException.errorStatus<span class="token punctuation">(</span>methodKey, response<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>后面只需要对应处理 throwable.getMessage() 即可!</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f4184d3f4784d98e2cbbc6b738ec2e59/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">ubuntu20.04 Server安装部署Janus</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1c473b13e1266ddc32a913745f9b75e6/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">c&#43;&#43;: ‘std::__cxx11::string abc::m_string’ is protected within this context</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>