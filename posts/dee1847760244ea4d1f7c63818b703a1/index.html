<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>wasm逆向——（极客大挑战2021wasm - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="wasm逆向——（极客大挑战2021wasm" />
<meta property="og:description" content="WebAssembly是一种全新的Web编程语言，但是与JavaScript不同，它不是一种让你直接手动编写的语言，而是C / C &#43;&#43;，Rust，C＃和TypeScript等不断增加的上层语言的编译目标。
wasm是基于堆栈的虚拟机的二进制指令格式
wabt包安装
尝试了gitclone的方法，一直没安装成功，尝试：
sudo apt install wabt
我的环境：ubuntu20.4
WABT（我们将其称为“ wabbit”）是用于WebAssembly的一套工具，包括：
wat2wasm：从WebAssembly文本格式转换为 WebAssembly二进制格式wasm2wat： wat2wasm的逆函数，从二进制格式转换回文本格式（也称为.wat）wasm-objdump：显示有关wasm二进制文件的信息。与objdump类似。wasm-interp：使用基于堆栈的解释器解码并运行WebAssembly二进制文件wasm-decompile：将wasm二进制文件反编译为可读的类似C的语法。wat- desugar：解析规范解释程序支持的.wat文本格式（S表达式，平面语法或混合格式）并打印“规范”平面格式wasm2c：将WebAssembly二进制文件转换为C源代码和标头wasm-strip：删除WebAssembly二进制文件的部分wasm-validate：验证WebAssembly二进制格式的文件wast2json：将wasm spec测试格式的文件转换为JSON文件和关联的wasm二进制文件wasm-opcodecnt：计算指令的操作码使用量spectest-interp：读取Spectest JSON文件，然后在解释器中运行其测 打开压缩包，是三个这个文件
1. 静态分析： ①反汇编：
wasm2wat xorwasm.wasm -o xorwasm.wat
把wasm文件转换成webassmebly文件。
②反编译：
wasm2c xorwasm.wasm -o xorwasm.c
但是这样得到的.c代码与wasm的汇编代码没有什么区别，只是省略了⼀些出⼊栈的操作
③重新编译后⽤ida反编译进⾏优化：
之前我们得到的.c⽂件也是⽆法分析的，我们可以⽤gcc 编译.c⽂件，然后⽤ IDA 分析输出⽂件
⾸先我们要先将wabt/wasm2c⽂件夹下的wasm-rt.h和wasm-rt-impl.h头⽂件移动到我们反编译出来的.c和.h⽂件夹下
⽤gcc编译，直接gcc wasm.c会报错，因为很多wasm的函数没有具体的实现。但是我们可以只编译不链接，我们关⼼的只是程序 本⾝的逻辑，不需要真正编译出能运⾏的elf来
gcc -c xorwasm.c -o xorwasm.o
由于我没有使用clone我是去官网 上拷贝下wasm-rt.h和wasm-rt-impl.h到虚拟机中再执行
得到 xorwasm.o，放入64位IDApro
④关键函数分析：
if函数判断栈内空间，我们来看一下f11函数
几点特殊说明：f**函数一般是基本函数，print，scanf，strlen之类的
根据第一个参数猜测功能 0x400的偏移都对应常量开头，第一个参数的值减去0x400，再加上下面的基地址，就是函数所用的常量
下面我们加载看一下加密函数f10.
很简单写脚本
a=[0x35, 0x3F, 0x25, 0x1D, 0x11, 0x07, 0x15, 0x0B, 0x39, 0x2F, 0x15, 0x39, 0x35, 0x56, 0x39, 0x21, 0x09, 0x56, 0x02, 0x47, 0x47, 0x1B] for i in range(len(a)): print(chr(a[i]^ord(&#39;f&#39;)),end=&#39;&#39;) flag：SYC{wasm_Is_S0_Go0d!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/dee1847760244ea4d1f7c63818b703a1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-11-28T20:13:31+08:00" />
<meta property="article:modified_time" content="2021-11-28T20:13:31+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">wasm逆向——（极客大挑战2021wasm</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p> WebAssembly是一种全新的Web编程语言，但是与JavaScript不同，它不是一种让你直接手动编写的语言，而是C / C ++，Rust，C＃和TypeScript等<a href="https://link.zhihu.com/?target=https%3A//stackoverflow.com/a/47483989/249933" rel="nofollow" title="不断增加的上层语言">不断增加的上层语言</a>的编译目标。</p> 
<p>wasm是基于堆栈的虚拟机的二进制指令格式</p> 
<p>wabt包安装</p> 
<p>尝试了gitclone的方法，一直没安装成功，尝试：</p> 
<blockquote> 
 <p>sudo apt install wabt</p> 
</blockquote> 
<p>我的环境：ubuntu20.4</p> 
<p>WABT（我们将其称为“ wabbit”）是用于WebAssembly的一套工具，包括：</p> 
<ul><li><a href="https://webassembly.github.io/wabt/doc/wat2wasm.1.html" rel="nofollow" title="wat2wasm">wat2wasm</a>：从WebAssembly文本格式转换为 WebAssembly二进制格式</li><li><a href="https://webassembly.github.io/wabt/doc/wasm2wat.1.html" rel="nofollow" title="wasm2wat">wasm2wat</a>：<a href="https://webassembly.github.io/wabt/doc/wasm2wat.1.html" rel="nofollow" title=" wat2wasm"> wat2wasm</a>的逆函数，从二进制格式转换回文本格式（也称为.wat）</li><li><a href="https://webassembly.github.io/wabt/doc/wasm-objdump.1.html" rel="nofollow" title="wasm-objdump">wasm-objdump</a>：显示有关wasm二进制文件的信息。与objdump类似。</li><li><a href="https://webassembly.github.io/wabt/doc/wasm-interp.1.html" rel="nofollow" title="wasm-interp">wasm-interp</a>：使用基于堆栈的解释器解码并运行WebAssembly二进制文件</li><li><a href="https://webassembly.github.io/wabt/doc/wasm-decompile.1.html" rel="nofollow" title="wasm-decompile">wasm-decompile</a>：将wasm二进制文件反编译为可读的类似C的语法。</li><li><a href="https://webassembly.github.io/wabt/doc/wat-desugar.1.html" rel="nofollow" title="wat-">wat-</a> desugar：解析规范解释程序支持的.wat文本格式（S表达式，平面语法或混合格式）并打印“规范”平面格式</li><li><a href="https://webassembly.github.io/wabt/doc/wasm2c.1.html" rel="nofollow" title="wasm2c">wasm2c</a>：将WebAssembly二进制文件转换为C源代码和标头</li><li><a href="https://webassembly.github.io/wabt/doc/wasm-strip.1.html" rel="nofollow" title="wasm-strip">wasm-strip</a>：删除WebAssembly二进制文件的部分</li><li><a href="https://webassembly.github.io/wabt/doc/wasm-validate.1.html" rel="nofollow" title="wasm-validate">wasm-validate</a>：验证WebAssembly二进制格式的文件</li><li><a href="https://webassembly.github.io/wabt/doc/wast2json.1.html" rel="nofollow" title="wast2json">wast2json</a>：将wasm spec测试格式的文件转换为JSON文件和关联的wasm二进制文件</li><li><a href="https://webassembly.github.io/wabt/doc/wasm-opcodecnt.1.html" rel="nofollow" title="wasm-opcodecnt">wasm-opcodecnt</a>：计算指令的操作码使用量</li><li><a href="https://webassembly.github.io/wabt/doc/spectest-interp.1.html" rel="nofollow" title="spectest-interp">spectest-interp</a>：读取Spectest JSON文件，然后在解释器中运行其测</li></ul> 
<p> <img alt="" height="71" src="https://images2.imgbox.com/f9/26/KjNUGceP_o.png" width="619"></p> 
<p> 打开压缩包，是三个这个文件</p> 
<h2><strong>1. 静态分析：</strong></h2> 
<p> ①反汇编：</p> 
<blockquote> 
 <p>wasm2wat xorwasm.wasm -o xorwasm.wat</p> 
</blockquote> 
<p> 把wasm文件转换成webassmebly文件。</p> 
<p>②反编译：</p> 
<blockquote> 
 <p>wasm2c xorwasm.wasm -o xorwasm.c</p> 
</blockquote> 
<p><img alt="" height="194" src="https://images2.imgbox.com/2a/9f/g1YnWDIa_o.png" width="109"></p> 
<p>但是这样得到的.c代码与wasm的汇编代码没有什么区别，只是省略了⼀些出⼊栈的操作</p> 
<p>③重新编译后⽤ida反编译进⾏优化：</p> 
<p>之前我们得到的.c⽂件也是⽆法分析的，我们可以⽤gcc 编译.c⽂件，然后⽤ IDA 分析输出⽂件</p> 
<p>⾸先我们要先将wabt/wasm2c⽂件夹下的wasm-rt.h和wasm-rt-impl.h头⽂件移动到我们反编译出来的.c和.h⽂件夹下</p> 
<p>⽤gcc编译，直接gcc wasm.c会报错，因为很多wasm的函数没有具体的实现。但是我们可以只编译不链接，我们关⼼的只是程序 本⾝的逻辑，不需要真正编译出能运⾏的elf来</p> 
<blockquote> 
 <p>gcc -c xorwasm.c -o xorwasm.o</p> 
</blockquote> 
<p>由于我没有使用clone我是去<a class="link-info" href="https://github.com/WebAssembly/wabt" title="官网">官网</a> 上拷贝下wasm-rt.h和wasm-rt-impl.h到虚拟机中再执行</p> 
<p>得到 xorwasm.o，放入64位IDApro</p> 
<p>④关键函数分析：</p> 
<p><img alt="" height="192" src="https://images2.imgbox.com/10/47/d3bLkQd1_o.png" width="501"></p> 
<p> if函数判断栈内空间，我们来看一下f11函数</p> 
<p><img alt="" height="646" src="https://images2.imgbox.com/ec/f0/SSVbhd8V_o.png" width="720"></p> 
<p></p> 
<p>几点特殊说明：f**函数一般是基本函数，print，scanf，strlen之类的</p> 
<p>根据第一个参数猜测功能 0x400的偏移都对应常量开头，第一个参数的值减去0x400，再加上下面的基地址，就是函数所用的常量</p> 
<p><img alt="" height="14" src="https://images2.imgbox.com/c4/7c/YF9wPsot_o.png" width="685"></p> 
<p> 下面我们加载看一下加密函数f10.</p> 
<p> <img alt="" height="379" src="https://images2.imgbox.com/56/d8/HnKseI4F_o.png" width="769"></p> 
<p> 很简单写脚本</p> 
<pre><code class="language-python">a=[0x35, 0x3F, 0x25, 0x1D, 0x11, 0x07, 0x15, 0x0B, 0x39, 0x2F,
  0x15, 0x39, 0x35, 0x56, 0x39, 0x21, 0x09, 0x56, 0x02, 0x47,
  0x47, 0x1B]
for i in range(len(a)):
  print(chr(a[i]^ord('f')),end='')</code></pre> 
<p>flag：SYC{wasm_Is_S0_Go0d!!}</p> 
<p>总结：wasm逆向第一次接触，主要是看懂函数。。。</p> 
<p></p> 
<p><strong>二：动态调试</strong></p> 
<p>我使用的是windos自带的msedge浏览器.</p> 
<p>双击.html文件毫无收获 </p> 
<p><img alt="" height="967" src="https://images2.imgbox.com/29/a1/HmHNsuFY_o.png" width="1200"> 这样是没有正确运⾏起来的，⾸先要在对应⽂件夹开⼀个简易服务器，才能正确的运⾏ ⾸先cd进对应⽬录 然后使⽤python创建⼀个简易的本地局域⽹</p> 
<blockquote> 
 <p>python -m http.server -b localhost</p> 
</blockquote> 
<p>之后便可以直接⽤浏览器访问： </p> 
<blockquote> 
 <p><a href="http://localhost:8000/xorwasm.html" rel="nofollow" title="http://localhost:8000/xorwasm.html">http://localhost:800<br> 0/xorwasm.html</a></p> 
</blockquote> 
<p> <img alt="" height="288" src="https://images2.imgbox.com/52/69/fBGNIGqY_o.png" width="565"></p> 
<p> 提示输入flag，随机输入</p> 
<p>可以看⻅验证失败 接下来我们逐渐跟进去进⾏调试 F12打开调试器 打开wasm文件</p> 
<p><img alt="" height="779" src="https://images2.imgbox.com/96/de/Oai2nS6V_o.png" width="1200"></p> 
<p> ctrl+f 查找main函数</p> 
<p>点击地址栏下好我们的断点</p> 
<p>然后刷新，可以看⻅被断下</p> 
<p><img alt="" height="417" src="https://images2.imgbox.com/07/37/2Nso4iZm_o.png" width="269"></p> 
<p>F8执⾏(等价于IDA的F9)，F10单步步过，F11单步步⼊ 然后跟进func11直到要求我们输⼊flag 查看内存的⽅法</p> 
<p><img alt="" height="365" src="https://images2.imgbox.com/44/a9/UKSyl6Te_o.png" width="272"></p> 
<p> 点击memory右上角的图标</p> 
<p><img alt="" height="197" src="https://images2.imgbox.com/3e/21/y03ib2f8_o.png" width="711"></p> 
<p> 输入要想查询的值</p> 
<p><img alt="" height="117" src="https://images2.imgbox.com/03/d0/Vmu8rMBJ_o.png" width="179"></p> 
<p><img alt="" height="62" src="https://images2.imgbox.com/bd/4a/gSw95zA3_o.png" width="218"></p> 
<p>执行完func96屏幕出现</p> 
<p><img alt="" height="65" src="https://images2.imgbox.com/8b/1d/pSkFy9Na_o.png" width="219"> </p> 
<p> 猜测为输出函数</p> 
<p>执行到func17 查询1084的值</p> 
<p><img alt="" height="114" src="https://images2.imgbox.com/b0/30/PKuXbaZK_o.png" width="435"> </p> 
<p>为%猜测是输入函数。</p> 
<p> <img alt="" height="101" src="https://images2.imgbox.com/6d/94/bHXw39hj_o.png" width="257"></p> 
<p>这⾥判断我们输⼊的字符串的⻓度，然后将⻓度存放到了var22中 </p> 
<p><img alt="" height="152" src="https://images2.imgbox.com/c2/ae/Em7sgOme_o.png" width="327"></p> 
<p> 判断长度是否等于二十二不等于执行这个</p> 
<p><img alt="" height="125" src="https://images2.imgbox.com/d9/63/oIl0bLtQ_o.png" width="498"></p> 
<p>我们再次输入一个22长度的</p> 
<p><img alt="" height="82" src="https://images2.imgbox.com/ec/7a/xuh7rJms_o.png" width="242"></p> 
<p>跟进f10</p> 
<p><img alt="" height="114" src="https://images2.imgbox.com/c7/ef/qu5hpoxL_o.png" width="320"> </p> 
<p>发现关键异或，就是将我们输⼊的字符串取出和const 102进⾏异或之后再存放回去 加密之后返回 </p> 
<p> 跟进到f9</p> 
<p><img alt="" height="118" src="https://images2.imgbox.com/19/d3/raU6kxAn_o.png" width="297"></p> 
<p>var2存放的是我们的⽐较数据的地址 将⽐较数据取出写出解题脚本即可 </p> 
<p><img alt="" height="51" src="https://images2.imgbox.com/d9/61/xMzVY9QX_o.png" width="1131"></p> 
<p> </p> 
<pre><code class="language-python">a=[0x35, 0x3F, 0x25, 0x1D, 0x11, 0x07, 0x15, 0x0B, 0x39, 0x2F,
  0x15, 0x39, 0x35, 0x56, 0x39, 0x21, 0x09, 0x56, 0x02, 0x47,
  0x47, 0x1B]
for i in range(len(a)):
  print(chr(a[i]^ord('f')),end='')</code></pre> 
<p>flag：SYC{wasm_Is_S0_Go0d!!}</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3f33a28da5c19a53a50223d6fbde80b1/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">无root手机证书解决方案之VMOS&#43;小黄鸟</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7aed1dbefde10ed6fc888dda798dcf22/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Vue 基础语法之计算属性(computed)、侦听器(watch)、过滤器(filters)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>