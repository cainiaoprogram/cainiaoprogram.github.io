<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【有丝分裂检测】MIDOG Domain Adaptation实现 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【有丝分裂检测】MIDOG Domain Adaptation实现" />
<meta property="og:description" content="背景介绍部分参考这一篇博文:【01】有丝分裂检测—病理领域适应问题—论文解析1_TianleiShi的博客-CSDN博客
原文Github链接：https://github.com/scjjb/MIDOG_Domain_Adaptation
修改后的代码链接：
一. MIDOG预处理 解析MIDOG的标注文件.json → df = get_bbox_df()训练集和测试集划分 → train_test_split(df)图像块生成：不重叠裁剪成512*512尺寸的patch → mask_segmentor() from PatchSeg_functions import mask_segmentor from Data_functions import get_bbox_df, train_test_split ############ Preparation ################ ## Get dataset and generate 512x512 crops from the original WSIs df = get_bbox_df() df_train, df_test = train_test_split(df) image_ids=list(df[&#39;file_name&#39;].unique()) mask_segmentor(image_ids,df,512,512,categories=[&#39;mitotic figure&#39;], image_folder=&#34;I:/Pathology/Dataset/MIDOG2021/image_crops/&#34;) 1. json文件解析 主要是两个列表元素：images和annotationsimages列表中包含200张图像信息：file_name，id，width和heightannotation中包含了4435个标注信息：bbox坐标，category_id，image_id，id（第几个标注） 最终得到df，shape = {tuple: 2}(4435, 8)，如下图所示 2. 训练集和测试集划分 A、B、C三个中心分别有50张图片，每个中心以8：2的比例划分训练集和测试集【前40个为训练集，后10个为测试集】分别训练三个模型，并在另外1个中心进行外部测试。eg：A&#43;B训练，C外部测试只对外部测试集进行校正，参与模型训练的数据集不进行颜色校正 二. 颜色校正 三. 细胞检测 1. U-Net分割网络实现过程 step1：依赖库导入，模型设置 💡 segmentation_models_pytorch 高级API：①集成了9种分割模型架构：Unet、Unet&#43;&#43;、MAnet、Linknet、FPN、PSPNet、PAN、DeepLabV3、DeepLabV3&#43;；②每种架构有113种可用的编码器；③所有编码器均具有预训练的权重，可更快收敛。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/0173437c0b0b30f198600c085c2449c4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-23T19:41:14+08:00" />
<meta property="article:modified_time" content="2022-08-23T19:41:14+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【有丝分裂检测】MIDOG Domain Adaptation实现</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="%E8%83%8C%E6%99%AF%E4%BB%8B%E7%BB%8D%E9%83%A8%E5%88%86%E5%8F%82%E8%80%83%E8%BF%99%E4%B8%80%E7%AF%87%E5%8D%9A%E6%96%87%3A%E3%80%9001%E3%80%91%E6%9C%89%E4%B8%9D%E5%88%86%E8%A3%82%E6%A3%80%E6%B5%8B%E2%80%94%E7%97%85%E7%90%86%E9%A2%86%E5%9F%9F%E9%80%82%E5%BA%94%E9%97%AE%E9%A2%98%E2%80%94%E8%AE%BA%E6%96%87%E8%A7%A3%E6%9E%901_TianleiShi%E7%9A%84%E5%8D%9A%E5%AE%A2-CSDN%E5%8D%9A%E5%AE%A2">背景介绍部分参考这一篇博文:<a href="https://blog.csdn.net/weixin_40629850/article/details/126359222?spm=1001.2014.3001.5502" title="【01】有丝分裂检测—病理领域适应问题—论文解析1_TianleiShi的博客-CSDN博客">【01】有丝分裂检测—病理领域适应问题—论文解析1_TianleiShi的博客-CSDN博客</a></p> 
<p>原文Github链接：<a href="https://github.com/scjjb/MIDOG_Domain_Adaptation" title="https://github.com/scjjb/MIDOG_Domain_Adaptation">https://github.com/scjjb/MIDOG_Domain_Adaptation</a></p> 
<p>修改后的代码链接：</p> 
<hr> 
<h3>一. MIDOG预处理</h3> 
<ul><li>解析MIDOG的标注文件.json  →  df = get_bbox_df()</li><li>训练集和测试集划分 →  train_test_split(df)</li><li>图像块生成：不重叠裁剪成512*512尺寸的patch  →  mask_segmentor()</li></ul> 
<pre><code class="language-python">from PatchSeg_functions import mask_segmentor
from Data_functions import get_bbox_df, train_test_split
############ Preparation ################
## Get dataset and generate 512x512 crops from the original WSIs
df = get_bbox_df()
df_train, df_test = train_test_split(df)
image_ids=list(df['file_name'].unique())
mask_segmentor(image_ids,df,512,512,categories=['mitotic figure'],
               image_folder="I:/Pathology/Dataset/MIDOG2021/image_crops/")</code></pre> 
<h4 id="%E8%A7%A3%E6%9E%90json%E6%96%87%E4%BB%B6">1. json文件解析</h4> 
<ul><li>主要是两个列表元素：images和annotations</li><li>images列表中包含200张图像信息：file_name，id，width和height</li><li>annotation中包含了4435个标注信息：bbox坐标，category_id，image_id，id（第几个标注）</li></ul> 
<h3 id="%E2%80%8B%E7%BC%96%E8%BE%91"><img alt="" height="139" src="https://images2.imgbox.com/ff/b7/6l8OuraI_o.png" width="672"></h3> 
<ul><li> 最终得到df，shape = {tuple: 2}(4435, 8)，如下图所示</li></ul> 
<p class="img-center"><img alt="" height="327" src="https://images2.imgbox.com/9a/54/Cbt9SSI3_o.png" width="969"></p> 
<h4 id="%C2%A0%E8%AE%AD%E7%BB%83%E9%9B%86%E5%92%8C%E6%B5%8B%E8%AF%95%E9%9B%86%E5%88%92%E5%88%86"> 2. 训练集和测试集划分</h4> 
<ul><li>A、B、C三个中心分别有50张图片，每个中心以8：2的比例划分训练集和测试集【前40个为训练集，后10个为测试集】</li><li>分别训练三个模型，并在另外1个中心进行外部测试。eg：A+B训练，C外部测试</li><li>只对外部测试集进行校正，参与模型训练的数据集不进行颜色校正</li></ul> 
<h3 id="2.%20%E9%A2%9C%E8%89%B2%E6%A0%A1%E6%AD%A3">二. 颜色校正</h3> 
<h3 id="3.%20%E7%BB%86%E8%83%9E%E6%A3%80%E6%B5%8B">三. 细胞检测</h3> 
<h4 id="1.%20U-Net%E5%88%86%E5%89%B2%E7%BD%91%E7%BB%9C%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B">1. U-Net分割网络实现过程</h4> 
<ul><li> <h4 id="step1%EF%BC%9A%E4%BE%9D%E8%B5%96%E5%BA%93%E5%AF%BC%E5%85%A5%EF%BC%8C%E6%A8%A1%E5%9E%8B%E8%AE%BE%E7%BD%AE"><span style="color:#333333;">step1：依赖库导入，模型设置</span></h4> </li></ul> 
<blockquote> 
 <p>💡 <span style="color:#be191c;"><strong>segmentation_models_pytorch </strong></span><span style="color:#0d0016;">高级API：①集成了9种分割模型架构：Unet、Unet++、MAnet、Linknet、FPN、PSPNet、PAN、DeepLabV3、DeepLabV3+；②每种架构有113种可用的编码器；③所有编码器均具有预训练的权重，可更快收敛。</span></p> 
</blockquote> 
<pre><code class="language-python">## Import required packages and functions
import torch
import numpy as np
import matplotlib.pyplot as plt
import gc
from torchvision import transforms
import segmentation_models_pytorch  ### 一个基于PyTorch的图像分割神经网络
from segmentation_processing import preprocess_crops, get_model_predictions, add_bbox_to_map
from segmentation_modelling import create_data_loaders, train_one_epoch, metric, evaluate, F1_score_centered
from pneumothorax_segmentation.unet_pipeline.Losses import ComboLoss
</code></pre> 
<pre><code class="language-python">## Model selection can be changed
model = segmentation_models_pytorch.Unet(
   encoder_name='resnet152', # 选择解码器，例如mobilenet_v2 或 efficientnet-b7
   encoder_weights='imagenet', # 使用预先训练的权重imagenet进行解码器初始化
   classes=1, # 模型输出通道（数据集所分的类别总数）
   activation=None, )</code></pre> 
<ul><li> <h4 id="step2%EF%BC%9A%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD"><strong>step2：数据加载</strong></h4> 
  <ul><li>定义data_transforms函数，注意train和valid数据集变换不同</li><li>preprocess_crops函数的功能如下：输入train、valid、test的patch数量，以及train scanner和test scanner；输出对应的patch索引<img alt="" height="1200" src="https://images2.imgbox.com/e8/a5/08Fde2Ee_o.png" width="1200">​​​​​​</li><li>create_data_loaders：数据transform以及dataloader</li></ul></li></ul> 
<pre><code class="language-python">## train_transforms will only be used in training, not evaluation
## image_transforms will be used in training and evaluation
train_transforms = transforms.Compose([
    transforms.RandomHorizontalFlip(p=0.5),
    transforms.RandomVerticalFlip(p=0.5),
    transforms.RandomAffine(degrees=90, translate=(0.1, 0.1), scale=(0.9, 1.1), shear=0.1)])

image_transforms = transforms.Compose([
    transforms.ToTensor(),])

## Prepare data loaders with image crops
train_ids, valid_ids, test_ids = preprocess_crops(5000, 1000, 2000， 
                               train_scanners=train_scanners,valid_scanners=valid_scanners)
train_loader, valid_loader, test_loader = create_data_loaders(train_ids, valid_ids,
       test_ids=test_ids,image_transform=image_transforms,train_transform=train_transforms)
</code></pre> 
<ul><li> <h4 id="step3%EF%BC%9A%E8%AE%AD%E7%BB%83%E8%BF%87%E7%A8%8B"><strong>step3：训练前设置</strong></h4> 
  <ul><li>损失权重：criterion = <strong>ComboLoss</strong>(**{'weights': {'bce': 2, 'dice': 1, 'focal': 10}})</li><li> <p>优化器定义：optimizer = torch.optim.<strong>Adam</strong>(model.parameters(), lr=learning_rate, weight_decay=0.001)</p> </li><li> <p>学习率控制器：scheduler = torch.optim.lr_scheduler.<strong>MultiStepLR</strong>( optimizer, milestones=[1, 2, 3, 4, 5, 6, 7, 8, 9, 10], gamma=gamma)</p> </li></ul></li></ul> 
<blockquote> 
 <p>💡<span style="color:#be191c;"><strong>MultiStepLR多步长衰减：</strong></span>固定步长衰减虽然能够按照固定的区间长度进行学习率更新<strong>，但是有时我们希望不同的区间采用不同的更新频率，或者是有的区间更新学习率，有的区间不更新学习率。动态区间长度控制。</strong></p> 
 <p>—— 其中milestones参数为表示学习率更新的起止区间，在区间[0. 1]内学习率不更新，而在[1, 2]、[2, 3].....[9, 10]的右侧值都进行一次更新；gamma参数表示学习率衰减为上次的gamma分之一</p> 
</blockquote> 
<ul><li> <h4><strong>step4：训练过程</strong></h4> 
  <ul><li>训练一个epoch后，计算train_loss</li><li>valid_loader前向传播，<strong>evaluate函数</strong>计算val_loss，以及f1_score 
    <ul><li><strong>get_model_predictions</strong>计算边界框预测结果valid_preds(每个像素点的分类概率)</li><li>add_bbox_to_map函数将边界框参数转为图像bboxs(01掩码)</li><li>最后利用混淆矩阵计算f1_score得分</li></ul></li><li>保存得分最高的模型，并绘制损失曲线和F1得分曲线</li><li>绘制训练集和测试集的F1得分曲线</li></ul></li></ul> 
<h3 id="4.%20%E6%A8%A1%E5%9E%8B%E8%AF%84%E4%BC%B0">模型评估</h3> 
<h2 id="%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE">环境配置</h2>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2d937c9d79a97105307eb700abe0b955/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">（1.5万字图文）解读华为集成产品开发IPD之市场管理流程（MM流程）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d8da2097585cbc39172efe00956fb43a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Docker容器启动失败修改内部配置文件</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>