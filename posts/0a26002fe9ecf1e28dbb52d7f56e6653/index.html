<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>mysql的全量备份和增量备份 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="mysql的全量备份和增量备份" />
<meta property="og:description" content="文章目录 全量备份1 创建mysqldump脚本1.1 找一个目录,这里选择放到/data/mysqlbackup下,创建shell脚本1.2 添加内容1.3给脚本赋予执行权限 2.crontab2.1查看cron状态2.1创建crontab脚本2.2 编辑,每天凌晨3点执行一次3.3 执行定时任务命令2.4 查看定时任务是否成功或者检测/var/spool/cron下是否生成对应cron脚本2.5 删除定时任务2.6编辑定时任务 3.数据恢复3.1删除旧数据库3.2 解压备份的文件3.3 恢复数据 增量备份1.开启mysql的binlog日志(增量备份)1.1 查看binlog是否开启1.2 编辑my.cnf1.3 重启数据库1.4 查看日志索引和事件位置1.5如何实现增量备份 2.一次增量备份2.1凌晨3点进行一次全量备份2.2 早上9点向test.user中插入三条数据2.3 下午5点把数据库删了~&gt;~2.4 如何恢复数据库? 全量备份 1 创建mysqldump脚本 先了解一下mysqldump的基本参数
1. 全备数据库(innodb Engine) mysqldump -uroot -pmysql123 --single-transaction --master-data=2 --flush-logs --flush-privileges --routines --events --all-databases &gt; /backup/db_bak01.sql 2. 全备(Myisam Engine) mysqldump -uroot -pmysql123 --lock-all-tables --master-data=2 --flush-logs --flush-privileges --routines --events --all-databases &gt; /backup/db_bak01.sql 3. 只备份数据库db1和db2 mysqldump -uroot -pmysql123 --single-transaction --master-data=2 --flush-logs --routines --events --databases db1 db2 &gt; /backup/db_bak01." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/0a26002fe9ecf1e28dbb52d7f56e6653/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-07T17:14:24+08:00" />
<meta property="article:modified_time" content="2022-03-07T17:14:24+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">mysql的全量备份和增量备份</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#_3" rel="nofollow">全量备份</a></li><li><ul><li><a href="#1_mysqldump_5" rel="nofollow">1 创建mysqldump脚本</a></li><li><ul><li><ul><li><a href="#11_datamysqlbackupshell_37" rel="nofollow">1.1 找一个目录,这里选择放到/data/mysqlbackup下,创建shell脚本</a></li><li><a href="#12__43" rel="nofollow">1.2 添加内容</a></li><li><a href="#13_84" rel="nofollow">1.3给脚本赋予执行权限</a></li></ul> 
    </li></ul> 
    </li><li><a href="#2crontab_90" rel="nofollow">2.crontab</a></li><li><ul><li><ul><li><a href="#21cron_115" rel="nofollow">2.1查看cron状态</a></li><li><a href="#21crontab_127" rel="nofollow">2.1创建crontab脚本</a></li><li><a href="#22_3_135" rel="nofollow">2.2 编辑,每天凌晨3点执行一次</a></li><li><a href="#33__143" rel="nofollow">3.3 执行定时任务命令</a></li><li><a href="#24_varspoolcroncron_149" rel="nofollow">2.4 查看定时任务是否成功或者检测/var/spool/cron下是否生成对应cron脚本</a></li><li><a href="#25__160" rel="nofollow">2.5 删除定时任务</a></li><li><a href="#26_168" rel="nofollow">2.6编辑定时任务</a></li></ul> 
    </li></ul> 
    </li><li><a href="#3_176" rel="nofollow">3.数据恢复</a></li><li><ul><li><ul><li><a href="#31_180" rel="nofollow">3.1删除旧数据库</a></li><li><a href="#32__186" rel="nofollow">3.2 解压备份的文件</a></li><li><a href="#33__192" rel="nofollow">3.3 恢复数据</a></li></ul> 
    </li></ul> 
   </li></ul> 
   </li><li><a href="#_216" rel="nofollow">增量备份</a></li><li><ul><li><a href="#1mysqlbinlog_218" rel="nofollow">1.开启mysql的binlog日志(增量备份)</a></li><li><ul><li><ul><li><a href="#11_binlog_220" rel="nofollow">1.1 查看binlog是否开启</a></li><li><a href="#12_mycnf_240" rel="nofollow">1.2 编辑my.cnf</a></li><li><a href="#13__257" rel="nofollow">1.3 重启数据库</a></li><li><a href="#14__286" rel="nofollow">1.4 查看日志索引和事件位置</a></li><li><a href="#15_304" rel="nofollow">1.5如何实现增量备份</a></li></ul> 
    </li></ul> 
    </li><li><a href="#2_310" rel="nofollow">2.一次增量备份</a></li><li><ul><li><ul><li><a href="#213_312" rel="nofollow">2.1凌晨3点进行一次全量备份</a></li><li><a href="#22_9testuser_358" rel="nofollow">2.2 早上9点向test.user中插入三条数据</a></li><li><a href="#23_5_366" rel="nofollow">2.3 下午5点把数据库删了~&gt;~</a></li><li><a href="#24__372" rel="nofollow">2.4 如何恢复数据库?</a></li></ul> 
    </li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="_3"></a>全量备份</h3> 
<h4><a id="1_mysqldump_5"></a>1 创建mysqldump脚本</h4> 
<p>先了解一下mysqldump的基本参数</p> 
<pre><code class="prism language-shell">1. 全备数据库<span class="token punctuation">(</span>innodb Engine<span class="token punctuation">)</span>
mysqldump -uroot -pmysql123 --single-transaction --master-data<span class="token operator">=</span>2  --flush-logs --flush-privileges --routines --events --all-databases <span class="token operator">&gt;</span> /backup/db_bak01.sql
2. 全备<span class="token punctuation">(</span>Myisam Engine<span class="token punctuation">)</span>
mysqldump -uroot -pmysql123 --lock-all-tables    --master-data<span class="token operator">=</span>2  --flush-logs --flush-privileges --routines --events --all-databases <span class="token operator">&gt;</span> /backup/db_bak01.sql
3. 只备份数据库db1和db2
mysqldump -uroot -pmysql123 --single-transaction --master-data<span class="token operator">=</span>2  --flush-logs --routines --events --databases db1 db2 <span class="token operator">&gt;</span> /backup/db_bak01.sql
</code></pre> 
<pre><code class="prism language-shell"><span class="token comment">#innodb事务</span>
--single-transaction
<span class="token comment">#在备份语句里添加CHANGE MASTER语句以及binlog文件及位置点信息</span>
<span class="token comment">#0: 不记录</span>
<span class="token comment">#1：记录CHANGE MASTER语句</span>
<span class="token comment">#2：记录但注释CHANGE MASTER语句</span>
<span class="token comment">#例子 CHANGE MASTER TO MASTER_LOG_FILE=’MySQL-bin.000002′, MASTER_LOG_POS=106;</span>
--master-data<span class="token operator">=</span><span class="token punctuation">[</span>0<span class="token punctuation">]</span><span class="token punctuation">[</span>1<span class="token punctuation">]</span><span class="token punctuation">[</span>2<span class="token punctuation">]</span>
<span class="token comment">#刷新binlog日志,比如之前是mysql-bin.000004执行完flush-logs后创建mysql-bin.000005,重启数据库也会执行flush-logs</span>
-F 或 --flush-logs 
<span class="token comment">#指定数据库,加了这个会生成建库的语句</span>
-B
<span class="token comment">#备份存储过程等</span>
-R
<span class="token comment">#锁表</span>
-x
</code></pre> 
<h6><a id="11_datamysqlbackupshell_37"></a>1.1 找一个目录,这里选择放到/data/mysqlbackup下,创建shell脚本</h6> 
<pre><code class="prism language-shell">vim /data/mysqlbackup/mysqlBackuoShell.sh
</code></pre> 
<h6><a id="12__43"></a>1.2 添加内容</h6> 
<pre><code class="prism language-shell"><span class="token shebang important">#!/bin/bash</span> 
   
<span class="token comment">#保存备份个数,31条 </span>
number<span class="token operator">=</span>31 
<span class="token comment">#备份保存路径 </span>
backup_dir<span class="token operator">=</span>/data/mysqlbackup/mysqlbackupdata 
<span class="token comment">#日期 </span>
dd<span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> +%Y-%m-%d<span class="token variable">`</span></span>
<span class="token comment">#备份工具 </span>
tool<span class="token operator">=</span>mysqldump 
<span class="token comment">#用户名 </span>
username<span class="token operator">=</span>用户名 
<span class="token comment">#密码 </span>
password<span class="token operator">=</span>密码
<span class="token comment">#将要备份的数据库 </span>
database_name<span class="token operator">=</span>city_challenge
   
<span class="token comment">#运行内容,结果用gzip压缩下</span>
<span class="token variable">$tool</span> -u <span class="token variable">$username</span> -p<span class="token variable">$password</span> --single-transaction --master-data<span class="token operator">=</span>2  <span class="token variable">$database_name</span><span class="token operator">|</span><span class="token function">gzip</span> <span class="token operator">&gt;</span> <span class="token variable">$backup_dir</span>/<span class="token variable">$database_name</span>-<span class="token variable">$dd</span>.sql.gz 
   
<span class="token comment">#写创建备份日志 </span>
<span class="token keyword">echo</span> <span class="token string">"create <span class="token variable">$backup_dir</span>/<span class="token variable">$database_name</span>-<span class="token variable">$dd</span>.sql.gz"</span> <span class="token operator">&gt;&gt;</span> <span class="token variable">$backup_dir</span>/log.txt 
   
<span class="token comment">#找出需要删除的备份 </span>
delfile<span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">ls</span> -l -crt  $backup_dir/*.sql.gz <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print <span class="token variable">$9</span> }'</span> <span class="token operator">|</span> <span class="token function">head</span> -1<span class="token variable">`</span></span> 
   
<span class="token comment">#判断现在的备份数量是否大于$number </span>
count<span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">ls</span> -l -crt  $backup_dir/*.sql.gz <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print <span class="token variable">$9</span> }'</span> <span class="token operator">|</span> <span class="token function">wc</span> -l<span class="token variable">`</span></span> 
   
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$count</span> -gt <span class="token variable">$number</span> <span class="token punctuation">]</span> 
<span class="token keyword">then</span> 
  <span class="token function">rm</span> <span class="token variable">$delfile</span>  //删除最早生成的备份，只保留number数量的备份 
  <span class="token comment">#写删除文件日志 </span>
  <span class="token keyword">echo</span> <span class="token string">"delete <span class="token variable">$delfile</span>"</span> <span class="token operator">&gt;&gt;</span> <span class="token variable">$backup_dir</span>/log.txt 
<span class="token keyword">fi</span>

</code></pre> 
<h6><a id="13_84"></a>1.3给脚本赋予执行权限</h6> 
<pre><code class="prism language-shell"><span class="token function">chmod</span> +x  mysqlBackuoShell.sh
</code></pre> 
<h4><a id="2crontab_90"></a>2.crontab</h4> 
<p>crontab是一个 Liunx 下 的定时执行工具，可以在无需人工干预的情况下运行作业。</p> 
<pre><code class="prism language-shell">//启动服务
<span class="token function">service</span> crond start 
//关闭服务
 <span class="token function">service</span> crond stop  
//重启服务
<span class="token function">service</span> crond restart  
//重新载入配置
<span class="token function">service</span> crond reload  
//查看服务状态
<span class="token function">service</span> crond status 
</code></pre> 
<p><strong>crontab语法</strong></p> 
<p>crontab命令用于安装、删除或者列出用于驱动cron后台进程的表格。用户把需要执行的命令序列放到crontab文件中以获得执行。每个用户都可以有自己的crontab文件。/var/spool/cron下的crontab文件不可以直接创建或者直接修改。该crontab文件是通过crontab命令创建的。</p> 
<p>在crontab文件中如何输入需要执行的命令和时间。该文件中每行都包括六个域，其中前五个域是指定命令被执行的时间，最后一个域是要被执行的命令。每个域之间使用空格或者制表符分隔。</p> 
<h6><a id="21cron_115"></a>2.1查看cron状态</h6> 
<pre><code class="prism language-shell"><span class="token function">service</span> crond status 
</code></pre> 
<p>没启动就</p> 
<pre><code class="prism language-shell"><span class="token function">service</span> crond start 
</code></pre> 
<h6><a id="21crontab_127"></a>2.1创建crontab脚本</h6> 
<p>位置随便,这里和shell脚本放在一块了</p> 
<pre><code class="prism language-shell">vim /data/mysqlbackup/mysqlRollBack.cron
</code></pre> 
<h6><a id="22_3_135"></a>2.2 编辑,每天凌晨3点执行一次</h6> 
<p><a href="https://tool.lu/crontab" rel="nofollow">crontab在线工具~~注意和java的cron不一样</a></p> 
<pre><code class="prism language-shell">0 3 * * * /data/mysqlbackup/mysqlBackuoShell.sh
</code></pre> 
<h6><a id="33__143"></a>3.3 执行定时任务命令</h6> 
<pre><code class="prism language-shell"><span class="token function">crontab</span> mysqlRollBack.cron
</code></pre> 
<h6><a id="24_varspoolcroncron_149"></a>2.4 查看定时任务是否成功或者检测/var/spool/cron下是否生成对应cron脚本</h6> 
<pre><code>crontab -l
</code></pre> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@node-test01 /data 18:04:43<span class="token punctuation">]</span><span class="token comment">#crontab -l</span>
0 3 * * * /data/mysqlbackup/mysqlBackuoShell.sh
</code></pre> 
<h6><a id="25__160"></a>2.5 删除定时任务</h6> 
<p>如果不想执行定时任务,直接删除就行了</p> 
<pre><code class="prism language-shell"><span class="token function">crontab</span> -r
</code></pre> 
<h6><a id="26_168"></a>2.6编辑定时任务</h6> 
<p>如果想要修改执行时间,可以编辑</p> 
<pre><code class="prism language-shell"><span class="token function">crontab</span> -e
</code></pre> 
<h4><a id="3_176"></a>3.数据恢复</h4> 
<p>注意,这里只是做了全量备份</p> 
<h6><a id="31_180"></a>3.1删除旧数据库</h6> 
<pre><code>mysql&gt; drop database 数据库名
</code></pre> 
<h6><a id="32__186"></a>3.2 解压备份的文件</h6> 
<pre><code>gzip -d city_challenge-2022-03-05.sql.gz
</code></pre> 
<h6><a id="33__192"></a>3.3 恢复数据</h6> 
<p><strong>1.在系统命令行中，输入如下实现还原：</strong></p> 
<pre><code>mysql -uroot -p12345678 &lt; /data/mysqlbackup/city_challenge-2022-03-05.sql
</code></pre> 
<p><strong>2.在登录进入mysql系统中,通过source指令找到对应系统中的文件进行还原：</strong></p> 
<pre><code>mysql&gt;use city_challenge
mysql&gt; source /data/mysqlbackup/city_challenge-2022-03-05.sql
</code></pre> 
<pre><code>注意一个细节:
若是mysqldump导出一个库的数据，导出文件为a.sql，然后mysql导入这个数据到新的空库下。
如果新库名和老库名不一致，那么需要将a.sql文件里的老库名改为新库名，
这样才能顺利使用mysql命令导入数据（如果使用source命令导入就不需要修改a.sql文件了）。
</code></pre> 
<h3><a id="_216"></a>增量备份</h3> 
<h4><a id="1mysqlbinlog_218"></a>1.开启mysql的binlog日志(增量备份)</h4> 
<h6><a id="11_binlog_220"></a>1.1 查看binlog是否开启</h6> 
<pre><code class="prism language-shell">mysql<span class="token operator">&gt;</span> show variables like <span class="token string">'%log_bin%'</span><span class="token punctuation">;</span>
+---------------------------------+-------+
<span class="token operator">|</span> Variable_name                   <span class="token operator">|</span> Value <span class="token operator">|</span>
+---------------------------------+-------+
<span class="token operator">|</span> log_bin                         <span class="token operator">|</span> OFF   <span class="token operator">|</span>
<span class="token operator">|</span> log_bin_basename                <span class="token operator">|</span>       <span class="token operator">|</span>
<span class="token operator">|</span> log_bin_index                   <span class="token operator">|</span>       <span class="token operator">|</span>
<span class="token operator">|</span> log_bin_trust_function_creators <span class="token operator">|</span> OFF   <span class="token operator">|</span>
<span class="token operator">|</span> log_bin_use_v1_row_events       <span class="token operator">|</span> OFF   <span class="token operator">|</span>
<span class="token operator">|</span> sql_log_bin                     <span class="token operator">|</span> ON    <span class="token operator">|</span>
+---------------------------------+-------+
6 rows <span class="token keyword">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span>0.01 sec<span class="token punctuation">)</span>

</code></pre> 
<p>如果没开启</p> 
<h6><a id="12_mycnf_240"></a>1.2 编辑my.cnf</h6> 
<pre><code>vim /etc/my.cnf
</code></pre> 
<p>增加</p> 
<pre><code>#节点Id,注意集群中不能重复,单节点不配置也可以
server-id=123
#开启binlog日志,指定其存放位置
log-bin=/var/lib/mysql/mysql-bin
#开启binlog自动过期
expire_logs_days=3
</code></pre> 
<h6><a id="13__257"></a>1.3 重启数据库</h6> 
<pre><code>service mysqld restart
</code></pre> 
<p>然后</p> 
<pre><code class="prism language-shell">mysql<span class="token operator">&gt;</span> show variables like <span class="token string">'%log_bin%'</span><span class="token punctuation">;</span>
+---------------------------------+--------------------------------+
<span class="token operator">|</span> Variable_name                   <span class="token operator">|</span> Value                          <span class="token operator">|</span>
+---------------------------------+--------------------------------+
<span class="token operator">|</span> log_bin                         <span class="token operator">|</span> ON                             <span class="token operator">|</span>
<span class="token operator">|</span> log_bin_basename                <span class="token operator">|</span> /var/lib/mysql/mysql-bin       <span class="token operator">|</span>
<span class="token operator">|</span> log_bin_index                   <span class="token operator">|</span> /var/lib/mysql/mysql-bin.index <span class="token operator">|</span>
<span class="token operator">|</span> log_bin_trust_function_creators <span class="token operator">|</span> OFF                            <span class="token operator">|</span>
<span class="token operator">|</span> log_bin_use_v1_row_events       <span class="token operator">|</span> OFF                            <span class="token operator">|</span>
<span class="token operator">|</span> sql_log_bin                     <span class="token operator">|</span> ON                             <span class="token operator">|</span>
+---------------------------------+--------------------------------+
6 rows <span class="token keyword">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span>0.00 sec<span class="token punctuation">)</span>
</code></pre> 
<p>发现已开启binlog</p> 
<p>/var/lib/mysql/mysql-bin是日志文件</p> 
<p>/var/lib/mysql/mysql-bin.index是索引</p> 
<h6><a id="14__286"></a>1.4 查看日志索引和事件位置</h6> 
<pre><code>mysql&gt; show master status;
+------------------+----------+--------------+------------------+-------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
+------------------+----------+--------------+------------------+-------------------+
| mysql-bin.000004 |      154 |              |                  |                   |
+------------------+----------+--------------+------------------+-------------------+
1 row in set (0.00 sec)
</code></pre> 
<p>mysql-bin是日志文件</p> 
<p>000004是索引</p> 
<p>pos=154是事件位置也可以叫偏移值</p> 
<h6><a id="15_304"></a>1.5如何实现增量备份</h6> 
<p>比如上面的每天凌晨3点执行一次全量备份,并且刷新一次binlog(–flush-logs),之前是 mysql-bin.000004,执行</p> 
<p>flush-logs后变成 mysql-bin.000005,那么mysql-bin.000005,中之中就是当日新增的数据</p> 
<h4><a id="2_310"></a>2.一次增量备份</h4> 
<h6><a id="213_312"></a>2.1凌晨3点进行一次全量备份</h6> 
<p>查询binlog</p> 
<pre><code>mysql&gt; show master logs;
+------------------+-----------+
| Log_name         | File_size |
+------------------+-----------+
| mysql-bin.000001 |      7083 |
| mysql-bin.000002 |       201 |
| mysql-bin.000003 |       201 |
| mysql-bin.000004 |       467 |
| mysql-bin.000005 |      1265 |
| mysql-bin.000006 |       201 |
+------------------+-----------+
6 rows in set (0.00 sec)
</code></pre> 
<pre><code class="prism language-shell"><span class="token comment">#全量备份test库,并刷新binlog</span>
mysqldump -u root -p --master-data<span class="token operator">=</span>2 --single-transaction  -F -B    <span class="token function">test</span> <span class="token operator">&gt;</span> /data/mysqlbackup/test5.sql<span class="token punctuation">;</span>
</code></pre> 
<p>再次查询binlog</p> 
<pre><code>mysql&gt; show master logs;
+------------------+-----------+
| Log_name         | File_size |
+------------------+-----------+
| mysql-bin.000001 |      7083 |
| mysql-bin.000002 |       201 |
| mysql-bin.000003 |       201 |
| mysql-bin.000004 |       467 |
| mysql-bin.000005 |      1265 |
| mysql-bin.000006 |       201 |
| mysql-bin.000007 |       154 |
+------------------+-----------+
7 rows in set (0.00 sec)
</code></pre> 
<p>多出了一条</p> 
<p>mysql-bin.000007</p> 
<h6><a id="22_9testuser_358"></a>2.2 早上9点向test.user中插入三条数据</h6> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token keyword">user</span> <span class="token punctuation">(</span> id<span class="token punctuation">,</span> age<span class="token punctuation">,</span>name <span class="token punctuation">)</span> <span class="token keyword">VALUES</span>  <span class="token punctuation">(</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'5'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
mysql<span class="token operator">&gt;</span><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token keyword">user</span> <span class="token punctuation">(</span> id<span class="token punctuation">,</span> age<span class="token punctuation">,</span>name <span class="token punctuation">)</span> <span class="token keyword">VALUES</span>  <span class="token punctuation">(</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">'6'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
mysql<span class="token operator">&gt;</span><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token keyword">user</span> <span class="token punctuation">(</span> id<span class="token punctuation">,</span> age<span class="token punctuation">,</span>name <span class="token punctuation">)</span> <span class="token keyword">VALUES</span>  <span class="token punctuation">(</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">'7'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h6><a id="23_5_366"></a>2.3 下午5点把数据库删了<sub>&gt;</sub></h6> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">drop</span> <span class="token keyword">database</span> test<span class="token punctuation">;</span>
</code></pre> 
<h6><a id="24__372"></a>2.4 如何恢复数据库?</h6> 
<p><em><em>查看最新的mysql-bin.00000</em>?</em>*</p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> master <span class="token keyword">status</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">------------------+----------+--------------+------------------+-------------------+</span>
<span class="token operator">|</span> <span class="token keyword">File</span>             <span class="token operator">|</span> Position <span class="token operator">|</span> Binlog_Do_DB <span class="token operator">|</span> Binlog_Ignore_DB <span class="token operator">|</span> Executed_Gtid_Set <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------+----------+--------------+------------------+-------------------+</span>
<span class="token operator">|</span> mysql<span class="token operator">-</span>bin<span class="token punctuation">.</span><span class="token number">000007</span> <span class="token operator">|</span>      <span class="token number">1109</span> <span class="token operator">|</span>              <span class="token operator">|</span>                  <span class="token operator">|</span>                   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------+----------+--------------+------------------+-------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> 
<p>日志是mysql-bin.000007,pos是1109</p> 
<p><strong>接着刷新日志 flush logs;</strong></p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> flush logs<span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> master logs<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">------------------+-----------+</span>
<span class="token operator">|</span> Log_name         <span class="token operator">|</span> File_size <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------+-----------+</span>
<span class="token operator">|</span> mysql<span class="token operator">-</span>bin<span class="token punctuation">.</span><span class="token number">000001</span> <span class="token operator">|</span>      <span class="token number">7083</span> <span class="token operator">|</span>
<span class="token operator">|</span> mysql<span class="token operator">-</span>bin<span class="token punctuation">.</span><span class="token number">000002</span> <span class="token operator">|</span>       <span class="token number">201</span> <span class="token operator">|</span>
<span class="token operator">|</span> mysql<span class="token operator">-</span>bin<span class="token punctuation">.</span><span class="token number">000003</span> <span class="token operator">|</span>       <span class="token number">201</span> <span class="token operator">|</span>
<span class="token operator">|</span> mysql<span class="token operator">-</span>bin<span class="token punctuation">.</span><span class="token number">000004</span> <span class="token operator">|</span>       <span class="token number">467</span> <span class="token operator">|</span>
<span class="token operator">|</span> mysql<span class="token operator">-</span>bin<span class="token punctuation">.</span><span class="token number">000005</span> <span class="token operator">|</span>      <span class="token number">1265</span> <span class="token operator">|</span>
<span class="token operator">|</span> mysql<span class="token operator">-</span>bin<span class="token punctuation">.</span><span class="token number">000006</span> <span class="token operator">|</span>       <span class="token number">201</span> <span class="token operator">|</span>
<span class="token operator">|</span> mysql<span class="token operator">-</span>bin<span class="token punctuation">.</span><span class="token number">000007</span> <span class="token operator">|</span>      <span class="token number">1156</span> <span class="token operator">|</span>
<span class="token operator">|</span> mysql<span class="token operator">-</span>bin<span class="token punctuation">.</span><span class="token number">000008</span> <span class="token operator">|</span>       <span class="token number">154</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------+-----------+</span>
<span class="token number">8</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

</code></pre> 
<p>接着新的日志就会输出到mysql-bin.000008上,以便我们分析mysql-bin.000007的数据</p> 
<p><strong>查看mysql-bin.000007</strong></p> 
<p>方式1</p> 
<pre><code class="prism language-shell"><span class="token comment">#-vvv :查看sql,方便判断pos点</span>
<span class="token comment">#--base64-output=decode-rows :  base64编码的数据转成row(没看到有啥用)</span>
mysqlbinlog -vvv --base64-output<span class="token operator">=</span>decode-rows   mysql-bin.000007
</code></pre> 
<p>部分</p> 
<pre><code class="prism language-shell">/*<span class="token operator">!</span>*/<span class="token punctuation">;</span>
<span class="token comment"># at 823</span>
<span class="token comment">#220307 14:32:40 server id 1  end_log_pos 874 CRC32 0x6a5153c0 	Table_map: `test`.`user` mapped to number 156</span>
<span class="token comment"># at 874</span>
<span class="token comment">#220307 14:32:40 server id 1  end_log_pos 921 CRC32 0x9df18a8f 	Write_rows: table id 156 flags: STMT_END_F</span>
<span class="token comment">### INSERT INTO `test`.`user`</span>
<span class="token comment">### SET</span>
<span class="token comment">###   @1=7 /* INT meta=0 nullable=0 is_null=0 */</span>
<span class="token comment">###   @2=7 /* INT meta=0 nullable=1 is_null=0 */</span>
<span class="token comment">###   @3='7' /* VARSTRING(1020) meta=1020 nullable=1 is_null=0 */</span>
<span class="token comment"># at 921</span>
<span class="token comment">#220307 14:32:40 server id 1  end_log_pos 952 CRC32 0xaa3f5c7b 	Xid = 7046</span>
COMMIT/*<span class="token operator">!</span>*/<span class="token punctuation">;</span>
<span class="token comment"># at 952</span>
<span class="token comment">#220307 14:37:44 server id 1  end_log_pos 1017 CRC32 0x8914e925 	Anonymous_GTID	last_committed=3	sequence_number=4	rbr_only=no</span>
SET @@SESSION.GTID_NEXT<span class="token operator">=</span> <span class="token string">'ANONYMOUS'</span>/*<span class="token operator">!</span>*/<span class="token punctuation">;</span>
<span class="token comment"># at 1017</span>
<span class="token comment">#220307 14:37:44 server id 1  end_log_pos 1109 CRC32 0xb100a121 	Query	thread_id=124	exec_time=0	error_code=0</span>
SET TIMESTAMP<span class="token operator">=</span>1646635064/*<span class="token operator">!</span>*/<span class="token punctuation">;</span>
drop database <span class="token function">test</span>
/*<span class="token operator">!</span>*/<span class="token punctuation">;</span>
SET @@SESSION.GTID_NEXT<span class="token operator">=</span> <span class="token string">'AUTOMATIC'</span> /* added by mysqlbinlog */ /*<span class="token operator">!</span>*/<span class="token punctuation">;</span>
DELIMITER <span class="token punctuation">;</span>
<span class="token comment"># End of log file</span>
/*<span class="token operator">!</span>50003 SET COMPLETION_TYPE<span class="token operator">=</span>@OLD_COMPLETION_TYPE*/<span class="token punctuation">;</span>
/*<span class="token operator">!</span>50530 SET @@SESSION.PSEUDO_SLAVE_MODE<span class="token operator">=</span>0*/<span class="token punctuation">;</span>

</code></pre> 
<p>方式2</p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span><span class="token keyword">show</span> binlog events <span class="token operator">in</span> <span class="token string">'mysql-bin.000007'</span>\G<span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-shell">mysql<span class="token operator">&gt;</span> show binlog events <span class="token keyword">in</span> <span class="token string">'mysql-bin.000007'</span><span class="token punctuation">;</span>
+------------------+------+----------------+-----------+-------------+---------------------------------------+
<span class="token operator">|</span> Log_name         <span class="token operator">|</span> Pos  <span class="token operator">|</span> Event_type     <span class="token operator">|</span> Server_id <span class="token operator">|</span> End_log_pos <span class="token operator">|</span> Info                                  <span class="token operator">|</span>
+------------------+------+----------------+-----------+-------------+---------------------------------------+
<span class="token operator">|</span> mysql-bin.000007 <span class="token operator">|</span>    4 <span class="token operator">|</span> Format_desc    <span class="token operator">|</span>         1 <span class="token operator">|</span>         123 <span class="token operator">|</span> Server ver: 5.7.37-log, Binlog ver: 4 <span class="token operator">|</span>
<span class="token operator">|</span> mysql-bin.000007 <span class="token operator">|</span>  123 <span class="token operator">|</span> Previous_gtids <span class="token operator">|</span>         1 <span class="token operator">|</span>         154 <span class="token operator">|</span>                                       <span class="token operator">|</span>
<span class="token operator">|</span> mysql-bin.000007 <span class="token operator">|</span>  154 <span class="token operator">|</span> Anonymous_Gtid <span class="token operator">|</span>         1 <span class="token operator">|</span>         219 <span class="token operator">|</span> SET @@SESSION.GTID_NEXT<span class="token operator">=</span> <span class="token string">'ANONYMOUS'</span>  <span class="token operator">|</span>
<span class="token operator">|</span> mysql-bin.000007 <span class="token operator">|</span>  219 <span class="token operator">|</span> Query          <span class="token operator">|</span>         1 <span class="token operator">|</span>         291 <span class="token operator">|</span> BEGIN                                 <span class="token operator">|</span>
<span class="token operator">|</span> mysql-bin.000007 <span class="token operator">|</span>  291 <span class="token operator">|</span> Table_map      <span class="token operator">|</span>         1 <span class="token operator">|</span>         342 <span class="token operator">|</span> table_id: 156 <span class="token punctuation">(</span>test.user<span class="token punctuation">)</span>             <span class="token operator">|</span>
<span class="token operator">|</span> mysql-bin.000007 <span class="token operator">|</span>  342 <span class="token operator">|</span> Write_rows     <span class="token operator">|</span>         1 <span class="token operator">|</span>         389 <span class="token operator">|</span> table_id: 156 flags: STMT_END_F       <span class="token operator">|</span>
<span class="token operator">|</span> mysql-bin.000007 <span class="token operator">|</span>  389 <span class="token operator">|</span> Xid            <span class="token operator">|</span>         1 <span class="token operator">|</span>         420 <span class="token operator">|</span> COMMIT /* xid<span class="token operator">=</span>7033 */                 <span class="token operator">|</span>
<span class="token operator">|</span> mysql-bin.000007 <span class="token operator">|</span>  420 <span class="token operator">|</span> Anonymous_Gtid <span class="token operator">|</span>         1 <span class="token operator">|</span>         485 <span class="token operator">|</span> SET @@SESSION.GTID_NEXT<span class="token operator">=</span> <span class="token string">'ANONYMOUS'</span>  <span class="token operator">|</span>
<span class="token operator">|</span> mysql-bin.000007 <span class="token operator">|</span>  485 <span class="token operator">|</span> Query          <span class="token operator">|</span>         1 <span class="token operator">|</span>         557 <span class="token operator">|</span> BEGIN                                 <span class="token operator">|</span>
<span class="token operator">|</span> mysql-bin.000007 <span class="token operator">|</span>  557 <span class="token operator">|</span> Table_map      <span class="token operator">|</span>         1 <span class="token operator">|</span>         608 <span class="token operator">|</span> table_id: 156 <span class="token punctuation">(</span>test.user<span class="token punctuation">)</span>             <span class="token operator">|</span>
<span class="token operator">|</span> mysql-bin.000007 <span class="token operator">|</span>  608 <span class="token operator">|</span> Write_rows     <span class="token operator">|</span>         1 <span class="token operator">|</span>         655 <span class="token operator">|</span> table_id: 156 flags: STMT_END_F       <span class="token operator">|</span>
<span class="token operator">|</span> mysql-bin.000007 <span class="token operator">|</span>  655 <span class="token operator">|</span> Xid            <span class="token operator">|</span>         1 <span class="token operator">|</span>         686 <span class="token operator">|</span> COMMIT /* xid<span class="token operator">=</span>7043 */                 <span class="token operator">|</span>
<span class="token operator">|</span> mysql-bin.000007 <span class="token operator">|</span>  686 <span class="token operator">|</span> Anonymous_Gtid <span class="token operator">|</span>         1 <span class="token operator">|</span>         751 <span class="token operator">|</span> SET @@SESSION.GTID_NEXT<span class="token operator">=</span> <span class="token string">'ANONYMOUS'</span>  <span class="token operator">|</span>
<span class="token operator">|</span> mysql-bin.000007 <span class="token operator">|</span>  751 <span class="token operator">|</span> Query          <span class="token operator">|</span>         1 <span class="token operator">|</span>         823 <span class="token operator">|</span> BEGIN                                 <span class="token operator">|</span>
<span class="token operator">|</span> mysql-bin.000007 <span class="token operator">|</span>  823 <span class="token operator">|</span> Table_map      <span class="token operator">|</span>         1 <span class="token operator">|</span>         874 <span class="token operator">|</span> table_id: 156 <span class="token punctuation">(</span>test.user<span class="token punctuation">)</span>             <span class="token operator">|</span>
<span class="token operator">|</span> mysql-bin.000007 <span class="token operator">|</span>  874 <span class="token operator">|</span> Write_rows     <span class="token operator">|</span>         1 <span class="token operator">|</span>         921 <span class="token operator">|</span> table_id: 156 flags: STMT_END_F       <span class="token operator">|</span>
<span class="token operator">|</span> mysql-bin.000007 <span class="token operator">|</span>  921 <span class="token operator">|</span> Xid            <span class="token operator">|</span>         1 <span class="token operator">|</span>         952 <span class="token operator">|</span> COMMIT /* xid<span class="token operator">=</span>7046 */                 <span class="token operator">|</span>
<span class="token operator">|</span> mysql-bin.000007 <span class="token operator">|</span>  952 <span class="token operator">|</span> Anonymous_Gtid <span class="token operator">|</span>         1 <span class="token operator">|</span>        1017 <span class="token operator">|</span> SET @@SESSION.GTID_NEXT<span class="token operator">=</span> <span class="token string">'ANONYMOUS'</span>  <span class="token operator">|</span>
<span class="token operator">|</span> mysql-bin.000007 <span class="token operator">|</span> 1017 <span class="token operator">|</span> Query          <span class="token operator">|</span>         1 <span class="token operator">|</span>        1109 <span class="token operator">|</span> drop database <span class="token function">test</span>                    <span class="token operator">|</span>
<span class="token operator">|</span> mysql-bin.000007 <span class="token operator">|</span> 1109 <span class="token operator">|</span> Rotate         <span class="token operator">|</span>         1 <span class="token operator">|</span>        1156 <span class="token operator">|</span> mysql-bin.000008<span class="token punctuation">;</span>pos<span class="token operator">=</span>4                <span class="token operator">|</span>
+------------------+------+----------------+-----------+-------------+---------------------------------------+
20 rows <span class="token keyword">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span>0.00 sec<span class="token punctuation">)</span>

</code></pre> 
<p>找到问题pos在<code>1017~1109</code>之间</p> 
<p><strong>所以将数据恢复到1017之前就可以了</strong></p> 
<p>1.先将昨天的全量备份恢复</p> 
<pre><code class="prism language-shell">mysql -uroot -p -v  <span class="token operator">&lt;</span>test5.sql
</code></pre> 
<p>查看数据库,发现test已经恢复</p> 
<pre><code class="prism language-shell">mysql<span class="token operator">&gt;</span> show databases<span class="token punctuation">;</span>    
+--------------------+
<span class="token operator">|</span> Database           <span class="token operator">|</span>
+--------------------+
<span class="token operator">|</span> information_schema <span class="token operator">|</span>
<span class="token operator">|</span> city_challenge     <span class="token operator">|</span>
<span class="token operator">|</span> ds_0               <span class="token operator">|</span>
<span class="token operator">|</span> ds_1               <span class="token operator">|</span>
<span class="token operator">|</span> mysql              <span class="token operator">|</span>
<span class="token operator">|</span> performance_schema <span class="token operator">|</span>
<span class="token operator">|</span> sys                <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token function">test</span>               <span class="token operator">|</span>
+--------------------+
8 rows <span class="token keyword">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span>0.00 sec<span class="token punctuation">)</span>
</code></pre> 
<p>2.恢复今天删库之前的数据</p> 
<p>方式一:</p> 
<pre><code class="prism language-shell">mysqlbinlog --stop-position<span class="token operator">=</span>1017 -d <span class="token function">test</span>  mysql-bin.000007 <span class="token operator">|</span> mysql -uroot -p12345678 
</code></pre> 
<p>mysqlbinlog恢复数据常用参数:</p> 
<pre><code class="prism language-shell">常用参数选项解释：
--start-position<span class="token operator">=</span>875 起始pos点
--stop-position<span class="token operator">=</span>954 结束pos点
--start-datetime<span class="token operator">=</span><span class="token string">"2016-9-25 22:01:08"</span> 起始时间点
--stop-datetime<span class="token operator">=</span><span class="token string">"2019-9-25 22:09:46"</span> 结束时间点
--skip-gtids是忽略GTIDs报错
-d 指定数据库
</code></pre> 
<p><strong>原理:实际是将读出的binlog日志内容，通过管道符传递给mysql命令</strong></p> 
<p>方式二:</p> 
<pre><code class="prism language-shell">mysqlbinlog --stop-position<span class="token operator">=</span>1017 -d <span class="token function">test</span>  mysql-bin.000007 <span class="token operator">&gt;</span>testa.sql
</code></pre> 
<pre><code class="prism language-shell">mysql -uroot -p12345678 <span class="token operator">&lt;</span> /data/mysqlbackup/testa.sql
</code></pre> 
<p><strong>原理:参照全量备份</strong></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/681859c1938773379187fee21b9c4f63/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">23. 电容触摸按键实验</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1dd167fa8856c89c25388fb23892a656/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">vue项目打包后，由于html被缓存导致出现白屏的处理</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>