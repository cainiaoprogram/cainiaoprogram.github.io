<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【Rcode】生存分析： KM &amp; COX回归&amp; 随机森林&amp; nomogram - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【Rcode】生存分析： KM &amp; COX回归&amp; 随机森林&amp; nomogram" />
<meta property="og:description" content="本文使用了R——survival包下的lung数据进行方法测试：
1）KM 2) Cox回归：多因素 3）随机森林因子（根据cox回归结果） 4）nomogram （ 根据cox回归结果，建立了中位生存时间，1年5年生存率的概率计算）
-----🧚🏽‍♀️本文只有干货，非常干！🤣-----
一、数据加载 #生存分析
library(&#34;survival&#34;) library(&#34;survminer&#34;) data(&#34;lung&#34;) head(lung) 结果： &lt;head(lung) inst time status age sex ph.ecog ph.karno pat.karno meal.cal wt.loss 1 3 306 2 74 1 1 90 100 1175 NA 2 3 455 2 68 1 0 90 90 1225 15 3 3 1010 1 56 1 0 90 90 NA 15 4 5 210 2 57 1 1 90 60 1150 11 5 1 883 2 60 1 0 100 90 NA 0 6 12 1022 1 74 1 1 50 80 513 0 二、KM方法和非参数检验 #---------------KM方法-------------------------" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/6d9b3cf698f00ab81c0213a7f815f282/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-01-29T12:11:54+08:00" />
<meta property="article:modified_time" content="2021-01-29T12:11:54+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【Rcode】生存分析： KM &amp; COX回归&amp; 随机森林&amp; nomogram</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><em><strong>本文使用了R——survival包下的lung数据进行方法测试</strong></em>：</p> 
<h5><a id="1KM_2"></a>1）KM</h5> 
<h5><a id="2___Cox_3"></a>2) Cox回归：多因素</h5> 
<h5><a id="3cox_4"></a>3）随机森林因子（根据cox回归结果）</h5> 
<h5><a id="4nomogram_5"></a>4）nomogram</h5> 
<p>（ 根据cox回归结果，建立了中位生存时间，1年5年生存率的概率计算）</p> 
<p>-----<strong>🧚🏽‍♀️本文只有干货，非常干！🤣</strong>-----</p> 
<h4><a id="_10"></a>一、数据加载</h4> 
<p>#生存分析</p> 
<pre><code>library("survival")
library("survminer")

data("lung")
head(lung)
</code></pre> 
<pre><code>结果：
&lt;head(lung)
  inst time status age sex ph.ecog ph.karno pat.karno meal.cal wt.loss
1    3  306      2  74   1       1       90       100     1175      NA
2    3  455      2  68   1       0       90        90     1225      15
3    3 1010      1  56   1       0       90        90       NA      15
4    5  210      2  57   1       1       90        60     1150      11
5    1  883      2  60   1       0      100        90       NA       0
6   12 1022      1  74   1       1       50        80      513       0
</code></pre> 
<h4><a id="KM_35"></a>二、KM方法和非参数检验</h4> 
<p>#---------------KM方法-------------------------</p> 
<pre><code>fit&lt;-survfit(Surv(time,status)~sex,data=lung)  #拟合生存函数
print(fit)
res.sum&lt;-surv_summary(fit)#看整体结果
head(res.sum)
#绘制KM曲线
ggsurvplot(fit,
           pval=TRUE,#添加P值
           conf.int = TRUE,#增加置信区间
           risk.tabel.col="strata",  #change risk tabel color by groups
           linetype = "strata",      #change line type by groups
           surv.median.line = "hv",   #specify median survival 增加中位生存时间
           ggtheme = theme_bw(),      #change ggplots theme
           palette = c("hue"),
           #palette = c("#E7B800","#2E9FDF"),#自定义调色板
           risk.table = TRUE,#add risk tabel绘制累计风险曲线
           xlab = "Follow up time(d)", # 指定x轴标签
           legend = c(0.8,0.75), # 指定图例位置
           legend.title = "", # 设置图例标题
           legend.labs = c("Male", "Female"), # 指定图例分组标签
           break.x.by = 100
           #fun="event"
           )

</code></pre> 
<p><img src="https://images2.imgbox.com/57/8e/LPNIk9D0_o.png" alt="在这里插入图片描述"></p> 
<pre><code>结果：
Call: survfit(formula = Surv(time, status) ~ sex, data = lung)

        n events median 0.95LCL 0.95UCL
sex=1 138    112    270     212     310
sex=2  90     53    426     348     550
&gt; res.sum&lt;-surv_summary(fit)#看整体结果
</code></pre> 
<h4><a id="cox_77"></a>三、cox方法和结果</h4> 
<p>#----------------cox方法-------------------------</p> 
<pre><code>data("lung")
head(lung)

res.cox&lt;-coxph(Surv(time,status)~age+sex+ph.ecog,data=lung) #多因素COX回归：age+sex+ph.ecog对生存结局的影响
#这里先做单因素分析纳入P&lt;0.05的，或者临床认为显著相关的
summary(res.cox)

ggsurvplot(survfit(res.cox),
           data=lung,
           palette = "#2E9FDF",
           ggtheme = theme_minimal(),
           legend="none"
           )
</code></pre> 
<p><img src="https://images2.imgbox.com/bb/c6/rdbJU65U_o.png" alt="在这里插入图片描述"></p> 
<pre><code>结果：
Call:
coxph(formula = Surv(time, status) ~ age + sex + ph.ecog, data = lung)

  n= 227, number of events= 164 
   (1 observation deleted due to missingness)

             coef exp(coef)  se(coef)      z Pr(&gt;|z|)    
age      0.011067  1.011128  0.009267  1.194 0.232416    
sex     -0.552612  0.575445  0.167739 -3.294 0.000986 ***
ph.ecog  0.463728  1.589991  0.113577  4.083 4.45e-05 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

        exp(coef) exp(-coef) lower .95 upper .95
age        1.0111     0.9890    0.9929    1.0297
sex        0.5754     1.7378    0.4142    0.7994
ph.ecog    1.5900     0.6289    1.2727    1.9864

Concordance= 0.637  (se = 0.025 )
Likelihood ratio test= 30.5  on 3 df,   p=1e-06
Wald test            = 29.93  on 3 df,   p=1e-06
Score (logrank) test = 30.5  on 3 df,   p=1e-06
</code></pre> 
<p>#根据cox回归结果，绘制基础森林图</p> 
<pre><code>ggforest(res.cox, data = lung,
         main = 'Hazard ratio of LIHC',  #标题
         cpositions = c(0.05, 0.15, 0.35),  #前三列距离
         fontsize = 1, #字体大小
         refLabel = 'reference', #相对变量的数值标签，也可改为1
         noDigits = 3 #保留HR值以及95%CI的小数位数
         )

</code></pre> 
<p><img src="https://images2.imgbox.com/cf/84/wrZ6IoaS_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="cox_142"></a>四、诺莫图：根据cox方法</h4> 
<p>先安装和加载包</p> 
<pre><code>#install.packages("rms")
library(rms)
</code></pre> 
<h3><a id="COX_149"></a>构建COX比例风险模型</h3> 
<pre><code>dd=datadist(lung)
options(datadist="dd")

f2 &lt;- psm(Surv(time,status) ~ age+sex+ph.ecog,data =  lung, dist='lognormal')

med &lt;- Quantile(f2) # 计算中位生存时间
surv &lt;- Survival(f2) # 构建生存概率函数
</code></pre> 
<h3><a id="COXNomogram_161"></a>绘制COX回归中位生存时间的Nomogram图</h3> 
<pre><code>nom &lt;- nomogram(f2, fun=function(x) med(lp=x),funlabel="Median Survival Time")
plot(nom)
</code></pre> 
<p><img src="https://images2.imgbox.com/fe/0b/mNhbTc1z_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="COXNomogram_171"></a>绘制COX回归生存概率的Nomogram图</h3> 
<pre><code>nom2 &lt;- nomogram(f2, fun=list(function(x) surv(365, x),
                             function(x) surv(1825, x),
                             function(x) med(lp=x)),
                funlabel=c("1-year Survival Probability", "5-year Survival Probability","Median Survival Time"))
plot(nom2, xfrac=.2)
</code></pre> 
<p><img src="https://images2.imgbox.com/26/86/wcuMMsy6_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4bcab6bcfe4a254aefba532720792a6e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">RTSP协议视频智能分析/智能识别系统EasyNVR运行一段时间后自动掉线如何排查？</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/22a5e6a361ce5d9601bc4126f6b37a87/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Java注解@Mock和@InjectMocks及@Mock和@Spy之间的区别</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>