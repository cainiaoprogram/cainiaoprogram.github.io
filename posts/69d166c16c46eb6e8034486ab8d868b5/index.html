<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>nginx(多实例)安装部署操作参考(linux) - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="nginx(多实例)安装部署操作参考(linux)" />
<meta property="og:description" content="1. 安装环境准备 1.1 主机环境准备 1.1.1. 关闭selinux sed -i &#39;s/SELINUX=enforcing/SELINUX=disabled/g&#39; /etc/selinux/config setenforce 0 1.1.2. 部署规划 实例1安装规划
软件安装路径：/usr/local/nginx/
软件日志路径：/usr/local/nginx/logs/
软件二进制路径：/usr/local/nginx/sbin/
软件缓存代理等路径：/usr/local/nginx/{client_body,proxy,fastcgi,uwsgi,scgi}
软件主配置文件路径：/usr/local/nginx/conf
软件子配置文件路径：/usr/local/nginx/conf/conf.d/
Pidfile路径：/usr/local/nginx/logs/nginx.pid
Lockfile路径：/var/lock/nginx.lock
sbin-path路径：/usr/local/nginx/sbin/nginx
端口规划：80
实例2安装规划
软件安装路径：/usr/local/nginx2/
软件日志路径：/usr/local/nginx2/logs/
软件二进制路径：/usr/local/nginx2/sbin/
软件缓存代理等路径：/usr/local/nginx2/{client_body,proxy,fastcgi,uwsgi,scgi}
软件主配置文件路径：/usr/local/nginx2/conf
软件子配置文件路径：/usr/local/nginx2/conf/conf.d/
Pidfile路径：/usr/local/nginx2/logs/nginx2.pid
Lockfile路径：/var/lock/nginx2.lock
sbin-path路径：/usr/local/nginx2/sbin/nginx2
端口规划 ：8080
1.1.3. 系统主机时间、时区、系统语言 l 本节视实际情况需要操作
l 修改时区 ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime l 修改系统语言环境 echo &#39;LANG=&#34;en_US.UTF-8&#34;&#39; &gt;&gt; /etc/profile &amp;&amp; source /etc/profile l 配置主机NTP时间同步 yum -y install ntp systemctl enable ntpd &amp;&amp; systemctl start ntpd echo &#39;server ntp1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/69d166c16c46eb6e8034486ab8d868b5/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-11-25T21:22:50+08:00" />
<meta property="article:modified_time" content="2020-11-25T21:22:50+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">nginx(多实例)安装部署操作参考(linux)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="1__0"></a>1. 安装环境准备</h3> 
<h3><a id="11__2"></a>1.1 主机环境准备</h3> 
<h3><a id="111_selinux_4"></a>1.1.1. 关闭selinux</h3> 
<pre><code class="prism language-html">sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config
setenforce 0
</code></pre> 
<h3><a id="112__11"></a>1.1.2. 部署规划</h3> 
<p><strong>实例1安装规划</strong></p> 
<p>软件安装路径：/usr/local/nginx/</p> 
<p>软件日志路径：/usr/local/nginx/logs/</p> 
<p>软件二进制路径：/usr/local/nginx/sbin/</p> 
<p>软件缓存代理等路径：/usr/local/nginx/{client_body,proxy,fastcgi,uwsgi,scgi}</p> 
<p>软件主配置文件路径：/usr/local/nginx/conf</p> 
<p>软件子配置文件路径：/usr/local/nginx/conf/conf.d/</p> 
<p>Pidfile路径：/usr/local/nginx/logs/nginx.pid</p> 
<p>Lockfile路径：/var/lock/nginx.lock</p> 
<p>sbin-path路径：/usr/local/nginx/sbin/nginx</p> 
<p>端口规划：80</p> 
<p><strong>实例2安装规划</strong></p> 
<p>软件安装路径：/usr/local/nginx2/</p> 
<p>软件日志路径：/usr/local/nginx2/logs/</p> 
<p>软件二进制路径：/usr/local/nginx2/sbin/</p> 
<p>软件缓存代理等路径：/usr/local/nginx2/{client_body,proxy,fastcgi,uwsgi,scgi}</p> 
<p>软件主配置文件路径：/usr/local/nginx2/conf</p> 
<p>软件子配置文件路径：/usr/local/nginx2/conf/conf.d/</p> 
<p>Pidfile路径：/usr/local/nginx2/logs/nginx2.pid</p> 
<p>Lockfile路径：/var/lock/nginx2.lock</p> 
<p>sbin-path路径：/usr/local/nginx2/sbin/nginx2</p> 
<p>端口规划 ：8080</p> 
<h3><a id="113__59"></a>1.1.3. 系统主机时间、时区、系统语言</h3> 
<p>l 本节视实际情况需要操作</p> 
<pre><code class="prism language-html">l  修改时区
ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
l  修改系统语言环境
echo 'LANG="en_US.UTF-8"' &gt;&gt; /etc/profile &amp;&amp; source /etc/profile
l  配置主机NTP时间同步
yum -y install ntp
systemctl enable ntpd &amp;&amp; systemctl start ntpd
echo 'server ntp1.aliyun.com' &gt;&gt; /etc/ntp.conf
echo 'server ntp2.aliyun.com' &gt;&gt; /etc/ntp.conf
</code></pre> 
<h3><a id="2_Nginx_75"></a>2. Nginx安装部署</h3> 
<p>备注：2.2章节、2.3章节与2.4章节的依赖包可使用yum直接安装，安装指令如下：</p> 
<pre><code class="prism language-html">yum install -y pcre-devel zlib-devel openssl-devel
</code></pre> 
<p>也可按本文档使用源码安装。如果使用yum安装，要注意nginx的安装参数要删除如下三行</p> 
<pre><code class="prism language-html">--with-pcre=../pcre-8.44 \
--with-zlib=../zlib-1.2.11 \
--with-openssl=../openssl-1.1.1g \  
</code></pre> 
<h3><a id="21_Nginx_91"></a>2.1 Nginx依赖安装与环境准备</h3> 
<p>l 添加用户与用户组（用户名请自行定义）</p> 
<pre><code class="prism language-html">groupadd -r nginx &amp;&amp; useradd -s /sbin/nologin -r -g nginx nginx
</code></pre> 
<p>l CentOS平台安装依赖</p> 
<pre><code class="prism language-html">yum -y install gcc gcc-c++ automake autoconf libtool make wget net-tools
yum install -y libxslt* libxml2* gd-devel perl-devel perl-ExtUtils-Embed GeoIP GeoIP-devel GeoIP-data
</code></pre> 
<p>l 下载nginx-1.19.1.tar.gz安装包，并解压</p> 
<pre><code class="prism language-html">cd /opt
wget http://nginx.org/download/nginx-1.19.1.tar.gz
tar -zxvf nginx-1.19.1.tar.gz
</code></pre> 
<p>l 从根源上隐藏nginx版本号</p> 
<p>(1)修改nginx.h文件如下三行配置信息变更，举例如下</p> 
<pre><code class="prism language-html">vi /opt/nginx-1.19.1/src/core/nginx.h
修改前
#define nginx_version      1019001
#define NGINX_VERSION      "1.19.1"
#define NGINX_VER          "nginx/" NGINX_VERSION
修改后
#define nginx_version      1010001
#define NGINX_VERSION      "618"
#define NGINX_VER          "WEB/" NGINX_VERSION
</code></pre> 
<p>(2)修改ngx_http_header_filter_module.c文件的ngx_http_server_string显示名称与步骤1中的NGINX_VER名称一致</p> 
<pre><code class="prism language-html">vi /opt/nginx-1.19.1/src/http/ngx_http_header_filter_module.c
修改前
static u_char ngx_http_server_string[] = "Server: nginx" CRLF;
static u_char ngx_http_server_full_string[] = "Server: " NGINX_VER CRLF;
static u_char ngx_http_server_build_string[] = "Server: " NGINX_VER_BUILD CRLF;
修改后
static u_char ngx_http_server_string[] = "Server: WEB" CRLF;
static u_char ngx_http_server_full_string[] = "Server: " NGINX_VER CRLF;
static u_char ngx_http_server_build_string[] = "Server: " NGINX_VER_BUILD CRLF;
</code></pre> 
<p>(2)修改ngx_http_special_response.c文件的ngx_http_error_tail显示名称与步骤1中的NGINX_VER名称一致</p> 
<pre><code class="prism language-html">vi /opt/nginx-1.19.1/src/http/ngx_http_special_response.c
修改前
static u_char ngx_http_error_tail[] =
"<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>center</span><span class="token punctuation">&gt;</span></span>nginx<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>center</span><span class="token punctuation">&gt;</span></span>" CRLF
"<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>" CRLF
"<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>" CRLF
;
修改后
static u_char ngx_http_error_tail[] =
"<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>center</span><span class="token punctuation">&gt;</span></span>WEB<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>center</span><span class="token punctuation">&gt;</span></span>" CRLF
"<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>" CRLF
"<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>" CRLF
;
</code></pre> 
<p>注：修改完成后注意保存配置文件</p> 
<p>l Nginx部署环境准备</p> 
<pre><code class="prism language-html">mkdir -pv /usr/local/nginx/{logs,client_body,proxy,fastcgi,uwsgi,scgi}
chown -R nginx:nginx /usr/local/nginx
</code></pre> 
<h3><a id="22_Pcre_171"></a>2.2 Pcre安装</h3> 
<pre><code class="prism language-html">cd /opt
wget https://ftp.pcre.org/pub/pcre/pcre-8.44.tar.gz
tar -zxvf pcre-8.44.tar.gz
cd pcre-8.44/
./configure
make &amp;&amp; make install
</code></pre> 
<p>2.3 Zlib安装</p> 
<pre><code class="prism language-html">cd /opt
wget http://www.zlib.net/fossils/zlib-1.2.11.tar.gz
tar -zxvf zlib-1.2.11.tar.gz
cd zlib-1.2.11
./configure
make &amp;&amp; make install
</code></pre> 
<h3><a id="24_Openssl_193"></a>2.4 Openssl安装</h3> 
<pre><code class="prism language-html">cd /opt
wget https://ftp.openssl.org/source/old/1.1.1/openssl-1.1.1g.tar.gz
tar -zxvf openssl-1.1.1g.tar.gz
cd openssl-1.1.1g
./config
make &amp;&amp; make install
openssl version
OpenSSL 1.1.1g  31 Mar 2020
</code></pre> 
<p>l 备注：如果openssl版本输入不对应，需要重装，建议使用如下方法</p> 
<pre><code class="prism language-html">cd openssl-OpenSSL_1_1_1g
./config  --prefix=/usr/local/openssl
make
make install
ln -s /usr/local/openssl/lib/libssl.so.1.1 /usr/local/lib/
ln -s /usr/local/openssl/lib/libcrypto.so.1.1  /usr/local/lib/
ln -s /usr/local/lib/libssl.so.1.1  /usr/lib/
ln -s /usr/local/lib/libcrypto.so.1.1  /usr/lib/
ln -s /usr/local/lib/libssl.so.1.1  /usr/lib64/
ln -s /usr/local/lib/libcrypto.so.1.1  /usr/lib64/
/usr/local/openssl/bin/openssl version
ldd /usr/local/openssl/bin/openssl
ldconfig -v
mv /usr/bin/openssl /usr/bin/openssl.old
ln -s /usr/local/openssl/bin/openssl /usr/bin/openssl
openssl version
OpenSSL 1.1.1f  31 Mar 2020
</code></pre> 
<p>l nginx安装时则需要指定openssl路径</p> 
<pre><code class="prism language-html">--with-openssl=../openssl-1.1.1g \
</code></pre> 
<h3><a id="25_Nginx_234"></a>2.5 Nginx安装</h3> 
<pre><code class="prism language-html">cd /opt/nginx-1.19.1
./configure \
--prefix=/usr/local/nginx \
--pid-path=/usr/local/nginx/logs/nginx.pid  \
--user=nginx \
--group=nginx \
--with-http_ssl_module \
--with-http_v2_module \
--with-http_dav_module \
--with-http_flv_module \
--with-http_realip_module \
--with-http_addition_module \
--with-http_xslt_module \
--with-http_stub_status_module \
--with-http_sub_module \
--with-http_random_index_module \
--with-http_degradation_module \
--with-http_secure_link_module \
--with-http_gzip_static_module \
--with-http_perl_module \
--with-pcre=../pcre-8.44 \
--with-zlib=../zlib-1.2.11 \
--with-openssl=../openssl-1.1.1g \
--with-debug \
--with-file-aio \
--with-mail \
--with-mail_ssl_module \
--http-client-body-temp-path=/usr/local/nginx/client_body \
--http-proxy-temp-path=/usr/local/nginx/proxy \
--http-fastcgi-temp-path=/usr/local/nginx/fastcgi \
--http-uwsgi-temp-path=/usr/local/nginx/uwsgi \
--http-scgi-temp-path=/usr/local/nginx/scgi \
--with-stream \
--with-ld-opt="-Wl,-E"
make &amp;&amp; make install
</code></pre> 
<h3><a id="26_Nginx2_274"></a>2.6 Nginx2安装</h3> 
<p>l 添加用户与用户组（用户名请自行定义）</p> 
<pre><code class="prism language-html">groupadd -r nginx2 &amp;&amp; useradd -s /sbin/nologin -r -g nginx2 nginx2
</code></pre> 
<p>l Nginx2部署环境准备</p> 
<pre><code class="prism language-html">mkdir -pv /usr/local/nginx2/{logs,client_body,proxy,fastcgi,uwsgi,scgi}
chown -R nginx2:nginx2 /usr/local/nginx2
</code></pre> 
<p>l Nginx2安装</p> 
<pre><code class="prism language-html">cd /opt/nginx-1.19.1
./configure \
--prefix=/usr/local/nginx2 \
--pid-path=/usr/local/nginx2/logs/nginx2.pid  \
--sbin-path=/usr/local/nginx2/sbin/nginx2 \
--conf-path=/usr/local/nginx2/conf/nginx.conf \
--error-log-path=/usr/local/nginx2/logs/error.log \
--http-log-path=/usr/local/nginx2/logs/access.log \
--lock-path=/var/run/nginx2.lock \
--user=nginx2 \
--group=nginx2 \
--with-http_ssl_module \
--with-http_v2_module \
--with-http_dav_module \
--with-http_flv_module \
--with-http_realip_module \
--with-http_addition_module \
--with-http_xslt_module \
--with-http_stub_status_module \
--with-http_sub_module \
--with-http_random_index_module \
--with-http_degradation_module \
--with-http_secure_link_module \
--with-http_gzip_static_module \
--with-http_perl_module \
--with-pcre=../pcre-8.44 \
--with-zlib=../zlib-1.2.11 \
--with-openssl=../openssl-1.1.1g \
--with-debug \
--with-file-aio \
--with-mail \
--with-mail_ssl_module \
--http-client-body-temp-path=/usr/local/nginx2/client_body \
--http-proxy-temp-path=/usr/local/nginx2/proxy \
--http-fastcgi-temp-path=/usr/local/nginx2/fastcgi \
--http-uwsgi-temp-path=/usr/local/nginx2/uwsgi \
--http-scgi-temp-path=/usr/local/nginx2/scgi \
--with-stream \
--with-ld-opt="-Wl,-E"
make &amp;&amp; make install
cd /usr/local/nginx2/conf
vim nginx.conf  --修改监听端口，避免启动冲突
</code></pre> 
<h3><a id="27_nginx_338"></a>2.7 配置nginx系统服务</h3> 
<p>1、添加nginx系统服务启动脚本</p> 
<pre><code class="prism language-html">vi /etc/init.d/nginx
#!/bin/bash
#
# nginx - this script starts and stops the nginx daemon
#
# chkconfig:   2345 85 15
# description:  Nginx is an HTTP(S) server, HTTP(S) reverse \
#               proxy and IMAP/POP3 proxy server
#
# processname: nginx
# config:      /usr/local/nginx/conf/nginx.conf
# pidfile:     /usr/local/nginx/logs/nginx.pid
 
# Source function library.
. /etc/rc.d/init.d/functions
 
# Source networking configuration.
. /etc/sysconfig/network
 
# Check that networking is up.
[ "$NETWORKING" = "no" ] &amp;&amp; exit 0
 
nginx="/usr/local/nginx/sbin/nginx"
prog=$(basename $nginx)
 
NGINX_CONF_FILE="/usr/local/nginx/conf/nginx.conf"
 
[ -f /etc/sysconfig/nginx ] &amp;&amp; . /etc/sysconfig/nginx
 
lockfile=/var/lock/nginx.lock
 
start() {
    [ -x $nginx ] || exit 5
    [ -f $NGINX_CONF_FILE ] || exit 6
    echo -n "Starting $prog: "
    daemon $nginx -c $NGINX_CONF_FILE
    retval=$?
    echo
    [ $retval -eq 0 ] &amp;&amp; touch $lockfile
    return $retval
}
 
stop() {
    echo -n "Stopping $prog: "
    killproc $prog -QUIT
    retval=$?
    echo
    [ $retval -eq 0 ] &amp;&amp; rm -f $lockfile
    return $retval
}
 
restart() {
    configtest || return $?
    stop
    sleep 1
    start
}
 
rh_status() {
    status $prog
}
 
rh_status_q() {
    rh_status &gt;/dev/null 2&gt;&amp;1
}
 
case "$1" in
    start)
        rh_status_q &amp;&amp; exit 0
        $1
        ;;
    stop)
        rh_status_q || exit 0
        $1
        ;;
    restart)
        $1
        ;;
    status)
        rh_status
        ;;
    *)
        echo $"Usage: $0 {start|stop|status|restart}"
        exit 2
        ;;
esac
</code></pre> 
<p>2、配置nginx系统服务及自启动</p> 
<pre><code class="prism language-html">chmod +x /etc/init.d/nginx
chkconfig --add nginx &amp;&amp; chkconfig nginx on
chkconfig --list nginx
</code></pre> 
<p>3、启动与停止nginx服务</p> 
<pre><code class="prism language-html">service nginx start    或使用  systemctl start nginx
service nginx status    或使用  systemctl status nginx
ps -ef|grep nginx
service nginx stop    或使用  systemctl stop nginx
</code></pre> 
<h3><a id="28_nginx2_448"></a>2.8 配置nginx2系统服务</h3> 
<p>1、添加nginx系统服务启动脚本</p> 
<pre><code class="prism language-html">vi /etc/init.d/nginx2
#!/bin/bash
#
# nginx - this script starts and stops the nginx daemon
#
# chkconfig:   2345 88 12
# description:  Nginx is an HTTP(S) server, HTTP(S) reverse \
#               proxy and IMAP/POP3 proxy server
#
# processname: nginx
# config:      /usr/local/nginx2/conf/nginx.conf
# pidfile:     /usr/local/nginx2/logs/nginx2.pid
 
# Source function library.
. /etc/rc.d/init.d/functions
 
# Source networking configuration.
. /etc/sysconfig/network
 
# Check that networking is up.
[ "$NETWORKING" = "no" ] &amp;&amp; exit 0
 
nginx="/usr/local/nginx2/sbin/nginx2"
prog=$(basename $nginx)
 
NGINX_CONF_FILE="/usr/local/nginx2/conf/nginx.conf"
 
[ -f /etc/sysconfig/nginx ] &amp;&amp; . /etc/sysconfig/nginx
 
lockfile=/var/lock/nginx2.lock
 
start() {
    [ -x $nginx ] || exit 5
    [ -f $NGINX_CONF_FILE ] || exit 6
    echo -n "Starting $prog: "
    daemon $nginx -c $NGINX_CONF_FILE
    retval=$?
    echo
    [ $retval -eq 0 ] &amp;&amp; touch $lockfile
    return $retval
}
 
stop() {
    echo -n "Stopping $prog: "
    killproc $prog -QUIT
    retval=$?
    echo
    [ $retval -eq 0 ] &amp;&amp; rm -f $lockfile
    return $retval
}
 
restart() {
    configtest || return $?
    stop
    sleep 1
    start
}
 
rh_status() {
    status $prog
}
 
rh_status_q() {
    rh_status &gt;/dev/null 2&gt;&amp;1
}
 
case "$1" in
    start)
        rh_status_q &amp;&amp; exit 0
        $1
        ;;
    stop)
        rh_status_q || exit 0
        $1
        ;;
    restart)
        $1
        ;;
    status)
        rh_status
        ;;
    *)
        echo $"Usage: $0 {start|stop|status|restart}"
        exit 2
        ;;
esac
</code></pre> 
<p>2、配置nginx2系统服务及自启动</p> 
<pre><code class="prism language-html">chmod +x /etc/init.d/nginx2
chkconfig --add nginx2 &amp;&amp; chkconfig nginx2 on
chkconfig --list nginx2
</code></pre> 
<p>3、启动与停止nginx服务(启动时注意端口不可冲突)</p> 
<pre><code class="prism language-html">service nginx2 start    或使用  systemctl start nginx2
service nginx2 status    或使用  systemctl status nginx2
ps -ef|grep nginx2
service nginx2 stop    或使用  systemctl stop nginx2
</code></pre> 
<h3><a id="29_nginx_558"></a>2.9 配置nginx环境变量</h3> 
<pre><code class="prism language-html">cat &gt;&gt;/etc/profile&lt;&lt;EOF
NGINX_HOME=/usr/local/nginx
PATH=\$NGINX_HOME/sbin:\$PATH
 
NGINX2_HOME=/usr/local/nginx2
PATH=\$NGINX2_HOME/sbin:\$PATH
EOF
source /etc/profile
</code></pre> 
<h3><a id="210_571"></a>2.10配置防火墙</h3> 
<p>配置操作系统防火墙（端口号根据实际添加）</p> 
<p>针对CentOS6：</p> 
<pre><code class="prism language-html">iptables -A INPUT -m state --state NEW -m tcp -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -m state --state NEW -m tcp -p tcp --dport 8080 -j ACCEPT

service iptables save
</code></pre> 
<p>针对CentOS7：</p> 
<pre><code class="prism language-html">firewall-cmd --permanent --zone=public --add-port=80/tcp
firewall-cmd --permanent --zone=public --add-port=8080/tcp
firewall-cmd --reload
</code></pre> 
<h3><a id="3_Nginx_592"></a>3. Nginx加固</h3> 
<h3><a id="31__594"></a>3.1 安全审计</h3> 
<p>l 启用错误日志</p> 
<pre><code class="prism language-html">#错误日志
error_log  logs/error.log;
</code></pre> 
<p>l 启用访问日志</p> 
<pre><code class="prism language-html">#访问日志
log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer"'
                      '"$http_user_agent" "$http_x_forwarded_for"'
                      '"$request_time" "$upstream_response_time"';
#日志缓存
 access_log  logs/access.log  main buffer=64k flush=60s;
  open_log_file_cache max=300 inactive=20s valid=1m min_uses=2;
</code></pre> 
<h3><a id="32_nginx_616"></a>3.2 隐藏nginx版本</h3> 
<p>l 在nginx.conf配置文件中添加隐藏nginx版本的参数</p> 
<pre><code class="prism language-html"># hide nginx version
server_tokens off;
</code></pre> 
<p>l 在fastcgi.conf配置文件中添加#注释如下配置隐藏php中nginx的版本信息</p> 
<pre><code class="prism language-html">fastcgi_param  SERVER_SOFTWARE    nginx/$nginx_version;
</code></pre> 
<h3><a id="33__631"></a>3.3 数据保密性</h3> 
<p>l 配置防盗链，在nginx.conf对应的server中配置以下参数（根据实际环境需要配置）</p> 
<pre><code class="prism language-html">location ~* ^.+\.(gif|jpg|png|swf|flv|rar|zip)$ {
valid_referers none blocked 域名;
if ($invalid_referer) {
return 403;
break;
}
access_log off;
}
</code></pre> 
<h3><a id="34__646"></a>3.4 配置错误界面</h3> 
<p>l 把error.html放在nginx/html下。在nginx.conf的http中配置以下参数</p> 
<pre><code class="prism language-html">error_page  404 500 502 503 504 505 /error.html;
</code></pre> 
<h3><a id="35_Web_654"></a>3.5 Web前端安全</h3> 
<p>l 防止点击劫持，防止ie内容嗅探，防止xss，只能从本域名加载资源（外部脚本无法执行），在nginx.conf的server中配置以下参数（根据实际环境需要配置）</p> 
<pre><code class="prism language-html">add_header X-Frame-Options SAMEORIGIN;
add_header X-Content-Type-Options nosniff;
add_header X-XSS-Protection 1;
#add_header Content-Security-Policy "default-src 'self'";
</code></pre> 
<h3><a id="36_https_665"></a>3.6 https安全</h3> 
<p>l 不使用SSL和TLS1.1以下，使用TLS1.2以上版本，在nginx.conf的server中配置以下参数（在启用https的场景中配置）</p> 
<pre><code class="prism language-html">SSL_Protocols TLSv1.2;
</code></pre> 
<h3><a id="37__673"></a>3.7 访问控制</h3> 
<p>l 限制ip访问（因公网访问nginx，建议不设置。除非有恶意ip尝试cc攻击或暴力破解等非法操作）（根据实际环境需要配置）</p> 
<pre><code class="prism language-html">location / {
deny 192.168.1.1; #拒绝IP
allow 192.168.1.0/24; #允许IP
allow 10.1.1.0/16; #允许IP
deny all; #拒绝其他所有IP
}
</code></pre> 
<h3><a id="38_http_686"></a>3.8 限制http请求方法</h3> 
<p>l 在nginx.conf的server中配置以下参数，只允许GET、POST两个http请求方式</p> 
<pre><code class="prism language-html">    location / {
        if ($request_method !~* GET|POST) {
        return 403;
        }
}
</code></pre> 
<p>l nginx禁用option方法，将下面语句添加到nginx.conf文件或者server模块中</p> 
<pre><code class="prism language-html">if ($request_method ~* OPTIONS) {
return 404;
}
</code></pre> 
<h3><a id="4_Nginx_706"></a>4. Nginx优化</h3> 
<h3><a id="41_Nginx_708"></a>4.1 Nginx工作进程数量</h3> 
<p>l 一般设置CPU的核心或者核心数x2（worker_processes最多开启8个）</p> 
<pre><code class="prism language-html">grep ^processor /proc/cpuinfo | wc -l    //获取cpu核心数
worker_processes  4;
</code></pre> 
<h3><a id="42_NginxCPU_717"></a>4.2 Nginx运行CPU亲和力</h3> 
<pre><code class="prism language-html">l  比如2核配置

worker_processes 2;
worker_cpu_affinity 01 10;

l  比如4核配置

worker_processes  4;
worker_cpu_affinity 0001 0010 0100 1000;

l  比如8核配置

worker_processes 8;
worker_cpu_affinity 00000001 00000010 00000100 0000100000010000 00100000 01000000 10000000;
</code></pre> 
<h3><a id="43__736"></a>4.3 优化内核参数与连接数</h3> 
<pre><code class="prism language-html">cat &gt;&gt;/etc/sysctl.conf&lt;&lt;EOF
fs.file-max = 6815744
net.ipv4.ip_forward = 0
net.ipv4.conf.default.rp_filter = 1
net.ipv4.conf.default.accept_source_route = 0
kernel.sysrq = 0
kernel.core_uses_pid = 1
net.ipv4.tcp_syncookies = 1
kernel.msgmnb = 65536
kernel.msgmax = 65536
kernel.shmmax = 68719476736
kernel.shmall = 4294967296
net.ipv4.tcp_max_tw_buckets = 6000
net.ipv4.tcp_sack = 1
net.ipv4.tcp_window_scaling = 1
net.ipv4.tcp_rmem = 10240 87380 12582912
net.ipv4.tcp_wmem = 10240 87380 12582912
net.core.wmem_default = 8388608
net.core.rmem_default = 8388608
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
net.core.netdev_max_backlog = 262144
net.core.somaxconn = 40960
net.ipv4.tcp_max_orphans = 3276800
net.ipv4.tcp_max_syn_backlog = 262144
net.ipv4.tcp_timestamps = 0
net.ipv4.tcp_synack_retries = 1
net.ipv4.tcp_syn_retries = 1
net.ipv4.tcp_tw_recycle = 1
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_mem = 94500000 915000000 927000000
net.ipv4.tcp_fin_timeout = 1
net.ipv4.tcp_keepalive_time = 30
net.ipv4.ip_local_port_range = 1024 65000
EOF
sysctl -p
cat &gt;&gt;/etc/security/limits.conf&lt;&lt;EOF
*       soft    nofile      65535
*       hard    nofile      65535
*       soft    noproc      65535
*       hard    noproc      65535
EOF
</code></pre> 
<h3><a id="44_Nginx_783"></a>4.4 Nginx事件处理</h3> 
<p>l 启用epoll模型以提高处理效率</p> 
<pre><code class="prism language-html">events {
use epoll;
worker_connections 65535;
multi_accept on;
}
</code></pre> 
<h3><a id="45__795"></a>4.5 开启高效传输模式</h3> 
<pre><code class="prism language-html">sendfile  on;
tcp_nopush  on;
</code></pre> 
<h3><a id="46__802"></a>4.6 连接超时时间</h3> 
<p>l 保护服务器资源，CPU，内存与控制连接数</p> 
<pre><code class="prism language-html">keepalive_timeout 60;
tcp_nodelay on;
client_header_buffer_size 4k;
open_file_cache max=102400 inactive=20s;
open_file_cache_valid 30s;
open_file_cache_min_uses 1;
client_header_timeout 60;
client_body_timeout 60;
reset_timedout_connection on;
send_timeout 20;
client_max_body_size 10m;
</code></pre> 
<h3><a id="47__820"></a>4.7 配置文件专属路径便携配置</h3> 
<p>不同的服务配置单独的conf文件，提高运维效率，以nginx.conf配置文件添加include参数</p> 
<pre><code class="prism language-html">mkdir /usr/local/nginx/conf/conf.d
include /usr/local/nginx/conf/conf.d/*.conf;
</code></pre> 
<h3><a id="48_Gzip_829"></a>4.8 Gzip调优</h3> 
<p>使用gzip压缩功能，可能为我们节约带宽，加快传输速度</p> 
<pre><code class="prism language-html">gzip on;
gzip_min_length 2k;
gzip_buffers   4 32k;
gzip_http_version 1.1;
gzip_comp_level 6;
gzip_typestext/plain text/css text/javascriptapplication/json application/javascript application/x-javascriptapplication/xml;
gzip_vary on;
gzip_proxied any;
</code></pre> 
<h3><a id="49_Expires_844"></a>4.9 Expires缓存调优</h3> 
<p>缓存，主要针对于图片，css，js等元素更改机会比较少的情况下使用，特别是图片，占用带宽大，可以设置图片在浏览器本地缓存365d，css，js，html可以缓存个10来天。</p> 
<pre><code>location ~* \.(ico|jpe?g|gif|png|bmp|swf|flv)$ {
    expires 30d;
    #log_not_found off;
    access_log off;
}

location ~* \.(js|css)$ {
    expires 7d;
    log_not_found off;
    access_log off;
}
</code></pre> 
<h3><a id="5__860"></a>5. 结束</h3>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f59a7d70c4fdb328216608edc06c51f3/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">1370. 上升下降字符串</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/bcbb6ee977b67d5df2da4e8a73b0ccd7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">[CTFSHOW]SQL注入(WEB入门)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>