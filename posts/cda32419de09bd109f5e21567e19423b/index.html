<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>USB UMS MTP设置过程 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="USB UMS MTP设置过程" />
<meta property="og:description" content="选择MTP，PTP，UMS的选项界面就定义在UsbSettings.java，选择其中一个选项时会执行以下代码。
packages/apps/Settings/src/com/android/settings/deviceinfo/UsbSettings.java
if (preference == mMtp) { mUsbManager.setCurrentFunction(UsbManager.USB_FUNCTION_MTP, true); updateToggles(UsbManager.USB_FUNCTION_MTP); } else if (preference == mPtp) { mUsbManager.setCurrentFunction(UsbManager.USB_FUNCTION_PTP, true); updateToggles(UsbManager.USB_FUNCTION_PTP); } else if(preference == mUms) { mUsbManager.setCurrentFunction(UsbManager.USB_FUNCTION_MASS_STORAGE, true); updateToggles(UsbManager.USB_FUNCTION_MASS_STORAGE); } updateToggle就是去让执行某些选项的选中与取消工作。
其中最重要的是mUsbManager.setCurrentFunction()，mUsbManger是这样得到的：
@Override public void onCreate(Bundle icicle) { super.onCreate(icicle); mUsbManager = (UsbManager)getSystemService(Context.USB_SERVICE); } 它的实现在frameworks/base/core/java/android/hardware/usb/UsbManager.java。 它的接口实现在frameworks/base/core/java/android/hardware/usb/IUsbManager.aidl
frameworks/base/services/java/com/android/server/usb/UsbService.java
/** * UsbService manages all USB related state, including both host and device support. * Host related events and calls are delegated to UsbHostManager, and device related * support is delegated to UsbDeviceManager." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/cda32419de09bd109f5e21567e19423b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2013-03-20T15:12:09+08:00" />
<meta property="article:modified_time" content="2013-03-20T15:12:09+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">USB UMS MTP设置过程</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>选择MTP，PTP，UMS的选项界面就定义在UsbSettings.java，选择其中一个选项时会执行以下代码。<br> </p> 
<p><span style="color:#0099">packages/apps/Settings/src/com/android/settings/deviceinfo/UsbSettings.java</span><br> </p> 
<p></p> 
<pre><code class="language-java">        if (preference == mMtp) {          
            mUsbManager.setCurrentFunction(UsbManager.USB_FUNCTION_MTP, true);
            updateToggles(UsbManager.USB_FUNCTION_MTP);
        } else if (preference == mPtp) {   
            mUsbManager.setCurrentFunction(UsbManager.USB_FUNCTION_PTP, true);
            updateToggles(UsbManager.USB_FUNCTION_PTP);
        } else if(preference == mUms) {    
            mUsbManager.setCurrentFunction(UsbManager.USB_FUNCTION_MASS_STORAGE, true);
            updateToggles(UsbManager.USB_FUNCTION_MASS_STORAGE);
        }
</code></pre> 
<p>updateToggle就是去让执行某些选项的选中与取消工作。<br> </p> 
<p>其中最重要的是<span style="color:#cc00"><strong>mUsbManager.setCurrentFunction()</strong></span>，mUsbManger是这样得到的：</p> 
<p></p> 
<pre><code class="language-java">    @Override
    public void onCreate(Bundle icicle) {
        super.onCreate(icicle);
        mUsbManager = (UsbManager)getSystemService(Context.USB_SERVICE);
    }   
</code></pre> 
<br> 它的实现在frameworks/base/core/java/android/hardware/usb/UsbManager.java。 
<p></p> 
<p>它的接口实现在frameworks/base/core/java/android/hardware/usb/IUsbManager.aidl</p> 
<p>frameworks/base/services/java/com/android/server/usb/UsbService.java<br> </p> 
<p></p> 
<pre><code class="language-java">/**    
 * UsbService manages all USB related state, including both host and device support.
 * Host related events and calls are delegated to UsbHostManager, and device related
 * support is delegated to UsbDeviceManager.
 */    
public class UsbService extends IUsbManager.Stub {
    private final Context mContext;
    private UsbDeviceManager mDeviceManager;
    private UsbHostManager mHostManager;
    private final UsbSettingsManager mSettingsManager;
</code></pre> 
<p></p> 
<p>这个界面就是"<span style="color:#cc00">com.android.settings.UsbSettings</span>" Activity。在frameworks/base/services/java/com/android/server/usb/UsbDeviceManager.java中被调用。</p> 
<p>如果你选择了USB调试功能，还会弹出"<span style="color:#cc00">com.android.settings.DevelopmentSettings</span>" Activity，也是在UsbDeviceManager.java中被调用。关于UsbDevcieManager，我们以后再细看。<br> </p> 
<p>如果你选择了UMS，还会弹出"<span style="color:#cc00">com.android.systemui.usb.UsbStorageActivity</span>" Activity，就是“打开USB存储设备”的界面。它就义在定义在：<br> frameworks/base/packages/SystemUI/src/com/android/systemui/usb/UsbStorageActivity.java。</p> 
<p>这些界面只有在插入USB时才会有通知显示。在没有插USB的情况下，有些界面是没有入口的。我们就以UsbStorageActivity为例，介绍一下这些通知是怎么弹出来的。</p> 
<h3>通知是怎么弹出来的</h3> 
<p><span style="color:#0099">frameworks/base/packages/SystemUI/src/com/android/systemui/statusbar/phone/PhoneStatusBarPolicy.java</span><br> </p> 
<p></p> 
<pre><code class="language-java">        // storage
        mStorageManager = (StorageManager) context.getSystemService(Context.STORAGE_SERVICE);
        mStorageManager.registerListener(
                new com.android.systemui.usb.StorageNotification(context));
</code></pre>这里注册了监听函数com.android.systemui.usb.StorageNotification，这个只是针对Phone，对于平板，有tablet/TabletStatusBarPolicy.java 
<p>我们来看一下注册的<strong><span style="color:#cc00">com.android.systemui.usb.StorageNotification</span></strong></p> 
<p><span style="color:#0099">frameworks/base/packages/SystemUI/src/com/android/systemui/usb/StorageNotification.java</span></p> 
<p></p> 
<pre><code class="language-java">public class StorageNotification extends StorageEventListener { 
    private static final String TAG = "StorageNotification";

    public StorageNotification(Context context) {
        mContext = context;

        mStorageManager = (StorageManager) context.getSystemService(Context.STORAGE_SERVICE);
        final boolean connected = mStorageManager.isUsbMassStorageConnected();
        Slog.d(TAG, String.format( "Startup with UMS connection %s (media state %s)", mUmsAvailable,
                Environment.getExternalStorageState()));
        
        HandlerThread thr = new HandlerThread("SystemUI StorageNotification");
        thr.start();
        mAsyncEventHandler = new Handler(thr.getLooper());

        onUsbMassStorageConnectionChanged(connected);
    }
</code></pre> 
<p>在构造函数里就调用了onUsbMassStorageConnectionChanged函数，它最终会调到<span style="color:#cc00">updateUsbMassStorageNotification</span>()，</p> 
<p></p> 
<pre><code class="language-java">    /** 
     * Update the state of the USB mass storage notification
     */
    void updateUsbMassStorageNotification(boolean available) {

        if (available) {
            Intent intent = new Intent();
            intent.setClass(mContext, com.android.systemui.usb.UsbStorageActivity.class);
            intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);

            PendingIntent pi = PendingIntent.getActivity(mContext, 0, intent, 0); 
            setUsbStorageNotification(
                    com.android.internal.R.string.usb_storage_notification_title,
                    com.android.internal.R.string.usb_storage_notification_message,
                    com.android.internal.R.drawable.stat_sys_data_usb,
                    false, true, pi);
        } else {
            setUsbStorageNotification(0, 0, 0, false, false, null);
        }   
    }   
</code></pre> 
<p>也就是说UsbStorageActivity和StorageNotification绑定在了一起，什么时候弹出这个通知，就可以进入这个Activity了。</p> 
<p>如果连接了USB，就会在通知栏里显示USB选项的通知。如果没有连接，就会把这个通知给取消掉。那我们看一下，这个通知是怎么弹出来的。<br> </p> 
<h3>StorageManager</h3> 
<p>frameworks/base/core/java/android/os/storage/StorageManager.java</p> 
<p></p> 
<pre><code class="language-java">    public void registerListener(StorageEventListener listener) {
        if (listener == null) {            
            return;
        }

        synchronized (mListeners) {        
            mListeners.add(new ListenerDelegate(listener));
        }
    }  
</code></pre>mListeners会被私有成员MountServiceBinderListener用到，而MountServiceBinderListener又是继承自IMountServiceListener.Stub，在构造函数里被注册。 
<p></p> 
<p></p> 
<pre><code class="language-java">    public StorageManager(Looper tgtLooper) throws RemoteException {
        mMountService = IMountService.Stub.asInterface(ServiceManager.getService("mount"));
        if (mMountService == null) {
            Log.e(TAG, "Unable to connect to mount service! - is it running yet?");
            return;
        }
        mTgtLooper = tgtLooper;
        mBinderListener = new MountServiceBinderListener();
        mMountService.registerListener(mBinderListener);
    }
</code></pre>所以关键还是在mMountService。
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d6479a717308a69a5a72efcbedec2345/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">office使用技巧</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9608b633441776f6298c5459efe01598/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Valid signing identity not found解决办法（原有IDP私钥丢失）及Certificate、App ID、Devices、Provisioning Profiles之间区别...</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>