<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Redis核心技术-性能-实战（查找bigKey、hotkey） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Redis核心技术-性能-实战（查找bigKey、hotkey）" />
<meta property="og:description" content="排查bigkey 过大的 Value 会引发数据倾斜、热点Key、实例流量或 CPU 性能被占满等问题，这个时候就需要排查 Redis 的大key去优化业务了，下面提供一些排查方案总结。
多大的 key 算大呢？
一个STRING类型的Key，它的值为5MB（数据过大）一个LIST类型的Key，它的列表数量为20000个（列表数量过多）一个ZSET类型的Key，它的成员数量为10000个（成员数量过多）一个HASH格式的Key，它的成员数量虽然只有1000个但这些成员的value总大小为100MB（成员体积过大） 如何查询key大小？
MEMORY USAGE 命令给出一个 key 和它的值在 RAM 中所占用的字节数。
&gt; memory usage testk 51 1.使用命令 --bigkeys –bigkeys 是 redis 自带的命令，对整个 Key 进行扫描，统计 string，list，set，zset，hash 这几个常见数据类型中每种类型里的最大的 key。
–bigkeys 是以 scan 延迟计算的方式扫描所有 key，因此执行过程中不会阻塞 redis，但实例存在大量的 keys 时，命令执行的时间会很长，这种情况建议在 slave 上扫描。
Linux：
redis-cli -h 127.0.0.1 -p 6379 -a &#34;password&#34; --bigkeys Windows：
./redis-cli.exe -h 127.0.0.1 -p 6379 -a &#34;password&#34; --bigkeys 2.使用 Rdbtools 工具包 Rdbtools 是 python写的 一个第三方开源工具，用来解析 Redis 快照文件。除了解析 rdb 文件，还提供了统计单个 key 大小的工具。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/8ece9b0af80bbc92f133bc8bf4ad0367/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-04T20:57:39+08:00" />
<meta property="article:modified_time" content="2023-02-04T20:57:39+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Redis核心技术-性能-实战（查找bigKey、hotkey）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="bigkey_0"></a>排查bigkey</h3> 
<p>过大的 Value 会引发<strong>数据倾斜</strong>、<strong>热点Key</strong>、<strong>实例流量</strong>或 <strong>CPU 性能被占满</strong>等问题，这个时候就需要排查 Redis 的大key去优化业务了，下面提供一些排查方案总结。</p> 
<p>多大的 key 算大呢？</p> 
<ul><li>一个STRING类型的Key，它的值为5MB（数据过大）</li><li>一个LIST类型的Key，它的列表数量为20000个（列表数量过多）</li><li>一个ZSET类型的Key，它的成员数量为10000个（成员数量过多）</li><li>一个HASH格式的Key，它的成员数量虽然只有1000个但这些成员的value总大小为100MB（成员体积过大）</li></ul> 
<p>如何查询key大小？<br> <a href="https://www.redis.com.cn/commands/memory-usage.html" rel="nofollow">MEMORY USAGE</a> 命令给出一个 key 和它的值在 RAM 中所占用的字节数。</p> 
<pre><code class="prism language-bash"><span class="token operator">&gt;</span> memory usage testk
<span class="token number">51</span>
</code></pre> 
<h4><a id="1_bigkeys_17"></a>1.使用命令 --bigkeys</h4> 
<p>–bigkeys 是 redis 自带的命令，对整个 Key 进行扫描，统计 string，list，set，zset，hash 这几个常见数据类型中每种类型里的最大的 key。</p> 
<p>–bigkeys 是以 scan 延迟计算的方式扫描所有 key，因此执行过程中不会阻塞 redis，但实例存在大量的 keys 时，命令执行的时间会很长，这种情况建议在 slave 上扫描。</p> 
<p>Linux：</p> 
<pre><code class="prism language-bash">redis-cli <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-p</span> <span class="token number">6379</span> <span class="token parameter variable">-a</span> <span class="token string">"password"</span> <span class="token parameter variable">--bigkeys</span>
</code></pre> 
<p>Windows：</p> 
<pre><code class="prism language-bash">./redis-cli.exe <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-p</span> <span class="token number">6379</span> <span class="token parameter variable">-a</span> <span class="token string">"password"</span> <span class="token parameter variable">--bigkeys</span>
</code></pre> 
<h4><a id="2_Rdbtools__32"></a>2.使用 Rdbtools 工具包</h4> 
<p>Rdbtools 是 python写的 一个第三方开源工具，用来解析 Redis 快照文件。除了解析 rdb 文件，还提供了统计单个 key 大小的工具。</p> 
<h5><a id="21_35"></a>2.1安装</h5> 
<pre><code class="prism language-bash"><span class="token function">git</span> clone https://github.com/sripathikrishnan/redis-rdb-tools
<span class="token builtin class-name">cd</span> redis-rdb-tools <span class="token function">sudo</span> <span class="token operator">&amp;&amp;</span> python setup.py <span class="token function">install</span>
</code></pre> 
<h5><a id="22_42"></a>2.2使用</h5> 
<p>从 dump.rdb 按照文件统计, 将所有 &gt; 10kb 的 key 输出到一个 csv 文件</p> 
<pre><code class="prism language-bash">rdb dump.rdb <span class="token parameter variable">-c</span> memory <span class="token parameter variable">--bytes</span> <span class="token number">10240</span> <span class="token parameter variable">-f</span> live_redis.csv
</code></pre> 
<h4><a id="3DBA_47"></a>3.阿里云DBA工具</h4> 
<p><img src="https://images2.imgbox.com/bf/4f/yoCZn4xF_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="hotkey_51"></a>排查hotkey</h3> 
<p>热Key带来的常见问题：</p> 
<ol><li>热Key占用大量的Redis CPU时间使其性能变差并影响其它请求；</li><li>Redis Cluster中各node流量不均衡造成Redis Cluster的分布式优势无法被Client利用，一个分片负载很高而其它分片十分空闲从而产生读/写热点问题；</li><li>在抢购、秒杀活动中，由于商品对应库存Key的请求量过大超出Redis处理能力造成超卖；</li><li>热Key的请求压力数量超出Redis的承受能力造成缓存击穿，此时大量强求将直接指向后端存储将其打挂并影响到其它业务；</li></ol> 
<h4><a id="1hotkeys__58"></a>1.–hotkeys 工具</h4> 
<p>执行redis自带的hotkey查询工具：</p> 
<pre><code class="prism language-bash">Administrator@DESKTOP-2TA9FLB MINGW64 /f/opt/Redis/Redis-x64-5.0.14.1
$ ./redis-cli.exe <span class="token parameter variable">-h</span> r-xxx.redis.rds.aliyuncs.com <span class="token parameter variable">-p</span> <span class="token number">6379</span> <span class="token parameter variable">-a</span> <span class="token string">"123456"</span> <span class="token parameter variable">--hotkeys</span>
Warning: Using a password with <span class="token string">'-a'</span> or <span class="token string">'-u'</span> option on the <span class="token builtin class-name">command</span> line interface may not be safe.
Error: ERR An LFU maxmemory policy is not selected, access frequency not tracked. Please note that when switching between policies at runtime LRU and LFU data will take some <span class="token function">time</span> to adjust.
</code></pre> 
<p>但是，需要把redis缓存淘汰策略 设置为volatile-lfu或者allkey-lfu才能使用 --hotkeys。</p> 
<p>查询缓存淘汰策略配置：</p> 
<pre><code class="prism language-bash"><span class="token operator">&gt;</span> config get maxmemory-policy
maxmemory-policy
volatile-lru
</code></pre> 
<h4><a id="2DBA_74"></a>2.阿里云DBA工具</h4> 
<p><img src="https://images2.imgbox.com/b6/f6/jpRsvMpv_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0332365bf13b135e2184eab4fe49ac7f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【allegro 17.4软件操作保姆级教程一】软件操作环境设置</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0498a3ea90f6634917c679190848583d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">pycharm快捷键、常用设置、配置管理</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>