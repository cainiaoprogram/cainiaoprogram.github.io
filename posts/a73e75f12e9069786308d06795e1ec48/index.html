<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>stable diffusion代码学习笔记 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="stable diffusion代码学习笔记" />
<meta property="og:description" content="前言：本文没有太多公式推理，只有一些简单的公式，以及公式和代码的对应关系。本文仅做个人学习笔记，如有理解错误的地方，请指出。 本文包含stable diffusion入门文献和不同版本的代码。 文献资源 本文学习的代码；相关文献： Denoising Diffusion Probabilistic Models : DDPM，这个是必看的，推推公式Denoising Diffusion Implicit Models ：DDIM，对 DDPM 的改进Pseudo Numerical Methods for Diffusion Models on Manifolds ：PNMD/PLMS，对 DDPM 的改进High-Resolution Image Synthesis with Latent Diffusion Models ：Latent-Diffusion，必看Neural Discrete Representation Learning ： VQVAE，简单翻了翻，示意图非常形象，很容易了解其做法 代码资源 stable diffusion v1.1-v1.4， https://github.com/CompVis/stable-diffusionstable diffusion v1.5，https://github.com/runwayml/stable-diffusionstable diffusion v2，https://github.com/Stability-AI/stablediffusionstable diffusion XL，https://github.com/Stability-AI/generative-models 前向过程（训练） 输入一张图片&#43;随机噪声，训练unet，网络预测图片加上的噪声 反向过程（推理） 给个随机噪声，不断迭代去噪，输出一张图片 总体流程 输入的prompt经过clip encoder编码成(3&#43;3,77,768)特征，正负prompt各3个，默认negative prompt为空‘’，解码时正的和负的latent图片用公式计算一下才是最终结果；time step通过linear层得到(3&#43;3,1280)特征；把prompt和time ebedding和随机生成的图片放入unet，得到的就是我们要的图片。 采样流程 text2img 该函数在PLMSSampler中，输入x(噪声，(3,4,64,64))-----c（输入的prompt，(3,77,768)----t （输入的time step，第几次去噪(3,)。把这三个东西输入unet，得到预测的噪声e_t。 def p_sample_plms(self, x, c, t, index, repeat_noise=False, use_original_steps=False, quantize_denoised=False, temperature=1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/a73e75f12e9069786308d06795e1ec48/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-12T11:26:53+08:00" />
<meta property="article:modified_time" content="2024-01-12T11:26:53+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">stable diffusion代码学习笔记</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>前言：本文没有太多公式推理，只有一些简单的公式，以及公式和代码的对应关系。本文仅做个人学习笔记，如有理解错误的地方，请指出。</h2> 
<h3><a id="stable_diffusion_1"></a>本文包含stable diffusion入门文献和不同版本的代码。</h3> 
<h3><a id="_2"></a>文献资源</h3> 
<ol><li>本文学习的<a href="https://github.com/CompVis/stable-diffusion">代码</a>；</li><li>相关文献：</li></ol> 
<ul><li><a href="https://arxiv.org/abs/2006.11239" rel="nofollow">Denoising Diffusion Probabilistic Models</a> : DDPM，这个是必看的，推推公式</li><li><a href="https://arxiv.org/abs/2010.02502" rel="nofollow">Denoising Diffusion Implicit Models</a> ：DDIM，对 DDPM 的改进</li><li><a href="https://openreview.net/forum?id=PlKWVd2yBkY" rel="nofollow">Pseudo Numerical Methods for Diffusion Models on Manifolds</a> ：PNMD/PLMS，对 DDPM 的改进</li><li><a href="https://arxiv.org/abs/2112.10752" rel="nofollow">High-Resolution Image Synthesis with Latent Diffusion Models</a> ：Latent-Diffusion，必看</li><li><a href="https://arxiv.org/abs/1711.00937" rel="nofollow">Neural Discrete Representation Learning</a> ： VQVAE，简单翻了翻，示意图非常形象，很容易了解其做法</li></ul> 
<h3><a id="_10"></a>代码资源</h3> 
<ol><li>stable diffusion v1.1-v1.4， <a href="https://github.com/CompVis/stable-diffusion">https://github.com/CompVis/stable-diffusion</a></li><li>stable diffusion v1.5，<a href="https://github.com/runwayml/stable-diffusion">https://github.com/runwayml/stable-diffusion</a></li><li>stable diffusion v2，<a href="https://github.com/Stability-AI/stablediffusion">https://github.com/Stability-AI/stablediffusion</a></li><li>stable diffusion XL，<a href="https://github.com/Stability-AI/generative-models">https://github.com/Stability-AI/generative-models</a></li></ol> 
<h3><a id="_15"></a>前向过程（训练）</h3> 
<ul><li>输入一张图片+随机噪声，训练unet，网络预测图片加上的噪声</li></ul> 
<h3><a id="_17"></a>反向过程（推理）</h3> 
<ul><li>给个随机噪声，不断迭代去噪，输出一张图片</li></ul> 
<h2><a id="_20"></a>总体流程</h2> 
<ul><li>输入的prompt经过clip encoder编码成(3+3,77,768)特征，正负prompt各3个，默认negative prompt为空‘’，解码时正的和负的latent图片用公式计算一下才是最终结果；time step通过linear层得到(3+3,1280)特征；把prompt和time ebedding和随机生成的图片放入unet，得到的就是我们要的图片。</li></ul> 
<h2><a id="_text2img_22"></a>采样流程 text2img</h2> 
<ul><li>该函数在PLMSSampler中，输入x(噪声，(3,4,64,64))-----c（输入的prompt，(3,77,768)----t （输入的time step，第几次去噪(3,)。把这三个东西输入unet，得到预测的噪声e_t。</li></ul> 
<pre><code class="prism language-python"> <span class="token keyword">def</span> <span class="token function">p_sample_plms</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> c<span class="token punctuation">,</span> t<span class="token punctuation">,</span> index<span class="token punctuation">,</span> repeat_noise<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> use_original_steps<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> quantize_denoised<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                      temperature<span class="token operator">=</span><span class="token number">1.</span><span class="token punctuation">,</span> noise_dropout<span class="token operator">=</span><span class="token number">0.</span><span class="token punctuation">,</span> score_corrector<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> corrector_kwargs<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                      unconditional_guidance_scale<span class="token operator">=</span><span class="token number">1.</span><span class="token punctuation">,</span> unconditional_conditioning<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> old_eps<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> t_next<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        b<span class="token punctuation">,</span> <span class="token operator">*</span>_<span class="token punctuation">,</span> device <span class="token operator">=</span> <span class="token operator">*</span>x<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> x<span class="token punctuation">.</span>device

        <span class="token keyword">def</span> <span class="token function">get_model_output</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> unconditional_conditioning <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">or</span> unconditional_guidance_scale <span class="token operator">==</span> <span class="token number">1.</span><span class="token punctuation">:</span>
                e_t <span class="token operator">=</span> self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>apply_model<span class="token punctuation">(</span>x<span class="token punctuation">,</span> t<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                x_in <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
                t_in <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>t<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
                c_in <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>unconditional_conditioning<span class="token punctuation">,</span> c<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># 积极消极的prompt，解码时按照公式减去消极prompt的图像</span>
                e_t_uncond<span class="token punctuation">,</span> e_t <span class="token operator">=</span> self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>apply_model<span class="token punctuation">(</span>x_in<span class="token punctuation">,</span> t_in<span class="token punctuation">,</span> c_in<span class="token punctuation">)</span><span class="token punctuation">.</span>chunk<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
                e_t <span class="token operator">=</span> e_t_uncond <span class="token operator">+</span> unconditional_guidance_scale <span class="token operator">*</span> <span class="token punctuation">(</span>e_t <span class="token operator">-</span> e_t_uncond<span class="token punctuation">)</span>

            <span class="token keyword">if</span> score_corrector <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token keyword">assert</span> self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>parameterization <span class="token operator">==</span> <span class="token string">"eps"</span>
                e_t <span class="token operator">=</span> score_corrector<span class="token punctuation">.</span>modify_score<span class="token punctuation">(</span>self<span class="token punctuation">.</span>model<span class="token punctuation">,</span> e_t<span class="token punctuation">,</span> x<span class="token punctuation">,</span> t<span class="token punctuation">,</span> c<span class="token punctuation">,</span> <span class="token operator">**</span>corrector_kwargs<span class="token punctuation">)</span>

            <span class="token keyword">return</span> e_t

        alphas <span class="token operator">=</span> self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>alphas_cumprod <span class="token keyword">if</span> use_original_steps <span class="token keyword">else</span> self<span class="token punctuation">.</span>ddim_alphas
        alphas_prev <span class="token operator">=</span> self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>alphas_cumprod_prev <span class="token keyword">if</span> use_original_steps <span class="token keyword">else</span> self<span class="token punctuation">.</span>ddim_alphas_prev
        sqrt_one_minus_alphas <span class="token operator">=</span> self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>sqrt_one_minus_alphas_cumprod <span class="token keyword">if</span> use_original_steps <span class="token keyword">else</span> self<span class="token punctuation">.</span>ddim_sqrt_one_minus_alphas
        sigmas <span class="token operator">=</span> self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>ddim_sigmas_for_original_num_steps <span class="token keyword">if</span> use_original_steps <span class="token keyword">else</span> self<span class="token punctuation">.</span>ddim_sigmas

        <span class="token keyword">def</span> <span class="token function">get_x_prev_and_pred_x0</span><span class="token punctuation">(</span>e_t<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># select parameters corresponding to the currently considered timestep</span>
            a_t <span class="token operator">=</span> torch<span class="token punctuation">.</span>full<span class="token punctuation">(</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> alphas<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>
            a_prev <span class="token operator">=</span> torch<span class="token punctuation">.</span>full<span class="token punctuation">(</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> alphas_prev<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>
            sigma_t <span class="token operator">=</span> torch<span class="token punctuation">.</span>full<span class="token punctuation">(</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sigmas<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>
            sqrt_one_minus_at <span class="token operator">=</span> torch<span class="token punctuation">.</span>full<span class="token punctuation">(</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sqrt_one_minus_alphas<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">,</span>device<span class="token operator">=</span>device<span class="token punctuation">)</span>

            <span class="token comment"># current prediction for x_0</span>
            pred_x0 <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> sqrt_one_minus_at <span class="token operator">*</span> e_t<span class="token punctuation">)</span> <span class="token operator">/</span> a_t<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> quantize_denoised<span class="token punctuation">:</span>
                pred_x0<span class="token punctuation">,</span> _<span class="token punctuation">,</span> <span class="token operator">*</span>_ <span class="token operator">=</span> self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>first_stage_model<span class="token punctuation">.</span>quantize<span class="token punctuation">(</span>pred_x0<span class="token punctuation">)</span>
            <span class="token comment"># direction pointing to x_t</span>
            dir_xt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1.</span> <span class="token operator">-</span> a_prev <span class="token operator">-</span> sigma_t<span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> e_t
            noise <span class="token operator">=</span> sigma_t <span class="token operator">*</span> noise_like<span class="token punctuation">(</span>x<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> device<span class="token punctuation">,</span> repeat_noise<span class="token punctuation">)</span> <span class="token operator">*</span> temperature
            <span class="token keyword">if</span> noise_dropout <span class="token operator">&gt;</span> <span class="token number">0.</span><span class="token punctuation">:</span>
                noise <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional<span class="token punctuation">.</span>dropout<span class="token punctuation">(</span>noise<span class="token punctuation">,</span> p<span class="token operator">=</span>noise_dropout<span class="token punctuation">)</span>
            x_prev <span class="token operator">=</span> a_prev<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> pred_x0 <span class="token operator">+</span> dir_xt <span class="token operator">+</span> noise
            <span class="token keyword">return</span> x_prev<span class="token punctuation">,</span> pred_x0

        e_t <span class="token operator">=</span> get_model_output<span class="token punctuation">(</span>x<span class="token punctuation">,</span> t<span class="token punctuation">)</span> <span class="token comment"># 模型预测的噪声</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>old_eps<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token comment"># Pseudo Improved Euler (2nd order)</span>
            x_prev<span class="token punctuation">,</span> pred_x0 <span class="token operator">=</span> get_x_prev_and_pred_x0<span class="token punctuation">(</span>e_t<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token comment"># 输入噪声减去预测噪声得到新的噪声，当前预测的latent图片</span>
            e_t_next <span class="token operator">=</span> get_model_output<span class="token punctuation">(</span>x_prev<span class="token punctuation">,</span> t_next<span class="token punctuation">)</span>
            e_t_prime <span class="token operator">=</span> <span class="token punctuation">(</span>e_t <span class="token operator">+</span> e_t_next<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token comment"># 两次噪声的均值？</span>
        <span class="token keyword">elif</span> <span class="token builtin">len</span><span class="token punctuation">(</span>old_eps<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token comment"># 2nd order Pseudo Linear Multistep (Adams-Bashforth)</span>
            e_t_prime <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> e_t <span class="token operator">-</span> old_eps<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
        <span class="token keyword">elif</span> <span class="token builtin">len</span><span class="token punctuation">(</span>old_eps<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>
            <span class="token comment"># 3nd order Pseudo Linear Multistep (Adams-Bashforth)</span>
            e_t_prime <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">23</span> <span class="token operator">*</span> e_t <span class="token operator">-</span> <span class="token number">16</span> <span class="token operator">*</span> old_eps<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">5</span> <span class="token operator">*</span> old_eps<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">12</span>
        <span class="token keyword">elif</span> <span class="token builtin">len</span><span class="token punctuation">(</span>old_eps<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">3</span><span class="token punctuation">:</span>
            <span class="token comment"># 4nd order Pseudo Linear Multistep (Adams-Bashforth)</span>
            e_t_prime <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">55</span> <span class="token operator">*</span> e_t <span class="token operator">-</span> <span class="token number">59</span> <span class="token operator">*</span> old_eps<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">37</span> <span class="token operator">*</span> old_eps<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">9</span> <span class="token operator">*</span> old_eps<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">24</span>

        x_prev<span class="token punctuation">,</span> pred_x0 <span class="token operator">=</span> get_x_prev_and_pred_x0<span class="token punctuation">(</span>e_t_prime<span class="token punctuation">,</span> index<span class="token punctuation">)</span>

        <span class="token keyword">return</span> x_prev<span class="token punctuation">,</span> pred_x0<span class="token punctuation">,</span> e_t
</code></pre> 
<ul><li>接下来看公式：<br> <img src="https://images2.imgbox.com/0c/5b/UL5JwgG1_o.png" alt="在这里插入图片描述"></li><li>网络得到e_t后，进入到get_x_prev_and_pred_x0函数，可以看到<code>pred_x0 = (x - sqrt_one_minus_at * e_t) / a_t.sqrt()</code>就是上述公式，也就是说网络的预测结果通过公式计算，我们可以得到预测的<code>pred_x0原始图片和前一刻的噪声图像x_prev</code>。</li></ul> 
<pre><code class="prism language-python">        <span class="token keyword">def</span> <span class="token function">get_x_prev_and_pred_x0</span><span class="token punctuation">(</span>e_t<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># select parameters corresponding to the currently considered timestep</span>
            a_t <span class="token operator">=</span> torch<span class="token punctuation">.</span>full<span class="token punctuation">(</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> alphas<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>
            a_prev <span class="token operator">=</span> torch<span class="token punctuation">.</span>full<span class="token punctuation">(</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> alphas_prev<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>
            sigma_t <span class="token operator">=</span> torch<span class="token punctuation">.</span>full<span class="token punctuation">(</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sigmas<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>
            sqrt_one_minus_at <span class="token operator">=</span> torch<span class="token punctuation">.</span>full<span class="token punctuation">(</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sqrt_one_minus_alphas<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">,</span>device<span class="token operator">=</span>device<span class="token punctuation">)</span>

            <span class="token comment"># current prediction for x_0</span>
            pred_x0 <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> sqrt_one_minus_at <span class="token operator">*</span> e_t<span class="token punctuation">)</span> <span class="token operator">/</span> a_t<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> quantize_denoised<span class="token punctuation">:</span>
                pred_x0<span class="token punctuation">,</span> _<span class="token punctuation">,</span> <span class="token operator">*</span>_ <span class="token operator">=</span> self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>first_stage_model<span class="token punctuation">.</span>quantize<span class="token punctuation">(</span>pred_x0<span class="token punctuation">)</span>
            <span class="token comment"># direction pointing to x_t</span>
            dir_xt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1.</span> <span class="token operator">-</span> a_prev <span class="token operator">-</span> sigma_t<span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> e_t
            noise <span class="token operator">=</span> sigma_t <span class="token operator">*</span> noise_like<span class="token punctuation">(</span>x<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> device<span class="token punctuation">,</span> repeat_noise<span class="token punctuation">)</span> <span class="token operator">*</span> temperature
            <span class="token keyword">if</span> noise_dropout <span class="token operator">&gt;</span> <span class="token number">0.</span><span class="token punctuation">:</span>
                noise <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional<span class="token punctuation">.</span>dropout<span class="token punctuation">(</span>noise<span class="token punctuation">,</span> p<span class="token operator">=</span>noise_dropout<span class="token punctuation">)</span>
            x_prev <span class="token operator">=</span> a_prev<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> pred_x0 <span class="token operator">+</span> dir_xt <span class="token operator">+</span> noise
            <span class="token keyword">return</span> x_prev<span class="token punctuation">,</span> pred_x0
</code></pre> 
<ul><li> <p>前一刻的噪声图像的推理公式如图：<br> <img src="https://images2.imgbox.com/c7/b4/6By2vSjN_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/83/9a/9RETOZtN_o.png" alt="在这里插入图片描述"></p> </li><li> <p>得到了上一刻的噪声图片x_prev后(也就是函数返回的img)，继续迭代，最终生成需要的图片。<br> <img src="https://images2.imgbox.com/44/d1/BmGitsuG_o.png" alt="在这里插入图片描述"></p> </li></ul> 
<h2><a id="_122"></a>额外说明</h2> 
<p>这部分代码应该就是PLMS加速采样用的，论文中有公式推理<br> <img src="https://images2.imgbox.com/03/13/6G7yoZz2_o.png" alt="在这里插入图片描述"><br> 另外，还有一些参数是训练时候保存的，betas逐渐增大，用来控制噪声的强度。变量名解析 <code>log_one_minus_alphas_cumprod</code>其实就是log(1-alpha(右下角t)(头上直线))，没有带prev的都是当前时刻t，带prev的是前一时刻t-1。</p> 
<p><img src="https://images2.imgbox.com/98/c1/L7mYgsEK_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_128"></a>参考文献：</h2> 
<p>https://blog.csdn.net/Eric_1993/article/details/129600524?spm=1001.2014.3001.5502<br> https://zhuanlan.zhihu.com/p/630354327</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a19cb88b13e03c41e04861fa116a3632/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Vue3 中使用 Vuex 和 Pinia 对比之 Vuex的用法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f08f7f15d994be36500c9851153e217c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">基于JAVA的民宿预定管理系统 开源项目</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>