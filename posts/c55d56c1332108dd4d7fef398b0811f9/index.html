<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android 事件分发介绍 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android 事件分发介绍" />
<meta property="og:description" content="文章目录 一、目的二、环境三、相关概念3.1 事件分发 四、详细设计4.1应用布局4.1.1 应用布局结构4.1.2 LayoutInspector 4.2 关键View&amp;方法4.2.1 相关View4.2.2 相关方法4.2.3 View与方法关系 4.3 事件分发概念图4.3.1 事件分发类图4.3.2 事件分发模型图 4.4 Activity组件4.4.1 Activity-&gt;dispatchTouchEvent()4.4.2 Activity-&gt;getWindow()4.4.3 Activity-&gt;onTouchEvent() 4.5 ViewGroup组件4.5.1 ViewGroup-&gt;dispatchTouchEvent()4.5.2 ViewGroup-&gt;dispatchTransformedTouchEvent() 4.6 View组件4.6.1 View-&gt;dispatchTouchEvent()4.6.2 OnTouchListener-&gt;onTouch()4.6.3 View-&gt;onTouchEvent() 4.7 例子-点击事件时序图 五、小结&amp;问题点六、代码仓库地址七、参考资料 一、目的 最开始接触Android时，仅仅是知道Android系统存在的点击事件、触摸事件，但是并不清楚这些事件的由来。
之后，在面试Oppo和美图时，皆有问到Android的事件分发机制，但是都被问得很懵逼，归根到底都是对于其实现逻辑的不理解。
随后，想去弥补该模块的不足，浏览很多关于Android事件分发的博文，但仍存在一些疑惑，就想着去阅读下源码，整理下笔记，希望对同学们有帮助。
二、环境 版本：Android 11平台：展锐 SPRD8541E 三、相关概念 3.1 事件分发 Android 中 View 的布局是一个树形结构，各个 ViewGroup 和 View 是按树形结构嵌套布局的，从而会出现用户触摸的位置坐标可能会落在多个 View 的范围内，这样就不知道哪个 View 来响应这个事件，为了解决这一问题，就出现了事件分发机制。
四、详细设计 4.1应用布局 4.1.1 应用布局结构 如下为一个Activity打开后，其对应视图的层级结构。
4.1.2 LayoutInspector Layout Inspector是google提供给我们进行布局分析的一个工具，也是目前google在弃用Hierarchy View后推荐使用的一款布局分析工具。
4.2 关键View&amp;方法 4.2.1 相关View 组件描述ActivityAndroid事件分发的起始端，其为一个window窗口，内部持有Decorder视图，该视图为当前窗体的根节点，同时，它也是一个ViewGroup容器。ViewGroupAndroid中ViewGroup是一个布局容器，可以嵌套多个 ViewGroup 和 View，事件传递和拦截都由 ViewGroup 完成。View事件传递的最末端，要么消费事件，要么不消费把事件传递给父容器 4." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/c55d56c1332108dd4d7fef398b0811f9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-10T17:39:50+08:00" />
<meta property="article:modified_time" content="2024-01-10T17:39:50+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android 事件分发介绍</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_1" rel="nofollow">一、目的</a></li><li><a href="#_6" rel="nofollow">二、环境</a></li><li><a href="#_10" rel="nofollow">三、相关概念</a></li><li><ul><li><a href="#31__11" rel="nofollow">3.1 事件分发</a></li></ul> 
  </li><li><a href="#_14" rel="nofollow">四、详细设计</a></li><li><ul><li><a href="#41_15" rel="nofollow">4.1应用布局</a></li><li><ul><li><a href="#411__16" rel="nofollow">4.1.1 应用布局结构</a></li><li><a href="#412_LayoutInspector_20" rel="nofollow">4.1.2 LayoutInspector</a></li></ul> 
   </li><li><a href="#42_View_24" rel="nofollow">4.2 关键View&amp;方法</a></li><li><ul><li><a href="#421_View_25" rel="nofollow">4.2.1 相关View</a></li><li><a href="#422__31" rel="nofollow">4.2.2 相关方法</a></li><li><a href="#423_View_38" rel="nofollow">4.2.3 View与方法关系</a></li></ul> 
   </li><li><a href="#43__45" rel="nofollow">4.3 事件分发概念图</a></li><li><ul><li><a href="#431__46" rel="nofollow">4.3.1 事件分发类图</a></li><li><a href="#432__49" rel="nofollow">4.3.2 事件分发模型图</a></li></ul> 
   </li><li><a href="#44_Activity_67" rel="nofollow">4.4 Activity组件</a></li><li><ul><li><a href="#441_ActivitydispatchTouchEvent_68" rel="nofollow">4.4.1 Activity-&gt;dispatchTouchEvent()</a></li><li><a href="#442_ActivitygetWindow_81" rel="nofollow">4.4.2 Activity-&gt;getWindow()</a></li><li><a href="#443_ActivityonTouchEvent_108" rel="nofollow">4.4.3 Activity-&gt;onTouchEvent()</a></li></ul> 
   </li><li><a href="#45_ViewGroup_120" rel="nofollow">4.5 ViewGroup组件</a></li><li><ul><li><a href="#451_ViewGroupdispatchTouchEvent_123" rel="nofollow">4.5.1 ViewGroup-&gt;dispatchTouchEvent()</a></li><li><a href="#452_ViewGroupdispatchTransformedTouchEvent_198" rel="nofollow">4.5.2 ViewGroup-&gt;dispatchTransformedTouchEvent()</a></li></ul> 
   </li><li><a href="#46_View_233" rel="nofollow">4.6 View组件</a></li><li><ul><li><a href="#461_ViewdispatchTouchEvent_235" rel="nofollow">4.6.1 View-&gt;dispatchTouchEvent()</a></li><li><a href="#462_OnTouchListeneronTouch_259" rel="nofollow">4.6.2 OnTouchListener-&gt;onTouch()</a></li><li><a href="#463_ViewonTouchEvent_279" rel="nofollow">4.6.3 View-&gt;onTouchEvent()</a></li></ul> 
   </li><li><a href="#47__336" rel="nofollow">4.7 例子-点击事件时序图</a></li></ul> 
  </li><li><a href="#_340" rel="nofollow">五、小结&amp;问题点</a></li><li><a href="#_353" rel="nofollow">六、代码仓库地址</a></li><li><a href="#_356" rel="nofollow">七、参考资料</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>一、目的</h2> 
<p>        最开始接触Android时，仅仅是知道Android系统存在的点击事件、触摸事件，但是并不清楚这些事件的由来。<br>         之后，在面试Oppo和美图时，皆有问到Android的事件分发机制，但是都被问得很懵逼，归根到底都是对于其实现逻辑的不理解。<br>         随后，想去弥补该模块的不足，浏览很多关于Android事件分发的博文，但仍存在一些疑惑，就想着去阅读下源码，整理下笔记，希望对同学们有帮助。</p> 
<h2><a id="_6"></a>二、环境</h2> 
<ol><li>版本：Android 11</li><li>平台：展锐 SPRD8541E</li></ol> 
<h2><a id="_10"></a>三、相关概念</h2> 
<h3><a id="31__11"></a>3.1 事件分发</h3> 
<p>        Android 中 View 的布局是一个树形结构，各个 ViewGroup 和 View 是按树形结构嵌套布局的，从而会出现用户触摸的位置坐标可能会落在多个 View 的范围内，这样就不知道哪个 View 来响应这个事件，为了解决这一问题，就出现了事件分发机制。</p> 
<h2><a id="_14"></a>四、详细设计</h2> 
<h3><a id="41_15"></a>4.1应用布局</h3> 
<h4><a id="411__16"></a>4.1.1 应用布局结构</h4> 
<p>        如下为一个Activity打开后，其对应视图的层级结构。</p> 
<div align="center"> 
 <img src="https://images2.imgbox.com/62/35/dBUHu5wp_o.png"> 
</div> 
<h4><a id="412_LayoutInspector_20"></a>4.1.2 LayoutInspector</h4> 
<p>        Layout Inspector是google提供给我们进行布局分析的一个工具，也是目前google在弃用Hierarchy View后推荐使用的一款布局分析工具。</p> 
<div align="center"> 
 <img src="https://images2.imgbox.com/dd/cc/uaoUi90A_o.png"> 
</div> 
<h3><a id="42_View_24"></a>4.2 关键View&amp;方法</h3> 
<h4><a id="421_View_25"></a>4.2.1 相关View</h4> 
<table><thead><tr><th>组件</th><th>描述</th></tr></thead><tbody><tr><td>Activity</td><td>Android事件分发的起始端，其为一个window窗口，内部持有Decorder视图，该视图为当前窗体的根节点，同时，它也是一个ViewGroup容器。</td></tr><tr><td>ViewGroup</td><td>Android中ViewGroup是一个布局容器，可以嵌套多个 ViewGroup 和 View，事件传递和拦截都由 ViewGroup 完成。</td></tr><tr><td>View</td><td>事件传递的最末端，要么消费事件，要么不消费把事件传递给父容器</td></tr></tbody></table> 
<h4><a id="422__31"></a>4.2.2 相关方法</h4> 
<table><thead><tr><th>方法</th><th>描述</th></tr></thead><tbody><tr><td>dispatchTouchEvent</td><td>分发事件</td></tr><tr><td>onInterceptTouchEvent</td><td>拦截事件</td></tr><tr><td>onTouchEvent</td><td>触摸事件</td></tr></tbody></table> 
<h4><a id="423_View_38"></a>4.2.3 View与方法关系</h4> 
<table><thead><tr><th>组件</th><th>dispatchTouchEvent</th><th>onInterceptTouchEvent</th><th>onTouchEvent</th></tr></thead><tbody><tr><td>Activity</td><td>✔</td><td>❌</td><td>✔</td></tr><tr><td>ViewGroup</td><td>✔</td><td>✔</td><td>✔</td></tr><tr><td>View</td><td>✔</td><td>❌</td><td>✔</td></tr></tbody></table> 
<h3><a id="43__45"></a>4.3 事件分发概念图</h3> 
<h4><a id="431__46"></a>4.3.1 事件分发类图</h4> 
<div align="center"> 
 <img src="https://images2.imgbox.com/f0/d2/RsQi6czD_o.jpg"> 
</div> 
<h4><a id="432__49"></a>4.3.2 事件分发模型图</h4> 
<div align="center"> 
 <img src="https://images2.imgbox.com/31/dd/7pHkCieY_o.png"> 
</div> 
<p>        Android的ACTION_DOWN事件分发如图，从1-9步骤，描述一个down事件的分发过程，如果大家能懂，就不用看下面文字描述了（写完这个篇幅，感觉文字好多，不好理解！）</p> 
<ol><li><strong>ACTION_DOWN事件触发。</strong> 当我们手指触摸屏幕，tp驱动会响应中断，通过ims输入系统，将down事件的相关信息发送到当前的窗口，即当前的Activity。</li><li><strong>Activity事件分发。</strong> 会引用dispatchTouchEvent()方法，对down事件分发。Activity本身会持有一个window对象，window对象的实现类PhoneWindow会持有一个DecorView对象，DecorView是一个ViewGroup对象，即我们可以理解为，Activity最终会将事件分发给下一个节点——ViewGroup。</li><li><strong>ViewGroup事件拦截。</strong> ViewGroup接收到事件后，会先引用onInterceptTouchEvent(),查看当前的视图容器是否做事件拦截。</li><li><strong>ViewGroup消费事件。</strong> 如当前的ViewGroup对事件进行拦截，即会调用onTouchEvent()，对事件消费。</li><li><strong>ViewGroup事件不拦截。</strong> 则ViewGroup会继续遍历自身的子节点，并且当事件的坐标位于子节点上，则继续下发到下一个节点。ViewGroup的子节点有可能是View，也可能是ViewGroup（当然，ViewGroup最后也是继承于View的，突然感觉有点废话）。</li><li><strong>ViewGroup事件分发。</strong> 目标视图如果是ViewGroup，会引用其super类的dispatchTouchEvent()方法，即事件下发，不管目标视图是View或者ViewGroup最终引用的是View类的分发方法。</li><li><strong>View事件消费。</strong> 在View的dispatchTouchEvent()方法中会根据当前View是否可以点击、onTouch()是否消费、onTouchEvent()是否消费等条件，来判断当前是否为目标View。</li><li><strong>View事件未消费。</strong> View事件未消费，则其父节点,即ViewGroup会调用onTouchEvent()方法，并根据返回值来决定是否消费事件。</li><li><strong>ViewGroup事件未消费。</strong> ViewGroup事件未消费，择其父节点，即Actviity会调用onTouchEvent()方法</li></ol> 
<p><em><strong>PS：</strong></em><br> (1) <strong>ACTION_MOVE</strong>和<strong>ACTION_UP</strong>事件，流程与ACTION_DOWN的分发过程基本一致，MOVE和UP事件也是通过Activity开始，借助DOWN事件产生的目标View，逐级分发。<br> (2) <strong>ACTION_CANCEL</strong>事件，是在down与up、move事件切换过程中，事件被拦截，两次的touchTarget目标view不一致，而产生的事件。用于对之前的目标View做恢复处理，避免down与up/move事件不对称。</p> 
<h3><a id="44_Activity_67"></a>4.4 Activity组件</h3> 
<h4><a id="441_ActivitydispatchTouchEvent_68"></a>4.4.1 Activity-&gt;dispatchTouchEvent()</h4> 
<p>        底层上报的事件信息，最终会引用到该方法。Activity会持有一个根视图DecordView，事件最终会往该ViewGroup分发，如所有的View都未消费该事件，则最终由Activity的onTouchEvent()<br> 来兜底处理。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@frameworks</span>\base\core\java\android\app\<span class="token class-name">Activity</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">dispatchTouchEvent</span><span class="token punctuation">(</span><span class="token class-name">MotionEvent</span> ev<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">superDispatchTouchEvent</span><span class="token punctuation">(</span>ev<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//Step 1. 查看Window对应的View是否分发该事件</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">onTouchEvent</span><span class="token punctuation">(</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Step 2. 如果没有组件消费事件，则由Activity兜底处理</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="442_ActivitygetWindow_81"></a>4.4.2 Activity-&gt;getWindow()</h4> 
<p>        我们每次启动一个Activity的组件，会先打开一个window窗口，而PhoneWindow是Window唯一的实现类。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@frameworks</span>\base\core\java\android\app\<span class="token class-name">Activity</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token class-name">Window</span> <span class="token function">getWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> mWindow<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">attach</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ActivityThread</span> aThread<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    mWindow <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PhoneWindow</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> window<span class="token punctuation">,</span> activityConfigCallback<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//PhoneWindow是Window窗口唯一的实现类</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>        PhoneWindow对象内部持有DecorView对象，而该View正是该窗口对应的视图容器，也是根节点。（此部分不具体分析）</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@frameworks</span>\base\core\java\com\android\internal\policy\<span class="token class-name">PhoneWindow</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PhoneWindow</span> <span class="token keyword">extends</span> <span class="token class-name">Window</span> <span class="token keyword">implements</span> <span class="token class-name">MenuBuilder<span class="token punctuation">.</span>     Callback</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">private</span> <span class="token class-name">DecorView</span> mDecor<span class="token punctuation">;</span><span class="token comment">//</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">superDispatchTouchEvent</span><span class="token punctuation">(</span><span class="token class-name">MotionEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> mDecor<span class="token punctuation">.</span><span class="token function">superDispatchTouchEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//往View的根节点分发事件</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="443_ActivityonTouchEvent_108"></a>4.4.3 Activity-&gt;onTouchEvent()</h4> 
<p>        Activity的onTouchEvent方法，是在没有任何组件消费事件的情况下，触发的方法。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@frameworks</span>\base\core\java\android\app\<span class="token class-name">Activity</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onTouchEvent</span><span class="token punctuation">(</span><span class="token class-name">MotionEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mWindow<span class="token punctuation">.</span><span class="token function">shouldCloseOnTouch</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="45_ViewGroup_120"></a>4.5 ViewGroup组件</h3> 
<p>        ViewGroup组件在整个事件分发的模型中，既有分发事件的责任，又要具备处理事件的能力，真的典型的当爹又当妈。<br>         当Activity调用superDispatchTouchEvent，即最终会使用到DecorView的superDispatchTouchEvent方法，而DecorView是继承于ViewGroup，即最终会引用ViewGroup的dispatchTouchEvent方法。</p> 
<h4><a id="451_ViewGroupdispatchTouchEvent_123"></a>4.5.1 ViewGroup-&gt;dispatchTouchEvent()</h4> 
<p>此方法为事件分发最核心的代码。其主要处理如下四件事情：<br> <strong>Setp 1. 重置事件。</strong> 一次完整触摸的事件：DOWN -&gt; MOVE -&gt; UP，即我们可以理解为DOWN是所有触摸事件的起始事件。当输入事件是ACTION_DOWN时，重置触摸事件状态信息，避免产生干扰。<br> <strong>Step 2. 拦截事件。</strong> 拦截事件是ViewGroup特有的方法，用于拦截事件，并将该事件分发给自己消费，防止事件继续下发。<br> <strong>Step 3.查找目标View。</strong> 查找目标View主要针对于Down事件。当ViewGroup未拦截事件，且输入事件是ACTION_DOWN时，会遍历该ViewGroup的所有子节点，并根据触摸位置的坐标，来决定当前子节点是否是下一级目标View。当找到目标View节点后，会分发Down事件，并记录该节点信息。<br> <strong>Step 4.下发事件。</strong> 如果目标View未找到的话，则会将事件交由自己的onTouchEvent()处理；如果目标View已经找到，则Down事件就此结束（此处暂不考虑多指场景）；Move和Up事件将继续下发（默认情况下Move、Up和Down事件是成对出现的，如果目标View已经存在，则Down事件已经下发，即意味着Move和Up事件也需要下发给对应的目标View）。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">dispatchTouchEvent</span><span class="token punctuation">(</span><span class="token class-name">MotionEvent</span> ev<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>actionMasked <span class="token operator">==</span> <span class="token class-name">MotionEvent</span><span class="token punctuation">.</span><span class="token constant">ACTION_DOWN</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//Step 1.重置事件信息，避免影响下一次事件</span>
        <span class="token function">cancelAndClearTouchTargets</span><span class="token punctuation">(</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">resetTouchState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>actionMasked <span class="token operator">==</span> <span class="token class-name">MotionEvent</span><span class="token punctuation">.</span><span class="token constant">ACTION_DOWN</span>
            <span class="token operator">||</span> mFirstTouchTarget <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> disallowIntercept <span class="token operator">=</span> <span class="token punctuation">(</span>mGroupFlags <span class="token operator">&amp;</span> <span class="token constant">FLAG_DISALLOW_INTERCEPT</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>disallowIntercept<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            intercepted <span class="token operator">=</span> <span class="token function">onInterceptTouchEvent</span><span class="token punctuation">(</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Step 2.拦截事件</span>
            ev<span class="token punctuation">.</span><span class="token function">setAction</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// restore action in case it was changed</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> 
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>canceled <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>intercepted<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//Step 3.查找目标View</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>actionMasked <span class="token operator">==</span> <span class="token class-name">MotionEvent</span><span class="token punctuation">.</span><span class="token constant">ACTION_DOWN</span>
                <span class="token operator">||</span> <span class="token punctuation">(</span>split <span class="token operator">&amp;&amp;</span> actionMasked <span class="token operator">==</span> <span class="token class-name">MotionEvent</span><span class="token punctuation">.</span><span class="token constant">ACTION_POINTER_DOWN</span><span class="token punctuation">)</span>
                <span class="token operator">||</span> actionMasked <span class="token operator">==</span> <span class="token class-name">MotionEvent</span><span class="token punctuation">.</span><span class="token constant">ACTION_HOVER_MOVE</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>newTouchTarget <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> childrenCount <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> childrenCount <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//遍历所有的子节点</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>child<span class="token punctuation">.</span><span class="token function">canReceivePointerEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">isTransformedTouchPointInView</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> child<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 子节点不可以接收事件，或者触摸位置不在子节点的范围上</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dispatchTransformedTouchEvent</span><span class="token punctuation">(</span>ev<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> child<span class="token punctuation">,</span> idBitsToAssign<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//找到目标View</span>
                        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//Step 4.根据找到的目标View情况，继续下发事件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mFirstTouchTarget <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// No touch targets so treat this as an ordinary view.</span>
        handled <span class="token operator">=</span> <span class="token function">dispatchTransformedTouchEvent</span><span class="token punctuation">(</span>ev<span class="token punctuation">,</span> canceled<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
                <span class="token class-name">TouchTarget</span><span class="token punctuation">.</span><span class="token constant">ALL_POINTER_IDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//没有找到目标View或者事件被拦截，事件下发给自己</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>target <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//多组数据，一般是指多指场景</span>
            <span class="token keyword">final</span> <span class="token class-name">TouchTarget</span> next <span class="token operator">=</span> target<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>alreadyDispatchedToNewTouchTarget <span class="token operator">&amp;&amp;</span> target <span class="token operator">==</span> newTouchTarget<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//此场景一般是down事件</span>
                handled <span class="token operator">=</span> <span class="token boolean">true</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dispatchTransformedTouchEvent</span><span class="token punctuation">(</span>ev<span class="token punctuation">,</span> cancelChild<span class="token punctuation">,</span>
                        target<span class="token punctuation">.</span>child<span class="token punctuation">,</span> target<span class="token punctuation">.</span>pointerIdBits<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//此场景一般是move、up事件</span>
                    handled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
            predecessor <span class="token operator">=</span> target<span class="token punctuation">;</span>
            target <span class="token operator">=</span> next<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> handled<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="452_ViewGroupdispatchTransformedTouchEvent_198"></a>4.5.2 ViewGroup-&gt;dispatchTransformedTouchEvent()</h4> 
<p>事件分发关键方法，主要用于向目标View分发事件，具体逻辑如下：<br> <strong>Step 1.Cancel事件分发。</strong> 之前我们提过Down和Up事件是成对存在的，如果Down事件已经下发的情况下，Up事件却因为事件拦截等原因，未能下发给目标View，目标View未收到Up事件，此时就可能产生一些按压状态的异常问题，故，在当前场景下，将会分发一个ACTION_CANCEL事件给目标View。<br> <strong>Step 2.事件处理。</strong> 如果事件未找到目标View，则child会为null，此时的事件将由自身处理。<br> <strong>Step 3.事件分发。</strong> 如果事件还存在目标View，则此时的事件会再分发。</p> 
<pre><code class="prism language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">dispatchTransformedTouchEvent</span><span class="token punctuation">(</span><span class="token class-name">MotionEvent</span> event<span class="token punctuation">,</span> <span class="token keyword">boolean</span> cancel<span class="token punctuation">,</span>
            <span class="token class-name">View</span> child<span class="token punctuation">,</span> <span class="token keyword">int</span> desiredPointerIdBits<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cancel <span class="token operator">||</span> oldAction <span class="token operator">==</span> <span class="token class-name">MotionEvent</span><span class="token punctuation">.</span><span class="token constant">ACTION_CANCEL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//Step 1.下发取消事件</span>
            event<span class="token punctuation">.</span><span class="token function">setAction</span><span class="token punctuation">(</span><span class="token class-name">MotionEvent</span><span class="token punctuation">.</span><span class="token constant">ACTION_CANCEL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                handled <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">dispatchTouchEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                handled <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">dispatchTouchEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            event<span class="token punctuation">.</span><span class="token function">setAction</span><span class="token punctuation">(</span>oldAction<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> handled<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//Step 2.如果事件未找到目标View，则触摸事件会发给自己</span>
            handled <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">dispatchTouchEvent</span><span class="token punctuation">(</span>transformedEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token keyword">float</span> offsetX <span class="token operator">=</span> mScrollX <span class="token operator">-</span> child<span class="token punctuation">.</span>mLeft<span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">float</span> offsetY <span class="token operator">=</span> mScrollY <span class="token operator">-</span> child<span class="token punctuation">.</span>mTop<span class="token punctuation">;</span>
            transformedEvent<span class="token punctuation">.</span><span class="token function">offsetLocation</span><span class="token punctuation">(</span>offsetX<span class="token punctuation">,</span> offsetY<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> child<span class="token punctuation">.</span><span class="token function">hasIdentityMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                transformedEvent<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">getInverseMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            handled <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">dispatchTouchEvent</span><span class="token punctuation">(</span>transformedEvent<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Step 3.找到目标View，事件下发给子节点</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> handled<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="46_View_233"></a>4.6 View组件</h3> 
<p>        View组件在事件处理模型中，主要是处理事件。我们知道ViewGroup，也是继承于View，所以ViewGroup也是同样具备View的处理事件能力。</p> 
<h4><a id="461_ViewdispatchTouchEvent_235"></a>4.6.1 View-&gt;dispatchTouchEvent()</h4> 
<p><strong>Step 1.触发onTouch()方法。</strong> 如果当前的View是可点击的，且配置了onTouch事件监听，则触发该View的onTouch()方法。<br> <strong>Step 2.触发onTouchEvent()方法。</strong> 如果该事件在上一步的onTouch()函数中未被消费，则触发onTouchEvent()方法。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">dispatchTouchEvent</span><span class="token punctuation">(</span><span class="token class-name">MotionEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">onFilterTouchEventForSecurity</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token class-name">ListenerInfo</span> li <span class="token operator">=</span> mListenerInfo<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>li <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> li<span class="token punctuation">.</span>mOnTouchListener <span class="token operator">!=</span> <span class="token keyword">null</span>
                <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>mViewFlags <span class="token operator">&amp;</span> <span class="token constant">ENABLED_MASK</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">ENABLED</span>
                <span class="token operator">&amp;&amp;</span> li<span class="token punctuation">.</span>mOnTouchListener<span class="token punctuation">.</span><span class="token function">onTouch</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//Step 1.触发onTouch事件</span>
            result <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result <span class="token operator">&amp;&amp;</span> <span class="token function">onTouchEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//Step 2.如onTouch未消费，触发onTouchEvent事件</span>
            result <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="462_OnTouchListeneronTouch_259"></a>4.6.2 OnTouchListener-&gt;onTouch()</h4> 
<p>        View可以设置事件监听，用于监听onTouch事件的回调，当然，像我们常见的onClick()、onLongClick()等事件也可监听，其相关源码如下：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@frameworks</span>\base\core\java\android\view\<span class="token class-name">View</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setOnTouchListener</span><span class="token punctuation">(</span><span class="token class-name">OnTouchListener</span> l<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//设置onTouch监听</span>
    <span class="token function">getListenerInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mOnTouchListener <span class="token operator">=</span> l<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">ListenerInfo</span> <span class="token function">getListenerInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mListenerInfo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> mListenerInfo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    mListenerInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ListenerInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> mListenerInfo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OnTouchListener</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//Touch接口，用于回调onTouch事件</span>
    <span class="token keyword">boolean</span> <span class="token function">onTouch</span><span class="token punctuation">(</span><span class="token class-name">View</span> v<span class="token punctuation">,</span> <span class="token class-name">MotionEvent</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="463_ViewonTouchEvent_279"></a>4.6.3 View-&gt;onTouchEvent()</h4> 
<p>        事件如未被onTouch消费掉，则会引用到onTouchEvent()方法，该方法会涉及ACTION_UP、ACTION_DOWN、ACTION_CANCEL、ACTION_MOVE事件的处理，View的onClick()、onLongClick()也是由该方法触发。此外，如果当前的View是可点击的话，则直接消费该事件。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onTouchEvent</span><span class="token punctuation">(</span><span class="token class-name">MotionEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">final</span> <span class="token keyword">boolean</span> clickable <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>viewFlags <span class="token operator">&amp;</span> <span class="token constant">CLICKABLE</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">CLICKABLE</span>
        <span class="token operator">||</span> <span class="token punctuation">(</span>viewFlags <span class="token operator">&amp;</span> <span class="token constant">LONG_CLICKABLE</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">LONG_CLICKABLE</span><span class="token punctuation">)</span>
        <span class="token operator">||</span> <span class="token punctuation">(</span>viewFlags <span class="token operator">&amp;</span> <span class="token constant">CONTEXT_CLICKABLE</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">CONTEXT_CLICKABLE</span><span class="token punctuation">;</span><span class="token comment">//当前View是否可点击</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>clickable <span class="token operator">||</span> <span class="token punctuation">(</span>viewFlags <span class="token operator">&amp;</span> <span class="token constant">TOOLTIP</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">TOOLTIP</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> <span class="token class-name">MotionEvent</span><span class="token punctuation">.</span><span class="token constant">ACTION_UP</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>抬起
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mHasPerformedLongPress <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mIgnoreNextUpEvent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>focusTaken<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token function">removeLongPressCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//若有长按事件未处理，则移除长按事件</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>mPerformClick <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            mPerformClick <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerformClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">post</span><span class="token punctuation">(</span>mPerformClick<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//通过Hanlder将点击事件发送到主线程执行</span>
                            <span class="token function">performClickInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//如果不成功，则直接引用点击事件</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mUnsetPressedState <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    mUnsetPressedState <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UnsetPressedState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//更新按钮的按压事件</span>
                <span class="token punctuation">}</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">MotionEvent</span><span class="token punctuation">.</span><span class="token constant">ACTION_DOWN</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>按下
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>isInScrollingContainer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//在可滚动的容器内，为了容错，延迟点击</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token function">postDelayed</span><span class="token punctuation">(</span>mPendingCheckForTap<span class="token punctuation">,</span> <span class="token class-name">ViewConfiguration</span><span class="token punctuation">.</span><span class="token function">getTapTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">setPressed</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置按下的状态</span>
                    <span class="token function">checkForLongClick</span><span class="token punctuation">(</span>
                            <span class="token class-name">ViewConfiguration</span><span class="token punctuation">.</span><span class="token function">getLongPressTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            x<span class="token punctuation">,</span>
                            y<span class="token punctuation">,</span>
                            <span class="token constant">TOUCH_GESTURE_CLASSIFIED__CLASSIFICATION__LONG_PRESS</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//开启一个长按延时事件</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token keyword">case</span> <span class="token class-name">MotionEvent</span><span class="token punctuation">.</span><span class="token constant">ACTION_CANCEL</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>取消
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">MotionEvent</span><span class="token punctuation">.</span><span class="token constant">ACTION_MOVE</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>移动
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token comment">//如果是可点击的View，即消费事件</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="47__336"></a>4.7 例子-点击事件时序图</h3> 
<p>        如下是Android的点击事件时序图，如果能够理解单击事件的由来，对于整个事件分发的知识要点已大体掌握。</p> 
<div align="center"> 
 <img src="https://images2.imgbox.com/6c/47/vHrIJn5p_o.jpg"> 
</div> 
<h2><a id="_340"></a>五、小结&amp;问题点</h2> 
<ol><li>事件分发流程？包括ACTION_DWON、ACTION_UP、ACTION_MOVE事件的处理过程；</li><li>ACTION_CANCEL事件的使用场景？父控件对move事件拦截场景？</li><li>单击、长按、触摸事件的产生过程？</li><li>点击一个View未抬起，同时move该事件直至离开当前View的范围，处理过程如何？</li><li>如果所有View都未消费事件，流程如何？</li><li>ViewPage+ListView，左右滑动和上下滑动冲突的解决问题？即事件拦截过程？</li><li>普通的View是根据什么来决定是否消费事件，例如Button？<br> =&gt;答：如无重写onTouchEvent事件，根据当前的View是否可点击，来决定是否消费事件。</li></ol> 
<hr> 
<p>        我最开始没有看源码，直接去看博客上的内容，弯弯绕绕，似懂非懂。在面试的过程中，面试官举个场景分析流程，我都懵逼，分析不出来，现场很尴尬。之后看源码，整体流程代码量很少，感叹于Android事件分发流程的设计，很少的代码量，却承载了很重要的功能，而没有见过该模块发生过异常。<br>         多读书，多看报，少吃零食，多睡觉！</p> 
<h2><a id="_353"></a>六、代码仓库地址</h2> 
<p>Demo地址:  https://gitee.com/linzhiqin/custom-demo</p> 
<h2><a id="_356"></a>七、参考资料</h2> 
<p>https://zhuanlan.zhihu.com/p/623664769?utm_id=0<br> 事件分发视频（总结很好，但是得先理解基本概念，才方便学习）<br> https://www.bilibili.com/video/BV1sy4y1W7az?p=1&amp;vd_source=f222e3bf3083cad8d9f660629bc47c16</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/04c443a9b7e671802d174b23f5990103/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">GBASE南大通用GBase 8a ODBC 配置SSL</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e29b58c78756646616a71fb844acb01b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">C# HttpClient Get Post简单封装</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>