<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>AWS CLI SSL: CERTIFICATE_VERIFY_FAILED 错误分析与解决 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="AWS CLI SSL: CERTIFICATE_VERIFY_FAILED 错误分析与解决" />
<meta property="og:description" content="简介 在前面的一些文章中，我们用到了 AWS Cli。比如为 ECS Fargate 建 Task 和 Service。
处于安全原因，很多公司都是通过 http 代理访问 internet，这时使用 AWS Cli 操作 AWS 时，可能会碰到“SSL validation failed”错误。
比如运行如下命令
aws sts get-caller-identity 会产生如下报错
SSL validation failed for https://sts.cn-north-1.amazonaws.com.cn/ [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1056) 图 1
这时可以用“–no-verify-ssl”参数解决
aws sts get-caller-identity --no-verify-ssl 但这种方式不但降低了安全性，而且结果总会带有一长串恼人的告警
urllib3/connectionpool.py:1013: InsecureRequestWarning: Unverified HTTPS request is being made to host &#39;pitc-zscaler-americas-cincinnati3pr.proxy.corporate.ge.com&#39;. Adding certificate verification is strongly advised. See: https://urllib3." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/18cc3cd7b533b6b7bd3b23a1f2dfde26/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-05-19T11:14:26+08:00" />
<meta property="article:modified_time" content="2021-05-19T11:14:26+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">AWS CLI SSL: CERTIFICATE_VERIFY_FAILED 错误分析与解决</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><img src="https://images2.imgbox.com/9a/ff/gsQfS7qb_o.png" alt=""></p> 
<h3><a id="_2"></a>简介</h3> 
<p>在前面的一些文章中，我们用到了 AWS Cli。比如为 ECS Fargate 建 Task 和 Service。</p> 
<p>处于安全原因，很多公司都是通过 http 代理访问 internet，这时使用 AWS Cli 操作 AWS 时，可能会碰到“SSL validation failed”错误。</p> 
<p>比如运行如下命令</p> 
<pre><code>aws sts get-caller-identity
</code></pre> 
<p>会产生如下报错</p> 
<pre><code>SSL validation failed for https://sts.cn-north-1.amazonaws.com.cn/ [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1056)
</code></pre> 
<p>图 1<br> <img src="https://images2.imgbox.com/f3/97/ToL4oZ6l_o.png" alt=""></p> 
<p>这时可以用“–no-verify-ssl”参数解决</p> 
<pre><code>aws sts get-caller-identity --no-verify-ssl
</code></pre> 
<p>但这种方式不但降低了安全性，而且结果总会带有一长串恼人的告警</p> 
<pre><code>urllib3/connectionpool.py:1013: InsecureRequestWarning: Unverified HTTPS request is being made to host 'pitc-zscaler-americas-cincinnati3pr.proxy.corporate.ge.com'. Adding certificate verification is strongly advised. See: https://urllib3.readthedocs.io/en/latest/advanced-usage.html#ssl-warnings
</code></pre> 
<p>图 2<br> <img src="https://images2.imgbox.com/8d/4b/2BKf9LEy_o.png" alt=""></p> 
<p>本文分析产生这种问题的原因，并给出解决方法，使得通过 http 代理使用 AWS CLi 时不再需要“–no-verify-ssl”参数。</p> 
<p>AWS CLi 用的是 Python，所以此方法也适用于单纯的 Python 报此错误</p> 
<p>本文主要以 AWS Cli version 2 为例说明，最后会给出 AWS Cli version 1 的解决方法。</p> 
<h4><a id="_44"></a>目录</h4> 
<ul><li>环境(配置)</li><li>AWS Cli 简介</li><li>实战步骤 
  <ol><li>报错重现 
    <ul><li>安装 AWS Cli</li><li>测试报错</li></ul> </li><li>错误分析与解决方法 
    <ul><li>错误分析</li><li>解决方法</li><li>AWS Cli version 1</li></ul> </li></ol> </li><li>总结</li><li>引申</li><li>后记</li></ul> 
<h3><a id="_60"></a>环境(配置)</h3> 
<ul><li>AWS 中国或 Global 帐号，可在官网申请，一年内使用指定资源免费</li><li>AWS cli version 2，Win10 + terminal</li></ul> 
<h3><a id="AWS_Cli__65"></a>AWS Cli 简介</h3> 
<p>AWS Command Line Interface（AWS CLi）是 AWS 开源工具，允许用户以命令行的形式对 AWS 资源进行操作。</p> 
<p>AWS CLi 可以实现 AWS 网页控制台一样的功能，而且有些 AWS 特性只能通过 AWS Cli 实现。</p> 
<p>AWS Cli 虽然使用起来没在网页上操作那么直观，但更简洁高效，生产中用AWS Cli其实也更多一些。</p> 
<p>另外在与 Jenkins 做 CICD 集成时，除了用 aws 插件，使用 AWS CLi 也是经常使用的方式。</p> 
<p>AWS Cli 支持两种系统</p> 
<ul><li>Linux shells Linux 或者 macOS</li><li>Windows command line cmd 或者 PowerShell</li></ul> 
<p>AWS Cli 版本</p> 
<ul><li>2.x 当前主流版本，与 python 集成，不需要单独安装 python</li><li>1.x 老版本，需独立安装 python</li></ul> 
<h3><a id="_85"></a>实战步骤</h3> 
<h4><a id="1__87"></a>1. 报错重现</h4> 
<p>首先，我们在 linux 环境下安装 AWS Cli 2</p> 
<h5><a id="_AWS_Cli_2_91"></a>安装 AWS Cli 2</h5> 
<p>运行以下命令安装</p> 
<pre><code>#下载安装包
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64-2.0.30.zip" -o "awscliv2.zip"
#解压到本地aws目录
unzip awscliv2.zip
#用root用户安装
sudo ./aws/install
</code></pre> 
<p>安装完成后，可以用如下命令测试</p> 
<pre><code>aws --version
</code></pre> 
<p>图 3<br> <img src="https://images2.imgbox.com/70/fe/qDxO3JF2_o.png" alt=""></p> 
<h5><a id="_113"></a>测试报错</h5> 
<h6><a id="_http__115"></a>在公司的内网中，没加公司 http 代理，运行命令</h6> 
<pre><code>export AWS_PROFILE=YOUR_CONFIGURED_IAM_USER
aws sts get-caller-identity
</code></pre> 
<p>说明：此命令用来返回当前用户的信息，使用 aws configure 配置后即可使用。</p> 
<p>报错</p> 
<pre><code>Could not connect to the endpoint URL: "https://sts.cn-north-1.amazonaws.com.cn/"
</code></pre> 
<p>无法连到https://sts.cn-north-1.amazonaws.com.cn/</p> 
<p>图 4<br> <img src="https://images2.imgbox.com/e1/54/AwvYLjHN_o.png" alt=""></p> 
<h6><a id="_135"></a>在公司的内网中，加上公司代理，运行命令失败，报错</h6> 
<pre><code>export AWS_PROFILE=YOUR_CONFIGURED_IAM_USER
export http_proxy=YOUR_HTTP_PROXY_NAME:80
export https_proxy=YOUR_HTTP_PROXY_NAME:80
aws sts get-caller-identity
</code></pre> 
<pre><code>SSL validation failed for https://sts.cn-north-1.amazonaws.com.cn/ [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1056)
</code></pre> 
<p>图 5<br> <img src="https://images2.imgbox.com/38/37/L41Tb2cu_o.png" alt=""></p> 
<h6><a id="noverifyssl_151"></a>在公司的内网中，加上公司代理，加上“–no-verify-ssl”参数，运行命令成功，但是有告警</h6> 
<pre><code>export AWS_PROFILE=YOUR_CONFIGURED_IAM_USER
export http_proxy=YOUR_HTTP_PROXY_NAME:80
export https_proxy=YOUR_HTTP_PROXY_NAME:80
aws sts get-caller-identity --no-verify-ssl
</code></pre> 
<p>图 2<br> <img src="https://images2.imgbox.com/74/4f/eEc4RKgH_o.png" alt=""></p> 
<h6><a id="_internet_wifi_163"></a>如果我们在相同的环境下，直接连接 internet（比如，我用的手提断开公司连接，直接连 wifi）运行命令，成功</h6> 
<p>图 6<br> <img src="https://images2.imgbox.com/92/d5/XGOIuNXK_o.png" alt=""></p> 
<h4><a id="2__168"></a>2. 错误分析与解决方法</h4> 
<h5><a id="_170"></a>错误分析</h5> 
<p>我们在公司内网中，使用代理，再一次运行相同的命令，这次加上“–debug”参数</p> 
<pre><code>aws sts get-caller-identity --debug
</code></pre> 
<p>加上 debug 参数后，输出信息非常长，这里只截取了其中一段</p> 
<pre><code>MainThread - botocore.httpsession - DEBUG - Certificate path: /usr/local/aws-cli/v2/2.1.30/dist/botocore/cacert.pem
</code></pre> 
<p>图 7<br> <img src="https://images2.imgbox.com/6a/bf/530kLbYL_o.png" alt=""></p> 
<p>输出信息显示 AWS Cli 从“/usr/local/aws-cli/v2/2.1.30/dist/botocore/cacert.pem”文件中查找网站证书。</p> 
<p>结合测试中的报错信息“unable to get local issuer certificate”</p> 
<p>我们可以推断出，“/usr/local/aws-cli/v2/2.1.30/dist/botocore/cacert.pem”中缺少必要的证书。</p> 
<p>这个证书是什么？</p> 
<p>从上述测试可以看到，如果连接 internet 时使用了公司代理，则或者报错，或者告警；而不使用代理直接连接 internet 则完全没有问题。</p> 
<p>所以客户端（AWS Cli）和服务器端（sts.cn-north-1.amazonaws.com.cn）都没有问题，问题出在使用的 http 代理服务器上。</p> 
<p>也就是说 cacert.pem 缺少的应该是代理服务器的证书。</p> 
<h5><a id="_201"></a>解决方法</h5> 
<p>代理服务器的证书，一般需要向公司网络管理员获取。（我所在的环境中，公司提供了下载此证书的网站，所以可以自行下载）</p> 
<p>用本文编辑打开公司证书，把内容复制到“/usr/local/aws-cli/v2/2.1.30/dist/botocore/cacert.pem”的最后</p> 
<p>公司证书内容如下</p> 
<pre><code>-----BEGIN CERTIFICATE-----
MIIDozCCAougAwIBAgIQeO8XlqAMLhxvtCap35yktzANBgkqhkiG9w0BAQsFADBS
....
5ad/qyN+Zgbjx8vEWlywmhXb78Gaf/AwSGAwQPtmQ0310a4DulGxo/kcuS78vFH1
mwJmHm9AIFoqBi8XpuhGmQ0nvymurEk=
-----END CERTIFICATE-----
</code></pre> 
<p>可用 vi 命令，复制到 cacert.pem 的最后</p> 
<pre><code>sudo vi /usr/local/aws-cli/v2/2.1.30/dist/botocore/cacert.pem
</code></pre> 
<p>保存后，我们重新在公司内网加代理的环境下测试</p> 
<pre><code>export AWS_PROFILE=YOUR_CONFIGURED_IAM_USER
export http_proxy=YOUR_HTTP_PROXY_NAME:80
export https_proxy=YOUR_HTTP_PROXY_NAME:80
aws sts get-caller-identity
</code></pre> 
<p>这时运行成功，和直接连接 internet 的情况一样了</p> 
<p>图 6<br> <img src="https://images2.imgbox.com/56/f9/Ii26VGu7_o.png" alt=""></p> 
<p>说明我们的猜测是正确的，由于本地环境中缺少 http 代理服务器的证书，导致 AWS Cli 报 SSL: CERTIFICATE_VERIFY_FAILED 错误。</p> 
<h5><a id="AWS_Cli_version_1_240"></a>AWS Cli version 1</h5> 
<p>上述分析和解决是基于 AWS Cli 2，AWS Cli 1 的处理方法略有不同。</p> 
<p>在 AWS CLi 1 的环境下运行 debug 时，输出的的信息中并没有提供类似“Certificate path: /usr/local/aws-cli/v2/2.1.30/dist/botocore/cacert.pem”这样的信息。</p> 
<p>AWS CLi 1 与 AWS CLi 2 不同，需要单独安装 python，所以我们可以通过 python 找到证书路径。</p> 
<p>首先，确定 AWS Cli 使用的 python 版本</p> 
<pre><code>aws --version
</code></pre> 
<p>图 8<br> <img src="https://images2.imgbox.com/56/b6/CH7hZPeT_o.png" alt=""></p> 
<p>然后运行如下 python 命令，查看 request 使用的证书路径</p> 
<pre><code>python
import requests as r
print(r.certs.where())
</code></pre> 
<p>图 9<br> <img src="https://images2.imgbox.com/35/a2/pOOm5cEy_o.png" alt=""></p> 
<p>最后，像上面一样把公司代理服务器的证书，添加到此路径证书的最后即可。</p> 
<h3><a id="_270"></a>总结</h3> 
<p>AWS Cli 报 SSL: CERTIFICATE_VERIFY_FAILED 错误，是调用 Python 代码报的错 python 包 urllib3 传递 https 请求时，会要求网站证书或其根证书。</p> 
<p>当通过公司代理服务器时访问外网时，urllib3 也会要求代理服务器的证书。</p> 
<p>但 python 安装时（如果安装了 request 包或者 certifi 包），只会包含大型证书服务商提供的根证书，并不会包含公司内部代理服务器的证书。所以会报找不到证书的错误。</p> 
<p>这时我们要么选择用“–no-verify-ssl”，要么手工导入代理服务器证书。</p> 
<p>在 Python 官网上 request 一段可以查到如下内容</p> 
<p><strong>Finally, note that using a proxy for https connections typically requires your local machine to trust the proxy’s root certificate.</strong></p> 
<h3><a id="_284"></a>引申</h3> 
<p>如果是自己部署的 http 代理服务器，也可以用下列 openssl 命令产生代理服务器的自签名证书，然后复制 example.crt 中的内容。</p> 
<pre><code>openssl req -x509 -newkey rsa:4096 -sha256 -days 3650 -nodes \
  -keyout example.key -out example.crt -subj "/CN=YOUR_PROXY_NAME.com"
</code></pre> 
<p>AWS CLi 这个错是 python 的错，搞清楚了这个问题，在 python 代码中遇到同样的错也可以用相同的方法解决。</p> 
<p>网上也有说用如下命令，解决类似问题</p> 
<pre><code>pip install certifi
</code></pre> 
<p>但 Certifi 里面是 Mozilla 提供的一组根证书，只可以解决连接大部分网站的证书问题。</p> 
<p>如果是公司内网的代理服务器，基本上是不可能通过这种方法解决的，只能通过手工导入解决。</p> 
<h3><a id="_305"></a>资源下载</h3> 
<p>这篇文章讲的很详细，很有启发<br> https://lukasa.co.uk/2013/07/Python_Requests_And_Proxies/</p> 
<p>这个讨论挺有帮助<br> https://stackoverflow.com/questions/22027418/openssl-python-requests-error-certificate-verify-failed</p> 
<p>Python 官网上那段可在下列链接中找到<br> https://docs.python-requests.org/en/master/user/advanced/</p> 
<h3><a id="_316"></a>后记</h3> 
<p>之前也尝试解决这个问题，可惜一直没成功。主要还是不明白其中的原理，只是把网上 X 度搜到的方法机械的试一遍。</p> 
<p>这次查了不少资料，连蒙带试，终于把 SSL: CERTIFICATE_VERIFY_FAILED 这个老问题解决了。</p> 
<p>把详细分析和解决过程记下来，省得以后忘了，另外也分享给有需要的人。</p> 
<p>更多内容，请关注微信公众号“全是 AWS 干货”</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/bb9d53f6d5b2d7976434be3657cfd501/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Swagger @Api position失效，解决解决接口排序问题（最简单版）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/334913019789d32907e2cdd177800f33/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Windows 下的高 DPI 应用开发（UWP / WPF / Windows Forms / Win32）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>