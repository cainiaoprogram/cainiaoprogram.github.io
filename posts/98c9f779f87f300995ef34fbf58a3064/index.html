<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>微服务-nacos配置管理 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="微服务-nacos配置管理" />
<meta property="og:description" content="Nacos配置管理 统一配置管理：一次配置更改并支持热更新。将核心配置存储到配置管理服务，当微服务启动时会自动读取配置管理服务中的配置信息并结合本地配置启动。当配置改动时，配置管理服务会自动通知微服务，微服务读取新配置并自动热更新，无需重新启动。
配置中心的思路是：
1、首先把项目中各种配置全部都放到一个集中的地方进行统一管理，并提供一套标准的接口。2、当各个服务需要获取配置的时候，就来配置中心的接口拉取自己的配置。
3、当配置中心中的各种参数有更新的时候，也能通知到各个服务实时的过来同步最新的信息，使之动态更新。
Hello配置管理
使用nacos作为配置中心，其实就是将nacos当做一个服务端，将各个微服务看成是客户端，将各个微服务的配置文件统一存放在nacos上，然后各个微服务从nacos上拉取配置即可。
对应的依赖为spring-cloud-starter-alibaba-nacos-config注意：启用配置中心后，需要配置文件写到bootstrap配置文件中。只能是bootstrap.yml或bootstrap.properties优先级等级为bootstrap.properties -&gt; bootstrap.yml -&gt; application.properties -&gt; application.yml
需要注意：SpringCloud默认将bootstrap移除了，需要手动添加bootstrap依赖
&lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-bootstrap&lt;/artifactId&gt; &lt;version&gt;3.1.5&lt;/version&gt;&lt;/dependency 消费者配置
spring.cloud.nacos.config.server-addr=localhost:8848 服务配置中心的配置spring.cloud.nacos.config.file-extension=yaml 配置使用的后缀名spring.cloud.nacos.config.prefix=nacos-consumer 配置DataId名称，默认就是服务名称spring.cloud.nacos.config.group=DEFAULT_GROUP 默认分组名称spring.profiles.active=dev 读取指定配置文件，配置参数dev开发环境、prod生产环境、test测试环境
配置设置的概念：
命名空间Namespace：不同的项目可以分为不同的命名空间。配置分组Group：根据项目的不同环境可以一个分组。配置集Data ID：服务不同环境的不同配置，就是一个配置集
使用nacos配置管理
DataID就是配置文件名称，不能冲突，采用【微服务名称-profile.yaml或properties】，如user-service-dev.yaml。默认DataId为spring.cloud.nacos.config.prefix，后面可以添加spring.profiles.active值，对应的文件后缀为spring.cloud.nacos.config.file-extension 分组采用默认即可。配置内容应该只有可能有热更新需求的配置信息，不是将所application.yml中内容全部拷贝。例如数据库地址一般不会频繁更新的，所以添加到配置管理中就不合适。这里适合一些开关类型或者模板类型的配置，pattern.dateformat=yyyy-MM-dd
微服务配置拉取 项目启动先读取nacos中的配置文件，然后读取本地配置文件application.yaml，合并后再创建spring容器，加载受管bean。项目中提供bootstrap.yml优先application.yml，这里配置nacos地址，从而实现nacos中配置信息的读取在控制器中读取配置信息进行验证
@Value(&#34;${pattern.dateformat}&#34;) private String dateFormat; @GetMapping(&#34;now&#34;)public String now(){ return LocalDateTime.now().format(DateTimeFormatter.ofPattern(dateFormat));} 配置热更新 可以在nacos控制台上手动编辑更新配置信息。事实上nacos中的配置文件变更后，微服务无需重启就可以感知。需要通过2种配置方式实现
方式1：在@Value注入的变量所在类上添加注解@RefreshScope
@Slf4j @RestController @RequestMapping(&#34;/user&#34;)@RefreshScopepublic class UserController { @Value(&#34;pattern.dateformat&#34;) private String dateFormat;} 在微服务日志中可以看到服务更新的自动通知
方式2：使用@ConfigurationProperties注解
@Component @Data@ConfigurationProperties(prefix=&#34;pattern&#34;)public class PatternProperties { private String dataformat;} 修改控制器类通过PatternProperties组件获取配置信息
@Autowiredprivate PatternProperties properties;@GetMapping(&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/98c9f779f87f300995ef34fbf58a3064/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-04T20:18:32+08:00" />
<meta property="article:modified_time" content="2023-08-04T20:18:32+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">微服务-nacos配置管理</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="Nacos_0"></a>Nacos配置管理</h3> 
<p><strong>统一配置管理</strong>：一次配置更改并支持热更新。将核心配置存储到配置管理服务，当微服务启动时会自动读取配置管理服务中的配置信息并结合本地配置启动。当配置改动时，配置管理服务会自动通知微服务，微服务读取新配置并自动热更新，无需重新启动。<br> <strong>配置中心的思路</strong>是：<br> 1、首先把项目中各种配置全部都放到一个集中的地方进行统一管理，并提供一套标准的接口。2、当各个服务需要获取配置的时候，就来配置中心的接口拉取自己的配置。<br> 3、当配置中心中的各种参数有更新的时候，也能通知到各个服务实时的过来同步最新的信息，使之动态更新。<br> <strong>Hello配置管理</strong><br> 使用nacos作为配置中心，其实就是将nacos当做一个服务端，将各个微服务看成是客户端，将各个微服务的配置文件统一存放在nacos上，然后各个微服务从nacos上拉取配置即可。<br> 对应的依赖为spring-cloud-starter-alibaba-nacos-config注意：启用配置中心后，需要配置文件写到bootstrap配置文件中。只能是bootstrap.yml或bootstrap.properties优先级等级为bootstrap.properties -&gt; bootstrap.yml -&gt; application.properties -&gt; application.yml</p> 
<p>需要注意：SpringCloud默认将bootstrap移除了，需要手动添加bootstrap依赖</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-bootstrap<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>&lt;/dependency
</code></pre> 
<p>消费者配置</p> 
<p>spring.cloud.nacos.config.server-addr=localhost:8848 服务配置中心的配置spring.cloud.nacos.config.file-extension=yaml 配置使用的后缀名spring.cloud.nacos.config.prefix=nacos-consumer 配置DataId名称，默认就是服务名称spring.cloud.nacos.config.group=DEFAULT_GROUP 默认分组名称spring.profiles.active=dev 读取指定配置文件，配置参数dev开发环境、prod生产环境、test测试环境</p> 
<p><strong>配置设置的概念：</strong></p> 
<ul><li>命名空间Namespace：不同的项目可以分为不同的命名空间。</li><li>配置分组Group：根据项目的不同环境可以一个分组。</li><li>配置集Data ID：服务不同环境的不同配置，就是一个配置集<br> 使用nacos配置管理<br> DataID就是配置文件名称，不能冲突，采用【微服务名称-profile.yaml或properties】，如user-service-dev.yaml。默认DataId为spring.cloud.nacos.config.prefix，后面可以添加spring.profiles.active值，对应的文件后缀为spring.cloud.nacos.config.file-extension</li></ul> 
<p>分组采用默认即可。配置内容应该只有可能有热更新需求的配置信息，不是将所application.yml中内容全部拷贝。例如数据库地址一般不会频繁更新的，所以添加到配置管理中就不合适。这里适合一些开关类型或者模板类型的配置，pattern.dateformat=yyyy-MM-dd</p> 
<h5><a id="_32"></a>微服务配置拉取</h5> 
<p>项目启动先读取nacos中的配置文件，然后读取本地配置文件application.yaml，合并后再创建spring容器，加载受管bean。项目中提供bootstrap.yml优先application.yml，这里配置nacos地址，从而实现nacos中配置信息的读取在控制器中读取配置信息进行验证</p> 
<pre><code class="prism language-c">@<span class="token function">Value</span><span class="token punctuation">(</span><span class="token string">"${pattern.dateformat}"</span><span class="token punctuation">)</span>
private String dateFormat<span class="token punctuation">;</span>
@<span class="token function">GetMapping</span><span class="token punctuation">(</span><span class="token string">"now"</span><span class="token punctuation">)</span>public String <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>  <span class="token keyword">return</span> LocalDateTime<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>DateTimeFormatter<span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span>dateFormat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_42"></a>配置热更新</h3> 
<p>可以在nacos控制台上手动编辑更新配置信息。事实上nacos中的配置文件变更后，微服务无需重启就可以感知。需要通过2种配置方式实现<br> 方式1：在@Value注入的变量所在类上添加注解@RefreshScope</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Slf4j</span>  <span class="token annotation punctuation">@RestController</span>  <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/user"</span><span class="token punctuation">)</span><span class="token annotation punctuation">@RefreshScopepublic</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{<!-- --></span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"pattern.dateformat"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> dateFormat<span class="token punctuation">;</span><span class="token punctuation">}</span>
</code></pre> 
<p>在微服务日志中可以看到服务更新的自动通知<br> 方式2：使用@ConfigurationProperties注解</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>  <span class="token annotation punctuation">@Data</span><span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix<span class="token operator">=</span><span class="token string">"pattern"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PatternProperties</span> <span class="token punctuation">{<!-- --></span>    <span class="token keyword">private</span> <span class="token class-name">String</span> dataformat<span class="token punctuation">;</span><span class="token punctuation">}</span>
</code></pre> 
<p>修改控制器类通过PatternProperties组件获取配置信息</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Autowiredprivate</span> <span class="token class-name">PatternProperties</span> properties<span class="token punctuation">;</span><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"now"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>    <span class="token keyword">return</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getDateformat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>
</code></pre> 
<p>推荐配置更新时优先考虑使用@ConfigurationProperties，而不是@Value+@RefreshScope</p> 
<h3><a id="_65"></a>多环境配置共享</h3> 
<p>某个配置在开发、测试、生产等不同环境下的数据值一致，每个配置文件中都写一次是不合理的，而且修改时必须在每个配置文件中进行修改就更加的不合理了。微服务启动时会从nacos读取多个配置文件</p> 
<ol><li>【spring.application.name】-【spring.profiles.active】.yaml，例如userservice-dev.yaml</li><li>【spring.application.name】.yaml，例如userservice.yaml</li><li>【spring.application.name】，没有后缀，例如userservice无论profile如何变化，[spring.application.name].yaml文件一定会被加载，因此多环境共享配置可以写入这个配置文件中。多配置优先级：服务名-profile.yaml &gt; 服务名.yaml &gt; 本地配置</li></ol>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1fb95745b58ff6b067e83d4ffc888f8f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【Linux】Linux下git的使用</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c08fa4d39a57bc70e24320473c3117d4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Java基础知识点---面向对象（实例三）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>