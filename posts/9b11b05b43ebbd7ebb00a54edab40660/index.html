<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【源码阅读】AndPermission源码阅读 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【源码阅读】AndPermission源码阅读" />
<meta property="og:description" content="原文地址：https://www.jianshu.com/p/24a33acb7eb6 前言 权限是绝大多数App必不可少的部分，不管你仍在用原生的方式，还是其他的开源库，AndPermission绝对是值得学习的一个开源库，今天，我们就来学习下它的设计思想。
AndPermission 思路 权限库的思路大体上都如下图所示，也玩不出太复杂的花样。
image.png
使用 1.添加引用 implementation &#39;com.yanzhenjie.permission:support:2.0.1&#39;
2.请求权限 AndPermission.with(this)
.runtime()
.permission(permissions)
.rationale(new RuntimeRationale())
.onGranted(new Action&lt;List&lt;String&gt;&gt;() {
@Override
public void onAction(List&lt;String&gt; permissions) {
toast(R.string.successfully);
}
})
.onDenied(new Action&lt;List&lt;String&gt;&gt;() {
@Override
public void onAction(@NonNull List&lt;String&gt; permissions) {
toast(R.string.failure);
if (AndPermission.hasAlwaysDeniedPermission(MainActivity.this, permissions)) {
showSettingDialog(MainActivity.this, permissions);
}
}
})
.start();
3.安装应用 private void installPackage() {
AndPermission.with(this)
.install()
.file(new File(Environment.getExternalStorageDirectory(), &#34;android.apk&#34;))
.rationale(new InstallRationale())
.onGranted(new Action&lt;File&gt;() {
@Override
public void onAction(File data) {" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/9b11b05b43ebbd7ebb00a54edab40660/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-05-22T15:11:16+08:00" />
<meta property="article:modified_time" content="2021-05-22T15:11:16+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【源码阅读】AndPermission源码阅读</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>原文地址：https://www.jianshu.com/p/24a33acb7eb6</h2> 
<h2><strong>前言</strong></h2> 
<p>权限是绝大多数App必不可少的部分，不管你仍在用原生的方式，还是其他的开源库，AndPermission绝对是值得学习的一个开源库，今天，我们就来学习下它的设计思想。</p> 
<h2><a href="https://github.com/yanzhenjie/AndPermission">AndPermission</a></h2> 
<h2>思路</h2> 
<p>权限库的思路大体上都如下图所示，也玩不出太复杂的花样。</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/1d/37/1DgoxIqI_o.png"></p> 
<p>image.png</p> 
<h2>使用</h2> 
<h3>1.添加引用</h3> 
<p><br> implementation 'com.yanzhenjie.permission:support:2.0.1'</p> 
<h3><br> 2.请求权限</h3> 
<p><br>         AndPermission.with(this)<br>             .runtime()<br>             .permission(permissions)<br>             .rationale(new RuntimeRationale())<br>             .onGranted(new Action&lt;List&lt;String&gt;&gt;() {<!-- --><br>                 @Override<br>                 public void onAction(List&lt;String&gt; permissions) {<!-- --><br>                     toast(R.string.successfully);<br>                 }<br>             })<br>             .onDenied(new Action&lt;List&lt;String&gt;&gt;() {<!-- --><br>                 @Override<br>                 public void onAction(@NonNull List&lt;String&gt; permissions) {<!-- --><br>                     toast(R.string.failure);<br>                     if (AndPermission.hasAlwaysDeniedPermission(MainActivity.this, permissions)) {<!-- --><br>                         showSettingDialog(MainActivity.this, permissions);<br>                     }<br>                 }<br>             })<br>             .start();</p> 
<h3><br> 3.安装应用</h3> 
<p><br>     private void installPackage() {<!-- --><br>         AndPermission.with(this)<br>             .install()<br>             .file(new File(Environment.getExternalStorageDirectory(), "android.apk"))<br>             .rationale(new InstallRationale())<br>             .onGranted(new Action&lt;File&gt;() {<!-- --><br>                 @Override<br>                 public void onAction(File data) {<!-- --><br>                     // Installing.<br>                     toast(R.string.successfully);<br>                 }<br>             })<br>             .onDenied(new Action&lt;File&gt;() {<!-- --><br>                 @Override<br>                 public void onAction(File data) {<!-- --><br>                     // The user refused to install.<br>                     toast(R.string.failure);<br>                 }<br>             })<br>             .start();<br>     }</p> 
<h3><br> 4.应用上显示（悬浮窗）</h3> 
<p><br>     private void requestPermissionForAlertWindow() {<!-- --><br>         AndPermission.with(this).overlay().rationale(new OverlayRationale()).onGranted(new Action&lt;Void&gt;() {<!-- --><br>             @Override<br>             public void onAction(Void data) {<!-- --><br>                 toast(R.string.successfully);<br>                 showAlertWindow();<br>             }<br>         }).onDenied(new Action&lt;Void&gt;() {<!-- --><br>             @Override<br>             public void onAction(Void data) {<!-- --><br>                 toast(R.string.failure);<br>             }<br>         }).start();<br>     }</p> 
<h3><br> 5.修改系统设置</h3> 
<p><br>     private void requestWriteSystemSetting() {<!-- --><br>         AndPermission.with(this).setting().write().rationale(new WriteSettingRationale()).onGranted(new Action&lt;Void&gt;() {<!-- --><br>             @Override<br>             public void onAction(Void data) {<!-- --><br>                 toast(R.string.successfully);<br>             }<br>         }).onDenied(new Action&lt;Void&gt;() {<!-- --><br>             @Override<br>             public void onAction(Void data) {<!-- --><br>                 toast(R.string.failure);<br>             }<br>         }).start();<br>     }</p> 
<h3><br> 6.通知</h3> 
<p><br>     private void requestNotificationListener() {<!-- --><br>         AndPermission.with(this)<br>             .notification()<br>             .listener()<br>             .rationale(new NotifyListenerRationale())<br>             .onGranted(new Action&lt;Void&gt;() {<!-- --><br>                 @Override<br>                 public void onAction(Void data) {<!-- --><br>                     toast(R.string.successfully);<br>                 }<br>             })<br>             .onDenied(new Action&lt;Void&gt;() {<!-- --><br>                 @Override<br>                 public void onAction(Void data) {<!-- --><br>                     toast(R.string.failure);<br>                 }<br>             })<br>             .start();<br>     }</p> 
<h2><br> 源码分析</h2> 
<h3>1.with方法</h3> 
<p><br> public static Option with(Context context) {<!-- --><br>         return new Boot(getContextSource(context));<br>     }<br> public static Option with(Fragment fragment) {<!-- --><br>         return new Boot(new SupportFragmentSource(fragment));<br>     }<br> public static Option with(android.app.Fragment fragment) {<!-- --><br>         return new Boot(new FragmentSource(fragment));<br>     }<br> public static Option with(Activity activity) {<!-- --><br>         return new Boot(new ActivitySource(activity));<br>     }</p> 
<p><br> with方法可以传入Context、Fragment、android.app.Fragment fragment、Activity，返回的都是Option对象，而它是个接口，我们来看看Option的实现类Boot</p> 
<p>public class Boot implements Option {<!-- --><br>     public Boot(Source source) {<!-- --><br>         this.mSource = source;<br>     }<br>     @Override<br>     public RuntimeOption runtime() {<!-- --><br>         return new Runtime(mSource);<br>     }<br>     @Override<br>     public InstallRequest install() {<!-- --><br>         return INSTALL_REQUEST_FACTORY.create(mSource);<br>     }<br>     @Override<br>     public OverlayRequest overlay() {<!-- --><br>         return OVERLAY_REQUEST_FACTORY.create(mSource);<br>     }<br>     @Override<br>     public NotifyOption notification() {<!-- --><br>         return new Notify(mSource);<br>     }<br>     @Override<br>     public Setting setting() {<!-- --><br>         return new Setting(mSource);<br>     }<br> }<br> 可以看到，这里对不同的Request做了封装，对以后的扩展非常有利，这也是AndPermission的亮点之一。</p> 
<p>之前传入的Context、Fragment、android.app.Fragment fragment、Activity只影响的startActivity、startActivityForResult、isShowRationalePermission方法</p> 
<p>Source相关代码</p> 
<p>    public abstract void startActivity(Intent intent);</p> 
<p>    public abstract void startActivityForResult(Intent intent, int requestCode);</p> 
<p>    public abstract boolean isShowRationalePermission(String permission);</p> 
<p><br> ActivitySource相关代码</p> 
<p>public class ActivitySource extends Source {<!-- --></p> 
<p>    @Override<br>     public void startActivity(Intent intent) {<!-- --><br>         mActivity.startActivity(intent);<br>     }<br>     @Override<br>     public void startActivityForResult(Intent intent, int requestCode) {<!-- --><br>         mActivity.startActivityForResult(intent, requestCode);<br>     }<br>     @Override<br>     public boolean isShowRationalePermission(String permission) {<!-- --><br>         if (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.M) return false;<br>         return mActivity.shouldShowRequestPermissionRationale(permission);<br>     }<br> }</p> 
<h3><br> 2.permission</h3> 
<p><br>     @Override<br>     public PermissionRequest permission(@NonNull String... permissions) {<!-- --><br>         //是否在`manifest.xml`中注册<br>         checkPermissions(permissions);<br>         return FACTORY.create(mSource).permission(permissions);<br>     }<br> 这里首先对传入的权限做了检查，是否在manifest.xml中注册，然后调用FACTORY.create创建了一个PermissionRequest</p> 
<p>    static {<!-- --><br>         if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.M) {<!-- --><br>             FACTORY = new MRequestFactory();<br>         } else {<!-- --><br>             FACTORY = new LRequestFactory();<br>         }<br>     }<br>     public interface PermissionRequestFactory {<!-- --><br>         PermissionRequest create(Source source);<br>     }</p> 
<h3><br> 3.rationale相当于是个拦截器，当没有权限时会执行。</h3> 
<p><br> 这个有什么用呢？比如说，App需要申请全局悬浮窗权限，相比直接跳到授权页，弹个提示框由用户选择是否去授权就显得友好的多。<br> 当showRationale()被回调后说明没有权限，此时开发者必须回调RequestExecutor#execute()来启动设置或者RequestExecutor#cancel()来取消启动设置，否则将不会回调onGranted()或者onDenied()中的任何一个，也就是说AndPermission将不会有任何响应。</p> 
<h3>4.onGranted同意授权时调用，onDenied拒绝授权时调用</h3> 
<h3><br> 5.start开始授权</h3> 
<p><br> MRequest相关代码如下</p> 
<p>    @Override<br>     public void start() {<!-- --><br>         List&lt;String&gt; deniedList = getDeniedPermissions(STANDARD_CHECKER, mSource, mPermissions);<br>         mDeniedPermissions = deniedList.toArray(new String[deniedList.size()]);<br>         if (mDeniedPermissions.length &gt; 0) {<!-- --><br>             List&lt;String&gt; rationaleList = getRationalePermissions(mSource, mDeniedPermissions);<br>             if (rationaleList.size() &gt; 0) {<!-- --><br>                 mRationale.showRationale(mSource.getContext(), rationaleList, this);<br>             } else {<!-- --><br>                 execute();<br>             }<br>         } else {<!-- --><br>             onCallback();<br>         }<br>     }<br> 首先，判断传递进来的权限有哪些是没有已授权，如都已授权，直接回调成功；如有未授权的，先判断是否有需要拦截的，如没有，则调用execute方法</p> 
<p>    public void execute() {<!-- --><br>         BridgeRequest request = new BridgeRequest(mSource);<br>         request.setType(BridgeRequest.TYPE_PERMISSION);<br>         request.setPermissions(mDeniedPermissions);<br>         request.setCallback(this);<br>         RequestManager.get().add(request);<br>     }<br> RequestManager 它的核心是个线程池</p> 
<p>相关方法</p> 
<p>    private RequestManager() {<!-- --><br>         this.mQueue = new LinkedBlockingQueue&lt;&gt;();</p> 
<p>        new RequestExecutor(mQueue).start();<br>     }<br>     public void add(BridgeRequest request) {<!-- --><br>         mQueue.add(request);<br>     }<br> RequestExecutor相关方法</p> 
<p>    public void run() {<!-- --><br>         while (true) {<!-- --><br>             synchronized (this) {<!-- --><br>                 try {<!-- --><br>                     mRequest = mQueue.take();<br>                 } catch (InterruptedException e) {<!-- --><br>                     continue;<br>                 }<br>                 mMessenger = new Messenger(mRequest.getSource().getContext(), this);<br>                 mMessenger.register();<br>                 executeCurrent();<br>                 try {<!-- --><br>                     wait();<br>                 } catch (InterruptedException e) {<!-- --><br>                     e.printStackTrace();<br>                 }<br>             }<br>         }<br>     }<br>     private void executeCurrent() {<!-- --><br>             ...省略...<br>             case BridgeRequest.TYPE_PERMISSION: <br>                 BridgeActivity.requestPermission(mRequest.getSource(), mRequest.getPermissions());<br>                 break;<br>             ...省略...<br>     }<br> 再来看看 BridgeActivity.requestPermission</p> 
<p>    static void requestPermission(Source source, String[] permissions) {<!-- --><br>         Intent intent = new Intent(source.getContext(), BridgeActivity.class);<br>         intent.putExtra(KEY_TYPE, BridgeRequest.TYPE_PERMISSION);<br>         intent.putExtra(KEY_PERMISSIONS, permissions);<br>         source.startActivity(intent);<br>     }<br> BridgeActivity相关代码</p> 
<p>    @Override<br>     protected void onCreate(Bundle savedInstanceState) {<!-- --><br>                  ...省略...<br>                  String[] permissions = intent.getStringArrayExtra(KEY_PERMISSIONS);<br>                 requestPermissions(permissions, BridgeRequest.TYPE_PERMISSION);<br>                  ...省略...<br>      }<br> 看到这里大家就比较熟悉了，最后我们在看看授权的回调处理</p> 
<p>    @Override<br>     public void onRequestPermissionsResult(int requestCode, @NonNull String[] permissions,<br>         @NonNull int[] grantResults) {<!-- --><br>         Messenger.send(this);<br>         finish();<br>     }<br> Messenger相关代码</p> 
<p>    public static void send(Context context) {<!-- --><br>         Intent broadcast = new Intent(ACTION);<br>         context.sendBroadcast(broadcast);<br>     }<br>     @Override<br>     public void onReceive(Context context, Intent intent) {<!-- --><br>         mCallback.onCallback();<br>     }</p> 
<p>这里回调到了RequestExecutor#onCallback方法，而其又回调到了MRequest#onCallback方法</p> 
<p>MRequest相关代码</p> 
<p>    @Override<br>     public void onCallback() {<!-- --><br>         new AsyncTask&lt;Void, Void, List&lt;String&gt;&gt;() {<!-- --><br>             @Override<br>             protected List&lt;String&gt; doInBackground(Void... voids) {<!-- --><br>                 return getDeniedPermissions(DOUBLE_CHECKER, mSource, mPermissions);<br>             }<br>             @Override<br>             protected void onPostExecute(List&lt;String&gt; deniedList) {<!-- --><br>                 if (deniedList.isEmpty()) {<!-- --><br>                     callbackSucceed();<br>                 } else {<!-- --><br>                     callbackFailed(deniedList);<br>                 }<br>             }<br>         }.execute();<br>     }<br> 这里再次对传入的权限做检查，如果没有未授权，则回调成功，否则回调失败。</p> 
<h3>6.用户拒绝授权时提示</h3> 
<p><br>                     if (AndPermission.hasAlwaysDeniedPermission(MainActivity.this, permissions)) {<!-- --><br>                         showSettingDialog(MainActivity.this, permissions);<br>                     }<br> 最终调用的逻辑是在SettingPage#start方法，这里对不同的机型做了适配</p> 
<p>    public void start(int requestCode) {<!-- --><br>         Intent intent;<br>         if (MARK.contains("huawei")) {<!-- --><br>             intent = huaweiApi(mSource.getContext());<br>         } else if (MARK.contains("xiaomi")) {<!-- --><br>             intent = xiaomiApi(mSource.getContext());<br>         } else if (MARK.contains("oppo")) {<!-- --><br>             intent = oppoApi(mSource.getContext());<br>         } else if (MARK.contains("vivo")) {<!-- --><br>             intent = vivoApi(mSource.getContext());<br>         } else if (MARK.contains("meizu")) {<!-- --><br>             intent = meizuApi(mSource.getContext());<br>         } else {<!-- --><br>             intent = defaultApi(mSource.getContext());<br>         }<br>         try {<!-- --><br>             mSource.startActivityForResult(intent, requestCode);<br>         } catch (Exception e) {<!-- --><br>             intent = defaultApi(mSource.getContext());<br>             mSource.startActivityForResult(intent, requestCode);<br>         }<br>     }</p> 
<h2><br> 总结</h2> 
<h3>设计思想：</h3> 
<p>1.构建请求Request<br> 2.封装参数<br> 3.添加到线程池<br> 4.执行完毕，回调<br> 这和Glide是惊人的相似，详情可以查看【源码阅读】Glide源码阅读之with方法（一）系列文章</p> 
<h2>结束语</h2> 
<p>这里只分析了runtime的设计思想，install、overlay、notification与其类似，就不一一分析了。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fea16938dd7518d9d861e7ceabea4096/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">TCP服务器搭建—阿里云&amp;&amp;Jetson Nano</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e9c4537fe2e29419779c02f3272fe0d2/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Java对象监视器Monitor</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>