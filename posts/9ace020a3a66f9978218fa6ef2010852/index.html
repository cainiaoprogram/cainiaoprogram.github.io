<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>zookeeper源码(05)数据存储 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="zookeeper源码(05)数据存储" />
<meta property="og:description" content="本文详细分析一下zookeeper的数据存储。
ZKDatabase 维护zookeeper服务器内存数据库，包括session、dataTree和committedlog数据，从磁盘读取日志和快照后启动。
关键字段 // 数据节点树 protected DataTree dataTree; protected ConcurrentHashMap&lt;Long, Integer&gt; sessionsWithTimeouts; protected FileTxnSnapLog snapLog; // 用于操作底层数据文件 // committedLog中第一条和最后一条数据的zxid protected long minCommittedLog, maxCommittedLog; // committedLog最大容量，默认500 public int commitLogCount; // 维护最后提交的请求集，可用于快速follower同步 protected Queue&lt;Proposal&gt; committedLog = new ArrayDeque&lt;&gt;(); protected ReentrantReadWriteLock logLock = new ReentrantReadWriteLock(); private volatile boolean initialized = false; // txnlog计数 private AtomicInteger txnCount = new AtomicInteger(0); 构造方法 public ZKDatabase(FileTxnSnapLog snapLog) { dataTree = createDataTree(); sessionsWithTimeouts = new ConcurrentHashMap&lt;&gt;(); this." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/9ace020a3a66f9978218fa6ef2010852/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-09T00:08:42+08:00" />
<meta property="article:modified_time" content="2024-01-09T00:08:42+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">zookeeper源码(05)数据存储</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>本文详细分析一下zookeeper的数据存储。</p> 
<h2><a id="ZKDatabase_4"></a>ZKDatabase</h2> 
<p>维护zookeeper服务器内存数据库，包括session、dataTree和committedlog数据，从磁盘读取日志和快照后启动。</p> 
<h3><a id="_10"></a>关键字段</h3> 
<pre><code class="prism language-java"><span class="token comment">// 数据节点树</span>
<span class="token keyword">protected</span> <span class="token class-name">DataTree</span> dataTree<span class="token punctuation">;</span>
<span class="token keyword">protected</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> sessionsWithTimeouts<span class="token punctuation">;</span>
<span class="token keyword">protected</span> <span class="token class-name">FileTxnSnapLog</span> snapLog<span class="token punctuation">;</span> <span class="token comment">// 用于操作底层数据文件</span>
<span class="token comment">// committedLog中第一条和最后一条数据的zxid</span>
<span class="token keyword">protected</span> <span class="token keyword">long</span> minCommittedLog<span class="token punctuation">,</span> maxCommittedLog<span class="token punctuation">;</span>
<span class="token comment">// committedLog最大容量，默认500</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> commitLogCount<span class="token punctuation">;</span>
<span class="token comment">// 维护最后提交的请求集，可用于快速follower同步</span>
<span class="token keyword">protected</span> <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Proposal</span><span class="token punctuation">&gt;</span></span> committedLog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayDeque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">protected</span> <span class="token class-name">ReentrantReadWriteLock</span> logLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantReadWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> initialized <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token comment">// txnlog计数</span>
<span class="token keyword">private</span> <span class="token class-name">AtomicInteger</span> txnCount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="_33"></a>构造方法</h3> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">ZKDatabase</span><span class="token punctuation">(</span><span class="token class-name">FileTxnSnapLog</span> snapLog<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    dataTree <span class="token operator">=</span> <span class="token function">createDataTree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sessionsWithTimeouts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>snapLog <span class="token operator">=</span> snapLog<span class="token punctuation">;</span>

    <span class="token comment">// 初始化snapshotSizeFactor默认0.33</span>
    <span class="token comment">// 初始化commitLogCount默认500</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">DataTree</span> <span class="token function">createDataTree</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DataTree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>创建DataTree对象：创建/zookeeper/quota、/zookeeper/config节点，创建dataWatches和childWatches对象(使用WatchManager实现类)。</p> 
<h3><a id="_54"></a>主要方法</h3> 
<pre><code class="prism language-java"><span class="token comment">// 返回committedLog集</span>
<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Proposal</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCommittedLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回dataTree.lastProcessedZxid的值</span>
<span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getDataTreeLastProcessedZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回dataTree.getSessions()集</span>
<span class="token keyword">public</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSessions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回sessionsWithTimeouts的size</span>
<span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getSessionCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 从磁盘加载dataTree并把txnLog加载到committedLog中</span>
<span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">loadDataBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token comment">// 从磁盘加载txnLog到committedLog中</span>
<span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">fastForwardDataBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token comment">// 使用addCommittedProposal方法添加committedLog</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">addCommittedProposal</span><span class="token punctuation">(</span><span class="token class-name">TxnHeader</span> hdr<span class="token punctuation">,</span> <span class="token class-name">Record</span> txn<span class="token punctuation">,</span> <span class="token class-name">TxnDigest</span> digest<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 添加committedLog</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addCommittedProposal</span><span class="token punctuation">(</span><span class="token class-name">Request</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 从txnLog加载Proposal</span>
<span class="token keyword">public</span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Proposal</span><span class="token punctuation">&gt;</span></span> <span class="token function">getProposalsFromTxnLog</span><span class="token punctuation">(</span><span class="token keyword">long</span> startZxid<span class="token punctuation">,</span> <span class="token keyword">long</span> sizeLimit<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 使用dataTree.removeCnxn(cnxn)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">removeCnxn</span><span class="token punctuation">(</span><span class="token class-name">ServerCnxn</span> cnxn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 使用dataTree.killSession(sessionId, zxid)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">killSession</span><span class="token punctuation">(</span><span class="token keyword">long</span> sessionId<span class="token punctuation">,</span> <span class="token keyword">long</span> zxid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 使用dataTree.dumpEphemerals(pwriter)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">dumpEphemerals</span><span class="token punctuation">(</span><span class="token class-name">PrintWriter</span> pwriter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 使用dataTree.getEphemerals()</span>
<span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getEphemerals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 使用dataTree.getNodeCount()</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getNodeCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 使用dataTree.getEphemerals(sessionId)</span>
<span class="token keyword">public</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getEphemerals</span><span class="token punctuation">(</span><span class="token keyword">long</span> sessionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 给dataTree.lastProcessedZxid赋值</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setlastProcessedZxid</span><span class="token punctuation">(</span><span class="token keyword">long</span> zxid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 使用dataTree.processTxn(hdr, txn, digest)</span>
<span class="token keyword">public</span> <span class="token class-name">ProcessTxnResult</span> <span class="token function">processTxn</span><span class="token punctuation">(</span><span class="token class-name">TxnHeader</span> hdr<span class="token punctuation">,</span> <span class="token class-name">Record</span> txn<span class="token punctuation">,</span> <span class="token class-name">TxnDigest</span> digest<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 使用dataTree.statNode(path, serverCnxn)</span>
<span class="token keyword">public</span> <span class="token class-name">Stat</span> <span class="token function">statNode</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token class-name">ServerCnxn</span> serverCnxn<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">KeeperException<span class="token punctuation">.</span>NoNodeException</span><span class="token punctuation">;</span>
<span class="token comment">// 使用dataTree.getNode(path)</span>
<span class="token keyword">public</span> <span class="token class-name">DataNode</span> <span class="token function">getNode</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 使用dataTree.getData(path, stat, watcher)</span>
<span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token class-name">Stat</span> stat<span class="token punctuation">,</span> <span class="token class-name">Watcher</span> watcher<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">KeeperException<span class="token punctuation">.</span>NoNodeException</span><span class="token punctuation">;</span>
<span class="token comment">// 使用dataTree.setWatches方法实现</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setWatches</span><span class="token punctuation">(</span><span class="token keyword">long</span> relativeZxid<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> dataWatches<span class="token punctuation">,</span>
                       <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> existWatches<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> childWatches<span class="token punctuation">,</span>
                       <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> persistentWatches<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> persistentRecursiveWatches<span class="token punctuation">,</span>
                       <span class="token class-name">Watcher</span> watcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 使用dataTree.addWatch(basePath, watcher, mode)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addWatch</span><span class="token punctuation">(</span><span class="token class-name">String</span> basePath<span class="token punctuation">,</span> <span class="token class-name">Watcher</span> watcher<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 使用dataTree.getChildren(path, stat, watcher)</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getChildren</span><span class="token punctuation">(</span>
    <span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token class-name">Stat</span> stat<span class="token punctuation">,</span> <span class="token class-name">Watcher</span> watcher<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">KeeperException<span class="token punctuation">.</span>NoNodeException</span><span class="token punctuation">;</span>
<span class="token comment">// 使用dataTree.getAllChildrenNumber(path)</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getAllChildrenNumber</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">KeeperException<span class="token punctuation">.</span>NoNodeException</span><span class="token punctuation">;</span>
<span class="token comment">// Truncate the ZKDatabase to the specified zxid</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">truncateLog</span><span class="token punctuation">(</span><span class="token keyword">long</span> zxid<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token comment">// Deserialize a snapshot from an input archive</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deserializeSnapshot</span><span class="token punctuation">(</span><span class="token class-name">InputArchive</span> ia<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token comment">// Deserialize a snapshot that contains FileHeader from an input archive</span>
<span class="token comment">// It is used by the admin restore command</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deserializeSnapshot</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">InputArchive</span> ia<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">CheckedInputStream</span> is<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token comment">// Serialize the snapshot</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">serializeSnapshot</span><span class="token punctuation">(</span><span class="token class-name">OutputArchive</span> oa<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span>
<span class="token comment">// 使用snapLog.append(si)保存数据，txnCount++</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">Request</span> si<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token comment">// 使用snapLog.rollLog()滚动底层txnLog</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rollLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token comment">// 使用snapLog.commit()提交底层txnLog</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token comment">// 初始化/zookeeper/config数据，集群启动时已介绍</span>
<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">initConfigInZKDatabase</span><span class="token punctuation">(</span><span class="token class-name">QuorumVerifier</span> qv<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 使用dataTree.containsWatcher(path, type, watcher)</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">containsWatcher</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token class-name">WatcherType</span> type<span class="token punctuation">,</span> <span class="token class-name">Watcher</span> watcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 使用dataTree.removeWatch(path, type, watcher)</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">removeWatch</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token class-name">WatcherType</span> type<span class="token punctuation">,</span> <span class="token class-name">Watcher</span> watcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="loadDataBase_134"></a>loadDataBase方法</h3> 
<p>从磁盘加载dataTree并把txnLog加载到committedLog中：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">loadDataBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">long</span> startTime <span class="token operator">=</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">currentElapsedTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 1. 从snapshot加载dataTree</span>
    <span class="token comment">// 2. 使用fastForwardFromEdits方法从txnLog加载dataTree和committedlog</span>
    <span class="token keyword">long</span> zxid <span class="token operator">=</span> snapLog<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span>dataTree<span class="token punctuation">,</span> sessionsWithTimeouts<span class="token punctuation">,</span> commitProposalPlaybackListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    initialized <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment">// 略</span>
    <span class="token keyword">return</span> zxid<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="fastForwardDataBase_152"></a>fastForwardDataBase方法</h3> 
<p>从txnLog加载dataTree和committedlog集：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">fastForwardDataBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 会通过commitProposalPlaybackListener调用addCommittedProposal添加committedlog</span>
    <span class="token keyword">long</span> zxid <span class="token operator">=</span> snapLog<span class="token punctuation">.</span><span class="token function">fastForwardFromEdits</span><span class="token punctuation">(</span>
        dataTree<span class="token punctuation">,</span> sessionsWithTimeouts<span class="token punctuation">,</span> commitProposalPlaybackListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    initialized <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> zxid<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="addCommittedProposal_168"></a>addCommittedProposal方法</h3> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">addCommittedProposal</span><span class="token punctuation">(</span><span class="token class-name">TxnHeader</span> hdr<span class="token punctuation">,</span> <span class="token class-name">Record</span> txn<span class="token punctuation">,</span> <span class="token class-name">TxnDigest</span> digest<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Request</span> r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> hdr<span class="token punctuation">.</span><span class="token function">getCxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> hdr<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> hdr<span class="token punctuation">,</span> txn<span class="token punctuation">,</span> hdr<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    r<span class="token punctuation">.</span><span class="token function">setTxnDigest</span><span class="token punctuation">(</span>digest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addCommittedProposal</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addCommittedProposal</span><span class="token punctuation">(</span><span class="token class-name">Request</span> request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">WriteLock</span> wl <span class="token operator">=</span> logLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        wl<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>committedLog<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> commitLogCount<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            committedLog<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            minCommittedLog <span class="token operator">=</span> committedLog<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>packet<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>committedLog<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            minCommittedLog <span class="token operator">=</span> request<span class="token punctuation">.</span>zxid<span class="token punctuation">;</span>
            maxCommittedLog <span class="token operator">=</span> request<span class="token punctuation">.</span>zxid<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSerializeData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">QuorumPacket</span> pp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QuorumPacket</span><span class="token punctuation">(</span><span class="token class-name">Leader</span><span class="token punctuation">.</span><span class="token constant">PROPOSAL</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>zxid<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Proposal</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proposal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        p<span class="token punctuation">.</span>packet <span class="token operator">=</span> pp<span class="token punctuation">;</span>
        p<span class="token punctuation">.</span>request <span class="token operator">=</span> request<span class="token punctuation">;</span>
        committedLog<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        maxCommittedLog <span class="token operator">=</span> p<span class="token punctuation">.</span>packet<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
        wl<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="getProposalsFromTxnLog_204"></a>getProposalsFromTxnLog方法</h3> 
<p>从txnlog获取Proposal，只填充packet字段：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Proposal</span><span class="token punctuation">&gt;</span></span> <span class="token function">getProposalsFromTxnLog</span><span class="token punctuation">(</span><span class="token keyword">long</span> startZxid<span class="token punctuation">,</span> <span class="token keyword">long</span> sizeLimit<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sizeLimit <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">TxnLogProposalIterator</span><span class="token punctuation">.</span><span class="token constant">EMPTY_ITERATOR</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">TxnIterator</span> itr <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 从txnLog文件读取数据</span>
        <span class="token comment">// 底层通过FileTxnIterator类读取文件流实现</span>
        itr <span class="token operator">=</span> snapLog<span class="token punctuation">.</span><span class="token function">readTxnLog</span><span class="token punctuation">(</span>startZxid<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// If we cannot guarantee that this is strictly the starting txn</span>
        <span class="token comment">// after a given zxid, we should fail.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>itr<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>itr<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> startZxid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            itr<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">TxnLogProposalIterator</span><span class="token punctuation">.</span><span class="token constant">EMPTY_ITERATOR</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>sizeLimit <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">long</span> txnSize <span class="token operator">=</span> itr<span class="token punctuation">.</span><span class="token function">getStorageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>txnSize <span class="token operator">&gt;</span> sizeLimit<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                itr<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token class-name">TxnLogProposalIterator</span><span class="token punctuation">.</span><span class="token constant">EMPTY_ITERATOR</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        itr<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">TxnLogProposalIterator</span><span class="token punctuation">.</span><span class="token constant">EMPTY_ITERATOR</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TxnLogProposalIterator</span><span class="token punctuation">(</span>itr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="truncateLog_244"></a>truncateLog方法</h3> 
<p>把txnlog数据truncate到指定的zxid位置，然后重新加载DataTree数据：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">truncateLog</span><span class="token punctuation">(</span><span class="token keyword">long</span> zxid<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// truncate the log</span>
    <span class="token keyword">boolean</span> truncated <span class="token operator">=</span> snapLog<span class="token punctuation">.</span><span class="token function">truncateLog</span><span class="token punctuation">(</span>zxid<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>truncated<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">loadDataBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="deserializeSnapshot_266"></a>deserializeSnapshot方法</h3> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deserializeSnapshot</span><span class="token punctuation">(</span><span class="token class-name">InputArchive</span> ia<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SerializeUtils</span><span class="token punctuation">.</span><span class="token function">deserializeSnapshot</span><span class="token punctuation">(</span><span class="token function">getDataTree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ia<span class="token punctuation">,</span> <span class="token function">getSessionWithTimeOuts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    initialized <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deserializeSnapshot</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">InputArchive</span> ia<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">CheckedInputStream</span> is<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// deserialize data tree</span>
    <span class="token keyword">final</span> <span class="token class-name">DataTree</span> dataTree <span class="token operator">=</span> <span class="token function">getDataTree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">FileSnap</span><span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>dataTree<span class="token punctuation">,</span> <span class="token function">getSessionWithTimeOuts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ia<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SnapStream</span><span class="token punctuation">.</span><span class="token function">checkSealIntegrity</span><span class="token punctuation">(</span>is<span class="token punctuation">,</span> ia<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// deserialize digest and check integrity</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dataTree<span class="token punctuation">.</span><span class="token function">deserializeZxidDigest</span><span class="token punctuation">(</span>ia<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SnapStream</span><span class="token punctuation">.</span><span class="token function">checkSealIntegrity</span><span class="token punctuation">(</span>is<span class="token punctuation">,</span> ia<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// deserialize lastProcessedZxid and check integrity</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dataTree<span class="token punctuation">.</span><span class="token function">deserializeLastProcessedZxid</span><span class="token punctuation">(</span>ia<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SnapStream</span><span class="token punctuation">.</span><span class="token function">checkSealIntegrity</span><span class="token punctuation">(</span>is<span class="token punctuation">,</span> ia<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// compare the digest to find inconsistency</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dataTree<span class="token punctuation">.</span><span class="token function">getDigestFromLoadedSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        dataTree<span class="token punctuation">.</span><span class="token function">compareSnapshotDigests</span><span class="token punctuation">(</span>dataTree<span class="token punctuation">.</span>lastProcessedZxid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    initialized <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="serializeSnapshot_304"></a>serializeSnapshot方法</h3> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">serializeSnapshot</span><span class="token punctuation">(</span><span class="token class-name">OutputArchive</span> oa<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">SerializeUtils</span><span class="token punctuation">.</span><span class="token function">serializeSnapshot</span><span class="token punctuation">(</span><span class="token function">getDataTree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> oa<span class="token punctuation">,</span> <span class="token function">getSessionWithTimeOuts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="DataTree_314"></a>DataTree</h2> 
<p>维护树状结构，没有任何网络或客户端连接代码，因此可以以独立的方式进行测试。</p> 
<p>维护两个并行的数据结构：一个从完整路径映射到DataNodes的哈希表和一个DataNodes树，对路径的所有访问都是通过哈希表进行的，只有在序列化到磁盘时才遍历DataNodes树。</p> 
<h3><a id="_322"></a>关键字段</h3> 
<pre><code class="prism language-java"><span class="token comment">// This map provides a fast lookup to the data nodes</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">NodeHashMap</span> nodes<span class="token punctuation">;</span>
<span class="token comment">// Watcher</span>
<span class="token keyword">private</span> <span class="token class-name">IWatchManager</span> dataWatches<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token class-name">IWatchManager</span> childWatches<span class="token punctuation">;</span>
<span class="token comment">// cached total size of paths and data for all DataNodes</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicLong</span> nodeDataSize <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// This hashtable lists the paths of the ephemeral nodes of a session</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">HashSet</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> ephemerals <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// This set contains the paths of all container nodes</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> containers <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">newSetFromMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// This set contains the paths of all ttl nodes</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> ttls <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">newSetFromMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// This is a pointer to the root of the DataTree</span>
<span class="token keyword">private</span> <span class="token class-name">DataNode</span> root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataNode</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">StatPersisted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// create a /zookeeper filesystem that is the proc filesystem of zookeeper</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">DataNode</span> procDataNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataNode</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">StatPersisted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// create a /zookeeper/quota node for maintaining quota properties for zookeeper</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">DataNode</span> quotaDataNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataNode</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">StatPersisted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 最新被处理的zxid</span>
<span class="token keyword">public</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> lastProcessedZxid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>NodeHashMap - NodeHashMapImpl实现类使用ConcurrentHashMap保存path -&gt; DataNode数据</li><li>IWatchManager和Watcher - 监听器管理</li><li>DataNode - 封装树节点信息，包括data、children、stat等</li></ul> 
<h3><a id="_356"></a>构造方法</h3> 
<pre><code class="prism language-java"><span class="token class-name">DataTree</span><span class="token punctuation">(</span><span class="token class-name">DigestCalculator</span> digestCalculator<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>digestCalculator <span class="token operator">=</span> digestCalculator<span class="token punctuation">;</span>
    nodes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NodeHashMapImpl</span><span class="token punctuation">(</span>digestCalculator<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// rather than fight it, let root have an alias</span>
    nodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "" -&gt; root</span>
    nodes<span class="token punctuation">.</span><span class="token function">putWithoutDigest</span><span class="token punctuation">(</span>rootZookeeper<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "/" -&gt; root</span>

    <span class="token comment">// add the proc node and quota node</span>
    root<span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>procChildZookeeper<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 添加zookeeper子节点</span>
    nodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>procZookeeper<span class="token punctuation">,</span> procDataNode<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "/zookeeper" -&gt; procDataNode</span>

    procDataNode<span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>quotaChildZookeeper<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 添加quota子节点</span>
    nodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>quotaZookeeper<span class="token punctuation">,</span> quotaDataNode<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "/zookeeper/quota" -&gt; quotaDataNode</span>

    <span class="token function">addConfigNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 添加/zookeeper/config节点</span>

    nodeDataSize<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token function">approximateDataSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 使用WatchManager实现类</span>
        dataWatches <span class="token operator">=</span> <span class="token class-name">WatchManagerFactory</span><span class="token punctuation">.</span><span class="token function">createWatchManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        childWatches <span class="token operator">=</span> <span class="token class-name">WatchManagerFactory</span><span class="token punctuation">.</span><span class="token function">createWatchManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addConfigNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">DataNode</span> zookeeperZnode <span class="token operator">=</span> nodes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>procZookeeper<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 找到/zookeeper节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>zookeeperZnode <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        zookeeperZnode<span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>configChildZookeeper<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 添加config子节点</span>
    <span class="token punctuation">}</span>

    nodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>configZookeeper<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DataNode</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">StatPersisted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Reconfig node is access controlled by default (ZOOKEEPER-2014).</span>
        <span class="token function">setACL</span><span class="token punctuation">(</span>configZookeeper<span class="token punctuation">,</span> <span class="token class-name">ZooDefs<span class="token punctuation">.</span>Ids</span><span class="token punctuation">.</span><span class="token constant">READ_ACL_UNSAFE</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoNodeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_400"></a>主要方法</h3> 
<pre><code class="prism language-java"><span class="token comment">// Add a new node to the DataTree</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createNode</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>ACL<span class="token punctuation">&gt;</span></span> acl<span class="token punctuation">,</span> <span class="token keyword">long</span> ephemeralOwner<span class="token punctuation">,</span>
                       <span class="token keyword">int</span> parentCVersion<span class="token punctuation">,</span> <span class="token keyword">long</span> zxid<span class="token punctuation">,</span> <span class="token keyword">long</span> time<span class="token punctuation">,</span> <span class="token class-name">Stat</span> outputStat<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Remove path from the DataTree</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteNode</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token keyword">long</span> zxid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 为节点设置数据</span>
<span class="token keyword">public</span> <span class="token class-name">Stat</span> <span class="token function">setData</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data<span class="token punctuation">,</span> <span class="token keyword">int</span> version<span class="token punctuation">,</span> <span class="token keyword">long</span> zxid<span class="token punctuation">,</span> <span class="token keyword">long</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 1. 获取path的data</span>
<span class="token comment">// 2. 如果watcher不为null则addWatch</span>
<span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token class-name">Stat</span> stat<span class="token punctuation">,</span> <span class="token class-name">Watcher</span> watcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 使用node.copyStat(stat)保存stat数据</span>
<span class="token keyword">public</span> <span class="token class-name">Stat</span> <span class="token function">statNode</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token class-name">Watcher</span> watcher<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 1. copyStat到stat中</span>
<span class="token comment">// 2. addWatch</span>
<span class="token comment">// 3. getChildren</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token class-name">Stat</span> stat<span class="token punctuation">,</span> <span class="token class-name">Watcher</span> watcher<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 设置、获取权限</span>
<span class="token keyword">public</span> <span class="token class-name">Stat</span> <span class="token function">setACL</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>ACL<span class="token punctuation">&gt;</span></span> acl<span class="token punctuation">,</span> <span class="token keyword">int</span> version<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>ACL<span class="token punctuation">&gt;</span></span> <span class="token function">getACL</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token class-name">Stat</span> stat<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>ACL<span class="token punctuation">&gt;</span></span> <span class="token function">getACL</span><span class="token punctuation">(</span><span class="token class-name">DataNode</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 添加Watcher</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addWatch</span><span class="token punctuation">(</span><span class="token class-name">String</span> basePath<span class="token punctuation">,</span> <span class="token class-name">Watcher</span> watcher<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 处理事务请求</span>
<span class="token keyword">public</span> <span class="token class-name">ProcessTxnResult</span> <span class="token function">processTxn</span><span class="token punctuation">(</span><span class="token class-name">TxnHeader</span> header<span class="token punctuation">,</span> <span class="token class-name">Record</span> txn<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isSubTxn<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 杀会话，使用deleteNodes删除paths2DeleteLocal和paths2DeleteInTxn集</span>
<span class="token keyword">void</span> <span class="token function">killSession</span><span class="token punctuation">(</span>
    <span class="token keyword">long</span> session<span class="token punctuation">,</span> <span class="token keyword">long</span> zxid<span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> paths2DeleteLocal<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> paths2DeleteInTxn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 遍历paths2Delete调用deleteNode方法删除节点</span>
<span class="token keyword">void</span> <span class="token function">deleteNodes</span><span class="token punctuation">(</span><span class="token keyword">long</span> session<span class="token punctuation">,</span> <span class="token keyword">long</span> zxid<span class="token punctuation">,</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> paths2Delete<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 递归方式获取path下面的总节点数和总字节数</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">getCounts</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token class-name">Counts</span> counts<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 序列化</span>
<span class="token keyword">void</span> <span class="token function">serializeNode</span><span class="token punctuation">(</span><span class="token class-name">OutputArchive</span> oa<span class="token punctuation">,</span> <span class="token class-name">StringBuilder</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">serializeNodeData</span><span class="token punctuation">(</span><span class="token class-name">OutputArchive</span> oa<span class="token punctuation">,</span> <span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token class-name">DataNode</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">serializeAcls</span><span class="token punctuation">(</span><span class="token class-name">OutputArchive</span> oa<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">serializeNodes</span><span class="token punctuation">(</span><span class="token class-name">OutputArchive</span> oa<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token class-name">OutputArchive</span> oa<span class="token punctuation">,</span> <span class="token class-name">String</span> tag<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 反序列化</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deserialize</span><span class="token punctuation">(</span><span class="token class-name">InputArchive</span> ia<span class="token punctuation">,</span> <span class="token class-name">String</span> tag<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 从dataWatches和childWatches移除watcher</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">removeCnxn</span><span class="token punctuation">(</span><span class="token class-name">Watcher</span> watcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 触发或addWatch</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setWatches</span><span class="token punctuation">(</span><span class="token keyword">long</span> relativeZxid<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> dataWatches<span class="token punctuation">,</span>
                       <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> existWatches<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> childWatches<span class="token punctuation">,</span>
                       <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> persistentWatches<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> persistentRecursiveWatches<span class="token punctuation">,</span>
                       <span class="token class-name">Watcher</span> watcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 为path设置新的cversion和zxid</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCversionPzxid</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token keyword">int</span> newCversion<span class="token punctuation">,</span> <span class="token keyword">long</span> zxid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Add the digest to the historical list, and update the latest zxid digest</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">logZxidDigest</span><span class="token punctuation">(</span><span class="token keyword">long</span> zxid<span class="token punctuation">,</span> <span class="token keyword">long</span> digest<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 序列化、反序列化lastProcessedZxidDigest</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">serializeZxidDigest</span><span class="token punctuation">(</span><span class="token class-name">OutputArchive</span> oa<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">deserializeZxidDigest</span><span class="token punctuation">(</span><span class="token class-name">InputArchive</span> ia<span class="token punctuation">,</span> <span class="token keyword">long</span> startZxidOfSnapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 序列化、反序列化lastProcessedZxid</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">serializeLastProcessedZxid</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">OutputArchive</span> oa<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">deserializeLastProcessedZxid</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">InputArchive</span> ia<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Compares the actual tree's digest with that in the snapshot.</span>
<span class="token comment">// Resets digestFromLoadedSnapshot after comparison.</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">compareSnapshotDigests</span><span class="token punctuation">(</span><span class="token keyword">long</span> zxid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Compares the digest of the tree with the digest present in transaction digest.</span>
<span class="token comment">// If there is any error, logs and alerts the watchers.</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">compareDigest</span><span class="token punctuation">(</span><span class="token class-name">TxnHeader</span> header<span class="token punctuation">,</span> <span class="token class-name">Record</span> txn<span class="token punctuation">,</span> <span class="token class-name">TxnDigest</span> digest<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="createNode_474"></a>createNode方法</h3> 
<p>processTxn中会使用该方法创建节点：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createNode</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>ACL<span class="token punctuation">&gt;</span></span> acl<span class="token punctuation">,</span>
                       <span class="token keyword">long</span> ephemeralOwner<span class="token punctuation">,</span> <span class="token keyword">int</span> parentCVersion<span class="token punctuation">,</span> <span class="token keyword">long</span> zxid<span class="token punctuation">,</span>
                       <span class="token keyword">long</span> time<span class="token punctuation">,</span> <span class="token class-name">Stat</span> outputStat<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoNodeException</span><span class="token punctuation">,</span> <span class="token class-name">NodeExistsException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> lastSlash <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token char">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> parentName <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> lastSlash<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> childName <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>lastSlash <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">StatPersisted</span> stat <span class="token operator">=</span> <span class="token function">createStat</span><span class="token punctuation">(</span>zxid<span class="token punctuation">,</span> time<span class="token punctuation">,</span> ephemeralOwner<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Create a node stat</span>
    <span class="token class-name">DataNode</span> parent <span class="token operator">=</span> nodes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>parentName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 父节点需要存在</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Long</span> acls <span class="token operator">=</span> aclCache<span class="token punctuation">.</span><span class="token function">convertAcls</span><span class="token punctuation">(</span>acl<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> children <span class="token operator">=</span> parent<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// path节点不能存在</span>

        nodes<span class="token punctuation">.</span><span class="token function">preChange</span><span class="token punctuation">(</span>parentName<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行removeDigest</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parentCVersion <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            parentCVersion <span class="token operator">=</span> parent<span class="token punctuation">.</span>stat<span class="token punctuation">.</span><span class="token function">getCversion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            parentCVersion<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// childVersion递增</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>parentCVersion <span class="token operator">&gt;</span> parent<span class="token punctuation">.</span>stat<span class="token punctuation">.</span><span class="token function">getCversion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            parent<span class="token punctuation">.</span>stat<span class="token punctuation">.</span><span class="token function">setCversion</span><span class="token punctuation">(</span>parentCVersion<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 父节点的childVersion</span>
            parent<span class="token punctuation">.</span>stat<span class="token punctuation">.</span><span class="token function">setPzxid</span><span class="token punctuation">(</span>zxid<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 父节点processZxid</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">DataNode</span> child <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataNode</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> acls<span class="token punctuation">,</span> stat<span class="token punctuation">)</span><span class="token punctuation">;</span>
        parent<span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>childName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 添加节点</span>
        nodes<span class="token punctuation">.</span><span class="token function">postChange</span><span class="token punctuation">(</span>parentName<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        nodeDataSize<span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span><span class="token function">getNodeSize</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> child<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 维护NodeHashMap</span>
        <span class="token class-name">EphemeralType</span> ephemeralType <span class="token operator">=</span> <span class="token class-name">EphemeralType</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ephemeralOwner<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 通常是VOID|NORMAL</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ephemeralType <span class="token operator">==</span> <span class="token class-name">EphemeralType</span><span class="token punctuation">.</span><span class="token constant">CONTAINER</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            containers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ephemeralType <span class="token operator">==</span> <span class="token class-name">EphemeralType</span><span class="token punctuation">.</span><span class="token constant">TTL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ttls<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ephemeralOwner <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 维护临时节点</span>
            <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> ephemerals<span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>ephemeralOwner<span class="token punctuation">,</span> k <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>list<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>outputStat <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            child<span class="token punctuation">.</span><span class="token function">copyStat</span><span class="token punctuation">(</span>outputStat<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 把权限保存到outputStat中</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 略</span>

    <span class="token comment">// 触发监听器</span>
    dataWatches<span class="token punctuation">.</span><span class="token function">triggerWatch</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token class-name">Event<span class="token punctuation">.</span>EventType<span class="token punctuation">.</span>NodeCreated</span><span class="token punctuation">,</span> zxid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    childWatches<span class="token punctuation">.</span><span class="token function">triggerWatch</span><span class="token punctuation">(</span>
        parentName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"/"</span> <span class="token operator">:</span> parentName<span class="token punctuation">,</span> <span class="token class-name">Event<span class="token punctuation">.</span>EventType<span class="token punctuation">.</span>NodeChildrenChanged</span><span class="token punctuation">,</span> zxid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="deleteNode_535"></a>deleteNode方法</h3> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteNode</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token keyword">long</span> zxid<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoNodeException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> lastSlash <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token char">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> parentName <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> lastSlash<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> childName <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>lastSlash <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">DataNode</span> parent <span class="token operator">=</span> nodes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>parentName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 父节点要存在</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        nodes<span class="token punctuation">.</span><span class="token function">preChange</span><span class="token punctuation">(</span>parentName<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        parent<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>childName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 移除子节点</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>zxid <span class="token operator">&gt;</span> parent<span class="token punctuation">.</span>stat<span class="token punctuation">.</span><span class="token function">getPzxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            parent<span class="token punctuation">.</span>stat<span class="token punctuation">.</span><span class="token function">setPzxid</span><span class="token punctuation">(</span>zxid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        nodes<span class="token punctuation">.</span><span class="token function">postChange</span><span class="token punctuation">(</span>parentName<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">DataNode</span> node <span class="token operator">=</span> nodes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 节点要存在</span>
    nodes<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 从NodeHashMap移除</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        aclCache<span class="token punctuation">.</span><span class="token function">removeUsage</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>acl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        nodeDataSize<span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token function">getNodeSize</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> node<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">long</span> owner <span class="token operator">=</span> node<span class="token punctuation">.</span>stat<span class="token punctuation">.</span><span class="token function">getEphemeralOwner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">EphemeralType</span> ephemeralType <span class="token operator">=</span> <span class="token class-name">EphemeralType</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ephemeralType <span class="token operator">==</span> <span class="token class-name">EphemeralType</span><span class="token punctuation">.</span><span class="token constant">CONTAINER</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            containers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ephemeralType <span class="token operator">==</span> <span class="token class-name">EphemeralType</span><span class="token punctuation">.</span><span class="token constant">TTL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ttls<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>owner <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 移除临时节点</span>
            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> nodes <span class="token operator">=</span> ephemerals<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>nodes <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>nodes<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    nodes<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 略</span>

    <span class="token comment">// 触发监听器</span>
    <span class="token class-name">WatcherOrBitSet</span> processed <span class="token operator">=</span> dataWatches<span class="token punctuation">.</span><span class="token function">triggerWatch</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token class-name">EventType<span class="token punctuation">.</span>NodeDeleted</span><span class="token punctuation">,</span> zxid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    childWatches<span class="token punctuation">.</span><span class="token function">triggerWatch</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token class-name">EventType<span class="token punctuation">.</span>NodeDeleted</span><span class="token punctuation">,</span> zxid<span class="token punctuation">,</span> processed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    childWatches<span class="token punctuation">.</span><span class="token function">triggerWatch</span><span class="token punctuation">(</span>
        <span class="token string">""</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>parentName<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"/"</span> <span class="token operator">:</span> parentName<span class="token punctuation">,</span> <span class="token class-name">EventType<span class="token punctuation">.</span>NodeChildrenChanged</span><span class="token punctuation">,</span> zxid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="setData_589"></a>setData方法</h3> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">Stat</span> <span class="token function">setData</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data<span class="token punctuation">,</span> <span class="token keyword">int</span> version<span class="token punctuation">,</span> <span class="token keyword">long</span> zxid<span class="token punctuation">,</span> <span class="token keyword">long</span> time<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoNodeException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Stat</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">DataNode</span> n <span class="token operator">=</span> nodes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 节点要存在</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> lastData<span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        lastData <span class="token operator">=</span> n<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
        nodes<span class="token punctuation">.</span><span class="token function">preChange</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
        n<span class="token punctuation">.</span>data <span class="token operator">=</span> data<span class="token punctuation">;</span> <span class="token comment">// data赋值</span>
        n<span class="token punctuation">.</span>stat<span class="token punctuation">.</span><span class="token function">setMtime</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 修改时间</span>
        n<span class="token punctuation">.</span>stat<span class="token punctuation">.</span><span class="token function">setMzxid</span><span class="token punctuation">(</span>zxid<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 修改的zxid</span>
        n<span class="token punctuation">.</span>stat<span class="token punctuation">.</span><span class="token function">setVersion</span><span class="token punctuation">(</span>version<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 版本</span>
        n<span class="token punctuation">.</span><span class="token function">copyStat</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 保存stat</span>
        nodes<span class="token punctuation">.</span><span class="token function">postChange</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 略</span>
    <span class="token comment">// 触发监听器</span>
    dataWatches<span class="token punctuation">.</span><span class="token function">triggerWatch</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token class-name">EventType<span class="token punctuation">.</span>NodeDataChanged</span><span class="token punctuation">,</span> zxid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="setAclacl_616"></a>setAcl等acl方法</h3> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">Stat</span> <span class="token function">setACL</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>ACL<span class="token punctuation">&gt;</span></span> acl<span class="token punctuation">,</span> <span class="token keyword">int</span> version<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoNodeException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">DataNode</span> n <span class="token operator">=</span> nodes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Stat</span> stat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        aclCache<span class="token punctuation">.</span><span class="token function">removeUsage</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>acl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        nodes<span class="token punctuation">.</span><span class="token function">preChange</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
        n<span class="token punctuation">.</span>stat<span class="token punctuation">.</span><span class="token function">setAversion</span><span class="token punctuation">(</span>version<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// access时间</span>
        n<span class="token punctuation">.</span>acl <span class="token operator">=</span> aclCache<span class="token punctuation">.</span><span class="token function">convertAcls</span><span class="token punctuation">(</span>acl<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置权限</span>
        n<span class="token punctuation">.</span><span class="token function">copyStat</span><span class="token punctuation">(</span>stat<span class="token punctuation">)</span><span class="token punctuation">;</span>
        nodes<span class="token punctuation">.</span><span class="token function">postChange</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> stat<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>ACL<span class="token punctuation">&gt;</span></span> <span class="token function">getACL</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token class-name">Stat</span> stat<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoNodeException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">DataNode</span> n <span class="token operator">=</span> nodes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stat <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            n<span class="token punctuation">.</span><span class="token function">copyStat</span><span class="token punctuation">(</span>stat<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>aclCache<span class="token punctuation">.</span><span class="token function">convertLong</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>acl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>ACL<span class="token punctuation">&gt;</span></span> <span class="token function">getACL</span><span class="token punctuation">(</span><span class="token class-name">DataNode</span> node<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> aclCache<span class="token punctuation">.</span><span class="token function">convertLong</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>acl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="addWatch_652"></a>addWatch方法</h3> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addWatch</span><span class="token punctuation">(</span><span class="token class-name">String</span> basePath<span class="token punctuation">,</span> <span class="token class-name">Watcher</span> watcher<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">WatcherMode</span> watcherMode <span class="token operator">=</span> <span class="token class-name">WatcherMode</span><span class="token punctuation">.</span><span class="token function">fromZooDef</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// PERSISTENT_RECURSIVE or PERSISTENT</span>
    dataWatches<span class="token punctuation">.</span><span class="token function">addWatch</span><span class="token punctuation">(</span>basePath<span class="token punctuation">,</span> watcher<span class="token punctuation">,</span> watcherMode<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 只给节点添加Watcher</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>watcherMode <span class="token operator">!=</span> <span class="token class-name">WatcherMode</span><span class="token punctuation">.</span><span class="token constant">PERSISTENT_RECURSIVE</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        childWatches<span class="token punctuation">.</span><span class="token function">addWatch</span><span class="token punctuation">(</span>basePath<span class="token punctuation">,</span> watcher<span class="token punctuation">,</span> watcherMode<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 递归添加Watcher</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="processTxn_666"></a>processTxn方法</h3> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">ProcessTxnResult</span> <span class="token function">processTxn</span><span class="token punctuation">(</span><span class="token class-name">TxnHeader</span> header<span class="token punctuation">,</span> <span class="token class-name">Record</span> txn<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isSubTxn<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">ProcessTxnResult</span> rc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProcessTxnResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        rc<span class="token punctuation">.</span>clientId <span class="token operator">=</span> header<span class="token punctuation">.</span><span class="token function">getClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rc<span class="token punctuation">.</span>cxid <span class="token operator">=</span> header<span class="token punctuation">.</span><span class="token function">getCxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rc<span class="token punctuation">.</span>zxid <span class="token operator">=</span> header<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rc<span class="token punctuation">.</span>type <span class="token operator">=</span> header<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rc<span class="token punctuation">.</span>err <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        rc<span class="token punctuation">.</span>multiResult <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>header<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> <span class="token class-name">OpCode</span><span class="token punctuation">.</span>create<span class="token operator">:</span> <span class="token comment">// 创建节点</span>
            <span class="token class-name">CreateTxn</span> createTxn <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">CreateTxn</span><span class="token punctuation">)</span> txn<span class="token punctuation">;</span>
            rc<span class="token punctuation">.</span>path <span class="token operator">=</span> createTxn<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">createNode</span><span class="token punctuation">(</span>createTxn<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> createTxn<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> createTxn<span class="token punctuation">.</span><span class="token function">getAcl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                createTxn<span class="token punctuation">.</span><span class="token function">getEphemeral</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> header<span class="token punctuation">.</span><span class="token function">getClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> createTxn<span class="token punctuation">.</span><span class="token function">getParentCVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                header<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> header<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token class-name">OpCode</span><span class="token punctuation">.</span>create2<span class="token operator">:</span> <span class="token comment">// 创建节点并保存stat</span>
            <span class="token class-name">CreateTxn</span> create2Txn <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">CreateTxn</span><span class="token punctuation">)</span> txn<span class="token punctuation">;</span>
            rc<span class="token punctuation">.</span>path <span class="token operator">=</span> create2Txn<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Stat</span> stat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">createNode</span><span class="token punctuation">(</span>create2Txn<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> create2Txn<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> create2Txn<span class="token punctuation">.</span><span class="token function">getAcl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                create2Txn<span class="token punctuation">.</span><span class="token function">getEphemeral</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> header<span class="token punctuation">.</span><span class="token function">getClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> create2Txn<span class="token punctuation">.</span><span class="token function">getParentCVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                header<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> header<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stat<span class="token punctuation">)</span><span class="token punctuation">;</span>
            rc<span class="token punctuation">.</span>stat <span class="token operator">=</span> stat<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token class-name">OpCode</span><span class="token punctuation">.</span>createTTL<span class="token operator">:</span>
            <span class="token class-name">CreateTTLTxn</span> createTtlTxn <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">CreateTTLTxn</span><span class="token punctuation">)</span> txn<span class="token punctuation">;</span>
            rc<span class="token punctuation">.</span>path <span class="token operator">=</span> createTtlTxn<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            stat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">createNode</span><span class="token punctuation">(</span>createTtlTxn<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> createTtlTxn<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> createTtlTxn<span class="token punctuation">.</span><span class="token function">getAcl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">EphemeralType</span><span class="token punctuation">.</span><span class="token constant">TTL</span><span class="token punctuation">.</span><span class="token function">toEphemeralOwner</span><span class="token punctuation">(</span>createTtlTxn<span class="token punctuation">.</span><span class="token function">getTtl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// ttl</span>
                createTtlTxn<span class="token punctuation">.</span><span class="token function">getParentCVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> header<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> header<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stat<span class="token punctuation">)</span><span class="token punctuation">;</span>
            rc<span class="token punctuation">.</span>stat <span class="token operator">=</span> stat<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token class-name">OpCode</span><span class="token punctuation">.</span>createContainer<span class="token operator">:</span>
            <span class="token class-name">CreateContainerTxn</span> createContainerTxn <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">CreateContainerTxn</span><span class="token punctuation">)</span> txn<span class="token punctuation">;</span>
            rc<span class="token punctuation">.</span>path <span class="token operator">=</span> createContainerTxn<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            stat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">createNode</span><span class="token punctuation">(</span>createContainerTxn<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> createContainerTxn<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                createContainerTxn<span class="token punctuation">.</span><span class="token function">getAcl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">EphemeralType</span><span class="token punctuation">.</span><span class="token constant">CONTAINER_EPHEMERAL_OWNER</span><span class="token punctuation">,</span>
                createContainerTxn<span class="token punctuation">.</span><span class="token function">getParentCVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> header<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> header<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stat<span class="token punctuation">)</span><span class="token punctuation">;</span>
            rc<span class="token punctuation">.</span>stat <span class="token operator">=</span> stat<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token class-name">OpCode</span><span class="token punctuation">.</span>delete<span class="token operator">:</span>
        <span class="token keyword">case</span> <span class="token class-name">OpCode</span><span class="token punctuation">.</span>deleteContainer<span class="token operator">:</span>
            <span class="token class-name">DeleteTxn</span> deleteTxn <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">DeleteTxn</span><span class="token punctuation">)</span> txn<span class="token punctuation">;</span>
            rc<span class="token punctuation">.</span>path <span class="token operator">=</span> deleteTxn<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">deleteNode</span><span class="token punctuation">(</span>deleteTxn<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> header<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 删除节点</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token class-name">OpCode</span><span class="token punctuation">.</span>reconfig<span class="token operator">:</span>
        <span class="token keyword">case</span> <span class="token class-name">OpCode</span><span class="token punctuation">.</span>setData<span class="token operator">:</span> <span class="token comment">// 设置节点数据</span>
            <span class="token class-name">SetDataTxn</span> setDataTxn <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SetDataTxn</span><span class="token punctuation">)</span> txn<span class="token punctuation">;</span>
            rc<span class="token punctuation">.</span>path <span class="token operator">=</span> setDataTxn<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            rc<span class="token punctuation">.</span>stat <span class="token operator">=</span> <span class="token function">setData</span><span class="token punctuation">(</span>setDataTxn<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> setDataTxn<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> setDataTxn<span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                header<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> header<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token class-name">OpCode</span><span class="token punctuation">.</span>setACL<span class="token operator">:</span> <span class="token comment">// 设置ACL</span>
            <span class="token class-name">SetACLTxn</span> setACLTxn <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SetACLTxn</span><span class="token punctuation">)</span> txn<span class="token punctuation">;</span>
            rc<span class="token punctuation">.</span>path <span class="token operator">=</span> setACLTxn<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            rc<span class="token punctuation">.</span>stat <span class="token operator">=</span> <span class="token function">setACL</span><span class="token punctuation">(</span>setACLTxn<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> setACLTxn<span class="token punctuation">.</span><span class="token function">getAcl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> setACLTxn<span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token class-name">OpCode</span><span class="token punctuation">.</span>closeSession<span class="token operator">:</span> <span class="token comment">// 关闭session</span>
            <span class="token keyword">long</span> sessionId <span class="token operator">=</span> header<span class="token punctuation">.</span><span class="token function">getClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>txn <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">killSession</span><span class="token punctuation">(</span>sessionId<span class="token punctuation">,</span> header<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ephemerals<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>sessionId<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">CloseSessionTxn</span><span class="token punctuation">)</span> txn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPaths2Delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">killSession</span><span class="token punctuation">(</span>sessionId<span class="token punctuation">,</span> header<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token class-name">OpCode</span><span class="token punctuation">.</span>error<span class="token operator">:</span>
            <span class="token class-name">ErrorTxn</span> errTxn <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ErrorTxn</span><span class="token punctuation">)</span> txn<span class="token punctuation">;</span>
            rc<span class="token punctuation">.</span>err <span class="token operator">=</span> errTxn<span class="token punctuation">.</span><span class="token function">getErr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token class-name">OpCode</span><span class="token punctuation">.</span>check<span class="token operator">:</span>
            <span class="token class-name">CheckVersionTxn</span> checkTxn <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">CheckVersionTxn</span><span class="token punctuation">)</span> txn<span class="token punctuation">;</span>
            rc<span class="token punctuation">.</span>path <span class="token operator">=</span> checkTxn<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token class-name">OpCode</span><span class="token punctuation">.</span>multi<span class="token operator">:</span>
            <span class="token comment">// 遍历处理每一个Txn</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">KeeperException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        rc<span class="token punctuation">.</span>err <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

    <span class="token comment">//</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>header<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">OpCode</span><span class="token punctuation">.</span>create <span class="token operator">&amp;&amp;</span> rc<span class="token punctuation">.</span>err <span class="token operator">==</span> <span class="token class-name">Code</span><span class="token punctuation">.</span><span class="token constant">NODEEXISTS</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> lastSlash <span class="token operator">=</span> rc<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token char">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> parentName <span class="token operator">=</span> rc<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> lastSlash<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CreateTxn</span> cTxn <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">CreateTxn</span><span class="token punctuation">)</span> txn<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">setCversionPzxid</span><span class="token punctuation">(</span>parentName<span class="token punctuation">,</span> cTxn<span class="token punctuation">.</span><span class="token function">getParentCVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> header<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoNodeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            rc<span class="token punctuation">.</span>err <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isSubTxn<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rc<span class="token punctuation">.</span>zxid <span class="token operator">&gt;</span> lastProcessedZxid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            lastProcessedZxid <span class="token operator">=</span> rc<span class="token punctuation">.</span>zxid<span class="token punctuation">;</span> <span class="token comment">// 设置最新lastProcessedZxid</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 略</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> rc<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="serialize_783"></a>serialize相关方法</h3> 
<pre><code class="prism language-java"><span class="token keyword">void</span> <span class="token function">serializeNode</span><span class="token punctuation">(</span><span class="token class-name">OutputArchive</span> oa<span class="token punctuation">,</span> <span class="token class-name">StringBuilder</span> path<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> pathString <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">DataNode</span> node <span class="token operator">=</span> <span class="token function">getNode</span><span class="token punctuation">(</span>pathString<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 查找节点</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> children<span class="token punctuation">;</span>
    <span class="token class-name">DataNode</span> nodeCopy<span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">StatPersisted</span> statCopy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StatPersisted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">copyStatPersisted</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>stat<span class="token punctuation">,</span> statCopy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// we do not need to make a copy of node.data because the contents are never changed</span>
        nodeCopy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataNode</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>data<span class="token punctuation">,</span> node<span class="token punctuation">.</span>acl<span class="token punctuation">,</span> statCopy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        children <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">serializeNodeData</span><span class="token punctuation">(</span>oa<span class="token punctuation">,</span> pathString<span class="token punctuation">,</span> nodeCopy<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 把节点写入到oa中</span>
    path<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token char">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> off <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 遍历子节点，将子节点写入oa中</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> child <span class="token operator">:</span> children<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        path<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>off<span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        path<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">serializeNode</span><span class="token punctuation">(</span>oa<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// visible for test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">serializeNodeData</span><span class="token punctuation">(</span><span class="token class-name">OutputArchive</span> oa<span class="token punctuation">,</span> <span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token class-name">DataNode</span> node<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    oa<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    oa<span class="token punctuation">.</span><span class="token function">writeRecord</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"node"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">serializeAcls</span><span class="token punctuation">(</span><span class="token class-name">OutputArchive</span> oa<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    aclCache<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>oa<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 序列化整个NodeHashMap对象</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">serializeNodes</span><span class="token punctuation">(</span><span class="token class-name">OutputArchive</span> oa<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">serializeNode</span><span class="token punctuation">(</span>oa<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// / marks end of stream</span>
    <span class="token comment">// we need to check if clear had been called in between the snapshot.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        oa<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 完整序列化</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token class-name">OutputArchive</span> oa<span class="token punctuation">,</span> <span class="token class-name">String</span> tag<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">serializeAcls</span><span class="token punctuation">(</span>oa<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">serializeNodes</span><span class="token punctuation">(</span>oa<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="deserialize_838"></a>deserialize相关方法</h3> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deserialize</span><span class="token punctuation">(</span><span class="token class-name">InputArchive</span> ia<span class="token punctuation">,</span> <span class="token class-name">String</span> tag<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    aclCache<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>ia<span class="token punctuation">)</span><span class="token punctuation">;</span>
    nodes<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pTrie<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nodeDataSize<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> path <span class="token operator">=</span> ia<span class="token punctuation">.</span><span class="token function">readString</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">"/"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">DataNode</span> node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ia<span class="token punctuation">.</span><span class="token function">readRecord</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"node"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            aclCache<span class="token punctuation">.</span><span class="token function">addUsage</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>acl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">int</span> lastSlash <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token char">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lastSlash <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            root <span class="token operator">=</span> node<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">String</span> parentPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> lastSlash<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">DataNode</span> parent <span class="token operator">=</span> nodes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>parentPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span>
                        <span class="token string">"Invalid Datatree, unable to find parent "</span> <span class="token operator">+</span> parentPath <span class="token operator">+</span> <span class="token string">" of path "</span> <span class="token operator">+</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            parent<span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>lastSlash <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> owner <span class="token operator">=</span> node<span class="token punctuation">.</span>stat<span class="token punctuation">.</span><span class="token function">getEphemeralOwner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">EphemeralType</span> ephemeralType <span class="token operator">=</span> <span class="token class-name">EphemeralType</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ephemeralType <span class="token operator">==</span> <span class="token class-name">EphemeralType</span><span class="token punctuation">.</span><span class="token constant">CONTAINER</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                containers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ephemeralType <span class="token operator">==</span> <span class="token class-name">EphemeralType</span><span class="token punctuation">.</span><span class="token constant">TTL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                ttls<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>owner <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> ephemerals<span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> k <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        path <span class="token operator">=</span> ia<span class="token punctuation">.</span><span class="token function">readString</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// have counted digest for root node with "", ignore here to avoid counting twice for root node</span>
    nodes<span class="token punctuation">.</span><span class="token function">putWithoutDigest</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>

    nodeDataSize<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token function">approximateDataSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// we are done with deserializing the datatree update the quotas - create path trie</span>
    <span class="token comment">// and also update the stat nodes</span>
    <span class="token function">setupQuota</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    aclCache<span class="token punctuation">.</span><span class="token function">purgeUnused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="FileTxnSnapLog_893"></a>FileTxnSnapLog</h2> 
<p>操作TxnLog和SnapShot的入口类。</p> 
<p>构造方法会创建dataDir和snapDir目录，判断数据目录可写，创建txnLog和snapLog对象访问数据文件。</p> 
<h3><a id="_901"></a>主要方法</h3> 
<pre><code class="prism language-java"><span class="token comment">// 从snapshots和transaction logs加载数据库</span>
<span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">restore</span><span class="token punctuation">(</span><span class="token class-name">DataTree</span> dt<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> sessions<span class="token punctuation">,</span> <span class="token class-name">PlayBackListener</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// fast forward the server database to have the latest transactions in it</span>
<span class="token comment">// This is the same as restore, but only reads from the transaction logs and not restores from a snapshot</span>
<span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">fastForwardFromEdits</span><span class="token punctuation">(</span><span class="token class-name">DataTree</span> dt<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> sessions<span class="token punctuation">,</span> <span class="token class-name">PlayBackListener</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 使用txnLog.read(zxid, fastForward)方法从指定zxid加载TxnIterator</span>
<span class="token keyword">public</span> <span class="token class-name">TxnIterator</span> <span class="token function">readTxnLog</span><span class="token punctuation">(</span><span class="token keyword">long</span> zxid<span class="token punctuation">,</span> <span class="token keyword">boolean</span> fastForward<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// process the transaction on the datatree</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processTransaction</span><span class="token punctuation">(</span><span class="token class-name">TxnHeader</span> hdr<span class="token punctuation">,</span> <span class="token class-name">DataTree</span> dt<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> sessions<span class="token punctuation">,</span> <span class="token class-name">Record</span> txn<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 使用txnLog.getLastLoggedZxid()方法获取last logged zxid</span>
<span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getLastLoggedZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 把datatree和sessions保存到snapshot中</span>
<span class="token keyword">public</span> <span class="token class-name">File</span> <span class="token function">save</span><span class="token punctuation">(</span>
    <span class="token class-name">DataTree</span> dataTree<span class="token punctuation">,</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> sessionsWithTimeouts<span class="token punctuation">,</span> <span class="token keyword">boolean</span> syncSnap<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 把txnLog truncate到指定的zxid</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">truncateLog</span><span class="token punctuation">(</span><span class="token keyword">long</span> zxid<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 使用snaplog.findMostRecentSnapshot()方法加载最近snapshot文件</span>
<span class="token keyword">public</span> <span class="token class-name">File</span> <span class="token function">findMostRecentSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 使用snaplog.findNRecentSnapshots(n)方法加载n个最近snapshot文件</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">File</span><span class="token punctuation">&gt;</span></span> <span class="token function">findNRecentSnapshots</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 使用snaplog.findNValidSnapshots(n)方法加载n个合法snapshot文件</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">File</span><span class="token punctuation">&gt;</span></span> <span class="token function">findNValidSnapshots</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 获取快照文件，可能包含比给定zxid更新的事务。</span>
<span class="token comment">// 包括起始zxid大于给定zxid的日志，以及起始zxid小于给定zxid的最新事务日志。</span>
<span class="token comment">// 后一个日志文件可能包含超出给定zxid的事务。</span>
<span class="token keyword">public</span> <span class="token class-name">File</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getSnapshotLogs</span><span class="token punctuation">(</span><span class="token keyword">long</span> zxid<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 使用txnLog.append(si)追加数据</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">Request</span> si<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// txnLog.commit()提交数据</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="restore_947"></a>restore方法</h3> 
<ol><li>从snapshot加载dataTree数据</li><li>从txnlog加载dataTree和committedlog数据</li><li>如果没有加载到dataTree数据，将空的dataTree数据保存到snapshot.0文件中</li></ol> 
<h3><a id="fastForwardFromEdits_955"></a>fastForwardFromEdits方法</h3> 
<p>从txnlog加载dataTree和committedlog数据。</p> 
<h3><a id="processTransaction_961"></a>processTransaction方法</h3> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processTransaction</span><span class="token punctuation">(</span><span class="token class-name">TxnHeader</span> hdr<span class="token punctuation">,</span> <span class="token class-name">DataTree</span> dt<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> sessions<span class="token punctuation">,</span>
        <span class="token class-name">Record</span> txn<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">KeeperException<span class="token punctuation">.</span>NoNodeException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">ProcessTxnResult</span> rc<span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>hdr<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">case</span> <span class="token class-name">OpCode</span><span class="token punctuation">.</span>createSession<span class="token operator">:</span>
        sessions<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>hdr<span class="token punctuation">.</span><span class="token function">getClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">CreateSessionTxn</span><span class="token punctuation">)</span> txn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTimeOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// give dataTree a chance to sync its lastProcessedZxid</span>
        rc <span class="token operator">=</span> dt<span class="token punctuation">.</span><span class="token function">processTxn</span><span class="token punctuation">(</span>hdr<span class="token punctuation">,</span> txn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token class-name">OpCode</span><span class="token punctuation">.</span>closeSession<span class="token operator">:</span>
        sessions<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>hdr<span class="token punctuation">.</span><span class="token function">getClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rc <span class="token operator">=</span> dt<span class="token punctuation">.</span><span class="token function">processTxn</span><span class="token punctuation">(</span>hdr<span class="token punctuation">,</span> txn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
        rc <span class="token operator">=</span> dt<span class="token punctuation">.</span><span class="token function">processTxn</span><span class="token punctuation">(</span>hdr<span class="token punctuation">,</span> txn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="save_985"></a>save方法</h3> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">File</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token class-name">DataTree</span> dataTree<span class="token punctuation">,</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> sessionsWithTimeouts<span class="token punctuation">,</span>
        <span class="token keyword">boolean</span> syncSnap<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">long</span> lastZxid <span class="token operator">=</span> dataTree<span class="token punctuation">.</span>lastProcessedZxid<span class="token punctuation">;</span>
    <span class="token comment">// 文件名snapshot.${lastZxid}</span>
    <span class="token class-name">File</span> snapshotFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>snapDir<span class="token punctuation">,</span> <span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token function">makeSnapshotName</span><span class="token punctuation">(</span>lastZxid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        snapLog<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>dataTree<span class="token punctuation">,</span> sessionsWithTimeouts<span class="token punctuation">,</span> snapshotFile<span class="token punctuation">,</span> syncSnap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> snapshotFile<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="truncateLog_1004"></a>truncateLog方法</h3> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">truncateLog</span><span class="token punctuation">(</span><span class="token keyword">long</span> zxid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// close the existing txnLog and snapLog</span>
        <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// truncate it</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">FileTxnLog</span> truncLog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileTxnLog</span><span class="token punctuation">(</span>dataDir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">boolean</span> truncated <span class="token operator">=</span> truncLog<span class="token punctuation">.</span><span class="token function">truncate</span><span class="token punctuation">(</span>zxid<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// re-open the txnLog and snapLog</span>
            <span class="token comment">// I'd rather just close/reopen this object itself, however that</span>
            <span class="token comment">// would have a big impact outside ZKDatabase as there are other</span>
            <span class="token comment">// objects holding a reference to this object.</span>
            txnLog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileTxnLog</span><span class="token punctuation">(</span>dataDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
            snapLog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileSnap</span><span class="token punctuation">(</span>snapDir<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> truncated<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="TxnLogFileTxnLog_1033"></a>TxnLog接口和FileTxnLog实现类</h3> 
<h4><a id="txnlog_1035"></a>txnlog</h4> 
<p>使用文件保存所有的事务操作，客户端的写操作会先写入txnlog文件，在follower达到quorum状态后提交到dataTree中，在ZKDatabase启动阶段，如果txnlog的zxid大于snapshot的zxid时，会加载txnlog文件数据回放事务，提交到dataTree中。</p> 
<h4><a id="TxnLog_1041"></a>TxnLog接口</h4> 
<p>Interface for reading transaction logs.</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">TxnLog</span> <span class="token keyword">extends</span> <span class="token class-name">Closeable</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// Setter for ServerStats to monitor fsync threshold exceed</span>
    <span class="token keyword">void</span> <span class="token function">setServerStats</span><span class="token punctuation">(</span><span class="token class-name">ServerStats</span> serverStats<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// roll the current log being appended to</span>
    <span class="token keyword">void</span> <span class="token function">rollLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>

    <span class="token comment">// Append a request to the transaction log with a digset</span>
    <span class="token keyword">boolean</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">Request</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>

    <span class="token comment">// Start reading the transaction logs from a given zxid</span>
    <span class="token class-name">TxnIterator</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">long</span> zxid<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>

    <span class="token comment">// the last zxid of the logged transactions</span>
    <span class="token keyword">long</span> <span class="token function">getLastLoggedZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>

    <span class="token comment">// truncate the log to get in sync with the leader</span>
    <span class="token keyword">boolean</span> <span class="token function">truncate</span><span class="token punctuation">(</span><span class="token keyword">long</span> zxid<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>

    <span class="token comment">// the dbid for this transaction log</span>
    <span class="token keyword">long</span> <span class="token function">getDbId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>

    <span class="token comment">// commit the transaction and make sure they are persisted</span>
    <span class="token keyword">void</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>

    <span class="token comment">// return transaction log's elapsed sync time in milliseconds</span>
    <span class="token keyword">long</span> <span class="token function">getTxnLogSyncElapsedTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">setTotalLogSize</span><span class="token punctuation">(</span><span class="token keyword">long</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> <span class="token function">getTotalLogSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="FileTxnLog_1083"></a>FileTxnLog实现类</h4> 
<pre><code>This class implements the TxnLog interface. It provides api's to access the txnlogs and add entries to it.
The format of a Transactional log is as follows:

   LogFile:
       FileHeader TxnList ZeroPad

   FileHeader: {
       magic 4bytes (ZKLG)
       version 4bytes
       dbid 8bytes
   }

   TxnList:
       Txn || Txn TxnList

   Txn:
       checksum Txnlen TxnHeader Record 0x42

   checksum: 8bytes Adler32 is currently used
     calculated across payload -- Txnlen, TxnHeader, Record and 0x42

   Txnlen:
       len 4bytes

   TxnHeader: {
       sessionid 8bytes
       cxid 4bytes
       zxid 8bytes
       time 8bytes
       type 4bytes
   }

   Record:
       See Jute definition file for details on the various record types

   ZeroPad:
       0 padded to EOF (filled during preallocation stage)
</code></pre> 
<h4><a id="FileTxnLog_1127"></a>FileTxnLog主要方法实现</h4> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">boolean</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">Request</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">TxnHeader</span> hdr <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHdr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hdr <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 不是事务请求</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hdr<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> lastZxidSeen<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        lastZxidSeen <span class="token operator">=</span> hdr<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>logStream <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 创建新log.${hdr.zxid}文件</span>
        logFileWrite <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>logDir<span class="token punctuation">,</span> <span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token function">makeLogName</span><span class="token punctuation">(</span>hdr<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>logFileWrite<span class="token punctuation">)</span><span class="token punctuation">;</span>
        logStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedOutputStream</span><span class="token punctuation">(</span>fos<span class="token punctuation">)</span><span class="token punctuation">;</span>
        oa <span class="token operator">=</span> <span class="token class-name">BinaryOutputArchive</span><span class="token punctuation">.</span><span class="token function">getArchive</span><span class="token punctuation">(</span>logStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FileHeader</span> fhdr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileHeader</span><span class="token punctuation">(</span><span class="token constant">TXNLOG_MAGIC</span><span class="token punctuation">,</span> <span class="token constant">VERSION</span><span class="token punctuation">,</span> dbId<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 文件头</span>
        <span class="token keyword">long</span> dataSize <span class="token operator">=</span> oa<span class="token punctuation">.</span><span class="token function">getDataSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fhdr<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>oa<span class="token punctuation">,</span> <span class="token string">"fileheader"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 写文件头</span>
        logStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 文件偏移量</span>
        filePosition <span class="token operator">+=</span> oa<span class="token punctuation">.</span><span class="token function">getDataSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> dataSize<span class="token punctuation">;</span>
        filePadding<span class="token punctuation">.</span><span class="token function">setCurrentSize</span><span class="token punctuation">(</span>filePosition<span class="token punctuation">)</span><span class="token punctuation">;</span>
        streamsToFlush<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>fos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    fileSize <span class="token operator">=</span> filePadding<span class="token punctuation">.</span><span class="token function">padFile</span><span class="token punctuation">(</span>fos<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> filePosition<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buf <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSerializeData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> dataSize <span class="token operator">=</span> oa<span class="token punctuation">.</span><span class="token function">getDataSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Checksum</span> crc <span class="token operator">=</span> <span class="token function">makeChecksumAlgorithm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    crc<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    oa<span class="token punctuation">.</span><span class="token function">writeLong</span><span class="token punctuation">(</span>crc<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"txnEntryCRC"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// checksum</span>
    <span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token function">writeTxnBytes</span><span class="token punctuation">(</span>oa<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 写len, hdr, txn, digest, 0x42</span>
    unFlushedSize <span class="token operator">+=</span> oa<span class="token punctuation">.</span><span class="token function">getDataSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> dataSize<span class="token punctuation">;</span> <span class="token comment">// 计算未flush字节数</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getLastLoggedZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">File</span><span class="token punctuation">[</span><span class="token punctuation">]</span> files <span class="token operator">=</span> <span class="token function">getLogFiles</span><span class="token punctuation">(</span>logDir<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> maxLog <span class="token operator">=</span> files<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span>
        <span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token function">getZxidFromName</span><span class="token punctuation">(</span>files<span class="token punctuation">[</span>files<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">LOG_FILE_PREFIX</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">// 最新的log文件的后缀作为zxid</span>
    <span class="token keyword">long</span> zxid <span class="token operator">=</span> maxLog<span class="token punctuation">;</span>
    <span class="token comment">// 从文件解析最新zxid</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">FileTxnLog</span> txn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileTxnLog</span><span class="token punctuation">(</span>logDir<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token class-name">TxnIterator</span> itr <span class="token operator">=</span> txn<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>maxLog<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>itr<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">TxnHeader</span> hdr <span class="token operator">=</span> itr<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            zxid <span class="token operator">=</span> hdr<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> zxid<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">rollLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>logStream <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>logStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 把当前文件刷写出去</span>
        prevLogsRunningTotal <span class="token operator">+=</span> <span class="token function">getCurrentLogSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>logStream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 重置相关变量，后续append时会创建新的文件</span>
        oa <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        fileSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        filePosition <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        unFlushedSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>logStream <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        logStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 刷写文件</span>
        filePosition <span class="token operator">+=</span> unFlushedSize<span class="token punctuation">;</span>
        <span class="token comment">// If we have written more than we have previously preallocated,</span>
        <span class="token comment">// we should override the fileSize by filePosition.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>filePosition <span class="token operator">&gt;</span> fileSize<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            fileSize <span class="token operator">=</span> filePosition<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        unFlushedSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">FileOutputStream</span> log <span class="token operator">:</span> streamsToFlush<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 刷写文件</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>forceSync<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">long</span> startSyncNS <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">FileChannel</span> channel <span class="token operator">=</span> log<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            channel<span class="token punctuation">.</span><span class="token function">force</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 略</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 关闭文件流</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>streamsToFlush<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        streamsToFlush<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Roll the log file if we exceed the size limit</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>txnLogSizeLimit <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 默认-1分支进不来</span>
        <span class="token keyword">long</span> logSize <span class="token operator">=</span> <span class="token function">getCurrentLogSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>logSize <span class="token operator">&gt;</span> txnLogSizeLimit<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">rollLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// FileTxnIterator封装logFile和输入流对象，可以按照协议从文件流读取txnLog数据</span>
<span class="token keyword">public</span> <span class="token class-name">TxnIterator</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">long</span> zxid<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">read</span><span class="token punctuation">(</span>zxid<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token class-name">TxnIterator</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">long</span> zxid<span class="token punctuation">,</span> <span class="token keyword">boolean</span> fastForward<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FileTxnIterator</span><span class="token punctuation">(</span>logDir<span class="token punctuation">,</span> zxid<span class="token punctuation">,</span> fastForward<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 将log文件truncate到指定zxid位置</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">truncate</span><span class="token punctuation">(</span><span class="token keyword">long</span> zxid<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">FileTxnIterator</span> itr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileTxnIterator</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logDir<span class="token punctuation">,</span> zxid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">PositionInputStream</span> input <span class="token operator">=</span> itr<span class="token punctuation">.</span>inputStream<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>input <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"No log files found to truncate"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">long</span> pos <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// now, truncate at the current position</span>
        <span class="token class-name">RandomAccessFile</span> raf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">(</span>itr<span class="token punctuation">.</span>logFile<span class="token punctuation">,</span> <span class="token string">"rw"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        raf<span class="token punctuation">.</span><span class="token function">setLength</span><span class="token punctuation">(</span>pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
        raf<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 把最小的文件truncate到指定zxid位置</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>itr<span class="token punctuation">.</span><span class="token function">goToNextLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 删除所有&gt;zxid的log文件</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>itr<span class="token punctuation">.</span>logFile<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">FileHeader</span> <span class="token function">readHeader</span><span class="token punctuation">(</span><span class="token class-name">File</span> file<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">InputStream</span> is <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        is <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">InputArchive</span> ia <span class="token operator">=</span> <span class="token class-name">BinaryInputArchive</span><span class="token punctuation">.</span><span class="token function">getArchive</span><span class="token punctuation">(</span>is<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FileHeader</span> hdr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hdr<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>ia<span class="token punctuation">,</span> <span class="token string">"fileheader"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 反序列化</span>
        <span class="token keyword">return</span> hdr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// is.close();</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="FileTxnIterator_1278"></a>FileTxnIterator类</h4> 
<p>this class implements the txnlog iterator interface which is used for reading the transaction logs.</p> 
<p>内部使用List保存着比指定zxid大或者含有指定zxid数据的log文件，初始化阶段会定位到参数zxid指定的位置，这样在后续访问时就可以从参数指定的zxid开始读取数据了。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">FileTxnIterator</span><span class="token punctuation">(</span><span class="token class-name">File</span> logDir<span class="token punctuation">,</span> <span class="token keyword">long</span> zxid<span class="token punctuation">,</span> <span class="token keyword">boolean</span> fastForward<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>logDir <span class="token operator">=</span> logDir<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>zxid <span class="token operator">=</span> zxid<span class="token punctuation">;</span>
    <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>fastForward <span class="token operator">&amp;&amp;</span> hdr <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>hdr<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> zxid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 这里将数据移动到zxid位置</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    storedFiles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 倒序查找log文件</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">File</span><span class="token punctuation">&gt;</span></span> files <span class="token operator">=</span> <span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token function">sortDataDir</span><span class="token punctuation">(</span>
        <span class="token class-name">FileTxnLog</span><span class="token punctuation">.</span><span class="token function">getLogFiles</span><span class="token punctuation">(</span>logDir<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token constant">LOG_FILE_PREFIX</span><span class="token punctuation">,</span>
        <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">File</span> f <span class="token operator">:</span> files<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token function">getZxidFromName</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">LOG_FILE_PREFIX</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> zxid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            storedFiles<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token function">getZxidFromName</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">LOG_FILE_PREFIX</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> zxid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// add the last logfile that is less than the zxid</span>
            storedFiles<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">goToNextLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 定位到下一个文件</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 定位到下一个log数据</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="SnapShotFileSnap_1326"></a>SnapShot接口和FileSnap实现类</h3> 
<h4><a id="SnapShot_1328"></a>SnapShot接口</h4> 
<p>snapshot interface for the persistence layer. implement this interface for implementing snapshots.</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SnapShot</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// deserialize a data tree from the last valid snapshot and return the last zxid that was deserialized</span>
    <span class="token keyword">long</span> <span class="token function">deserialize</span><span class="token punctuation">(</span><span class="token class-name">DataTree</span> dt<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> sessions<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>

    <span class="token comment">// persist the datatree and the sessions into a persistence storage</span>
    <span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token class-name">DataTree</span> dt<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> sessions<span class="token punctuation">,</span> <span class="token class-name">File</span> name<span class="token punctuation">,</span> <span class="token keyword">boolean</span> fsync<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>

    <span class="token comment">// find the most recent snapshot file</span>
    <span class="token class-name">File</span> <span class="token function">findMostRecentSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>

    <span class="token comment">// get information of the last saved/restored snapshot</span>
    <span class="token class-name">SnapshotInfo</span> <span class="token function">getLastSnapshotInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// free resources from this snapshot immediately</span>
    <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="FileSnap_1354"></a>FileSnap实现类</h4> 
<p>负责存储、序列化和反序列化正确的快照。并提供对快照的访问：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">deserialize</span><span class="token punctuation">(</span><span class="token class-name">DataTree</span> dt<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> sessions<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 在snapDir下查找合法的快照文件，倒序，所以最新的在前面</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">File</span><span class="token punctuation">&gt;</span></span> snapList <span class="token operator">=</span> <span class="token function">findNValidSnapshots</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">File</span> snap <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> snapZxid <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> foundValid <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> snapListSize <span class="token operator">=</span> snapList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> snapListSize<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        snap <span class="token operator">=</span> snapList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        snapZxid <span class="token operator">=</span> <span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token function">getZxidFromName</span><span class="token punctuation">(</span>snap<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">SNAPSHOT_FILE_PREFIX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">CheckedInputStream</span> snapIS <span class="token operator">=</span> <span class="token class-name">SnapStream</span><span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span>snap<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">InputArchive</span> ia <span class="token operator">=</span> <span class="token class-name">BinaryInputArchive</span><span class="token punctuation">.</span><span class="token function">getArchive</span><span class="token punctuation">(</span>snapIS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">deserialize</span><span class="token punctuation">(</span>dt<span class="token punctuation">,</span> sessions<span class="token punctuation">,</span> ia<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将数据反序列到dt</span>
            <span class="token class-name">SnapStream</span><span class="token punctuation">.</span><span class="token function">checkSealIntegrity</span><span class="token punctuation">(</span>snapIS<span class="token punctuation">,</span> ia<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Deserializing the zxid digest from the input</span>
            <span class="token comment">// stream and update the digestFromLoadedSnapshot.</span>
            <span class="token comment">// 格式: zxid digestVersion digest</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dt<span class="token punctuation">.</span><span class="token function">deserializeZxidDigest</span><span class="token punctuation">(</span>ia<span class="token punctuation">,</span> snapZxid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">SnapStream</span><span class="token punctuation">.</span><span class="token function">checkSealIntegrity</span><span class="token punctuation">(</span>snapIS<span class="token punctuation">,</span> ia<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// deserialize lastProcessedZxid and check inconsistency</span>
            <span class="token comment">// 读lastZxid字段得到</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dt<span class="token punctuation">.</span><span class="token function">deserializeLastProcessedZxid</span><span class="token punctuation">(</span>ia<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">SnapStream</span><span class="token punctuation">.</span><span class="token function">checkSealIntegrity</span><span class="token punctuation">(</span>snapIS<span class="token punctuation">,</span> ia<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            foundValid <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 验证foundValid</span>
    <span class="token comment">// 上次处理到的zxid</span>
    dt<span class="token punctuation">.</span>lastProcessedZxid <span class="token operator">=</span> snapZxid<span class="token punctuation">;</span>
    lastSnapshotInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SnapshotInfo</span><span class="token punctuation">(</span>dt<span class="token punctuation">.</span>lastProcessedZxid<span class="token punctuation">,</span> snap<span class="token punctuation">.</span><span class="token function">lastModified</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// compare the digest if this is not a fuzzy snapshot, we want to compare and find inconsistent asap</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dt<span class="token punctuation">.</span><span class="token function">getDigestFromLoadedSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        dt<span class="token punctuation">.</span><span class="token function">compareSnapshotDigests</span><span class="token punctuation">(</span>dt<span class="token punctuation">.</span>lastProcessedZxid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> dt<span class="token punctuation">.</span>lastProcessedZxid<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">deserialize</span><span class="token punctuation">(</span>
        <span class="token class-name">DataTree</span> dt<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> sessions<span class="token punctuation">,</span> <span class="token class-name">InputArchive</span> ia<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">FileHeader</span> header <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// magic, version, dbid</span>
    header<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>ia<span class="token punctuation">,</span> <span class="token string">"fileheader"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解析文件头并验证magic</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>header<span class="token punctuation">.</span><span class="token function">getMagic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">SNAP_MAGIC</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"mismatching magic headers"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 反序列化</span>
    <span class="token comment">// 会话:</span>
    <span class="token comment">//   Count Session(s)</span>
    <span class="token comment">//   Session {id, timeout}</span>
    <span class="token comment">// 节点:</span>
    <span class="token comment">//   AclCache PathNode(s)</span>
    <span class="token comment">//   PathNode {path, node}</span>
    <span class="token comment">//   node {data, acl, stat}</span>
    <span class="token class-name">SerializeUtils</span><span class="token punctuation">.</span><span class="token function">deserializeSnapshot</span><span class="token punctuation">(</span>dt<span class="token punctuation">,</span> ia<span class="token punctuation">,</span> sessions<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">protected</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">File</span><span class="token punctuation">&gt;</span></span> <span class="token function">findNValidSnapshots</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 在snapDir下查找快照文件，倒序，最新的在前面</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">File</span><span class="token punctuation">&gt;</span></span> files <span class="token operator">=</span> <span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token function">sortDataDir</span><span class="token punctuation">(</span>snapDir<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">SNAPSHOT_FILE_PREFIX</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">File</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">File</span> f <span class="token operator">:</span> files<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">SnapStream</span><span class="token punctuation">.</span><span class="token function">isValidSnapshot</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 验证文件合法</span>
                list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
                count<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> n<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> list<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">File</span><span class="token punctuation">&gt;</span></span> <span class="token function">findNRecentSnapshots</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 在snapDir下查找快照文件，倒序，最新的在前面</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">File</span><span class="token punctuation">&gt;</span></span> files <span class="token operator">=</span> <span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token function">sortDataDir</span><span class="token punctuation">(</span>snapDir<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">SNAPSHOT_FILE_PREFIX</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">File</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">File</span> f <span class="token operator">:</span> files<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> n<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token function">getZxidFromName</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">SNAPSHOT_FILE_PREFIX</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            count<span class="token operator">++</span><span class="token punctuation">;</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> list<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span>
        <span class="token class-name">DataTree</span> dt<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> sessions<span class="token punctuation">,</span> <span class="token class-name">OutputArchive</span> oa<span class="token punctuation">,</span> <span class="token class-name">FileHeader</span> header<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 验证header!=null</span>
    header<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>oa<span class="token punctuation">,</span> <span class="token string">"fileheader"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 序列化文件头</span>
    <span class="token class-name">SerializeUtils</span><span class="token punctuation">.</span><span class="token function">serializeSnapshot</span><span class="token punctuation">(</span>dt<span class="token punctuation">,</span> oa<span class="token punctuation">,</span> sessions<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 序列化dataTree</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span>
        <span class="token class-name">DataTree</span> dt<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> sessions<span class="token punctuation">,</span> <span class="token class-name">File</span> snapShot<span class="token punctuation">,</span> <span class="token keyword">boolean</span> fsync<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>close<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">CheckedOutputStream</span> snapOS <span class="token operator">=</span> <span class="token class-name">SnapStream</span><span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span>snapShot<span class="token punctuation">,</span> fsync<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">OutputArchive</span> oa <span class="token operator">=</span> <span class="token class-name">BinaryOutputArchive</span><span class="token punctuation">.</span><span class="token function">getArchive</span><span class="token punctuation">(</span>snapOS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">FileHeader</span> header <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileHeader</span><span class="token punctuation">(</span><span class="token constant">SNAP_MAGIC</span><span class="token punctuation">,</span> <span class="token constant">VERSION</span><span class="token punctuation">,</span> dbId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">serialize</span><span class="token punctuation">(</span>dt<span class="token punctuation">,</span> sessions<span class="token punctuation">,</span> oa<span class="token punctuation">,</span> header<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">SnapStream</span><span class="token punctuation">.</span><span class="token function">sealStream</span><span class="token punctuation">(</span>snapOS<span class="token punctuation">,</span> oa<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 序列化digest</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dt<span class="token punctuation">.</span><span class="token function">serializeZxidDigest</span><span class="token punctuation">(</span>oa<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">SnapStream</span><span class="token punctuation">.</span><span class="token function">sealStream</span><span class="token punctuation">(</span>snapOS<span class="token punctuation">,</span> oa<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 序列化lastProcessZxid</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dt<span class="token punctuation">.</span><span class="token function">serializeLastProcessedZxid</span><span class="token punctuation">(</span>oa<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">SnapStream</span><span class="token punctuation">.</span><span class="token function">sealStream</span><span class="token punctuation">(</span>snapOS<span class="token punctuation">,</span> oa<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            lastSnapshotInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SnapshotInfo</span><span class="token punctuation">(</span>
                <span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token function">getZxidFromName</span><span class="token punctuation">(</span>snapShot<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">SNAPSHOT_FILE_PREFIX</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                snapShot<span class="token punctuation">.</span><span class="token function">lastModified</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"FileSnap has already been closed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="DatadirCleanupManager_1494"></a>DatadirCleanupManager</h2> 
<h3><a id="_1496"></a>启动周期任务</h3> 
<p>清理过期文件，保留最新的snapRetainCount个snapshot文件和对应的txnlog文件，将其余过期的文件删除掉。</p> 
<p>purgeInterval参数指定执行周期(小时)，默认0不开启清理功能。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">PurgeTaskStatus</span><span class="token punctuation">.</span><span class="token constant">STARTED</span> <span class="token operator">==</span> purgeTaskStatus<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Don't schedule the purge task with zero or negative purge interval.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>purgeInterval <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    timer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Timer</span><span class="token punctuation">(</span><span class="token string">"PurgeTask"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">TimerTask</span> task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PurgeTask</span><span class="token punctuation">(</span>dataLogDir<span class="token punctuation">,</span> snapDir<span class="token punctuation">,</span> snapRetainCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    timer<span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">HOURS</span><span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span>purgeInterval<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    purgeTaskStatus <span class="token operator">=</span> <span class="token class-name">PurgeTaskStatus</span><span class="token punctuation">.</span><span class="token constant">STARTED</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="PurgeTask_1522"></a>PurgeTask</h3> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">PurgeTxnLog</span><span class="token punctuation">.</span><span class="token function">purge</span><span class="token punctuation">(</span>logsDir<span class="token punctuation">,</span> snapsDir<span class="token punctuation">,</span> snapRetainCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>PurgeTxnLog.purge方法：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">purge</span><span class="token punctuation">(</span><span class="token class-name">File</span> dataDir<span class="token punctuation">,</span> <span class="token class-name">File</span> snapDir<span class="token punctuation">,</span> <span class="token keyword">int</span> num<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>num <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token constant">COUNT_ERR_MSG</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">FileTxnSnapLog</span> txnLog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileTxnSnapLog</span><span class="token punctuation">(</span>dataDir<span class="token punctuation">,</span> snapDir<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 倒序查找最新的num个snapshot文件</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">File</span><span class="token punctuation">&gt;</span></span> snaps <span class="token operator">=</span> txnLog<span class="token punctuation">.</span><span class="token function">findNValidSnapshots</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> numSnaps <span class="token operator">=</span> snaps<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>numSnaps <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 删除掉zxid比snaps小的txnlog和snapshot文件</span>
        <span class="token function">purgeOlderSnapshots</span><span class="token punctuation">(</span>txnLog<span class="token punctuation">,</span> snaps<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>numSnaps <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="ContainerManager_1554"></a>ContainerManager</h2> 
<p>负责清理container节点，只能有leader管理。启动后，定期检查cversion&gt;0且没有子级的container节点和ttl节点。尝试删除节点，删除的结果并不重要。如果提议失败或容器节点不为空，则没有任何危害。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/13fbfb9b8688a53de713f48fce920d43/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">简单程序 C语言xdoj98</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2c8970776d0db9b0ba323a3ca4b5a58d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Openharmony 对应Android基本系统信息</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>