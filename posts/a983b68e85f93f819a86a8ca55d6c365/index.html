<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>RK1808 uboot的编译分析 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="RK1808 uboot的编译分析" />
<meta property="og:description" content="前言 为了更深入了解rk1808 sdk，对其中关于uboot部分的脚本和makefile等做一个分析
主要参考文件：Rockchip_Developer_Guide_Linux_Software_CN.pdf
uboot的编译 根据文档的说法，编译uboot有两种方法
在uboot目录下编译 这种方法，先cd到uboot目录下，然后执行
sudo ./make.sh rk1808 在顶层目录下编译 这种方法，利用底层目录的build.sh，传递参数uboot进行编译
sudo ./build.sh uboot 其实利用build.sh脚本，实际上也是cd到uboot目录下，去调用make.sh脚本进行编译，因此这两种方式其实可以认为是一种，那要想弄清楚来龙去脉，就得先分析build.sh脚本
build.sh分析 直接跳到末尾，有这样一段话，首先判断是不是需要打印usage，如果不是，然后再对输入的参数，也就是$@进行遍历，并判断它是什么
例如我这样输入sudo ./build.sh uboot，在下面的case分支语句中，就会进入eval build_$option || usage，这个意思是||前能执行，就去执行，不能执行，就打印usage
#========================= # build targets #========================= if echo $@|grep -wqE &#34;help|-h&#34;; then usage exit 0 fi OPTIONS=&#34;$@&#34; for option in ${OPTIONS:-allsave}; do echo &#34;processing option: $option&#34; case $option in BoardConfig*.mk) option=$TOP_DIR/device/rockchip/$RK_TARGET_PRODUCT/$option ;&amp; *.mk) CONF=$(realpath $option) echo &#34;switching to board: $CONF&#34; if [ ! -f $CONF ]; then echo &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/a983b68e85f93f819a86a8ca55d6c365/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-07-28T14:50:06+08:00" />
<meta property="article:modified_time" content="2020-07-28T14:50:06+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">RK1808 uboot的编译分析</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>前言</h2> 
<p>为了更深入了解rk1808 sdk，对其中关于uboot部分的脚本和makefile等做一个分析</p> 
<p>主要参考文件：<strong>Rockchip_Developer_Guide_Linux_Software_CN.pdf</strong></p> 
<h2><a id="uboot_6"></a>uboot的编译</h2> 
<p>根据文档的说法，编译uboot有两种方法</p> 
<ul><li>在uboot目录下编译</li></ul> 
<p>这种方法，先cd到uboot目录下，然后执行</p> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> ./make.sh rk1808
</code></pre> 
<ul><li>在顶层目录下编译</li></ul> 
<p>这种方法，利用底层目录的build.sh，传递参数uboot进行编译</p> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> ./build.sh uboot
</code></pre> 
<p>其实利用build.sh脚本，实际上也是cd到uboot目录下，去调用make.sh脚本进行编译，因此这两种方式其实可以认为是一种，那要想弄清楚来龙去脉，就得先分析build.sh脚本</p> 
<h2><a id="buildsh_28"></a>build.sh分析</h2> 
<p>直接跳到末尾，有这样一段话，首先判断是不是需要打印usage，如果不是，然后再对输入的参数，也就是<code>$@</code>进行遍历，并判断它是什么</p> 
<p>例如我这样输入<code>sudo ./build.sh uboot</code>，在下面的case分支语句中，就会进入<code>eval build_$option || usage</code>，这个意思是<code>||</code>前能执行，就去执行，不能执行，就打印usage</p> 
<pre><code class="prism language-shell"><span class="token comment">#=========================</span>
<span class="token comment"># build targets</span>
<span class="token comment">#=========================</span>

<span class="token keyword">if</span> <span class="token keyword">echo</span> <span class="token variable">$@</span><span class="token operator">|</span><span class="token function">grep</span> -wqE <span class="token string">"help|-h"</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        usage
        <span class="token keyword">exit</span> 0
<span class="token keyword">fi</span>

OPTIONS<span class="token operator">=</span><span class="token string">"<span class="token variable">$@</span>"</span>
<span class="token keyword">for</span> option <span class="token keyword">in</span> <span class="token variable">${OPTIONS:-allsave}</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
	<span class="token keyword">echo</span> <span class="token string">"processing option: <span class="token variable">$option</span>"</span>
	<span class="token keyword">case</span> <span class="token variable">$option</span> <span class="token keyword">in</span>
		BoardConfig*.mk<span class="token punctuation">)</span>
            option<span class="token operator">=</span><span class="token variable">$TOP_DIR</span>/device/rockchip/<span class="token variable">$RK_TARGET_PRODUCT</span>/<span class="token variable">$option</span>
            <span class="token punctuation">;</span><span class="token operator">&amp;</span>  
        *.mk<span class="token punctuation">)</span>
            CONF<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>realpath $option<span class="token variable">)</span></span>
            <span class="token keyword">echo</span> <span class="token string">"switching to board: <span class="token variable">$CONF</span>"</span>
            <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -f <span class="token variable">$CONF</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
                <span class="token keyword">echo</span> <span class="token string">"not exist!"</span>
                <span class="token keyword">exit</span> 1
            <span class="token keyword">fi</span>  
			<span class="token function">ln</span> -sf <span class="token variable">$CONF</span> <span class="token variable">$BOARD_CONFIG</span>
			<span class="token punctuation">;</span><span class="token punctuation">;</span>  
		buildroot<span class="token operator">|</span>debian<span class="token operator">|</span>distro<span class="token operator">|</span>yocto<span class="token punctuation">)</span>
            build_rootfs <span class="token variable">$option</span>
            <span class="token punctuation">;</span><span class="token punctuation">;</span>  
		recovery<span class="token punctuation">)</span>
            build_kernel
            <span class="token punctuation">;</span><span class="token operator">&amp;</span>  
        *<span class="token punctuation">)</span>  
            <span class="token function">eval</span> build_<span class="token variable">$option</span> <span class="token operator">||</span> usage
            <span class="token punctuation">;</span><span class="token punctuation">;</span>  
	esac
<span class="token keyword">done</span> 
</code></pre> 
<p>再往上看，可以找到编译uboot的函数，它首先删除了一个loader什么的bin文件，据说是用于初始化ddr的，这个暂时没太想明白</p> 
<p>然后cd到uboot的目录下，执行<code>./make.sh rk1808</code>，它这个参数<code>$RK_UBOOT_DEFCONFIG</code>通过打印可以很清楚地知道，其实就是rk1808，然后判断上一个命令的退出状态，来确定执行成功与否</p> 
<p>接下来就是分析make.sh了</p> 
<pre><code class="prism language-shell"><span class="token keyword">function</span> build_uboot<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">echo</span> <span class="token string">"============Start build uboot============"</span>
        <span class="token keyword">echo</span> <span class="token string">"TARGET_UBOOT_CONFIG=<span class="token variable">$RK_UBOOT_DEFCONFIG</span>"</span>
        <span class="token keyword">echo</span> <span class="token string">"========================================="</span>
        <span class="token keyword">if</span> <span class="token punctuation">[</span> -f u-boot/*_loader_*.bin <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
                <span class="token function">rm</span> u-boot/*_loader_*.bin
        <span class="token keyword">fi</span>
        <span class="token function">cd</span> u-boot <span class="token operator">&amp;&amp;</span> ./make.sh <span class="token variable">$RK_UBOOT_DEFCONFIG</span> <span class="token operator">&amp;&amp;</span> <span class="token function">cd</span> -
        <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> -eq 0 <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
                <span class="token keyword">echo</span> <span class="token string">"====Build uboot ok!===="</span>
        <span class="token keyword">else</span>
                <span class="token keyword">echo</span> <span class="token string">"====Build uboot failed!===="</span>
                <span class="token keyword">exit</span> 1
        <span class="token keyword">fi</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="makesh_97"></a>make.sh</h2> 
<p>这个脚本比刚才的复杂的多，因为瑞星微的sdk是针对所有产品的，一份sdk可以编译出多款芯片的镜像文件，所以这个makefile、编译脚本等都很复杂，但是我们只要抽丝剥茧，抓住核心即可</p> 
<p>还是老规矩，直接跳到末尾，看它调用了哪些函数</p> 
<pre><code class="prism language-shell">prepare
select_toolchain
select_chip_info
fixup_platform_configure
sub_commands
<span class="token function">make</span> CROSS_COMPILE<span class="token operator">=</span><span class="token variable">${TOOLCHAIN_GCC}</span>  all --jobs<span class="token operator">=</span><span class="token variable">${JOB}</span> <span class="token variable">${OUTOPT}</span>
pack_uboot_image
pack_loader_image
pack_trust_image
finish     
</code></pre> 
<h3><a id="prepare_116"></a>prepare</h3> 
<pre><code class="prism language-shell">prepare<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	local absolute_path cmd <span class="token function">dir</span> count

	<span class="token comment"># Parse output directory 'O=&lt;dir&gt;'</span>
	cmd<span class="token operator">=</span><span class="token variable">${OUTDIR%=*}</span>
	<span class="token variable"><span class="token variable">`</span><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">${cmd}</span>"</span> <span class="token operator">=</span> <span class="token string">'O'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span><span class="token variable">`</span></span>
        OUTDIR<span class="token operator">=</span>$<span class="token punctuation">{<!-- --></span>OUTDIR<span class="token comment">#*=}</span>
        OUTOPT<span class="token operator">=</span>O<span class="token operator">=</span><span class="token variable">${OUTDIR}</span>
	<span class="token keyword">else</span>
		<span class="token keyword">case</span> <span class="token variable">$BOARD</span> <span class="token keyword">in</span>
            <span class="token comment"># Parse from exit .config</span>
            <span class="token string">''</span><span class="token operator">|</span>elf*<span class="token operator">|</span>loader*<span class="token operator">|</span>spl*<span class="token operator">|</span>itb<span class="token operator">|</span>debug*<span class="token operator">|</span>trust<span class="token operator">|</span>uboot<span class="token operator">|</span>map<span class="token operator">|</span>sym<span class="token punctuation">)</span>
                count<span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">find</span> -name .config <span class="token operator">|</span> <span class="token function">wc</span> -l<span class="token variable">`</span></span>
                dir<span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">find</span> -name .config<span class="token variable">`</span></span>
                <span class="token comment"># Good, find only one .config</span>
                <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$count</span> -eq 1 <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
                    dir<span class="token operator">=</span><span class="token variable">${dir%/*}</span>
                    OUTDIR<span class="token operator">=</span>$<span class="token punctuation">{<!-- --></span>dir<span class="token comment">#*/}</span>
                    <span class="token comment"># Set OUTOPT if not current directory</span>
                    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$OUTDIR</span> <span class="token operator">!=</span> <span class="token string">'.'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
                        OUTOPT<span class="token operator">=</span>O<span class="token operator">=</span><span class="token variable">${OUTDIR}</span>
                    <span class="token keyword">fi</span>
                <span class="token keyword">elif</span> <span class="token punctuation">[</span> <span class="token variable">$count</span> -eq 0 <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
                    <span class="token keyword">echo</span>
                    <span class="token keyword">echo</span> <span class="token string">"Build failed, Can't find .config"</span>
                    <span class="token function">help</span>
                    <span class="token keyword">exit</span> 1
                <span class="token keyword">else</span>
                    <span class="token keyword">echo</span>
                    <span class="token keyword">echo</span> <span class="token string">"Build failed, find <span class="token variable">$count</span> '.config': "</span>
                    <span class="token keyword">echo</span> <span class="token string">"<span class="token variable">$dir</span>"</span>
                    <span class="token keyword">echo</span> <span class="token string">"Please leave only one of them"</span>
                    <span class="token keyword">exit</span> 1
                <span class="token keyword">fi</span>
                <span class="token punctuation">;</span><span class="token punctuation">;</span>
            *<span class="token punctuation">)</span>
                OUTDIR<span class="token operator">=</span>.
                <span class="token punctuation">;</span><span class="token punctuation">;</span>
		esac
	<span class="token keyword">fi</span>

    <span class="token comment"># Parse help and make defconfig</span>
    <span class="token keyword">case</span> <span class="token variable">$BOARD</span> <span class="token keyword">in</span>
    	<span class="token comment">#Help</span>
    	--help<span class="token operator">|</span>-help<span class="token operator">|</span><span class="token function">help</span><span class="token operator">|</span>--h<span class="token operator">|</span>-h<span class="token punctuation">)</span>
   	 		<span class="token function">help</span>
    		<span class="token keyword">exit</span> 0
			<span class="token punctuation">;</span><span class="token punctuation">;</span>

    	<span class="token comment">#Subcmd</span>
        <span class="token string">''</span><span class="token operator">|</span>elf*<span class="token operator">|</span>loader*<span class="token operator">|</span>spl*<span class="token operator">|</span>itb<span class="token operator">|</span>debug*<span class="token operator">|</span>trust*<span class="token operator">|</span>uboot<span class="token operator">|</span>map<span class="token operator">|</span>sym<span class="token punctuation">)</span>
            <span class="token punctuation">;</span><span class="token punctuation">;</span>

		*<span class="token punctuation">)</span>
            <span class="token comment">#Func address is valid ?</span>
            <span class="token keyword">if</span> <span class="token punctuation">[</span> -z <span class="token variable"><span class="token variable">$(</span><span class="token keyword">echo</span> $<span class="token punctuation">{<!-- --></span>FUNCADDR<span class="token punctuation">}</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'s/[0-9,a-f,A-F,x,X,-]//g'</span><span class="token variable">)</span></span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
            	<span class="token keyword">return</span>
            <span class="token keyword">elif</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -f configs/<span class="token variable">${BOARD}</span>_defconfig <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
                <span class="token keyword">echo</span>
                <span class="token keyword">echo</span> <span class="token string">"Can't find: configs/<span class="token variable">${BOARD}</span>_defconfig"</span>
                <span class="token keyword">echo</span>
                <span class="token keyword">echo</span> <span class="token string">"******** Rockchip Support List *************"</span>
                <span class="token keyword">echo</span> <span class="token string">"<span class="token variable">${SUPPORT_LIST}</span>"</span>
                <span class="token keyword">echo</span> <span class="token string">"********************************************"</span>
                <span class="token keyword">echo</span>
                <span class="token keyword">exit</span> 1
            <span class="token keyword">else</span>
            	<span class="token keyword">echo</span> <span class="token string">"make for <span class="token variable">${BOARD}</span>_defconfig by -j<span class="token variable">${JOB}</span>"</span>
           	 	<span class="token function">make</span> <span class="token variable">${BOARD}</span>_defconfig <span class="token variable">${OUTOPT}</span>
            <span class="token keyword">fi</span>
			<span class="token punctuation">;</span><span class="token punctuation">;</span>
	esac
	
    <span class="token comment"># Initialize RKBIN</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span> -d <span class="token variable">${RKBIN_TOOLS}</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    	absolute_path<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">cd</span> `dirname $<span class="token punctuation">{<!-- --></span>RKBIN_TOOLS<span class="token punctuation">}</span>`<span class="token punctuation">;</span> <span class="token function">pwd</span><span class="token variable">)</span></span>
    	RKBIN<span class="token operator">=</span><span class="token variable">${absolute_path}</span>
    <span class="token keyword">else</span>
        <span class="token keyword">echo</span>
        <span class="token keyword">echo</span> <span class="token string">"Can't find '../rkbin/' repository, please download it before pack image!"</span>
        <span class="token keyword">echo</span> <span class="token string">"How to obtain? 3 ways:"</span>
        <span class="token keyword">echo</span> <span class="token string">"  1. Login your Rockchip gerrit account: \"Projects\" -&gt; \"List\" -&gt; search \"rk/rkbin\" repository"</span>
        <span class="token keyword">echo</span> <span class="token string">"  2. Github repository: https://github.com/rockchip-linux/rkbin"</span>
        <span class="token keyword">echo</span> <span class="token string">"  3. Download full release SDK repository"</span>
        <span class="token keyword">exit</span> 1
    <span class="token keyword">fi</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这个函数很长，首先出现了几个变量，然后先看分析第一段<code># Parse output directory 'O=&lt;dir&gt;'</code></p> 
<pre><code class="prism language-shell">BOARD<span class="token operator">=</span><span class="token variable">$1</span>
OUTDIR<span class="token operator">=</span><span class="token variable">$2</span>
OUTOPT<span class="token operator">=</span>
</code></pre> 
<p>我们传进来的<code>$1</code>是rk1808，后面两个OUT都是空，因此，不会进入<code>if [ "${cmd}" = 'O' ]; then</code>这个条件里面</p> 
<p>进到第二个条件后，会去遍历我们传进来的参数 <code>$1</code>，也就是<code>BOARD</code>，然后第一个case条件是<code>''|elf*|loader*|spl*|itb|debug*|trust|uboot|map|sym)</code>很明显rk1808不满足这个，所以会执行末尾的<code>*)</code>，这个条件里面，只做了一件事，那就是<code>OUTDIR=.</code></p> 
<hr> 
<p>然后分析第二段，<code># Parse help and make defconfig</code></p> 
<p>可以看到注释的help和subcmd仍然是不会被执行的，所以直接看<code>Func address is valid ?</code>部分</p> 
<p>这个if条件的结果，是<code>rk</code>，不为空，所以不会return</p> 
<p>然后判断<code>configs/rk1808_defconfig</code>这个默认配置文件在不在</p> 
<p>最后唯一有用的部分，就是执行<code>make ${BOARD}_defconfig ${OUTOPT}</code>，也就是<code>make rk1808_defconfig .</code></p> 
<p>这句话的作用是从configs中拷贝配置文件到当前目录下</p> 
<pre><code class="prism language-shell"><span class="token keyword">case</span> <span class="token variable">$BOARD</span> <span class="token keyword">in</span>                                                                                                                                            
        <span class="token comment">#Help</span>
        --help<span class="token operator">|</span>-help<span class="token operator">|</span><span class="token function">help</span><span class="token operator">|</span>--h<span class="token operator">|</span>-h<span class="token punctuation">)</span>
        <span class="token function">help</span>
        <span class="token keyword">exit</span> 0
        <span class="token punctuation">;</span><span class="token punctuation">;</span>  

        <span class="token comment">#Subcmd</span>
        <span class="token string">''</span><span class="token operator">|</span>elf*<span class="token operator">|</span>loader*<span class="token operator">|</span>spl*<span class="token operator">|</span>itb<span class="token operator">|</span>debug*<span class="token operator">|</span>trust*<span class="token operator">|</span>uboot<span class="token operator">|</span>map<span class="token operator">|</span>sym<span class="token punctuation">)</span>
        <span class="token punctuation">;</span><span class="token punctuation">;</span>  

		*<span class="token punctuation">)</span>  
        <span class="token comment">#Func address is valid ?</span>
        <span class="token keyword">if</span> <span class="token punctuation">[</span> -z <span class="token variable"><span class="token variable">$(</span><span class="token keyword">echo</span> $<span class="token punctuation">{<!-- --></span>FUNCADDR<span class="token punctuation">}</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'s/[0-9,a-f,A-F,x,X,-]//g'</span><span class="token variable">)</span></span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
                <span class="token keyword">return</span>
        <span class="token keyword">elif</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -f configs/<span class="token variable">${BOARD}</span>_defconfig <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
                <span class="token keyword">echo</span>
                <span class="token keyword">echo</span> <span class="token string">"Can't find: configs/<span class="token variable">${BOARD}</span>_defconfig"</span>
                <span class="token keyword">echo</span>
                <span class="token keyword">echo</span> <span class="token string">"******** Rockchip Support List *************"</span>
                <span class="token keyword">echo</span> <span class="token string">"<span class="token variable">${SUPPORT_LIST}</span>"</span>
                <span class="token keyword">echo</span> <span class="token string">"********************************************"</span>
                <span class="token keyword">echo</span>
                <span class="token keyword">exit</span> 1
        <span class="token keyword">else</span>
                <span class="token keyword">echo</span> <span class="token string">"make for <span class="token variable">${BOARD}</span>_defconfig by -j<span class="token variable">${JOB}</span>"</span>
                <span class="token function">make</span> <span class="token variable">${BOARD}</span>_defconfig <span class="token variable">${OUTOPT}</span>
        <span class="token keyword">fi</span>  
        <span class="token punctuation">;</span><span class="token punctuation">;</span>  
esac
</code></pre> 
<hr> 
<p>然后分析第三段<code># Initialize RKBIN</code></p> 
<p>在uboot的同级目录下，有个rkbin目录，编译uboot时需要用到这里面的bin文件，这里就是为了将它的绝对路径赋值给RKBIN</p> 
<pre><code class="prism language-shell"><span class="token comment"># Initialize RKBIN                                                                                                                                        </span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> -d <span class="token variable">${RKBIN_TOOLS}</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span> 
        absolute_path<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">cd</span> `dirname $<span class="token punctuation">{<!-- --></span>RKBIN_TOOLS<span class="token punctuation">}</span>`<span class="token punctuation">;</span> <span class="token function">pwd</span><span class="token variable">)</span></span>
        RKBIN<span class="token operator">=</span><span class="token variable">${absolute_path}</span>
<span class="token keyword">else</span>    
        <span class="token keyword">echo</span>    
        <span class="token keyword">echo</span> <span class="token string">"Can't find '../rkbin/' repository, please download it before pack image!"</span>
        <span class="token keyword">echo</span> <span class="token string">"How to obtain? 3 ways:"</span>
        <span class="token keyword">echo</span> <span class="token string">"  1. Login your Rockchip gerrit account: \"Projects\" -&gt; \"List\" -&gt; search \"rk/rkbin\" repository"</span>
        <span class="token keyword">echo</span> <span class="token string">"  2. Github repository: https://github.com/rockchip-linux/rkbin"</span>
        <span class="token keyword">echo</span> <span class="token string">"  3. Download full release SDK repository"</span>
        <span class="token keyword">exit</span> 1  
<span class="token keyword">fi</span>
</code></pre> 
<h3><a id="select_toolchain_290"></a>select_toolchain</h3> 
<p>根据当前目录下的<code>.config</code>文件，判断是否有<code>CONFIG_ARM64=y</code>，然后给TOOLCHAIN_GCC等变量赋一个绝对路径</p> 
<pre><code class="prism language-shell">select_toolchain<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    local absolute_path

    <span class="token keyword">if</span> <span class="token function">grep</span>  -q <span class="token string">'^CONFIG_ARM64=y'</span> <span class="token variable">${OUTDIR}</span>/.config <span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token keyword">if</span> <span class="token punctuation">[</span> -d <span class="token variable">${TOOLCHAIN_ARM64}</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
            absolute_path<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">cd</span> `dirname $<span class="token punctuation">{<!-- --></span>TOOLCHAIN_ARM64<span class="token punctuation">}</span>`<span class="token punctuation">;</span> <span class="token function">pwd</span><span class="token variable">)</span></span>
            TOOLCHAIN_GCC<span class="token operator">=</span><span class="token variable">${absolute_path}</span>/bin/<span class="token variable">${GCC_ARM64}</span>
            TOOLCHAIN_OBJDUMP<span class="token operator">=</span><span class="token variable">${absolute_path}</span>/bin/<span class="token variable">${OBJ_ARM64}</span>
            TOOLCHAIN_ADDR2LINE<span class="token operator">=</span><span class="token variable">${absolute_path}</span>/bin/<span class="token variable">${ADDR2LINE_ARM64}</span>
        <span class="token keyword">else</span>
            <span class="token keyword">echo</span> <span class="token string">"Can't find toolchain: <span class="token variable">${TOOLCHAIN_ARM64}</span>"</span>
            <span class="token keyword">exit</span> 1
        <span class="token keyword">fi</span>  
    <span class="token keyword">else</span>
        <span class="token keyword">if</span> <span class="token punctuation">[</span> -d <span class="token variable">${TOOLCHAIN_ARM32}</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
            absolute_path<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">cd</span> `dirname $<span class="token punctuation">{<!-- --></span>TOOLCHAIN_ARM32<span class="token punctuation">}</span>`<span class="token punctuation">;</span> <span class="token function">pwd</span><span class="token variable">)</span></span>
            TOOLCHAIN_GCC<span class="token operator">=</span><span class="token variable">${absolute_path}</span>/bin/<span class="token variable">${GCC_ARM32}</span>
            TOOLCHAIN_OBJDUMP<span class="token operator">=</span><span class="token variable">${absolute_path}</span>/bin/<span class="token variable">${OBJ_ARM32}</span>
            TOOLCHAIN_ADDR2LINE<span class="token operator">=</span><span class="token variable">${absolute_path}</span>/bin/<span class="token variable">${ADDR2LINE_ARM32}</span>
        <span class="token keyword">else</span>
            <span class="token keyword">echo</span> <span class="token string">"Can't find toolchain: <span class="token variable">${TOOLCHAIN_ARM32}</span>"</span>
            <span class="token keyword">exit</span> 1
        <span class="token keyword">fi</span>  
    <span class="token keyword">fi</span>  

    <span class="token comment"># echo "toolchain: ${TOOLCHAIN_GCC}"</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="select_chip_info_325"></a>select_chip_info</h3> 
<p>这个函数个人感觉不怎么重要，所以代码就不贴了，它的作用也是从.config读取一些信息，然后给以下变量赋值</p> 
<p>RKCHIP_LABEL、RKCHIP_LOADER、RKCHIP_TRUST</p> 
<h3><a id="fixup_platform_configure_333"></a>fixup_platform_configure</h3> 
<p>这个函数也没什么意思，也是在赋值</p> 
<pre><code class="prism language-shell">PLATFORM_RSA<span class="token operator">=</span><span class="token string">"--rsa 3"</span>
PLATFORM_UBOOT_IMG_SIZE<span class="token operator">=</span><span class="token string">"--size 1024 2"</span>
PLATFORM_TRUST_IMG_SIZE<span class="token operator">=</span><span class="token string">"--size 1024 2"</span>
</code></pre> 
<h3><a id="sub_commands_345"></a>sub_commands</h3> 
<p>说实话我没看懂他要干啥</p> 
<h3><a id="make_351"></a>make</h3> 
<pre><code>make CROSS_COMPILE=${TOOLCHAIN_GCC}  all --jobs=${JOB} ${OUTOPT}
</code></pre> 
<p>这个其实就没啥好说的了，那个jobs是编译所用的线程数，output应该是生成文件的路径，默认是空的</p> 
<p>最终是生成<code>u-boot.img</code> <code>u-boot-dtb.img</code> <code>u-boot.bin</code> <code>u-boot-dtb.bin</code>等文件</p> 
<h3><a id="pack_uboot_image_361"></a>pack_uboot_image</h3> 
<p>打包uboot前，先检查<code>u-boot.bin</code>的大小，超过10M，就报错了</p> 
<pre><code class="prism language-shell"><span class="token comment"># Check file size</span>
    UBOOT_KB<span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">ls</span> -l u-boot.bin <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print <span class="token variable">$5</span>}'</span><span class="token variable">`</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$PLATFORM_UBOOT_IMG_SIZE</span>"</span> <span class="token operator">=</span> <span class="token string">""</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        UBOOT_MAX_KB<span class="token operator">=</span>1046528
    <span class="token keyword">else</span>
        UBOOT_MAX_KB<span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token keyword">echo</span> $PLATFORM_UBOOT_IMG_SIZE <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print strtonum(<span class="token variable">$2</span>)}'</span><span class="token variable">`</span></span>
        UBOOT_MAX_KB<span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span><span class="token punctuation">(</span>UBOOT_MAX_KB<span class="token operator">-</span>HEAD_KB<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1024</span><span class="token variable">))</span></span>
    <span class="token keyword">fi</span>  

    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$UBOOT_KB</span> -gt <span class="token variable">$UBOOT_MAX_KB</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token keyword">echo</span>    
        <span class="token keyword">echo</span> <span class="token string">"ERROR: pack uboot failed! u-boot.bin actual: <span class="token variable">$UBOOT_KB</span> bytes, max limit: <span class="token variable">$UBOOT_MAX_KB</span> bytes"</span>
        <span class="token keyword">exit</span> 1  
    <span class="token keyword">fi</span>
</code></pre> 
<p>最终在当前目录下，生成了uboot.img，并删除了其它的img结尾的中间文件</p> 
<pre><code class="prism language-shell"><span class="token comment"># Pack image</span>
    UBOOT_LOAD_ADDR<span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">sed</span> -n <span class="token string">"/CONFIG_SYS_TEXT_BASE=/s/CONFIG_SYS_TEXT_BASE=//p"</span> $<span class="token punctuation">{<!-- --></span>OUTDIR<span class="token punctuation">}</span>/include/autoconf.mk<span class="token operator">|</span><span class="token function">tr</span> -d <span class="token string">'\r'</span><span class="token variable">`</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> <span class="token variable">$UBOOT_LOAD_ADDR</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        UBOOT_LOAD_ADDR<span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">sed</span> -n <span class="token string">"/CONFIG_SYS_TEXT_BASE=/s/CONFIG_SYS_TEXT_BASE=//p"</span> $<span class="token punctuation">{<!-- --></span>OUTDIR<span class="token punctuation">}</span>/.config<span class="token operator">|</span><span class="token function">tr</span> -d <span class="token string">'\r'</span><span class="token variable">`</span></span>
    <span class="token keyword">fi</span>

    <span class="token variable">${RKTOOLS}</span>/loaderimage --pack --uboot <span class="token variable">${OUTDIR}</span>/u-boot.bin uboot.img <span class="token variable">${UBOOT_LOAD_ADDR}</span> <span class="token variable">${PLATFORM_UBOOT_IMG_SIZE}</span>                                                        

    <span class="token comment"># Delete u-boot.img and u-boot-dtb.img, which makes users not be confused with final uboot.img</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span> -f <span class="token variable">${OUTDIR}</span>/u-boot.img <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token function">rm</span> <span class="token variable">${OUTDIR}</span>/u-boot.img
    <span class="token keyword">fi</span>

    <span class="token keyword">if</span> <span class="token punctuation">[</span> -f <span class="token variable">${OUTDIR}</span>/u-boot-dtb.img <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token function">rm</span> <span class="token variable">${OUTDIR}</span>/u-boot-dtb.img
    <span class="token keyword">fi</span>
    <span class="token keyword">echo</span> <span class="token string">"pack uboot okay! Input: <span class="token variable">${OUTDIR}</span>/u-boot.bin"</span>
</code></pre> 
<h3><a id="pack_loader_image_404"></a>pack_loader_image</h3> 
<p>这一步最终生成这个文件<code>rk1808_loader_v1.04.105.bin</code>，并拷贝到当前目录下</p> 
<h3><a id="pack_trust_image_408"></a>pack_trust_image</h3> 
<p>这一步生成<code>trust.img</code>，这是arm搞的一个跟安全有关的东西<code>Trustzone</code>，大致是为了保护内存中的数据不被别人窃取之类的</p> 
<h3><a id="finish_412"></a>finish</h3> 
<p>最后一步就是打印一点信息，就ok了</p> 
<h2><a id="_418"></a>总结</h2> 
<p>从结果来看，执行make.sh一共得到了以下几个东西</p> 
<ul><li>uboot.img</li><li>rk1808_loader_v1.04.105.bin</li><li>trust.img</li></ul> 
<p>我们烧录的时候，是在顶层目录的rockdev去取镜像文件，在linux下，可以很清晰得看到链接的关系，所生成的这三个文件，都会被链接到</p> 
<pre><code class="prism language-shell">boot.img -<span class="token operator">&gt;</span> <span class="token punctuation">..</span>/kernel/boot.img
MiniLoaderAll.bin -<span class="token operator">&gt;</span> <span class="token punctuation">..</span>/u-boot/rk1808_loader_v1.04.105.bin
misc.img -<span class="token operator">&gt;</span> <span class="token punctuation">..</span>/device/rockchip/rockimg/wipe_all-misc.img
oem.img
parameter.txt -<span class="token operator">&gt;</span> <span class="token punctuation">..</span>/device/rockchip/rk1808/parameter-buildroot.txt
recovery.img -<span class="token operator">&gt;</span> <span class="token punctuation">..</span>/buildroot/output/rockchip_rk1808_recovery/images/recovery.img
rootfs.ext4 -<span class="token operator">&gt;</span> <span class="token punctuation">..</span>/buildroot/output/rockchip_rk1808/images/rootfs.ext2
rootfs.img -<span class="token operator">&gt;</span> <span class="token punctuation">..</span>/buildroot/output/rockchip_rk1808/images/rootfs.ext2
trust.img -<span class="token operator">&gt;</span> <span class="token punctuation">..</span>/u-boot/trust.img
uboot.img -<span class="token operator">&gt;</span> <span class="token punctuation">..</span>/u-boot/uboot.img
update.img
userdata.img
</code></pre> 
<p>除此之外，如果希望自己修改一些uboot的内容，可以通过类似内核的make menuconfig取修改.config文件，不过注意修改完了，一定要记得将该文件写回原来的位置，就是那个默认的deconfig所在的位置，否则每次编译，当前目录下的.config都会被configs目录下的xxx_deconfig覆盖掉</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a0274e373a2ca44dae230bbad89f36e3/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">第十二章 Logstash入门</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/278c343fae05f07cce774f33507edb73/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">基于Redis和RabbitMQ简单实现秒杀回顾</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>