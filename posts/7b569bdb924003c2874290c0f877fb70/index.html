<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>alarm唤醒系统过程分析 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="alarm唤醒系统过程分析" />
<meta property="og:description" content="Android的aralm可以唤醒系统，先看ararm调用过程
http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/AlarmManager.java
public void set(@AlarmType int type, long triggerAtMillis, PendingIntent operation) { setImpl(type, triggerAtMillis, legacyExactLength(), 0, 0, operation, null, null, null, null, null); } private void setImpl(@AlarmType int type, long triggerAtMillis, long windowMillis,long intervalMillis, int flags, PendingIntent operation, final OnAlarmListener listener,String listenerTag, Handler targetHandler, WorkSource workSource,AlarmClockInfo alarmClock) { mService.set(mPackageName, type, triggerAtMillis, windowMillis, intervalMillis, flags, operation, recipientWrapper, listenerTag, workSource, alarmClock); } http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/AlarmManagerService.java
private final IBinder mService = new IAlarmManager.Stub() { @Override public void set(String callingPackage, int type, long triggerAtTime, long windowLength, long interval, int flags, PendingIntent operation, IAlarmListener directReceiver, String listenerTag, WorkSource workSource, AlarmManager." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/7b569bdb924003c2874290c0f877fb70/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-09-26T19:22:36+08:00" />
<meta property="article:modified_time" content="2019-09-26T19:22:36+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">alarm唤醒系统过程分析</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>Android的aralm可以唤醒系统，先看ararm调用过程</p> 
<p><a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/AlarmManager.java" rel="nofollow">http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/AlarmManager.java</a></p> 
<pre class="has"><code class="language-java">public void set(@AlarmType int type, long triggerAtMillis, PendingIntent operation) {
        setImpl(type, triggerAtMillis, legacyExactLength(), 0, 0, operation, null, null,
                null, null, null);
 }</code></pre> 
<pre class="has"><code class="language-java">private void setImpl(@AlarmType int type, long triggerAtMillis, long windowMillis,long intervalMillis, int flags, PendingIntent operation, final OnAlarmListener listener,String listenerTag, Handler targetHandler, WorkSource workSource,AlarmClockInfo alarmClock) {
            mService.set(mPackageName, type, triggerAtMillis, windowMillis, intervalMillis, flags,
                    operation, recipientWrapper, listenerTag, workSource, alarmClock);
}</code></pre> 
<p><a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/AlarmManagerService.java" rel="nofollow">http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/AlarmManagerService.java</a></p> 
<pre class="has"><code class="language-java"> private final IBinder mService = new IAlarmManager.Stub() {
        @Override
        public void set(String callingPackage,
                int type, long triggerAtTime, long windowLength, long interval, int flags,
                PendingIntent operation, IAlarmListener directReceiver, String listenerTag,
                WorkSource workSource, AlarmManager.AlarmClockInfo alarmClock) {
            setImpl(type, triggerAtTime, windowLength, interval, operation, directReceiver,
                    listenerTag, flags, workSource, alarmClock, callingUid, callingPackage);
        }
}
</code></pre> 
<pre class="has"><code class="language-java">void setImpl(int type, long triggerAtTime, long windowLength, long interval,
            PendingIntent operation, IAlarmListener directReceiver, String listenerTag,
            int flags, WorkSource workSource, AlarmManager.AlarmClockInfo alarmClock,
            int callingUid, String callingPackage) {

            setImplLocked(type, triggerAtTime, triggerElapsed, windowLength, maxElapsed,
                    interval, operation, directReceiver, listenerTag, flags, true, workSource,
                    alarmClock, callingUid, callingPackage);
 }</code></pre> 
<pre class="has"><code class="language-java">private void setImplLocked(int type, long when, long whenElapsed, long windowLength,
            long maxWhen, long interval, PendingIntent operation, IAlarmListener directReceiver,
            String listenerTag, int flags, boolean doValidate, WorkSource workSource,
            AlarmManager.AlarmClockInfo alarmClock, int callingUid, String callingPackage) {
        Alarm a = new Alarm(type, when, whenElapsed, windowLength, maxWhen, interval,
                operation, directReceiver, listenerTag, workSource, flags, alarmClock,
                callingUid, callingPackage);
        setImplLocked(a, false, doValidate);
}</code></pre> 
<pre class="has"><code class="language-java">private void setImplLocked(Alarm a, boolean rebatching, boolean doValidate) {
	rescheduleKernelAlarmsLocked();
}
</code></pre> 
<pre class="has"><code class="language-java">void rescheduleKernelAlarmsLocked() {
	setLocked(ELAPSED_REALTIME, nextNonWakeup);
}</code></pre> 
<pre class="has"><code class="language-java">private void setLocked(int type, long when) {
	final int result = set(mNativeData, type, alarmSeconds, alarmNanoseconds);
}</code></pre> 
<pre class="has"><code class="language-java">private native int set(long nativeData, int type, long seconds, long nanoseconds);</code></pre> 
<p><a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/jni/com_android_server_AlarmManagerService.cpp" rel="nofollow">http://androidxref.com/9.0.0_r3/xref/frameworks/base/services/core/jni/com_android_server_AlarmManagerService.cpp</a></p> 
<pre class="has"><code class="language-cpp">static const JNINativeMethod sMethods[] = {
    {"set", "(JIJJ)I", (void*)android_server_AlarmManagerService_set},
}

static jint android_server_AlarmManagerService_set(JNIEnv*, jobject, jlong nativeData, jint type, jlong seconds, jlong nanoseconds)
{
    const int result = impl-&gt;set(type, &amp;ts);
}

int AlarmImpl::set(int type, struct timespec *ts)
{
    return timerfd_settime(fds[type], TFD_TIMER_ABSTIME, &amp;spec, NULL);
}
</code></pre> 
<p>通过系统调用设置内核时间</p> 
<pre class="has"><code class="language-cpp">SYSCALL_DEFINE4(timerfd_settime, int, ufd, int, flags,
		const struct itimerspec __user *, utmr,
		struct itimerspec __user *, otmr)
{
	struct itimerspec new, old;
	int ret;

	if (copy_from_user(&amp;new, utmr, sizeof(new)))
		return -EFAULT;
	ret = do_timerfd_settime(ufd, flags, &amp;new, &amp;old);
	if (ret)
		return ret;
	if (otmr &amp;&amp; copy_to_user(otmr, &amp;old, sizeof(old)))
		return -EFAULT;

	return ret;
}</code></pre> 
<p>找最近的一个唤醒闹钟，设置到rtc里，时间到了,rtc产生中断唤醒cpu </p> 
<pre class="has"><code>static const struct dev_pm_ops alarmtimer_pm_ops = {
	.suspend = alarmtimer_suspend,
};

static struct platform_driver alarmtimer_driver = {
	.driver = {
		.name = "alarmtimer",
		.pm = &amp;alarmtimer_pm_ops,
	},
	.shutdown = alarmtimer_shutdown,
};

static int alarmtimer_suspend(struct device *dev)
{
	struct rtc_time tm, tm_set;
	ktime_t min, now, set_time;
	unsigned long flags;
	struct rtc_device *rtc;
	struct rtc_wkalrm alarm;
	int i, ret = 0;

	spin_lock_irqsave(&amp;freezer_delta_lock, flags);
	min = freezer_delta;
	freezer_delta = ktime_set(0, 0);
	spin_unlock_irqrestore(&amp;freezer_delta_lock, flags);

	rtc = alarmtimer_get_rtcdev();
	/* If we have no rtcdev, just return */
	if (!rtc)
		return 0;

	/* Find the soonest timer to expire*/
	for (i = 0; i &lt; ALARM_NUMTYPE; i++) {
		struct alarm_base *base = &amp;alarm_bases[i];
		struct timerqueue_node *next;
		ktime_t delta;

		spin_lock_irqsave(&amp;base-&gt;lock, flags);
		next = timerqueue_getnext(&amp;base-&gt;timerqueue);
		spin_unlock_irqrestore(&amp;base-&gt;lock, flags);
		if (!next)
			continue;
		delta = ktime_sub(next-&gt;expires, base-&gt;gettime());
		if (!min.tv64 || (delta.tv64 &lt; min.tv64))
			min = delta;
	}
	if (min.tv64 == 0)
		return 0;

	if (ktime_to_ns(min) &lt; 2 * NSEC_PER_SEC) {
		__pm_wakeup_event(ws, 2 * MSEC_PER_SEC);
		return -EBUSY;
	}

	/* Setup an rtc timer to fire that far in the future */
	rtc_timer_cancel(rtc, &amp;rtctimer);
	rtc_read_time(rtc, &amp;tm);

	now = rtc_tm_to_ktime(tm);
	set_time = ktime_add(now, min);
	tm_set = rtc_ktime_to_tm(set_time);
	pr_info("Suspend alarm: %d-%d-%d %d:%d:%d\n", tm_set.tm_year + 1900,
		tm_set.tm_mon + 1, tm_set.tm_mday, tm_set.tm_hour,
		tm_set.tm_min, tm_set.tm_sec);

	alarm.time = tm_set;
	alarm.enabled = 1;
	if (rtc-&gt;ops &amp;&amp; rtc-&gt;ops-&gt;set_alarm) {
		ret = rtc-&gt;ops-&gt;ioctl(rtc-&gt;dev.parent,
				      SET_WAKE_ALARM, (unsigned long)&amp;alarm);
		/* Set alarm, if in the past reject suspend briefly to handle */
		if (ret &lt; 0) {
			pr_err("Suspend alarm setting error %d\n", ret);
			__pm_wakeup_event(ws, MSEC_PER_SEC);
		}
	}

	return ret;
}</code></pre> 
<p> 某次抓的log如下，也就是说ararm的唤醒都是可预期的(Suspend ararm是格林威治时间,转换成北京时间需+8)</p> 
<pre class="has"><code class="language-cpp">[09-24 17:35:00.017] &lt;6&gt;[   53.283769] c0 Suspend alarm: 2019-9-24 9:35:0
[09-24 17:35:06.009] &lt;6&gt;[   55.383820] c0 Suspend alarm: 2019-9-24 9:35:6
[09-24 17:35:12.010] &lt;6&gt;[   57.593710] c0 Suspend alarm: 2019-9-24 9:35:12
[09-24 17:39:03.010] &lt;6&gt;[   59.693765] c0 Suspend alarm: 2019-9-24 9:39:3
[09-24 17:45:00.024] &lt;6&gt;[   61.804539] c0 Suspend alarm: 2019-9-24 9:45:0
[09-24 18:00:00.024] &lt;6&gt;[   64.024533] c0 Suspend alarm: 2019-9-24 10:0:0
[09-24 18:15:00.023] &lt;6&gt;[   66.244466] c0 Suspend alarm: 2019-9-24 10:15:0
[09-24 18:30:00.024] &lt;6&gt;[   68.364377] c0 Suspend alarm: 2019-9-24 10:30:0
[09-24 18:33:47.025] &lt;6&gt;[   70.584263] c0 Suspend alarm: 2019-9-24 10:45:0
[09-24 18:33:57.023] &lt;6&gt;[   72.104397] c0 Suspend alarm: 2019-9-24 10:45:0
[09-24 18:38:08.025] &lt;6&gt;[   72.724177] c0 Suspend alarm: 2019-9-24 10:45:0


[09-24 17:35:00.041] &lt;6&gt;[   53.298469] c0 RTC ***** interrupt happen
[09-24 17:35:06.015] &lt;6&gt;[   55.397274] c0 RTC ***** interrupt happen
[09-24 17:35:12.015] &lt;6&gt;[   57.607150] c0 RTC ***** interrupt happen
[09-24 17:39:03.015] &lt;6&gt;[   59.707245] c0 RTC ***** interrupt happen
[09-24 17:45:00.068] &lt;6&gt;[   61.827663] c0 RTC ***** interrupt happen
[09-24 18:00:00.030] &lt;6&gt;[   64.047574] c0 RTC ***** interrupt happen
[09-24 18:15:00.030] &lt;6&gt;[   66.267515] c0 RTC ***** interrupt happen</code></pre> 
<p>Android上层通过poll一直在监听ararm，接收到通知后，将相应的事件进行分发。只有type类型为0或者2的alarm客户唤醒系统。可以根据打印信息查找唤醒系统的闹钟,如</p> 
<pre class="has"><code class="language-cpp">09-19 15:00:05.968   813   952 D AlarmManager: sending alarm.type = 2, action = com.android.providers.calendar.intent.CalendarProvider2, cn = ComponentInfo{com.android.providers.calendar/com.android.providers.calendar.CalendarProviderBroadcastReceiver}, operation = PendingIntent{3eaf5c8: PendingIntentRecord{29dc661 com.android.providers.calendar broadcastIntent}}

09-19 15:01:46.941   813   952 D AlarmManager: sending alarm.type = 0, action = null, cn = ComponentInfo{cn.showmac.vsimservice/cn.jpush.android.service.AlarmReceiver}, operation = PendingIntent{ec569d7: PendingIntentRecord{c33696d cn.showmac.vsimservice broadcastIntent}}</code></pre> 
<pre class="has"><code class="language-java">public class AlarmManager {
    public static final int RTC_WAKEUP = 0;
    public static final int RTC = 1;
    public static final int ELAPSED_REALTIME_WAKEUP = 2;
    public static final int ELAPSED_REALTIME = 3;
}</code></pre> 
<pre class="has"><code class="language-cpp">private class AlarmThread extends Thread
{
        public AlarmThread()
        {
            super("AlarmManager");
        }

        public void run()
        {
            ArrayList&lt;Alarm&gt; triggerList = new ArrayList&lt;Alarm&gt;();

            while (true)
            {
                int result = waitForAlarm(mNativeData);
		        deliverAlarmsLocked();
	    }
   ｝
</code></pre> 
<p>此外,休眠后，系统默认每10min(展讯的15min,看代码定义)唤醒一次系统，更新电池状态，也是通过定时器实现的，代码如下</p> 
<p><a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/health/2.0/default/healthd_common.cpp" rel="nofollow">http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/health/2.0/default/healthd_common.cpp</a></p> 
<pre class="has"><code class="language-cpp">static void wakealarm_init(void) {
    wakealarm_fd = timerfd_create(CLOCK_BOOTTIME_ALARM, TFD_NONBLOCK);
    wakealarm_set_interval(healthd_config.periodic_chores_interval_fast);
}

static int healthd_init() {
    wakealarm_init();
}</code></pre> 
<p>设置成15分钟,从上面的唤醒时间9.45,10:00,10:15,10:30也跟代码的一致。</p> 
<pre class="has"><code class="language-cpp">// Periodic chores fast interval in seconds
#define DEFAULT_PERIODIC_CHORES_INTERVAL_FAST (60 * 1)
// Periodic chores fast interval in seconds
#define DEFAULT_PERIODIC_CHORES_INTERVAL_SLOW (60 * 10)
void healthd_battery_update_internal(bool charger_online) {
    int new_wake_interval = charger_online ? healthd_config.periodic_chores_interval_fast
                                           : healthd_config.periodic_chores_interval_slow;
    if (new_wake_interval != wakealarm_wake_interval) wakealarm_set_interval(new_wake_interval);
}</code></pre> 
<p> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f0afd2968d7729ae383269a89fbe39f8/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">经典圣杯双飞翼布局</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0fd963bf521798e3080c3849ab5b05ac/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Molecular Dynamics</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>