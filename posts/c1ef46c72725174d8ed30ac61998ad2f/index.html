<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>minikube的安装部署使用(service expose端口暴露后访问受限问题) - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="minikube的安装部署使用(service expose端口暴露后访问受限问题)" />
<meta property="og:description" content="minikube的安装部署 环境（centos7 ip-&gt;192.168.44.133） 1.安装docker
docker安装
2.配置docker使用systemd作为默认cgroup驱动，使docker与kubenetes的驱动一致，否则会报错
处理错误参考链接
cat &lt;&lt; EOF &gt;&gt; /etc/docker/daemon.json
{
“exec-opts”:[“native.cgroupdriver=systemd”]
# “exec-opts”:[“native.cgroupdriver=cgroupfs”]
}
3.启动docker
systemctl start docker systemctl enable docker 4.设置阿里的kubeadm源
cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; EOF
[kubernetes]
name=Kubernetes Repo
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
gpgcheck=1
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
enable=1
EOF
5.安装kubeadm等
yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes
6.下载minikube的软件包
curl -Lo minikube http://kubernetes.oss-cn-hangzhou.aliyuncs.com/minikube/releases/v1.2.0/minikube-linux-amd64 &amp;&amp; chmod &#43;x minikube &amp;&amp; sudo mv minikube /usr/local/bin/
7.关闭交换分区
swapoff -a
8.启动minikube( minikube delete删除minikube结点)
minikube start --vm-driver=“none”" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/c1ef46c72725174d8ed30ac61998ad2f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-05-11T18:21:43+08:00" />
<meta property="article:modified_time" content="2021-05-11T18:21:43+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">minikube的安装部署使用(service expose端口暴露后访问受限问题)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="minikube_0"></a>minikube的安装部署</h3> 
<h5><a id="centos7__ip19216844133_1"></a>环境（centos7 ip-&gt;192.168.44.133）</h5> 
<p>1.安装docker<br> <a href="https://blog.csdn.net/Mr_Robot123/article/details/115912913">docker安装</a><br> 2.配置docker使用systemd作为默认cgroup驱动，使docker与kubenetes的驱动一致，否则会报错<br> <a href="https://blog.csdn.net/sinat_28371057/article/details/109895176">处理错误参考链接</a><br> cat &lt;&lt; EOF &gt;&gt; /etc/docker/daemon.json<br> {<!-- --><br> “exec-opts”:[“native.cgroupdriver=systemd”]<br> # “exec-opts”:[“native.cgroupdriver=cgroupfs”]<br> }<br> <img src="https://images2.imgbox.com/1a/b1/nO8oUC1O_o.png" alt="报错信息"></p> 
<p>3.启动docker</p> 
<pre><code class="prism language-powershell">systemctl <span class="token function">start</span> docker
systemctl enable docker 
</code></pre> 
<p>4.设置阿里的kubeadm源<br> cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; EOF<br> [kubernetes]<br> name=Kubernetes Repo<br> baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/<br> gpgcheck=1<br> gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg<br> enable=1<br> EOF</p> 
<p>5.安装kubeadm等<br> yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes</p> 
<p>6.下载minikube的软件包<br> curl -Lo minikube http://kubernetes.oss-cn-hangzhou.aliyuncs.com/minikube/releases/v1.2.0/minikube-linux-amd64 &amp;&amp; chmod +x minikube &amp;&amp; sudo mv minikube /usr/local/bin/</p> 
<p>7.关闭交换分区<br> swapoff -a<br> 8.启动minikube( minikube delete删除minikube结点)<br> minikube start --vm-driver=“none”</p> 
<p><img src="https://images2.imgbox.com/dc/81/8z7HAW6R_o.png" alt="启动成功"><br> deploy用来部署容器的工具</p> 
<pre><code class="prism language-powershell">kubectl create deployment nginx<span class="token operator">-</span>deploy <span class="token operator">--</span>image=nginx <span class="token operator">-</span>r 3
</code></pre> 
<p>deployment名称为 nginx-deploy<br> 使用的镜像为：nginx<br> -r 启动容器的副本数</p> 
<ul><li>kubectl常用命令</li></ul> 
<pre><code class="prism language-powershell"><span class="token comment">#创建部署</span>
kubectl create deployment nginx<span class="token operator">-</span>deploy
<span class="token comment"># 获取pod或结点信息</span>
kubectl get pod<span class="token operator">/</span>node
<span class="token comment"># 获取详细信息</span>
kubectl describle <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment">#获取日志信息</span>
kubectl logs
<span class="token comment"># 查看集群信息</span>
kubectl cluster<span class="token operator">-</span>info
<span class="token comment">#进入容器内部</span>
kubectl exec <span class="token operator">-</span>it <span class="token namespace">[pod_name]</span> <span class="token operator">--</span> <span class="token namespace">[command]</span>
<span class="token comment"># 删除部署</span>
kubectl  delete deployment nginx<span class="token operator">-</span>deploy
</code></pre> 
<h4><a id="service_70"></a>service暴露</h4> 
<p>常见的三种暴露模式<br> ClusterIp<br> NodePort<br> LoadBalancer</p> 
<p>创建deployment</p> 
<pre><code class="prism language-shell">kubectl create deployment my-nginx --image<span class="token operator">=</span>nginx --replicas<span class="token operator">=</span>2
</code></pre> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@minikube<span class="token punctuation">]</span><span class="token comment"># kubectl get deployment</span>
NAME       READY   UP-TO-DATE   AVAILABLE   AGE
my-nginx   2/2     2            2           72s
</code></pre> 
<p>创建服务并暴露端口</p> 
<pre><code class="prism language-powershell">kubectl expose deployment my<span class="token operator">-</span>nginx <span class="token operator">--</span>port=8080 <span class="token operator">--</span>target<span class="token operator">-</span>port=80 <span class="token operator">--</span><span class="token function">type</span>=<span class="token string">"NodePort"</span>
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@minikube]</span><span class="token comment"># kubectl get service</span>
NAME         <span class="token function">TYPE</span>        CLUSTER<span class="token operator">-</span>IP      EXTERNAL<span class="token operator">-</span>IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>          AGE
kubernetes   ClusterIP   10<span class="token punctuation">.</span>96<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1       &lt;none&gt;        443<span class="token operator">/</span>TCP          5h47m
my<span class="token operator">-</span>nginx     NodePort    10<span class="token punctuation">.</span>106<span class="token punctuation">.</span>249<span class="token punctuation">.</span>64   &lt;none&gt;        8080:32463<span class="token operator">/</span>TCP   9s
</code></pre> 
<p>查看服务详细信息</p> 
<pre><code class="prism language-powershell">kubectl describe service my<span class="token operator">-</span>nginx
</code></pre> 
<pre><code class="prism language-powershell">Name:                     my<span class="token operator">-</span>nginx
Namespace:                default
Labels:                   app=my<span class="token operator">-</span>nginx
Annotations:              &lt;none&gt;
Selector:                 app=my<span class="token operator">-</span>nginx
<span class="token function">Type</span>:                     NodePort
IP Families:              &lt;none&gt;
IP:                       10<span class="token punctuation">.</span>106<span class="token punctuation">.</span>249<span class="token punctuation">.</span>64
IPs:                      &lt;none&gt;
Port:                     &lt;unset&gt;  8080<span class="token operator">/</span>TCP
TargetPort:               80<span class="token operator">/</span>TCP
NodePort:                 &lt;unset&gt;  32463<span class="token operator">/</span>TCP
Endpoints:                172<span class="token punctuation">.</span>17<span class="token punctuation">.</span>0<span class="token punctuation">.</span>4:80<span class="token punctuation">,</span>172<span class="token punctuation">.</span>17<span class="token punctuation">.</span>0<span class="token punctuation">.</span>5:80
Session Affinity:         None
External Traffic Policy:  Cluster
Events:                   &lt;none&gt;

</code></pre> 
<p>访问宿主机ip+NodePort无法访问，本机访问正常<br> <img src="https://images2.imgbox.com/2f/45/8bsv33Gd_o.png" alt="本机访问正常"></p> 
<p>估计是iptables规则导致访问受限<br> <img src="https://images2.imgbox.com/f1/86/yVIVBjUE_o.png" alt="查看iptables规则"><br> <img src="https://images2.imgbox.com/52/91/i49saYV8_o.png" alt="问题描述"></p> 
<p>问题解决</p> 
<pre><code class="prism language-powershell">iptables <span class="token operator">-</span>P FORWARD ACCEPT
</code></pre> 
<p><img src="https://images2.imgbox.com/96/ce/aQPW2D75_o.png" alt="访问正常"><br> 疑点：为什么网页数据会经过forward数据转发链，猜测可能与k8s的kube-proxy代理有关</p> 
<p><strong>kube-proxy的三种模式</strong>：</p> 
<p>iptables模式（1.2版本后）<br> ipvs模式（1.8版本后）<br> userspace模式</p> 
<p><strong>动态扩缩容：</strong></p> 
<pre><code class="prism language-powershell">kubectl scale deployment my<span class="token operator">-</span>nginx <span class="token operator">--</span>replicas=3
<span class="token comment">#查看pod的详细信息</span>
kubectl get pod <span class="token operator">-</span>o wide
</code></pre> 
<p><strong>滚动升级</strong></p> 
<pre><code class="prism language-powershell"><span class="token comment"># 创建低版本nginx容器pod</span>
kubectl create deployment my<span class="token operator">-</span>nginx<span class="token operator">-</span>1<span class="token punctuation">.</span>18 <span class="token operator">--</span>image=nginx:1<span class="token punctuation">.</span>18<span class="token punctuation">.</span>0 <span class="token operator">-</span>r 2
<span class="token comment"># 滚动升级</span>
kubectl <span class="token function">set</span> image deployment my<span class="token operator">-</span>nginx<span class="token operator">-</span>1<span class="token punctuation">.</span>18 nginx=nginx:1<span class="token punctuation">.</span>19<span class="token punctuation">.</span>7
<span class="token comment"># 查看镜像版本</span>
kubectl describe pod my<span class="token operator">-</span>nginx<span class="token operator">-</span>1<span class="token punctuation">.</span>18
<span class="token comment"># 查看滚动升级是否成功</span>
kubectl rollout status deployment my<span class="token operator">-</span>nginx<span class="token operator">-</span>1<span class="token punctuation">.</span>18
<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span><span class="token operator">-</span>
&gt;deployment <span class="token string">"my-nginx-1.18"</span> successfully rolled out
<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span><span class="token operator">-</span>
<span class="token comment">#升级不存在的版本会出错</span>
<span class="token comment"># 回滚，撤销版本升级</span>
kubectl rollout undo deployment my<span class="token operator">-</span>nginx<span class="token operator">-</span>1<span class="token punctuation">.</span>18
<span class="token comment">#查看版本信息</span>
kubectl describe pod my<span class="token operator">-</span>nginx<span class="token operator">-</span>1<span class="token punctuation">.</span>18
</code></pre> 
<p><strong>k8s中的namespace</strong><br> 为了防止错误的操作同名服务，可以将不同服务的pod放置到不同的命名空间。</p> 
<pre><code class="prism language-powershell"><span class="token comment"># 查看pod所属命名空间</span>
kubectl get pod <span class="token operator">-</span>A
<span class="token comment"># 查看所有命名空间</span>
kubectl get namespace
</code></pre> 
<p><strong>configmap</strong><br> 相当于一个容器文件,共享数据到pod中的容器内，公共的数据中心</p> 
<p><strong>secret</strong><br> 存放加密信息（密码，密钥，auth认证信息）</p> 
<p><strong>pv与pvc</strong>:<br> pv:实际划分的存储空间<br> pvc:相当于取货单，去pv上申请空间分配<br> 资源部署通过yaml文件</p> 
<pre><code class="prism language-powershell">kubectl apply <span class="token operator">-</span>f  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>yaml
</code></pre> 
<p><a href="https://www.jianshu.com/p/f4ac7f4555d3" rel="nofollow">搭建k8s集群完整篇</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4564eeaa6ac5af3d4aaa2d9cd8c393fd/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">信号完整性之Ansys SIwave_S参数提取（四）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/130ccaf892347de40f32636124663f57/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Cat.1究竟是如何崛起的？中速率到底有什么用？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>