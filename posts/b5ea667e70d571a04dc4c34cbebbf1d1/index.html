<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>查看Oracle数据库资源状况 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="查看Oracle数据库资源状况" />
<meta property="og:description" content="对于Oracle数据库的资源状况，开发人员一般不怎么关注。但是有时候也会遇到，所以这里把相关的SQL做个笔记，方便查看。
​​​​
目录
1. 检查数据库基本状况
2. 检查Oracle相关资源的使用情况
3. 检查Oracle数据库备份结果
4. 检查Oracle数据库性能
5. 检查数据库cpu、I/O、内存性能
6. 检查数据库安全性
7. 其他检查
1. 检查数据库基本状况 1.1. 检查Oracle实例状态
select instance_name, host_name, startup_time, status, database_status from v$instance; 其中“STATUS”表示Oracle当前的实例状态，必须为“OPEN”；“DATABASE_STATUS”表示Oracle当前数据库的状态，必须为“ACTIVE”。 1.2. 检查Oracle在线日志状态
select group, status, type, member from v$logfile; 输出结果应该有3条以上（包含3条）记录，“STATUS”应该为非“INVALID”，非“DELETED”。注：“STATUS”显示为空表示正常。
1.3. 检查Oracle表空间的状态
select tablespace_name, status from dba_tablespaces; 输出结果中STATUS应该都为ONLINE。 1.4. 检查Oracle所有数据文件状态
select name, status from v$datafile; 输出结果中“STATUS”应该都为“ONLINE”。或者：
select file_name, status from dba_data_files; 输出结果中“STATUS”应该都为“AVAILABLE”。
1.5. 检查无效对象
select owner, object_name, object_type from dba_objects where status!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/b5ea667e70d571a04dc4c34cbebbf1d1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-06-18T14:11:52+08:00" />
<meta property="article:modified_time" content="2019-06-18T14:11:52+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">查看Oracle数据库资源状况</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p> </p> 
<p>对于Oracle数据库的资源状况，开发人员一般不怎么关注。但是有时候也会遇到，所以这里把相关的SQL做个笔记，方便查看。</p> 
<p><a name="_labelTop"></a>​​​​</p> 
<p id="main-toc"><strong>目录</strong></p> 
<p id="1.%20%E6%A3%80%E6%9F%A5%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E6%9C%AC%E7%8A%B6%E5%86%B5-toc" style="margin-left:80px;"><a href="#1.%20%E6%A3%80%E6%9F%A5%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E6%9C%AC%E7%8A%B6%E5%86%B5" rel="nofollow">1. 检查数据库基本状况</a></p> 
<p id="2.%20%E6%A3%80%E6%9F%A5Oracle%E7%9B%B8%E5%85%B3%E8%B5%84%E6%BA%90%E7%9A%84%E4%BD%BF%E7%94%A8%E6%83%85%E5%86%B5-toc" style="margin-left:80px;"><a href="#2.%20%E6%A3%80%E6%9F%A5Oracle%E7%9B%B8%E5%85%B3%E8%B5%84%E6%BA%90%E7%9A%84%E4%BD%BF%E7%94%A8%E6%83%85%E5%86%B5" rel="nofollow">2. 检查Oracle相关资源的使用情况</a></p> 
<p id="3.%20%E6%A3%80%E6%9F%A5Oracle%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD%E7%BB%93%E6%9E%9C-toc" style="margin-left:80px;"><a href="#3.%20%E6%A3%80%E6%9F%A5Oracle%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD%E7%BB%93%E6%9E%9C" rel="nofollow">3. 检查Oracle数据库备份结果</a></p> 
<p id="4.%20%E6%A3%80%E6%9F%A5Oracle%E6%95%B0%E6%8D%AE%E5%BA%93%E6%80%A7%E8%83%BD-toc" style="margin-left:80px;"><a href="#4.%20%E6%A3%80%E6%9F%A5Oracle%E6%95%B0%E6%8D%AE%E5%BA%93%E6%80%A7%E8%83%BD" rel="nofollow">4. 检查Oracle数据库性能</a></p> 
<p id="5.%20%E6%A3%80%E6%9F%A5%E6%95%B0%E6%8D%AE%E5%BA%93cpu%E3%80%81I%2FO%E3%80%81%E5%86%85%E5%AD%98%E6%80%A7%E8%83%BD-toc" style="margin-left:80px;"><a href="#5.%20%E6%A3%80%E6%9F%A5%E6%95%B0%E6%8D%AE%E5%BA%93cpu%E3%80%81I%2FO%E3%80%81%E5%86%85%E5%AD%98%E6%80%A7%E8%83%BD" rel="nofollow">5. 检查数据库cpu、I/O、内存性能</a></p> 
<p id="6.%20%E6%A3%80%E6%9F%A5%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E5%85%A8%E6%80%A7-toc" style="margin-left:80px;"><a href="#6.%20%E6%A3%80%E6%9F%A5%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E5%85%A8%E6%80%A7" rel="nofollow">6. 检查数据库安全性</a></p> 
<p id="7.%20%E5%85%B6%E4%BB%96%E6%A3%80%E6%9F%A5-toc" style="margin-left:80px;"><a href="#7.%20%E5%85%B6%E4%BB%96%E6%A3%80%E6%9F%A5" rel="nofollow">7. 其他检查</a></p> 
<hr id="hr-toc"> 
<h4 id="1.%20%E6%A3%80%E6%9F%A5%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E6%9C%AC%E7%8A%B6%E5%86%B5">1. 检查数据库基本状况</h4> 
<p>1.1. 检查Oracle实例状态</p> 
<pre class="has"><code class="language-sql">select instance_name, host_name, startup_time, status, database_status from v$instance; </code></pre> 
<p>其中“STATUS”表示Oracle当前的实例状态，必须为“OPEN”；“DATABASE_STATUS”表示Oracle当前数据库的状态，必须为“ACTIVE”。 </p> 
<p>1.2. 检查Oracle在线日志状态</p> 
<pre class="has"><code class="language-sql">select group, status, type, member from v$logfile; </code></pre> 
<p>输出结果应该有3条以上（包含3条）记录，“STATUS”应该为非“INVALID”，非“DELETED”。注：“STATUS”显示为空表示正常。</p> 
<p>1.3. 检查Oracle表空间的状态</p> 
<pre class="has"><code class="language-sql">select tablespace_name, status from dba_tablespaces; </code></pre> 
<p>输出结果中STATUS应该都为ONLINE。 </p> 
<p>1.4. 检查Oracle所有数据文件状态</p> 
<pre class="has"><code class="language-sql">select name, status from v$datafile;</code></pre> 
<p> 输出结果中“STATUS”应该都为“ONLINE”。或者：</p> 
<pre class="has"><code class="language-sql">select file_name, status from dba_data_files; </code></pre> 
<p> 输出结果中“STATUS”应该都为“AVAILABLE”。</p> 
<p>1.5. 检查无效对象</p> 
<pre class="has"><code class="language-sql">select owner, object_name, object_type from dba_objects 
where status!='VALID' and owner!='SYS' and owner!='SYSTEM';</code></pre> 
<p>如果有记录返回，则说明存在无效对象。若这些对象与应用相关，那么需要重新编译生成这个对象，或者： </p> 
<pre class="has"><code class="language-sql">select owner, object_name, object_type from dba_objects where status= 'INVALID';</code></pre> 
<p>1.6. 检查所有回滚段状态</p> 
<pre class="has"><code class="language-sql">select segment_name, status from dba_rollback_segs;</code></pre> 
<p> 输出结果中所有回滚段的“STATUS”应该为“ONLINE”。</p> 
<h4 id="2.%20%E6%A3%80%E6%9F%A5Oracle%E7%9B%B8%E5%85%B3%E8%B5%84%E6%BA%90%E7%9A%84%E4%BD%BF%E7%94%A8%E6%83%85%E5%86%B5">2. 检查Oracle相关资源的使用情况</h4> 
<p>2.1. 检查Oracle初始化文件中相关参数值</p> 
<pre class="has"><code class="language-sql">select resource_name, max_utilization, initial_allocation, limit_value from v$resource_limit;</code></pre> 
<p>若LIMIT_VALU-MAX_UTILIZATION&lt;=5，则表明与RESOURCE_NAME相关的Oracle初始化参数需要调整。可以通过修改Oracle初始化参数文件$ORACLE_BASE/admin/CKDB/pfile/initORCL.ora来修改。 </p> 
<p>2.2. 检查数据库连接情况</p> 
<p>查看当前会话连接数，是否属于正常范围。 </p> 
<pre class="has"><code class="language-sql">select count(*) from v$session;

select sid, serial#, username, program, machine, status from v$session;</code></pre> 
<p>其中：SID 会话(session)的ID号；SERIAL# 会话的序列号，和SID一起用来唯一标识一个会话；USERNAME 建立该会话的用户名；PROGRAM 这个会话是用什么工具连接到数据库的；STATUS 当前这个会话的状态，ACTIVE表示会话正在执行某些任务，INACTIVE表示当前会话没有执行任何操作；如果建立了过多的连接，会消耗数据库的资源，同时，对一些“挂死”的连接可能需要手工进行清理。<br> 如果DBA要手工断开某个会话，则执行：（一般不建议使用这种方式去杀掉数据库的连接，这样有时候session不会断开。容易引起死连接。建议通过sid查到操作系统的spid,使用ps –ef|grep spidno的方式确认spid不是ORACLE的后台进程。使用操作系统的kill -9命令杀掉连接）alter system kill session 'SID,SERIAL#';注意：上例中SID为1到10(USERNAME列为空)的会话，是Oracle的后台进程，不要对这些会话进行任何操作。 </p> 
<p>2.3. 检查系统磁盘空间</p> 
<p>如果文件系统的剩余空间过小或增长较快，需对其进行确认并删除不用的文件以释放空间。 </p> 
<pre class="has"><code class="language-bash">[oracle@AS14 ~]$ df -h

Filesystem Size Used Avail Use% Mounted on

/dev/sda5 9.7G 3.9G 5.4G 42% /

/dev/sda1 479M 16M 438M 4% /boot

/dev/sda2 49G 19G 28G 41% /data

none 1014M 0 1014M 0% /dev/shm</code></pre> 
<p>2.4. 检查表空间使用情况</p> 
<pre class="has"><code class="language-sql">select f.tablespace_name, a.total, f.free, round((f.free / a.total) * 100) "% Free"
from (select tablespace_name, sum(bytes / (1024 * 1024)) total from dba_data_files 
    group by tablespace_name) a, 
(select tablespace_name, round(sum(bytes / (1024 * 1024))) free from dba_free_space
    group by tablespace_name) f
WHERE a.tablespace_name = f.tablespace_name(+)
order by "% Free";</code></pre> 
<p>如果空闲率%Free小于10%以上（包含10%），则注意要增加数据文件来扩展表空间而不要是用数据文件的自动扩展功能。请不要对表空间增加过多的数据文件，增加数据文件的原则是每个数据文件大小为2G或者4G，自动扩展的最大限制在8G。</p> 
<p>2.5. 检查一些扩展异常的对象</p> 
<pre class="has"><code class="language-sql">select Segment_Name, Segment_Type, TableSpace_Name, (Extents / Max_extents) * 100 Percent
From sys.DBA_Segments
Where Max_Extents != 0 and (Extents / Max_extents) * 100 &gt;= 95
order By Percent;</code></pre> 
<p>如果有记录返回，则这些对象的扩展已经快达到它定义时的最大扩展值。对于这些对象要修改它的存储结构参数。 </p> 
<p>2.6. 检查system表空间内的内容</p> 
<pre class="has"><code class="language-sql">select distinct (owner) from dba_tables 
    where tablespace_name = 'SYSTEM' and owner != 'SYS' and owner != 'SYSTEM'
union
select distinct (owner) from dba_indexes 
    where tablespace_name = 'SYSTEM' and owner != 'SYS' and owner != 'SYSTEM';</code></pre> 
<p>如果有记录返回，则表明system表空间内存在一些非system和sys用户的对象。应该进一步检查这些对象是否与我们应用相关。如果相关请把这些对象移到非System表空间，同时应该检查这些对象属主的缺省表空间值。 </p> 
<p>2.7. 检查对象的下一扩展与表空间的最大扩展值</p> 
<pre class="has"><code class="language-sql">select a.table_name, a.next_extent, a.tablespace_name from all_tables a, 
(select tablespace_name, max(bytes) as big_chunk from dba_free_space group by tablespace_name) f
where f.tablespace_name = a.tablespace_name and a.next_extent &gt; f.big_chunk
union
select a.index_name, a.next_extent, a.tablespace_name from all_indexes a, 
(select tablespace_name, max(bytes) as big_chunk from dba_free_space group by tablespace_name) f
where f.tablespace_name = a.tablespace_name and a.next_extent &gt; f.big_chunk;</code></pre> 
<p>如果有记录返回，则表明这些对象的下一个扩展大于该对象所属表空间的最大扩展值，需调整相应表空间的存储参数。 </p> 
<h4 id="3.%20%E6%A3%80%E6%9F%A5Oracle%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD%E7%BB%93%E6%9E%9C">3. 检查Oracle数据库备份结果</h4> 
<p><br> 3.1. 检查数据库备份日志信息</p> 
<p>假设：备份的临时目录为/backup/hotbakup，我们需要检查2009年7月22日的备份结果，则用下面的命令来检查：</p> 
<pre class="has"><code class="language-bash">cat /backup/hotbackup/hotbackup-09-7-22.log|grep –i error</code></pre> 
<p><br> 备份脚本的日志文件为hotbackup-月份-日期-年份.log，在备份的临时目录下面。如果文件中存在“ERROR:”，则表明备份没有成功，存在问题需要检查。 </p> 
<p>3.2. 检查backup卷中文件产生的时间</p> 
<pre class="has"><code class="language-bash">#ls –lt /backup/hotbackup</code></pre> 
<p><br> backup卷是备份的临时目录，查看输出结果中文件的日期，都应当是在当天凌晨由热备份脚本产生的。如果时间不对则表明热备份脚本没执行成功。 </p> 
<p>3.3. 检查oracle用户的email</p> 
<pre class="has"><code class="language-bash">#tail –n 300 /var/mail/oracle</code></pre> 
<p>热备份脚本是通过Oracle用户的cron去执行的。cron执行完后操作系统就会发一条Email通知Oracle用户任务已经完成。查看Oracle email中今天凌晨部分有无ORA-，Error，Failed等出错信息，如果有则表明备份不正常。 </p> 
<h4 id="4.%20%E6%A3%80%E6%9F%A5Oracle%E6%95%B0%E6%8D%AE%E5%BA%93%E6%80%A7%E8%83%BD">4. 检查Oracle数据库性能</h4> 
<p>在本节主要检查Oracle数据库性能情况，包含：检查数据库的等待事件，检查死锁及处理，检查cpu、I/O、内存性能，查看是否有僵死进程，检查行链接/迁移，定期做统计分析，检查缓冲区命中率，检查共享池命中率，检查排序区，检查日志缓冲区，总共十个部分。 </p> 
<p>4.1. 检查数据库的等待事件</p> 
<pre class="has"><code class="language-sql">set pages 80
set lines 120
col event for a40

select sid, event, p1, p2, p3, WAIT_TIME, SECONDS_IN_WAIT
from v$session_wait
where event not like 'SQL%' and event not like 'rdbms%';</code></pre> 
<p>如果数据库长时间持续出现大量像latch free，enqueue，buffer busy waits，db file sequential read，db file scattered read等等待事件时，需要对其进行分析，可能存在问题的语句 </p> 
<p>4.2. Disk Read最高的SQL语句的获取</p> 
<pre class="has"><code class="language-sql">SELECT SQL_TEXT 
FROM (SELECT * FROM V$SQLAREA ORDER BY DISK_READS) 
WHERE ROWNUM &lt;= 5;</code></pre> 
<p>4.3. 查找前十条性能差的sql</p> 
<pre class="has"><code class="language-sql">SELECT *
FROM (SELECT PARSING_USER_ID, EXECUTIONS, SORTS, COMMAND_TYPE, DISK_READS, SQL_TEXT 
FROM V$SQLAREA ORDER BY DISK_READS DESC)
WHERE ROWNUM &lt; 10;</code></pre> 
<p>4.4. 等待时间最多的5个系统等待事件的获取</p> 
<pre class="has"><code class="language-sql">SELECT *
FROM (SELECT *FROM V$SYSTEM_EVENT WHERE EVENT NOT LIKE 'SQL%' ORDER BY TOTAL_WAITS DESC)
WHERE ROWNUM &lt;= 5;</code></pre> 
<p>4.5. 检查运行很久的SQL</p> 
<pre class="has"><code class="language-sql">COLUMN USERNAME FORMAT A12
COLUMN OPNAME FORMAT A16
COLUMN PROGRESS FORMAT A8

SELECT USERNAME, 
       SID, 
       OPNAME, 
       ROUND(SOFAR * 100 / TOTALWORK, 0) || '%' AS PROGRESS,
       TIME_REMAINING, 
       SQL_TEXT
FROM V$SESSION_LONGOPS, V$SQL
WHERE TIME_REMAINING &lt;&gt; 0 AND SQL_ADDRESS = ADDRESS AND SQL_HASH_VALUE = HASH_VALUE;</code></pre> 
<p>4.6. 检查消耗CPU最高的进程</p> 
<pre class="has"><code class="language-sql">SET LINE 240
SET VERIFY OFF
COLUMN SID FORMAT 999
COLUMN PID FORMAT 999
COLUMN S_# FORMAT 999
COLUMN USERNAME FORMAT A9 HEADING "ORA USER"
COLUMN PROGRAM FORMAT A29
COLUMN SQL FORMAT A60
COLUMN OSNAME FORMAT A9 HEADING "OS USER"

SELECT P.PID PID,
       S.SID SID,
       P.SPID SPID,
       S.USERNAME USERNAME,
       S.OSUSER OSNAME,
       P.SERIAL# S_#,
       P.TERMINAL,
       P.PROGRAM PROGRAM,
       P.BACKGROUND,
       S.STATUS,
       RTRIM(SUBSTR(A.SQL_TEXT, 1, 80)) SQL
FROM V$PROCESS P, V$SESSION S, V$SQLAREA A 
WHERE P.ADDR = S.PADDR AND S.SQL_ADDRESS = A.ADDRESS(+) AND P.SPID LIKE '%&amp;1%';</code></pre> 
<p>4.7. 检查碎片程度高的表</p> 
<pre class="has"><code class="language-sql">SELECT segment_name table_name, COUNT(*) extents
FROM dba_segments
WHERE owner NOT IN ('SYS', 'SYSTEM')
GROUP BY segment_name
HAVING COUNT(*) = (SELECT MAX(COUNT(*)) FROM dba_segments GROUP BY segment_name);</code></pre> 
<p>4.8. 检查表空间的I/O比例</p> 
<pre class="has"><code class="language-sql">SELECT DF.TABLESPACE_NAME NAME,
       DF.FILE_NAME       "FILE",
       F.PHYRDS           PYR,
       F.PHYBLKRD         PBR,
       F.PHYWRTS          PYW,
       F.PHYBLKWRT        PBW
FROM V$FILESTAT F, DBA_DATA_FILES DF
WHERE F.FILE# = DF.FILE_ID
ORDER BY DF.TABLESPACE_NAME; </code></pre> 
<p>4.9. 检查文件系统的I/O比例</p> 
<pre class="has"><code class="language-sql">SELECT SUBSTR(A.FILE#, 1, 2) "#",
       SUBSTR(A.NAME, 1, 30) "NAME",
       A.STATUS,
       A.BYTES,
       B.PHYRDS,
       B.PHYWRTS
FROM V$DATAFILE A, V$FILESTAT B
WHERE A.FILE# = B.FILE#; </code></pre> 
<p>4.10.检查死锁及处理</p> 
<p>查询目前锁对象信息： </p> 
<pre class="has"><code class="language-sql">select sid,
       serial#,
       username,
       SCHEMANAME,
       osuser,
       MACHINE,     
       terminal,
       PROGRAM,
       owner,
       object_name,
       object_type,
       o.object_id
from dba_objects o, v$locked_object l, v$session s
where o.object_id = l.object_id and s.sid = l.session_id; </code></pre> 
<p>oracle级kill掉该session： </p> 
<pre class="has"><code class="language-sql">alter system kill session '&amp;sid,&amp;serial#';</code></pre> 
<p>操作系统级kill掉session： </p> 
<pre class="has"><code class="language-bash">#&gt;kill -9 pid</code></pre> 
<h4 id="5.%20%E6%A3%80%E6%9F%A5%E6%95%B0%E6%8D%AE%E5%BA%93cpu%E3%80%81I%2FO%E3%80%81%E5%86%85%E5%AD%98%E6%80%A7%E8%83%BD">5. 检查数据库cpu、I/O、内存性能</h4> 
<p>记录数据库的cpu使用、IO、内存等使用情况，使用vmstat,iostat,sar,top等命令进行信息收集并检查这些信息，判断资源使用情况。 </p> 
<p>5.1 CPU使用情况：</p> 
<pre class="has"><code class="language-bash">[root@sale8 ~]# top

top - 10:29:35 up 73 days, 19:54, 1 user, load average: 0.37, 0.38, 0.29

Tasks: 353 total, 2 running, 351 sleeping, 0 stopped, 0 zombie

Cpu(s): 1.2% us, 0.1% sy, 0.0% ni,98.8% id, 0.0% wa, 0.0% hi, 0.0% si

Mem: 16404472k total, 12887428k used, 3517044k free, 60796k buffers

Swap: 8385920k total, 665576k used, 7720344k free, 10358384k cached


PID USER PR NI VIRT RES SHR S %CPU %MEM TIME+ COMMAND

30495 oracle 15 0 8329m 866m 861m R 10 5.4 7:53.90 oracle

32501 oracle 15 0 8328m 1.7g 1.7g S 2 10.6 1:58.38 oracle

32503 oracle 15 0 8329m 1.6g 1.6g S 2 10.2 2:06.62 oracle</code></pre> 
<p>当系统剩余的cpu平均值下降至10%以下的时视为CPU使用率异常，需记录下该数值，并将状态记为异常。 </p> 
<p>5.2 内存使用情况：</p> 
<pre class="has"><code># free -m

total used free shared buffers cached

Mem: 2026 1958 67 0 76 1556

-/+ buffers/cache: 326 1700

Swap: 5992 92 5900</code></pre> 
<p>当剩余内存低于总内存的10%时视为异常。 </p> 
<p>5.3 系统I/O情况：</p> 
<pre class="has"><code class="language-bash"># iostat -k 1 3

Linux 2.6.9-22.ELsmp (AS14) 07/29/2009


avg-cpu: %user %nice %sys%iowait %idle

0.16 0.00 0.05 0.36 99.43


Device: tps kB_read/s kB_wrtn/s kB_read kB_wrtn

sda 3.33 13.16 50.25 94483478 360665804


avg-cpu: %user %nice %sys%iowait %idle

0.00 0.00 0.00 0.00 100.00


Device: tps kB_read/s kB_wrtn/s kB_read kB_wrtn

sda 0.00 0.00 0.00 0 0</code></pre> 
<p>5.4 系统负载情况：</p> 
<pre class="has"><code class="language-bash">#uptime

12:08:37 up 162 days, 23:33, 15 users, load average: 0.01, 0.15, 0.10</code></pre> 
<p>如上所示，后面的3个数值如果有高于2.5的时候就表明系统在超负荷运转了，并将此值记录到巡检表，视为异常。 </p> 
<p>5.5.查看是否有僵死进程</p> 
<pre class="has"><code class="language-sql">select spid from v$process where addr not in (select paddr from v$session); </code></pre> 
<p>有些僵尸进程有阻塞其他业务的正常运行，定期杀掉僵尸进程。 </p> 
<p>5.6.检查行链接/迁移</p> 
<pre class="has"><code class="language-sql">select table_name, num_rows, chain_cnt
From dba_tables
Where owner = 'CTAIS2' And chain_cnt &lt;&gt; 0; </code></pre> 
<p>注：含有long raw列的表有行链接是正常的,找到迁移行保存到chained_rows表中,如没有该表执行../rdbms/admin/utlchain.sql </p> 
<pre class="has"><code class="language-sql">analyze table tablename list chained rows;</code></pre> 
<p>可通过表chained_rows中table_name,head_rowid看出哪些行是迁移行 </p> 
<pre class="has"><code class="language-sql">create table aa 
as select a.* from sb_zsxx a, chained_rows b where a.rowid=b.head_rowid and b.table_name ='SB_ZSXX';

delete from sb_zsxx where rowid in (select head_rowid from chained_rows where table_name = 'SB_ZSXX');

insert into sb_zsxx select * from chained_row where table_name = 'SB_ZSXX';</code></pre> 
<p>5.7 定期做统计分析</p> 
<p>对于采用Oracle Cost-Based-Optimizer的系统，需要定期对数据对象的统计信息进行采集更新，使优化器可以根据准备的信息作出正确的explain plan。在以下情况更需要进行统计信息的更新：<br> a. 应用发生变化<br> b. 大规模数据迁移、历史数据迁出、其他数据的导入等<br> c .数据量发生变化<br> 查看表或索引的统计信息是否需更新，如：</p> 
<pre class="has"><code class="language-sql">Select table_name, num_rows, last_analyzed 
From user_tables where table_name ='DJ_NSRXX'

select count(*) from DJ_NSRXX</code></pre> 
<p>如果行数相差很多,则该表需要更新统计信息，建议一周做一次统计信息收集，如： </p> 
<pre class="has"><code class="language-sql">exec sys.dbms_stats.gather_schema_stats(ownname=&gt;'CTAIS2',cascade =&gt; TRUE,degree =&gt; 4);</code></pre> 
<p>5.8 检查缓冲区命中率</p> 
<pre class="has"><code class="language-sql">SELECT a.VALUE + b.VALUE logical_reads,
       c.VALUE phys_reads,
       round(100 * (1 - c.value / (a.value + b.value)), 4) hit_ratio
FROM v$sysstat a, v$sysstat b, v$sysstat c
WHERE a.NAME = 'db block gets' AND b.NAME = 'consistent gets' AND c.NAME = 'physical reads';</code></pre> 
<p>如果命中率低于90%则需加大数据库参数db_cache_size。 </p> 
<p>5.9 检查共享池命中率</p> 
<pre class="has"><code class="language-sql">select sum(pinhits) / sum(pins) * 100 from v$librarycache; </code></pre> 
<p>如低于95%，则需要调整应用程序使用绑定变量，或者调整数据库参数shared pool的大小。 </p> 
<p>5.10 检查排序区</p> 
<pre class="has"><code class="language-sql">select name,value from v$sysstat where name like '%sort%'; </code></pre> 
<p>如果disk/(memoty+row)的比例过高，则需要调整sort_area_size(workarea_size_policy=false)或pga_aggregate_target(workarea_size_policy=true)。 </p> 
<p>5.11 检查日志缓冲区</p> 
<pre class="has"><code class="language-sql">select name,value from v$sysstat where name in ('redo entries','redo buffer allocation retries');</code></pre> 
<p>如果redo buffer allocation retries/redo entries超过1%，则需要增大log_buffer。 </p> 
<h4 id="6.%20%E6%A3%80%E6%9F%A5%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E5%85%A8%E6%80%A7">6. 检查数据库安全性</h4> 
<p>在本节主要检查Oracle数据库的安全性，包含：检查系统安全信息，定期修改密码，总共两个部分。</p> 
<p>6.1. 检查系统安全日志信息</p> 
<p>系统安全日志文件的目录在/var/log下，主要检查登录成功或失败的用户日志信息。<br> 检查登录成功的日志：</p> 
<pre class="has"><code class="language-bash">[root@rac2 ~]# grep -i accepted /var/log/secure
Jan 8 08:44:43 rac2 sshd[29559]: Accepted password for root from ::ffff:10.10.10.6 port 1119 ssh2……</code></pre> 
<p>检查登录失败的日志： </p> 
<pre class="has"><code class="language-bash">[root@rac2 ~]# grep -i inval /var/log/secure &amp;&amp;grep -i failed /var/log/secure

Jan 9 10:30:44 rac2 sshd[3071]: Invalid user ydbuser from ::ffff:192.168.3.5

Jan 9 10:30:56 rac2 sshd[3071]: Failed password for invalid user ydbuser from ::ffff:192.168.3.5 port 36005 ssh2

Jan 9 10:30:56 rac2 sshd[3071]: Failed password for invalid user ydbuser from ::ffff:192.168.3.5 port 36005 ssh2

Jan 10 22:44:38 rac2 sshd[21611]: Failed password for root from ::ffff:10.10.10.6 port 1723 ssh2</code></pre> 
<p>在出现的日志信息中没有错误(Invalid、refused)提示，如果没有(Invalid、refused)视为系统正常，出现错误提示，应作出系统告警通知。 </p> 
<p>6.2. 检查用户修改密码</p> 
<p>在数据库系统上往往存在很多的用户，如：第三方数据库监控系统，初始安装数据库时的演示用户，管理员用户等等，这些用户的密码往往是写定的，被很多人知道，会被别有用心的人利用来攻击系统甚至进行修改数据。需要修改密码的用户包括：<br> 数据库管理员用户SYS，SYSTEM；其他用户。<br> 登陆系统后，提示符下输入cat /etc/passwd，在列出来的用户中查看是否存在已经不再使用的或是陌生的帐号。若存在，则记录为异常。</p> 
<p>修改密码方法：</p> 
<pre class="has"><code class="language-sql">alter user USER_NAME identified by PASSWORD; </code></pre> 
<h4 id="7.%20%E5%85%B6%E4%BB%96%E6%A3%80%E6%9F%A5">7. 其他检查</h4> 
<p>在本节主要检查当前crontab任务是否正常，检查Oracle Job是否有失败等共六个部分。 </p> 
<p>7.1 检查当前crontab任务是否正常</p> 
<pre class="has"><code class="language-bash">[oracle@AS14 ~]$ crontab -l</code></pre> 
<p>7.2 Oracle Job是否有失败</p> 
<pre class="has"><code class="language-sql">select job, what, last_date, next_date, failures, broken 
from dba_jobs Where schema_user='CAIKE';</code></pre> 
<p>如有问题建议重建job，如：</p> 
<pre class="has"><code class="language-sql">exec sys.dbms_job.remove(1);
commit;
exec sys.dbms_job.isubmit(1,'REFRESH_ALL_SNAPSHOT;',SYSDATE+1/1440,'SYSDATE+4/1440');
commit;</code></pre> 
<p>7.3. 监控数据量的增长情况</p> 
<pre class="has"><code class="language-sql">select A.tablespace_name, (1 - (A.total) / B.total) * 100 used_percent
from (select tablespace_name, sum(bytes) total from dba_free_space group by tablespace_name) A,
(select tablespace_name, sum(bytes) total from dba_data_files group by tablespace_name) B
where A.tablespace_name = B.tablespace_name;</code></pre> 
<p>根据本周每天的检查情况找到空间扩展很快的数据库对象,并采取相应的措施：<br> --删除历史数据<br> 移动规定数据库中至少保留6个月的历史数据，所以以前的历史数据可以考虑备份然后进行清除以便释放其所占的资源空间。<br> ---扩表空间 </p> 
<pre class="has"><code class="language-sql">alter tablespace &lt;tablespace_name&gt; add datafile ‘&lt;file&gt;’ size &lt;size&gt; autoextend off;</code></pre> 
<p>注意：在数据库结构发生变化时，如增加了表空间，增加了数据文件或重做日志文件这些操作，都会造成Oracle数据库控制文件的变化，DBA应及进行控制文件的备份，备份方法是：<br> 执行SQL语句： </p> 
<pre class="has"><code class="language-sql">alter database backup controlfile to '/home/backup/control.bak';</code></pre> 
<p>或： </p> 
<pre class="has"><code class="language-sql">alter database backup controlfile to trace;</code></pre> 
<p>这样，会在USER_DUMP_DEST(初始化参数文件中指定)目录下生成创建控制文件的SQL命令。 </p> 
<p>7.4. 检查失效的索引</p> 
<pre class="has"><code class="language-sql">select index_name, table_name, tablespace_name, status
From dba_indexes 
Where owner = 'CTAIS2' And status &lt;&gt; 'VALID';</code></pre> 
<p>注：分区表上的索引status为N/A是正常的，如有失效索引则对该索引做rebuild，如：</p> 
<pre class="has"><code class="language-sql">alter index INDEX_NAME rebuild tablespace TABLESPACE_NAME; </code></pre> 
<p>7.5. 检查不起作用的约束</p> 
<pre class="has"><code class="language-sql">SELECT owner, constraint_name, table_name, constraint_type, status
FROM dba_constraints
WHERE status = 'DISABLE' and constraint_type = 'P';</code></pre> 
<p>如有失效约束则启用，如： </p> 
<pre class="has"><code class="language-sql">alter Table TABLE_NAME Enable Constraints CONSTRAINT_NAME;</code></pre> 
<p>7.6. 检查无效的trigger</p> 
<pre class="has"><code class="language-sql">SELECT owner, trigger_name, table_name, status FROM dba_triggers WHERE status = 'DISABLED';</code></pre> 
<p>如有失效触发器则启用，如： </p> 
<pre class="has"><code class="language-sql">alter Trigger TRIGGER_NAME Enable; </code></pre> 
<p> </p> 
<p>本文参考博客<a href="https://www.cnblogs.com/java-class/p/4979798.html#_label1" rel="nofollow">https://www.cnblogs.com/java-class/p/4979798.html#_label1</a>整理而成。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/af84c131146fcf22e508a69f85a54633/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Pandas数据处理之数据取值与选择</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e8f0d1561d0e2f51bc22891517979ded/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">代码签名证书购买及使用步骤  不同品牌代码签名证书的区别</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>