<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>用命令行方式给kvm虚拟机扩容的操作过程 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="用命令行方式给kvm虚拟机扩容的操作过程" />
<meta property="og:description" content="给KVM虚拟机ubuntu系统扩容，用图形界面 gparted 工具是很容易了，但受限于宿主机内存不足，无法运行图形界面，因此需用命令行方式解决。
然而查找了很多网上的教程，扩容完 /dev/vda 之后，就直接 lvextend 扩容逻辑卷。我使用后依然没有扩容效果。
其实上述两个操作之间需要补充扩容物理卷和格式化操作。此文将记录完整过程。
扩容前磁盘使用状态 扩容操作过程 1. 运行虚拟机，在宿主机上给虚拟机镜像扩容 命令： cd /var/lib/libvirt/images/ virsh start ubuntu20.04-worker virsh blockresize --path /var/lib/libvirt/images/ubuntu20.04-worker.qcow2 --size 40G ubuntu20.04-worker 2. 进入虚拟机中进行扩容操作 1）使用 fdisk -l 查看磁盘空间，可以看到 /dev/vda 设备已经扩到40G，其中已分配的有25G ：
2）使用 growpart /dev/vda 3 命令扩容磁盘设备，之后再次查看磁盘/dev/vda 设备已经分配了40G：
尽管 /dev/vda3 已经扩容，但根目录是挂载在 /dev/mapper/ubuntu--vg-ubuntu--lv 分区的，而它是位于 /dev/vda3 中的，但是为什么到现在还是23G呢？使用 lsblk 命令可以看到，目前 /dev/vda3 中增加的磁盘空间并未格式化成 lvm 类型，因此 ubuntu--vg-ubuntu--lv 分区依然是23G。接着使用 pvs 命令看到物理卷的可用区间是0。
因此我们需要先让新增的空间变成物理卷认可的空间，然后才能给 /dev/mapper/ubuntu--vg-ubuntu--lv 分区扩容：
3）使用 pvresize /dev/vda3 命令将新增的磁盘空间添加到物理卷中，接着再用 pvs 查看，现在可以看到 PFree 已经不是0了：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/4a2f5e285b835ed9b8380749ab631835/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-15T15:32:49+08:00" />
<meta property="article:modified_time" content="2023-08-15T15:32:49+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">用命令行方式给kvm虚拟机扩容的操作过程</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>        给KVM虚拟机ubuntu系统扩容，用图形界面 gparted 工具是很容易了，但受限于宿主机内存不足，无法运行图形界面，因此需用命令行方式解决。</p> 
<p>        然而查找了很多网上的教程，扩容完 /dev/vda 之后，就直接 lvextend 扩容逻辑卷。我使用后依然没有扩容效果。</p> 
<p>        其实上述两个操作之间需要补充扩容物理卷和格式化操作。此文将记录完整过程。</p> 
<h2 style="background-color:transparent;">扩容前磁盘使用状态</h2> 
<p style="text-align:center;"><img alt="" height="305" src="https://images2.imgbox.com/46/b1/Xzn9EyDv_o.png" width="619"></p> 
<h2>扩容操作过程</h2> 
<h3>1. 运行虚拟机，在宿主机上给虚拟机镜像扩容</h3> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/df/5b/eIZgWuVn_o.png"></p> 
<p>   命令： </p> 
<pre><code class="language-bash">cd /var/lib/libvirt/images/

virsh start ubuntu20.04-worker

virsh blockresize --path /var/lib/libvirt/images/ubuntu20.04-worker.qcow2 --size 40G ubuntu20.04-worker</code></pre> 
<h3>2. 进入虚拟机中进行扩容操作</h3> 
<p>        1）使用<span style="background-color:#d7d8d9;"> fdisk -l </span>查看磁盘空间，可以看到 /dev/vda 设备已经扩到40G，其中已分配的有25G ：</p> 
<p style="text-align:center;"><img alt="" height="825" src="https://images2.imgbox.com/22/1e/KaSkbaGD_o.png" width="672"></p> 
<p>        2）使用<span style="background-color:#d7d8d9;"> growpart   /dev/vda   3 </span>命令扩容磁盘设备，之后再次查看磁盘/dev/vda 设备已经分配了40G：</p> 
<p style="text-align:center;"><img alt="" height="788" src="https://images2.imgbox.com/68/3b/B3AbJtNB_o.png" width="673"></p> 
<p>             尽管 /dev/vda3 已经扩容，但根目录是挂载在<strong> /dev/mapper/ubuntu--vg-ubuntu--lv </strong>分区的，而它是位于 /dev/vda3 中的，但是为什么到现在还是23G呢？使用<span style="background-color:#d7d8d9;"> lsblk </span>命令可以看到，目前 /dev/vda3 中增加的磁盘空间并未格式化成 lvm 类型，因此 ubuntu--vg-ubuntu--lv 分区依然是23G。接着使用 pvs 命令看到物理卷的可用区间是0。</p> 
<p>             因此我们需要先让新增的空间变成物理卷认可的空间，然后才能给 /dev/mapper/ubuntu--vg-ubuntu--lv 分区扩容：</p> 
<p style="text-align:center;"><img alt="" height="369" src="https://images2.imgbox.com/03/07/G2oSJTlF_o.png" width="672"></p> 
<p>        3）使用<span style="background-color:#d7d8d9;"> pvresize /dev/vda3 </span>命令将新增的磁盘空间添加到物理卷中，接着再用 pvs 查看，现在可以看到 PFree 已经不是0了：</p> 
<p style="text-align:center;"><img alt="" height="390" src="https://images2.imgbox.com/88/28/VVOiQUjz_o.png" width="671"></p> 
<p>        4）扩容逻辑卷 ubuntu--vg-ubuntu--lv ，并使用 resize2fs 格式化：</p> 
<p style="text-align:center;"> <img alt="" height="331" src="https://images2.imgbox.com/ba/34/0bjGGiPf_o.png" width="665"></p> 
<p>        命令：</p> 
<pre><code class="language-bash">lvextend -l +100%FREE /dev/mapper/ubuntu--vg-ubuntu--lv

resize2fs /dev/mapper/ubuntu--vg-ubuntu--lv</code></pre> 
<h2 style="background-color:transparent;">扩容后磁盘使用状态：</h2> 
<p style="text-align:center;"><img alt="" height="327" src="https://images2.imgbox.com/03/2f/pzqqdhbs_o.png" width="665"></p> 
<p> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d29f6572d843e637f7f5ae9ee6ee1ac8/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">视频播放相关记录</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4be07e793809831d40c2628ad9c776a3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">LaTeX详细教程&#43;技巧总结</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>