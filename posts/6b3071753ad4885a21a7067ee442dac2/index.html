<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>yolov5的推理输出detect.py部分 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="yolov5的推理输出detect.py部分" />
<meta property="og:description" content="文章目录 前言detect.py1.输入参数2.设置文件保存路径3.加载训练好的模型权重4.数据处理5.进行推理6.yolov5里的nms 总结yolov5 系列 前言 推理阶段是整个检测模型完成后，要对模型进行测试的部分。很重要的一部分，只有了解了这个部分，才能在比赛或者项目提交中很好的输出自己模型的检测结果。同时，推理输出对模型部署在不同的环境下也是十分重要的。
源码：https://github.com/ultralytics/yolov5
版本yolov5 v6.1
detect.py 1.输入参数 @torch.no_grad() # 装饰器，推理部分不进行反向传播计算 def run( weights=ROOT / &#39;yolov5s.pt&#39;, # 加载的训练模型权重路径 source=ROOT / &#39;data/images&#39;, # 输入图像或视频文件路径 data=ROOT / &#39;data/coco128.yaml&#39;, # dataset.yaml path，自己生成的数据集yaml文件路径 imgsz=(640, 640), # inference size (height, width) conf_thres=0.25, # confidence threshold iou_thres=0.45, # NMS IOU threshold max_det=1000, # maximum detections per image，默认一张图最多输出1000个目标 device=&#39;&#39;, # cuda device, i.e. 0 or 0,1,2,3 or cpu，选择推理输出的设备 view_img=False, # show results，推理后是否展示结果图片 save_txt=False, # save results to *." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/6b3071753ad4885a21a7067ee442dac2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-24T21:36:02+08:00" />
<meta property="article:modified_time" content="2022-12-24T21:36:02+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">yolov5的推理输出detect.py部分</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_5" rel="nofollow">前言</a></li><li><a href="#detectpy_9" rel="nofollow">detect.py</a></li><li><ul><li><ul><li><a href="#1_10" rel="nofollow">1.输入参数</a></li><li><a href="#2_43" rel="nofollow">2.设置文件保存路径</a></li><li><a href="#3_56" rel="nofollow">3.加载训练好的模型权重</a></li><li><a href="#4_65" rel="nofollow">4.数据处理</a></li><li><a href="#5_147" rel="nofollow">5.进行推理</a></li><li><a href="#6yolov5nms_208" rel="nofollow">6.yolov5里的nms</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_234" rel="nofollow">总结</a></li><li><a href="#yolov5__236" rel="nofollow">yolov5 系列</a></li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="_5"></a>前言</h2> 
<p>    推理阶段是整个检测模型完成后，要对模型进行测试的部分。很重要的一部分，只有了解了这个部分，才能在比赛或者项目提交中很好的输出自己模型的检测结果。同时，推理输出对模型部署在不同的环境下也是十分重要的。<br> 源码：<a href="https://github.com/ultralytics/yolov5">https://github.com/ultralytics/yolov5</a><br> 版本yolov5 v6.1</p> 
<h2><a id="detectpy_9"></a>detect.py</h2> 
<h4><a id="1_10"></a>1.输入参数</h4> 
<pre><code class="prism language-python"><span class="token decorator annotation punctuation">@torch<span class="token punctuation">.</span>no_grad</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 装饰器，推理部分不进行反向传播计算</span>
<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>
        weights<span class="token operator">=</span>ROOT <span class="token operator">/</span> <span class="token string">'yolov5s.pt'</span><span class="token punctuation">,</span>  <span class="token comment"># 加载的训练模型权重路径</span>
        source<span class="token operator">=</span>ROOT <span class="token operator">/</span> <span class="token string">'data/images'</span><span class="token punctuation">,</span>  <span class="token comment"># 输入图像或视频文件路径</span>
        data<span class="token operator">=</span>ROOT <span class="token operator">/</span> <span class="token string">'data/coco128.yaml'</span><span class="token punctuation">,</span>  <span class="token comment"># dataset.yaml path，自己生成的数据集yaml文件路径</span>
        imgsz<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">640</span><span class="token punctuation">,</span> <span class="token number">640</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># inference size (height, width)</span>
        conf_thres<span class="token operator">=</span><span class="token number">0.25</span><span class="token punctuation">,</span>  <span class="token comment"># confidence threshold</span>
        iou_thres<span class="token operator">=</span><span class="token number">0.45</span><span class="token punctuation">,</span>  <span class="token comment"># NMS IOU threshold</span>
        max_det<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span>  <span class="token comment"># maximum detections per image，默认一张图最多输出1000个目标</span>
        device<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span>  <span class="token comment"># cuda device, i.e. 0 or 0,1,2,3 or cpu，选择推理输出的设备</span>
        view_img<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment"># show results，推理后是否展示结果图片</span>
        save_txt<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment"># save results to *.txt，保存成.txt文件</span>
        save_conf<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment"># save confidences in --save-txt labels，是否将置信度保存到txt文件</span>
        save_crop<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment"># save cropped prediction boxes，是否将预测到的目标从原图剪切下来</span>
        nosave<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment"># do not save images/videos，是否不保存推理输出的结果</span>
        classes<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>  <span class="token comment"># filter by class: --class 0, or --class 0 2 3，是否保留指定的类</span>
        agnostic_nms<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment"># class-agnostic NMS，进行nms时是否将其他类当作同一个类别处理</span>
        augment<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment"># augmented inference，是否进行测试推理时的数据增强，TTA之类的</span>
        visualize<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment"># visualize features，是否可视化输出</span>
        update<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment"># update all models，</span>
        project<span class="token operator">=</span>ROOT <span class="token operator">/</span> <span class="token string">'runs/detect'</span><span class="token punctuation">,</span>  <span class="token comment"># save results to project/name ，结果输出保存主文件目录</span>
        name<span class="token operator">=</span><span class="token string">'exp'</span><span class="token punctuation">,</span>  <span class="token comment"># save results to project/name，结果输出保存文件名称</span>
        exist_ok<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment"># existing project/name ok, do not increment</span>
        line_thickness<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>  <span class="token comment"># bounding box thickness (pixels)</span>
        hide_labels<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment"># hide labels</span>
        hide_conf<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment"># hide confidences</span>
        half<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment"># use FP16 half-precision inference，是否采用半精度浮点型进行推理运算</span>
        dnn<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment"># use OpenCV DNN for ONNX inference</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>

</code></pre> 
<h4><a id="2_43"></a>2.设置文件保存路径</h4> 
<pre><code class="prism language-python">	source <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span>   <span class="token comment"># 图像输入路径</span>
    save_img <span class="token operator">=</span> <span class="token keyword">not</span> nosave <span class="token keyword">and</span> <span class="token keyword">not</span> source<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'.txt'</span><span class="token punctuation">)</span>  <span class="token comment"># save inference images</span>
    is_file <span class="token operator">=</span> Path<span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">.</span>suffix<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token keyword">in</span> <span class="token punctuation">(</span>IMG_FORMATS <span class="token operator">+</span> VID_FORMATS<span class="token punctuation">)</span>  <span class="token comment"># 判断文件的后缀名是否是图像或视频</span>
    is_url <span class="token operator">=</span> source<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'rtsp://'</span><span class="token punctuation">,</span> <span class="token string">'rtmp://'</span><span class="token punctuation">,</span> <span class="token string">'http://'</span><span class="token punctuation">,</span> <span class="token string">'https://'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 是否是网址</span>
    webcam <span class="token operator">=</span> source<span class="token punctuation">.</span>isnumeric<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">or</span> source<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'.txt'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token punctuation">(</span>is_url <span class="token keyword">and</span> <span class="token keyword">not</span> is_file<span class="token punctuation">)</span>  <span class="token comment">#视频流文件</span>
    <span class="token keyword">if</span> is_url <span class="token keyword">and</span> is_file<span class="token punctuation">:</span>
        source <span class="token operator">=</span> check_file<span class="token punctuation">(</span>source<span class="token punctuation">)</span>  <span class="token comment"># download</span>
    <span class="token comment"># Directories</span>
    save_dir <span class="token operator">=</span> increment_path<span class="token punctuation">(</span>Path<span class="token punctuation">(</span>project<span class="token punctuation">)</span> <span class="token operator">/</span> name<span class="token punctuation">,</span> exist_ok<span class="token operator">=</span>exist_ok<span class="token punctuation">)</span>  <span class="token comment"># increment run,默认路径runs/detect/exp</span>
    <span class="token punctuation">(</span>save_dir <span class="token operator">/</span> <span class="token string">'labels'</span> <span class="token keyword">if</span> save_txt <span class="token keyword">else</span> save_dir<span class="token punctuation">)</span><span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>parents<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># make dir</span>
</code></pre> 
<h4><a id="3_56"></a>3.加载训练好的模型权重</h4> 
<pre><code class="prism language-python"><span class="token comment"># Load model</span>
    device <span class="token operator">=</span> select_device<span class="token punctuation">(</span>device<span class="token punctuation">)</span>   <span class="token comment"># 选择设备</span>
    <span class="token comment"># 不同的权重格式选择不同的加载方式 ，如.pt,.onnx,.trt</span>
    model <span class="token operator">=</span> DetectMultiBackend<span class="token punctuation">(</span>weights<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">,</span> dnn<span class="token operator">=</span>dnn<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">,</span> fp16<span class="token operator">=</span>half<span class="token punctuation">)</span>
    stride<span class="token punctuation">,</span> names<span class="token punctuation">,</span> pt <span class="token operator">=</span> model<span class="token punctuation">.</span>stride<span class="token punctuation">,</span> model<span class="token punctuation">.</span>names<span class="token punctuation">,</span> model<span class="token punctuation">.</span>pt  
    imgsz <span class="token operator">=</span> check_img_size<span class="token punctuation">(</span>imgsz<span class="token punctuation">,</span> s<span class="token operator">=</span>stride<span class="token punctuation">)</span>  <span class="token comment"># check image size,检查选择输入模型的尺寸是否符合32的倍数</span>
</code></pre> 
<h4><a id="4_65"></a>4.数据处理</h4> 
<p>整个数据处理的步骤;</p> 
<ul><li>1.先对输入图像的原图进行最短边的放缩;</li><li>2.为了匹配yolov5的下采样操作还要使得输入模型的宽高符合最后一次下采样stride(三层一般32，四层64)的倍数，还要对其进行padding。<br> +3. 同时，因为opencv读取图像是BGR格式，要将其转化为RGB格式。</li><li>4.最后，还要对输入的像素值进行归一化。</li></ul> 
<pre><code class="prism language-python"><span class="token comment"># Dataloader</span>
    <span class="token keyword">if</span> webcam<span class="token punctuation">:</span>
        view_img <span class="token operator">=</span> check_imshow<span class="token punctuation">(</span><span class="token punctuation">)</span>
        cudnn<span class="token punctuation">.</span>benchmark <span class="token operator">=</span> <span class="token boolean">True</span>  <span class="token comment"># set True to speed up constant image size inference</span>
        dataset <span class="token operator">=</span> LoadStreams<span class="token punctuation">(</span>source<span class="token punctuation">,</span> img_size<span class="token operator">=</span>imgsz<span class="token punctuation">,</span> stride<span class="token operator">=</span>stride<span class="token punctuation">,</span> auto<span class="token operator">=</span>pt<span class="token punctuation">)</span>
        bs <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>dataset<span class="token punctuation">)</span>  <span class="token comment"># batch_size</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token comment"># 这里只是简单的加载输入图像数据的路径</span>
        dataset <span class="token operator">=</span> LoadImages<span class="token punctuation">(</span>source<span class="token punctuation">,</span> img_size<span class="token operator">=</span>imgsz<span class="token punctuation">,</span> stride<span class="token operator">=</span>stride<span class="token punctuation">,</span> auto<span class="token operator">=</span>pt<span class="token punctuation">)</span>
        bs <span class="token operator">=</span> <span class="token number">1</span>  <span class="token comment"># batch_size</span>
    vid_path<span class="token punctuation">,</span> vid_writer <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">*</span> bs<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">*</span> bs
    <span class="token comment"># Run inference</span>
    <span class="token comment"># 先进行预热，用全为0的先进行一次推理，过一遍代码</span>
    model<span class="token punctuation">.</span>warmup<span class="token punctuation">(</span>imgsz<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token keyword">if</span> pt <span class="token keyword">else</span> bs<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">*</span>imgsz<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># warmup</span>
    <span class="token comment"># 这里迭代的时候要进入，utils/dataloaders.py里的__next__里进行letterbox数据宽高放缩处理</span>
    <span class="token keyword">for</span> path<span class="token punctuation">,</span> im<span class="token punctuation">,</span> im0s<span class="token punctuation">,</span> vid_cap<span class="token punctuation">,</span> s <span class="token keyword">in</span> dataset<span class="token punctuation">:</span>
       t1 <span class="token operator">=</span> time_sync<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 计算时间</span>
       im <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>im<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>  <span class="token comment"># 转成tensor并将数据转到cuda上</span>
       im <span class="token operator">=</span> im<span class="token punctuation">.</span>half<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> model<span class="token punctuation">.</span>fp16 <span class="token keyword">else</span> im<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># uint8 to fp16/32,选择使用的精度，半浮点型速度要更快</span>
       im <span class="token operator">/=</span> <span class="token number">255</span>  <span class="token comment"># 0 - 255 to 0.0 - 1.0  这是像素值归一化,跟坐标归一化无关</span>
       <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>im<span class="token punctuation">.</span>shape<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">:</span>
           im <span class="token operator">=</span> im<span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span>  <span class="token comment"># expand for batch dim，拓展一个batch维度</span>
       t2 <span class="token operator">=</span> time_sync<span class="token punctuation">(</span><span class="token punctuation">)</span>
       dt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+=</span> t2 <span class="token operator">-</span> t1  <span class="token comment"># 计算数据预处理时间</span>
</code></pre> 
<ul><li>letterbox进行resize和pad，opencv读取的bgr转成rgb</li></ul> 
<pre><code class="prism language-python"><span class="token comment"># Padded resize</span>
img <span class="token operator">=</span> letterbox<span class="token punctuation">(</span>img0<span class="token punctuation">,</span> self<span class="token punctuation">.</span>img_size<span class="token punctuation">,</span> stride<span class="token operator">=</span>self<span class="token punctuation">.</span>stride<span class="token punctuation">,</span> auto<span class="token operator">=</span>self<span class="token punctuation">.</span>auto<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
<span class="token keyword">def</span> <span class="token function">letterbox</span><span class="token punctuation">(</span>im<span class="token punctuation">,</span> new_shape<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">640</span><span class="token punctuation">,</span> <span class="token number">640</span><span class="token punctuation">)</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">114</span><span class="token punctuation">,</span> <span class="token number">114</span><span class="token punctuation">,</span> <span class="token number">114</span><span class="token punctuation">)</span><span class="token punctuation">,</span> auto<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> scaleFill<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> scaleup<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Resize and pad image while meeting stride-multiple constraints</span>
    shape <span class="token operator">=</span> im<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>  <span class="token comment"># 输入原图高宽[height, width]</span>
    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>new_shape<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        new_shape <span class="token operator">=</span> <span class="token punctuation">(</span>new_shape<span class="token punctuation">,</span> new_shape<span class="token punctuation">)</span>

    <span class="token comment"># Scale ratio (new / old)，求自己要求输入模型图像的高宽和原图高宽的最小比值</span>
    r <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>new_shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">/</span> shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> new_shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/</span> shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
    <span class="token keyword">if</span> <span class="token keyword">not</span> scaleup<span class="token punctuation">:</span>  <span class="token comment"># only scale down, do not scale up (for better val mAP)</span>
        r <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span>  <span class="token comment"># 这表示如果比值大于1不进行比例缩放</span>

    <span class="token comment"># Compute padding</span>
    ratio <span class="token operator">=</span> r<span class="token punctuation">,</span> r  <span class="token comment"># width, height ratios</span>
    <span class="token comment"># 对原图宽高进行最短边比列缩放，保持宽高比不变，使图像尽量不失真</span>
    new_unpad <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> r<span class="token punctuation">)</span><span class="token punctuation">)</span> 
    <span class="token comment"># 为了符合32的倍数要求（满足最小预测输出的特征层），要对缩放的尺寸进行padding  </span>
    dw<span class="token punctuation">,</span> dh <span class="token operator">=</span> new_shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> new_unpad<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> new_shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> new_unpad<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment"># wh padding</span>
    <span class="token keyword">if</span> auto<span class="token punctuation">:</span>  <span class="token comment"># minimum rectangle</span>
        dw<span class="token punctuation">,</span> dh <span class="token operator">=</span> np<span class="token punctuation">.</span>mod<span class="token punctuation">(</span>dw<span class="token punctuation">,</span> stride<span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>mod<span class="token punctuation">(</span>dh<span class="token punctuation">,</span> stride<span class="token punctuation">)</span>  <span class="token comment"># wh padding np.mod取模运算</span>
    <span class="token keyword">elif</span> scaleFill<span class="token punctuation">:</span>  <span class="token comment"># stretch</span>
        dw<span class="token punctuation">,</span> dh <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span>
        new_unpad <span class="token operator">=</span> <span class="token punctuation">(</span>new_shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> new_shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        ratio <span class="token operator">=</span> new_shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/</span> shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> new_shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">/</span> shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># width, height ratios</span>

    dw <span class="token operator">/=</span> <span class="token number">2</span>  <span class="token comment"># divide padding into 2 sides</span>
    dh <span class="token operator">/=</span> <span class="token number">2</span> <span class="token comment"># padding是对图像两边进行的</span>

    <span class="token keyword">if</span> shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> new_unpad<span class="token punctuation">:</span>  <span class="token comment"># 和原图宽高不等，opencv进行resize</span>
        im <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>im<span class="token punctuation">,</span> new_unpad<span class="token punctuation">,</span> interpolation<span class="token operator">=</span>cv2<span class="token punctuation">.</span>INTER_LINEAR<span class="token punctuation">)</span>
    top<span class="token punctuation">,</span> bottom <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>dh <span class="token operator">-</span> <span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>dh <span class="token operator">+</span> <span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 四舍五入后取整</span>
    left<span class="token punctuation">,</span> right <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>dw <span class="token operator">-</span> <span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>dw <span class="token operator">+</span> <span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># padding的部分是无效区域，用color=(114, 114, 114)常数值填充，前面讲mmdetection里的mask记录放缩图像无效区域一个意思</span>
    im <span class="token operator">=</span> cv2<span class="token punctuation">.</span>copyMakeBorder<span class="token punctuation">(</span>im<span class="token punctuation">,</span> top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>BORDER_CONSTANT<span class="token punctuation">,</span> value<span class="token operator">=</span>color<span class="token punctuation">)</span>  <span class="token comment"># add border</span>
    <span class="token comment"># 返回缩放的宽高，比例和padding大小，方便后面对归一化的预测输出进行还原，推理只要im</span>
    <span class="token keyword">return</span> im<span class="token punctuation">,</span> ratio<span class="token punctuation">,</span> <span class="token punctuation">(</span>dw<span class="token punctuation">,</span> dh<span class="token punctuation">)</span> 
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
<span class="token comment"># opncv读取的图片数据是HWC和BGR格式的，为了方便要进行处理</span>
<span class="token comment"># Convert</span>
img <span class="token operator">=</span> img<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment"># HWC to CHW, BGR to RGB</span>
img <span class="token operator">=</span> np<span class="token punctuation">.</span>ascontiguousarray<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
<span class="token keyword">return</span> path<span class="token punctuation">,</span> img<span class="token punctuation">,</span> img0<span class="token punctuation">,</span> self<span class="token punctuation">.</span>cap<span class="token punctuation">,</span> s
</code></pre> 
<h4><a id="5_147"></a>5.进行推理</h4> 
<p>推理步骤：</p> 
<ul><li>1.将输入图像经过模型得到预测输出；</li><li>2.对预测输出进行NMS处理；</li><li>3.对NMS处理后的Boxes进行相应的后处理。</li></ul> 
<pre><code class="prism language-python">     <span class="token comment"># Inference</span>
     visualize <span class="token operator">=</span> increment_path<span class="token punctuation">(</span>save_dir <span class="token operator">/</span> Path<span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">.</span>stem<span class="token punctuation">,</span> mkdir<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token keyword">if</span> visualize <span class="token keyword">else</span> <span class="token boolean">False</span>
     <span class="token comment"># [b,num_pre_boxes,(5+cls_scores)]这里是输出归一化的boxes:x,y,h,w,5表示[x,y,h,w,conf]</span>
     pred <span class="token operator">=</span> model<span class="token punctuation">(</span>im<span class="token punctuation">,</span> augment<span class="token operator">=</span>augment<span class="token punctuation">,</span> visualize<span class="token operator">=</span>visualize<span class="token punctuation">)</span>  
     t3 <span class="token operator">=</span> time_sync<span class="token punctuation">(</span><span class="token punctuation">)</span>
     dt<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+=</span> t3 <span class="token operator">-</span> t2  <span class="token comment"># 模型预测输出时间</span>
     <span class="token comment"># 多类别的nms，部署的话要可以用opencv的，也可以用c++可以自己写</span>
     <span class="token comment"># NMS,经过下面的NMS后才是[num_P,6],[x1,y1,x2,y2,conf,cls]</span>
     pred <span class="token operator">=</span> non_max_suppression<span class="token punctuation">(</span>pred<span class="token punctuation">,</span> conf_thres<span class="token punctuation">,</span> iou_thres<span class="token punctuation">,</span> classes<span class="token punctuation">,</span> agnostic_nms<span class="token punctuation">,</span> max_det<span class="token operator">=</span>max_det<span class="token punctuation">)</span><span class="token comment"># [x1,y1,x2,y2,conf,cls]</span>
     dt<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+=</span> time_sync<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> t3 <span class="token comment"># NMS的时间</span>
     
     <span class="token comment"># Process predictions</span>
     <span class="token keyword">for</span> i<span class="token punctuation">,</span> det <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>pred<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># per image</span>
         seen <span class="token operator">+=</span> <span class="token number">1</span>
         <span class="token keyword">if</span> webcam<span class="token punctuation">:</span>  <span class="token comment"># batch_size &gt;= 1</span>
             p<span class="token punctuation">,</span> im0<span class="token punctuation">,</span> frame <span class="token operator">=</span> path<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> im0s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dataset<span class="token punctuation">.</span>count
             s <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">: '</span></span>
         <span class="token keyword">else</span><span class="token punctuation">:</span>
             p<span class="token punctuation">,</span> im0<span class="token punctuation">,</span> frame <span class="token operator">=</span> path<span class="token punctuation">,</span> im0s<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> <span class="token string">'frame'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

         p <span class="token operator">=</span> Path<span class="token punctuation">(</span>p<span class="token punctuation">)</span>  <span class="token comment"># to Path</span>
         save_path <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>save_dir <span class="token operator">/</span> p<span class="token punctuation">.</span>name<span class="token punctuation">)</span>  <span class="token comment"># im.jpg</span>
         txt_path <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>save_dir <span class="token operator">/</span> <span class="token string">'labels'</span> <span class="token operator">/</span> p<span class="token punctuation">.</span>stem<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token string">''</span> <span class="token keyword">if</span> dataset<span class="token punctuation">.</span>mode <span class="token operator">==</span> <span class="token string">'image'</span> <span class="token keyword">else</span> <span class="token string-interpolation"><span class="token string">f'_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>frame<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>  <span class="token comment"># im.txt</span>
         s <span class="token operator">+=</span> <span class="token string">'%gx%g '</span> <span class="token operator">%</span> im<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>  <span class="token comment"># print string</span>
         gn <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># normalization gain whwh,  获取原图大小</span>
         imc <span class="token operator">=</span> im0<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> save_crop <span class="token keyword">else</span> im0  <span class="token comment"># for save_crop</span>
         annotator <span class="token operator">=</span> Annotator<span class="token punctuation">(</span>im0<span class="token punctuation">,</span> line_width<span class="token operator">=</span>line_thickness<span class="token punctuation">,</span> example<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">(</span>names<span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>det<span class="token punctuation">)</span><span class="token punctuation">:</span>
             <span class="token comment"># Rescale boxes from img_size to im0 size,im:640,640,im0:原图大小</span>
             det<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> scale_coords<span class="token punctuation">(</span>im<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> det<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> im0<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">#还原原来图像大小</span>

             <span class="token comment"># Print results</span>
             <span class="token keyword">for</span> c <span class="token keyword">in</span> det<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>unique<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                 n <span class="token operator">=</span> <span class="token punctuation">(</span>det<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> c<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># detections per class</span>
                 s <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>n<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>names<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token string">'s'</span> <span class="token operator">*</span> <span class="token punctuation">(</span>n <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">, "</span></span>  <span class="token comment"># add to string</span>

             <span class="token comment"># Write results</span>
             <span class="token keyword">for</span> <span class="token operator">*</span>xyxy<span class="token punctuation">,</span> conf<span class="token punctuation">,</span> cls <span class="token keyword">in</span> <span class="token builtin">reversed</span><span class="token punctuation">(</span>det<span class="token punctuation">)</span><span class="token punctuation">:</span>
                 <span class="token keyword">if</span> save_txt<span class="token punctuation">:</span>  <span class="token comment"># Write to file</span>
                 <span class="token comment"># xyxy2xywh：字面意思，将左上右下角的坐标值，转换为中心宽高值，再除以比例，归一化保存到txt文件上</span>
                 <span class="token comment"># 比赛或者项目里一般不会要求提交归一化的结果，所以这里自己稍微进行相应的处理即可</span>
                     xywh <span class="token operator">=</span> <span class="token punctuation">(</span>xyxy2xywh<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>xyxy<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> gn<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># normalized xywh</span>
                     <span class="token comment"># txt文件里每行记录(cls, *xywh)，如果要记录置信度，将save_conf设置为true</span>
                     line <span class="token operator">=</span> <span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token operator">*</span>xywh<span class="token punctuation">,</span> conf<span class="token punctuation">)</span> <span class="token keyword">if</span> save_conf <span class="token keyword">else</span> <span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token operator">*</span>xywh<span class="token punctuation">)</span>  <span class="token comment"># label format</span>
                     <span class="token comment"># 打开txt文件，将推理的结果写入</span>
                     <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>txt_path<span class="token punctuation">}</span></span><span class="token string">.txt'</span></span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                         f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'%g '</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rstrip<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> line <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>
                     <span class="token comment"># 后面的代码都是保存和展示结果文件的了，这里就不解析了</span>
                     <span class="token keyword">if</span> save_img <span class="token keyword">or</span> save_crop <span class="token keyword">or</span> view_img<span class="token punctuation">:</span>  <span class="token comment"># Add bbox to image</span>
					    c <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span>  <span class="token comment"># integer class</span>
					    label <span class="token operator">=</span> <span class="token boolean">None</span> <span class="token keyword">if</span> hide_labels <span class="token keyword">else</span> <span class="token punctuation">(</span>names<span class="token punctuation">[</span>c<span class="token punctuation">]</span> <span class="token keyword">if</span> hide_conf <span class="token keyword">else</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>names<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>conf<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
					    annotator<span class="token punctuation">.</span>box_label<span class="token punctuation">(</span>xyxy<span class="token punctuation">,</span> label<span class="token punctuation">,</span> color<span class="token operator">=</span>colors<span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
					 <span class="token keyword">if</span> save_crop<span class="token punctuation">:</span>
					    save_one_box<span class="token punctuation">(</span>xyxy<span class="token punctuation">,</span> imc<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token operator">=</span>save_dir <span class="token operator">/</span> <span class="token string">'crops'</span> <span class="token operator">/</span> names<span class="token punctuation">[</span>c<span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>p<span class="token punctuation">.</span>stem<span class="token punctuation">}</span></span><span class="token string">.jpg'</span></span><span class="token punctuation">,</span> BGR<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="6yolov5nms_208"></a>6.yolov5里的nms</h4> 
<p>在前面的博客，讲了单类别的nms，但是如果是多类别的nms可以怎么做呢？<br> 已知的方法：</p> 
<ul><li>第一种方法就是，对循环遍历每类，然后每类进行nms；</li><li>第二种方法，直接对所有的box进行分数降序排列，之后在循环里进行判断，只要类别相同的才进行iou计算，然后再比较阈值。这要用一个标记数组来记录哪些是要筛选的，之后筛选掉。</li><li>第三种方法，使用一个偏移量，将不同的类加上一个偏移量，将每个类的所有box单独变换到不同的坐标域，直接按原来的进行nms即可。</li></ul> 
<p>yolov5就是采用的第三种方法，这里这要讲下主要的代码，完整代码在utils/general.py里的non_max_suppression里</p> 
<pre><code class="prism language-python"><span class="token comment"># 主要代码</span>
	max_wh <span class="token operator">=</span> <span class="token number">7680</span>  <span class="token comment"># 最大宽高</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
<span class="token comment"># 这里的代码主要解释x的维度代表什么，下面有用到</span>
    <span class="token comment"># 找出的conf_thres(类别分数*置信度)最大的对应的一个类和索引，j是类别label的索引(其实就是类别标签)：[0,1,1,2]这种</span>
	conf<span class="token punctuation">,</span> j <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> keepdim<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    
	<span class="token comment"># 在维度1上重新合并[经过初步分数阈值筛选的预测数量,4+1+1=6]，取出大于conf_thres阈值的预测值[k,6]</span>
    x <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>box<span class="token punctuation">,</span> conf<span class="token punctuation">,</span> j<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span>conf<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> conf_thres<span class="token punctuation">]</span>    
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
<span class="token comment"># 进行多类别的nms</span>
	<span class="token comment"># Batched NMS，如果agnostic为true，表示所有的作为一类进行nms，默认false，每类乘上一个最大wh长度的偏移值</span>
    c <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token keyword">if</span> agnostic <span class="token keyword">else</span> max_wh<span class="token punctuation">)</span>  <span class="token comment"># classes</span>
    <span class="token comment"># 之后在boxes上加上偏移量作为iou计算的boxes</span>
    boxes<span class="token punctuation">,</span> scores <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">+</span> c<span class="token punctuation">,</span> x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>  <span class="token comment"># boxes (offset by class), scores</span>
    i <span class="token operator">=</span> torchvision<span class="token punctuation">.</span>ops<span class="token punctuation">.</span>nms<span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> scores<span class="token punctuation">,</span> iou_thres<span class="token punctuation">)</span>  <span class="token comment"># NMS</span>
</code></pre> 
<h2><a id="_234"></a>总结</h2> 
<p>    推理输出部分的理解是十分重要的，在比赛和项目中有提交结果格式的要求，都要在这修改相应的代码。同时，也可以在推理过程中使用一些trick去提升性能。同时，为了实时性，算法的开发部署主要就是推理阶段的部署。为了加速推理速度，提升检测性能，可以很好的将训练好的torch模型转换成onnx或者engine，使用c++进行部署。</p> 
<h2><a id="yolov5__236"></a>yolov5 系列</h2> 
<p><a href="https://blog.csdn.net/weixin_41311686/article/details/125210057?spm=1001.2014.3001.5501">yolov5使用自己的数据集相关代码</a><br> <a href="https://blog.csdn.net/weixin_41311686/article/details/127169478?spm=1001.2014.3001.5501">yolov5网络结构代码解读</a><br> <a href="https://blog.csdn.net/weixin_41311686/article/details/128094042?spm=1001.2014.3001.5501">yolov5的正负样本的定义和匹配</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b76ae3639f6e871af2c0fba277a03d73/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【前端面试整理 | vue相关知识整理 】</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0637723d820fb16892ae49df7289be20/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Vue3父子组件传参</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>