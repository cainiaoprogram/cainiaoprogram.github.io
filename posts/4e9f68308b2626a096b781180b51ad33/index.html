<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【springboot3.x 记录】spring-cloud-gateway 2022踩坑记录 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【springboot3.x 记录】spring-cloud-gateway 2022踩坑记录" />
<meta property="og:description" content="最近升级springboot3、springcloud微服务真是一挖一个坑，特此记录一下
一、openfeign 循环依赖问题 springcloud升级到 2022.0.4 后，启动项目发现提示 循环依赖 异常。
从上面图也能清楚地看到，就是A依赖B，B依赖C，C又依赖A，导致循环依赖。
翻查了一下github的 issue ，发现有人也遇到此类问题，如下图，原来早在2019年的时候，已经是不支持在 filter 里面使用 feign 调用了。
而且在2020版的 Spring Cloud Gateway 也已经移除了 robbion。
目前能找到的解决方式有两种：
1）改用 webclient
提及比较多的是这个项目 feign-reactive ，但是对于笔者而已对现有项目的改动比较大，最终没有采纳，大家有兴趣可以看看。
这里也有一篇文章有介绍如何使用 Reactive Feign
2）使用 @Lazy 注解
这个估计是目前最简单的方式，使用的延迟加载的方式来规避
刚好，给我发现了一篇文章，说到了这个类似的问题的原因，博主一步步debug源码分析，传送门
大致的问题出在框架本身、 feign client 加载 、过滤器加载顺序有关，导致最终被加载了两次，具体的分析方法文章博主也很详细的说明，在此就不再描述。
这里也有一篇文章是关于 GatewayAutoConfiguration 源码分析，有兴趣的也可以看一下。
二、异步问题 如果使用 @Lazy 注解方式来解决 循环依赖问题，那么马上又迎来第二个问题，异步调用问题。
java.lang.IllegalStateException: block()/blockFirst()/blockLast() are blocking, which is not supported in thread reactor-http-nio-3 at reactor.core.publisher.BlockingSingleSubscriber.blockingGet(BlockingSingleSubscriber.java:83) Suppressed: reactor.core.publisher.FluxOnAssembly$OnAssemblyException: Error has been observed at the following site(s): |_ checkpoint ⇢ org." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/4e9f68308b2626a096b781180b51ad33/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-10-14T23:14:56+08:00" />
<meta property="article:modified_time" content="2023-10-14T23:14:56+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【springboot3.x 记录】spring-cloud-gateway 2022踩坑记录</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <blockquote> 
 <p>最近升级springboot3、springcloud微服务真是一挖一个坑，特此记录一下</p> 
</blockquote> 
<h2>一、openfeign 循环依赖问题</h2> 
<p>springcloud升级到 2022.0.4 后，启动项目发现提示 循环依赖 异常。</p> 
<p><img alt="" height="393" src="https://images2.imgbox.com/f2/c5/EFweC9aL_o.png" width="1200"></p> 
<p>从上面图也能清楚地看到，就是A依赖B，B依赖C，C又依赖A，导致循环依赖。</p> 
<p>翻查了一下github的 <a class="link-info" href="https://github.com/spring-cloud/spring-cloud-gateway/issues/1099" title="issue">issue</a> ，发现有人也遇到此类问题，如下图，原来早在2019年的时候，已经是不支持在 filter 里面使用 feign 调用了。</p> 
<h2><img alt="" height="816" src="https://images2.imgbox.com/88/a3/wSmk0dRP_o.png" width="1200"></h2> 
<p>而且在2020版的 Spring Cloud Gateway 也已经移除了 robbion。</p> 
<p>目前能找到的解决方式有两种：</p> 
<p>1）改用 webclient</p> 
<p>提及比较多的是这个项目 <a class="link-info" href="https://github.com/PlaytikaOSS/feign-reactive" title="feign-reactive">feign-reactive</a> ，但是对于笔者而已对现有项目的改动比较大，最终没有采纳，大家有兴趣可以看看。</p> 
<p>这里也有一篇文章有介绍如何使用 <a class="link-info" href="https://blog.csdn.net/LCBUSHIHAHA/article/details/113817966" title="Reactive Feign">Reactive Feign</a></p> 
<p>2）使用 @Lazy 注解</p> 
<p>这个估计是目前最简单的方式，使用的延迟加载的方式来规避</p> 
<p><img alt="" height="268" src="https://images2.imgbox.com/94/00/Vualxd57_o.png" width="952"></p> 
<p>刚好，给我发现了一篇文章，说到了这个类似的问题的原因，博主一步步debug源码分析，<a class="link-info" href="https://juejin.cn/post/6844904001285128199" rel="nofollow" title="传送门">传送门</a></p> 
<p>大致的问题出在框架本身、 feign client 加载 、过滤器加载顺序有关，导致最终被加载了两次，具体的分析方法文章博主也很详细的说明，在此就不再描述。</p> 
<p>这里也有一篇文章是关于 <a class="link-info" href="https://www.cnblogs.com/bjlhx/p/9785528.html" rel="nofollow" title="GatewayAutoConfiguration 源码分析">GatewayAutoConfiguration 源码分析</a>，有兴趣的也可以看一下。</p> 
<p></p> 
<h2>二、异步问题</h2> 
<p>如果使用 @Lazy 注解方式来解决 循环依赖问题，那么马上又迎来第二个问题，异步调用问题。</p> 
<pre><code class="language-java">java.lang.IllegalStateException: block()/blockFirst()/blockLast() are blocking, which is not supported in thread reactor-http-nio-3
	at reactor.core.publisher.BlockingSingleSubscriber.blockingGet(BlockingSingleSubscriber.java:83)
	Suppressed: reactor.core.publisher.FluxOnAssembly$OnAssemblyException: 
Error has been observed at the following site(s):
	|_ checkpoint ⇢ org.springframework.web.cors.reactive.CorsWebFilter [DefaultWebFilterChain]
	|_ checkpoint ⇢ org.springframework.cloud.gateway.filter.WeightCalculatorWebFilter [DefaultWebFilterChain]
	|_ checkpoint ⇢ org.springframework.boot.actuate.metrics.web.reactive.server.MetricsWebFilter [DefaultWebFilterChain]
	|_ checkpoint ⇢ HTTP GET "/api/users/getUserInfo" [ExceptionHandlingWebHandler]
</code></pre> 
<p>原因是，不能在Spring Cloud Gateway中使用同步调用，而普通的feign调用又是同步的。升级后的组件已经开始使用 webflux 响应式开发，走的异步方式提升性能，对于使用阻塞的请求全部会抛异常，哪怕是同步的http请求也不行。</p> 
<p>解决方式目前有两种：</p> 
<p>1）使用 webclient，接入 ReactiveFeign </p> 
<p>2）强制同步转异步，将 feign 调用封装成异步任务</p> 
<p>这是曲线救国的方法，使用 Future 方式包装一层feign调用，其实际还是同步阻塞请求。</p> 
<pre><code class="language-java">//获取账号
CompletableFuture&lt;PlatformAccountResponse&gt; platformAccountResponseCompletableFuture = CompletableFuture.supplyAsync(() -&gt; {
        PlatformAccountResponse platformAccountResponse = cloudPlatformAccountService.queryByDeviceId(deviceId);
            return platformAccountResponse;
        });

//阻塞同步获取返回结果
PlatformAccountResponse response = platformAccountResponseCompletableFuture.get();</code></pre> 
<h2>三、shiro 鉴权</h2> 
<p>本想着使用 shiro 鉴权，然后发现 shiro 必须使用web-mvc（依赖spring-boot-starter-web），但是web-mvc与web-flux不兼容，而springcloud-gateway必须依赖web-flux，所以shiro无法集成到springcloud-gateway，会失效。</p> 
<p>好家伙，还好在整合前先了解了一下...</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/aa32c7374bf51959c2c5bdd12bed53a1/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">BP神经网络及python实现（详细）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/aabc67c9aec9bdf91a0c92563f9ffe6c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">比特听命：补码的产生过程与整数在计算机中的存储</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>