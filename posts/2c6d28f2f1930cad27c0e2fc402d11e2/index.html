<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>TextView跑马灯效果不生效的原因分析及解决方案 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="TextView跑马灯效果不生效的原因分析及解决方案" />
<meta property="og:description" content="今天同事遇到一个缺陷，跑马灯不生效，迟迟无法解决，于是帮忙看了下，最终顺利解决了，做个记录。
首先原来的代码是这样的：
JAVA代码实现（Kotlin）： holder.itemView.tv_title.text = title XML中实现： &lt;TextView android:id=&#34;@&#43;id/tv_title&#34; android:layout_width=&#34;@dimen/dip96&#34; android:layout_height=&#34;@dimen/dip17&#34; android:ellipsize=&#34;marquee&#34; android:focusableInTouchMode=&#34;true&#34; android:fontFamily=&#34;sans-serif-medium&#34; android:gravity=&#34;center&#34; android:marqueeRepeatLimit=&#34;marquee_forever&#34; android:scrollHorizontally=&#34;true&#34; android:singleLine=&#34;true&#34; android:textColor=&#34;@color/color_333333&#34; android:textSize=&#34;@dimen/dip12&#34; tools:text=&#34;系统版本信息&#34; /&gt; 都很正常。搜索晚上大多数的解决方案，无法是添加singleLine等字段，这里面其实都已经设置了。百度的所有方案都试过了，都是无效的，靠人不如靠己，就只能自己尝试调试源码解决了。幸好手里面有一部神机pixel4，和源码完全对得上，可以直接调试。
原因分析：
我这里就不一步一步的分析原因了，直接定位到原因点，是否展示跑马灯效果，是textView中这段代码控制的：
@UnsupportedAppUsage(maxTargetSdk = Build.VERSION_CODES.P, trackingBug = 115609023) private void startMarquee() { // Do not ellipsize EditText if (getKeyListener() != null) return; if (compressText(getWidth() - getCompoundPaddingLeft() - getCompoundPaddingRight())) { return; } if ((mMarquee == null || mMarquee.isStopped()) &amp;&amp; (isFocused() || isSelected()) &amp;&amp; getLineCount() == 1 &amp;&amp; canMarquee()) { if (mMarqueeFadeMode == MARQUEE_FADE_SWITCH_SHOW_ELLIPSIS) { mMarqueeFadeMode = MARQUEE_FADE_SWITCH_SHOW_FADE; final Layout tmp = mLayout; mLayout = mSavedMarqueeModeLayout; mSavedMarqueeModeLayout = tmp; setHorizontalFadingEdgeEnabled(true); requestLayout(); invalidate(); } if (mMarquee == null) mMarquee = new Marquee(this); mMarquee." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/2c6d28f2f1930cad27c0e2fc402d11e2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-01-21T18:31:52+08:00" />
<meta property="article:modified_time" content="2021-01-21T18:31:52+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">TextView跑马灯效果不生效的原因分析及解决方案</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>今天同事遇到一个缺陷，跑马灯不生效，迟迟无法解决，于是帮忙看了下，最终顺利解决了，做个记录。</p> 
<p>首先原来的代码是这样的：</p> 
<pre><code>JAVA代码实现（Kotlin）：

holder.itemView.tv_title.text = title
          

XML中实现：
 &lt;TextView
                android:id="@+id/tv_title"
                android:layout_width="@dimen/dip96"
                android:layout_height="@dimen/dip17"
                android:ellipsize="marquee"
                android:focusableInTouchMode="true"
                android:fontFamily="sans-serif-medium"
                android:gravity="center"
                android:marqueeRepeatLimit="marquee_forever"
                android:scrollHorizontally="true"
                android:singleLine="true"
                android:textColor="@color/color_333333"
                android:textSize="@dimen/dip12"
                tools:text="系统版本信息" /&gt;</code></pre> 
<p>都很正常。搜索晚上大多数的解决方案，无法是添加singleLine等字段，这里面其实都已经设置了。百度的所有方案都试过了，都是无效的，靠人不如靠己，就只能自己尝试调试源码解决了。幸好手里面有一部神机pixel4，和源码完全对得上，可以直接调试。</p> 
<p> </p> 
<p>原因分析：</p> 
<p>我这里就不一步一步的分析原因了，直接定位到原因点，是否展示跑马灯效果，是textView中这段代码控制的：</p> 
<pre><code>
    @UnsupportedAppUsage(maxTargetSdk = Build.VERSION_CODES.P, trackingBug = 115609023)
    private void startMarquee() {
        // Do not ellipsize EditText
        if (getKeyListener() != null) return;

        if (compressText(getWidth() - getCompoundPaddingLeft() - getCompoundPaddingRight())) {
            return;
        }

        if ((mMarquee == null || mMarquee.isStopped()) &amp;&amp; (isFocused() || isSelected())
                &amp;&amp; getLineCount() == 1 &amp;&amp; canMarquee()) {

            if (mMarqueeFadeMode == MARQUEE_FADE_SWITCH_SHOW_ELLIPSIS) {
                mMarqueeFadeMode = MARQUEE_FADE_SWITCH_SHOW_FADE;
                final Layout tmp = mLayout;
                mLayout = mSavedMarqueeModeLayout;
                mSavedMarqueeModeLayout = tmp;
                setHorizontalFadingEdgeEnabled(true);
                requestLayout();
                invalidate();
            }

            if (mMarquee == null) mMarquee = new Marquee(this);
            mMarquee.start(mMarqueeRepeatLimit);
        }
    }</code></pre> 
<p>前面我们能看到正常的判断，是否一行，是否选中，是否获取焦点等等，这些都没有问题。问题点就在canMarquee()方法里面。</p> 
<p> </p> 
<pre><code>    private boolean canMarquee() {
        int width = mRight - mLeft - getCompoundPaddingLeft() - getCompoundPaddingRight();
        return width &gt; 0 &amp;&amp; (mLayout.getLineWidth(0) &gt; width
                || (mMarqueeFadeMode != MARQUEE_FADE_NORMAL &amp;&amp; mSavedMarqueeModeLayout != null
                        &amp;&amp; mSavedMarqueeModeLayout.getLineWidth(0) &gt; width));
    }</code></pre> 
<p>这里有一个很重要的问题，我们的绘制流程一般是measure-&gt;layout-&gt;draw的流程，而startMarquee的调用时机默认是在makeNewLayout中，也就是measure的流程中。但是mRight和mLeft的赋值却是在layout的流程当中，所以这里，首次的时候，最终得到的width的值一定是&lt;=0的，这样的话，canMarquee返回值为false，所以跑马灯没有生效。</p> 
<p>在源码当中，只有界面绘制出来，然后再去获取焦点的话，此时跑马灯效果才生效，这也是正常跑马灯效果展示的流程。但是如果xml中就声明了获取焦点，这时候有时也是不生效的，因为默认就具有焦点，调用canMarquee方法的时候，left和right很有可能还是0。</p> 
<p>解决方案1：</p> 
<p>既然这样，那我们就post一个runnable，再去获取焦点就好了。如下：</p> 
<pre><code> holder.itemView.tv_title.text = name
            Handler().post{
                holder.itemView.tv_title.requestFocus()
            }</code></pre> 
<p>但是这样还是有问题，如果界面上有多个TextView的话，多个textView发生焦点抢占，这时候去执行</p> 
<p><span style="color:#f33b45;">f ((mMarquee == null || mMarquee.isStopped()) &amp;&amp; (isFocused() || isSelected())<br>                 &amp;&amp; getLineCount() == 1 &amp;&amp; canMarquee())</span></p> 
<p>判断的时候，因为返回isFoucused返回false，所以跑马灯还是不生效的。或者严格点说，多个textView，只有最后获取到焦点的那个才会生效。</p> 
<p><span style="color:#f33b45;">解决方案2：</span></p> 
<p><span style="color:#f33b45;">看源码，除了isFocused()，还有isSelected()，那我们能不能使用isSelected来解决这个问题呢？当然可以，代码稍微一改：</span></p> 
<pre><code> holder.itemView.tv_title.text = name
            Handler().post{
                holder.itemView.tv_title.isSelected = true
            }</code></pre> 
<p>这样就完美了，多个textView也可以同时实现跑马灯的效果了。</p> 
<p>说到这里，还有一个要注意的点，源码当中，只有select状态的切换，才会触发执行跑马灯效果，所以务必把textView的isSelected的属性，设置为false，切记。</p> 
<p>源码如下：</p> 
<pre><code> @Override
    public void setSelected(boolean selected) {
        boolean wasSelected = isSelected();

        super.setSelected(selected);
        //这里，只有发生状态的切换，才会触发startMarquee方法
        if (selected != wasSelected &amp;&amp; mEllipsize == TextUtils.TruncateAt.MARQUEE) {
            if (selected) {
                startMarquee();
            } else {
                stopMarquee();
            }
        }
    }</code></pre> 
<p> </p> 
<p> </p> 
<p> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fcd322d2bd8d76219c11f2b0ccf740be/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">golang net/http包在k8s使用中碰到http: superfluous response.WriteHeader call from xxx的问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4e2ed095ac8c8f382dce8019f5a490b6/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">学习笔记(二):逻辑斯蒂回归算法（Logistic Regression）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>