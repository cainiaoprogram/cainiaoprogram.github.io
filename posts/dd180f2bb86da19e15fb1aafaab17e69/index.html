<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>使用python tkinter开发一个爬取B站直播弹幕的工具 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="使用python tkinter开发一个爬取B站直播弹幕的工具" />
<meta property="og:description" content="项目地址 https://github.com/jonssonyan/bilibli-danmu
开发工具 python 3.7.9pycharm 2019.3.5 代码 import threading import time import tkinter.simpledialog from tkinter import END, simpledialog, messagebox import requests class Danmu(): def __init__(self, room_id): # 弹幕url self.url = &#39;https://api.live.bilibili.com/xlive/web-room/v1/dM/gethistory&#39; # 请求头 self.headers = { &#39;Host&#39;: &#39;api.live.bilibili.com&#39;, &#39;User-Agent&#39;: &#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:78.0) Gecko/20100101 Firefox/78.0&#39;, } # 定义POST传递的参数 self.data = { &#39;roomid&#39;: room_id, &#39;csrf_token&#39;: &#39;&#39;, &#39;csrf&#39;: &#39;&#39;, &#39;visit_id&#39;: &#39;&#39;, } # 日志写对象 self.log_file_write = open(&#39;danmu.log&#39;, mode=&#39;a&#39;, encoding=&#39;utf-8&#39;) # 读取日志 log_file_read = open(&#39;danmu." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/dd180f2bb86da19e15fb1aafaab17e69/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-02-06T14:34:55+08:00" />
<meta property="article:modified_time" content="2021-02-06T14:34:55+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">使用python tkinter开发一个爬取B站直播弹幕的工具</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>项目地址</h2> 
<p>https://github.com/jonssonyan/bilibli-danmu</p> 
<h2><a id="_2"></a>开发工具</h2> 
<ol><li>python 3.7.9</li><li>pycharm 2019.3.5</li></ol> 
<h2><a id="_5"></a>代码</h2> 
<pre><code class="prism language-python"><span class="token keyword">import</span> threading
<span class="token keyword">import</span> time
<span class="token keyword">import</span> tkinter<span class="token punctuation">.</span>simpledialog
<span class="token keyword">from</span> tkinter <span class="token keyword">import</span> END<span class="token punctuation">,</span> simpledialog<span class="token punctuation">,</span> messagebox

<span class="token keyword">import</span> requests


<span class="token keyword">class</span> <span class="token class-name">Danmu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> room_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 弹幕url</span>
        self<span class="token punctuation">.</span>url <span class="token operator">=</span> <span class="token string">'https://api.live.bilibili.com/xlive/web-room/v1/dM/gethistory'</span>
        <span class="token comment"># 请求头</span>
        self<span class="token punctuation">.</span>headers <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">'Host'</span><span class="token punctuation">:</span> <span class="token string">'api.live.bilibili.com'</span><span class="token punctuation">,</span>
            <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:78.0) Gecko/20100101 Firefox/78.0'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
        <span class="token comment"># 定义POST传递的参数</span>
        self<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">'roomid'</span><span class="token punctuation">:</span> room_id<span class="token punctuation">,</span>
            <span class="token string">'csrf_token'</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
            <span class="token string">'csrf'</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
            <span class="token string">'visit_id'</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
        <span class="token comment"># 日志写对象</span>
        self<span class="token punctuation">.</span>log_file_write <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'danmu.log'</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'a'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
        <span class="token comment"># 读取日志</span>
        log_file_read <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'danmu.log'</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>log <span class="token operator">=</span> log_file_read<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">get_danmu</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 暂停0.5防止cpu占用过高</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment"># 获取直播间弹幕</span>
        html <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>self<span class="token punctuation">.</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>self<span class="token punctuation">.</span>headers<span class="token punctuation">,</span> data<span class="token operator">=</span>self<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 解析弹幕列表</span>
        <span class="token keyword">for</span> content <span class="token keyword">in</span> html<span class="token punctuation">[</span><span class="token string">'data'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'room'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token comment"># 获取昵称</span>
            nickname <span class="token operator">=</span> content<span class="token punctuation">[</span><span class="token string">'nickname'</span><span class="token punctuation">]</span>
            <span class="token comment"># 获取发言</span>
            text <span class="token operator">=</span> content<span class="token punctuation">[</span><span class="token string">'text'</span><span class="token punctuation">]</span>
            <span class="token comment"># 获取发言时间</span>
            timeline <span class="token operator">=</span> content<span class="token punctuation">[</span><span class="token string">'timeline'</span><span class="token punctuation">]</span>
            <span class="token comment"># 记录发言</span>
            msg <span class="token operator">=</span> timeline <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> nickname <span class="token operator">+</span> <span class="token string">': '</span> <span class="token operator">+</span> text
            <span class="token comment"># 判断对应消息是否存在于日志，如果和最后一条相同则打印并保存</span>
            <span class="token keyword">if</span> msg <span class="token operator">+</span> <span class="token string">'\n'</span> <span class="token operator">not</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>log<span class="token punctuation">:</span>
                <span class="token comment"># 打印消息</span>
                listb<span class="token punctuation">.</span>insert<span class="token punctuation">(</span>END<span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
                listb<span class="token punctuation">.</span>see<span class="token punctuation">(</span>END<span class="token punctuation">)</span>
                <span class="token comment"># 保存日志</span>
                self<span class="token punctuation">.</span>log_file_write<span class="token punctuation">.</span>write<span class="token punctuation">(</span>msg <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>
                <span class="token comment"># 添加到日志列表</span>
                self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>append<span class="token punctuation">(</span>msg <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>
            <span class="token comment"># 清空变量缓存</span>
            nickname <span class="token operator">=</span> <span class="token string">''</span>
            text <span class="token operator">=</span> <span class="token string">''</span>
            timeline <span class="token operator">=</span> <span class="token string">''</span>
            msg <span class="token operator">=</span> <span class="token string">''</span>


<span class="token keyword">def</span> <span class="token function">bilibili</span><span class="token punctuation">(</span>delay<span class="token punctuation">,</span> room_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 创建bDanmu实例</span>
    bDanmu <span class="token operator">=</span> Danmu<span class="token punctuation">(</span>room_id<span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token comment"># 暂停防止cpu占用过高</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>delay<span class="token punctuation">)</span>
        <span class="token comment"># 获取弹幕</span>
        bDanmu<span class="token punctuation">.</span>get_danmu<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">author</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 弹出对话框</span>
    messagebox<span class="token punctuation">.</span>showinfo<span class="token punctuation">(</span>title<span class="token operator">=</span><span class="token string">'关于'</span><span class="token punctuation">,</span> message<span class="token operator">=</span><span class="token string">'作者：阿壮Jonson\n日期：2021年2月4日\n微信公众号：科技猫'</span><span class="token punctuation">)</span>


<span class="token comment"># tkinter GUI</span>
window <span class="token operator">=</span> tkinter<span class="token punctuation">.</span>Tk<span class="token punctuation">(</span><span class="token punctuation">)</span>
window<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'BiliBli弹幕查看工具'</span><span class="token punctuation">)</span>
window<span class="token punctuation">.</span>minsize<span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span>
window<span class="token punctuation">.</span>geometry<span class="token punctuation">(</span><span class="token string">'400x600+250+100'</span><span class="token punctuation">)</span>

<span class="token comment"># 菜单栏</span>
menubar <span class="token operator">=</span> tkinter<span class="token punctuation">.</span>Menu<span class="token punctuation">(</span>window<span class="token punctuation">)</span>
<span class="token comment"># Open放在菜单栏中，就是装入容器</span>
menubar<span class="token punctuation">.</span>add_command<span class="token punctuation">(</span>label<span class="token operator">=</span><span class="token string">'关于'</span><span class="token punctuation">,</span> command<span class="token operator">=</span>author<span class="token punctuation">)</span>
<span class="token comment"># 创建菜单栏完成后，配置让菜单栏menubar显示出来</span>
window<span class="token punctuation">.</span>config<span class="token punctuation">(</span>menu<span class="token operator">=</span>menubar<span class="token punctuation">)</span>

<span class="token comment"># 滚动条</span>
sc <span class="token operator">=</span> tkinter<span class="token punctuation">.</span>Scrollbar<span class="token punctuation">(</span>window<span class="token punctuation">)</span>
sc<span class="token punctuation">.</span>pack<span class="token punctuation">(</span>side<span class="token operator">=</span>tkinter<span class="token punctuation">.</span>RIGHT<span class="token punctuation">,</span> fill<span class="token operator">=</span>tkinter<span class="token punctuation">.</span>Y<span class="token punctuation">)</span>
<span class="token comment"># Listbox控件</span>
listb <span class="token operator">=</span> tkinter<span class="token punctuation">.</span>Listbox<span class="token punctuation">(</span>window<span class="token punctuation">,</span> yscrollcommand<span class="token operator">=</span>sc<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">)</span>
<span class="token comment"># 将部件放置到主窗口中</span>
listb<span class="token punctuation">.</span>pack<span class="token punctuation">(</span>side<span class="token operator">=</span>tkinter<span class="token punctuation">.</span>LEFT<span class="token punctuation">,</span> fill<span class="token operator">=</span>tkinter<span class="token punctuation">.</span>BOTH<span class="token punctuation">,</span> expand<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token comment"># 滚动条动，列表跟着动</span>
sc<span class="token punctuation">.</span>config<span class="token punctuation">(</span>command<span class="token operator">=</span>listb<span class="token punctuation">.</span>yview<span class="token punctuation">)</span>

<span class="token comment"># 获取字符串（标题，提示，初始值）</span>
room_id <span class="token operator">=</span> simpledialog<span class="token punctuation">.</span>askstring<span class="token punctuation">(</span>title<span class="token operator">=</span><span class="token string">'请输入房间号'</span><span class="token punctuation">,</span> prompt<span class="token operator">=</span><span class="token string">'请输入房间号：'</span>
                                 <span class="token punctuation">,</span> initialvalue<span class="token operator">=</span><span class="token string">'21089733'</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> room_id <span class="token keyword">is</span> <span class="token operator">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token comment"># 创建获取弹幕线程</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        t <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>bilibili<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>room_id<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        t<span class="token punctuation">.</span>setDaemon<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Error: 启动失败！请检查房间号是否正确"</span><span class="token punctuation">)</span>
<span class="token comment"># 进入循环显示</span>
window<span class="token punctuation">.</span>mainloop<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="_121"></a>编译</h2> 
<p>使用第三方包：pyinstaller</p> 
<h3><a id="_123"></a>命令</h3> 
<pre><code class="prism language-python">pyinstaller <span class="token operator">-</span>F <span class="token operator">-</span>w bilibli<span class="token operator">-</span>danmu<span class="token punctuation">.</span>py
</code></pre> 
<h3><a id="_127"></a>参数解释</h3> 
<ul><li>-F，-onefile 产生单个的可执行文件</li><li>-w，–windowed，–noconsolc 指定程序运行时不显示命令行窗口（仅对 Windows 有效）</li></ul> 
<h3><a id="PyInstaller__130"></a>PyInstaller 支持的常用选项</h3> 
<p><img src="https://images2.imgbox.com/e6/b2/3kCJY87J_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_132"></a>补充</h3> 
<ol><li>执行完命令之后会在项目目录下多出dist文件夹，编译后的文件就在该文件夹下</li><li>pyinstaller 不可以跨平台编译，windows平台下只能编译成windows下的执行文件(.exe)，同理mac linux也是一样</li></ol>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/33a5cdbf7813c8260cc2f8660f3eef22/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">C/C&#43;&#43;学习路线图--从C小白到C界精英  #CSDN博文精选# #IT技术# #学习路线# #系统化学习#</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/dd10d7866c922afad55e871c827bbae5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">树莓派ROS stm32 slam Freertos VFH&#43;A*避障路径规划-智能平衡计划（四）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>