<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>FreeSWITCH 对接IMS平台相关材料汇编 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="FreeSWITCH 对接IMS平台相关材料汇编" />
<meta property="og:description" content="freeswitch与各种设备对接的成功配置，需要的请参考，有错误的地方请指导。
1、对接华为softco
中继配置
\sip_profiles\external\
拨号规则
出局
\conf\dialplan\default\
--加拨9至softco softco侧配置对端SIP端口为5080
2、对接网络电话提供商
中继配置
\sip_profiles\external\
&lt;include&gt;
&lt;gateway name=&#34;sip_isp&#34;&gt;
&lt;param name=&#34;username&#34; value=&#34;username&#34;/&gt;
&lt;param name=&#34;password&#34; value=&#34;password&#34;/&gt;
&lt;param name=&#34;realm&#34; value=&#34;$${local_ip_v4}&#34;/&gt;
&lt;param name=&#34;from-domain&#34; value=&#34;sip.isp.com&#34;/&gt; &lt;/gateway&gt;
&lt;/include&gt;
拨号规则
\conf\dialplan\default\
&lt;include&gt;
&lt;extension name=&#34;sip_isp_outbound&#34;&gt;
&lt;condition field=&#34;destination_number&#34; expression=&#34;^(1\d{10})$&#34;&gt;
&lt;action application=&#34;bridge&#34; data=&#34;sofia/gateway/sip_isp/$1&#34;/&gt;
&lt;/condition&gt;
&lt;/extension&gt;
&lt;/include&gt;
3、电信IMS对接
中继配置
\sip_profiles\external\
&lt;include&gt; &lt;gateway name=&#34;gd_ims&#34;&gt; &lt;param name=&#34;username&#34; value=&#34;&#43;8675512345678&#34;/&gt; &lt;param name=&#34;from-user&#34; value=&#34;&#43;8675512345678&#34;/&gt; &lt;param name=&#34;realm&#34; value=&#34;$${local_ip_v4}&#34;/&gt; &lt;param name=&#34;auth-username&#34; value=&#34;&#43;8675512345678@gd.ctcims.cn&#34;/&gt; &lt;param name=&#34;proxy&#34; value=&#34;gd.ctcims.cn&#34;/&gt; &lt;param name=&#34;from-domain&#34; value=&#34;gd.ctcims.cn&#34;/&gt; &lt;param name=&#34;register-proxy&#34; value=&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/6190d673e8f44565359dd22ca4f2b88c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-03-19T15:36:20+08:00" />
<meta property="article:modified_time" content="2021-03-19T15:36:20+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">FreeSWITCH 对接IMS平台相关材料汇编</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>freeswitch与各种设备对接的成功配置，需要的请参考，有错误的地方请指导。</p> 
<p>1、对接华为softco</p> 
<p>中继配置</p> 
<p>\sip_profiles\external\</p> 
<p>拨号规则</p> 
<p>出局</p> 
<p>\conf\dialplan\default\</p> 
<p>--加拨9至softco softco侧配置对端SIP端口为5080</p> 
<p>2、对接网络电话提供商</p> 
<p>中继配置</p> 
<p>\sip_profiles\external\</p> 
<p>&lt;include&gt;<br>     &lt;gateway name="sip_isp"&gt;<br>       &lt;param name="username" value="username"/&gt;<br>       &lt;param name="password" value="password"/&gt;<br>       &lt;param name="realm" value="$${local_ip_v4}"/&gt;<br>       &lt;param name="from-domain" value="sip.isp.com"/&gt; <br>     &lt;/gateway&gt;<br> &lt;/include&gt;</p> 
<p>拨号规则</p> 
<p>\conf\dialplan\default\</p> 
<p>&lt;include&gt;<br>   &lt;extension name="sip_isp_outbound"&gt;<br>     &lt;condition field="destination_number" expression="^(1\d{10})$"&gt;<br>     &lt;action application="bridge" data="sofia/gateway/sip_isp/$1"/&gt;<br>     &lt;/condition&gt;<br>   &lt;/extension&gt;<br> &lt;/include&gt;</p> 
<p>3、电信IMS对接</p> 
<p>中继配置</p> 
<p>\sip_profiles\external\</p> 
<pre><code class="language-XML">&lt;include&gt;
&lt;gateway name="gd_ims"&gt;
&lt;param name="username" value="+8675512345678"/&gt;
&lt;param name="from-user" value="+8675512345678"/&gt;
&lt;param name="realm" value="$${local_ip_v4}"/&gt;
&lt;param name="auth-username" value="+8675512345678@gd.ctcims.cn"/&gt;
&lt;param name="proxy" value="gd.ctcims.cn"/&gt;
&lt;param name="from-domain" value="gd.ctcims.cn"/&gt;
&lt;param name="register-proxy" value="116.31.226.17"/&gt;
&lt;param name="outbound-proxy" value="bac01.sz.gd.ctcims.cn"/&gt;
&lt;param name="password" value="password"/&gt;
&lt;param name="register" value="true"/&gt;
&lt;param name="expire-seconds" value="3600"/&gt;
&lt;param name="retry-seconds" value="30"/&gt;
&lt;param name="ping" value="25"/&gt;
&lt;param name="context" value="public"/&gt;
&lt;param name="sip-ip" value="$${local_ip_v4}"/&gt;
&lt;/gateway&gt;
&lt;/include&gt;</code></pre> 
<p><br><br> &lt;!-- realm：域名 --&gt;<br> &lt;!-- username：认证的用户名 --&gt;<br> &lt;!-- password：认证的密码 --&gt;<br> &lt;!-- from-user：指定在SIP消息中的源用户信息，没有配置则默认和username相同 --&gt;<br> &lt;!-- from-domain：是指定域，它们会影响SIP中的“From”头域。 --&gt;<br> &lt;!-- regitster-proxy：表示注册的地址 --&gt;<br> &lt;!-- outbound-proxy：表示呼出时指向的地址，这里其实和注册地址是一致的 --&gt;<br> &lt;!-- register：是否注册 --&gt;<br> &lt;!-- expire-seconds：注册的间隔时间 --&gt;<br> -----------------------------------<br>  </p> 
<p>中继配置</p> 
<p>\sip_profiles\external\</p> 
<p>拨号规则</p> 
<p>出局</p> 
<p>\conf\dialplan\default\</p> 
<p>&lt;include&gt;<br>   &lt;extension name="gd_ims_out"&gt;<br>     &lt;condition field="destination_number" expression="^(0\d{11}|0\d{10}|1\d{10}|\1d{2}|1\d{4}|[2-8]\d{7}|9\d{4}|9\d{5})$"&gt;     &lt;!--出局--&gt;<br>       &lt;action  application="start_dtmf_generate"/&gt;  &lt;!-- 解决不能二次拨号，深圳电信只支持inband收号方式--&gt;<br>     &lt;action application="set" data="effective_caller_id_number=+8675512345678"/&gt;&lt;!-- 主叫号码 --&gt;<br>     &lt;action application="set" data="effective_caller_id_name=eSpace7950"/&gt; &lt;!-- 主叫设备名 --&gt;<br>     &lt;action application="bridge" data="sofia/gateway/gd_ims/$1@116.31.226.17"/&gt;  &lt;!-- 在openwrt需要添加“@目的IP（域名可能不行）”--&gt;<br>     &lt;/condition&gt;<br>   &lt;/extension&gt;<br> &lt;/include&gt;</p> 
<p>拨号规则</p> 
<p>入局</p> 
<p>\conf\dialplan\public\</p> 
<p>&lt;include&gt;<br>   &lt;extension name="ims_in_1"&gt;<br>   &lt;!-- 转接不成功转语音信箱 --&gt;<br>   &lt;condition field="destination_number" expression="8675512345678$"&gt;<br>   &lt;action application="set" data="call_timeout=30"/&gt;<br>   &lt;action application="set" data="hangup_after_bridge=true"/&gt;<br>   &lt;action application="set" data="continue_on_fail=true"/&gt;<br>   &lt;action application="transfer" data="1002 XML default"/&gt;<br>   &lt;action application="answer"/&gt;<br>   &lt;action application="sleep" data="1000"/&gt;<br>   &lt;action application="bridge" data="loopback/app=voicemail:default ${domain_name} 1002"/&gt;<br>   &lt;/condition&gt;<br>   &lt;/extension&gt;<br> &lt;/include&gt;</p> 
<p>4、对接华为UAP6600</p> 
<p>中继配置</p> 
<p>\sip_profiles\external\</p> 
<p>拨号规则</p> 
<p>出局</p> 
<p>\conf\dialplan\default\</p> 
<p><strong>FreeSWICTCH —-&gt; 语音网关 —-&gt; 运营商 —-&gt; 手机或固话</strong></p> 
<p></p> 
<p><strong>配置信息</strong></p> 
<p>中继配置<br> conf\sip_profiles\external</p> 
<p>二、配置外呼</p> 
<p>首先你要有某个运营商提供的sip账号，该SIP账号（或提供该账号的设备）在 FreeSWITCH 中称为SIP网关（Gateway）。添加一个网关只需要在<strong> conf/sip_profiles/external/</strong>中创建一个XML文件：内容是：<strong>SIP服务器地址，可以是IP或IP:端口号  SIP用户名   密码</strong></p> 
<blockquote> 
 <p>&lt;gateway name="gw1"&gt;<br>     &lt;param name="realm" value="SIP服务器地址，可以是IP或IP:端口号"/&gt;<br>     &lt;param name="username" value="SIP用户名"/&gt;<br>     &lt;param name="password" value="密码"/&gt;<br> &lt;/gateway&gt;</p> 
</blockquote> 
<p>重启FS，使修改生效</p> 
<p>或者指令freeswitch&gt; <strong>sofia profile external rescan</strong></p> 
<p>显示一下网关的注册状态：</p> 
<pre><code>freeswitch&gt; sofia status
</code></pre> 
<p>如果显示 gateway gw1 的状态是 REGED，则表明已正确地注册到了网关上。你可以先用命令试一下网关是否工作正常：</p> 
<pre><code>freeswitch&gt; originate sofia/gateway/gw1/xxxxxx &amp;echo</code></pre> 
<p><strong>3.5.1　从某一分机上呼出</strong></p> 
<p>修改拨号计划，创建一个新的XML文件— conf/dialplan/default/call_out.xml，内容如下：</p> 
<pre> </pre> 
<blockquote>
  &lt;include&gt; 
 <br>   &lt;extension name="call out"&gt; 
 <br>     &lt;condition field="destination_number" expression="^0(\d+)$"&gt; 
 <br>       &lt;action application="bridge" data="sofia/gateway/gw1/$1"/&gt; 
 <br>     &lt;/condition&gt; 
 <br>   &lt;/extension&gt; 
 <br> &lt;/include&gt; 
</blockquote> 
<p>其中，“^0(d+)$”为正则表达式，“(d+)”匹配 0 后面的所有数字并存到变量$1中。然后通过bridge程序通过网关gw1打出该号码。当然，建立该XML后需要在控制台中执行reloadxml使之生效</p> 
<p><strong>3.5.2　呼入电话处理</strong></p> 
<p>创建以下XML文件并放到 conf/dialplan/public/my_did.xml中：</p> 
<blockquote> 
 <p>&lt;include&gt;<br>   &lt;extension name="public_did"&gt;<br>     &lt;condition field="destination_number" expression="^(你的DID)$"&gt;<br>       &lt;action application="transfer" data="1000 XML default"/&gt;<br>     &lt;/condition&gt;<br>   &lt;/extension&gt;<br> &lt;/include&gt;</p> 
</blockquote> 
<p>在FreeSWITCH中执行reloadxml使之生效。上述配置会将来话直接转接到分机 1000 上</p> 
<p><strong>4、总结：</strong></p> 
<p>FreeSWITCH的外呼场景主要通过配置网关注册、拨号计划来实现，实际上外呼中的呼叫、转接、会议都要用到这两个技术</p> 
<p>网关如果在同一网段或者网关在FreeSWITCH的外网的话（实际上就是说FreeSWITCH可以直接访问到网关），就采用FreeSWITCH注册到网关或者指向网关的方式，这也是常用的方式。 如果网关在内网，而FreeSWITCH在外网的话，就只能采用内网网关注册到FreeSWITCH的方式。</p> 
<p>拨号计划是 FreeSWITCH 中至关重要的一部分。它的主要作用就是对电话进行路由（从这一点上来说，相当于一个路由表）。说的简明一点，就是当一个用户拨号时，对用户所拨的号码进行分析，进而决定下一步该做什么。当然，实际上，它所能做的比你想象的要强大的多。</p> 
<p></p> 
<h4><strong>对接移动公司IMS：</strong></h4> 
<p>移动的IMS对接都是注册的模式对接的，所以废话不多说，直接上gateway配置数据</p> 
<p>&lt;include&gt;<br> &lt;gateway name="8610xxxxxxx"&gt;     //此处的格式为86+区号+号码（区号不带0）<br> &lt;param name="realm" value="ims.gd.chinamobile.com"/&gt;  //运营商提供的域名<br> &lt;param name="register-transport" value="udp"/&gt;<br> &lt;param name="username" value="8610xxxxxxx@ims.gd.chinamobile.com"/&gt;<br> &lt;param name="password" value="123456"/&gt;<br> &lt;param name="from-domain" value="ims.gd.chinamobile.com"/&gt;<br> &lt;param name="register-proxy" value="10.0.0.0"/&gt;   //运营商地址<br> &lt;param name="proxy" value="ims.gd.chinamobile.com"/&gt;<br> &lt;param name="register" value="true"/&gt;<br> &lt;param name="extension-in-contact" value="true"/&gt;<br> &lt;param name="extension" value="+8610xxxxxxx"/&gt;<br> &lt;param name="from-user" value="+8610xxxxxxx"/&gt;<br> &lt;param name="expire-seconds" value="3600"/&gt;<br> &lt;param name="caller-id-in-from" value="false"/&gt;<br> &lt;/gateway&gt;<br> &lt;/include&gt;</p> 
<p>至此网关处就已对接完毕，一个号码一个gateway，新增gateway可用sofia profile external rescan进行生效，若号码注销需要删除可用sofia profile external killgw 8610xxxxxxx进行删除。</p> 
<p>跟移动对接需开启100rel功能，并将invite中的fmtp:101 0-16修改为0-15否则会导致通话接起秒断的现象。此处的修改在源码下./src/switch_core_media.c文件，进入文件搜索0-16</p> 
<p>将上图两个地方的0-16修改为图中的0-15即可。</p> 
<p>再将invite中的Supported: precondition,去掉，否则会导致通话异常。此处修改源码中的./src/mod/endpoints/mod_sofia/sofia.c文件搜索precondition,大致在3055行。去掉precondition即可，以上两个操作均需重新编译源码，并重启FS进程方可生效。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a29a758b11f16958159b569ae2f02efc/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">es Root mapping definition has unsupported parameters解决方法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c4ceede08024352a4b5dbd741ea5d1c3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">uniapp 账号登陆，账号绑定/解绑流程，躺坑</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>