<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Window网络编程之简单TCP建立 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Window网络编程之简单TCP建立" />
<meta property="og:description" content="目录 步骤分解搭建SOCKET开发环境开发环境说明启动SOCKET说明 创建TCP服务器创建SOCKET原型使用 绑定端口原型使用 监听连接原型使用 连接客户端原型使用 向客户端发送数据原型使用 关闭服务器原型使用 创建TCP客户端创建SOCKET使用 连接服务器原型使用 接收数据原型使用 运行结果 步骤分解 服务端建立
步骤说明涉及函数建立服务端SOCKETsocket绑定服务IP和端口bind监听网络端口listen等待建立连接accept发送数据send关闭服务端SOCKETclosesocket 客户端建立
步骤说明涉及函数建立客户端SOCKETsocket连接服务器connect接收数据recv关闭服务端SOCKETclosesocket 搭建SOCKET开发环境 开发环境说明 window下进行SOCKET编程依赖两个库如下所示：
较早的DLL是wsock32.dll，对应的头文件为winsock1.h；最新的DLL是ws2_32.dll，对应的头文件为winsock2.h。 基本所有的window操作系统都已经支持了ws2_32.dll，因此可以直接使用这个库无需考虑第一个比较早的库。除了导入头文件之外还需要导入ws2_32.lib链接库，可使用显示导入方式
#pragma comment (lib, &#34;ws2_32.lib&#34;) 如果在vs开发环境下也可以在项目属性中添加依赖库，如果使用Clion则在CMakeLists中add_executable语句前增加一条语句
link_libraries(ws2_32) 启动SOCKET说明 SOCKET标准的启动过程如下：
#include &lt;iostream&gt; #include &lt;WinSock2.h&gt; int main(int argc, char * argv[]) { WSADATA wsa_data; WSAStartup(MAKEWORD(2, 2), &amp;wsa_data); // ...... WSACleanup(); return 0; } 使用MAKEWORD(2, 2)来明确SOCKET的版本号，WinSock规范的最新版本号为2.2版本，wsock32.dll仅支持1.0和1.1，wsock32.dll已经能够很好的支持TCP/IP通信程序的开发，ws2_32.dll主要增加了对其他协议的支持，建议使用最新的2.2版本。
如果当前工程中还需要用到window.h头文件，需要在引入任何头文件之前增加WIN32_LEAN_AND_MEAN宏定义，减少对较早SOCKET版本的依赖，如果能保证window.h在WinSock2.h之后引入也可不添加次宏定义。
创建TCP服务器 创建SOCKET 原型 int socket(int af, int type, int protocol); 参数说明：
字段说明参数填写af地址族，使用IP的类型AF_INET = IPv4，AF_INET6 = IPv6type数据传输方式SOCK_STREAM = 面向连接，SOCK_DGRAM = 面向连接protocol传输协议IPPROTO_TCP，IPPTOTO_UDP 使用 int main(int argc, char * argv[]) { WSADATA wsa_data; WSAStartup(MAKEWORD(2, 2), &amp;wsa_data); SOCKET server_socket = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP); WSACleanup(); return 0; } 绑定端口 原型 int bind(SOCKET sock, const struct sockaddr *addr, int addrlen); 参数说明：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/2edf2a289c4cbd4fd7f6b848dd5cd1f9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-03-27T21:05:31+08:00" />
<meta property="article:modified_time" content="2021-03-27T21:05:31+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Window网络编程之简单TCP建立</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#_2" rel="nofollow">步骤分解</a></li><li><a href="#SOCKET_22" rel="nofollow">搭建SOCKET开发环境</a></li><li><ul><li><a href="#_24" rel="nofollow">开发环境说明</a></li><li><a href="#SOCKET_42" rel="nofollow">启动SOCKET说明</a></li></ul> 
  </li><li><a href="#TCP_63" rel="nofollow">创建TCP服务器</a></li><li><ul><li><a href="#SOCKET_65" rel="nofollow">创建SOCKET</a></li><li><ul><li><a href="#_67" rel="nofollow">原型</a></li><li><a href="#_81" rel="nofollow">使用</a></li></ul> 
   </li><li><a href="#_95" rel="nofollow">绑定端口</a></li><li><ul><li><a href="#_97" rel="nofollow">原型</a></li><li><a href="#_122" rel="nofollow">使用</a></li></ul> 
   </li><li><a href="#_150" rel="nofollow">监听连接</a></li><li><ul><li><a href="#_152" rel="nofollow">原型</a></li><li><a href="#_165" rel="nofollow">使用</a></li></ul> 
   </li><li><a href="#_193" rel="nofollow">连接客户端</a></li><li><ul><li><a href="#_195" rel="nofollow">原型</a></li><li><a href="#_209" rel="nofollow">使用</a></li></ul> 
   </li><li><a href="#_236" rel="nofollow">向客户端发送数据</a></li><li><ul><li><a href="#_238" rel="nofollow">原型</a></li><li><a href="#_253" rel="nofollow">使用</a></li></ul> 
   </li><li><a href="#_271" rel="nofollow">关闭服务器</a></li><li><ul><li><a href="#_273" rel="nofollow">原型</a></li><li><a href="#_285" rel="nofollow">使用</a></li></ul> 
  </li></ul> 
  </li><li><a href="#TCP_302" rel="nofollow">创建TCP客户端</a></li><li><ul><li><a href="#SOCKET_304" rel="nofollow">创建SOCKET</a></li><li><ul><li><a href="#_308" rel="nofollow">使用</a></li></ul> 
   </li><li><a href="#_322" rel="nofollow">连接服务器</a></li><li><ul><li><a href="#_324" rel="nofollow">原型</a></li><li><a href="#_332" rel="nofollow">使用</a></li></ul> 
   </li><li><a href="#_357" rel="nofollow">接收数据</a></li><li><ul><li><a href="#_359" rel="nofollow">原型</a></li><li><a href="#_375" rel="nofollow">使用</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_397" rel="nofollow">运行结果</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_2"></a>步骤分解</h2> 
<ul><li> <p>服务端建立</p> 
  <table><thead><tr><th align="left">步骤说明</th><th align="left">涉及函数</th></tr></thead><tbody><tr><td align="left">建立服务端SOCKET</td><td align="left">socket</td></tr><tr><td align="left">绑定服务IP和端口</td><td align="left">bind</td></tr><tr><td align="left">监听网络端口</td><td align="left">listen</td></tr><tr><td align="left">等待建立连接</td><td align="left">accept</td></tr><tr><td align="left">发送数据</td><td align="left">send</td></tr><tr><td align="left">关闭服务端SOCKET</td><td align="left">closesocket</td></tr></tbody></table></li><li> <p>客户端建立</p> 
  <table><thead><tr><th align="left">步骤说明</th><th align="left">涉及函数</th></tr></thead><tbody><tr><td align="left">建立客户端SOCKET</td><td align="left">socket</td></tr><tr><td align="left">连接服务器</td><td align="left">connect</td></tr><tr><td align="left">接收数据</td><td align="left">recv</td></tr><tr><td align="left">关闭服务端SOCKET</td><td align="left">closesocket</td></tr></tbody></table></li></ul> 
<h2><a id="SOCKET_22"></a>搭建SOCKET开发环境</h2> 
<h3><a id="_24"></a>开发环境说明</h3> 
<p>window下进行SOCKET编程依赖两个库如下所示：</p> 
<ul><li>较早的DLL是<code>wsock32.dll</code>，对应的头文件为<code>winsock1.h</code>；</li><li>最新的DLL是<code>ws2_32.dll</code>，对应的头文件为<code>winsock2.h</code>。</li></ul> 
<p>基本所有的window操作系统都已经支持了<code>ws2_32.dll</code>，因此可以直接使用这个库无需考虑第一个比较早的库。除了导入头文件之外还需要导入<code>ws2_32.lib</code>链接库，可使用显示导入方式</p> 
<pre><code class="prism language-cpp"><span class="token macro property">#<span class="token directive keyword">pragma</span> comment (lib, "ws2_32.lib")</span>
</code></pre> 
<p>如果在vs开发环境下也可以在<code>项目属性中添加依赖库</code>，如果使用Clion则在CMakeLists中<code>add_executable</code>语句前增加一条语句</p> 
<pre><code class="prism language-cmake">link_libraries(ws2_32)
</code></pre> 
<h3><a id="SOCKET_42"></a>启动SOCKET说明</h3> 
<p>SOCKET标准的启动过程如下：</p> 
<pre><code class="prism language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;WinSock2.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    WSADATA wsa_data<span class="token punctuation">;</span>
    <span class="token function">WSAStartup</span><span class="token punctuation">(</span><span class="token function">MAKEWORD</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>wsa_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ......</span>
    <span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>使用<code>MAKEWORD(2, 2)</code>来明确SOCKET的版本号，WinSock规范的最新版本号为<code>2.2</code>版本，<code>wsock32.dll</code>仅支持<code>1.0</code>和<code>1.1</code>，<code>wsock32.dll</code>已经能够很好的支持<code>TCP/IP</code>通信程序的开发，<code>ws2_32.dll</code>主要增加了对其他协议的支持，建议使用最新的<code>2.2</code>版本。</p> 
<p>如果当前工程中还需要用到<code>window.h</code>头文件，需要在引入任何头文件之前增加<code>WIN32_LEAN_AND_MEAN</code>宏定义，减少对较早SOCKET版本的依赖，如果能保证<code>window.h</code>在<code>WinSock2.h</code>之后引入也可不添加次宏定义。</p> 
<h2><a id="TCP_63"></a>创建TCP服务器</h2> 
<h3><a id="SOCKET_65"></a>创建SOCKET</h3> 
<h4><a id="_67"></a>原型</h4> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">socket</span><span class="token punctuation">(</span><span class="token keyword">int</span> af<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>参数说明：</p> 
<table><thead><tr><th align="left">字段</th><th align="left">说明</th><th align="left">参数填写</th></tr></thead><tbody><tr><td align="left">af</td><td align="left">地址族，使用IP的类型</td><td align="left">AF_INET = IPv4，AF_INET6 = IPv6</td></tr><tr><td align="left">type</td><td align="left">数据传输方式</td><td align="left">SOCK_STREAM = 面向连接，SOCK_DGRAM = 面向连接</td></tr><tr><td align="left">protocol</td><td align="left">传输协议</td><td align="left">IPPROTO_TCP，IPPTOTO_UDP</td></tr></tbody></table> 
<h4><a id="_81"></a>使用</h4> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    WSADATA wsa_data<span class="token punctuation">;</span>
    <span class="token function">WSAStartup</span><span class="token punctuation">(</span><span class="token function">MAKEWORD</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>wsa_data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    SOCKET server_socket <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> IPPROTO_TCP<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_95"></a>绑定端口</h3> 
<h4><a id="_97"></a>原型</h4> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">bind</span><span class="token punctuation">(</span>SOCKET sock<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> sockaddr <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token keyword">int</span> addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>参数说明：</p> 
<table><thead><tr><th align="left">字段</th><th align="left">说明</th><th align="left">参数填写</th></tr></thead><tbody><tr><td align="left">sock</td><td align="left">SOCKET对象</td><td align="left">使用socket创建的对象后返回的对象</td></tr><tr><td align="left">addr</td><td align="left">SOCKET地址结构体</td><td align="left">外部创建好并填写，IP、端口等信息</td></tr><tr><td align="left">addrlen</td><td align="left">SOCKET地址结构体长度</td><td align="left">-</td></tr></tbody></table> 
<p>结构体定义：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">struct</span> sockaddr_in<span class="token punctuation">{<!-- --></span>
    sa_family_t     sin_family<span class="token punctuation">;</span>   <span class="token comment">//地址族（Address Family），也就是地址类型</span>
    <span class="token keyword">uint16_t</span>        sin_port<span class="token punctuation">;</span>     <span class="token comment">//16位的端口号</span>
    <span class="token keyword">struct</span> in_addr  sin_addr<span class="token punctuation">;</span>     <span class="token comment">//32位IP地址</span>
    <span class="token keyword">char</span>            sin_zero<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">//不使用，一般用0填充</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_122"></a>使用</h4> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    WSADATA wsa_data<span class="token punctuation">;</span>
    <span class="token function">WSAStartup</span><span class="token punctuation">(</span><span class="token function">MAKEWORD</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>wsa_data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ......</span>

    <span class="token comment"> 绑定地址和端口 </span>
    SOCKADDR_IN sock_add_in<span class="token punctuation">;</span>
    sock_add_in<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    sock_add_in<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">9090</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sock_add_in<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>S_un<span class="token punctuation">.</span>S_addr <span class="token operator">=</span> INADDR_ANY<span class="token punctuation">;</span>
    <span class="token keyword">int</span> bind_result <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>server_socket<span class="token punctuation">,</span> <span class="token punctuation">(</span>SOCKADDR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>sock_add_in<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>SOCKADDR_IN<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bind_result <span class="token operator">==</span> SOCKET_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"bind error."</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>其中<code>INADDR_ANY</code>表示当前服务器可以接收任意客户端请求，也可填写具体IP地址，地址填写的时候使用<code>inet_addr</code>函数进行转换。端口号的填写也是一样的需要使用<code>htons</code>函数进行转换。</p> 
<p>在进行绑定时需要将<code>SOCKADDR_IN</code>强转换成<code>SOCKADDR</code>结构体，这两个结构体的长度是相同的都是16字节，可以简单的认为<code>SOCKADDR</code>是一种通用的结构体，可以用来保存多种类型的IP地址和端口号，而<code>SOCKADDR_IN</code>是专门用来保存<code>IPv4</code>地址的结构体。另外还有<code>SOCKADDR_IN6_LH</code>是专门用来保存<code>IPv6</code>地址的结构体。</p> 
<h3><a id="_150"></a>监听连接</h3> 
<h4><a id="_152"></a>原型</h4> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">listen</span><span class="token punctuation">(</span>SOCKET sock<span class="token punctuation">,</span> <span class="token keyword">int</span> backlog<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>参数说明：</p> 
<table><thead><tr><th align="left">字段</th><th align="left">说明</th><th align="left">参数填写</th></tr></thead><tbody><tr><td align="left">sock</td><td align="left">SOCKET对象</td><td align="left">使用socket创建的对象后返回的对象</td></tr><tr><td align="left">backlog</td><td align="left">请求队列的最大长度</td><td align="left">-</td></tr></tbody></table> 
<h4><a id="_165"></a>使用</h4> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    WSADATA wsa_data<span class="token punctuation">;</span>
    <span class="token function">WSAStartup</span><span class="token punctuation">(</span><span class="token function">MAKEWORD</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>wsa_data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ......</span>

    <span class="token comment"> 监听连接 </span>
    <span class="token keyword">int</span> listen_result <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>server_socket<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>listen_result <span class="token operator">==</span> SOCKET_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"listen error."</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>listen</code>使SOCKET进入监听状态，其中<code>backlog为请求队列的最大长度</code>。<code>动监听</code>是指当没有客户端请求时，SOCKET处于<code>睡眠</code>状态，只有当接收到客户端请求时，SOCKET才会被<code>唤醒</code>来响应请求。</p> 
<p>当SOCKET正在处理客户端请求时，如果有<code>新的请求进来</code>SOCKET是没法处理，只能<code>把它放进缓冲区</code>，待当前请求处理完毕后，再从缓冲区中读取出来处理。如果不断有新的请求进来，它们就按照先后顺序在缓冲区中排队直到缓冲区满。这个缓冲区，就称为请求队列(Request Queue)。</p> 
<p>缓冲区的长度<code>(即，能存放多少个客户端请求)</code>可以通过backlog参数指定，可以根据需求来定，并发量小的话可以是10或者20，或者将backlog的值设置为<code>SOMAXCONN</code>由系统来决定请求队列长度，这个值一般比较大可能是几百或者更多。</p> 
<p>当请求队列满时，就不再接收新的请求，客户端会收到<code>WSAECONNREFUSED</code>错误。</p> 
<h3><a id="_193"></a>连接客户端</h3> 
<h4><a id="_195"></a>原型</h4> 
<pre><code class="prism language-cpp">SOCKET <span class="token function">accept</span><span class="token punctuation">(</span>SOCKET sock<span class="token punctuation">,</span> <span class="token keyword">struct</span> sockaddr <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>参数说明：</p> 
<table><thead><tr><th align="left">字段</th><th align="left">说明</th><th align="left">参数填写</th></tr></thead><tbody><tr><td align="left">sock</td><td align="left">SOCKET对象</td><td align="left">使用socket创建的对象后返回的对象</td></tr><tr><td align="left">addr</td><td align="left">客户端SOCKET地址结构体</td><td align="left">空结构体在接收连接请求的时候填写填充客户端信息</td></tr><tr><td align="left">addrlen</td><td align="left">客户端SOCKET地址结构体</td><td align="left">客户端SOCKET地址结构体的长度</td></tr></tbody></table> 
<h4><a id="_209"></a>使用</h4> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    WSADATA wsa_data<span class="token punctuation">;</span>
    <span class="token function">WSAStartup</span><span class="token punctuation">(</span><span class="token function">MAKEWORD</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>wsa_data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ......</span>

    <span class="token comment"> 处理连接 </span>
    SOCKADDR_IN client_add_in <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> client_lent <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>SOCKADDR_IN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    SOCKET client_socket <span class="token operator">=</span> INVALID_SOCKET<span class="token punctuation">;</span>
    client_socket <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>server_socket<span class="token punctuation">,</span> <span class="token punctuation">(</span>SOCKADDR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>client_add_in<span class="token punctuation">,</span> <span class="token operator">&amp;</span>client_lent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>client_socket <span class="token operator">==</span> INVALID_SOCKET<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"client connect error."</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>listen只是让SOCKET进入监听状态并没有真正接收客户端请求，listen后面的代码会继续执行，accept才是处理请求的函数，accept会阻塞当前线程执行。</p> 
<p>accept返回<code>一个新的SOCKET</code>来和客户端通信，其中<code>SOCKADDR_IN结构会被填充</code>，描述了客户端的<code>IP地址</code>和<code>端口号</code>。</p> 
<h3><a id="_236"></a>向客户端发送数据</h3> 
<h4><a id="_238"></a>原型</h4> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">send</span><span class="token punctuation">(</span>SOCKET sock<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> buf<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>参数说明：</p> 
<table><thead><tr><th align="left">字段</th><th align="left">说明</th><th align="left">参数填写</th></tr></thead><tbody><tr><td align="left">sock</td><td align="left">SOCKET对象</td><td align="left">使用accept后返回的SOCKET对象</td></tr><tr><td align="left">buf</td><td align="left">发送数据包缓存地址</td><td align="left">发送的实际数据地址</td></tr><tr><td align="left">len</td><td align="left">发送的数据的字节数</td><td align="left">-</td></tr><tr><td align="left">flags</td><td align="left">为发送数据时的选项</td><td align="left">一般填0</td></tr></tbody></table> 
<h4><a id="_253"></a>使用</h4> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    WSADATA wsa_data<span class="token punctuation">;</span>
    <span class="token function">WSAStartup</span><span class="token punctuation">(</span><span class="token function">MAKEWORD</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>wsa_data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// .....</span>
    
    <span class="token comment"> 发送数据 </span>
    <span class="token keyword">char</span> message<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Build TCP Connect."</span><span class="token punctuation">;</span>
    <span class="token function">send</span><span class="token punctuation">(</span>client_socket<span class="token punctuation">,</span> message<span class="token punctuation">,</span> <span class="token function">strnlen_s</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_271"></a>关闭服务器</h3> 
<h4><a id="_273"></a>原型</h4> 
<pre><code class="prism language-cpp"><span class="token function">closesocket</span><span class="token punctuation">(</span>SOCKET s<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>参数说明：</p> 
<table><thead><tr><th align="left">字段</th><th align="left">说明</th><th align="left">参数填写</th></tr></thead><tbody><tr><td align="left">s</td><td align="left">SOCKET对象</td><td align="left">使用socket创建的对象后返回的对象</td></tr></tbody></table> 
<h4><a id="_285"></a>使用</h4> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    WSADATA wsa_data<span class="token punctuation">;</span>
    <span class="token function">WSAStartup</span><span class="token punctuation">(</span><span class="token function">MAKEWORD</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>wsa_data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ......</span>

    <span class="token comment"> 关闭服务器 </span>
    <span class="token function">closesocket</span><span class="token punctuation">(</span>server_socket<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="TCP_302"></a>创建TCP客户端</h2> 
<h3><a id="SOCKET_304"></a>创建SOCKET</h3> 
<p>客户端创建SOCKET的步骤与服务器创建SOCKET步骤一致。</p> 
<h4><a id="_308"></a>使用</h4> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    WSADATA wsa_data<span class="token punctuation">;</span>
    <span class="token function">WSAStartup</span><span class="token punctuation">(</span><span class="token function">MAKEWORD</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>wsa_data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    SOCKET client_socket <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> IPPROTO_TCP<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_322"></a>连接服务器</h3> 
<h4><a id="_324"></a>原型</h4> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">connect</span><span class="token punctuation">(</span>SOCKET sock<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> sockaddr <span class="token operator">*</span>serv_addr<span class="token punctuation">,</span> <span class="token keyword">int</span> addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>参数和<code>bind</code>一样，不同的是客户端连接的时候需要指定服务器的具体IP。</p> 
<h4><a id="_332"></a>使用</h4> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    WSADATA wsa_data<span class="token punctuation">;</span>
    <span class="token function">WSAStartup</span><span class="token punctuation">(</span><span class="token function">MAKEWORD</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>wsa_data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ......</span>

    <span class="token comment"> 连接服务器 </span>
    SOCKADDR_IN sock_add_in<span class="token punctuation">;</span>
    sock_add_in<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    sock_add_in<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">9090</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sock_add_in<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>S_un<span class="token punctuation">.</span>S_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> connect_result <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span>client_socket<span class="token punctuation">,</span> <span class="token punctuation">(</span>sockaddr<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>sock_add_in<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>SOCKADDR_IN<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>connect_result <span class="token operator">==</span> SOCKET_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"connect error."</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_357"></a>接收数据</h3> 
<h4><a id="_359"></a>原型</h4> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">recv</span><span class="token punctuation">(</span>SOCKET sock<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>参数说明：</p> 
<table><thead><tr><th align="left">字段</th><th align="left">说明</th><th align="left">参数填写</th></tr></thead><tbody><tr><td align="left">sock</td><td align="left">SOCKET对象</td><td align="left">使用socket创建的SOCKET对象</td></tr><tr><td align="left">buf</td><td align="left">接收数据包缓存地址</td><td align="left">接收到数据后存放的内存地址</td></tr><tr><td align="left">len</td><td align="left">数据缓存区的大小</td><td align="left">-</td></tr><tr><td align="left">flags</td><td align="left">为发送数据时的选项</td><td align="left">一般填0</td></tr></tbody></table> 
<h4><a id="_375"></a>使用</h4> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    WSADATA wsa_data<span class="token punctuation">;</span>
    <span class="token function">WSAStartup</span><span class="token punctuation">(</span><span class="token function">MAKEWORD</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>wsa_data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ......</span>

    <span class="token comment"> 接收数据 </span>
    <span class="token keyword">int</span> recv_len <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>client_socket<span class="token punctuation">,</span> message<span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>recv_len <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"recv message : %s"</span> <span class="token operator">&lt;&lt;</span> message <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>recv返回实际接收到的数据包的大小，可以根据返回值判断数据是否正确，最后关闭socket即可。</p> 
<h2><a id="_397"></a>运行结果</h2> 
<p><img src="https://images2.imgbox.com/52/f6/1HxLOqJ5_o.png" alt="TCP连接"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ac0db453b4b172212e7396a09d44fba7/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">正运动学建模方法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/427b9ea18b28ba177f9a9ce9a4b477cd/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">微服务架构-分布式解决方案-108：XXL-JOB分片集群模式</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>