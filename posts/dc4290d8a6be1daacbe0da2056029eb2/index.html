<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>GAMES101：作业6记录 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="GAMES101：作业6记录" />
<meta property="og:description" content="1 总览 在之前的编程练习中,我们实现了基础的光线追踪算法,具体而言是光线传输、光线与三角形求交。我们采用了这样的方法寻找光线与场景的交点:遍历场景中的所有物体,判断光线是否与它相交。在场景中的物体数量不大时,该做法可以取得良好的结果,但当物体数量增多、模型变得更加复杂,该做法将会变得非常低效。因此,我们需要加速结构来加速求交过程。在本次练习中,我们重点关注物体划分算法 Bounding Volume Hierarchy (BVH)。本练习要求你实现 Ray-BoundingVolume 求交与 BVH 查找。
首先,你需要从上一次编程练习中引用以下函数:
Render() in Renderer.cpp: 将你的光线生成过程粘贴到此处,并且按照新框
架更新相应调用的格式。Triangle::getIntersection in Triangle.hpp: 将你的光线-三角形相交函数粘贴到此处,并且按照新框架更新相应相交信息的格式。 在本次编程练习中,你需要实现以下函数:
IntersectP(const Ray&amp; ray, const Vector3f&amp; invDir, const std::array&lt;int, 3&gt;&amp; dirIsNeg) in Bounds3.hpp: 这个函数的作用是判断包围盒 BoundingBox 与光线是否相交,你需要按照课程介绍的算法实现求交过程。getIntersection(BVHBuildNode* node, const Ray ray) in BVH.cpp: 建立 BVH 之后,我们可以用它加速求交过程。该过程递归进行,你将在其中调用你实现的 Bounds3::IntersectP. 2. 实现 Render()的实现 光线生成，这里的eye_pos被移动到了(-1,5,10)，表示的是相机的位置，和作业5不一样，揣测代码的意思eye_pos已经是世界坐标了，而scene默认的fov是90，所以，这说明相机平面中心坐标其实等价于移动到了(-1,5,9)的位置（回想作业5相机的位置是(0,0,0)，而相机平面中心的坐标是(0,0,-1)）。和作业5不同，这里的ray的起点应该是eye_pos。
void Renderer::Render(const Scene&amp; scene) { std::vector&lt;Vector3f&gt; framebuffer(scene.width * scene.height); float scale = tan(deg2rad(scene.fov * 0.5)); float imageAspectRatio = scene.width / (float)scene." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/dc4290d8a6be1daacbe0da2056029eb2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-07T13:37:20+08:00" />
<meta property="article:modified_time" content="2024-01-07T13:37:20+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">GAMES101：作业6记录</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="1__0"></a>1 总览</h2> 
<p>在之前的编程练习中,我们实现了基础的光线追踪算法,具体而言是光线传输、光线与三角形求交。我们采用了这样的方法寻找光线与场景的交点:遍历场景中的所有物体,判断光线是否与它相交。在场景中的物体数量不大时,该做法可以取得良好的结果,但当物体数量增多、模型变得更加复杂,该做法将会变得非常低效。因此,我们需要加速结构来加速求交过程。在本次练习中,我们重点关注物体划分算法 <strong>Bounding Volume Hierarchy (BVH)</strong>。本练习要求你实现 <strong>Ray-BoundingVolume</strong> 求交与 <strong>BVH</strong> 查找。</p> 
<p>首先,你需要从上一次编程练习中引用以下函数:</p> 
<ul><li><code>Render()</code> in <code>Renderer.cpp</code>: 将你的光线生成过程粘贴到此处,并且按照新框<br> 架更新相应调用的格式。</li><li><code>Triangle::getIntersection</code> in <code>Triangle.hpp</code>: 将你的光线-三角形相交函数粘贴到此处,并且按照新框架更新相应相交信息的格式。</li></ul> 
<p>在本次编程练习中,你需要实现以下函数:</p> 
<ul><li><code>IntersectP(const Ray&amp; ray, const Vector3f&amp; invDir, const std::array&lt;int, 3&gt;&amp; dirIsNeg)</code> in <code>Bounds3.hpp</code>: 这个函数的作用是判断包围盒 BoundingBox 与光线是否相交,你需要按照课程介绍的算法实现求交过程。</li><li><code>getIntersection(BVHBuildNode* node, const Ray ray)</code> in <code>BVH.cpp</code>: 建立 BVH 之后,我们可以用它加速求交过程。该过程递归进行,你将在其中调用你实现的 <code>Bounds3::IntersectP</code>.</li></ul> 
<h2><a id="2__13"></a>2. 实现</h2> 
<h3><a id="Render_15"></a>Render()的实现</h3> 
<p>光线生成，这里的eye_pos被移动到了(-1,5,10)，表示的是相机的位置，和作业5不一样，揣测代码的意思eye_pos已经是世界坐标了，而scene默认的fov是90，所以，这说明相机平面中心坐标其实等价于移动到了(-1,5,9)的位置（回想作业5相机的位置是(0,0,0)，而相机平面中心的坐标是(0,0,-1)）。和作业5不同，这里的ray的起点应该是eye_pos。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">Renderer</span><span class="token double-colon punctuation">::</span><span class="token function">Render</span><span class="token punctuation">(</span><span class="token keyword">const</span> Scene<span class="token operator">&amp;</span> scene<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>Vector3f<span class="token operator">&gt;</span> <span class="token function">framebuffer</span><span class="token punctuation">(</span>scene<span class="token punctuation">.</span>width <span class="token operator">*</span> scene<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">float</span> scale <span class="token operator">=</span> <span class="token function">tan</span><span class="token punctuation">(</span><span class="token function">deg2rad</span><span class="token punctuation">(</span>scene<span class="token punctuation">.</span>fov <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> imageAspectRatio <span class="token operator">=</span> scene<span class="token punctuation">.</span>width <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>scene<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
    Vector3f <span class="token function">eye_pos</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> m <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">uint32_t</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> scene<span class="token punctuation">.</span>height<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">uint32_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> scene<span class="token punctuation">.</span>width<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// generate primary ray direction</span>
            <span class="token keyword">float</span> x <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>scene<span class="token punctuation">.</span>width <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span>
                      imageAspectRatio <span class="token operator">*</span> scale<span class="token punctuation">;</span>
            <span class="token keyword">float</span> y <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>scene<span class="token punctuation">.</span>height<span class="token punctuation">)</span> <span class="token operator">*</span> scale<span class="token punctuation">;</span>
            <span class="token comment">// TODO: Find the x and y positions of the current pixel to get the</span>
            <span class="token comment">// direction</span>
            <span class="token comment">//  vector that passes through it.</span>
            <span class="token comment">// Also, don't forget to multiply both of them with the variable</span>
            <span class="token comment">// *scale*, and x (horizontal) variable with the *imageAspectRatio*</span>

             Vector3f dir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">Vector3f</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Don't forget to normalize this direction!</span>
            Ray <span class="token function">ray</span><span class="token punctuation">(</span>eye_pos<span class="token punctuation">,</span> dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
            framebuffer<span class="token punctuation">[</span>m<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> scene<span class="token punctuation">.</span><span class="token function">castRay</span><span class="token punctuation">(</span>ray<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token comment">// Don't forget to normalize this direction!</span>

        <span class="token punctuation">}</span>
        <span class="token function">UpdateProgress</span><span class="token punctuation">(</span>j <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>scene<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">UpdateProgress</span><span class="token punctuation">(</span><span class="token number">1.f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// save framebuffer to file</span>
    FILE<span class="token operator">*</span> fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"binary.ppm"</span><span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token function">fprintf</span><span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token string">"P6\n%d %d\n255\n"</span><span class="token punctuation">,</span> scene<span class="token punctuation">.</span>width<span class="token punctuation">,</span> scene<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> scene<span class="token punctuation">.</span>height <span class="token operator">*</span> scene<span class="token punctuation">.</span>width<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> color<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        color<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">255</span> <span class="token operator">*</span> <span class="token function">clamp</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> framebuffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        color<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">255</span> <span class="token operator">*</span> <span class="token function">clamp</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> framebuffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        color<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">255</span> <span class="token operator">*</span> <span class="token function">clamp</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> framebuffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fwrite</span><span class="token punctuation">(</span>color<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>    
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="TrianglegetIntersection_65"></a>Triangle::getIntersection()的实现</h3> 
<pre><code class="prism language-cpp"><span class="token keyword">inline</span> Intersection <span class="token class-name">Triangle</span><span class="token double-colon punctuation">::</span><span class="token function">getIntersection</span><span class="token punctuation">(</span>Ray ray<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    Intersection inter<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dotProduct</span><span class="token punctuation">(</span>ray<span class="token punctuation">.</span>direction<span class="token punctuation">,</span> normal<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> inter<span class="token punctuation">;</span>
    <span class="token keyword">double</span> u<span class="token punctuation">,</span> v<span class="token punctuation">,</span> t_tmp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    Vector3f pvec <span class="token operator">=</span> <span class="token function">crossProduct</span><span class="token punctuation">(</span>ray<span class="token punctuation">.</span>direction<span class="token punctuation">,</span> e2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> det <span class="token operator">=</span> <span class="token function">dotProduct</span><span class="token punctuation">(</span>e1<span class="token punctuation">,</span> pvec<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fabs</span><span class="token punctuation">(</span>det<span class="token punctuation">)</span> <span class="token operator">&lt;</span> EPSILON<span class="token punctuation">)</span>
        <span class="token keyword">return</span> inter<span class="token punctuation">;</span>

    <span class="token keyword">double</span> det_inv <span class="token operator">=</span> <span class="token number">1.</span> <span class="token operator">/</span> det<span class="token punctuation">;</span>
    Vector3f tvec <span class="token operator">=</span> ray<span class="token punctuation">.</span>origin <span class="token operator">-</span> v0<span class="token punctuation">;</span>
    u <span class="token operator">=</span> <span class="token function">dotProduct</span><span class="token punctuation">(</span>tvec<span class="token punctuation">,</span> pvec<span class="token punctuation">)</span> <span class="token operator">*</span> det_inv<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>u <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> u <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> inter<span class="token punctuation">;</span>
    Vector3f qvec <span class="token operator">=</span> <span class="token function">crossProduct</span><span class="token punctuation">(</span>tvec<span class="token punctuation">,</span> e1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    v <span class="token operator">=</span> <span class="token function">dotProduct</span><span class="token punctuation">(</span>ray<span class="token punctuation">.</span>direction<span class="token punctuation">,</span> qvec<span class="token punctuation">)</span> <span class="token operator">*</span> det_inv<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> u <span class="token operator">+</span> v <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> inter<span class="token punctuation">;</span>
    t_tmp <span class="token operator">=</span> <span class="token function">dotProduct</span><span class="token punctuation">(</span>e2<span class="token punctuation">,</span> qvec<span class="token punctuation">)</span> <span class="token operator">*</span> det_inv<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>t_tmp <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> inter<span class="token punctuation">;</span>
    <span class="token comment">// TODO find ray triangle intersection</span>
    inter<span class="token punctuation">.</span>happened <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    inter<span class="token punctuation">.</span>coords <span class="token operator">=</span> ray<span class="token punctuation">.</span>origin <span class="token operator">+</span> t_tmp <span class="token operator">*</span> ray<span class="token punctuation">.</span>direction<span class="token punctuation">;</span>
    inter<span class="token punctuation">.</span>normal <span class="token operator">=</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>normal<span class="token punctuation">;</span>
    inter<span class="token punctuation">.</span>distance <span class="token operator">=</span> t_tmp<span class="token punctuation">;</span>
    inter<span class="token punctuation">.</span>obj <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    inter<span class="token punctuation">.</span>m <span class="token operator">=</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>m<span class="token punctuation">;</span>

    <span class="token keyword">return</span> inter<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>TODO前面已经写好了我们在作业5写的Möller-Trumbore算法，不过我这里多加了一步判断，防止光线是反向的也计算出交点：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span>t_tmp <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> inter<span class="token punctuation">;</span>
</code></pre> 
<p>既然我们已经得到了交点，现在就是给交点的属性赋值了，如上面的代码所示:</p> 
<p>happened: 是否发生相交<br> coords: 交点的世界坐标<br> normal: 交点的法向量<br> distance: 交点和相机的距离<br> obj: 物体<br> m: 材料属性</p> 
<h3><a id="Bounds3IntersectP_122"></a>Bounds3::IntersectP()的实现</h3> 
<p>基本的思路是按照下面这张图来得到t_enter和t_exit</p> 
<p><img src="https://images2.imgbox.com/7f/da/1R76RIqn_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/6d/fd/CFQBbDm2_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/7d/03/EUMujJxC_o.png" alt="在这里插入图片描述"><br> 代码里使用了invDir因为乘法比除法更快，而dirIsNeg根据提示是说光线方向的三个分量是否大于零，例如对包围盒的x平面而言，包围盒有两个x平面<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         x 
        
       
         = 
        
       
         p 
        
       
         M 
        
       
         i 
        
       
         n 
        
       
         . 
        
       
         x 
        
       
      
        x=pMin.x 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.109em;">pM</span><span class="mord mathnormal">in</span><span class="mord">.</span><span class="mord mathnormal">x</span></span></span></span></span>和<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         x 
        
       
         = 
        
       
         p 
        
       
         M 
        
       
         a 
        
       
         x 
        
       
         . 
        
       
         x 
        
       
      
        x=pMax.x 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.109em;">pM</span><span class="mord mathnormal">a</span><span class="mord mathnormal">x</span><span class="mord">.</span><span class="mord mathnormal">x</span></span></span></span></span>，如果光线的x方向分量大于0，说明先进入<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         x 
        
       
         = 
        
       
         p 
        
       
         M 
        
       
         i 
        
       
         n 
        
       
         . 
        
       
         x 
        
       
      
        x=pMin.x 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.109em;">pM</span><span class="mord mathnormal">in</span><span class="mord">.</span><span class="mord mathnormal">x</span></span></span></span></span>这个平面，而从<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         x 
        
       
         = 
        
       
         p 
        
       
         M 
        
       
         a 
        
       
         x 
        
       
         . 
        
       
         x 
        
       
      
        x=pMax.x 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.109em;">pM</span><span class="mord mathnormal">a</span><span class="mord mathnormal">x</span><span class="mord">.</span><span class="mord mathnormal">x</span></span></span></span></span>离开，反之如果光线的x方向分量小于0，说明先进入了<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         x 
        
       
         = 
        
       
         p 
        
       
         M 
        
       
         a 
        
       
         x 
        
       
         . 
        
       
         x 
        
       
      
        x=pMax.x 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.109em;">pM</span><span class="mord mathnormal">a</span><span class="mord mathnormal">x</span><span class="mord">.</span><span class="mord mathnormal">x</span></span></span></span></span>这个平面，而从<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         x 
        
       
         = 
        
       
         p 
        
       
         M 
        
       
         i 
        
       
         n 
        
       
         . 
        
       
         x 
        
       
      
        x=pMin.x 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.109em;">pM</span><span class="mord mathnormal">in</span><span class="mord">.</span><span class="mord mathnormal">x</span></span></span></span></span>平面离开。所以这里用dirIsNeg判断，如果分量小于0，则交换tEnter和tExit对应的分量。</p> 
<p>判断和包围盒有交点的条件是：</p> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          t 
         
         
         
           E 
          
         
           n 
          
         
           t 
          
         
           e 
          
         
           r 
          
         
        
       
         &lt; 
        
        
        
          t 
         
         
         
           E 
          
         
           x 
          
         
           i 
          
         
           t 
          
         
        
       
      
        t_{Enter} &lt; t_{Exit} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.7651em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0576em;">E</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight" style="margin-right: 0.0278em;">er</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.7651em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0576em;">E</span><span class="mord mathnormal mtight">x</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>且<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          t 
         
         
         
           E 
          
         
           x 
          
         
           i 
          
         
           t 
          
         
        
       
         ≥ 
        
       
         0 
        
       
      
        t_{Exit} \ge 0 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.786em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0576em;">E</span><span class="mord mathnormal mtight">x</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">0</span></span></span></span></span></p> 
<pre><code class="prism language-cpp"><span class="token keyword">inline</span> <span class="token keyword">bool</span> <span class="token class-name">Bounds3</span><span class="token double-colon punctuation">::</span><span class="token function">IntersectP</span><span class="token punctuation">(</span><span class="token keyword">const</span> Ray<span class="token operator">&amp;</span> ray<span class="token punctuation">,</span> <span class="token keyword">const</span> Vector3f<span class="token operator">&amp;</span> invDir<span class="token punctuation">,</span>
                                <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>array<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> dirIsNeg<span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// invDir: ray direction(x,y,z), invDir=(1.0/x,1.0/y,1.0/z), use this because Multiply is faster that Division</span>
    <span class="token comment">// dirIsNeg: ray direction(x,y,z), dirIsNeg=[int(x&gt;0),int(y&gt;0),int(z&gt;0)], use this to simplify your logic</span>
    <span class="token comment">// TODO test if ray bound intersects</span>
    Vector3f vec_tEnter <span class="token operator">=</span> <span class="token punctuation">(</span>pMin <span class="token operator">-</span> ray<span class="token punctuation">.</span>origin<span class="token punctuation">)</span> <span class="token operator">*</span> invDir<span class="token punctuation">;</span>
    Vector3f vec_tExit <span class="token operator">=</span> <span class="token punctuation">(</span>pMax <span class="token operator">-</span> ray<span class="token punctuation">.</span>origin<span class="token punctuation">)</span> <span class="token operator">*</span> invDir<span class="token punctuation">;</span>
    
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dirIsNeg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        std<span class="token double-colon punctuation">::</span><span class="token function">swap</span><span class="token punctuation">(</span>vec_tEnter<span class="token punctuation">.</span>x<span class="token punctuation">,</span> vec_tExit<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dirIsNeg<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        std<span class="token double-colon punctuation">::</span><span class="token function">swap</span><span class="token punctuation">(</span>vec_tEnter<span class="token punctuation">.</span>y<span class="token punctuation">,</span> vec_tExit<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dirIsNeg<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        std<span class="token double-colon punctuation">::</span><span class="token function">swap</span><span class="token punctuation">(</span>vec_tEnter<span class="token punctuation">.</span>z<span class="token punctuation">,</span> vec_tExit<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">float</span> tEnter <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span>vec_tEnter<span class="token punctuation">.</span>x<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span>vec_tEnter<span class="token punctuation">.</span>y<span class="token punctuation">,</span> vec_tEnter<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> tExit <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span>vec_tExit<span class="token punctuation">.</span>x<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span>vec_tExit<span class="token punctuation">.</span>y<span class="token punctuation">,</span> vec_tExit<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>tEnter <span class="token operator">&lt;</span>  tExit <span class="token operator">&amp;&amp;</span> tExit <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="BVHcppgetIntersection_164"></a>BVH.cpp-getIntersection()的实现</h3> 
<p>基本的实现思路如下图算法所示：</p> 
<p><img src="https://images2.imgbox.com/3b/43/cWW2MRSl_o.png" alt="在这里插入图片描述"></p> 
<p>递归二叉树节点，如果发现节点的包围盒没有被光线打中，则返回一个默认的Intersection，如果发现节点遍历到了叶子节点，则返回这个节点的物体的交点的信息，否则用hitLeft记录左子树的交点，用hitRight记录右子树的交点，比较两个子树的交点和光线的距离，返回更小的那一个。</p> 
<pre><code class="prism language-cpp">Intersection <span class="token class-name">BVHAccel</span><span class="token double-colon punctuation">::</span><span class="token function">getIntersection</span><span class="token punctuation">(</span>BVHBuildNode<span class="token operator">*</span> node<span class="token punctuation">,</span> <span class="token keyword">const</span> Ray<span class="token operator">&amp;</span> ray<span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// TODO Traverse the BVH to find intersection</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>node<span class="token operator">-&gt;</span>bounds<span class="token punctuation">.</span><span class="token function">IntersectP</span><span class="token punctuation">(</span>ray<span class="token punctuation">,</span> ray<span class="token punctuation">.</span>direction_inv<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">array</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>ray<span class="token punctuation">.</span>direction<span class="token punctuation">.</span>x <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span> ray<span class="token punctuation">.</span>direction<span class="token punctuation">.</span>y <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span> ray<span class="token punctuation">.</span>direction<span class="token punctuation">.</span>z <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">Intersection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token operator">-&gt;</span>left <span class="token operator">==</span> <span class="token keyword">nullptr</span> <span class="token operator">&amp;&amp;</span> node<span class="token operator">-&gt;</span>right <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> node<span class="token operator">-&gt;</span>object<span class="token operator">-&gt;</span><span class="token function">getIntersection</span><span class="token punctuation">(</span>ray<span class="token punctuation">)</span><span class="token punctuation">;</span>

    Intersection hitLeft <span class="token operator">=</span> <span class="token class-name">BVHAccel</span><span class="token double-colon punctuation">::</span><span class="token function">getIntersection</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span>left<span class="token punctuation">,</span> ray<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Intersection hitRight <span class="token operator">=</span> <span class="token class-name">BVHAccel</span><span class="token double-colon punctuation">::</span><span class="token function">getIntersection</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span>right<span class="token punctuation">,</span> ray<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> hitLeft<span class="token punctuation">.</span>distance <span class="token operator">&lt;</span> hitRight<span class="token punctuation">.</span>distance <span class="token operator">?</span> hitLeft <span class="token operator">:</span> hitRight<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/9d/6f/JQHGa6nu_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/25/0b/mNT53Sj9_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="SAH_192"></a>提高部分：SAH的实现</h3> 
<p>知乎的这篇文章讲得很好：<a href="https://zhuanlan.zhihu.com/p/50720158" rel="nofollow">PBRT-E4.3-层次包围体(BVH)（一）</a></p> 
<p><img src="https://images2.imgbox.com/44/05/zJeEsn4L_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/21/58/DALhkawl_o.png" alt="在这里插入图片描述"></p> 
<p>我们计算不同划分下的代价，我们希望代价可以最小，这样包围盒求交也最小，递归计算的消耗也会变小。</p> 
<p>一种方法是划分各个桶的方法，在总的节点的包围盒计算每个片体质心所在的桶的序号，然后桶也增加在这个桶里的片体的个数和所有片体的包围盒，这样计算时间也是4s，没什么太大的差别，这里的代码先使用了排序，然后通过寻找最低的cost找到划分的指针和begin指针的差值，用迭代器给leftshapes和rightshapes赋值</p> 
<p><img src="https://images2.imgbox.com/2a/c9/4rvLJCsW_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-cpp">BVHBuildNode<span class="token operator">*</span> <span class="token class-name">BVHAccel</span><span class="token double-colon punctuation">::</span><span class="token function">recursiveBuild_SAH</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>Object<span class="token operator">*</span><span class="token operator">&gt;</span> objects<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    BVHBuildNode<span class="token operator">*</span> node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">BVHBuildNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Compute bounds of all primitives in BVH node</span>
    Bounds3 bounds<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> objects<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
        bounds <span class="token operator">=</span> <span class="token function">Union</span><span class="token punctuation">(</span>bounds<span class="token punctuation">,</span> objects<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>objects<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Create leaf _BVHBuildNode_</span>
    node<span class="token operator">-&gt;</span>bounds <span class="token operator">=</span> objects<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    node<span class="token operator">-&gt;</span>object <span class="token operator">=</span> objects<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    node<span class="token operator">-&gt;</span>left <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    node<span class="token operator">-&gt;</span>right <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> node<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>objects<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        node<span class="token operator">-&gt;</span>left <span class="token operator">=</span> <span class="token function">recursiveBuild_SAH</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>vector<span class="token punctuation">{<!-- --></span>objects<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        node<span class="token operator">-&gt;</span>right <span class="token operator">=</span> <span class="token function">recursiveBuild_SAH</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>vector<span class="token punctuation">{<!-- --></span>objects<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        node<span class="token operator">-&gt;</span>bounds <span class="token operator">=</span> <span class="token function">Union</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span>left<span class="token operator">-&gt;</span>bounds<span class="token punctuation">,</span> node<span class="token operator">-&gt;</span>right<span class="token operator">-&gt;</span>bounds<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> node<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        Bounds3 centroidBounds<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> objects<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
            centroidBounds <span class="token operator">=</span>
                <span class="token function">Union</span><span class="token punctuation">(</span>centroidBounds<span class="token punctuation">,</span> objects<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Centroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> dim <span class="token operator">=</span> centroidBounds<span class="token punctuation">.</span><span class="token function">maxExtent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>dim<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
            std<span class="token double-colon punctuation">::</span><span class="token function">sort</span><span class="token punctuation">(</span>objects<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> objects<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">auto</span> f1<span class="token punctuation">,</span> <span class="token keyword">auto</span> f2<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> f1<span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Centroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>x <span class="token operator">&lt;</span>
                    f2<span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Centroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
            std<span class="token double-colon punctuation">::</span><span class="token function">sort</span><span class="token punctuation">(</span>objects<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> objects<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">auto</span> f1<span class="token punctuation">,</span> <span class="token keyword">auto</span> f2<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> f1<span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Centroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>y <span class="token operator">&lt;</span>
                    f2<span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Centroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>y<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
            std<span class="token double-colon punctuation">::</span><span class="token function">sort</span><span class="token punctuation">(</span>objects<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> objects<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">auto</span> f1<span class="token punctuation">,</span> <span class="token keyword">auto</span> f2<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> f1<span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Centroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>z <span class="token operator">&lt;</span>
                    f2<span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Centroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>z<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">float</span> boundsArea <span class="token operator">=</span> bounds<span class="token punctuation">.</span><span class="token function">SurfaceArea</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token keyword">int</span> bucketNum <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
        Bucket bucket<span class="token punctuation">[</span>bucketNum<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> objects<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> b<span class="token punctuation">;</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>dim<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span> b <span class="token operator">=</span> centroidBounds<span class="token punctuation">.</span><span class="token function">Offset</span><span class="token punctuation">(</span>objects<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Centroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>x <span class="token operator">*</span> bucketNum<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> b <span class="token operator">=</span> centroidBounds<span class="token punctuation">.</span><span class="token function">Offset</span><span class="token punctuation">(</span>objects<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Centroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>y <span class="token operator">*</span> bucketNum<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span> b <span class="token operator">=</span> centroidBounds<span class="token punctuation">.</span><span class="token function">Offset</span><span class="token punctuation">(</span>objects<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Centroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>z <span class="token operator">*</span> bucketNum<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">==</span> bucketNum<span class="token punctuation">)</span>
                b <span class="token operator">=</span> bucketNum <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
            bucket<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">.</span>bounds <span class="token operator">=</span> <span class="token function">Union</span><span class="token punctuation">(</span>bucket<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">.</span>bounds<span class="token punctuation">,</span> objects<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bucket<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">.</span>cnt<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">float</span> costRes <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token class-name">numeric_limits</span><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">infinity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> partitionInd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> bucketNum <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Bounds3 boundsLeft<span class="token punctuation">,</span> boundsRight<span class="token punctuation">;</span>
            <span class="token keyword">int</span> cntLeft <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> cntRight <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                cntLeft <span class="token operator">+=</span> bucket<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>cnt<span class="token punctuation">;</span>
                boundsLeft <span class="token operator">=</span> <span class="token function">Union</span><span class="token punctuation">(</span>boundsLeft<span class="token punctuation">,</span> bucket<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>bounds<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> bucketNum<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                cntRight <span class="token operator">+=</span> bucket<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>cnt<span class="token punctuation">;</span>
                boundsRight <span class="token operator">=</span> <span class="token function">Union</span><span class="token punctuation">(</span>boundsRight<span class="token punctuation">,</span> bucket<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>bounds<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">float</span> cost <span class="token operator">=</span> cntLeft <span class="token operator">*</span> boundsLeft<span class="token punctuation">.</span><span class="token function">SurfaceArea</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> boundsArea <span class="token operator">+</span> cntRight <span class="token operator">*</span> boundsRight<span class="token punctuation">.</span><span class="token function">SurfaceArea</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> boundsArea <span class="token operator">+</span> <span class="token number">0.125f</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cost <span class="token operator">&lt;</span> costRes<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                partitionInd <span class="token operator">=</span> i<span class="token punctuation">;</span>
                costRes <span class="token operator">=</span> cost<span class="token punctuation">;</span>
                offset <span class="token operator">=</span> cntLeft<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">auto</span> beginning <span class="token operator">=</span> objects<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> midding <span class="token operator">=</span> objects<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> offset<span class="token punctuation">;</span>
        <span class="token keyword">auto</span> ending <span class="token operator">=</span> objects<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> leftshapes <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">vector</span><span class="token generic class-name"><span class="token operator">&lt;</span>Object<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>beginning<span class="token punctuation">,</span> midding<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> rightshapes <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">vector</span><span class="token generic class-name"><span class="token operator">&lt;</span>Object<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>midding<span class="token punctuation">,</span> ending<span class="token punctuation">)</span><span class="token punctuation">;</span>

        node<span class="token operator">-&gt;</span>left <span class="token operator">=</span> <span class="token function">recursiveBuild_SAH</span><span class="token punctuation">(</span>leftshapes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        node<span class="token operator">-&gt;</span>right <span class="token operator">=</span> <span class="token function">recursiveBuild_SAH</span><span class="token punctuation">(</span>rightshapes<span class="token punctuation">)</span><span class="token punctuation">;</span>

        node<span class="token operator">-&gt;</span>bounds <span class="token operator">=</span> <span class="token function">Union</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span>left<span class="token operator">-&gt;</span>bounds<span class="token punctuation">,</span> node<span class="token operator">-&gt;</span>right<span class="token operator">-&gt;</span>bounds<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> node<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>我们需要定义结构体Bucket来放置桶，这里在BVH.hpp里进行了定义。</p> 
<p><code>BVH.hpp</code></p> 
<pre><code class="prism language-cpp"><span class="token keyword">struct</span> <span class="token class-name">Bucket</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    Bounds3 bounds<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>上面的写法每次计算leftBound和rightBount都要重新计算一遍，进行了很多重复计算，如果能保存中间结果呢可以减少重复计算，说不定提高计算效率，这里和力扣的<a href="https://leetcode.cn/problems/product-of-array-except-self/" rel="nofollow">238.除自身以外数组的乘积</a>的思路很像</p> 
<p>这里举个例子，比如bucket每个区间里各放有0,1,2,3四个片元，leftBound就放bucket左区间的片元的包围盒，rightBound放bucket右区间的片元的包围盒：</p> 
<p><img src="https://images2.imgbox.com/32/b5/9lArcAsO_o.png" alt="在这里插入图片描述"><br> 以bucket[1]为界（bucket[1]包含在左包围盒里），0,1包含在左包围盒，对应的是leftBound[1]，2,3包含在右包围盒，对应的是rightBound[1]</p> 
<p><img src="https://images2.imgbox.com/08/8b/OhZi5iTh_o.png" alt="在这里插入图片描述"></p> 
<p>相邻的包围盒我们可以推得有递推公式，思路是包含前一个小区间的大包围盒和当前小区间的包围盒合并就可以得到包含当前小区间的大包围盒：</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          l 
         
        
          e 
         
        
          f 
         
        
          t 
         
        
          B 
         
        
          o 
         
        
          u 
         
        
          n 
         
        
          d 
         
        
          [ 
         
        
          i 
         
        
          ] 
         
        
          = 
         
        
          U 
         
        
          n 
         
        
          i 
         
        
          o 
         
        
          n 
         
        
          ( 
         
        
          b 
         
        
          u 
         
        
          c 
         
        
          k 
         
        
          e 
         
        
          t 
         
        
          [ 
         
        
          i 
         
        
          ] 
         
        
          . 
         
        
          g 
         
        
          e 
         
        
          t 
         
        
          B 
         
        
          o 
         
        
          u 
         
        
          n 
         
        
          d 
         
        
          ( 
         
        
          ) 
         
        
          , 
         
        
          l 
         
        
          e 
         
        
          f 
         
        
          t 
         
        
          B 
         
        
          o 
         
        
          u 
         
        
          n 
         
        
          d 
         
        
          [ 
         
        
          i 
         
        
          − 
         
        
          1 
         
        
          ] 
         
        
          ) 
         
        
       
         leftBound[i] = Union(bucket[i].getBound(), leftBound[i-1]) 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="mord mathnormal" style="margin-right: 0.0502em;">tB</span><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mclose">]</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.109em;">U</span><span class="mord mathnormal">ni</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mord mathnormal">u</span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right: 0.0315em;">k</span><span class="mord mathnormal">e</span><span class="mord mathnormal">t</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mclose">]</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right: 0.0359em;">g</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right: 0.0502em;">tB</span><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="mord mathnormal" style="margin-right: 0.0502em;">tB</span><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord">1</span><span class="mclose">])</span></span></span></span></span></span><br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          r 
         
        
          i 
         
        
          g 
         
        
          h 
         
        
          t 
         
        
          B 
         
        
          o 
         
        
          u 
         
        
          n 
         
        
          d 
         
        
          [ 
         
        
          i 
         
        
          ] 
         
        
          = 
         
        
          U 
         
        
          n 
         
        
          i 
         
        
          o 
         
        
          n 
         
        
          ( 
         
        
          b 
         
        
          u 
         
        
          c 
         
        
          k 
         
        
          e 
         
        
          t 
         
        
          [ 
         
        
          i 
         
        
          + 
         
        
          1 
         
        
          ] 
         
        
          . 
         
        
          g 
         
        
          e 
         
        
          t 
         
        
          B 
         
        
          o 
         
        
          u 
         
        
          n 
         
        
          d 
         
        
          ( 
         
        
          ) 
         
        
          , 
         
        
          r 
         
        
          i 
         
        
          g 
         
        
          h 
         
        
          t 
         
        
          B 
         
        
          o 
         
        
          u 
         
        
          n 
         
        
          d 
         
        
          [ 
         
        
          i 
         
        
          + 
         
        
          1 
         
        
          ] 
         
        
          ) 
         
        
       
         rightBound[i] = Union(bucket[i+1].getBound(), rightBound[i+1]) 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0278em;">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right: 0.0359em;">g</span><span class="mord mathnormal">h</span><span class="mord mathnormal" style="margin-right: 0.0502em;">tB</span><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mclose">]</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.109em;">U</span><span class="mord mathnormal">ni</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mord mathnormal">u</span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right: 0.0315em;">k</span><span class="mord mathnormal">e</span><span class="mord mathnormal">t</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord">1</span><span class="mclose">]</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right: 0.0359em;">g</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right: 0.0502em;">tB</span><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.0278em;">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right: 0.0359em;">g</span><span class="mord mathnormal">h</span><span class="mord mathnormal" style="margin-right: 0.0502em;">tB</span><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord">1</span><span class="mclose">])</span></span></span></span></span></span></p> 
<p>另外排序是不是也消耗了一点时间，下面的代码把排序给去掉了：</p> 
<pre><code class="prism language-cpp">BVHBuildNode<span class="token operator">*</span> <span class="token class-name">BVHAccel</span><span class="token double-colon punctuation">::</span><span class="token function">recursiveBuild_SAH</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>Object<span class="token operator">*</span><span class="token operator">&gt;</span> objects<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    BVHBuildNode<span class="token operator">*</span> node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">BVHBuildNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Compute bounds of all primitives in BVH node</span>
    Bounds3 bounds<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> objects<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
        bounds <span class="token operator">=</span> <span class="token function">Union</span><span class="token punctuation">(</span>bounds<span class="token punctuation">,</span> objects<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>objects<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Create leaf _BVHBuildNode_</span>
    node<span class="token operator">-&gt;</span>bounds <span class="token operator">=</span> objects<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    node<span class="token operator">-&gt;</span>object <span class="token operator">=</span> objects<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    node<span class="token operator">-&gt;</span>left <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    node<span class="token operator">-&gt;</span>right <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> node<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>objects<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        node<span class="token operator">-&gt;</span>left <span class="token operator">=</span> <span class="token function">recursiveBuild_SAH</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>vector<span class="token punctuation">{<!-- --></span>objects<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        node<span class="token operator">-&gt;</span>right <span class="token operator">=</span> <span class="token function">recursiveBuild_SAH</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>vector<span class="token punctuation">{<!-- --></span>objects<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        node<span class="token operator">-&gt;</span>bounds <span class="token operator">=</span> <span class="token function">Union</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span>left<span class="token operator">-&gt;</span>bounds<span class="token punctuation">,</span> node<span class="token operator">-&gt;</span>right<span class="token operator">-&gt;</span>bounds<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> node<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        Bounds3 centroidBounds<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> objects<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
            centroidBounds <span class="token operator">=</span>
                <span class="token function">Union</span><span class="token punctuation">(</span>centroidBounds<span class="token punctuation">,</span> objects<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Centroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> dim <span class="token operator">=</span> centroidBounds<span class="token punctuation">.</span><span class="token function">maxExtent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">float</span> boundsArea <span class="token operator">=</span> bounds<span class="token punctuation">.</span><span class="token function">SurfaceArea</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token keyword">int</span> bucketNum <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
        Bucket bucket<span class="token punctuation">[</span>bucketNum<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> object<span class="token operator">:</span> objects<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> b<span class="token punctuation">;</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>dim<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span> b <span class="token operator">=</span> centroidBounds<span class="token punctuation">.</span><span class="token function">Offset</span><span class="token punctuation">(</span>object<span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Centroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>x <span class="token operator">*</span> bucketNum<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> b <span class="token operator">=</span> centroidBounds<span class="token punctuation">.</span><span class="token function">Offset</span><span class="token punctuation">(</span>object<span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Centroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>y  <span class="token operator">*</span> bucketNum<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span> b <span class="token operator">=</span> centroidBounds<span class="token punctuation">.</span><span class="token function">Offset</span><span class="token punctuation">(</span>object<span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Centroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>z  <span class="token operator">*</span> bucketNum<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">==</span> bucketNum<span class="token punctuation">)</span>
                b <span class="token operator">=</span> bucketNum <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
            bucket<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">.</span>bounds <span class="token operator">=</span> <span class="token function">Union</span><span class="token punctuation">(</span>bucket<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">.</span>bounds<span class="token punctuation">,</span> object<span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bucket<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">.</span>cnt<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>



        std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>Bounds3<span class="token operator">&gt;</span> <span class="token function">leftBound</span><span class="token punctuation">(</span>bucketNum <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>Bounds3<span class="token operator">&gt;</span> <span class="token function">rightBound</span><span class="token punctuation">(</span>bucketNum <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        leftBound<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> bucket<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>bounds<span class="token punctuation">;</span>
        rightBound<span class="token punctuation">[</span>bucketNum <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> bucket<span class="token punctuation">[</span>bucketNum <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>bounds<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> bucketNum <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            leftBound<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">Union</span><span class="token punctuation">(</span>leftBound<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bucket<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>bounds<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
           
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> bucketNum <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>i<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            rightBound<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">Union</span><span class="token punctuation">(</span>rightBound<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bucket<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>bounds<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
            

        <span class="token keyword">int</span> cntLeft <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> cntRight <span class="token operator">=</span> objects<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> costRes <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token class-name">numeric_limits</span><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">infinity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> partitionInd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> bucketNum <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            cntLeft <span class="token operator">=</span> cntLeft <span class="token operator">+</span> bucket<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>cnt<span class="token punctuation">;</span>
            cntRight <span class="token operator">=</span> cntRight <span class="token operator">-</span> bucket<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>cnt<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cntLeft <span class="token operator">&amp;&amp;</span> cntRight<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">float</span> cost <span class="token operator">=</span> cntLeft <span class="token operator">*</span> leftBound<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">SurfaceArea</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> boundsArea <span class="token operator">+</span> cntRight <span class="token operator">*</span> rightBound<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">SurfaceArea</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> boundsArea <span class="token operator">+</span> <span class="token number">0.125f</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cost <span class="token operator">&lt;</span> costRes<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    partitionInd <span class="token operator">=</span> i<span class="token punctuation">;</span>
                    costRes <span class="token operator">=</span> cost<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            
        <span class="token punctuation">}</span>
        <span class="token keyword">auto</span> leftshapes <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">vector</span><span class="token generic class-name"><span class="token operator">&lt;</span>Object<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> rightshapes <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">vector</span><span class="token generic class-name"><span class="token operator">&lt;</span>Object<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> object<span class="token operator">:</span> objects<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> b<span class="token punctuation">;</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>dim<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span> b <span class="token operator">=</span> centroidBounds<span class="token punctuation">.</span><span class="token function">Offset</span><span class="token punctuation">(</span>object<span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Centroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>x <span class="token operator">*</span> bucketNum<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> b <span class="token operator">=</span> centroidBounds<span class="token punctuation">.</span><span class="token function">Offset</span><span class="token punctuation">(</span>object<span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Centroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>y <span class="token operator">*</span> bucketNum<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span> b <span class="token operator">=</span> centroidBounds<span class="token punctuation">.</span><span class="token function">Offset</span><span class="token punctuation">(</span>object<span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Centroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>z <span class="token operator">*</span> bucketNum<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">==</span> bucketNum<span class="token punctuation">)</span>
                b <span class="token operator">=</span> bucketNum <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">&lt;=</span> partitionInd<span class="token punctuation">)</span>
                leftshapes<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                rightshapes<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        node<span class="token operator">-&gt;</span>left <span class="token operator">=</span> <span class="token function">recursiveBuild_SAH</span><span class="token punctuation">(</span>leftshapes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        node<span class="token operator">-&gt;</span>right <span class="token operator">=</span> <span class="token function">recursiveBuild_SAH</span><span class="token punctuation">(</span>rightshapes<span class="token punctuation">)</span><span class="token punctuation">;</span>

        node<span class="token operator">-&gt;</span>bounds <span class="token operator">=</span> <span class="token function">Union</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span>left<span class="token operator">-&gt;</span>bounds<span class="token punctuation">,</span> node<span class="token operator">-&gt;</span>right<span class="token operator">-&gt;</span>bounds<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> node<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>结果还是一样花了4秒渲染完。</p> 
<p>另一种写法是将所有图元按照数量均匀划分成了B个部分，然后计算代价，这样划分比较快，但是好像没有用到桶的划分。</p> 
<pre><code class="prism language-cpp">BVHBuildNode<span class="token operator">*</span> <span class="token class-name">BVHAccel</span><span class="token double-colon punctuation">::</span><span class="token function">recursiveBuild_SAH</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>Object<span class="token operator">*</span><span class="token operator">&gt;</span> objects<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
        BVHBuildNode<span class="token operator">*</span> node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">BVHBuildNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Compute bounds of all primitives in BVH node</span>
    Bounds3 bounds<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> objects<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
        bounds <span class="token operator">=</span> <span class="token function">Union</span><span class="token punctuation">(</span>bounds<span class="token punctuation">,</span> objects<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>objects<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Create leaf _SAHBuildNode_</span>
    node<span class="token operator">-&gt;</span>bounds <span class="token operator">=</span> objects<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    node<span class="token operator">-&gt;</span>object <span class="token operator">=</span> objects<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    node<span class="token operator">-&gt;</span>left <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    node<span class="token operator">-&gt;</span>right <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> node<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>objects<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        node<span class="token operator">-&gt;</span>left <span class="token operator">=</span> <span class="token function">recursiveBuild_SAH</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>vector<span class="token punctuation">{<!-- --></span>objects<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        node<span class="token operator">-&gt;</span>right <span class="token operator">=</span> <span class="token function">recursiveBuild_SAH</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>vector<span class="token punctuation">{<!-- --></span>objects<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        node<span class="token operator">-&gt;</span>bounds <span class="token operator">=</span> <span class="token function">Union</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span>left<span class="token operator">-&gt;</span>bounds<span class="token punctuation">,</span> node<span class="token operator">-&gt;</span>right<span class="token operator">-&gt;</span>bounds<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> node<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        Bounds3 centroidBounds<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> objects<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
            centroidBounds <span class="token operator">=</span>
                <span class="token function">Union</span><span class="token punctuation">(</span>centroidBounds<span class="token punctuation">,</span> objects<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Centroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> dim <span class="token operator">=</span> centroidBounds<span class="token punctuation">.</span><span class="token function">maxExtent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>dim<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
            std<span class="token double-colon punctuation">::</span><span class="token function">sort</span><span class="token punctuation">(</span>objects<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> objects<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">auto</span> f1<span class="token punctuation">,</span> <span class="token keyword">auto</span> f2<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> f1<span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Centroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>x <span class="token operator">&lt;</span>
                    f2<span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Centroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
            std<span class="token double-colon punctuation">::</span><span class="token function">sort</span><span class="token punctuation">(</span>objects<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> objects<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">auto</span> f1<span class="token punctuation">,</span> <span class="token keyword">auto</span> f2<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> f1<span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Centroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>y <span class="token operator">&lt;</span>
                    f2<span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Centroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>y<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
            std<span class="token double-colon punctuation">::</span><span class="token function">sort</span><span class="token punctuation">(</span>objects<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> objects<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">auto</span> f1<span class="token punctuation">,</span> <span class="token keyword">auto</span> f2<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> f1<span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Centroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>z <span class="token operator">&lt;</span>
                    f2<span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Centroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>z<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">auto</span> beginning <span class="token operator">=</span> objects<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> ending <span class="token operator">=</span> objects<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">float</span> midIdx <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> bucketNum <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> costRes <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token class-name">numeric_limits</span><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">infinity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> nodeArea <span class="token operator">=</span> bounds<span class="token punctuation">.</span><span class="token function">SurfaceArea</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> bucketNum<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">auto</span> mid_temp <span class="token operator">=</span> objects<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>objects<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>i <span class="token operator">/</span> bucketNum<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">auto</span> leftshapes <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">vector</span><span class="token generic class-name"><span class="token operator">&lt;</span>Object<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>beginning<span class="token punctuation">,</span> mid_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">auto</span> rightshapes <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">vector</span><span class="token generic class-name"><span class="token operator">&lt;</span>Object<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>mid_temp<span class="token punctuation">,</span> ending<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">assert</span><span class="token punctuation">(</span>objects<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span>leftshapes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> rightshapes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Bounds3 leftBounds<span class="token punctuation">,</span> rightBounds<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> leftshapes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span>
                leftBounds <span class="token operator">=</span> <span class="token function">Union</span><span class="token punctuation">(</span>leftBounds<span class="token punctuation">,</span> leftshapes<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> rightshapes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span>
                rightBounds <span class="token operator">=</span> <span class="token function">Union</span><span class="token punctuation">(</span>rightBounds<span class="token punctuation">,</span> rightshapes<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">float</span> leftArea <span class="token operator">=</span> leftBounds<span class="token punctuation">.</span><span class="token function">SurfaceArea</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">float</span> rightArea <span class="token operator">=</span> rightBounds<span class="token punctuation">.</span><span class="token function">SurfaceArea</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">float</span> cost <span class="token operator">=</span> leftArea <span class="token operator">/</span> nodeArea <span class="token operator">*</span> leftshapes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> rightArea <span class="token operator">/</span> nodeArea <span class="token operator">*</span> rightshapes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0.125f</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cost <span class="token operator">&lt;</span> costRes<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                midIdx <span class="token operator">=</span> i<span class="token punctuation">;</span>
                costRes <span class="token operator">=</span> cost<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">auto</span> middling <span class="token operator">=</span> objects<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>objects<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>midIdx <span class="token operator">/</span> bucketNum<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> leftshapes <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">vector</span><span class="token generic class-name"><span class="token operator">&lt;</span>Object<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>beginning<span class="token punctuation">,</span> middling<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> rightshapes <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">vector</span><span class="token generic class-name"><span class="token operator">&lt;</span>Object<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>middling<span class="token punctuation">,</span> ending<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">assert</span><span class="token punctuation">(</span>objects<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span>leftshapes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> rightshapes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        node<span class="token operator">-&gt;</span>left <span class="token operator">=</span> <span class="token function">recursiveBuild_SAH</span><span class="token punctuation">(</span>leftshapes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        node<span class="token operator">-&gt;</span>right <span class="token operator">=</span> <span class="token function">recursiveBuild_SAH</span><span class="token punctuation">(</span>rightshapes<span class="token punctuation">)</span><span class="token punctuation">;</span>

        node<span class="token operator">-&gt;</span>bounds <span class="token operator">=</span> <span class="token function">Union</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span>left<span class="token operator">-&gt;</span>bounds<span class="token punctuation">,</span> node<span class="token operator">-&gt;</span>right<span class="token operator">-&gt;</span>bounds<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> node<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/18/d8/T3g1nMlL_o.png" alt="在这里插入图片描述"><br> 时间上也是4s。</p> 
<h2><a id="3__570"></a>3. 其他代码批注</h2> 
<h3><a id="BVHAccelrecursiveBuild_572"></a>BVHAccel::recursiveBuild()</h3> 
<p>这个函数的作用是递归的建立BVH的数，最后返回根节点，首先先把所有物体的包围盒得到，然后如果物体的个数为1，创建叶子节点，如果物体的个数是2，两个物体分别作为左右子树，如果物体的个数大于2，那么找当前节点内每个物体的包围盒质心的总和（Union），并且用maxExtent函数找这个包围盒最长的轴，沿最长的轴对物体进行排序，然后按排序的结果划分左子树和右子树。</p> 
<pre><code class="prism language-cpp">BVHBuildNode<span class="token operator">*</span> <span class="token class-name">BVHAccel</span><span class="token double-colon punctuation">::</span><span class="token function">recursiveBuild</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>Object<span class="token operator">*</span><span class="token operator">&gt;</span> objects<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    BVHBuildNode<span class="token operator">*</span> node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">BVHBuildNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Compute bounds of all primitives in BVH node</span>
    Bounds3 bounds<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> objects<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
        bounds <span class="token operator">=</span> <span class="token function">Union</span><span class="token punctuation">(</span>bounds<span class="token punctuation">,</span> objects<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>objects<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Create leaf _BVHBuildNode_</span>
        node<span class="token operator">-&gt;</span>bounds <span class="token operator">=</span> objects<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        node<span class="token operator">-&gt;</span>object <span class="token operator">=</span> objects<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        node<span class="token operator">-&gt;</span>left <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        node<span class="token operator">-&gt;</span>right <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> node<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>objects<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        node<span class="token operator">-&gt;</span>left <span class="token operator">=</span> <span class="token function">recursiveBuild</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>vector<span class="token punctuation">{<!-- --></span>objects<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        node<span class="token operator">-&gt;</span>right <span class="token operator">=</span> <span class="token function">recursiveBuild</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>vector<span class="token punctuation">{<!-- --></span>objects<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        node<span class="token operator">-&gt;</span>bounds <span class="token operator">=</span> <span class="token function">Union</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span>left<span class="token operator">-&gt;</span>bounds<span class="token punctuation">,</span> node<span class="token operator">-&gt;</span>right<span class="token operator">-&gt;</span>bounds<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> node<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        Bounds3 centroidBounds<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> objects<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
            centroidBounds <span class="token operator">=</span>
                <span class="token function">Union</span><span class="token punctuation">(</span>centroidBounds<span class="token punctuation">,</span> objects<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Centroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> dim <span class="token operator">=</span> centroidBounds<span class="token punctuation">.</span><span class="token function">maxExtent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>dim<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
            std<span class="token double-colon punctuation">::</span><span class="token function">sort</span><span class="token punctuation">(</span>objects<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> objects<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">auto</span> f1<span class="token punctuation">,</span> <span class="token keyword">auto</span> f2<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> f1<span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Centroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>x <span class="token operator">&lt;</span>
                       f2<span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Centroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
            std<span class="token double-colon punctuation">::</span><span class="token function">sort</span><span class="token punctuation">(</span>objects<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> objects<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">auto</span> f1<span class="token punctuation">,</span> <span class="token keyword">auto</span> f2<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> f1<span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Centroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>y <span class="token operator">&lt;</span>
                       f2<span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Centroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>y<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
            std<span class="token double-colon punctuation">::</span><span class="token function">sort</span><span class="token punctuation">(</span>objects<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> objects<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">auto</span> f1<span class="token punctuation">,</span> <span class="token keyword">auto</span> f2<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> f1<span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Centroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>z <span class="token operator">&lt;</span>
                       f2<span class="token operator">-&gt;</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Centroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>z<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">auto</span> beginning <span class="token operator">=</span> objects<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> middling <span class="token operator">=</span> objects<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>objects<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> ending <span class="token operator">=</span> objects<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">auto</span> leftshapes <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">vector</span><span class="token generic class-name"><span class="token operator">&lt;</span>Object<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>beginning<span class="token punctuation">,</span> middling<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> rightshapes <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">vector</span><span class="token generic class-name"><span class="token operator">&lt;</span>Object<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>middling<span class="token punctuation">,</span> ending<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">assert</span><span class="token punctuation">(</span>objects<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span>leftshapes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> rightshapes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        node<span class="token operator">-&gt;</span>left <span class="token operator">=</span> <span class="token function">recursiveBuild</span><span class="token punctuation">(</span>leftshapes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        node<span class="token operator">-&gt;</span>right <span class="token operator">=</span> <span class="token function">recursiveBuild</span><span class="token punctuation">(</span>rightshapes<span class="token punctuation">)</span><span class="token punctuation">;</span>

        node<span class="token operator">-&gt;</span>bounds <span class="token operator">=</span> <span class="token function">Union</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span>left<span class="token operator">-&gt;</span>bounds<span class="token punctuation">,</span> node<span class="token operator">-&gt;</span>right<span class="token operator">-&gt;</span>bounds<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> node<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>maxExtent的实现，用来获取最长的轴，0,1,2,分别对应x轴，y轴和z轴：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token class-name">Bounds</span><span class="token double-colon punctuation">::</span><span class="token function">maxExtent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
    <span class="token punctuation">{<!-- --></span>
        Vector3f d <span class="token operator">=</span> <span class="token function">Diagonal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token punctuation">.</span>x <span class="token operator">&gt;</span> d<span class="token punctuation">.</span>y <span class="token operator">&amp;&amp;</span> d<span class="token punctuation">.</span>x <span class="token operator">&gt;</span> d<span class="token punctuation">.</span>z<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token punctuation">.</span>y <span class="token operator">&gt;</span> d<span class="token punctuation">.</span>z<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="Bounds3_662"></a>Bounds3</h3> 
<p>这个建立的是一个三维的包围盒，对于一个长方体我们只需要两个角点就可以把包围盒的信息记录下来，两个角点分别是最靠近原点和最远离原点的，看下代码中的pMin和pMax的定义就知道了</p> 
<ul><li><code> Vector3f Diagonal()</code>：获得包围盒长宽高的矢量</li><li><code>double SurfaceArea() </code>: 获得包围盒的表面积</li><li><code>Vector3f Centroid()</code>：获得包围盒的中心</li><li><code>Bounds3 Intersect(const Bounds3&amp; b)</code>：和另一个包围盒相交后的新的包围盒</li><li><code>Vector3f Offset(const Vector3f&amp; p)</code>：p在包围盒各维度长度的占比</li><li><code>bool Overlaps(const Bounds3&amp; b1, const Bounds3&amp; b2)</code>：两个包围盒是不是有重叠</li><li><code>bool Inside(const Vector3f&amp; p, const Bounds3&amp; b)</code>：点p是不是在包围盒b内</li><li><code>Bounds3 Union(const Bounds3&amp; b1, const Bounds3&amp; b2)</code>：两个包围盒合并为一个更大的包围盒</li><li><code>Bounds3 Union(const Bounds3&amp; b, const Vector3f&amp; p)</code>：添加点p以后的新的包围盒</li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d222e462771ce8621f89449be806630c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Android蓝牙音乐SRC侧的实现</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/95c750b1a2e3cae6dd33a8baa94be2e4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">数据结构之链表——学习笔记（1）（基本概念与相关的几道习题讲解）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>