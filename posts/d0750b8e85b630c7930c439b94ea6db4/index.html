<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>互相关注业务场景数据库表设计 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="互相关注业务场景数据库表设计" />
<meta property="og:description" content="目录
业务场景
业务问题：
数据库表设计：
like（关注表）：
friend（朋友表） 并发场景下，SQL语句执行逻辑
比较 A 和 B 的大小，如果 A执行下面的逻辑：&lt;&gt;
如果 A&gt;B,则执行下面的逻辑：
SQL写法详解：
参考内容：
业务场景 业务上有这样的需求，A、B两个用户，如果互相关注，则成为好友。
业务问题： 在并发场景下，同时有两个人，设置为关注对方，就可能导致无法成功加为朋友关系。如下：
session（a喜欢b）session（b喜欢a） begin;
select * from friend_like where user_id = B andliker_id = A;(返回空)
begin;
select * from friend_like where user_id = B andliker_id = A;(返回空)
insert into friend_like (user_id, liker_id) values(B,A);insert into friend_like (user_id, liker_id) values(A,B);commit;commit; 数据库表设计： like（关注表）： CREATE TABLE `friend_like` ( `id` int(11) NOT NULL AUTO_INCREMENT, `user_id` int(11) NOT NULL, `liker_id` int(11) NOT NULL, `relation_ship` int(11) NOT NULL, PRIMARY KEY (`id`), UNIQUE KEY `uk_user_id_liker_id` (`user_id`,`liker_id`) ) ENGINE=InnoDB; friend（朋友表） CREATE TABLE `friend` ( `id` int(11) NOT NULL AUTO_INCREMENT, `friend_1_id` int(11) NOT NULL, `friend_2_id` int(11) NOT NULL, UNIQUE KEY `uk_friend` (`friend_1_id`,`friend_2_id`), PRIMARY KEY (`id`) ) ENGINE=InnoDB; relation_ship: 1，表示 user id 关注 liker id;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/d0750b8e85b630c7930c439b94ea6db4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-03T15:44:19+08:00" />
<meta property="article:modified_time" content="2023-11-03T15:44:19+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">互相关注业务场景数据库表设计</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="-toc" style="margin-left:80px;"></p> 
<p id="%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF-toc" style="margin-left:80px;"><a href="#%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF" rel="nofollow">业务场景</a></p> 
<p id="%E4%B8%9A%E5%8A%A1%E9%97%AE%E9%A2%98%EF%BC%9A-toc" style="margin-left:80px;"><a href="#%E4%B8%9A%E5%8A%A1%E9%97%AE%E9%A2%98%EF%BC%9A" rel="nofollow">业务问题：</a></p> 
<p id="%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8%E8%AE%BE%E8%AE%A1%EF%BC%9A-toc" style="margin-left:80px;"><a href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8%E8%AE%BE%E8%AE%A1%EF%BC%9A" rel="nofollow">数据库表设计：</a></p> 
<p id="like%EF%BC%88%E5%85%B3%E6%B3%A8%E8%A1%A8%EF%BC%89%EF%BC%9A-toc" style="margin-left:120px;"><a href="#like%EF%BC%88%E5%85%B3%E6%B3%A8%E8%A1%A8%EF%BC%89%EF%BC%9A" rel="nofollow">like（关注表）：</a></p> 
<p id="friend%EF%BC%88%E6%9C%8B%E5%8F%8B%E8%A1%A8%EF%BC%89%C2%A0-toc" style="margin-left:120px;"><a href="#friend%EF%BC%88%E6%9C%8B%E5%8F%8B%E8%A1%A8%EF%BC%89%C2%A0" rel="nofollow">friend（朋友表） </a></p> 
<p id="%E5%B9%B6%E5%8F%91%E5%9C%BA%E6%99%AF%E4%B8%8B%EF%BC%8CSQL%E8%AF%AD%E5%8F%A5%E6%89%A7%E8%A1%8C%E9%80%BB%E8%BE%91-toc" style="margin-left:80px;"><a href="#%E5%B9%B6%E5%8F%91%E5%9C%BA%E6%99%AF%E4%B8%8B%EF%BC%8CSQL%E8%AF%AD%E5%8F%A5%E6%89%A7%E8%A1%8C%E9%80%BB%E8%BE%91" rel="nofollow">并发场景下，SQL语句执行逻辑</a></p> 
<p id="%E6%AF%94%E8%BE%83%20A%20%E5%92%8C%20B%20%E7%9A%84%E5%A4%A7%E5%B0%8F%EF%BC%8C%E5%A6%82%E6%9E%9C%20A%3CB%E6%89%A7%E8%A1%8C%E4%B8%8B%E9%9D%A2%E7%9A%84%E9%80%BB%E8%BE%91%EF%BC%9A-toc" style="margin-left:120px;"><a href="#%E6%AF%94%E8%BE%83%20A%20%E5%92%8C%20B%20%E7%9A%84%E5%A4%A7%E5%B0%8F%EF%BC%8C%E5%A6%82%E6%9E%9C%20A%3CB%E6%89%A7%E8%A1%8C%E4%B8%8B%E9%9D%A2%E7%9A%84%E9%80%BB%E8%BE%91%EF%BC%9A" rel="nofollow">比较 A 和 B 的大小，如果 A执行下面的逻辑：&lt;&gt;</a></p> 
<p id="%E5%A6%82%E6%9E%9C%20A%3EB%2C%E5%88%99%E6%89%A7%E8%A1%8C%E4%B8%8B%E9%9D%A2%E7%9A%84%E9%80%BB%E8%BE%91%EF%BC%9A-toc" style="margin-left:120px;"><a href="#%E5%A6%82%E6%9E%9C%20A%3EB%2C%E5%88%99%E6%89%A7%E8%A1%8C%E4%B8%8B%E9%9D%A2%E7%9A%84%E9%80%BB%E8%BE%91%EF%BC%9A" rel="nofollow">如果 A&gt;B,则执行下面的逻辑：</a></p> 
<p id="SQL%E5%86%99%E6%B3%95%E8%AF%A6%E8%A7%A3%EF%BC%9A-toc" style="margin-left:120px;"><a href="#SQL%E5%86%99%E6%B3%95%E8%AF%A6%E8%A7%A3%EF%BC%9A" rel="nofollow">SQL写法详解：</a></p> 
<p id="%E5%8F%82%E8%80%83%E5%86%85%E5%AE%B9%EF%BC%9A-toc" style="margin-left:80px;"><a href="#%E5%8F%82%E8%80%83%E5%86%85%E5%AE%B9%EF%BC%9A" rel="nofollow">参考内容：</a></p> 
<hr id="hr-toc"> 
<p></p> 
<h4 id="%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF">业务场景</h4> 
<p>业务上有这样的需求，A、B两个用户，如果互相关注，则成为好友。</p> 
<h4 id="%E4%B8%9A%E5%8A%A1%E9%97%AE%E9%A2%98%EF%BC%9A">业务问题：</h4> 
<p>在并发场景下，同时有两个人，设置为关注对方，就可能导致无法成功加为朋友关系。如下：</p> 
<table border="1" cellpadding="1" cellspacing="1" style="width:500px;"><tbody><tr><td style="width:229px;">session（a喜欢b）</td><td style="width:269px;">session（b喜欢a）</td></tr><tr><td style="width:229px;"> <p>begin;</p> <p>select * from friend_like where user_id = B andliker_id = A;(返回空)</p> </td><td style="width:269px;"></td></tr><tr><td style="width:229px;"></td><td style="width:269px;"> <p>begin;</p> <p>select * from  friend_like where user_id = B andliker_id = A;(返回空)</p> </td></tr><tr><td style="width:229px;"></td><td style="width:269px;">insert into  friend_like  (user_id, liker_id) values(B,A);</td></tr><tr><td style="width:229px;">insert into  friend_like  (user_id, liker_id) values(A,B);</td><td style="width:269px;"></td></tr><tr><td style="width:229px;">commit;</td><td style="width:269px;"></td></tr><tr><td style="width:229px;"></td><td style="width:269px;">commit;</td></tr></tbody></table> 
<h4 id="%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8%E8%AE%BE%E8%AE%A1%EF%BC%9A">数据库表设计：</h4> 
<h5 id="like%EF%BC%88%E5%85%B3%E6%B3%A8%E8%A1%A8%EF%BC%89%EF%BC%9A">like（关注表）：</h5> 
<pre><code>CREATE TABLE `friend_like` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `user_id` int(11) NOT NULL,
  `liker_id` int(11) NOT NULL,
  `relation_ship` int(11) NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_id_liker_id` (`user_id`,`liker_id`)
) ENGINE=InnoDB;</code></pre> 
<h5 id="friend%EF%BC%88%E6%9C%8B%E5%8F%8B%E8%A1%A8%EF%BC%89%C2%A0">friend（朋友表） </h5> 
<pre><code>CREATE TABLE `friend` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `friend_1_id` int(11) NOT NULL,
  `friend_2_id` int(11) NOT NULL,
  UNIQUE KEY `uk_friend` (`friend_1_id`,`friend_2_id`),
  PRIMARY KEY (`id`)
) ENGINE=InnoDB;</code></pre> 
<p> relation_ship: </p> 
<p>1，表示 user id 关注 liker id;</p> 
<p>2，表示liker id 关注 user id;</p> 
<p>3，表示互相关注。</p> 
<h4 id="%E5%B9%B6%E5%8F%91%E5%9C%BA%E6%99%AF%E4%B8%8B%EF%BC%8CSQL%E8%AF%AD%E5%8F%A5%E6%89%A7%E8%A1%8C%E9%80%BB%E8%BE%91">并发场景下，SQL语句执行逻辑</h4> 
<h5 id="%E6%AF%94%E8%BE%83%20A%20%E5%92%8C%20B%20%E7%9A%84%E5%A4%A7%E5%B0%8F%EF%BC%8C%E5%A6%82%E6%9E%9C%20A%3CB%E6%89%A7%E8%A1%8C%E4%B8%8B%E9%9D%A2%E7%9A%84%E9%80%BB%E8%BE%91%EF%BC%9A">比较 A 和 B 的大小，如果 A&lt;B执行下面的逻辑：</h5> 
<pre><code>begin; /*启动事务*/
insert into `like`(user_id, liker_id, relation_ship) values(A, B, 1) on duplicate key update relation_ship=relation_ship | 1;
select relation_ship from `like` where user_id=A and liker_id=B;
/*代码中判断返回的 relation_ship，
  如果是1，事务结束，执行 commit
  如果是3，则执行下面这两个语句：
  */
insert ignore into friend(friend_1_id, friend_2_id) values(A,B);
commit;/*提交事务*/</code></pre> 
<h5 id="%E5%A6%82%E6%9E%9C%20A%3EB%2C%E5%88%99%E6%89%A7%E8%A1%8C%E4%B8%8B%E9%9D%A2%E7%9A%84%E9%80%BB%E8%BE%91%EF%BC%9A">如果 A&gt;B,则执行下面的逻辑：</h5> 
<pre><code>begin; /*启动事务*/
insert into `like`(user_id, liker_id, relation_ship) values(B, A, 2) on duplicate key update relation_ship=relation_ship | 2;
select relation_ship from `like` where user_id=B and liker_id=A;
/*代码中判断返回的 relation_ship，
  如果是2，事务结束，执行 commit
  如果是3，则执行下面这两个语句：
*/
insert ignore into friend(friend_1_id, friend_2_id) values(B,A);
commit;</code></pre> 
<h5 id="SQL%E5%86%99%E6%B3%95%E8%AF%A6%E8%A7%A3%EF%BC%9A">SQL写法详解：</h5> 
<p>这个设计里，让“friend_like”表里的数据保证 user id &lt; liker id，这样不论是A关注B，还是B关注A，在操作“like”表的时候，如果反向的关系已经存在，就会出现行锁冲突<br> 然后，insert...on duplicate 语句，确保了在事务内部，执行了这个 SQL语句后，就强行占住了这个行锁，之后的 select 判断 relation ship 这个逻辑时就确保了是在行锁保护下的读操作。<br> 操作符“|” 是按位或，连同最后一句 insert 语句里的 ignore，是为了保证重复调用时的幂等性<br> 这样，即使在双方“同时”执行关注操作，最终数据库里的结果，也是 like 表里面有一条关于 A和B的记录，而且 relation ship 的值是3，并且 friend 表里面也有了A和B的这条记录。</p> 
<h4 id="%E5%8F%82%E8%80%83%E5%86%85%E5%AE%B9%EF%BC%9A">参考内容：</h4> 
<p><a href="https://time.geekbang.org/column/article/73161" rel="nofollow" title="15 | 答疑文章（一）：日志和索引相关问题 (geekbang.org)">15 | 答疑文章（一）：日志和索引相关问题 (geekbang.org)</a></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6b55c18060c7b81a6c2e0568ce7f43af/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">byte数组转16进制</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f1ea38ef01bcc9df36b9bcf3e8a66bdb/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">多种代码生成炫酷代码雨（推荐）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>