<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>关于docker网络实践中遇到的问题 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="关于docker网络实践中遇到的问题" />
<meta property="og:description" content="1.禁用docker自动修改iptables规则 查看docker.service文件/usr/lib/systemd/system/docker.service
默认在宿主机部署容器，映射了端口的话，docker能自己修改iptables规则，把这些端口暴露到公网。
如果要求这些端口不能暴露到公网，则可以在docker.service加上–iptables=false这个配置，则可以禁用掉此功能。随之而来的问题是，需要自己配置网络流量在宿主机网口和docker桥接网口之间的流转，否则就会出现网络流量只能出去，回不来的情况。
解决这个问题可以先不添加–iptables=false，让docker服务先运行起来，它就自己创建了对应的规则，然后通过iptables-save &gt; ./iptables.txt 命令把iptables规则保存成一个文件。再把文件内的暴露端口的相关规则删除掉。然后通过iptables-restore &lt; ./iptables.txt命令把规则刷到iptables即可。需要的就是下面这些流量转发的规则。
然后iptables需要放开对docker 网络中指定ip段的访问即可。
如果使用的是firewalld并不使用iptables，则需要编辑/etc/firewalld/direct.xml文件中的规则并重新加载防火墙以激活这些规则。Direct 规则主要由服务或应用程序用来添加特定的防火墙规则。
参考：https://blog.csdn.net/qq_38263083/article/details/130385278
这篇文章详细说明了docker 网络对iptables的影响：https://blog.csdn.net/weixin_39789525/article/details/110640003
Docker 添加了 DOCKER, DOCKER-USER, DOCKER-ISOLATION-STAGE-1， DOCKER-ISOLATION-STAGE-2 四条链
2.docker网络的NAT 启动docker时，docker进程会创建一个名为docker0的虚拟网桥，用于宿主机与容器之间的通信。当启动一个docker容器时，docker容器将会附加到虚拟网桥上，容器内的报文通过docker0向外转发。
如果docker容器访问宿主机，那么docker0网桥将报文直接转发到本机，报文的源地址是docker0网段的地址。而如果docker容器访问宿主机以外的机器，docker的SNAT网桥会将报文的源地址转换为宿主机的地址，通过宿主机的网卡向外发送。
docker容器无法访问宿主机报出 No route to host
docker网络和iptables规则
3.docker网络类型 bridge，使用bridge类型的驱动，这个网络就是我们一直在用的默认网络，此网络使用docker0作为虚拟交换机。host，使用host类型的驱动，当容器接入此网络时，会共享宿主机的网络空间。none，没有使用任何类型的网络驱动，当容器使用none网络时，表示禁用网络。overlay，使得多个Docker主机可以连接在一起，形成一个虚拟网络，从而实现多主机之间的容器通信。Docker Overlay网络使用VXLAN协议实现跨主机的网络通信。 当你初始化一个 Swarm 或将一个Docker主机加入到一个现有的Swarm时，在该Docker主机上会创建两个新的网络：
一个ingress的 overlay 网络，它处理与 swarm 服务相关的控制和数据流量。当你创建一个 swarm 服务，并且没有把它连接到用户定义的 overlay 网络时，它默认连接到 ingress 网络。一个docker_gwbridge 的 bridge 网络，它将单个 Docker daemon 与 Swarm 里的其他daemon 连接起来。 docker overlay网络原理详解
docker swarm网络如何路由" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/298a9544310f55ff9130fcb7fab2df60/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-10T15:41:18+08:00" />
<meta property="article:modified_time" content="2023-11-10T15:41:18+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">关于docker网络实践中遇到的问题</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-kimbie-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h5><a id="1dockeriptables_0"></a>1.禁用docker自动修改iptables规则</h5> 
<p>查看docker.service文件/usr/lib/systemd/system/docker.service<br> <img src="https://images2.imgbox.com/74/88/zQsU91Hy_o.png" alt="在这里插入图片描述"><br> 默认在宿主机部署容器，映射了端口的话，docker能自己修改iptables规则，把这些端口暴露到公网。<br> <img src="https://images2.imgbox.com/48/97/8KIXDogZ_o.png" alt="在这里插入图片描述"><br> 如果要求这些端口不能暴露到公网，则可以在docker.service加上–iptables=false这个配置，则可以禁用掉此功能。随之而来的问题是，需要自己配置网络流量在宿主机网口和docker桥接网口之间的流转，否则就会出现网络流量只能出去，回不来的情况。<br> 解决这个问题可以先不添加–iptables=false，让docker服务先运行起来，它就自己创建了对应的规则，然后通过iptables-save &gt; ./iptables.txt 命令把iptables规则保存成一个文件。再把文件内的暴露端口的相关规则删除掉。然后通过iptables-restore &lt; ./iptables.txt命令把规则刷到iptables即可。需要的就是下面这些流量转发的规则。<br> <img src="https://images2.imgbox.com/77/ca/mU16K5D7_o.png" alt="在这里插入图片描述"><br> 然后iptables需要放开对docker 网络中指定ip段的访问即可。</p> 
<p>如果使用的是firewalld并不使用iptables，则需要编辑/etc/firewalld/direct.xml文件中的规则并重新加载防火墙以激活这些规则。Direct 规则主要由服务或应用程序用来添加特定的防火墙规则。<br> 参考：https://blog.csdn.net/qq_38263083/article/details/130385278</p> 
<p>这篇文章详细说明了docker 网络对iptables的影响：https://blog.csdn.net/weixin_39789525/article/details/110640003</p> 
<blockquote> 
 <p>Docker 添加了 DOCKER, DOCKER-USER, DOCKER-ISOLATION-STAGE-1， DOCKER-ISOLATION-STAGE-2 四条链</p> 
</blockquote> 
<h5><a id="2dockerNAT_18"></a>2.docker网络的NAT</h5> 
<p>启动docker时，docker进程会创建一个名为docker0的虚拟网桥，用于宿主机与容器之间的通信。当启动一个docker容器时，docker容器将会附加到虚拟网桥上，容器内的报文通过docker0向外转发。</p> 
<p>如果docker容器访问宿主机，那么docker0网桥将报文直接转发到本机，报文的源地址是docker0网段的地址。而如果docker容器访问宿主机以外的机器，docker的SNAT网桥会将报文的源地址转换为宿主机的地址，通过宿主机的网卡向外发送。</p> 
<p><a href="https://blog.csdn.net/qq_22260641/article/details/119276721">docker容器无法访问宿主机报出 No route to host</a><br> <a href="https://www.zsythink.net/archives/4409" rel="nofollow">docker网络和iptables规则</a></p> 
<p><img src="https://images2.imgbox.com/47/80/6KnUUwiW_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="3docker_27"></a>3.docker网络类型</h5> 
<ul><li>bridge，使用bridge类型的驱动，这个网络就是我们一直在用的默认网络，此网络使用docker0作为虚拟交换机。</li><li>host，使用host类型的驱动，当容器接入此网络时，会共享宿主机的网络空间。</li><li>none，没有使用任何类型的网络驱动，当容器使用none网络时，表示禁用网络。</li><li>overlay，使得多个Docker主机可以连接在一起，形成一个虚拟网络，从而实现多主机之间的容器通信。Docker Overlay网络使用VXLAN协议实现跨主机的网络通信。</li></ul> 
<p>当你初始化一个 Swarm 或将一个Docker主机加入到一个现有的Swarm时，在该Docker主机上会创建两个新的网络：</p> 
<ul><li>一个ingress的 overlay 网络，它处理与 swarm 服务相关的控制和数据流量。当你创建一个 swarm 服务，并且没有把它连接到用户定义的 overlay 网络时，它默认连接到 ingress 网络。</li><li>一个docker_gwbridge 的 bridge 网络，它将单个 Docker daemon 与 Swarm 里的其他daemon 连接起来。</li></ul> 
<p><a href="https://cloud.tencent.com/developer/article/2246171?areaSource=102001.9&amp;traceId=XukGDjahkTuFBknX5ngcC" rel="nofollow">docker overlay网络原理详解</a><br> <a href="https://www.jianshu.com/p/b48b8898bd76" rel="nofollow">docker swarm网络如何路由</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4c6a8a6462aca5111c7dd08726ea8f32/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">内核编译报错: No rule to make target ‘debian/canonical-certs.pem‘, needed by ‘certs/x509_certificate_list‘</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3afc4dfeb1bd52dc06eb0594b6d7efb3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Mac电脑Visio文件编辑查看软件推荐Visio Viewer for Mac</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>