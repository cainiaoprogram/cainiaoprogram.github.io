<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Tensorflow下使用SSD训练自己的数据集 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Tensorflow下使用SSD训练自己的数据集" />
<meta property="og:description" content="Tensorflow下使用SSD训练自己的数据集 1、数据集格式转换。
① 将自己的数据集做成VOC2007格式，直接将VOC2007文件夹粘贴到SSD-Tensorflow-master目录下。
② 修改datasets文件夹中pascalvoc_common.py文件中的训练类。
#原始的 # VOC_LABELS = { # &#39;none&#39;: (0, &#39;Background&#39;), # &#39;aeroplane&#39;: (1, &#39;Vehicle&#39;), # &#39;bicycle&#39;: (2, &#39;Vehicle&#39;), # &#39;bird&#39;: (3, &#39;Animal&#39;), # &#39;boat&#39;: (4, &#39;Vehicle&#39;), # &#39;bottle&#39;: (5, &#39;Indoor&#39;), # &#39;bus&#39;: (6, &#39;Vehicle&#39;), # &#39;car&#39;: (7, &#39;Vehicle&#39;), # &#39;cat&#39;: (8, &#39;Animal&#39;), # &#39;chair&#39;: (9, &#39;Indoor&#39;), # &#39;cow&#39;: (10, &#39;Animal&#39;), # &#39;diningtable&#39;: (11, &#39;Indoor&#39;), # &#39;dog&#39;: (12, &#39;Animal&#39;), # &#39;horse&#39;: (13, &#39;Animal&#39;), # &#39;motorbike&#39;: (14, &#39;Vehicle&#39;), # &#39;person&#39;: (15, &#39;Person&#39;), # &#39;pottedplant&#39;: (16, &#39;Indoor&#39;), # &#39;sheep&#39;: (17, &#39;Animal&#39;), # &#39;sofa&#39;: (18, &#39;Indoor&#39;), # &#39;train&#39;: (19, &#39;Vehicle&#39;), # &#39;tvmonitor&#39;: (20, &#39;Indoor&#39;), # } #修改后的 VOC_LABELS = { &#39;none&#39;: (0, &#39;Background&#39;), &#39;gun&#39;: (1, &#39;gun&#39;), &#39;knife&#39;: (2, &#39;knife&#39;), } ③ 修改datasets文件夹中的pascalvoc_to_tfrecords." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/7b7d82109c3b16e351ff11cfa085f7aa/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-03-27T19:21:55+08:00" />
<meta property="article:modified_time" content="2019-03-27T19:21:55+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Tensorflow下使用SSD训练自己的数据集</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>Tensorflow下使用SSD训练自己的数据集</h2> 
<p>1、<strong>数据集格式转换</strong>。</p> 
<p>① 将自己的数据集做成VOC2007格式，直接将VOC2007文件夹粘贴到SSD-Tensorflow-master目录下。</p> 
<p>② 修改datasets文件夹中pascalvoc_common.py文件中的训练类。</p> 
<pre class="has"><code class="language-python">#原始的
# VOC_LABELS = {
#     'none': (0, 'Background'),
#     'aeroplane': (1, 'Vehicle'),
#     'bicycle': (2, 'Vehicle'),
#     'bird': (3, 'Animal'),
#     'boat': (4, 'Vehicle'),
#     'bottle': (5, 'Indoor'),
#     'bus': (6, 'Vehicle'),
#     'car': (7, 'Vehicle'),
#     'cat': (8, 'Animal'),
#     'chair': (9, 'Indoor'),
#     'cow': (10, 'Animal'),
#     'diningtable': (11, 'Indoor'),
#     'dog': (12, 'Animal'),
#     'horse': (13, 'Animal'),
#     'motorbike': (14, 'Vehicle'),
#     'person': (15, 'Person'),
#     'pottedplant': (16, 'Indoor'),
#     'sheep': (17, 'Animal'),
#     'sofa': (18, 'Indoor'),
#     'train': (19, 'Vehicle'),
#     'tvmonitor': (20, 'Indoor'),
# }

#修改后的
VOC_LABELS = {
    'none': (0, 'Background'),
    'gun': (1, 'gun'),
    'knife': (2, 'knife'),
}
</code></pre> 
<p>③ 修改datasets文件夹中的pascalvoc_to_tfrecords.py文件。</p> 
<p>修改文件的83行读取方式为’rb‘，如果你的文件不是.jpg格式，也可以修改图片的类型。</p> 
<pre class="has"><code class="language-python">    # Read the image file.
    filename = directory + DIRECTORY_IMAGES + name + '.jpg'
    image_data = tf.gfile.FastGFile(filename, 'rb').read()</code></pre> 
<p>修改文件的67行，设置将几张图片转为一个tfrecords。</p> 
<pre class="has"><code class="language-python"># TFRecords convertion parameters.
RANDOM_SEED = 4242
SAMPLES_PER_FILES = 1 # 一张图片转为一个tfrecords</code></pre> 
<p>④ 在SSD-Tensorflow-master目录下创建tfrecords_文件夹，做以下改动后运行tf_convert_data.py文件。</p> 
<p><strong>Linux下：</strong>在SSD-Tensorflow-master目录下创建tf_conver_data.sh,文件写入内容如下：</p> 
<p>            DATASET_DIR=./VOC2007/     #VOC数据保存的文件夹（VOC的目录格式未改变）  <br>             OUTPUT_DIR=./tfrecords_  #自己建立的保存tfrecords数据的文件夹       <br>             python ./tf_convert_data.py \     <br>               --dataset_name=pascalvoc \         <br>               --dataset_dir=${DATASET_DIR} \   <br>               --output_name=voc_2007_train \ <br>               --output_dir=${OUTPUT_DIR}</p> 
<p><strong>Windows+pychram：</strong>配置pycharm--&gt;run--&gt;Edit Configuration</p> 
<p>Script parameters中写入：--dataset_name=pascalvoc --dataset_dir=./VOC2007/ --output_name=voc_2007_train --output_dir=./tfrecords_</p> 
<p><img alt="" class="has" height="222" src="https://images2.imgbox.com/76/a6/dAGMpwG0_o.png" width="719"></p> 
<p>⑤ 生成后的结果。<br><img alt="" class="has" height="164" src="https://images2.imgbox.com/c1/75/VpAOaPDo_o.png" width="611"></p> 
<p>2、<strong>训练模型</strong>。</p> 
<p>① 修改train_ssd_network.py文件，设置训练参数(此处可进行学习率等参数的修改，也可以不修改，在使用cmd命令运行文件时进行设置)。</p> 
<pre class="has"><code class="language-python"># 修改135行
tf.app.flags.DEFINE_integer(
    'num_classes', 3, 'Number of classes to use in the dataset.') # 自己的类别数+1


# 修改154行，设置迭代次数，max-step为None时会无限训练
tf.app.flags.DEFINE_integer('max_number_of_steps', 6000,
                            'The maximum number of training steps.')</code></pre> 
<p>② 修改nets目录下的ssd_vgg_300.py文件(使用此网络结构时) 。</p> 
<pre class="has"><code class="language-python"># 修改94-97行
    default_params = SSDParams(
        img_shape=(300, 300),      # 输入的size
        num_classes=3,      # 修改为自己的类别数+1
        no_annotation_label=3,      # 修改为自己的类别数+1</code></pre> 
<p>③ 修改eval_ssd_network.py文件。</p> 
<pre class="has"><code class="language-python"># 65-66行
tf.app.flags.DEFINE_integer(
    'num_classes', 3, 'Number of classes to use in the dataset.') # 修改为自己的类别数+1</code></pre> 
<p>④ 修改datasets目录下的pascalvoc_2007.py文件。</p> 
<pre class="has"><code class="language-python"># 原始文件
# (Images, Objects) statistics on every class.
# TRAIN_STATISTICS = {
# 'none': (0, 0),
# 'aeroplane': (238, 306), # 238为该类训练图像总数，306为该类训练图像中框的总数
# 'bicycle': (243, 353),
# 'bird': (330, 486),
# 'boat': (181, 290),
# 'bottle': (244, 505),
# 'bus': (186, 229),
# 'car': (713, 1250),
# 'cat': (337, 376),
# 'chair': (445, 798),
# 'cow': (141, 259),
# 'diningtable': (200, 215),
# 'dog': (421, 510),
# 'horse': (287, 362),
# 'motorbike': (245, 339),
# 'person': (2008, 4690),
# 'pottedplant': (245, 514),
# 'sheep': (96, 257),
# 'sofa': (229, 248),
# 'train': (261, 297),
# 'tvmonitor': (256, 324),
# 'total': (5011, 12608),
# }

# TEST_STATISTICS = {
# 'none': (0, 0),
# 'aeroplane': (1, 1),
# 'bicycle': (1, 1),
# 'bird': (1, 1),
# 'boat': (1, 1),
# 'bottle': (1, 1),
# 'bus': (1, 1),
# 'car': (1, 1),
# 'cat': (1, 1),
# 'chair': (1, 1),
# 'cow': (1, 1),
# 'diningtable': (1, 1),
# 'dog': (1, 1),
# 'horse': (1, 1),
# 'motorbike': (1, 1),
# 'person': (1, 1),
# 'pottedplant': (1, 1),
# 'sheep': (1, 1),
# 'sofa': (1, 1),
# 'train': (1, 1),
# 'tvmonitor': (1, 1),
# 'total': (20, 20),
# }

# SPLITS_TO_SIZES = {
# 'train': 5011,
# 'test': 4952,
# }

# SPLITS_TO_STATISTICS = {
#     'train': TRAIN_STATISTICS,
#     'test': TEST_STATISTICS,
# }

# NUM_CLASSES = 20

# 修改后
# (Images, Objects) statistics on every class.
TRAIN_STATISTICS = {
    'none': (0, 0),
    'gun': (77, 77),
    'knife': (77, 77),
    'total': (154, 154),
}
TEST_STATISTICS = {
    'none': (0, 0),
    'gun': (1, 1),
    'knife': (1, 1),
    'total': (2, 2),
}
SPLITS_TO_SIZES = {
    'train': 154,
    'test': 66,
}
SPLITS_TO_STATISTICS = {
    'train': TRAIN_STATISTICS,
    'test': TEST_STATISTICS,
}
NUM_CLASSES = 2 # 自己的训练类别数</code></pre> 
<p>3、加载预训练模型。</p> 
<p>下载预训练好的vgg16模型，解压出vgg_16.ckpt文件放入checkpoint文件中。</p> 
<p>下载地址参考：<a href="https://blog.csdn.net/weixin_39881922/article/details/80569803">目标检测SSD+Tensorflow 训练自己的数据集</a></p> 
<p>链接：https://pan.baidu.com/s/1diWbdJdjVbB3AWN99406nA 密码：ge3x</p> 
<p><img alt="" class="has" height="128" src="https://images2.imgbox.com/24/30/De5nZYkn_o.png" width="295"></p> 
<p><strong>Linux：</strong>新建一个.sh文件，文件里写入</p> 
<pre class="has"><code class="language-python">DATASET_DIR=./tfrecords_/
TRAIN_DIR=./train_model/
CHECKPOINT_PATH=./checkpoints/vgg_16.ckpt 

python3 ./train_ssd_network.py \  
    --train_dir=./train_model/ \      #训练生成模型的存放路径  
    --dataset_dir=./tfrecords_/ \  #数据存放路径  
    --dataset_name=pascalvoc_2007 \ #数据名的前缀  
    --dataset_split_name=train \  
    --model_name=ssd_300_vgg \      #加载的模型的名字  
    --checkpoint_path=./checkpoints/vgg_16.ckpt \  #所加载模型的路径  
    --checkpoint_model_scope=vgg_16 \   #所加载模型里面的作用域名  
    --checkpoint_exclude_scopes=ssd_300_vgg/conv6,ssd_300_vgg/conv7,ssd_300_vgg/block8,ssd_300_vgg/block9,ssd_300_vgg/block10,ssd_300_vgg/block11,ssd_300_vgg/block4_box,ssd_300_vgg/block7_box,ssd_300_vgg/block8_box,ssd_300_vgg/block9_box,ssd_300_vgg/block10_box,ssd_300_vgg/block11_box \  
    --trainable_scopes=ssd_300_vgg/conv6,ssd_300_vgg/conv7,ssd_300_vgg/block8,ssd_300_vgg/block9,ssd_300_vgg/block10,ssd_300_vgg/block11,ssd_300_vgg/block4_box,ssd_300_vgg/block7_box,ssd_300_vgg/block8_box,ssd_300_vgg/block9_box,ssd_300_vgg/block10_box,ssd_300_vgg/block11_box \  
    --save_summaries_secs=60 \  #每60s保存一下日志  
    --save_interval_secs=600 \  #每600s保存一下模型  
    --weight_decay=0.0005 \     #正则化的权值衰减的系数  
    --optimizer=adam \          #选取的最优化函数  
    --learning_rate=0.001 \     #学习率  
    --learning_rate_decay_factor=0.94 \ #学习率的衰减因子  
    --batch_size=24 \     
    --gpu_memory_fraction=0.9   #指定占用gpu内存的百分比 
</code></pre> 
<p><strong>Windows+pycharm：</strong>在上述的run中Edit Configuration配置，打开命令运行代码</p> 
<pre class="has"><code class="language-python">python ./train_ssd_network.py  --train_dir=./train_model/  --dataset_dir=./tfrecords_/  --dataset_name=pascalvoc_2007 --dataset_split_name=train --model_name=ssd_300_vgg   --checkpoint_path=./checkpoints/vgg_16.ckpt   --checkpoint_model_scope=vgg_16 --checkpoint_exclude_scopes=ssd_300_vgg/conv6,ssd_300_vgg/conv7,ssd_300_vgg/block8,ssd_300_vgg/block9,ssd_300_vgg/block10,ssd_300_vgg/block11,ssd_300_vgg/block4_box,ssd_300_vgg/block7_box,ssd_300_vgg/block8_box,ssd_300_vgg/block9_box,ssd_300_vgg/block10_box,ssd_300_vgg/block11_box   --trainable_scopes=ssd_300_vgg/conv6,ssd_300_vgg/conv7,ssd_300_vgg/block8,ssd_300_vgg/block9,ssd_300_vgg/block10,ssd_300_vgg/block11,ssd_300_vgg/block4_box,ssd_300_vgg/block7_box,ssd_300_vgg/block8_box,ssd_300_vgg/block9_box,ssd_300_vgg/block10_box,ssd_300_vgg/block11_box --save_summaries_secs=60   --save_interval_secs=600 --weight_decay=0.0005   --optimizer=adam   --learning_rate=0.001 --learning_rate_decay_factor=0.94   --batch_size=24      --gpu_memory_fraction=0.9    
</code></pre> 
<p><img alt="" class="has" height="484" src="https://images2.imgbox.com/f2/7b/JsHC0Tti_o.png" width="537"></p> 
<p>4、参考</p> 
<p><a href="https://blog.csdn.net/weixin_39881922/article/details/80569803">目标检测SSD+Tensorflow 训练自己的数据集</a></p> 
<p><a href="https://blog.csdn.net/qq1483661204/article/details/79776065">目标检测 -- SSD (tensorflow 版) 逐行逐句解读</a></p> 
<p><a href="https://blog.csdn.net/clover_my/article/details/88853884">Windows下TensorFlow+SSD遇到的问题</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/573e20c8f260171281b7a42df10725f3/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">一文看懂YOLO v2</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5a7b19757f79d88bdc0688dfe7cc3973/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Spring boot 2项目部署到Windows系统tomcat中遇到中文乱码问题（都是问号？）解决记录...</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>