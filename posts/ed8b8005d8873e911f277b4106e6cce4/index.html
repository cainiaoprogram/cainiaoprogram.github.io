<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>k8s1.26 nfs-provisioner配置 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="k8s1.26 nfs-provisioner配置" />
<meta property="og:description" content="nfs-provisioner配置相对简单：
rbac配置 [root@k8s-1 nfs-provisioner]# cat sa.yaml apiVersion: v1 kind: ServiceAccount metadata: name: nfs-client-provisioner # replace with namespace where provisioner is deployed namespace: default --- kind: ClusterRole apiVersion: rbac.authorization.k8s.io/v1 metadata: name: nfs-client-provisioner-runner rules: - apiGroups: [&#34;&#34;] resources: [&#34;nodes&#34;] verbs: [&#34;get&#34;, &#34;list&#34;, &#34;watch&#34;] - apiGroups: [&#34;&#34;] resources: [&#34;persistentvolumes&#34;] verbs: [&#34;get&#34;, &#34;list&#34;, &#34;watch&#34;, &#34;create&#34;, &#34;delete&#34;] - apiGroups: [&#34;&#34;] resources: [&#34;persistentvolumeclaims&#34;] verbs: [&#34;get&#34;, &#34;list&#34;, &#34;watch&#34;, &#34;update&#34;] - apiGroups: [&#34;storage.k8s.io&#34;] resources: [&#34;storageclasses&#34;] verbs: [&#34;get&#34;, &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/ed8b8005d8873e911f277b4106e6cce4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-18T11:19:02+08:00" />
<meta property="article:modified_time" content="2023-04-18T11:19:02+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">k8s1.26 nfs-provisioner配置</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>nfs-provisioner配置相对简单：</p> 
<h3>rbac配置</h3> 
<p>[root@k8s-1 nfs-provisioner]# cat sa.yaml </p> 
<pre><code class="language-bash">apiVersion: v1
kind: ServiceAccount
metadata:
  name: nfs-client-provisioner
  # replace with namespace where provisioner is deployed
  namespace: default
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: nfs-client-provisioner-runner
rules:
  - apiGroups: [""]
    resources: ["nodes"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["persistentvolumes"]
    verbs: ["get", "list", "watch", "create", "delete"]
  - apiGroups: [""]
    resources: ["persistentvolumeclaims"]
    verbs: ["get", "list", "watch", "update"]
  - apiGroups: ["storage.k8s.io"]
    resources: ["storageclasses"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["create", "update", "patch"]
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: run-nfs-client-provisioner
subjects:
  - kind: ServiceAccount
    name: nfs-client-provisioner
    # replace with namespace where provisioner is deployed
    namespace: default
roleRef:
  kind: ClusterRole
  name: nfs-client-provisioner-runner
  apiGroup: rbac.authorization.k8s.io
---
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: leader-locking-nfs-client-provisioner
  # replace with namespace where provisioner is deployed
  namespace: default
rules:
  - apiGroups: [""]
    resources: ["endpoints"]
    verbs: ["get", "list", "watch", "create", "update", "patch"]
---
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: leader-locking-nfs-client-provisioner
  # replace with namespace where provisioner is deployed
  namespace: default
subjects:
  - kind: ServiceAccount
    name: nfs-client-provisioner
    # replace with namespace where provisioner is deployed
    namespace: default
roleRef:
  kind: Role
  name: leader-locking-nfs-client-provisioner
  apiGroup: rbac.authorization.k8s.io</code></pre> 
<h3>deployment配置</h3> 
<p>[root@k8s-1 nfs-provisioner]# cat deploy.yaml</p> 
<pre><code class="language-bash">kind: Deployment
apiVersion: apps/v1
metadata:
  name: nfs-client-provisioner
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nfs-client-provisioner
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: nfs-client-provisioner
    spec:
      serviceAccountName: nfs-client-provisioner
      containers:
        - name: nfs-client-provisioner
          image: registry.cn-beijing.aliyuncs.com/mydlq/nfs-subdir-external-provisioner:v4.0.0
          volumeMounts:
            - name: nfs-client-root
              mountPath: /persistentvolumes
          env:
            - name: PROVISIONER_NAME
              value: nfs-provisioner # 和3.Storage中provisioner保持一致便可
            - name: NFS_SERVER
              value: 192.168.2.220
            - name: NFS_PATH
              value: /data/nfs_provisioner
      volumes:
        - name: nfs-client-root
          nfs:
            server: 192.168.2.220
            path: /data/nfs_provisioner</code></pre> 
<p></p> 
<h3>storageclass配置</h3> 
<p>[root@k8s-1 nfs-provisioner]# cat storageclass.yaml </p> 
<pre><code class="language-bash">kind: StorageClass
apiVersion: storage.k8s.io/v1
metadata:
  annotations:
    storageclass.kubernetes.io/is-default-class: "true"
  name: nfs-storage
provisioner: nfs-provisioner
volumeBindingMode: Immediate
reclaimPolicy: Delete</code></pre> 
<p>应用部署</p> 
<p>[root@k8s-1 nfs-provisioner]# kubectl apply -f sa.yaml </p> 
<p>[root@k8s-1 nfs-provisioner]# kubectl apply -f deploy.yaml</p> 
<p>[root@k8s-1 nfs-provisioner]# kubectl apply -f  storageclass.yaml</p> 
<p>[root@k8s-1 nfs-provisioner]# kubectl get pod  |grep nfs<br> nfs-client-provisioner-7b6b68d687-pc2hz   1/1     Running   0               75m</p> 
<p>测试：</p> 
<pre><code class="language-bash">[root@k8s-1 nfs-provisioner]# cat nginx_sts_pvc.yaml 
apiVersion: v1
kind: Service
metadata:
  name: nginx
  labels:
    app: nginx
spec:
  ports:
  - port: 80
    name: web
  clusterIP: None
  selector:
    app: nginx
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: web
spec:
  serviceName: "nginx"
  replicas: 2
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx
        ports:
        - containerPort: 80
          name: web
        volumeMounts:
        - name: www
          mountPath: /usr/share/nginx/html
  volumeClaimTemplates:
  - metadata:
      name: www
    spec:
      accessModes: [ "ReadWriteOnce" ]
      storageClassName: "nfs-storage"
      resources:
        requests:
          storage: 10Mi</code></pre> 
<p>[root@k8s-1 nfs-provisioner]# kubectl apply -f nginx_sts_pvc.yaml <br> service/nginx created<br> statefulset.apps/web created</p> 
<p>[root@k8s-1 nfs-provisioner]# kubectl get pod -A |grep web<br> default       web-0                                     1/1     Running   0               44s<br> default       web-1                                     1/1     Running   0               41s</p> 
<p>自动创建pv,pvc</p> 
<pre><code class="language-bash">[root@k8s-1 nfs-provisioner]# kubectl get pv,pvc |grep web
persistentvolume/pvc-1a4130ff-4c42-48b2-af27-2eac30b90e96   10Mi       RWO            Delete           Bound    default/www-web-0      nfs-storage             13h
persistentvolume/pvc-a41fd05f-94ec-4b56-8232-f65512486508   10Mi       RWO            Delete           Bound    default/www-web-1      nfs-storage             13h
persistentvolumeclaim/www-web-0      Bound    pvc-1a4130ff-4c42-48b2-af27-2eac30b90e96   10Mi       RWO            nfs-storage    13h
persistentvolumeclaim/www-web-1      Bound    pvc-a41fd05f-94ec-4b56-8232-f65512486508   10Mi       RWO            nfs-storage    13h

[root@k8s-1 nfs-provisioner]# kubectl get svc |grep nginx
nginx        ClusterIP   None             &lt;none&gt;        80/TCP         3m43s

</code></pre> 
<p></p> 
<p>[root@k8s-1 nfs-provisioner]# curl  web-1.nginx.default.svc.cluster.local<br> web-1<br> [root@k8s-1 nfs-provisioner]# curl  web-0.nginx.default.svc.cluster.local<br> web-0</p> 
<p></p> 
<p>部署成功。</p> 
<p></p> 
<p><a href="https://www.kubebiz.com/wow/nfs-client-provisioner?k8sv=v1.24" rel="nofollow" title="参考文章：https://www.kubebiz.com/wow/nfs-client-provisioner?k8sv=v1.24">参考文章：https://www.kubebiz.com/wow/nfs-client-provisioner?k8sv=v1.24</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7165759818cd35506f06be30e1095191/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">人工智能中的顶级期刊</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/bc26f255c8997d91d3b826335994e488/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">k8s部署mysql一主二从，数据持久化部署</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>