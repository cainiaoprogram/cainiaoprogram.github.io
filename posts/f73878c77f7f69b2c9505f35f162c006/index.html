<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>弱网测试：使用netem模拟网络延迟、丢包、损坏、重复、和乱序等网络问题 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="弱网测试：使用netem模拟网络延迟、丢包、损坏、重复、和乱序等网络问题" />
<meta property="og:description" content="本文目录 1、延时---Delay1.1、enp2s0 网卡上增加100ms延时1.2、enp2s0 网卡上增加100ms ± 20ms的延时(80ms到120ms)1.3、enp2s0 网卡上增加100ms ± 20ms的延时(80ms到120ms)，并且设置相关系数为50%1.4、enp2s0 网卡上增加100ms ± 20ms的延时(80ms到120ms)，报文延时分布满足正态分布 2、丢包率---loss2.1、enp2s0 网卡模拟发送的报文有 16% 的丢包率2.2、enp2s0 网卡模拟发送的报文使用loss state/loss gemodel模型进行丢包2.3、enp2s0 网卡模拟发送的报文选用loss state/loss gemodel模型进行丢包时的enc选项 3、损坏/错误报文---corrupt3.1、enp2s0 网卡模拟发送的报文中随机选取 25%变成损坏的报文（在被随机选中做为错误报文的随机位置造成一个错误） 4、重复报文---duplicate4.1、enp2s0 网卡模拟发送的报文中随机选取 25%产生重复报文 5、乱序---reorder5.1、enp2s0 网卡模拟发送的报文中每5个报文就产生一个乱序包5.2、enp2s0 网卡模拟发送的报文中以50%的概率完全随机产生乱序包 6、基于报文数量(令牌桶TBF)的限速---limit7、基于报文长度的限速---rate8、基于时间窗的延时与限速---slot NetEm 是Linux的TC(traffic control)下的那个增强工具，使用这个工具可以在指定的网卡的发送方向上，注入网络延迟、丢包、重复、损坏和乱序等，用于在性能良好的局域网中，模拟出广域网中复杂的网络问题。 值得注意的是NetEm的规则是在指定网卡上生效的，所以所有从指定网卡发出的报文都会受到NetEm指定规则的影响。
NetEm借助于tc的qdisc框架，配置到网卡上，支持的命令格式如下(注意：一般来说netem要在root权限下配置)
tc qdisc ... dev DEVICE ] add netem OPTIONS OPTIONS := [ LIMIT ] [ DELAY ] [ LOSS ] [ CORRUPT ] [ DUPLICATION ] [ REORDERING ] [ RATE ] [ SLOT ] NetEm支持LIMIT, DELAY, LOSS, CORRUPT, DUPLICATION, REORDERING, RATE, SLOT这几种选项，下面会挨个详细介绍。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/f73878c77f7f69b2c9505f35f162c006/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-05T11:54:06+08:00" />
<meta property="article:modified_time" content="2023-04-05T11:54:06+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">弱网测试：使用netem模拟网络延迟、丢包、损坏、重复、和乱序等网络问题</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>本文目录</h4> 
 <ul><li><a href="#1Delay_15" rel="nofollow">1、延时---Delay</a></li><li><ul><li><a href="#11enp2s0_100ms_38" rel="nofollow">1.1、enp2s0 网卡上增加100ms延时</a></li><li><a href="#12enp2s0_100ms__20ms80ms120ms_44" rel="nofollow">1.2、enp2s0 网卡上增加100ms ± 20ms的延时(80ms到120ms)</a></li><li><a href="#13enp2s0_100ms__20ms80ms120ms50_50" rel="nofollow">1.3、enp2s0 网卡上增加100ms ± 20ms的延时(80ms到120ms)，并且设置相关系数为50%</a></li><li><a href="#14enp2s0_100ms__20ms80ms120ms_56" rel="nofollow">1.4、enp2s0 网卡上增加100ms ± 20ms的延时(80ms到120ms)，报文延时分布满足正态分布</a></li></ul> 
  </li><li><a href="#2loss_62" rel="nofollow">2、丢包率---loss</a></li><li><ul><li><a href="#21enp2s0__16__83" rel="nofollow">2.1、enp2s0 网卡模拟发送的报文有 16% 的丢包率</a></li><li><a href="#22enp2s0_loss_stateloss_gemodel_89" rel="nofollow">2.2、enp2s0 网卡模拟发送的报文使用loss state/loss gemodel模型进行丢包</a></li><li><a href="#23enp2s0_loss_stateloss_gemodelenc_93" rel="nofollow">2.3、enp2s0 网卡模拟发送的报文选用loss state/loss gemodel模型进行丢包时的enc选项</a></li></ul> 
  </li><li><a href="#3corrupt_96" rel="nofollow">3、损坏/错误报文---corrupt</a></li><li><ul><li><a href="#31enp2s0__25_109" rel="nofollow">3.1、enp2s0 网卡模拟发送的报文中随机选取 25%变成损坏的报文（在被随机选中做为错误报文的随机位置造成一个错误）</a></li></ul> 
  </li><li><a href="#4duplicate_116" rel="nofollow">4、重复报文---duplicate</a></li><li><ul><li><a href="#41enp2s0__25_130" rel="nofollow">4.1、enp2s0 网卡模拟发送的报文中随机选取 25%产生重复报文</a></li></ul> 
  </li><li><a href="#5reorder_136" rel="nofollow">5、乱序---reorder</a></li><li><ul><li><a href="#51enp2s0_5_161" rel="nofollow">5.1、enp2s0 网卡模拟发送的报文中每5个报文就产生一个乱序包</a></li><li><a href="#52enp2s0_50_167" rel="nofollow">5.2、enp2s0 网卡模拟发送的报文中以50%的概率完全随机产生乱序包</a></li></ul> 
  </li><li><a href="#6TBFlimit_174" rel="nofollow">6、基于报文数量(令牌桶TBF)的限速---limit</a></li><li><a href="#7rate_176" rel="nofollow">7、基于报文长度的限速---rate</a></li><li><a href="#8slot_178" rel="nofollow">8、基于时间窗的延时与限速---slot</a></li></ul> 
</div> 
<p></p> 
<p>NetEm 是Linux的TC(traffic control)下的那个增强工具，使用这个工具可以在指定的网卡的发送方向上，注入网络延迟、丢包、重复、损坏和乱序等，用于在性能良好的局域网中，模拟出广域网中复杂的网络问题。 值得注意的是NetEm的规则是在指定网卡上生效的，所以所有从指定网卡发出的报文都会受到NetEm指定规则的影响。</p> 
<p>NetEm借助于tc的qdisc框架，配置到网卡上，支持的命令格式如下(注意：一般来说netem要在root权限下配置)</p> 
<pre><code class="prism language-bash">   tc qdisc <span class="token punctuation">..</span>. dev DEVICE <span class="token punctuation">]</span> <span class="token function">add</span> netem OPTIONS
   OPTIONS :<span class="token operator">=</span> <span class="token punctuation">[</span> LIMIT <span class="token punctuation">]</span> <span class="token punctuation">[</span> DELAY <span class="token punctuation">]</span> <span class="token punctuation">[</span> LOSS <span class="token punctuation">]</span> <span class="token punctuation">[</span> CORRUPT <span class="token punctuation">]</span> <span class="token punctuation">[</span> DUPLICATION <span class="token punctuation">]</span> <span class="token punctuation">[</span> REORDERING <span class="token punctuation">]</span> <span class="token punctuation">[</span> RATE <span class="token punctuation">]</span> <span class="token punctuation">[</span> SLOT <span class="token punctuation">]</span>
</code></pre> 
<p>NetEm支持LIMIT, DELAY, LOSS, CORRUPT, DUPLICATION, REORDERING, RATE, SLOT这几种选项，下面会挨个详细介绍。</p> 
<h2><a id="1Delay_15"></a>1、延时—Delay</h2> 
<p>设置延时的命令如下所示：</p> 
<pre><code class="prism language-bash">   DELAY :<span class="token operator">=</span> delay TIME <span class="token punctuation">[</span> JITTER <span class="token punctuation">[</span> CORRELATION <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
          <span class="token punctuation">[</span> distribution <span class="token punctuation">{<!-- --></span> uniform <span class="token operator">|</span> normal <span class="token operator">|</span> pareto <span class="token operator">|</span>  paretonormal <span class="token punctuation">}</span> <span class="token punctuation">]</span>
</code></pre> 
<p>这里有4个参数：TIME，JITTER, CORRELATION, distribution，TIME是必选参数，而其它几个参数都是可选参数。</p> 
<ol><li>TIME：延迟的时间</li><li>JITTER：抖动，增加一个随机时间长度，让延迟时间出现在某个范围</li><li>CORRELATION：相关，下一个报文延迟时间和上一个报文的相关系数</li><li>distribution：分布，延迟的分布模式，可以选择的值有 uniform、normal、pareto 和 paretonormal</li></ol> 
<ul><li> <p>delay<br> 通过些命令，可以在指定网卡的发送方向上给发送出去的报文设置一个指定的延时，这个延时值(TIME)可以是固定的，也可以在固定值的基础上设置一个抖动(JITTER)和一个相关性(CORRELATION)(网络延时的变化应该是平滑的，则相邻的报文的延时应该是大小变化不大的，而不是突变的，100%表示前后完全相关，即无抖动的固定延时，0%表示完全不相关，则延时是完全随机的，相邻报文之间的延时没有任何相关性)。延时和抖动的单位是ms，而相关性是个百分数。</p> </li><li> <p>distribution<br> 可以通过这个参数配置延时的分布状态，不使用这个配置时，默认为Normal配置，延时的分布会符合正态分布，但因为受网络里流量类型不同的影响，延时分布可能用不同的分布状态，所以除了默认的Normal之外，NetEm同时不提供了uniform, pareto和paretonormal供用户选择。</p> </li></ul> 
<p>使用例子如下：</p> 
<h3><a id="11enp2s0_100ms_38"></a>1.1、enp2s0 网卡上增加100ms延时</h3> 
<pre><code class="prism language-bash">tc qdisc <span class="token function">add</span> dev enp2s0 root netem delay 100ms
</code></pre> 
<h3><a id="12enp2s0_100ms__20ms80ms120ms_44"></a>1.2、enp2s0 网卡上增加100ms ± 20ms的延时(80ms到120ms)</h3> 
<pre><code class="prism language-bash">tc qdisc <span class="token function">add</span> dev enp2s0 root netem delay 100ms 20ms
</code></pre> 
<h3><a id="13enp2s0_100ms__20ms80ms120ms50_50"></a>1.3、enp2s0 网卡上增加100ms ± 20ms的延时(80ms到120ms)，并且设置相关系数为50%</h3> 
<pre><code class="prism language-bash">tc qdisc <span class="token function">add</span> dev enp2s0 root netem delay 100ms 20ms <span class="token number">50</span>%
</code></pre> 
<h3><a id="14enp2s0_100ms__20ms80ms120ms_56"></a>1.4、enp2s0 网卡上增加100ms ± 20ms的延时(80ms到120ms)，报文延时分布满足正态分布</h3> 
<pre><code class="prism language-bash">tc qdisc <span class="token function">add</span> dev enp2s0 root netem delay 100ms 20ms distribution normal
</code></pre> 
<h2><a id="2loss_62"></a>2、丢包率—loss</h2> 
<p>设置丢包的命令如下所示：</p> 
<pre><code class="prism language-bash">       LOSS :<span class="token operator">=</span> loss <span class="token punctuation">{<!-- --></span> random PERCENT <span class="token punctuation">[</span> CORRELATION <span class="token punctuation">]</span>  <span class="token operator">|</span>
                      state p13 <span class="token punctuation">[</span> p31 <span class="token punctuation">[</span> p32 <span class="token punctuation">[</span> p23 <span class="token punctuation">[</span> p14<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">|</span>
                      gemodel p <span class="token punctuation">[</span> r <span class="token punctuation">[</span> <span class="token number">1</span>-h <span class="token punctuation">[</span> <span class="token number">1</span>-k <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>  <span class="token punctuation">[</span> ecn <span class="token punctuation">]</span>
</code></pre> 
<p>这里有4个参数：其中random, state, gemodel 是必选参数（3选1），而ecn参数都是可选参数。</p> 
<ul><li> <p>loss random<br> 设置本网卡发送数据报文的丢包率(用百分比来表示)，同样也支持相关性配置（这里相关性配置强烈不推荐使用，因为在使用过程中发现了一些影响测试结果的表现）。</p> </li><li> <p>loss state<br> adds packet losses according to the 4-state Markov using the transition probabilities as input parameters. The parameter p13 is mandatory and if used alone corresponds to the Bernoulli model. The optional parameters allows to extend the model to 2-state (p31), 3-state (p23 and p32) and 4-state (p14). State 1 corresponds to good reception, State 4 to independent losses, State 3 to burst losses and State 2 to good reception within a burst.</p> </li><li> <p>loss gemodel<br> adds packet losses according to the Gilbert-Elliot loss model or its special cases (Gilbert, Simple Gilbert and Bernoulli). To use the Bernoulli model, the only needed parameter is p while the others will be set to the default values r=1-p, 1-h=1 and 1-k=0. The parameters needed for the Simple Gilbert model are two (p and r), while three parameters (p, r, 1-h) are needed for the Gilbert model and four (p, r, 1-h and 1-k) are needed for the Gilbert-Elliot model. As known, p and r are the transition probabilities between the bad and the good states, 1-h is the loss probability in the bad state and 1-k is the loss probability in the good state.</p> </li></ul> 
<p>使用例子如下：</p> 
<h3><a id="21enp2s0__16__83"></a>2.1、enp2s0 网卡模拟发送的报文有 16% 的丢包率</h3> 
<pre><code class="prism language-bash">tc qdisc <span class="token function">add</span> dev eth0 root netem loss <span class="token number">16</span>%
</code></pre> 
<h3><a id="22enp2s0_loss_stateloss_gemodel_89"></a>2.2、enp2s0 网卡模拟发送的报文使用loss state/loss gemodel模型进行丢包</h3> 
<p>4-state Markov 模型 和 Gilbert-Elliot 丢包模型一般使用不多，<font color="red">待更新</font>。</p> 
<h3><a id="23enp2s0_loss_stateloss_gemodelenc_93"></a>2.3、enp2s0 网卡模拟发送的报文选用loss state/loss gemodel模型进行丢包时的enc选项</h3> 
<p>can be used optionally to mark packets instead of dropping them. A loss model has to be used for this to be enabled.<font color="red">待更新</font></p> 
<h2><a id="3corrupt_96"></a>3、损坏/错误报文—corrupt</h2> 
<p>设置损坏/错误的命令如下所示：</p> 
<pre><code class="prism language-bash">       CORRUPT :<span class="token operator">=</span> corrupt PERCENT <span class="token punctuation">[</span> CORRELATION <span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre> 
<p>这里有2个参数：其中PERCENT是必选参数，而CORRELATION参数都是可选参数。</p> 
<ul><li>corrupt PERCENT<br> 按PERCENT指定的百分比随机选定的报文中模拟随机噪声在报文随机的位置引入错误。</li><li>CORRELATION<br> 同样支持相关系数。0%表示完全不相关，是完全随机的，而100%是完全相关。</li></ul> 
<p>使用例子如下：</p> 
<h3><a id="31enp2s0__25_109"></a>3.1、enp2s0 网卡模拟发送的报文中随机选取 25%变成损坏的报文（在被随机选中做为错误报文的随机位置造成一个错误）</h3> 
<pre><code class="prism language-bash">tc qdisc <span class="token function">add</span> dev enp2s0 root netem corrupt <span class="token number">25</span>%
</code></pre> 
<h2><a id="4duplicate_116"></a>4、重复报文—duplicate</h2> 
<p>设置重复报文的命令如下所示：</p> 
<pre><code class="prism language-bash">       DUPLICATION :<span class="token operator">=</span> duplicate PERCENT <span class="token punctuation">[</span> CORRELATION <span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre> 
<p>这里有2个参数：其中PERCENT是必选参数，而CORRELATION参数都是可选参数。</p> 
<ul><li>duplicate PERCENT<br> 按PERCENT指定的百分比随机选定的报文相应的产生一组重复报文</li><li>CORRELATION<br> 同样支持相关系数。0%表示完全不相关，是完全随机的，而100%是完全相关。</li></ul> 
<p>使用例子如下：</p> 
<h3><a id="41enp2s0__25_130"></a>4.1、enp2s0 网卡模拟发送的报文中随机选取 25%产生重复报文</h3> 
<pre><code class="prism language-bash">tc  qdisc  <span class="token function">add</span>  dev  eth0  enp2s0  netem  duplicate <span class="token number">25</span>%
</code></pre> 
<h2><a id="5reorder_136"></a>5、乱序—reorder</h2> 
<p>设置重复报文的命令如下所示：</p> 
<pre><code class="prism language-bash">       REORDERING :<span class="token operator">=</span> reorder PERCENT <span class="token punctuation">[</span> CORRELATION <span class="token punctuation">]</span> <span class="token punctuation">[</span> gap DISTANCE <span class="token punctuation">]</span>
</code></pre> 
<p>这里有2个参数：其中PERCENT是必选参数，而CORRELATION和 gap DISTANCE参数都是可选参数。</p> 
<ul><li> <p>duplicate PERCENT<br> 按PERCENT指定的百分比随机选定的报文相应的产生乱序</p> </li><li> <p>CORRELATION<br> 同样支持相关系数。0%表示完全不相关，是完全随机的，而100%是完全相关。</p> <pre><code> 要使用乱序，则必须要同时配置一个延时(这个很好理解，本该在前面的报文延时了，后面的报文先发，才会产生乱序)。通常有以下二种方式来配置乱序(以延时10ms做为前提).
</code></pre> </li><li> <p>reorder 90% gap 5<br> 在这里，最开始4个报文(4= gap - 1)延时10ms, 接下去的下一个报文(第5个报文)以90%的可能性(就是说第5个报文有90%的可能性会被立刻发送)会被立刻发送(第5个报文有10%的可能性会被延时10ms发送)，同样也支持相关系数。在产生了一个乱序的包后(上面第5个报文如果被立刻发送了，那么因为只有第5个包没有被延时，那第它就是一个乱序的包) ，立刻重复上述流程(将再接下去的4个报文延时10ms, 再接下去的第5个报文有90%的可能性立刻发送，就有90%的可能性产生一个乱序包)。注意：如果你需要 100%的每5个包，产生一个乱序包，则可以将可能性设置成100%。</p> </li><li> <p>reorder 25%<br> 25%的包被立刻发送，其它75%的包被延时10ms以产生乱序。</p> </li></ul> 
<p>使用例子如下：</p> 
<h3><a id="51enp2s0_5_161"></a>5.1、enp2s0 网卡模拟发送的报文中每5个报文就产生一个乱序包</h3> 
<p>这里100%可以设置成0-100%，那么系统将以指定的概率来生产一个乱序包，如果不到100%则生产乱序的规则见上面说明，只有100%的情况 下，才是稳定的每5个包，产生一个乱序。gap值也可以按需要进行修改。</p> 
<pre><code class="prism language-bash">root@xxx-pc:/home/xxx<span class="token comment"># tc qdisc add dev enp2s0 root netem delay 20ms reorder 100% gap 5</span>
</code></pre> 
<h3><a id="52enp2s0_50_167"></a>5.2、enp2s0 网卡模拟发送的报文中以50%的概率完全随机产生乱序包</h3> 
<p>在不设置相关系数和gap的情况下，系统会以指定的概论完全随机的产生乱序包</p> 
<pre><code class="prism language-bash">root@xxx-pc:/home/xxx<span class="token comment"># tc qdisc add dev enp2s0 root netem delay 20ms reorder 50% </span>
</code></pre> 
<h2><a id="6TBFlimit_174"></a>6、基于报文数量(令牌桶TBF)的限速—limit</h2> 
<p><font color="red">待更新</font></p> 
<h2><a id="7rate_176"></a>7、基于报文长度的限速—rate</h2> 
<p><font color="red">待更新</font></p> 
<h2><a id="8slot_178"></a>8、基于时间窗的延时与限速—slot</h2> 
<p><font color="red">待更新</font></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5cb73ecb2bd8b7fb5e0e179b7dd30093/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">使用kubesphere搭建k8s集群</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2effc5c6934e3495123ff0e37668b860/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Vue3解决懒加载</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>