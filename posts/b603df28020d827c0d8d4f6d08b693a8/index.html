<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>mybatis插件开发之 分页插件pagehelper调用原理 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="mybatis插件开发之 分页插件pagehelper调用原理" />
<meta property="og:description" content="/** * Mybatis - 通用分页拦截器&lt;br/&gt; * 项目地址 : http://git.oschina.net/free/Mybatis_PageHelper * * @author liuzh/abel533/isea533 * @version 5.0.0 */ //springboot集成pagehelper项目中的简单分页查询如下： @Override public PageInfo&lt;SysUser&gt; pageUsers(Integer pageNum, Integer pageSize) { PageHelper.startPage(pageNum,pageSize); List&lt;SysUser&gt; list = userMapper.selectAll(); PageInfo pageInfo = new PageInfo(list); return pageInfo; } 一、 PageHelper.startPage(pageNum,pageSize);
这一步是为了提前设置分页参数 ，调用PageHelper的父类PageMethod.startPage （）-&gt;PageMethod.setLocalPage()设置Page参数 到
protected static final ThreadLocal&lt;Page&gt; LOCAL_PAGE = new ThreadLocal&lt;Page&gt;(); 变量中
二、 List&lt;SysUser&gt; list = userMapper.selectAll();
这步会触发分页拦截器PageInterceptor ，执行
public Object intercept(Invocation invocation) throws Throwable { try { Object[] args = invocation." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/b603df28020d827c0d8d4f6d08b693a8/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-10-13T12:59:31+08:00" />
<meta property="article:modified_time" content="2019-10-13T12:59:31+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">mybatis插件开发之 分页插件pagehelper调用原理</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <pre><code class="language-html hljs">/**
 * Mybatis - 通用分页拦截器&lt;br/&gt;
 * 项目地址 : http://git.oschina.net/free/Mybatis_PageHelper
 *
 * @author liuzh/abel533/isea533
 * @version 5.0.0
 */</code></pre> 
<pre><code class="language-html hljs">//springboot集成pagehelper项目中的简单分页查询如下：
@Override
public PageInfo&lt;SysUser&gt; pageUsers(Integer pageNum, Integer pageSize) {

   PageHelper.startPage(pageNum,pageSize);
   List&lt;SysUser&gt; list = userMapper.selectAll();
   PageInfo pageInfo = new PageInfo(list);
   return pageInfo;

}</code></pre> 
<p><strong>一、 PageHelper.startPage(pageNum,pageSize);</strong></p> 
<p><strong>  </strong>  这一步是为了提前设置分页参数  ，调用PageHelper的父类PageMethod.startPage （）-&gt;PageMethod.setLocalPage()设置Page参数 到</p> 
<pre><code class="language-html hljs">protected static final ThreadLocal&lt;Page&gt; LOCAL_PAGE = new ThreadLocal&lt;Page&gt;();</code></pre> 
<p>变量中</p> 
<p><strong>二、 List&lt;SysUser&gt; list = userMapper.selectAll();</strong></p> 
<p><strong>这步会触发分页拦截器PageInterceptor   ，执行</strong></p> 
<pre><code class="language-html hljs">public Object intercept(Invocation invocation) throws Throwable {<!-- --></code></pre> 
<pre><code class="language-html hljs">try {
    Object[] args = invocation.getArgs();
    MappedStatement ms = (MappedStatement) args[0];
    Object parameter = args[1];
    RowBounds rowBounds = (RowBounds) args[2];
    ResultHandler resultHandler = (ResultHandler) args[3];
    Executor executor = (Executor) invocation.getTarget();
    CacheKey cacheKey;
    BoundSql boundSql;
    //由于逻辑关系，只会进入一次
    if (args.length == 4) {
        //4 个参数时
        boundSql = ms.getBoundSql(parameter);
        cacheKey = executor.createCacheKey(ms, parameter, rowBounds, boundSql);
    } else {
        //6 个参数时
        cacheKey = (CacheKey) args[4];
        boundSql = (BoundSql) args[5];
    }
    checkDialectExists();

    List resultList;
    //调用方法判断是否需要进行分页，如果不需要，直接返回结果
    if (!dialect.skip(ms, parameter, rowBounds)) {
        //判断是否需要进行 count 查询
        if (dialect.beforeCount(ms, parameter, rowBounds)) {
            //查询总数
            Long count = count(executor, ms, parameter, rowBounds, resultHandler, boundSql);
            //处理查询总数，返回 true 时继续分页查询，false 时直接返回
            if (!dialect.afterCount(count, parameter, rowBounds)) {
                //当查询总数为 0 时，直接返回空的结果
                return dialect.afterPage(new ArrayList(), parameter, rowBounds);
            }
        }
        resultList = ExecutorUtil.pageQuery(dialect, executor,
                ms, parameter, rowBounds, resultHandler, boundSql, cacheKey);
    } else {
        //rowBounds用参数值，不使用分页插件处理时，仍然支持默认的内存分页
        resultList = executor.query(ms, parameter, rowBounds, resultHandler, cacheKey, boundSql);
    }
    return dialect.afterPage(resultList, parameter, rowBounds);
} finally {
    if(dialect != null){
        dialect.afterAll();
    }
}</code></pre> 
<p>}方法，<strong>返回的其实是一个Page类</strong></p> 
<p><strong>定义如下：继承了ArrayList</strong></p> 
<p> </p> 
<pre><code class="language-html hljs">public class Page&lt;E&gt; extends ArrayList&lt;E&gt; implements Closeable {
    private static final long serialVersionUID = 1L;

    /**
     * 页码，从1开始
     */
    private int pageNum;
    /**
     * 页面大小
     */
    private int pageSize;
    /**
     * 起始行
     */
    private int startRow;
    /**
     * 末行
     */
    private int endRow;
    /**
     * 总数
     */
    private long total;
    /**
     * 总页数
     */
    private int pages;
    /**
     * 包含count查询
     */
    private boolean count = true;
    /**
     * 分页合理化
     */
    private Boolean reasonable;
    /**
     * 当设置为true的时候，如果pagesize设置为0（或RowBounds的limit=0），就不执行分页，返回全部结果
     */
    private Boolean pageSizeZero;
    /**
     * 进行count查询的列名
     */
    private String countColumn;
    /**
     * 排序
     */
    private String orderBy;
    /**
     * 只增加排序
     */
    private boolean orderByOnly;</code></pre> 
<p><strong>3、 PageInfo pageInfo = new PageInfo(list);</strong></p> 
<pre><code class="language-html hljs">判断是否是Page,设置总数total</code></pre> 
<pre><code class="language-html hljs">/**
 * 包装Page对象
 *
 * @param list
 */
public PageInfo(List&lt;T&gt; list) {
    this(list, 8);
}

/**
 * 包装Page对象
 *
 * @param list          page结果
 * @param navigatePages 页码数量
 */
public PageInfo(List&lt;T&gt; list, int navigatePages) {
    super(list);
    if (list instanceof Page) {
        Page page = (Page) list;
        this.pageNum = page.getPageNum();
        this.pageSize = page.getPageSize();

        this.pages = page.getPages();
        this.size = page.size();
        //由于结果是&gt;startRow的，所以实际的需要+1
        if (this.size == 0) {
            this.startRow = 0;
            this.endRow = 0;
        } else {
            this.startRow = page.getStartRow() + 1;
            //计算实际的endRow（最后一页的时候特殊）
            this.endRow = this.startRow - 1 + this.size;
        }
    } else if (list instanceof Collection) {
        this.pageNum = 1;
        this.pageSize = list.size();

        this.pages = this.pageSize &gt; 0 ? 1 : 0;
        this.size = list.size();
        this.startRow = 0;
        this.endRow = list.size() &gt; 0 ? list.size() - 1 : 0;
    }
    if (list instanceof Collection) {
        this.navigatePages = navigatePages;
        //计算导航页
        calcNavigatepageNums();
        //计算前后页，第一页，最后一页
        calcPage();
        //判断页面边界
        judgePageBoudary();
    }
}</code></pre> 
<p> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d436a44097385e7fabe42d87e2682439/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">王道数据结构2.3.7——23、删除单链表中绝对值相等的元素，只保留第一个元素</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/31f35e1b6fec12348debff62a63700d4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Platinum Maestro运动控制器 —— PVT模式笔记</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>