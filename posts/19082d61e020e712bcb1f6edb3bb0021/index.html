<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Druid03-守护线程 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Druid03-守护线程" />
<meta property="og:description" content="1、CreateConnectionThread 线程 1.1 线程创建 ​ Druid连接池运行后，该线程大部分情况下都处于WAITING状态，通过 jstack -l PID 查看。
protected void createAndStartCreatorThread() { if (createScheduler == null) { String threadName = &#34;Druid-ConnectionPool-Create-&#34; &#43; System.identityHashCode(this); //创建线程并启动 createConnectionThread = new CreateConnectionThread(threadName); createConnectionThread.start(); return; } initedLatch.countDown(); } 1.2 执行过程 public void run() { //利用循环，获取连接 for (;;) { try { //获取锁，可响应中断 lock.lockInterruptibly(); } catch (InterruptedException e2) { break; } try { boolean emptyWait = true; ... //判断是否能够创建连接，否则通过Condition条件锁将线程挂起 if (emptyWait) { // 必须存在线程等待，才创建连接 if (poolingCount &gt;= notEmptyWaitThreadCount //等待的连接数大于线程池连接数，才创建 &amp;&amp; (!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/19082d61e020e712bcb1f6edb3bb0021/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-14T18:57:48+08:00" />
<meta property="article:modified_time" content="2022-09-14T18:57:48+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Druid03-守护线程</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h6><a id="1CreateConnectionThread__0"></a>1、CreateConnectionThread 线程</h6> 
<h6><a id="11__2"></a>1.1 线程创建</h6> 
<p>​ Druid连接池运行后，该线程大部分情况下都处于WAITING状态，通过 jstack -l PID 查看。</p> 
<pre><code class="prism language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">createAndStartCreatorThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>createScheduler <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> threadName <span class="token operator">=</span> <span class="token string">"Druid-ConnectionPool-Create-"</span> <span class="token operator">+</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//创建线程并启动</span>
        createConnectionThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CreateConnectionThread</span><span class="token punctuation">(</span>threadName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        createConnectionThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    initedLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="12__19"></a>1.2 执行过程</h6> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">//利用循环，获取连接</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            	<span class="token comment">//获取锁，可响应中断</span>
                lock<span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">boolean</span> emptyWait <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token comment">//判断是否能够创建连接，否则通过Condition条件锁将线程挂起</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>emptyWait<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 必须存在线程等待，才创建连接</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>poolingCount <span class="token operator">&gt;=</span> notEmptyWaitThreadCount <span class="token comment">//等待的连接数大于线程池连接数，才创建</span>
                            <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>keepAlive <span class="token operator">&amp;&amp;</span> activeCount <span class="token operator">+</span> poolingCount <span class="token operator">&lt;</span> minIdle<span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isFailContinuous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        empty<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// 活动线程数+可用线程数小于maxActive，才创建</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>activeCount <span class="token operator">+</span> poolingCount <span class="token operator">&gt;=</span> maxActive<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        empty<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
			
            <span class="token class-name">PhysicalConnectionInfo</span> connection <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//创建物理连接</span>
                connection <span class="token operator">=</span> <span class="token function">createPhysicalConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//重试和故障转移</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"create connection RuntimeException"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">setFailContinuous</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Error</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"create connection Error"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">setFailContinuous</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>connection <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
			<span class="token comment">//将物理连接PUT到连接池，通知消费线程来获取</span>
            <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token function">put</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//PUT失败将连接关闭</span>
                <span class="token class-name">JdbcUtils</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">getPhysicalConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"put physical connection to pool failed."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            errorCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// reset errorCount</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>closing <span class="token operator">||</span> closed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>​ DruidAbstractDataSource 创建时创建了两个条件锁。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">DruidAbstractDataSource</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> lockFair<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span>lockFair<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//当连接数不够时将线程阻塞</span>
    notEmpty <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//需要创建新连接时被唤醒线程，否则将线程阻塞</span>
    empty <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>​ 初始化完成后 CreateConnectionThread线程在empty条件锁阻塞住，当连接池中的连接不够时会唤醒该线程，同时通过notEmpty.await() 阻塞用户线程，通过连接的回收或创建新的连接被唤醒这也是一个生产者和消费者模式，可以将CreateConnectionThread 作为生产者的线程。</p> 
<h6><a id="2DestroyConnectionThread_106"></a>2、DestroyConnectionThread线程</h6> 
<p>​ 线程池中的销毁线程，将connections 连接池中的连接经过各类条件判断进行分类，最后分别对keepAliveConnections和evictConnections遍历处理，检测可用继续放回connections中，检测不可用丢弃。</p> 
<pre><code class="prism language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">createAndStartDestroyThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    destroyTask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DestroyTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment">//可配置定时任务的线程池或创建线程的方式</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>destroyScheduler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">long</span> period <span class="token operator">=</span> timeBetweenEvictionRunsMillis<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>period <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            period <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        destroySchedulerFuture <span class="token operator">=</span> destroyScheduler<span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span>destroyTask<span class="token punctuation">,</span> period<span class="token punctuation">,</span> period<span class="token punctuation">,</span>
                                                                      <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        initedLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">String</span> threadName <span class="token operator">=</span> <span class="token string">"Druid-ConnectionPool-Destroy-"</span> <span class="token operator">+</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    destroyConnectionThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DestroyConnectionThread</span><span class="token punctuation">(</span>threadName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    destroyConnectionThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="21__130"></a>2.1 执行过程</h6> 
<p>​ DestroyConnectionThread 线程通过配置timeBetweenEvictionRunsMillis 间隔执行默认60秒一次，通过DestroyTask.run方法执行。</p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DestroyTask</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{<!-- --></span>
  
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//连接池检测</span>
            <span class="token function">shrink</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> keepAlive<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//配置removeAbandoned=true</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRemoveAbandoned</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//判断连接池内的连接最新GET时间，超时removeAbandonedTimeoutMillis则close连接池</span>
                <span class="token comment">//每次getConnection更新connectedTimeNano时间</span>
                <span class="token function">removeAbandoned</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h6><a id="22_shrink_151"></a>2.2 shrink过程</h6> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shrink</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> checkTime<span class="token punctuation">,</span> <span class="token keyword">boolean</span> keepAlive<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//获取锁</span>
            lock<span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inited<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//大于minIdle的连接数=池中连接数-最小空闲连接数</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> checkCount <span class="token operator">=</span> poolingCount <span class="token operator">-</span> minIdle<span class="token punctuation">;</span>
            <span class="token comment">//遍历数组中的连接对象</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> poolingCount<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//对线程池的连接对象进行循环判断</span>
                <span class="token class-name">DruidConnectionHolder</span> connection <span class="token operator">=</span> connections<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
				<span class="token comment">//如果发生了报错则连接池则放入活性检测连接池</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>onFatalError <span class="token operator">||</span> fatalErrorIncrement <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>lastFatalErrorTimeMillis <span class="token operator">&gt;</span> connection<span class="token punctuation">.</span>connectTimeMillis<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">{<!-- --></span>
                    keepAliveConnections<span class="token punctuation">[</span>keepAliveCount<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> connection<span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>checkTime<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//如果配置连接过期时间(默认-1)</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>phyTimeoutMillis <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">long</span> phyConnectTimeMillis <span class="token operator">=</span> currentTimeMillis <span class="token operator">-</span> connection<span class="token punctuation">.</span>connectTimeMillis<span class="token punctuation">;</span>
                        <span class="token comment">//如果超过了连接时间则需要进行抛弃</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>phyConnectTimeMillis <span class="token operator">&gt;</span> phyTimeoutMillis<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            evictConnections<span class="token punctuation">[</span>evictCount<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> connection<span class="token punctuation">;</span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">long</span> idleMillis <span class="token operator">=</span> currentTimeMillis <span class="token operator">-</span> connection<span class="token punctuation">.</span>lastActiveTimeMillis<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>idleMillis <span class="token operator">&lt;</span> minEvictableIdleTimeMillis
                            <span class="token operator">&amp;&amp;</span> idleMillis <span class="token operator">&lt;</span> keepAliveBetweenTimeMillis
                    <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
					<span class="token comment">//连接空闲时间大于 minEvictableIdleTimeMillis 则判断是否关闭连接</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>idleMillis <span class="token operator">&gt;=</span> minEvictableIdleTimeMillis<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    	<span class="token comment">//连接数大于 minIdle 加入关闭连接数组</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>checkTime <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> checkCount<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            evictConnections<span class="token punctuation">[</span>evictCount<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> connection<span class="token punctuation">;</span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span>
                       <span class="token comment">//连接数不大于 minIdle 大于最大空闲时间，加入关闭连接数组</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>idleMillis <span class="token operator">&gt;</span> maxEvictableIdleTimeMillis<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            evictConnections<span class="token punctuation">[</span>evictCount<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> connection<span class="token punctuation">;</span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
					<span class="token comment">//如果配置了keepAlive并接空闲时间超过keepAliveBetweenTimeMillis则放入活性检测连接池</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>keepAlive <span class="token operator">&amp;&amp;</span> idleMillis <span class="token operator">&gt;=</span> keepAliveBetweenTimeMillis<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        keepAliveConnections<span class="token punctuation">[</span>keepAliveCount<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> connection<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> checkCount<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        evictConnections<span class="token punctuation">[</span>evictCount<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> connection<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//需要从可用连接池删除个数，将先添加到连接池的进行删除</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>removeCount <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//从线程池复制开始位置=removeCount，复制到connections从start=0,length=(poolingCount-removeCount）</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>connections<span class="token punctuation">,</span> removeCount<span class="token punctuation">,</span> connections<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> poolingCount <span class="token operator">-</span> removeCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//connections从start(poolingCount - removeCount)到poolingCount设置为空</span>
                <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span>connections<span class="token punctuation">,</span> poolingCount <span class="token operator">-</span> removeCount<span class="token punctuation">,</span> poolingCount<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//连接池可用数量减删除数量</span>
                poolingCount <span class="token operator">-=</span> removeCount<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token comment">//将抛弃连接池的连接进行关闭</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>evictCount <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> evictCount<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">DruidConnectionHolder</span> item <span class="token operator">=</span> evictConnections<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token class-name">Connection</span> connection <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">JdbcUtils</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
                destroyCountUpdater<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span>evictConnections<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    	<span class="token comment">//需要检测可用性的连接&gt;0</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>keepAliveCount <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> keepAliveCount <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">DruidConnectionHolder</span> holer <span class="token operator">=</span> keepAliveConnections<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token class-name">Connection</span> connection <span class="token operator">=</span> holer<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                holer<span class="token punctuation">.</span><span class="token function">incrementKeepAliveCheckCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">boolean</span> validate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//检测连接的可用性</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">validateConnection</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    validate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>LOG<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"keepAliveErr"</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">boolean</span> discard <span class="token operator">=</span> <span class="token operator">!</span>validate<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>validate<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    holer<span class="token punctuation">.</span>lastKeepTimeMillis <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//如果连接可用则PUT到连接池</span>
                    <span class="token keyword">boolean</span> putOk <span class="token operator">=</span> <span class="token function">put</span><span class="token punctuation">(</span>holer<span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>putOk<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        discard <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>discard<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//连接不可用则进行关闭</span>
                        connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token punctuation">}</span>
                    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                        discardCount<span class="token operator">++</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>activeCount <span class="token operator">+</span> poolingCount <span class="token operator">&lt;=</span> minIdle<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">//将创建连接的线程唤醒</span>
                            <span class="token function">emptySignal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDataSourceStat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addKeepAliveCheckCount</span><span class="token punctuation">(</span>keepAliveCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span>keepAliveConnections<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>needFill<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//需要创建的连接数=最小连接数-(活动线程数+连接池可用线程数+创建连接线程数)</span>
                <span class="token keyword">int</span> fillCount <span class="token operator">=</span> minIdle <span class="token operator">-</span> <span class="token punctuation">(</span>activeCount <span class="token operator">+</span> poolingCount <span class="token operator">+</span> createTaskCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> fillCount<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//将创建连接的线程唤醒</span>
                    <span class="token function">emptySignal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>onFatalError <span class="token operator">||</span> fatalErrorIncrement <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">emptySignal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>​ 使用validateQuery查询探活连接消耗更大，JDBC提供了更轻量级的探活机制 Connection#isValid， Druid中MySQL通过MySqlValidConnectionChecker检测连接可用性，可使用ping的方式，jvm参数：-Ddruid.mysql.usePingMethod=true。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5308591029880d7634a3a95a0340db98/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">golang学习笔记（26）-go test单元测试</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f9bc755daea232d0dac8234e83d45570/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">SSD训练数据集流程（学习记录）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>