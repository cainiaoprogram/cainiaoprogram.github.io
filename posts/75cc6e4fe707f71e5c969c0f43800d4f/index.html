<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SQL 时间范围和时间粒度 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="SQL 时间范围和时间粒度" />
<meta property="og:description" content="前言 使用 SQL 进行业务数据计算时，经常会遇到两个概念：时间范围 和 时间粒度 。以 最近一天的每小时的用户访问人数 为例：
最近一天 是时间范围每小时 是时间粒度 常见的时间范围：最近五分钟、最近一小时、最近一天、最近一周、最近一月、最近一年、截止到今天、截止到本周、截止到本月、截止到今年。
常见的时间粒度：五分钟、小时、天、周、月、年。
大多数情况下，我们需要根据计算时间和时间范围，计算出业务数据的开始时间和结束时间，用于过滤业务数据；然后再根据业务数据的业务时间和时间粒度，计算出业务时间点，用于分组统计业务数据。
假设用户访问表（user_visit）记录如下：
iduidtimestamp1u12022-09-19 15:10:582u22022-09-19 16:24:193u12022-09-20 01:04:034u22022-09-20 02:12:365u12022-09-20 02:35:036u12022-09-20 03:10:27 使用 最近一天 过滤数据，开始时间：2022-09-20 00:00:00，结束时间：2022-09-21 00:00:00，SQL 伪代码：
SELECT * FROM user_visit WHERE timestamp &gt;= &#34;2022-09-20 00:00:00&#34; AND timestamp &lt; &#34;2022-09-21 00:00:00&#34; 过滤结果：
iduidtimestamp3u12022-09-20 01:04:034u22022-09-20 02:12:365u12022-09-20 02:35:036u12022-09-20 03:10:27 过滤后的业务数据，使用 小时 将业务时间转换成业务时间点，转换结果：
iduidtimestamp3u12022-09-20 01:00:004u22022-09-20 02:00:005u12022-09-20 02:00:006u12022-09-20 03:00:00 按小时分组统计用户访问人数，SQL 伪代码：
SELECT timestamp, COUNT(DISTINCT(uid)) AS uids FROM user_visit GROUP BY timestamp 统计结果：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/75cc6e4fe707f71e5c969c0f43800d4f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-20T19:05:12+08:00" />
<meta property="article:modified_time" content="2022-09-20T19:05:12+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SQL 时间范围和时间粒度</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>前言</h2> 
<p>使用 SQL 进行业务数据计算时，经常会遇到两个概念：<strong>时间范围</strong> 和 <strong>时间粒度</strong> 。以 <strong>最近一天的每小时的用户访问人数</strong> 为例：</p> 
<ul><li><strong>最近一天</strong> 是时间范围</li><li><strong>每小时</strong> 是时间粒度</li></ul> 
<p>常见的时间范围：最近五分钟、最近一小时、最近一天、最近一周、最近一月、最近一年、截止到今天、截止到本周、截止到本月、截止到今年。</p> 
<p>常见的时间粒度：五分钟、小时、天、周、月、年。</p> 
<p>大多数情况下，我们需要根据计算时间和时间范围，计算出业务数据的开始时间和结束时间，用于过滤业务数据；然后再根据业务数据的业务时间和时间粒度，计算出业务时间点，用于分组统计业务数据。</p> 
<p>假设用户访问表（user_visit）记录如下：</p> 
<table><thead><tr><th align="center">id</th><th align="center">uid</th><th align="center">timestamp</th></tr></thead><tbody><tr><td align="center">1</td><td align="center">u1</td><td align="center">2022-09-19 15:10:58</td></tr><tr><td align="center">2</td><td align="center">u2</td><td align="center">2022-09-19 16:24:19</td></tr><tr><td align="center">3</td><td align="center">u1</td><td align="center">2022-09-20 01:04:03</td></tr><tr><td align="center">4</td><td align="center">u2</td><td align="center">2022-09-20 02:12:36</td></tr><tr><td align="center">5</td><td align="center">u1</td><td align="center">2022-09-20 02:35:03</td></tr><tr><td align="center">6</td><td align="center">u1</td><td align="center">2022-09-20 03:10:27</td></tr></tbody></table> 
<p>使用 <strong>最近一天</strong> 过滤数据，开始时间：2022-09-20 00:00:00，结束时间：2022-09-21 00:00:00，SQL 伪代码：</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span>
	<span class="token operator">*</span>
<span class="token keyword">FROM</span>
	user_visit
<span class="token keyword">WHERE</span>
	<span class="token keyword">timestamp</span> <span class="token operator">&gt;=</span> <span class="token string">"2022-09-20 00:00:00"</span>
	<span class="token operator">AND</span> <span class="token keyword">timestamp</span> <span class="token operator">&lt;</span> <span class="token string">"2022-09-21 00:00:00"</span>
</code></pre> 
<p>过滤结果：</p> 
<table><thead><tr><th align="center">id</th><th align="center">uid</th><th align="center">timestamp</th></tr></thead><tbody><tr><td align="center">3</td><td align="center">u1</td><td align="center">2022-09-20 01:04:03</td></tr><tr><td align="center">4</td><td align="center">u2</td><td align="center">2022-09-20 02:12:36</td></tr><tr><td align="center">5</td><td align="center">u1</td><td align="center">2022-09-20 02:35:03</td></tr><tr><td align="center">6</td><td align="center">u1</td><td align="center">2022-09-20 03:10:27</td></tr></tbody></table> 
<p>过滤后的业务数据，使用 <strong>小时</strong> 将业务时间转换成业务时间点，转换结果：</p> 
<table><thead><tr><th align="center">id</th><th align="center">uid</th><th align="center">timestamp</th></tr></thead><tbody><tr><td align="center">3</td><td align="center">u1</td><td align="center">2022-09-20 01:00:00</td></tr><tr><td align="center">4</td><td align="center">u2</td><td align="center">2022-09-20 02:00:00</td></tr><tr><td align="center">5</td><td align="center">u1</td><td align="center">2022-09-20 02:00:00</td></tr><tr><td align="center">6</td><td align="center">u1</td><td align="center">2022-09-20 03:00:00</td></tr></tbody></table> 
<p>按小时分组统计用户访问人数，SQL 伪代码：</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span>
	<span class="token keyword">timestamp</span><span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> uids
<span class="token keyword">FROM</span>
	user_visit
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span>
	<span class="token keyword">timestamp</span>
</code></pre> 
<p>统计结果：</p> 
<table><thead><tr><th align="center">timestamp</th><th align="center">uids</th></tr></thead><tbody><tr><td align="center">2022-09-20 01:00:00</td><td align="center">1</td></tr><tr><td align="center">2022-09-20 02:00:00</td><td align="center">2</td></tr><tr><td align="center">2022-09-20 03:00:00</td><td align="center">1</td></tr></tbody></table> 
<p>整个过程涉及两个关键的时间计算：</p> 
<ul><li>根据计算时间和时间范围，计算业务数据开始时间和结束时间</li><li>根据业务时间和时间粒度，计算业务时间点</li></ul> 
<p>这两个时间的计算均需要通过 SQL 的 <strong>日期时间函数</strong> 实现。然而不同的数据库对于日期时间函数的支持程度差异很大，实际的计算过程可能比较繁琐。</p> 
<p>本文以阿里云 ODPS 和 RDS 为例，详细说明日期时间函数关于时间范围和时间粒度的计算方法。</p> 
<blockquote> 
 <p>时间范围的开始时间是闭区间，结束时间是开区间。</p> 
</blockquote> 
<h2><a id="_85"></a>时间类型</h2> 
<p>阿里云的 ODPS 和 RDS 都是支持日期时间（DATETIME）类型的，业务数据可以直接使用 DATETIME 存储业务时间；也可以使用其它数据类型存储业务时间，常见的有日期时间字符串（STRING）和 Unix 时间戳（INT）。</p> 
<p>我们建议将业务时间统一转换成 DATETIME 类型之后再进行时间计算。</p> 
<h3><a id="_91"></a>日期时间字符串</h3> 
<p>以字符串 2022-09-20 15:10:58 例，将其转换成 DATETIME。</p> 
<p><strong>ODPS</strong></p> 
<pre><code class="prism language-sql">TO_DATE<span class="token punctuation">(</span><span class="token string">'2022-09-20 15:10:58'</span><span class="token punctuation">,</span> <span class="token string">'yyyy-mm-dd hh:mi:ss'</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>RDS</strong></p> 
<pre><code class="prism language-sql">STR_TO_DATE<span class="token punctuation">(</span><span class="token string">'2022-09-20 15:10:58'</span><span class="token punctuation">,</span> <span class="token string">'%Y-%m-%d %H:%i:%s'</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="Unix__107"></a>Unix 时间戳</h3> 
<p>以时间戳 1663657859 为例，将其转换成 DATETIME。</p> 
<p><strong>ODPS</strong></p> 
<pre><code class="prism language-sql">FROM_UNIXTIME<span class="token punctuation">(</span><span class="token number">1663657859</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>RDS</strong></p> 
<pre><code class="prism language-sql">FROM_UNIXTIME<span class="token punctuation">(</span><span class="token number">1663657859</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="_124"></a>时间范围</h2> 
<p>我们使用 当前时间 指代 计算时间，获取当前时间（DATETIME）：</p> 
<p><strong>ODPS</strong></p> 
<pre><code class="prism language-sql">GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>RDS</strong></p> 
<pre><code class="prism language-sql"><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_141"></a>最近五分钟</h3> 
<p>以计算时间：2022-09-20 17:07:33 为例，最近五分钟的业务开始时间应为：2022-09-20 17:00:00，业务结束时间应为：2022-09-20 17:05:00。</p> 
<p><strong>ODPS</strong></p> 
<pre><code class="prism language-sql"><span class="token comment">// 开始时间</span>
FROM_UNIXTIME<span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span>UNIX_TIMESTAMP<span class="token punctuation">(</span>GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">300</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">300</span><span class="token punctuation">)</span>

<span class="token comment">// 结束时间</span>
FROM_UNIXTIME<span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span>UNIX_TIMESTAMP<span class="token punctuation">(</span>GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">300</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>RDS</strong></p> 
<pre><code class="prism language-sql"><span class="token comment">// 开始时间</span>
FROM_UNIXTIME<span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span>UNIX_TIMESTAMP<span class="token punctuation">(</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">300</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">300</span><span class="token punctuation">)</span>

<span class="token comment">// 结束时间</span>
FROM_UNIXTIME<span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span>UNIX_TIMESTAMP<span class="token punctuation">(</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">300</span><span class="token punctuation">)</span>
</code></pre> 
<blockquote> 
 <p>300 表示 5 分钟，即：300 秒。</p> 
</blockquote> 
<h3><a id="_167"></a>最近一小时</h3> 
<p>以计算时间 2022-09-20 17:19:57 为例，最近一小时的业务开始时间应为 2022-09-20 16:00:00，业务结束时间应为 2022-09-20 17:00:00。</p> 
<p><strong>ODPS</strong></p> 
<pre><code class="prism language-sql"><span class="token comment">// 开始时间</span>
DATETRUNC<span class="token punctuation">(</span>DATEADD<span class="token punctuation">(</span>GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'hh'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'hh'</span><span class="token punctuation">)</span>

<span class="token comment">// 结束时间</span>
DATETRUNC<span class="token punctuation">(</span>GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'hh'</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>RDS</strong></p> 
<pre><code class="prism language-sql"><span class="token comment">// 开始时间</span>
DATE_FORMAT<span class="token punctuation">(</span>DATE_ADD<span class="token punctuation">(</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token keyword">HOUR</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'%Y-%m-%d %H:00:00'</span><span class="token punctuation">)</span>

<span class="token comment">// 结束时间</span>
DATE_FORMAT<span class="token punctuation">(</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'%Y-%m-%d %H:00:00'</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_191"></a>最近一天</h3> 
<p>以计算时间 2022-09-20 17:31:06 为例，最近一天的业务开始时间应为 2022-09-19 00:00:00，业务结束时间应为 2022-09-20 00:00:00。</p> 
<p><strong>ODPS</strong></p> 
<pre><code class="prism language-sql"><span class="token comment">// 开始时间</span>
DATETRUNC<span class="token punctuation">(</span>DATEADD<span class="token punctuation">(</span>GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'dd'</span><span class="token punctuation">)</span>

<span class="token comment">// 结束时间</span>
DATETRUNC<span class="token punctuation">(</span>GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'dd'</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>RDS</strong></p> 
<pre><code class="prism language-sql"><span class="token comment">// 开始时间</span>
DATE_FORMAT<span class="token punctuation">(</span>DATE_ADD<span class="token punctuation">(</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token keyword">DAY</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'%Y-%m-%d 00:00:00'</span><span class="token punctuation">)</span>

<span class="token comment">// 结束时间</span>
DATE_FORMAT<span class="token punctuation">(</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'%Y-%m-%d 00:00:00'</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_216"></a>最近一周</h3> 
<p>以计算时间 2022-09-20 17:48:10 为例，最近一周的业务开始时间应为 2022-09-12 00:00:00，业务结束时间应为 2022-09-19 00:00:00。</p> 
<p><strong>ODPS</strong></p> 
<pre><code class="prism language-sql"><span class="token comment">// 开始时间</span>
DATETRUNC<span class="token punctuation">(</span>DATEADD<span class="token punctuation">(</span>GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span> WEEKDAY<span class="token punctuation">(</span>GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">7</span> <span class="token punctuation">,</span> <span class="token string">'dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'dd'</span><span class="token punctuation">)</span>

<span class="token comment">// 结束时间</span>
DATETRUNC<span class="token punctuation">(</span>DATEADD<span class="token punctuation">(</span>GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span> WEEKDAY<span class="token punctuation">(</span>GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'dd'</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>RDS</strong></p> 
<pre><code class="prism language-sql"><span class="token comment">// 开始时间</span>
DATE_FORMAT<span class="token punctuation">(</span>ADDDATE<span class="token punctuation">(</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span> <span class="token number">7</span> <span class="token operator">-</span> WEEKDAY<span class="token punctuation">(</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'%Y-%m-%d 00:00:00'</span><span class="token punctuation">)</span>

<span class="token comment">// 结束时间</span>
DATE_FORMAT<span class="token punctuation">(</span>ADDDATE<span class="token punctuation">(</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span> WEEKDAY<span class="token punctuation">(</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'%Y-%m-%d 00:00:00'</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_240"></a>最近一月</h3> 
<p>以计算时间 2022-09-20 17:57:05 为例，最近一月的业务开始时间应为 2022-08-01 00:00:00，业务结束时间应为 2022-09-01 00:00:00。</p> 
<p><strong>ODPS</strong></p> 
<pre><code class="prism language-sql"><span class="token comment">// 开始时间</span>
DATETRUNC<span class="token punctuation">(</span>DATEADD<span class="token punctuation">(</span>GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'mm'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'mm'</span><span class="token punctuation">)</span>

<span class="token comment">// 结束时间</span>
DATETRUNC<span class="token punctuation">(</span>GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'mm'</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>RDS</strong></p> 
<pre><code class="prism language-sql"><span class="token comment">// 开始时间</span>
DATE_FORMAT<span class="token punctuation">(</span>DATE_ADD<span class="token punctuation">(</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token keyword">MONTH</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'%Y-%m-01 00:00:00'</span><span class="token punctuation">)</span>

<span class="token comment">// 结束时间</span>
DATE_FORMAT<span class="token punctuation">(</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'%Y-%m-01 00:00:00'</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_264"></a>最近一年</h3> 
<p>以计算时间 2022-09-20 18:03:00 为例，最近一年的业务开始时间应为 2021-01-01 00:00:00，业务结束时间应为 2022-01-01 00:00:00。</p> 
<p><strong>ODPS</strong></p> 
<pre><code class="prism language-sql"><span class="token comment">// 开始时间</span>
DATETRUNC<span class="token punctuation">(</span>DATEADD<span class="token punctuation">(</span>GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'yyyy'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'yyyy'</span><span class="token punctuation">)</span>

<span class="token comment">// 结束时间</span>
DATETRUNC<span class="token punctuation">(</span>GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'yyyy'</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>RDS</strong></p> 
<pre><code class="prism language-sql"><span class="token comment">// 开始时间</span>
DATE_FORMAT<span class="token punctuation">(</span>DATE_ADD<span class="token punctuation">(</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token keyword">YEAR</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'%Y-01-01 00:00:00'</span><span class="token punctuation">)</span>

<span class="token comment">// 结束时间</span>
DATE_FORMAT<span class="token punctuation">(</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'%Y-01-01 00:00:00'</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_288"></a>截止到今天</h3> 
<p>以计算时间 2022-09-20 18:12:31 为例，截止到今天的业务开始时间应为 2022-09-20 00:00:00，业务结束时间应为 2022-09-21 00:00:00。</p> 
<p><strong>ODPS</strong></p> 
<pre><code class="prism language-sql"><span class="token comment">// 开始时间</span>
DATETRUNC<span class="token punctuation">(</span>GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'dd'</span><span class="token punctuation">)</span>

<span class="token comment">// 结束时间</span>
DATETRUNC<span class="token punctuation">(</span>DATEADD<span class="token punctuation">(</span>GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'dd'</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>RDS</strong></p> 
<pre><code class="prism language-sql"><span class="token comment">// 开始时间</span>
DATE_FORMAT<span class="token punctuation">(</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'%Y-%m-%d 00:00:00'</span><span class="token punctuation">)</span>

<span class="token comment">// 结束时间</span>
DATE_FORMAT<span class="token punctuation">(</span>ADDDATE<span class="token punctuation">(</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'%Y-%m-%d 00:00:00'</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_312"></a>截止到本周</h3> 
<p>以计算时间 2022-09-20 18:16:20 为例，截止到本周的业务开始时间应为 2022-09-19 00:00:00，业务结束时间应为 2022-09-26 00:00:00。</p> 
<p><strong>ODPS</strong></p> 
<pre><code class="prism language-sql"><span class="token comment">// 开始时间</span>
DATETRUNC<span class="token punctuation">(</span>DATEADD<span class="token punctuation">(</span>GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span> WEEKDAY<span class="token punctuation">(</span>GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'dd'</span><span class="token punctuation">)</span>

<span class="token comment">// 结束时间</span>
DATETRUNC<span class="token punctuation">(</span>DATEADD<span class="token punctuation">(</span>GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">7</span> <span class="token operator">-</span> WEEKDAY<span class="token punctuation">(</span>GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'dd'</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>RDS</strong></p> 
<pre><code class="prism language-sql"><span class="token comment">// 开始时间</span>
DATE_FORMAT<span class="token punctuation">(</span>ADDDATE<span class="token punctuation">(</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span> WEEKDAY<span class="token punctuation">(</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'%Y-%m-%d 00:00:00'</span><span class="token punctuation">)</span>

<span class="token comment">// 结束时间</span>
DATE_FORMAT<span class="token punctuation">(</span>ADDDATE<span class="token punctuation">(</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">7</span> <span class="token operator">-</span> WEEKDAY<span class="token punctuation">(</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'%Y-%m-%d 00:00:00'</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_336"></a>截止到本月</h3> 
<p>以计算时间 2022-09-20 18:19:15 为例，截止到本月的业务开始时间为 2022-09-01 00:00:00，业务结束时间应为 2022-10-01 00:00:00。</p> 
<p><strong>ODPS</strong></p> 
<pre><code class="prism language-sql"><span class="token comment">// 开始时间</span>
DATETRUNC<span class="token punctuation">(</span>GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'mm'</span><span class="token punctuation">)</span>

<span class="token comment">// 结束时间</span>
DATETRUNC<span class="token punctuation">(</span>DATEADD<span class="token punctuation">(</span>GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'mm'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'mm'</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>RDS</strong></p> 
<pre><code class="prism language-sql"><span class="token comment">// 开始时间</span>
DATE_FORMAT<span class="token punctuation">(</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'%Y-%m-01 00:00:00'</span><span class="token punctuation">)</span>

<span class="token comment">// 结束时间</span>
DATE_FORMAT<span class="token punctuation">(</span>ADDDATE<span class="token punctuation">(</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token number">1</span> <span class="token keyword">MONTH</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'%Y-%m-01 00:00:00'</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_360"></a>截止到今年</h3> 
<p>以计算时间 2022-09-20 18:21:09 为例，截止到今年的业务开始时间为 2022-01-01 00:00:00，业务结束时间应为 2023-01-01 00:00:00。</p> 
<p><strong>ODPS</strong></p> 
<pre><code class="prism language-sql"><span class="token comment">// 开始时间</span>
DATETRUNC<span class="token punctuation">(</span>GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'yyyy'</span><span class="token punctuation">)</span>

<span class="token comment">// 结束时间</span>
DATETRUNC<span class="token punctuation">(</span>DATEADD<span class="token punctuation">(</span>GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'yyyy'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'yyyy'</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>RDS</strong></p> 
<pre><code class="prism language-sql"><span class="token comment">// 开始时间</span>
DATE_FORMAT<span class="token punctuation">(</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'%Y-01-01 00:00:00'</span><span class="token punctuation">)</span>

<span class="token comment">// 结束时间</span>
DATE_FORMAT<span class="token punctuation">(</span>ADDDATE<span class="token punctuation">(</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token number">1</span> <span class="token keyword">YEAR</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'%Y-01-01 00:00:00'</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="_385"></a>时间粒度</h2> 
<h3><a id="_387"></a>五分钟</h3> 
<p>参考时间范围为最近五分钟的结束时间的计算方法。</p> 
<h3><a id="_392"></a>小时</h3> 
<p>参考时间范围为最近一小时的结束时间的计算方法。</p> 
<h3><a id="_396"></a>天</h3> 
<p>参考时间范围为最近一天的结束时间的计算方法。</p> 
<h3><a id="_401"></a>周</h3> 
<p>参考时间范围为最近一周的结束时间的计算方法。</p> 
<h3><a id="_405"></a>月</h3> 
<p>参考时间范围为最近一月的结束时间的计算方法。</p> 
<h3><a id="_409"></a>年</h3> 
<p>参考时间范围为最近一年的结束时间的计算方法。</p> 
<h2><a id="_414"></a>结语</h2> 
<p>时间范围和时间粒度的计算虽然不是什么技术难点，却是数据分析 SQL 语句中极其重要的组成部分。不同数据库之间的日期时间函数的支持程度差异较大，具体使用时很容易混淆，如果平时可以多记录多总结，则可以幅度提升开发效率。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/395fe2aa50dcd370b33adcc335e57fd0/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">5000预算组装台式机配置清单</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/19dd6eccfc520d1a18dd5e70315860a5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">第二章 学生指导(01 小学生身心发展的规律 02 学生心理发展与教育 03 小学生的学习)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>