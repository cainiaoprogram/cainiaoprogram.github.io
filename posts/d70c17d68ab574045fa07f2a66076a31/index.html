<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【零基础玩转yolov5】yolov5训练自己的数据集（CPU训练&#43;GPU训练） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【零基础玩转yolov5】yolov5训练自己的数据集（CPU训练&#43;GPU训练）" />
<meta property="og:description" content="文章目录 一、写在前面二、使用labelimg标记图片1.准备工作2.标记图片 三、 划分数据集以及配置文件修改1. 划分训练集、验证集、测试集2.XML格式转yolo_txt格式3.配置文件4.聚类获得先验框 四、使用CPU训练五、使用GPU训练1.开始训练2.重新下载pytorch 六、训练结果可视化 一、写在前面 博主也是最近开始玩yolov5的，甚至也是最近开始使用python的，很多东西都没有接触过，因此训练自己的数据集花了不少时间，所以想写篇博客记录一下，希望同样是零基础的小伙伴们可以更加轻松的上手。同时大家如果发现了错误和理解偏差，欢迎指正。
参考资料：
Yolov5训练自己的数据集（详细完整版）训练集、验证集、测试集的划分yolov5 训练结果解析关于yolov5的一些说明（txt文件、训练结果分析等） 本教程所安装版本：
pycahrm：2021.3.3Anconda：2022.05python：3.9yolov5：v6.2pytorch：CUDA 11.6 踩坑经历：
路径中就不要有短横杠-以及空格等等特殊字符，中文更不能要有❗。否则在之后训练时会出现各种路径找不到的问题😭使用pip等下载指令时最好不要挂VPN，否则可能会下载失败 在上一篇博客里 博客链接，我们完成了yolov5的安装和相关环境的配置，在这篇博客里，我们继续yolov5的学习，尝试训练自己的数据集
二、使用labelimg标记图片 1.准备工作 在yolov5目录下新建一个名为VOCData的文件夹
在VOCData文件夹下创建 Annotations 和 images 文件夹（【🎯易错】：images的文件名不建议修改，否则之后训练时容易出现No labels found的错误，原因见下）
[说明]：
Annotations 文件夹用于存放使用labelimg标记后的图片（XML格式）images 文件夹用于存放用于标记的图片
（【🎯易错】：images 文件夹下直接放图片，内部不要嵌套有文件夹，否则之后训练可能会出现 No label found 的错误，具体原因见下文中 xml_to_yolo.py文件的第67行） [为什么]：
在 yolov5 的 utils 文件夹打开 dataloaders.py文件后，搜索define，便可以找到这样的一段代码：
该段代码的作用是由images文件夹的地址直接推出labels文件夹的位置，所以我们存储图片的文件必须叫做images，同时labels文件必须和images文件必须在同一目录下（先不管labels具体是什么，有个基本的概念即可，接下来会细说）
2.标记图片 在cmd窗口下输入 labelimg 或者运行 labelimg.py 文件进入labelimg的可执行程序（注：如果是在虚拟环境下安装的labelimg，记得先激活虚拟环境）
分别设置需要标注图片的文件夹和存放标记结果的文件夹的地址
推荐设置自动保存
标记图片快捷键：w：标记 a：上一张图片 d：下一张图片
标注的时候尽可能贴近物体轮廓
不知道有没有和我一样开始只能标记方形框的，按住ctrl&#43;shift&#43;R就可以恢复创建矩形框
在Annotations文件夹下可以看到我们标记好的XML文件
三、 划分数据集以及配置文件修改 1. 划分训练集、验证集、测试集 在VOCData目录下创建程序 split_train_val.py 并运行以下代码。代码可以不做任何修改" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/d70c17d68ab574045fa07f2a66076a31/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-24T14:14:59+08:00" />
<meta property="article:modified_time" content="2023-05-24T14:14:59+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【零基础玩转yolov5】yolov5训练自己的数据集（CPU训练&#43;GPU训练）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#_1" rel="nofollow">一、写在前面</a></li><li><a href="#labelimg_26" rel="nofollow">二、使用labelimg标记图片</a></li><li><ul><li><a href="#1_27" rel="nofollow">1.准备工作</a></li><li><a href="#2_44" rel="nofollow">2.标记图片</a></li></ul> 
   </li><li><a href="#__60" rel="nofollow">三、 划分数据集以及配置文件修改</a></li><li><ul><li><a href="#1__61" rel="nofollow">1. 划分训练集、验证集、测试集</a></li><li><a href="#2XMLyolo_txt_122" rel="nofollow">2.XML格式转yolo_txt格式</a></li><li><a href="#3_208" rel="nofollow">3.配置文件</a></li><li><a href="#4_224" rel="nofollow">4.聚类获得先验框</a></li></ul> 
   </li><li><a href="#CPU_232" rel="nofollow">四、使用CPU训练</a></li><li><a href="#GPU_252" rel="nofollow">五、使用GPU训练</a></li><li><ul><li><a href="#1_253" rel="nofollow">1.开始训练</a></li><li><a href="#2pytorch_275" rel="nofollow">2.重新下载pytorch</a></li></ul> 
   </li><li><a href="#_291" rel="nofollow">六、训练结果可视化</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="_1"></a>一、写在前面</h3> 
<p> 博主也是最近开始玩yolov5的，甚至也是最近开始使用python的，很多东西都没有接触过，因此训练自己的数据集花了不少时间，所以想写篇博客记录一下，希望同样是零基础的小伙伴们可以更加轻松的上手。同时大家如果发现了错误和理解偏差，欢迎指正。</p> 
<p><strong>参考资料：</strong></p> 
<ol><li><a href="https://blog.csdn.net/qq_45945548/article/details/121701492">Yolov5训练自己的数据集（详细完整版）</a></li><li><a href="https://blog.csdn.net/sinat_29957455/article/details/83793601">训练集、验证集、测试集的划分</a></li><li><a href="https://blog.csdn.net/qq_27278957/article/details/119968555">yolov5 训练结果解析</a></li><li><a href="https://blog.csdn.net/weixin_44570845/article/details/121337026">关于yolov5的一些说明（txt文件、训练结果分析等）</a></li></ol> 
<p> <br> <strong>本教程所安装版本：</strong></p> 
<ul><li>pycahrm：2021.3.3</li><li>Anconda：2022.05</li><li>python：3.9</li><li>yolov5：v6.2</li><li>pytorch：CUDA 11.6</li></ul> 
<p><strong>踩坑经历：</strong></p> 
<ul><li>路径中就不要有<code>短横杠-</code>以及<code>空格</code>等等特殊字符，<code>中文更不能要有❗</code>。否则在之后训练时会出现各种路径找不到的问题😭</li><li>使用pip等下载指令时最好不要挂VPN，否则可能会下载失败</li></ul> 
<p> 在上一篇博客里 <a href="https://blog.csdn.net/whc18858/article/details/127131741?spm=1001.2014.3001.5501">博客链接</a>，我们完成了yolov5的安装和相关环境的配置，在这篇博客里，我们继续yolov5的学习，尝试训练自己的数据集</p> 
<hr> 
<h3><a id="labelimg_26"></a>二、使用labelimg标记图片</h3> 
<h4><a id="1_27"></a>1.准备工作</h4> 
<ol><li>在yolov5目录下新建一个名为<code>VOCData</code>的文件夹<br> <img src="https://images2.imgbox.com/bc/59/rExQKN0b_o.png" alt="在这里插入图片描述"></li><li>在VOCData文件夹下创建 <code>Annotations</code> 和 <code>images</code> 文件夹（【🎯<strong>易错</strong>】：images的文件名不建议修改，否则之后训练时容易出现<code>No labels found</code>的错误，原因见下）<br> <img src="https://images2.imgbox.com/c8/1b/RgLpMofG_o.png" alt="在这里插入图片描述"></li></ol> 
<p><strong>[说明]：</strong></p> 
<ul><li><code>Annotations</code> 文件夹用于存放使用labelimg标记后的图片（XML格式）</li><li><code>images</code> 文件夹用于存放用于标记的图片<br> （【🎯<strong>易错</strong>】：<code>images</code> 文件夹下直接放图片，内部不要嵌套有文件夹，否则之后训练可能会出现 <code>No label found</code> 的错误，具体原因见下文中 <code>xml_to_yolo.py</code>文件的第67行）</li></ul> 
<p><strong>[为什么]：</strong></p> 
<p> 在 <strong>yolov5</strong> 的 <strong>utils</strong> 文件夹打开 <code>dataloaders.py</code>文件后，搜索define，便可以找到这样的一段代码：<br> <img src="https://images2.imgbox.com/17/fa/cnrRUzKq_o.png" alt="在这里插入图片描述"><br>  该段代码的作用是<strong>由images文件夹的地址直接推出labels文件夹的位置</strong>，所以我们存储图片的文件必须叫做<code>images</code>，同时labels文件必须和images文件必须在同一目录下（先不管labels具体是什么，有个基本的概念即可，接下来会细说）</p> 
<h4><a id="2_44"></a>2.标记图片</h4> 
<ol><li> <p>在cmd窗口下输入 <code>labelimg</code> 或者运行 <code>labelimg.py</code> 文件进入labelimg的可执行程序（注：如果是在虚拟环境下安装的labelimg，记得先激活虚拟环境）</p> </li><li> <p>分别设置需要标注图片的文件夹和存放标记结果的文件夹的地址<br> <img src="https://images2.imgbox.com/88/a7/A9v417oo_o.png" alt="在这里插入图片描述"></p> </li><li> <p>推荐设置自动保存<br> <img src="https://images2.imgbox.com/4c/64/2vjy7Hll_o.png" alt="在这里插入图片描述"></p> </li><li> <p>标记图片快捷键：<code>w：标记</code>   <code>a：上一张图片</code>   <code>d：下一张图片</code><br> <img src="https://images2.imgbox.com/90/fb/XL6sseHz_o.png" alt="在这里插入图片描述"><br> 标注的时候尽可能贴近物体轮廓</p> </li></ol> 
<p> 不知道有没有和我一样开始只能标记<strong>方形框</strong>的，按住<code>ctrl+shift+R</code>就可以恢复创建<strong>矩形框</strong><br>  在Annotations文件夹下可以看到我们标记好的XML文件<br> <img src="https://images2.imgbox.com/62/a6/9qZm4hPu_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="__60"></a>三、 划分数据集以及配置文件修改</h3> 
<h4><a id="1__61"></a>1. 划分训练集、验证集、测试集</h4> 
<p> 在VOCData目录下创建程序 <code>split_train_val.py</code> 并运行以下代码。代码可以不做任何修改</p> 
<pre><code class="prism language-python"><span class="token comment"># coding:utf-8</span>

<span class="token keyword">import</span> os
<span class="token keyword">import</span> random
<span class="token keyword">import</span> argparse

parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#xml文件的地址，根据自己的数据进行修改 xml一般存放在Annotations下</span>
parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--xml_path'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'Annotations'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'input xml label path'</span><span class="token punctuation">)</span>
<span class="token comment">#数据集的划分，地址选择自己数据下的ImageSets/Main</span>
parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--txt_path'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'ImageSets/Main'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'output txt label path'</span><span class="token punctuation">)</span>
opt <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>

trainval_percent <span class="token operator">=</span> <span class="token number">1.0</span>  <span class="token comment"># 训练集和验证集所占比例。 这里没有划分测试集</span>
train_percent <span class="token operator">=</span> <span class="token number">0.9</span>     <span class="token comment"># 训练集所占比例，可自己进行调整</span>
xmlfilepath <span class="token operator">=</span> opt<span class="token punctuation">.</span>xml_path
txtsavepath <span class="token operator">=</span> opt<span class="token punctuation">.</span>txt_path
total_xml <span class="token operator">=</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>xmlfilepath<span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>txtsavepath<span class="token punctuation">)</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>txtsavepath<span class="token punctuation">)</span>

num <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>total_xml<span class="token punctuation">)</span>
list_index <span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span>
tv <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>num <span class="token operator">*</span> trainval_percent<span class="token punctuation">)</span>
tr <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>tv <span class="token operator">*</span> train_percent<span class="token punctuation">)</span>
trainval <span class="token operator">=</span> random<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>list_index<span class="token punctuation">,</span> tv<span class="token punctuation">)</span>
train <span class="token operator">=</span> random<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>trainval<span class="token punctuation">,</span> tr<span class="token punctuation">)</span>

file_trainval <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>txtsavepath <span class="token operator">+</span> <span class="token string">'/trainval.txt'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span>
file_test <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>txtsavepath <span class="token operator">+</span> <span class="token string">'/test.txt'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span>
file_train <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>txtsavepath <span class="token operator">+</span> <span class="token string">'/train.txt'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span>
file_val <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>txtsavepath <span class="token operator">+</span> <span class="token string">'/val.txt'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> list_index<span class="token punctuation">:</span>
    name <span class="token operator">=</span> total_xml<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'\n'</span>
    <span class="token keyword">if</span> i <span class="token keyword">in</span> trainval<span class="token punctuation">:</span>
        file_trainval<span class="token punctuation">.</span>write<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
        <span class="token keyword">if</span> i <span class="token keyword">in</span> train<span class="token punctuation">:</span>
            file_train<span class="token punctuation">.</span>write<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            file_val<span class="token punctuation">.</span>write<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        file_test<span class="token punctuation">.</span>write<span class="token punctuation">(</span>name<span class="token punctuation">)</span>

file_trainval<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
file_train<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
file_val<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
file_test<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>运行结束后会在生成一个名为 ImageSets 的文件夹：<br> <img src="https://images2.imgbox.com/a2/d7/O3rUm6Ac_o.png" alt="在这里插入图片描述"><br>  测试集里的内容为空，因为在划分数据的时候，将<code>90%</code>的数据划分到训练集，将<code>10%</code>的数据划分到训练集。如果要分配，则调整上面14，15行代码中trainval和train的所占的比例</p> 
<p><strong>[说明]：</strong></p> 
<blockquote> 
 <ul><li>训练集是用来训练模型的，通过尝试不同的方法和思路使用训练集来训练不同的模型</li><li>验证集使用交叉验证来挑选最优的模型，通过不断的迭代来改善模型在验证集上的性能</li><li>测试集用来评估模型的性能</li></ul> 
</blockquote> 
<h4><a id="2XMLyolo_txt_122"></a>2.XML格式转yolo_txt格式</h4> 
<p>在VOCData目录下创建程序 <code>xml_to_yolo.py</code> 并运行以下代码，注意：</p> 
<ul><li>将classes改为自己标注时设置的类名（我这里叫"DM"）</li><li>将各个绝对路径修改为自己的</li><li><code>\</code> 是 python中的转义字符，所以表示地址时要使用 <code>\\</code>取消转义，或者<code>/</code></li></ul> 
<pre><code class="prism language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">import</span> xml<span class="token punctuation">.</span>etree<span class="token punctuation">.</span>ElementTree <span class="token keyword">as</span> ET
<span class="token keyword">import</span> os
<span class="token keyword">from</span> os <span class="token keyword">import</span> getcwd

sets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'train'</span><span class="token punctuation">,</span> <span class="token string">'val'</span><span class="token punctuation">,</span> <span class="token string">'test'</span><span class="token punctuation">]</span>
classes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"DM"</span><span class="token punctuation">]</span>  <span class="token comment"># 改成自己的类别</span>
abs_path <span class="token operator">=</span> os<span class="token punctuation">.</span>getcwd<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>abs_path<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">convert</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> box<span class="token punctuation">)</span><span class="token punctuation">:</span>
    dw <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">.</span> <span class="token operator">/</span> <span class="token punctuation">(</span>size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    dh <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">.</span> <span class="token operator">/</span> <span class="token punctuation">(</span>size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2.0</span> <span class="token operator">-</span> <span class="token number">1</span>
    y <span class="token operator">=</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> box<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2.0</span> <span class="token operator">-</span> <span class="token number">1</span>
    w <span class="token operator">=</span> box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    h <span class="token operator">=</span> box<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
    x <span class="token operator">=</span> x <span class="token operator">*</span> dw
    w <span class="token operator">=</span> w <span class="token operator">*</span> dw
    y <span class="token operator">=</span> y <span class="token operator">*</span> dh
    h <span class="token operator">=</span> h <span class="token operator">*</span> dh
    <span class="token keyword">return</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h


<span class="token keyword">def</span> <span class="token function">convert_annotation</span><span class="token punctuation">(</span>image_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
    in_file <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'D:/yolov5/VOCData/Annotations/%s.xml'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>image_id<span class="token punctuation">)</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'UTF-8'</span><span class="token punctuation">)</span>
    out_file <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'D:/yolov5/VOCData/labels/%s.txt'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>image_id<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span>
    tree <span class="token operator">=</span> ET<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>in_file<span class="token punctuation">)</span>
    root <span class="token operator">=</span> tree<span class="token punctuation">.</span>getroot<span class="token punctuation">(</span><span class="token punctuation">)</span>
    size <span class="token operator">=</span> root<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'size'</span><span class="token punctuation">)</span>
    w <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>size<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'width'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span>
    h <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>size<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'height'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span>
    <span class="token keyword">for</span> obj <span class="token keyword">in</span> root<span class="token punctuation">.</span><span class="token builtin">iter</span><span class="token punctuation">(</span><span class="token string">'object'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        difficult <span class="token operator">=</span> obj<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'difficult'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text
        <span class="token comment"># difficult = obj.find('Difficult').text</span>
        cls <span class="token operator">=</span> obj<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text
        <span class="token keyword">if</span> cls <span class="token keyword">not</span> <span class="token keyword">in</span> classes <span class="token keyword">or</span> <span class="token builtin">int</span><span class="token punctuation">(</span>difficult<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        cls_id <span class="token operator">=</span> classes<span class="token punctuation">.</span>index<span class="token punctuation">(</span>cls<span class="token punctuation">)</span>
        xmlbox <span class="token operator">=</span> obj<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'bndbox'</span><span class="token punctuation">)</span>
        b <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>xmlbox<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'xmin'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span>xmlbox<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'xmax'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span>xmlbox<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'ymin'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token builtin">float</span><span class="token punctuation">(</span>xmlbox<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'ymax'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span>
        b1<span class="token punctuation">,</span> b2<span class="token punctuation">,</span> b3<span class="token punctuation">,</span> b4 <span class="token operator">=</span> b
        <span class="token comment"># 标注越界修正</span>
        <span class="token keyword">if</span> b2 <span class="token operator">&gt;</span> w<span class="token punctuation">:</span>
            b2 <span class="token operator">=</span> w
        <span class="token keyword">if</span> b4 <span class="token operator">&gt;</span> h<span class="token punctuation">:</span>
            b4 <span class="token operator">=</span> h
        b <span class="token operator">=</span> <span class="token punctuation">(</span>b1<span class="token punctuation">,</span> b2<span class="token punctuation">,</span> b3<span class="token punctuation">,</span> b4<span class="token punctuation">)</span>
        bb <span class="token operator">=</span> convert<span class="token punctuation">(</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span>
        out_file<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>cls_id<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> <span class="token string">" "</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token keyword">for</span> a <span class="token keyword">in</span> bb<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>


wd <span class="token operator">=</span> getcwd<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> image_set <span class="token keyword">in</span> sets<span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string">'D:/yolov5/VOCData/labels/'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span><span class="token string">'D:/yolov5/VOCData/labels/'</span><span class="token punctuation">)</span>
    image_ids <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'D:/yolov5/VOCData/ImageSets/Main/%s.txt'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>image_set<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string">'D:/yolov5/VOCData/dataSet_path/'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span><span class="token string">'D:/yolov5/VOCData/dataSet_path/'</span><span class="token punctuation">)</span>
	<span class="token comment"># 这行路径不需更改，这是相对路径</span>
    list_file <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'dataSet_path/%s.txt'</span> <span class="token operator">%</span> image_set<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 图片格式为jpg则设置为 .jpg, 如果为png则设置为 .png。否则会出现路径找不到的问题</span>
    <span class="token keyword">for</span> image_id <span class="token keyword">in</span> image_ids<span class="token punctuation">:</span>
        list_file<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">'D:/yolov5/VOCData/images/%s.jpg\n'</span> <span class="token operator">%</span> image_id<span class="token punctuation">)</span>
        convert_annotation<span class="token punctuation">(</span>image_id<span class="token punctuation">)</span>
    list_file<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<p>【🎯<strong>易错 <strong>】：第59行代码中的<code>split()</code>函数是以空格作为分隔符的，因此如果你的</strong>xml</strong>文件名中带有空格，就会将文件名错误划分。回应开头说的话，为了避免各种路径找不到的问题，文件路径中<strong>不要有空格，不要有特殊符号，不要有中文！！</strong></p> 
<p> 运行后会生成如下图所示的 <code>dataSet_path</code> 和 <code>labels</code> 文件夹。dataSet_path下会有三个数据集的txt文件，labels下存放各个图像的标注文件</p> 
<p><img src="https://images2.imgbox.com/f2/cf/rR300Nha_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="3_208"></a>3.配置文件</h4> 
<p> 在 yolov5 的 <code>data</code> 文件夹下创建一个名为 <code>myvoc.yaml</code>，模板如下，根据自己实际情况填写：<br> 【🎯<strong>易错</strong>】：注意冒号后面是有<strong>空格</strong>的</p> 
<pre><code class="prism language-python">train<span class="token punctuation">:</span> D<span class="token punctuation">:</span><span class="token operator">/</span>yolov5<span class="token operator">/</span>VOCData<span class="token operator">/</span>dataSet_path<span class="token operator">/</span>train<span class="token punctuation">.</span>txt
val<span class="token punctuation">:</span> D<span class="token punctuation">:</span><span class="token operator">/</span>yolov5<span class="token operator">/</span>VOCData<span class="token operator">/</span>dataSet_path<span class="token operator">/</span>val<span class="token punctuation">.</span>txt

<span class="token comment"># number of classes</span>
nc<span class="token punctuation">:</span> <span class="token number">1</span>

<span class="token comment"># class names</span>
names<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"DM"</span><span class="token punctuation">]</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/9b/78/HEaI0nE9_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="4_224"></a>4.聚类获得先验框</h4> 
<ol><li>获取anchors<br>  较高版本的yolov5都可以在 <code>utils</code>文件夹下找到 <code>autoanchor.py</code>文件，它的作用是自动获取anchors，因此我们不需要额外的操作。<br> <img src="https://images2.imgbox.com/d0/02/BKRWkoSN_o.png" alt="在这里插入图片描述"></li><li>在 <code>models</code> 文件夹下找到 <code>yolov5s.yaml</code>（如果使用这个权重模型训练的话），将其中的 <code>nc</code> 改为实际上标注类的数量，和 myvoc.yaml 一样（<em>记得保存</em>）。<br> <img src="https://images2.imgbox.com/3d/7a/RyubhqVr_o.png" alt="在这里插入图片描述"></li></ol> 
<h3><a id="CPU_232"></a>四、使用CPU训练</h3> 
<p> 在cmd窗口下激活相应<strong>虚拟环境</strong>后 <strong>cd</strong> 到 yolov5 文件夹后，输入下列指令即可开始训练</p> 
<pre><code class="prism language-python">python train<span class="token punctuation">.</span>py <span class="token operator">-</span><span class="token operator">-</span>weights yolov5s<span class="token punctuation">.</span>pt  <span class="token operator">-</span><span class="token operator">-</span>cfg models<span class="token operator">/</span>yolov5s<span class="token punctuation">.</span>yaml  <span class="token operator">-</span><span class="token operator">-</span>data data<span class="token operator">/</span>myvoc<span class="token punctuation">.</span>yaml <span class="token operator">-</span><span class="token operator">-</span>epoch <span class="token number">200</span> <span class="token operator">-</span><span class="token operator">-</span>batch<span class="token operator">-</span>size <span class="token number">8</span> <span class="token operator">-</span><span class="token operator">-</span>img <span class="token number">640</span>   <span class="token operator">-</span><span class="token operator">-</span>device cpu
</code></pre> 
<p><strong>[参数说明]：</strong></p> 
<ul><li><code>--weights</code> ：权重文件所在的相对路径</li><li><code>--cfg</code>：存储模型结构配置文件的相对路径</li><li><code>--data</code>：存储训练、测试数据的文件的相对路径</li><li><code>--epoch</code>：训练过程中整个数据集将被迭代（训练）了多少次</li><li><code>--batch-size</code>：训练完多少张图片才进行权重更新</li><li><code>--img</code>：自适应缩放输入图片的尺寸为指定大小。在YOLOv5中，输入图像的大小需要是正方形，并且是 32 的倍数</li><li><code>--device</code>：选择用CPU或者GPU训练</li></ul> 
<p>【🎯<strong>易错</strong>】：在指定路径的时候需要注意，在python中，<code>\</code>是转移字符，如果我们想要表示路径，则需要使用<code>/</code>或者<code>\\</code>取消转义<br> (开始训练)<br> <img src="https://images2.imgbox.com/71/6b/ZX98P7x9_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="GPU_252"></a>五、使用GPU训练</h3> 
<h4><a id="1_253"></a>1.开始训练</h4> 
<p> <strong>CPU</strong>适合处理少量复杂运算，<strong>GPU</strong>适合处理大量简单运算。相较于 <strong>CPU</strong>，<strong>GPU</strong> 在具备大量重复数据集运算和频繁内存访问等特点的应用场景中具有无可比拟的优势，在运行分析、深度学习和机器学习算法尤其有用。<br>  GPU 能够让某些计算比传统 CPU 上运行相同的计算速度快 10 倍至 100 倍。所以更加推荐使用GPU进行训练。</p> 
<p> 使用GPU训练，只需将代码中的<code>--device cpu</code>改为<code>--device 0/1……</code> 即可，显卡编号可以使用<code>nvidia-smi</code>指令来查看。如下图所示，我的电脑中只安装了一块GPU，在训练中只能使用 <code>--device 0</code>.</p> 
<pre><code class="prism language-python">python train<span class="token punctuation">.</span>py <span class="token operator">-</span><span class="token operator">-</span>weights yolov5s<span class="token punctuation">.</span>pt  <span class="token operator">-</span><span class="token operator">-</span>cfg models<span class="token operator">/</span>yolov5s<span class="token punctuation">.</span>yaml  <span class="token operator">-</span><span class="token operator">-</span>data data<span class="token operator">/</span>myvoc<span class="token punctuation">.</span>yaml <span class="token operator">-</span><span class="token operator">-</span>epoch <span class="token number">200</span> <span class="token operator">-</span><span class="token operator">-</span>batch<span class="token operator">-</span>size <span class="token number">8</span> <span class="token operator">-</span><span class="token operator">-</span>img <span class="token number">640</span>   <span class="token operator">-</span><span class="token operator">-</span>device <span class="token number">0</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/ce/47/iuopcpIx_o.png" alt="在这里插入图片描述"><br> 而在下面例子中，则有两块GPU<br> <img src="https://images2.imgbox.com/0e/e0/LmvSyi0H_o.png" alt="在这里插入图片描述"></p> 
<p>🎯<strong>易错①</strong>：如果训练时出现 <code>CUDA out of memory</code>的错误，将 <code>batch_size</code> 改到4基本能解决问题，再不行就改成1</p> 
<p><img src="https://images2.imgbox.com/a9/1b/Ay6dQqdI_o.png" alt="在这里插入图片描述"></p> 
<p>🎯<strong>易错</strong>：<code>yolov5</code> 是基于 <code>pytorch</code> 实现的，而使用 pip 默认安装的 pytorch 是以CPU作为计算平台，因此CUDA是不可用的，需要重新下载基于 CUDA 计算的pytorch</p> 
<h4><a id="2pytorch_275"></a>2.重新下载pytorch</h4> 
<p>pytorch文件比较大，建议下载的时候首先给 pip 换源</p> 
<ul><li>Pytorch官方下载链接 ：<a href="https://pytorch.org/get-started/locally/" rel="nofollow">https://pytorch.org/get-started/locally/</a></li></ul> 
<p><img src="https://images2.imgbox.com/82/66/GD1h7uTN_o.png" alt="在这里插入图片描述"></p> 
<ol><li> <p>首先在相应虚拟环境下删除原先版本的pytorch。注意！仅仅使用<code>pip uninstall torch</code>指令是不够的，因为重新下载的 torch 可能与其他软件之间存在<strong>版本不兼容问题</strong>。正确的做法是：找到自己Anconda中对应虚拟环境的位置，将下面这些文件全部删除。<br> <img src="https://images2.imgbox.com/90/bb/RmSymOGS_o.png" alt="在这里插入图片描述"></p> </li><li> <p>使用 <code>nvidia-smi</code> 查看最高能下载的 pytorch CUDA版本，我这里是11.6<br> <img src="https://images2.imgbox.com/47/89/6QXVS77S_o.png" alt="在这里插入图片描述"></p> </li><li> <p>强烈推荐使用 <code>pip</code> 安装而不要使用 <code>conda</code>安装，<code>conda</code> 安装太慢了，换源还是很慢，而且还很容易失败 <a href="https://blog.csdn.net/whc18858/article/details/127135973">pip install 与 conda install 的使用区别</a></p> </li><li> <p>切换到相应虚拟环境中，运行 <strong>“Run this Command:”</strong> 提示的 pip 代码安装<img src="https://images2.imgbox.com/c4/46/kIrcyZkL_o.png" alt="在这里插入图片描述"></p> </li><li> <p>检测cuda是否可用：首先包含头文件 <code>import torch</code>，在输入指令 <code>torch.cuda.is_available()</code>，返回true说明可以使用。接下来我们就可以使用GPU进行训练<br> <img src="https://images2.imgbox.com/69/3e/7VH0vQjn_o.png" alt="在这里插入图片描述"></p> </li></ol> 
<h3><a id="_291"></a>六、训练结果可视化</h3> 
<p>训练结果将保存在 <code>\runs\train</code> 文件夹下，部分文件意义如下：<br> <img src="https://images2.imgbox.com/c2/77/FH3g4e8s_o.png" alt="在这里插入图片描述"></p> 
<ul><li>weights：训练生成权重。包含 <code>best.pt</code> (最好的权重，detect时用到它)，和 <code>last.pt</code>(最近生成的权重模型)</li><li>confusion：混淆矩阵。混淆矩阵让我们了解分类模型所犯的错误，更重要的是可以了解哪些错误类型正在发生。</li><li>F1_curve：置信度和F1分数的关系图</li><li>P_curve：准确率和置信度的关系图</li><li>R_curve：召回率和置信度之间的关系</li><li>PR_curve：PR曲线中的P代表的是precision（精准率），R代表的是recall（召回率），其代表的是精准率与召回率的关系</li><li>labels：左上图表示个类别的数据量；右上图表示标签；左下图表示 center 的 xy 坐标；右下图表示各个标签的长和宽</li></ul> 
<p> <strong>TensorBoard</strong> 是 TensorFlow 提供的一个可视化工具，用于帮助用户通过交互式的数据可视化方式监控、调试、优化深度学习模型。使用指令 <code>tensorboard --logdir=xxx</code> 启动TensorBoard 服务，并递归式的读取指定路径下的所有事件数据。</p> 
<p> 训练后的事件数据存储在 <code>runs/train</code> 路径中，我们想查看exp13的训练结果，可以执行下面的指令： <code>tensorboard --logdir= runs/train/exp13</code></p> 
<p><img src="https://images2.imgbox.com/a5/8b/Ci1A7WMK_o.png" alt="在这里插入图片描述"></p> 
<p> 访问网页<code> http://localhost:6006/</code>即可看到各种训练结果（注：localhost指的是你所在的计算机本身）<br> <img src="https://images2.imgbox.com/25/64/qxoam1HX_o.png" alt="在这里插入图片描述"></p> 
<p>使用刚刚训练好的 <code>best.pt</code>模型来检测：</p> 
<pre><code class="prism language-python"> python detect<span class="token punctuation">.</span>py <span class="token operator">-</span><span class="token operator">-</span>weights runs<span class="token operator">/</span>train<span class="token operator">/</span>exp<span class="token operator">/</span>weights<span class="token operator">/</span>best<span class="token punctuation">.</span>pt <span class="token operator">-</span><span class="token operator">-</span>source <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span>source<span class="token operator">/</span>test<span class="token punctuation">.</span>png
</code></pre> 
<p><strong>[说明]：</strong></p> 
<ul><li><code>--weights</code>：表示我们选择的权重模型</li><li><code>--source</code>：表示待检测的图片的路径 (…/表示上级路径)</li></ul> 
<p>成功实现了恶劣环境下的DM码的定位<br> <img src="https://images2.imgbox.com/2f/d9/ZemNXFgV_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/372cf8ea86ff968bfcb7cb6151223c62/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">ubuntu20.4配置自动启动root用户并开启向日葵</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f14b171f9271ff8d4a73f69bbd2231cd/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">js 实现金额数字格式化（加元、万元、亿元单位）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>