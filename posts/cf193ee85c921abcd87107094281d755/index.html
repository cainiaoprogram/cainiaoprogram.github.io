<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>阿里云HaaS100主板在Alios things中控制380V遮阳棚电机 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="阿里云HaaS100主板在Alios things中控制380V遮阳棚电机" />
<meta property="og:description" content="文档说明 本文是说明HaaS100通过RS485串口控制380V电机的开发记录：
涉及到modbus的驱动函数使用，以及跟厂家的协议匹配，数值处理等方面。
我的系统通过HaaS100的RS485口，连接了1个32位的Modbus继电器。
目录
文档说明
1.设备连接拓扑
2.程序实现
3.助人自助
1.设备连接拓扑 这个拓扑图是简化了的，实际上控制一个380V的电机，需要3个继电器，脉冲式的控制电机启动。这在制作配电柜的时候，需要跟厂家说明，预留出接线端子。
2.程序实现 程序上实现需要以下三步：
2.1.控制继电器脉冲式开关
/* 函数名称：Set_Switch_state 函数功能： 设置继电器闪开闪关，因为是脉冲输出，因此其实没有所谓开或是关，都一样 输入参数： 参数1：mb_handler1 modbus数据结构句柄 参数2：DeviceAddr Modbus地址 参数3：Coiladdr 线圈地址 参数4：CoilValue 线圈状态 Switchon,Switchoff; 输出参数：成功与否的标志位 */ mb_status_t Set_Switch_state(mb_handler_t *mb_handler1,uint8_t DeviceAddr,uint16_t Coiladdr,uint16_t CoilValue) { mb_status_t status1; mb_handler_t *mb_handler; uint16_t data_resp = 0; status1 = mbmaster_write_single_coil(mb_handler1, DeviceAddr, Coiladdr,Switchon, NULL, &amp;dat a_resp, NULL, AOS_WAIT_FOREVER); status1 = mbmaster_write_single_coil(mb_handler1, DeviceAddr, Coiladdr,Switchoff, NULL, &amp;data_resp, NULL, AOS_WAIT_FOREVER); return status1; } 2.2.解析云端指令并执行
/** recv event post response message from cloud static int user_property_set_event_handler(const int devid, const char *request, const int request_len) { int res = 0; EXAMPLE_TRACE(&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/cf193ee85c921abcd87107094281d755/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-06-05T17:38:52+08:00" />
<meta property="article:modified_time" content="2021-06-05T17:38:52+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">阿里云HaaS100主板在Alios things中控制380V遮阳棚电机</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p style="text-align:center;"><img alt="" height="317" src="https://images2.imgbox.com/63/c4/7tjCbGg4_o.png" width="321"></p> 
<p> </p> 
<h4 id="%E6%96%87%E6%A1%A3%E8%AF%B4%E6%98%8E">文档说明</h4> 
<p>本文是说明HaaS100通过RS485串口控制380V电机的开发记录：</p> 
<p>涉及到modbus的驱动函数使用，以及跟厂家的协议匹配，数值处理等方面。</p> 
<p>我的系统通过HaaS100的RS485口，连接了1个32位的Modbus继电器。</p> 
<p id="main-toc"><strong>目录</strong></p> 
<p><a href="#%E6%96%87%E6%A1%A3%E8%AF%B4%E6%98%8E" rel="nofollow">文档说明</a></p> 
<p id="1.%E8%AE%BE%E5%A4%87%E8%BF%9E%E6%8E%A5%E6%8B%93%E6%89%91-toc" style="margin-left:40px;"><a href="#1.%E8%AE%BE%E5%A4%87%E8%BF%9E%E6%8E%A5%E6%8B%93%E6%89%91" rel="nofollow">1.设备连接拓扑</a></p> 
<p id="2.%E7%A8%8B%E5%BA%8F%E5%AE%9E%E7%8E%B0-toc" style="margin-left:40px;"><a href="#2.%E7%A8%8B%E5%BA%8F%E5%AE%9E%E7%8E%B0" rel="nofollow">2.程序实现</a></p> 
<p id="3.%E5%8A%A9%E4%BA%BA%E8%87%AA%E5%8A%A9-toc" style="margin-left:40px;"><a href="#3.%E5%8A%A9%E4%BA%BA%E8%87%AA%E5%8A%A9" rel="nofollow">3.助人自助</a></p> 
<hr id="hr-toc"> 
<p> </p> 
<h3 id="1.%E8%AE%BE%E5%A4%87%E8%BF%9E%E6%8E%A5%E6%8B%93%E6%89%91">1.设备连接拓扑</h3> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/76/3f/0APulYNM_o.png"></p> 
<p>这个拓扑图是简化了的，实际上控制一个380V的电机，需要3个继电器，脉冲式的控制电机启动。这在制作配电柜的时候，需要跟厂家说明，预留出接线端子。</p> 
<p> </p> 
<h3 id="2.%E7%A8%8B%E5%BA%8F%E5%AE%9E%E7%8E%B0">2.程序实现</h3> 
<p>程序上实现需要以下三步：</p> 
<p>2.1.控制继电器脉冲式开关</p> 
<pre><code>/* 函数名称：Set_Switch_state 函数功能：
设置继电器闪开闪关，因为是脉冲输出，因此其实没有所谓开或是关，都一样 
输入参数：         
参数1：mb_handler1 modbus数据结构句柄         
参数2：DeviceAddr Modbus地址         
参数3：Coiladdr 线圈地址         
参数4：CoilValue 线圈状态 Switchon,Switchoff; 输出参数：成功与否的标志位 */ mb_status_t  Set_Switch_state(mb_handler_t *mb_handler1,uint8_t DeviceAddr,uint16_t Coiladdr,uint16_t CoilValue) {     
    mb_status_t status1;     
    mb_handler_t *mb_handler;     
    uint16_t   data_resp = 0;                                   
status1 = mbmaster_write_single_coil(mb_handler1, DeviceAddr, Coiladdr,Switchon, NULL, &amp;dat    a_resp, NULL, AOS_WAIT_FOREVER); status1 = mbmaster_write_single_coil(mb_handler1, DeviceAddr, Coiladdr,Switchoff, NULL, &amp;data_resp, NULL, AOS_WAIT_FOREVER);     
return status1; 
}</code></pre> 
<p> </p> 
<p>2.2.解析云端指令并执行</p> 
<pre><code>/** recv event post response message from cloud 
static int user_property_set_event_handler(const int devid, const char *request, const int request_len)
{
    int res = 0;
    EXAMPLE_TRACE("Property Set Received, Request: %s", request);

    /* request ="{"Switch01":1}" 下发的指令是1号开关的---------*/

    cJSON *root = NULL, *item_PowerSwitch = NULL;
    root = cJSON_Parse(request);
    //-----------------------1号开关的控制逻辑
    item_PowerSwitch = cJSON_GetObjectItem(root, "Switch01");
        if (item_PowerSwitch != NULL)
        {
            if(item_PowerSwitch-&gt;valueint)
            {
                Set_Switch_state(mb_handler,SwitchDeviceAddr01,0,Switchon);
            }    
            else
            {
                Set_Switch_state(mb_handler,SwitchDeviceAddr01,0,Switchoff);
                
            }
        }
……
}
</code></pre> 
<p> </p> 
<p>2.3.根据电机逻辑修改代码</p> 
<p>实际上电机要正常动作，有一个逻辑顺序，就是正转之后你要反转，必须先按停止，因此会出现，用户要启动电机无论是正转还是反转，都需要先按下停止，所以代码中会有相应的关联。比如开关123分别对应正反停，那么当正被按下时，应该执行两个开关命令，即</p> 
<p>正传的代码是：</p> 
<pre><code>if(item_PowerSwitch-&gt;valueint) 
{ 
    Set_Switch_state(mb_handler,SwitchDeviceAddr03,0,Switchon); 
    Set_Switch_state(mb_handler,SwitchDeviceAddr01,0,Switchon);
}</code></pre> 
<p>反转的代码是：</p> 
<pre><code>if(item_PowerSwitch-&gt;valueint) 
{ 
    Set_Switch_state(mb_handler,SwitchDeviceAddr03,0,Switchon); 
    Set_Switch_state(mb_handler,SwitchDeviceAddr02,0,Switchon);
}</code></pre> 
<p> </p> 
<h3 id="3.%E5%8A%A9%E4%BA%BA%E8%87%AA%E5%8A%A9">3.助人自助</h3> 
<p>在Haas开发过程中，系统代码本身有阿里云的技术支持积极的给我们解决问题，应用上的问题，自己的代码，我们可以实现互助交流，我本身代码能力也不强，写的代码是能用但是不是很规范，完备，希望大家指正，如果项目上遇到选型、驱动，方案上的问题，欢迎和我交流，微信paulmark。</p> 
<p>我是技术人员创业，道路不是很好走，听朋友说，多交流才有机会，希望通过不断的交流，输出有价值的东西，得到更多的机会。</p> 
<p>我是学良，欢迎与我沟通。</p> 
<p> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e8e912757e5823c189ec7ad938600c0c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">leetcode_160_相交链表</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/cfd99ab2d82068f8d5f9591c712b7836/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Faser-RCNN之ROIPooling详解</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>