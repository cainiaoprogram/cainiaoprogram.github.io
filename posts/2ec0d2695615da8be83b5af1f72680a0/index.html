<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>esp32学习笔记（4）——adc - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="esp32学习笔记（4）——adc" />
<meta property="og:description" content="文章目录 前言一、ESP32 ADC相关介绍二、使用步骤1.接口函数介绍2.代码示例 总结 前言 ADC即模拟数字转换器（Analog-to-digital converter）是用于将模拟形式的连续信号转换为数字形式的离散信号的一类设备。一个模拟数字转换器可以提供信号用于测量。与之相对的设备成为数字模拟转换器。
例如温度、压力、声音或者图像等，需要转换成更容易储存、处理和发射的数字形式。那就可以用到ADC了
提示：以下是本篇文章正文内容，下面案例可供参考
一、ESP32 ADC相关介绍 一些 ADC2 引脚用作捆绑引脚（GPIO 0、2、15），因此不能自由使用。
ESP32 DevKitC：由于外部自动编程电路，GPIO 0 无法使用。
ESP-WROVER-KIT：GPIO 0、2、4 和 15 不能使用，因为用于不同目的的外部连接。
由于 ADC2 模块也被 Wi-Fi 使用，因此它们一起使用时只有一个可以抢占，这意味着adc2_get_raw()可能会被阻塞直到 Wi-Fi 停止
ESP32 集成了 2 个 SAR（逐次逼近寄存器）ADC，总共支持 18 个测量通道（模拟使能引脚）。
ADC1，8通道：GPIO32 - GPIO39
ADC2，10个通道：GPIO0、GPIO2、GPIO4、GPIO12 - GPIO15、GOIO25 - GPIO27
以下介绍通过ADC1进行介绍
2、ADC衰减
Vref 是 ESP32 ADC 内部用于测量输入电压的参考电压。ESP32 ADC 可以测量从 0 V 到 Vref 的模拟电压。在不同的芯片中，Vref 不同，中位数为 1.1 V。为了转换大于 Vref 的电压，可以在输入 ADC 之前对输入电压进行衰减。有 4 种可用的衰减选项，衰减越高，可测量的输入电压就越高。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/2ec0d2695615da8be83b5af1f72680a0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-19T16:34:04+08:00" />
<meta property="article:modified_time" content="2022-04-19T16:34:04+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">esp32学习笔记（4）——adc</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_6" rel="nofollow">前言</a></li><li><a href="#ESP32_ADC_15" rel="nofollow">一、ESP32 ADC相关介绍</a></li><li><a href="#_34" rel="nofollow">二、使用步骤</a></li><li><ul><li><a href="#1_35" rel="nofollow">1.接口函数介绍</a></li><li><a href="#2_175" rel="nofollow">2.代码示例</a></li></ul> 
  </li><li><a href="#_338" rel="nofollow">总结</a></li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="_6"></a>前言</h2> 
<p>ADC即模拟数字转换器（Analog-to-digital converter）是用于将<strong>模拟</strong>形式的<strong>连续</strong>信号<strong>转换</strong>为<strong>数字</strong>形式的<strong>离散</strong>信号的一类设备。一个模拟数字转换器可以提供信号用于测量。与之相对的设备成为数字模拟转换器。<br> 例如温度、压力、声音或者图像等，需要转换成更容易储存、处理和发射的数字形式。那就可以用到ADC了</p> 
<hr> 
<p><code>提示：以下是本篇文章正文内容，下面案例可供参考</code></p> 
<h2><a id="ESP32_ADC_15"></a>一、ESP32 ADC相关介绍</h2> 
<p>一些 ADC2 引脚用作捆绑引脚（GPIO 0、2、15），因此不能自由使用。<br> ESP32 DevKitC：由于外部自动编程电路，GPIO 0 无法使用。<br> ESP-WROVER-KIT：GPIO 0、2、4 和 15 不能使用，因为用于不同目的的外部连接。<br> 由于 ADC2 模块也被 Wi-Fi 使用，因此它们一起使用时只有一个可以抢占，这意味着adc2_get_raw()可能会被阻塞直到 Wi-Fi 停止</p> 
<p>ESP32 集成了 2 个 SAR（逐次逼近寄存器）ADC，总共支持 18 个测量通道（模拟使能引脚）。<br> ADC1，8通道：GPIO32 - GPIO39<br> ADC2，10个通道：GPIO0、GPIO2、GPIO4、GPIO12 - GPIO15、GOIO25 - GPIO27<br> 以下介绍通过ADC1进行介绍<br> <strong>2、ADC衰减</strong><br> Vref 是 ESP32 ADC 内部用于测量输入电压的参考电压。ESP32 ADC 可以测量从 0 V 到 Vref 的模拟电压。在不同的芯片中，Vref 不同，中位数为 1.1 V。为了转换大于 Vref 的电压，可以在输入 ADC 之前对输入电压进行衰减。有 4 种可用的衰减选项，衰减越高，可测量的输入电压就越高。<br> <img src="https://images2.imgbox.com/b6/9b/QQtMoDUy_o.png" alt="在这里插入图片描述"><br> <strong>3、ADC 转换</strong><br> ADC 转换是将输入模拟电压转换为数字值。ADC 驱动程序 API (<code>adc1_get_raw()</code>)提供的 ADC 转换结果是原始数据。Single Read 模式下 ESP32 ADC 原始结果的分辨率为 12 位。<br> 如果根据ADC采集的原始数据来计算电压那可以用Vout（输出电压）=Dout（输出的数据）*Vmax（最大测量电压）/Dmax（最大输出数据）<br> ps:如果是带有ADC校准位的板子可以直接调用<code>esp_adc_cal_raw_to_voltage()</code>来直接读取输出电压，单位为mv<br> <strong>4、ADC 单次读取</strong><br> 在配置好位宽<code>adc1_config_width()</code>和衰减<code>adc1_config_channel_atten()</code>之后就可以直接调用<code>adc1_get_raw(),</code>读取结果了；值得说明的是官方也提供给了从ULP直接读取ADC1通道的结果，但是这个要在配置的时候调用<code>adc1_ulp_enable()</code>来使能ULP</p> 
<h2><a id="_34"></a>二、使用步骤</h2> 
<h3><a id="1_35"></a>1.接口函数介绍</h3> 
<p><strong>（1）设置通道衰减</strong></p> 
<pre><code class="prism language-c"><span class="token class-name">esp_err_t</span> adc1_config_channel_atten（<span class="token class-name">adc1_channel_t</span> channel，<span class="token class-name">adc_atten_t</span> atten ）
</code></pre> 
<p>第一个参数是设置ADC通道，第二个参数是设置衰减等级；默认衰减是0dB;通过官方给的衰减设置可以看到，衰减设置的越大，那么可采集的电压范围就越大（通过对输入电压进行衰减）<br> 返回值：<br> ESP_OK 成功<br> ESP_ERR_INVALID_ARG 参数错误<br> <img src="https://images2.imgbox.com/dd/c3/cXh4h8HD_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/40/e4/iVNukItt_o.png" alt="在这里插入图片描述"><br> <strong>（2）配置ADC的捕获位宽</strong></p> 
<pre><code class="prism language-c"><span class="token class-name">esp_err_t</span> <span class="token function">adc1_config_width</span><span class="token punctuation">(</span> <span class="token class-name">adc_bits_width_t</span> width_bit <span class="token punctuation">)</span>
</code></pre> 
<p>参数：ADC1 的位捕获宽度<br> 返回值：<br> ESP_OK 成功<br> ESP_ERR_INVALID_ARG 参数错误<br> <img src="https://images2.imgbox.com/c2/fb/5uTcxMr8_o.png" alt="在这里插入图片描述"></p> 
<p><strong>(3)读取单个通道上的ADC数据</strong></p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">adc1_get_raw</span><span class="token punctuation">(</span> <span class="token class-name">adc1_channel_t</span> channel<span class="token punctuation">)</span>
</code></pre> 
<p>返回<br> -1：参数错误<br> 其他：ADC1 通道读数。<br> 参数<br> channel: ADC1 通道读取</p> 
<p><strong>(4)初始化数字ADC</strong></p> 
<pre><code class="prism language-c"><span class="token class-name">esp_err_t</span> <span class="token function">adc_digi_initialize</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">adc_digi_init_config_t</span> <span class="token operator">*</span>init_config <span class="token punctuation">)</span>
</code></pre> 
<p>参数：数字ADC的初始化配置<code>adc_digi_init_config_t</code> 在这个结构体里面；<br> 返回：</p> 
<ul><li> 
  <ul><li>ESP_ERR_INVALID_ARG 参数错误</li></ul> </li><li> 
  <ul><li>ESP_ERR_NOT_FOUND 没有找到中断空闲</li></ul> </li><li> 
  <ul><li>ESP_ERR_NO_MEM 内存不足</li></ul> </li><li> 
  <ul><li>ESP_OK 成功<br> <img src="https://images2.imgbox.com/39/64/tZJYgMZR_o.png" alt="在这里插入图片描述"><br> 结构体中参数依次是<br> 1）转换后的数据可以存储的最大长度。<br> 2）在一个中断中可以转换的数据字节数<br> 3）待初始化的ADC1通道列表。<br> 4）需要初始化的ADC2通道列表。</li></ul> </li></ul> 
<p><strong>（5）通过 DMA 从数字 ADC 读取字节。</strong></p> 
<pre><code class="prism language-c"><span class="token class-name">esp_err_t</span> <span class="token function">adc_digi_read_bytes</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> length_max<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> <span class="token operator">*</span>out_length<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> timeout_ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>[out] buf：从 ADC 读取的缓冲区。<br> [in] length_max：从 ADC 读取的预期数据长度。<br> [out] out_length：从 ADC 读取的数据的实际长度。<br> [in] timeout_ms：等待数据的时间，以毫秒为单位。<br> 返回<br> ESP_ERR_INVALID_STATE 驱动状态无效。通常这意味着 ADC 采样率快于任务处理率。<br> ESP_ERR_TIMEOUT 操作超时<br> ESP_OK 成功<br> <strong>（6）启动数字ADC和 DMA</strong></p> 
<pre><code class="prism language-c"><span class="token class-name">esp_err_t</span> <span class="token function">adc_digi_start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>返回<br> ESP_ERR_INVALID_STATE 驱动状态无效。<br> ESP_OK 成功<br> <strong>（6）设置数字控制器</strong></p> 
<pre><code class="prism language-c"><span class="token class-name">esp_err_t</span> <span class="token function">adc_digi_controller_configure</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">adc_digi_configuration_t</span> <span class="token operator">*</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>返回值：<br> ESP_ERR_INVALID_STATE 驱动状态无效。<br> ESP_ERR_INVALID_ARG 如果参数组合无效。<br> ESP_OK 成功<br> 参数为adc_digi_configuration_t 结构体<br> <img src="https://images2.imgbox.com/96/01/OqyNoGMI_o.png" alt="在这里插入图片描述"><br> 结构体中参数依次是<br> 1）限制ADC转换的时间，转换完成后是否停止<br> 2）限制ADC转换触发器上限1-255<br> 3）ADC通道数<br> 4）初始化结构体配置参数<br> 5）采样频率611Hz ~ 83333Hz<br> 6）ADC DMA传输模式:选择ADC1、ADC2、ADC1与ADC2、ADC1与ADC2轮流<br> 7）ADC DMA传输转换格式：12BIT转换/11BIT转换<br> <img src="https://images2.imgbox.com/a7/e2/3opZUtAt_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/66/5b/0cvdlxCl_o.png" alt="在这里插入图片描述"></p> 
<p>对于设置的输出格式来说如果设置输出12BIT的数据，那么输出的16位中存放格式是[15:12] 通道，[11:0]12 位 ADC 数据 。注意：对于单次转换模式。<br> 如果设置的数是11BIT的数据那么存放内容就是[15]adc 单元，[14:11]通道，[10:0]11 位 ADC 数据 。注意：对于多或交替转换模式。</p> 
<p><strong>（7）检查 ADC 校准值是否烧入 eFuse</strong>。</p> 
<pre><code class="prism language-c"><span class="token class-name">esp_err_t</span> <span class="token function">esp_adc_cal_check_efuse</span><span class="token punctuation">(</span> <span class="token class-name">esp_adc_cal_value_t</span> value_type <span class="token punctuation">)</span>
</code></pre> 
<p>检查 ADC 参考电压或两点值是否已烧到当前 ESP32 的 eFuse<br> 返回：<br> ESP_OK：eFuse 支持校准模式<br> ESP_ERR_NOT_SUPPORTED：错误，eFuse 值未烧入<br> ESP_ERR_INVALID_ARG：错误，无效参数（ESP_ADC_CAL_VAL_DEFAULT_VREF）<br> 参数：<br> value_type：校准值的类型（ESP_ADC_CAL_VAL_EFUSE_VREF 或 ESP_ADC_CAL_VAL_EFUSE_TP）<br> <strong>（8）以特定衰减表征 ADC，</strong><br> esp_adc_cal_value_t esp_adc_cal_characterize( adc_unit_t adc_num , adc_atten_t atten , adc_bits_width_t bit_width , uint32_t default_vref , esp_adc_cal_characteristics_t * chars )<br> 返回：<br> ESP_ADC_CAL_VAL_EFUSE_VREF：用于表征的 eFuse Vref<br> ESP_ADC_CAL_VAL_EFUSE_TP：用于表征的两点值（仅在线性模式下）<br> ESP_ADC_CAL_VAL_DEFAULT_VREF：用于表征的默认 Vref<br> 参数：<br> [in] adc_num：ADC_UNIT_1 或 ADC_UNIT_2<br> [in] atten: 衰减<br> [in] bit_width: ADC的位宽配置<br> [in] default_vref：默认 ADC 参考电压，单位 mV<br> [out] chars: 指向用于存储 ADC 特征的空结构的指针<br> <strong>（9）将 ADC 读数转换为以 mV 为单位的电压。</strong><br> uint32_t esp_adc_cal_raw_to_voltage(uint32_t adc_reading, const esp_adc_cal_characteristics_t *chars);<br> 在调用此函数之前必须初始化特征结构（调用 esp_adc_cal_characterize()）<br> 返回：<br> 电压 (mV)<br> 参数：<br> [in] adc_reading: ADC 读数<br> [in] chars: 指向包含 ADC 特征的初始化结构的指针<br> <strong>（10）直接获取通道以 mV 为单位的电压。</strong><br> esp_err_t esp_adc_cal_get_voltage(adc_channel_t channel, const esp_adc_cal_characteristics_t *chars, uint32_t *voltage);<br> 这个函数同（9）函数一样都是得到电压，但是（9）传参是ADC的读数，本函数传参是ADC通道<br> 参数<br> [in] channel：要读取的 ADC 通道<br> [in] chars: 指向已初始化 ADC 特征结构的指针<br> [out] voltage：存储转换电压的指针<br> 返回<br> ESP_OK：ADC 读取并转换为 mV<br> ESP_ERR_INVALID_ARG：由于参数无效导致的错误<br> ESP_ERR_INVALID_STATE：读取结果无效。尝试再次阅读。</p> 
<h3><a id="2_175"></a>2.代码示例</h3> 
<p>ADC+DMA<br> my_adc.c</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"my_adc.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">CONFIG_IDF_TARGET_ESP32S2</span></span>
<span class="token keyword">static</span> <span class="token class-name">uint16_t</span> adc1_chan_mask <span class="token operator">=</span> <span class="token function">BIT</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token class-name">uint16_t</span> adc2_chan_mask <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token class-name">adc_channel_t</span> channel<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>ADC1_CHANNEL_0<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">CONFIG_IDF_TARGET_ESP32</span></span>
<span class="token keyword">static</span> <span class="token class-name">uint16_t</span> adc1_chan_mask <span class="token operator">=</span> <span class="token function">BIT</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//</span>
<span class="token keyword">static</span> <span class="token class-name">uint16_t</span> adc2_chan_mask <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token class-name">adc_channel_t</span> channel<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>ADC1_CHANNEL_0<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>


<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">continuous_adc_init</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> adc1_chan_mask<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> adc2_chan_mask<span class="token punctuation">,</span> <span class="token class-name">adc_channel_t</span> <span class="token operator">*</span>channel<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> channel_num<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">adc_digi_init_config_t</span> adc_dma_config <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span>max_store_buf_size <span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">,</span><span class="token comment">//可以传输的字节大小</span>
        <span class="token punctuation">.</span>conv_num_each_intr <span class="token operator">=</span> TIMES<span class="token punctuation">,</span><span class="token comment">//一個中斷可以转换的字節數</span>
        <span class="token punctuation">.</span>adc1_chan_mask <span class="token operator">=</span> adc1_chan_mask<span class="token punctuation">,</span><span class="token comment">//待初始化的通道列表</span>
        <span class="token punctuation">.</span>adc2_chan_mask <span class="token operator">=</span> adc2_chan_mask<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">ESP_ERROR_CHECK</span><span class="token punctuation">(</span><span class="token function">adc_digi_initialize</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>adc_dma_config<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">adc_digi_configuration_t</span> dig_cfg <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span>conv_limit_en <span class="token operator">=</span> ADC_CONV_LIMIT_EN<span class="token punctuation">,</span><span class="token comment">//限制ADC转换的次数，在转换conv_limit_num之后就会停止，选择是否使能</span>
        <span class="token punctuation">.</span>conv_limit_num <span class="token operator">=</span> <span class="token number">250</span><span class="token punctuation">,</span><span class="token comment">//设置ADC触发器的上限</span>
        <span class="token punctuation">.</span>sample_freq_hz <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span><span class="token comment">//ADC采样频率</span>
        <span class="token punctuation">.</span>conv_mode <span class="token operator">=</span> ADC_CONV_MODE<span class="token punctuation">,</span><span class="token comment">//选择DMA转换模式，选择使用哪个ADC或者都使用</span>
        <span class="token punctuation">.</span>format <span class="token operator">=</span> ADC_OUTPUT_TYPE<span class="token punctuation">,</span><span class="token comment">//设置数据输出格式</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name">adc_digi_pattern_config_t</span> adc_pattern<span class="token punctuation">[</span>SOC_ADC_PATT_LEN_MAX<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//将使用ADC通道的配置列表</span>
    dig_cfg<span class="token punctuation">.</span>pattern_num <span class="token operator">=</span> channel_num<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> channel_num<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">uint8_t</span> unit <span class="token operator">=</span> <span class="token function">GET_UNIT</span><span class="token punctuation">(</span>channel<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">uint8_t</span> ch <span class="token operator">=</span> channel<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0x7</span><span class="token punctuation">;</span><span class="token comment">//ADC通道，总共0-7八个通道，只看后三位</span>
        adc_pattern<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>atten <span class="token operator">=</span> ADC_ATTEN_DB_11<span class="token punctuation">;</span><span class="token comment">//衰减</span>
        adc_pattern<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>channel <span class="token operator">=</span> ch<span class="token punctuation">;</span><span class="token comment">//通道</span>
        adc_pattern<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>unit <span class="token operator">=</span> unit<span class="token punctuation">;</span><span class="token comment">//索引</span>
        adc_pattern<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>bit_width <span class="token operator">=</span> SOC_ADC_DIGI_MAX_BITWIDTH<span class="token punctuation">;</span><span class="token comment">//设置位宽为最大宽度</span>

        <span class="token function">ESP_LOGI</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"adc_pattern[%d].atten is :%x"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> adc_pattern<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>atten<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ESP_LOGI</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"adc_pattern[%d].channel is :%x"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> adc_pattern<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ESP_LOGI</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"adc_pattern[%d].unit is :%x"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> adc_pattern<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    dig_cfg<span class="token punctuation">.</span>adc_pattern <span class="token operator">=</span> adc_pattern<span class="token punctuation">;</span>
    <span class="token function">ESP_ERROR_CHECK</span><span class="token punctuation">(</span><span class="token function">adc_digi_controller_configure</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dig_cfg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


bool <span class="token function">check_valid_data</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">adc_digi_output_data_t</span> <span class="token operator">*</span>data<span class="token punctuation">)</span><span class="token comment">//判断数据是不是有效的</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> unit <span class="token operator">=</span> data<span class="token operator">-&gt;</span>type2<span class="token punctuation">.</span>unit<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>unit <span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> false<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token operator">-&gt;</span>type2<span class="token punctuation">.</span>channel <span class="token operator">&gt;=</span> <span class="token function">SOC_ADC_CHANNEL_NUM</span><span class="token punctuation">(</span>unit<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> false<span class="token punctuation">;</span><span class="token comment">//判断通道数是不是配置多了</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> true<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">my_adc_dma_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">continuous_adc_init</span><span class="token punctuation">(</span>adc1_chan_mask<span class="token punctuation">,</span> adc2_chan_mask<span class="token punctuation">,</span> channel<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">adc_channel_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化配置</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>main.c</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"my_adc.h"</span></span>

<span class="token comment">// #define LEDC_MAX_DUTY   (8191)</span>
<span class="token comment">// #define LEDC_FADE_TIME  (1000)</span>
<span class="token keyword">void</span> <span class="token function">app_main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">esp_err_t</span> ret<span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> ret_num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> result<span class="token punctuation">[</span>TIMES<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token number">0xcc</span><span class="token punctuation">,</span> TIMES<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//把数组result里面的times个值都初始化成0xcc=204;</span>
    <span class="token comment">// continuous_adc_init(adc1_chan_mask, adc2_chan_mask, channel, sizeof(channel) / sizeof(adc_channel_t));//初始化配置</span>
    <span class="token function">my_adc_dma_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">adc_digi_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//启动转换</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        ret <span class="token operator">=</span> <span class="token function">adc_digi_read_bytes</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> TIMES<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ret_num<span class="token punctuation">,</span> ADC_MAX_DELAY<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读取转换数据，数据存在result里面，预期是256个，实际是ret_num个。转换超时时间限制是最大</span>
        <span class="token comment">//判断adc_digi_read_bytes返回的参数，成功、驱动设备未安装（残阳速率大于任务处理速率）、超时</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> ESP_OK <span class="token operator">||</span> ret <span class="token operator">==</span> ESP_ERR_INVALID_STATE<span class="token punctuation">)</span> 
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> ESP_ERR_INVALID_STATE<span class="token punctuation">)</span> 
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">/**
                 * 对于普通的只打印任务处理速率还是很快的
                 * 
                 * @note 1
                 * Issue:
                 * As an example, we simply print the result out, which is super slow. Therefore the conversion is too
                 * fast for the task to handle. In this condition, some conversion results lost.
                 *
                 * Reason:
                 * When this error occurs, you will usually see the task watchdog timeout issue also.
                 * Because the conversion is too fast, whereas the task calling `adc_digi_read_bytes` is slow.
                 * So `adc_digi_read_bytes` will hardly block. Therefore Idle Task hardly has chance to run. In this
                 * example, we add a `vTaskDelay(1)` below, to prevent the task watchdog timeout.
                 *
                 * Solution:
                 * Either decrease the conversion speed, or increase the frequency you call `adc_digi_read_bytes`
                 */</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ERROR:请降低转换速度,或者增加调用adc_digi_read_bytes的频率\n"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ret_num<span class="token punctuation">;</span> i <span class="token operator">+=</span> ADC_RESULT_BYTE<span class="token punctuation">)</span> 
            <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">adc_digi_output_data_t</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>result<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//把result中的数据传到adc_digi_output_data_t中，（void*）就是可以把数据转换成任意类型的数据</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">CONFIG_IDF_TARGET_ESP32</span></span>
                <span class="token function">ESP_LOGI</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Unit: %d, Channel: %d, Value: %x"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>type1<span class="token punctuation">.</span>channel<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>type1<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//如果选择的是ESP32那么输出使用的哪个ADC的哪个通道以及那种类型的数据</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ADC_CONV_MODE <span class="token operator">==</span> ADC_CONV_BOTH_UNIT <span class="token operator">||</span> ADC_CONV_MODE <span class="token operator">==</span> ADC_CONV_ALTER_UNIT<span class="token punctuation">)</span> <span class="token comment">//判断ADC转换模式时ADC1、2,或者是轮流转换</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//判断数据是否有效</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">check_valid_data</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token function">ESP_LOGI</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Unit: %d,_Channel: %d, Value: %x"</span><span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>type2<span class="token punctuation">.</span>unit<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>type2<span class="token punctuation">.</span>channel<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>type2<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//输出有效数据</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> 
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// abort();</span>
                        <span class="token function">ESP_LOGI</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Invalid data [%d_%d_%x]"</span><span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>type2<span class="token punctuation">.</span>unit<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>type2<span class="token punctuation">.</span>channel<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>type2<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//输出数据无效</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">CONFIG_IDF_TARGET_ESP32S2</span></span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ADC_CONV_MODE <span class="token operator">==</span> ADC_CONV_SINGLE_UNIT_2<span class="token punctuation">)</span> 
                <span class="token punctuation">{<!-- --></span>
                    <span class="token function">ESP_LOGI</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Unit: %d, Channel: %d, Value: %x"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>type1<span class="token punctuation">.</span>channel<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>type1<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ADC_CONV_MODE <span class="token operator">==</span> ADC_CONV_SINGLE_UNIT_1<span class="token punctuation">)</span> 
                <span class="token punctuation">{<!-- --></span>
                    <span class="token function">ESP_LOGI</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Unit: %d, Channel: %d, Value: %d"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>type1<span class="token punctuation">.</span>channel<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>type1<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>  <span class="token comment">//#if CONFIG_IDF_TARGET_ESP32S2</span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
            <span class="token punctuation">}</span>
            <span class="token comment">//See `note 1`</span>
            <span class="token function">vTaskDelay</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//程序运行太快，防止任务看门狗超时</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> ESP_ERR_TIMEOUT<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">/**
             * ``ESP_ERR_TIMEOUT``: If ADC conversion is not finished until Timeout, you'll get this return error.
             * Here we set Timeout ``portMAX_DELAY``, so you'll never reach this branch.
             */</span>
            <span class="token function">ESP_LOGW</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"No data, increase timeout or reduce conv_num_each_intr"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">vTaskDelay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>  
    <span class="token function">adc_digi_stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">adc_digi_deinitialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> ESP_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


</code></pre> 
<h2><a id="_338"></a>总结</h2> 
<p>完整代码工程在这里：<a href="https://gitee.com/zhaidayu/esp32code.git" rel="nofollow">代码</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9f87eaa02b1a442d1e13b73d5a5fa140/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">C语言32个关键字详解</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/12051bcaa36ea0d3780ee9149e22765a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">WASM反编译，WASM逆向</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>