<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>五、helm部署 prometheus-operator - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="五、helm部署 prometheus-operator" />
<meta property="og:description" content="一、了解Prometheus概念二、认识Prometheus Operator1、安装Prometheus软件1.1、利用helm3进行安装1.2、发布prometheus和Grafana的svc1.3、卸载方法 2、模拟业务监控2.1、模拟发布业务pod2.2、添加servicemonitors采集监控指标2.3、可以通过prometheus查看 3、配置告警3.1、告警模板文件 template.tmpl3.2、config.yaml3.3、创建webhook挂载configmap3.4、配置alertmanager.yaml使用webhook3.5、创建告警3.5、group_wait和repeat_interval讲解3.6、其他相关告警配置参数含义3.7、告警状态含义 4、告警模板讲解4.1、if/else语句4.2、Range语法4.3、比较语法4.4、逻辑运算4.5、内置函数4.6、移除空格4.7、模板数据结构介绍 Prometheus是一个用于监控和告警的开源系统。一开始由Soundcloud开发，后来在2016年，它迁移到CNCF并且称为Kubernetes之后最流行的项目之一。从整个Linux服务器到stand-alone web服务器、数据库服务或一个单独的进程，它都能监控。在Prometheus术语中，它所监控的事物称为目标（Target）。每个目标单元被称为指标（metric）。它以设置好的时间间隔通过http抓取目标，以收集指标并将数据放置在其时序数据库（Time Series Database）中。可以使用PromQL查询语言查询相关target的指标。 一、了解Prometheus概念 组成Prometheus生态的组件：
1、 了解prometheus相关术语：
Prometheus Server：在时序数据库中抓取和存储指标的主要组件
抓取：一种拉取方法以获取指标。它通常以10-60秒的时间间隔抓取。
Target：检索数据的server客户端
服务发现：启用Prometheus，使其能够识别它需要监控的应用程序并在动态环境中拉取指标
Alert Manager：负责处理警报的组件（包括silencing、inhibition、聚合告警信息，并通过邮件、PagerDuty、Slack等方式发送告警通知）。
数据可视化：抓取的数据存储在本地存储中，并使用PromQL直接查询，或通过Grafana dashboard查看。
二、认识Prometheus Operator 根据Prometheus Operator的项目所有者CoreOS称，Prometheus Operator可以配置原生Kubernetes并且可以管理和操作Prometheus和Alertmanager集群。
该Operator引入了以下Kubernetes自定义资源定义（CRDs）：Prometheus、ServiceMonitor、PrometheusRule和Alertmanager。如果你想了解更多内容可以访问链接
1、安装： stable/prometheus-operator Helm chart来安装Prometheus Operator
下载链接：https://github.com/helm/charts/tree/master/stable/prometheus-operator
默认安装程序将会部署以下组件：prometheus-operator、prometheus、alertmanager、node-exporter、kube-state-metrics以及grafana。默认状态下，Prometheus将会抓取Kubernetes的主要组件：kube-apiserver、kube-controller-manager以及etcd。 1、安装Prometheus软件 1.1、利用helm3进行安装 查看helm是否安装，这里使用的是helm3（helm2与helm3有很大区别，需要注意） ~]# helm version version.BuildInfo{Version:&#34;v3.0.0&#34;, GitCommit:&#34;e29ce2a54e96cd02ccfce88bee4f58bb6e2a28b6&#34;, GitTreeState:&#34;clean&#34;, GoVersion:&#34;go1.13.4&#34;} 添加helm仓库 helm repo add stable http://mirror.azure.cn/kubernetes/charts helm repo add prometheus-community https://prometheus-community.github.io/helm-charts helm repo update helm search repo prometheus-community 部署prometheus 如果想要提前自定义配置，可以把chart包下载下来
# helm pull prometheus-community/prometheus-operator（可选）" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/6de43ad2ad1dd1ced28d8bb94832e85d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-10-31T09:54:58+08:00" />
<meta property="article:modified_time" content="2021-10-31T09:54:58+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">五、helm部署 prometheus-operator</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4> </h4> 
 <ul><li><a href="#Prometheus_7" rel="nofollow">一、了解Prometheus概念</a></li><li><a href="#Prometheus_Operator_25" rel="nofollow">二、认识Prometheus Operator</a></li><li><ul><li><a href="#1Prometheus_37" rel="nofollow">1、安装Prometheus软件</a></li><li><ul><li><a href="#11helm3_38" rel="nofollow">1.1、利用helm3进行安装</a></li><li><a href="#12prometheusGrafanasvc_60" rel="nofollow">1.2、发布prometheus和Grafana的svc</a></li><li><a href="#13_107" rel="nofollow">1.3、卸载方法</a></li></ul> 
   </li><li><a href="#2_131" rel="nofollow">2、模拟业务监控</a></li><li><ul><li><a href="#21pod_132" rel="nofollow">2.1、模拟发布业务pod</a></li><li><a href="#22servicemonitors_190" rel="nofollow">2.2、添加servicemonitors采集监控指标</a></li><li><a href="#23prometheus_213" rel="nofollow">2.3、可以通过prometheus查看</a></li></ul> 
   </li><li><a href="#3_216" rel="nofollow">3、配置告警</a></li><li><ul><li><a href="#31_templatetmpl_219" rel="nofollow">3.1、告警模板文件 template.tmpl</a></li><li><a href="#32configyaml_307" rel="nofollow">3.2、config.yaml</a></li><li><a href="#33webhookconfigmap_342" rel="nofollow">3.3、创建webhook挂载configmap</a></li><li><a href="#34alertmanageryamlwebhook_402" rel="nofollow">3.4、配置alertmanager.yaml使用webhook</a></li><li><a href="#35_469" rel="nofollow">3.5、创建告警</a></li><li><a href="#35group_waitrepeat_interval_538" rel="nofollow">3.5、group_wait和repeat_interval讲解</a></li><li><a href="#36_559" rel="nofollow">3.6、其他相关告警配置参数含义</a></li><li><a href="#37_567" rel="nofollow">3.7、告警状态含义</a></li></ul> 
   </li><li><a href="#4_572" rel="nofollow">4、告警模板讲解</a></li><li><ul><li><a href="#41ifelse_593" rel="nofollow">4.1、if/else语句</a></li><li><a href="#42Range_614" rel="nofollow">4.2、Range语法</a></li><li><a href="#43_630" rel="nofollow">4.3、比较语法</a></li><li><a href="#44_643" rel="nofollow">4.4、逻辑运算</a></li><li><a href="#45_662" rel="nofollow">4.5、内置函数</a></li><li><a href="#46_675" rel="nofollow">4.6、移除空格</a></li><li><a href="#47_683" rel="nofollow">4.7、模板数据结构介绍</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<ul><li>Prometheus是一个用于监控和告警的开源系统。</li><li>一开始由Soundcloud开发，后来在2016年，它迁移到CNCF并且称为Kubernetes之后最流行的项目之一。从整个Linux服务器到stand-alone web服务器、数据库服务或一个单独的进程，它都能监控。</li><li>在Prometheus术语中，它所监控的事物称为目标（Target）。每个目标单元被称为指标（metric）。它以设置好的时间间隔通过http抓取目标，以收集指标并将数据放置在其时序数据库（Time Series Database）中。</li><li>可以使用PromQL查询语言查询相关target的指标。</li></ul> 
<h2><a id="Prometheus_7"></a>一、了解Prometheus概念</h2> 
<ul><li>组成Prometheus生态的组件：<br> <img src="https://images2.imgbox.com/15/06/lgYRuZPT_o.png" alt="在这里插入图片描述"></li></ul> 
<p>1、 了解prometheus相关术语：</p> 
<ul><li> <p>Prometheus Server：在时序数据库中抓取和存储指标的主要组件</p> 
  <ul><li> <p>抓取：一种拉取方法以获取指标。它通常以10-60秒的时间间隔抓取。</p> </li><li> <p>Target：检索数据的server客户端</p> </li></ul> </li><li> <p>服务发现：启用Prometheus，使其能够识别它需要监控的应用程序并在动态环境中拉取指标</p> </li><li> <p>Alert Manager：负责处理警报的组件（包括silencing、inhibition、聚合告警信息，并通过邮件、PagerDuty、Slack等方式发送告警通知）。</p> </li><li> <p>数据可视化：抓取的数据存储在本地存储中，并使用PromQL直接查询，或通过Grafana dashboard查看。</p> </li></ul> 
<h2><a id="Prometheus_Operator_25"></a>二、认识Prometheus Operator</h2> 
<ul><li> <p>根据Prometheus Operator的项目所有者CoreOS称，Prometheus Operator可以配置原生Kubernetes并且可以管理和操作Prometheus和Alertmanager集群。</p> </li><li> <p>该Operator引入了以下Kubernetes自定义资源定义（CRDs）：Prometheus、ServiceMonitor、PrometheusRule和Alertmanager。<a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/design.md">如果你想了解更多内容可以访问链接</a></p> </li></ul> 
<p>1、安装： stable/prometheus-operator Helm chart来安装Prometheus Operator<br> 下载链接：https://github.com/helm/charts/tree/master/stable/prometheus-operator</p> 
<ul><li>默认安装程序将会部署以下组件：prometheus-operator、prometheus、alertmanager、node-exporter、kube-state-metrics以及grafana。</li><li>默认状态下，Prometheus将会抓取Kubernetes的主要组件：kube-apiserver、kube-controller-manager以及etcd。</li></ul> 
<h3><a id="1Prometheus_37"></a>1、安装Prometheus软件</h3> 
<h4><a id="11helm3_38"></a>1.1、利用helm3进行安装</h4> 
<ul><li>查看helm是否安装，这里使用的是helm3（helm2与helm3有很大区别，需要注意）</li></ul> 
<pre><code class="prism language-shell">~<span class="token punctuation">]</span><span class="token comment"># helm version</span>
version.BuildInfo<span class="token punctuation">{<!-- --></span>Version:<span class="token string">"v3.0.0"</span>, GitCommit:<span class="token string">"e29ce2a54e96cd02ccfce88bee4f58bb6e2a28b6"</span>, GitTreeState:<span class="token string">"clean"</span>, GoVersion:<span class="token string">"go1.13.4"</span><span class="token punctuation">}</span>
</code></pre> 
<ul><li>添加helm仓库</li></ul> 
<pre><code class="prism language-c">helm repo add stable http<span class="token operator">:</span><span class="token comment">//mirror.azure.cn/kubernetes/charts</span>
helm repo add prometheus<span class="token operator">-</span>community https<span class="token operator">:</span><span class="token comment">//prometheus-community.github.io/helm-charts</span>
helm repo update
helm search repo prometheus<span class="token operator">-</span>community
</code></pre> 
<ul><li>部署prometheus</li></ul> 
<blockquote> 
 <p>如果想要提前自定义配置，可以把chart包下载下来<br> <code># helm pull prometheus-community/prometheus-operator（可选）</code></p> 
</blockquote> 
<pre><code class="prism language-c">kubectl create ns monitoring
helm install prometheus<span class="token operator">-</span>operator <span class="token operator">--</span>set rbacEnable<span class="token operator">=</span>true <span class="token operator">--</span>namespace<span class="token operator">=</span>monitoring  <span class="token operator">--</span>wait prometheus<span class="token operator">-</span>community<span class="token operator">/</span>prometheus<span class="token operator">-</span>operator

# 或者 helm install prometheus<span class="token operator">-</span>operator <span class="token operator">--</span>set rbacEnable<span class="token operator">=</span>true <span class="token operator">--</span>namespace<span class="token operator">=</span>monitoring  <span class="token operator">--</span>wait stable<span class="token operator">/</span>prometheus<span class="token operator">-</span>operator
</code></pre> 
<h4><a id="12prometheusGrafanasvc_60"></a>1.2、发布prometheus和Grafana的svc</h4> 
<ul><li>可以通过nodeport或者ingress暴露grafana和prometheus</li></ul> 
<p>1、NodePort的方式发布</p> 
<pre><code class="prism language-c">kubectl <span class="token operator">-</span>n monitoring patch svc prometheus<span class="token operator">-</span>operator<span class="token operator">-</span>grafana <span class="token operator">-</span>p <span class="token string">'{"spec":{"type":"NodePort"}}'</span>
kubectl <span class="token operator">-</span>n monitoring patch svc prometheus<span class="token operator">-</span>operator<span class="token operator">-</span>prometheus <span class="token operator">-</span>p <span class="token string">'{"spec":{"type":"NodePort"}}'</span>
</code></pre> 
<p>2、ingress的方式发布</p> 
<pre><code class="prism language-c"><span class="token operator">--</span><span class="token operator">-</span>
apiVersion<span class="token operator">:</span> extensions<span class="token operator">/</span>v1beta1
kind<span class="token operator">:</span> Ingress
metadata<span class="token operator">:</span>
  name<span class="token operator">:</span> grafana
  namespace<span class="token operator">:</span> monitoring
spec<span class="token operator">:</span>
  rules<span class="token operator">:</span>
  <span class="token operator">-</span> host<span class="token operator">:</span> grafana<span class="token punctuation">.</span>oper<span class="token punctuation">.</span>com
    http<span class="token operator">:</span>
      paths<span class="token operator">:</span>
      <span class="token operator">-</span> backend<span class="token operator">:</span>
          serviceName<span class="token operator">:</span> prometheus<span class="token operator">-</span>operator<span class="token operator">-</span>grafana
          servicePort<span class="token operator">:</span> <span class="token number">80</span>
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion<span class="token operator">:</span> extensions<span class="token operator">/</span>v1beta1
kind<span class="token operator">:</span> Ingress
metadata<span class="token operator">:</span>
  name<span class="token operator">:</span> prometheus
  namespace<span class="token operator">:</span> monitoring
spec<span class="token operator">:</span>
  rules<span class="token operator">:</span>
  <span class="token operator">-</span> host<span class="token operator">:</span> prometheus<span class="token punctuation">.</span>oper<span class="token punctuation">.</span>com
    http<span class="token operator">:</span>
      paths<span class="token operator">:</span>
      <span class="token operator">-</span> backend<span class="token operator">:</span>
          serviceName<span class="token operator">:</span> prometheus<span class="token operator">-</span>operator<span class="token operator">-</span>prometheus
          servicePort<span class="token operator">:</span> <span class="token number">9090</span>

</code></pre> 
<ul><li>获取grafana admin用户密码</li></ul> 
<pre><code class="prism language-c">kubectl  <span class="token operator">-</span>n monitoring get secrets <span class="token operator">|</span>grep Opaque<span class="token operator">|</span>grep grafana<span class="token operator">|</span>awk <span class="token string">'{print $1}'</span><span class="token operator">|</span>xargs kubectl <span class="token operator">-</span>n monitoring get secrets <span class="token operator">-</span>o yaml<span class="token operator">|</span>grep admin<span class="token operator">-</span>password<span class="token operator">|</span>grep <span class="token operator">-</span>v f<span class="token operator">:</span><span class="token operator">|</span>awk <span class="token operator">-</span>F <span class="token string">"admin-password: "</span> <span class="token string">'{print $2}'</span><span class="token operator">|</span>base64 <span class="token operator">-</span>d <span class="token operator">&amp;&amp;</span> echo <span class="token string">''</span>
</code></pre> 
<h4><a id="13_107"></a>1.3、卸载方法</h4> 
<p>1、正常卸载</p> 
<pre><code class="prism language-c">helm <span class="token operator">-</span>n monitoring delete prometheus<span class="token operator">-</span>operator
</code></pre> 
<p>2、若安装失败，执行下面命令进行清理</p> 
<pre><code class="prism language-c"> kubectl <span class="token operator">-</span>n monitoring get deployments<span class="token punctuation">.</span>apps<span class="token operator">|</span>tail <span class="token operator">-</span>n <span class="token operator">+</span><span class="token number">2</span><span class="token operator">|</span>awk <span class="token string">'{print $1}'</span><span class="token operator">|</span>xargs kubectl <span class="token operator">-</span>n monitoring delete deployments<span class="token punctuation">.</span>apps
 kubectl <span class="token operator">-</span>n monitoring get svc<span class="token operator">|</span>tail <span class="token operator">-</span>n <span class="token operator">+</span><span class="token number">2</span><span class="token operator">|</span>awk <span class="token string">'{print $1}'</span><span class="token operator">|</span>xargs kubectl <span class="token operator">-</span>n monitoring delete svc
 kubectl <span class="token operator">-</span>n monitoring get sts<span class="token operator">|</span>tail <span class="token operator">-</span>n <span class="token operator">+</span><span class="token number">2</span><span class="token operator">|</span>awk <span class="token string">'{print $1}'</span><span class="token operator">|</span>xargs kubectl <span class="token operator">-</span>n monitoring delete sts
 kubectl <span class="token operator">-</span>n monitoring get crd<span class="token operator">|</span>tail <span class="token operator">-</span>n <span class="token operator">+</span><span class="token number">2</span><span class="token operator">|</span>awk <span class="token string">'{print $1}'</span><span class="token operator">|</span>xargs kubectl <span class="token operator">-</span>n monitoring delete crd
 kubectl <span class="token operator">-</span>n monitoring get servicemonitorings<span class="token punctuation">.</span>monitoringing<span class="token punctuation">.</span>coreos<span class="token punctuation">.</span>com<span class="token operator">|</span>tail <span class="token operator">-</span>n <span class="token operator">+</span><span class="token number">2</span><span class="token operator">|</span>awk <span class="token string">'{print $1}'</span><span class="token operator">|</span>xargs kubectl <span class="token operator">-</span>n monitoring delete servicemonitorings<span class="token punctuation">.</span>monitoringing<span class="token punctuation">.</span>coreos<span class="token punctuation">.</span>com
 kubectl <span class="token operator">-</span>n monitoring get ds<span class="token operator">|</span>tail <span class="token operator">-</span>n <span class="token operator">+</span><span class="token number">2</span><span class="token operator">|</span>awk <span class="token string">'{print $1}'</span><span class="token operator">|</span>xargs kubectl <span class="token operator">-</span>n monitoring delete ds
 kubectl <span class="token operator">-</span>n monitoring get job<span class="token operator">|</span>tail <span class="token operator">-</span>n <span class="token operator">+</span><span class="token number">2</span><span class="token operator">|</span>awk <span class="token string">'{print $1}'</span><span class="token operator">|</span>xargs kubectl <span class="token operator">-</span>n monitoring delete job
 kubectl <span class="token operator">-</span>n monitoring get pod<span class="token operator">|</span>tail <span class="token operator">-</span>n <span class="token operator">+</span><span class="token number">2</span><span class="token operator">|</span>awk <span class="token string">'{print $1}'</span><span class="token operator">|</span>xargs kubectl <span class="token operator">-</span>n monitoring delete pod
 kubectl get PodSecurityPolicy<span class="token operator">|</span>grep prome<span class="token operator">|</span>awk <span class="token string">'{print $1}'</span><span class="token operator">|</span>xargs kubectl delete podsecuritypolicies<span class="token punctuation">.</span>policy
 kubectl get clusterrole<span class="token operator">|</span>grep prometheus<span class="token operator">|</span>awk <span class="token string">'{print $1}'</span><span class="token operator">|</span>xargs kubectl delete clusterrole
 kubectl get clusterrolebindings<span class="token punctuation">.</span>rbac<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io<span class="token operator">|</span>grep prometheus<span class="token operator">|</span>awk <span class="token string">'{print $1}'</span><span class="token operator">|</span>xargs kubectl delete clusterrolebindings<span class="token punctuation">.</span>rbac<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io
 kubectl  <span class="token operator">-</span>n kube<span class="token operator">-</span>system get svc<span class="token operator">|</span>grep prometheus<span class="token operator">|</span>awk <span class="token string">'{print $1}'</span><span class="token operator">|</span>xargs kubectl <span class="token operator">-</span>n kube<span class="token operator">-</span>system delete svc
 kubectl  <span class="token operator">-</span>n kube<span class="token operator">-</span>system get mutatingwebhookconfigurations<span class="token punctuation">.</span>admissionregistration<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io<span class="token operator">|</span>grep prometheus<span class="token operator">|</span>awk <span class="token string">'{print $1}'</span><span class="token operator">|</span>xargs kubectl delete mutatingwebhookconfigurations<span class="token punctuation">.</span>admissionregistration<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io
 kubectl  <span class="token operator">-</span>n kube<span class="token operator">-</span>system get validatingwebhookconfigurations<span class="token punctuation">.</span>admissionregistration<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io<span class="token operator">|</span>grep prometheus<span class="token operator">|</span>awk <span class="token string">'{print $1}'</span><span class="token operator">|</span>xargs kubectl delete validatingwebhookconfigurations<span class="token punctuation">.</span>admissionregistration<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io
 kubectl delete ns monitoring
</code></pre> 
<h3><a id="2_131"></a>2、模拟业务监控</h3> 
<h4><a id="21pod_132"></a>2.1、模拟发布业务pod</h4> 
<ul><li>demo镜像构建参数：https://github.com/hnlq715/nginx-prometheus-metrics，该镜像会提供一个业务metric</li><li>yaml文件如下</li></ul> 
<pre><code class="prism language-c">apiVersion<span class="token operator">:</span> apps<span class="token operator">/</span>v1
kind<span class="token operator">:</span> Deployment
metadata<span class="token operator">:</span>
  name<span class="token operator">:</span> nginx<span class="token operator">-</span>demo
  labels<span class="token operator">:</span>
    app<span class="token operator">:</span> nginx<span class="token operator">-</span>demo
spec<span class="token operator">:</span>
  replicas<span class="token operator">:</span> <span class="token number">1</span>
  selector<span class="token operator">:</span>
    matchLabels<span class="token operator">:</span>
      app<span class="token operator">:</span> nginx<span class="token operator">-</span>demo
  template<span class="token operator">:</span>
    metadata<span class="token operator">:</span>
      labels<span class="token operator">:</span>
        app<span class="token operator">:</span> nginx<span class="token operator">-</span>demo
    spec<span class="token operator">:</span>
      containers<span class="token operator">:</span>
      <span class="token operator">-</span> name<span class="token operator">:</span> nginx<span class="token operator">-</span>demo
        image<span class="token operator">:</span> registry<span class="token punctuation">.</span>baidubce<span class="token punctuation">.</span>com<span class="token operator">/</span>docker<span class="token operator">-</span>hub<span class="token operator">/</span>nginx<span class="token operator">-</span>prometheus<span class="token operator">-</span>metrics<span class="token operator">:</span>latest
        ports<span class="token operator">:</span>
        <span class="token operator">-</span> name<span class="token operator">:</span> http<span class="token operator">-</span>metrics
          containerPort<span class="token operator">:</span> <span class="token number">9527</span>
        <span class="token operator">-</span> name<span class="token operator">:</span> web
          containerPort<span class="token operator">:</span> <span class="token number">80</span>
        <span class="token operator">-</span> name<span class="token operator">:</span> test
          containerPort<span class="token operator">:</span> <span class="token number">1314</span>
        imagePullPolicy<span class="token operator">:</span> IfNotPresent
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion<span class="token operator">:</span> v1
kind<span class="token operator">:</span> Service
metadata<span class="token operator">:</span>
  labels<span class="token operator">:</span>
    app<span class="token operator">:</span> nginx<span class="token operator">-</span>demo
  name<span class="token operator">:</span> nginx<span class="token operator">-</span>demo
  namespace<span class="token operator">:</span> <span class="token keyword">default</span>
spec<span class="token operator">:</span>
  ports<span class="token operator">:</span>
  <span class="token operator">-</span> name<span class="token operator">:</span> http<span class="token operator">-</span>metrics
    port<span class="token operator">:</span> <span class="token number">9527</span>
    protocol<span class="token operator">:</span> TCP
    targetPort<span class="token operator">:</span> <span class="token number">9527</span>
  <span class="token operator">-</span> name<span class="token operator">:</span> web
    port<span class="token operator">:</span> <span class="token number">80</span>
    protocol<span class="token operator">:</span> TCP
    targetPort<span class="token operator">:</span> <span class="token number">80</span>
  <span class="token operator">-</span> name<span class="token operator">:</span> test
    port<span class="token operator">:</span> <span class="token number">1314</span>
    protocol<span class="token operator">:</span> TCP
    targetPort<span class="token operator">:</span> <span class="token number">1314</span>
  selector<span class="token operator">:</span>
    app<span class="token operator">:</span> nginx<span class="token operator">-</span>demo
  type<span class="token operator">:</span> ClusterIP 

</code></pre> 
<h4><a id="22servicemonitors_190"></a>2.2、添加servicemonitors采集监控指标</h4> 
<pre><code class="prism language-c">apiVersion<span class="token operator">:</span> monitoring<span class="token punctuation">.</span>coreos<span class="token punctuation">.</span>com<span class="token operator">/</span>v1
kind<span class="token operator">:</span> ServiceMonitor
metadata<span class="token operator">:</span>
  labels<span class="token operator">:</span>
    app<span class="token operator">:</span> nginx<span class="token operator">-</span>demo
    release<span class="token operator">:</span> prometheus<span class="token operator">-</span>operator
  name<span class="token operator">:</span> nginx<span class="token operator">-</span>demo
  namespace<span class="token operator">:</span> monitoring
spec<span class="token operator">:</span>
  endpoints<span class="token operator">:</span>
  <span class="token operator">-</span> interval<span class="token operator">:</span> <span class="token number">15</span>s
    port<span class="token operator">:</span> http<span class="token operator">-</span>metrics
  namespaceSelector<span class="token operator">:</span>
    matchNames<span class="token operator">:</span>
    <span class="token operator">-</span> <span class="token keyword">default</span>
  selector<span class="token operator">:</span>
    matchLabels<span class="token operator">:</span>
      app<span class="token operator">:</span> nginx<span class="token operator">-</span>demo

</code></pre> 
<h4><a id="23prometheus_213"></a>2.3、可以通过prometheus查看</h4> 
<p><img src="https://images2.imgbox.com/ba/ff/oPWCuGnV_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3_216"></a>3、配置告警</h3> 
<ul><li>准备template.tmpl和config.yaml的configmap</li><li>创建webhook挂载上面的configmap</li></ul> 
<h4><a id="31_templatetmpl_219"></a>3.1、告警模板文件 template.tmpl</h4> 
<pre><code class="prism language-c">apiVersion<span class="token operator">:</span> v1
kind<span class="token operator">:</span> ConfigMap
metadata<span class="token operator">:</span>
  namespace<span class="token operator">:</span> monitoring
  name<span class="token operator">:</span> dingtalk<span class="token operator">-</span>webhook<span class="token operator">-</span>template
data<span class="token operator">:</span>
  template<span class="token punctuation">.</span>tmpl<span class="token operator">:</span> <span class="token operator">|</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> define <span class="token string">"__subject"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>Status <span class="token operator">|</span> toUpper <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token keyword">if</span> eq <span class="token punctuation">.</span>Status <span class="token string">"firing"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>Alerts<span class="token punctuation">.</span>Firing <span class="token operator">|</span> len <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> end <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>GroupLabels<span class="token punctuation">.</span>SortedPairs<span class="token punctuation">.</span>Values     <span class="token operator">|</span> join <span class="token string">" "</span> <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token keyword">if</span> <span class="token function">gt</span> <span class="token punctuation">(</span>len <span class="token punctuation">.</span>CommonLabels<span class="token punctuation">)</span> <span class="token punctuation">(</span>len <span class="token punctuation">.</span>GroupLabels<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> with <span class="token punctuation">.</span>CommonLabels<span class="token punctuation">.</span>Remove <span class="token punctuation">.</span>GroupLabels<span class="token punctuation">.</span>Names <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>Values <span class="token operator">|</span> join <span class="token string">" "</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> end     <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> end <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> define <span class="token string">"__alertmanagerURL"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>ExternalURL <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">/</span>#<span class="token operator">/</span>alerts<span class="token operator">?</span>receiver<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>Receiver <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>

    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> define <span class="token string">"__text_alert_list"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> range <span class="token punctuation">.</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token operator">*</span><span class="token operator">*</span>Labels<span class="token operator">*</span><span class="token operator">*</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> range <span class="token punctuation">.</span>Labels<span class="token punctuation">.</span>SortedPairs <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&amp;</span>gt<span class="token punctuation">;</span> <span class="token operator">-</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>Name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>Value <span class="token operator">|</span> markdown <span class="token operator">|</span> html <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token operator">*</span><span class="token operator">*</span>Annotations<span class="token operator">*</span><span class="token operator">*</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> range <span class="token punctuation">.</span>Annotations<span class="token punctuation">.</span>SortedPairs <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&amp;</span>gt<span class="token punctuation">;</span> <span class="token operator">-</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>Name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>Value <span class="token operator">|</span> markdown <span class="token operator">|</span> html <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token operator">*</span><span class="token operator">*</span>Source<span class="token operator">:</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>GeneratorURL <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>GeneratorURL <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> end <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>

    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> define <span class="token string">"default.__text_alert_list"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> range <span class="token punctuation">.</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token operator">--</span><span class="token operator">-</span>
    <span class="token operator">*</span><span class="token operator">*</span>告警级别<span class="token operator">:</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>Labels<span class="token punctuation">.</span>severity <span class="token operator">|</span> upper <span class="token punctuation">}</span><span class="token punctuation">}</span>

    <span class="token operator">*</span><span class="token operator">*</span>运营团队<span class="token operator">:</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>Labels<span class="token punctuation">.</span>team <span class="token operator">|</span> upper <span class="token punctuation">}</span><span class="token punctuation">}</span>

    <span class="token operator">*</span><span class="token operator">*</span>触发时间<span class="token operator">:</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> dateInZone <span class="token string">"2006.01.02 15:04:05"</span> <span class="token punctuation">(</span><span class="token punctuation">.</span>StartsAt<span class="token punctuation">)</span> <span class="token string">"Asia/Shanghai"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>

    <span class="token operator">*</span><span class="token operator">*</span>事件信息<span class="token operator">:</span><span class="token operator">*</span><span class="token operator">*</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> range <span class="token punctuation">.</span>Annotations<span class="token punctuation">.</span>SortedPairs <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&amp;</span>gt<span class="token punctuation">;</span> <span class="token operator">-</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>Name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>Value <span class="token operator">|</span> markdown <span class="token operator">|</span> html <span class="token punctuation">}</span><span class="token punctuation">}</span>

    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>

    <span class="token operator">*</span><span class="token operator">*</span>事件标签<span class="token operator">:</span><span class="token operator">*</span><span class="token operator">*</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> range <span class="token punctuation">.</span>Labels<span class="token punctuation">.</span>SortedPairs <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token keyword">if</span> <span class="token function">and</span> <span class="token punctuation">(</span><span class="token function">ne</span> <span class="token punctuation">(</span><span class="token punctuation">.</span>Name<span class="token punctuation">)</span> <span class="token string">"severity"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">ne</span> <span class="token punctuation">(</span><span class="token punctuation">.</span>Name<span class="token punctuation">)</span> <span class="token string">"summary"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">ne</span> <span class="token punctuation">(</span><span class="token punctuation">.</span>Name<span class="token punctuation">)</span> <span class="token string">"team"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&amp;</span>gt<span class="token punctuation">;</span> <span class="token operator">-</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>Name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>Value <span class="token operator">|</span>     markdown <span class="token operator">|</span> html <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> end <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> define <span class="token string">"default.__text_alertresovle_list"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> range <span class="token punctuation">.</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token operator">--</span><span class="token operator">-</span>
    <span class="token operator">*</span><span class="token operator">*</span>告警级别<span class="token operator">:</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>Labels<span class="token punctuation">.</span>severity <span class="token operator">|</span> upper <span class="token punctuation">}</span><span class="token punctuation">}</span>

    <span class="token operator">*</span><span class="token operator">*</span>运营团队<span class="token operator">:</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>Labels<span class="token punctuation">.</span>team <span class="token operator">|</span> upper <span class="token punctuation">}</span><span class="token punctuation">}</span>

    <span class="token operator">*</span><span class="token operator">*</span>触发时间<span class="token operator">:</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> dateInZone <span class="token string">"2006.01.02 15:04:05"</span> <span class="token punctuation">(</span><span class="token punctuation">.</span>StartsAt<span class="token punctuation">)</span> <span class="token string">"Asia/Shanghai"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>

    <span class="token operator">*</span><span class="token operator">*</span>结束时间<span class="token operator">:</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> dateInZone <span class="token string">"2006.01.02 15:04:05"</span> <span class="token punctuation">(</span><span class="token punctuation">.</span>EndsAt<span class="token punctuation">)</span> <span class="token string">"Asia/Shanghai"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>

    <span class="token operator">*</span><span class="token operator">*</span>事件信息<span class="token operator">:</span><span class="token operator">*</span><span class="token operator">*</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> range <span class="token punctuation">.</span>Annotations<span class="token punctuation">.</span>SortedPairs <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&amp;</span>gt<span class="token punctuation">;</span> <span class="token operator">-</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>Name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>Value <span class="token operator">|</span> markdown <span class="token operator">|</span> html <span class="token punctuation">}</span><span class="token punctuation">}</span>

    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>

    <span class="token operator">*</span><span class="token operator">*</span>事件标签<span class="token operator">:</span><span class="token operator">*</span><span class="token operator">*</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> range <span class="token punctuation">.</span>Labels<span class="token punctuation">.</span>SortedPairs <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token keyword">if</span> <span class="token function">and</span> <span class="token punctuation">(</span><span class="token function">ne</span> <span class="token punctuation">(</span><span class="token punctuation">.</span>Name<span class="token punctuation">)</span> <span class="token string">"severity"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">ne</span> <span class="token punctuation">(</span><span class="token punctuation">.</span>Name<span class="token punctuation">)</span> <span class="token string">"summary"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">ne</span> <span class="token punctuation">(</span><span class="token punctuation">.</span>Name<span class="token punctuation">)</span> <span class="token string">"team"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&amp;</span>gt<span class="token punctuation">;</span> <span class="token operator">-</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>Name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>Value <span class="token operator">|</span>     markdown <span class="token operator">|</span> html <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> end <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>

    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token comment">/* Default */</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> define <span class="token string">"default.title"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> template <span class="token string">"__subject"</span> <span class="token punctuation">.</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> define <span class="token string">"default.content"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>#### \<span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>Status <span class="token operator">|</span> toUpper <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token keyword">if</span> eq <span class="token punctuation">.</span>Status <span class="token string">"firing"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>Alerts<span class="token punctuation">.</span>Firing <span class="token operator">|</span> len <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>\<span class="token punctuation">]</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> index     <span class="token punctuation">.</span>GroupLabels <span class="token string">"alertname"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> template <span class="token string">"__alertmanagerURL"</span> <span class="token punctuation">.</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">*</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token keyword">if</span> <span class="token function">gt</span> <span class="token punctuation">(</span>len <span class="token punctuation">.</span>Alerts<span class="token punctuation">.</span>Firing<span class="token punctuation">)</span> <span class="token number">0</span> <span class="token operator">-</span><span class="token punctuation">}</span><span class="token punctuation">}</span>

    <span class="token operator">*</span><span class="token operator">*=</span><span class="token operator">==</span><span class="token operator">=</span>侦测到故障<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">*</span><span class="token operator">*</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> template <span class="token string">"default.__text_alert_list"</span> <span class="token punctuation">.</span>Alerts<span class="token punctuation">.</span>Firing <span class="token punctuation">}</span><span class="token punctuation">}</span>

    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token operator">-</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>

    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token keyword">if</span> <span class="token function">gt</span> <span class="token punctuation">(</span>len <span class="token punctuation">.</span>Alerts<span class="token punctuation">.</span>Resolved<span class="token punctuation">)</span> <span class="token number">0</span> <span class="token operator">-</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> template <span class="token string">"default.__text_alertresovle_list"</span> <span class="token punctuation">.</span>Alerts<span class="token punctuation">.</span>Resolved <span class="token punctuation">}</span><span class="token punctuation">}</span>

    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token operator">-</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token operator">-</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>

    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token comment">/* Legacy */</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> define <span class="token string">"legacy.title"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> template <span class="token string">"__subject"</span> <span class="token punctuation">.</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> define <span class="token string">"legacy.content"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>#### \<span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>Status <span class="token operator">|</span> toUpper <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token keyword">if</span> eq <span class="token punctuation">.</span>Status <span class="token string">"firing"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>Alerts<span class="token punctuation">.</span>Firing <span class="token operator">|</span> len <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>\<span class="token punctuation">]</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> index     <span class="token punctuation">.</span>GroupLabels <span class="token string">"alertname"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> template <span class="token string">"__alertmanagerURL"</span> <span class="token punctuation">.</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">*</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> template <span class="token string">"__text_alert_list"</span> <span class="token punctuation">.</span>Alerts<span class="token punctuation">.</span>Firing <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token operator">-</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>

    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token comment">/* Following names for compatibility */</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> define <span class="token string">"ding.link.title"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> template <span class="token string">"default.title"</span> <span class="token punctuation">.</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> define <span class="token string">"ding.link.content"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> template <span class="token string">"default.content"</span> <span class="token punctuation">.</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>

</code></pre> 
<h4><a id="32configyaml_307"></a>3.2、config.yaml</h4> 
<pre><code class="prism language-c">apiVersion<span class="token operator">:</span> v1
kind<span class="token operator">:</span> ConfigMap
metadata<span class="token operator">:</span>
  namespace<span class="token operator">:</span> monitoring
  name<span class="token operator">:</span> dingtalk<span class="token operator">-</span>webhook<span class="token operator">-</span>config
data<span class="token operator">:</span>
  config<span class="token punctuation">.</span>yml<span class="token operator">:</span> <span class="token operator">|</span>
    <span class="token macro property"><span class="token directive-hash">#</span> <span class="token expression">Request timeout</span></span>
    timeout<span class="token operator">:</span> <span class="token number">5</span>s

    ## Customizable templates path
    templates<span class="token operator">:</span>
    <span class="token operator">-</span> <span class="token operator">/</span>etc<span class="token operator">/</span>prometheus<span class="token operator">-</span>webhook<span class="token operator">-</span>dingtalk<span class="token operator">/</span>templates<span class="token comment">/*.tmpl

    ## You can also override default template using `default_message`
    ## The following example to use the 'legacy' template from v0.3.0
    # default_message:
    #   title: '{<!-- -->{ template "legacy.title" . }}'
    #   text: '{<!-- -->{ template "legacy.content" . }}'

    ## Targets, previously was known as "profiles"
    targets:
      webhook-dingtalk:
        url: https://oapi.dingtalk.com/robot/send?access_token=xxxx #钉钉webhook地址
        message:
          title: '{<!-- -->{ template "ding.link.title" . }}'
          text: '{<!-- -->{ template "ding.link.content" . }}'
        mention:
          all: true
          mobiles: ['135xxxxxxxx']

</span></code></pre> 
<h4><a id="33webhookconfigmap_342"></a>3.3、创建webhook挂载configmap</h4> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">cat</span> <span class="token expression">webhook<span class="token operator">-</span>deployment<span class="token punctuation">.</span>yaml</span></span>

apiVersion<span class="token operator">:</span> apps<span class="token operator">/</span>v1
kind<span class="token operator">:</span> Deployment
metadata<span class="token operator">:</span>
  namespace<span class="token operator">:</span> monitoring
  name<span class="token operator">:</span> dingtalk<span class="token operator">-</span>webhook
  labels<span class="token operator">:</span>
    app<span class="token operator">:</span> dingtalk<span class="token operator">-</span>webhook
spec<span class="token operator">:</span>
  selector<span class="token operator">:</span>
    matchLabels<span class="token operator">:</span>
      app<span class="token operator">:</span> dingtalk<span class="token operator">-</span>webhook
  replicas<span class="token operator">:</span> <span class="token number">1</span>
  template<span class="token operator">:</span>
    metadata<span class="token operator">:</span>
      labels<span class="token operator">:</span>
        app<span class="token operator">:</span> dingtalk<span class="token operator">-</span>webhook
    spec<span class="token operator">:</span>
      containers<span class="token operator">:</span>
      <span class="token operator">-</span> name<span class="token operator">:</span> dingtalk<span class="token operator">-</span>webhook
        image<span class="token operator">:</span> registry<span class="token punctuation">.</span>baidubce<span class="token punctuation">.</span>com<span class="token operator">/</span>docker<span class="token operator">-</span>hub<span class="token operator">/</span>timonwong<span class="token operator">/</span>prometheus<span class="token operator">-</span>webhook<span class="token operator">-</span>dingtalk<span class="token operator">:</span>v1<span class="token punctuation">.</span><span class="token number">4.0</span>
        args<span class="token operator">:</span>
        <span class="token operator">-</span> <span class="token operator">--</span>config<span class="token punctuation">.</span>file<span class="token operator">=</span><span class="token operator">/</span>etc<span class="token operator">/</span>prometheus<span class="token operator">-</span>webhook<span class="token operator">-</span>dingtalk<span class="token operator">/</span>config<span class="token punctuation">.</span>yml
        ports<span class="token operator">:</span>
        <span class="token operator">-</span> containerPort<span class="token operator">:</span> <span class="token number">8060</span>
          protocol<span class="token operator">:</span> TCP
        volumeMounts<span class="token operator">:</span>
        <span class="token operator">-</span> name<span class="token operator">:</span> dingtalk<span class="token operator">-</span>webhook<span class="token operator">-</span>confing
          mountPath<span class="token operator">:</span> <span class="token string">"/etc/prometheus-webhook-dingtalk"</span>
        <span class="token operator">-</span> name<span class="token operator">:</span> dingtalk<span class="token operator">-</span>webhook<span class="token operator">-</span>template
          mountPath<span class="token operator">:</span> <span class="token string">"/etc/prometheus-webhook-dingtalk/templates"</span>
      volumes<span class="token operator">:</span>
      <span class="token operator">-</span> name<span class="token operator">:</span> dingtalk<span class="token operator">-</span>webhook<span class="token operator">-</span>confing
        configMap<span class="token operator">:</span>
          name<span class="token operator">:</span> dingtalk<span class="token operator">-</span>webhook<span class="token operator">-</span>config
      <span class="token operator">-</span> name<span class="token operator">:</span> dingtalk<span class="token operator">-</span>webhook<span class="token operator">-</span>template
        configMap<span class="token operator">:</span>
          name<span class="token operator">:</span> dingtalk<span class="token operator">-</span>webhook<span class="token operator">-</span>template
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion<span class="token operator">:</span> v1
kind<span class="token operator">:</span> Service
metadata<span class="token operator">:</span>
  namespace<span class="token operator">:</span> monitoring
  name<span class="token operator">:</span> dingtalk<span class="token operator">-</span>webhook
  labels<span class="token operator">:</span>
    app<span class="token operator">:</span> dingtalk<span class="token operator">-</span>webhook
spec<span class="token operator">:</span>
  selector<span class="token operator">:</span>
    app<span class="token operator">:</span> dingtalk<span class="token operator">-</span>webhook
  ports<span class="token operator">:</span>
  <span class="token operator">-</span> name<span class="token operator">:</span> http
    port<span class="token operator">:</span> <span class="token number">8060</span>
    targetPort<span class="token operator">:</span> <span class="token number">8060</span>
    protocol<span class="token operator">:</span> TCP

</code></pre> 
<h4><a id="34alertmanageryamlwebhook_402"></a>3.4、配置alertmanager.yaml使用webhook</h4> 
<ul><li>获取alertmanager.yaml现有配置</li></ul> 
<pre><code class="prism language-c">kubectl <span class="token operator">-</span>n monitoring get secrets  alertmanager<span class="token operator">-</span>prometheus<span class="token operator">-</span>operator<span class="token operator">-</span>alertmanager  <span class="token operator">-</span>o yaml<span class="token operator">|</span>grep alertmanager<span class="token punctuation">.</span>yaml<span class="token operator">|</span>grep <span class="token operator">-</span>v <span class="token string">'{}'</span><span class="token operator">|</span>awk  <span class="token operator">-</span>F  <span class="token string">": "</span> <span class="token string">'{print $2}'</span><span class="token operator">|</span>base64 <span class="token operator">-</span>d <span class="token operator">&gt;&gt;</span>alertmanager<span class="token punctuation">.</span>yaml

</code></pre> 
<ul><li>修改alertmanager.yaml</li></ul> 
<pre><code class="prism language-c">############################ 钉钉告警 ############################
global<span class="token operator">:</span>
  resolve_timeout<span class="token operator">:</span> <span class="token number">5</span>m
receivers<span class="token operator">:</span>
<span class="token operator">-</span> name<span class="token operator">:</span> dingtalk<span class="token operator">-</span>webhook
  webhook_configs<span class="token operator">:</span>
  <span class="token operator">-</span> send_resolved<span class="token operator">:</span> true
    url<span class="token operator">:</span> http<span class="token operator">:</span><span class="token comment">//dingtalk-webhook:8060/dingtalk/webhook-dingtalk/send</span>
route<span class="token operator">:</span>
  group_by<span class="token operator">:</span>
  <span class="token operator">-</span> job
  group_interval<span class="token operator">:</span> <span class="token number">5</span>m
  group_wait<span class="token operator">:</span> <span class="token number">30</span>s
  receiver<span class="token operator">:</span> dingtalk<span class="token operator">-</span>webhook
  repeat_interval<span class="token operator">:</span> <span class="token number">12</span>h
  routes<span class="token operator">:</span>
  <span class="token operator">-</span> receiver<span class="token operator">:</span> dingtalk<span class="token operator">-</span>webhook
    group_wait<span class="token operator">:</span> <span class="token number">10</span>s



############################ 邮件告警配置如下 ########################
cat alertmanager<span class="token punctuation">.</span>yaml
global<span class="token operator">:</span>
  resolve_timeout<span class="token operator">:</span> <span class="token number">5</span>m
route<span class="token operator">:</span>
  group_by<span class="token operator">:</span> <span class="token punctuation">[</span>Alertname<span class="token punctuation">]</span>
  <span class="token macro property"><span class="token directive-hash">#</span> <span class="token expression">Send all notifications to me<span class="token punctuation">.</span></span></span>
  receiver<span class="token operator">:</span> demo<span class="token operator">-</span>alert
  group_wait<span class="token operator">:</span> <span class="token number">30</span>s
  group_interval<span class="token operator">:</span> <span class="token number">5</span>m
  repeat_interval<span class="token operator">:</span> <span class="token number">12</span>h
  routes<span class="token operator">:</span>
  <span class="token operator">-</span> match<span class="token operator">:</span>
      alertname<span class="token operator">:</span> DemoAlertName
    receiver<span class="token operator">:</span> <span class="token string">'demo-alert'</span>

receivers<span class="token operator">:</span>
<span class="token operator">-</span> name<span class="token operator">:</span> demo<span class="token operator">-</span>alert
  email_configs<span class="token operator">:</span>
  <span class="token operator">-</span> to<span class="token operator">:</span> your_email@gmail<span class="token punctuation">.</span>com
    from<span class="token operator">:</span> from_email@gmail<span class="token punctuation">.</span>com
    <span class="token macro property"><span class="token directive-hash">#</span> <span class="token expression">Your smtp server address</span></span>
    smarthost<span class="token operator">:</span> smtp<span class="token punctuation">.</span>gmail<span class="token punctuation">.</span>com<span class="token operator">:</span><span class="token number">587</span>
    auth_username<span class="token operator">:</span> from_email@gmail<span class="token punctuation">.</span>com
    auth_identity<span class="token operator">:</span> from_email@gmail<span class="token punctuation">.</span>com
    auth_password<span class="token operator">:</span> <span class="token number">16l</span>etter_generated token # you can use gmail account password<span class="token punctuation">,</span> but better create a dedicated token <span class="token keyword">for</span> this
    headers<span class="token operator">:</span>
      From<span class="token operator">:</span> from_email@gmail<span class="token punctuation">.</span>com
      Subject<span class="token operator">:</span> <span class="token string">'Demo ALERT'</span>
</code></pre> 
<ul><li>重新部署alertmanager.yaml</li></ul> 
<pre><code class="prism language-c">kubectl  <span class="token operator">-</span>n monitoring delete secret alertmanager<span class="token operator">-</span>prometheus<span class="token operator">-</span>operator<span class="token operator">-</span>alertmanager
kubectl <span class="token operator">-</span>n monitoring create secret generic alertmanager<span class="token operator">-</span>prometheus<span class="token operator">-</span>operator<span class="token operator">-</span>alertmanager <span class="token operator">--</span>from<span class="token operator">-</span>file<span class="token operator">=</span>alertmanager<span class="token punctuation">.</span>yaml
</code></pre> 
<h4><a id="35_469"></a>3.5、创建告警</h4> 
<ul><li>让我们移除所有默认告警并创建一个我们自己的告警： 
  <ul><li>注意：我们只保留一条规则是为了让demo更容易。但是有一条规则，你绝对不能删除，它位于monitoring-demo-prometheus-operator-general.rules.yaml中，被称为看门狗。该告警总是处于触发状态，其目的是确保整个告警流水线正常运转。</li></ul> </li></ul> 
<pre><code class="prism language-c"># 可以从CLI中检查我们留下的规则并将其与我们将在浏览器中看到的进行比较。
kubectl <span class="token operator">-</span>n monitoring describe prometheusrule demo<span class="token operator">-</span>prometheus<span class="token operator">-</span>operator<span class="token operator">-</span>alertmanager<span class="token punctuation">.</span>rules

########################## 移除默认的告警（也可以不必移除） ##########################
kubectl <span class="token operator">-</span>n monitoring delete prometheusrules $<span class="token punctuation">(</span>kubectl <span class="token operator">-</span>n monitoring get prometheusrules <span class="token operator">|</span> grep <span class="token operator">-</span>v alert<span class="token punctuation">)</span>
kubectl <span class="token operator">-</span>n monitoring get prometheusrules

########################## 创建自己的告警 ##########################
<span class="token operator">~</span><span class="token punctuation">]</span># vim demo<span class="token operator">-</span>nginx<span class="token operator">-</span>alertmanager<span class="token punctuation">.</span>rules
apiVersion<span class="token operator">:</span> monitoring<span class="token punctuation">.</span>coreos<span class="token punctuation">.</span>com<span class="token operator">/</span>v1
kind<span class="token operator">:</span> PrometheusRule
metadata<span class="token operator">:</span>
  generation<span class="token operator">:</span> <span class="token number">1</span>
  labels<span class="token operator">:</span>
    app<span class="token operator">:</span> prometheus<span class="token operator">-</span>operator
    chart<span class="token operator">:</span> prometheus<span class="token operator">-</span>operator<span class="token operator">-</span><span class="token number">9.3</span><span class="token number">.2</span>
    heritage<span class="token operator">:</span> Helm
    release<span class="token operator">:</span> prometheus<span class="token operator">-</span>operator
  managedFields<span class="token operator">:</span>
  <span class="token operator">-</span> apiVersion<span class="token operator">:</span> monitoring<span class="token punctuation">.</span>coreos<span class="token punctuation">.</span>com<span class="token operator">/</span>v1
    manager<span class="token operator">:</span> Go<span class="token operator">-</span>http<span class="token operator">-</span>client
    operation<span class="token operator">:</span> Update
  name<span class="token operator">:</span> demo<span class="token operator">-</span>prometheus<span class="token operator">-</span>operator<span class="token operator">-</span>alertmanager<span class="token punctuation">.</span>rules
spec<span class="token operator">:</span>
  groups<span class="token operator">:</span>
  <span class="token operator">-</span> name<span class="token operator">:</span> demo<span class="token operator">-</span>alertmanager<span class="token punctuation">.</span>rules
    rules<span class="token operator">:</span>
    <span class="token operator">-</span> alert<span class="token operator">:</span> Demo<span class="token operator">-</span>test
      annotations<span class="token operator">:</span>
        message<span class="token operator">:</span> Alertmanager has found <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> $labels<span class="token punctuation">.</span>instance <span class="token punctuation">}</span><span class="token punctuation">}</span> with CPU too high
      expr<span class="token operator">:</span> <span class="token function">rate</span> <span class="token punctuation">(</span>container_cpu_usage_seconds_total<span class="token punctuation">{<!-- --></span>pod<span class="token operator">=</span><span class="token operator">~</span><span class="token string">"nginx-demo.*"</span><span class="token punctuation">,</span>image<span class="token operator">!=</span><span class="token string">""</span><span class="token punctuation">,</span> container<span class="token operator">!=</span><span class="token string">"POD"</span><span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token number">1</span>m<span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token operator">&gt;</span> <span class="token number">0.04</span>
      <span class="token keyword">for</span><span class="token operator">:</span> <span class="token number">5</span>m
      labels<span class="token operator">:</span>
        severity<span class="token operator">:</span> critical
</code></pre> 
<p><strong>FAQ: 发布告警规则报错如下</strong></p> 
<ul><li><a href="https://github.com/helm/charts/issues/19928">参考文档</a>:https://github.com/helm/charts/issues/19928</li></ul> 
<pre><code class="prism language-c"><span class="token punctuation">[</span>root@master prometheusrules<span class="token punctuation">]</span># kubectl apply <span class="token operator">-</span>f demo<span class="token operator">-</span>nginx<span class="token operator">-</span>alertmanager<span class="token punctuation">.</span>rules
</code></pre> 
<p><code>Error from server (InternalError): error when creating "demo.yaml": Internal error occurred: failed calling webhook "prometheusrulemutate.monitoring.coreos.com": Post https://prometheus-operator-operator.monitoring.svc:443/admission-prometheusrules/mutate?timeout=30s: context deadline exceeded</code></p> 
<p>解决办法：删除资源<code>validatingwebhookconfigurations.admissionregistration.k8s.io</code>和<code>MutatingWebhookConfiguration</code>，并且重新创建你的rules</p> 
<pre><code class="prism language-c"># 查看这两种资源
<span class="token punctuation">[</span>root@master prometheusrules<span class="token punctuation">]</span># kubectl get validatingwebhookconfigurations<span class="token punctuation">.</span>admissionregistration<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io
NAME                            WEBHOOKS   AGE
prometheus<span class="token operator">-</span>operator<span class="token operator">-</span>admission   <span class="token number">1</span>          <span class="token number">45</span>m
<span class="token punctuation">[</span>root@master prometheusrules<span class="token punctuation">]</span># kubectl get MutatingWebhookConfiguration
NAME                            WEBHOOKS   AGE
prometheus<span class="token operator">-</span>operator<span class="token operator">-</span>admission   <span class="token number">1</span>          <span class="token number">46</span>m

# 删除后 重新发布规则
<span class="token punctuation">[</span>root@master prometheusrules<span class="token punctuation">]</span># kubectl delete validatingwebhookconfigurations<span class="token punctuation">.</span>admissionregistration<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io prometheus<span class="token operator">-</span>operator<span class="token operator">-</span>admission

<span class="token punctuation">[</span>root@master prometheusrules<span class="token punctuation">]</span># kubectl delete MutatingWebhookConfiguration prometheus<span class="token operator">-</span>operator<span class="token operator">-</span>admission

<span class="token punctuation">[</span>root@master prometheusrules<span class="token punctuation">]</span># kubectl apply <span class="token operator">-</span>f demo<span class="token operator">-</span>nginx<span class="token operator">-</span>alertmanager<span class="token punctuation">.</span>rules

</code></pre> 
<ul><li>到prometheus Ui页面上查看新的告警规则，可以看到新建的告警规则</li></ul> 
<p><img src="https://images2.imgbox.com/62/d9/ntu4dCov_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="35group_waitrepeat_interval_538"></a>3.5、group_wait和repeat_interval讲解</h4> 
<ul><li>1、告警从prometheus到alertmanger后缓存group_wait时间，聚合同类型不同机器的告警一个邮件发送</li><li>2、问题没有恢复间隔repeat_interval时间，发送第二次告警</li><li>3、第一次告警发出后等待group_interval时间，开始为该组触发新告警</li><li>4、告警解除resolve_timeout，告警问题解除后保持resolve_timeout时间，发送恢复邮件</li></ul> 
<p>示例：</p> 
<pre><code class="prism language-c">cat alertmanager<span class="token operator">/</span>alertmanager<span class="token punctuation">.</span>yml
templates<span class="token operator">:</span>
<span class="token operator">-</span> <span class="token string">'/usr/local/prometheus/alertmanager/template/default.tmpl'</span>
route<span class="token operator">:</span>
  group_by<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'alertname'</span><span class="token punctuation">]</span>
# 告警合并
  group_wait<span class="token operator">:</span> <span class="token number">60</span>s
  group_interval<span class="token operator">:</span> <span class="token number">5</span>m
  repeat_interval<span class="token operator">:</span> <span class="token number">7</span>m
  resolve_timeout<span class="token operator">:</span> <span class="token number">5</span>m
  receiver<span class="token operator">:</span> <span class="token string">'default'</span>
</code></pre> 
<h4><a id="36_559"></a>3.6、其他相关告警配置参数含义</h4> 
<ul><li>annotation：描述告警的信息标签集。</li><li>expr：由PromQL写的表达式</li><li>for：可选参数，设置了之后会告诉Prometheus在定义的时间段内告警是否处于active状态。仅在此定义时间后才会触发告警。</li><li>label：可以附加到告警的额外标签。</li></ul> 
<p><a href="https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules/" rel="nofollow">了解更多关于告警的信息</a>：<br> https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules/</p> 
<h4><a id="37_567"></a>3.7、告警状态含义</h4> 
<ul><li>告警有3个阶段： 
  <ul><li>Inactive：不满足告警触发条件</li><li>Pending：条件已满足</li><li>Firing：触发告警</li></ul> </li></ul> 
<h3><a id="4_572"></a>4、告警模板讲解</h3> 
<ul><li>告警模板是基于go语言的模板来写的，具体可参考官方文档：https://golang.org/pkg/text/template/</li><li>告警模板的使用类似helm中{<!-- -->{.Values}}这种调用方式</li></ul> 
<p>示例1：在模板中定义了变量后，在整个模板中都能使用</p> 
<pre><code class="prism language-c"><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> $Name <span class="token operator">:</span><span class="token operator">=</span> <span class="token string">"fei"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
hello <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> $Name <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> 
<p>示例2：定义模板，类似helm的_helpers.tpl文件内容</p> 
<pre><code class="prism language-c"><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> define <span class="token string">"this.is.template"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token keyword">if</span> <span class="token punctuation">.</span>Name <span class="token punctuation">}</span><span class="token punctuation">}</span> 
hello <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>Name <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token keyword">else</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
no one<span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> 
<h4><a id="41ifelse_593"></a>4.1、if/else语句</h4> 
<pre><code class="prism language-c"># 示例<span class="token number">1</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token keyword">if</span> <span class="token punctuation">.</span>Name <span class="token punctuation">}</span><span class="token punctuation">}</span> 
hello <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>Name <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token keyword">else</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
no one<span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>


# 示例<span class="token number">2</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token keyword">if</span> <span class="token punctuation">.</span>Name1 <span class="token punctuation">}</span><span class="token punctuation">}</span>
hello <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>Name1 <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">.</span>Name2 <span class="token punctuation">}</span><span class="token punctuation">}</span>
hello <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>Name2 <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token keyword">else</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
no one
<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> 
<h4><a id="42Range_614"></a>4.2、Range语法</h4> 
<ul><li>模板里使用range来进行遍历数据，类似于jinja2模板语言中的for</li></ul> 
<pre><code class="prism language-c"># 假设定义数据结构如下
type Info <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
    Name string
    Age <span class="token keyword">int</span>
<span class="token punctuation">}</span>

# 然后模板就如下
<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> range <span class="token punctuation">.</span>Info <span class="token punctuation">}</span><span class="token punctuation">}</span>
name<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>Name <span class="token punctuation">}</span><span class="token punctuation">}</span>
age<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>Age <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> 
<h4><a id="43_630"></a>4.3、比较语法</h4> 
<ul><li>eq 等于</li><li>ne 不等于</li><li>lt 小于</li><li>le 小于等于</li><li>gt 大于</li><li>ge 大于等于</li></ul> 
<pre><code class="prism language-c"><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token keyword">if</span> gt <span class="token punctuation">.</span>Number1 <span class="token punctuation">.</span>Number2 <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>Number1 <span class="token punctuation">}</span><span class="token punctuation">}</span>大于<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>Number2 <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> 
<h4><a id="44_643"></a>4.4、逻辑运算</h4> 
<ul><li>and 全都满足，返回true</li><li>not 取反</li><li>or 有一个为true,即可返回true</li></ul> 
<pre><code class="prism language-c"><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token keyword">if</span> and <span class="token punctuation">.</span>Username <span class="token punctuation">.</span>Passwd <span class="token punctuation">}</span><span class="token punctuation">}</span>
begin login
<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token keyword">if</span> <span class="token function">gt</span> <span class="token punctuation">(</span>len <span class="token punctuation">.</span>Passwd<span class="token punctuation">)</span> <span class="token number">16</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
passwd valid
<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token keyword">else</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
login faild
<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>

<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token keyword">if</span> not <span class="token punctuation">.</span>Authenticated <span class="token punctuation">}</span><span class="token punctuation">}</span>
access deny
<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> 
<h4><a id="45_662"></a>4.5、内置函数</h4> 
<ul><li><code>title</code>: 将字符串转换为首字母大写</li><li><code>toUpper</code>: 所有字母转换成大写</li><li><code>toLower</code>: 所有字母转换成小写</li><li><code>join</code>: 拼接字符串</li><li><code>safeHtml</code>: 将字符串标记为不需要自动转义的html</li><li><code>len</code>: 获取长度</li></ul> 
<pre><code class="prism language-c"><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token string">"abcd"</span> <span class="token operator">|</span> toUpper <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token string">"ABCD"</span> <span class="token operator">|</span> toLower <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>Values <span class="token operator">|</span> join <span class="token string">","</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> 
<h4><a id="46_675"></a>4.6、移除空格</h4> 
<ul><li>使用<code>-</code>减号来做处理,移除空格</li></ul> 
<pre><code class="prism language-c"><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token operator">-</span> <span class="token punctuation">}</span><span class="token punctuation">}</span> #去掉左边的空格
<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token operator">-</span><span class="token punctuation">}</span><span class="token punctuation">}</span> #去掉右边的空格
<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token operator">-</span> <span class="token operator">-</span><span class="token punctuation">}</span><span class="token punctuation">}</span> #去掉两边所有的空格
</code></pre> 
<h4><a id="47_683"></a>4.7、模板数据结构介绍</h4> 
<pre><code class="prism language-xml">.Receiver: 接收器的名称
.Status: 如果正在告警，值为firing，恢复为resolved
.Alerts: 所有告警对象的列表，是一个列表，
.Alerts.Firing: 告警列表
.Alerts.Resolved: 恢复列表
.GroupLabels: 告警的分组标签
.CommonLabels: 所有告警共有的标签
.CommonAnnotations: 所有告警共有的注解
.ExternalURL: 告警对应的alertmanager连接地址
</code></pre> 
<ul><li>具体可以看下报警出来的信息：</li></ul> 
<pre><code class="prism language-c"><span class="token punctuation">{<!-- --></span>
	<span class="token string">'receiver'</span><span class="token operator">:</span> <span class="token string">'webhook'</span><span class="token punctuation">,</span>
	<span class="token string">'status'</span><span class="token operator">:</span> <span class="token string">'firing'</span><span class="token punctuation">,</span>
	<span class="token string">'alerts'</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
		<span class="token string">'status'</span><span class="token operator">:</span> <span class="token string">'firing'</span><span class="token punctuation">,</span>
		<span class="token string">'labels'</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
			<span class="token string">'alertname'</span><span class="token operator">:</span> <span class="token string">'内存使用率'</span><span class="token punctuation">,</span>
			<span class="token string">'instance'</span><span class="token operator">:</span> <span class="token string">'10.127.92.100'</span><span class="token punctuation">,</span>
			<span class="token string">'job'</span><span class="token operator">:</span> <span class="token string">'sentry'</span><span class="token punctuation">,</span>
			<span class="token string">'severity'</span><span class="token operator">:</span> <span class="token string">'warning'</span><span class="token punctuation">,</span>
			<span class="token string">'team'</span><span class="token operator">:</span> <span class="token string">'ops'</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token string">'annotations'</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
			<span class="token string">'description'</span><span class="token operator">:</span> <span class="token string">'内存使用率已超过55%，内存使用率：58%'</span><span class="token punctuation">,</span>
			<span class="token string">'summary'</span><span class="token operator">:</span> <span class="token string">'内存使用率'</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token string">'startsAt'</span><span class="token operator">:</span> <span class="token string">'2020-12-30T07:20:08.775177336Z'</span><span class="token punctuation">,</span>
		<span class="token string">'endsAt'</span><span class="token operator">:</span> <span class="token string">'0001-01-01T00:00:00Z'</span><span class="token punctuation">,</span>
		<span class="token string">'generatorURL'</span><span class="token operator">:</span> <span class="token string">'http://prometheus-server:9090/graph?g0.expr=round%28%281+-+%28node_memory_MemAvailable_bytes%7Bjob%3D%22sentry%22%7D+%2F+%28node_memory_MemTotal_bytes%7Bjob%3D%22sentry%22%7D%29%29%29+%2A+100%29+%3E+55&amp;g0.tab=1'</span><span class="token punctuation">,</span>
		<span class="token string">'fingerprint'</span><span class="token operator">:</span> <span class="token string">'09f94bd1aa7da54f'</span>
	<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token string">'groupLabels'</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
		<span class="token string">'alertname'</span><span class="token operator">:</span> <span class="token string">'内存使用率'</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token string">'commonLabels'</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
		<span class="token string">'alertname'</span><span class="token operator">:</span> <span class="token string">'内存使用率'</span><span class="token punctuation">,</span>
		<span class="token string">'job'</span><span class="token operator">:</span> <span class="token string">'sentry'</span><span class="token punctuation">,</span>
		<span class="token string">'severity'</span><span class="token operator">:</span> <span class="token string">'warning'</span><span class="token punctuation">,</span>
		<span class="token string">'team'</span><span class="token operator">:</span> <span class="token string">'ops'</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token string">'commonAnnotations'</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
		<span class="token string">'summary'</span><span class="token operator">:</span> <span class="token string">'内存使用率'</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token string">'externalURL'</span><span class="token operator">:</span> <span class="token string">'http://alertmanager-server:9093'</span><span class="token punctuation">,</span>
	<span class="token string">'version'</span><span class="token operator">:</span> <span class="token string">'4'</span><span class="token punctuation">,</span>
	<span class="token string">'groupKey'</span><span class="token operator">:</span> <span class="token string">'{}:{alertname="内存使用率"}'</span><span class="token punctuation">,</span>
	<span class="token string">'truncatedAlerts'</span><span class="token operator">:</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>模板示例：</p> 
<ul><li><a href="https://raw.githubusercontent.com/prometheus/alertmanager/master/template/default.tmpl" rel="nofollow">官方模板参考</a>：https://raw.githubusercontent.com/prometheus/alertmanager/master/template/default.tmpl</li></ul> 
<pre><code class="prism language-c"># <span class="token operator">==</span>注意：<span class="token operator">==</span> 需要特别说明下告警信息里的时间是utc时间，需要转换为北京时间，也就是在utc时间的基础上加<span class="token number">8</span>小时，也就是<span class="token number">28800</span>秒，也就是这里写的<span class="token number">28800e9</span>

<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> define <span class="token string">"wechat.default.message"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token operator">-</span> <span class="token keyword">if</span> <span class="token function">gt</span> <span class="token punctuation">(</span>len <span class="token punctuation">.</span>Alerts<span class="token punctuation">.</span>Firing<span class="token punctuation">)</span> <span class="token number">0</span> <span class="token operator">-</span><span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token comment">// 判断报警列表的长度是否大于0，大于0说明有报警，否则没有</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token operator">-</span> range $index<span class="token punctuation">,</span> $alert <span class="token operator">:</span><span class="token operator">=</span> <span class="token punctuation">.</span>Alerts <span class="token operator">-</span><span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token comment">// 遍历所有的告警列表，$index是索引，$alert是每一个报警元素</span>
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>异常告警<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
告警类型<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> $alert<span class="token punctuation">.</span>Labels<span class="token punctuation">.</span>alertname <span class="token punctuation">}</span><span class="token punctuation">}</span>
告警级别<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> $alert<span class="token punctuation">.</span>Labels<span class="token punctuation">.</span>severity <span class="token punctuation">}</span><span class="token punctuation">}</span>
告警详情<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> $alert<span class="token punctuation">.</span>Annotations<span class="token punctuation">.</span>description<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>$alert<span class="token punctuation">.</span>Annotations<span class="token punctuation">.</span>summary<span class="token punctuation">}</span><span class="token punctuation">}</span>
故障时间<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">(</span>$alert<span class="token punctuation">.</span>StartsAt<span class="token punctuation">.</span>Add <span class="token number">28800e9</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Format <span class="token string">"2006-01-02 15:04:05"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token comment">// 调整为北京时间</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token operator">-</span> <span class="token keyword">if</span> <span class="token function">gt</span> <span class="token punctuation">(</span>len $alert<span class="token punctuation">.</span>Labels<span class="token punctuation">.</span>instance<span class="token punctuation">)</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token comment">// 判断下是否存在instance</span>
实例信息<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> $alert<span class="token punctuation">.</span>Labels<span class="token punctuation">.</span>instance <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token operator">-</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>END<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token operator">-</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token operator">-</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token operator">-</span> <span class="token keyword">if</span> <span class="token function">gt</span> <span class="token punctuation">(</span>len <span class="token punctuation">.</span>Alerts<span class="token punctuation">.</span>Resolved<span class="token punctuation">)</span> <span class="token number">0</span> <span class="token operator">-</span><span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token comment">// 判断恢复列表长度是否大于0，大于0说明有恢复信息，否则没有</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token operator">-</span> range $index<span class="token punctuation">,</span> $alert <span class="token operator">:</span><span class="token operator">=</span> <span class="token punctuation">.</span>Alerts <span class="token operator">-</span><span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token comment">//遍历恢复列表</span>
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>异常恢复<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
告警类型<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> $alert<span class="token punctuation">.</span>Labels<span class="token punctuation">.</span>alertname <span class="token punctuation">}</span><span class="token punctuation">}</span>
告警级别<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> $alert<span class="token punctuation">.</span>Labels<span class="token punctuation">.</span>severity <span class="token punctuation">}</span><span class="token punctuation">}</span>
告警详情<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> $alert<span class="token punctuation">.</span>Annotations<span class="token punctuation">.</span>description<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>$alert<span class="token punctuation">.</span>Annotations<span class="token punctuation">.</span>summary<span class="token punctuation">}</span><span class="token punctuation">}</span>
故障时间<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">(</span>$alert<span class="token punctuation">.</span>StartsAt<span class="token punctuation">.</span>Add <span class="token number">28800e9</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Format <span class="token string">"2006-01-02 15:04:05"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span> #调整为北京时间
恢复时间<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">(</span>$alert<span class="token punctuation">.</span>EndsAt<span class="token punctuation">.</span>Add <span class="token number">28800e9</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Format <span class="token string">"2006-01-02 15:04:05"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span> #调整为北京时间
<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token operator">-</span> <span class="token keyword">if</span> <span class="token function">gt</span> <span class="token punctuation">(</span>len $alert<span class="token punctuation">.</span>Labels<span class="token punctuation">.</span>instance<span class="token punctuation">)</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
实例信息<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> $alert<span class="token punctuation">.</span>Labels<span class="token punctuation">.</span>instance <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token operator">-</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>END<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token operator">-</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token operator">-</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token operator">-</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> 
<p>定义的接受者示例：其中<code>wechat.default.message</code>就是上面define的模板名称</p> 
<pre><code class="prism language-c">receivers<span class="token operator">:</span>
<span class="token operator">-</span> name<span class="token operator">:</span> <span class="token string">'wechat'</span>
  wechat_configs<span class="token operator">:</span>
  <span class="token operator">-</span> send_resolved<span class="token operator">:</span> true
    message<span class="token operator">:</span> <span class="token string">'{<!-- -->{ template "wechat.default.message" . }}'</span> 
    to_party<span class="token operator">:</span> <span class="token string">'接收告警的部门ID'</span>
    agent_id<span class="token operator">:</span> <span class="token string">'应用ID'</span>
    to_user<span class="token operator">:</span> <span class="token string">'用户ID'</span>
    api_secret<span class="token operator">:</span> <span class="token string">'部门secret'</span>
</code></pre> 
<p>参考文章：https://www.cnblogs.com/rancherlabs/p/12558140.html</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/05a945ceecefa73dde83a61b000169f8/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">原型对象、原型链超详细讲解（附图解）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/aec86c01340926579b298cf680fda771/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">计算机网络网络层协议之RIP协议、OSPF协议和BGP协议</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>