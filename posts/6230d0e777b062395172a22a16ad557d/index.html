<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ssr_next.js - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ssr_next.js" />
<meta property="og:description" content="1. 什么是同构 同构的项目支持客户端渲染和服务器端渲染客户端渲染缺点 首屏速度加载慢不支持 SEO 和搜索引擎优化首页需要通过请求初始化数据 2.Next.js Next.js 英文文档,Next.js 中文文档 是一个轻量级的 React 服务端渲染应用框架默认支持服务端渲染自动根据页面进行代码分割基于页面的客户端路由方案基于 Webpack 的开发环境，支持热模块替换可以跟Koa或者其它Node.js服务器进行集成支持 Babel 和 Webpack 的配置项定制静态文件服务 public 3.项目初始化 3.1 创建项目 mkdir zhufengnextjs cd zhufengnextjs npm init -y npm install react react-dom next redux react-redux --save npm install axios express body-parser cors express-session connect-mongo mongoose koa koa-router --save 3.2 添加脚本 package.json
{ &#34;scripts&#34;: { &#34;dev&#34;: &#34;next dev&#34;, &#34;build&#34;: &#34;next build&#34;, &#34;start&#34;: &#34;next start&#34; } } .gitignore
3.3 访问服务 以 ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/6230d0e777b062395172a22a16ad557d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-25T23:34:27+08:00" />
<meta property="article:modified_time" content="2022-08-25T23:34:27+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ssr_next.js</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="1__1"></a>1. 什么是同构</h3> 
<ul><li>同构的项目支持客户端渲染和服务器端渲染</li><li>客户端渲染缺点 
  <ul><li>首屏速度加载慢</li><li>不支持 SEO 和搜索引擎优化</li><li>首页需要通过请求初始化数据</li></ul> </li></ul> 
<p><img src="https://images2.imgbox.com/57/33/upMA3O24_o.png" alt="renderflow"></p> 
<h3><a id="2Nextjs_11"></a>2.Next.js</h3> 
<ul><li><a href="https://nextjs.org/docs" rel="nofollow">Next.js 英文文档</a>,<a href="https://nextjs.frontendx.cn/docs/" rel="nofollow">Next.js 中文文档</a> 是一个轻量级的 React 服务端渲染应用框架</li><li>默认支持服务端渲染</li><li>自动根据页面进行代码分割</li><li>基于页面的客户端路由方案</li><li>基于 Webpack 的开发环境，支持热模块替换</li><li>可以跟<code>Koa</code>或者其它<code>Node.js</code>服务器进行集成</li><li>支持 Babel 和 Webpack 的配置项定制</li><li>静态文件服务 public</li></ul> 
<h3><a id="3_22"></a>3.项目初始化</h3> 
<h4><a id="31__24"></a>3.1 创建项目</h4> 
<pre><code class="prism language-js">mkdir zhufengnextjs
cd zhufengnextjs
npm init <span class="token operator">-</span>y
npm install react  react<span class="token operator">-</span>dom  next  redux react<span class="token operator">-</span>redux  <span class="token operator">--</span>save
npm install axios express  body<span class="token operator">-</span>parser  cors express<span class="token operator">-</span>session connect<span class="token operator">-</span>mongo mongoose koa koa<span class="token operator">-</span>router <span class="token operator">--</span>save
</code></pre> 
<h4><a id="32__34"></a>3.2 添加脚本</h4> 
<p>package.json</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"dev"</span><span class="token operator">:</span> <span class="token string">"next dev"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"build"</span><span class="token operator">:</span> <span class="token string">"next build"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"start"</span><span class="token operator">:</span> <span class="token string">"next start"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><a href="https://github.com/zeit/next.js/blob/canary/.gitignore">.gitignore</a></p> 
<h4><a id="33__50"></a>3.3 访问服务</h4> 
<ul><li>以 ./pages 作为服务端的渲染和索引的根目录</li><li> 
  <ul><li>pages 是 next.js 中非常重要的一个目录，其中每一个 js 文件就代表一个页面，但是有两个例外，<code>_app.js</code> 和 <code>_document.js</code></li></ul> </li><li>next.js 会将 pages 下的 js 文件根据其路径名和文件名自动生成对应的路由</li><li><code>pages</code>组件代码自动分割</li><li>next.js 项目运行之后会自动生成<code>.next</code>目录</li></ul> 
<h5><a id="331_indexjs_58"></a>3.3.1 index.js</h5> 
<pre><code class="prism language-js"><span class="token keyword">function</span> <span class="token function">Home</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>Home<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> Home<span class="token punctuation">;</span>
</code></pre> 
<h5><a id="332_pagesuserjs_67"></a>3.3.2 pages\user.js</h5> 
<p>pages\user.js</p> 
<pre><code class="prism language-js"><span class="token keyword">function</span> <span class="token function">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>User<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> User<span class="token punctuation">;</span>
</code></pre> 
<h5><a id="333__78"></a>3.3.3 访问</h5> 
<pre><code class="prism language-js">npm run dev
curl http<span class="token operator">:</span><span class="token operator">/</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">localhost:3000</span><span class="token regex-delimiter">/</span></span>
</code></pre> 
<h3><a id="4_85"></a>4.跑通路由和样式</h3> 
<h4><a id="41__87"></a>4.1 知识点</h4> 
<ul><li>绑定 <code>styled-jsx</code> 来生成独立作用域的 <code>CSS</code></li><li>如何支持本地和全局<code>css</code></li><li>路由的使用和两种跳转路径的方法</li></ul> 
<h4><a id="42_pages_appjs_93"></a>4.2 pages_app.js</h4> 
<ul><li><code>App</code>组件是每个页面的根组件，页面切换时 App 不会销毁，但是里面的页面组件会销毁，因此可以利用这个来设置全局属性和样式</li><li>全局 css 只能写在这里，否则会报错 
  <ul><li>当页面变化时保持页面布局</li><li>当路由变化时保持页面状态</li><li>注入额外数据到页面里</li></ul> </li></ul> 
<p>pages_app.js</p> 
<pre><code class="prism language-js"><span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">"next/app"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Link <span class="token keyword">from</span> <span class="token string">"next/link"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> _appStyle <span class="token keyword">from</span> <span class="token string">"./_app.module.css"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">"../styles/global.css"</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">LayoutApp</span> <span class="token keyword">extends</span> <span class="token class-name">App</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> <span class="token punctuation">{<!-- --></span> Component <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>style jsx<span class="token operator">&gt;</span>
          <span class="token punctuation">{<!-- --></span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
            li {
              display: inline-block;
              margin-left: 10px;
              line-height: 31px;
            }
          </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>style<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>header<span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>img src<span class="token operator">=</span><span class="token string">"/images/logo.png"</span> className<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>_appStyle<span class="token punctuation">.</span>logo<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>ul<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>li<span class="token operator">&gt;</span>
              <span class="token operator">&lt;</span>Link href<span class="token operator">=</span><span class="token string">"/"</span><span class="token operator">&gt;</span>首页<span class="token operator">&lt;</span><span class="token operator">/</span>Link<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>li<span class="token operator">&gt;</span>
              <span class="token operator">&lt;</span>Link href<span class="token operator">=</span><span class="token string">"/user"</span><span class="token operator">&gt;</span>用户管理<span class="token operator">&lt;</span><span class="token operator">/</span>Link<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>li<span class="token operator">&gt;</span>
              <span class="token operator">&lt;</span>Link href<span class="token operator">=</span><span class="token string">"/profile"</span><span class="token operator">&gt;</span>个人中心<span class="token operator">&lt;</span><span class="token operator">/</span>Link<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>header<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Component <span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>footer style<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">textAlign</span><span class="token operator">:</span> <span class="token string">"center"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>@copyright 珠峰架构<span class="token operator">&lt;</span><span class="token operator">/</span>footer<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> LayoutApp<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="43__appmodulecss_145"></a>4.3 _app.module.css</h4> 
<p>pages _app.module.css</p> 
<pre><code class="prism language-css"><span class="token selector">.logo</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">width</span><span class="token punctuation">:</span> 120px<span class="token punctuation">;</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 31px<span class="token punctuation">;</span>
  <span class="token property">float</span><span class="token punctuation">:</span> left<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="44_globalcss_157"></a>4.4 global.css</h4> 
<p>styles\global.css</p> 
<pre><code class="prism language-css"><span class="token selector">html,
body</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">margin</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="45_pagesindexjs_169"></a>4.5 pages\index.js</h4> 
<p>pages\index.js</p> 
<pre><code class="prism language-js"><span class="token keyword">function</span> <span class="token function">Home</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>Home<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> Home<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="46_pagesuserjs_180"></a>4.6 pages\user.js</h4> 
<p>pages\user.js</p> 
<pre><code class="prism language-js"><span class="token keyword">import</span> Link <span class="token keyword">from</span> <span class="token string">"next/link"</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>User<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>Link href<span class="token operator">=</span><span class="token string">"/"</span><span class="token operator">&gt;</span>首页<span class="token operator">&lt;</span><span class="token operator">/</span>Link<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> User<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="47_pagesprofilejs_197"></a>4.7 pages\profile.js</h4> 
<p>pages\profile.js</p> 
<pre><code class="prism language-js"><span class="token keyword">import</span> router <span class="token keyword">from</span> <span class="token string">"next/router"</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">Profile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>Profile<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> router<span class="token punctuation">.</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>返回<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> Profile<span class="token punctuation">;</span>
</code></pre> 
<h3><a id="5_214"></a>5.二级路由</h3> 
<h4><a id="51__216"></a>5.1 知识点</h4> 
<ul><li>支持二级路由</li><li>实现二级布局组件</li><li>路由跳转传递参数</li><li>页面组件通过<code>getInitialProps</code>获取数据</li></ul> 
<h4><a id="52__223"></a>5.2 执行顺序</h4> 
<h5><a id="521__225"></a>5.2.1 后台顺序</h5> 
<ul><li>LayoutApp getInitialProps</li><li>UseList getInitialProps</li><li>LayoutApp constructor</li><li>UseList constructor</li></ul> 
<h5><a id="522__232"></a>5.2.2 前台顺序</h5> 
<ul><li>初次渲染 
  <ul><li>LayoutApp constructor</li><li>UseList constructor</li></ul> </li><li>路由切换 
  <ul><li>LayoutApp getInitialProps</li><li>UseList getInitialProps</li><li>UseList constructor</li></ul> </li></ul> 
<h5><a id="523__appjs_242"></a>5.2.3 _app.js</h5> 
<p>pages_app.js</p> 
<pre><code class="prism language-diff">import App from 'next/app';
import Link from 'next/link';
import _appStyle from './_app.module.css';
import '../styles/global.css';
class LayoutApp extends App {
+ static async getInitialProps({ Component,ctx }) {
+   let pageProps = {};
+   if (Component.getInitialProps)
+     pageProps = await Component.getInitialProps(ctx);
+   return { pageProps };//我：将会成为LayoutApp的属性对象
+ }
  render() {
+   let { Component, pageProps } = this.props;
    return (
      &lt;div&gt;
        &lt;style jsx&gt;
          {
            `li{
                  display:inline-block;
                  margin-left:10px;
                  line-height:31px;
             }`
          }
        &lt;/style&gt;
        &lt;header&gt;
          &lt;img src="/images/logo.png" className={_appStyle.logo} /&gt;
          &lt;ul&gt;
            &lt;li&gt;&lt;Link href="/"&gt;首页&lt;/Link&gt;&lt;/li&gt;
+           &lt;li&gt;&lt;Link href="/user/list" &gt;用户管理&lt;/Link&gt;&lt;/li&gt;
            &lt;li&gt;&lt;Link href="/profile"&gt;个人中心&lt;/Link&gt;&lt;/li&gt;
          &lt;/ul&gt;
        &lt;/header&gt;
+       &lt;Component {...pageProps} /&gt;
        &lt;footer style={<!-- -->{ textAlign: 'center' }} &gt;@copyright 珠峰架构&lt;/footer&gt;
      &lt;/div&gt;
    )
  }
}
export default LayoutApp;
</code></pre> 
<h5><a id="524_userindexjs_288"></a>5.2.4 user\index.js</h5> 
<p>pages\user\index.js</p> 
<pre><code class="prism language-js"><span class="token keyword">import</span> Link <span class="token keyword">from</span> <span class="token string">"next/link"</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">UserLayout</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>ul<span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>li<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>Link href<span class="token operator">=</span><span class="token string">"/user/list"</span><span class="token operator">&gt;</span>
              <span class="token operator">&lt;</span>a<span class="token operator">&gt;</span>用户列表<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>Link<span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>li<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>Link href<span class="token operator">=</span><span class="token string">"/user/add"</span><span class="token operator">&gt;</span>
              <span class="token operator">&lt;</span>a<span class="token operator">&gt;</span>添加用户<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>Link<span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span>props<span class="token punctuation">.</span>children<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> UserLayout<span class="token punctuation">;</span>
</code></pre> 
<h5><a id="525_userlistjs_318"></a>5.2.5 user\list.js</h5> 
<p>pages\user\list.js</p> 
<pre><code class="prism language-js"><span class="token keyword">import</span> Link <span class="token keyword">from</span> <span class="token string">"next/link"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> UserLayout <span class="token keyword">from</span> <span class="token string">"./"</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">UseList</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>UserLayout<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>ul<span class="token operator">&gt;</span>
        <span class="token punctuation">{<!-- --></span>props<span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
          <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>user<span class="token punctuation">.</span>id<span class="token punctuation">}</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>Link href<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/user/detail/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>user<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span>user<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>Link<span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>UserLayout<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
UseList<span class="token punctuation">.</span><span class="token function-variable function">getInitialProps</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">let</span> list <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"张三"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"李四"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span> list <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> UseList<span class="token punctuation">;</span>
</code></pre> 
<h5><a id="526_useraddjs_348"></a>5.2.6 user\add.js</h5> 
<p>pages\user\add.js</p> 
<pre><code class="prism language-js"><span class="token keyword">import</span> UserLayout <span class="token keyword">from</span> <span class="token string">"./"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">UserAdd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">let</span> nameRef <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> passwordRef <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> <span class="token function-variable function">handleSubmit</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> user <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">name</span><span class="token operator">:</span> nameRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
      <span class="token literal-property property">password</span><span class="token operator">:</span> passwordRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>UserLayout<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>form onSubmit<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>handleSubmit<span class="token punctuation">}</span><span class="token operator">&gt;</span>
        <span class="token literal-property property">用户名</span><span class="token operator">:</span>
        <span class="token operator">&lt;</span>input ref<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>nameRef<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token literal-property property">密码</span><span class="token operator">:</span>
        <span class="token operator">&lt;</span>input ref<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>passwordRef<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button type<span class="token operator">=</span><span class="token string">"submit"</span><span class="token operator">&gt;</span>添加<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>UserLayout<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> UserAdd<span class="token punctuation">;</span>
</code></pre> 
<h5><a id="527_userdetailidjs_381"></a>5.2.7 user\detail[id].js</h5> 
<p>pages\user\detail[id].js</p> 
<pre><code class="prism language-js"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> UserLayout <span class="token keyword">from</span> <span class="token string">"../"</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">UserDetail</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>UserLayout<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token constant">ID</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>props<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>UserLayout<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
UserDetail<span class="token punctuation">.</span><span class="token function-variable function">getInitialProps</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//这个上下文ctx是自带的</span>
  <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">user</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">id</span><span class="token operator">:</span> ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>id <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> UserDetail<span class="token punctuation">;</span>
</code></pre> 
<h3><a id="6_401"></a>6.调用接口</h3> 
<ul><li>当服务渲染时,<code>getInitialProps</code>将会把数据序列化，就像<code>JSON.stringify</code></li><li>所以确保<code>getInitialProps</code>返回的是一个普通 <code>JS</code> 对象，而不是 Date, Map 或 Set 类型</li><li>当页面初始化加载时,<code>getInitialProps</code>只会加载在服务端。只有当路由跳转（Link 组件跳转或 API 方法跳转）时，客户端才会执行<code>getInitialProps</code></li><li><code>getInitialProps</code>将不能使用在子组件中。只能使用在<code>pages</code>页面中</li></ul> 
<h4><a id="61__408"></a>6.1 方法执行顺序</h4> 
<h5><a id="611__410"></a>6.1.1 首次访问</h5> 
<p>服务器端</p> 
<pre><code class="prism language-js">LayoutApp getInitialProps 获取LayoutApp初始属性
UseList getInitialProps 调用页面组件的getInitialProps方法
LayoutApp constructor 根据属性创建LayoutAPp的实例
LayoutApp render  调用此实例的render方法，返回react元素
UseList constructor 创建子组件
UseList render 渲染子组件
</code></pre> 
<ul><li>然后会把HTML结构和LayoutApp属性对象序列化后发给客户端</li><li>客户端再把LayoutApp属性反序列化后变成对象</li></ul> 
<p>客户端</p> 
<pre><code class="prism language-js">LayoutApp constructor
LayoutApp render
UseList constructor
UseList render
</code></pre> 
<h5><a id="612__435"></a>6.1.2 切换路由</h5> 
<p>客户端</p> 
<pre><code class="prism language-js">LayoutApp getInitialProps
UseList getInitialProps
LayoutApp render
UseList constructor
UseList render
</code></pre> 
<h4><a id="62_pages_appjs_447"></a>6.2 pages_app.js</h4> 
<p>pages_app.js</p> 
<pre><code class="prism language-diff">import App from 'next/app';
import Link from 'next/link';
import _appStyle from './_app.module.css';
import '../styles/global.css';
class LayoutApp extends App {
+ constructor(props) {
+   super(props)
+   console.log('LayoutApp constructor');
+ }
  static async getInitialProps({ Component, ctx }) {
+   console.log('LayoutApp getInitialProps');
    let pageProps = {};
    if (Component.getInitialProps)
      pageProps = await Component.getInitialProps(ctx);
    return { pageProps };
  }
  render() {
    console.log('LayoutApp render');
    let { Component, pageProps } = this.props;
    return (
      &lt;div&gt;
        &lt;style jsx&gt;
          {
            `li{
                  display:inline-block;
                  margin-left:10px;
                  line-height:31px;
             }`
          }
        &lt;/style&gt;
        &lt;header&gt;
          &lt;img src="/images/logo.png" className={_appStyle.logo} /&gt;
          &lt;ul&gt;
            &lt;li&gt;&lt;Link href="/"&gt;首页&lt;/Link&gt;&lt;/li&gt;
            &lt;li&gt;&lt;Link href="/user/list" &gt;用户管理&lt;/Link&gt;&lt;/li&gt;
            &lt;li&gt;&lt;Link href="/profile"&gt;个人中心&lt;/Link&gt;&lt;/li&gt;
          &lt;/ul&gt;
        &lt;/header&gt;
        &lt;Component {...pageProps} /&gt;
        &lt;footer style={<!-- -->{ textAlign: 'center' }} &gt;@copyright 珠峰架构&lt;/footer&gt;
      &lt;/div&gt;
    )
  }
}
export default LayoutApp;
</code></pre> 
<h4><a id="63_pagesuserlistjs_499"></a>6.3 pages\user\list.js</h4> 
<p>pages\user\list.js</p> 
<pre><code class="prism language-diff">import React from 'react';
import Link from 'next/link';
import UserLayout from './';
+import request from '../../utils/request';
class UseList extends React.Component {
+ constructor(props) {
+   super(props);
+   console.log('UseList constructor');
+ }
  render() {
    console.log('UseList render');
    return (
      &lt;UserLayout&gt;
        &lt;ul&gt;
          {
            this.props.list.map((user) =&gt; (
              &lt;li key={user.id}&gt;
                &lt;Link href={`/user/detail/${user.id}`}&gt;{user.name}&lt;/Link&gt;
              &lt;/li&gt;
            ))
          }
        &lt;/ul&gt;
      &lt;/UserLayout&gt;
    )
  }
}

UseList.getInitialProps = async () =&gt; {
+ console.log('UseList getInitialProps');
  let response = await request({ url: '/api/users', method: 'GET' }).then(res =&gt; res.data);
  return { list: response.data };
}
export default UseList;
</code></pre> 
<h4><a id="64_pagesuseraddjs_539"></a>6.4 pages\user\add.js</h4> 
<p>pages\user\add.js</p> 
<pre><code class="prism language-diff">import UserLayout from './';
import React from 'react';
+import request from '../../utils/request';
import router from 'next/router'
function UserAdd() {
  let nameRef = React.useRef();
  let passwordRef = React.useRef();
  let handleSubmit = async (event) =&gt; {
    event.preventDefault();
    const user = { name: nameRef.current.value, password: passwordRef.current.value };
+   let response = await request.post('/api/register', user).then(res =&gt; res.data);
+   if (response.success) {
+     router.push('/user/list');
+   } else {
+     alert('添加用户失败');
+   }
  }
  return (
    &lt;UserLayout&gt;
      &lt;form onSubmit={handleSubmit}&gt;
        用户名:&lt;input ref={nameRef} /&gt;
        密码:&lt;input ref={passwordRef} /&gt;
        &lt;button type="submit"&gt;添加&lt;/button&gt;
      &lt;/form&gt;
    &lt;/UserLayout&gt;
  )
}

export default UserAdd;
</code></pre> 
<h4><a id="65_idjs_575"></a>6.5 [id].js</h4> 
<p>pages\user\detail[id].js</p> 
<pre><code class="prism language-diff">import React from 'react';
import UserLayout from '../';
+import request from '../../../utils/request';
function UserDetail(props) {
  return (
    &lt;UserLayout&gt;
      &lt;p&gt;ID:{props.user.id}&lt;/p&gt;
      &lt;p&gt;NAME:{props.user.name}&lt;/p&gt;
    &lt;/UserLayout&gt;
  )
}
UserDetail.getInitialProps = async (ctx) =&gt; {
+ let response = await request({ url: `/api/users/${ctx.query.id}`, method: 'GET' }).then(res =&gt; res.data);
+ return { user: response.data };
}
export default UserDetail;
</code></pre> 
<h4><a id="66_utilsrequestjs_598"></a>6.6 utils\request.js</h4> 
<p>utils\request.js</p> 
<pre><code class="prism language-js"><span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">"axios"</span><span class="token punctuation">;</span>
axios<span class="token punctuation">.</span>defaults<span class="token punctuation">.</span>withCredentials <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token comment">//在跨域的时候携带cookie</span>
<span class="token keyword">const</span> instance <span class="token operator">=</span> axios<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">baseURL</span><span class="token operator">:</span> <span class="token string">"http://localhost:5000"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> instance<span class="token punctuation">;</span>
</code></pre> 
<h3><a id="7_611"></a>7.懒加载</h3> 
<h4><a id="71_idjs____613"></a>7.1 [id].js 懒加载组件</h4> 
<p>pages\user\detail[id].js</p> 
<pre><code class="prism language-diff">import React from 'react';
import UserLayout from '../';
import request from '../../../utils/request';
+import dynamic from 'next/dynamic';
//import UserInfo from '@/components/UserInfo';
+const DynamicUserInfo = dynamic(() =&gt; import('@/components/UserInfo'));
function UserDetail(props) {
  const [show, setShow] = React.useState(false);
  return (
    &lt;UserLayout&gt;
      &lt;p&gt;ID:{props.user &amp;&amp; props.user.id}&lt;/p&gt;
+     &lt;button onClick={() =&gt; setShow(!show)}&gt;显示/隐藏&lt;/button&gt;
+     {
+       show &amp;&amp; props.user &amp;&amp; &lt;DynamicUserInfo user={props.user} /&gt;
+     }
+   &lt;/UserLayout&gt;
  )
}
UserDetail.getInitialProps = async (ctx) =&gt; {
  let response = await request({ url: `/api/users/${ctx.query.id}`, method: 'GET' }).then(res =&gt; res.data);
  return { user: response.data };
}
export default UserDetail;
</code></pre> 
<h4><a id="72_componentsUserInfojs___643"></a>7.2 components\UserInfo.js 懒加载模块</h4> 
<p>UserInfo.js</p> 
<pre><code class="prism language-js"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">UserInfo</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>createdAt<span class="token punctuation">,</span> setCreatedAt<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>user<span class="token punctuation">.</span>createdAt<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">changeFormat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> moment <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">"moment"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//我：懒加载</span>
    <span class="token function">setCreatedAt</span><span class="token punctuation">(</span>moment<span class="token punctuation">.</span><span class="token function">default</span><span class="token punctuation">(</span>createdAt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fromNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token constant">NAME</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>props<span class="token punctuation">.</span>user<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>创建时间<span class="token operator">:</span><span class="token punctuation">{<!-- --></span>createdAt<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>changeFormat<span class="token punctuation">}</span><span class="token operator">&gt;</span>切换为相对时间<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> UserInfo<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="73_jsconfigjson___666"></a>7.3 jsconfig.json 配置@别名</h4> 
<p>jsconfig.json</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"compilerOptions"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"baseUrl"</span><span class="token operator">:</span> <span class="token string">"."</span><span class="token punctuation">,</span><span class="token comment">//当前目录</span>
    <span class="token string-property property">"paths"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"@/*"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"/*"</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="8_redux_681"></a>8.集成 redux</h3> 
<h4><a id="81__683"></a>8.1 知识点</h4> 
<ul><li>集成redux</li><li>cookie保存和存递</li></ul> 
<h4><a id="82_pages_appjs_688"></a>8.2 pages_app.js</h4> 
<p>pages_app.js</p> 
<pre><code class="prism language-diff">import App from 'next/app';
import Link from 'next/link';
import _appStyle from './_app.module.css';
import '../styles/global.css';
+import { Provider } from 'react-redux';
+import request from '../utils/request';
+import createStore from '../store';
+import * as types from '../store/action-types';
+function getStore(initialState) {
+  if (typeof window === 'undefined') {
+    return createStore(initialState);//如果是服务器端,每次都返回新的仓库
+  } else {
+    if (!window._REDUX_STORE_) {
+      window._REDUX_STORE_ = createStore(initialState);
+    }
+    return window._REDUX_STORE_;
+  }
+}
class LayoutApp extends App {
  constructor(props) {
    super(props)
+   this.store = getStore(props.initialState);
    console.log('LayoutApp constructor');
  }
  static async getInitialProps({ Component, ctx }) {
+   console.log('LayoutApp getInitialProps');
+   let store = getStore();//1.后台创建新仓库  5.每次切换路由都会执行此方法获取老仓库
+   if (typeof window == 'undefined') {//2.后台获取用户信息，服务器环境
+     let options = { url: '/api/validate' };
+     if (ctx.req &amp;&amp; ctx.req.headers.cookie) { 
+       options.headers = options.headers || {};
+       options.headers.cookie = ctx.req.headers.cookie;
+     }
+     let response = await request(options).then(res =&gt; res.data);
+     if (response.success) {
+       store.dispatch({ type: types.SET_USER_INFO, payload: response.data });
+     }
+   }
+   let pageProps = {};
+   if (Component.getInitialProps)
+     pageProps = await Component.getInitialProps(ctx);
+   const props = { pageProps };
+   if (typeof window == 'undefined') {//后台获取用赋值状态，我：为了客户端可以直接用服务端的store初始化仓库
+     props.initialState = store.getState();
+   }
+   return props;
  }
  render() {
    console.log('LayoutApp render');
    let state = this.store.getState();
    let { Component, pageProps } = this.props;
    return (
+     &lt;Provider store={this.store}&gt;
        &lt;style jsx&gt;
          {
            `li{
                  display:inline-block;
                  margin-left:10px;
                  line-height:31px;
            }`
          }
        &lt;/style&gt;
        &lt;header&gt;
          &lt;img src="/images/logo.png" className={_appStyle.logo} /&gt;
          &lt;ul&gt;
            &lt;li&gt;&lt;Link href="/"&gt;首页&lt;/Link&gt;&lt;/li&gt;
            &lt;li&gt;&lt;Link href="/user/list" &gt;用户管理&lt;/Link&gt;&lt;/li&gt;
            &lt;li&gt;&lt;Link href="/profile"&gt;个人中心&lt;/Link&gt;&lt;/li&gt;
            &lt;li&gt;
              {
+               state.currentUser ? &lt;span&gt;{state.currentUser.name}&lt;/span&gt; : &lt;Link href="/login"&gt;登录&lt;/Link&gt;
              }
            &lt;/li&gt;
          &lt;/ul&gt;
        &lt;/header&gt;
        &lt;Component {...pageProps} /&gt;
        &lt;footer style={<!-- -->{ textAlign: 'center' }} &gt;@copyright 珠峰架构&lt;/footer&gt;
+     &lt;/Provider&gt;
    )
  }
}
export default LayoutApp;
</code></pre> 
<h4><a id="83_actiontypesjs_777"></a>8.3 action-types.js</h4> 
<p>store\action-types.js</p> 
<pre><code class="prism language-js"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">SET_USER_INFO</span> <span class="token operator">=</span> <span class="token string">'SET_USER_INFO'</span><span class="token punctuation">;</span><span class="token comment">//设置用户信息</span>
</code></pre> 
<h4><a id="84_reducerjs_785"></a>8.4 reducer.js</h4> 
<p>store\reducer.js</p> 
<pre><code class="prism language-js"><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> types <span class="token keyword">from</span> <span class="token string">'./action-types'</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> initState <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">currentUser</span><span class="token operator">:</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">reducer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">state <span class="token operator">=</span> initState<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> types<span class="token punctuation">.</span><span class="token constant">SET_USER_INFO</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">currentUser</span><span class="token operator">:</span> action<span class="token punctuation">.</span>payload <span class="token punctuation">}</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">return</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> reducer<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="85_storeindexjs_805"></a>8.5 store\index.js</h4> 
<p>store\index.js</p> 
<pre><code class="prism language-js"><span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> createStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'redux'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> reducer <span class="token keyword">from</span> <span class="token string">'./reducer'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">initialState</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">createStore</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> initialState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="86_loginjs_818"></a>8.6 login.js</h4> 
<p>pages\login.js</p> 
<pre><code class="prism language-js"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> request <span class="token keyword">from</span> <span class="token string">'@/utils/request'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> router <span class="token keyword">from</span> <span class="token string">'next/router'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> connect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-redux'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> types <span class="token keyword">from</span> <span class="token string">'@/store/action-types'</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">Login</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> nameRef <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> passwordRef <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token function-variable function">handleSubmit</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> user <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> nameRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token literal-property property">password</span><span class="token operator">:</span> passwordRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>value <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> response <span class="token operator">=</span> <span class="token keyword">await</span> request<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/login'</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>success<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            props<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> types<span class="token punctuation">.</span><span class="token constant">SET_USER_INFO</span><span class="token punctuation">,</span> <span class="token literal-property property">payload</span><span class="token operator">:</span> response<span class="token punctuation">.</span>data <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'登录失败'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token operator">&lt;</span>form onSubmit<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>handleSubmit<span class="token punctuation">}</span><span class="token operator">&gt;</span>
            <span class="token literal-property property">用户名</span><span class="token operator">:</span><span class="token operator">&lt;</span>input ref<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>nameRef<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
            <span class="token literal-property property">密码</span><span class="token operator">:</span><span class="token operator">&lt;</span>input ref<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>passwordRef<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>button type<span class="token operator">=</span><span class="token string">"submit"</span><span class="token operator">&gt;</span>登录<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token parameter">state</span> <span class="token operator">=&gt;</span> state<span class="token punctuation">)</span><span class="token punctuation">(</span>Login<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="9loading_854"></a>9.loading</h3> 
<ul><li><a href="https://nextjs.frontendx.cn/docs/#%E8%B7%AF%E7%94%B1" rel="nofollow">路由事件</a></li></ul> 
<table><thead><tr><th align="left">事件</th><th align="left">触发时机</th></tr></thead><tbody><tr><td align="left">routeChangeStart(url)</td><td align="left">路由开始切换时触发</td></tr><tr><td align="left">routeChangeComplete(url)</td><td align="left">完成路由切换时触发</td></tr><tr><td align="left">routeChangeError(err, url)</td><td align="left">路由切换报错时触发</td></tr><tr><td align="left">beforeHistoryChange(url)</td><td align="left">浏览器 history 模式开始切换时触发</td></tr><tr><td align="left">hashChangeStart(url)</td><td align="left">开始切换 hash 值但是没有切换页面路由时触发</td></tr><tr><td align="left">hashChangeComplete(url)</td><td align="left">完成切换 hash 值但是没有切换页面路由时触发</td></tr></tbody></table> 
<h4><a id="91__appjs_867"></a>9.1 _app.js</h4> 
<p>pages_app.js</p> 
<pre><code class="prism language-diff">import App from 'next/app';
import Link from 'next/link';
import _appStyle from './_app.module.css';
import '../styles/global.css';
import { Provider } from 'react-redux';
import request from '../utils/request';
import createStore from '../store';
import * as types from '../store/action-types';
+import router from 'next/router';
function getStore(initialState) {
  if (typeof window === 'undefined') {
    return createStore(initialState);//如果是服务器端,每次都返回新的仓库
  } else {
    if (!window._REDUX_STORE_) {
      window._REDUX_STORE_ = createStore(initialState);
    }
    return window._REDUX_STORE_;
  }
}
class LayoutApp extends App {
  constructor(props) {
    super(props)
+   this.state = { loading: false }
    this.store = getStore(props.initialState);
    console.log('LayoutApp constructor');
  }
  static async getInitialProps({ Component, ctx }) {
    console.log('LayoutApp getInitialProps');
    let store = getStore();//1.后台创建新仓库  5.每次切换路由都会执行此方法获取老仓库
    if (typeof window == 'undefined') {//2.后台获取用户信息
      let options = { url: '/api/validate' };
      if (ctx.req &amp;&amp; ctx.req.headers.cookie) {
        options.headers = options.headers || {};
        options.headers.cookie = ctx.req.headers.cookie;
      }
      let response = await request(options).then(res =&gt; res.data);
      if (response.success) {
        store.dispatch({ type: types.SET_USER_INFO, payload: response.data });
      }
    }
    let pageProps = {};
    if (Component.getInitialProps)
      pageProps = await Component.getInitialProps(ctx);
    const props = { pageProps };
    if (typeof window == 'undefined') {//后台获取用赋值状态
      props.initialState = store.getState();
    }
    return props;
  }
+  componentDidMount() {
+    this.routeChangeStart = (url) =&gt; {
+      this.setState({ loading: true });
+    };
+    router.events.on('routeChangeStart', this.routeChangeStart);
+    this.routeChangeComplete = (url) =&gt; {
+      this.setState({ loading: false });
+    };
+    router.events.on('routeChangeComplete', this.routeChangeComplete);
+  }
+  componentWillUnmount() {
+    router.events.off('routeChangeStart', this.routeChangeStart)
+    router.events.off('routeChangeStart', this.routeChangeComplete)
+  }
  render() {
    console.log('LayoutApp render');
    let state = this.store.getState();
    let { Component, pageProps } = this.props;
    return (
      &lt;Provider store={this.store}&gt;
        &lt;style jsx&gt;
          {
            `li{
                  display:inline-block;
                  margin-left:10px;
                  line-height:31px;
            }`
          }
        &lt;/style&gt;
        &lt;header&gt;
          &lt;img src="/images/logo.png" className={_appStyle.logo} /&gt;
          &lt;ul&gt;
            &lt;li&gt;&lt;Link href="/"&gt;首页&lt;/Link&gt;&lt;/li&gt;
            &lt;li&gt;&lt;Link href="/user/list" &gt;用户管理&lt;/Link&gt;&lt;/li&gt;
            &lt;li&gt;&lt;Link href="/profile"&gt;个人中心&lt;/Link&gt;&lt;/li&gt;
            &lt;li&gt;
              {
                state.currentUser ? &lt;span&gt;{state.currentUser.name}&lt;/span&gt; : &lt;Link href="/login"&gt;登录&lt;/Link&gt;
              }
            &lt;/li&gt;
          &lt;/ul&gt;
        &lt;/header&gt;
        {
+         this.state.loading ? &lt;div&gt;切换中......&lt;/div&gt; : &lt;Component {...pageProps} /&gt;
        }
        &lt;footer style={<!-- -->{ textAlign: 'center' }} &gt;@copyright 珠峰架构&lt;/footer&gt;
      &lt;/Provider&gt;
    )
  }
}
export default LayoutApp;
</code></pre> 
<h3><a id="10_974"></a>10.受保护路由</h3> 
<h4><a id="101_profilejs_976"></a>10.1 profile.js</h4> 
<p>pages\profile.js</p> 
<pre><code class="prism language-js"><span class="token keyword">import</span> router <span class="token keyword">from</span> <span class="token string">'next/router'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> connect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-redux'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> request <span class="token keyword">from</span> <span class="token string">'../utils/request'</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">Profile</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> <span class="token punctuation">{<!-- --></span> currentUser <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>当前登录用户<span class="token operator">:</span><span class="token punctuation">{<!-- --></span>currentUser<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> router<span class="token punctuation">.</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>返回<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

Profile<span class="token punctuation">.</span><span class="token function-variable function">getInitialProps</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> store</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> state <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> currentUser <span class="token operator">=</span> state<span class="token punctuation">.</span>currentUser<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>currentUser<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span> currentUser <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>req<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      ctx<span class="token punctuation">.</span>res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">Location</span><span class="token operator">:</span> <span class="token string">'/login'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//我：服务端重定向</span>
      ctx<span class="token punctuation">.</span>res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//我：客户端重定向</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//我：这部分后面改了了上面那种，因为服务端返回数据的时候已经加载了一次，所以可以利用这个store。</span>

Profile<span class="token punctuation">.</span><span class="token function-variable function">getInitialProps</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> options <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">'/api/validate'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>req <span class="token operator">&amp;&amp;</span> ctx<span class="token punctuation">.</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>cookie<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        options<span class="token punctuation">.</span>headers <span class="token operator">=</span> options<span class="token punctuation">.</span>headers <span class="token operator">||</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        options<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>cookie <span class="token operator">=</span> ctx<span class="token punctuation">.</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>cookie<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">request</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span>res<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>success<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token literal-property property">currentUser</span><span class="token operator">:</span>response<span class="token punctuation">.</span>data<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>req<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ctx<span class="token punctuation">.</span>res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">303</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">Location</span><span class="token operator">:</span> <span class="token string">'/login'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
            ctx<span class="token punctuation">.</span>res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> WrappedProfile <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span>
    <span class="token parameter">state</span> <span class="token operator">=&gt;</span> state
<span class="token punctuation">)</span><span class="token punctuation">(</span>Profile<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> WrappedProfile<span class="token punctuation">;</span>
</code></pre> 
<h3><a id="11Document_1037"></a>11.自定义Document</h3> 
<h4><a id="111_pages_documentjs_1039"></a>11.1 pages_document.js</h4> 
<p>pages_document.js</p> 
<pre><code class="prism language-js"><span class="token keyword">import</span> Document<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> Html<span class="token punctuation">,</span> Head<span class="token punctuation">,</span> Main<span class="token punctuation">,</span> NextScript <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'next/document'</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">CustomDocument</span> <span class="token keyword">extends</span> <span class="token class-name">Document</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">getInitialProps</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token keyword">await</span> Document<span class="token punctuation">.</span><span class="token function">getInitialProps</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span> <span class="token operator">...</span>props <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>
            <span class="token operator">&lt;</span>Html<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>Head<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>style<span class="token operator">&gt;</span>
                        <span class="token punctuation">{<!-- --></span>
                            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
                            *{
                                padding:0;
                                margin:0;
                            }
                            </span><span class="token template-punctuation string">`</span></span>
                        <span class="token punctuation">}</span>
                    <span class="token operator">&lt;</span><span class="token operator">/</span>style<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>Head<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>Main <span class="token operator">/</span><span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>NextScript <span class="token operator">/</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>Html<span class="token operator">&gt;</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> CustomDocument<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="112_pagesindexjs__SEO_1076"></a>11.2 pages\index.js 这个是做SEO的</h4> 
<p>pages\index.js</p> 
<pre><code class="prism language-js"><span class="token keyword">import</span> Head <span class="token keyword">from</span> <span class="token string">'next/head'</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
              <span class="token operator">&lt;</span>Head<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>首页<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string">"description"</span> content<span class="token operator">=</span><span class="token string">"这是首页"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
             <span class="token operator">&lt;</span><span class="token operator">/</span>Head<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>Home<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>##用来替换getInitialProps的</p> 
<h3><a id="12_getServerSideProps_1097"></a>12. getServerSideProps</h3> 
<ul><li>data-fetching 
  <ul><li>getServerSideProps (Server-side Rendering): Fetch data on each request</li></ul> </li></ul> 
<h4><a id="121_listjs_1102"></a>12.1 list.js</h4> 
<p>pages\user\list.js</p> 
<pre><code class="prism language-diff">import React from 'react';
import Link from 'next/link';
import UserLayout from './';
import request from '@/utils/request';
class UseList extends React.Component {
  constructor(props) {
    super(props);
    console.log('UseList constructor');
  }
  render() {
    console.log('UseList render');
    return (
      &lt;UserLayout&gt;
        &lt;ul&gt;
          {
            this.props.list.map((user) =&gt; (
              &lt;li key={user.id}&gt;
                &lt;Link href={`/user/detail/${user.id}`}&gt;{user.name}&lt;/Link&gt;
              &lt;/li&gt;
            ))
          }
        &lt;/ul&gt;
      &lt;/UserLayout&gt;
    )
  }
}

-UseList.getInitialProps = async () =&gt; {
-  console.log('UseList getInitialProps');
-  let response = await request({ url: '/api/users', method: 'GET' }).then(res =&gt; res.data);
-  return { list: response.data };
-} 
//每个请求都会调用
+export async function getServerSideProps() {
+  const res = await request.get('http://localhost:5000/api/users')
+  return {
+    props: {
+      list: res.data.data
+    },
+  }
+}
export default UseList;
</code></pre> 
<h3><a id="13_getStaticProps_1151"></a>13. getStaticProps</h3> 
<ul><li>data-fetching 
  <ul><li>getStaticProps (Static Generation): Fetch data at build time //构建时获取数据</li><li>getStaticPaths (Static Generation): Specify dynamic routes to pre-render based on data // 预渲染所有的路径</li></ul> </li></ul> 
<h4><a id="131_pagesuserlistjs_1157"></a>13.1 pages\user\list.js</h4> 
<p>pages\user\list.js</p> 
<pre><code class="prism language-js"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Link <span class="token keyword">from</span> <span class="token string">'next/link'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> UserLayout <span class="token keyword">from</span> <span class="token string">'./'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> request <span class="token keyword">from</span> <span class="token string">'@/utils/request'</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">UseList</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'UseList constructor'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'UseList render'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>UserLayout<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>ul<span class="token operator">&gt;</span>
          <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
              <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>user<span class="token punctuation">.</span>id<span class="token punctuation">}</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>Link href<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/user/detail/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>user<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span>user<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>Link<span class="token operator">&gt;</span>
              <span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
            <span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>UserLayout<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/* UseList.getInitialProps = async () =&gt; {
  console.log('UseList getInitialProps');
  let response = await request({ url: '/api/users', method: 'GET' }).then(res =&gt; res.data);
  return { list: response.data };
} */</span>
<span class="token comment">//每个请求都会调用</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getServerSideProps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> request<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'http://localhost:5000/api/users'</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">list</span><span class="token operator">:</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>data
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 这个函数在编译阶段被调用</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getStaticProps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> request<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'http://localhost:5000/api/users'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">list</span><span class="token operator">:</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>data
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> UseList<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="132_pagesuserdetailidjs_1217"></a>13.2 pages\user\detail[id].js</h4> 
<p>pages\user\detail[id].js</p> 
<pre><code class="prism language-js"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> UserLayout <span class="token keyword">from</span> <span class="token string">'../'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> request <span class="token keyword">from</span> <span class="token string">'@/utils/request'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> dynamic <span class="token keyword">from</span> <span class="token string">'next/dynamic'</span><span class="token punctuation">;</span>
<span class="token comment">//import UserInfo from '@/components/UserInfo';</span>
<span class="token keyword">const</span> DynamicUserInfo <span class="token operator">=</span> <span class="token function">dynamic</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'@/components/UserInfo'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">UserDetail</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>show<span class="token punctuation">,</span> setShow<span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>UserLayout<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token constant">ID</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>props<span class="token punctuation">.</span>user <span class="token operator">&amp;&amp;</span> props<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setShow</span><span class="token punctuation">(</span><span class="token operator">!</span>show<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>显示<span class="token operator">/</span>隐藏<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
      <span class="token punctuation">{<!-- --></span>
        show <span class="token operator">&amp;&amp;</span> props<span class="token punctuation">.</span>user <span class="token operator">&amp;&amp;</span> <span class="token operator">&lt;</span>DynamicUserInfo user<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>props<span class="token punctuation">.</span>user<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
      <span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>UserLayout<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
UserDetail<span class="token punctuation">.</span><span class="token function-variable function">getInitialProps</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">let</span> response <span class="token operator">=</span> <span class="token keyword">await</span> request<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/api/users/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">user</span><span class="token operator">:</span> response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>data <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getStaticPaths</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> request<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'http://localhost:5000/api/users'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> users <span class="token operator">=</span> res<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
  <span class="token keyword">const</span> paths <span class="token operator">=</span> users<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">user</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/user/detail/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>user<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span> paths<span class="token punctuation">,</span> <span class="token literal-property property">fallback</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getStaticProps</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{<!-- --></span> params <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'params'</span><span class="token punctuation">,</span> params<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toTimeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> request<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://localhost:5000/api/users/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>params<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">user</span><span class="token operator">:</span> res<span class="token punctuation">.</span>data
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> UserDetail<span class="token punctuation">;</span>
</code></pre> 
<h3><a id="14_1262"></a>14.布署</h3> 
<h4><a id="141__1264"></a>14.1 直接布署</h4> 
<pre><code class="prism language-js">npm run build
npm run start
</code></pre> 
<h4><a id="142_express_1271"></a>14.2 集成express布署</h4> 
<h5><a id="1421__1273"></a>14.2.1 编译</h5> 
<pre><code class="prism language-js">npm run build
</code></pre> 
<h5><a id="1422_startjs_1279"></a>14.2.2 start.js</h5> 
<p>start.js</p> 
<pre><code class="prism language-js"><span class="token keyword">const</span> next <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'next'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">dev</span><span class="token operator">:</span><span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//我：非开发环境</span>
<span class="token keyword">const</span> handler <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">getRequestHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取请求处理器</span>
<span class="token comment">//预编译一下</span>
app<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"express"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> bodyParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"body-parser"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token punctuation">{<!-- --></span>UserModel<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./model'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> session <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"express-session"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./config'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> MongoStore <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'connect-mongo'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//.......</span>
<span class="token operator">+</span>   app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>        <span class="token keyword">await</span> <span class="token function">handler</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'服务器在5000端口启动!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="15apijs_1306"></a>15.api.js</h3> 
<pre><code class="prism language-diff">const express = require('express');
const cors = require('cors');
+ const logger = require('morgan');//我：打印日志
const session = require('express-session');
const app = express();
+ app.use(logger('dev'));
+ 如果跨域访问要携带cookie，就必须指明哪些可以跨域，需要配置。
app.use(
  cors({
    origin: ['http://localhost:3000'],
    credentials: true,
    allowedHeaders: "Content-Type,Authorization",
    methods: "GET,HEAD,PUT,PATCH,POST,DELETE,OPTIONS"
  })
);
app.use(session({
  saveUninitialized: true,
  resave: true,
  secret: 'zhufeng'
}));
app.use(express.json());
app.use(express.urlencoded({ extended: true }));
const users = [];
app.get('/api/users', (req, res) =&gt; {
  res.json({
    success: true,
    data: users
  });
});
app.post('/api/register', (req, res) =&gt; {
  const user = req.body;
  user.id = Date.now() + "";
  user.createdAt = new Date().toISOString();
  users.push(user);
  res.json({
    success: true,
    data: user
  })
});
+ 我：通过这种方式解析id这个参数的
app.get('/api/users/:id', (req, res) =&gt; {
  const id = req.params.id;
  const user = users.find(user =&gt; user.id === id);
  res.json({
    success: true,
    data: user
  })
});
app.post('/api/login', (req, res) =&gt; {
  const user = req.body;
  req.session.user = user;
  res.json({
    success: true,
    data: user
  })
});

app.get('/api/logout', (req, res) =&gt; {
  req.session.user = null;
  res.json({
    success: true,
    data: null
  })
});
app.get('/api/validate', (req, res) =&gt; {
  const user = req.session.user;
  if (user) {
    res.json({
      success: true,
      data: user
    })
  } else {
    res.json({
      success: false,
      error: `用户未登录`
    })
  }
});
app.listen(5000, () =&gt; console.log('api server started on port 5000'));
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/24cb18bdce710919da846a8a8fd3eb2b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">win11退回win10的无损教程（超简单！）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b0f63bd0ef689506585f7a51154131db/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">NAT是什么？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>