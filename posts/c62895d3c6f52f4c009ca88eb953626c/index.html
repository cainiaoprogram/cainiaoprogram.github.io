<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【DRONECAN】（三）WSL2 及 ubuntu20.04 CAN 驱动安装 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【DRONECAN】（三）WSL2 及 ubuntu20.04 CAN 驱动安装" />
<meta property="og:description" content="【DRONECAN】（三）WSL2 及 ubuntu20.04 CAN 驱动安装
前言 这一篇文章主要介绍一下 WSL2 及 ubuntu20.04 CAN 驱动的安装，首先说一下介绍本文的目的。
大家肯定都接触过 ubuntu 系统，但是我们常用的操作系统都是 Windows，想要切换到 ubuntu 系统要么装虚拟机，要么装双系统。双系统必然是麻烦的，而且得两个系统来回切换，而虚拟机的代表就是 vmware，简单的使用还行，但是涉及到三维仿真就会比较卡顿了，而且占用资源也是比较大的。WSL2（Windows Subsystem for Linux 2）是 Windows 10 操作系统中的一个功能，用于在 Windows 系统中运行 Linux 环境，以便用户可以在 Windows 系统中使用 Linux 的命令行工具和应用程序。它是一种虚拟化技术，通过在 Windows 系统上运行一个轻量级的 Linux 内核来实现。注意，相比较于 WSL 1 使用翻译层将 Linux 系统调用转化成 Windows 系统调用，WSL2 是有一个 Linux 内核，只不过微软做了一些裁剪。
因此，WSL2 更适合做 Linux 开发。所以，目前我也沉迷用 WSL2 做 Linux 开发，例如在 WSL2 做 Ardupilot 开发、GAZEBO 仿真等等，都是基于 WSL2 有一个 Linux 的内核。
安装 WSL2 WSL2 安装就很容易，网上也有很多教程，总结一下就是：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/c62895d3c6f52f4c009ca88eb953626c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-30T22:24:23+08:00" />
<meta property="article:modified_time" content="2023-08-30T22:24:23+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【DRONECAN】（三）WSL2 及 ubuntu20.04 CAN 驱动安装</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>【DRONECAN】（三）WSL2 及 ubuntu20.04 CAN 驱动安装</p> 
<h3><a id="_2"></a>前言</h3> 
<p>这一篇文章主要介绍一下 WSL2 及 ubuntu20.04 CAN 驱动的安装，首先说一下介绍本文的目的。</p> 
<p>大家肯定都接触过 ubuntu 系统，但是我们常用的操作系统都是 Windows，想要切换到 ubuntu 系统要么装虚拟机，要么装双系统。双系统必然是麻烦的，而且得两个系统来回切换，而虚拟机的代表就是 vmware，简单的使用还行，但是涉及到三维仿真就会比较卡顿了，而且占用资源也是比较大的。WSL2（Windows Subsystem for Linux 2）是 Windows 10 操作系统中的一个功能，用于在 Windows 系统中运行 Linux 环境，以便用户可以在 Windows 系统中使用 Linux 的命令行工具和应用程序。它是一种虚拟化技术，通过在 Windows 系统上运行一个轻量级的 Linux 内核来实现。<strong>注意，相比较于 WSL 1 使用翻译层将 Linux 系统调用转化成 Windows 系统调用，WSL2 是有一个 Linux 内核，只不过微软做了一些裁剪。</strong><br> 因此，WSL2 更适合做 Linux 开发。所以，目前我也沉迷用 WSL2 做 Linux 开发，例如在 WSL2 做 Ardupilot 开发、GAZEBO 仿真等等，都是基于 WSL2 有一个 Linux 的内核。</p> 
<h3><a id="_WSL2_9"></a>安装 WSL2</h3> 
<p>WSL2 安装就很容易，网上也有很多教程，总结一下就是：</p> 
<p><strong>1、检查更新 win10 版本</strong></p> 
<p>在 cmd 中使用 winver 命令来检查当前 win 的版本，如果版本太低，可以在 设置 - 更新和安全 - Windows 更新中更新。但是有时候会没有提示能更新到最新的版本，那就可以使用微软提供的更新助手。</p> 
<p><strong>2、启用虚拟功能</strong></p> 
<p>在 powerShell 中以管理员身份运行下面命令以确保开启适用于 Linux 的 Windows 子系统和虚拟机平台配置项。</p> 
<pre><code>dism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart
dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart
</code></pre> 
<p><strong>3、下载 Linux 内核更新程序包</strong></p> 
<p>下载地址：<br> <a href="https://wslstorestorage.blob.core.windows.net/wslblob/wsl_update_x64.msi" rel="nofollow">https://wslstorestorage.blob.core.windows.net/wslblob/wsl_update_x64.msi<br> </a></p> 
<p>下载安装即可。</p> 
<p><strong>4、安装Linux分发版本</strong></p> 
<p>在微软商店搜索 Ubuntu20.04，在列表中选择最新的长期支持版本 20.04 LTS 并安装启动</p> 
<p><strong>5、确保 WSL 的版本为2.0</strong></p> 
<p>使用wsl -l -v命令查看安装版本是否正确（VERSION为2）<br> 如果显示当前不是 WSL 2 版本，可以通过以下命令设置 WSL 的默认版本:</p> 
<pre><code>wsl --set-version Ubuntu-20.04 2
</code></pre> 
<h3><a id="WSL2_Ubuntu2004_47"></a>WSL2 Ubuntu20.04配置</h3> 
<p>安装完成后，我们首先需要把源替换为国内镜像，当然有代理的话也可以不换源</p> 
<p><strong>1、备份源列表</strong></p> 
<pre><code>sudo cp /etc/apt/sources.list /etc/apt/sources.list.bak
</code></pre> 
<p><strong>2、命令行打开sources.list文件</strong></p> 
<pre><code>sudo vim /etc/apt/sources.list
</code></pre> 
<p><strong>3、将源文件内容全部注释,并添加以下任意源</strong></p> 
<p><code>阿里云源</code></p> 
<pre><code>deb http://mirrors.aliyun.com/ubuntu/ focal main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ focal main restricted universe multiverse

deb http://mirrors.aliyun.com/ubuntu/ focal-security main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ focal-security main restricted universe multiverse

deb http://mirrors.aliyun.com/ubuntu/ focal-updates main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ focal-updates main restricted universe multiverse

deb http://mirrors.aliyun.com/ubuntu/ focal-proposed main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ focal-proposed main restricted universe multiverse

deb http://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiverse
</code></pre> 
<p><code>清华源</code></p> 
<pre><code>deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal main restricted
deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-updates main restricted
deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal universe
deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-updates universe
deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal multiverse
deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-updates multiverse
deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-backports main restricted universe multiverse
deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-security main restricted
deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-security universe
deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-security multiverse
</code></pre> 
<p><strong>4、更新源</strong></p> 
<pre><code>sudo apt-get update
sudo apt-get upgrade
</code></pre> 
<p><strong>5、WSL2代理配置</strong></p> 
<p>参考：<br> <a href="https://blog.csdn.net/m0_46680603/article/details/128769706">https://blog.csdn.net/m0_46680603/article/details/128769706</a></p> 
<h3><a id="WSL2__CAN__111"></a>WSL2 安装 CAN 驱动</h3> 
<p>WSL2 Ubuntu发行版默认是不支持socketCAN的，这意味着使用WSL2无法正常进行硬件CAN调试工作。由于WSL2支持完整的linux内核，因此可以通过自行编译并替换linux内核的方式，实现WSL2对CAN的支持。</p> 
<p><strong>下载wsl内核源码</strong></p> 
<p>首先查看内核版本</p> 
<pre><code>uname -r
</code></pre> 
<p>输出内核版本，如我是5.15.90.3-microsoft-standard-WSL2</p> 
<p>这里我们要去下载Linux内核源码，再把CAN驱动编译进去。</p> 
<pre><code>git clone https://github.com/microsoft/WSL2-Linux-Kernel.git
cd WSL2-Linux-Kernel
git checkout linux-msft-wsl-5.15.90.3
</code></pre> 
<p><strong>修改配置文件</strong></p> 
<p>安装依赖：</p> 
<pre><code>sudo apt update
sudo apt install build-essential flex bison libssl-dev libelf-dev libncurses-dev autoconf libudev-dev libtool
</code></pre> 
<pre><code>cp Microsoft/config-wsl .config
sudo make menuconfig
</code></pre> 
<p>在Networking support—&gt;CAN BUS subsystem support下面，按M把他们和他们下面的选项都变成module，把能选的全选了，按M没反应变不成module的就按y让它变成build-in的，类似这样，注意每一级都要选，别漏掉了</p> 
<p><img src="https://images2.imgbox.com/af/4b/35gkUv1r_o.png" alt=""></p> 
<p><img src="https://images2.imgbox.com/ef/10/xvcYH2JL_o.png" alt=""></p> 
<p>然后最下面save，命名为.config。可以手动改一下文件里面的：CONFIG_LOCALVERSION="-microsoft-standard-WSL2"选项，改成别的名字，这里我改成了“5.15.90.3-microsoft-standard-WSL2-CAN”</p> 
<p><strong>编译安装</strong></p> 
<p>编译：</p> 
<pre><code>sudo make -j12 #有几个核就写几个
sudo make modules_install
sudo make install
</code></pre> 
<p>安装：</p> 
<p>把bzImage复制到WSL系统外并且添加配置文件告诉WSL它在哪：</p> 
<pre><code>cp arch/x86/boot/bzImage /mnt/c/Users/windows你的用户名/can_bzImage
</code></pre> 
<p>然后在c/Users/路径下创建.wslconfig文件，以文本方式打开并键入：</p> 
<pre><code>[wsl2]
kernel=C:\\Users\\xxxxx\\刚刚bzImage的名字不带后缀
</code></pre> 
<p>重启WSL2：</p> 
<pre><code>wsl --shutdown
</code></pre> 
<p>应该能看到自己起的名字</p> 
<pre><code>uname -r                    
</code></pre> 
<p><img src="https://images2.imgbox.com/3e/6d/ibTvmKBI_o.png" alt=""></p> 
<p>安装can工具驱动：</p> 
<pre><code>sudo apt install can-utils
</code></pre> 
<p>设置CAN驱动：</p> 
<pre><code>sudo modprobe can
sudo modprobe can-raw
sudo modprobe can-gw
</code></pre> 
<p><strong>设置虚拟CAN</strong></p> 
<pre><code>sudo modprobe vcan

sudo ip link add dev vcan0 type vcan
sudo ip link add dev vcan1 type vcan
sudo ip link set up vcan0
sudo ip link set up vcan1
</code></pre> 
<p>然后把vcan0和vcan1连接起来：</p> 
<pre><code>sudo cangw -A -s vcan0 -d vcan1 -e 
</code></pre> 
<p>控制台1监控vcan1接收到的数据：</p> 
<pre><code>sudo candump vcan1

</code></pre> 
<p>控制台2通过vcan0发送数据：</p> 
<pre><code>cansend vcan0 123#0011
</code></pre> 
<p>出现下面的界面，则说明CAN驱动已经编译安装好了。</p> 
<p><img src="https://images2.imgbox.com/f7/8e/K9DF7hCU_o.png" alt=""></p> 
<p><strong>WSL2挂载USB CAN设备</strong></p> 
<p>Linux对CAN的支持比Windows更友好，因为Linux有SocketCAN这层协议，SocketCAN可以把许多标准的CAN协议转换成Socket套接字方式的网络协议（网上那种自带串口上位机的非标准协议USB转CAN模块除外），因此扩展性和兼容性更强，而Windows没有。。。所以这也是选择WSL2的原因之一。</p> 
<p>这里我使用的是Pogo科技的CANv2模块，内置SLCAN协议，在Linux系统下可以转换成SocketCAN协议，在Windows系统也可以直连DroneCAN_GUI_TOOL,对调试DroneCAN来说非常方便，可从淘宝购买：<a href="https://item.taobao.com/item.htm?spm=a21n57.1.0.0.aa72523c7Y5zQv&amp;id=734695507467&amp;ns=1&amp;abbucket=15#detail" rel="nofollow">https://item.taobao.com/item.htm?spm=a21n57.1.0.0.aa72523c7Y5zQv&amp;id=734695507467&amp;ns=1&amp;abbucket=15#detail</a>：</p> 
<p><img src="https://images2.imgbox.com/b9/35/QcInGBTE_o.png" alt=""></p> 
<p>当wsl2中使用usb设备时，必须先将其从windows挂到wsl中，WSL2 本身并不支持连接 USB 设备，所以需要安装 usbipd-win。</p> 
<p><strong>第一步：</strong></p> 
<p>在管理员Powershell：</p> 
<pre><code>winget install --interactive --exact dorssel.usbipd-win
#重启wsl
wsl --shutdown
usbipd wsl list
</code></pre> 
<p><strong>第二步：</strong></p> 
<p>在wsl2中执行：</p> 
<pre><code>sudo apt install linux-tools-virtual hwdata
sudo update-alternatives --install /usr/local/bin/usbip usbip `ls /usr/lib/linux-tools/*/usbip | tail -n1` 20
</code></pre> 
<p><strong>第三步：</strong></p> 
<p>在管理员Powershell：</p> 
<pre><code>usbipd wsl list
</code></pre> 
<p><img src="https://images2.imgbox.com/dd/05/9Kcqd8jJ_o.png" alt=""></p> 
<p>图中出现的2-12就是我们要挂在WSL2的设备：</p> 
<pre><code>2-12   0483:5740  STMicroelectronics Virtual COM Port (COM39)                   Not attached
</code></pre> 
<p>然后在管理员Powershell执行：</p> 
<pre><code>usbipd wsl attach --busid 2-12
</code></pre> 
<p><strong>第四步：</strong></p> 
<p>在wsl2中执行：</p> 
<pre><code>lsusb
</code></pre> 
<p><img src="https://images2.imgbox.com/33/e4/DC6MEfDc_o.png" alt=""></p> 
<p>出现了<code>STMicroelectronics Virtual COM Port</code>，则说明挂载成功。</p> 
<p><strong>WSL2中USB CAN和虚拟CAN互通</strong></p> 
<p>由于<code>Pogo CANv2</code>是SLCAN协议的CAN模块，执行下面命令：</p> 
<pre><code>sudo modprobe can
sudo modprobe can-raw
sudo modprobe can-gw
sudo modprobe slcan
sudo modprobe vcan

sudo slcand -o -c -s8 /dev/ttyACM2 can0

sudo ifconfig can0 up

</code></pre> 
<p>输入ifconfig：</p> 
<p><img src="https://images2.imgbox.com/27/a1/d4TLqGhj_o.png" alt=""></p> 
<p>出现了can0、vcan0、vcan1，则说明USBCAN、虚拟CAN都连接到网络了。</p> 
<p>然后输入下面指令，将can0和vcan0连起来，下面的意思就是把can0和vcan0连到同一局域网，vcan0会收到can0的数据，反过来写亦之：</p> 
<pre><code>sudo cangw -A -s can0 -d vcan0 -e
</code></pre> 
<p>我这里将CANv2连到了CubeOrange飞控上：</p> 
<p><img src="https://images2.imgbox.com/54/30/HgjoZKFL_o.png" alt=""></p> 
<p>然后打开两个终端，分别输入：<code>sudo candump can0</code> <code>sudo candump vcan0</code></p> 
<p><img src="https://images2.imgbox.com/c0/2b/O6Zy2yTw_o.png" alt=""></p> 
<p>可以看到图中，vcan0和can0收到了同样的数据</p> 
<p><strong>WSL2中DroneCAN_GUI_TOOL</strong></p> 
<p>使用SocketCAN的好处也是不言而喻的，在DroneCAN_GUI_TOOL中，不仅可以用USBCAN收发数据，也可以用vcan0，接上章，把can0和vcan0路由在一起后，即可以用can0连接在DroneCAN_GUI_TOOL中，也可以用vcan0连DroneCAN_GUI_TOOL，如下图所示。</p> 
<p><img src="https://images2.imgbox.com/bc/25/GeWqJFwh_o.png" alt=""></p> 
<p><img src="https://images2.imgbox.com/06/cd/osgN1uLX_o.png" alt=""></p> 
<p>所以，CAN在Linux中可以做更多的扩展，而Windows则实现不了，一个CAN就是一个CAN，而在Linux中，可以通过SocketCAN套接字的方式拓展成网络设备。因此，想要高级开发的话，还是选WSL2吧</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/16999f4683991137adea5dc2a6e5cfac/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">kafka一篇文章解答90%以上面试问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/83218ac34c1834c26781fe4bde918ee4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Welcome</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>