<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Skywalking(8.7)安装以及docker镜像打包 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Skywalking(8.7)安装以及docker镜像打包" />
<meta property="og:description" content="Skywalking安装以及docker镜像打包 Skywalking版本：apache-skywalking-apm-es7-8.7.0
ES版本：7.17.2
一.下载Skywalking的安装包 下载地址：Index of /dist/skywalking/8.7.0 (apache.org)
上传到服务器安装目录并解压
#这里选择的安装目录是/usr/local cd /usr/local tar -zxvf apache-skywalking-apm-es7-8.7.0.tar.gz 二.查看并修改配置文件 #进入解压好的目录 cd apache-skywalking-apm-bin-es7 #编辑配置文件 vi config/application.yml 在配置文件中找到图片所在的位置
此处修改的地方为SW_STORAGE:elasticsearch7，elasticsearch7是该文档中的一个es数据存储的配置项。
然后修改es存储的地址，在图片中如下位置修改：
然后退出保存
storage.elasticsearch7，配置项，设置使用 Elasticsearch 7.X 版本作为存储器，本次安装选用的es7，所以需要配置es的地址。storage.elasticsearch，配置项，设置使用 Elasticsearch 6.X 版本作为存储器。所以无需做任何改动。storage.h2，配置项，设置使用 H2 作为存储器。 如服务器出现端口占用，还可以选择更改Skywalking的端口。
vi webapp/webapp.yml 三.启动Skywalking cd bin/ ls 这里可以看见有三个启动脚本，分别是oap启动脚本，webServer的启动脚本，和同时启动两个服务的脚本startup.sh。
因为是首次安装，所以先启动oap，执行oapService.sh，然后看日志输出。打开 logs/skywalking-oap-server.log 日志文件，查看是否有错误日志。首次启动时，因为 SkyWalking OAP 会创建 Elasticsearch 的索引，所以会一直打印日志，如下图。
最终，我们看到如下日志，基本可以代表 SkyWalking OAP 服务启动成功：
org.eclipse.jetty.server.Server - 444 [main] INFO [] - Started 因为首次启动oap会创建大量索引，所以需要花费较长时间。
然后启动webappServer，执行webappService.sh，然后通过ip加配置的端口访问UI页面，能成功进入就算安装成功。
四.使用Nginx，配置oap-server 域名 在配置SkyWalking Agent的时候，oap在接收代理数据的时候报错。所以需要通过Nginx配置grpc 通信" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/49fc6eefc0f165b022dd5c3b02d0fcb2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-09T10:42:09+08:00" />
<meta property="article:modified_time" content="2024-01-09T10:42:09+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Skywalking(8.7)安装以及docker镜像打包</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="Skywalkingdocker_2"></a>Skywalking安装以及docker镜像打包</h3> 
<blockquote> 
 <p>Skywalking版本：apache-skywalking-apm-es7-8.7.0</p> 
 <p>ES版本：7.17.2</p> 
</blockquote> 
<h4><a id="Skywalking_10"></a>一.下载Skywalking的安装包</h4> 
<blockquote> 
 <p>下载地址：<a href="https://archive.apache.org/dist/skywalking/8.7.0/" rel="nofollow">Index of /dist/skywalking/8.7.0 (apache.org)</a></p> 
 <p><img src="https://images2.imgbox.com/08/4d/AyNiBHIR_o.png" alt="image-20240105110418630"></p> 
</blockquote> 
<p>上传到服务器安装目录并解压</p> 
<pre><code class="prism language-shell"><span class="token comment">#这里选择的安装目录是/usr/local</span>
<span class="token builtin class-name">cd</span> /usr/local
<span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> apache-skywalking-apm-es7-8.7.0.tar.gz
</code></pre> 
<p><img src="https://images2.imgbox.com/71/52/vNhrFqyh_o.png" alt="image-20240105115542247"></p> 
<h4><a id="_30"></a>二.查看并修改配置文件</h4> 
<pre><code class="prism language-shell"><span class="token comment">#进入解压好的目录</span>
<span class="token builtin class-name">cd</span> apache-skywalking-apm-bin-es7
<span class="token comment">#编辑配置文件</span>
<span class="token function">vi</span> config/application.yml
</code></pre> 
<p>在配置文件中找到图片所在的位置</p> 
<p><img src="https://images2.imgbox.com/37/4b/j9tB4Ana_o.png" alt="image-20240108093627399"></p> 
<blockquote> 
 <p>此处修改的地方为<code>SW_STORAGE:elasticsearch7</code>，<code>elasticsearch7</code>是该文档中的一个es数据存储的配置项。</p> 
</blockquote> 
<p>然后修改es存储的地址，在图片中如下位置修改：</p> 
<p><img src="https://images2.imgbox.com/12/0c/apJu86ch_o.png" alt="image-20240108093857684"></p> 
<p>然后退出保存</p> 
<blockquote> 
 <ul><li>storage.elasticsearch7，配置项，设置使用 Elasticsearch 7.X 版本作为存储器，本次安装选用的es7，所以需要配置es的地址。</li><li>storage.elasticsearch，配置项，设置使用 Elasticsearch 6.X 版本作为存储器。所以无需做任何改动。</li><li>storage.h2，配置项，设置使用 H2 作为存储器。</li></ul> 
</blockquote> 
<p>如服务器出现端口占用，还可以选择更改Skywalking的端口。</p> 
<pre><code class="prism language-shell"><span class="token function">vi</span> webapp/webapp.yml
</code></pre> 
<p><img src="https://images2.imgbox.com/95/9d/qYyQikru_o.png" alt="image-20240108100011551"></p> 
<h4><a id="Skywalking_65"></a>三.启动Skywalking</h4> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> bin/
<span class="token function">ls</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/d6/f7/IRVhsOYy_o.png" alt="image-20240108100054090"></p> 
<p>这里可以看见有三个启动脚本，分别是oap启动脚本，webServer的启动脚本，和同时启动两个服务的脚本startup.sh。</p> 
<p>因为是首次安装，所以先启动oap，执行<code>oapService.sh</code>，然后看日志输出。打开 <code>logs/skywalking-oap-server.log</code> 日志文件，查看是否有错误日志。首次启动时，因为 SkyWalking OAP 会创建 Elasticsearch 的索引，所以会一直打印日志，如下图。</p> 
<p><img src="https://images2.imgbox.com/6b/e1/lbdvWtJR_o.png" alt="image-20240108102440907"></p> 
<p>最终，我们看到如下日志，基本可以代表 SkyWalking OAP 服务启动成功：</p> 
<pre><code>org.eclipse.jetty.server.Server - 444 [main] INFO  [] - Started
</code></pre> 
<p>因为首次启动oap会创建大量索引，所以需要花费较长时间。</p> 
<p>然后启动webappServer，执行<code>webappService.sh</code>，然后通过ip加配置的端口访问UI页面，能成功进入就算安装成功。</p> 
<p><img src="https://images2.imgbox.com/f4/07/vID2N8oU_o.png" alt="image-20240108103429497"></p> 
<h4><a id="Nginxoapserver__92"></a>四.使用Nginx，配置oap-server 域名</h4> 
<blockquote> 
 <p>在配置SkyWalking Agent的时候，oap在接收代理数据的时候报错。所以需要通过Nginx配置grpc 通信</p> 
 <p><img src="https://images2.imgbox.com/56/ec/vctjyC9s_o.png" alt="image-20240108161636711"></p> 
</blockquote> 
<p>在Nginx中作如下配置：</p> 
<pre><code># grpc 代理配置
server {
	listen 11800 http2; # grpc方式对外暴露端口
	server_name localhost;
	# access_log logs/access.log main;
	location / {
		grpc_pass grpc://&lt;Sktwalking主机IP&gt;:11800; # 此处配置grpc服务的ip和端口
	}
}
</code></pre> 
<blockquote> 
 <p>需要注意http2 和 http的端口不能重复。</p> 
 <p>一般Nginx安装的时候默认是没有ngx_http_v2_module模块的，所以需要安装，<a href="https://blog.csdn.net/qq_43479188/article/details/135474371">教程地址</a>。</p> 
</blockquote> 
<h4><a id="SkyWalking_Agent_116"></a>五.配置SkyWalking Agent</h4> 
<blockquote> 
 <p>此处选择使用Dockerfile，在打包的时候把探针打入Java后端的镜像。</p> 
</blockquote> 
<p>Dockerfile文件：</p> 
<pre><code class="prism language-dockerfile"># 配置了sky-walking的dockerfile
FROM &lt;jdk11基础镜像&gt;
MAINTAINER uni
WORKDIR /usr/app
RUN ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
RUN echo 'Asia/Shanghai' &gt;/etc/timezone
ARG APP_NAME="app"
ARG PORT=10001
ENV JAVA_OPTS="-Xms512m -Xmx512m" \
    SPRING_PROFILES_ACTIVE=$PROFILE \
    APPLICATION_NAME=$APP_NAME \
    SW_AGENT_COLLECTOR_BACKEND_SERVICES="&lt;通过Nginx代理后的地址&gt;:11800"

ADD ./target/${APPLICATION_NAME}.jar ${APPLICATION_NAME}.jar
# 将agent文件夹放入容器，jenkins配置里，docker build前一步，cp到target文件夹下的
ADD ./target/agent/ /usr/local/agent
EXPOSE ${EXPORT}
ENTRYPOINT exec java ${JAVA_OPTS} -javaagent:/usr/local/agent/skywalking-agent.jar -Dskywalking.agent.service_name=$APPLICATION_NAME -Dskywalking.collector.backend_service=${SW_AGENT_COLLECTOR_BACKEND_SERVICES}  -jar -Dspring.profiles.active=${SPRING_PROFILES_ACTIVE} ${APPLICATION_NAME}.jar
</code></pre> 
<blockquote> 
 <p><code>APPLICATION_NAME=$APP_NAME</code>是docker打包时传入的后端服务名称的值，<code>SPRING_PROFILES_ACTIVE=$PROFILE</code>用于指定运行环境。</p> 
 <p>文档中的target/agent/，这个agent文件是，apache-skywalking-apm-bin-es7目录下的agent文件夹，我这里是提前cp到，Dockerfile打包目录下的target目录下的。同样，请确保你的后端Jar包文件和agent处于同一目录。</p> 
</blockquote> 
<p>执行打包命令</p> 
<pre><code class="prism language-shell"><span class="token function">docker</span> build --build-arg <span class="token assign-left variable">APP_NAME</span><span class="token operator">=</span><span class="token operator">&lt;</span>自己的项目名<span class="token operator">&gt;</span> --build-arg <span class="token assign-left variable">PROFILE</span><span class="token operator">=</span>test --build-arg <span class="token assign-left variable">PORT</span><span class="token operator">=</span><span class="token number">8080</span> <span class="token parameter variable">-f</span> Dockerfile <span class="token parameter variable">-t</span> <span class="token operator">&lt;</span>自己的harbor私服地址<span class="token operator">&gt;</span>/<span class="token operator">&lt;</span>自己的项目名<span class="token operator">&gt;</span>:test-1 <span class="token builtin class-name">.</span>
</code></pre> 
<blockquote> 
 <p>这里的APP_NAME换成自己的项目名，PROFILE是你的运行环境，这边默认为test，-t后面是自己的镜像名，一般默认是私服地址+项目名+tag</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token comment">#然后上传自己打包的镜像到私服</span>
<span class="token function">docker</span> push <span class="token operator">&lt;</span>自己的harbor私服地址<span class="token operator">&gt;</span>/<span class="token operator">&lt;</span>自己的项目名<span class="token operator">&gt;</span>:test-1
</code></pre> 
<p>然后在目标服务器用docker运行测试，看项目是否启动。成功配置的结果，如下图：</p> 
<p><img src="https://images2.imgbox.com/1b/a4/inW5vhDq_o.png" alt="image-20240104180902903"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e6d940984f6479aaaeb756f1d014fc2f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">React路由进阶方法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d5aecce5406154f42a21171e8f511b16/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">VirtualBox安装OpenEuler</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>