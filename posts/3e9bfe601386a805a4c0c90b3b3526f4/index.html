<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>深入了解RecyclerView - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="深入了解RecyclerView" />
<meta property="og:description" content="RecyclerView缓存机制 说到Android的布局，ListView肯定是最常用的控件之一了，而提到ListView就不得不说起RecyclerView了，强大的RecyclerView不仅可以实现和ListView同样的效果，还优化了ListView中存在的各种不足之处。Android官方更加推荐使用RecyclerView。官方给RecyclerView的解释：
A flexible view for providing a limited window into a large data set.
翻译过来的意思就是一个为大数据集提供有限窗口的灵活视图。如果我们想用好这个RecyclerView，那么对于他的缓存机制我们就有了解的必要了，下面我们就来看下RecyclerView 的缓存机制
RecyclerView的缓存类 RecyclerView 有几个比较重要的缓存类：Recycler，RecycledViewPool，ViewCacheExtension
Recycler 我们先来看下源码（ 部分）
public final class Recycler { final ArrayList&lt;ViewHolder&gt; mAttachedScrap = new ArrayList&lt;&gt;(); ArrayList&lt;ViewHolder&gt; mChangedScrap = null; final ArrayList&lt;ViewHolder&gt; mCachedViews = new ArrayList&lt;ViewHolder&gt;(); int mViewCacheMax = DEFAULT_CACHE_SIZE; RecycledViewPool mRecyclerPool; private ViewCacheExtension mViewCacheExtension; static final int DEFAULT_CACHE_SIZE = 2; ...省略... } 这个Recycler 类里就基本包含了所有的缓存类，首先说下他的成员变量
mAttachedScrap ：这个变量用一个ArrayList存放了ViewHolder，这里的ViewHolder的数据是不做修改的，当使用到这里的缓存的时候是不用走adapter的绑定方法的。mChangedScrap ：这个变量和上面的mAttachedScrap 一样，不过有区别的是这里存放的是已经变了的ViewHolder，使用到了这个缓存的话是需要重新走adapter的绑定方法的。mCachedViews ：这个存放的是已经与RecyclerView分离了的ViewHolder，但是他依然保存了ViewHolder的信息，比如position，数据等。这里的默认的大小为2，就是mViewCacheMax这个变量，不过我们可以人为的改变他的大小，用到了RecyclerView.setItemViewCacheSize()方法。mRecyclerPool：这个就是一个缓存类，从名字中我们也可以看到，是一个缓存池。进入这个类我们可以看到： public static class RecycledViewPool { private static final int DEFAULT_MAX_SCRAP = 5; ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/3e9bfe601386a805a4c0c90b3b3526f4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-10-19T12:18:49+08:00" />
<meta property="article:modified_time" content="2022-10-19T12:18:49+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">深入了解RecyclerView</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="RecyclerView_0"></a>RecyclerView缓存机制</h2> 
<p>说到Android的布局，ListView肯定是最常用的控件之一了，而提到ListView就不得不说起RecyclerView了，强大的RecyclerView不仅可以实现和ListView同样的效果，还优化了ListView中存在的各种不足之处。Android官方更加推荐使用RecyclerView。官方给RecyclerView的解释：</p> 
<blockquote> 
 <p>A flexible view for providing a limited window into a large data set.</p> 
</blockquote> 
<p>翻译过来的意思就是一个为大数据集提供有限窗口的灵活视图。如果我们想用好这个RecyclerView，那么对于他的缓存机制我们就有了解的必要了，下面我们就来看下RecyclerView 的缓存机制</p> 
<h3><a id="RecyclerView_7"></a>RecyclerView的缓存类</h3> 
<p>RecyclerView 有几个比较重要的缓存类：Recycler，RecycledViewPool，ViewCacheExtension</p> 
<h4><a id="Recycler_10"></a>Recycler</h4> 
<p>我们先来看下源码（ 部分）</p> 
<pre><code class="prism language-java">	<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Recycler</span> <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">final</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ViewHolder</span><span class="token punctuation">&gt;</span></span> mAttachedScrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ViewHolder</span><span class="token punctuation">&gt;</span></span> mChangedScrap <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      
        <span class="token keyword">final</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ViewHolder</span><span class="token punctuation">&gt;</span></span> mCachedViews <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ViewHolder</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> mViewCacheMax <span class="token operator">=</span> DEFAULT_CACHE_SIZE<span class="token punctuation">;</span>

        <span class="token class-name">RecycledViewPool</span> mRecyclerPool<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">ViewCacheExtension</span> mViewCacheExtension<span class="token punctuation">;</span>

        <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DEFAULT_CACHE_SIZE <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
	 	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>省略<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>这个Recycler 类里就基本包含了所有的缓存类，首先说下他的成员变量</p> 
<ol><li>mAttachedScrap ：这个变量用一个ArrayList存放了ViewHolder，这里的ViewHolder的数据是不做修改的，当使用到这里的缓存的时候是不用走adapter的绑定方法的。</li><li>mChangedScrap ：这个变量和上面的mAttachedScrap 一样，不过有区别的是这里存放的是已经变了的ViewHolder，使用到了这个缓存的话是需要重新走adapter的绑定方法的。</li><li>mCachedViews ：这个存放的是已经与RecyclerView分离了的ViewHolder，但是他依然保存了ViewHolder的信息，比如position，数据等。这里的默认的大小为2，就是mViewCacheMax这个变量，不过我们可以人为的改变他的大小，用到了RecyclerView.setItemViewCacheSize()方法。</li><li>mRecyclerPool：这个就是一个缓存类，从名字中我们也可以看到，是一个缓存池。进入这个类我们可以看到：</li></ol> 
<pre><code class="prism language-java">	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">RecycledViewPool</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DEFAULT_MAX_SCRAP <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>省略<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ScrapData</span> <span class="token punctuation">{<!-- --></span>
           <span class="token keyword">final</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ViewHolder</span><span class="token punctuation">&gt;</span></span> mScrapHeap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">int</span> mMaxScrap <span class="token operator">=</span> DEFAULT_MAX_SCRAP<span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token class-name">SparseArray</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ScrapData</span><span class="token punctuation">&gt;</span></span> mScrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SparseArray</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token keyword">private</span> <span class="token keyword">int</span> mAttachCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>省略<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
</code></pre> 
<ul><li>首先看到的就是这个常量DEFAULT_MAX_SCRAP ，这个指的就是这个缓存池默认的缓存数，这个数量也是可以修改的，而且这个数量指的并不是这个池子可以缓存这么多，而指的是每个itemType可以缓存的ViewHolder数量。</li><li>接下来就是静态内部类ScrapData ，这里面也创建了一个存储ViewHoler的ArrayList，和一个mMaxScrap ，表示了这个默认的缓存数为5。</li><li>最后就是SparseArray ，它存储了我们上面的ScrapData ，这样的话就可以通过区分itemType来缓存ViewHolder了。</li></ul> 
<ol start="5"><li>mViewCacheExtension：是一个抽象类，开发者可以自己去定义这个缓存类，我们可以根据实际场景来制定。</li></ol> 
<h3><a id="RecyclerView__59"></a>RecyclerView 的加载过程</h3> 
<p>上面介绍了RecyclerView 的几个比较重要的缓存类，那他们之间是怎么样工作的呢？下面我就就来看一下RecyclerView 的加载过程，一个view从创建到显示出来大概要经过measure，layout，draw这么几个方法，我们来看measure这个过程，定位到RecyclerView 的onMeasure()方法：</p> 
<pre><code class="prism language-java">	<span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onMeasure</span><span class="token punctuation">(</span><span class="token keyword">int</span> widthSpec<span class="token punctuation">,</span> <span class="token keyword">int</span> heightSpec<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mLayout <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">defaultOnMeasure</span><span class="token punctuation">(</span>widthSpec<span class="token punctuation">,</span> heightSpec<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mLayout<span class="token punctuation">.</span><span class="token function">isAutoMeasureEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mState<span class="token punctuation">.</span>mLayoutStep <span class="token operator">==</span> <span class="token class-name">State</span><span class="token punctuation">.</span>STEP_START<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">dispatchLayoutStep1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">dispatchLayoutStep2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>省略了一些无关的代码，其中比较重要的方法dispatchLayoutStep1()和dispatchLayoutStep2()，我们可以看到影响dispatchLayoutStep1()方法运行的条件是mState.mLayoutStep == State.STEP_START，我们进入源码可以看到：State.STEP_START是一个常量，值为1，mState.mLayoutStep指向了一个变量</p> 
<pre><code class="prism language-java">	<span class="token keyword">int</span> mLayoutStep <span class="token operator">=</span> STEP_START<span class="token punctuation">;</span>
</code></pre> 
<p>条件为true所以首先进入到dispatchLayoutStep1()</p> 
<pre><code class="prism language-java">	<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">dispatchLayoutStep1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mState<span class="token punctuation">.</span>mRunSimpleAnimations<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mState<span class="token punctuation">.</span>mRunPredictiveAnimations<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">clearOldPositions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mState<span class="token punctuation">.</span>mLayoutStep <span class="token operator">=</span> <span class="token class-name">State</span><span class="token punctuation">.</span>STEP_LAYOUT<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>有两个比较重要的if语句，条件为mState.mRunSimpleAnimations和mState.mRunPredictiveAnimations，点击进去我们可以发现</p> 
<pre><code class="prism language-java">	<span class="token keyword">boolean</span> mRunSimpleAnimations <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token keyword">boolean</span> mRunPredictiveAnimations <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
</code></pre> 
<p>这两个变量默认都为false，第二个判断走了一个clearOldPositions()方法，从字面意思上来看就是清除之前的position操作，由于我们是第一次加载，这个方法暂且与我们无关，接下来就是mState.mLayoutStep = State.STEP_LAYOUT，我们可以看到这里的值改变了，方法结束，返回到onMeasure我们来往下看dispatchLayoutStep2()方法：</p> 
<pre><code class="prism language-java">	<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">dispatchLayoutStep2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">startInterceptRequestLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">onEnterLayoutOrScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mState<span class="token punctuation">.</span><span class="token function">assertLayoutStep</span><span class="token punctuation">(</span><span class="token class-name">State</span><span class="token punctuation">.</span>STEP_LAYOUT <span class="token operator">|</span> <span class="token class-name">State</span><span class="token punctuation">.</span>STEP_ANIMATIONS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mAdapterHelper<span class="token punctuation">.</span><span class="token function">consumeUpdatesInOnePass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mState<span class="token punctuation">.</span>mItemCount <span class="token operator">=</span> mAdapter<span class="token punctuation">.</span><span class="token function">getItemCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mState<span class="token punctuation">.</span>mDeletedInvisibleItemCountSincePreviousLayout <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment">// Step 2: Run layout</span>
        mState<span class="token punctuation">.</span>mInPreLayout <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        mLayout<span class="token punctuation">.</span><span class="token function">onLayoutChildren</span><span class="token punctuation">(</span>mRecycler<span class="token punctuation">,</span> mState<span class="token punctuation">)</span><span class="token punctuation">;</span>

        mState<span class="token punctuation">.</span>mStructureChanged <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        mPendingSavedState <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token comment">// onLayoutChildren may have caused client code to disable item animations; re-check</span>
        mState<span class="token punctuation">.</span>mRunSimpleAnimations <span class="token operator">=</span> mState<span class="token punctuation">.</span>mRunSimpleAnimations <span class="token operator">&amp;&amp;</span> mItemAnimator <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        mState<span class="token punctuation">.</span>mLayoutStep <span class="token operator">=</span> <span class="token class-name">State</span><span class="token punctuation">.</span>STEP_ANIMATIONS<span class="token punctuation">;</span>
        <span class="token function">onExitLayoutOrScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">stopInterceptRequestLayout</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>在这个方法会调用到mLayout.onLayoutChildren(mRecycler, mState)方法，mLayout也就是LayoutManager，我们去LinearLayoutManager里看看onLayoutChildren到底都做了什么</p> 
<pre><code class="prism language-java">	<span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onLayoutChildren</span><span class="token punctuation">(</span><span class="token class-name">RecyclerView<span class="token punctuation">.</span>Recycler</span> recycler<span class="token punctuation">,</span> <span class="token class-name">RecyclerView<span class="token punctuation">.</span>State</span> state<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
     	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token function">detachAndScrapAttachedViews</span><span class="token punctuation">(</span>recycler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mAnchorInfo<span class="token punctuation">.</span>mLayoutFromEnd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token comment">// fill towards start</span>
            <span class="token function">fill</span><span class="token punctuation">(</span>recycler<span class="token punctuation">,</span> mLayoutState<span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            startOffset <span class="token operator">=</span> mLayoutState<span class="token punctuation">.</span>mOffset<span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token function">fill</span><span class="token punctuation">(</span>recycler<span class="token punctuation">,</span> mLayoutState<span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            endOffset <span class="token operator">=</span> mLayoutState<span class="token punctuation">.</span>mOffset<span class="token punctuation">;</span>
			<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token comment">// fill towards end</span>
            <span class="token function">fill</span><span class="token punctuation">(</span>recycler<span class="token punctuation">,</span> mLayoutState<span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            endOffset <span class="token operator">=</span> mLayoutState<span class="token punctuation">.</span>mOffset<span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token function">fill</span><span class="token punctuation">(</span>recycler<span class="token punctuation">,</span> mLayoutState<span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            startOffset <span class="token operator">=</span> mLayoutState<span class="token punctuation">.</span>mOffset<span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>这个方法代码比较多，我只拿出了对我们比较重要的代码，首先来看下detachAndScrapAttachedViews(recycler)方法</p> 
<pre><code class="prism language-java">		<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">detachAndScrapAttachedViews</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Recycler</span> recycler<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> childCount <span class="token operator">=</span> <span class="token function">getChildCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> childCount <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">final</span> <span class="token class-name">View</span> v <span class="token operator">=</span> <span class="token function">getChildAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">scrapOrRecycleView</span><span class="token punctuation">(</span>recycler<span class="token punctuation">,</span> i<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">scrapOrRecycleView</span><span class="token punctuation">(</span><span class="token class-name">Recycler</span> recycler<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">,</span> <span class="token class-name">View</span> view<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token class-name">ViewHolder</span> viewHolder <span class="token operator">=</span> <span class="token function">getChildViewHolderInt</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>viewHolder<span class="token punctuation">.</span><span class="token function">isInvalid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>viewHolder<span class="token punctuation">.</span><span class="token function">isRemoved</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mRecyclerView<span class="token punctuation">.</span>mAdapter<span class="token punctuation">.</span><span class="token function">hasStableIds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">removeViewAt</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
                recycler<span class="token punctuation">.</span><span class="token function">recycleViewHolderInternal</span><span class="token punctuation">(</span>viewHolder<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">detachViewAt</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
                recycler<span class="token punctuation">.</span><span class="token function">scrapView</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mRecyclerView<span class="token punctuation">.</span>mViewInfoStore<span class="token punctuation">.</span><span class="token function">onViewDetached</span><span class="token punctuation">(</span>viewHolder<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>detachAndScrapAttachedViews方法里调用了scrapOrRecycleView(recycler, i, v)方法，在这个方法里正常第一次布局的时候是会走else分支，在else分支里我们看到了recycler这个成员变量，也就是Recycler ，熟悉的东西来了，我们走进recycler.scrapView(view);</p> 
<pre><code class="prism language-java">		<span class="token keyword">void</span> <span class="token function">scrapView</span><span class="token punctuation">(</span><span class="token class-name">View</span> view<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token class-name">ViewHolder</span> holder <span class="token operator">=</span> <span class="token function">getChildViewHolderInt</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>holder<span class="token punctuation">.</span><span class="token function">hasAnyOfTheFlags</span><span class="token punctuation">(</span><span class="token class-name">ViewHolder</span><span class="token punctuation">.</span>FLAG_REMOVED <span class="token operator">|</span> <span class="token class-name">ViewHolder</span><span class="token punctuation">.</span>FLAG_INVALID<span class="token punctuation">)</span>
                    <span class="token operator">||</span> <span class="token operator">!</span>holder<span class="token punctuation">.</span><span class="token function">isUpdated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">canReuseUpdatedViewHolder</span><span class="token punctuation">(</span>holder<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>holder<span class="token punctuation">.</span><span class="token function">isInvalid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>holder<span class="token punctuation">.</span><span class="token function">isRemoved</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mAdapter<span class="token punctuation">.</span><span class="token function">hasStableIds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Called scrap view with an invalid view."</span>
                            <span class="token operator">+</span> <span class="token string">" Invalid views cannot be reused from scrap, they should rebound from"</span>
                            <span class="token operator">+</span> <span class="token string">" recycler pool."</span> <span class="token operator">+</span> <span class="token function">exceptionLabel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                holder<span class="token punctuation">.</span><span class="token function">setScrapContainer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mAttachedScrap<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>holder<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mChangedScrap <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    mChangedScrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ViewHolder</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                holder<span class="token punctuation">.</span><span class="token function">setScrapContainer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mChangedScrap<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>holder<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>进到这个方法里，我们看到了熟悉的mAttachedScrap和mChangedScrap，到这里我们基本可以知道，在首次布局onLayoutChildren()调用了detachAndScrapAttachedViews(recycler)方法中把我们的view添加到了mAttachedScrap缓存中。接下来我们返回到onLayoutChildren方法，下面有个if语句，不过最终还是会走fill方法，fill方法里又调用了layoutChunk()方法，我们来看一看这个layoutChunk()里做了什么</p> 
<pre><code class="prism language-java">	<span class="token keyword">void</span> <span class="token function">layoutChunk</span><span class="token punctuation">(</span><span class="token class-name">RecyclerView<span class="token punctuation">.</span>Recycler</span> recycler<span class="token punctuation">,</span> <span class="token class-name">RecyclerView<span class="token punctuation">.</span>State</span> state<span class="token punctuation">,</span>
            <span class="token class-name">LayoutState</span> layoutState<span class="token punctuation">,</span> <span class="token class-name">LayoutChunkResult</span> result<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">View</span> view <span class="token operator">=</span> layoutState<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>recycler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token class-name">RecyclerView<span class="token punctuation">.</span>LayoutParams</span> params <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">RecyclerView<span class="token punctuation">.</span>LayoutParams</span><span class="token punctuation">)</span> view<span class="token punctuation">.</span><span class="token function">getLayoutParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>layoutState<span class="token punctuation">.</span>mScrapList <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mShouldReverseLayout <span class="token operator">==</span> <span class="token punctuation">(</span>layoutState<span class="token punctuation">.</span>mLayoutDirection
                    <span class="token operator">==</span> <span class="token class-name">LayoutState</span><span class="token punctuation">.</span>LAYOUT_START<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">addView</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">addView</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mShouldReverseLayout <span class="token operator">==</span> <span class="token punctuation">(</span>layoutState<span class="token punctuation">.</span>mLayoutDirection
                    <span class="token operator">==</span> <span class="token class-name">LayoutState</span><span class="token punctuation">.</span>LAYOUT_START<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">addDisappearingView</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">addDisappearingView</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>首先通过next方法把view拿到，然后经过一系列的判断将view添加到布局里去，我们着重看下next方法，看一看是怎么获取到view的</p> 
<pre><code class="prism language-java">		<span class="token class-name">View</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token class-name">RecyclerView<span class="token punctuation">.</span>Recycler</span> recycler<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mScrapList <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token function">nextViewFromScrapList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">final</span> <span class="token class-name">View</span> view <span class="token operator">=</span> recycler<span class="token punctuation">.</span><span class="token function">getViewForPosition</span><span class="token punctuation">(</span>mCurrentPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mCurrentPosition <span class="token operator">+=</span> mItemDirection<span class="token punctuation">;</span>
            <span class="token keyword">return</span> view<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>如果mScrapList 不为空就走nextViewFromScrapList()方法，我们暂时忽略这个方法，然后走进recycler.getViewForPosition(mCurrentPosition)这个方法，</p> 
<pre><code class="prism language-java">        <span class="token annotation punctuation">@NonNull</span>
        <span class="token keyword">public</span> <span class="token class-name">View</span> <span class="token function">getViewForPosition</span><span class="token punctuation">(</span><span class="token keyword">int</span> position<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">getViewForPosition</span><span class="token punctuation">(</span>position<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">View</span> <span class="token function">getViewForPosition</span><span class="token punctuation">(</span><span class="token keyword">int</span> position<span class="token punctuation">,</span> <span class="token keyword">boolean</span> dryRun<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">tryGetViewHolderForPositionByDeadline</span><span class="token punctuation">(</span>position<span class="token punctuation">,</span> dryRun<span class="token punctuation">,</span> FOREVER_NS<span class="token punctuation">)</span><span class="token punctuation">.</span>itemView<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>经过层层调用，最终走到了tryGetViewHolderForPositionByDeadline(position, dryRun, FOREVER_NS)方法</p> 
<pre><code class="prism language-java">        <span class="token annotation punctuation">@Nullable</span>
        <span class="token class-name">ViewHolder</span> <span class="token function">tryGetViewHolderForPositionByDeadline</span><span class="token punctuation">(</span><span class="token keyword">int</span> position<span class="token punctuation">,</span>
                <span class="token keyword">boolean</span> dryRun<span class="token punctuation">,</span> <span class="token keyword">long</span> deadlineNs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
           
            <span class="token class-name">ViewHolder</span> holder <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token comment">// 0) If there is a changed scrap, try to find from there</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mState<span class="token punctuation">.</span><span class="token function">isPreLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                holder <span class="token operator">=</span> <span class="token function">getChangedScrapViewForPosition</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fromScrapOrHiddenOrCache <span class="token operator">=</span> holder <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 1) Find by position from scrap/hidden list/cache</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>holder <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                holder <span class="token operator">=</span> <span class="token function">getScrapOrHiddenOrCachedHolderForPosition</span><span class="token punctuation">(</span>position<span class="token punctuation">,</span> dryRun<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>holder <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 2) Find from scrap/cache via stable ids, if exists</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>holder <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mViewCacheExtension <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// We are NOT sending the offsetPosition because LayoutManager does not</span>
                    <span class="token comment">// know it.</span>
                    <span class="token keyword">final</span> <span class="token class-name">View</span> view <span class="token operator">=</span> mViewCacheExtension
                            <span class="token punctuation">.</span><span class="token function">getViewForPositionAndType</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> position<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>holder <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// fallback to pool</span>
                    holder <span class="token operator">=</span> <span class="token function">getRecycledViewPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRecycledView</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>holder <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    holder <span class="token operator">=</span> mAdapter<span class="token punctuation">.</span><span class="token function">createViewHolder</span><span class="token punctuation">(</span><span class="token class-name">RecyclerView</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> holder<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>这里面做了很多的事情，view 的获取和绑定都是在这里实现的，我们从顺序往下看</p> 
<ol><li>首先经过第一个if语句，当mState.isPreLayout()为true时就会调用getChangedScrapViewForPosition(position)来获取view；我们在调用adapter的notifyItemChanged等方法时isPreLayout()就为true，意思就是列表的item数据改变了，就会把这个viewHoler放入到mChangedScrap里</li><li>接下来如果没有找到holder 就会走getScrapOrHiddenOrCachedHolderForPosition()方法</li></ol> 
<pre><code class="prism language-java">        <span class="token class-name">ViewHolder</span> <span class="token function">getScrapOrHiddenOrCachedHolderForPosition</span><span class="token punctuation">(</span><span class="token keyword">int</span> position<span class="token punctuation">,</span> <span class="token keyword">boolean</span> dryRun<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> scrapCount <span class="token operator">=</span> mAttachedScrap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token comment">// Try first for an exact, non-invalid match from scrap.</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> scrapCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">final</span> <span class="token class-name">ViewHolder</span> holder <span class="token operator">=</span> mAttachedScrap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dryRun<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">View</span> view <span class="token operator">=</span> mChildHelper<span class="token punctuation">.</span><span class="token function">findHiddenNonRemovedView</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// Search in our first-level recycled view cache.</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> cacheSize <span class="token operator">=</span> mCachedViews<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cacheSize<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">final</span> <span class="token class-name">ViewHolder</span> holder <span class="token operator">=</span> mCachedViews<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>这里面有三个步骤，首先从mAttachedScrap里找，然后再从mChildHelper里的mHiddenViews里找，最后再从mCachedViews里找</p> 
<ol start="3"><li>假如上面的方法依然没有找到holder，就从mViewCacheExtension里找，我们之前说过这个类是给开发者自定义的一个类，如果我们自己没有重写，那么这里是找不到的</li><li>接下来就是在pool中找了，这里调用了getRecycledViewPool().getRecycledView(type)，这个参数type就是我们之前说的viewHoler的类型了</li></ol> 
<pre><code class="prism language-java">        <span class="token keyword">public</span> <span class="token class-name">ViewHolder</span> <span class="token function">getRecycledView</span><span class="token punctuation">(</span><span class="token keyword">int</span> viewType<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token class-name">ScrapData</span> scrapData <span class="token operator">=</span> mScrap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>viewType<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>scrapData <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>scrapData<span class="token punctuation">.</span>mScrapHeap<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">final</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ViewHolder</span><span class="token punctuation">&gt;</span></span> scrapHeap <span class="token operator">=</span> scrapData<span class="token punctuation">.</span>mScrapHeap<span class="token punctuation">;</span>
                <span class="token keyword">return</span> scrapHeap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>scrapHeap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<ol start="5"><li>最后如果上面的方法中都没有找到holder，那么就会调用mAdapter.createViewHolder(RecyclerView.this, type)了，是不是很熟悉？没错，就是我们在Adapter里重写的createViewHolder()方法了。</li></ol> 
<p>到此为止一个RecyclerView从无到有的加载过程我们就分析完了。</p> 
<h3><a id="RecyclerView__323"></a>RecyclerView 的滑动缓存过程</h3> 
<p>我们知道RecyclerView 具有强大的缓存机制，内部也实现了可滑动的机制，那么当滑动时被滑出屏幕外的View和滑动进屏幕内的View他们都是从哪里来的呢，我们一起来看源码</p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">scrollHorizontallyBy</span><span class="token punctuation">(</span><span class="token keyword">int</span> dx<span class="token punctuation">,</span> <span class="token class-name">RecyclerView<span class="token punctuation">.</span>Recycler</span> recycler<span class="token punctuation">,</span>
            <span class="token class-name">RecyclerView<span class="token punctuation">.</span>State</span> state<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mOrientation <span class="token operator">==</span> VERTICAL<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">scrollBy</span><span class="token punctuation">(</span>dx<span class="token punctuation">,</span> recycler<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">scrollVerticallyBy</span><span class="token punctuation">(</span><span class="token keyword">int</span> dy<span class="token punctuation">,</span> <span class="token class-name">RecyclerView<span class="token punctuation">.</span>Recycler</span> recycler<span class="token punctuation">,</span>
            <span class="token class-name">RecyclerView<span class="token punctuation">.</span>State</span> state<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mOrientation <span class="token operator">==</span> HORIZONTAL<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">scrollBy</span><span class="token punctuation">(</span>dy<span class="token punctuation">,</span> recycler<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>我们知道RecyclerView 是可以横向滑动的，那么横向和纵向滑动分别调用了上面的两个方法，他们也最终调用了同一个方法scrollBy(dx, recycler, state)；而这个方法里也调用了fill()方法</p> 
<pre><code class="prism language-java">	<span class="token keyword">int</span> <span class="token function">fill</span><span class="token punctuation">(</span><span class="token class-name">RecyclerView<span class="token punctuation">.</span>Recycler</span> recycler<span class="token punctuation">,</span> <span class="token class-name">LayoutState</span> layoutState<span class="token punctuation">,</span>
            <span class="token class-name">RecyclerView<span class="token punctuation">.</span>State</span> state<span class="token punctuation">,</span> <span class="token keyword">boolean</span> stopOnFocusable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>layoutState<span class="token punctuation">.</span>mScrollingOffset <span class="token operator">!=</span> <span class="token class-name">LayoutState<span class="token punctuation">.</span>SCROLLING_OFFSET_NaN</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// TODO ugly bug fix. should not happen</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>layoutState<span class="token punctuation">.</span>mAvailable <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                layoutState<span class="token punctuation">.</span>mScrollingOffset <span class="token operator">+=</span> layoutState<span class="token punctuation">.</span>mAvailable<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">recycleByLayoutState</span><span class="token punctuation">(</span>recycler<span class="token punctuation">,</span> layoutState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>进入fill方法，这次我们不看layoutChunk()方法，我们来看一下recycleByLayoutState(recycler, layoutState)方法，方法中判断条件分别会走recycleViewsFromEnd()和recycleViewsFromStart()方法,但是这两个方法最终都会调用recycleChildren(recycler, childCount - 1, i)方法，而该方法最后调用了removeAndRecycleViewAt(i, recycler)方法</p> 
<pre><code class="prism language-java">        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">removeAndRecycleViewAt</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Recycler</span> recycler<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token class-name">View</span> view <span class="token operator">=</span> <span class="token function">getChildAt</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">removeViewAt</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
            recycler<span class="token punctuation">.</span><span class="token function">recycleView</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>这里把index位的view给remove掉了，然后调用了recycler.recycleView(view)，紧接着这个方法又调用了recycleViewHolderInternal(holder)方法。</p> 
<pre><code class="prism language-java">       <span class="token keyword">void</span> <span class="token function">recycleViewHolderInternal</span><span class="token punctuation">(</span><span class="token class-name">ViewHolder</span> holder<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>forceRecycle <span class="token operator">||</span> holder<span class="token punctuation">.</span><span class="token function">isRecyclable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mViewCacheMax <span class="token operator">&gt;</span> <span class="token number">0</span>
                        <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>holder<span class="token punctuation">.</span><span class="token function">hasAnyOfTheFlags</span><span class="token punctuation">(</span><span class="token class-name">ViewHolder</span><span class="token punctuation">.</span>FLAG_INVALID
                        <span class="token operator">|</span> <span class="token class-name">ViewHolder</span><span class="token punctuation">.</span>FLAG_REMOVED
                        <span class="token operator">|</span> <span class="token class-name">ViewHolder</span><span class="token punctuation">.</span>FLAG_UPDATE
                        <span class="token operator">|</span> <span class="token class-name">ViewHolder</span><span class="token punctuation">.</span>FLAG_ADAPTER_POSITION_UNKNOWN<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// Retire oldest cached view</span>
                    <span class="token keyword">int</span> cachedViewSize <span class="token operator">=</span> mCachedViews<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>cachedViewSize <span class="token operator">&gt;=</span> mViewCacheMax <span class="token operator">&amp;&amp;</span> cachedViewSize <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token function">recycleCachedViewAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        cachedViewSize<span class="token operator">--</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    
                    mCachedViews<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>targetCacheIndex<span class="token punctuation">,</span> holder<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    cached <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cached<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">addViewHolderToRecycledViewPool</span><span class="token punctuation">(</span>holder<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    recycled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
           <span class="token punctuation">}</span>
</code></pre> 
<p>这里面的逻辑就是先判断mCachedViews的容量是否超过默认值，如果超过了就要走recycleCachedViewAt(0)方法，这个方法里的逻辑就是把最老的缓存放到RecyclePool里，然后把mCachedViews里的remove掉，执行了该操作之后再把新的缓存放到mCachedViews里，如果这个视图不符合条件会直接被放进RecyclerPool中，注意这里有个cached的boolean类型的变量，就是来判断是否符合条件的，RecyclePool里的操作addViewHolderToRecycledViewPool(holder, true)方法最终会调用getRecycledViewPool().putRecycledView(holder);</p> 
<pre><code class="prism language-java">        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">putRecycledView</span><span class="token punctuation">(</span><span class="token class-name">ViewHolder</span> scrap<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> viewType <span class="token operator">=</span> scrap<span class="token punctuation">.</span><span class="token function">getItemViewType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ViewHolder</span><span class="token punctuation">&gt;</span></span> scrapHeap <span class="token operator">=</span> <span class="token function">getScrapDataForType</span><span class="token punctuation">(</span>viewType<span class="token punctuation">)</span><span class="token punctuation">.</span>mScrapHeap<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mScrap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>viewType<span class="token punctuation">)</span><span class="token punctuation">.</span>mMaxScrap <span class="token operator">&lt;=</span> scrapHeap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            scrap<span class="token punctuation">.</span><span class="token function">resetInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            scrapHeap<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>scrap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>这个方法里的逻辑为：首先判断池子里的容量是否满了，如果满了的话就直接返回，不再缓存了，否则的话会调用resetInternal()方法，从reset我们也可以看出是一个重置方法，缓存之前全部清空，这里也就可以说明为什么满了之后就不再继续缓存了，到此为止，滑出屏幕外的缓存过程也就讲完了，那么滑入屏幕内的过程呢，其实是和RecyclerView加载过程是一样的。</p> 
<h2><a id="_405"></a>总结</h2> 
<p>我们从RecyclerView的几个缓存类整体入手，分析成员变量，到RecyclerView的加载过程，再到他的缓存过程，这几个方面了解了RecyclerView缓存层级与缓存机制。</p> 
<p>参考：<br> https://blog.csdn.net/singwhatiwanna/article/details/100166495</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/952b6d79a6cc6ea77eb4dfa0bbd2b093/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">ubuntu18.04 安装nvidia显卡驱动</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/faddced8636cb654bc879767e452f779/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">布式事务Seata和分库分表sharding-sphere的整合</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>