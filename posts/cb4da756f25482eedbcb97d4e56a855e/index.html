<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Nginx实战案例--并发限制与带宽限制 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Nginx实战案例--并发限制与带宽限制" />
<meta property="og:description" content="我们经常会遇到这种情况，服务器流量异常，负载过大等等。对于大流量恶意的攻击访问，会带来带宽的浪费，服务器压力，影响业务，往往考虑对同一个ip的连接数，并发数进行限制。
一、限制并发 1.修改配置文件
[root@server1 conf]# vim nginx.conf 33 #gzip on; 34 limit_conn_zone $binary_remote_addr zone=addr:10m; 35 limit_req_zone $binary_remote_addr zone=one:10m rate=1r/s;	#注意：必须写在server上面 36 server { ...... 54 location /download { 55 limit_conn addr 1; #只能一个并发，多了会报错 56 57 #limit_rate 50k; #限制带宽，每秒最多50k 58 } 其中：
limit_conn_zone $binary_remote_addr zone=addr:10m; 表示大小是10m内存 10m的内存来对IP传输开销
limit_req_zone $binary_remote_addr zone=one:10m rate=1r/s; 1s不超过一个请求
limit_conn_zone 用来限制同一时间连接数，即并发限制
limit_req_zone 用来限制单位时间的请求数，即速率限制，采用漏桶算法
$binary_remote_addr 是限制同一客户端ip地址
zone=addr:10m 表示生成一个大小为10m，名字为one的内存区域，用来存储访问的频次信息
重新加载nginx：
[root@server1 conf]# nginx -t nginx: the configuration file /usr/local/nginx/conf/nginx.conf syntax is ok nginx: configuration file /usr/local/nginx/conf/nginx." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/cb4da756f25482eedbcb97d4e56a855e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-02-26T17:46:25+08:00" />
<meta property="article:modified_time" content="2020-02-26T17:46:25+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Nginx实战案例--并发限制与带宽限制</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>我们经常会遇到这种情况，服务器流量异常，负载过大等等。对于大流量恶意的攻击访问，会带来带宽的浪费，服务器压力，影响业务，往往考虑对同一个ip的连接数，并发数进行限制。</p> 
<h2><a id="_1"></a>一、限制并发</h2> 
<p><strong>1.修改配置文件</strong></p> 
<pre><code class="prism language-handlebars"><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@server1 conf</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">vim</span> <span class="token variable">nginx</span><span class="token punctuation">.</span><span class="token variable">conf</span>

 <span class="token number">33</span>     <span class="token block keyword">#gzip</span>  <span class="token variable">on</span><span class="token punctuation">;</span>
 <span class="token number">34</span>     <span class="token variable">limit_conn_zone</span> <span class="token variable">$binary_remote_addr</span> <span class="token variable">zone</span><span class="token punctuation">=</span><span class="token variable">addr:</span><span class="token number">10</span><span class="token variable">m</span><span class="token punctuation">;</span>
 <span class="token number">35</span>     <span class="token variable">limit_req_zone</span> <span class="token variable">$binary_remote_addr</span> <span class="token variable">zone</span><span class="token punctuation">=</span><span class="token variable">one:</span><span class="token number">10</span><span class="token variable">m</span> <span class="token variable">rate</span><span class="token punctuation">=</span><span class="token number">1</span><span class="token variable">r</span><span class="token punctuation">/</span><span class="token variable">s</span><span class="token punctuation">;</span>			<span class="token punctuation">#</span><span class="token variable">注意：必须写在server上面</span>
 <span class="token number">36</span>     <span class="token variable">server</span> <span class="token punctuation">{<!-- --></span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token number">54</span>         <span class="token variable">location</span> <span class="token punctuation">/</span><span class="token variable">download</span> <span class="token punctuation">{<!-- --></span>
 <span class="token number">55</span>             <span class="token variable">limit_conn</span> <span class="token variable">addr</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token punctuation">#</span><span class="token variable">只能一个并发，多了会报错</span>
 <span class="token number">56</span> 
 <span class="token number">57</span>             <span class="token block keyword">#limit_rate</span> <span class="token number">50</span><span class="token variable">k</span><span class="token punctuation">;</span>    <span class="token punctuation">#</span><span class="token variable">限制带宽，每秒最多</span><span class="token number">50</span><span class="token variable">k</span>
 <span class="token number">58</span>         <span class="token punctuation">}</span>

</code></pre> 
<p>其中：<br> <code>limit_conn_zone $binary_remote_addr zone=addr:10m;</code> 表示大小是10m内存 10m的内存来对IP传输开销<br> <code>limit_req_zone $binary_remote_addr zone=one:10m rate=1r/s;</code> 1s不超过一个请求<br> <code>limit_conn_zone</code> 用来限制同一时间连接数，即并发限制<br> <code>limit_req_zone</code> 用来限制单位时间的请求数，即速率限制，采用漏桶算法<br> <code>$binary_remote_addr</code> 是限制同一客户端ip地址<br> <code>zone=addr:10m</code> 表示生成一个大小为10m，名字为one的内存区域，用来存储访问的频次信息</p> 
<p>重新加载nginx：</p> 
<pre><code class="prism language-handlebars"><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@server1 conf</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">nginx</span> <span class="token variable">-t</span>
<span class="token variable">nginx:</span> <span class="token variable">the</span> <span class="token variable">configuration</span> <span class="token variable">file</span> <span class="token punctuation">/</span><span class="token variable">usr</span><span class="token punctuation">/</span><span class="token variable">local</span><span class="token punctuation">/</span><span class="token variable">nginx</span><span class="token punctuation">/</span><span class="token variable">conf</span><span class="token punctuation">/</span><span class="token variable">nginx</span><span class="token punctuation">.</span><span class="token variable">conf</span> <span class="token variable">syntax</span> <span class="token variable">is</span> <span class="token variable">ok</span>
<span class="token variable">nginx:</span> <span class="token variable">configuration</span> <span class="token variable">file</span> <span class="token punctuation">/</span><span class="token variable">usr</span><span class="token punctuation">/</span><span class="token variable">local</span><span class="token punctuation">/</span><span class="token variable">nginx</span><span class="token punctuation">/</span><span class="token variable">conf</span><span class="token punctuation">/</span><span class="token variable">nginx</span><span class="token punctuation">.</span><span class="token variable">conf</span> <span class="token variable">test</span> <span class="token variable">is</span> <span class="token variable">successful</span>
<span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@server1 conf</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">nginx</span> <span class="token variable">-s</span> <span class="token variable">reload</span>
</code></pre> 
<p><strong>2.测试</strong></p> 
<p>新建download目录后放入测试文件：</p> 
<pre><code class="prism language-handlebars"><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@server1 conf</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">mkdir</span> <span class="token punctuation">/</span><span class="token variable">usr</span><span class="token punctuation">/</span><span class="token variable">local</span><span class="token punctuation">/</span><span class="token variable">nginx</span><span class="token punctuation">/</span><span class="token variable">html</span><span class="token punctuation">/</span><span class="token variable">download</span>
<span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@server1 conf</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">cd</span> <span class="token punctuation">/</span><span class="token variable">usr</span><span class="token punctuation">/</span><span class="token variable">local</span><span class="token punctuation">/</span><span class="token variable">nginx</span><span class="token punctuation">/</span><span class="token variable">html</span><span class="token punctuation">/</span><span class="token variable">download</span>
<span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@server1 download</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">ls</span>
<span class="token number">1.</span><span class="token variable">jpg</span>
</code></pre> 
<p>清空日志文件：</p> 
<pre><code class="prism language-handlebars"><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@server1 download</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">cd</span> <span class="token punctuation">/</span><span class="token variable">usr</span><span class="token punctuation">/</span><span class="token variable">local</span><span class="token punctuation">/</span><span class="token variable">nginx</span><span class="token punctuation">/</span><span class="token variable">logs</span>
<span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@server1 logs</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token punctuation">&gt;</span><span class="token variable">access</span><span class="token punctuation">.</span><span class="token variable">log</span> 
<span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@server1 logs</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">cat</span> <span class="token variable">access</span><span class="token punctuation">.</span><span class="token variable">log</span> 
</code></pre> 
<p>并发测试，在客户端：</p> 
<pre><code class="prism language-handlebars"><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@foundation63 ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">ab</span> <span class="token variable">-c</span> <span class="token number">10</span> <span class="token variable">-n</span> <span class="token number">1000</span> <span class="token variable">http:</span><span class="token punctuation">/</span><span class="token punctuation">/</span><span class="token number">172.25</span><span class="token number">.63</span><span class="token number">.1</span><span class="token block keyword">/download/</span><span class="token number">1.</span><span class="token variable">jpg</span>
</code></pre> 
<p>测试后查看日志可以发现好多503错误，即服务器对并发进行了限制</p> 
<h2><a id="_61"></a>二、限制带宽</h2> 
<p>带宽限制的测试即只有配置文件不相同：</p> 
<pre><code class="prism language-handlebars"><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@server1 conf</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">vim</span> <span class="token variable">nginx</span><span class="token punctuation">.</span><span class="token variable">conf</span>

 <span class="token number">33</span>     <span class="token block keyword">#gzip</span>  <span class="token variable">on</span><span class="token punctuation">;</span>
 <span class="token number">34</span>     <span class="token variable">limit_conn_zone</span> <span class="token variable">$binary_remote_addr</span> <span class="token variable">zone</span><span class="token punctuation">=</span><span class="token variable">addr:</span><span class="token number">10</span><span class="token variable">m</span><span class="token punctuation">;</span>
 <span class="token number">35</span>     <span class="token variable">limit_req_zone</span> <span class="token variable">$binary_remote_addr</span> <span class="token variable">zone</span><span class="token punctuation">=</span><span class="token variable">one:</span><span class="token number">10</span><span class="token variable">m</span> <span class="token variable">rate</span><span class="token punctuation">=</span><span class="token number">1</span><span class="token variable">r</span><span class="token punctuation">/</span><span class="token variable">s</span><span class="token punctuation">;</span>			<span class="token punctuation">#</span><span class="token variable">注意：必须写在server上面</span>
 <span class="token number">36</span>     <span class="token variable">server</span> <span class="token punctuation">{<!-- --></span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token number">54</span>         <span class="token variable">location</span> <span class="token punctuation">/</span><span class="token variable">download</span> <span class="token punctuation">{<!-- --></span>
 <span class="token number">55</span>             <span class="token block keyword">#limit_conn</span> <span class="token variable">addr</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token punctuation">#</span><span class="token variable">只能一个并发，多了会报错</span>
 <span class="token number">56</span> 
 <span class="token number">57</span>             <span class="token variable">limit_rate</span> <span class="token number">50</span><span class="token variable">k</span><span class="token punctuation">;</span>    <span class="token punctuation">#</span><span class="token variable">限制带宽，每秒最多</span><span class="token number">50</span><span class="token variable">k</span>
 <span class="token number">58</span>         <span class="token punctuation">}</span>

</code></pre> 
<p>最后进行客户端测试时发现速度明显变慢，即服务器对速度进行了限制。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7ae33fcc496590ab035454782cca9dc0/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Win 10 常用快捷键</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/041db5af4bba77e91a6741837a8c6978/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">基于卷积神经网络(CNN)模型的垃圾分类设计与实现</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>