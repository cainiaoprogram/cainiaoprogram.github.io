<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android中的sharedUserId - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android中的sharedUserId" />
<meta property="og:description" content="一、manifest标签包含内容 &lt;manifest xmlns:android=&#34;http://schemas.android.com/apk/res/android&#34; // 命名空间 android:versionCode=&#34;1&#34; // 版本号，会被gradle中覆盖，不推荐 android:versionName=&#34;1.0&#34; // 版本名称，同上 android:sharedUserId=&#34;net.loosash.share&#34; // sharedUserId 本文详细介绍 android:sharedUserLabel=&#34;@string/app_name&#34; // 为用户提供一个可读的标签，value仅能使用资源id android:installLocation=&#34;internalOnly&#34; // 安装位置 默认internalOnly：只能安装在内部存储中；preferExternal：安装在外部存储中，当不可用时安装在内部存储中，安装后用户可以通过系统设置移动安装位置；auto：用户可以选择安装在内部存储还是外部存储中。 package=&#34;net.loosash.learnmanifest&#34;&gt; ...... &lt;/manifest&gt; 复制代码 二、sharedUserId注意事项 sharedUserId的value必须包含一个&#34;.&#34;，否则在打包安装到手机的时候会报错。某些功能的实现需要对相同shareUserId的apk使用相同的签名。 三、对sharedUserId的理解 我们都知道android的每一个应用都运行在单独的虚拟机上，以便提高系统的稳定性，每个应用进程都是由单独的Linux系统用户所创建，相同的sharedUserId的应用归属的linux相同的用户，资源共享则有很多的的便利可以利用。 我做了一个测试，使用adb shell top命令查看进程。 附带adb shell top命令解析
&gt;adb shell top -h Usage: top [ -m max_procs ] [ -n iterations ] [ -d delay ] [ -s sort_column ] [-t ] [ -h ] -m num Maximum number of processes to display." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/61cf65004fe85f04a00b1cd8a3769424/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-11-05T01:40:05+08:00" />
<meta property="article:modified_time" content="2018-11-05T01:40:05+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android中的sharedUserId</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div class="article-content"> 
 <h3 class="heading">一、manifest标签包含内容</h3> 
 <pre><code class="hljs bash copyable">&lt;manifest xmlns:android=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>  // 命名空间
    android:versionCode=<span class="hljs-string">"1"</span>  // 版本号，会被gradle中覆盖，不推荐
    android:versionName=<span class="hljs-string">"1.0"</span>  // 版本名称，同上
    android:sharedUserId=<span class="hljs-string">"net.loosash.share"</span>  // sharedUserId 本文详细介绍
    android:sharedUserLabel=<span class="hljs-string">"@string/app_name"</span>  // 为用户提供一个可读的标签，value仅能使用资源id
    android:installLocation=<span class="hljs-string">"internalOnly"</span>  // 安装位置 默认internalOnly：只能安装在内部存储中；preferExternal：安装在外部存储中，当不可用时安装在内部存储中，安装后用户可以通过系统设置移动安装位置；auto：用户可以选择安装在内部存储还是外部存储中。
    package=<span class="hljs-string">"net.loosash.learnmanifest"</span>&gt;
    ......
&lt;/manifest&gt;
<span class="copy-code-btn">复制代码</span></code></pre> 
 <h3 class="heading">二、sharedUserId注意事项</h3> 
 <ul><li>sharedUserId的value必须包含一个"."，否则在打包安装到手机的时候会报错。</li><li>某些功能的实现需要对相同shareUserId的apk使用相同的签名。</li></ul> 
 <h3 class="heading">三、对sharedUserId的理解</h3> 
 <p>我们都知道android的每一个应用都运行在单独的虚拟机上，以便提高系统的稳定性，每个应用进程都是由单独的Linux系统用户所创建，相同的sharedUserId的应用归属的linux相同的用户，资源共享则有很多的的便利可以利用。 我做了一个测试，使用adb shell top命令查看进程。 附带adb shell top命令解析</p> 
 <pre><code class="hljs bash copyable">&gt;adb shell top -h
Usage: top [ -m max_procs ] [ -n iterations ] [ <span class="hljs-_">-d</span> delay ] [ <span class="hljs-_">-s</span> sort_column ] [-t ] [ -h ]
    -m num  Maximum number of processes to display. 最多显示多少个进程
    -n num  Updates to show before exiting.  刷新次数 
    <span class="hljs-_">-d</span> num  Seconds to <span class="hljs-built_in">wait</span> between updates. 刷新间隔时间（默认5秒）
    <span class="hljs-_">-s</span> col  Column to sort by (cpu,vss,rss,thr). 按哪列排序 
    -t      Show threads instead of processes. 显示线程信息而不是进程
    -h      Display this <span class="hljs-built_in">help</span> screen.  显示帮助文档 
<span class="copy-code-btn">复制代码</span></code></pre> 
 <p>这张图是两个应用使用不同的sharedUserId </p> 
 <figure> 
  <figcaption></figcaption> 
 </figure> 
 <p></p> 
 <p>下面这张图是改成了相同的sharedUserId </p> 
 <figure> 
  <figcaption></figcaption> 
 </figure> 
 <p></p> 
 <h3 class="heading">四、对于相同sharedUserId的使用</h3> 
 <p>以下两个应用的包名分别为net.loosash.learnshareduserid（A应用）、net.loosash.learnshareduserid2（B应用） 1、获取同名sharedUserId应用SP 当然SP存储的跨应用处理还有其他方式，具体会在SP部分中进行说明，这里特指getSharePreferences(String name ,@PreferencesMode int mode)方法中mode为Context.MODE_PRIVATE情况。 通过拿到Context来操作SP的读取。 A应用中储存</p> 
 <pre><code class="hljs bash copyable">        val preferences = getSharedPreferences(<span class="hljs-string">"sp"</span>, Context.MODE_PRIVATE)
        preferences.edit().putInt(key_test_int, 1024).apply()
        Log.d(tag,<span class="hljs-string">"获取sp内<span class="hljs-variable">$key_test_int</span> 值为<span class="hljs-variable">${preferences.getInt(key_test_int,0)}</span>"</span>)
<span class="copy-code-btn">复制代码</span></code></pre> 
 <p>B应用中读取SP</p> 
 <pre><code class="hljs bash copyable">        val otherContext = this.createPackageContext(<span class="hljs-string">"net.loosash.learnshareduserid"</span>,Context.CONTEXT_IGNORE_SECURITY)
        val preferences = otherContext.getSharedPreferences(<span class="hljs-string">"sp"</span>, Context.MODE_PRIVATE)
        Log.d(tag,<span class="hljs-string">"获取sp内<span class="hljs-variable">$key_test_int</span> 值为<span class="hljs-variable">${preferences.getInt(key_test_int,0)}</span>"</span>)
<span class="copy-code-btn">复制代码</span></code></pre> 
 <p>查看日志输出 A应用</p> 
 <figure> 
  <figcaption></figcaption> 
 </figure> B应用 
 <figure> 
  <figcaption></figcaption> 
 </figure> 可见不同的应用共享SP中的数据了，同理数据库的访问也同样共享 2、访问同名sharedUserId应用 data/data 目录 在A中增加assets文件test.txt，在B中增加文件test_from_b.txt 在B中加入代码 
 <p></p> 
 <pre><code class="hljs bash copyable">  &lt;uses-permission android:name=<span class="hljs-string">"android.permission.WRITE_EXTERNAL_STORAGE"</span>/&gt;
  &lt;uses-permission android:name=<span class="hljs-string">"android.permission.READ_EXTERNAL_STORAGE"</span>/&gt;
<span class="copy-code-btn">复制代码</span></code></pre> 
 <pre><code class="hljs bash copyable">//        var file = File(<span class="hljs-string">"/data/data/net.loosash.learnshareduserid/test.txt"</span>)
        var file = File(<span class="hljs-string">"/data/data/net.loosash.learnshareduserid/test_from_b.txt"</span>)
        <span class="hljs-keyword">if</span> (!file.exists()) {
            file.createNewFile()
        }
        // 在B中将B的test_from_b写入A
        var input = this.assets.open(<span class="hljs-string">"test_from_b.txt"</span>)
        // 在B中将A的<span class="hljs-built_in">test</span>写入A
//        var input = otherContext.assets.open(<span class="hljs-string">"test.txt"</span>)
        var output = FileOutputStream(file)
        val buffer = ByteArray(1024)

        <span class="hljs-keyword">while</span> (input.read(buffer) != -1) {
            output.write(buffer, 0, input.read(buffer))
        }
        input.close()
        output.close()
<span class="copy-code-btn">复制代码</span></code></pre> 
 <p>在不同sharedUserId时，运行B,报错Permission denied，无法访问A的data/data 目录</p> 
 <figure> 
  <figcaption></figcaption> 
 </figure> 访问A的 data/data 目录，无test.txt及test_from_b.txt 
 <figure> 
  <figcaption></figcaption> 
 </figure> 修改相同sharedUserId，运行B，访问 data/data 目录，发现已经存在test.txt及test_from_b.txt 
 <figure> 
  <figcaption></figcaption> 
 </figure> 
 <p></p> 
 <h2 class="heading">五、总结</h2> 
 <p>不同应用之间可以通过设置相同sharedUserId来实现在Linux上的用户统一，来打破不同应用间的沙盒性质，已实现数据、资源的共享。</p> 
 <h3 class="heading">关注微信公众号，最新技术干货实时推送</h3> 
 <p></p> 
 <figure> 
  <figcaption></figcaption> 
 </figure> 
 <p></p> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/59fde5d83d17e4263ec925e74efc0c2c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">k级台阶问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1930fef0593f180ac35f307cc6a5a7ea/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">byte[]和InputStream的相互转换</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>