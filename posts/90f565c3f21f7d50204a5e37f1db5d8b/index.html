<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android13适配所有文件管理权限 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android13适配所有文件管理权限" />
<meta property="og:description" content="Android13适配所有文件管理权限 前言： 很早之前在Android11上面就适配过所有文件管理权限，这次是海外版升级到Android13，由于选择相册用的是第三方库，组内的同事没有上架Google的经验直接就提交代码，虽然功能没有问题，但是上架的时候被打回了，于是记录一下适配工作.
1.简介： 绝大多数需要共享存储空间访问权限的应用都可以遵循共享媒体文件和共享非媒体文件方面的最佳做法。然而，某些应用的核心用例需要广泛访问设备上的文件，但无法采用注重隐私保护的存储最佳实践高效地访问这些文件。对于这些情况，Android 提供了一种名为“所有文件访问权”的特殊应用访问权限。
例如，防病毒应用的主要用例可能需要定期扫描不同目录中的许多文件。如果此扫描需要反复的用户交互，让其使用系统文件选择器选择目录，就会带来糟糕的用户体验。其他用例（如文件管理器应用、备份和恢复应用以及文档管理应用）也需要考虑类似情况。
2.Google Play通知: 此部分为在 Google Play 上发布应用的开发者提供通知。
为了限制对共享存储的广泛访问，Google Play 商店已更新其政策，用来评估以 Android 11（API 级别 30）或更高版本为目标平台且通过 MANAGE_EXTERNAL_STORAGE 权限请求“所有文件访问权”的应用。此政策自 2021 年 5 月起生效。
当应用以 Android 11 或更高版本为目标平台并声明了 MANAGE_EXTERNAL_STORAGE 权限时，Android Studio 会显示图 1 中所示的 lint 警告。此警告会提醒您：“Google Play 商店的一项政策限制了对该权限的使用”。
图 1. Android Studio 中的 Lint 警告，提醒开发者有关 MANAGE_EXTERNAL_STORAGE 权限的 Google Play 政策。
仅当您的应用无法有效利用更有利于保护隐私的 API（如存储访问框架或 Media Store API）时，您才能请求 MANAGE_EXTERNAL_STORAGE 权限。您的应用对该权限的使用必须在允许的使用情形范围内，并且必须与应用的核心功能直接相关。如果您的应用包含与以下任一项类似的用例，可能会请求 MANAGE_EXTERNAL_STORAGE 权限：
文件管理器备份和恢复应用防病毒应用文档管理应用设备上的文件搜索磁盘和文件加密设备到设备数据迁移 3.选择相册图片： 由于使用的是io.github.lucksiege:pictureselector这个库，版本为v3.10.9：
PictureSelector.create(this) .openGallery(SelectMimeType.ofImage()) .setImageEngine(GlideEngine.createGlideEngine()) .forResult(object : OnResultCallbackListener&lt;LocalMedia?" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/90f565c3f21f7d50204a5e37f1db5d8b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-13T19:18:16+08:00" />
<meta property="article:modified_time" content="2023-12-13T19:18:16+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android13适配所有文件管理权限</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Android13_0"></a>Android13适配所有文件管理权限</h2> 
<h2><a id="_2"></a>前言：</h2> 
<p>很早之前在Android11上面就适配过所有文件管理权限，这次是海外版升级到Android13，由于选择相册用的是第三方库，组内的同事没有上架Google的经验直接就提交代码，虽然功能没有问题，但是上架的时候被打回了，于是记录一下适配工作.</p> 
<h2><a id="1_6"></a>1.简介：</h2> 
<p>绝大多数需要共享存储空间访问权限的应用都可以遵循<a href="https://developer.android.google.cn/training/data-storage/use-cases?hl=zh-cn#share-media-all" rel="nofollow">共享媒体文件</a>和<a href="https://developer.android.google.cn/training/data-storage/use-cases?hl=zh-cn#sharing-non-media-files" rel="nofollow">共享非媒体文件</a>方面的最佳做法。然而，某些应用的核心用例需要广泛访问设备上的文件，但无法采用注重隐私保护的存储最佳实践高效地访问这些文件。对于这些情况，Android 提供了一种名为“所有文件访问权”的特殊应用访问权限。</p> 
<p>例如，防病毒应用的主要用例可能需要定期扫描不同目录中的许多文件。如果此扫描需要反复的用户交互，让其使用系统文件选择器选择目录，就会带来糟糕的用户体验。其他用例（如文件管理器应用、备份和恢复应用以及文档管理应用）也需要考虑类似情况。</p> 
<h2><a id="2Google_Play_12"></a>2.Google Play通知:</h2> 
<p>此部分为在 Google Play 上发布应用的开发者提供通知。</p> 
<p>为了限制对共享存储的广泛访问，Google Play 商店<a href="https://support.google.com/googleplay/android-developer/answer/10467955?hl=zh-cn" rel="nofollow">已更新其政策</a>，用来评估以 Android 11（API 级别 30）或更高版本为目标平台且通过 <code>MANAGE_EXTERNAL_STORAGE</code> 权限请求“所有文件访问权”的应用。此政策自 2021 年 5 月起生效。</p> 
<p>当应用以 Android 11 或更高版本为目标平台并声明了 <code>MANAGE_EXTERNAL_STORAGE</code> 权限时，Android Studio 会显示图 1 中所示的 lint 警告。此警告会提醒您：“Google Play 商店的一项政策限制了对该权限的使用”。<br> <img src="https://images2.imgbox.com/07/46/dS2qqSoV_o.png" alt="在这里插入图片描述"></p> 
<p><strong>图 1.</strong> Android Studio 中的 Lint 警告，提醒开发者有关 <code>MANAGE_EXTERNAL_STORAGE</code> 权限的 Google Play 政策。</p> 
<p>仅当您的应用无法有效利用更有利于保护隐私的 API（如<a href="https://developer.android.google.cn/training/data-storage/shared/documents-files?hl=zh-cn" rel="nofollow">存储访问框架</a>或 <a href="https://developer.android.google.cn/training/data-storage/shared/media?hl=zh-cn" rel="nofollow">Media Store API</a>）时，您才能请求 <code>MANAGE_EXTERNAL_STORAGE</code> 权限。您的应用对该权限的使用必须在允许的使用情形范围内，并且必须与应用的核心功能直接相关。如果您的应用包含与以下任一项类似的用例，可能会请求 <code>MANAGE_EXTERNAL_STORAGE</code> 权限：</p> 
<ul><li>文件管理器</li><li>备份和恢复应用</li><li>防病毒应用</li><li>文档管理应用</li><li>设备上的文件搜索</li><li>磁盘和文件加密</li><li><a href="https://developer.android.google.cn/guide/topics/data/testingbackup?hl=zh-cn#TestingTransfer" rel="nofollow">设备到设备数据迁移</a></li></ul> 
<h2><a id="3_36"></a>3.选择相册图片：</h2> 
<p>由于使用的是io.github.lucksiege:pictureselector这个库，版本为v3.10.9：</p> 
<pre><code>PictureSelector.create(this)
    .openGallery(SelectMimeType.ofImage())
    .setImageEngine(GlideEngine.createGlideEngine())
    .forResult(object : OnResultCallbackListener&lt;LocalMedia?&gt; {
        override fun onResult(result: ArrayList&lt;LocalMedia?&gt;) {
            LogUtils.d("===返回的图片地址为===", result[0]!!.path)
            Glide.with(this@MainActivity).load(result[0]?.path).into(ivBg)
        }

        override fun onCancel() {}
    })
</code></pre> 
<h2><a id="4_54"></a>4.使用系统拍照：</h2> 
<pre><code>PictureSelector.create(this)
    .openCamera(SelectMimeType.ofImage())
    .forResult(object : OnResultCallbackListener&lt;LocalMedia?&gt; {
        override fun onResult(result: ArrayList&lt;LocalMedia?&gt;) {
            LogUtils.d("===返回的图片地址为===", result[0]!!.path)
            Glide.with(this@MainActivity).load(result[0]?.path).into(ivCamera)
        }

        override fun onCancel() {}
    })
</code></pre> 
<h2><a id="5_69"></a>5.打开系统相册：</h2> 
<pre><code>    private fun openPhotoAlbum() {
        val intent = Intent(Intent.ACTION_GET_CONTENT)
        intent.addCategory(Intent.CATEGORY_OPENABLE)
        intent.type = "image/*"
        //1.以startActivityForResult方式打开Activity
/*        startActivityForResult(
            Intent.createChooser(intent, "File Browser"), Constants.FILE_CHOOSER_RESULT_CODE)*/
        //2.以launch方式打开相册
        photoLaunch.launch("image/*")
    }
</code></pre> 
<h2><a id="6_84"></a>6.未适配前的效果如下：</h2> 
<p><img src="https://images2.imgbox.com/33/1a/wEtD8nfY_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="7_89"></a>7.去掉本项目的所有文件管理权限：</h2> 
<pre><code class="prism language-kotlin"><span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"android.permission.READ_EXTERNAL_STORAGE"</span></span>
    android<span class="token operator">:</span>maxSdkVersion<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"32"</span></span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"android.permission.WRITE_EXTERNAL_STORAGE"</span></span>
    tools<span class="token operator">:</span>ignore<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"ScopedStorage"</span></span> android<span class="token operator">:</span>maxSdkVersion<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"32"</span></span><span class="token operator">/</span><span class="token operator">&gt;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/7d/0b/ehulFVZD_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="8_101"></a>8.去掉后权限后再次运行：</h2> 
<p><img src="https://images2.imgbox.com/e2/10/QfJeiVnn_o.png" alt="在这里插入图片描述"></p> 
<p>还是提示申请所有文件管理权限，去github查看图片库的版本，发现新版本已经适配了Android13和所有文件管理权限，于是更新一下图片库的依赖版本.</p> 
<pre><code class="prism language-kotlin">dependencies <span class="token punctuation">{<!-- --></span>
    <span class="token function">implementation</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"androidx.core:core-ktx:1.9.0"</span></span><span class="token punctuation">)</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"androidx.appcompat:appcompat:1.6.1"</span></span><span class="token punctuation">)</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"com.google.android.material:material:1.8.0"</span></span><span class="token punctuation">)</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"androidx.constraintlayout:constraintlayout:2.1.4"</span></span><span class="token punctuation">)</span>
    <span class="token function">testImplementation</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"junit:junit:4.13.2"</span></span><span class="token punctuation">)</span>
    <span class="token function">androidTestImplementation</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"androidx.test.ext:junit:1.1.5"</span></span><span class="token punctuation">)</span>
    <span class="token function">androidTestImplementation</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"androidx.test.espresso:espresso-core:3.5.1"</span></span><span class="token punctuation">)</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"io.github.lucksiege:pictureselector:v3.11.1"</span></span><span class="token punctuation">)</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"com.github.bumptech.glide:glide:4.15.1"</span></span><span class="token punctuation">)</span>
    <span class="token function">annotationProcessor</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"com.github.bumptech.glide:compiler:4.15.1"</span></span><span class="token punctuation">)</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"com.blankj:utilcodex:1.31.1"</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="9ImageEngine_124"></a>9.新版本ImageEngine：</h2> 
<pre><code class="prism language-kotlin"><span class="token comment">/**
 * 加载图片
 *
 * @param context   上下文
 * @param url       资源url
 * @param imageView 图片承载控件
 */</span>
<span class="token annotation builtin">@Override</span>
<span class="token keyword">public</span> void <span class="token function">loadImage</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> String url<span class="token punctuation">,</span> ImageView imageView<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ActivityCompatHelper<span class="token punctuation">.</span><span class="token function">assertValidRequest</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    Glide<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span>imageView<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation builtin">@Override</span>
<span class="token keyword">public</span> void <span class="token function">loadImageBitmap</span><span class="token punctuation">(</span><span class="token annotation builtin">@NonNull</span> Context context<span class="token punctuation">,</span> <span class="token annotation builtin">@NonNull</span> String url<span class="token punctuation">,</span> int maxWidth<span class="token punctuation">,</span> int maxHeight<span class="token punctuation">,</span> OnCallbackListener<span class="token operator">&lt;</span>Bitmap<span class="token operator">&gt;</span> call<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span>

<span class="token comment">/**
 * 加载相册目录封面
 *
 * @param context   上下文
 * @param url       图片路径
 * @param imageView 承载图片ImageView
 */</span>
<span class="token annotation builtin">@Override</span>
<span class="token keyword">public</span> void <span class="token function">loadAlbumCover</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> String url<span class="token punctuation">,</span> ImageView imageView<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ActivityCompatHelper<span class="token punctuation">.</span><span class="token function">assertValidRequest</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    Glide<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">asBitmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">override</span><span class="token punctuation">(</span><span class="token number">180</span><span class="token punctuation">,</span> <span class="token number">180</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">sizeMultiplier</span><span class="token punctuation">(</span><span class="token number">0.5f</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>new <span class="token function">CenterCrop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> new <span class="token function">RoundedCorners</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">placeholder</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>drawable<span class="token punctuation">.</span>ps_image_placeholder<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span>imageView<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/**
 * 加载图片列表图片
 *
 * @param context   上下文
 * @param url       图片路径
 * @param imageView 承载图片ImageView
 */</span>
<span class="token annotation builtin">@Override</span>
<span class="token keyword">public</span> void <span class="token function">loadGridImage</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> String url<span class="token punctuation">,</span> ImageView imageView<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ActivityCompatHelper<span class="token punctuation">.</span><span class="token function">assertValidRequest</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    Glide<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">override</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">centerCrop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">placeholder</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>drawable<span class="token punctuation">.</span>ps_image_placeholder<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span>imageView<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation builtin">@Override</span>
<span class="token keyword">public</span> void <span class="token function">pauseRequests</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ActivityCompatHelper<span class="token punctuation">.</span><span class="token function">assertValidRequest</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    Glide<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pauseRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation builtin">@Override</span>
<span class="token keyword">public</span> void <span class="token function">resumeRequests</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ActivityCompatHelper<span class="token punctuation">.</span><span class="token function">assertValidRequest</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    Glide<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resumeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token function">MyImageGlideEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> static <span class="token keyword">final</span> <span class="token keyword">class</span> InstanceHolder <span class="token punctuation">{<!-- --></span>
    static <span class="token keyword">final</span> MyImageGlideEngine instance <span class="token operator">=</span> new <span class="token function">MyImageGlideEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> static MyImageGlideEngine <span class="token function">createGlideEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> InstanceHolder<span class="token punctuation">.</span>instance<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/c6/a1/Mxnibirx_o.png" alt="在这里插入图片描述"></p> 
<p>​</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">package</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>allfilemanagerdemo<span class="token punctuation">.</span>utils<span class="token punctuation">;</span>

<span class="token keyword">import</span> android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>Context<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span>Bitmap<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>widget<span class="token punctuation">.</span>ImageView<span class="token punctuation">;</span>

<span class="token keyword">import</span> androidx<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>NonNull<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>bumptech<span class="token punctuation">.</span>glide<span class="token punctuation">.</span>Glide<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>bumptech<span class="token punctuation">.</span>glide<span class="token punctuation">.</span>load<span class="token punctuation">.</span>resource<span class="token punctuation">.</span>bitmap<span class="token punctuation">.</span>CenterCrop<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>bumptech<span class="token punctuation">.</span>glide<span class="token punctuation">.</span>load<span class="token punctuation">.</span>resource<span class="token punctuation">.</span>bitmap<span class="token punctuation">.</span>RoundedCorners<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>allfilemanagerdemo<span class="token punctuation">.</span>R<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>luck<span class="token punctuation">.</span>picture<span class="token punctuation">.</span>lib<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>ImageEngine<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>luck<span class="token punctuation">.</span>picture<span class="token punctuation">.</span>lib<span class="token punctuation">.</span>interfaces<span class="token punctuation">.</span>OnCallbackListener<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>luck<span class="token punctuation">.</span>picture<span class="token punctuation">.</span>lib<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>ActivityCompatHelper<span class="token punctuation">;</span>

<span class="token comment">/**
 * @author：luck
 * @date：2019-11-13 17:02
 * @describe：Glide加载引擎
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> MyImageGlideEngine implements ImageEngine <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 加载图片
     *
     * @param context   上下文
     * @param url       资源url
     * @param imageView 图片承载控件
     */</span>
    <span class="token annotation builtin">@Override</span>
    <span class="token keyword">public</span> void <span class="token function">loadImage</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> String url<span class="token punctuation">,</span> ImageView imageView<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ActivityCompatHelper<span class="token punctuation">.</span><span class="token function">assertValidRequest</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        Glide<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span>imageView<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation builtin">@Override</span>
    <span class="token keyword">public</span> void <span class="token function">loadImage</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> ImageView imageView<span class="token punctuation">,</span> String url<span class="token punctuation">,</span> int maxWidth<span class="token punctuation">,</span> int maxHeight<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ActivityCompatHelper<span class="token punctuation">.</span><span class="token function">assertValidRequest</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        Glide<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">override</span><span class="token punctuation">(</span>maxWidth<span class="token punctuation">,</span> maxHeight<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span>imageView<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 加载相册目录封面
     *
     * @param context   上下文
     * @param url       图片路径
     * @param imageView 承载图片ImageView
     */</span>
    <span class="token annotation builtin">@Override</span>
    <span class="token keyword">public</span> void <span class="token function">loadAlbumCover</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> String url<span class="token punctuation">,</span> ImageView imageView<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ActivityCompatHelper<span class="token punctuation">.</span><span class="token function">assertValidRequest</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        Glide<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">asBitmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">override</span><span class="token punctuation">(</span><span class="token number">180</span><span class="token punctuation">,</span> <span class="token number">180</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">sizeMultiplier</span><span class="token punctuation">(</span><span class="token number">0.5f</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>new <span class="token function">CenterCrop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> new <span class="token function">RoundedCorners</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">placeholder</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>drawable<span class="token punctuation">.</span>ps_image_placeholder<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span>imageView<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 加载图片列表图片
     *
     * @param context   上下文
     * @param url       图片路径
     * @param imageView 承载图片ImageView
     */</span>
    <span class="token annotation builtin">@Override</span>
    <span class="token keyword">public</span> void <span class="token function">loadGridImage</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> String url<span class="token punctuation">,</span> ImageView imageView<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ActivityCompatHelper<span class="token punctuation">.</span><span class="token function">assertValidRequest</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        Glide<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">override</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">centerCrop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">placeholder</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>drawable<span class="token punctuation">.</span>ps_image_placeholder<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span>imageView<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation builtin">@Override</span>
    <span class="token keyword">public</span> void <span class="token function">pauseRequests</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ActivityCompatHelper<span class="token punctuation">.</span><span class="token function">assertValidRequest</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        Glide<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pauseRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation builtin">@Override</span>
    <span class="token keyword">public</span> void <span class="token function">resumeRequests</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ActivityCompatHelper<span class="token punctuation">.</span><span class="token function">assertValidRequest</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        Glide<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resumeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token function">MyImageGlideEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> static <span class="token keyword">final</span> <span class="token keyword">class</span> InstanceHolder <span class="token punctuation">{<!-- --></span>
        static <span class="token keyword">final</span> MyImageGlideEngine instance <span class="token operator">=</span> new <span class="token function">MyImageGlideEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> static MyImageGlideEngine <span class="token function">createGlideEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> InstanceHolder<span class="token punctuation">.</span>instance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="10Android13_349"></a>10.Android13文件读写权限适配：</h2> 
<pre><code class="prism language-kotlin"><span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">initPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkPermissions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">takePhoto</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">requestPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-kotlin"><span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">requestPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">when</span> <span class="token punctuation">{<!-- --></span>
        Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>SDK_INT <span class="token operator">&gt;=</span> <span class="token number">33</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            ActivityCompat<span class="token punctuation">.</span><span class="token function">requestPermissions</span><span class="token punctuation">(</span>
                <span class="token keyword">this</span><span class="token punctuation">,</span>
                <span class="token function">arrayOf</span><span class="token punctuation">(</span>
                    Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>READ_MEDIA_IMAGES<span class="token punctuation">,</span>
                    Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>READ_MEDIA_AUDIO<span class="token punctuation">,</span>
                    Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>READ_MEDIA_VIDEO<span class="token punctuation">,</span>
                    Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>CAMERA<span class="token punctuation">,</span>
                <span class="token punctuation">)</span><span class="token punctuation">,</span>
                Constants<span class="token punctuation">.</span>REQUEST_CODE_PERMISSIONS
            <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">else</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            ActivityCompat<span class="token punctuation">.</span><span class="token function">requestPermissions</span><span class="token punctuation">(</span>
                <span class="token keyword">this</span><span class="token punctuation">,</span>
                REQUIRED_PERMISSIONS<span class="token punctuation">,</span>
                Constants<span class="token punctuation">.</span>REQUEST_CODE_PERMISSIONS
            <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-kotlin"><span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">checkPermissions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">when</span> <span class="token punctuation">{<!-- --></span>
        Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>SDK_INT <span class="token operator">&gt;=</span> <span class="token number">33</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">val</span> permissions <span class="token operator">=</span> <span class="token function">arrayOf</span><span class="token punctuation">(</span>
                Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>READ_MEDIA_IMAGES<span class="token punctuation">,</span>
                Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>READ_MEDIA_AUDIO<span class="token punctuation">,</span>
                Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>READ_MEDIA_VIDEO<span class="token punctuation">,</span>
                Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>CAMERA<span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>permission <span class="token keyword">in</span> permissions<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> Environment<span class="token punctuation">.</span><span class="token function">isExternalStorageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">else</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>permission <span class="token keyword">in</span> REQUIRED_PERMISSIONS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ContextCompat<span class="token punctuation">.</span><span class="token function">checkSelfPermission</span><span class="token punctuation">(</span>
                        <span class="token keyword">this</span><span class="token punctuation">,</span>
                        permission
                    <span class="token punctuation">)</span> <span class="token operator">!=</span> PackageManager<span class="token punctuation">.</span>PERMISSION_GRANTED
                <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-kotlin"><span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onRequestPermissionsResult</span><span class="token punctuation">(</span>
    requestCode<span class="token operator">:</span> Int<span class="token punctuation">,</span> permissions<span class="token operator">:</span> Array<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">,</span> grantResults<span class="token operator">:</span>
    IntArray
<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onRequestPermissionsResult</span><span class="token punctuation">(</span>requestCode<span class="token punctuation">,</span> permissions<span class="token punctuation">,</span> grantResults<span class="token punctuation">)</span>
    <span class="token keyword">when</span> <span class="token punctuation">(</span>requestCode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Constants<span class="token punctuation">.</span>REQUEST_CODE_PERMISSIONS <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">var</span> allPermissionsGranted <span class="token operator">=</span> <span class="token boolean">true</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>result <span class="token keyword">in</span> grantResults<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> PackageManager<span class="token punctuation">.</span>PERMISSION_GRANTED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    allPermissionsGranted <span class="token operator">=</span> <span class="token boolean">false</span>
                    <span class="token keyword">break</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">when</span> <span class="token punctuation">{<!-- --></span>
                allPermissionsGranted <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 权限已授予，执行文件读写操作</span>
                    <span class="token function">takePhoto</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">else</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 权限被拒绝，处理权限请求失败的情况</span>
                    ToastUtils<span class="token punctuation">.</span><span class="token function">showShort</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"请您打开必要权限"</span></span><span class="token punctuation">)</span>
                    <span class="token function">requestPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="11_452"></a>11.打开相册：</h2> 
<p>这里有两种方式：</p> 
<p>11.1 以startActivityForResult方式打开</p> 
<pre><code class="prism language-kotlin">    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">openPhotoAlbum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">val</span> intent <span class="token operator">=</span> <span class="token function">Intent</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>ACTION_GET_CONTENT<span class="token punctuation">)</span>
        intent<span class="token punctuation">.</span><span class="token function">addCategory</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>CATEGORY_OPENABLE<span class="token punctuation">)</span>
        intent<span class="token punctuation">.</span>type <span class="token operator">=</span> "image<span class="token comment">/*"
        //以startActivityForResult方式打开Activity
       startActivityForResult(
            Intent.createChooser(intent, "File Browser"), Constants.FILE_CHOOSER_RESULT_CODE)
    }
</span></code></pre> 
<p>11.2 以launch方式打开</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">openPhotoAlbum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
     <span class="token comment">//以launch方式打开相册</span>
      photoLaunch<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span>"image<span class="token comment">/*")
}
</span></code></pre> 
<h2><a id="12_478"></a>12.打开相册结果回调:</h2> 
<p>12.1 startActivityResult方式结果回调：</p> 
<pre><code class="prism language-kotlin">    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onActivityResult</span><span class="token punctuation">(</span>requestCode<span class="token operator">:</span> Int<span class="token punctuation">,</span> resultCode<span class="token operator">:</span> Int<span class="token punctuation">,</span> <span class="token keyword">data</span><span class="token operator">:</span> Intent<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onActivityResult</span><span class="token punctuation">(</span>requestCode<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span> <span class="token keyword">data</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resultCode <span class="token operator">!=</span> RESULT_OK<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">when</span> <span class="token punctuation">(</span>requestCode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Constants<span class="token punctuation">.</span>FILE_CHOOSER_RESULT_CODE <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">data</span><span class="token operator">?</span><span class="token punctuation">.</span>data <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">val</span> imgStr<span class="token operator">:</span> String <span class="token operator">=</span> <span class="token function">getImageAbsolutePath</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">data</span><span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>TextUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>imgStr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">val</span> imgUri<span class="token operator">:</span> Uri<span class="token operator">?</span> <span class="token operator">=</span> FileUtils<span class="token punctuation">.</span><span class="token function">getUriFromPath</span><span class="token punctuation">(</span>imgStr<span class="token punctuation">,</span> application<span class="token punctuation">)</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>imgUri <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        Glide<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token label symbol">@MainActivity</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>imgUri<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span>ivPhoto<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>12.2 launch方式结果回调：</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">private</span> <span class="token keyword">val</span> photoLaunch <span class="token operator">=</span>
<span class="token function">registerForActivityResult</span><span class="token punctuation">(</span>ActivityResultContracts<span class="token punctuation">.</span><span class="token function">GetContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> uri <span class="token operator">-&gt;</span>
    Glide<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token label symbol">@MainActivity</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>uri<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span>ivPhoto<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="13_515"></a>13.实现的效果如下：</h2> 
<p><img src="https://images2.imgbox.com/aa/57/60y4xy2s_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/cf/70/475ujX4S_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/a1/81/zUJ636aI_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="14_525"></a>14.项目源码如下：</h2> 
<p><a href="https://gitee.com/jackning_admin/all-file-manager-demo" rel="nofollow">https://gitee.com/jackning_admin/all-file-manager-demo</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/428794030f5368e73f61222436904315/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">数字证书、签名到底是什么？</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2aa795db28001eb8b50bee8349ed1c0f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">huggingface的生成模型</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>