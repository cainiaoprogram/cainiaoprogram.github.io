<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SQL Server2005中触发器的运用 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="SQL Server2005中触发器的运用" />
<meta property="og:description" content="http://www.blogjava.net/qileilove/archive/2012/06/21/381239.html
编写过存储过程的人，再编写触发器时会发现：他们的语法、格式是非常类似的。其实触发器就是一种特殊类型的存储过程。他们都是预编译的，在程序正式编译前就由编译器进行编译，存储在服务器端。
不过，触发器与一般的存储过程也有些区别。触发器主要是通过对数据库的增删改的操作，或者是一个触发动作的触发作用等事件触发而被执行；而存储过程则是通过像传递SQL语句一样，传递存储过程的名字来被程序调用，实现功能。
触发器一共分为五种类型：Update触发器，Insert触发器、Delete触发器、Instead of触发器和After触发器。前三个分别是相应表上进行更新、插入、删除操作时触发。Instead of触发器在不执行插入、更新或删除操作时触发。
在触发器中存在两个虚拟表：Inserted表和Deleted表。Inserted表保存的是Insert或Update之后所影响的记录形成的表，Deleted保存的是Delete或update之前所影响的记录形成的表。这两个表是逻辑表，这两个表是动态驻留在内存中的，当触发器工作完成，这两个表也被删除。
触发器的创建代码格式：
CREATE TRIGGER trigger_name --触发器的名字 ON table|view [WITH ENCRYPTION] --在哪个表上创建触发器 { FOR | AFTER | INSTEAD OF } {[INSERT][,][UPDATE][,][DELETE]} --激活触发器的类型 AS sql_statements […n] 代码中关键字for、after、Insteadof分别代表不同的使用范围：
for表示为AFTER触发器，且该类型触发器仅能在表上创建；
after表示只有在执行了指定的操作INSERT、DELETE、UPDATE之后触发器才被激活，执行触发器中的SQL语句；
instead of当为表或视图定义了针对某一操作INSERT、DELETE、UPDATE的INSTEAD OF 类型触发器，且执行了相应的操作时，尽管触发器被触发，但相应的操作并不被执行，而运行的仅是触发器SQL语句本身。
下面说下触发器的作用：
1、级联修改数据库中的相关的表；
看下面的牛腩新闻发布系统的例子：其中一个新闻类别（Category）对应多个或者0条新闻；一条新闻（news）对应着多个或者0个新闻评论（comment）。
set ANSI_NULLS ON set QUOTED_IDENTIFIER ON go -- ============================================= -- Author: 刘正权 -- Create date: 2008-11-15 11：13 -- Description: 删除新闻类别触发器 -- ============================================= CREATE TRIGGER trigCategoryDelete ON category instead of DELETE AS BEGIN --删除新闻，再在类别表中删除--触发器实现 declare @caId int select @caId=id from deleted --删除评论(选出多条用in,一条用=号) delete comment where newsId in (select newsId from news wherecaId=@caId) --删除新闻 delete news wherecaId=@caId --删除类别 delete category whereid=@caId END 2、执行比核查约束更为复杂的约束操作；在触发器中可以书写更为复杂的SQL语句，例如可以引用多个表，并使用if……else等语句做更复杂的检查。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/dde90f1ec5d57ba756e88cb16e65c3bb/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2013-07-04T13:24:50+08:00" />
<meta property="article:modified_time" content="2013-07-04T13:24:50+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SQL Server2005中触发器的运用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p><a href="http://www.blogjava.net/qileilove/archive/2012/06/21/381239.html" rel="nofollow">http://www.blogjava.net/qileilove/archive/2012/06/21/381239.html</a></p> 
<p></p> 
<p style="line-height:19px; word-break:break-all; margin-top:10px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51)"> 编写过存储过程的人，再编写触发器时会发现：他们的语法、格式是非常类似的。其实触发器就是一种特殊类型的存储过程。他们都是预编译的，在程序正式编译前就由编译器进行编译，存储在服务器端。</p> 
<p style="line-height:19px; word-break:break-all; margin-top:10px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51)"> 　　不过，触发器与一般的存储过程也有些区别。触发器主要是通过对<a href="http://www.blogjava.net/qileilove/archive/2012/06/21/381239.html" rel="nofollow noopener noreferrer" target="_self" style="color:rgb(26,139,200); text-decoration:none; word-break:break-all; line-height:normal!important"><span style="word-break:break-all"><span style="word-break:break-all">数据库</span></span></a>的增删改的操作，或者是一个触发动作的触发作用等事件触发而被执行；而存储过程则是通过像传递<a href="http://www.blogjava.net/qileilove/archive/2012/06/21/381239.html" rel="nofollow noopener noreferrer" target="_self" style="color:rgb(26,139,200); text-decoration:none; word-break:break-all; line-height:normal!important"><span style="word-break:break-all"><span style="word-break:break-all">SQL</span></span></a>语句一样，传递存储过程的名字来被程序调用，实现功能。</p> 
<p style="line-height:19px; word-break:break-all; margin-top:10px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51)"> 　　触发器一共分为五种类型：Update触发器，Insert触发器、Delete触发器、Instead of触发器和After触发器。前三个分别是相应表上进行更新、插入、删除操作时触发。Instead of触发器在不执行插入、更新或删除操作时触发。</p> 
<p style="line-height:19px; word-break:break-all; margin-top:10px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51)"> 　　在触发器中存在两个虚拟表：Inserted表和Deleted表。Inserted表保存的是Insert或Update之后所影响的记录形成的表，Deleted保存的是Delete或update之前所影响的记录形成的表。这两个表是逻辑表，这两个表是动态驻留在内存中的，当触发器<a href="http://www.blogjava.net/qileilove/archive/2012/06/21/381239.html" rel="nofollow noopener noreferrer" target="_self" style="color:rgb(26,139,200); text-decoration:none; word-break:break-all; line-height:normal!important"><span style="word-break:break-all"><span style="word-break:break-all">工作</span></span></a>完成，这两个表也被删除。</p> 
<p align="center" style="line-height:19px; word-break:break-all; margin-top:10px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51)"> <a href="http://www.51testing.com/batch.download.php?aid=33443" rel="nofollow noopener noreferrer" target="_blank" style="color:rgb(51,51,51); text-decoration:none; word-break:break-all; line-height:normal!important"><img border="0" src="https://images2.imgbox.com/5c/e7/gt1VxbnV_o.jpg" alt="" style="border:0px none; word-break:break-all; list-style:none outside none; margin:0px; padding:0px; max-width:500px"></a></p> 
<p align="left" style="line-height:19px; word-break:break-all; margin-top:10px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51)"> 　　触发器的创建代码格式：</p> 
<p align="left" style="line-height:19px; word-break:break-all; margin-top:10px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51)"> </p> 
<table align="center" style="word-break:break-all; color:rgb(51,51,51); font-size:12px; text-align:left; background-color:rgb(221,221,221); border-color:rgb(153,153,153); border-style:solid; width:612px"><tbody style="word-break:break-all"><tr style="word-break:break-all"><td style="color:rgb(69,69,69); font-family:Verdana,Geneva,Arial,Helvetica,sans-serif; word-wrap:break-word; line-height:14px; word-break:break-all"> CREATE TRIGGER trigger_name      --触发器的名字<br style="word-break:break-all"> ON table|view [WITH ENCRYPTION]  --在哪个表上创建触发器<br style="word-break:break-all"> { FOR | AFTER | INSTEAD OF }    <br style="word-break:break-all"> {[INSERT][,][UPDATE][,][DELETE]} --激活触发器的类型<br style="word-break:break-all"> AS sql_statements […n]</td></tr></tbody></table> 
<p style="line-height:19px; word-break:break-all; margin-top:10px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51)"> </p> 
<p align="left" style="line-height:19px; word-break:break-all; margin-top:10px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51)"> 　　代码中关键字for、after、Insteadof分别代表不同的使用范围：</p> 
<p align="left" style="line-height:19px; word-break:break-all; margin-top:10px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51)"> 　　for表示为AFTER触发器，且该类型触发器仅能在表上创建；</p> 
<p align="left" style="line-height:19px; word-break:break-all; margin-top:10px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51)"> 　　after表示只有在执行了指定的操作INSERT、DELETE、UPDATE之后触发器才被激活，执行触发器中的SQL语句；</p> 
<p align="left" style="line-height:19px; word-break:break-all; margin-top:10px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51)"> 　　instead of当为表或视图定义了针对某一操作INSERT、DELETE、UPDATE的INSTEAD OF 类型触发器，且执行了相应的操作时，尽管触发器被触发，但相应的操作并不被执行，而运行的仅是触发器SQL语句本身。</p> 
<p align="left" style="line-height:19px; word-break:break-all; margin-top:10px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51)"> 　　下面说下触发器的作用：</p> 
<p align="left" style="line-height:19px; word-break:break-all; margin-top:10px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51)"> 　　1、级联修改数据库中的相关的表；</p> 
<p align="left" style="line-height:19px; word-break:break-all; margin-top:10px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51)"> 　　看下面的牛腩新闻发布系统的例子：其中一个新闻类别（Category）对应多个或者0条新闻；一条新闻（news）对应着多个或者0个新闻评论（comment）。</p> 
<p align="left" style="line-height:19px; word-break:break-all; margin-top:10px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51)"> </p> 
<table align="center" style="word-break:break-all; color:rgb(51,51,51); font-size:12px; text-align:left; background-color:rgb(221,221,221); border-color:rgb(153,153,153); border-style:solid; width:612px"><tbody style="word-break:break-all"><tr style="word-break:break-all"><td style="color:rgb(69,69,69); font-family:Verdana,Geneva,Arial,Helvetica,sans-serif; word-wrap:break-word; line-height:14px; word-break:break-all"> set ANSI_NULLS ON<br style="word-break:break-all"> set QUOTED_IDENTIFIER ON<br style="word-break:break-all"> go<br style="word-break:break-all"> -- =============================================<br style="word-break:break-all"> -- Author:  刘正权<br style="word-break:break-all"> -- Create date: 2008-11-15 11：13<br style="word-break:break-all"> -- Description: 删除新闻类别触发器<br style="word-break:break-all"> -- =============================================<br style="word-break:break-all"> CREATE TRIGGER trigCategoryDelete<br style="word-break:break-all">    ON  category<br style="word-break:break-all">    instead of DELETE<br style="word-break:break-all"> AS<br style="word-break:break-all"> BEGIN<br style="word-break:break-all"> --删除新闻，再在类别表中删除--触发器实现<br style="word-break:break-all">  declare @caId int<br style="word-break:break-all">  select @caId=id from deleted<br style="word-break:break-all">  --删除评论(选出多条用in,一条用=号)<br style="word-break:break-all">  delete comment where newsId in (select newsId from news where<a href="mailto:caId=@caId" rel="nofollow" style="color:rgb(51,51,51); text-decoration:none; word-break:break-all">caId=@caId</a>)<br style="word-break:break-all">  --删除新闻<br style="word-break:break-all">  delete news where<a href="mailto:caId=@caId" rel="nofollow" style="color:rgb(51,51,51); text-decoration:none; word-break:break-all">caId=@caId</a><br style="word-break:break-all">  --删除类别<br style="word-break:break-all">  delete category where<a href="mailto:id=@caId" rel="nofollow" style="color:rgb(51,51,51); text-decoration:none; word-break:break-all">id=@caId</a><br style="word-break:break-all"> END</td></tr></tbody></table> 
<p style="line-height:19px; word-break:break-all; margin-top:10px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51)"> </p> 
<p align="left" style="line-height:19px; word-break:break-all; margin-top:10px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51)"> 　　2、执行比核查约束更为复杂的约束操作；在触发器中可以书写更为复杂的SQL语句，例如可以引用多个表，并使用if……else等语句做更复杂的检查。</p> 
<p align="left" style="line-height:19px; word-break:break-all; margin-top:10px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51)"> 　　下面看下例子：如果更改了学生的学号，则他的借书记录表中记录也同时更新。</p> 
<p align="left" style="line-height:19px; word-break:break-all; margin-top:10px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51)"> 　　这时候，我们可以建立一下触发器：</p> 
<p align="left" style="line-height:19px; word-break:break-all; margin-top:10px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51)"> </p> 
<table align="center" style="word-break:break-all; color:rgb(51,51,51); font-size:12px; text-align:left; background-color:rgb(221,221,221); border-color:rgb(153,153,153); border-style:solid; width:612px"><tbody style="word-break:break-all"><tr style="word-break:break-all"><td style="color:rgb(69,69,69); font-family:Verdana,Geneva,Arial,Helvetica,sans-serif; word-wrap:break-word; line-height:14px; word-break:break-all"> <p style="word-break:break-all; margin-top:10px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; line-height:1.8em!important"> SET ANSI_NULLS ON<br style="word-break:break-all; line-height:normal!important"> GO<br style="word-break:break-all; line-height:normal!important"> SET QUOTED_IDENTIFIER ON<br style="word-break:break-all; line-height:normal!important"> GO<br style="word-break:break-all; line-height:normal!important"> -- =============================================<br style="word-break:break-all; line-height:normal!important"> -- Author:  刘正权<br style="word-break:break-all; line-height:normal!important"> -- Create date:2012-4-22<br style="word-break:break-all; line-height:normal!important"> -- Description: 更改了学生的学号，则他的借书记录表中记录也同时更新<br style="word-break:break-all; line-height:normal!important"> -- =============================================<br style="word-break:break-all; line-height:normal!important"> Create Trigger truStudent<br style="word-break:break-all; line-height:normal!important"> On Student        --在Student表中创建触发器<br style="word-break:break-all; line-height:normal!important"> for Update        --为什么事件触发<br style="word-break:break-all; line-height:normal!important"> As                --事件触发后所要做的事情<br style="word-break:break-all; line-height:normal!important"> if Update(StudentID)           <br style="word-break:break-all; line-height:normal!important"> begin</p> <p style="word-break:break-all; margin-top:10px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; line-height:1.8em!important"> Update BorrowRecord<br style="word-break:break-all; line-height:normal!important"> Set StudentID=i.StudentID<br style="word-break:break-all; line-height:normal!important"> From BorrowRecord br , Deleted   d ,Inserted i  --Deleted和Inserted临时表<br style="word-break:break-all; line-height:normal!important"> Where br.StudentID=d.StudentID<br style="word-break:break-all; line-height:normal!important"> end </p> </td></tr></tbody></table> 
<br style="color:rgb(75,75,75); font-family:Verdana,Geneva,Arial,Helvetica,sans-serif; font-size:13px; line-height:19px"> 
<br style="color:rgb(75,75,75); font-family:Verdana,Geneva,Arial,Helvetica,sans-serif; font-size:13px; line-height:19px"> 
<br style="color:rgb(75,75,75); font-family:Verdana,Geneva,Arial,Helvetica,sans-serif; font-size:13px; line-height:19px"> 
<br style="color:rgb(75,75,75); font-family:Verdana,Geneva,Arial,Helvetica,sans-serif; font-size:13px; line-height:19px"> 
<div style="color:rgb(75,75,75); font-family:Verdana,Geneva,Arial,Helvetica,sans-serif; font-size:13px; line-height:19px"> 
 <p style="word-break:break-all; margin-top:10px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:Arial,Helvetica,sans-serif; font-size:12px"> 　　3、拒绝或回滚违反引用完整性的操作。检查对数据库的操作是否违反引用完整性，并选择相应的操作；</p> 
 <p style="word-break:break-all; margin-top:10px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:Arial,Helvetica,sans-serif; font-size:12px"> 　　看下面的例子：不允许删除任何销售记录大于等于20条的商店。</p> 
 <p style="word-break:break-all; margin-top:10px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:Arial,Helvetica,sans-serif; font-size:12px"> </p> 
 <table align="center" style="word-break:break-all; color:rgb(51,51,51); font-family:Arial,Helvetica,sans-serif; font-size:12px; text-align:left; background-color:rgb(221,221,221); border-color:rgb(153,153,153); border-style:solid; width:612px"><tbody style="word-break:break-all"><tr style="word-break:break-all"><td style="color:rgb(69,69,69); font-family:Verdana,Geneva,Arial,Helvetica,sans-serif; word-wrap:break-word; line-height:14px; word-break:break-all"> SET ANSI_NULLS ON<br style="word-break:break-all"> GO<br style="word-break:break-all"> SET QUOTED_IDENTIFIER ON<br style="word-break:break-all"> GO<br style="word-break:break-all"> -- =============================================<br style="word-break:break-all"> -- Author:  刘正权<br style="word-break:break-all"> -- Create date: 2012-4-22<br style="word-break:break-all"> -- Description: 不允许删除任何销售记录大于等于20条的商店<br style="word-break:break-all"> -- =============================================<br style="word-break:break-all"> CREATE TRIGGER trDelSales<br style="word-break:break-all">    ON  tblSales  <br style="word-break:break-all">    for Delete<br style="word-break:break-all"> AS <br style="word-break:break-all">  if(select Count(*) from Deleted <br style="word-break:break-all">  where Deleted.qty&gt;=20)&gt;0<br style="word-break:break-all"> BEGIN<br style="word-break:break-all">  print'您不能删除任何记录'<br style="word-break:break-all">  rollback transaction   --事务回滚<br style="word-break:break-all"> END<br style="word-break:break-all"> GO</td></tr></tbody></table> 
 <p style="word-break:break-all; margin-top:10px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:Arial,Helvetica,sans-serif; font-size:12px"> </p> 
 <p style="word-break:break-all; margin-top:10px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:Arial,Helvetica,sans-serif; font-size:12px"> 　　4、比较表修改前后数据之间的差别，并根据差别才去相应的操作。</p> 
 <p style="word-break:break-all; margin-top:10px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:Arial,Helvetica,sans-serif; font-size:12px"> 　　例如：若想规定每次工资的变动幅度不能超过40％，使用触发器可以将修改后的表数据和修改前的表数据进行比较，若超出40%，可以回滚该修改操作。</p> 
 <p style="word-break:break-all; margin-top:10px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:Arial,Helvetica,sans-serif; font-size:12px"> 　　触发器是自动触发的，一旦对表中的数据做了修改，该触发器将立即被激活，充分体现了触发的优势，保持了数据的完整性；然而，触发器性能通常是比较低的。</p> 
 <p style="word-break:break-all; margin-top:10px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:Arial,Helvetica,sans-serif; font-size:12px"> 　　当运行触发器时，系统处理的大部分时间花费在参照它表达的这一处理上，因为这些表达既不在内存中，也不在数据库设备上，而逻辑表（删除表和插入表）总是位于内存中。所以触发器参照的其他表的位置决定了操作花费时间的长短。</p> 
</div> 
<br>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e398f60e6f68957cd1d6d569f1c52ece/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">ImageSource的使用心得</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9bed1784c46bd86886b3b0e17487e2ec/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">设置UITableView不允许滚动</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>