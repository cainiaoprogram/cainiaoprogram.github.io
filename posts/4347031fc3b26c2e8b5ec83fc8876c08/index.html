<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>2022-05-17 Druid源码阅读——Druid在什么时候会创建连接（二） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="2022-05-17 Druid源码阅读——Druid在什么时候会创建连接（二）" />
<meta property="og:description" content="Druid在什么时候会创建连接 CreateConnectionTask#runInternal
CreateConnectionTask是用于Druid中用于创建连接的任务，实现了Runnable接口，主要用于向线程池中提交任务。
public class CreateConnectionTask implements Runnable { private int errorCount = 0; private boolean initTask = false; private final long taskId; public CreateConnectionTask() { taskId = createTaskIdSeedUpdater.getAndIncrement(DruidDataSource.this); } public CreateConnectionTask(boolean initTask) { taskId = createTaskIdSeedUpdater.getAndIncrement(DruidDataSource.this); this.initTask = initTask; } @Override public void run() { runInternal(); } private void runInternal() { //创建循环，保证可以获取到连接 for (;;) { // addLast //加锁创建 lock.lock(); try { //如果当前连接池被关闭或者处于关闭状态 if (closed || closing) { //清除创建任务，停止执行 clearCreateTask(taskId); return; } //空等待状态 boolean emptyWait = true; //如果出现创建异常并且连接池中没有连接，空等待状态设为false if (createError !" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/4347031fc3b26c2e8b5ec83fc8876c08/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-18T08:26:40+08:00" />
<meta property="article:modified_time" content="2022-05-18T08:26:40+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">2022-05-17 Druid源码阅读——Druid在什么时候会创建连接（二）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Druid_0"></a>Druid在什么时候会创建连接</h2> 
<ul><li> <p>CreateConnectionTask#runInternal</p> <p><code>CreateConnectionTask</code>是用于Druid中用于创建连接的任务，实现了<code>Runnable</code>接口，主要用于向线程池中提交任务。</p> <pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CreateConnectionTask</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> errorCount   <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> initTask <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> taskId<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">CreateConnectionTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        taskId <span class="token operator">=</span> createTaskIdSeedUpdater<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span>DruidDataSource<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">CreateConnectionTask</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> initTask<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        taskId <span class="token operator">=</span> createTaskIdSeedUpdater<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span>DruidDataSource<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>initTask <span class="token operator">=</span> initTask<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">runInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">runInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//创建循环，保证可以获取到连接</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

            <span class="token comment">// addLast</span>
            <span class="token comment">//加锁创建</span>
            lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//如果当前连接池被关闭或者处于关闭状态</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>closed <span class="token operator">||</span> closing<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//清除创建任务，停止执行</span>
                    <span class="token function">clearCreateTask</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//空等待状态</span>
                <span class="token keyword">boolean</span> emptyWait <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token comment">//如果出现创建异常并且连接池中没有连接，空等待状态设为false</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>createError <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> poolingCount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    emptyWait <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//判断是否存在空等待状态</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>emptyWait<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 必须存在线程等待，才创建连接</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>poolingCount <span class="token operator">&gt;=</span> notEmptyWaitThreadCount <span class="token comment">//</span>
                        <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>keepAlive <span class="token operator">&amp;&amp;</span> activeCount <span class="token operator">+</span> poolingCount <span class="token operator">&lt;</span> minIdle<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 在keepAlive场景不能放弃创建</span>
                        <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>initTask<span class="token punctuation">)</span> <span class="token comment">// 线程池初始化时的任务不能放弃创建</span>
                        <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isFailContinuous</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// failContinuous时不能放弃创建，否则会无法创建线程</span>
                        <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isOnFatalError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// onFatalError时不能放弃创建，否则会无法创建线程</span>
                       <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//清理任务</span>
                        <span class="token function">clearCreateTask</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token comment">// 防止创建超过maxActive数量的连接</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>activeCount <span class="token operator">+</span> poolingCount <span class="token operator">&gt;=</span> maxActive<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//清理任务</span>
                        <span class="token function">clearCreateTask</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//解锁</span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//物理线程</span>
            PhysicalConnectionInfo physicalConnection <span class="token operator">=</span> null<span class="token punctuation">;</span>

            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//创建物理线程</span>
                physicalConnection <span class="token operator">=</span> <span class="token function">createPhysicalConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">OutOfMemoryError</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"create connection OutOfMemoryError, out memory. "</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//创建异常数自增</span>
                errorCount<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token comment">//如果创建异常次数大于重试次数并且timeBetweenConnectErrorMillis&gt;0</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>errorCount <span class="token operator">&gt;</span> connectionErrorRetryAttempts <span class="token operator">&amp;&amp;</span> timeBetweenConnectErrorMillis <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// fail over retry attempts</span>
                    <span class="token function">setFailContinuous</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//如果开启了快速失败</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>failFast<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//加锁，唤醒</span>
                        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">//发出信号，唤醒所有在等待的线程</span>
                            notEmpty<span class="token punctuation">.</span><span class="token function">signalAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">//如果开启了获取失败后中断</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>breakAfterAcquireFailure<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//加锁，清除任务，终止执行</span>
                        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token function">clearCreateTask</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">//重置异常计数</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>errorCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// reset errorCount</span>
                    <span class="token comment">//如果连接池关闭中已关闭，加锁清除任务，终止执行</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>closing <span class="token operator">||</span> closed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token function">clearCreateTask</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">//设置调度任务，在timeBetweenConnectErrorMillis后重新创建</span>
                    createSchedulerFuture <span class="token operator">=</span> createScheduler<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> timeBetweenConnectErrorMillis<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"create connection SQLException, url: "</span> <span class="token operator">+</span> jdbcUrl<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>

                errorCount<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>errorCount <span class="token operator">&gt;</span> connectionErrorRetryAttempts <span class="token operator">&amp;&amp;</span> timeBetweenConnectErrorMillis <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// fail over retry attempts</span>
                    <span class="token function">setFailContinuous</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>failFast<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                            notEmpty<span class="token punctuation">.</span><span class="token function">signalAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>breakAfterAcquireFailure<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token function">clearCreateTask</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">this</span><span class="token punctuation">.</span>errorCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// reset errorCount</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>closing <span class="token operator">||</span> closed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token function">clearCreateTask</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    createSchedulerFuture <span class="token operator">=</span> createScheduler<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> timeBetweenConnectErrorMillis<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"create connection RuntimeException"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// unknow fatal exception</span>
                <span class="token function">setFailContinuous</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Error</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//发生Error时，清除任务，跳出循环中止执行</span>
                lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">clearCreateTask</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"create connection Error"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// unknow fatal exception</span>
                <span class="token function">setFailContinuous</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//发生Throwable时，清除任务，跳出循环中止执行</span>
                lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">clearCreateTask</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"create connection unexecpted error."</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//如果连接创建失败，重新创建</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>physicalConnection <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//设置物理连接的创建任务ID</span>
            physicalConnection<span class="token punctuation">.</span>createTaskId <span class="token operator">=</span> taskId<span class="token punctuation">;</span>
            <span class="token comment">//将连接置入连接池中</span>
            <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token function">put</span><span class="token punctuation">(</span>physicalConnection<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//如果置入连接池失败，关闭当前连接</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                JdbcUtils<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>physicalConnection<span class="token punctuation">.</span><span class="token function">getPhysicalConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"put physical connection to pool failed."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//由于创建连接成功，跳出循环</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p>CreateConnectionThread#run</p> <p><code>CreateConnectionThread</code>是Druid中用于创建连接的线程，在不设置线程池的情况下将以此种方式自动创建线程，通过此方式创建，需要接收到<code>empty</code>的唤醒。</p> <pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CreateConnectionThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token function">CreateConnectionThread</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//闭锁计数减少，连接池初始化时创建线程时用</span>
        initedLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//最后丢弃计数</span>
        <span class="token keyword">long</span> lastDiscardCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">//异常数</span>
        <span class="token keyword">int</span> errorCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// addLast</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//可中断锁</span>
                lock<span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//如果当前锁被中断，跳出循环，放弃创建线程</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//获得连接池中的丢弃计数</span>
            <span class="token keyword">long</span> discardCount <span class="token operator">=</span> DruidDataSource<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>discardCount<span class="token punctuation">;</span>
            <span class="token comment">//如果丢弃数被更改</span>
            <span class="token keyword">boolean</span> discardChanged <span class="token operator">=</span> discardCount <span class="token operator">-</span> lastDiscardCount <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token comment">//记录当前连接池中的丢弃数</span>
            lastDiscardCount <span class="token operator">=</span> discardCount<span class="token punctuation">;</span>

            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//空等待状态</span>
                <span class="token keyword">boolean</span> emptyWait <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token comment">// 如果存在创建异常、连接池中没有连接、丢弃数没有被更改</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>createError <span class="token operator">!=</span> null
                    <span class="token operator">&amp;&amp;</span> poolingCount <span class="token operator">==</span> <span class="token number">0</span>
                    <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>discardChanged<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//不进行等待</span>
                    emptyWait <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//如果存在等待、异步初始化、累计创建数小于初始化线程大小</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>emptyWait
                    <span class="token operator">&amp;&amp;</span> asyncInit <span class="token operator">&amp;&amp;</span> createCount <span class="token operator">&lt;</span> initialSize<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    emptyWait <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>emptyWait<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 必须存在线程等待，才创建连接</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>poolingCount <span class="token operator">&gt;=</span> notEmptyWaitThreadCount <span class="token comment">//</span>
                        <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>keepAlive <span class="token operator">&amp;&amp;</span> activeCount <span class="token operator">+</span> poolingCount <span class="token operator">&lt;</span> minIdle<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isFailContinuous</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                       <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//发送信号量，使线程挂起，暂不创建</span>
                        empty<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token comment">// 防止创建超过maxActive数量的连接</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>activeCount <span class="token operator">+</span> poolingCount <span class="token operator">&gt;=</span> maxActive<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//发送信号量，使线程挂起，暂不创建</span>
                        empty<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//跳出循环，重新判断，避免连接溢出</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//如果线程被打断，记录创建异常，异常发生时间</span>
                lastCreateError <span class="token operator">=</span> e<span class="token punctuation">;</span>
                lastErrorTimeMillis <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//如果连接池不处于关闭中或被关闭，打印异常日志</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>closing<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>closed<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"create connection Thread Interrupted, url: "</span> <span class="token operator">+</span> jdbcUrl<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//跳出循环，终止执行</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//解锁</span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            PhysicalConnectionInfo connection <span class="token operator">=</span> null<span class="token punctuation">;</span>

            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//创建线程</span>
                connection <span class="token operator">=</span> <span class="token function">createPhysicalConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"create connection SQLException, url: "</span> <span class="token operator">+</span> jdbcUrl <span class="token operator">+</span> <span class="token string">", errorCode "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getErrorCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                          <span class="token operator">+</span> <span class="token string">", state "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getSQLState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>

                errorCount<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>errorCount <span class="token operator">&gt;</span> connectionErrorRetryAttempts <span class="token operator">&amp;&amp;</span> timeBetweenConnectErrorMillis <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// fail over retry attempts</span>
                    <span class="token function">setFailContinuous</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>failFast<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                            notEmpty<span class="token punctuation">.</span><span class="token function">signalAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>breakAfterAcquireFailure<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>timeBetweenConnectErrorMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> interruptEx<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"create connection RuntimeException"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">setFailContinuous</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Error</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"create connection Error"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">setFailContinuous</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//如果连接创建失败，重新创建</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>connection <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//置入连接池，如果置入连接池失败，则关闭当前连接</span>
            <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token function">put</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                JdbcUtils<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">getPhysicalConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"put physical connection to pool failed."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//重置异常计数</span>
            errorCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// reset errorCount</span>
            <span class="token comment">//如果正在关闭中或已关闭，跳出循环</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>closing <span class="token operator">||</span> closed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p>DruidDataSource#fill(int)</p> <p><code>fill()</code>顾名思义，将填充连接池中的连接数，该方法分为无参<code>fill()</code>和有参<code>fill(int toCount)</code>，无参方法将会调用有参函数，将线程池填充至最大。</p> <pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">fill</span><span class="token punctuation">(</span><span class="token keyword">int</span> toCount<span class="token punctuation">)</span> <span class="token keyword">throws</span> SQLException <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//如果线程池被关闭，抛出异常</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>closed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">DataSourceClosedException</span><span class="token punctuation">(</span><span class="token string">"dataSource already closed at "</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>closeTimeMillis<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//参数校验，填充线程数不应该小于0</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>toCount <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"toCount can't not be less than zero"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//初始化连接池</span>
    <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果填充数&gt;最大活跃数，填充数=最大活跃数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>toCount <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>maxActive<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        toCount <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>maxActive<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//记录填充数</span>
    <span class="token keyword">int</span> fillCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//可被打断锁</span>
            lock<span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//如果被打断，记录连接异常数</span>
            connectErrorCountUpdater<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SQLException</span><span class="token punctuation">(</span><span class="token string">"interrupt"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//判断当前连接池中连接是否可以被填充至指定大小</span>
        <span class="token keyword">boolean</span> fillable <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isFillable</span><span class="token punctuation">(</span>toCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//解锁</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//如果不能被填充，跳出循环</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fillable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        DruidConnectionHolder holder<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//创建连接</span>
            PhysicalConnectionInfo pyConnInfo <span class="token operator">=</span> <span class="token function">createPhysicalConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//创建连接持有者</span>
            holder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DruidConnectionHolder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> pyConnInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"fill connection error, url: "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jdbcUrl<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//记录连接异常数</span>
            connectErrorCountUpdater<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//可被中断锁</span>
            lock<span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//记录连接异常数</span>
            connectErrorCountUpdater<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SQLException</span><span class="token punctuation">(</span><span class="token string">"interrupt"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//如果不能被填充到指定数</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isFillable</span><span class="token punctuation">(</span>toCount<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//关闭当前连接</span>
                JdbcUtils<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>holder<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"fill connections skip."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//跳出循环</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//将连接置入连接池，上次活跃时间为当前</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">putLast</span><span class="token punctuation">(</span>holder<span class="token punctuation">,</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//填充数自增</span>
            fillCount<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//解锁</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>LOG<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"fill "</span> <span class="token operator">+</span> fillCount <span class="token operator">+</span> <span class="token string">" connections"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//返回填充数</span>
    <span class="token keyword">return</span> fillCount<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> </li></ul> 
<h2><a id="_451"></a>总结</h2> 
<h3><a id="Druid_453"></a>Druid连接创建方式</h3> 
<p>Druid连接有两种创建方式，一种为同步(即方法内部同步创建)，一种为异步(通过线程创建或线程池提交任务)。</p> 
<p>在异步创建时，采用线程创建还是线程池提交任务由连接池是否指定线程池确定，在使用线程池创建时，以下两种条件创建会被直接取消</p> 
<ul><li>createTaskCount &gt;= maxCreateTaskCount，即当前创建任务数大于最大任务数</li><li>activeCount + poolingCount + createTaskCount &gt;= maxActive，即活跃总数+池中总数+创建中总数&gt;=最大活跃数</li></ul> 
<h3><a id="Druid_462"></a>Druid连接的创建时点</h3> 
<ul><li> <p>initialSize&gt;0时，将在<code>init()</code>时进行创建，此时创建连接由是否指定<code>asyncInit</code>参数来判断，需要注意的时，此时如果采用异步创建需要设置线程池，否则即使开启<code>asyncInit</code>也依旧会采用同步创建。</p> </li><li> <p>开启<code>keepAlive</code>并且initialSize&lt;minIdle，将在<code>init()</code>时进行创建，此时将采用异步方式创建连接</p> </li><li> <p>抛弃连接(<code>discardConnection</code>)且连接池中活跃连接总数&lt;最小数量，此时采用异步方式创建连接</p> </li><li> <p>连接池取出的连接发生异常且<code>fatalErrorCount - fatalErrorCountLastShrink &gt; onFatalErrorMaxActive</code>时，此时采用异步方式创建</p> </li><li> <p>从连接池中取连接时，连接池中没有空闲连接，此时将采用异步方式创建连接</p> </li><li> <p>向连接池中置入连接时(要求此时为异步线程池方式创建)，且满足<code>poolingCount + createTaskCount &lt; notEmptyWaitThreadCount &amp;&amp; activeCount + poolingCount + createTaskCount &lt; maxActive</code>时</p> </li><li> <p>连接池收缩(<code>shrink</code>)后，将<code>keepAliveConnections</code>归还至池子中时存在校验异常的连接，并且连接池中活跃连接总数&lt;最小数量，此时采用异步创建</p> </li><li> <p>连接池收缩后，开启<code>keepAlive</code>且连接池中活跃连接总数&lt;最小数量，此时将采用异步方式将连接池中连接填充至最小连接数</p> </li><li> <p>连接池收缩后，未开启keepAlive或连接池中活跃连接总数&gt;=最小数量，并且满足<code>onFatalError || fatalErrorIncrement &gt; 0</code>，此时将采用异步方式创建连接</p> </li><li> <p>获得连接时，满足<code>设置了创建线程池、池中没有连接、活跃连接数&lt;最大活跃数、没有创建中的连接、线程池是ScheduledThreadPoolExecutor或它的子类</code>，且此时线程池中存在排队，同步创建</p> </li><li> <p>在手动调用<code>fill()</code>方法时，采用同步方式创建</p> </li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/22b614ad7a3b05c0b380576db4575b36/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">[ Druid ] 源码拆解 —— 2. 连接是如何创建的 ？</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d641b4e7d918387b1f8e1a2b2a72f58a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">IDEA中安装并使用JRebel热部署插件</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>