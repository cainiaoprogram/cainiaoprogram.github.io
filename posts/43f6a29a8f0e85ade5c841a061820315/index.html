<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Prometheus规则定义及基于docker简单邮箱钉钉服务发现 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Prometheus规则定义及基于docker简单邮箱钉钉服务发现" />
<meta property="og:description" content="目录
规则文件用于定义Prometheus中的告警规则，即在满足特定条件时生成警报。
记录规则文件用于定义Prometheus中的记录规则，即根据现有的指标数据生成新的时间序列数据
grafana启动
Alertmanager的介绍
告警功能概述
Prometheus监控系统的告警逻辑
启动Alertmanager
启用告警功能：
定义告警发送
在Prometheus上定义告警规则
规则文件用于定义Prometheus中的告警规则，即在满足特定条件时生成警报。 在规则文件中所有的文件都隶属于groups，在groups之下才能定义规则，每个规则都有名字
规则文件： groups: 规则组定义 - name: &lt;string&gt; rules: - name: expr: PromQL - name: expr: - name: &lt;group2&gt; #第二组下的规则 rules: - name: expr: 记录规则文件用于定义Prometheus中的记录规则，即根据现有的指标数据生成新的时间序列数据 定义记录规则，记录规则用record来命名，规则文件用name来命名
记录规则文件： groups: - name: &lt;string&gt; rules: - record: expr: PromQL labels: {} - record: expr: labels: {} grafana启动 docker启动grafana需要配置IP号，也可以下载安装进行配置
[root@rocky8 datasources]#pwd /root/learning-prometheus-master/08-prometheus-components-compose/grafana/grafana/provisioning/datasources [root@rocky8 datasources]#cat all.yml # config file version apiVersion: 1 # list of datasources that should be deleted from the database deleteDatasources: - name: Prometheus orgId: 1 # list of datasources to insert/update depending # whats available in the database datasources: # &lt;string, required&gt; name of the datasource." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/43f6a29a8f0e85ade5c841a061820315/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-10-11T10:39:07+08:00" />
<meta property="article:modified_time" content="2023-10-11T10:39:07+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Prometheus规则定义及基于docker简单邮箱钉钉服务发现</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="-toc" style="margin-left:160px;"></p> 
<p id="%E8%A7%84%E5%88%99%E6%96%87%E4%BB%B6%E7%94%A8%E4%BA%8E%E5%AE%9A%E4%B9%89Prometheus%E4%B8%AD%E7%9A%84%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99%EF%BC%8C%E5%8D%B3%E5%9C%A8%E6%BB%A1%E8%B6%B3%E7%89%B9%E5%AE%9A%E6%9D%A1%E4%BB%B6%E6%97%B6%E7%94%9F%E6%88%90%E8%AD%A6%E6%8A%A5%E3%80%82-toc" style="margin-left:160px;"><a href="#%E8%A7%84%E5%88%99%E6%96%87%E4%BB%B6%E7%94%A8%E4%BA%8E%E5%AE%9A%E4%B9%89Prometheus%E4%B8%AD%E7%9A%84%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99%EF%BC%8C%E5%8D%B3%E5%9C%A8%E6%BB%A1%E8%B6%B3%E7%89%B9%E5%AE%9A%E6%9D%A1%E4%BB%B6%E6%97%B6%E7%94%9F%E6%88%90%E8%AD%A6%E6%8A%A5%E3%80%82" rel="nofollow">规则文件用于定义Prometheus中的告警规则，即在满足特定条件时生成警报。</a></p> 
<p id="%C2%A0%E8%AE%B0%E5%BD%95%E8%A7%84%E5%88%99%E6%96%87%E4%BB%B6%E7%94%A8%E4%BA%8E%E5%AE%9A%E4%B9%89Prometheus%E4%B8%AD%E7%9A%84%E8%AE%B0%E5%BD%95%E8%A7%84%E5%88%99%EF%BC%8C%E5%8D%B3%E6%A0%B9%E6%8D%AE%E7%8E%B0%E6%9C%89%E7%9A%84%E6%8C%87%E6%A0%87%E6%95%B0%E6%8D%AE%E7%94%9F%E6%88%90%E6%96%B0%E7%9A%84%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97%E6%95%B0%E6%8D%AE-toc" style="margin-left:160px;"><a href="#%C2%A0%E8%AE%B0%E5%BD%95%E8%A7%84%E5%88%99%E6%96%87%E4%BB%B6%E7%94%A8%E4%BA%8E%E5%AE%9A%E4%B9%89Prometheus%E4%B8%AD%E7%9A%84%E8%AE%B0%E5%BD%95%E8%A7%84%E5%88%99%EF%BC%8C%E5%8D%B3%E6%A0%B9%E6%8D%AE%E7%8E%B0%E6%9C%89%E7%9A%84%E6%8C%87%E6%A0%87%E6%95%B0%E6%8D%AE%E7%94%9F%E6%88%90%E6%96%B0%E7%9A%84%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97%E6%95%B0%E6%8D%AE" rel="nofollow"> 记录规则文件用于定义Prometheus中的记录规则，即根据现有的指标数据生成新的时间序列数据</a></p> 
<p id="grafana%E5%90%AF%E5%8A%A8-toc" style="margin-left:80px;"><a href="#grafana%E5%90%AF%E5%8A%A8" rel="nofollow">grafana启动</a></p> 
<p id="%C2%A0Alertmanager%E7%9A%84%E4%BB%8B%E7%BB%8D-toc" style="margin-left:0px;"><a href="#%C2%A0Alertmanager%E7%9A%84%E4%BB%8B%E7%BB%8D" rel="nofollow"> Alertmanager的介绍</a></p> 
<p id="%E5%91%8A%E8%AD%A6%E5%8A%9F%E8%83%BD%E6%A6%82%E8%BF%B0-toc" style="margin-left:80px;"><a href="#%E5%91%8A%E8%AD%A6%E5%8A%9F%E8%83%BD%E6%A6%82%E8%BF%B0" rel="nofollow">告警功能概述</a></p> 
<p id="%C2%A0Prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%91%8A%E8%AD%A6%E9%80%BB%E8%BE%91-toc" style="margin-left:80px;"><a href="#%C2%A0Prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%91%8A%E8%AD%A6%E9%80%BB%E8%BE%91" rel="nofollow"> Prometheus监控系统的告警逻辑</a></p> 
<p id="%E5%90%AF%E5%8A%A8Alertmanager-toc" style="margin-left:160px;"><a href="#%E5%90%AF%E5%8A%A8Alertmanager" rel="nofollow">启动Alertmanager</a></p> 
<p id="%E5%90%AF%E7%94%A8%E5%91%8A%E8%AD%A6%E5%8A%9F%E8%83%BD%EF%BC%9A-toc" style="margin-left:80px;"><a href="#%E5%90%AF%E7%94%A8%E5%91%8A%E8%AD%A6%E5%8A%9F%E8%83%BD%EF%BC%9A" rel="nofollow">启用告警功能：</a></p> 
<p id="%C2%A0%E5%AE%9A%E4%B9%89%E5%91%8A%E8%AD%A6%E5%8F%91%E9%80%81-toc" style="margin-left:160px;"><a href="#%C2%A0%E5%AE%9A%E4%B9%89%E5%91%8A%E8%AD%A6%E5%8F%91%E9%80%81" rel="nofollow"> 定义告警发送</a></p> 
<p id="%E5%9C%A8Prometheus%E4%B8%8A%E5%AE%9A%E4%B9%89%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99-toc" style="margin-left:160px;"><a href="#%E5%9C%A8Prometheus%E4%B8%8A%E5%AE%9A%E4%B9%89%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99" rel="nofollow">在Prometheus上定义告警规则</a></p> 
<hr id="hr-toc"> 
<p></p> 
<h6 id="%E8%A7%84%E5%88%99%E6%96%87%E4%BB%B6%E7%94%A8%E4%BA%8E%E5%AE%9A%E4%B9%89Prometheus%E4%B8%AD%E7%9A%84%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99%EF%BC%8C%E5%8D%B3%E5%9C%A8%E6%BB%A1%E8%B6%B3%E7%89%B9%E5%AE%9A%E6%9D%A1%E4%BB%B6%E6%97%B6%E7%94%9F%E6%88%90%E8%AD%A6%E6%8A%A5%E3%80%82">规则文件用于定义Prometheus中的告警规则，即在满足特定条件时生成警报。</h6> 
<p>在规则文件中所有的文件都隶属于groups，在groups之下才能定义规则，每个规则都有名字</p> 
<pre><code> 规则文件：
    groups:  规则组定义
    - name: &lt;string&gt;
      rules: 
      - name:
        expr: PromQL 
      - name: 
        expr: 
    - name: &lt;group2&gt; #第二组下的规则
      rules:
      - name:
        expr:</code></pre> 
<h6 id="%C2%A0%E8%AE%B0%E5%BD%95%E8%A7%84%E5%88%99%E6%96%87%E4%BB%B6%E7%94%A8%E4%BA%8E%E5%AE%9A%E4%B9%89Prometheus%E4%B8%AD%E7%9A%84%E8%AE%B0%E5%BD%95%E8%A7%84%E5%88%99%EF%BC%8C%E5%8D%B3%E6%A0%B9%E6%8D%AE%E7%8E%B0%E6%9C%89%E7%9A%84%E6%8C%87%E6%A0%87%E6%95%B0%E6%8D%AE%E7%94%9F%E6%88%90%E6%96%B0%E7%9A%84%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97%E6%95%B0%E6%8D%AE"> 记录规则文件用于定义Prometheus中的记录规则，即根据现有的指标数据生成新的时间序列数据</h6> 
<p>定义记录规则，记录规则用record来命名，规则文件用name来命名</p> 
<pre><code>记录规则文件：
    groups:
    - name: &lt;string&gt;
      rules: 
      - record:
        expr: PromQL
        labels: {} 
      - record: 
        expr: 
        labels: {}</code></pre> 
<h4 id="grafana%E5%90%AF%E5%8A%A8">grafana启动</h4> 
<p> docker启动grafana需要配置IP号，也可以下载安装进行配置</p> 
<pre><code>[root@rocky8 datasources]#pwd
/root/learning-prometheus-master/08-prometheus-components-compose/grafana/grafana/provisioning/datasources
[root@rocky8 datasources]#cat all.yml 
# config file version
apiVersion: 1

# list of datasources that should be deleted from the database
deleteDatasources:
  - name: Prometheus
    orgId: 1

# list of datasources to insert/update depending
# whats available in the database
datasources:
  # &lt;string, required&gt; name of the datasource. Required
- name: 'Prometheus'
  type: 'prometheus'
  access: 'proxy'
  org_id: 1
  url: 'http://10.0.0.8:9090'
  is_default: true
  version: 1
  editable: true
</code></pre> 
<p>grafana自带面板数据<img alt="" height="763" src="https://images2.imgbox.com/bc/83/GLpqjrnP_o.png" width="1200"></p> 
<h2 id="%C2%A0Alertmanager%E7%9A%84%E4%BB%8B%E7%BB%8D"> Alertmanager的介绍</h2> 
<h4 id="%E5%91%8A%E8%AD%A6%E5%8A%9F%E8%83%BD%E6%A6%82%E8%BF%B0">告警功能概述</h4> 
<p> Prometheus对指标的收集、存储同告警能力分属于Prometheus Server和AlertManager两个独立的组件，前者仅负责基于“告警规则”生成告警通知，具体的告警操作则由后者完成；<br>         ◼ Alertmanager负责处理由客户端发来的告警通知<br>                 ◆ 客户端通常是Prometheus Server，但它也支持接收来自其它工具的告警；<br>                 ◆ Alertmanager对告警通知进行分组、去重后，根据路由规则将其路由到不同的receiver，如Email、短信或PagerDuty等； </p> 
<p><img alt="" height="375" src="https://images2.imgbox.com/9c/3a/Fdqn7UHr_o.png" width="613"></p> 
<h4 id="%C2%A0Prometheus%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%91%8A%E8%AD%A6%E9%80%BB%E8%BE%91"> Prometheus监控系统的告警逻辑</h4> 
<p><br>  首先要配置Prometheus成为Alertmanager的告警客户端；</p> 
<ul><li>反过来，Alertmanager也是应用程序，它自身同样应该纳入prometheus的监控目标；</li></ul> 
<p> 配置逻辑</p> 
<p>在Alertmanager上定义receiver，他们通常是能够基于某个媒介接收告警消息的特定用户；</p> 
<ul><li> Email、WeChat、Pagerduty、Slack和Webhook等是为常见的发送告警信息的媒介；</li><li>在不同的媒介上，代表告警消息接收人的地址表示方式也会有所不同；</li></ul> 
<p>◼ 在Alertmanager上定义路由规则（route），以便将收到的告警通知按需分别进行处理；<br> ◼ 在Prometheus上定义告警规则生成告警通知，发送给Alertmanager；</p> 
<p>除了基本的告警通知能力外，Altermanager还支持对告警进行去重、分组、抑制、静默和路由等功能； </p> 
<h6 id="%E5%90%AF%E5%8A%A8Alertmanager">启动Alertmanager</h6> 
<pre><code>[root@rocky8 alertmanager]#cat docker-compose.yml 
version: '3.6'

volumes:
 alertmanager_data: {}
networks:
  monitoring:
    driver: bridge
    ipam:
      config:
        - subnet: 172.31.55.0/24

services:
  alertmanager:
    image: prom/alertmanager:v0.25.0
    volumes:
      - ./alertmanager/:/etc/alertmanager/
      - alertmanager_data:/alertmanager
    networks:
      - monitoring
    restart: always
    ports:
      - 9093:9093
    command:
      - '--config.file=/etc/alertmanager/config.yml'
      - '--storage.path=/alertmanager'
      - '--log.level=debug'

[root@rocky8 alertmanager]#docker-compose up
[root@rocky8 alertmanager]#pwd
/root/learning-prometheus-master/08-prometheus-components-compose/alertmanager
</code></pre> 
<h4 id="%E5%90%AF%E7%94%A8%E5%91%8A%E8%AD%A6%E5%8A%9F%E8%83%BD%EF%BC%9A">启用告警功能：</h4> 
<p>  1、在prometheus server上，编写并加载alert rule；<br>   2、在prometheus server上，指定要使用的alertmanager；<br>   3、在alertmanager，定义好告警接收人；<br>       - email <br>       - dingtalk <br>       - wechat <br>       - 短信</p> 
<p>  4、把alertmanager纳入到监控目标中来； </p> 
<h6 id="%C2%A0%E5%AE%9A%E4%B9%89%E5%91%8A%E8%AD%A6%E5%8F%91%E9%80%81"> 定义告警发送</h6> 
<pre><code>[root@rocky8 alertmanager]#cat email_template.tmpl    告警二次处理文件
{<!-- -->{ define "email.default.html" }}
{<!-- -->{- if gt (len .Alerts.Firing) 0 -}}
{<!-- -->{ range .Alerts }}
=========start==========&lt;br&gt;
告警程序: prometheus_alert &lt;br&gt;
告警级别: {<!-- -->{ .Labels.severity }} &lt;br&gt;
告警类型: {<!-- -->{ .Labels.alertname }} &lt;br&gt;
告警主机: {<!-- -->{ .Labels.instance }} &lt;br&gt;
告警主题: {<!-- -->{ .Annotations.summary }}  &lt;br&gt;
告警详情: {<!-- -->{ .Annotations.description }} &lt;br&gt;
触发时间: {<!-- -->{ .StartsAt.Format "2006-01-02 15:04:05" }} &lt;br&gt;
=========end==========&lt;br&gt;
{<!-- -->{ end }}{<!-- -->{ end -}}
 
{<!-- -->{- if gt (len .Alerts.Resolved) 0 -}}
{<!-- -->{ range .Alerts }}
=========start==========&lt;br&gt;
告警程序: prometheus_alert &lt;br&gt;
告警级别: {<!-- -->{ .Labels.severity }} &lt;br&gt;
告警类型: {<!-- -->{ .Labels.alertname }} &lt;br&gt;
告警主机: {<!-- -->{ .Labels.instance }} &lt;br&gt;
告警主题: {<!-- -->{ .Annotations.summary }} &lt;br&gt;
告警详情: {<!-- -->{ .Annotations.description }} &lt;br&gt;
触发时间: {<!-- -->{ .StartsAt.Format "2006-01-02 15:04:05" }} &lt;br&gt;
恢复时间: {<!-- -->{ .EndsAt.Format "2006-01-02 15:04:05" }} &lt;br&gt;
=========end==========&lt;br&gt;
{<!-- -->{ end }}{<!-- -->{ end -}}
{<!-- -->{- end }}


[root@rocky8 alertmanager]#cat config.yml   告警文件处理
global:
    resolve_timeout: 1m
    smtp_smarthost: 'smtp.qq.com:465'
    smtp_from: '704318431@qq.com'
    smtp_auth_username: '704318431@qq.com'
    smtp_auth_password: 'uvytiziidqbbid'
    smtp_hello: '@qq.com'
    smtp_require_tls: false

route:
    # The labels by which incoming alerts are grouped together. For example,
    # multiple alerts coming in for job=mysqld-exporter and alertname=mysql_down would
    # be batched into a single group.
    group_by: ['job', 'alertname'] 

    # When a new group of alerts is created by an incoming alert, wait at
    # least 'group_wait' to send the initial notification.
    # This way ensures that you get multiple alerts for the same group that start
    # firing shortly after another are batched together on the first notification.
    group_wait: 10s

    # When the first notification was sent, wait 'group_interval' to send a batch
    # of new alerts that started firing for that group.
    group_interval: 10s

    # If an alert has successfully been sent, wait 'repeat_interval' to resend them.
    repeat_interval: 5m

    receiver: team-devops-email
    #receiver: team-devops-wechat

templates:
  - '/etc/alertmanager/email_template.tmpl'
  - '/etc/alertmanager/wechat_template.tmpl'

 # 定义接收者
receivers:
- name: 'team-devops-email'
  email_configs:
    - to: '13363328683@163.com'
      headers:
        subject: "{<!-- -->{ .Status | toUpper }} {<!-- -->{ .CommonLabels.env }}:{<!-- -->{ .CommonLabels.cluster }} {<!-- -->{ .CommonLabels.alertname }}"
      html: '{<!-- -->{ template "email.default.html" . }}'
      send_resolved: true 

- name: 'team-devops-wechat'
  wechat_configs:
    - corp_id: ww4c893118fbf4d07c 
      to_user: '@all'
      agent_id: 1000003
      api_secret: WTepmmaqxbBOeTQOuxa0Olzov_hSEWsZWrPX1k6opMk
      send_resolved: true

inhibit_rules: 
  - source_match: 
     severity: 'critical' 
    target_match: 
     severity: 'warning' 
    equal: ['alertname', 'job']
</code></pre> 
<h6 id="%E5%9C%A8Prometheus%E4%B8%8A%E5%AE%9A%E4%B9%89%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99">在Prometheus上定义告警规则</h6> 
<pre><code>[root@rocky8 rules]#pwd
/usr/local/prometheus/rules

[root@rocky8 rules]#cat alert-rules-blackbox-exporter.yml 
groups:
- name: blackbox
  rules:
  
  # Blackbox probe failed
  - alert: BlackboxProbeFailed
    expr: probe_success == 0
    for: 0m
    labels:
      severity: critical
    annotations:
      summary: Blackbox probe failed (instance {<!-- -->{ $labels.instance }})
      description: "Probe failed\n  VALUE = {<!-- -->{ $value }}\n  LABELS = {<!-- -->{ $labels }}"

  # Blackbox slow probe
  - alert: BlackboxSlowProbe
    expr: avg_over_time(probe_duration_seconds[1m]) &gt; 1
    for: 1m
    labels:
      severity: warning
    annotations:
      summary: Blackbox slow probe (instance {<!-- -->{ $labels.instance }})
      description: "Blackbox probe took more than 1s to complete\n  VALUE = {<!-- -->{ $value }}\n  LABELS = {<!-- -->{ $labels }}"

  # Blackbox probe HTTP failure
  - alert: BlackboxProbeHttpFailure
    expr: probe_http_status_code &lt;= 199 OR probe_http_status_code &gt;= 400
    for: 0m
    labels:
      severity: critical
    annotations:
      summary: Blackbox probe HTTP failure (instance {<!-- -->{ $labels.instance }})
      description: "HTTP status code is not 200-399\n  VALUE = {<!-- -->{ $value }}\n  LABELS = {<!-- -->{ $labels }}"

  # Blackbox probe slow HTTP
  - alert: BlackboxProbeSlowHttp
    expr: avg_over_time(probe_http_duration_seconds[1m]) &gt; 1
    for: 1m
    labels:
      severity: warning
    annotations:
      summary: Blackbox probe slow HTTP (instance {<!-- -->{ $labels.instance }})
      description: "HTTP request took more than 1s\n  VALUE = {<!-- -->{ $value }}\n  LABELS = {<!-- -->{ $labels }}"

  # Blackbox probe slow ping
  - alert: BlackboxProbeSlowPing
    expr: avg_over_time(probe_icmp_duration_seconds[1m]) &gt; 1
    for: 1m
    labels:
      severity: warning
    annotations:
      summary: Blackbox probe slow ping (instance {<!-- -->{ $labels.instance }})
      description: "Blackbox ping took more than 1s\n  VALUE = {<!-- -->{ $value }}\n  LABELS = {<!-- -->{ $labels }}"

</code></pre> 
<p>在Prometheus上让他加载</p> 
<pre><code>[root@rocky8 prometheus]#cat prometheus.yml
# my global config
global:
  scrape_interval: 15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.
  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.
  # scrape_timeout is set to the global default (10s).

# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - 10.0.0.18:9093   #指定 alertmanager告警发配置送路径
          # - alertmanager:9093

# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.
rule_files:
    - rules/record-rules-*.yml
    - rules/alert-rules-*.yml   #指定告警文件加载路径


[root@rocky8 prometheus]#./promtool check config ./prometheus.yml   #检查
[root@rocky8 prometheus]#curl -XPOST localhost:9090/-/reload        #加载</code></pre> 
<p> 实例</p> 
<p><img alt="" height="664" src="https://images2.imgbox.com/49/8a/X7R5loCE_o.png" width="1200"></p> 
<p> 钉钉告警</p> 
<p><img alt="" height="513" src="https://images2.imgbox.com/0d/72/ZfExQ3iZ_o.png" width="1200"></p> 
<p> 对应的这两个</p> 
<p> <img alt="" height="371" src="https://images2.imgbox.com/96/d7/LkEM5eIo_o.png" width="676"></p> 
<p> 然后重新启动就可以了</p> 
<pre><code>[root@rocky8 alertmanager]#pwd
/root/learning-prometheus-master/08-prometheus-components-compose/alertmanager-and-dingtalk/alertmanager
[root@rocky8 alertmanager]#cat config.yml 
global:
    resolve_timeout: 1m
    smtp_smarthost: 'smtp.qq.com:465'
    smtp_from: 'ikubernetes@qq.com'
    smtp_auth_username: 'ikubernetes@qq.com'
    smtp_auth_password: 'ioojgoqmgybfbgfg'
    smtp_hello: '@qq.com'
    smtp_require_tls: false

route:
    # The labels by which incoming alerts are grouped together. For example,
    # multiple alerts coming in for job=mysqld-exporter and alertname=mysql_down would
    # be batched into a single group.
    group_by: ['job', 'alertname'] 

    # When a new group of alerts is created by an incoming alert, wait at
    # least 'group_wait' to send the initial notification.
    # This way ensures that you get multiple alerts for the same group that start
    # firing shortly after another are batched together on the first notification.
    group_wait: 10s

    # When the first notification was sent, wait 'group_interval' to send a batch
    # of new alerts that started firing for that group.
    group_interval: 10s

    # If an alert has successfully been sent, wait 'repeat_interval' to resend them.
    repeat_interval: 5m

    receiver: team-devops-dingtalk
    #receiver: team-devops-email
    #receiver: team-devops-wechat

templates:
  - '/etc/alertmanager/email_template.tmpl'
  - '/etc/alertmanager/wechat_template.tmpl'

 # 定义接收者
receivers:
- name: 'team-devops-email'
  email_configs:
    - to: 'mage@magedu.com'
      headers:
        subject: "{<!-- -->{ .Status | toUpper }} {<!-- -->{ .CommonLabels.env }}:{<!-- -->{ .CommonLabels.cluster }} {<!-- -->{ .CommonLabels.alertname }}"
      html: '{<!-- -->{ template "email.default.html" . }}'
      send_resolved: true 

- name: 'team-devops-wechat'
  wechat_configs:
    - corp_id: ww4c893118fbf4d07c 
      to_user: '@all'
      agent_id: 1000008
      api_secret: WTepmmaqxbBOeTQOuxa0Olzov_hSEWsZWrPX1k6opMk
      send_resolved: true

- name: 'team-devops-dingtalk'
  webhook_configs:
  - url: http://prometheus-webhook-dingtalk:8060/dingtalk/webhook1/send             
    send_resolved: true

inhibit_rules: 
  - source_match: 
     severity: 'critical' 
    target_match: 
     severity: 'warning' 
    equal: ['alertname', 'job']
</code></pre> 
<p><img alt="" height="461" src="https://images2.imgbox.com/df/63/mNKG7CpM_o.png" width="743"></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/cada8c5813bb9a70e281582c5326e651/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">kubernetes集群一个master两个node证书过期解决</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3880caf99814f5c6765b848b55ba0c22/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">BUSMASTER使用记录（二）：诊断功能、在线16进制转字符串、脚本编写</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>