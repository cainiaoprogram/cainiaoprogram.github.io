<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>PowerMockito的基本使用 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="PowerMockito的基本使用" />
<meta property="og:description" content="PowerMockito经常会结合Mockito使用，先说一下这2个的介绍：
1.Mockito和PowerMockito的简介 Mockito和PowerMockito是什么东西呢？他们有什么作用呢？Mocktio和PowerMockito都是Mock的工具类，主要是Java的类库，Mock就是伪装的意思。他们适用于单元测试中，对于单元测试来说，我们不希望依赖于第三方的组件，比如数据库、Webservice等。在写单元测试的时候，我们如果遇到了这些需要依赖第三方的情况，我们可以使用Mock的技术，伪造出来我们自己想要的结果。对于Java而言，mock的对象主要是Java 方法和 Java类。
下面我就介绍一下怎么使用Mockito和PowerMockito去进行Mock。
2.Mockito和PowerMockito的区别 在我看来，PowerMockito是Mockito的一种增强，他们的PowerMockito可以调用Mockito的方法，但是对于Mocktio不能Mock的对象或者方法，我们可以使用PowerMockito来实现。比如Mockito不能用于static Method, final method, 枚举类， private method，这些我们都可以用PowerMockito来实现，当PowerMockito和mockito结合使用的时候，我们需要考虑兼容性的问题。两者的版本需要兼容。
MockitoPowerMockito2.8.9&#43;2.x2.8.0-2.8.91.7.x2.7.51.7.0RC42.4.01.7.0RC22.0.0-beta - 2.0.42-beta1.6.5-1.7.0RC1.10.8 - 1.10.x1.6.2 - 2.01.9.5-rc1 - 1.9.51.5.0 - 1.5.61.9.0-rc1 &amp; 1.9.01.4.10 - 1.4.121.8.51.3.9 - 1.4.91.8.41.3.7 &amp; 1.3.81.8.31.3.61.8.1 &amp; 1.8.21.3.51.81.31.71.2.5 Ref：https://github.com/powermock/powermock/wiki/Mockito
3.具体用法 本文实现实现需要构造的接口和需要返回值的接口
引入依赖 &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.projectlombok&lt;/groupId&gt; &lt;artifactId&gt;lombok&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework&lt;/groupId&gt; &lt;artifactId&gt;spring-context-support&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework&lt;/groupId&gt; &lt;artifactId&gt;spring-test&lt;/artifactId&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;junit&lt;/groupId&gt; &lt;artifactId&gt;junit&lt;/artifactId&gt; &lt;version&gt;4.12&lt;/version&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.mockito&lt;/groupId&gt; &lt;artifactId&gt;mockito-all&lt;/artifactId&gt; &lt;version&gt;2.0.2-beta&lt;/version&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.powermock&lt;/groupId&gt; &lt;artifactId&gt;powermock-module-junit4&lt;/artifactId&gt; &lt;version&gt;1.7.4&lt;/version&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/324862b75a60b10e885210f7a0792761/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-06-04T11:46:45+08:00" />
<meta property="article:modified_time" content="2020-06-04T11:46:45+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">PowerMockito的基本使用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>PowerMockito经常会结合Mockito使用，先说一下这2个的介绍：</p> 
<h4>1.Mockito和PowerMockito的简介</h4> 
<p><br> Mockito和PowerMockito是什么东西呢？他们有什么作用呢？Mocktio和PowerMockito都是Mock的工具类，主要是Java的类库，Mock就是伪装的意思。他们适用于单元测试中，对于单元测试来说，我们不希望依赖于第三方的组件，比如数据库、Webservice等。在写单元测试的时候，我们如果遇到了这些需要依赖第三方的情况，我们可以使用Mock的技术，伪造出来我们自己想要的结果。对于Java而言，mock的对象主要是Java 方法和 Java类。</p> 
<p>下面我就介绍一下怎么使用Mockito和PowerMockito去进行Mock。</p> 
<h4>2.Mockito和PowerMockito的区别</h4> 
<p><br> 在我看来，PowerMockito是Mockito的一种增强，他们的PowerMockito可以调用Mockito的方法，但是对于Mocktio不能Mock的对象或者方法，我们可以使用PowerMockito来实现。比如Mockito不能用于static Method, final method, 枚举类， private method，这些我们都可以用PowerMockito来实现，当PowerMockito和mockito结合使用的时候，我们需要考虑兼容性的问题。两者的版本需要兼容。</p> 
<p> </p> 
<table style="width:346px;"><tbody><tr><th style="width:182px;">Mockito</th><th style="width:161px;"><strong><u>PowerMockito</u></strong></th></tr><tr><td style="width:182px;">2.8.9+</td><td style="width:161px;">2.x</td></tr><tr><td style="width:182px;">2.8.0-2.8.9</td><td style="width:161px;">1.7.x</td></tr><tr><td style="width:182px;">2.7.5</td><td style="width:161px;">1.7.0RC4</td></tr><tr><td style="width:182px;">2.4.0</td><td style="width:161px;">1.7.0RC2</td></tr><tr><td style="width:182px;">2.0.0-beta - 2.0.42-beta</td><td style="width:161px;">1.6.5-1.7.0RC</td></tr><tr><td style="width:182px;">1.10.8 - 1.10.x</td><td style="width:161px;">1.6.2 - 2.0</td></tr><tr><td style="width:182px;">1.9.5-rc1 - 1.9.5</td><td style="width:161px;">1.5.0 - 1.5.6</td></tr><tr><td style="width:182px;">1.9.0-rc1 &amp; 1.9.0</td><td style="width:161px;">1.4.10 - 1.4.12</td></tr><tr><td style="width:182px;">1.8.5</td><td style="width:161px;">1.3.9 - 1.4.9</td></tr><tr><td style="width:182px;">1.8.4</td><td style="width:161px;">1.3.7 &amp; 1.3.8</td></tr><tr><td style="width:182px;">1.8.3</td><td style="width:161px;">1.3.6</td></tr><tr><td style="width:182px;">1.8.1 &amp; 1.8.2</td><td style="width:161px;">1.3.5</td></tr><tr><td style="width:182px;">1.8</td><td style="width:161px;">1.3</td></tr><tr><td style="width:182px;">1.7</td><td style="width:161px;">1.2.5</td></tr></tbody></table> 
<p>Ref：<a href="https://github.com/powermock/powermock/wiki/Mockito">https://github.com/powermock/powermock/wiki/Mockito</a></p> 
<h4>3.具体用法</h4> 
<p>本文实现实现需要构造的接口和需要返回值的接口</p> 
<ul><li>引入依赖</li></ul> 
<pre><code class="language-html">&lt;dependencies&gt;
	&lt;dependency&gt;
		&lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
		&lt;artifactId&gt;lombok&lt;/artifactId&gt;
	&lt;/dependency&gt;
	&lt;dependency&gt;
		&lt;groupId&gt;org.springframework&lt;/groupId&gt;
		&lt;artifactId&gt;spring-context-support&lt;/artifactId&gt;
	&lt;/dependency&gt;
	&lt;dependency&gt;
		&lt;groupId&gt;org.springframework&lt;/groupId&gt;
		&lt;artifactId&gt;spring-test&lt;/artifactId&gt;
		&lt;scope&gt;test&lt;/scope&gt;
	&lt;/dependency&gt;
	&lt;dependency&gt;
		&lt;groupId&gt;junit&lt;/groupId&gt;
		&lt;artifactId&gt;junit&lt;/artifactId&gt;
		&lt;version&gt;4.12&lt;/version&gt;
		&lt;scope&gt;test&lt;/scope&gt;
	&lt;/dependency&gt;
	&lt;dependency&gt;
		&lt;groupId&gt;org.mockito&lt;/groupId&gt;
		&lt;artifactId&gt;mockito-all&lt;/artifactId&gt;
		&lt;version&gt;2.0.2-beta&lt;/version&gt;
		&lt;scope&gt;test&lt;/scope&gt;
	&lt;/dependency&gt;
	&lt;dependency&gt;
		&lt;groupId&gt;org.powermock&lt;/groupId&gt;
		&lt;artifactId&gt;powermock-module-junit4&lt;/artifactId&gt;
		&lt;version&gt;1.7.4&lt;/version&gt;
		&lt;scope&gt;test&lt;/scope&gt;
	&lt;/dependency&gt;
	&lt;dependency&gt;
		&lt;groupId&gt;org.powermock&lt;/groupId&gt;
		&lt;artifactId&gt;powermock-api-mockito&lt;/artifactId&gt;
		&lt;version&gt;1.7.4&lt;/version&gt;
		&lt;scope&gt;test&lt;/scope&gt;
	&lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre> 
<ul><li>需要Mock的类:</li></ul> 
<p>ProcessDB.java</p> 
<pre><code class="language-java">package com.github.mock.simple.vo;

public class ProcessDB {
    
    public ProcessDB(String ss){
        System.out.println(ss + " Enter ProcessDB ...");
    }
    
    public ProcessDB(){
        System.out.println("Enter ProcessDB ...");
    }
    
    public void getResultOfConnectDBNoReturn(String ss) {
        System.out.println(ss + " Enter getResultOfConnectDBNoReturn ...");
    }
    
    public String getResultOfConnectDB() {
        return "haha, Really went to the database";
    }
}
 
</code></pre> 
<ul><li>需要测试的类：</li></ul> 
<p>IUserService.java</p> 
<pre><code class="language-java">package com.github.mock.simple.user;

public interface IUserService {

    public String testedMehtod();

}
</code></pre> 
<p>UserServiceImpl.java</p> 
<pre><code class="language-java">package com.github.mock.simple.user.impl;

import org.springframework.stereotype.Service;

import com.github.mock.simple.user.IUserService;
import com.github.mock.simple.vo.ProcessDB;

@Service
public class UserServiceImpl implements IUserService {

    @Override
    public String testedMehtod(){
        System.out.println("Enter UserServiceImpl testedMehtod ...");
        ProcessDB processDB = new ProcessDB("BB");
        processDB.getResultOfConnectDBNoReturn("AA");
        return processDB.getResultOfConnectDB();
    }

}
</code></pre> 
<p>BussinessService.java</p> 
<pre><code class="language-java">package com.github.mock.simple.user.impl;

import com.github.mock.simple.vo.ProcessDB;

public class BussinessService {
    public String testedMehtod() {
        System.out.println("Enter BussinessService testedMehtod ...");
        ProcessDB processDB = new ProcessDB("BB");
        processDB.getResultOfConnectDBNoReturn("AA");
        return processDB.getResultOfConnectDB();
    }
}
</code></pre> 
<ul><li>测试类：</li></ul> 
<p>MockSpringSimpleTest.java</p> 
<pre><code class="language-java">package com.github.mock.simple.test;

import java.text.MessageFormat;

import org.junit.Assert;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.MockitoAnnotations;
import org.powermock.api.mockito.PowerMockito;
import org.powermock.core.classloader.annotations.PrepareForTest;
import org.powermock.modules.junit4.PowerMockRunner;
import org.powermock.modules.junit4.PowerMockRunnerDelegate;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;

import com.github.mock.simple.user.IUserService;
import com.github.mock.simple.user.impl.BussinessService;
import com.github.mock.simple.user.impl.UserServiceImpl;
import com.github.mock.simple.vo.ProcessDB;

@RunWith(PowerMockRunner.class)
@PowerMockRunnerDelegate(SpringJUnit4ClassRunner.class)//Spring上下文
@PrepareForTest({BussinessService.class,UserServiceImpl.class})
@ContextConfiguration(locations = {"classpath:applicationContext-mock-inject.xml"})
public class MockSpringSimpleTest {

    //使用Spring上下文
    @Autowired
    IUserService userService;

    @Mock
    ProcessDB processDB;
    
    //不使用Spring上下文时，使用该注解
    @InjectMocks
    private BussinessService bussinessService;

    @Before
    public void initMocks() throws Exception {
        MockitoAnnotations.initMocks(this);
        //ReflectionTestUtils.setField(userService, "processDB", processDB);
        PowerMockito.whenNew(ProcessDB.class).withArguments("BB").thenReturn(processDB);
        // PowerMockito.whenNew(ProcessDB.class).withNoArguments().thenReturn(processDB);
    }

    @Test
    public void mockConnectDB() {
        String aa = "haha, everything is fake"; 
        PowerMockito.when(processDB.getResultOfConnectDB()).thenReturn(aa);
        PowerMockito.doNothing().when(processDB).getResultOfConnectDBNoReturn("AA");
        System.out.println(bussinessService.testedMehtod());
        Assert.assertEquals("haha, everything is fake", bussinessService.testedMehtod());
    }

    @Test
    public void mockConnectDB2() {
        try {
            String aa = "haha, everything is fake";
            PowerMockito.when(processDB.getResultOfConnectDB()).thenReturn(aa);
            PowerMockito.doNothing().when(processDB).getResultOfConnectDBNoReturn("AA");
            System.out.println(userService.testedMehtod());
            Assert.assertEquals("haha, everything is fake", userService.testedMehtod());
        } catch (Exception ex) {
            System.out.println("--- getMessage ---");
            System.out.println(ex.getMessage());
            System.out.println();
            
            System.out.println("--- toString ---");
            System.out.println(ex.toString());
            System.out.println();
            
//            System.out.println("--- printStackTrace ---");
//            StringWriter stringWriter = new StringWriter();
//            PrintWriter printWriter = new PrintWriter(stringWriter);
//            ex.printStackTrace(printWriter);
//            System.out.println(stringWriter.toString());
//            System.out.println();
            
            System.out.println("--- printStackTrace DIY ---");
            System.out.println(ex.getClass().getName() + ": " + ex.getMessage());
            StringBuilder sbException = new StringBuilder();
            for (StackTraceElement ele : ex.getStackTrace()) {
                sbException.append(MessageFormat.format("\tat {0}.{1}({2}:{3})\n", 
                    ele.getClassName(), ele.getMethodName(), ele.getFileName(), ele.getLineNumber()));;
            }
            System.out.println(sbException);
            
            sbException = null;
//            stringWriter = null;
//            printWriter = null;
        }
    }

}
</code></pre> 
<ul><li>扫描注入xml</li></ul> 
<p>最后applicationContext-mock-inject.xml</p> 
<pre><code class="language-html">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xsi:schemaLocation="
	http://www.springframework.org/schema/beans
	http://www.springframework.org/schema/beans/spring-beans.xsd  
	http://www.springframework.org/schema/context
	http://www.springframework.org/schema/context/spring-context.xsd"&gt;

    &lt;context:component-scan base-package="com.github.mock.simple"/&gt;

&lt;/beans&gt;</code></pre> 
<p>对于没有实现类，但又被依赖的接口，在applicationContext-mock-inject.xml添加如下内容 (本文不需要)：</p> 
<pre><code class="language-html">&lt;bean name="iXxService" class="org.mockito.Mockito" factory-method="mock"&gt;
    &lt;constructor-arg value="com.github.mock.simple.api.IXxService"/&gt;
&lt;/bean&gt;</code></pre> 
<p>同时在测试类里面添加下面的代码：</p> 
<pre><code class="language-java">@Mock
iXxService iXxService;</code></pre> 
<p>在 @Before里面添加下面的代码</p> 
<pre><code class="language-java">ReflectionTestUtils.setField(userService, "iXxService", iXxService);</code></pre> 
<ul><li>测试结果</li></ul> 
<p><img alt="" height="130" src="https://images2.imgbox.com/3e/e9/hwQP3lQL_o.png" width="735"></p> 
<p><img alt="" height="190" src="https://images2.imgbox.com/9e/98/mQFWMBuB_o.png" width="866"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/bec1edcb36948c48e1f61e995b5a3e8c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">华人博士提出原型对比学习，非监督学习效果远超MoCo和SimCLR</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b65539bc4b7ab9a46694ae611cf384a0/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">深度学习之Batch Normalization</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>