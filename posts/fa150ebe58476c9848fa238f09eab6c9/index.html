<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>HDFS的 DataNode 工作机制 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="HDFS的 DataNode 工作机制" />
<meta property="og:description" content="1 DataNode 工作机制 1）一个数据块在DataNode上以文件形式存储在磁盘上，包括两个文件，一个是数据本身，一个是元数据包括数据块的长度，块数据的校验和，以及时间戳。
2）DataNode启动后向NameNode注册，通过后，周期性（1小时）的向NameNode上报所有的块信息。
3）心跳是每3秒一次，心跳返回结果带有NameNode给该DataNode的命令如复制块数据到另一台机器，或删除某个数据块。如果超过10分钟没有收到某个DataNode的心跳，则认为该节点不可用。
4）集群运行中可以安全加入和退出一些机器。
2 掉线时限参数设置 需要注意的是hdfs-site.xml 配置文件中的heartbeat.recheck.interval的单位为毫秒，dfs.heartbeat.interval的单位为秒。
&lt;property&gt;
&lt;name&gt;dfs.namenode.heartbeat.recheck-interval&lt;/name&gt;
&lt;value&gt;300000&lt;/value&gt;
&lt;/property&gt;
&lt;property&gt;
&lt;name&gt;dfs.heartbeat.interval&lt;/name&gt;
&lt;value&gt;3&lt;/value&gt;
&lt;/property&gt;
3 退役旧数据节点 3.1 添加白名单 添加到白名单的主机节点，都允许访问NameNode，不在白名单的主机节点，都会被退出。
配置白名单的具体步骤如下：
（1）在NameNode的/opt/module/hadoop-2.7.2/etc/hadoop目录下创建dfs.hosts文件
[haitao@hadoop102 hadoop]$ pwd
/opt/module/hadoop-2.7.2/etc/hadoop
[haitao@hadoop102 hadoop]$ touch dfs.hosts
[haitao@hadoop102 hadoop]$ vi dfs.hosts
添加如下主机名称（不添加hadoop105）
hadoop102
hadoop103
hadoop104
（2）在NameNode的hdfs-site.xml配置文件中增加dfs.hosts属性
&lt;property&gt;
&lt;name&gt;dfs.hosts&lt;/name&gt;
&lt;value&gt;/opt/module/hadoop-2.7.2/etc/hadoop/dfs.hosts&lt;/value&gt;
&lt;/property&gt;
（3）配置文件分发
[haitao@hadoop102 hadoop]$ xsync hdfs-site.xml
（4）刷新NameNode
[haitao@hadoop102 hadoop-2.7.2]$ hdfs dfsadmin -refreshNodes
Refresh nodes successful
（5）更新ResourceManager节点
[haitao@hadoop102 hadoop-2.7.2]$ yarn rmadmin -refreshNodes
20/06/24 14:17:11 INFO client." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/fa150ebe58476c9848fa238f09eab6c9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-04-22T23:24:01+08:00" />
<meta property="article:modified_time" content="2021-04-22T23:24:01+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">HDFS的 DataNode 工作机制</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>1 DataNode 工作机制</h2> 
<p><img alt="" height="505" src="https://images2.imgbox.com/cb/61/6ek2Yhbe_o.png" width="1064"></p> 
<p style="margin-left:0cm;">1）一个数据块在DataNode上以文件形式存储在磁盘上，包括两个文件，一个是数据本身，一个是元数据包括数据块的长度，块数据的校验和，以及时间戳。</p> 
<p style="margin-left:0cm;">2）DataNode启动后向NameNode注册，通过后，周期性（1小时）的向NameNode上报所有的块信息。</p> 
<p style="margin-left:0cm;">3）心跳是每3秒一次，心跳返回结果带有NameNode给该DataNode的命令如复制块数据到另一台机器，或删除某个数据块。如果超过10分钟没有收到某个DataNode的心跳，则认为该节点不可用。</p> 
<p style="margin-left:0cm;">4）集群运行中可以安全加入和退出一些机器。</p> 
<h2 style="margin-left:0cm;">2 掉线时限参数设置</h2> 
<p style="margin-left:0cm;"><img alt="" height="489" src="https://images2.imgbox.com/bd/49/kuIuDcbd_o.png" width="1030"></p> 
<p style="margin-left:0cm;"><span style="color:#000000;">需要注意的是</span><span style="color:#000000;">hdfs-site.xml </span><span style="color:#000000;">配置文件中的</span><span style="color:#000000;">heartbeat.recheck.interval</span><span style="color:#000000;">的单位为</span><span style="color:#FF0000;">毫秒</span><span style="color:#000000;">，</span><span style="color:#000000;">dfs.heartbeat.interval</span><span style="color:#000000;">的单位为</span><span style="color:#FF0000;">秒</span><span style="color:#000000;">。</span></p> 
<blockquote> 
 <p style="margin-left:0cm;"><span style="color:#000000;">&lt;property&gt;</span></p> 
 <p style="margin-left:0cm;"><span style="color:#000000;">    &lt;name&gt;dfs.namenode.heartbeat.recheck-interval&lt;/name&gt;</span></p> 
 <p style="margin-left:0cm;"><span style="color:#000000;">    &lt;value&gt;300000&lt;/value&gt;</span></p> 
 <p style="margin-left:0cm;"><span style="color:#000000;">&lt;/property&gt;</span></p> 
 <p style="margin-left:0cm;"><span style="color:#000000;">&lt;property&gt;</span></p> 
 <p style="margin-left:0cm;"><span style="color:#000000;">    &lt;name&gt;dfs.heartbeat.interval&lt;/name&gt;</span></p> 
 <p style="margin-left:0cm;"><span style="color:#000000;">    &lt;value&gt;3&lt;/value&gt;</span></p> 
 <p style="margin-left:0cm;"><span style="color:#000000;">&lt;/property&gt;</span></p> 
</blockquote> 
<h2 style="margin-left:0cm;">3 退役旧数据节点</h2> 
<h3 style="margin-left:0cm;">3.1 添加白名单</h3> 
<p style="margin-left:0cm;">添加到白名单的主机节点，都允许访问NameNode，不在白名单的主机节点，都会被退出。</p> 
<p style="margin-left:0cm;">配置白名单的具体步骤如下：</p> 
<p style="margin-left:0cm;">（1）在NameNode的/opt/module/hadoop-2.7.2/etc/hadoop目录下创<span style="color:#000000;">建</span><span style="color:#000000;">dfs.hosts</span><span style="color:#000000;">文件</span></p> 
<blockquote> 
 <p style="margin-left:0cm;"><span style="color:#000000;">[haitao@hadoop102 hadoop]$ pwd</span></p> 
 <p style="margin-left:0cm;"><span style="color:#000000;">/opt/module/hadoop-2.7.2/etc/hadoop</span></p> 
 <p style="margin-left:0cm;"><span style="color:#000000;">[haitao@hadoop102 hadoop]$ touch dfs.hosts</span></p> 
 <p style="margin-left:0cm;">[haitao@hadoop102 hadoop]$ vi dfs.hosts</p> 
</blockquote> 
<p> 添加如下主机名称（<span style="color:#FF0000;">不添加</span><span style="color:#FF0000;">hadoop105</span>）</p> 
<blockquote> 
 <p style="margin-left:0cm;"><span style="color:#000000;">hadoop102</span></p> 
 <p style="margin-left:0cm;"><span style="color:#000000;">hadoop103</span></p> 
 <p style="margin-left:0cm;"><span style="color:#000000;">hadoop104</span></p> 
</blockquote> 
<p> （2）在NameNode的hdfs-site.xml配置文件中增加dfs.hosts属性</p> 
<blockquote> 
 <p style="margin-left:0cm;"><span style="color:#000000;">&lt;property&gt;</span></p> 
 <p style="margin-left:0cm;"><span style="color:#000000;">&lt;name&gt;dfs.hosts&lt;/name&gt;</span></p> 
 <p style="margin-left:0cm;"><span style="color:#000000;">&lt;value&gt;/opt/module/hadoop-2.7.2/etc/hadoop/dfs.hosts&lt;/value&gt;</span></p> 
 <p style="margin-left:0cm;"><span style="color:#000000;">&lt;/property&gt;</span></p> 
</blockquote> 
<p> （3）配置文件分发</p> 
<blockquote> 
 <p style="margin-left:0cm;"><span style="color:#000000;">[haitao@hadoop102 hadoop]$ xsync hdfs-site.xml</span></p> 
</blockquote> 
<p> （4）刷新NameNode</p> 
<blockquote> 
 <p style="margin-left:0cm;"><span style="color:#000000;">[haitao@hadoop102 hadoop-2.7.2]$ hdfs dfsadmin -refreshNodes</span></p> 
</blockquote> 
<p>Refresh nodes successful</p> 
<p>（5）更新ResourceManager节点</p> 
<blockquote> 
 <p style="margin-left:0cm;"><span style="color:#000000;">[haitao@hadoop102 hadoop-2.7.2]$ yarn rmadmin -refreshNodes</span></p> 
 <p style="margin-left:0cm;"><span style="color:#000000;">20/06/24 14:17:11 INFO client.RMProxy: Connecting to ResourceManager at hadoop103/192.168.1.103:8033</span></p> 
</blockquote> 
<p>（6）在web浏览器上查看</p> 
<p><img alt="" height="482" src="https://images2.imgbox.com/be/f1/39yhps6Z_o.png" width="1018"></p> 
<p>4. 如果数据不均衡，可以用命令实现集群的再平衡</p> 
<blockquote> 
 <p style="margin-left:0cm;"><span style="color:#000000;">[haitao@hadoop102 sbin]$ ./start-balancer.sh</span></p> 
 <p style="margin-left:0cm;"><span style="color:#000000;">starting balancer, logging to /opt/module/hadoop-2.7.2/logs/hadoop-atguigu-balancer-hadoop102.out</span></p> 
 <p style="margin-left:0cm;"><span style="color:#000000;">Time Stamp               Iteration#  Bytes Already Moved  Bytes Left To Move  Bytes Being Moved</span></p> 
</blockquote> 
<h3 style="margin-left:0cm;">3.2 黑名单退役</h3> 
<p style="margin-left:0cm;">在黑名单上面的主机都会被强制退出。</p> 
<p style="margin-left:0cm;">1.在NameNode的/opt/module/hadoop-2.7.2/etc/hadoop目录下创<span style="color:#000000;">建</span>dfs.hosts.exclude<span style="color:#000000;">文件</span></p> 
<blockquote> 
 <p style="margin-left:0cm;"><span style="color:#000000;">[haitao@hadoop102 hadoop]$ pwd</span></p> 
 <p style="margin-left:0cm;"><span style="color:#000000;">/opt/module/hadoop-2.7.2/etc/hadoop</span></p> 
 <p style="margin-left:0cm;"><span style="color:#000000;">[haitao@hadoop102 hadoop]$ touch dfs.hosts.exclude</span></p> 
 <p style="margin-left:0cm;"><span style="color:#000000;">[haitao@hadoop102 hadoop]$ vi dfs.hosts.exclude</span></p> 
</blockquote> 
<p style="margin-left:0cm;">添加如下主机名称（要退役的节点）</p> 
<blockquote> 
 <p style="margin-left:0cm;"><span style="color:#FF0000;">hadoop105</span></p> 
</blockquote> 
<p>2．在NameNode的hdfs-site.xml配置文件中增加dfs.hosts.exclude属性</p> 
<blockquote> 
 <div style="margin-left:31.5pt;"> 
  <p style="margin-left:0cm;"><span style="color:#000000;">&lt;property&gt;</span></p> 
  <p style="margin-left:0cm;"><span style="color:#000000;">&lt;name&gt;dfs.hosts.exclude&lt;/name&gt;</span></p> 
  <p style="margin-left:0cm;"><span style="color:#000000;">      &lt;value&gt;/opt/module/hadoop-2.7.2/etc/hadoop/dfs.hosts.exclude&lt;/value&gt;</span></p> 
  <p style="margin-left:0cm;"><span style="color:#000000;">&lt;/property&gt;</span></p> 
 </div> 
</blockquote> 
<p>3．刷新NameNode、刷新ResourceManager</p> 
<blockquote> 
 <div style="margin-left:31.5pt;"> 
  <p style="margin-left:0cm;"><span style="color:#000000;">[haitao@hadoop102 hadoop-2.7.2]$ hdfs dfsadmin -refreshNodes</span></p> 
  <p style="margin-left:0cm;"><span style="color:#000000;">Refresh nodes successful</span></p> 
  <p style="margin-left:0cm;"> </p> 
  <p style="margin-left:0cm;"><span style="color:#000000;">[haitao@hadoop102 hadoop-2.7.2]$ yarn rmadmin -refreshNodes</span></p> 
  <p style="margin-left:0cm;"><span style="color:#000000;">20/06/24 14:55:56 INFO client.RMProxy: Connecting to ResourceManager at hadoop103/192.168.1.103:8033</span></p> 
 </div> 
</blockquote> 
<p> 4.     检查Web浏览器，退役节点的状态为decommission in progress（退役中），说明数据节点正在复制块到其他节点，如图所示</p> 
<p><img alt="" height="112" src="https://images2.imgbox.com/03/4a/RXYo2xxq_o.png" width="1084"></p> 
<p>5.等待退役节点状态为decommissioned（所有块已经复制完成），停止该节点及节点资源管理器。注意：如果副本数是3，服役的节点小于等于3，是不能退役成功的，需要修改副本数后才能退役，如图所示</p> 
<p><img alt="" height="86" src="https://images2.imgbox.com/8e/f3/dqUx5n6v_o.png" width="994"></p> 
<p>6.    如果数据不均衡，可以用命令实现集群的再平衡</p> 
<blockquote> 
 <p style="margin-left:0cm;"><span style="color:#000000;">[haitao@hadoop102 hadoop-2.7.2]$ sbin/start-balancer.sh </span></p> 
 <p style="margin-left:0cm;"><span style="color:#000000;">starting balancer, logging to /opt/module/hadoop-2.7.2/logs/hadoop-atguigu-balancer-hadoop102.out</span></p> 
 <p style="margin-left:0cm;"><span style="color:#000000;">Time Stamp               Iteration#  Bytes Already Moved  Bytes Left To Move  Bytes Being Moved</span></p> 
</blockquote> 
<p style="margin-left:0cm;"><span style="color:#FF0000;">注意：不允许白名单和黑名单中同时出现同一个主机名称。</span></p> 
<h2 style="margin-left:0cm;">4 Datanode多目录配置</h2> 
<p style="margin-left:0cm;">1.DataNode也可以配置成多个目录，每个目录存储的数据不一样。即：数据不是副本</p> 
<p>2.具体配置如下</p> 
<p>hdfs-site.xml</p> 
<blockquote> 
 <p style="margin-left:0cm;"><span style="color:#000000;">&lt;property&gt;</span></p> 
 <p style="margin-left:0cm;"><span style="color:#000000;">        &lt;name&gt;dfs.datanode.data.dir&lt;/name&gt;</span></p> 
 <p style="margin-left:0cm;"><span style="color:#000000;">&lt;value&gt;file:///${hadoop.tmp.dir}/dfs/data1,file:///${hadoop.tmp.dir}/dfs/data2&lt;/value&gt;</span></p> 
 <p style="margin-left:0cm;"><span style="color:#000000;">&lt;/property&gt;</span></p> 
</blockquote> 
<h2 style="margin-left:0cm;">*5 HDFS 2.X 新特性</h2> 
<h3 style="margin-left:0cm;">1.数据完整性</h3> 
<p style="margin-left:0cm;">思考：如果电脑磁盘里面存储的数据是控制高铁信号灯的红灯信号（1）和绿灯信号（0），但是存储该数据的磁盘坏了，一直显示是绿灯，是否很危险？同理DataNode节点上的数据损坏了，却没有发现，是否也很危险，那么如何解决呢？</p> 
<p style="margin-left:0cm;">如下是DataNode节点保证数据完整性的方法。</p> 
<p style="margin-left:0cm;">1）当DataNode读取Block的时候，它会计算CheckSum。</p> 
<p style="margin-left:0cm;">2）如果计算后的CheckSum，与Block创建时值不一样，说明Block已经损坏。</p> 
<p style="margin-left:0cm;">3）Client读取其他DataNode上的Block。</p> 
<p style="margin-left:0cm;">4）DataNode在其文件创建后周期验证CheckSum，如图所示。</p> 
<p style="margin-left:0cm;"><img alt="" height="495" src="https://images2.imgbox.com/dd/79/YV0sQZ1P_o.png" width="1026"></p> 
<h3 style="margin-left:0cm;">2 小文件存档</h3> 
<p style="margin-left:0cm;"> </p> 
<p style="margin-left:0cm;"><img alt="" height="497" src="https://images2.imgbox.com/d8/7b/kcU59lnX_o.png" width="1038"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/54176b64f953838e9def03febf70df5f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Shell 数组</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ecb5087cbffc973498b05e8406ca67bb/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">mysql语句——图书馆查询语句</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>