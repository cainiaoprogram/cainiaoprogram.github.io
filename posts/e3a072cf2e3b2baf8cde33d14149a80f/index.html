<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>firewalld 规则配置 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="firewalld 规则配置" />
<meta property="og:description" content="一、概念 1、动态防火墙
启动新规则时，不会像ipatbles一样，先清空规则，再启动所有规则，如此会对现在程序有影响，哪怕只是一条规则。而firewalld 规则变更不需要对整个防火墙规则重载，可直接添加新规则
2、iptables与firewalld的关系
firewalld底层使用iptables作为防火墙规则管理入口。
firewalld内核模块还是netfilter,只是firewalld修改了daemon和service
添加规则还是通过iptables管理的，可以通过iptables查看规则 firewalld没有链的概念
3、firewalld 配置
储存在/usr/lib/fierwalld/和/etc/firewalld/目录中的XML文件中
/usr/lib/fierwalld/services/ 模块目录,里面有每个服务对应的模板，配置默认端口
/etc/firewalld/ 配置目录
4、firewalld区域
firewalld将网卡对应到不同的区域（zone）,zone默认共有9个：block,dmz,drop,external,home,internal,public,trusted,work.
区域相当于iptables的表 drop区域：配置的规则为丢弃的规则
public区域：公共规则
二、开放端口 1、配置文件添加
[root@localhost ~]# vim /etc/firewalld/zones/public.xml
[root@localhost ~]# vim /etc/firewalld/zones/public.xml &lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt; &lt;zone&gt; &lt;short&gt;Public&lt;/short&gt; &lt;description&gt;For use in public areas. You do not trust the other computers on networks to not harm your computer. Only selected incoming connections are accepted.&lt;/d escription&gt; &lt;service name=&#34;ssh&#34;/&gt; &lt;service name=&#34;dhcpv6-client&#34;/&gt; &lt;port protocol=&#34;tcp&#34; port=&#34;80&#34;/&gt; &lt;port protocol=&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/e3a072cf2e3b2baf8cde33d14149a80f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-01-20T15:41:59+08:00" />
<meta property="article:modified_time" content="2022-01-20T15:41:59+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">firewalld 规则配置</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>一、概念</h3> 
<p>1、动态防火墙</p> 
<blockquote> 
 <p>启动新规则时，不会像ipatbles一样，先清空规则，再启动所有规则，如此会对现在程序有影响，哪怕只是一条规则。而firewalld 规则变更不需要对整个防火墙规则重载，可直接添加新规则</p> 
</blockquote> 
<p>2、iptables与firewalld的关系</p> 
<blockquote> 
 <p>firewalld底层使用iptables作为防火墙规则管理入口。<br> firewalld内核模块还是netfilter,只是firewalld修改了daemon和service<br> 添加规则还是通过iptables管理的，可以通过iptables查看规则 <br> firewalld没有链的概念</p> 
</blockquote> 
<p>3、firewalld 配置<br> 储存在/usr/lib/fierwalld/和/etc/firewalld/目录中的XML文件中</p> 
<blockquote> 
 <p>/usr/lib/fierwalld/services/ 模块目录,里面有每个服务对应的模板，配置默认端口<br> /etc/firewalld/ 配置目录</p> 
</blockquote> 
<p>4、firewalld区域</p> 
<blockquote> 
 <p>firewalld将网卡对应到不同的区域（zone）,zone默认共有9个：block,dmz,drop,external,home,internal,public,trusted,work.<br> 区域相当于iptables的表 drop区域：配置的规则为丢弃的规则<br> public区域：公共规则</p> 
</blockquote> 
<h3><a id="_25"></a>二、开放端口</h3> 
<p>1、配置文件添加<br> [root@localhost ~]# vim /etc/firewalld/zones/public.xml</p> 
<pre><code class="prism language-c"><span class="token punctuation">[</span>root@localhost <span class="token operator">~</span><span class="token punctuation">]</span># vim <span class="token operator">/</span>etc<span class="token operator">/</span>firewalld<span class="token operator">/</span>zones<span class="token operator">/</span>public<span class="token punctuation">.</span>xml
<span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">"1.0"</span> encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token operator">?</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>zone<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token keyword">short</span><span class="token operator">&gt;</span>Public<span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">short</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>description<span class="token operator">&gt;</span>For use in public areas<span class="token punctuation">.</span> You <span class="token keyword">do</span> not trust the other computers on networks to not harm your computer<span class="token punctuation">.</span> Only selected incoming connections are accepted<span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>d
escription<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>service name<span class="token operator">=</span><span class="token string">"ssh"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>service name<span class="token operator">=</span><span class="token string">"dhcpv6-client"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>port protocol<span class="token operator">=</span><span class="token string">"tcp"</span> port<span class="token operator">=</span><span class="token string">"80"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>port protocol<span class="token operator">=</span><span class="token string">"tcp"</span> port<span class="token operator">=</span><span class="token string">"22"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>port protocol<span class="token operator">=</span><span class="token string">"tcp"</span> port<span class="token operator">=</span><span class="token string">"3306"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>port protocol<span class="token operator">=</span><span class="token string">"tcp"</span> port<span class="token operator">=</span><span class="token string">"8080"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>port protocol<span class="token operator">=</span><span class="token string">"tcp"</span> port<span class="token operator">=</span><span class="token string">"2222"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>masquerade<span class="token operator">/</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>forward<span class="token operator">-</span>port to<span class="token operator">-</span>addr<span class="token operator">=</span><span class="token string">"192.168.1.109"</span> to<span class="token operator">-</span>port<span class="token operator">=</span><span class="token string">"8080"</span> protocol<span class="token operator">=</span><span class="token string">"tcp"</span> port<span class="token operator">=</span><span class="token string">"80"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>zone<span class="token operator">&gt;</span>
</code></pre> 
<p>2、命令行添加<br> 列出所支持的zone和查看当前的默认zone</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">firewall</span><span class="token expression"><span class="token operator">-</span>cmd <span class="token operator">--</span>get<span class="token operator">-</span>zones</span></span>
</code></pre> 
<p>默认使用区域</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">firewall</span><span class="token expression"><span class="token operator">-</span>cmd <span class="token operator">--</span>get<span class="token operator">-</span><span class="token keyword">default</span><span class="token operator">-</span>zone</span></span>
</code></pre> 
<p>查看防火墙规则</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">firewall</span><span class="token expression"><span class="token operator">-</span>cmd <span class="token operator">--</span>list<span class="token operator">-</span>all</span></span>
</code></pre> 
<p>查看规则状态</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">firewall</span><span class="token expression"><span class="token operator">-</span>cmd <span class="token operator">--</span>state</span></span>
</code></pre> 
<p>加载规则</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">firewall</span><span class="token expression"><span class="token operator">-</span>cmd <span class="token operator">--</span>reload</span></span>
</code></pre> 
<p>开放3306端口</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">firewall</span><span class="token expression"><span class="token operator">-</span>cmd <span class="token operator">--</span>add<span class="token operator">-</span>port<span class="token operator">=</span><span class="token number">3306</span><span class="token operator">/</span>tcp <span class="token operator">--</span>permanent</span></span>
</code></pre> 
<p>开放网段</p> 
<pre><code class="prism language-cpp"> firewall<span class="token operator">-</span>cmd <span class="token operator">--</span>permanent <span class="token operator">--</span>add<span class="token operator">-</span>source<span class="token operator">=</span><span class="token number">192.168</span><span class="token punctuation">.</span><span class="token number">0.0</span><span class="token operator">/</span><span class="token number">22</span>
</code></pre> 
<p>移除规则</p> 
<pre><code class="prism language-cpp"> firewall<span class="token operator">-</span>cmd <span class="token operator">--</span>permanent <span class="token operator">--</span>remove<span class="token operator">-</span>source<span class="token operator">=</span><span class="token number">192.168</span><span class="token punctuation">.</span><span class="token number">0.0</span><span class="token operator">/</span><span class="token number">22</span>
</code></pre> 
<p>开放服务</p> 
<pre><code class="prism language-cpp">firewall<span class="token operator">-</span>cmd <span class="token operator">--</span>permanent <span class="token operator">--</span>add<span class="token operator">-</span>service<span class="token operator">=</span>http
</code></pre> 
<p>移除服务</p> 
<pre><code class="prism language-cpp">firewall<span class="token operator">-</span>cmd <span class="token operator">--</span>permanent <span class="token operator">--</span>remove<span class="token operator">-</span>service<span class="token operator">=</span>http
</code></pre> 
<p>添加服务</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">cp</span> <span class="token expression">ssh<span class="token punctuation">.</span>xml tomcat<span class="token punctuation">.</span>xm 添加模块</span></span>
vim tomcat<span class="token punctuation">.</span>xml
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">systemctl</span> <span class="token expression">restart firewalld<span class="token punctuation">.</span>service</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">firewall</span><span class="token expression"><span class="token operator">-</span>cmd <span class="token operator">--</span>add<span class="token operator">-</span>service<span class="token operator">=</span>tomcat <span class="token operator">--</span>permanent</span></span>
</code></pre> 
<p>开启12222端口</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">firewall</span><span class="token expression"><span class="token operator">-</span>cmd <span class="token operator">-</span>add<span class="token operator">-</span>port<span class="token operator">=</span><span class="token number">12222</span><span class="token operator">/</span>tcp <span class="token operator">--</span>permanent</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">cat</span> <span class="token expression"><span class="token operator">/</span>etc<span class="token operator">/</span>firewalld<span class="token operator">/</span>zones<span class="token operator">/</span>public<span class="token punctuation">.</span>xml</span></span>
</code></pre> 
<p>删除规则</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">firewall</span><span class="token expression"><span class="token operator">-</span>cmd <span class="token operator">--</span>remove<span class="token operator">-</span>port<span class="token operator">=</span><span class="token number">12222</span><span class="token operator">/</span>tcp <span class="token operator">--</span>permanent</span></span>
</code></pre> 
<p>允许192.168.0.142访问80端口</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">firewall</span><span class="token expression"><span class="token operator">-</span>cmd <span class="token operator">--</span>permanent <span class="token operator">--</span>add<span class="token operator">-</span>rich<span class="token operator">-</span>rule<span class="token operator">=</span></span><span class="token string">"rule family="</span><span class="token expression">ipv4</span><span class="token string">" source address="</span><span class="token expression"><span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.142</span></span><span class="token string">" port protocol="</span><span class="token expression">tcp</span><span class="token string">" port="</span><span class="token expression"><span class="token number">80</span></span><span class="token string">" accept"</span></span>
family  对哪个协议
source address	源地址
accept	允许
drop	拒绝
</code></pre> 
<p>拒绝192.168.0.142访问80端口</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">firewall</span><span class="token expression"><span class="token operator">-</span>cmd <span class="token operator">--</span>permanent <span class="token operator">--</span>add<span class="token operator">-</span>rich<span class="token operator">-</span>rule<span class="token operator">=</span></span><span class="token string">"rule family="</span><span class="token expression">ipv4</span><span class="token string">" source address="</span><span class="token expression"><span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.142</span></span><span class="token string">" port protocol="</span><span class="token expression">tcp</span><span class="token string">" port="</span><span class="token expression"><span class="token number">80</span></span><span class="token string">" drop"</span></span>
</code></pre> 
<p>注：同一规则允许及拒绝时，效果为拒绝，不会跟iptables一样，没有先后顺序优先匹配，为全文匹配，拒绝大于允许</p> 
<p>三、端口转发<br> 开启转发功能</p> 
<pre><code class="prism language-c"><span class="token punctuation">[</span>root@localhost subsys<span class="token punctuation">]</span># vim <span class="token operator">/</span>etc<span class="token operator">/</span>sysctl<span class="token punctuation">.</span>conf 
net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>ip_forward <span class="token operator">=</span> <span class="token number">1</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">sysctl</span> <span class="token expression"><span class="token operator">-</span>p</span></span>
或者
echo <span class="token number">1</span> <span class="token operator">&gt;</span><span class="token operator">/</span>proc<span class="token operator">/</span>sys<span class="token operator">/</span>net<span class="token operator">/</span>ipv4<span class="token operator">/</span>ip_forward
</code></pre> 
<p>将访问192.168.1.123(本机)主机8080端口的请求转发至80端口</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">firewall</span><span class="token expression"><span class="token operator">-</span>cmd <span class="token operator">--</span>permanent <span class="token operator">--</span>zone<span class="token operator">=</span>public <span class="token operator">--</span>add<span class="token operator">-</span>forward<span class="token operator">-</span>port<span class="token operator">=</span>port<span class="token operator">=</span><span class="token number">8080</span><span class="token operator">:</span>proto<span class="token operator">=</span>tcp<span class="token operator">:</span>toport<span class="token operator">=</span><span class="token number">80</span><span class="token operator">:</span>toaddr<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.123</span></span></span>
</code></pre> 
<p>将访问192.168.1.123（本机）主机8080端口的请求转发至192.168.1.111的80端口</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">firewall</span><span class="token expression"><span class="token operator">-</span>cmd <span class="token operator">--</span>permanent <span class="token operator">--</span>zone<span class="token operator">=</span>public <span class="token operator">--</span>add<span class="token operator">-</span>forward<span class="token operator">-</span>port<span class="token operator">=</span>port<span class="token operator">=</span><span class="token number">8080</span><span class="token operator">:</span>proto<span class="token operator">=</span>tcp<span class="token operator">:</span>toaddr<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.111</span><span class="token operator">:</span>toport<span class="token operator">=</span><span class="token number">80</span></span></span>
</code></pre> 
<p>将本机的80端口转发至192.168.1.109 8080端口</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">firewall</span><span class="token expression"><span class="token operator">-</span>cmd <span class="token operator">--</span>permanent <span class="token operator">--</span>zone<span class="token operator">=</span>public <span class="token operator">--</span>add<span class="token operator">-</span>forward<span class="token operator">-</span>port<span class="token operator">=</span>port<span class="token operator">=</span><span class="token number">80</span><span class="token operator">:</span>proto<span class="token operator">=</span>tcp<span class="token operator">:</span>toport<span class="token operator">=</span><span class="token number">8080</span><span class="token operator">:</span>toaddr<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.109</span></span></span>
</code></pre> 
<p>允许IP 192.168.1.142访问本机器的6379端口</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">firewall</span><span class="token expression"><span class="token operator">-</span>cmd <span class="token operator">--</span>permanent <span class="token operator">--</span>add<span class="token operator">-</span>rich<span class="token operator">-</span>rule<span class="token operator">=</span></span><span class="token string">"rule family="</span><span class="token expression">ipv4</span><span class="token string">" source address="</span><span class="token expression"><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.142</span></span><span class="token string">" port protocol="</span><span class="token expression">tcp</span><span class="token string">" port="</span><span class="token expression"><span class="token number">6379</span></span><span class="token string">" accept"</span></span>
</code></pre> 
<p>拒绝IP 192.168.1.142访问本机的22号端口</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">firewall</span><span class="token expression"><span class="token operator">-</span>cmd <span class="token operator">--</span>permanent <span class="token operator">--</span>add<span class="token operator">-</span>rech<span class="token operator">-</span>rule<span class="token operator">=</span></span><span class="token string">"rule family="</span><span class="token expression">ipv4</span><span class="token string">" source address="</span><span class="token expression"><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.142</span></span><span class="token string">" port protocol="</span><span class="token expression">tcp</span><span class="token string">" port="</span><span class="token expression"><span class="token number">80</span></span><span class="token string">" drop"</span></span>
</code></pre> 
<p>注：转发时，要开启伪装，伪装就是SNAT</p> 
<p>允许IP伪装</p> 
<pre><code class="prism language-c"><span class="token punctuation">[</span>root@localhost <span class="token operator">~</span><span class="token punctuation">]</span>#  firewall<span class="token operator">-</span>cmd <span class="token operator">--</span>permanent <span class="token operator">--</span>zone<span class="token operator">=</span>public <span class="token operator">--</span>add<span class="token operator">-</span>masquerade
success
<span class="token punctuation">[</span>root@localhost <span class="token operator">~</span><span class="token punctuation">]</span># firewall<span class="token operator">-</span>cmd <span class="token operator">--</span>reload
success
<span class="token punctuation">[</span>root@localhost <span class="token operator">~</span><span class="token punctuation">]</span># firewall<span class="token operator">-</span>cmd <span class="token operator">--</span>query<span class="token operator">-</span>masquerade                         
yes
</code></pre> 
<p>-----------------------------end</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/96b2a7d2bd8b5e3758ae5012d5bd997e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">关于图像傅里叶变换得到的频谱图的通俗理解</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c480de28193ad8fdc59c239985359b3c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">windows2012通过本地安全策略限制远程登录的IP地址</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>