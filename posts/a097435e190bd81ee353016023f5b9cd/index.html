<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>银联支付服务之公众号支付业务（二） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="银联支付服务之公众号支付业务（二）" />
<meta property="og:description" content="上一节已经介绍了银联的公众号支付业务，以及如何注册成为开发者，这一节将创建一个控制台应用程序调启微信支付并成功付款。 一、请求协议 HTTP(S)
HTTP方法：GET
二、接口地址 测试环境：http://58.247.0.18:29015/v1/netpay/webpay/pay
生产环境：https://api-mop.chinaums.com/v1/netpay/webpay/pay
三、参数 3.1URL参数 参数名称参数说明参数类型长度是否必须备注authorization认证方式string 是值为OPEN-FORM-PARAMappIdAppIdstring&lt;=32是 timestamp时间戳string14是yyyyMMddHHmmssnonce随机数string&lt;=128是 content业务内容string 是 signature签名string 是 Base64_Encode(HmacSHA256
(appId &#43; timestamp &#43; nonce &#43;
SHA256_HEX(content), AppKey))
3.2业务内容主体（只列出必填与部分主要参数，详细参数请参考官方文档） 格式：JSON
参数名称参数说明参数类型长度是否必须备注msgId消息IDstring&lt;=64否原样返回requestTimestamp报文请求时 间string 是格式yyyy-MM-dd HH:mm:ssmerOrderId商户订单号string 是商户自行生成（下面详细介绍）mid商户号string15是 tid终端号string8是 instMid业务类型string 是YUEDANDEFAULTtotalAmount支付总金额 1..100000000是 notifyUrl支付结果通知地址string（url） 否 returnUrl网页跳转地址string（url） 否 四、参数准备 4.1appId、商户号、终端号、来源编码获取 注册成为开发者后可以获取到这几个参数，注册开发者请回顾上一节
4.2订单号规则与生成 以银商分配的4位来源编号作为账单号的前4位，且在商户系统中此账单号保证唯一。总长 度需大于6位，小于28位。银商的推荐规则为（无特殊情况下，建议遵守此规则）：{来源编号(4位)}{时间(yyyyMMddmmHHssSSS)(17位)}{7位随机数}
public static string getMerOrderId(string number)//number即来源编号，一般为1017 { string time = DateTime.Now.ToString(&#34;yyyyMMddHHmmssSSS&#34;); System.Random Random = new System.Random(); int Result = Random.Next(1000000, 9999999);//7位随机数 return number &#43;= time &#43;= Result; } 4." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/a097435e190bd81ee353016023f5b9cd/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-09-01T09:43:50+08:00" />
<meta property="article:modified_time" content="2020-09-01T09:43:50+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">银联支付服务之公众号支付业务（二）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h3 style="text-indent:33px;">上一节已经介绍了银联的公众号支付业务，以及如何注册成为开发者，这一节将创建一个控制台应用程序调启微信支付并成功付款。</h3> 
<h3 id="%E4%B8%80%E3%80%81%E8%AF%B7%E6%B1%82%E5%8D%8F%E8%AE%AE">一、请求协议</h3> 
<p>HTTP(S)</p> 
<p>HTTP方法：GET</p> 
<h3 id="%E4%BA%8C%E3%80%81%E6%8E%A5%E5%8F%A3%E5%9C%B0%E5%9D%80">二、接口地址</h3> 
<p>测试环境：http://58.247.0.18:29015/v1/netpay/webpay/pay</p> 
<p>生产环境：https://api-mop.chinaums.com/v1/netpay/webpay/pay</p> 
<h3 id="%E4%B8%89%E3%80%81%E5%8F%82%E6%95%B0">三、参数</h3> 
<h4 id="3.1URL%E5%8F%82%E6%95%B0">3.1URL参数</h4> 
<table align="center" border="1" cellpadding="1" cellspacing="1"><tbody><tr><td>参数名称</td><td>参数说明</td><td>参数类型</td><td>长度</td><td>是否必须</td><td>备注</td></tr><tr><td>authorization</td><td>认证方式</td><td>string</td><td> </td><td>是</td><td>值为OPEN-FORM-PARAM</td></tr><tr><td>appId</td><td>AppId</td><td>string</td><td>&lt;=32</td><td>是</td><td> </td></tr><tr><td>timestamp</td><td>时间戳</td><td>string</td><td>14</td><td>是</td><td>yyyyMMddHHmmss</td></tr><tr><td>nonce</td><td>随机数</td><td>string</td><td>&lt;=128</td><td>是</td><td> </td></tr><tr><td>content</td><td>业务内容</td><td>string</td><td> </td><td>是</td><td> </td></tr><tr><td>signature</td><td>签名</td><td>string</td><td> </td><td>是</td><td> <p>Base64_Encode(HmacSHA256</p> <p>(appId + timestamp + nonce +</p> <p>SHA256_HEX(content), AppKey))</p> </td></tr></tbody></table> 
<h4 id="3.2%E4%B8%9A%E5%8A%A1%E5%86%85%E5%AE%B9%E4%B8%BB%E4%BD%93%EF%BC%88%E5%8F%AA%E5%88%97%E5%87%BA%E5%BF%85%E5%A1%AB%E4%B8%8E%E9%83%A8%E5%88%86%E4%B8%BB%E8%A6%81%E5%8F%82%E6%95%B0%EF%BC%8C%E8%AF%A6%E7%BB%86%E5%8F%82%E6%95%B0%E8%AF%B7%E5%8F%82%E8%80%83%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%EF%BC%89">3.2业务内容主体（只列出必填与部分主要参数，详细参数请参考官方文档）</h4> 
<p>格式：JSON</p> 
<table border="1" cellpadding="1" cellspacing="1"><tbody><tr><td>参数名称</td><td>参数说明</td><td>参数类型</td><td>长度</td><td>是否必须</td><td>备注</td></tr><tr><td>msgId</td><td>消息ID</td><td>string</td><td>&lt;=64</td><td>否</td><td>原样返回</td></tr><tr><td>requestTimestamp</td><td>报文请求时 间</td><td>string</td><td> </td><td>是</td><td>格式yyyy-MM-dd HH:mm:ss</td></tr><tr><td>merOrderId</td><td>商户订单号</td><td>string</td><td> </td><td>是</td><td>商户自行生成（下面详细介绍）</td></tr><tr><td>mid</td><td>商户号</td><td>string</td><td>15</td><td>是</td><td> </td></tr><tr><td>tid</td><td>终端号</td><td>string</td><td>8</td><td>是</td><td> </td></tr><tr><td>instMid</td><td>业务类型</td><td>string</td><td> </td><td>是</td><td>YUEDANDEFAULT</td></tr><tr><td>totalAmount</td><td>支付总金额</td><td> </td><td>1..100000000</td><td>是</td><td> </td></tr><tr><td>notifyUrl</td><td>支付结果通知地址</td><td>string（url）</td><td> </td><td>否</td><td> </td></tr><tr><td>returnUrl</td><td>网页跳转地址</td><td>string（url）</td><td> </td><td>否</td><td> </td></tr></tbody></table> 
<h3 id="%E5%9B%9B%E3%80%81%E5%8F%82%E6%95%B0%E5%87%86%E5%A4%87">四、参数准备</h3> 
<h4 id="4.1appId%E3%80%81%E5%95%86%E6%88%B7%E5%8F%B7%E3%80%81%E7%BB%88%E7%AB%AF%E5%8F%B7%E3%80%81%E6%9D%A5%E6%BA%90%E7%BC%96%E7%A0%81%E8%8E%B7%E5%8F%96">4.1appId、商户号、终端号、来源编码获取</h4> 
<p>注册成为开发者后可以获取到这几个参数，注册开发者请<a href="https://blog.csdn.net/xiaolu1014/article/details/106796819">回顾上一节</a></p> 
<p><img alt="" height="227" src="https://images2.imgbox.com/86/a7/MG4rgaXZ_o.png" width="711"></p> 
<h4 id="4.2%E8%AE%A2%E5%8D%95%E5%8F%B7%E8%A7%84%E5%88%99%E4%B8%8E%E7%94%9F%E6%88%90">4.2订单号规则与生成</h4> 
<p style="text-indent:33px;">以银商分配的4位来源编号作为账单号的前4位，且在商户系统中此账单号保证唯一。总长 度需大于6位，小于28位。银商的推荐规则为（无特殊情况下，建议遵守此规则）：{来源编号(4位)}{时间(yyyyMMddmmHHssSSS)(17位)}{7位随机数}</p> 
<pre><code class="language-cs">public static string getMerOrderId(string number)//number即来源编号，一般为1017
        {
            string time = DateTime.Now.ToString("yyyyMMddHHmmssSSS");
            System.Random Random = new System.Random();
            int Result = Random.Next(1000000, 9999999);//7位随机数

            return number += time += Result;
        }</code></pre> 
<h4 id="4.3%C2%A0%E7%94%9F%E6%88%90%E7%AD%BE%E5%90%8D">4.3 生成签名</h4> 
<p style="text-indent:33px;">Base64_Encode(HmacSHA256(appId + timestamp + nonce + SHA256_HEX(content), AppKey))</p> 
<pre><code class="language-cs">private static string createSignature(string appid, string timestamp, string nonce, string body, string appkey)
        {
            string signature = "";
            SHA256 sha256 = new SHA256CryptoServiceProvider();
            byte[] retVal = sha256.ComputeHash(System.Text.Encoding.UTF8.GetBytes(body));
            StringBuilder sb = new StringBuilder();
            for (int i = 0; i &lt; retVal.Length; i++)
            {
                sb.Append(retVal[i].ToString("x2"));
            }
            Console.WriteLine("SHA256:" + sb.ToString());
            var encoding = new System.Text.UTF8Encoding();
            byte[] keyByte = encoding.GetBytes(appkey);
            byte[] messageBytes = encoding.GetBytes(appid + timestamp + nonce + sb.ToString());
            using (var hmacsha256 = new HMACSHA256(keyByte))
            {
                byte[] hashmessage = hmacsha256.ComputeHash(messageBytes);
                signature = Convert.ToBase64String(hashmessage);
            }
            return signature;
        }</code></pre> 
<h4 id="4.4%E4%B8%9A%E5%8A%A1%E5%86%85%E5%AE%B9%E4%B8%BB%E4%BD%93">4.4业务内容主体</h4> 
<p>业务主体格式为JSON字符串，示例代码为C#，我们通过引入Newtonsoft库来构建一个JSON对象，后面再转成字符串即可。</p> 
<pre><code class="language-cs">JObject jobject = new JObject();
            jobject.Add("requestTimestamp", timestamp);    // 报文请求时间
            jobject.Add("merOrderId", merOrderId); // 商户订单号
            jobject.Add("srcReserve", "qqyl"); // 请求系统预留字段
            jobject.Add("mid", "898340149000005"); // 商户号
            jobject.Add("tid", "88880001");    // 终端号
            jobject.Add("instMid", "YUEDANDEFAULT"); // 业务类型
            jobject.Add("attachedData", "fjsj"); //商户附加数据
            jobject.Add("orderDesc", "zdms");  // 账单描述
            jobject.Add("totalAmount", 1);      // 支付总金额
            jobject.Add("notifyUrl", "https://www.sina.com.cn");  // 支付结果通知地址
            jobject.Add("returnUrl", "http://www.baidu.com");  // 网页跳转地址
            string body = jobject.ToString();</code></pre> 
<h3>一切准备就绪，下面是完整代码</h3> 
<pre><code class="language-cs">        /// &lt;summary&gt;
        /// 前台支付
        /// &lt;/summary&gt;
        /// &lt;param name="args"&gt;&lt;/param&gt;
        static void Main(string[] args)
        {
            string payUrl = "http://58.247.0.18:29015/v1/netpay/webpay/pay";//测试地址
            string appid = "10037e6f66f2d0f901672aa27d69XXXX";
            string appkey = "47ace12ae3b348fe93ab46cee97cXXXX";
            string timestamp = DateTime.Now.ToString("yyyyMMddHHmmss");
            string merOrderId = getMerOrderId("1017");
            string nonce = Guid.NewGuid().ToString().Replace("-","");
            JObject jobject = new JObject();
            jobject.Add("requestTimestamp", timestamp);    // 报文请求时间
            jobject.Add("merOrderId", merOrderId); // 商户订单号
            jobject.Add("srcReserve", "qqyl"); // 请求系统预留字段
            jobject.Add("mid", "898340149000005"); // 商户号
            jobject.Add("tid", "88880001");    // 终端号
            jobject.Add("instMid", "YUEDANDEFAULT"); // 业务类型
            jobject.Add("attachedData", "fjsj"); //商户附加数据
            jobject.Add("orderDesc", "zdms");  // 账单描述
            jobject.Add("totalAmount", 1);      // 支付总金额,单位：分，也就是支付0.01元
            jobject.Add("notifyUrl", "https://www.sina.com.cn");  // 支付结果通知地址
            jobject.Add("returnUrl", "http://www.baidu.com");  // 网页跳转地址
            string body = jobject.ToString();
            string signature = createSignature(appid, timestamp, nonce, body, appkey);
            string connection = "Data Source=.;Initial Catalog=JwsoftBsFrame_20200606;Integrated Security=True;";
            using (SqlConnection conn = new SqlConnection(connection))
            {
                conn.Open();
                string sql = $"INSERT INTO A0_TestPay(requestTimestamp,appid,merOrderId ) VALUES ({timestamp},'{appid}',{merOrderId})";
                using (SqlCommand cmd = new SqlCommand(sql, conn))
                {
                    cmd.ExecuteNonQuery();
                }
            }
            //url即我们需要的最终结果，复制url到微信打开就能调起微信支付
            string url = payUrl + "?authorization=OPEN-FORM-PARAM&amp;appId=" + appid
                + "&amp;timestamp=" + timestamp
                + "&amp;nonce=" + nonce
                + "&amp;content=" + HttpUtility.UrlEncode(body, Encoding.UTF8) + "&amp;signature=" + HttpUtility.UrlEncode(signature, Encoding.UTF8);
            Console.WriteLine(url);
            Console.ReadKey();
        }
        /// &lt;summary&gt;
        /// 生成订单号
        /// &lt;/summary&gt;
        /// &lt;param name="number"&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static string getMerOrderId(string number)
        {
            string time = DateTime.Now.ToString("yyyyMMddHHmmss");
            System.Random Random = new System.Random();
            int Result = Random.Next(1000000, 9999999);

            return number += time += Result;
        }
        /// &lt;summary&gt;
        /// 生成签名
        /// &lt;/summary&gt;
        /// &lt;param name="appid"&gt;&lt;/param&gt;
        /// &lt;param name="timestamp"&gt;&lt;/param&gt;
        /// &lt;param name="nonce"&gt;&lt;/param&gt;
        /// &lt;param name="body"&gt;&lt;/param&gt;
        /// &lt;param name="appkey"&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        private static string createSignature(string appid, string timestamp, string nonce, string body, string appkey)
        {
            string signature = "";
            //先计算出 body 的 sha256加密
            SHA256 sha256 = new SHA256CryptoServiceProvider();
            byte[] retVal = sha256.ComputeHash(System.Text.Encoding.UTF8.GetBytes(body));
            StringBuilder sb = new StringBuilder();
            for (int i = 0; i &lt; retVal.Length; i++)
            {
                sb.Append(retVal[i].ToString("x2"));
            }
            Console.WriteLine("SHA256:" + sb.ToString());

            //在结合起来
            var encoding = new System.Text.UTF8Encoding();
            byte[] keyByte = encoding.GetBytes(appkey);
            byte[] messageBytes = encoding.GetBytes(appid + timestamp + nonce + sb.ToString());
            using (var hmacsha256 = new HMACSHA256(keyByte))
            {
                byte[] hashmessage = hmacsha256.ComputeHash(messageBytes);
                signature = Convert.ToBase64String(hashmessage);
            }
            return signature;
        }</code></pre> 
<p> </p> 
<p><strong>string url = payUrl + "?authorization=OPEN-FORM-PARAM&amp;appId=" + appid<br>                 + "&amp;timestamp=" + timestamp<br>                 + "&amp;nonce=" + nonce<br>                 + "&amp;content=" + HttpUtility.UrlEncode(body, Encoding.UTF8) + "&amp;signature=" + HttpUtility.UrlEncode(signature, Encoding.UTF8);</strong></p> 
<p><strong>示例：</strong></p> 
<p><a href="http://58.247.0.18:29015/v1/netpay/webpay/pay?authorization=OPEN-FORM-PARAM&amp;appId=10037e6f66f2d0f901672aa27d690006&amp;timestamp=20200831215653&amp;nonce=c31e0e0e47bf49f3968dd73e510be52e&amp;content=%7B%0D%0A++%22requestTimestamp%22%3A+%2220200831215653%22%2C%0D%0A++%22merOrderId%22%3A+%221017202008312156533441158%22%2C%0D%0A++%22srcReserve%22%3A+%22qqyl%22%2C%0D%0A++%22mid%22%3A+%22898340149000005%22%2C%0D%0A++%22tid%22%3A+%2288880001%22%2C%0D%0A++%22instMid%22%3A+%22YUEDANDEFAULT%22%2C%0D%0A++%22attachedData%22%3A+%22fjsj%22%2C%0D%0A++%22orderDesc%22%3A+%22zdms%22%2C%0D%0A++%22totalAmount%22%3A+1%2C%0D%0A++%22notifyUrl%22%3A+%22https%3A%2F%2Fwww.sina.com.cn%22%2C%0D%0A++%22returnUrl%22%3A+%22http%3A%2F%2Fwww.baidu.com%22%0D%0A%7D&amp;signature=pghTBBzie2qMewmy4FvZuvsLJV%2BqdC%2BhZhTm6T53r%2BE%3D" rel="nofollow">http://58.247.0.18:29015/v1/netpay/webpay/pay?authorization=OPEN-FORM-PARAM&amp;appId=10037e6f66f2d0f901672aa27d690006&amp;timestamp=20200831215653&amp;nonce=c31e0e0e47bf49f3968dd73e510be52e&amp;content=%7b%0d%0a++%22requestTimestamp%22%3a+%2220200831215653%22%2c%0d%0a++%22merOrderId%22%3a+%221017202008312156533441158%22%2c%0d%0a++%22srcReserve%22%3a+%22qqyl%22%2c%0d%0a++%22mid%22%3a+%22898340149000005%22%2c%0d%0a++%22tid%22%3a+%2288880001%22%2c%0d%0a++%22instMid%22%3a+%22YUEDANDEFAULT%22%2c%0d%0a++%22attachedData%22%3a+%22fjsj%22%2c%0d%0a++%22orderDesc%22%3a+%22zdms%22%2c%0d%0a++%22totalAmount%22%3a+1%2c%0d%0a++%22notifyUrl%22%3a+%22https%3a%2f%2fwww.sina.com.cn%22%2c%0d%0a++%22returnUrl%22%3a+%22http%3a%2f%2fwww.baidu.com%22%0d%0a%7d&amp;signature=pghTBBzie2qMewmy4FvZuvsLJV%2bqdC%2bhZhTm6T53r%2bE%3d</a></p> 
<p><strong>url即我们需要的最终结果，复制url到微信打开就能调起微信支付。实际业务中，我们只需要构建好好这个url微信中跳转就好。</strong></p> 
<h3>五、调起微信支付</h3> 
<p><img alt="" height="476" src="https://images2.imgbox.com/1f/42/1kaWip3b_o.jpg" width="220"><img alt="" height="475" src="https://images2.imgbox.com/2a/3e/mz0byc92_o.jpg" width="219"> <img alt="" height="475" src="https://images2.imgbox.com/7b/3a/TxeBuNun_o.jpg" width="219"><img alt="" height="474" src="https://images2.imgbox.com/60/5d/4bf5d7ML_o.jpg" width="219"></p> 
<ol><li>将程序构建好的url复制到微信中打开，点击访问</li><li>成功调起微信支付后，就是熟悉的付款操作了</li><li>jobject.Add("totalAmount", 1);      // 支付总金额,单位：分，也就是支付0.01元</li><li>jobject.Add("returnUrl", "http://www.baidu.com");  // 支付成功后网页跳转地址</li><li>如果检查程序没问题，但是点击链接，没有响应的话，可能是测试接口不稳定造成了，请在工作时间内进行测试调用。不是上班时间，估计银联那边把所有访问都拒绝了。</li></ol> 
<p style="text-indent:33px;"><strong>下一节，我们将继续讲解支付结果查询和退款查询的接口调用，我们测试支付的钱可以通过退款接口进行退回的。 </strong></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/15bc3de02451dba588b894df808cd302/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Linux GUI自动化测试工具 -- LDTP</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/11d97f4cc377a1b1052e99611883bd11/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">STM32CubeMX官网下载方法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>