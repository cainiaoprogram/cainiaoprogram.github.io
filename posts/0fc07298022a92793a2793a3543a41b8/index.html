<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>android -- 蓝牙 bluetooth （一） 入门 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="android -- 蓝牙 bluetooth （一） 入门" />
<meta property="og:description" content="前段时间在 网上看了一些关于android蓝牙的文章，发现大部分是基于老版本（4.1以前含4.1）的源码，虽然无碍了解蓝牙的基本原理和工作流程，但对着4.2.2的代码看起来总是有些遗憾。所以针对4.2.2版本代码整理下相关知识，当然蓝牙工作的主干流程是没有变的，上电、加载驱动这些动作少不了的，只是这些功能的实现代码位置变了不少。希望本文可以让大家对android4.2的蓝牙部分代码有一个初步的了解。
正文开始前，先明确代码版本：android jellyBean 4.2.2，后续的蓝牙相关文章同样如此。
另推荐个源码在线阅读网址 http://androidxref.com/，已经知道的童鞋无视这行吧。
入手一个新的模块或应用，当然首先要知道它都有什么了，与它相关的代码在那里，所以先一起看下蓝牙代码分布吧。
1. 代码分布： packages/apps/Bluetooth/ 看这路径肯定是蓝牙应用方面的代码了，主要是关于蓝牙应用协议的表现代码，包括opp、hfp、hdp、a2dp、pan等等，这些名词后面再解释。
frameworks/base/core/java/android/server/ 4.2以后这个目录虽然还有了，但里面代码已经转移到应用层了，就是前面那个目录，所以4.2.2上的蓝牙这里可以忽略。
framework/base/core/java/android/bluetooth 这个目录里的代码更像一个桥梁，里面有供java层使用一些类，也有对应的aidl文件联系C、C&#43;&#43;部分的代码，还是挺重要的。
kernel\drivers\bluetoothBluetooth 具体协议实现。包括hci,hid，rfcomm,sco,SDP等协议
kernel\net\bluetooth Linux kernel
对各种接口的Bluetoothdevice的驱动。例如：USB接口，串口等，上面kernel这两个目录有可能看不到的，但一定会有的。
external\bluetooth\bluedroid BlueZ (应用空间协议)，官方蓝牙协议栈。
system\bluetoothBluetooth 适配层代码，和framework那个作用类似，是串联framework与blueZ的工具。
大致代码分布就是这些，初步查看后让我们再来看下蓝牙的整体结构。
2.整体结构： 这部分直接上图了，看着直观些。图中把JNI部分虽然在目前4.2的代码中在packages层，这里还是画在Framework层了，说明下希望
不要引起理解的误会。从图上可以感觉到整体流程和以前变化不大，所以流程方面的文章看4.1或更早的应该问题也不大。
PS：上图关于蓝牙协议栈的说明有误，4.2里已经不再是bluez了，在些更正一下，当然协议栈这一部分还是要有的，新的协议栈看下面英文：
Android 4.2 introduces a new Bluetooth stack optimized for use with Android devices. The new Bluetooth stack developed in collaboration between Google and Broadcom replaces the stack based on BlueZ and provides improved compatibility and reliability.
google和broadcom合作开发了一个新蓝牙协议栈，老版本的兼容性问题在所难免了。在此感谢网友andger032的提醒。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/0fc07298022a92793a2793a3543a41b8/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2013-05-19T21:44:40+08:00" />
<meta property="article:modified_time" content="2013-05-19T21:44:40+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">android -- 蓝牙 bluetooth （一） 入门</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>        前段时间在 网上看了一些关于android蓝牙的文章，发现大部分是基于老版本（4.1以前含4.1）的源码，虽然无碍了解蓝牙的基本原理和工作流程，但对着4.2.2的代码看起来总是有些遗憾。所以针对4.2.2版本代码整理下相关知识，当然蓝牙工作的主干流程是没有变的，上电、加载驱动这些动作少不了的，只是这些功能的实现代码位置变了不少。希望本文可以让大家对android4.2的蓝牙部分代码有一个初步的了解。</p> 
<p><br> </p> 
<p><strong>        正文开始前，先明确代码版本：android <span style="font-weight:bold"> jellyBean </span>4.2.2，后续的蓝牙相关文章同样如此。</strong></p> 
<p><strong>        另推荐个源码在线阅读网址 <a href="http://androidxref.com/" rel="nofollow">http://androidxref.com/</a>，已经知道的童鞋无视这行吧。</strong></p> 
<p><br> </p> 
<p>        入手一个新的模块或应用，当然首先要知道它都有什么了，与它相关的代码在那里，所以先一起看下蓝牙代码分布吧。</p> 
<p><br> </p> 
<h3>1. 代码分布：</h3> 
<p></p> 
<p>    packages/apps/Bluetooth/     </p> 
<p>         看这路径肯定是蓝牙应用方面的代码了，主要是关于蓝牙应用协议的表现代码，包括opp、hfp、hdp、a2dp、pan等等，这些名词后面再解释。</p> 
<p>    frameworks/base/core/java/android/server/  </p> 
<p>          4.2以后这个目录虽然还有了，但里面代码已经转移到应用层了，就是前面那个目录，所以4.2.2上的蓝牙这里可以忽略。</p> 
<p>    framework/base/core/java/android/bluetooth  </p> 
<p>           这个目录里的代码更像一个桥梁，里面有供java层使用一些类，也有对应的aidl文件联系C、C++部分的代码，还是挺重要的。</p> 
<p>    kernel\drivers\bluetoothBluetooth    </p> 
<p>           具体协议实现。包括hci,hid，rfcomm,sco,SDP等协议</p> 
<p>    kernel\net\bluetooth Linux kernel</p> 
<p>           对各种接口的Bluetoothdevice的驱动。例如：USB接口，串口等，上面kernel这两个目录有可能看不到的，但一定会有的。</p> 
<p>    external\bluetooth\bluedroid      BlueZ (应用空间协议)，<span style="font-family:arial; font-size:12px; line-height:18px">官方蓝牙协议栈。</span></p> 
<p>    system\bluetoothBluetooth        适配层代码，和framework那个作用类似，是串联framework与blueZ的工具。</p> 
<p>        大致代码分布就是这些，初步查看后让我们再来看下蓝牙的整体结构。</p> 
<p><br> </p> 
<h3>2.整体结构：</h3> 
<p>        这部分直接上图了，看着直观些。图中把JNI部分虽然在目前4.2的代码中在packages层，这里还是画在Framework层了，说明下希望</p> 
<p>不要引起理解的误会。从图上可以感觉到整体流程和以前变化不大，所以流程方面的文章看4.1或更早的应该问题也不大。</p> 
<p><img src="https://images2.imgbox.com/85/da/eqSdYt73_o.png" alt=""><br> </p> 
<p><br> </p> 
<p><strong> PS：</strong>上图关于蓝牙协议栈的说明有误，4.2里已经不再是bluez了，在些更正一下，当然协议栈这一部分还是要有的，新的协议栈看下面英文：</p> 
<p><br> </p> 
<p>Android 4.2 introduces a new Bluetooth stack optimized for use with Android devices. The new Bluetooth stack developed in </p> 
<p>collaboration between Google and Broadcom replaces the stack based on BlueZ and provides improved compatibility and reliability.<br> </p> 
<p>google和broadcom合作开发了一个新蓝牙协议栈，老版本的兼容性问题在所难免了。在此感谢网友<a class="username" href="http://blog.csdn.net/andger032" target="_blank" style="color:rgb(51,102,153); text-decoration:none; line-height:26px; background-color:rgb(248,252,251)" rel="noopener noreferrer">andger032</a>的提醒。</p> 
<p><br> </p> 
<h3>3.常用类和名词解释：  </h3> 
<p>   \packages\apps\Settings\src\com\android\settings\bluetooth 目录下<br> </p> 
<p></p> 
<p>     BluetoothEnabler.java   界面上蓝牙开启、关闭的开关就是它了， </p> 
<p>     BluetoothSettings.java  主界面，用于管理配对和连接设备<br> </p> 
<p>     LocalBluetoothManager.java  提供了蓝牙API上的简单调用接口，这里只是开始。<br> </p> 
<p>    CachedBluetoothDevice.java   描述蓝牙设备的类，对BluetoothDevice的再封装<br> </p> 
<p>    BluetoothPairingDialog.java<span style="white-space:pre"> </span> 那个配对提示的对话框</p> 
<p><br> </p> 
<p>  /packages/apps/Phone/src/com/android/phone/</p> 
<p>    BluetoothPhoneService.java  在phone的目录肯定和电话相关了，蓝牙接听挂断电话会用到这个<br> </p> 
<p><br> </p> 
<p> /packages/apps/Bluetooth/src/com/android/bluetooth/btservice/</p> 
<p>        AdapterService.java    4.2后才有的代码，蓝牙打开、关闭、扫描、配对都会走到这里，其实更准确的说它替代了4.1之前的BluetoothService.java，原来的工作就由这个类来完成了。说到这里不能不说4.2蓝牙的目录变了，在4.1及以前的代码中packages层的代码只有opp协议相关应用的代码，也就是文件传输那部分，而4.2的代码应用层的代码则丰富了许多，按具体的蓝牙应用协议来区别，分为以下文件夹（这里一并对蓝牙一些名词作个简单解释）：</p> 
<p>       a2dp    蓝牙立体声，和蓝牙耳机听歌有关那些，另还有个avrcp--<span style="font-family:arial,宋体,sans-serif; line-height:24px; text-indent:30px"><span style="font-size:10px">音频/视频远程控制配置文件，</span></span>是用来听歌时暂停，上下歌曲选择的。<br>        btservice  这个前面AdapterService.java的描述大家应该能猜到一些，关于蓝牙基本操作的目录，一切由此开始。<br>        hdp      蓝牙关于医疗方面的应用 <span style="font-family:arial; font-size:12px; line-height:18px">Bluetooth Health Device Profile</span><br>        hfp       和电话相关，蓝牙接听、挂断电话  Hands-free Profile<br>        hid      人机交互接口，蓝牙鼠标键盘什么的就是这个了<br>       opp     不多解释，以前就有。<br>       pan      描述了两个或更多个 Bluetooth 设备如何构成一个即时网络，和网络有关的还有串行端口功能(SPP)，拨号网络功能(DUN)</p> 
<p>      pbap    <span style="font-family:arial; font-size:12px; line-height:18px">电话号码簿访问协议</span><span style="font-family:arial; font-size:12px; line-height:18px">(Phonebook Access Profile)</span></p> 
<p><span style="font-family:arial; font-size:12px"><span style="line-height:18px">       android 4.2的蓝牙应用层部分代码更丰富了，虽然有些目录还没具体代码，不过说不准哪个版本更新就有了，就像4.0添加了hdp医疗那部分一样。</span></span></p> 
<p><span style="font-family:arial; font-size:12px"><span style="line-height:18px">另外原本在framework的JNI代码也被移到packages/apps/bluetooth当中。</span></span><span style="line-height:18px; font-family:arial">     </span></p> 
<p><span style="font-family:arial"><span style="line-height:18px"><span style="font-family:monospace; font-size:14px"></span></span></span></p> 
<p>   /frameworks/base/core/java/android/bluetooth/目录下</p> 
<p><br> </p> 
<p>      BluetoothA2dp.java<span style="white-space:pre"> </span><span style="white-space:pre"></span>A2DP的功能实现<br>      BluetoothAdapter.java<span style="white-space:pre"> </span><span style="white-space:pre"></span>蓝牙action的定义，虚拟设备属性以及操作方法<br>      BluetoothAudioGateway.java<span style="white-space:pre"> </span><span style="white-space:pre"></span>蓝牙语音网关<br>      BluetoothClass.java<span style="white-space:pre"> </span><span style="white-space:pre"></span>蓝牙设备类型的定义<br>      BluetoothDevice.java<span style="white-space:pre"> </span><span style="white-space:pre"></span>蓝牙设备属性<br>      BluetoothDevicePicker.java<span style="white-space:pre"> </span>定义远程蓝牙设备的特性，比如需要认证，设备类型<br>      BluetoothHeadset.java<span style="white-space:pre"> </span><span style="white-space:pre"></span>定义蓝牙headset功能的属性以及接口<br>      BluetoothInputStream.java<span style="white-space:pre"> </span><span style="white-space:pre"></span>蓝牙流接口的实现（输入流）<br>     BluetoothOutputStream.java<span style="white-space:pre"> </span><span style="white-space:pre"></span>蓝牙流接口的实现（输出流）<br>     BluetoothServerSocket.java<span style="white-space:pre"> </span><span style="white-space:pre"></span>蓝牙socket服务端具备的方法<br>     BluetoothSocket.java<span style="white-space:pre"> </span><span style="white-space:pre"></span>蓝牙socket的封装<br>     BluetoothUuid.java<span style="white-space:pre"> </span><span style="white-space:pre"></span>蓝牙uuid的定义以及uuid的解析</p> 
<p><span style="font-family:arial; font-size:12px"><span style="line-height:18px">    以上java文件在使用具体功能会用到，现在只是简单描述下，至于具体使用在后续文章用到时再给出。同时代码说明部分也就写这些了</span></span></p> 
<p><span style="font-family:arial; font-size:12px"><span style="line-height:18px">对于C、C++部分的代码一方面没看那么多，另一方面根据android JNI的命名习惯，大家找起来也很容易。</span></span></p> 
<p><span style="font-family:arial; font-size:12px"><span style="line-height:18px"><br> </span></span></p> 
<p></p> 
<h3>4.后续分析：</h3> 
<p>       前面从整体上描述蓝牙的基本知识，落实在具体的代码分析上，我们按几个主线功能来走，蓝牙的开关、搜索配对、蓝牙耳机与电话和文件传输，</p> 
<p>这几个也算是蓝牙的常用必备功能了，所以在后续文章中将按着这个顺序来跟一下它们代码调用流程。希望可以让你快速的了解蓝牙，当然如果有失误</p> 
<p>写错的地方，欢迎反馈，谢谢。</p> 
<p><br> </p> 
<p><br> </p> 
<p>------------------------修改记录------------------</p> 
<p>2013.5.28 23:16  修改蓝牙协议栈说明</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/37827cab0e8e16f7feef7582a7af8c2f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Class.forName() 理解</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7e1dc36d04bd8e290bed9e1cecc390b5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">MSSQL2005 登录名、角色、数据库用户、角色、架构的关系</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>