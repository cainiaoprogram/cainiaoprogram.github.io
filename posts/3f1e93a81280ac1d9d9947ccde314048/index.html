<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>QT 操作Windows系统服务 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="QT 操作Windows系统服务" />
<meta property="og:description" content="Windows服务是在Windows操作系统上运行的后台应用程序，它们在系统启动时自动启动，并在后台持续运行，不需要用户交互。Windows服务的作用包括但不限于以下几个方面：1. 提供系统功能：许多Windows服务提供了系统级的功能和服务，如网络连接、文件共享、打印服务、安全认证、远程管理等。这些服务为用户和其他应用程序提供了基础设施和功能支持。2. 自动化任务：Windows服务可以用于执行自动化任务，如定期备份、数据同步、日志记录、定时任务等。它们可以在后台运行，无需用户干预，提供可靠的自动化功能。3. 后台通信和消息传递：Windows服务可以用于实现后台通信和消息传递，如消息队列、进程间通信等。它们可以在不同的应用程序之间传递数据和消息，实现应用程序之间的协作和集成。4. 系统监控和管理：Windows服务可以用于监控和管理系统状态和资源，如性能监控、事件日志、服务管理等。它们可以收集系统信息、监测系统性能，并提供管理接口和功能，帮助管理员维护和管理系统。
Windows服务是在后台运行的应用程序，提供了系统级的功能和服务，执行自动化任务，实现后台通信和消息传递，以及监控和管理系统。它们为Windows操作系统提供了稳定、可靠和高效的功能支持。
需要注意程序需要使用管理员权限启动才可以操作服务
QT 操作Windows系统服务目录
1 创建服务
2 删除服务
3 打开服务
4 关闭服务
5 启动服务
6 停止服务
7 自动启动
8 手动启动
9 查询服务
10 .h源文件
本文作者原创，转载请附上文章出处与本文链接。
1 创建服务 ///@ 创建服务 void MainWindow::newService() { SC_HANDLE schandle = ::OpenSCManager(NULL, NULL, SC_MANAGER_ALL_ACCESS); //打开服务管理 SC_HANDLE h = ::CreateService(schandle, L&#34;ServiceAPI&#34;, //服务名 L&#34;ServiceAPI-Test&#34;, //显示用的服务名 SERVICE_ALL_ACCESS, //所有访问权限 SERVICE_WIN32_OWN_PROCESS, //私有类型 SERVICE_AUTO_START, //自启动类型 SERVICE_ERROR_NORMAL, //忽略错误处理 L&#34;D:/ServiceAPI.exe&#34;, //应用程序路径 nullptr, nullptr, nullptr, nullptr, nullptr); ::CloseServiceHandle(h); //关闭 ::CloseServiceHandle(schandle);//关闭 ::getchar(); //暂停 } 2 删除服务 ///@ 删除服务 void MainWindow::deleteService() { SC_HANDLE schandle = ::OpenSCManager(NULL, NULL, SC_MANAGER_ALL_ACCESS); //打开服务管理 SC_HANDLE h = ::OpenService(schandle, L&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/3f1e93a81280ac1d9d9947ccde314048/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-10-21T21:00:00+08:00" />
<meta property="article:modified_time" content="2023-10-21T21:00:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">QT 操作Windows系统服务</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>        Windows服务是在Windows操作系统上运行的后台应用程序，它们在系统启动时自动启动，并在后台持续运行，不需要用户交互。Windows服务的作用包括但不限于以下几个方面：1. 提供系统功能：许多Windows服务提供了系统级的功能和服务，如网络连接、文件共享、打印服务、安全认证、远程管理等。这些服务为用户和其他应用程序提供了基础设施和功能支持。2. 自动化任务：Windows服务可以用于执行自动化任务，如定期备份、数据同步、日志记录、定时任务等。它们可以在后台运行，无需用户干预，提供可靠的自动化功能。3. 后台通信和消息传递：Windows服务可以用于实现后台通信和消息传递，如消息队列、进程间通信等。它们可以在不同的应用程序之间传递数据和消息，实现应用程序之间的协作和集成。4. 系统监控和管理：Windows服务可以用于监控和管理系统状态和资源，如性能监控、事件日志、服务管理等。它们可以收集系统信息、监测系统性能，并提供管理接口和功能，帮助管理员维护和管理系统。<br>         Windows服务是在后台运行的应用程序，提供了系统级的功能和服务，执行自动化任务，实现后台通信和消息传递，以及监控和管理系统。它们为Windows操作系统提供了稳定、可靠和高效的功能支持。</p> 
<p>        需要注意程序需要使用管理员权限启动才可以操作服务</p> 
<p><img alt="" height="838" src="https://images2.imgbox.com/57/30/1Rig84pm_o.png" width="1200"></p> 
<p id="main-toc"><strong>QT 操作Windows系统服务目录</strong></p> 
<p id="1%20%E5%88%9B%E5%BB%BA%E6%9C%8D%E5%8A%A1-toc" style="margin-left:0px;"><a href="#1%20%E5%88%9B%E5%BB%BA%E6%9C%8D%E5%8A%A1" rel="nofollow">1 创建服务</a></p> 
<p id="2%20%E5%88%A0%E9%99%A4%E6%9C%8D%E5%8A%A1-toc" style="margin-left:0px;"><a href="#2%20%E5%88%A0%E9%99%A4%E6%9C%8D%E5%8A%A1" rel="nofollow">2 删除服务</a></p> 
<p id="3%20%E6%89%93%E5%BC%80%E6%9C%8D%E5%8A%A1-toc" style="margin-left:0px;"><a href="#3%20%E6%89%93%E5%BC%80%E6%9C%8D%E5%8A%A1" rel="nofollow">3 打开服务</a></p> 
<p id="4%20%E5%85%B3%E9%97%AD%E6%9C%8D%E5%8A%A1-toc" style="margin-left:0px;"><a href="#4%20%E5%85%B3%E9%97%AD%E6%9C%8D%E5%8A%A1" rel="nofollow">4 关闭服务</a></p> 
<p id="5%20%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1-toc" style="margin-left:0px;"><a href="#5%20%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1" rel="nofollow">5 启动服务</a></p> 
<p id="6%20%E5%81%9C%E6%AD%A2%E6%9C%8D%E5%8A%A1-toc" style="margin-left:0px;"><a href="#6%20%E5%81%9C%E6%AD%A2%E6%9C%8D%E5%8A%A1" rel="nofollow">6 停止服务</a></p> 
<p id="7%20%E8%87%AA%E5%8A%A8%E5%90%AF%E5%8A%A8-toc" style="margin-left:0px;"><a href="#7%20%E8%87%AA%E5%8A%A8%E5%90%AF%E5%8A%A8" rel="nofollow">7 自动启动</a></p> 
<p id="8%20%E6%89%8B%E5%8A%A8%E5%90%AF%E5%8A%A8-toc" style="margin-left:0px;"><a href="#8%20%E6%89%8B%E5%8A%A8%E5%90%AF%E5%8A%A8" rel="nofollow">8 手动启动</a></p> 
<p id="9%20%E6%9F%A5%E8%AF%A2%E6%9C%8D%E5%8A%A1-toc" style="margin-left:0px;"><a href="#9%20%E6%9F%A5%E8%AF%A2%E6%9C%8D%E5%8A%A1" rel="nofollow">9 查询服务</a></p> 
<p id="10%20.h%E6%BA%90%E6%96%87%E4%BB%B6-toc" style="margin-left:0px;"><a href="#10%20.h%E6%BA%90%E6%96%87%E4%BB%B6" rel="nofollow">10 .h源文件</a></p> 
<hr id="hr-toc"> 
<blockquote> 
 <p><span style="color:#fe2c24;"> <strong><u>本文作者原创，转载请附上文章出处与本文链接。</u></strong></span></p> 
</blockquote> 
<h2 id="1%20%E5%88%9B%E5%BB%BA%E6%9C%8D%E5%8A%A1">1 创建服务</h2> 
<pre><code class="language-cpp">///@ 创建服务
void MainWindow::newService()
{
    SC_HANDLE schandle = ::OpenSCManager(NULL, NULL, SC_MANAGER_ALL_ACCESS); //打开服务管理
    SC_HANDLE h = ::CreateService(schandle,
        L"ServiceAPI", //服务名
        L"ServiceAPI-Test", //显示用的服务名
        SERVICE_ALL_ACCESS, //所有访问权限
        SERVICE_WIN32_OWN_PROCESS,  //私有类型
        SERVICE_AUTO_START, //自启动类型
        SERVICE_ERROR_NORMAL, //忽略错误处理
        L"D:/ServiceAPI.exe", //应用程序路径
        nullptr, nullptr, nullptr, nullptr, nullptr);

    ::CloseServiceHandle(h); //关闭
    ::CloseServiceHandle(schandle);//关闭
    ::getchar(); //暂停
}</code></pre> 
<h2 id="2%20%E5%88%A0%E9%99%A4%E6%9C%8D%E5%8A%A1">2 删除服务</h2> 
<pre><code class="language-cpp">///@ 删除服务
void MainWindow::deleteService()
{
    SC_HANDLE schandle = ::OpenSCManager(NULL, NULL, SC_MANAGER_ALL_ACCESS); //打开服务管理
    SC_HANDLE h = ::OpenService(schandle, L"ServiceAPI", SERVICE_ALL_ACCESS); //打开要删除的服务

    if (h != NULL)
    {
        if (::DeleteService(h))
        {
            qDebug() &lt;&lt; "Service deleted successfully.";
        }
        else
        {
            if(GetLastError() == 1072)
                qDebug() &lt;&lt; "Please restart Windows .....";
            else
                qDebug() &lt;&lt; "Failed to delete service. Error code: " &lt;&lt; GetLastError();
        }
        ::CloseServiceHandle(h); //关闭服务句柄
    }
    else
    {
        qDebug() &lt;&lt; "Failed to open service. Error code: " &lt;&lt; GetLastError();
    }

    ::CloseServiceHandle(schandle); //关闭服务管理句柄
    ::getchar(); //暂停
}
</code></pre> 
<h2 id="3%20%E6%89%93%E5%BC%80%E6%9C%8D%E5%8A%A1">3 打开服务</h2> 
<pre><code class="language-cpp">///@ 打开服务
void MainWindow::openService()
{
    // 打开服务控制管理器
    hSCM = OpenSCManager(NULL, NULL, SC_MANAGER_ALL_ACCESS);

    if (hSCM == NULL) {
        qDebug() &lt;&lt; "OpenSCManager failed with error:" &lt;&lt; GetLastError();
        return;
    }

    // 打开Windows 服务
    hService = OpenService(hSCM, TEXT("SQLWriter"), SERVICE_ALL_ACCESS);

    if (hService == NULL) {
        qDebug() &lt;&lt; "OpenService failed with error:" &lt;&lt; GetLastError();
        CloseServiceHandle(hSCM);
        return;
    }
}

</code></pre> 
<h2 id="4%20%E5%85%B3%E9%97%AD%E6%9C%8D%E5%8A%A1">4 关闭服务</h2> 
<pre><code class="language-cpp">///@ 关闭服务
void MainWindow::closeService()
{
    // 关闭服务和服务控制管理器的句柄
    CloseServiceHandle(hService);
    CloseServiceHandle(hSCM);
}
</code></pre> 
<h2 id="5%20%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1">5 启动服务</h2> 
<pre><code class="language-cpp">///@ 启动服务
void MainWindow::startService()
{
    if (!StartService(hService, 0, NULL)) {
        qDebug() &lt;&lt; "StartService failed with error:" &lt;&lt; GetLastError();
    }
}
</code></pre> 
<h2 id="6%20%E5%81%9C%E6%AD%A2%E6%9C%8D%E5%8A%A1">6 停止服务</h2> 
<pre><code class="language-cpp">///@ 停止服务
void MainWindow::stopService()
{
    SERVICE_STATUS status;
    if (!ControlService(hService, SERVICE_CONTROL_STOP, &amp;status)) {
        qDebug() &lt;&lt; "ControlService failed with error:" &lt;&lt; GetLastError();
    }
}
</code></pre> 
<h2 id="7%20%E8%87%AA%E5%8A%A8%E5%90%AF%E5%8A%A8">7 自动启动</h2> 
<pre><code class="language-cpp">///@ 自动启用服务
void MainWindow::enableService()
{
    enable = true;
    if (!ChangeServiceConfig(
        hService,        // handle of service
        SERVICE_NO_CHANGE, // service type: no change
        enable ? SERVICE_DEMAND_START : SERVICE_DISABLED,
        SERVICE_NO_CHANGE, // error control: no change
        NULL,              // binary path: no change
        NULL,              // load order group: no change
        NULL,              // tag ID: no change
        NULL,              // dependencies: no change
        NULL,              // service start name: no change
        NULL,              // password: no change
        NULL))             // display name: no change
    {
        qDebug() &lt;&lt; "ChangeServiceConfig failed with error:" &lt;&lt; GetLastError();
    }
}
</code></pre> 
<h2 id="8%20%E6%89%8B%E5%8A%A8%E5%90%AF%E5%8A%A8">8 手动启动</h2> 
<pre><code class="language-cpp">///@ 手动启用服务
void MainWindow::manualService()
{
    enable = true;
    if (!ChangeServiceConfig(
        hService,        // handle of service
        SERVICE_NO_CHANGE, // service type: no change
        enable ? SERVICE_AUTO_START : SERVICE_DISABLED, // service start type   SERVICE_DEMAND_START
        SERVICE_NO_CHANGE, // error control: no change
        NULL,              // binary path: no change
        NULL,              // load order group: no change
        NULL,              // tag ID: no change
        NULL,              // dependencies: no change
        NULL,              // service start name: no change
        NULL,              // password: no change
        NULL))             // display name: no change
    {
        qDebug() &lt;&lt; "ChangeServiceConfig failed with error:" &lt;&lt; GetLastError();
    }
}
</code></pre> 
<h2 id="9%20%E6%9F%A5%E8%AF%A2%E6%9C%8D%E5%8A%A1">9 查询服务</h2> 
<pre><code class="language-cpp">void MainWindow::findService()
{
    QSettings servicesSettings("HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services", QSettings::NativeFormat);
    QStringList services = servicesSettings.childGroups();

    for (const QString&amp; service : services) {
        printServiceInfo(service);
    }
}</code></pre> 
<pre><code class="language-cpp">void MainWindow::printServiceInfo(const QString&amp; serviceName)
{
    qDebug() &lt;&lt; "服务名称: " &lt;&lt; serviceName;    //Service Name
    QSettings serviceSettings("HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\" + serviceName, QSettings::NativeFormat);
    QStringList keys = serviceSettings.allKeys();


    if(serviceSettings.value("DisplayName").toString() == "")
        return;

     qDebug() &lt;&lt; "显示名称: " &lt;&lt; serviceSettings.value("DisplayName").toString();
     qDebug() &lt;&lt; "描述: " &lt;&lt; serviceSettings.value("Description").toString();
     qDebug() &lt;&lt; "映像路径: " &lt;&lt; serviceSettings.value("ImagePath").toString();


     QString displayName = QCoreApplication::translate("WalletService", "@%SystemRoot%\\System32\\WalletService.dll,-1000");
     QString description = QCoreApplication::translate("WalletService", "@%SystemRoot%\\System32\\WalletService.dll,-1001");

     qDebug() &lt;&lt; "显示名称：" &lt;&lt; displayName;
     qDebug() &lt;&lt; "描述：" &lt;&lt; description;
}</code></pre> 
<h2 id="10%20.h%E6%BA%90%E6%96%87%E4%BB%B6">10 .h源文件</h2> 
<pre><code class="language-cpp">#ifndef MAINWINDOW_H
#define MAINWINDOW_H

#include &lt;QMainWindow&gt;
#include &lt;QDebug&gt;
#include &lt;QSettings&gt;
#include &lt;windows.h&gt;
#include &lt;winsvc.h&gt;
#include &lt;iostream&gt;
#pragma comment(lib, "advapi32.lib")

#define MAX_SERVICE_SIZE 1024 * 64
#define MAX_QUERY_SIZE   1024 * 8

#pragma execution_character_set("utf-8")

QT_BEGIN_NAMESPACE
namespace Ui { class MainWindow; }
QT_END_NAMESPACE

class MainWindow : public QMainWindow
{
    Q_OBJECT

public:
    MainWindow(QWidget *parent = nullptr);
    ~MainWindow();

    SC_HANDLE hSCM;
    SC_HANDLE hService;
private:
    Ui::MainWindow *ui;

    bool enable;

    void openService();
    void closeService();
    void findService();
    void printServiceInfo(const QString&amp; serviceName);
    void startService();
    void stopService();
    void newService();
    void deleteService();
    void enableService();
    void manualService();
    void disabledService();
};
#endif // MAINWINDOW_H
</code></pre> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d7b49fdafecf8bbee57345a102b1e469/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">@Cleanup() 使用注意事项</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/523157768a2bec246074ea16f469059e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">x-cmd pkg | bat - cat 命令的替代品，对 cat 命令进行功能扩展</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>