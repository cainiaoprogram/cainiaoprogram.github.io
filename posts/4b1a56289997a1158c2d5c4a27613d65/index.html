<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>go-zero 1—rpc服务的创建和rpc服务之间的调用，并介绍go-zero 服务启动的流程 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="go-zero 1—rpc服务的创建和rpc服务之间的调用，并介绍go-zero 服务启动的流程" />
<meta property="og:description" content="前期准备 如果对 grpc 还不太了解的，可以看看我的这栏文章https://blog.csdn.net/wanmei002/category_11067794.html
因为 服务发现和服务注册用到了 etcd , 但是最新的 grpc 跟 etcd 不兼容，
所以 protoc-gen-go 跟 grpc 的版本要降级
go get -u github.com/golang/protobuf/protoc-gen-go@v1.3.2
go get google.golang.org/grpc@v1.29.1
先贴以下我的 go.mod
require ( github.com/golang/protobuf v1.4.2 github.com/modern-go/concurrent v0.0.0-20180306012644-bacd9c7ef1dd // indirect github.com/tal-tech/go-zero v1.1.4 google.golang.org/grpc v1.29.1 ) 简单初始化 一个 grpc server 以下代码来自 go-zero 文档, 地址: https://github.com/tal-tech/zero-doc/blob/main/doc/shorturl.md
建一个文件，进入 初始化: go mod init *****goctl rpc template -o transform.protogoctl rpc proto -src transform.proto -dir .go get github.com/golang/protobuf@v1.4.2go get google.golang.org/grpc@v1.29.1go get 获得所有的依赖查看下 etc/transform." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/4b1a56289997a1158c2d5c4a27613d65/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-06-24T19:21:53+08:00" />
<meta property="article:modified_time" content="2021-06-24T19:21:53+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">go-zero 1—rpc服务的创建和rpc服务之间的调用，并介绍go-zero 服务启动的流程</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>前期准备</h3> 
<blockquote> 
 <p>如果对 grpc 还不太了解的，可以看看我的这栏文章<a href="https://blog.csdn.net/wanmei002/category_11067794.html">https://blog.csdn.net/wanmei002/category_11067794.html</a></p> 
</blockquote> 
<p>因为 服务发现和服务注册用到了 etcd , 但是最新的 grpc 跟 etcd 不兼容，</p> 
<p>所以 protoc-gen-go 跟 grpc 的版本要降级</p> 
<p><code>go get -u github.com/golang/protobuf/protoc-gen-go@v1.3.2</code></p> 
<p><code>go get google.golang.org/grpc@v1.29.1</code></p> 
<p>先贴以下我的 go.mod</p> 
<pre><code class="prism language-go">require <span class="token punctuation">(</span>
	github<span class="token punctuation">.</span>com<span class="token operator">/</span>golang<span class="token operator">/</span>protobuf v1<span class="token punctuation">.</span><span class="token number">4.2</span>
	github<span class="token punctuation">.</span>com<span class="token operator">/</span>modern<span class="token operator">-</span><span class="token keyword">go</span><span class="token operator">/</span>concurrent v0<span class="token punctuation">.</span><span class="token number">0.0</span><span class="token operator">-</span><span class="token number">20180306012644</span><span class="token operator">-</span>bacd9c7ef1dd <span class="token comment">// indirect</span>
	github<span class="token punctuation">.</span>com<span class="token operator">/</span>tal<span class="token operator">-</span>tech<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>zero v1<span class="token punctuation">.</span><span class="token number">1.4</span>
	google<span class="token punctuation">.</span>golang<span class="token punctuation">.</span>org<span class="token operator">/</span>grpc v1<span class="token punctuation">.</span><span class="token number">29.1</span>
<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="__grpc_server_22"></a>简单初始化 一个 grpc server</h3> 
<blockquote> 
 <p>以下代码来自 go-zero 文档, 地址: <a href="https://github.com/tal-tech/zero-doc/blob/main/doc/shorturl.md">https://github.com/tal-tech/zero-doc/blob/main/doc/shorturl.md</a></p> 
</blockquote> 
<ul><li>建一个文件，进入 初始化: go mod init *****</li><li><code>goctl rpc template -o transform.proto</code></li><li><code>goctl rpc proto -src transform.proto -dir .</code></li><li><code>go get github.com/golang/protobuf@v1.4.2</code></li><li><code>go get google.golang.org/grpc@v1.29.1</code></li><li><code>go get</code> 获得所有的依赖</li><li>查看下 etc/transform.yaml 文件里的etcd 地址:端口 是否正确</li><li>go run transform.go 运行起来程序</li></ul> 
<h3><a id="rpc__34"></a>rpc 服务之间的调用</h3> 
<h4><a id="_35"></a>修改配置文件</h4> 
<p>比如我们又建了一个服务 AAA，要调用 transform 服务</p> 
<h5><a id="_AAA___37"></a>修改 AAA 服务的配置文件</h5> 
<ul><li>修改在 etc/ 目录下的 yaml 文件，在其中添加 transform 服务的 etcd 信息，添加内容如下:</li></ul> 
<pre><code class="prism language-json">Transform<span class="token operator">:</span> <span class="token comment">// 名字可以自己取</span>
  Etcd<span class="token operator">:</span>
    Hosts<span class="token operator">:</span>
      <span class="token operator">-</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">2379</span>  <span class="token comment">// transform 服务注册的 etcd</span>
    Key<span class="token operator">:</span> transform<span class="token punctuation">.</span>rpc  <span class="token comment">// transform 服务注册的 服务名</span>
</code></pre> 
<ul><li>在 AAA 服务目录下的 internal/svc/servicecontext.go 文件中添加 transform 客户端连接</li></ul> 
<pre><code class="prism language-go">    <span class="token keyword">type</span> ServiceContext <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
    	Config config<span class="token punctuation">.</span>Config
    	Transform transformer<span class="token punctuation">.</span>Transformer <span class="token comment">// Transformer服务 客户端接口 位置一般是: transform/transformer/transformer.go</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>创建 transform 服务连接，也是在 servicecontext.go 文件中</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">NewServiceContext</span><span class="token punctuation">(</span>c config<span class="token punctuation">.</span>Config<span class="token punctuation">)</span> <span class="token operator">*</span>ServiceContext <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>ServiceContext<span class="token punctuation">{<!-- --></span>
		Config<span class="token punctuation">:</span> c<span class="token punctuation">,</span>
		<span class="token comment">// 创建 transform 客户端连接</span>
		Transform<span class="token punctuation">:</span> transformer<span class="token punctuation">.</span><span class="token function">NewTransformer</span><span class="token punctuation">(</span>zrpc<span class="token punctuation">.</span><span class="token function">MustNewClient</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Transform<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">// c.Transform 是在 yaml 中配置的 transform 服务的配置信息</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>逻辑一般都在项目下的 internal/logic 文件夹下, 在 rpc 方法中，在其中调用 其它 gRPC 项目的方法可以<br> 用 l.svcCtx.Transform 对象里的方法</p> 
<h3><a id="_gozero__67"></a>现在我们来了解下 go-zero 服务是怎么运行了</h3> 
<h4><a id="_proto__rpc__68"></a>新建的实现 proto 中声明的 rpc 方法</h4> 
<pre><code class="prism language-go"><span class="token comment">// 第二个参数的值 会赋值给 s 的register属性，然后 调用 s.Start() 方法, 注册服务</span>
s <span class="token operator">:=</span> zrpc<span class="token punctuation">.</span><span class="token function">MustNewServer</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>RpcServerConf<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>grpcServer <span class="token operator">*</span>grpc<span class="token punctuation">.</span>Server<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		transform<span class="token punctuation">.</span><span class="token function">RegisterTransformerServer</span><span class="token punctuation">(</span>grpcServer<span class="token punctuation">,</span> srv<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="_75"></a>让我们看看新建的时候都做了什么</h4> 
<h5><a id="_76"></a>第一步</h5> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">MustNewServer</span><span class="token punctuation">(</span>c RpcServerConf<span class="token punctuation">,</span> register internal<span class="token punctuation">.</span>RegisterFn<span class="token punctuation">)</span> <span class="token operator">*</span>RpcServer <span class="token punctuation">{<!-- --></span>
	server<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">NewServer</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> register<span class="token punctuation">)</span><span class="token comment">// 这个是第二步</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> server
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_87"></a>第二步</h5> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">NewServer</span><span class="token punctuation">(</span>c RpcServerConf<span class="token punctuation">,</span> register internal<span class="token punctuation">.</span>RegisterFn<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>RpcServer<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">var</span> err <span class="token builtin">error</span>
    <span class="token comment">// 如果要 Auth 认证，需要配置 redis ，这里检查是否配置了 redis</span>
	<span class="token keyword">if</span> err <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">Validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>

	<span class="token keyword">var</span> server internal<span class="token punctuation">.</span>Server
	metrics <span class="token operator">:=</span> stat<span class="token punctuation">.</span><span class="token function">NewMetrics</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>ListenOn<span class="token punctuation">)</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span><span class="token function">HasEtcd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 检查 配置的 ip</span>
		listenOn <span class="token operator">:=</span> <span class="token function">figureOutListenOn</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>ListenOn<span class="token punctuation">)</span>
		<span class="token comment">// 重要的一步 连接etcd 并注册服务，并保持续期  这是第三步</span>
        server<span class="token punctuation">,</span> err <span class="token operator">=</span> internal<span class="token punctuation">.</span><span class="token function">NewRpcPubServer</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Etcd<span class="token punctuation">.</span>Hosts<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Etcd<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> listenOn<span class="token punctuation">,</span> internal<span class="token punctuation">.</span><span class="token function">WithMetrics</span><span class="token punctuation">(</span>metrics<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		server <span class="token operator">=</span> internal<span class="token punctuation">.</span><span class="token function">NewRpcServer</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>ListenOn<span class="token punctuation">,</span> internal<span class="token punctuation">.</span><span class="token function">WithMetrics</span><span class="token punctuation">(</span>metrics<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	server<span class="token punctuation">.</span><span class="token function">SetName</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">=</span> <span class="token function">setupInterceptors</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> c<span class="token punctuation">,</span> metrics<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>

	rpcServer <span class="token operator">:=</span> <span class="token operator">&amp;</span>RpcServer<span class="token punctuation">{<!-- --></span>
		server<span class="token punctuation">:</span>   server<span class="token punctuation">,</span>
		register<span class="token punctuation">:</span> register<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">SetUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> rpcServer<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_126"></a>第三步</h5> 
<pre><code class="prism language-go">server<span class="token punctuation">,</span> err <span class="token operator">=</span> internal<span class="token punctuation">.</span><span class="token function">NewRpcPubServer</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Etcd<span class="token punctuation">.</span>Hosts<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Etcd<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> listenOn<span class="token punctuation">,</span> internal<span class="token punctuation">.</span><span class="token function">WithMetrics</span><span class="token punctuation">(</span>metrics<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>上面的 NewRpcPubServer 方法里的代码</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">NewRpcPubServer</span><span class="token punctuation">(</span>etcdEndpoints <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> etcdKey<span class="token punctuation">,</span> listenOn <span class="token builtin">string</span><span class="token punctuation">,</span> opts <span class="token operator">...</span>ServerOption<span class="token punctuation">)</span> <span class="token punctuation">(</span>Server<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	registerEtcd <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 连接 etcd 并设置租约</span>
		pubClient <span class="token operator">:=</span> discov<span class="token punctuation">.</span><span class="token function">NewPublisher</span><span class="token punctuation">(</span>etcdEndpoints<span class="token punctuation">,</span> etcdKey<span class="token punctuation">,</span> listenOn<span class="token punctuation">)</span>
		<span class="token keyword">return</span> pubClient<span class="token punctuation">.</span><span class="token function">KeepAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	server <span class="token operator">:=</span> keepAliveServer<span class="token punctuation">{<!-- --></span>
		registerEtcd<span class="token punctuation">:</span> registerEtcd<span class="token punctuation">,</span>
                      <span class="token comment">// 这是第四步</span>
		Server<span class="token punctuation">:</span>       <span class="token function">NewRpcServer</span><span class="token punctuation">(</span>listenOn<span class="token punctuation">,</span> opts<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> server<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_149"></a>第四步</h5> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">NewRpcServer</span><span class="token punctuation">(</span>address <span class="token builtin">string</span><span class="token punctuation">,</span> opts <span class="token operator">...</span>ServerOption<span class="token punctuation">)</span> Server <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">var</span> options rpcServerOptions
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> opt <span class="token operator">:=</span> <span class="token keyword">range</span> opts <span class="token punctuation">{<!-- --></span>
		<span class="token function">opt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>options<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> options<span class="token punctuation">.</span>metrics <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		options<span class="token punctuation">.</span>metrics <span class="token operator">=</span> stat<span class="token punctuation">.</span><span class="token function">NewMetrics</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
    <span class="token comment">// 这个 server 是比较重要的 他有个方法</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>rpcServer<span class="token punctuation">{<!-- --></span>
		baseRpcServer<span class="token punctuation">:</span> <span class="token function">newBaseRpcServer</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> options<span class="token punctuation">.</span>metrics<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>rpcServer 的 Start 方法, 这个方法就是注册grpc 服务 和 注册拦截器</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>rpcServer<span class="token punctuation">)</span> <span class="token function">Start</span><span class="token punctuation">(</span>register RegisterFn<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
	lis<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">"tcp"</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>address<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>

	unaryInterceptors <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>grpc<span class="token punctuation">.</span>UnaryServerInterceptor<span class="token punctuation">{<!-- --></span>
		serverinterceptors<span class="token punctuation">.</span><span class="token function">UnaryTracingInterceptor</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span>
		serverinterceptors<span class="token punctuation">.</span><span class="token function">UnaryCrashInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		serverinterceptors<span class="token punctuation">.</span><span class="token function">UnaryStatInterceptor</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>metrics<span class="token punctuation">)</span><span class="token punctuation">,</span>
		serverinterceptors<span class="token punctuation">.</span><span class="token function">UnaryPrometheusInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	unaryInterceptors <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>unaryInterceptors<span class="token punctuation">,</span> s<span class="token punctuation">.</span>unaryInterceptors<span class="token operator">...</span><span class="token punctuation">)</span>
	streamInterceptors <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>grpc<span class="token punctuation">.</span>StreamServerInterceptor<span class="token punctuation">{<!-- --></span>
		serverinterceptors<span class="token punctuation">.</span>StreamCrashInterceptor<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	streamInterceptors <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>streamInterceptors<span class="token punctuation">,</span> s<span class="token punctuation">.</span>streamInterceptors<span class="token operator">...</span><span class="token punctuation">)</span>
	options <span class="token operator">:=</span> <span class="token function">append</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>options<span class="token punctuation">,</span> <span class="token function">WithUnaryServerInterceptors</span><span class="token punctuation">(</span>unaryInterceptors<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token function">WithStreamServerInterceptors</span><span class="token punctuation">(</span>streamInterceptors<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	server <span class="token operator">:=</span> grpc<span class="token punctuation">.</span><span class="token function">NewServer</span><span class="token punctuation">(</span>options<span class="token operator">...</span><span class="token punctuation">)</span>
	<span class="token function">register</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span>
	<span class="token comment">// we need to make sure all others are wrapped up</span>
	<span class="token comment">// so we do graceful stop at shutdown phase instead of wrap up phase</span>
	waitForCalled <span class="token operator">:=</span> proc<span class="token punctuation">.</span><span class="token function">AddWrapUpListener</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		server<span class="token punctuation">.</span><span class="token function">GracefulStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">waitForCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">return</span> server<span class="token punctuation">.</span><span class="token function">Serve</span><span class="token punctuation">(</span>lis<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="__200"></a>第五步 启动起来</h5> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>rs <span class="token operator">*</span>RpcServer<span class="token punctuation">)</span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> rs<span class="token punctuation">.</span>server<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>rs<span class="token punctuation">.</span>register<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		logx<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>就这样 grpc 服务就跑起来了</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/11a7eed0f7dbc2a592a8ae76930368a1/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">win7计算机未连接网络连接,win7连接可用，未连接怎么办？</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d8670accdb7401227a4386c24e8af024/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">IDEA导入springboot工程后Cannot resolve plugin org.springframework.boot:spring-boot-maven-plugin:＜unknown＞</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>