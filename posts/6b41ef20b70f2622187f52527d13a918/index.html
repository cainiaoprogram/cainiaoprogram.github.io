<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【大数据之Kafka】十五、Kafka-Kraft模式 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【大数据之Kafka】十五、Kafka-Kraft模式" />
<meta property="og:description" content="1 Kafka-Kraft架构 左图为 Kafka 现有架构，元数据在 zookeeper 中，运行时动态选举 controller，由controller 进行 Kafka 集群管理。
右图为 kraft 模式架构（实验性），不再依赖 zookeeper 集群，而是用三台 controller 节点代替 zookeeper，元数据保存在 controller 中，由 controller 直接进行 Kafka 集群管理。
好处：
（1）Kafka 不再依赖外部框架，而是能够独立运行；
（2）controller 管理集群时，不再需要从 zookeeper 中先读取数据，集群性能上升；
（3）由于不依赖 zookeeper，集群扩展时不再受到 zookeeper 读写能力限制；
（ 4）controller 不再动态选举，而是由配置文件规定。这样可以有针对性的加强controller 节点的配置，而不是像以前一样对随机 controller 节点的高负载束手无策。
2 Kafka-Kraft集群部署 （1）再解压一份Kafka安装包。
tar -zxvf kafka_2.12-3.0.0.tgz -C /opt/module/ （2）重命名为kafka2。
mv kafka_2.12-3.0.0/ kafka2 （3）在 hadoop102 上修改/opt/module/kafka2/config/kraft/server.properties 配置文件。
#kafka 的角色（controller 相当于主机、broker 节点相当于从机，主机类似 zk 功能） process.roles=broker, controller #节点 ID node.id=2 #controller 服务协议别名 controller." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/6b41ef20b70f2622187f52527d13a918/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-20T15:30:00+08:00" />
<meta property="article:modified_time" content="2023-09-20T15:30:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【大数据之Kafka】十五、Kafka-Kraft模式</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="1_KafkaKraft_0"></a>1 Kafka-Kraft架构</h2> 
<p><img src="https://images2.imgbox.com/6e/65/rQNkmCI6_o.png" alt="在这里插入图片描述"><br>   左图为 Kafka 现有架构，元数据在 zookeeper 中，运行时动态选举 controller，由controller 进行 Kafka 集群管理。<br>   右图为 kraft 模式架构（实验性），不再依赖 zookeeper 集群，而是用三台 controller 节点代替 zookeeper，元数据保存在 controller 中，由 controller 直接进行 Kafka 集群管理。</p> 
<p>好处：<br>   （1）Kafka 不再依赖外部框架，而是能够独立运行；<br>   （2）controller 管理集群时，不再需要从 zookeeper 中先读取数据，集群性能上升；<br>   （3）由于不依赖 zookeeper，集群扩展时不再受到 zookeeper 读写能力限制；<br> （  4）controller 不再动态选举，而是由配置文件规定。这样可以有针对性的加强controller 节点的配置，而不是像以前一样对随机 controller 节点的高负载束手无策。</p> 
<h2><a id="2_KafkaKraft_11"></a>2 Kafka-Kraft集群部署</h2> 
<p>（1）再解压一份Kafka安装包。</p> 
<pre><code class="prism language-java">tar <span class="token operator">-</span>zxvf kafka_2<span class="token punctuation">.</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">3.0</span><span class="token number">.0</span><span class="token punctuation">.</span>tgz <span class="token operator">-</span><span class="token class-name">C</span> <span class="token operator">/</span>opt<span class="token operator">/</span><span class="token keyword">module</span><span class="token operator">/</span>
</code></pre> 
<p>（2）重命名为kafka2。</p> 
<pre><code class="prism language-java">mv kafka_2<span class="token punctuation">.</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">3.0</span><span class="token number">.0</span><span class="token operator">/</span> kafka2
</code></pre> 
<p>（3）在 hadoop102 上修改/opt/module/kafka2/config/kraft/server.properties 配置文件。</p> 
<pre><code class="prism language-java">#kafka 的角色（controller 相当于主机、broker 节点相当于从机，主机类似 zk 功能）
process<span class="token punctuation">.</span>roles<span class="token operator">=</span>broker<span class="token punctuation">,</span> controller
#节点 <span class="token constant">ID</span>
node<span class="token punctuation">.</span>id<span class="token operator">=</span><span class="token number">2</span>

#controller 服务协议别名
controller<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>names<span class="token operator">=</span><span class="token constant">CONTROLLER</span>
#全 <span class="token class-name">Controller</span> 列表
controller<span class="token punctuation">.</span>quorum<span class="token punctuation">.</span>voters<span class="token operator">=</span><span class="token number">2</span><span class="token annotation punctuation">@hadoop102</span><span class="token operator">:</span><span class="token number">9093</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token annotation punctuation">@hadoop103</span><span class="token operator">:</span><span class="token number">9093</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token annotation punctuation">@hadoop104</span><span class="token operator">:</span><span class="token number">9093</span>
#不同服务器绑定的端口
listeners<span class="token operator">=</span><span class="token constant">PLAINTEXT</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token operator">:</span><span class="token number">9092</span><span class="token punctuation">,</span><span class="token constant">CONTROLLER</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token operator">:</span><span class="token number">9093</span>
#broker 服务协议别名
inter<span class="token punctuation">.</span>broker<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>name<span class="token operator">=</span><span class="token constant">PLAINTEXT</span>
#broker 对外暴露的地址
<span class="token class-name"><span class="token namespace">advertised<span class="token punctuation">.</span></span>Listeners</span><span class="token operator">=</span><span class="token constant">PLAINTEXT</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>hadoop102<span class="token operator">:</span><span class="token number">9092</span>
#协议别名到安全协议的映射
listener<span class="token punctuation">.</span>security<span class="token punctuation">.</span>protocol<span class="token punctuation">.</span>map<span class="token operator">=</span><span class="token constant">CONTROLLER</span><span class="token operator">:</span><span class="token constant">PLAINTEXT</span><span class="token punctuation">,</span><span class="token constant">PLAINTEXT</span><span class="token operator">:</span><span class="token constant">PLAINTEXT</span><span class="token punctuation">,</span><span class="token constant">SSL</span><span class="token operator">:</span><span class="token constant">SSL</span><span class="token punctuation">,</span><span class="token constant">SASL_PLAINTEXT</span><span class="token operator">:</span><span class="token constant">SASL_PLAINTEXT</span><span class="token punctuation">,</span><span class="token constant">SASL_SSL</span><span class="token operator">:</span><span class="token constant">SASL_SSL</span>
#kafka 数据存储目录
log<span class="token punctuation">.</span>dirs<span class="token operator">=</span><span class="token operator">/</span>opt<span class="token operator">/</span><span class="token keyword">module</span><span class="token operator">/</span>kafka2<span class="token operator">/</span>data
</code></pre> 
<p>（4）分发kafka2，在 hadoop103 和 hadoop104 上需要对 node.id 相应改变， 值需要和controller.quorum.voters 对应。在 hadoop103 和 hadoop104 上需要 根据各自的主机名称，修改相应的advertised.Listeners 地址。</p> 
<p>（5）初始化集群数据目录，首先生成存储目录唯一 ID。</p> 
<pre><code class="prism language-java"> bin<span class="token operator">/</span>kafka<span class="token operator">-</span>storage<span class="token punctuation">.</span>sh random<span class="token operator">-</span>uuid
</code></pre> 
<p><img src="https://images2.imgbox.com/e2/69/lcQkHNHr_o.png" alt="在这里插入图片描述"><br> （6）用该 ID 格式化 kafka 存储目录（三台节点）。</p> 
<pre><code class="prism language-java"><span class="token punctuation">[</span>lyx<span class="token annotation punctuation">@hadoop102</span> kafka2<span class="token punctuation">]</span>$ bin<span class="token operator">/</span>kafka<span class="token operator">-</span>storage<span class="token punctuation">.</span>sh format <span class="token operator">-</span>t <span class="token number">7</span>NSm<span class="token operator">-</span>xjRRGu3hj<span class="token operator">-</span><span class="token number">4</span>bA0qMw <span class="token operator">-</span>c <span class="token operator">/</span>opt<span class="token operator">/</span><span class="token keyword">module</span><span class="token operator">/</span>kafka2<span class="token operator">/</span>config<span class="token operator">/</span>kraft<span class="token operator">/</span>server<span class="token punctuation">.</span>properties

<span class="token punctuation">[</span>lyx<span class="token annotation punctuation">@hadoop103</span> kafka2<span class="token punctuation">]</span>$ bin<span class="token operator">/</span>kafka<span class="token operator">-</span>storage<span class="token punctuation">.</span>sh format <span class="token operator">-</span>t <span class="token number">7</span>NSm<span class="token operator">-</span>xjRRGu3hj<span class="token operator">-</span><span class="token number">4</span>bA0qMw <span class="token operator">-</span>c <span class="token operator">/</span>opt<span class="token operator">/</span><span class="token keyword">module</span><span class="token operator">/</span>kafka2<span class="token operator">/</span>config<span class="token operator">/</span>kraft<span class="token operator">/</span>server<span class="token punctuation">.</span>properties

<span class="token punctuation">[</span>lyx<span class="token annotation punctuation">@hadoop104</span> kafka2<span class="token punctuation">]</span>$ bin<span class="token operator">/</span>kafka<span class="token operator">-</span>storage<span class="token punctuation">.</span>sh format <span class="token operator">-</span>t <span class="token number">7</span>NSm<span class="token operator">-</span>xjRRGu3hj<span class="token operator">-</span><span class="token number">4</span>bA0qMw <span class="token operator">-</span>c <span class="token operator">/</span>opt<span class="token operator">/</span><span class="token keyword">module</span><span class="token operator">/</span>kafka2<span class="token operator">/</span>config<span class="token operator">/</span>kraft<span class="token operator">/</span>server<span class="token punctuation">.</span>properties
</code></pre> 
<p>（7）启动Kafka集群。</p> 
<pre><code class="prism language-java"><span class="token punctuation">[</span>lyx<span class="token annotation punctuation">@hadoop102</span> kafka2<span class="token punctuation">]</span>$ bin<span class="token operator">/</span>kafka<span class="token operator">-</span>server<span class="token operator">-</span>start<span class="token punctuation">.</span>sh <span class="token operator">-</span>daemon config<span class="token operator">/</span>kraft<span class="token operator">/</span>server<span class="token punctuation">.</span>properties

<span class="token punctuation">[</span>lyx<span class="token annotation punctuation">@hadoop103</span> kafka2<span class="token punctuation">]</span>$ bin<span class="token operator">/</span>kafka<span class="token operator">-</span>server<span class="token operator">-</span>start<span class="token punctuation">.</span>sh <span class="token operator">-</span>daemon config<span class="token operator">/</span>kraft<span class="token operator">/</span>server<span class="token punctuation">.</span>properties

<span class="token punctuation">[</span>lyx<span class="token annotation punctuation">@hadoop104</span> kafka2<span class="token punctuation">]</span>$ bin<span class="token operator">/</span>kafka<span class="token operator">-</span>server<span class="token operator">-</span>start<span class="token punctuation">.</span>sh <span class="token operator">-</span>daemon config<span class="token operator">/</span>kraft<span class="token operator">/</span>server<span class="token punctuation">.</span>properties
</code></pre> 
<p><img src="https://images2.imgbox.com/07/e6/7Id5b4XQ_o.png" alt="在这里插入图片描述"><br> （8）停止Kafka集群。</p> 
<pre><code class="prism language-java"><span class="token punctuation">[</span>lyx<span class="token annotation punctuation">@hadoop102</span> kafka2<span class="token punctuation">]</span>$ bin<span class="token operator">/</span>kafka<span class="token operator">-</span>server<span class="token operator">-</span>stop<span class="token punctuation">.</span>sh

<span class="token punctuation">[</span>lyx<span class="token annotation punctuation">@hadoop103</span> kafka2<span class="token punctuation">]</span>$ bin<span class="token operator">/</span>kafka<span class="token operator">-</span>server<span class="token operator">-</span>stop<span class="token punctuation">.</span>sh

<span class="token punctuation">[</span>lyx<span class="token annotation punctuation">@hadoop104</span> kafka2<span class="token punctuation">]</span>$ bin<span class="token operator">/</span>kafka<span class="token operator">-</span>server<span class="token operator">-</span>stop<span class="token punctuation">.</span>sh
</code></pre> 
<h2><a id="3_KafkaKraft_84"></a>3 Kafka-Kraft集群启停脚本</h2> 
<p>（1）在/home/用户名/bin目录下创建文件kf2.sh脚本。</p> 
<pre><code class="prism language-java">#<span class="token operator">!</span><span class="token operator">/</span>bin<span class="token operator">/</span>bash
<span class="token keyword">case</span> $<span class="token number">1</span> in
<span class="token string">"start"</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> i in hadoop102 hadoop103 hadoop104
    <span class="token keyword">do</span>
        echo <span class="token string">" --------启动 $i Kafka2-------"</span>
        ssh $i "<span class="token operator">/</span>opt<span class="token operator">/</span><span class="token keyword">module</span><span class="token operator">/</span>kafka2<span class="token operator">/</span>bin<span class="token operator">/</span>kafka<span class="token operator">-</span>server<span class="token operator">-</span>start<span class="token punctuation">.</span>sh <span class="token operator">-</span>
daemon <span class="token operator">/</span>opt<span class="token operator">/</span><span class="token keyword">module</span><span class="token operator">/</span>kafka2<span class="token operator">/</span>config<span class="token operator">/</span>kraft<span class="token operator">/</span>server<span class="token punctuation">.</span>properties"
    done
<span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token string">"stop"</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> i in hadoop102 hadoop103 hadoop104
    <span class="token keyword">do</span>
        echo <span class="token string">" --------停止 $i Kafka2-------"</span>
        ssh $i <span class="token string">"/opt/module/kafka2/bin/kafka-server-stop.sh "</span>
    done
<span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
esac
</code></pre> 
<p>（2）添加执行权限。</p> 
<pre><code class="prism language-java">chmod <span class="token number">777</span> kf2<span class="token punctuation">.</span>sh
</code></pre> 
<p>（3）启动集群命令。</p> 
<pre><code class="prism language-java">kf2<span class="token punctuation">.</span>sh start
</code></pre> 
<p>（4）停止集群命令。</p> 
<pre><code class="prism language-java">kf2<span class="token punctuation">.</span>sh stop
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/25e66ff65fa940e435af8de7bbccb35e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Gitlab 备份和恢复</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/db1480212994895cb1f9010f51105289/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">jmeter时间戳</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>