<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>使用 Haproxy &#43; Nginx 实现高可用配置 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="使用 Haproxy &#43; Nginx 实现高可用配置" />
<meta property="og:description" content="使用 Haproxy &#43; Nginx 实现高可用配置 一、基本介绍二、使用 Haproxy &#43; Nginx 实现高可用配置1.安装 Nginx2.安装 Haproxy3.修改 Haproxy 配置文件4.启动 Haproxy 服务5.验证 一、基本介绍 Haproxy 是目前比较流行的一种集群调度工具，同类集群调度器工具有很多，如 LVS 和 Nginx。相比较而言，LVS 性能最好，但是搭建相对复杂；Nginx 的 upstream 模块虽然支持集群功能，但是对集群节点健康检查功能不强，性能没有 Haproxy 好。
Haproxy 可以提供高可用性、负载均衡以及基于 TCP 和 HTTP 应用的代理，并且支持虚拟主机配置。官方介绍
常见调度模式：
调度模式作用Round Robin（轮询）根据轮询分配访问请求，来实现负载均衡的效果（可以配置权重，以此增加调度概率）Least Connections（最小连接数）根据后端节点的连接数大小，来动态的分配前端请求（将请求优先分配到连接数小的节点上）Source Hashing（基于来源访问调度）用于一些有 Session 会话记录在服务器端的场景，可以基于来源 IP、Cookie 等进行集群调度。 二、使用 Haproxy &#43; Nginx 实现高可用配置 准备工作：
主机名操作系统IP地址软件包Nginx-1CentOS7.4192.168.1.1nginx-1.21.0.tar.gzNginx-2CentOS7.4192.168.1.2nginx-1.21.0.tar.gzHaproxyCentOS7.4192.168.1.3haproxy-2.6.0.tar.gz 1.安装 Nginx 1）安装并启动 Nginx 服务
[root@Nginx-1 ~]# yum -y install pcre-devel zlib-devel popt-devel openssl-devel openssl [root@Nginx-1 ~]# wget http://www.nginx.org/download/nginx-1.21.0.tar.gz [root@Nginx-1 ~]# ls anaconda-ks." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/b8f0286af1b0ca7a76899df42193da02/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-30T18:15:10+08:00" />
<meta property="article:modified_time" content="2022-07-30T18:15:10+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">使用 Haproxy &#43; Nginx 实现高可用配置</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>使用 Haproxy + Nginx 实现高可用配置</h4> 
 <ul><li><a href="#_2" rel="nofollow">一、基本介绍</a></li><li><a href="#_Haproxy__Nginx__14" rel="nofollow">二、使用 Haproxy + Nginx 实现高可用配置</a></li><li><ul><li><a href="#1_Nginx_21" rel="nofollow">1.安装 Nginx</a></li><li><a href="#2_Haproxy_55" rel="nofollow">2.安装 Haproxy</a></li><li><a href="#3_Haproxy__67" rel="nofollow">3.修改 Haproxy 配置文件</a></li><li><a href="#4_Haproxy__107" rel="nofollow">4.启动 Haproxy 服务</a></li><li><a href="#5_128" rel="nofollow">5.验证</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_2"></a>一、基本介绍</h2> 
<p>Haproxy 是目前比较流行的一种集群调度工具，同类集群调度器工具有很多，如 LVS 和 Nginx。相比较而言，LVS 性能最好，但是搭建相对复杂；Nginx 的 <code>upstream</code> 模块虽然支持集群功能，但是对集群节点健康检查功能不强，性能没有 Haproxy 好。</p> 
<p>Haproxy 可以提供高可用性、负载均衡以及基于 TCP 和 HTTP 应用的代理，并且支持虚拟主机配置。<a href="https://cbonte.github.io/haproxy-dconv/2.6/intro.html" rel="nofollow">官方介绍</a></p> 
<hr> 
<p>常见调度模式：</p> 
<table><thead><tr><th align="left">调度模式</th><th align="left">作用</th></tr></thead><tbody><tr><td align="left">Round Robin（轮询）</td><td align="left">根据轮询分配访问请求，来实现负载均衡的效果（可以配置权重，以此增加调度概率）</td></tr><tr><td align="left">Least Connections（最小连接数）</td><td align="left">根据后端节点的连接数大小，来动态的分配前端请求（将请求优先分配到连接数小的节点上）</td></tr><tr><td align="left">Source Hashing（基于来源访问调度）</td><td align="left">用于一些有 Session 会话记录在服务器端的场景，可以基于来源 IP、Cookie 等进行集群调度。</td></tr></tbody></table> 
<h2><a id="_Haproxy__Nginx__14"></a>二、使用 Haproxy + Nginx 实现高可用配置</h2> 
<p>准备工作：</p> 
<table><thead><tr><th align="left">主机名</th><th align="left">操作系统</th><th align="left">IP地址</th><th align="left">软件包</th></tr></thead><tbody><tr><td align="left">Nginx-1</td><td align="left">CentOS7.4</td><td align="left">192.168.1.1</td><td align="left"><code>nginx-1.21.0.tar.gz</code></td></tr><tr><td align="left">Nginx-2</td><td align="left">CentOS7.4</td><td align="left">192.168.1.2</td><td align="left"><code>nginx-1.21.0.tar.gz</code></td></tr><tr><td align="left">Haproxy</td><td align="left">CentOS7.4</td><td align="left">192.168.1.3</td><td align="left"><code>haproxy-2.6.0.tar.gz</code></td></tr></tbody></table> 
<h3><a id="1_Nginx_21"></a>1.安装 Nginx</h3> 
<p>1）安装并启动 Nginx 服务</p> 
<pre><code class="prism language-handlebars"><span class="token punctuation">[</span><span class="token variable">root</span><span class="token punctuation">@</span><span class="token variable">Nginx-</span><span class="token number">1</span> <span class="token punctuation">~</span><span class="token punctuation">]</span><span class="token punctuation">#</span> <span class="token variable">yum</span> <span class="token variable">-y</span> <span class="token variable">install</span> <span class="token variable">pcre-devel</span> <span class="token variable">zlib-devel</span> <span class="token variable">popt-devel</span> <span class="token variable">openssl-devel</span> <span class="token variable">openssl</span>
<span class="token punctuation">[</span><span class="token variable">root</span><span class="token punctuation">@</span><span class="token variable">Nginx-</span><span class="token number">1</span> <span class="token punctuation">~</span><span class="token punctuation">]</span><span class="token punctuation">#</span> <span class="token variable">wget</span> <span class="token variable">http</span><span class="token punctuation">:</span><span class="token punctuation">/</span><span class="token punctuation">/</span><span class="token variable">www</span><span class="token punctuation">.</span><span class="token variable">nginx</span><span class="token punctuation">.</span><span class="token variable">org</span><span class="token punctuation">/</span><span class="token variable">download</span><span class="token punctuation">/</span><span class="token variable">nginx-</span><span class="token number">1.21</span><span class="token number">.0</span><span class="token punctuation">.</span><span class="token variable">tar</span><span class="token punctuation">.</span><span class="token variable">gz</span>
<span class="token punctuation">[</span><span class="token variable">root</span><span class="token punctuation">@</span><span class="token variable">Nginx-</span><span class="token number">1</span> <span class="token punctuation">~</span><span class="token punctuation">]</span><span class="token punctuation">#</span> <span class="token variable">ls</span>
<span class="token variable">anaconda-ks</span><span class="token punctuation">.</span><span class="token variable">cfg</span>  <span class="token variable">nginx-</span><span class="token number">1.21</span><span class="token number">.0</span><span class="token punctuation">.</span><span class="token variable">tar</span><span class="token punctuation">.</span><span class="token variable">gz</span>
<span class="token punctuation">[</span><span class="token variable">root</span><span class="token punctuation">@</span><span class="token variable">Nginx-</span><span class="token number">1</span> <span class="token punctuation">~</span><span class="token punctuation">]</span><span class="token punctuation">#</span> <span class="token variable">tar</span> <span class="token variable">zxf</span> <span class="token variable">nginx-</span><span class="token number">1.21</span><span class="token number">.0</span><span class="token punctuation">.</span><span class="token variable">tar</span><span class="token punctuation">.</span><span class="token variable">gz</span> <span class="token variable">-C</span> <span class="token punctuation">/</span><span class="token variable">usr</span><span class="token punctuation">/</span><span class="token variable">src</span><span class="token punctuation">/</span>
<span class="token punctuation">[</span><span class="token variable">root</span><span class="token punctuation">@</span><span class="token variable">Nginx-</span><span class="token number">1</span> <span class="token punctuation">~</span><span class="token punctuation">]</span><span class="token punctuation">#</span> <span class="token variable">cd</span> <span class="token punctuation">/</span><span class="token variable">usr</span><span class="token punctuation">/</span><span class="token variable">src</span><span class="token punctuation">/</span><span class="token variable">nginx-</span><span class="token number">1.21</span><span class="token number">.0</span><span class="token punctuation">/</span>
<span class="token punctuation">[</span><span class="token variable">root</span><span class="token punctuation">@</span><span class="token variable">Nginx-</span><span class="token number">1</span> <span class="token variable">nginx-</span><span class="token number">1.21</span><span class="token number">.0</span><span class="token punctuation">]</span><span class="token punctuation">#</span> <span class="token variable">useradd</span> <span class="token variable">-M</span> <span class="token variable">-s</span> <span class="token punctuation">/</span><span class="token variable">sbin</span><span class="token punctuation">/</span><span class="token variable">nologin</span> <span class="token variable">nginx</span>
<span class="token punctuation">[</span><span class="token variable">root</span><span class="token punctuation">@</span><span class="token variable">Nginx-</span><span class="token number">1</span> <span class="token variable">nginx-</span><span class="token number">1.21</span><span class="token number">.0</span><span class="token punctuation">]</span><span class="token punctuation">#</span> <span class="token punctuation">.</span><span class="token punctuation">/</span><span class="token variable">configure</span> <span class="token punctuation">\</span>
<span class="token variable">--prefix</span><span class="token punctuation">=</span><span class="token punctuation">/</span><span class="token variable">usr</span><span class="token punctuation">/</span><span class="token variable">local</span><span class="token punctuation">/</span><span class="token variable">nginx</span> <span class="token punctuation">\</span>
<span class="token variable">--user</span><span class="token punctuation">=</span><span class="token variable">nginx</span> <span class="token punctuation">\</span>
<span class="token variable">--group</span><span class="token punctuation">=</span><span class="token variable">nginx</span> <span class="token punctuation">\</span>
<span class="token variable">--with-file-aio</span> <span class="token punctuation">\</span>
<span class="token variable">--with-http_stub_status_module</span> <span class="token punctuation">\</span>
<span class="token variable">--with-http_gzip_static_module</span> <span class="token punctuation">\</span>
<span class="token variable">--with-http_flv_module</span> <span class="token punctuation">\</span>
<span class="token variable">--with-http_ssl_module</span> <span class="token punctuation">\</span>
<span class="token variable">--with-stream</span> <span class="token punctuation">\</span>
<span class="token variable">--with-pcre</span> <span class="token punctuation">&amp;</span><span class="token punctuation">&amp;</span> <span class="token variable">make</span> <span class="token punctuation">&amp;</span><span class="token punctuation">&amp;</span> <span class="token variable">make</span> <span class="token variable">install</span>
<span class="token punctuation">[</span><span class="token variable">root</span><span class="token punctuation">@</span><span class="token variable">Nginx-</span><span class="token number">1</span> <span class="token variable">nginx-</span><span class="token number">1.21</span><span class="token number">.0</span><span class="token punctuation">]</span><span class="token punctuation">#</span> <span class="token variable">ln</span> <span class="token variable">-s</span> <span class="token punctuation">/</span><span class="token variable">usr</span><span class="token punctuation">/</span><span class="token variable">local</span><span class="token punctuation">/</span><span class="token variable">nginx</span><span class="token punctuation">/</span><span class="token variable">sbin</span><span class="token punctuation">/</span><span class="token variable">nginx</span> <span class="token punctuation">/</span><span class="token variable">usr</span><span class="token punctuation">/</span><span class="token variable">local</span><span class="token punctuation">/</span><span class="token variable">sbin</span><span class="token punctuation">/</span>
<span class="token punctuation">[</span><span class="token variable">root</span><span class="token punctuation">@</span><span class="token variable">Nginx-</span><span class="token number">1</span> <span class="token variable">nginx-</span><span class="token number">1.21</span><span class="token number">.0</span><span class="token punctuation">]</span><span class="token punctuation">#</span> <span class="token variable">cd</span>
<span class="token punctuation">[</span><span class="token variable">root</span><span class="token punctuation">@</span><span class="token variable">Nginx-</span><span class="token number">1</span> <span class="token punctuation">~</span><span class="token punctuation">]</span><span class="token punctuation">#</span> <span class="token variable">nginx</span>
<span class="token punctuation">[</span><span class="token variable">root</span><span class="token punctuation">@</span><span class="token variable">Nginx-</span><span class="token number">1</span> <span class="token punctuation">~</span><span class="token punctuation">]</span><span class="token punctuation">#</span> <span class="token variable">netstat</span> <span class="token variable">-anpt</span> <span class="token punctuation">|</span> <span class="token variable">grep</span> <span class="token number">80</span>
</code></pre> 
<p>2）配置 Nginx 页面</p> 
<pre><code class="prism language-handlebars"><span class="token punctuation">[</span><span class="token variable">root</span><span class="token punctuation">@</span><span class="token variable">Nginx-</span><span class="token number">1</span> <span class="token punctuation">~</span><span class="token punctuation">]</span><span class="token punctuation">#</span> <span class="token variable">echo</span> <span class="token string">"&lt;h1&gt;This is 192.168.1.1&lt;/h1&gt;"</span> <span class="token punctuation">&gt;</span> <span class="token punctuation">/</span><span class="token variable">usr</span><span class="token punctuation">/</span><span class="token variable">local</span><span class="token punctuation">/</span><span class="token variable">nginx</span><span class="token punctuation">/</span><span class="token variable">html</span><span class="token punctuation">/</span><span class="token variable">index</span><span class="token punctuation">.</span><span class="token variable">html</span>
</code></pre> 
<pre><code class="prism language-handlebars"><span class="token punctuation">[</span><span class="token variable">root</span><span class="token punctuation">@</span><span class="token variable">Nginx-</span><span class="token number">2</span> <span class="token punctuation">~</span><span class="token punctuation">]</span><span class="token punctuation">#</span> <span class="token variable">echo</span> <span class="token string">"&lt;h1&gt;This is 192.168.1.2&lt;/h1&gt;"</span> <span class="token punctuation">&gt;</span> <span class="token punctuation">/</span><span class="token variable">usr</span><span class="token punctuation">/</span><span class="token variable">local</span><span class="token punctuation">/</span><span class="token variable">nginx</span><span class="token punctuation">/</span><span class="token variable">html</span><span class="token punctuation">/</span><span class="token variable">index</span><span class="token punctuation">.</span><span class="token variable">html</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/da/3e/GDzVi37X_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="2_Haproxy_55"></a>2.安装 Haproxy</h3> 
<pre><code class="prism language-handlebars"><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@Haproxy ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">wget</span> <span class="token variable">https</span><span class="token punctuation">:</span><span class="token punctuation">/</span><span class="token punctuation">/</span><span class="token variable">www</span><span class="token punctuation">.</span><span class="token variable">haproxy</span><span class="token punctuation">.</span><span class="token variable">org</span><span class="token punctuation">/</span><span class="token variable">download</span><span class="token punctuation">/</span><span class="token number">2.6</span><span class="token block keyword">/src/haproxy-</span><span class="token number">2.6</span><span class="token number">.0</span><span class="token punctuation">.</span><span class="token variable">tar</span><span class="token punctuation">.</span><span class="token variable">gz</span>
<span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@Haproxy ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">ls</span>
<span class="token variable">anaconda-ks</span><span class="token punctuation">.</span><span class="token variable">cfg</span>  <span class="token variable">haproxy-</span><span class="token number">2.6</span><span class="token number">.0</span><span class="token punctuation">.</span><span class="token variable">tar</span><span class="token punctuation">.</span><span class="token variable">gz</span>
<span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@Haproxy ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">tar</span> <span class="token variable">xf</span> <span class="token variable">haproxy-</span><span class="token number">2.6</span><span class="token number">.0</span><span class="token punctuation">.</span><span class="token variable">tar</span><span class="token punctuation">.</span><span class="token variable">gz</span> <span class="token variable">-C</span> <span class="token punctuation">/</span><span class="token variable">usr</span><span class="token punctuation">/</span><span class="token variable">src</span><span class="token punctuation">/</span>
<span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@Haproxy ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">cd</span> <span class="token punctuation">/</span><span class="token variable">usr</span><span class="token punctuation">/</span><span class="token variable">src</span><span class="token punctuation">/</span><span class="token variable">haproxy-</span><span class="token number">2.6</span><span class="token number">.0</span><span class="token punctuation">/</span>
<span class="token punctuation">[</span><span class="token variable">root</span><span class="token punctuation">@</span><span class="token variable">Haproxy</span> <span class="token variable">haproxy-</span><span class="token number">2.6</span><span class="token number">.0</span><span class="token punctuation">]</span><span class="token punctuation">#</span> <span class="token variable">make</span> <span class="token punctuation">\</span>
<span class="token variable">TARGET</span><span class="token punctuation">=</span><span class="token variable">linux$</span><span class="token punctuation">(</span><span class="token variable">uname</span> <span class="token variable">-r</span> <span class="token punctuation">|</span> <span class="token variable">awk</span> <span class="token variable">-F</span><span class="token punctuation">.</span> <span class="token string">'{print $1$2}'</span><span class="token punctuation">)</span> <span class="token variable">ARCH</span><span class="token punctuation">=</span><span class="token variable">$</span><span class="token punctuation">(</span><span class="token variable">uname</span> <span class="token variable">-r</span> <span class="token punctuation">|</span> <span class="token variable">awk</span> <span class="token variable">-F</span><span class="token punctuation">.</span> <span class="token string">'{print $NF}'</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token variable">root</span><span class="token punctuation">@</span><span class="token variable">Haproxy</span> <span class="token variable">haproxy-</span><span class="token number">2.6</span><span class="token number">.0</span><span class="token punctuation">]</span><span class="token punctuation">#</span> <span class="token variable">make</span> <span class="token variable">install</span> <span class="token variable">PREFIX</span><span class="token punctuation">=</span><span class="token punctuation">/</span><span class="token variable">usr</span><span class="token punctuation">/</span><span class="token variable">local</span><span class="token punctuation">/</span><span class="token variable">haproxy</span>
</code></pre> 
<ul><li><code>TARGET</code> 和 <code>ARCH</code>：分别对应系统的<strong>内核版本和系统位数。</strong></li></ul> 
<h3><a id="3_Haproxy__67"></a>3.修改 Haproxy 配置文件</h3> 
<pre><code class="prism language-handlebars"><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@Haproxy ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">vim</span> <span class="token punctuation">/</span><span class="token variable">usr</span><span class="token punctuation">/</span><span class="token variable">local</span><span class="token punctuation">/</span><span class="token variable">haproxy</span><span class="token punctuation">/</span><span class="token variable">haproxy</span><span class="token punctuation">.</span><span class="token variable">cfg</span>
<span class="token variable">global</span>
  <span class="token variable">log</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span> <span class="token variable">local0</span> <span class="token variable">info</span>
  <span class="token variable">log</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span> <span class="token variable">local1</span> <span class="token variable">notice</span>
  <span class="token variable">maxconn</span> <span class="token number">204800</span>										<span class="token punctuation">#</span> <span class="token variable">最大连接数</span>
  <span class="token variable">chroot</span> <span class="token punctuation">/</span><span class="token variable">usr</span><span class="token punctuation">/</span><span class="token variable">local</span><span class="token punctuation">/</span><span class="token variable">haproxy</span>								<span class="token punctuation">#</span> 
  <span class="token variable">pidfile</span> <span class="token punctuation">/</span><span class="token variable">usr</span><span class="token punctuation">/</span><span class="token variable">local</span><span class="token punctuation">/</span><span class="token variable">haproxy</span><span class="token punctuation">/</span><span class="token variable">haproxy</span><span class="token punctuation">.</span><span class="token variable">pid</span>				<span class="token punctuation">#</span> <span class="token variable">进程文件位置</span>
  <span class="token variable">uid</span> <span class="token number">99</span>												<span class="token punctuation">#</span> <span class="token variable">运行用户的</span> <span class="token variable">UID</span> <span class="token punctuation">(</span><span class="token variable">对应的用户是</span> <span class="token variable">nobody</span><span class="token punctuation">)</span>
  <span class="token variable">gid</span> <span class="token number">99</span>												<span class="token punctuation">#</span> <span class="token variable">运行组的</span> <span class="token variable">GID</span>
  <span class="token variable">daemon</span>												<span class="token punctuation">#</span> <span class="token variable">后台启动</span>

<span class="token variable">defaults</span>
  <span class="token variable">log</span> <span class="token variable">global</span>											<span class="token punctuation">#</span> <span class="token variable">引用</span> <span class="token variable">global</span> <span class="token variable">定义的日志格式</span>
  <span class="token variable">mode</span> <span class="token variable">http</span>												<span class="token punctuation">#</span> <span class="token variable">代理模式为</span> <span class="token variable">HTTP</span>
  <span class="token variable">option</span> <span class="token variable">httplog</span>										<span class="token punctuation">#</span> <span class="token variable">采用</span> <span class="token variable">HTTP</span> <span class="token variable">日志格式记录日志</span>
  <span class="token variable">option</span> <span class="token variable">httpclose</span>										<span class="token punctuation">#</span> <span class="token variable">请求完成后主动关闭</span> <span class="token variable">HTTP</span> <span class="token variable">通道</span>
  <span class="token variable">option</span> <span class="token variable">dontlognull</span>									<span class="token punctuation">#</span> <span class="token variable">禁止记录空连接日志记录</span>
  <span class="token variable">option</span> <span class="token variable">forwardfor</span>										<span class="token punctuation">#</span> <span class="token variable">将客户端真实IP发送至后端服务器</span>
  <span class="token variable">retries</span> <span class="token number">3</span>												<span class="token punctuation">#</span> <span class="token variable">最大失败次数</span>
  <span class="token variable">balance</span> <span class="token variable">leastconn</span>										<span class="token punctuation">#</span> <span class="token variable">基于最小连接数进行调度</span>
  <span class="token variable">timeout</span> <span class="token variable">connect</span> <span class="token number">10</span><span class="token variable">s</span>
  <span class="token variable">timeout</span> <span class="token variable">client</span>  <span class="token number">1</span><span class="token variable">m</span>
  <span class="token variable">timeout</span> <span class="token variable">server</span>  <span class="token number">1</span><span class="token variable">m</span>
  <span class="token variable">timeout</span> <span class="token variable">check</span>   <span class="token number">10</span><span class="token variable">s</span>

<span class="token variable">listen</span> <span class="token variable">admin_status</span>
  <span class="token variable">bind</span> <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token punctuation">:</span><span class="token number">8001</span>
  <span class="token variable">mode</span> <span class="token variable">http</span>
  <span class="token variable">stats</span> <span class="token variable">uri</span> <span class="token punctuation">/</span><span class="token variable">haproxy</span>									<span class="token punctuation">#</span> <span class="token variable">Haproxy</span> <span class="token variable">监控界面的</span> <span class="token variable">URL</span>
  <span class="token variable">stats</span> <span class="token variable">auth</span> <span class="token variable">admin</span><span class="token punctuation">:</span><span class="token number">123123</span>
  <span class="token variable">stats</span> <span class="token variable">hide-version</span>									<span class="token punctuation">#</span> <span class="token variable">隐藏</span> <span class="token variable">Haproxy</span> <span class="token variable">监控界面的版本号</span>

<span class="token variable">listen</span> <span class="token variable">nginx_upstream</span>
  <span class="token variable">bind</span> <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token punctuation">:</span><span class="token number">8080</span>
  <span class="token variable">mode</span> <span class="token variable">http</span>
  <span class="token variable">server</span> <span class="token variable">nginx_1</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">80</span> <span class="token variable">check</span> <span class="token variable">inter</span> <span class="token number">10</span><span class="token variable">s</span> <span class="token variable">fall</span> <span class="token number">3</span>
  <span class="token variable">server</span> <span class="token variable">nginx_2</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.2</span><span class="token punctuation">:</span><span class="token number">80</span> <span class="token variable">check</span> <span class="token variable">inter</span> <span class="token number">10</span><span class="token variable">s</span> <span class="token variable">fall</span> <span class="token number">3</span>
</code></pre> 
<h3><a id="4_Haproxy__107"></a>4.启动 Haproxy 服务</h3> 
<p>1）启动 Haproxy 服务</p> 
<pre><code class="prism language-handlebars"><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@Haproxy ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token punctuation">/</span><span class="token variable">usr</span><span class="token punctuation">/</span><span class="token variable">local</span><span class="token punctuation">/</span><span class="token variable">haproxy</span><span class="token punctuation">/</span><span class="token variable">sbin</span><span class="token punctuation">/</span><span class="token variable">haproxy</span> <span class="token variable">-f</span> <span class="token punctuation">/</span><span class="token variable">usr</span><span class="token punctuation">/</span><span class="token variable">local</span><span class="token punctuation">/</span><span class="token variable">haproxy</span><span class="token punctuation">/</span><span class="token variable">haproxy</span><span class="token punctuation">.</span><span class="token variable">cfg</span>
<span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@Haproxy ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">ps</span> <span class="token variable">aux</span> <span class="token punctuation">|</span> <span class="token variable">grep</span> <span class="token variable">haproxy</span>
</code></pre> 
<p>2）修改 Rsyslog 配置文件</p> 
<p>Haproxy 在默认情况下并不会记录日志，除了需要在 Haproxy 配置文件内指定日志的输出外，还需要修改系统日志的配置文件。</p> 
<pre><code class="prism language-handlebars"><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@Haproxy ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">sed</span> <span class="token variable">-i</span> <span class="token string">'s/ModLoad imudp/^#//'</span> <span class="token block keyword">/etc/rsyslog.conf</span>
<span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@Haproxy ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">sed</span> <span class="token variable">-i</span> <span class="token string">'s/UDPServerRun 514/^#//'</span> <span class="token block keyword">/etc/rsyslog.conf</span>
<span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@Haproxy ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">echo</span> <span class="token string">"local0.info /usr/local/haproxy/logs/access.log"</span> <span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span> <span class="token punctuation">/</span><span class="token variable">etc</span><span class="token punctuation">/</span><span class="token variable">rsyslog</span><span class="token punctuation">.</span><span class="token variable">conf</span>
<span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@Haproxy ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">echo</span> <span class="token string">"local0.notice /usr/local/haproxy/logs/error.log"</span> <span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span> <span class="token punctuation">/</span><span class="token variable">etc</span><span class="token punctuation">/</span><span class="token variable">rsyslog</span><span class="token punctuation">.</span><span class="token variable">conf</span>
<span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@Haproxy ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">mkdir</span> <span class="token punctuation">/</span><span class="token variable">usr</span><span class="token punctuation">/</span><span class="token variable">local</span><span class="token punctuation">/</span><span class="token variable">haproxy</span><span class="token punctuation">/</span><span class="token variable">logs</span>
<span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@Haproxy ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">systemctl</span> <span class="token variable">restart</span> <span class="token variable">rsyslog</span>
</code></pre> 
<h3><a id="5_128"></a>5.验证</h3> 
<p>1）验证 LB（负载均衡）</p> 
<pre><code class="prism language-handlebars"><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@Haproxy ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">for</span> <span class="token variable">i</span> <span class="token variable">in</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token variable">seq</span> <span class="token number">1</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">do</span> <span class="token variable">curl</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.3</span><span class="token punctuation">:</span><span class="token number">8080</span><span class="token punctuation">;</span><span class="token variable">done</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/64/2a/EvlmRLki_o.png" alt="在这里插入图片描述"></p> 
<p>2）验证 HA（高可用）</p> 
<pre><code class="prism language-handlebars"><span class="token punctuation">[</span><span class="token variable">root</span><span class="token punctuation">@</span><span class="token variable">Nginx-</span><span class="token number">1</span> <span class="token punctuation">~</span><span class="token punctuation">]</span><span class="token punctuation">#</span> <span class="token punctuation">/</span><span class="token variable">usr</span><span class="token punctuation">/</span><span class="token variable">local</span><span class="token punctuation">/</span><span class="token variable">nginx</span><span class="token punctuation">/</span><span class="token variable">sbin</span><span class="token punctuation">/</span><span class="token variable">nginx</span> <span class="token variable">-s</span> <span class="token variable">stop</span>
</code></pre> 
<pre><code class="prism language-handlebars"><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@Haproxy ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">for</span> <span class="token variable">i</span> <span class="token variable">in</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token variable">seq</span> <span class="token number">1</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">do</span> <span class="token variable">curl</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.3</span><span class="token punctuation">:</span><span class="token number">8080</span><span class="token punctuation">;</span><span class="token variable">done</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/44/26/cKAX4xfU_o.png" alt="在这里插入图片描述"><br> 3）查看日志</p> 
<pre><code class="prism language-handlebars"><span class="token brackets"><span class="token punctuation">[</span><span class="token variable">root@Haproxy ~</span><span class="token punctuation">]</span></span><span class="token punctuation">#</span> <span class="token variable">tail</span> <span class="token punctuation">/</span><span class="token variable">usr</span><span class="token punctuation">/</span><span class="token variable">local</span><span class="token punctuation">/</span><span class="token variable">haproxy</span><span class="token punctuation">/</span><span class="token variable">logs</span><span class="token punctuation">/</span><span class="token variable">access</span><span class="token punctuation">.</span><span class="token variable">log</span>
<span class="token variable">Jul</span> <span class="token number">27</span> <span class="token number">10</span><span class="token punctuation">:</span><span class="token number">21</span><span class="token punctuation">:</span><span class="token number">24</span> <span class="token variable">localhost</span> <span class="token variable">haproxy</span><span class="token punctuation">[</span><span class="token number">19810</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">34478</span> <span class="token punctuation">[</span><span class="token number">27</span><span class="token block keyword">/Jul/</span><span class="token number">2022</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token number">21</span><span class="token punctuation">:</span><span class="token number">24.095</span><span class="token punctuation">]</span> <span class="token variable">nginx_upstream</span> <span class="token variable">nginx_upstream</span><span class="token punctuation">/</span><span class="token variable">nginx_2</span> <span class="token number">0</span><span class="token punctuation">/</span><span class="token number">0</span><span class="token punctuation">/</span><span class="token number">0</span><span class="token punctuation">/</span><span class="token number">0</span><span class="token punctuation">/</span><span class="token number">0</span> <span class="token number">200</span> <span class="token number">228</span> <span class="token variable">-</span> <span class="token variable">-</span> <span class="token variable">----</span> <span class="token number">1</span><span class="token punctuation">/</span><span class="token number">1</span><span class="token punctuation">/</span><span class="token number">0</span><span class="token punctuation">/</span><span class="token number">0</span><span class="token punctuation">/</span><span class="token number">0</span> <span class="token number">0</span><span class="token punctuation">/</span><span class="token number">0</span> <span class="token string">"GET / HTTP/1.1"</span>
<span class="token variable">Jul</span> <span class="token number">27</span> <span class="token number">10</span><span class="token punctuation">:</span><span class="token number">21</span><span class="token punctuation">:</span><span class="token number">25</span> <span class="token variable">localhost</span> <span class="token variable">haproxy</span><span class="token punctuation">[</span><span class="token number">19810</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">34480</span> <span class="token punctuation">[</span><span class="token number">27</span><span class="token block keyword">/Jul/</span><span class="token number">2022</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token number">21</span><span class="token punctuation">:</span><span class="token number">25.102</span><span class="token punctuation">]</span> <span class="token variable">nginx_upstream</span> <span class="token variable">nginx_upstream</span><span class="token punctuation">/</span><span class="token variable">nginx_2</span> <span class="token number">0</span><span class="token punctuation">/</span><span class="token number">0</span><span class="token punctuation">/</span><span class="token number">0</span><span class="token punctuation">/</span><span class="token number">0</span><span class="token punctuation">/</span><span class="token number">0</span> <span class="token number">200</span> <span class="token number">228</span> <span class="token variable">-</span> <span class="token variable">-</span> <span class="token variable">----</span> <span class="token number">1</span><span class="token punctuation">/</span><span class="token number">1</span><span class="token punctuation">/</span><span class="token number">0</span><span class="token punctuation">/</span><span class="token number">0</span><span class="token punctuation">/</span><span class="token number">0</span> <span class="token number">0</span><span class="token punctuation">/</span><span class="token number">0</span> <span class="token string">"GET / HTTP/1.1"</span>
<span class="token variable">Jul</span> <span class="token number">27</span> <span class="token number">10</span><span class="token punctuation">:</span><span class="token number">21</span><span class="token punctuation">:</span><span class="token number">26</span> <span class="token variable">localhost</span> <span class="token variable">haproxy</span><span class="token punctuation">[</span><span class="token number">19810</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">34482</span> <span class="token punctuation">[</span><span class="token number">27</span><span class="token block keyword">/Jul/</span><span class="token number">2022</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token number">21</span><span class="token punctuation">:</span><span class="token number">26.109</span><span class="token punctuation">]</span> <span class="token variable">nginx_upstream</span> <span class="token variable">nginx_upstream</span><span class="token punctuation">/</span><span class="token variable">nginx_2</span> <span class="token number">0</span><span class="token punctuation">/</span><span class="token number">0</span><span class="token punctuation">/</span><span class="token number">0</span><span class="token punctuation">/</span><span class="token number">0</span><span class="token punctuation">/</span><span class="token number">0</span> <span class="token number">200</span> <span class="token number">228</span> <span class="token variable">-</span> <span class="token variable">-</span> <span class="token variable">----</span> <span class="token number">1</span><span class="token punctuation">/</span><span class="token number">1</span><span class="token punctuation">/</span><span class="token number">0</span><span class="token punctuation">/</span><span class="token number">0</span><span class="token punctuation">/</span><span class="token number">0</span> <span class="token number">0</span><span class="token punctuation">/</span><span class="token number">0</span> <span class="token string">"GET / HTTP/1.1"</span>
<span class="token variable">Jul</span> <span class="token number">27</span> <span class="token number">10</span><span class="token punctuation">:</span><span class="token number">21</span><span class="token punctuation">:</span><span class="token number">27</span> <span class="token variable">localhost</span> <span class="token variable">haproxy</span><span class="token punctuation">[</span><span class="token number">19810</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">34484</span> <span class="token punctuation">[</span><span class="token number">27</span><span class="token block keyword">/Jul/</span><span class="token number">2022</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token number">21</span><span class="token punctuation">:</span><span class="token number">27.117</span><span class="token punctuation">]</span> <span class="token variable">nginx_upstream</span> <span class="token variable">nginx_upstream</span><span class="token punctuation">/</span><span class="token variable">nginx_2</span> <span class="token number">0</span><span class="token punctuation">/</span><span class="token number">0</span><span class="token punctuation">/</span><span class="token number">0</span><span class="token punctuation">/</span><span class="token number">0</span><span class="token punctuation">/</span><span class="token number">0</span> <span class="token number">200</span> <span class="token number">228</span> <span class="token variable">-</span> <span class="token variable">-</span> <span class="token variable">----</span> <span class="token number">1</span><span class="token punctuation">/</span><span class="token number">1</span><span class="token punctuation">/</span><span class="token number">0</span><span class="token punctuation">/</span><span class="token number">0</span><span class="token punctuation">/</span><span class="token number">0</span> <span class="token number">0</span><span class="token punctuation">/</span><span class="token number">0</span> <span class="token string">"GET / HTTP/1.1"</span>
<span class="token variable">Jul</span> <span class="token number">27</span> <span class="token number">10</span><span class="token punctuation">:</span><span class="token number">21</span><span class="token punctuation">:</span><span class="token number">28</span> <span class="token variable">localhost</span> <span class="token variable">haproxy</span><span class="token punctuation">[</span><span class="token number">19810</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">34486</span> <span class="token punctuation">[</span><span class="token number">27</span><span class="token block keyword">/Jul/</span><span class="token number">2022</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token number">21</span><span class="token punctuation">:</span><span class="token number">28.125</span><span class="token punctuation">]</span> <span class="token variable">nginx_upstream</span> <span class="token variable">nginx_upstream</span><span class="token punctuation">/</span><span class="token variable">nginx_2</span> <span class="token number">0</span><span class="token punctuation">/</span><span class="token number">0</span><span class="token punctuation">/</span><span class="token number">0</span><span class="token punctuation">/</span><span class="token number">0</span><span class="token punctuation">/</span><span class="token number">0</span> <span class="token number">200</span> <span class="token number">228</span> <span class="token variable">-</span> <span class="token variable">-</span> <span class="token variable">----</span> <span class="token number">1</span><span class="token punctuation">/</span><span class="token number">1</span><span class="token punctuation">/</span><span class="token number">0</span><span class="token punctuation">/</span><span class="token number">0</span><span class="token punctuation">/</span><span class="token number">0</span> <span class="token number">0</span><span class="token punctuation">/</span><span class="token number">0</span> <span class="token string">"GET / HTTP/1.1"</span>
</code></pre> 
<p>4）查看 Haproxy 监控界面</p> 
<p><img src="https://images2.imgbox.com/4c/07/x98d9f2v_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b9bd3b1c148ba30ad017ffbe191e766a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">基础复习——项目练习——计算器</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4f4457e966c021eee733489457dd2229/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">SQL后计算的利器</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>