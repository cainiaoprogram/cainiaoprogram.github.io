<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>了解一下InternLM3 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="了解一下InternLM3" />
<meta property="og:description" content="在 InternStudio 平台中选择 A100(1/4) 的配置，如下图所示镜像选择 Cuda11.7-conda，接下来打开刚刚租用服务器的进入开发机，并且打开其中的终端开始环境配置、模型下载和运行 demo。入开发机后，在页面的左上角可以切换 JupyterLab、终端和 VScode，并在终端输入 bash 命令，进入 conda 环境。如下图所示：
进入 conda 环境之后，使用以下命令从本地克隆一个已有的 pytorch 2.0.1 的环境,，需要等3分钟左右把
bash # 请每次使用 jupyter lab 打开终端时务必先执行 bash 命令进入 bash 中 /root/share/install_conda_env_internlm_base.sh LLMwinter 然后使用以下命令激活环境 conda activate LLMwinter 并在环境中安装运行 demo 所需要的依赖。 # 升级pip python -m pip install --upgrade pip pip install modelscope==1.9.5 pip install transformers==4.35.2 pip install streamlit==1.24.0 pip install sentencepiece==0.1.99 pip install accelerate==0.24.1 InternStudio 平台的 share 目录下已经为我们准备了全系列的 InternLM 模型，所以我们可以直接复制即可。使用如下命令复制： mkdir -p /root/model/winterLLMfiles cp -r /root/share/temp/model_repos/internlm-chat-7b /root/model/winterLLMfiles -r 选项表示递归地复制目录及其内容" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/3deaf685efde7eaafae24459f8a32d05/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-07T18:47:44+08:00" />
<meta property="article:modified_time" content="2024-01-07T18:47:44+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">了解一下InternLM3</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <ul><li> <p>在 <a href="https://studio.intern-ai.org.cn/" rel="nofollow">InternStudio</a> 平台中选择 A100(1/4) 的配置，如下图所示镜像选择 <code>Cuda11.7-conda</code>，接下来打开刚刚租用服务器的<code>进入开发机</code>，并且打开其中的终端开始环境配置、模型下载和运行 <code>demo</code>。入开发机后，在页面的左上角可以切换 <code>JupyterLab</code>、<code>终端</code>和 <code>VScode</code>，并在终端输入 <code>bash</code> 命令，进入 <code>conda</code> 环境。如下图所示：</p> 
  <ul><li><img src="https://images2.imgbox.com/9e/74/5Gt9akdu_o.png" alt="在这里插入图片描述"></li></ul> </li><li> <p>进入 <code>conda</code> 环境之后，使用以下命令从本地克隆一个已有的 <code>pytorch 2.0.1</code> 的环境,，需要等3分钟左右把</p> </li></ul> 
<pre><code class="prism language-shell"><span class="token function">bash</span> <span class="token comment"># 请每次使用 jupyter lab 打开终端时务必先执行 bash 命令进入 bash 中</span>
/root/share/install_conda_env_internlm_base.sh LLMwinter
</code></pre> 
<ul><li>然后使用以下命令激活环境</li></ul> 
<pre><code class="prism language-shell">conda activate LLMwinter
</code></pre> 
<ul><li>并在环境中安装运行 demo 所需要的依赖。</li></ul> 
<pre><code class="prism language-shell"><span class="token comment"># 升级pip</span>
python <span class="token parameter variable">-m</span> pip <span class="token function">install</span> <span class="token parameter variable">--upgrade</span> pip
pip <span class="token function">install</span> <span class="token assign-left variable">modelscope</span><span class="token operator">==</span><span class="token number">1.9</span>.5
pip <span class="token function">install</span> <span class="token assign-left variable">transformers</span><span class="token operator">==</span><span class="token number">4.35</span>.2
pip <span class="token function">install</span> <span class="token assign-left variable">streamlit</span><span class="token operator">==</span><span class="token number">1.24</span>.0
pip <span class="token function">install</span> <span class="token assign-left variable">sentencepiece</span><span class="token operator">==</span><span class="token number">0.1</span>.99
pip <span class="token function">install</span> <span class="token assign-left variable">accelerate</span><span class="token operator">==</span><span class="token number">0.24</span>.1
</code></pre> 
<ul><li><a href="https://studio.intern-ai.org.cn/" rel="nofollow">InternStudio</a> 平台的 <code>share</code> 目录下已经为我们准备了全系列的 <code>InternLM</code> 模型，所以我们可以直接复制即可。使用如下命令复制：</li></ul> 
<pre><code class="prism language-shell"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /root/model/winterLLMfiles
<span class="token function">cp</span> <span class="token parameter variable">-r</span> /root/share/temp/model_repos/internlm-chat-7b /root/model/winterLLMfiles
</code></pre> 
<blockquote> 
 <p>-r 选项表示递归地复制目录及其内容</p> 
</blockquote> 
<ul><li> <p><img src="https://images2.imgbox.com/b2/a3/TJlAPL0O_o.png" alt="在这里插入图片描述"></p> </li><li> <p>也可以使用 <code>modelscope</code> 中的 <code>snapshot_download</code> 函数下载模型，第一个参数为模型名称，参数 <code>cache_dir</code> 为模型的下载路径。在 <code>/root</code> 路径下新建目录 <code>model</code>，在目录下新建 <code>download.py</code> 文件并在其中输入以下内容，粘贴代码后记得保存文件，如下图所示。并运行 <code>python /root/model/download.py</code> 执行下载，模型大小为 14 GB，下载模型大概需要 10~20 分钟</p> </li></ul> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">from</span> modelscope <span class="token keyword">import</span> snapshot_download<span class="token punctuation">,</span> AutoModel<span class="token punctuation">,</span> AutoTokenizer
<span class="token keyword">import</span> os
model_dir <span class="token operator">=</span> snapshot_download<span class="token punctuation">(</span><span class="token string">'winterLLMfiles/internlm-chat-7b'</span><span class="token punctuation">,</span> cache_dir<span class="token operator">=</span><span class="token string">'/root/model'</span><span class="token punctuation">,</span> revision<span class="token operator">=</span><span class="token string">'v1.0.3'</span><span class="token punctuation">)</span>
</code></pre> 
<blockquote> 
 <p>注意：使用 <code>pwd</code> 命令可以查看当前的路径，<code>JupyterLab</code> 左侧目录栏显示为 <code>/root/</code> 下的路径。</p> 
</blockquote> 
<ul><li>首先 <code>clone</code> 代码，在 <code>/root</code> 路径下新建 <code>code</code> 目录，然后切换路径, clone 代码.</li></ul> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /root/code
<span class="token function">git</span> clone https://gitee.com/internlm/InternLM.git
</code></pre> 
<ul><li> <p><img src="https://images2.imgbox.com/d8/e5/xN6hPS2N_o.png" alt="在这里插入图片描述"></p> </li><li> <p>切换 commit 版本，与教程 commit 版本保持一致，可以让大家更好的复现。</p> </li></ul> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> InternLM
<span class="token function">git</span> checkout 3028f07cb79e5b1d7342f4ad8d11efad3fd13d17
</code></pre> 
<ul><li> <p>将 <code>/root/code/InternLM/web_demo.py</code> 中 29 行和 33 行的模型更换为本地的 <code>/root/model/winterLLMfiles/internlm-chat-7b</code>。</p> </li><li> <p><img src="https://images2.imgbox.com/ef/78/6fTJTm9W_o.png" alt="在这里插入图片描述"></p> </li></ul> 
<p>我们可以在 <code>/root/code/InternLM</code> 目录下新建一个 <code>cli_demo.py</code> 文件，将以下代码填入其中：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">from</span> transformers <span class="token keyword">import</span> AutoTokenizer<span class="token punctuation">,</span> AutoModelForCausalLM


model_name_or_path <span class="token operator">=</span> <span class="token string">"/root/model/winterLLMfiles/internlm-chat-7b"</span>

tokenizer <span class="token operator">=</span> AutoTokenizer<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span>model_name_or_path<span class="token punctuation">,</span> trust_remote_code<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
model <span class="token operator">=</span> AutoModelForCausalLM<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span>model_name_or_path<span class="token punctuation">,</span> trust_remote_code<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> torch_dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>bfloat16<span class="token punctuation">,</span> device_map<span class="token operator">=</span><span class="token string">'auto'</span><span class="token punctuation">)</span>
model <span class="token operator">=</span> model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

system_prompt <span class="token operator">=</span> <span class="token triple-quoted-string string">"""You are an AI assistant whose name is InternLM (书生·浦语).
- InternLM (书生·浦语) is a conversational language model that is developed by Shanghai AI Laboratory (上海人工智能实验室). It is designed to be helpful, honest, and harmless.
- InternLM (书生·浦语) can understand and communicate fluently in the language chosen by the user such as English and 中文.
"""</span>

messages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>system_prompt<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"=============Welcome to InternLM chatbot, type 'exit' to exit.============="</span><span class="token punctuation">)</span>

<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    input_text <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"User  &gt;&gt;&gt; "</span><span class="token punctuation">)</span>
    input_text <span class="token operator">=</span> input_text<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> input_text <span class="token operator">==</span> <span class="token string">"exit"</span><span class="token punctuation">:</span>
        <span class="token keyword">break</span>
    response<span class="token punctuation">,</span> history <span class="token operator">=</span> model<span class="token punctuation">.</span>chat<span class="token punctuation">(</span>tokenizer<span class="token punctuation">,</span> input_text<span class="token punctuation">,</span> history<span class="token operator">=</span>messages<span class="token punctuation">)</span>
    messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>input_text<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"robot &gt;&gt;&gt; </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>response<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</code></pre> 
<ul><li>然后在终端运行以下命令，即可体验 <code>InternLM-Chat-7B</code> 模型的对话能力。对话效果如下所示：</li></ul> 
<pre><code class="prism language-shell">python /root/code/InternLM/cli_demo.py
</code></pre> 
<ul><li> <p>报错？？</p> </li><li> <p><img src="https://images2.imgbox.com/5f/6c/j8wpghDr_o.png" alt="在这里插入图片描述"></p> </li><li> <p>调整一下重启，注意输入合法：</p> </li><li> <p><img src="https://images2.imgbox.com/96/e7/nX3eUigX_o.png" alt="在这里插入图片描述"></p> </li><li> <p>好的，下次探索把，官方教程放下面了。下机，不要浪费资源</p> </li></ul> 
<pre><code class="prism language-shell"><span class="token function">bash</span>
conda activate internlm-demo  <span class="token comment"># 首次进入 vscode 会默认是 base 环境，所以首先切换环境</span>
<span class="token builtin class-name">cd</span> /root/code/InternLM
streamlit run web_demo.py <span class="token parameter variable">--server.address</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">--server.port</span> <span class="token number">6006</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/c0/0c/9mNI3jwo_o.png" alt="在这里插入图片描述"></p> 
<p>注意：要在浏览器打开 <code>http://127.0.0.1:6006</code> 页面后，模型才会加载，如下图所示：</p> 
<p><img src="https://images2.imgbox.com/14/45/YLuUpPqh_o.png" alt="在这里插入图片描述"></p> 
<p>在加载完模型之后，就可以与 InternLM-Chat-7B 进行对话了，如下图所示：</p> 
<p><img src="https://images2.imgbox.com/ba/df/bWEjMTFd_o.png" alt="在这里插入图片描述"></p> 
<p>Lagent 智能体工具调用 Demo</p> 
<p>本小节我们将使用 <a href="https://studio.intern-ai.org.cn/" rel="nofollow">InternStudio</a> 中的 A100(1/4) 机器、<code>InternLM-Chat-7B</code> 模型和 <code>Lagent</code> 框架部署一个智能工具调用 Demo。</p> 
<p>Lagent 是一个轻量级、开源的基于大语言模型的智能体（agent）框架，支持用户快速地将一个大语言模型转变为多种类型的智能体，并提供了一些典型工具为大语言模型赋能。通过 Lagent 框架可以更好的发挥 InternLM 的全部性能。</p> 
<p>下面我们就开始动手实现！</p> 
<p>选择和第一个 <code>InternLM</code> 一样的镜像环境，运行以下命令安装依赖，如果上一个 <code>InternLM-Chat-7B</code> 已经配置好环境不需要重复安装.</p> 
<pre><code class="prism language-shell"><span class="token comment"># 升级pip</span>
python <span class="token parameter variable">-m</span> pip <span class="token function">install</span> <span class="token parameter variable">--upgrade</span> pip

pip <span class="token function">install</span> <span class="token assign-left variable">modelscope</span><span class="token operator">==</span><span class="token number">1.9</span>.5
pip <span class="token function">install</span> <span class="token assign-left variable">transformers</span><span class="token operator">==</span><span class="token number">4.35</span>.2
pip <span class="token function">install</span> <span class="token assign-left variable">streamlit</span><span class="token operator">==</span><span class="token number">1.24</span>.0
pip <span class="token function">install</span> <span class="token assign-left variable">sentencepiece</span><span class="token operator">==</span><span class="token number">0.1</span>.99
pip <span class="token function">install</span> <span class="token assign-left variable">accelerate</span><span class="token operator">==</span><span class="token number">0.24</span>.1
</code></pre> 
<p><a href="https://studio.intern-ai.org.cn/" rel="nofollow">InternStudio</a> 平台的 <code>share</code> 目录下已经为我们准备了全系列的 <code>InternLM</code> 模型，所以我们可以直接复制即可。使用如下命令复制：</p> 
<pre><code class="prism language-shell"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /root/model/Shanghai_AI_Laboratory
<span class="token function">cp</span> <span class="token parameter variable">-r</span> /root/share/temp/model_repos/internlm-chat-7b /root/model/Shanghai_AI_Laboratory
</code></pre> 
<blockquote> 
 <p>-r 选项表示递归地复制目录及其内容</p> 
</blockquote> 
<p>也可以在 <code>/root/model</code> 路径下新建 <code>download.py</code> 文件并在其中输入以下内容，并运行 <code>python /root/model/download.py</code> 执行下载，模型大小为 14 GB，下载模型大概需要 10~20 分钟</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">from</span> modelscope <span class="token keyword">import</span> snapshot_download<span class="token punctuation">,</span> AutoModel<span class="token punctuation">,</span> AutoTokenizer
<span class="token keyword">import</span> os
model_dir <span class="token operator">=</span> snapshot_download<span class="token punctuation">(</span><span class="token string">'Shanghai_AI_Laboratory/internlm-chat-7b'</span><span class="token punctuation">,</span> cache_dir<span class="token operator">=</span><span class="token string">'/root/model'</span><span class="token punctuation">,</span> revision<span class="token operator">=</span><span class="token string">'v1.0.3'</span><span class="token punctuation">)</span>
</code></pre> 
<p>首先切换路径到 <code>/root/code</code> 克隆 <code>lagent</code> 仓库，并通过 <code>pip install -e .</code> 源码安装 <code>Lagent</code></p> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /root/code
<span class="token function">git</span> clone https://gitee.com/internlm/lagent.git
<span class="token builtin class-name">cd</span> /root/code/lagent
<span class="token function">git</span> checkout 511b03889010c4811b1701abb153e02b8e94fb5e <span class="token comment"># 尽量保证和教程commit版本一致</span>
pip <span class="token function">install</span> <span class="token parameter variable">-e</span> <span class="token builtin class-name">.</span> <span class="token comment"># 源码安装</span>
</code></pre> 
<p>由于代码修改的地方比较多，大家直接将 <code>/root/code/lagent/examples/react_web_demo.py</code> 内容替换为以下代码</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> copy
<span class="token keyword">import</span> os

<span class="token keyword">import</span> streamlit <span class="token keyword">as</span> st
<span class="token keyword">from</span> streamlit<span class="token punctuation">.</span>logger <span class="token keyword">import</span> get_logger

<span class="token keyword">from</span> lagent<span class="token punctuation">.</span>actions <span class="token keyword">import</span> ActionExecutor<span class="token punctuation">,</span> GoogleSearch<span class="token punctuation">,</span> PythonInterpreter
<span class="token keyword">from</span> lagent<span class="token punctuation">.</span>agents<span class="token punctuation">.</span>react <span class="token keyword">import</span> ReAct
<span class="token keyword">from</span> lagent<span class="token punctuation">.</span>llms <span class="token keyword">import</span> GPTAPI
<span class="token keyword">from</span> lagent<span class="token punctuation">.</span>llms<span class="token punctuation">.</span>huggingface <span class="token keyword">import</span> HFTransformerCasualLM


<span class="token keyword">class</span> <span class="token class-name">SessionState</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">init_state</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Initialize session state variables."""</span>
        st<span class="token punctuation">.</span>session_state<span class="token punctuation">[</span><span class="token string">'assistant'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        st<span class="token punctuation">.</span>session_state<span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

        <span class="token comment">#action_list = [PythonInterpreter(), GoogleSearch()]</span>
        action_list <span class="token operator">=</span> <span class="token punctuation">[</span>PythonInterpreter<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        st<span class="token punctuation">.</span>session_state<span class="token punctuation">[</span><span class="token string">'plugin_map'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            action<span class="token punctuation">.</span>name<span class="token punctuation">:</span> action
            <span class="token keyword">for</span> action <span class="token keyword">in</span> action_list
        <span class="token punctuation">}</span>
        st<span class="token punctuation">.</span>session_state<span class="token punctuation">[</span><span class="token string">'model_map'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        st<span class="token punctuation">.</span>session_state<span class="token punctuation">[</span><span class="token string">'model_selected'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
        st<span class="token punctuation">.</span>session_state<span class="token punctuation">[</span><span class="token string">'plugin_actions'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">clear_state</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Clear the existing session state."""</span>
        st<span class="token punctuation">.</span>session_state<span class="token punctuation">[</span><span class="token string">'assistant'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        st<span class="token punctuation">.</span>session_state<span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        st<span class="token punctuation">.</span>session_state<span class="token punctuation">[</span><span class="token string">'model_selected'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
        <span class="token keyword">if</span> <span class="token string">'chatbot'</span> <span class="token keyword">in</span> st<span class="token punctuation">.</span>session_state<span class="token punctuation">:</span>
            st<span class="token punctuation">.</span>session_state<span class="token punctuation">[</span><span class="token string">'chatbot'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>_session_history <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>


<span class="token keyword">class</span> <span class="token class-name">StreamlitUI</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> session_state<span class="token punctuation">:</span> SessionState<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>init_streamlit<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>session_state <span class="token operator">=</span> session_state

    <span class="token keyword">def</span> <span class="token function">init_streamlit</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Initialize Streamlit's UI settings."""</span>
        st<span class="token punctuation">.</span>set_page_config<span class="token punctuation">(</span>
            layout<span class="token operator">=</span><span class="token string">'wide'</span><span class="token punctuation">,</span>
            page_title<span class="token operator">=</span><span class="token string">'lagent-web'</span><span class="token punctuation">,</span>
            page_icon<span class="token operator">=</span><span class="token string">'./docs/imgs/lagent_icon.png'</span><span class="token punctuation">)</span>
        <span class="token comment"># st.header(':robot_face: :blue[Lagent] Web Demo ', divider='rainbow')</span>
        st<span class="token punctuation">.</span>sidebar<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'模型控制'</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">setup_sidebar</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Setup the sidebar for model and plugin selection."""</span>
        model_name <span class="token operator">=</span> st<span class="token punctuation">.</span>sidebar<span class="token punctuation">.</span>selectbox<span class="token punctuation">(</span>
            <span class="token string">'模型选择：'</span><span class="token punctuation">,</span> options<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'gpt-3.5-turbo'</span><span class="token punctuation">,</span><span class="token string">'internlm'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> model_name <span class="token operator">!=</span> st<span class="token punctuation">.</span>session_state<span class="token punctuation">[</span><span class="token string">'model_selected'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            model <span class="token operator">=</span> self<span class="token punctuation">.</span>init_model<span class="token punctuation">(</span>model_name<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>session_state<span class="token punctuation">.</span>clear_state<span class="token punctuation">(</span><span class="token punctuation">)</span>
            st<span class="token punctuation">.</span>session_state<span class="token punctuation">[</span><span class="token string">'model_selected'</span><span class="token punctuation">]</span> <span class="token operator">=</span> model_name
            <span class="token keyword">if</span> <span class="token string">'chatbot'</span> <span class="token keyword">in</span> st<span class="token punctuation">.</span>session_state<span class="token punctuation">:</span>
                <span class="token keyword">del</span> st<span class="token punctuation">.</span>session_state<span class="token punctuation">[</span><span class="token string">'chatbot'</span><span class="token punctuation">]</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            model <span class="token operator">=</span> st<span class="token punctuation">.</span>session_state<span class="token punctuation">[</span><span class="token string">'model_map'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>model_name<span class="token punctuation">]</span>

        plugin_name <span class="token operator">=</span> st<span class="token punctuation">.</span>sidebar<span class="token punctuation">.</span>multiselect<span class="token punctuation">(</span>
            <span class="token string">'插件选择'</span><span class="token punctuation">,</span>
            options<span class="token operator">=</span><span class="token builtin">list</span><span class="token punctuation">(</span>st<span class="token punctuation">.</span>session_state<span class="token punctuation">[</span><span class="token string">'plugin_map'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            default<span class="token operator">=</span><span class="token punctuation">[</span><span class="token builtin">list</span><span class="token punctuation">(</span>st<span class="token punctuation">.</span>session_state<span class="token punctuation">[</span><span class="token string">'plugin_map'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

        plugin_action <span class="token operator">=</span> <span class="token punctuation">[</span>
            st<span class="token punctuation">.</span>session_state<span class="token punctuation">[</span><span class="token string">'plugin_map'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token keyword">for</span> name <span class="token keyword">in</span> plugin_name
        <span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token string">'chatbot'</span> <span class="token keyword">in</span> st<span class="token punctuation">.</span>session_state<span class="token punctuation">:</span>
            st<span class="token punctuation">.</span>session_state<span class="token punctuation">[</span><span class="token string">'chatbot'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>_action_executor <span class="token operator">=</span> ActionExecutor<span class="token punctuation">(</span>
                actions<span class="token operator">=</span>plugin_action<span class="token punctuation">)</span>
        <span class="token keyword">if</span> st<span class="token punctuation">.</span>sidebar<span class="token punctuation">.</span>button<span class="token punctuation">(</span><span class="token string">'清空对话'</span><span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token string">'clear'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>session_state<span class="token punctuation">.</span>clear_state<span class="token punctuation">(</span><span class="token punctuation">)</span>
        uploaded_file <span class="token operator">=</span> st<span class="token punctuation">.</span>sidebar<span class="token punctuation">.</span>file_uploader<span class="token punctuation">(</span>
            <span class="token string">'上传文件'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'png'</span><span class="token punctuation">,</span> <span class="token string">'jpg'</span><span class="token punctuation">,</span> <span class="token string">'jpeg'</span><span class="token punctuation">,</span> <span class="token string">'mp4'</span><span class="token punctuation">,</span> <span class="token string">'mp3'</span><span class="token punctuation">,</span> <span class="token string">'wav'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> model_name<span class="token punctuation">,</span> model<span class="token punctuation">,</span> plugin_action<span class="token punctuation">,</span> uploaded_file

    <span class="token keyword">def</span> <span class="token function">init_model</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> option<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Initialize the model based on the selected option."""</span>
        <span class="token keyword">if</span> option <span class="token keyword">not</span> <span class="token keyword">in</span> st<span class="token punctuation">.</span>session_state<span class="token punctuation">[</span><span class="token string">'model_map'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> option<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'gpt'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                st<span class="token punctuation">.</span>session_state<span class="token punctuation">[</span><span class="token string">'model_map'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>option<span class="token punctuation">]</span> <span class="token operator">=</span> GPTAPI<span class="token punctuation">(</span>
                    model_type<span class="token operator">=</span>option<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                st<span class="token punctuation">.</span>session_state<span class="token punctuation">[</span><span class="token string">'model_map'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>option<span class="token punctuation">]</span> <span class="token operator">=</span> HFTransformerCasualLM<span class="token punctuation">(</span>
                    <span class="token string">'/root/model/Shanghai_AI_Laboratory/internlm-chat-7b'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> st<span class="token punctuation">.</span>session_state<span class="token punctuation">[</span><span class="token string">'model_map'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>option<span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">initialize_chatbot</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> model<span class="token punctuation">,</span> plugin_action<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Initialize the chatbot with the given model and plugin actions."""</span>
        <span class="token keyword">return</span> ReAct<span class="token punctuation">(</span>
            llm<span class="token operator">=</span>model<span class="token punctuation">,</span> action_executor<span class="token operator">=</span>ActionExecutor<span class="token punctuation">(</span>actions<span class="token operator">=</span>plugin_action<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">render_user</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> prompt<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> st<span class="token punctuation">.</span>chat_message<span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            st<span class="token punctuation">.</span>markdown<span class="token punctuation">(</span>prompt<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">render_assistant</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> agent_return<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> st<span class="token punctuation">.</span>chat_message<span class="token punctuation">(</span><span class="token string">'assistant'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> action <span class="token keyword">in</span> agent_return<span class="token punctuation">.</span>actions<span class="token punctuation">:</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    self<span class="token punctuation">.</span>render_action<span class="token punctuation">(</span>action<span class="token punctuation">)</span>
            st<span class="token punctuation">.</span>markdown<span class="token punctuation">(</span>agent_return<span class="token punctuation">.</span>response<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">render_action</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> st<span class="token punctuation">.</span>expander<span class="token punctuation">(</span>action<span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">,</span> expanded<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            st<span class="token punctuation">.</span>markdown<span class="token punctuation">(</span>
                <span class="token string">"&lt;p style='text-align: left;display:flex;'&gt; &lt;span style='font-size:14px;font-weight:600;width:70px;text-align-last: justify;'&gt;插    件&lt;/span&gt;&lt;span style='width:14px;text-align:left;display:block;'&gt;:&lt;/span&gt;&lt;span style='flex:1;'&gt;"</span>  <span class="token comment"># noqa E501</span>
                <span class="token operator">+</span> action<span class="token punctuation">.</span><span class="token builtin">type</span> <span class="token operator">+</span> <span class="token string">'&lt;/span&gt;&lt;/p&gt;'</span><span class="token punctuation">,</span>
                unsafe_allow_html<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
            st<span class="token punctuation">.</span>markdown<span class="token punctuation">(</span>
                <span class="token string">"&lt;p style='text-align: left;display:flex;'&gt; &lt;span style='font-size:14px;font-weight:600;width:70px;text-align-last: justify;'&gt;思考步骤&lt;/span&gt;&lt;span style='width:14px;text-align:left;display:block;'&gt;:&lt;/span&gt;&lt;span style='flex:1;'&gt;"</span>  <span class="token comment"># noqa E501</span>
                <span class="token operator">+</span> action<span class="token punctuation">.</span>thought <span class="token operator">+</span> <span class="token string">'&lt;/span&gt;&lt;/p&gt;'</span><span class="token punctuation">,</span>
                unsafe_allow_html<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">isinstance</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>args<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token string">'text'</span> <span class="token keyword">in</span> action<span class="token punctuation">.</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
                st<span class="token punctuation">.</span>markdown<span class="token punctuation">(</span>
                    <span class="token string">"&lt;p style='text-align: left;display:flex;'&gt;&lt;span style='font-size:14px;font-weight:600;width:70px;text-align-last: justify;'&gt; 执行内容&lt;/span&gt;&lt;span style='width:14px;text-align:left;display:block;'&gt;:&lt;/span&gt;&lt;/p&gt;"</span><span class="token punctuation">,</span>  <span class="token comment"># noqa E501</span>
                    unsafe_allow_html<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
                st<span class="token punctuation">.</span>markdown<span class="token punctuation">(</span>action<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token string">'text'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>render_action_results<span class="token punctuation">(</span>action<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">render_action_results</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Render the results of action, including text, images, videos, and
        audios."""</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">isinstance</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>result<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            st<span class="token punctuation">.</span>markdown<span class="token punctuation">(</span>
                <span class="token string">"&lt;p style='text-align: left;display:flex;'&gt;&lt;span style='font-size:14px;font-weight:600;width:70px;text-align-last: justify;'&gt; 执行结果&lt;/span&gt;&lt;span style='width:14px;text-align:left;display:block;'&gt;:&lt;/span&gt;&lt;/p&gt;"</span><span class="token punctuation">,</span>  <span class="token comment"># noqa E501</span>
                unsafe_allow_html<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token string">'text'</span> <span class="token keyword">in</span> action<span class="token punctuation">.</span>result<span class="token punctuation">:</span>
                st<span class="token punctuation">.</span>markdown<span class="token punctuation">(</span>
                    <span class="token string">"&lt;p style='text-align: left;'&gt;"</span> <span class="token operator">+</span> action<span class="token punctuation">.</span>result<span class="token punctuation">[</span><span class="token string">'text'</span><span class="token punctuation">]</span> <span class="token operator">+</span>
                    <span class="token string">'&lt;/p&gt;'</span><span class="token punctuation">,</span>
                    unsafe_allow_html<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token string">'image'</span> <span class="token keyword">in</span> action<span class="token punctuation">.</span>result<span class="token punctuation">:</span>
                image_path <span class="token operator">=</span> action<span class="token punctuation">.</span>result<span class="token punctuation">[</span><span class="token string">'image'</span><span class="token punctuation">]</span>
                image_data <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>image_path<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
                st<span class="token punctuation">.</span>image<span class="token punctuation">(</span>image_data<span class="token punctuation">,</span> caption<span class="token operator">=</span><span class="token string">'Generated Image'</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token string">'video'</span> <span class="token keyword">in</span> action<span class="token punctuation">.</span>result<span class="token punctuation">:</span>
                video_data <span class="token operator">=</span> action<span class="token punctuation">.</span>result<span class="token punctuation">[</span><span class="token string">'video'</span><span class="token punctuation">]</span>
                video_data <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>video_data<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
                st<span class="token punctuation">.</span>video<span class="token punctuation">(</span>video_data<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token string">'audio'</span> <span class="token keyword">in</span> action<span class="token punctuation">.</span>result<span class="token punctuation">:</span>
                audio_data <span class="token operator">=</span> action<span class="token punctuation">.</span>result<span class="token punctuation">[</span><span class="token string">'audio'</span><span class="token punctuation">]</span>
                audio_data <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>audio_data<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
                st<span class="token punctuation">.</span>audio<span class="token punctuation">(</span>audio_data<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    logger <span class="token operator">=</span> get_logger<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
    <span class="token comment"># Initialize Streamlit UI and setup sidebar</span>
    <span class="token keyword">if</span> <span class="token string">'ui'</span> <span class="token keyword">not</span> <span class="token keyword">in</span> st<span class="token punctuation">.</span>session_state<span class="token punctuation">:</span>
        session_state <span class="token operator">=</span> SessionState<span class="token punctuation">(</span><span class="token punctuation">)</span>
        session_state<span class="token punctuation">.</span>init_state<span class="token punctuation">(</span><span class="token punctuation">)</span>
        st<span class="token punctuation">.</span>session_state<span class="token punctuation">[</span><span class="token string">'ui'</span><span class="token punctuation">]</span> <span class="token operator">=</span> StreamlitUI<span class="token punctuation">(</span>session_state<span class="token punctuation">)</span>

    <span class="token keyword">else</span><span class="token punctuation">:</span>
        st<span class="token punctuation">.</span>set_page_config<span class="token punctuation">(</span>
            layout<span class="token operator">=</span><span class="token string">'wide'</span><span class="token punctuation">,</span>
            page_title<span class="token operator">=</span><span class="token string">'lagent-web'</span><span class="token punctuation">,</span>
            page_icon<span class="token operator">=</span><span class="token string">'./docs/imgs/lagent_icon.png'</span><span class="token punctuation">)</span>
        <span class="token comment"># st.header(':robot_face: :blue[Lagent] Web Demo ', divider='rainbow')</span>
    model_name<span class="token punctuation">,</span> model<span class="token punctuation">,</span> plugin_action<span class="token punctuation">,</span> uploaded_file <span class="token operator">=</span> st<span class="token punctuation">.</span>session_state<span class="token punctuation">[</span>
        <span class="token string">'ui'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>setup_sidebar<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># Initialize chatbot if it is not already initialized</span>
    <span class="token comment"># or if the model has changed</span>
    <span class="token keyword">if</span> <span class="token string">'chatbot'</span> <span class="token keyword">not</span> <span class="token keyword">in</span> st<span class="token punctuation">.</span>session_state <span class="token keyword">or</span> model <span class="token operator">!=</span> st<span class="token punctuation">.</span>session_state<span class="token punctuation">[</span>
            <span class="token string">'chatbot'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>_llm<span class="token punctuation">:</span>
        st<span class="token punctuation">.</span>session_state<span class="token punctuation">[</span><span class="token string">'chatbot'</span><span class="token punctuation">]</span> <span class="token operator">=</span> st<span class="token punctuation">.</span>session_state<span class="token punctuation">[</span>
            <span class="token string">'ui'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>initialize_chatbot<span class="token punctuation">(</span>model<span class="token punctuation">,</span> plugin_action<span class="token punctuation">)</span>

    <span class="token keyword">for</span> prompt<span class="token punctuation">,</span> agent_return <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>st<span class="token punctuation">.</span>session_state<span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                    st<span class="token punctuation">.</span>session_state<span class="token punctuation">[</span><span class="token string">'assistant'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        st<span class="token punctuation">.</span>session_state<span class="token punctuation">[</span><span class="token string">'ui'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>render_user<span class="token punctuation">(</span>prompt<span class="token punctuation">)</span>
        st<span class="token punctuation">.</span>session_state<span class="token punctuation">[</span><span class="token string">'ui'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>render_assistant<span class="token punctuation">(</span>agent_return<span class="token punctuation">)</span>
    <span class="token comment"># User input form at the bottom (this part will be at the bottom)</span>
    <span class="token comment"># with st.form(key='my_form', clear_on_submit=True):</span>

    <span class="token keyword">if</span> user_input <span class="token operator">:=</span> st<span class="token punctuation">.</span>chat_input<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        st<span class="token punctuation">.</span>session_state<span class="token punctuation">[</span><span class="token string">'ui'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>render_user<span class="token punctuation">(</span>user_input<span class="token punctuation">)</span>
        st<span class="token punctuation">.</span>session_state<span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>user_input<span class="token punctuation">)</span>
        <span class="token comment"># Add file uploader to sidebar</span>
        <span class="token keyword">if</span> uploaded_file<span class="token punctuation">:</span>
            file_bytes <span class="token operator">=</span> uploaded_file<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
            file_type <span class="token operator">=</span> uploaded_file<span class="token punctuation">.</span><span class="token builtin">type</span>
            <span class="token keyword">if</span> <span class="token string">'image'</span> <span class="token keyword">in</span> file_type<span class="token punctuation">:</span>
                st<span class="token punctuation">.</span>image<span class="token punctuation">(</span>file_bytes<span class="token punctuation">,</span> caption<span class="token operator">=</span><span class="token string">'Uploaded Image'</span><span class="token punctuation">)</span>
            <span class="token keyword">elif</span> <span class="token string">'video'</span> <span class="token keyword">in</span> file_type<span class="token punctuation">:</span>
                st<span class="token punctuation">.</span>video<span class="token punctuation">(</span>file_bytes<span class="token punctuation">,</span> caption<span class="token operator">=</span><span class="token string">'Uploaded Video'</span><span class="token punctuation">)</span>
            <span class="token keyword">elif</span> <span class="token string">'audio'</span> <span class="token keyword">in</span> file_type<span class="token punctuation">:</span>
                st<span class="token punctuation">.</span>audio<span class="token punctuation">(</span>file_bytes<span class="token punctuation">,</span> caption<span class="token operator">=</span><span class="token string">'Uploaded Audio'</span><span class="token punctuation">)</span>
            <span class="token comment"># Save the file to a temporary location and get the path</span>
            file_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>root_dir<span class="token punctuation">,</span> uploaded_file<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> tmpfile<span class="token punctuation">:</span>
                tmpfile<span class="token punctuation">.</span>write<span class="token punctuation">(</span>file_bytes<span class="token punctuation">)</span>
            st<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'File saved at: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>file_path<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
            user_input <span class="token operator">=</span> <span class="token string">'我上传了一个图像，路径为: {file_path}. {user_input}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
                file_path<span class="token operator">=</span>file_path<span class="token punctuation">,</span> user_input<span class="token operator">=</span>user_input<span class="token punctuation">)</span>
        agent_return <span class="token operator">=</span> st<span class="token punctuation">.</span>session_state<span class="token punctuation">[</span><span class="token string">'chatbot'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>chat<span class="token punctuation">(</span>user_input<span class="token punctuation">)</span>
        st<span class="token punctuation">.</span>session_state<span class="token punctuation">[</span><span class="token string">'assistant'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>copy<span class="token punctuation">.</span>deepcopy<span class="token punctuation">(</span>agent_return<span class="token punctuation">)</span><span class="token punctuation">)</span>
        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span>agent_return<span class="token punctuation">.</span>inner_steps<span class="token punctuation">)</span>
        st<span class="token punctuation">.</span>session_state<span class="token punctuation">[</span><span class="token string">'ui'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>render_assistant<span class="token punctuation">(</span>agent_return<span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    root_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    root_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>root_dir<span class="token punctuation">,</span> <span class="token string">'tmp_dir'</span><span class="token punctuation">)</span>
    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>root_dir<span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-shell">streamlit run /root/code/lagent/examples/react_web_demo.py <span class="token parameter variable">--server.address</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">--server.port</span> <span class="token number">6006</span>
</code></pre> 
<p>用同样的方法我们依然切换到 <code>VScode</code> 页面，运行成功后，<a href="./hello_world.md#52-%E9%85%8D%E7%BD%AE%E6%9C%AC%E5%9C%B0%E7%AB%AF%E5%8F%A3" rel="nofollow"><strong>查看本教程5.2配置本地端口后</strong></a>，将端口映射到本地。在本地浏览器输入 <code>http://127.0.0.1:6006</code> 即可。</p> 
<p>我们在 <code>Web</code> 页面选择 <code>InternLM</code> 模型，等待模型加载完毕后，输入数学问题 已知 <code>2x+3=10</code>，求<code>x</code> ,此时 <code>InternLM-Chat-7B</code> 模型理解题意生成解此题的 <code>Python</code> 代码，<code>Lagent</code> 调度送入 <code>Python</code> 代码解释器求出该问题的解。</p> 
<p><img src="https://images2.imgbox.com/59/3d/aHWPYBY3_o.png" alt="在这里插入图片描述"></p> 
<p>浦语·灵笔图文理解创作 Demo</p> 
<p>本小节我们将使用 <a href="https://studio.intern-ai.org.cn/" rel="nofollow">InternStudio</a> 中的 A100(1/4) * 2 机器和 <code>internlm-xcomposer-7b</code> 模型部署一个图文理解创作 Demo 。</p> 
<h4><a id="41__437"></a>4.1 环境准备</h4> 
<p>首先在 <a href="https://studio.intern-ai.org.cn/" rel="nofollow">InternStudio</a> 上选择 A100(1/4)*2 的配置。如下图所示：</p> 
<p><img src="https://images2.imgbox.com/2c/a0/K9pDK0TH_o.png" alt="在这里插入图片描述"></p> 
<p>接下来打开刚刚租用服务器的 <code>进入开发机</code>，并在终端输入 <code>bash</code> 命令，进入 <code>conda</code> 环境，接下来就是安装依赖。</p> 
<p>进入 <code>conda</code> 环境之后，使用以下命令从本地克隆一个已有的<code>pytorch 2.0.1</code> 的环境</p> 
<pre><code class="prism language-shell">/root/share/install_conda_env_internlm_base.sh xcomposer-demo
</code></pre> 
<p>然后使用以下命令激活环境</p> 
<pre><code class="prism language-shell">conda activate xcomposer-demo
</code></pre> 
<p>接下来运行以下命令，安装 <code>transformers</code>、<code>gradio</code> 等依赖包。请严格安装以下版本安装！</p> 
<pre><code class="prism language-shell">pip <span class="token function">install</span> <span class="token assign-left variable">transformers</span><span class="token operator">==</span><span class="token number">4.33</span>.1 <span class="token assign-left variable">timm</span><span class="token operator">==</span><span class="token number">0.4</span>.12 <span class="token assign-left variable">sentencepiece</span><span class="token operator">==</span><span class="token number">0.1</span>.99 <span class="token assign-left variable">gradio</span><span class="token operator">==</span><span class="token number">3.44</span>.4 <span class="token assign-left variable">markdown2</span><span class="token operator">==</span><span class="token number">2.4</span>.10 <span class="token assign-left variable">xlsxwriter</span><span class="token operator">==</span><span class="token number">3.1</span>.2 einops accelerate
</code></pre> 
<h4><a id="42__464"></a>4.2 模型下载</h4> 
<p><a href="https://studio.intern-ai.org.cn/" rel="nofollow">InternStudio</a>平台的 <code>share</code> 目录下已经为我们准备了全系列的 <code>InternLM</code> 模型，所以我们可以直接复制即可。使用如下命令复制：</p> 
<pre><code class="prism language-shell"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /root/model/Shanghai_AI_Laboratory
<span class="token function">cp</span> <span class="token parameter variable">-r</span> /root/share/temp/model_repos/internlm-xcomposer-7b /root/model/Shanghai_AI_Laboratory
</code></pre> 
<blockquote> 
 <p>-r 选项表示递归地复制目录及其内容</p> 
</blockquote> 
<p>也可以安装 <code>modelscope</code>，下载模型的老朋友了</p> 
<pre><code class="prism language-shell">pip <span class="token function">install</span> <span class="token assign-left variable">modelscope</span><span class="token operator">==</span><span class="token number">1.9</span>.5
</code></pre> 
<p>在 <code>/root/model</code> 路径下新建 <code>download.py</code> 文件并在其中输入以下内容，并运行 <code>python /root/model/download.py</code> 执行下载</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">from</span> modelscope <span class="token keyword">import</span> snapshot_download<span class="token punctuation">,</span> AutoModel<span class="token punctuation">,</span> AutoTokenizer
<span class="token keyword">import</span> os
model_dir <span class="token operator">=</span> snapshot_download<span class="token punctuation">(</span><span class="token string">'Shanghai_AI_Laboratory/internlm-xcomposer-7b'</span><span class="token punctuation">,</span> cache_dir<span class="token operator">=</span><span class="token string">'/root/model'</span><span class="token punctuation">,</span> revision<span class="token operator">=</span><span class="token string">'master'</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="43__490"></a>4.3 代码准备</h4> 
<p>在 <code>/root/code</code> <code>git clone InternLM-XComposer</code> 仓库的代码</p> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /root/code
<span class="token function">git</span> clone https://gitee.com/internlm/InternLM-XComposer.git
<span class="token builtin class-name">cd</span> /root/code/InternLM-XComposer
<span class="token function">git</span> checkout 3e8c79051a1356b9c388a6447867355c0634932d  <span class="token comment"># 最好保证和教程的 commit 版本一致</span>
</code></pre> 
<h4><a id="44_Demo__501"></a>4.4 Demo 运行</h4> 
<p>在终端运行以下代码：</p> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /root/code/InternLM-XComposer
python examples/web_demo.py  <span class="token punctuation">\</span>
    <span class="token parameter variable">--folder</span> /root/model/Shanghai_AI_Laboratory/internlm-xcomposer-7b <span class="token punctuation">\</span>
    <span class="token parameter variable">--num_gpus</span> <span class="token number">1</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--port</span> <span class="token number">6006</span>
</code></pre> 
<blockquote> 
 <p>这里 <code>num_gpus 1</code> 是因为InternStudio平台对于 <code>A100(1/4)*2</code> 识别仍为一张显卡。但如果有小伙伴课后使用两张 3090 来运行此 demo，仍需将 <code>num_gpus</code> 设置为 <code>2</code> 。</p> 
</blockquote> 
<p><a href="./hello_world.md#52-%E9%85%8D%E7%BD%AE%E6%9C%AC%E5%9C%B0%E7%AB%AF%E5%8F%A3" rel="nofollow"><strong>查看本教程5.2配置本地端口后</strong></a>，将端口映射到本地。在本地浏览器输入 <code>http://127.0.0.1:6006</code> 即可。我们以<code>又见敦煌</code>为提示词，体验图文创作的功能，如下图所示：</p> 
<p><img src="https://images2.imgbox.com/e4/9d/EdA6q1Jr_o.png" alt="在这里插入图片描述"></p> 
<p>接下来，我们可以体验一下图片理解的能力，如下所示~</p> 
<p><img src="https://images2.imgbox.com/ba/f7/OnqypKbo_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e0b36d5ef645aa8254e696dfbd62fa98/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">基于单片机的集中供热监控电路设计</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/17f75a287f1567ee723352237e5d245e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">leetcode：1108. IP 地址无效化</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>