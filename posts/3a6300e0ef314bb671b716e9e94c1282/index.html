<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Kafka 开启 SASL/PLAINTEXT 认证及 ACL - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Kafka 开启 SASL/PLAINTEXT 认证及 ACL" />
<meta property="og:description" content="Linux 安装 Kafka 并开启 SASL/PLAINTEXT 认证 前言一、环境准备1、组件版本2、下载文件3、上传文件 二、安装 Zookeeper（单节点）三、安装 Kafka（单节点）四、Zookeeper 开启 SASL 认证1、修改 zoo.cfg，添加如下配置2、新增 zk_server_jaas.conf3、将 kafka 认证的包导入 zk 中4、修改 zkEnv.sh 添加环境变量5、重启 zk 五、Kafka 开启 SASL 认证1、新增 kafka_server_jaas.conf 配置文件2、修改 kafka-run-class.sh，添加环境变量3、修改 server.properties 配置文件4、重启 kafka5、查看 Topic6、启动生产者和消费者 六、配置 ACL1、配置 Zookeeper ACL2、配置 Kafka ACL 前言 在之前的开发工作中，需要开发使用用户名密码的方式连接 Kafka 并对 Kafka 数据进行处理，但是客户并没有提供可以测试的环境，于是就自己着手搭建了一套单节点的 Kafka 并开启 SASL 认证。
一、环境准备 1、组件版本 组件版本kafka2.11-2.22zookeeper3.6.2 2、下载文件 KAFKA：下载地址
ZOOKEEPER：下载地址
3、上传文件 # 将下载的 zookeeper 和 kafka 包上传到 /opt/software 目录下 mkdir -p /opt/software # 组件的安装目录 mkdir -p /opt/module # 组件数据存放目录 mkdir -p /opt/data 二、安装 Zookeeper（单节点） # 解压zookeeper文件到/opt/modele/目录下 cd /opt/software tar -zxvf apache-zookeeper-3." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/3a6300e0ef314bb671b716e9e94c1282/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-07T13:21:46+08:00" />
<meta property="article:modified_time" content="2022-07-07T13:21:46+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Kafka 开启 SASL/PLAINTEXT 认证及 ACL</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>Linux 安装 Kafka 并开启 SASL/PLAINTEXT 认证</h4> 
 <ul><li><ul><li><a href="#_2" rel="nofollow">前言</a></li><li><a href="#_6" rel="nofollow">一、环境准备</a></li><li><ul><li><a href="#1_8" rel="nofollow">1、组件版本</a></li><li><a href="#2_15" rel="nofollow">2、下载文件</a></li><li><a href="#3_21" rel="nofollow">3、上传文件</a></li></ul> 
   </li><li><a href="#_Zookeeper_32" rel="nofollow">二、安装 Zookeeper（单节点）</a></li><li><a href="#_Kafka_99" rel="nofollow">三、安装 Kafka（单节点）</a></li><li><a href="#Zookeeper__SASL__151" rel="nofollow">四、Zookeeper 开启 SASL 认证</a></li><li><ul><li><a href="#1_zoocfg_153" rel="nofollow">1、修改 zoo.cfg，添加如下配置</a></li><li><a href="#2_zk_server_jaasconf_165" rel="nofollow">2、新增 zk_server_jaas.conf</a></li><li><a href="#3_kafka__zk__185" rel="nofollow">3、将 kafka 认证的包导入 zk 中</a></li><li><a href="#4_zkEnvsh__194" rel="nofollow">4、修改 zkEnv.sh 添加环境变量</a></li><li><a href="#5_zk_203" rel="nofollow">5、重启 zk</a></li></ul> 
   </li><li><a href="#Kafka__SASL__211" rel="nofollow">五、Kafka 开启 SASL 认证</a></li><li><ul><li><a href="#1_kafka_server_jaasconf__213" rel="nofollow">1、新增 kafka_server_jaas.conf 配置文件</a></li><li><a href="#2_kafkarunclasssh_239" rel="nofollow">2、修改 kafka-run-class.sh，添加环境变量</a></li><li><a href="#3_serverproperties__248" rel="nofollow">3、修改 server.properties 配置文件</a></li><li><a href="#4_kafka_265" rel="nofollow">4、重启 kafka</a></li><li><a href="#5_Topic_272" rel="nofollow">5、查看 Topic</a></li><li><a href="#6_298" rel="nofollow">6、启动生产者和消费者</a></li></ul> 
   </li><li><a href="#_ACL_342" rel="nofollow">六、配置 ACL</a></li><li><ul><li><a href="#1_Zookeeper_ACL_352" rel="nofollow">1、配置 Zookeeper ACL</a></li><li><a href="#2_Kafka_ACL_393" rel="nofollow">2、配置 Kafka ACL</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="_2"></a>前言</h3> 
<p>在之前的开发工作中，需要开发使用用户名密码的方式连接 Kafka 并对 Kafka 数据进行处理，但是客户并没有提供可以测试的环境，于是就自己着手搭建了一套单节点的 Kafka 并开启 SASL 认证。</p> 
<h3><a id="_6"></a>一、环境准备</h3> 
<h4><a id="1_8"></a>1、组件版本</h4> 
<table><thead><tr><th>组件</th><th>版本</th></tr></thead><tbody><tr><td>kafka</td><td>2.11-2.22</td></tr><tr><td>zookeeper</td><td>3.6.2</td></tr></tbody></table> 
<h4><a id="2_15"></a>2、下载文件</h4> 
<ul><li> <p>KAFKA：<a href="https://archive.apache.org/dist/kafka/2.2.2/kafka_2.11-2.2.2.tgz" rel="nofollow">下载地址</a></p> </li><li> <p>ZOOKEEPER：<a href="https://archive.apache.org/dist/zookeeper/zookeeper-3.6.2/apache-zookeeper-3.6.2-bin.tar.gz" rel="nofollow">下载地址</a></p> </li></ul> 
<h4><a id="3_21"></a>3、上传文件</h4> 
<pre><code class="prism language-shell"><span class="token comment"># 将下载的 zookeeper 和 kafka 包上传到 /opt/software 目录下</span>
<span class="token function">mkdir</span> -p /opt/software
<span class="token comment"># 组件的安装目录</span>
<span class="token function">mkdir</span> -p /opt/module
<span class="token comment"># 组件数据存放目录</span>
<span class="token function">mkdir</span> -p /opt/data
</code></pre> 
<h3><a id="_Zookeeper_32"></a>二、安装 Zookeeper（单节点）</h3> 
<pre><code class="prism language-shell"><span class="token comment"># 解压zookeeper文件到/opt/modele/目录下</span>
<span class="token builtin class-name">cd</span> /opt/software
<span class="token function">tar</span> -zxvf apache-zookeeper-3.6.2-bin.tar.gz -C /opt/module/

<span class="token comment"># 进入解压后的文件</span>
<span class="token builtin class-name">cd</span> /opt/module/apache-zookeeper-3.6.2-bin

<span class="token comment"># ll 可以发现文件夹结构如下</span>
ll
	drwxr-xr-x <span class="token number">2</span> root root  <span class="token number">4096</span> Sep  <span class="token number">4</span>  <span class="token number">2020</span> bin
	drwxr-xr-x <span class="token number">2</span> root root  <span class="token number">4096</span> Sep  <span class="token number">4</span>  <span class="token number">2020</span> conf
	drwxr-xr-x <span class="token number">5</span> root root  <span class="token number">4096</span> Sep  <span class="token number">4</span>  <span class="token number">2020</span> docs
	drwxr-xr-x <span class="token number">2</span> root root  <span class="token number">4096</span> Jul  <span class="token number">6</span> <span class="token number">11</span>:27 lib
	-rw-r--r-- <span class="token number">1</span> root root <span class="token number">11358</span> Sep  <span class="token number">4</span>  <span class="token number">2020</span> LICENSE.txt
	-rw-r--r-- <span class="token number">1</span> root root   <span class="token number">432</span> Sep  <span class="token number">4</span>  <span class="token number">2020</span> NOTICE.txt
	-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">1963</span> Sep  <span class="token number">4</span>  <span class="token number">2020</span> README.md
	-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">3166</span> Sep  <span class="token number">4</span>  <span class="token number">2020</span> README_packaging.md

<span class="token comment"># 创建zk配置文件</span>
<span class="token builtin class-name">cd</span> conf/
<span class="token function">cp</span> zoo_sample.cfg zoo.cfg
<span class="token function">vim</span> zoo.cfg
	<span class="token comment"># 修改如下配置（数据存储文件，自定义都行，不修改也行）</span>
	<span class="token assign-left variable">dataDir</span><span class="token operator">=</span>/tmp/zookeeper <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token assign-left variable">dataDir</span><span class="token operator">=</span>/opt/data/zookeeper

<span class="token comment"># 记得创建刚才配置的地址</span>
<span class="token function">mkdir</span> -p /opt/data/zookeeper

<span class="token comment"># ok 启动 zk</span>
<span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>/bin/
<span class="token function">sh</span> zkServer.sh start
	
<span class="token comment"># 执行启动命令后控制台打印如下日志</span>
ZooKeeper JMX enabled by default
Using config: /opt/module/apache-zookeeper-3.6.2-bin/bin/<span class="token punctuation">..</span>/conf/zoo.cfg
Starting zookeeper <span class="token punctuation">..</span>. FAILED TO START

<span class="token comment"># ok 很明显启动失败了 我们查看日志</span>
<span class="token function">less</span> <span class="token punctuation">..</span>/logs/zookeeper-root-server-zujian1.sdns.bigdata.suxr.sit.testpbcdci.out
	<span class="token comment">#可以看到如下的日志</span>
	Problem starting AdminServer on address <span class="token number">0.0</span>.0.0, port <span class="token number">8080</span> and <span class="token builtin class-name">command</span> URL /commands
	Caused by: java.io.IOException: Failed to <span class="token builtin class-name">bind</span> to /0.0.0.0:8080
	Caused by: java.net.BindException: Address already <span class="token keyword">in</span> use
	<span class="token comment"># 发现 8080端口已经被占用了，这是Zookeeper 3.5 之后的新特性，AdminServer 默认使用8080端口</span>
	
<span class="token comment"># 修改 AdminServer 的默认端口</span>
<span class="token function">vim</span> <span class="token punctuation">..</span>/conf/zoo.cfg
	<span class="token comment"># 添加如下配置</span>
	admin.serverPort<span class="token operator">=</span><span class="token number">8081</span>
	
<span class="token comment"># 重新启动zk</span>
<span class="token function">sh</span> zkServer.sh start

<span class="token comment"># 看到如下日志表示启动成功</span>
ZooKeeper JMX enabled by default
Using config: /opt/module/apache-zookeeper-3.6.2-bin/bin/<span class="token punctuation">..</span>/conf/zoo.cfg
Starting zookeeper <span class="token punctuation">..</span>. STARTED

<span class="token comment"># 其他命令</span>
<span class="token function">sh</span> zkServer.sh restart <span class="token comment"># 重启</span>
<span class="token function">sh</span> zkServer.sh stop <span class="token comment"># 停止</span>
<span class="token function">sh</span> zkServer.sh status <span class="token comment"># 查看zk运行状态</span>
</code></pre> 
<h3><a id="_Kafka_99"></a>三、安装 Kafka（单节点）</h3> 
<pre><code class="prism language-shell"><span class="token comment"># 解压 kafka 安装包</span>
<span class="token builtin class-name">cd</span> /opt/software/
<span class="token function">tar</span> -zxvf kafka_2.11-2.2.2.tgz -C /opt/module/

<span class="token comment"># 修改 kafka 配置文件</span>
<span class="token builtin class-name">cd</span> /opt/module/kafka_2.11-2.2.2/config
<span class="token function">vim</span> server.properties
	<span class="token comment"># broker 服务器要监听的地址及端口</span>
	<span class="token assign-left variable">listeners</span><span class="token operator">=</span>PLAINTEXT://hostname:9092
	<span class="token comment"># kafka消息存放的路径</span>
	log.dirs<span class="token operator">=</span>/opt/data/kafka/kafka-logs
	<span class="token comment"># zk 地址</span>
	zookeeper.connect<span class="token operator">=</span>localhost:2181/kafka

<span class="token comment"># 创建如上的文件夹</span>
<span class="token function">mkdir</span> -p /opt/data/kafka/kafka-logs

<span class="token comment"># 启动 kafka</span>
<span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>/bin/
<span class="token function">sh</span> kafka-server-start.sh <span class="token punctuation">..</span>/config/server.properties

<span class="token comment"># 查看日志，如果启动成功，则终止前台程序，改为守护进程启动</span>
<span class="token function">sh</span> kafka-server-start.sh -daemon <span class="token punctuation">..</span>/config/server.properties

<span class="token comment"># 查看启动日志</span>
<span class="token function">tail</span> 200f <span class="token punctuation">..</span>/logs/kafkaServer.out

<span class="token comment"># 创建 topic （这里需要使用主机名，使用IP会报错，我也不知道为什么）</span>
./kafka-topics.sh --create --bootstrap-server hostname:9092 --replication-factor <span class="token number">1</span> --partitions <span class="token number">1</span> --topic topic-test

<span class="token comment"># 经过一番研究，上面的bug解决了，修改配置文件，详情查看博客（https://blog.csdn.net/chenfeng_sky/article/details/103124473）</span>
<span class="token function">vim</span> <span class="token punctuation">..</span>/config/server.properties
	advertised.host.name<span class="token operator">=</span>ip

<span class="token comment"># 查看 topic</span>
./kafka-topics.sh --bootstrap-server hostname:9092 --list

<span class="token comment"># 查看 topic 详细信息</span>
./kafka-topics.sh --describe --bootstrap-server hostname:9092 --topic topic-test

<span class="token comment"># 启动生产者</span>
./kafka-console-producer.sh --broker-list hostname:9092 --topic topic-test

<span class="token comment"># 开一个linux新窗口 启动消费者</span>
./kafka-console-consumer.sh --bootstrap-server hostname:9092  --from-beginning --topic topic-test

<span class="token comment"># 往生产者中输入消息，可以看到在消费者中会打印消息，到这里，kafka 安装完成</span>
</code></pre> 
<h3><a id="Zookeeper__SASL__151"></a>四、Zookeeper 开启 SASL 认证</h3> 
<h4><a id="1_zoocfg_153"></a>1、修改 zoo.cfg，添加如下配置</h4> 
<pre><code class="prism language-shell"><span class="token comment"># 开启认证功能，注意是 阿拉伯数字的 1，而不是英文字母 L。</span>
authProvider.1<span class="token operator">=</span>org.apache.zookeeper.server.auth.SASLAuthenticationProvider
<span class="token comment"># 设置认证方式为sasl</span>
<span class="token assign-left variable">requireClientAuthScheme</span><span class="token operator">=</span>sasl
<span class="token comment"># 客户端开启 SASL</span>
zookeeper.sasl.client<span class="token operator">=</span>true
<span class="token assign-left variable">jaasLoginRenew</span><span class="token operator">=</span><span class="token number">3600000</span>
</code></pre> 
<h4><a id="2_zk_server_jaasconf_165"></a>2、新增 zk_server_jaas.conf</h4> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>/conf

<span class="token function">vim</span> zk_server_jaas.conf

<span class="token comment"># 添加如下内容</span>
Server <span class="token punctuation">{<!-- --></span>
	org.apache.kafka.common.security.plain.PlainLoginModule required
	<span class="token assign-left variable">username</span><span class="token operator">=</span><span class="token string">"admin"</span>
	<span class="token assign-left variable">password</span><span class="token operator">=</span><span class="token string">"zookeeper-admin-pwd"</span>
	<span class="token assign-left variable">user_kafka</span><span class="token operator">=</span><span class="token string">"kafka-zookeeper-pwd"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>Server字段用于指定服务端登录配置。通过org.apache.org.apache.kafka.common.security.plain.PlainLoginModule 由指定采用 PLAIN 机制。</p> 
<p>定义了两个用户，username 和paasword 是 zk集群之间的认证密码，user_kafka = “kafka"定义了一个用户"kafka”，密码是"kafka-zookeeper-pwd"， 通过“ user_ "为前缀后接用户名方式创建连接代理的用户名和密码。</p> 
<h4><a id="3_kafka__zk__185"></a>3、将 kafka 认证的包导入 zk 中</h4> 
<p>从上面的配置可以看出，Zookeeper的认证机制是使用插件 “org.apache.kafka.common.security.plain.PlainLoginModule”，所以需要导入Kafka相关jar包，kafka-clients相关jar包，在kafka服务下的lib目录中可以找到，根据kafka不同版本，相关jar包版本会有所变化。</p> 
<pre><code class="prism language-shell"><span class="token function">cp</span> /opt/module/kafka_2.11-2.2.2/libs/kafka-clients-2.2.2.jar /opt/module/apache-zookeeper-3.6.2-bin/lib/
<span class="token function">cp</span> /opt/module/kafka_2.11-2.2.2/libs/lz4-java-1.5.0.jar /opt/module/apache-zookeeper-3.6.2-bin/lib/
</code></pre> 
<h4><a id="4_zkEnvsh__194"></a>4、修改 zkEnv.sh 添加环境变量</h4> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /opt/module/apache-zookeeper-3.6.2-bin/bin/
<span class="token function">vim</span> zkEnv.sh
<span class="token comment"># 添加如下变量</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">SERVER_JVMFLAGS</span><span class="token operator">=</span><span class="token string">" -Djava.security.auth.login.config=/opt/module/apache-zookeeper-3.6.2-bin/conf/zk_server_jaas.conf"</span>
</code></pre> 
<h4><a id="5_zk_203"></a>5、重启 zk</h4> 
<pre><code class="prism language-shell">/opt/module/apache-zookeeper-3.6.2-bin/bin/zkServer.sh stop
/opt/module/apache-zookeeper-3.6.2-bin/bin/zkServer.sh start
/opt/module/apache-zookeeper-3.6.2-bin/bin/zkServer.sh status
</code></pre> 
<h3><a id="Kafka__SASL__211"></a>五、Kafka 开启 SASL 认证</h3> 
<h4><a id="1_kafka_server_jaasconf__213"></a>1、新增 kafka_server_jaas.conf 配置文件</h4> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /opt/module/kafka_2.11-2.2.2/config/

<span class="token function">vim</span> kafka_server_jaas.conf

<span class="token comment"># 添加如下内容</span>
    KafkaServer <span class="token punctuation">{<!-- --></span>
       org.apache.kafka.common.security.plain.PlainLoginModule required
       <span class="token assign-left variable">username</span><span class="token operator">=</span><span class="token string">"admin"</span>
       <span class="token assign-left variable">password</span><span class="token operator">=</span><span class="token string">"kafka-admin-pwd"</span>
       <span class="token assign-left variable">user_admin</span><span class="token operator">=</span><span class="token string">"kafka-admin-pwd"</span>
       <span class="token assign-left variable">user_kafka_client</span><span class="token operator">=</span><span class="token string">"kafka-server-pwd"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    Client <span class="token punctuation">{<!-- --></span>
       org.apache.kafka.common.security.plain.PlainLoginModule required
       <span class="token assign-left variable">username</span><span class="token operator">=</span><span class="token string">"kafka"</span>
       <span class="token assign-left variable">password</span><span class="token operator">=</span><span class="token string">"kafka-zookeeper-pwd"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>KafkaServer，使用 user_ 来定义多个用户，供客户端程序（生产者、消费者程序）认证使用，可以定义多个，后续配置还可以根据不同的用户定义ACL。username 和password 的值必须在 user_*中有配置，且用户名密码一致，否则kafka启动就会报错。</p> 
<p>Client 配置 kafka 和 zookeeper 通信用的，从上文的Zookeeper JAAS文件中选择一个用户，填写用户名和密码即可。</p> 
<h4><a id="2_kafkarunclasssh_239"></a>2、修改 kafka-run-class.sh，添加环境变量</h4> 
<pre><code class="prism language-shell"><span class="token function">vim</span> <span class="token punctuation">..</span>/bin/kafka-run-class.sh

<span class="token comment"># 添加如下内容</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">KAFKA_OPTS</span><span class="token operator">=</span><span class="token string">" -Djava.security.auth.login.config=/opt/module/kafka_2.11-2.2.2/config/kafka_server_jaas.conf"</span>
</code></pre> 
<h4><a id="3_serverproperties__248"></a>3、修改 server.properties 配置文件</h4> 
<pre><code class="prism language-shell"><span class="token assign-left variable">listeners</span><span class="token operator">=</span>SASL_PLAINTEXT://10.98.0.116:9092
advertised.listeners<span class="token operator">=</span>SASL_PLAINTEXT://10.98.0.116:9092
<span class="token comment"># 用于在代理之间进行通信的安全协议。有效值为：PLAINTEXT、SSL、SASL_PLAINTEXT、SASL_SSL。</span>
security.inter.broker.protocol<span class="token operator">=</span>SASL_PLAINTEXT
sasl.enabled.mechanisms<span class="token operator">=</span>PLAIN
sasl.mechanism.inter.broker.protocol<span class="token operator">=</span>PLAIN
authorizer.class.name<span class="token operator">=</span>kafka.security.auth.SimpleAclAuthorizer
allow.everyone.if.no.acl.found<span class="token operator">=</span>false
<span class="token comment"># super.users=User:*的值和kafka_server_jaas.conf中KafkaServer的username的值保持一致</span>
super.users<span class="token operator">=</span>User:admin
<span class="token comment"># 配置 kafka 使用 zookeeper 的 ACL</span>
zookeeper.set.acl<span class="token operator">=</span>true
</code></pre> 
<h4><a id="4_kafka_265"></a>4、重启 kafka</h4> 
<pre><code class="prism language-shell"><span class="token punctuation">..</span>/bin/kafka-server-stop.sh
<span class="token punctuation">..</span>/bin/kafka-server-start.sh -daemon <span class="token punctuation">..</span>/config/server.properties
</code></pre> 
<h4><a id="5_Topic_272"></a>5、查看 Topic</h4> 
<pre><code class="prism language-shell"><span class="token punctuation">..</span>/bin/kafka-topics.sh --zookeeper hostname:2181 --list
<span class="token punctuation">..</span>/bin/kafka-topics.sh --bootstrap-server hostname:9092 --list
</code></pre> 
<p>此时我们会发现，使用 --bootstrap-server 命令卡住不动了，我们可以查看一下日志</p> 
<pre><code class="prism language-shell"><span class="token function">tail</span> -200f /opt/module/kafka_2.11-2.2.2/logs/server.log

<span class="token comment"># 可以看到一直在打印异常信息</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-07-06 <span class="token number">19</span>:16:07,363<span class="token punctuation">]</span> INFO <span class="token punctuation">[</span>SocketServer <span class="token assign-left variable">brokerId</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">]</span> Failed authentication with /hostname <span class="token punctuation">(</span>Unexpected Kafka request of <span class="token builtin class-name">type</span> METADATA during SASL handshake.<span class="token punctuation">)</span> <span class="token punctuation">(</span>org.apache.kafka.common.network.Selector<span class="token punctuation">)</span>

<span class="token comment"># 可以发现，SASL握手失败，brokerId=0 的 broker 认证失败了，这说明 SASL 认证开启成功了，我们和 broker 通信需要经过认证，而访问 zk 时，kafka 会将认证信息携带过去。所以我们在访问 broker 的时候也将认证信息传递过去可以了</span>
<span class="token function">vim</span> /opt/module/kafka_2.11-2.2.2/config/sasl.properties
	<span class="token comment"># 添加如下认证信息，需要注意的是，username 和 password 就是之前 KafkaServer 中配置好的用户名密码。在这里先使用超级用户，因为别的用户都涉及到 ACL 授权的事，这个后面再说，超级用户不受ACL权限控制。</span>
	sasl.jaas.config<span class="token operator">=</span>org.apache.kafka.common.security.plain.PlainLoginModule required <span class="token assign-left variable">username</span><span class="token operator">=</span><span class="token string">"admin"</span> <span class="token assign-left variable">password</span><span class="token operator">=</span><span class="token string">"kafka-admin-pwd"</span><span class="token punctuation">;</span>
	security.protocol<span class="token operator">=</span>SASL_PLAINTEXT
	sasl.mechanism<span class="token operator">=</span>PLAIN

<span class="token comment"># 携带认证信息查看 Topic</span>
./kafka-topics.sh --bootstrap-server hostname:9092 --list --command-config <span class="token punctuation">..</span>/config/sasl.properties
</code></pre> 
<h4><a id="6_298"></a>6、启动生产者和消费者</h4> 
<pre><code class="prism language-shell"><span class="token comment"># 启动生产者</span>
./kafka-console-producer.sh --broker-list hostname:9092 --topic topic-test -producer.config <span class="token punctuation">..</span>/config/sasl.properties

<span class="token comment"># 开一个linux新窗口 启动消费者</span>
./kafka-console-consumer.sh --bootstrap-server hostname:9092  --from-beginning --topic topic-test -consumer.config <span class="token punctuation">..</span>/config/sasl.properties
</code></pre> 
<p>在生产中我们使用生产者和消费者，大都使用下面的方式进行配置。</p> 
<pre><code class="prism language-shell"><span class="token comment"># 在 kafka_server_jaas.conf 中添加 KafkaClient 的认证信息</span>
<span class="token function">vim</span> <span class="token punctuation">..</span>/config/kafka_server_jaas.conf
KafkaClient <span class="token punctuation">{<!-- --></span>
   org.apache.kafka.common.security.plain.PlainLoginModule required
   <span class="token assign-left variable">username</span><span class="token operator">=</span><span class="token string">"admin"</span>
   <span class="token assign-left variable">password</span><span class="token operator">=</span><span class="token string">"kafka-admin-pwd"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment"># 修改 consumer.properties 和 producer.properties 配置文件，添加如下内容</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> <span class="token punctuation">..</span>/config/consumer.properties <span class="token operator">&lt;&lt;</span><span class="token string">EOF
security.protocol=SASL_PLAINTEXT
sasl.mechanism=PLAIN
EOF</span>

<span class="token function">cat</span> <span class="token operator">&gt;</span> <span class="token punctuation">..</span>/config/producer.properties <span class="token operator">&lt;&lt;</span><span class="token string">EOF
security.protocol=SASL_PLAINTEXT
sasl.mechanism=PLAIN
EOF</span>
</code></pre> 
<p>配置好了之后，启动命令如下</p> 
<pre><code class="prism language-shell"><span class="token comment"># 启动生产者</span>
./kafka-console-producer.sh --broker-list hostname:9092 --topic topic-test -producer.config <span class="token punctuation">..</span>/config/producer.properties

<span class="token comment"># 开一个linux新窗口 启动消费者</span>
./kafka-console-consumer.sh --bootstrap-server hostname:9092 --from-beginning --topic topic-test -consumer.config <span class="token punctuation">..</span>/config/consumer.properties
</code></pre> 
<p>后续还有 ACL 相关问题，我自己也还没有搞懂。。。</p> 
<h3><a id="_ACL_342"></a>六、配置 ACL</h3> 
<p>又稍微的研究了一下zk和kafka的ACL，有点懂了，下面就带大家来进行配置。</p> 
<p>在我们开始之前，我们可以先阅读一下下面的内容</p> 
<p><a href="https://www.cnblogs.com/dalianpai/p/12748144.html" rel="nofollow">ZK ACL</a></p> 
<p><a href="https://kafka.apache.org/22/documentation.html#security_authz" rel="nofollow">Apache Kafka</a></p> 
<h4><a id="1_Zookeeper_ACL_352"></a>1、配置 Zookeeper ACL</h4> 
<p>首先我们来看一下官网的这一段话</p> 
<blockquote> 
 <p>If you are running a version of Kafka that does not support security or simply with security disabled, and you want to make the cluster secure, then you need to execute the following steps to enable ZooKeeper authentication with minimal disruption to your operations:</p> 
 <ol><li>Perform a rolling restart setting the JAAS login file, which enables brokers to authenticate. At the end of the rolling restart, brokers are able to manipulate znodes with strict ACLs, but they will not create znodes with those ACLs</li><li>Perform a second rolling restart of brokers, this time setting the configuration parameter zookeeper.set.acl to true, which enables the use of secure ACLs when creating znodes</li><li>Execute the ZkSecurityMigrator tool. To execute the tool, there is this script: ./bin/zookeeper-security-migration.sh with zookeeper.acl set to secure. This tool traverses the corresponding sub-trees changing the ACLs of the znodes</li></ol> 
</blockquote> 
<p>所以，我们要开启 Zookeeper 的 ACL 身份认证功能，执行一下的步骤即可</p> 
<p>1、配置 jaas 文件，使得 kafka broker 需要认证操作 zk 中的节点。这个我们在之前开启 SASL 已经配置完成了。</p> 
<p>2、在 kafka 配置文件（server.properties）中添加如下的配置</p> 
<pre><code class="prism language-shell">    <span class="token comment"># 配置 kafka 使用 zookeeper 的 ACL</span>
    zookeeper.set.acl<span class="token operator">=</span>true
</code></pre> 
<p>3、执行如下脚本，将 zookeeper.acl 设置为 secure。此工具会遍历相应的子节点，更改 znode 的 ACL。</p> 
<pre><code class="prism language-shell">    ./zookeeper-security-migration.sh --zookeeper.acl<span class="token operator">=</span>secure --zookeeper.connect<span class="token operator">=</span>localhost:2181/kafka
</code></pre> 
<p>在执行前，我们可以通过 zk 客户端来查看一下 kafka 节点的 ACL</p> 
<pre><code class="prism language-shell">   /opt/module/apache-zookeeper-3.6.2-bin/bin/zkCli.sh
    <span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">3</span><span class="token punctuation">]</span> getAcl /kafka
    <span class="token string">'world,'</span>anyone
    <span class="token builtin class-name">:</span> cdrwa
    <span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">4</span><span class="token punctuation">]</span>
    
    <span class="token comment"># 可以看到是默认的权限，然后我们执行上述脚本，再次查看发现节点ACL已经发生改变，表示经过 sasl 认证的kafka 用户具有 cdrwa 权限，其他所有用户都只有 r 权限。</span>
    <span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">5</span><span class="token punctuation">]</span> getAcl /kafka
    <span class="token string">'sasl,'</span>kafka
    <span class="token builtin class-name">:</span> cdrwa
    <span class="token string">'world,'</span>anyone
    <span class="token builtin class-name">:</span> r
    <span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">6</span><span class="token punctuation">]</span>
</code></pre> 
<p>经过我的测试，我发现如果在 zookeeper.set.acl=true 配置完成后，zk 中没有 kafka 的节点信息，那么启动 kafka 后，zk 中生成的节点信息，自动就修改了 ACL。</p> 
<h4><a id="2_Kafka_ACL_393"></a>2、配置 Kafka ACL</h4> 
<p>在开始之前，我们简单学习下Kafka ACL的格式。根据官网的介绍，Kafka中一条ACL的格式如下：“Principal P is [Allowed/Denied] Operation O From Host H On Resource R”。它们的含义如下：</p> 
<ol><li>principal：表示一个Kafka user</li><li>operation：表示一个具体的操作类型，有效值: Read(读), Write(写), Create(创建), Delete(删除), Alter(修改),Describe(描述), ClusterAction(集群操作), All(所有)</li><li>Host：表示连向Kafka集群的client的IP地址，如果是‘*’则表示所有IP。注意：当前Kafka不支持主机名，只能指定IP地址</li><li>Resource：表示一种Kafka资源类型。当前共有5种类型：TOPIC、CLUSTER、GROUP、transactional-id、delegation-token</li></ol> 
<p>ok，在之前的配置中，我们配置 kafkaClient 都是使用的超级用户，跳过了 ACL，现在我们将用户修改回来。</p> 
<pre><code class="prism language-shell">    <span class="token function">vim</span> /opt/module/kafka_2.11-2.2.2/config/sasl.properties
    sasl.jaas.config<span class="token operator">=</span>org.apache.kafka.common.security.plain.PlainLoginModule required <span class="token assign-left variable">username</span><span class="token operator">=</span><span class="token string">"kafka_client"</span> <span class="token assign-left variable">password</span><span class="token operator">=</span><span class="token string">"kafka-server-pwd"</span><span class="token punctuation">;</span>
    
    <span class="token function">vim</span> <span class="token punctuation">..</span>/config/kafka_server_jaas.conf
    KafkaClient <span class="token punctuation">{<!-- --></span>
       org.apache.kafka.common.security.plain.PlainLoginModule required
       <span class="token assign-left variable">username</span><span class="token operator">=</span><span class="token string">"kafka_client"</span>
       <span class="token assign-left variable">password</span><span class="token operator">=</span><span class="token string">"kafka-server-pwd"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>配置好了之后，我们重启服务，再次启动生产者和消费者，此时我们会发现，我们当前没有权限操作 topic 了</p> 
<pre><code class="prism language-shell">    <span class="token punctuation">[</span>root@hostname bin<span class="token punctuation">]</span><span class="token comment"># ./kafka-console-consumer.sh --bootstrap-server hostname:9092 --topic topic-test -consumer.config ../config/consumer.properties</span>
    <span class="token punctuation">[</span><span class="token number">2022</span>-07-07 <span class="token number">12</span>:16:27,284<span class="token punctuation">]</span> WARN <span class="token punctuation">[</span>Consumer <span class="token assign-left variable">clientId</span><span class="token operator">=</span>consumer-1, <span class="token assign-left variable">groupId</span><span class="token operator">=</span>test-consumer-group<span class="token punctuation">]</span> Error <span class="token keyword">while</span> fetching metadata with correlation <span class="token function">id</span> <span class="token number">2</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>topic-test<span class="token operator">=</span>TOPIC_AUTHORIZATION_FAILED<span class="token punctuation">}</span> <span class="token punctuation">(</span>org.apache.kafka.clients.NetworkClient<span class="token punctuation">)</span>
    <span class="token punctuation">[</span><span class="token number">2022</span>-07-07 <span class="token number">12</span>:16:27,285<span class="token punctuation">]</span> ERROR Error processing message, terminating consumer process:  <span class="token punctuation">(</span>kafka.tools.ConsoleConsumer$<span class="token punctuation">)</span>
    org.apache.kafka.common.errors.TopicAuthorizationException: Not authorized to access topics: <span class="token punctuation">[</span>topic-test<span class="token punctuation">]</span>
    Processed a total of <span class="token number">0</span> messages
    <span class="token punctuation">[</span>root@hostname bin<span class="token punctuation">]</span><span class="token comment">#</span>
</code></pre> 
<p>我们可以通过，如下命令来查看 topic 的权限信息</p> 
<pre><code class="prism language-shell">    <span class="token comment"># 查看所有权限</span>
    ./kafka-acls.sh --authorizer-properties zookeeper.connect<span class="token operator">=</span>hostname:2181/kafka --list 
    <span class="token comment"># 查看单个</span>
    ./kafka-acls.sh --authorizer-properties zookeeper.connect<span class="token operator">=</span>hostname:2181/kafka --list --topic topic-test
</code></pre> 
<p>然后可以通过如下命令来对topic进行acl</p> 
<pre><code class="prism language-shell">    <span class="token comment"># 给用户kafka_client topic topic-test 的 producer 权限</span>
    bin/kafka-acls.sh --authorizer-properties zookeeper.connect<span class="token operator">=</span>hostname:2181/kafka --topic <span class="token string">"topic-test"</span> --add --allow-principal User:kafka_client --producer
    
    <span class="token comment"># 给用户kafka_client 所有消费者组的 topic topic-test 的 consumer 权限</span>
    bin/kafka-acls.sh --authorizer-properties zookeeper.connect<span class="token operator">=</span>hostname:2181/kafka --topic <span class="token string">"topic-test"</span> --add --allow-principal User:kafka_client --consumer --group <span class="token string">"*"</span>
</code></pre> 
<p>配置好了之后，kafka_client 用户对 topic-test topic 就有了正常的生产消费权限，如下</p> 
<pre><code class="prism language-shell">    <span class="token punctuation">[</span>root@hostname bin<span class="token punctuation">]</span><span class="token comment"># ./kafka-acls.sh --authorizer-properties zookeeper.connect=hostname:2181/kafka --list</span>
    Current ACLs <span class="token keyword">for</span> resource <span class="token variable"><span class="token variable">`</span>Topic:LITERAL:topic-test<span class="token variable">`</span></span><span class="token builtin class-name">:</span>
            User:kafka_client has Allow permission <span class="token keyword">for</span> operations: Write from hosts: *
            User:kafka_client has Allow permission <span class="token keyword">for</span> operations: Describe from hosts: *
            User:kafka_client has Allow permission <span class="token keyword">for</span> operations: Create from hosts: *
            User:kafka_client has Allow permission <span class="token keyword">for</span> operations: Read from hosts: *
</code></pre> 
<p>ACL 还有很多中限制，就看大家的实际需求去配置就行。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3ddb3bacaf13f9c2dcf6aa889fd1670b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【批处理DOS-CMD命令-汇总和小结】-时间延迟命令、延迟执行命令——ping、for、vbs延迟函数、批处理命令</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4c8eee848c7a3c35b239d41cb6e5d920/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">修改ssh服务的默认端口（附坑解决）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>