<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>hyper-v用命令方式创建NAT网络 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="hyper-v用命令方式创建NAT网络" />
<meta property="og:description" content="文章目录 NAT 概述创建 NAT 虚拟网络配置vm的ip地址 NAT 概述 NAT 使用主计算机的 IP 地址和端口通过内部 Hyper-V 虚拟网关向虚拟机授予对网络资源的访问权限。
网络地址转换 (NAT) 是一种网络模式，旨在通过将一个外部 IP 地址和端口映射到更大的内部 IP 地址集来转换 IP 地址。 基本上，NAT 使用流量表将流量从一个外部（主机）IP 地址和端口号路由到与网络上的终结点（虚拟机、计算机和容器等）关联的正确内部 IP 地址
此外，NAT 允许多个虚拟机托管需要相同（内部）通信端口的应用程序，方法是将它们映射到唯一的外部端口。
出于所有这些原因，NAT 网络对于容器技术是很常见的
创建 NAT 虚拟网络 以管理员身份打开 PowerShell 控制台。创建内部交换机。 New-VMSwitch -SwitchName &#34;natsw&#34; -SwitchType Internal natsw是自己定义的名称
查找刚创建的虚拟交换机的接口索引。 可以通过运行 Get-NetAdapter 来查找接口索引
你的输出应类似下面的形式：
PS C:\Windows\system32&gt; Get-NetAdapter Name InterfaceDescription ifIndex Status MacAddress LinkSpeed ---- -------------------- ------- ------ ---------- --------- vEthernet (natsw) Hyper-V Virtual Ethernet Adapter #3 56 Up 00-15-5D-00-02-01 10 Gbps 以太网 Intel(R) 82579LM Gigabit Network Con." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/38607766ff16e1a489465c1126afb1fb/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-31T10:10:39+08:00" />
<meta property="article:modified_time" content="2023-12-31T10:10:39+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">hyper-v用命令方式创建NAT网络</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#NAT__6" rel="nofollow">NAT 概述</a></li><li><a href="#_NAT__15" rel="nofollow">创建 NAT 虚拟网络</a></li><li><a href="#vmip_124" rel="nofollow">配置vm的ip地址</a></li></ul> 
</div> 
<p></p> 
<h2><a id="NAT__6"></a>NAT 概述</h2> 
<p>NAT 使用主计算机的 IP 地址和端口通过内部 Hyper-V 虚拟网关向虚拟机授予对网络资源的访问权限。</p> 
<p>网络地址转换 (NAT) 是一种网络模式，旨在通过将一个外部 IP 地址和端口映射到更大的内部 IP 地址集来转换 IP 地址。 基本上，NAT 使用流量表将流量从一个外部（主机）IP 地址和端口号路由到与网络上的终结点（虚拟机、计算机和容器等）关联的正确内部 IP 地址</p> 
<p>此外，NAT 允许多个虚拟机托管需要相同（内部）通信端口的应用程序，方法是将它们映射到唯一的外部端口。</p> 
<p>出于所有这些原因，NAT 网络对于容器技术是很常见的</p> 
<h2><a id="_NAT__15"></a>创建 NAT 虚拟网络</h2> 
<ul><li>以管理员身份打开 PowerShell 控制台。</li><li>创建内部交换机。</li></ul> 
<pre><code class="prism language-bash">New-VMSwitch <span class="token parameter variable">-SwitchName</span> <span class="token string">"natsw"</span> <span class="token parameter variable">-SwitchType</span> Internal
</code></pre> 
<p>natsw是自己定义的名称</p> 
<ul><li>查找刚创建的虚拟交换机的接口索引。</li></ul> 
<p>可以通过运行 <code>Get-NetAdapter</code> 来查找接口索引</p> 
<p>你的输出应类似下面的形式：</p> 
<pre><code class="prism language-bash">PS C:<span class="token punctuation">\</span>Windows<span class="token punctuation">\</span>system3<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span> Get-NetAdapter

Name                      InterfaceDescription                    ifIndex Status       MacAddress             LinkSpeed
----                      --------------------                    ------- ------       ----------             ---------
vEthernet <span class="token punctuation">(</span>natsw<span class="token punctuation">)</span>         Hyper-V Virtual Ethernet Adapter <span class="token comment">#3          56 Up           00-15-5D-00-02-01        10 Gbps</span>
以太网                    Intel<span class="token punctuation">(</span>R<span class="token punctuation">)</span> 82579LM Gigabit Network Con<span class="token punctuation">..</span>.      <span class="token number">18</span> Up           3C-97-0E-86-6E-29         <span class="token number">1</span> Gbps
WLAN                      Intel<span class="token punctuation">(</span>R<span class="token punctuation">)</span> Centrino<span class="token punctuation">(</span>R<span class="token punctuation">)</span> Advanced-N <span class="token number">6205</span>          <span class="token number">9</span> Disconnected 6C-88-14-01-B7-B4       <span class="token number">240</span> Mbps
vEthernet <span class="token punctuation">(</span>pub<span class="token punctuation">)</span>           Hyper-V Virtual Ethernet Adapter <span class="token comment">#2          38 Up           3C-97-0E-86-6E-29         1 Gbps</span>
以太网 <span class="token number">2</span>                  Sangfor SSL VPN CS Support System VNIC        <span class="token number">5</span> Disconnected 00-FF-36-2B-A1-5A        <span class="token number">10</span> Mbps
</code></pre> 
<p>内部交换机的名称将类似于 vEthernet (SwitchName)，接口描述将为 Hyper-V Virtual Ethernet Adapter。 请记下其 ifIndex 以便在下一步中使用。</p> 
<ul><li>使用 New-NetIPAddress 配置 NAT 网关。</li></ul> 
<p>下面是常规命令：</p> 
<pre><code class="prism language-bash">New-NetIPAddress <span class="token parameter variable">-IPAddress</span> <span class="token operator">&lt;</span>NAT Gateway IP<span class="token operator">&gt;</span> <span class="token parameter variable">-PrefixLength</span> <span class="token operator">&lt;</span>NAT Subnet Prefix Length<span class="token operator">&gt;</span> <span class="token parameter variable">-InterfaceIndex</span> <span class="token operator">&lt;</span>ifIndex<span class="token operator">&gt;</span>
</code></pre> 
<p>若要配置网关，你将需要一些有关你的网络的信息：</p> 
<p>IPAddress - NAT 网关 IP 指定要用作 NAT 网关 IP 的 IPv4 或 IPv6 地址。 常规形式将为 a.b.c.1（例如 172.16.0.1）。 尽管最后一个位置不一定是 .1，但通常是 1（基于前缀长度）。 此 IP 地址位于来宾虚拟机使用的地址范围。 例如，如果来宾 VM 使用 IP 范围 172.16.0.0，则可以使用 IP 地址 172.16.0.100 作为 NAT 网关。</p> 
<p>通用网关 IP 为 192.168.0.1</p> 
<p>PrefixLength – NAT 子网前缀长度定义的 NAT 本地子网大小（子网掩码）。 子网前缀长度将介于 0 到 32 之间的一个整数值。</p> 
<p>0 将映射整个 Internet，32 则只允许一个映射的 IP。 常用值范围从 24 到 12，具体要取决于多少 IP 需要附加到 NAT。</p> 
<p>常用 PrefixLength 为 24 – 这是子网掩码 255.255.255.0</p> 
<p>InterfaceIndex – ifIndex 是你在上一步中确定的虚拟交换机的接口索引。</p> 
<p>本例运行以下内容来创建 NAT 网关：<br> 56是刚才创建的交换机的接口索引</p> 
<pre><code class="prism language-bash">New-NetIPAddress <span class="token parameter variable">-IPAddress</span> <span class="token number">192.168</span>.0.1 <span class="token parameter variable">-PrefixLength</span> <span class="token number">24</span> <span class="token parameter variable">-InterfaceIndex</span> <span class="token number">56</span>


IPAddress         <span class="token builtin class-name">:</span> <span class="token number">192.168</span>.0.1
InterfaceIndex    <span class="token builtin class-name">:</span> <span class="token number">56</span>
InterfaceAlias    <span class="token builtin class-name">:</span> vEthernet <span class="token punctuation">(</span>natsw<span class="token punctuation">)</span>
AddressFamily     <span class="token builtin class-name">:</span> IPv4
Type              <span class="token builtin class-name">:</span> Unicast
PrefixLength      <span class="token builtin class-name">:</span> <span class="token number">24</span>
PrefixOrigin      <span class="token builtin class-name">:</span> Manual
SuffixOrigin      <span class="token builtin class-name">:</span> Manual
AddressState      <span class="token builtin class-name">:</span> Tentative
ValidLifetime     <span class="token builtin class-name">:</span>
PreferredLifetime <span class="token builtin class-name">:</span>
SkipAsSource      <span class="token builtin class-name">:</span> False
PolicyStore       <span class="token builtin class-name">:</span> ActiveStore
</code></pre> 
<ul><li>使用 New-NetNat 配置 NAT 网络。</li></ul> 
<p>下面是常规命令：</p> 
<pre><code class="prism language-bash">New-NetNat <span class="token parameter variable">-Name</span> <span class="token operator">&lt;</span>NATOutsideName<span class="token operator">&gt;</span> <span class="token parameter variable">-InternalIPInterfaceAddressPrefix</span> <span class="token operator">&lt;</span>NAT subnet prefix<span class="token operator">&gt;</span>
</code></pre> 
<p>若要配置网关，你将需要提供一些有关网络和 NAT 网关的信息：</p> 
<p>Name - NATOutsideName 描述 NAT 网络的名称。 将使用此参数删除 NAT 网络。</p> 
<p>InternalIPInterfaceAddressPrefix - NAT 子网前缀同时描述上述 NAT 网关 IP 前缀和上述 NAT 子网前缀长度。</p> 
<p>常规形式将为 a.b.c.0/NAT 子网前缀长度</p> 
<p>综上所述，对于本示例，我们将使用 192.168.0.0/24</p> 
<p>对于我们的示例，运行以下命令以设置 NAT 网络：</p> 
<pre><code class="prism language-bash">New-NetNat <span class="token parameter variable">-Name</span> MyNATnetwork <span class="token parameter variable">-InternalIPInterfaceAddressPrefix</span> <span class="token number">192.168</span>.0.0/24

Name                             <span class="token builtin class-name">:</span> MyNATnetwork
ExternalIPInterfaceAddressPrefix <span class="token builtin class-name">:</span>
InternalIPInterfaceAddressPrefix <span class="token builtin class-name">:</span> <span class="token number">192.168</span>.0.0/24
IcmpQueryTimeout                 <span class="token builtin class-name">:</span> <span class="token number">30</span>
TcpEstablishedConnectionTimeout  <span class="token builtin class-name">:</span> <span class="token number">1800</span>
TcpTransientConnectionTimeout    <span class="token builtin class-name">:</span> <span class="token number">120</span>
TcpFilteringBehavior             <span class="token builtin class-name">:</span> AddressDependentFiltering
UdpFilteringBehavior             <span class="token builtin class-name">:</span> AddressDependentFiltering
UdpIdleSessionTimeout            <span class="token builtin class-name">:</span> <span class="token number">120</span>
UdpInboundRefresh                <span class="token builtin class-name">:</span> False
Store                            <span class="token builtin class-name">:</span> Local
Active                           <span class="token builtin class-name">:</span> True

</code></pre> 
<h2><a id="vmip_124"></a>配置vm的ip地址</h2> 
<p>由于这个没有配置dhcp，因此，vm需要手工分配一个IP地址，取值范围在刚才创建的nat网络中去一个地址，网关是nat的网关。<br> 譬如 ：</p> 
<pre><code class="prism language-bash">ipaddress：192.168.0.2/24
gateway：192.168.0.1
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/92a33e72a4bcebf6613f518c10465ef1/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">MFC连接mqtt服务器订阅和发送数据-自设计函数库</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/555e09f8a312c9e5e1bcf83dda264ae0/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">linux 休眠唤醒中设备、总线、用户进程、内核线程调试分析流程</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>