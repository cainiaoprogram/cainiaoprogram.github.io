<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Sharding-JDBC架构篇 - 分库分表神器 Sharding-JDBC - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Sharding-JDBC架构篇 - 分库分表神器 Sharding-JDBC" />
<meta property="og:description" content="前言 Sharding-JDBC 定位为轻量级 Java 框架，在 Java 的 JDBC 层提供额外服务。它使用客户端直连数据库，以 jar 包的形式提供服务，无需额外部署和依赖，可理解为增强版的 JDBC 驱动。
适用于任何基于 JDBC 的 ORM 框架。支持任何第三方的数据库连接池。支持任意实现 JDBC 规范的数据库。目前支持 MySQL、Oracle、SQL Server、PostgreSQL 以及遵循 SQL92 标准的数据库。
基本概念 表 表是透明化数据分片的关键概念。Apache ShardingSphere 通过提供多样化的表类型，适配不同场景下的数据分片需求。
逻辑表
相同结构的水平拆分数据库（表）的逻辑名称，是 SQL 中表的逻辑标识。例：订单数据根据主键尾数拆分为 10 张表，分别是 t_order_0 到 t_order_9，它们的逻辑表名为 t_order。
真实表
在水平拆分的数据库中真实存在的物理表。即上个示例中的 t_order_0 到 t_order_9。
绑定表
指分片规则一致的一组分片表。使用绑定表进行多表关联查询时，必须使用分片键进行关联，否则会出现笛卡尔积关联或者跨库关联，从而影响查询效率。例如：t_order 表和 t_order_item 表，均按照 order_id 分片，并且使用 order_id 进行关联，则此两张表互为绑定表关系。绑定表之间的多表关联查询不会出现笛卡尔积关联，关联查询效率将大大提升。举例说明，如果 SQL 为：
select i.* from t_order o join t_order_item i on o.order_id = i.order_id where o." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/5d5e8975b2f92ac46bc5d36f21c2e105/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-16T21:14:58+08:00" />
<meta property="article:modified_time" content="2023-02-16T21:14:58+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Sharding-JDBC架构篇 - 分库分表神器 Sharding-JDBC</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atelier-sulphurpool-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>前言</h2> 
<p>Sharding-JDBC 定位为轻量级 Java 框架，在 Java 的 JDBC 层提供额外服务。它使用客户端直连数据库，以 jar 包的形式提供服务，无需额外部署和依赖，可理解为增强版的 JDBC 驱动。</p> 
<p>适用于任何基于 JDBC 的 ORM 框架。支持任何第三方的数据库连接池。支持任意实现 JDBC 规范的数据库。目前支持 MySQL、Oracle、SQL Server、PostgreSQL 以及遵循 SQL92 标准的数据库。</p> 
<h2><a id="_6"></a>基本概念</h2> 
<h3><a id="_8"></a>表</h3> 
<p>表是透明化数据分片的关键概念。Apache ShardingSphere 通过提供多样化的表类型，适配不同场景下的数据分片需求。</p> 
<p><strong>逻辑表</strong></p> 
<p>相同结构的水平拆分数据库（表）的逻辑名称，是 SQL 中表的逻辑标识。例：订单数据根据主键尾数拆分为 10 张表，分别是 <code>t_order_0</code> 到 <code>t_order_9</code>，它们的逻辑表名为 <code>t_order</code>。</p> 
<p><strong>真实表</strong></p> 
<p>在水平拆分的数据库中真实存在的物理表。即上个示例中的 <code>t_order_0</code> 到 <code>t_order_9</code>。</p> 
<p><strong>绑定表</strong></p> 
<p>指分片规则一致的一组分片表。使用绑定表进行多表关联查询时，必须使用分片键进行关联，否则会出现笛卡尔积关联或者跨库关联，从而影响查询效率。例如：<code>t_order</code> 表和 <code>t_order_item</code> 表，均按照 <code>order_id</code> 分片，并且使用 <code>order_id</code> 进行关联，则此两张表互为绑定表关系。绑定表之间的<font color="orange">多表关联查询不会出现笛卡尔积关联</font>，关联查询效率将大大提升。举例说明，如果 SQL 为：</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> i<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> t_order o <span class="token keyword">join</span> t_order_item i <span class="token keyword">on</span> o<span class="token punctuation">.</span>order_id <span class="token operator">=</span> i<span class="token punctuation">.</span>order_id <span class="token keyword">where</span> o<span class="token punctuation">.</span>order_id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>在不配置绑定表关系时，假设分片键 <code>order_id</code> 将数值 10 路由至第 0 片，将数值 11 路由至第 1 片，那么路由后的 SQL 应该为 4 条，它们呈现为笛卡尔积：</p> 
<table><thead><tr><th align="left">t_order表</th><th align="left">t_order_item表</th></tr></thead><tbody><tr><td align="left">t_order_0</td><td align="left">t_order_item_0</td></tr><tr><td align="left">t_order_0</td><td align="left">t_order_item_1</td></tr><tr><td align="left">t_order_1</td><td align="left">t_order_item_0</td></tr><tr><td align="left">t_order_1</td><td align="left">t_order_item_1</td></tr></tbody></table> 
<p>在配置绑定表关系后，并且使用 <code>order_id</code> 进行关联后，路由的SQL应该为 2 条：</p> 
<table><thead><tr><th>t_order表</th><th>t_order_item表</th></tr></thead><tbody><tr><td>t_order_0</td><td>t_order_item_0</td></tr><tr><td>t_order_1</td><td>t_order_item_1</td></tr></tbody></table> 
<p>其中 <code>t_order</code> 表由于指定了分片条件，ShardingSphere 将会以它作为整个绑定表的主表。所有的分片计算将会只使用主表的策略，那么 <code>t_order_item</code> 表的分片计算将会使用 <code>t_order</code> 表的分片条件。</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
    <span class="token key atrule">shardingsphere</span><span class="token punctuation">:</span>
        <span class="token key atrule">sharding</span><span class="token punctuation">:</span>
            <span class="token key atrule">tables</span><span class="token punctuation">:</span>
                <span class="token key atrule">t_order</span><span class="token punctuation">:</span>
                    <span class="token key atrule">actualDataNodes</span><span class="token punctuation">:</span> ds$<span class="token punctuation">{<!-- --></span>0..2<span class="token punctuation">}</span>.t_order
                    <span class="token key atrule">logicTable</span><span class="token punctuation">:</span> t_order
                    <span class="token key atrule">databaseStrategy</span><span class="token punctuation">:</span>
                        <span class="token key atrule">inline</span><span class="token punctuation">:</span>
                            <span class="token key atrule">sharding-column</span><span class="token punctuation">:</span> order_id
                            <span class="token key atrule">algorithm-expression</span><span class="token punctuation">:</span> ds$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{<!-- --></span>order_id % 3<span class="token punctuation">}</span>
                    <span class="token key atrule">keyGenerator</span><span class="token punctuation">:</span>
                        <span class="token key atrule">type</span><span class="token punctuation">:</span> SNOWFLAKE
                        <span class="token key atrule">column</span><span class="token punctuation">:</span> order_id
                <span class="token key atrule">t_order_item</span><span class="token punctuation">:</span>
                    <span class="token key atrule">actual-data-nodes</span><span class="token punctuation">:</span> ds$<span class="token punctuation">{<!-- --></span>0..2<span class="token punctuation">}</span>.t_order_item
                    <span class="token key atrule">logicTable</span><span class="token punctuation">:</span> t_order_item
                    <span class="token key atrule">database-strategy</span><span class="token punctuation">:</span>
                        <span class="token key atrule">inline</span><span class="token punctuation">:</span>
                            <span class="token key atrule">sharding-column</span><span class="token punctuation">:</span> order_id
                            <span class="token key atrule">algorithm-expression</span><span class="token punctuation">:</span> ds$<span class="token punctuation">{<!-- --></span>order_id % 3<span class="token punctuation">}</span>
                    <span class="token key atrule">keyGenerator</span><span class="token punctuation">:</span>
                        <span class="token key atrule">type</span><span class="token punctuation">:</span> SNOWFLAKE
                        <span class="token key atrule">column</span><span class="token punctuation">:</span> item_id
            <span class="token key atrule">binding-tables</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> t_order<span class="token punctuation">,</span> t_order_item
</code></pre> 
<p><strong>广播表</strong></p> 
<p>指所有的分片数据源中都存在的表，<font color="orange">表结构以及表中的数据在每个数据库中均完全一致</font>。适用于数据量不大且需要与海量数据的表进行关联查询的场景，例如：字典表。</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
    <span class="token key atrule">shardingsphere</span><span class="token punctuation">:</span>
        <span class="token key atrule">sharding</span><span class="token punctuation">:</span>
            <span class="token key atrule">tables</span><span class="token punctuation">:</span>
                <span class="token key atrule">t_config</span><span class="token punctuation">:</span>
                    <span class="token key atrule">actual-data-nodes</span><span class="token punctuation">:</span> ds$<span class="token punctuation">{<!-- --></span>0..2<span class="token punctuation">}</span>.t_config
            <span class="token key atrule">broadcast-tables</span><span class="token punctuation">:</span> 
            		<span class="token punctuation">-</span> t_config
</code></pre> 
<p><strong>单表</strong></p> 
<p>指所有的分片数据源中仅唯一存在的表。适用于数据量不大且无需分片的表。</p> 
<h3><a id="_94"></a><strong>数据节点</strong></h3> 
<p>数据分片的最小单元，由数据源名称和真实表组成。例：<code>ds_0.t_order_0</code>。逻辑表与真实表的映射关系，可以分为均匀分布和自定义分布两种形式。</p> 
<p><strong>均匀分布</strong></p> 
<p>指真实表在每个数据源内呈现均匀分布的态势，例如：</p> 
<pre><code>db0
  ├── t_order0
  └── t_order1
db1
  ├── t_order0
  └── t_order1
</code></pre> 
<p>数据节点的配置如下：</p> 
<pre><code>db0.t_order0, db0.t_order1, db1.t_order0, db1.t_order1
</code></pre> 
<p><strong>自定义分布</strong></p> 
<p>指真实表呈现特定规则的分布，例如：</p> 
<pre><code>db0
  ├── t_order0
  └── t_order1
db1
  ├── t_order2
  ├── t_order3
  └── t_order4
</code></pre> 
<p>数据节点的配置如下：</p> 
<pre><code>db0.t_order0, db0.t_order1, db1.t_order2, db1.t_order3, db1.t_order4
</code></pre> 
<h3><a id="_137"></a>分片</h3> 
<p><strong>分片键</strong></p> 
<p>用于将数据库（表）水平拆分的数据库字段。例如：按照订单表中的订单 id 取模分片，则订单 id 就是分片键。SQL 中如果没有用于分片的字段，将执行全路由，性能较差。Apache ShardingSphere 支持根据单字段、多字段进行分片。</p> 
<p><strong>分片算法</strong></p> 
<p>用于将数据分片的算法。分片算法可以使用 Apache ShardingSphere 内置的分片算法语法糖，也可以由开发者自定义分片算法。</p> 
<ul><li>自动化分片算法：分片算法语法糖，用于便捷的托管所有数据节点，使用者无需关注真实表的物理分布。包括取模、哈希、范围、时间等常用分片算法的实现。</li><li>自定义分片算法：提供接口让开发者自己实现与业务紧密相关的分片算法，并允许开发者自行管理真实表的物理分布。 
  <ul><li>标准分片算法：用于处理单字段作为分片键的 =，&gt;，&lt;，&gt;=，&lt;=，in， between and 进行分片的场景。</li><li>复合分片算法：用于处理多字段作为分片键进行分片的场景。</li><li>Hint分片算法：用于处理使用 Hint 行分片的场景。</li></ul> </li></ul> 
<p><strong>分片策略</strong></p> 
<p>包括分片键和分片算法，由于分片算法的独立性，将其独立抽离。真正可用于分片操作的是分片键+分片算法，也就是分片策略。</p> 
<p><strong>强制分片路由</strong></p> 
<p>对于分片字段并非是 SQL 字段而是其它外置条件决定的场景，可以使用 SQL Hint 注入分片值。比如，按照员工主键分库，但是数据库中并没有该字段。SQL Hint 支持通过 Java API 和 SQL 注释两种方式。</p> 
<h3><a id="_162"></a><strong>行表达式</strong></h3> 
<p>在繁琐的数据分片规则配置中，随着数据节点的增多，大量的重复配置使得配置本身不易被维护。通过行表达式可以有效地<font color="orange">简化数据节点配置工作量</font>。</p> 
<p>对于常见的分片算法，使用 Java 代码实现并不有助于配置的统一管理。通过行表达式书写分片算法，可以有效地<font color="orange">将规则配置一同存放，更加易于浏览与存储</font>。</p> 
<p>只需要在配置中使用 <code>${expression}</code> 或者 <code>$-&gt;{expression}</code> 标识行表达式即可。目前支持<font color="orange">数据节点</font>和<font color="orange">分片算法</font>这两个部分的配置。行表达式的内容使用的是 Groovy 的语法，Groovy 能够支持的所有操作，行表达式均能够支持。例如：<code>${begin..end}</code> ：表示范围区间；<code>${[unit1, unit2, unit3]}</code> ：表示枚举值；如果连续出现多个行表达式，整个表达式最终的结果将会根据每个子表达式的结果进行笛卡尔组合</p> 
<p>e.g. <code>${['online', 'offline']}_table${1..2}</code> ，则最终解析为 online_table1，online_table2，offline_table1，offline_table2</p> 
<h3><a id="_172"></a>分布式主键</h3> 
<p>Apache ShardingSphere 不仅提供了内置的分布式主键生成器，例如 UUID、SNOWFLAKE，还抽离出分布式主键生成器的接口，方便用户自行实现自定义的自增主键生成器。</p> 
<h4><a id="UUID_176"></a>UUID</h4> 
<p>使用 UUID.randomUUID() 的方式。</p> 
<h4><a id="SNOWFLAKE_180"></a>SNOWFLAKE</h4> 
<p>使用 Twitter 的雪花算法（snowflake）生成 64 bit 的长整型数据，包括 1 bit 符号位、41bit 时间戳位、10 bit 工作进程位、12 bit 序列号位。</p> 
<p>符号位：预留，恒为零。</p> 
<p>时间戳位：约等于 69.73 年。ShardingSphere 的雪花算法的时间纪元从 2016 年11月1日零点开始，可以使用到 2086 年。</p> 
<p>工作进程位：对应每个工作进程 id。</p> 
<p>序列号位：在一毫秒内生成的 id。如果一毫秒内生成的数量超过了 4096，则生成器会等待到下个毫秒继续生成。</p> 
<p><strong>时钟回拨</strong></p> 
<p>服务器时钟回拨会导致产生重复序列，因此默认分布式主键生成器提供了一个最大容忍的时钟回拨毫秒数。 如果时钟回拨的时间超过最大容忍的毫秒数阈值，则程序报错；如果在可容忍的范围内，默认分布式主键生成器会等待时钟同步到最后一次主键生成的时间后再继续工作。 最大容忍的时钟回拨毫秒数的默认值为 0，可通过属性设置。</p> 
<h2><a id="_196"></a>分片策略</h2> 
<p>每个表最多可以指定一个分片策略。</p> 
<h3><a id="_200"></a><strong>行表达式分片策略</strong></h3> 
<p>对应 InlineShardingStrategy。使用 Groovy 的表达式，提供对 SQL 语句中的 = 和 in 的分片操作的支持，只支持单分片键。</p> 
<p><code>${begin..end}</code> ：表示范围区间</p> 
<p><code>${[unit1, unit2, unit3]}</code> ：表示枚举值</p> 
<p>行表达式如果连续出现多个行表达式，整个表达式最终的结果将会根据每个子表达式的结果进行笛卡尔组合。比如 <code>${['online', 'offline']}_table${1..2}</code> ，则最终解析为 online_table1，online_table2，offline_table1，offline_table2。</p> 
<p><font color="999aaa">java api 方式 - 数据分片</font></p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 数据分片
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShardingJdbcDemo</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">DataSource</span><span class="token punctuation">&gt;</span></span> dataSourceMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 配置数据源0</span>
        <span class="token class-name">DruidDataSource</span> dataSource0 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DruidDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource0<span class="token punctuation">.</span><span class="token function">setDriverClassName</span><span class="token punctuation">(</span><span class="token string">"com.mysql.cj.jdbc.Driver"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource0<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span><span class="token string">"jdbc:mysql://10.211.55.6:3306/ds0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource0<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource0<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSourceMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"ds0"</span><span class="token punctuation">,</span> dataSource0<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 配置数据源1</span>
        <span class="token class-name">DruidDataSource</span> dataSource1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DruidDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource1<span class="token punctuation">.</span><span class="token function">setDriverClassName</span><span class="token punctuation">(</span><span class="token string">"com.mysql.cj.jdbc.Driver"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource1<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span><span class="token string">"jdbc:mysql://10.211.55.14:3306/ds1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource1<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource1<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSourceMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"ds1"</span><span class="token punctuation">,</span> dataSource1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 配置数据源2</span>
        <span class="token class-name">DruidDataSource</span> dataSource2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DruidDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource2<span class="token punctuation">.</span><span class="token function">setDriverClassName</span><span class="token punctuation">(</span><span class="token string">"com.mysql.cj.jdbc.Driver"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource2<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span><span class="token string">"jdbc:mysql://10.211.55.15:3306/ds2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource2<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource2<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSourceMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"ds2"</span><span class="token punctuation">,</span> dataSource2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 配置表规则</span>
        <span class="token class-name">TableRuleConfiguration</span> orderRuleConfiguration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TableRuleConfiguration</span><span class="token punctuation">(</span><span class="token string">"t_order"</span><span class="token punctuation">,</span> <span class="token string">"ds${0..2}.t_order"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 配置分库策略</span>
        <span class="token class-name">InlineShardingStrategyConfiguration</span> databaseShardingStrategyConfiguration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InlineShardingStrategyConfiguration</span><span class="token punctuation">(</span><span class="token string">"order_id"</span><span class="token punctuation">,</span> <span class="token string">"ds${order_id % 3}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderRuleConfiguration<span class="token punctuation">.</span><span class="token function">setDatabaseShardingStrategyConfig</span><span class="token punctuation">(</span>databaseShardingStrategyConfiguration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 配置分表策略</span>
        <span class="token class-name">InlineShardingStrategyConfiguration</span> tableShardingStrategyConfiguration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InlineShardingStrategyConfiguration</span><span class="token punctuation">(</span><span class="token string">"order_id"</span><span class="token punctuation">,</span> <span class="token string">"t_order"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderRuleConfiguration<span class="token punctuation">.</span><span class="token function">setTableShardingStrategyConfig</span><span class="token punctuation">(</span>tableShardingStrategyConfiguration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 配置分片规则</span>
        <span class="token class-name">ShardingRuleConfiguration</span> shardingRuleConfiguration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ShardingRuleConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 添加表规则</span>
        shardingRuleConfiguration<span class="token punctuation">.</span><span class="token function">getTableRuleConfigs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderRuleConfiguration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">PreparedStatement</span> preparedStatement <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">DataSource</span> dataSource <span class="token operator">=</span> <span class="token class-name">ShardingDataSourceFactory</span><span class="token punctuation">.</span><span class="token function">createDataSource</span><span class="token punctuation">(</span>dataSourceMap<span class="token punctuation">,</span> shardingRuleConfiguration<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">"select * from t_order where order_id = ?"</span><span class="token punctuation">;</span>
            connection <span class="token operator">=</span> dataSource<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            preparedStatement <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
            preparedStatement<span class="token punctuation">.</span><span class="token function">setLong</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ResultSet</span> resultSet <span class="token operator">=</span> preparedStatement<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>resultSet<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"order_id &gt;&gt;&gt; "</span> <span class="token operator">+</span> resultSet<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"user_id &gt;&gt;&gt; "</span> <span class="token operator">+</span> resultSet<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>preparedStatement <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    preparedStatement<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>connection <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>


    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><font color="999aaa">Spring Boot yml 方式 - 数据分片</font></p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
    <span class="token key atrule">application</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> shardingsphere<span class="token punctuation">-</span>demo
    <span class="token key atrule">shardingsphere</span><span class="token punctuation">:</span>
        <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
            <span class="token key atrule">names</span><span class="token punctuation">:</span> ds0<span class="token punctuation">,</span>ds1<span class="token punctuation">,</span>ds2
            <span class="token key atrule">ds0</span><span class="token punctuation">:</span>
                <span class="token key atrule">type</span><span class="token punctuation">:</span> com.alibaba.druid.pool.DruidDataSource
                <span class="token key atrule">driverClassName</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
                <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//10.211.55.6<span class="token punctuation">:</span>3306/ds0
                <span class="token key atrule">username</span><span class="token punctuation">:</span> root
                <span class="token key atrule">password</span><span class="token punctuation">:</span> root
            <span class="token key atrule">ds1</span><span class="token punctuation">:</span>
                <span class="token key atrule">type</span><span class="token punctuation">:</span> com.alibaba.druid.pool.DruidDataSource
                <span class="token key atrule">driverClassName</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
                <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//10.211.55.14<span class="token punctuation">:</span>3306/ds1
                <span class="token key atrule">username</span><span class="token punctuation">:</span> root
                <span class="token key atrule">password</span><span class="token punctuation">:</span> root
            <span class="token key atrule">ds2</span><span class="token punctuation">:</span>
                <span class="token key atrule">type</span><span class="token punctuation">:</span> com.alibaba.druid.pool.DruidDataSource
                <span class="token key atrule">driverClassName</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
                <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//10.211.55.15<span class="token punctuation">:</span>3306/ds2
                <span class="token key atrule">username</span><span class="token punctuation">:</span> root
                <span class="token key atrule">password</span><span class="token punctuation">:</span> root
        <span class="token key atrule">sharding</span><span class="token punctuation">:</span>
            <span class="token key atrule">tables</span><span class="token punctuation">:</span>
                <span class="token key atrule">t_order</span><span class="token punctuation">:</span>
                    <span class="token key atrule">actualDataNodes</span><span class="token punctuation">:</span> ds$<span class="token punctuation">{<!-- --></span>0..2<span class="token punctuation">}</span>.t_order
                    <span class="token key atrule">logicTable</span><span class="token punctuation">:</span> t_order
                    <span class="token key atrule">databaseStrategy</span><span class="token punctuation">:</span>
                        <span class="token key atrule">inline</span><span class="token punctuation">:</span>
                            <span class="token key atrule">sharding-column</span><span class="token punctuation">:</span> order_id
                            <span class="token key atrule">algorithm-expression</span><span class="token punctuation">:</span> ds$<span class="token punctuation">{<!-- --></span>order_id % 3<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_328"></a>标准分片策略</h3> 
<p>对应 StandardShardingStrategy。提供对 SQL 语句中的 =、&gt;、 &lt;、 &gt;=、&lt;=、in、between and 的分片操作支持。只支持单分片键。标准分片策略提供了 PreciseShardingAlgorithm、RangeShardingAlgorithm 两种分片算法。PreciseShardingAlgorithm 是必选的，RangeShardingAlgorithm 是可选的。</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
	<span class="token key atrule">shardingsphere</span><span class="token punctuation">:</span>
		<span class="token key atrule">sharding</span><span class="token punctuation">:</span>
			<span class="token key atrule">tables</span><span class="token punctuation">:</span>
				<span class="token key atrule">t_order</span><span class="token punctuation">:</span> 
					<span class="token key atrule">actualDataNodes</span><span class="token punctuation">:</span> ds$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{<!-- --></span>0..2<span class="token punctuation">}</span>.t_order
          <span class="token key atrule">logicTable</span><span class="token punctuation">:</span> t_order
          <span class="token key atrule">databaseStrategy</span><span class="token punctuation">:</span>
          	<span class="token key atrule">standard</span><span class="token punctuation">:</span>
            	<span class="token key atrule">shardingColumn</span><span class="token punctuation">:</span> order_id
            	<span class="token key atrule">preciseAlgorithmClassName</span><span class="token punctuation">:</span> com.shardingsphere.demo.algorithm.MyPreciseShardingAlgorithm
              <span class="token key atrule">rangeAlgorithmClassName</span><span class="token punctuation">:</span> com.shardingsphere.demo.algorithm.MyRangeShardingAlgorithm
</code></pre> 
<h4><a id="_347"></a>精确分片算法</h4> 
<p>对应 PreciseShardingAlgorithm。用于处理单分片键进行 = 、in 操作分片的场景。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyPreciseShardingAlgorithm</span> <span class="token keyword">implements</span> <span class="token class-name">PreciseShardingAlgorithm</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
  
  	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> <span class="token constant">LOGGER</span> <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">MyPreciseShardingAlgorithm</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PREFIX</span> <span class="token operator">=</span> <span class="token string">"ds"</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Sharding.
     *
     * @param availableTargetNames available data sources or tables's names
     * @param shardingValue        sharding value
     * @return sharding result for data source or table's name
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">doSharding</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> availableTargetNames<span class="token punctuation">,</span> <span class="token class-name">PreciseShardingValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> shardingValue<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"available target names &gt;&gt;&gt; {}"</span><span class="token punctuation">,</span> availableTargetNames<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> targetDatabase <span class="token operator">=</span> <span class="token constant">PREFIX</span> <span class="token operator">+</span> shardingValue<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> availableTargetNames<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> optional <span class="token operator">=</span> availableTargetNames<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>targetDatabase<span class="token operator">::</span><span class="token function">equals</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>optional<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> targetDatabase<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>targetDatabase <span class="token operator">+</span><span class="token string">" target name is not available."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_378"></a>范围分片算法</h4> 
<p>对应 RangeShardingAlgorithm。用于处理单分片键进行 between and、&gt;、&lt;、&gt;=、&lt;= 操作分片的场景。如果不配置 RangeShardingAlgorithm，SQL 中的 between and 将按照全库路由处理。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyRangeShardingAlgorithm</span> <span class="token keyword">implements</span> <span class="token class-name">RangeShardingAlgorithm</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> <span class="token constant">LOGGER</span> <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">MyRangeShardingAlgorithm</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PREFIX</span> <span class="token operator">=</span> <span class="token string">"ds"</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Long</span> <span class="token constant">STEP</span> <span class="token operator">=</span> <span class="token number">100L</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Long</span> <span class="token constant">INITIAL_END_POINT</span> <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Sharding.
     *
     * @param availableTargetNames available data sources or tables's names
     * @param shardingValue        sharding value
     * @return sharding results for data sources or tables's names
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">doSharding</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> availableTargetNames<span class="token punctuation">,</span> <span class="token class-name">RangeShardingValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> shardingValue<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"available target names &gt;&gt;&gt; {}"</span><span class="token punctuation">,</span> availableTargetNames<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> dataSources <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Range</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> valueRange <span class="token operator">=</span> shardingValue<span class="token punctuation">.</span><span class="token function">getValueRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> hasLowerBound <span class="token operator">=</span> valueRange<span class="token punctuation">.</span><span class="token function">hasLowerBound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> hasUpperBound <span class="token operator">=</span> valueRange<span class="token punctuation">.</span><span class="token function">hasUpperBound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"has upper bound - {}, has lower bound - {} "</span><span class="token punctuation">,</span> hasUpperBound<span class="token punctuation">,</span> hasLowerBound<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> lowerEndPoint <span class="token operator">=</span> <span class="token constant">INITIAL_END_POINT</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> upperEndPoint <span class="token operator">=</span> <span class="token constant">INITIAL_END_POINT</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hasLowerBound <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>hasUpperBound<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            lowerEndPoint <span class="token operator">=</span> valueRange<span class="token punctuation">.</span><span class="token function">lowerEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            upperEndPoint <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>lowerEndPoint <span class="token operator">+</span> <span class="token constant">STEP</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasLowerBound <span class="token operator">&amp;&amp;</span> hasUpperBound<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            upperEndPoint <span class="token operator">=</span> valueRange<span class="token punctuation">.</span><span class="token function">upperEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            lowerEndPoint <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>upperEndPoint <span class="token operator">-</span> <span class="token constant">STEP</span><span class="token punctuation">,</span> <span class="token constant">INITIAL_END_POINT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hasLowerBound <span class="token operator">&amp;&amp;</span> hasUpperBound<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            lowerEndPoint <span class="token operator">=</span> valueRange<span class="token punctuation">.</span><span class="token function">lowerEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            upperEndPoint <span class="token operator">=</span> valueRange<span class="token punctuation">.</span><span class="token function">upperEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Long</span> i <span class="token operator">=</span> lowerEndPoint<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> upperEndPoint<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">String</span> dataSource <span class="token operator">=</span> <span class="token constant">PREFIX</span> <span class="token operator">+</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> availableTargetNames<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dataSources<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> dataSources<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_431"></a><strong>复合分片策略</strong></h3> 
<p>对应 ComplexShardingStrategy。提供对 SQL语句中的 =、&gt;、&lt;、&gt;=、&lt;=、in、between and 的分片操作支持。支持多分片键。</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
	<span class="token key atrule">shardingsphere</span><span class="token punctuation">:</span>
		<span class="token key atrule">sharding</span><span class="token punctuation">:</span>
			<span class="token key atrule">tables</span><span class="token punctuation">:</span>
				<span class="token key atrule">t_order</span><span class="token punctuation">:</span> 
					<span class="token key atrule">actualDataNodes</span><span class="token punctuation">:</span> ds$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{<!-- --></span>0..2<span class="token punctuation">}</span>.t_order
          <span class="token key atrule">logicTable</span><span class="token punctuation">:</span> t_order
          <span class="token key atrule">databaseStrategy</span><span class="token punctuation">:</span>
          	<span class="token key atrule">complex</span><span class="token punctuation">:</span>
            	<span class="token key atrule">shardingColumns</span><span class="token punctuation">:</span> order_id<span class="token punctuation">,</span> user_id
            	<span class="token key atrule">algorithmClassName</span><span class="token punctuation">:</span> com.shardingsphere.demo.algorithm.MyComplexKeysShardingAlgorithm
</code></pre> 
<h4><a id="_449"></a><strong>复合分片算法</strong></h4> 
<p>对应 ComplexKeysShardingAlgorithm。用于处理使用多键作为分片键进行分片的场景。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyComplexKeysShardingAlgorithm</span> <span class="token keyword">implements</span> <span class="token class-name">ComplexKeysShardingAlgorithm</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SHARDING_KEY</span> <span class="token operator">=</span> <span class="token string">"order_id"</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SHARDING_KEY2</span> <span class="token operator">=</span> <span class="token string">"user_id"</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PREFIX</span> <span class="token operator">=</span> <span class="token string">"ds"</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Sharding.
     *
     * @param availableTargetNames available data sources or tables's names
     * @param shardingValue        sharding value
     * @return sharding results for data sources or tables's names
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">doSharding</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> availableTargetNames<span class="token punctuation">,</span> <span class="token class-name">ComplexKeysShardingValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> shardingValue<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> targetDataSources <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> columnNameAndShardingValuesMap <span class="token operator">=</span> shardingValue<span class="token punctuation">.</span><span class="token function">getColumnNameAndShardingValuesMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>columnNameAndShardingValuesMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token constant">SHARDING_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> orderIdShardingValues <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>columnNameAndShardingValuesMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">SHARDING_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>columnNameAndShardingValuesMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token constant">SHARDING_KEY2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> userIdShardingValues <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>columnNameAndShardingValuesMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">SHARDING_KEY2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Long</span> orderIdShardingValue <span class="token operator">:</span> orderIdShardingValues<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>orderIdShardingValue <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        targetDataSources<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">PREFIX</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Long</span> userIdShardingValue <span class="token operator">:</span> userIdShardingValues<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        targetDataSources<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">PREFIX</span> <span class="token operator">+</span> <span class="token punctuation">(</span>userIdShardingValue <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> availableTargetNames<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> targetDataSources<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="Hint_494"></a>Hint分片策略</h3> 
<p>对应 HintShardingStrategy。通过 Hint 指定分片值而非从 SQL 中提取分片值的方式进行分片的策略。</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
	<span class="token key atrule">shardingsphere</span><span class="token punctuation">:</span>
		<span class="token key atrule">sharding</span><span class="token punctuation">:</span>
			<span class="token key atrule">tables</span><span class="token punctuation">:</span>
				<span class="token key atrule">t_order</span><span class="token punctuation">:</span> 
					<span class="token key atrule">actualDataNodes</span><span class="token punctuation">:</span> ds$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{<!-- --></span>0..2<span class="token punctuation">}</span>.t_order
          <span class="token key atrule">logicTable</span><span class="token punctuation">:</span> t_order
          <span class="token key atrule">databaseStrategy</span><span class="token punctuation">:</span>
          	<span class="token key atrule">hint</span><span class="token punctuation">:</span>
            	<span class="token key atrule">algorithmClassName</span><span class="token punctuation">:</span> com.mzs.shardingsphere.demo.algorithm.MyHintShardingAlgorithm
</code></pre> 
<h4><a id="Hint_511"></a>Hint分片算法</h4> 
<p>对应 HintShardingAlgorithm。用于处理使用 Hint 行分片的场景。</p> 
<blockquote> 
 <p>在一些场景中，分片条件不存在于 SQL 中，而是存在于外部业务逻辑。ShardingSphere 提供了一种通过外部指定分片结果的方式，叫做 Hint。</p> 
 <p>实现机制：ShardingSphere 使用 ThreadLocal 管理分片键值。可以通过编程的方式向 HintManager 中添加分片条件，该分片条件仅仅在当前线程中生效。</p> 
</blockquote> 
<p><font color="999aaa">在数据库的 crud 操作的前面加上如下几行代码：</font></p> 
<pre><code class="prism language-java"><span class="token class-name">HintManager</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">HintManager</span> hintManager <span class="token operator">=</span> <span class="token class-name">HintManager</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  hintManager<span class="token punctuation">.</span><span class="token function">setDatabaseShardingValue</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定分片值</span>
	<span class="token comment">// hintManager.addDatabaseShardingValue("t_order", 0L);	// 指定逻辑表名与分片值</span>
	<span class="token comment">// hintManager.addTableShardingValue("t_order", 0L);		// 指定逻辑表名与分片值</span>
  <span class="token comment">// hintManager.setMasterRouteOnly();										// 强制从MySQL的主节点读取数据</span>
  <span class="token comment">// 执行数据库的 crud 操作</span>
<span class="token punctuation">}</span>
</code></pre> 
<p></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyHintShardingAlgorithm</span> <span class="token keyword">implements</span> <span class="token class-name">HintShardingAlgorithm</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PREFIX</span> <span class="token operator">=</span> <span class="token string">"ds"</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Sharding.
     *
     * &lt;p&gt;sharding value injected by hint, not in SQL.&lt;/p&gt;
     *
     * @param availableTargetNames available data sources or tables's names
     * @param shardingValue        sharding value
     * @return sharding result for data sources or tables's names
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">doSharding</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> availableTargetNames<span class="token punctuation">,</span> <span class="token class-name">HintShardingValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> shardingValue<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> dataSourceNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token comment">// 遍历上述的 HintManager 指定的分片值</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Long</span> value <span class="token operator">:</span> shardingValue<span class="token punctuation">.</span><span class="token function">getValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>	
            dataSourceNames<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">PREFIX</span> <span class="token operator">+</span> <span class="token punctuation">(</span>value <span class="token operator">%</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> dataSourceNames<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_560"></a>不分片策略</h3> 
<p>对应NoneShardingStrategy。不分片的策略。</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
	<span class="token key atrule">shardingsphere</span><span class="token punctuation">:</span>
		<span class="token key atrule">sharding</span><span class="token punctuation">:</span>
			<span class="token key atrule">tables</span><span class="token punctuation">:</span>
				<span class="token key atrule">t_order</span><span class="token punctuation">:</span> 
					<span class="token key atrule">actualDataNodes</span><span class="token punctuation">:</span> ds0.t_order
          <span class="token key atrule">logicTable</span><span class="token punctuation">:</span> t_order
          <span class="token key atrule">databaseStrategy</span><span class="token punctuation">:</span>
          	<span class="token key atrule">none</span><span class="token punctuation">:</span>
</code></pre> 
<h2><a id="_576"></a>读写分离</h2> 
<p><font color="999aaa">java api 方式- 读写分离</font></p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 读写分离
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShardingJdbcDemo2</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">DataSource</span><span class="token punctuation">&gt;</span></span> dataSourceMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 配置数据源1</span>
        <span class="token class-name">DruidDataSource</span> dataSource1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DruidDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource1<span class="token punctuation">.</span><span class="token function">setDriverClassName</span><span class="token punctuation">(</span><span class="token string">"com.mysql.cj.jdbc.Driver"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource1<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span><span class="token string">"jdbc:mysql://10.211.55.7:3306/ds3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource1<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource1<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSourceMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"master0"</span><span class="token punctuation">,</span> dataSource1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 配置数据源2</span>
        <span class="token class-name">DruidDataSource</span> dataSource2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DruidDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource2<span class="token punctuation">.</span><span class="token function">setDriverClassName</span><span class="token punctuation">(</span><span class="token string">"com.mysql.cj.jdbc.Driver"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource2<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span><span class="token string">"jdbc:mysql://10.211.55.8:3306/ds3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource2<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource2<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSourceMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"slave0"</span><span class="token punctuation">,</span> dataSource2<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">MasterSlaveRuleConfiguration</span> masterSlaveRuleConfiguration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MasterSlaveRuleConfiguration</span><span class="token punctuation">(</span>
                <span class="token string">"master_slave_shard"</span><span class="token punctuation">,</span> <span class="token string">"master0"</span><span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token string">"slave0"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">PreparedStatement</span> preparedStatement <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">DataSource</span> dataSource <span class="token operator">=</span> <span class="token class-name">MasterSlaveDataSourceFactory</span><span class="token punctuation">.</span><span class="token function">createDataSource</span><span class="token punctuation">(</span>dataSourceMap<span class="token punctuation">,</span> masterSlaveRuleConfiguration<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">"select * from user_info where user_id = ?"</span><span class="token punctuation">;</span>
            connection <span class="token operator">=</span> dataSource<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            preparedStatement <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
            preparedStatement<span class="token punctuation">.</span><span class="token function">setLong</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ResultSet</span> resultSet <span class="token operator">=</span> preparedStatement<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>resultSet<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"user_id &gt;&gt;&gt; "</span> <span class="token operator">+</span> resultSet<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"user_name &gt;&gt;&gt; "</span> <span class="token operator">+</span> resultSet<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>preparedStatement <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    preparedStatement<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>connection <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><font color="999aaa">Spring Boot yml 方式 - 读写分离</font></p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
    <span class="token key atrule">shardingsphere</span><span class="token punctuation">:</span>
        <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
            <span class="token key atrule">names</span><span class="token punctuation">:</span> master0<span class="token punctuation">,</span>slave0
            <span class="token key atrule">master0</span><span class="token punctuation">:</span>
                <span class="token key atrule">type</span><span class="token punctuation">:</span> com.alibaba.druid.pool.DruidDataSource
                <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
                <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//10.211.55.7<span class="token punctuation">:</span>3306/ds3
                <span class="token key atrule">username</span><span class="token punctuation">:</span> root
                <span class="token key atrule">password</span><span class="token punctuation">:</span> root
            <span class="token key atrule">slave0</span><span class="token punctuation">:</span>
                <span class="token key atrule">type</span><span class="token punctuation">:</span> com.alibaba.druid.pool.DruidDataSource
                <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
                <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//10.211.55.8<span class="token punctuation">:</span>3306/ds3
                <span class="token key atrule">username</span><span class="token punctuation">:</span> root
                <span class="token key atrule">password</span><span class="token punctuation">:</span> root
        <span class="token key atrule">sharding</span><span class="token punctuation">:</span>
            <span class="token key atrule">tables</span><span class="token punctuation">:</span>
                <span class="token key atrule">user_info</span><span class="token punctuation">:</span>
                    <span class="token key atrule">actualDataNodes</span><span class="token punctuation">:</span> master0.user_info
                    <span class="token key atrule">databaseStrategy</span><span class="token punctuation">:</span>
                        <span class="token key atrule">inline</span><span class="token punctuation">:</span>
                            <span class="token key atrule">sharding-column</span><span class="token punctuation">:</span> user_id
                            <span class="token key atrule">algorithm-expression</span><span class="token punctuation">:</span> master0
                    <span class="token key atrule">keyGenerator</span><span class="token punctuation">:</span>
                        <span class="token key atrule">type</span><span class="token punctuation">:</span> SNOWFLAKE
                        <span class="token key atrule">column</span><span class="token punctuation">:</span> user_id
            <span class="token key atrule">master-slave-rules</span><span class="token punctuation">:</span>
                <span class="token key atrule">master0</span><span class="token punctuation">:</span>
                    <span class="token key atrule">master-data-source-name</span><span class="token punctuation">:</span> master0
                    <span class="token key atrule">slave-data-source-names</span><span class="token punctuation">:</span> slave0
</code></pre> 
<h2><a id="_677"></a>分页</h2> 
<p>完全支持 MySQL、PostgreSQL 和 Oracle 的分页查询，SQLServer 由于分页查询较为复杂，仅部分支持。</p> 
<p>详情查看 <a href="https://shardingsphere.apache.org/document/4.1.1/cn/features/sharding/use-norms/pagination/" rel="nofollow">ShardingSphere4.x版本分页</a></p> 
<h2><a id="SQL__683"></a>SQL 使用规范</h2> 
<p>详情查看 <a href="https://shardingsphere.apache.org/document/4.1.1/cn/features/sharding/use-norms/sql/#distinct%E6%94%AF%E6%8C%81%E6%83%85%E5%86%B5%E8%AF%A6%E7%BB%86%E8%AF%B4%E6%98%8E" rel="nofollow">ShardingSphere4.x版本SQL规范</a></p> 
<h2><a id="_687"></a>分布式事务</h2> 
<p>首先需要导入如下依赖：</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.shardingsphere<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>sharding-jdbc-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${shardingsphere.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 使用XA事务时，需要引入此模块 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.shardingsphere<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>sharding-transaction-xa-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${shardingsphere.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 使用BASE事务时，需要引入此模块 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.shardingsphere<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>sharding-transaction-base-seata-at<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${sharding-sphere.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>然后配置 Spring Boot 的事务管理器。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableTransactionManagement</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransactionConfiguration</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">PlatformTransactionManager</span> <span class="token function">txManager</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">DataSource</span> dataSource<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DataSourceTransactionManager</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">JdbcTemplate</span> <span class="token function">jdbcTemplate</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">DataSource</span> dataSource<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JdbcTemplate</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>最后在业务代码中使用分布式事务。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Transactional</span>
<span class="token annotation punctuation">@ShardingTransactionType</span><span class="token punctuation">(</span><span class="token class-name">TransactionType</span><span class="token punctuation">.</span><span class="token constant">XA</span><span class="token punctuation">)</span>  <span class="token comment">// 支持TransactionType.LOCAL, TransactionType.XA, TransactionType.BASE</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    jdbcTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"INSERT INTO t_order (user_id, status) VALUES (?, ?)"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">PreparedStatementCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> preparedStatement <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
        preparedStatement<span class="token punctuation">.</span><span class="token function">setObject</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        preparedStatement<span class="token punctuation">.</span><span class="token function">setObject</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        preparedStatement<span class="token punctuation">.</span><span class="token function">executeUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>本地事务</strong></p> 
<p>对应 TransactionType.LOCAL。</p> 
<ul><li> <p>完全支持非跨库事务，例如：仅分表，或者分库但是路由的结果在单库中。</p> </li><li> <p>完全支持因逻辑夜场导致的跨库事务。例如：同一事务中，跨两个库更新。更新完毕后，抛出空指针，则两个库的内容都能回滚。</p> </li><li> <p>不支持因网络、硬件异常导致的跨库事务。例如：同一事务中，跨两个库更新，更新完毕后、未提交之前，第一个库宕机，则只有第二个库的数据提交。</p> </li></ul> 
<p><strong>两阶段事务-XA</strong></p> 
<p>对应 TransactionType.XA。</p> 
<p>ShardingSpere 默认的 XA 事务管理器是 Atomikos，在项目的 logs 目录中会生成 xa_tx.log 文件，用于崩溃恢复的。</p> 
<p>也可以在项目的 classpath 中添加 jta.properties 来定制化 Atomikos 配置项。具体可以参考<a href="https://www.atomikos.com/Documentation/JtaProperties" rel="nofollow">Atomikos 官方文档</a>。</p> 
<ul><li>支持数据分片后的跨库XA事务</li><li>两阶段提交保证操作的原子性和数据的强一致性</li><li>服务宕机重启后，提交/回滚中的事务可自动恢复</li><li>SPI机制整合主流的XA事务管理器，默认Atomikos，可以选择使用Narayana和Bitronix</li><li>同时支持XA和非XA的连接池</li><li>提供spring-boot和namespace的接入端</li><li>不支持服务宕机后，在其它机器上恢复提交/回滚中的数据</li></ul> 
<p><strong>柔性事务</strong></p> 
<p>对应 TransactionType.BASE。</p> 
<ul><li> <p>完全支持跨库分布式事务</p> </li><li> <p>支持RC隔离级别</p> </li><li> <p>通过undo快照进行事务回滚</p> </li><li> <p>支持服务宕机后的，自动恢复提交中的事务</p> </li><li> <p>需要额外部署Seata-server服务进行分支事务的协调</p> </li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/241a871b083a7cb32933b7c6d756d60a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">用python写出通过5天的交通流量数据来训练算法，以预测第六天的交通拥堵情况...</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/40319e73d0204b036f4ff575e1392b1d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">辉芒微(FMD)单片机开发环境搭建</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>