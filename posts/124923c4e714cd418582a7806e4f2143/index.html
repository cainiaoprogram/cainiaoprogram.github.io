<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Springcloud 微服务实战笔记 Feign - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Springcloud 微服务实战笔记 Feign" />
<meta property="og:description" content="优点 基于Netflix Feign实现，整合了Spring cloud Ribbon 和 Spring cloud Hystrix
提供了声明式的WEB服务客户端定义方式
扩展了Spring MVC的注解支持
使用 1、pom导入包：
&lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-feign&lt;/artifactId&gt; &lt;version&gt;1.4.4.RELEASE&lt;/version&gt; &lt;/dependency&gt; 2、接口增加注解： @FeignClient
@FeignClient(name = &#34;spring-cloud-study-demo&#34;) public interface DemoRemoteClient { @GetMapping(&#34;/demo/getData/{uid}&#34;) public ApiReturnObject getData(@PathVariable(value=&#34;uid&#34;) String uid,@RequestParam(value=&#34;data&#34;) String data); } 注解@FeignClient的name参数配置为服务名(服务提供方可以自己随便写一个)
3、Controller直接调用
@RestController public class FeignController { @Resource DemoRemoteClient demoRemoteClient; @GetMapping(&#34;/remote/demo/getData/{uid}&#34;) public ApiReturnObject basePath(@PathVariable String uid ,String data){ return demoRemoteClient.getData(uid, data); } } 4、启动类增加注解 @EnableFeignClients
@EnableEurekaClient @EnableFeignClients @SpringBootApplication public class SpringCloudStudyFeignApplication { public static void main(String[] args) { SpringApplication." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/124923c4e714cd418582a7806e4f2143/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-04T11:14:22+08:00" />
<meta property="article:modified_time" content="2024-01-04T11:14:22+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Springcloud 微服务实战笔记 Feign</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>优点</h2> 
<p>基于Netflix Feign实现，整合了Spring cloud Ribbon 和 Spring cloud Hystrix</p> 
<p>提供了声明式的WEB服务客户端定义方式</p> 
<p>扩展了Spring MVC的注解支持</p> 
<p></p> 
<h2>使用</h2> 
<p>1、pom导入包：</p> 
<pre><code class="language-XML">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-feign&lt;/artifactId&gt;
    &lt;version&gt;1.4.4.RELEASE&lt;/version&gt;
&lt;/dependency&gt;</code></pre> 
<p>2、接口增加注解： @FeignClient</p> 
<pre><code class="language-java">@FeignClient(name = "spring-cloud-study-demo")
public interface DemoRemoteClient {
	
	@GetMapping("/demo/getData/{uid}")
	public ApiReturnObject getData(@PathVariable(value="uid") String uid,@RequestParam(value="data") String data);

}</code></pre> 
<p>注解@FeignClient的name参数配置为服务名(服务提供方可以自己随便写一个)</p> 
<p> </p> 
<p>3、Controller直接调用</p> 
<pre><code class="language-java">@RestController
public class FeignController {
	@Resource
	DemoRemoteClient demoRemoteClient;
	
	@GetMapping("/remote/demo/getData/{uid}")
	public ApiReturnObject  basePath(@PathVariable String uid ,String data){
		return demoRemoteClient.getData(uid, data);
	}
}</code></pre> 
<p>4、启动类增加注解 @EnableFeignClients</p> 
<pre><code class="language-java">@EnableEurekaClient
@EnableFeignClients
@SpringBootApplication
public class SpringCloudStudyFeignApplication {
	public static void main(String[] args) {
		SpringApplication.run(SpringCloudStudyFeignApplication.class,args);
		System.out.println("http://127.0.0.1:6666/feign/remote/demo/222");
	}
}</code></pre> 
<p> </p> 
<h2 id="ribbon配置">Ribbon配置</h2> 
<h3 id="全局配置">全局配置</h3> 
<p>直接使用ribbon.key=value的方式设置即可，比如：</p> 
<pre><code class="language-bash">ribbon.ConnectTime=500
ribbon.ReadTimeout=5000
</code></pre> 
<p></p> 
<h3 id="指定服务配置">指定服务配置</h3> 
<p>使用@FeignClient注解中的name或则Value属性值来设置对应的Ribbon参数，比如：</p> 
<pre><code>SPRING-CLOUD-STUDY-DEMO.ribbon.ConnectTime=500
SPRING-CLOUD-STUDY-DEMO.ribbon.ReadTimeout=5000
SPRING-CLOUD-STUDY-DEMO.ribbon.OkToRetryOnAllOperations=true
</code></pre> 
<p></p> 
<h3 id="重试机制">重试机制</h3> 
<p>Spring Cloud Feign中默认实现了请求的重试机制(重试次数参数可配置)</p> 
<p>需注意：Ribbon的超时与Hystrix的超时是两个概念。为了能让Ribbon超时重试生效，需要让Hystrix的超时时间设置大于Ribbon的超时时间，否则Hystrix超时后直接熔断了，也就没有重试了。</p> 
<p></p> 
<h2 id="hystrix配置">Hystrix配置</h2> 
<h3 id="全局配置-1">全局配置</h3> 
<p>Hystrix全局配置与Ribbon全局配置一样，直接使用默认前缀hystrix.xxx.xxx.xx即可配置，比如设置超时时间：</p> 
<pre><code>hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds=5000
hystrix.command.default.execution.timeout.enabled=false ##来关闭熔断功能。
</code></pre> 
<p>在 对 Hystrix 进 行 配 置 之 前 ， 我 们 需 要 确 认feign.hystrix.enabled参数没有被设置为false，否则该参数设置会关闭Feign客户端的Hystrix支持。</p> 
<p></p> 
<h3 id="禁用hystrix">禁用Hystrix</h3> 
<ol><li>通过feign.hystrix.enabled参数配置，全局配置，默认为false。</li><li>针对某个服务关闭hystrix，需要通过使用@Scope（"prototype"）注解为指定的客户端配置Feign.Builder实例，详细实现步骤如下所示。 <pre><code class="language-java">// 构建一个关闭Hystrix的配置类
@Configuration
public class DisableHystrixConfiguration {
  @Bean
  @Scope（"prototype"）
  public Feign.Builder feignBuilder（）{
  return Feign.builder（）;
}

}
// 在HelloService的@FeignClient注解中，通过configuration参数引入上面实现的配置。
@FeignClient(name="SPRING-CLOUD-STUDY-DEMO",configuration=DisableHystrixConfiguration.class)
public interface HelloService {
  ...
}
</code></pre> </li></ol> 
<p></p> 
<h3 id="指定命令配置">指定命令配置</h3> 
<p>采用hystrix.command.(commadKey默认为方法名)为前缀来进行配置</p> 
<p></p> 
<h3 id="服务降级配置">服务降级配置</h3> 
<p>注解@FeignClient包含参数：org.springframework.cloud.openfeign.FeignClient#fallback</p> 
<p>fallback参数为实现FeignClient接口实现类class</p> 
<pre><code class="language-java">// FeignClient注解增加fallback参数，配置为当前接口实现类
@FeignClient(name = "SPRING-CLOUD-STUDY-DEMO", fallback = DemoFallback.class)
public interface DemoFeignClient {

    @GetMapping("/demo/hello")
    String hello();
}

// 实现FeignClient接口，重写降级方法
@Component
public class DemoFallback implements DemoFeignClient{

    @Override
    public String hello() {
        return "fallbcak";
    }
}
</code></pre> 
<p></p> 
<h3 id="请求压缩">请求压缩</h3> 
<p>Spring Cloud Feign支持对请求与响应进行GZIP压缩，以减少通信过程中的性能损耗。我们只需通过下面两个参数设置，就能开启请求与响应的压缩功能：</p> 
<pre><code>feign.compression.request.enabled=true
feign.compression.response.enabled=true
</code></pre> 
<p>指定压缩类型</p> 
<pre><code>feign.compression.request.mime.types=text/xml,application/xml,application/json(默认值)
</code></pre> 
<p>设置请求压缩的大小下限，只有超过这个大小的请求才会对其进行压缩</p> 
<pre><code>feign.compression.request.min-request-size=2048(默认值)
</code></pre> 
<p></p> 
<h2 id="工作原理">工作原理</h2> 
<p>1、获取feign相关配置信息</p> 
<p><img alt="" height="908" src="https://images2.imgbox.com/14/61/jPkkOlzt_o.png" width="1200"></p> 
<p>我们使用 Feign 的话，会在 Application 的主启动类上，标记 EnableFeignClient 注解，在要调用的接口上标记 FeignClient 注解。 ​在 EnableFeignClients 注解内部，有一个 @Import(FeignClientsRegistrar.class) ，这个类实现了 ImportBeanDefinitionRegistrar 接口，这个的话是 Spring Context 项目下的，所以会在 Spring Boot 项目启动的时候，会调用 FeignClientsRegistrar.registerBeanDefinitions , 扫描 FeiginClient 注解，并设置相关信息，主要实现在org.springframework.cloud.openfeign.FeignClientsRegistrar#registerDefaultConfiguration：</p> 
<pre><code class="language-java">private void registerDefaultConfiguration(AnnotationMetadata metadata,
            BeanDefinitionRegistry registry) {
        Map&lt;String, Object&gt; defaultAttrs = metadata
                .getAnnotationAttributes(EnableFeignClients.class.getName(), true);

        if (defaultAttrs != null &amp;&amp; defaultAttrs.containsKey("defaultConfiguration")) {
            String name;
            if (metadata.hasEnclosingClass()) {
                name = "default." + metadata.getEnclosingClassName();
            }
            else {
                name = "default." + metadata.getClassName();
            }
            registerClientConfiguration(registry, name,
                    defaultAttrs.get("defaultConfiguration"));
        }
    }
</code></pre> 
<p>2、扫描FeignClient注解接口</p> 
<p>主要实现org.springframework.cloud.openfeign.FeignClientsRegistrar#registerFeignClients：</p> 
<pre><code class="language-java">public void registerFeignClients(AnnotationMetadata metadata,
            BeanDefinitionRegistry registry) {
        ClassPathScanningCandidateComponentProvider scanner = getScanner();
        scanner.setResourceLoader(this.resourceLoader);

        Set&lt;String&gt; basePackages;

        Map&lt;String, Object&gt; attrs = metadata
                .getAnnotationAttributes(EnableFeignClients.class.getName());
        AnnotationTypeFilter annotationTypeFilter = new AnnotationTypeFilter(
                FeignClient.class);
        final Class&lt;?&gt;[] clients = attrs == null ? null
                : (Class&lt;?&gt;[]) attrs.get("clients");
        if (clients == null || clients.length == 0) {
            scanner.addIncludeFilter(annotationTypeFilter);
            basePackages = getBasePackages(metadata);
        }
        else {
            final Set&lt;String&gt; clientClasses = new HashSet&lt;&gt;();
            basePackages = new HashSet&lt;&gt;();
            for (Class&lt;?&gt; clazz : clients) {
                basePackages.add(ClassUtils.getPackageName(clazz));
                clientClasses.add(clazz.getCanonicalName());
            }
            AbstractClassTestingTypeFilter filter = new AbstractClassTestingTypeFilter() {
                @Override
                protected boolean match(ClassMetadata metadata) {
                    String cleaned = metadata.getClassName().replaceAll("\\$", ".");
                    return clientClasses.contains(cleaned);
                }
            };
            scanner.addIncludeFilter(
                    new AllTypeFilter(Arrays.asList(filter, annotationTypeFilter)));
        }

        for (String basePackage : basePackages) {
            Set&lt;BeanDefinition&gt; candidateComponents = scanner
                    .findCandidateComponents(basePackage);
            for (BeanDefinition candidateComponent : candidateComponents) {
                if (candidateComponent instanceof AnnotatedBeanDefinition) {
                    // verify annotated class is an interface
                    AnnotatedBeanDefinition beanDefinition = (AnnotatedBeanDefinition) candidateComponent;
                    AnnotationMetadata annotationMetadata = beanDefinition.getMetadata();
                    Assert.isTrue(annotationMetadata.isInterface(),
                            "@FeignClient can only be specified on an interface");

                    Map&lt;String, Object&gt; attributes = annotationMetadata
                            .getAnnotationAttributes(
                                    FeignClient.class.getCanonicalName());

                    String name = getClientName(attributes);
                    registerClientConfiguration(registry, name,
                            attributes.get("configuration"));

                    registerFeignClient(registry, annotationMetadata, attributes);
                }
            }
        }
    }
</code></pre> 
<p>最终会调用org.springframework.cloud.openfeign.FeignClientsRegistrar#registerFeignClient方法，主要实现：</p> 
<pre><code class="language-java">private void registerFeignClient(BeanDefinitionRegistry registry,
            AnnotationMetadata annotationMetadata, Map&lt;String, Object&gt; attributes) {
        String className = annotationMetadata.getClassName();
        BeanDefinitionBuilder definition = BeanDefinitionBuilder
                .genericBeanDefinition(FeignClientFactoryBean.class);
        validate(attributes);
        definition.addPropertyValue("url", getUrl(attributes));
        definition.addPropertyValue("path", getPath(attributes));
        String name = getName(attributes);
        definition.addPropertyValue("name", name);
        String contextId = getContextId(attributes);
        definition.addPropertyValue("contextId", contextId);
        definition.addPropertyValue("type", className);
        definition.addPropertyValue("decode404", attributes.get("decode404"));
        definition.addPropertyValue("fallback", attributes.get("fallback"));
        definition.addPropertyValue("fallbackFactory", attributes.get("fallbackFactory"));
        definition.setAutowireMode(AbstractBeanDefinition.AUTOWIRE_BY_TYPE);

        String alias = contextId + "FeignClient";
        AbstractBeanDefinition beanDefinition = definition.getBeanDefinition();
        beanDefinition.setAttribute(FactoryBean.OBJECT_TYPE_ATTRIBUTE, className);

        // has a default, won't be null
        boolean primary = (Boolean) attributes.get("primary");

        beanDefinition.setPrimary(primary);

        String qualifier = getQualifier(attributes);
        if (StringUtils.hasText(qualifier)) {
            alias = qualifier;
        }

        BeanDefinitionHolder holder = new BeanDefinitionHolder(beanDefinition, className,
                new String[] { alias });
        BeanDefinitionReaderUtils.registerBeanDefinition(holder, registry);
    }
</code></pre> 
<p>registerFeignClient中通过BeanDefinitionBuilder构建FeignClientFactoryBean(构建Feign的核心)，将通过@FeginClient 注解获取到的信息，都设置到这个 definition 中，如图：</p> 
<p><img alt="" height="583" src="https://images2.imgbox.com/e9/c8/cGygyUkd_o.png" width="699"></p> 
<p>3、FeignClientFactoryBean.getObject()方法 动态代理的实现入口</p> 
<pre><code class="language-java">&lt;T&gt; T getTarget() {
        FeignContext context = applicationContext.getBean(FeignContext.class);
        Feign.Builder builder = feign(context);

        if (!StringUtils.hasText(url)) {
            if (!name.startsWith("http")) {
                url = "http://" + name;
            }
            else {
                url = name;
            }
            url += cleanPath();
            return (T) loadBalance(builder, context,
                    new HardCodedTarget&lt;&gt;(type, name, url));
        }
        if (StringUtils.hasText(url) &amp;&amp; !url.startsWith("http")) {
            url = "http://" + url;
        }
        String url = this.url + cleanPath();
        Client client = getOptional(context, Client.class);
        if (client != null) {
            if (client instanceof LoadBalancerFeignClient) {
                // not load balancing because we have a url,
                // but ribbon is on the classpath, so unwrap
                client = ((LoadBalancerFeignClient) client).getDelegate();
            }
            if (client instanceof FeignBlockingLoadBalancerClient) {
                // not load balancing because we have a url,
                // but Spring Cloud LoadBalancer is on the classpath, so unwrap
                client = ((FeignBlockingLoadBalancerClient) client).getDelegate();
            }
            builder.client(client);
        }
        Targeter targeter = get(context, Targeter.class);
        return (T) targeter.target(this, builder, context,
                new HardCodedTarget&lt;&gt;(type, name, url));
    }
</code></pre> 
<p>方法这一系列执行后，生成动态代理对象，动态代理对象为每个方法都初始化了SynchronousMethodHandler负责处理方法的请求，然后将动态代理对象放入到Spring容器中，当执行Controller执行时候，其实执行的是InvacationHandler的invoke()方法。</p> 
<p>在创建SynchronousMethodHandler.Factory时候，发现是与LoadBalancerFeignClient结合</p> 
<p><img alt="" height="677" src="https://images2.imgbox.com/81/1e/rzhJYqrE_o.png" width="865"></p> 
<p>调用动态代理invoke方法时候，根据构造的Map&lt;Method, MethodHandler&gt;找到对应的handler对象，最终调用com.netflix.client.AbstractLoadBalancerAwareClient#executeWithLoadBalancer(S, com.netflix.client.config.IClientConfig)方法(Ribbon的实现)：</p> 
<pre><code class="language-java"> public T executeWithLoadBalancer(final S request, final IClientConfig requestConfig) throws ClientException {
        LoadBalancerCommand&lt;T&gt; command = buildLoadBalancerCommand(request, requestConfig);

        try {
            return command.submit(
                new ServerOperation&lt;T&gt;() {
                    @Override
                    public Observable&lt;T&gt; call(Server server) {
                        URI finalUri = reconstructURIWithServer(server, request.getUri());
                        S requestForServer = (S) request.replaceUri(finalUri);
                        try {
                            return Observable.just(AbstractLoadBalancerAwareClient.this.execute(requestForServer, requestConfig));
                        } 
                        catch (Exception e) {
                            return Observable.error(e);
                        }
                    }
                })
                .toBlocking()
                .single();
        } catch (Exception e) {
            Throwable t = e.getCause();
            if (t instanceof ClientException) {
                throw (ClientException) t;
            } else {
                throw new ClientException(e);
            }
        }
        
    }
</code></pre> 
<p>到这里其实就是Ribbon的实现了。</p> 
<p>参考资料：</p> 
<p>《Spring Cloud微服务实战》</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/16494d4ab9a42e7b5ad3e3964ad9e279/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">uniapp中uview组件库丰富的Slider 滑动选择器的使用方法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7c53e910956f7555b58861de7fc93867/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Javascript学习之路：JS中的遍历跳出循环总结</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>