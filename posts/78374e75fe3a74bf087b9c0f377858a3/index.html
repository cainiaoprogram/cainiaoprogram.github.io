<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>嵌入式Linux内核以及根文件系统制作 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="嵌入式Linux内核以及根文件系统制作" />
<meta property="og:description" content="内核制作 注意：
我测试的使用nandflsh中bootloader启动，sd卡bootloader启动有问题
制作嵌入式平台使用的Linux内核，方法和制作PC平台的Linux内核基本一致。
清除原有配置与中间文件
x86: make distclean
arm:make distclean
配置内核
x86: make menuconfig
arm:make menuconfig ARCH=arm
(一般来说有一个参考的配置文件)
编译内核
x86: make bzImage
arm:make uImage ARCH=arm CROSS_COMPILE=arm-linux-
(注意使用ARCH以及CROSS_COMPILE参数)
通过tftp传到内存中 (注意将uImage.bin移动到tftp服务器指定问文件夹内)
tftp 0xc0008000 uImage.bin
然后启动bootm c0008000
可以看到没有文件系统，内核无法进行挂载
根文件系统制作 建立根文件系统目录与文件 创建目录创建设备文件加入配置文件添加内核模块编译busybox 挂载文件系统到内核 挂载方式简介initramfs挂载NFS挂载 创建目录 mkdir bin dev etc lib proc sbin sys usr mnt tmp var
mkdir usr/bin usr/lib usr/sbin lib/modules
创建设备文件 cd rootfs/dev
mknod -m 666 console c 5 1
mknod -m 666 null c 1 3" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/78374e75fe3a74bf087b9c0f377858a3/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-09-29T11:22:35+08:00" />
<meta property="article:modified_time" content="2021-09-29T11:22:35+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">嵌入式Linux内核以及根文件系统制作</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>内核制作</h2> 
<p><strong>注意：</strong><br> <strong>我测试的使用nandflsh中bootloader启动，sd卡bootloader启动有问题</strong></p> 
<p>制作嵌入式平台使用的Linux内核，方法和制作PC平台的Linux内核基本一致。</p> 
<ol><li> <p>清除原有配置与中间文件<br> x86: make distclean<br> arm:make distclean</p> </li><li> <p>配置内核<br> x86: make menuconfig<br> arm:make menuconfig ARCH=arm<br> (一般来说有一个参考的配置文件)</p> </li><li> <p>编译内核<br> x86: make bzImage<br> arm:make uImage ARCH=arm CROSS_COMPILE=arm-linux-<br> (注意使用ARCH以及CROSS_COMPILE参数)</p> </li></ol> 
<p><img src="https://images2.imgbox.com/b7/05/u0Sz6IM0_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/55/01/EieMwovj_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="tftp_23"></a>通过tftp传到内存中</h2> 
<p>(注意将uImage.bin移动到tftp服务器指定问文件夹内)<br> <code>tftp 0xc0008000 uImage.bin</code></p> 
<p><img src="https://images2.imgbox.com/dd/f4/BZxeDODM_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/c3/a4/3Cyc3ib1_o.png" alt="在这里插入图片描述"><br> 然后启动<code>bootm c0008000</code></p> 
<p><img src="https://images2.imgbox.com/76/91/7NxSZZ25_o.png" alt="在这里插入图片描述"><br> 可以看到没有文件系统，内核无法进行挂载<br> <img src="https://images2.imgbox.com/68/2d/nkgsrAbm_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_36"></a>根文件系统制作</h2> 
<ul><li>建立根文件系统目录与文件 
  <ul><li>创建目录</li><li>创建设备文件</li><li>加入配置文件</li><li>添加内核模块</li><li>编译busybox</li></ul> </li><li>挂载文件系统到内核 
  <ul><li>挂载方式简介</li><li>initramfs挂载</li><li>NFS挂载</li></ul> </li></ul> 
<h3><a id="_49"></a>创建目录</h3> 
<p><code>mkdir bin dev etc lib proc sbin sys usr mnt tmp var</code><br> <code>mkdir usr/bin usr/lib usr/sbin lib/modules</code></p> 
<h3><a id="_53"></a>创建设备文件</h3> 
<p><code>cd rootfs/dev</code><br> <code>mknod -m 666 console c 5 1</code><br> <code>mknod -m 666 null c 1 3</code><br> (-m 属性、c表示字符设备、 5 主设备号、 1次设备号)</p> 
<h3><a id="_59"></a>加入配置文件</h3> 
<p><img src="https://images2.imgbox.com/85/9d/Inwp9KxF_o.png" alt="在这里插入图片描述"></p> 
<p><code>tar xvf etc.tar.gz</code><br> <code>mv etc/* ./root/etc/ -rf</code></p> 
<h3><a id="_67"></a>添加内核模块</h3> 
<p><code>cd ../linux</code>(linux是上面我们制作内核的文件)<br> <code>make modules ARCH=arm CROSS_COMPILE=arm-linux-</code><br> <img src="https://images2.imgbox.com/c2/82/93fnAlPN_o.png" alt="在这里插入图片描述"></p> 
<p><code>make modules_install ARCH=arm INSTALL_MOD_PATH=../rootfs</code></p> 
<p><img src="https://images2.imgbox.com/17/04/1d4wOQJt_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/cf/f2/b1W1n01F_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="busybox_79"></a>编译/安装busybox</h3> 
<p><strong>Busybox:嵌入式开发中的瑞士军刀</strong></p> 
<p>配置busybox<br> <code>make menuconfig</code></p> 
<p>Busybox Settings **&gt;**build Options- <strong>&gt;</strong><br> 选中“Build busybox as a static binary”，静态链接Cross Compiler 'prefix (arm-linux-)<br> Installation Options- &gt;<br> 选中“Don’t use /usr"，选中该项可以避免busybox被安装到宿主系统的<br> /usr目录下,破坏宿主系统<br> Busybox Installation Prefix (/xxx/rootfs)<br> 该选项表明编译后的busybox的安装位置</p> 
<p><img src="https://images2.imgbox.com/18/18/FQUT8FA5_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/5b/e1/uhnNAVAE_o.png" alt="在这里插入图片描述"></p> 
<p>之后使用<code>make</code>开始编译</p> 
<p>编译完成<br> <img src="https://images2.imgbox.com/ea/38/L1xUnTu2_o.png" alt="在这里插入图片描述"></p> 
<p>安装<code>make install</code></p> 
<p><img src="https://images2.imgbox.com/be/9d/aMjIRuP0_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/ca/77/fjw44pqm_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/b3/9a/2jHHybMm_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_111"></a>挂载根文件系统到内核</h3> 
<h4><a id="_112"></a>挂载方式</h4> 
<p>根据存<strong>储设备的硬件特性、系统需求</strong>,不同的文件系统类型有不同的应用场合。在嵌入式Linux应用中，主要的存储设备为RAM和FLASH，常用的基于存储设备的文件系统类型包括: jffs2 , yaffs2 , ubifs,ramdisk等</p> 
<ul><li>基于NandFlash的文件系统 
  <ul><li>Yaffs2(可读可写)</li><li>UbiFS(可读可写)</li></ul> </li><li>基于NorFlash的文件系统 
  <ul><li>Jffs2(可读可写)</li></ul> </li><li>基于内存的文件系统(启动速度快) 
  <ul><li>Ramdisk(固定)</li><li>Initramfs（动态分配)</li></ul> </li><li>基于网络的文件系统 
  <ul><li>NFS(一般开发阶段使用)</li></ul> </li></ul> 
<h4><a id="Initramfs_126"></a>使用Initramfs</h4> 
<ol><li><code>cd rootfs</code><br> <code>ln -s ./bin/busybox init</code></li><li>配置Linux内核，支持initramfs</li></ol> 
<p><img src="https://images2.imgbox.com/5b/99/2Evfe8LX_o.png" alt="在这里插入图片描述"><br> 然后到内核文件所在目录输入<code>make menuconfig ARCH=arm</code><br> <img src="https://images2.imgbox.com/d3/49/rieLum4a_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/65/f5/GlskjlPB_o.png" alt="在这里插入图片描述"><br> 然后选择其下面一项指定位置<br> <img src="https://images2.imgbox.com/e9/cd/DphlqqL6_o.png" alt="在这里插入图片描述"><br> 最后保存退出，重新编译</p> 
<p><code>make uImage ARCH=arm CROSS_COMPILE=arm-linux-</code><br> <mark>这个时候编译的内核是有文件系统在其中的</mark></p> 
<p><img src="https://images2.imgbox.com/86/ba/jfj4eWaC_o.png" alt="在这里插入图片描述"><br> 复制到tftp目录中去<br> <img src="https://images2.imgbox.com/44/ae/EaHyPQ94_o.png" alt="在这里插入图片描述"><br> 然后再U-Boot中设置环境变量<br> <code>set bootargs noinitrd console=ttySAC0,115200</code> <br> 然后再U-Boot中通过tftp下载 <br> <code>tftp c0008000 uImage.bin</code></p> 
<p><img src="https://images2.imgbox.com/7b/e1/hJeocSjD_o.png" alt="在这里插入图片描述"><br> 然后启动<br> <code>bootm c0008000</code></p> 
<p><img src="https://images2.imgbox.com/4e/88/VKMgmrTX_o.png" alt="在这里插入图片描述"><br> 可以看到系统被成功启动<br> <img src="https://images2.imgbox.com/02/61/7EoiSP2C_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="NFSnetwork_file_system_160"></a>使用NFS(network file system)</h4> 
<p>首先取消initramfs,在内核文件目录<br> <code>make menuconfig ARCH=arm</code><br> <img src="https://images2.imgbox.com/6c/08/k8kAJdW7_o.png" alt="在这里插入图片描述"><br> 然后勾选<code>network file system</code><br> <img src="https://images2.imgbox.com/be/13/LhBc9p1n_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/0b/e9/heChHptV_o.png" alt="在这里插入图片描述"><br> 保存后再次编译</p> 
<p><img src="https://images2.imgbox.com/9a/02/yZ4FPiFs_o.png" alt="在这里插入图片描述"><br> <mark>然后将rootfs这个文件夹通过nfs共享出去</mark></p> 
<p>然后在bootloader中下载uImage.bin<br> 开发板中<br> <code>tftp c0008000 uImage.bin</code></p> 
<p><img src="https://images2.imgbox.com/12/f0/PI1pODut_o.png" alt="在这里插入图片描述"></p> 
<p>然后要设置启动参数</p> 
<pre><code>set env bootargs noinitrd console=ttySAC0,115200 init=/init root=/dev/nfs rw nfsroot=192.168.3.246:/home/wp/Desktop/arm-kernel/rootfs ip=192.168.3.122:192.168.3.246:192.168.3.1:255.255.255.0:willpower:eth0:off
</code></pre> 
<p>其中：<br> <strong>nfsroot</strong>表示共享的rootfs文件夹的位置<br> <strong>ip字段后面依次为</strong>开发板IP、nfs服务器IP、网关IP、子网掩码、主机名字、网卡、以及DHCP是否开启</p> 
<p><strong>这个时候可能会出现</strong></p> 
<p><mark>Linux通过nfs挂载根文件系统失败：VFS: Unable to mount root fs via NFS, trying floppy.</mark></p> 
<p>参考此篇<a href="https://www.cnblogs.com/aodu/p/13973028.html" rel="nofollow">文章</a>(有效)<br> <img src="https://images2.imgbox.com/20/1d/ua7REMxh_o.png" alt="在这里插入图片描述"><br> <code>sudo vim /etc/default/nfs-kernel-server</code><br> 添加<br> <strong>RPCNFSDOPTS="–nfs-version 2,3,4 --debug --syslog"</strong><br> 然后重启服务器<br> <code>sudo /etc/init.d/nfs-kernel-server restart</code>即可</p> 
<p>然后再开发板中启动内核<br> <code>bootm c0008000</code><br> 就可以成功看到界面了<br> <img src="https://images2.imgbox.com/23/84/kOefXQ3g_o.png" alt="在这里插入图片描述"><br> 这个时候在一边做操作即可同步到另一边非常方便</p> 
<p><img src="https://images2.imgbox.com/0b/e6/hV4aoST0_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/07/8c/p5XN2eQz_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_209"></a>编译问题</h2> 
<h3><a id="mkimage_command_not_found__UBoot_images_will_not_be_built_212"></a>编译内核提示mkimage command not found – U-Boot images will not be built</h3> 
<p><code>sudo apt install u-boot-tools</code></p> 
<h3><a id="Makefilexxx_216"></a>“Makefile:xxx：***混合的隐含和普通规则。停止”</h3> 
<p><a href="https://blog.csdn.net/zyllong/article/details/37812703">原文链接</a><br> <img src="https://images2.imgbox.com/83/9d/Gy3c4ri0_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/00/1f/gKiBFcZu_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/64a0435e95852974778af67c88b98952/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">python图像灰度变换</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/836d118cebd2a134e7001c69e4014390/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Linux内存管理子系统(概念入门)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>