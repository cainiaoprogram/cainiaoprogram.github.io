<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux用户空间内存区域的匿名映射 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Linux用户空间内存区域的匿名映射" />
<meta property="og:description" content="1 在调用mmap系统调用时，可以指定的标志(flag)参数：
1: #define MAP_SHARED 0x01 /* Share changes */ 2: #define MAP_PRIVATE 0x02 /* Changes are private */ 3: #define MAP_TYPE 0x0f /* Mask for type of mapping */ 4: #define MAP_FIXED 0x10 /* Interpret addr exactly */ 5: #define MAP_ANONYMOUS 0x20 /* don&#39;t use a file */ 6: #ifdef CONFIG_MMAP_ALLOW_UNINITIALIZED 7: # define MAP_UNINITIALIZED 0x4000000 /* For anonymous mmap, memory could be uninitialized */ 8: #else 9: # define MAP_UNINITIALIZED 0x0 /* Don&#39;t support this flag */ 10: #endif MAP_SHARED" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/1b378b491dc659d4fe24c7a595e43c74/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-07-03T00:29:00+08:00" />
<meta property="article:modified_time" content="2019-07-03T00:29:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux用户空间内存区域的匿名映射</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div id="cnblogs_post_body" class="blogpost-body"> 
 <h4>1</h4> 
 <p>在调用mmap系统调用时，可以指定的标志(flag)参数：</p> 
 <div style="border-bottom:#C0C0C0 1px solid;text-align:left;border-left:#C0C0C0 1px solid;line-height:12pt;font-family:'Courier New', courier, monospace;font-size:8pt;border-top:#C0C0C0 1px solid;border-right:#C0C0C0 1px solid;" id="codeSnippetWrapper"> 
  <div style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;" id="codeSnippet"> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum1">   1:</span> <span style="color:#cc6633;">#define</span> MAP_SHARED    0x01        <span style="color:#008000;">/* Share changes */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum2">   2:</span> <span style="color:#cc6633;">#define</span> MAP_PRIVATE    0x02        <span style="color:#008000;">/* Changes are private */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum3">   3:</span> <span style="color:#cc6633;">#define</span> MAP_TYPE    0x0f        <span style="color:#008000;">/* Mask for type of mapping */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum4">   4:</span> <span style="color:#cc6633;">#define</span> MAP_FIXED    0x10        <span style="color:#008000;">/* Interpret addr exactly */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum5">   5:</span> <span style="color:#cc6633;">#define</span> MAP_ANONYMOUS    0x20        <span style="color:#008000;">/* don't use a file */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum6">   6:</span> <span style="color:#cc6633;">#ifdef</span> CONFIG_MMAP_ALLOW_UNINITIALIZED</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum7">   7:</span> # define MAP_UNINITIALIZED 0x4000000    <span style="color:#008000;">/* For anonymous mmap, memory could be uninitialized */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum8">   8:</span> <span style="color:#cc6633;">#else</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum9">   9:</span> # define MAP_UNINITIALIZED 0x0        <span style="color:#008000;">/* Don't support this flag */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum10">  10:</span> <span style="color:#cc6633;">#endif</span></pre> 
  </div> 
 </div> 
 <blockquote> 
  <p>MAP_SHARED</p> 
  <p> </p> 
 </blockquote> 
 <p>用于多个进程共享对一个文件的访问</p> 
 <blockquote> 
  <p>MAP_PRIVATE</p> 
  <p> </p> 
 </blockquote> 
 <p>用于创建一个<font color="#ff0000">与数据源分离</font>的私有映射，对区域的写入操作不影响数据源文件中的内容</p> 
 <blockquote> 
  <p>MAP_FIXED</p> 
  <p> </p> 
 </blockquote> 
 <p>用于在指定的目标线性地址创建一个映射，不允许调整到其他地址</p> 
 <blockquote> 
  <p>MAP_ANONYMOUS</p> 
  <p> </p> 
 </blockquote> 
 <p>用于创建与文件无关的映射，或者说没有数据源的映射</p> 
 <p><font color="#ff0000">do_anonymous_page会调用alloc_zeroed_user_highpage_movable分配一个初始化为全0的内存页。</font></p> 
 <h4>2</h4> 
 <p> </p> 
 <p>在vm_area_struct数据结构定义中，有一个双链表结点：anon_vma_chain</p> 
 <div style="border-bottom:#C0C0C0 1px solid;text-align:left;border-left:#C0C0C0 1px solid;line-height:12pt;font-family:'Courier New', courier, monospace;font-size:8pt;border-top:#C0C0C0 1px solid;border-right:#C0C0C0 1px solid;"> 
  <div style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   1:</span> <span style="color:#0000ff;">struct</span> vm_area_struct {<!-- --></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   2:</span> ......</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   3:</span> <span style="color:#008000;">/*</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   4:</span> <span style="color:#008000;">     * A file's MAP_PRIVATE vma can be in both i_mmap tree and anon_vma</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   5:</span> <span style="color:#008000;">     * list, after a COW of one of the file pages.    A MAP_SHARED vma</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   6:</span> <span style="color:#008000;">     * can only be in the i_mmap tree.  An anonymous MAP_PRIVATE, stack</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   7:</span> <span style="color:#008000;">     * or brk vma (with NULL file) can only be in an anon_vma list.</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   8:</span> <span style="color:#008000;">     */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   9:</span>     <span style="color:#0000ff;">struct</span> list_head anon_vma_chain; <span style="color:#008000;">/* Serialized by mmap_sem &amp;</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  10:</span> <span style="color:#008000;">                      * page_table_lock */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum11">  11:</span>     <span style="color:#0000ff;">struct</span> anon_vma *anon_vma;    <span style="color:#008000;">/* Serialized by page_table_lock */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum12">  12:</span> ......</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum13">  13:</span> }</pre> 
  </div> 
 </div> 
 <p>其中，struct anon_vma定义:</p> 
 <div style="border-bottom:#C0C0C0 1px solid;text-align:left;border-left:#C0C0C0 1px solid;line-height:12pt;font-family:'Courier New', courier, monospace;font-size:8pt;border-top:#C0C0C0 1px solid;border-right:#C0C0C0 1px solid;"> 
  <div style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   1:</span> <span style="color:#008000;">/*</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   2:</span> <span style="color:#008000;"> * The anon_vma heads a list of private "related" vmas, to scan if</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   3:</span> <span style="color:#008000;"> * an anonymous page pointing to this anon_vma needs to be unmapped:</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   4:</span> <span style="color:#008000;"> * the vmas on the list will be related by forking, or by splitting.</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   5:</span> <span style="color:#008000;"> *</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   6:</span> <span style="color:#008000;"> * Since vmas come and go as they are split and merged (particularly</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   7:</span> <span style="color:#008000;"> * in mprotect), the mapping field of an anonymous page cannot point</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   8:</span> <span style="color:#008000;"> * directly to a vma: instead it points to an anon_vma, on whose list</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   9:</span> <span style="color:#008000;"> * the related vmas can be easily linked or unlinked.</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  10:</span> <span style="color:#008000;"> *</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  11:</span> <span style="color:#008000;"> * After unlinking the last vma on the list, we must garbage collect</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  12:</span> <span style="color:#008000;"> * the anon_vma object itself: we're guaranteed no page can be</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  13:</span> <span style="color:#008000;"> * pointing to this anon_vma once its vma list is empty.</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum14">  14:</span> <span style="color:#008000;"> */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum15">  15:</span> <span style="color:#0000ff;">struct</span> anon_vma {<!-- --></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum16">  16:</span>     <span style="color:#0000ff;">struct</span> anon_vma *root;    <span style="color:#008000;">/* Root of this anon_vma tree */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum17">  17:</span>     <span style="color:#0000ff;">struct</span> mutex mutex;    <span style="color:#008000;">/* Serialize access to vma list */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum18">  18:</span>     <span style="color:#008000;">/*</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum19">  19:</span> <span style="color:#008000;">     * The refcount is taken on an anon_vma when there is no</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum20">  20:</span> <span style="color:#008000;">     * guarantee that the vma of page tables will exist for</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum21">  21:</span> <span style="color:#008000;">     * the duration of the operation. A caller that takes</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum22">  22:</span> <span style="color:#008000;">     * the reference is responsible for clearing up the</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum23">  23:</span> <span style="color:#008000;">     * anon_vma if they are the last user on release</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum24">  24:</span> <span style="color:#008000;">     */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum25">  25:</span>     atomic_t refcount;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum26">  26:</span>  </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum27">  27:</span>     <span style="color:#008000;">/*</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum28">  28:</span> <span style="color:#008000;">     * NOTE: the LSB of the head.next is set by</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum29">  29:</span> <span style="color:#008000;">     * mm_take_all_locks() _after_ taking the above lock. So the</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum30">  30:</span> <span style="color:#008000;">     * head must only be read/written after taking the above lock</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum31">  31:</span> <span style="color:#008000;">     * to be sure to see a valid next pointer. The LSB bit itself</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum32">  32:</span> <span style="color:#008000;">     * is serialized by a system wide lock only visible to</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum33">  33:</span> <span style="color:#008000;">     * mm_take_all_locks() (mm_all_locks_mutex).</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum34">  34:</span> <span style="color:#008000;">     */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum35">  35:</span>     <span style="color:#0000ff;">struct</span> list_head head;    <span style="color:#008000;">/* Chain of private "related" vmas */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum36">  36:</span> };</pre> 
  </div> 
 </div> 
 <h4>3</h4> 
 <p>do_mmap</p> 
 <div style="border-bottom:#C0C0C0 1px solid;text-align:left;border-left:#C0C0C0 1px solid;line-height:12pt;font-family:'Courier New', courier, monospace;font-size:8pt;border-top:#C0C0C0 1px solid;border-right:#C0C0C0 1px solid;"> 
  <div style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   1:</span> <span style="color:#0000ff;">static</span> <span style="color:#0000ff;">inline</span> <span style="color:#0000ff;">unsigned</span> <span style="color:#0000ff;">long</span> do_mmap(<span style="color:#0000ff;">struct</span> file *file, <span style="color:#0000ff;">unsigned</span> <span style="color:#0000ff;">long</span> addr,</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   2:</span>     <span style="color:#0000ff;">unsigned</span> <span style="color:#0000ff;">long</span> len, <span style="color:#0000ff;">unsigned</span> <span style="color:#0000ff;">long</span> prot,</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   3:</span>     <span style="color:#0000ff;">unsigned</span> <span style="color:#0000ff;">long</span> flag, <span style="color:#0000ff;">unsigned</span> <span style="color:#0000ff;">long</span> offset)</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   4:</span> {<!-- --></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   5:</span>     <span style="color:#0000ff;">unsigned</span> <span style="color:#0000ff;">long</span> ret = -EINVAL;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   6:</span>     <span style="color:#0000ff;">if</span> ((offset + PAGE_ALIGN(len)) &lt; offset)</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   7:</span>         <span style="color:#0000ff;">goto</span> out;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   8:</span>     <span style="color:#0000ff;">if</span> (!(offset &amp; ~PAGE_MASK))</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   9:</span>         ret = do_mmap_pgoff(file, addr, len, prot, flag, offset &gt;&gt; PAGE_SHIFT);</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  10:</span> out:</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  11:</span>     <span style="color:#0000ff;">return</span> ret;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  12:</span> }</pre> 
  </div> 
 </div> 
 <blockquote> 
  <p>if ((offset + PAGE_ALIGN(len)) &lt; offset)</p> 
  <p> </p> 
 </blockquote> 
 <blockquote> 
  <p>/* to align the pointer to the (next) page boundary */<br>#define PAGE_ALIGN(addr) ALIGN(addr, PAGE_SIZE)</p> 
 </blockquote> 
 <blockquote> 
  <p>/*<br>* 'kernel.h' contains some often-used function prototypes etc<br>*/<br>#define __ALIGN_KERNEL(x, a)        __ALIGN_KERNEL_MASK(x, (typeof(x))(a) - 1)<br>#define __ALIGN_KERNEL_MASK(x, mask)    </p> 
 </blockquote> 
 <p>即</p> 
 <blockquote> 
  <p>if ((offset + <font color="#ffc000"><font color="#ff0000">(((len) + (PAGE_SIZE)) &amp; ~(PAGE_SIZE-1)))</font> </font>&lt; offset)</p> 
  <p> </p> 
 </blockquote> 
 <p>表示如果len太长，再进行align to page boundary操作就会溢出了，那么没有那么多的线性地址空间可以给它映射，因此失败。</p> 
 <blockquote></blockquote> 
 <blockquote> 
  <p>if (!(offset &amp; ~PAGE_MASK))</p> 
  <p> </p> 
 </blockquote> 
 <p>如果offset是位于页的边界处，则继续操作</p> 
 <blockquote> 
  <p>ret = do_mmap_pgoff(file, addr, len, prot, flag, offset &gt;&gt; PAGE_SHIFT);</p> 
  <p> </p> 
 </blockquote> 
 <p>其中最后一个参数代表了映射区域在文件中的页序号。</p> 
 <div style="border-bottom:#C0C0C0 1px solid;text-align:left;border-left:#C0C0C0 1px solid;line-height:12pt;font-family:'Courier New', courier, monospace;font-size:8pt;border-top:#C0C0C0 1px solid;border-right:#C0C0C0 1px solid;"> 
  <div style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   1:</span> <span style="color:#008000;">/*</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   2:</span> <span style="color:#008000;"> * The caller must hold down_write(&amp;current-&gt;mm-&gt;mmap_sem).</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   3:</span> <span style="color:#008000;"> */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   4:</span>  </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   5:</span> <span style="color:#0000ff;">unsigned</span> <span style="color:#0000ff;">long</span> do_mmap_pgoff(<span style="color:#0000ff;">struct</span> file *file, <span style="color:#0000ff;">unsigned</span> <span style="color:#0000ff;">long</span> addr,</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   6:</span>             <span style="color:#0000ff;">unsigned</span> <span style="color:#0000ff;">long</span> len, <span style="color:#0000ff;">unsigned</span> <span style="color:#0000ff;">long</span> prot,</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   7:</span>             <span style="color:#0000ff;">unsigned</span> <span style="color:#0000ff;">long</span> flags, <span style="color:#0000ff;">unsigned</span> <span style="color:#0000ff;">long</span> pgoff)</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   8:</span> {<!-- --></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   9:</span>     <span style="color:#0000ff;">struct</span> mm_struct * mm = current-&gt;mm;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  10:</span>     <span style="color:#0000ff;">struct</span> inode *inode;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  11:</span>     vm_flags_t vm_flags;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  12:</span>     <span style="color:#0000ff;">int</span> error;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  13:</span>     <span style="color:#0000ff;">unsigned</span> <span style="color:#0000ff;">long</span> reqprot = prot;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  14:</span>  </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  15:</span>     <span style="color:#008000;">/*</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  16:</span> <span style="color:#008000;">     * Does the application expect PROT_READ to imply PROT_EXEC?</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  17:</span> <span style="color:#008000;">     *</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  18:</span> <span style="color:#008000;">     * (the exception is when the underlying filesystem is noexec</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  19:</span> <span style="color:#008000;">     *  mounted, in which case we dont add PROT_EXEC.)</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  20:</span> <span style="color:#008000;">     */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  21:</span>     <span style="color:#0000ff;">if</span> ((prot &amp; PROT_READ) &amp;&amp; (current-&gt;personality &amp; READ_IMPLIES_EXEC))</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  22:</span>         <span style="color:#0000ff;">if</span> (!(file &amp;&amp; (file-&gt;f_path.mnt-&gt;mnt_flags &amp; MNT_NOEXEC)))</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  23:</span>             prot |= PROT_EXEC;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  24:</span>  </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  25:</span>     <span style="color:#0000ff;">if</span> (!len)</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  26:</span>         <span style="color:#0000ff;">return</span> -EINVAL;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  27:</span>  </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  28:</span>     <span style="color:#0000ff;">if</span> (!(flags &amp; MAP_FIXED))</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  29:</span>         addr = round_hint_to_min(addr);</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  30:</span>  </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  31:</span>     <span style="color:#008000;">/* Careful about overflows.. */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  32:</span>     len = PAGE_ALIGN(len);</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  33:</span>     <span style="color:#0000ff;">if</span> (!len)</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  34:</span>         <span style="color:#0000ff;">return</span> -ENOMEM;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  35:</span>  </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  36:</span>     <span style="color:#008000;">/* offset overflow? */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum37">  37:</span>     <span style="color:#0000ff;">if</span> ((pgoff + (len &gt;&gt; PAGE_SHIFT)) &lt; pgoff)</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum38">  38:</span>                <span style="color:#0000ff;">return</span> -EOVERFLOW;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum39">  39:</span>  </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum40">  40:</span>     <span style="color:#008000;">/* Too many mappings? */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum41">  41:</span>     <span style="color:#0000ff;">if</span> (mm-&gt;map_count &gt; sysctl_max_map_count)</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum42">  42:</span>         <span style="color:#0000ff;">return</span> -ENOMEM;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum43">  43:</span>  </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum44">  44:</span>     <span style="color:#008000;">/* Obtain the address to map to. we verify (or select) it and ensure</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum45">  45:</span> <span style="color:#008000;">     * that it represents a valid section of the address space.</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum46">  46:</span> <span style="color:#008000;">     */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum47">  47:</span>     addr = get_unmapped_area(file, addr, len, pgoff, flags);</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum48">  48:</span>     <span style="color:#0000ff;">if</span> (addr &amp; ~PAGE_MASK)</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum49">  49:</span>         <span style="color:#0000ff;">return</span> addr;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum50">  50:</span>  </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum51">  51:</span>     <span style="color:#008000;">/* Do simple checking here so the lower-level routines won't have</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum52">  52:</span> <span style="color:#008000;">     * to. we assume access permissions have been handled by the open</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum53">  53:</span> <span style="color:#008000;">     * of the memory object, so we don't do any here.</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum54">  54:</span> <span style="color:#008000;">     */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum55">  55:</span>     vm_flags = calc_vm_prot_bits(prot) | calc_vm_flag_bits(flags) |</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum56">  56:</span>             mm-&gt;def_flags | VM_MAYREAD | VM_MAYWRITE | VM_MAYEXEC;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum57">  57:</span>  </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum58">  58:</span>     <span style="color:#0000ff;">if</span> (flags &amp; MAP_LOCKED)</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum59">  59:</span>         <span style="color:#0000ff;">if</span> (!can_do_mlock())</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum60">  60:</span>             <span style="color:#0000ff;">return</span> -EPERM;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum61">  61:</span>  </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum62">  62:</span>     <span style="color:#008000;">/* mlock MCL_FUTURE? */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum63">  63:</span>     <span style="color:#0000ff;">if</span> (vm_flags &amp; VM_LOCKED) {<!-- --></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum64">  64:</span>         <span style="color:#0000ff;">unsigned</span> <span style="color:#0000ff;">long</span> locked, lock_limit;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum65">  65:</span>         locked = len &gt;&gt; PAGE_SHIFT;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum66">  66:</span>         locked += mm-&gt;locked_vm;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum67">  67:</span>         lock_limit = rlimit(RLIMIT_MEMLOCK);</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum68">  68:</span>         lock_limit &gt;&gt;= PAGE_SHIFT;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum69">  69:</span>         <span style="color:#0000ff;">if</span> (locked &gt; lock_limit &amp;&amp; !capable(CAP_IPC_LOCK))</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum70">  70:</span>             <span style="color:#0000ff;">return</span> -EAGAIN;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum71">  71:</span>     }</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum72">  72:</span>  </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum73">  73:</span>     inode = file ? file-&gt;f_path.dentry-&gt;d_inode : NULL;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum74">  74:</span>  </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum75">  75:</span>     <span style="color:#0000ff;">if</span> (file) {<!-- --></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum76">  76:</span>         <span style="color:#0000ff;">switch</span> (flags &amp; MAP_TYPE) {<!-- --></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum77">  77:</span>         <span style="color:#0000ff;">case</span> MAP_SHARED:</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum78">  78:</span>             <span style="color:#0000ff;">if</span> ((prot&amp;PROT_WRITE) &amp;&amp; !(file-&gt;f_mode&amp;FMODE_WRITE))</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum79">  79:</span>                 <span style="color:#0000ff;">return</span> -EACCES;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum80">  80:</span>  </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum81">  81:</span>             <span style="color:#008000;">/*</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum82">  82:</span> <span style="color:#008000;">             * Make sure we don't allow writing to an append-only</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum83">  83:</span> <span style="color:#008000;">             * file..</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum84">  84:</span> <span style="color:#008000;">             */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum85">  85:</span>             <span style="color:#0000ff;">if</span> (IS_APPEND(inode) &amp;&amp; (file-&gt;f_mode &amp; FMODE_WRITE))</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum86">  86:</span>                 <span style="color:#0000ff;">return</span> -EACCES;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum87">  87:</span>  </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum88">  88:</span>             <span style="color:#008000;">/*</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum89">  89:</span> <span style="color:#008000;">             * Make sure there are no mandatory locks on the file.</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum90">  90:</span> <span style="color:#008000;">             */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum91">  91:</span>             <span style="color:#0000ff;">if</span> (locks_verify_locked(inode))</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum92">  92:</span>                 <span style="color:#0000ff;">return</span> -EAGAIN;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum93">  93:</span>  </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum94">  94:</span>             vm_flags |= VM_SHARED | VM_MAYSHARE;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum95">  95:</span>             <span style="color:#0000ff;">if</span> (!(file-&gt;f_mode &amp; FMODE_WRITE))</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum96">  96:</span>                 vm_flags &amp;= ~(VM_MAYWRITE | VM_SHARED);</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum97">  97:</span>  </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum98">  98:</span>             <span style="color:#008000;">/* fall through */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum99">  99:</span>         <span style="color:#0000ff;">case</span> MAP_PRIVATE:</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum100"> 100:</span>             <span style="color:#0000ff;">if</span> (!(file-&gt;f_mode &amp; FMODE_READ))</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum101"> 101:</span>                 <span style="color:#0000ff;">return</span> -EACCES;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum102"> 102:</span>             <span style="color:#0000ff;">if</span> (file-&gt;f_path.mnt-&gt;mnt_flags &amp; MNT_NOEXEC) {<!-- --></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum103"> 103:</span>                 <span style="color:#0000ff;">if</span> (vm_flags &amp; VM_EXEC)</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum104"> 104:</span>                     <span style="color:#0000ff;">return</span> -EPERM;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum105"> 105:</span>                 vm_flags &amp;= ~VM_MAYEXEC;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum106"> 106:</span>             }</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum107"> 107:</span>  </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum108"> 108:</span>             <span style="color:#0000ff;">if</span> (!file-&gt;f_op || !file-&gt;f_op-&gt;mmap)</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum109"> 109:</span>                 <span style="color:#0000ff;">return</span> -ENODEV;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum110"> 110:</span>             <span style="color:#0000ff;">break</span>;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum111"> 111:</span>  </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum112"> 112:</span>         <span style="color:#0000ff;">default</span>:</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum113"> 113:</span>             <span style="color:#0000ff;">return</span> -EINVAL;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum114"> 114:</span>         }</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum115"> 115:</span>     } <span style="color:#0000ff;">else</span> {<!-- --></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum116"> 116:</span>         <span style="color:#0000ff;">switch</span> (flags &amp; MAP_TYPE) {<!-- --></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum117"> 117:</span>         <span style="color:#0000ff;">case</span> MAP_SHARED:</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum118"> 118:</span>             <span style="color:#008000;">/*</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum119"> 119:</span> <span style="color:#008000;">             * Ignore pgoff.</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum120"> 120:</span> <span style="color:#008000;">             */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum121"> 121:</span>             pgoff = 0;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum122"> 122:</span>             vm_flags |= VM_SHARED | VM_MAYSHARE;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum123"> 123:</span>             <span style="color:#0000ff;">break</span>;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum124"> 124:</span>         <span style="color:#0000ff;">case</span> MAP_PRIVATE:</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum125"> 125:</span>             <span style="color:#008000;">/*</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum126"> 126:</span> <span style="color:#008000;">             * Set pgoff according to addr for anon_vma.</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum127"> 127:</span> <span style="color:#008000;">             */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum128"> 128:</span>             pgoff = addr &gt;&gt; PAGE_SHIFT;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum129"> 129:</span>             <span style="color:#0000ff;">break</span>;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum130"> 130:</span>         <span style="color:#0000ff;">default</span>:</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum131"> 131:</span>             <span style="color:#0000ff;">return</span> -EINVAL;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum132"> 132:</span>         }</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum133"> 133:</span>     }</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum134"> 134:</span>  </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum135"> 135:</span>     error = security_file_mmap(file, reqprot, prot, flags, addr, 0);</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum136"> 136:</span>     <span style="color:#0000ff;">if</span> (error)</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum137"> 137:</span>         <span style="color:#0000ff;">return</span> error;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum138"> 138:</span>  </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum139"> 139:</span>     <span style="color:#0000ff;">return</span> mmap_region(file, addr, len, flags, vm_flags, pgoff);</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum140"> 140:</span> }</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum141"> 141:</span> EXPORT_SYMBOL(do_mmap_pgoff);</pre> 
  </div> 
 </div> 
 <blockquote> 
  <p>/* Obtain the address to map to. we verify (or select) it and ensure<br>     * that it represents a valid section of the address space.<br>     */<br>    addr = get_unmapped_area(file, addr, len, pgoff, flags);<br>    if (addr &amp; ~PAGE_MASK)<br>        return addr;</p> 
 </blockquote> 
 <p>get_unmapped_area函数用于查找到一个可以安放请求的这么长的一个vma的线性地址范围，返回这个范围的起始地址。如果这个起始地址不是从页对齐处开始的，代表找到的这个地址是不符合要求的，因此也不再往下走了，直接返回。</p> 
 <p><font color="#ff0000">但是是问题是，如果直接返回了，那么调用都会不会不做检查，直接认为内核已经完成了mmap的操作，而尝试去读写这块还没有与文件建立起关联的内存区域呢，会发生什么不可知的事？</font></p> 
 <p><font color="#ff0000"></font> </p> 
 <p><font color="#ff0000">【根据<a title="http://www.cnblogs.com/long123king/p/3502170.html" href="http://www.cnblogs.com/long123king/p/3502170.html" rel="nofollow">http://www.cnblogs.com/long123king/p/3502170.html</a>中的思想，当进程真正需要访问页时，会触发Page Fault，那么这一步关键是设置好相应的Page Fault handler以及相应struct的指针成员】</font></p> 
</div> 
<p>转载于:https://www.cnblogs.com/long123king/p/3512607.html</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/55bb6e683118e8ec9dceaf306b64c382/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">[JavaScript]Cookie详解(转)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d3a49c4fd4e35b599eb0ef3912b3aad5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">怎样学习新语言</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>