<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>在Vivado中创建计数器IP核 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="在Vivado中创建计数器IP核" />
<meta property="og:description" content="简介
在 Vivado 软件中，我们可以很方便的通过创建和封装 IP 向导的方式来自定义 IP 核。
自定义 IP 核可以定制化系统设计，以达到设计重用的目的，可以很大程度上简化系统设计和缩短产品上市的时间。
本实验中可以创建一个带有 AXI4 接口的 IP 核，用于 PS 和 PL 的数据通信。本次实验选择常用的方式，即创建一个带有 AXI 接口的 IP 核，该 IP 核通过 AXI 协议实现 PS 和 PL 的数据通信。AXI 协议是一种高性能、高带宽、低延迟的片内总线。
实验任务
本章的实验任务是通过自定义一个 COUNT IP 核，使其间隔1s计数1次，并切CPU可以实时读取计数结果。
硬件设计
step1：创建一个新的 IP 核
1-1 打开 Vivado，进入 Vivado 界面后，点击“Tasks”栏中的“Manage IP”。在弹出的选项中选择“New
IP Location…”。如下图所示：
1-2 在弹出的界面中选择“Next”，然后设置 Manage IP 核的属性，在“IP Location:”一栏指定工程的
路径，路径为：F:/ZYNQ/ Embedded_System/custom_ip，其它保持默认即可。点击“Finish”完成 Manage IP工程的创建，如图 所示。注意，Part 一栏中设置开发板的型号，在后面的工程中会重新指定，这里直接保持默认。
此时弹出确认工程路径的界面，点击“OK”按钮完成工程的创建。如下图所示：
1-3 工程创建完成后，运行创建和封装 IP 向导。点击菜单栏的“Tools”，选择“Create and Package New" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/ca0bd7102b83c6f02ab0a8797bf224ae/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-11-08T19:27:29+08:00" />
<meta property="article:modified_time" content="2021-11-08T19:27:29+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">在Vivado中创建计数器IP核</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><strong>简介</strong><br> 在 Vivado 软件中，我们可以很方便的通过创建和封装 IP 向导的方式来自定义 IP 核。<br> 自定义 IP 核可以定制化系统设计，以达到设计重用的目的，可以很大程度上简化系统设计和缩短产品上市的时间。<br> 本实验中可以创建一个带有 AXI4 接口的 IP 核，用于 PS 和 PL 的数据通信。本次实验选择常用的方式，即创建一个带有 AXI 接口的 IP 核，该 IP 核通过 AXI 协议实现 PS 和 PL 的数据通信。AXI 协议是一种高性能、高带宽、低延迟的片内总线。</p> 
<p><strong>实验任务</strong><br> 本章的实验任务是通过自定义一个 COUNT IP 核，使其间隔1s计数1次，并切CPU可以实时读取计数结果。</p> 
<p><strong>硬件设计</strong><br> step1：创建一个新的 IP 核</p> 
<p>1-1 打开 Vivado，进入 Vivado 界面后，点击“Tasks”栏中的“Manage IP”。在弹出的选项中选择“New<br> IP Location…”。如下图所示：<br> <img src="https://images2.imgbox.com/9d/59/RKEc7g8L_o.png" alt="在这里插入图片描述"></p> 
<p>1-2 在弹出的界面中选择“Next”，然后设置 Manage IP 核的属性，在“IP Location:”一栏指定工程的<br> 路径，路径为：F:/ZYNQ/ Embedded_System/custom_ip，其它保持默认即可。点击“Finish”完成 Manage IP工程的创建，如图 所示。注意，Part 一栏中设置开发板的型号，在后面的工程中会重新指定，这里直接保持默认。<br> <img src="https://images2.imgbox.com/c1/b1/h6xNWslE_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/13/0b/gRMENmYJ_o.png" alt="在这里插入图片描述"><br> 此时弹出确认工程路径的界面，点击“OK”按钮完成工程的创建。如下图所示：<img src="https://images2.imgbox.com/a9/45/okqk5j7l_o.png" alt="在这里插入图片描述"></p> 
<p>1-3 工程创建完成后，运行创建和封装 IP 向导。点击菜单栏的“Tools”，选择“Create and Package New<br> IP”，在弹出的界面中，点击“NEXT”。如图 所示：<br> <img src="https://images2.imgbox.com/9a/62/6uoKnA4u_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/16/1b/p8KwwKOY_o.png" alt="在这里插入图片描述"></p> 
<p>1-4 接下来选择封装 IP 或者创建一个带 AXI4 接口的 IP 核，我们这里选择创建一个带 AXI 接口的 IP<br> 核，选中“Creat a new AXI4 peripheral”，并点击“NEXT”按钮。如下图所示：<br> <img src="https://images2.imgbox.com/d9/03/MTKtpLXc_o.png" alt="在这里插入图片描述"></p> 
<p>1-5 接下来分别设置 IP 核名称（Name）、版本号（Version）、显示名（Display name）、描述（Description）<br> 和路径（IP location）。在 Name 一栏设置 IP 核的名称，本次实验的功能是控制 PL LED 呈现呼吸灯的效果，<br> 因此这里在 Name 一栏 ，将 名称 改为 “ count_ip ”， 此时 Display name 一 栏会 自动 更改 为<br> “count_ip_v1.0”。其它的设置直接保持默认即可，点击“NEXT”按钮，如下图所示：<br> <img src="https://images2.imgbox.com/3e/cd/4IXWPZws_o.png" alt="在这里插入图片描述"></p> 
<p>1-6 接下来对 AXI 接口进行设置。<br> <img src="https://images2.imgbox.com/02/7b/AnR4ScyG_o.png" alt="在这里插入图片描述"><br> Name（名称）：这里修改成 S00_AXI。<br> Interface Tpye（接口类型）：共三种接口类型可选，分别是 Lite、Full 和 Stream。<br> ①AXI4-Lite 接口是简化版的 AXI4 接口，用于较少数据量的存储映射通信；<br> ②AXI4-Full 接口是高性能存储映射接口，用于较多数据量的存储映射通信；<br> ③AXI4-Stream 用于高速数据流传输，非存储映射接口。本次实验只需少量数据的通信，因此接口类型选择默认的 Lite 接口。<br> Interface Mode（接口模式）：接口模式有 Slave（从机）和 Master（主机）两种模式可选，AXI 协议是主机和从机通过“握手”的 方式 建立连接，这里选择默认的 Slave 接口模式。<br> Data Width（数据宽度）：数据位宽保持默认，即 32 位位宽<br> Memory Size（存储器大小）： 在 AXI4-Lite 接口模式下，该选项不可设置。<br> Number of Registers（寄存器数量）：用于配置 PL LED 呼吸灯寄存器的数量，这里保持默认。<br> 点击“Next”按钮。</p> 
<p>1-7 最后弹出封装接口的总结描述和下一步操作选项的界面。这里保持默认，即将 IP 添加至 IP 库中，<br> 点击“Finish”按钮完成 IP 核的创建和封装。如下图所示：<br> <img src="https://images2.imgbox.com/57/1d/soUzmJqz_o.png" alt="在这里插入图片描述"><br> 在 IP Catalog 界面中可以看到刚刚添加的 IP 核，位于 User Repository 一栏中的 AXI Peripheral 下，名称为“count_ip_v1.0”，如图 所示：<br> <img src="https://images2.imgbox.com/8b/6d/AxQLyxZM_o.png" alt="在这里插入图片描述"></p> 
<p>1-8 创建好 IP 核后，我们接下来对 count_ip_v1.0 IP 核进行编辑。右击 count_ip_v1.0 IP 核，选择“Edit in IP Packager”，在弹出的界面中点击“OK”，如图所示：<br> <img src="https://images2.imgbox.com/cc/b4/fiP1YC6W_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/c2/f5/NKPsCfqr_o.png" alt="在这里插入图片描述"></p> 
<p>此时会打开一个新的工程，如图 所示：<br> <img src="https://images2.imgbox.com/d7/d7/RTu0Kmjv_o.png" alt="在这里插入图片描述"><br> 1-9 此时工程中缺失 count.v 文件，count.v 文件用于实现计数的功能。<br> 右击“Design Sources”，选择“Add Sources…”，在弹出的界面中选择“Add or Create design source”，点击“NEXT”，如图 所示：<br> <img src="https://images2.imgbox.com/0f/01/TVuLqdiK_o.png" alt="在这里插入图片描述"><br> 点 击 “ Create File ” 创 建 一 个 新 的 文 件 ， 在 弹 出 的 界 面 输 入 名 称 count ，路径<br> 为…/ip_repo/count_ip_1.0/hdl，点击“OK”按钮，如图所示：<br> <img src="https://images2.imgbox.com/3f/11/7tqXZkPt_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/bc/3f/saSCWJpJ_o.png" alt="在这里插入图片描述"><br> 点击“Finish”按钮完成创建，如下图所示：<br> <img src="https://images2.imgbox.com/16/8b/KFTkYpGL_o.png" alt="在这里插入图片描述"><br> 在弹出的模块定义界面中点击“OK”按钮，接下来在弹出的确认按钮中点击“YES”。<br> <img src="https://images2.imgbox.com/21/e9/pMwLhm0n_o.png" alt="在这里插入图片描述"><br> 双击新创建的文件，进入编辑：<br> <img src="https://images2.imgbox.com/76/4c/xtgceE0V_o.png" alt="在这里插入图片描述"><br> 在新创建的文件count.v中敲入以下代码：</p> 
<pre><code class="prism language-c">module <span class="token function">counter</span><span class="token punctuation">(</span>
    input  wire        sys_clk <span class="token punctuation">,</span> 
    input  wire        sys_rst_n <span class="token punctuation">,</span>
    
    output reg <span class="token punctuation">[</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>  cnt         <span class="token comment">//和系统中的寄存器0例化在一起</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
reg <span class="token punctuation">[</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span> period_cnt <span class="token punctuation">;</span>

<span class="token comment">//周期计数：1s记一次</span>
always @ <span class="token punctuation">(</span>posedge sys_clk or negedge sys_rst_n<span class="token punctuation">)</span> begin
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sys_rst_n<span class="token punctuation">)</span>
        period_cnt <span class="token operator">&lt;=</span> <span class="token number">26</span>'d0<span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>period_cnt<span class="token operator">==</span><span class="token number">26</span>'d50_000_000<span class="token punctuation">)</span>
        period_cnt <span class="token operator">&lt;=</span> <span class="token number">26</span>'d0<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        period_cnt <span class="token operator">&lt;=</span> period_cnt<span class="token operator">+</span><span class="token number">1</span>'b1<span class="token punctuation">;</span>
end

<span class="token comment">//计数范围：0-100</span>
always @ <span class="token punctuation">(</span>posedge sys_clk or negedge sys_rst_n<span class="token punctuation">)</span> begin
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sys_rst_n<span class="token punctuation">)</span>begin            
        cnt<span class="token operator">&lt;=</span><span class="token number">8</span>'d0<span class="token punctuation">;</span>   
    end
    <span class="token keyword">else</span> begin
        <span class="token keyword">if</span><span class="token punctuation">(</span>period_cnt <span class="token operator">==</span> <span class="token number">26</span>'d50_000_000<span class="token punctuation">)</span>begin
            <span class="token keyword">if</span><span class="token punctuation">(</span>cnt<span class="token operator">==</span><span class="token number">8</span>'d100<span class="token punctuation">)</span>begin
                cnt<span class="token operator">&lt;=</span><span class="token number">8</span>'d0<span class="token punctuation">;</span>
                
             end   
            <span class="token keyword">else</span>
                 cnt<span class="token operator">&lt;=</span>cnt<span class="token operator">+</span><span class="token number">1</span>'b1<span class="token punctuation">;</span>   
           end
        <span class="token keyword">else</span> begin
            cnt<span class="token operator">&lt;=</span>cnt<span class="token punctuation">;</span>
         
        end
     end

end

endmodule
</code></pre> 
<p>双击 count_ip_v1_0 下的 count_ip_v1_0_S00_AXI_inst，（注：count_ip_v1_0 中的程序为系统默认生成，不做修改），如下图所示：<br> count_ip_v1_0_S00_AXI 模块<em>实现了 AXI4 协议下的读写寄存器的功能</em>，我们只需要对该模块稍作<br> 修改，即可实现计数器输出的功能。<br> <em><strong>代码分析：</strong></em><br> <strong>向寄存器中写入数据的部分代码：</strong><br> <img src="https://images2.imgbox.com/a3/ca/LUUe3YYk_o.png" alt="在这里插入图片描述"><br> <strong>从寄存器中读出数据的部分代码：</strong><br> <img src="https://images2.imgbox.com/3b/84/teO3WGhF_o.png" alt="在这里插入图片描述"><br> <strong>注意：在本次的计数器IP核创建例程中，我们需要在这里把slv_reg0作为PL到PS传输时的寄存器，即仅从寄存器中读出数据，而不需要向寄存器中写入数据，因此需要将它的赋值屏蔽掉，即直接注释掉即可，如下图所示。</strong><br> <img src="https://images2.imgbox.com/a5/c2/1LidN8Hw_o.png" alt="在这里插入图片描述"><br> <strong>并在该文件中加入下列代码：</strong><br> 将计数值存放在reg0中，并对系统输入输出参数进行例化：<br> <img src="https://images2.imgbox.com/91/8f/aNXraRqs_o.png" alt="在这里插入图片描述"></p> 
<p><strong>完成上述步骤后即可，点击Run Synthesis进行编译。</strong><br> <img src="https://images2.imgbox.com/21/65/cjjFDgg0_o.png" alt="在这里插入图片描述"><br> <strong>编译完成后，可通过IP-XACT 界面下的 component.xml 打开Package IP界面，开始设置IP的封装。依次按照下图步骤进行操作：</strong><br> <img src="https://images2.imgbox.com/be/5e/F2RYu1jC_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/9e/36/hWbmkMx0_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/7b/ba/rYIEghQ7_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/2f/7a/vMQOtxkT_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/e7/63/qVKWH0wj_o.png" alt="在这里插入图片描述"><br> 至此，自定义IP就配置完成了，需要使用计数器ip可直接调用。<br> 可在SDk中使用COUNT_IP_mReadReg（COUNT_IP_BASEADDR,COUNT_IP_REG0);对计数结果进行读取。<br> #define COUNT_IP_BASEADDR XPAR_COUNT_IP_0_S00_AXI_BASEADDR //IP的基地址<br> #define COUNT_IP_REG0 COUNT_IP_s0_AXI_SLV_REGG_OFFSET //REG0地址</p> 
<p>SDK中编写如下代码即可实现，计数器读取：</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stdio.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"xparameters.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"count_ip.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"xil_io.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sleep.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stdlib.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sleep.h"</span></span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">COUNT_IP_BASEADDR</span>		<span class="token expression">XPAR_COUNT_IP_0_S00_AXI_BASEADDR  </span><span class="token comment">//IP的基地址</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">COUNT_IP_REG0</span>			<span class="token expression">COUNT_IP_S00_AXI_SLV_REG0_OFFSET </span><span class="token comment">//REG0地址</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"test\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>

			<span class="token comment">//读取结果</span>
			result <span class="token operator">=</span> <span class="token function">COUNT_IP_mReadReg</span><span class="token punctuation">(</span>COUNT_IP_BASEADDR<span class="token punctuation">,</span>COUNT_IP_REG0<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"CPU0 count： %d\n"</span><span class="token punctuation">,</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a847fcab04f7d406a3c24955a633ade7/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">装载问题(多种方法解决)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b36fb0b7671f4bab294b73edd48ed28f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">0-1背包问题（多种解决方案）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>