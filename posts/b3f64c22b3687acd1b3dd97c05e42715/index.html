<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android Security PIN 相关代码 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android Security PIN 相关代码" />
<meta property="og:description" content="开发项目遇到一个问题，具体描述及复制步骤如下：
就是开启&#34;Enhanced PIN privacy&#34;(增强的PIN隐私)的时候输入秘密的时候还是会显示数字
如下图，应该是直接是“.” 不应该出现PIN 密码
想要的效果如下图：
设置的步骤如下图：
其中涉及到的部分code如下：
/frameworks/base/core/java/com/android/internal/widget/LockPatternUtils.java
/frameworks/base/packages/SystemUI/src/com/android/keyguard/KeyguardPinBasedInputViewController.java
/frameworks/base/packages/SystemUI/src/com/android/keyguard/PasswordTextView.java
/frameworks/base/services/core/java/com/android/server/locksettings/LockSettingsStorage.java
I.LockPatternUtils.java:
/** * @return Whether enhanced pin privacy is enabled. */ public boolean isPinEnhancedPrivacyEnabled(int userId) { return getBoolean(LOCK_PIN_ENHANCED_PRIVACY, false, userId); } /** * Set whether enhanced pin privacy is enabled. */ public void setPinEnhancedPrivacyEnabled(boolean enabled, int userId) { setBoolean(LOCK_PIN_ENHANCED_PRIVACY, enabled, userId); } private boolean getBoolean(String secureSettingKey, boolean defaultValue, int userId) { Log.i(&#34;TD&#34;,&#34;LockPatternUtils-----&gt;getBoolean: &#34;&#43;secureSettingKey); try { return getLockSettings()." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/b3f64c22b3687acd1b3dd97c05e42715/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-27T16:01:47+08:00" />
<meta property="article:modified_time" content="2023-12-27T16:01:47+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android Security PIN 相关代码</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>开发项目遇到一个问题，具体描述及复制步骤如下：</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/fd/80/gpTvPtr0_o.png"></p> 
<p>就是开启"Enhanced PIN privacy"(增强的PIN隐私)的时候输入秘密的时候还是会显示数字<br> 如下图，应该是直接是“.” 不应该出现PIN 密码</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/a3/34/9cHodYaQ_o.png"></p> 
<p>想要的效果如下图：</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/9f/60/3qf9Mvcw_o.png"></p> 
<p>设置的步骤如下图：</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/f3/61/RcLjHjPe_o.png"></p> 
<p>其中涉及到的部分code如下：</p> 
<p>/frameworks/base/core/java/com/android/internal/widget/LockPatternUtils.java<br> /frameworks/base/packages/SystemUI/src/com/android/keyguard/KeyguardPinBasedInputViewController.java</p> 
<p>/frameworks/base/packages/SystemUI/src/com/android/keyguard/PasswordTextView.java</p> 
<p>/frameworks/base/services/core/java/com/android/server/locksettings/LockSettingsStorage.java</p> 
<p><strong>I.LockPatternUtils.java:</strong></p> 
<pre><code class="language-java">/**
     * @return Whether enhanced pin privacy is enabled.
     */
    public boolean isPinEnhancedPrivacyEnabled(int userId) {
        return getBoolean(LOCK_PIN_ENHANCED_PRIVACY, false, userId);
    }

    /**
     * Set whether enhanced pin privacy is enabled.
     */
    public void setPinEnhancedPrivacyEnabled(boolean enabled, int userId) {
        setBoolean(LOCK_PIN_ENHANCED_PRIVACY, enabled, userId);
    }

private boolean getBoolean(String secureSettingKey, boolean defaultValue, int userId) {
        Log.i("TD","LockPatternUtils-----&gt;getBoolean: "+secureSettingKey);
        try {
            return getLockSettings().getBoolean(secureSettingKey, defaultValue, userId);
        } catch (RemoteException re) {
            return defaultValue;
        }
    }

    private void setBoolean(String secureSettingKey, boolean enabled, int userId) {
        Log.i("TD","LockPatternUtils-----&gt;setsetBoolean: "+secureSettingKey);
        try {
            getLockSettings().setBoolean(secureSettingKey, enabled, userId);
        } catch (RemoteException re) {
            // What can we do?
            Log.e(TAG, "Couldn't write boolean " + secureSettingKey + re);
        }
    }
</code></pre> 
<p><strong>II.KeyguardPinBasedInputViewController.java</strong></p> 
<pre><code class="language-java">protected void onViewAttached() {
        super.onViewAttached();

        Log.i("TD","KeyguardPinBasedInputViewController-------------&gt;onViewAttached");
        boolean showAnimations = !mLockPatternUtils
                .isPinEnhancedPrivacyEnabled(KeyguardUpdateMonitor.getCurrentUser());
        mPasswordEntry.setShowPassword(showAnimations);
        for (NumPadKey button : mView.getButtons()) {
            button.setOnTouchListener((v, event) -&gt; {
                if (event.getActionMasked() == MotionEvent.ACTION_DOWN) {
                    mFalsingCollector.avoidGesture();
                }
                return false;
            });
            button.setAnimationEnabled(showAnimations);
        }
        mPasswordEntry.setOnKeyListener(mOnKeyListener);
        mPasswordEntry.setUserActivityListener(this::onUserInput);

        View deleteButton = mView.findViewById(R.id.delete_button);
        deleteButton.setOnTouchListener(mActionButtonTouchListener);
        deleteButton.setOnClickListener(v -&gt; {
            // check for time-based lockouts
            Log.i("TD","KeyguardPinBasedInputViewController-------------&gt;deleteButton");
            if (mPasswordEntry.isEnabled()) {
                mPasswordEntry.deleteLastChar();
            }
        });
        deleteButton.setOnLongClickListener(v -&gt; {
            // check for time-based lockouts
            if (mPasswordEntry.isEnabled()) {
                mView.resetPasswordText(true /* animate */, true /* announce */);
            }
            Log.i("TD","KeyguardPinBasedInputViewController-------------&gt;deleteButton#longPress");
            mView.doHapticKeyClick();
            return true;
        });

        View okButton = mView.findViewById(R.id.key_enter);
        if (okButton != null) {
            okButton.setOnTouchListener(mActionButtonTouchListener);
            okButton.setOnClickListener(v -&gt; {
                Log.i("TD","KeyguardPinBasedInputViewController-------------&gt;okButton");
                if (mPasswordEntry.isEnabled()) {
                    verifyPasswordAndUnlock();
                }
            });
            okButton.setOnHoverListener(mLiftToActivateListener);
        }
    }
</code></pre> 
<p><strong>III.LockSettingsStorage.java<br><span style="color:#fe2c24;">Pattern 的加密也会走到这边</span></strong></p> 
<pre><code class="language-java">public void setBoolean(String key, boolean value, int userId) {
        Log.i("TD","LockSettingsStorage*******&gt;setBoolean-=-key is: "+key + "  **value: "+value);
        setString(key, value ? "1" : "0", userId);
    }
    
    public void setString(String key, String value, int userId) {
        Preconditions.checkArgument(userId != USER_FRP, "cannot store lock settings for FRP user");

        writeKeyValue(key, value, userId);
        if (ArrayUtils.contains(SETTINGS_TO_BACKUP, key)) {
            BackupManager.dataChanged("com.android.providers.settings");
        }
    }
    
 public void writeKeyValue(String key, String value, int userId) {
        writeKeyValue(mOpenHelper.getWritableDatabase(), key, value, userId);
    }

    @VisibleForTesting
    public void writeKeyValue(SQLiteDatabase db, String key, String value, int userId) {
        Log.i("TD","LockSettingsService----&gt;writeKeyValue");
        Log.i("TD","LockSettingsService----&gt;COLUMN_KEY: "+key);
        Log.i("TD","LockSettingsService----&gt;COLUMN_USERID: "+userId);
        Log.i("TD","LockSettingsService----&gt;COLUMN_VALUE: "+value);
        ContentValues cv = new ContentValues();
        cv.put(COLUMN_KEY, key);
        cv.put(COLUMN_USERID, userId);
        cv.put(COLUMN_VALUE, value);

        db.beginTransaction();
        try {
            db.delete(TABLE, COLUMN_KEY + "=? AND " + COLUMN_USERID + "=?",
                    new String[] {key, Integer.toString(userId)});
            db.insert(TABLE, null, cv);
            db.setTransactionSuccessful();
            mCache.putKeyValue(key, value, userId);
        } finally {
            db.endTransaction();
        }
        dispatchChange(this);
    }    
</code></pre> 
<p><strong>IV.PasswordTextView.java</strong></p> 
<pre><code class="language-java">private void startDotAppearAnimation(long delay) {
            cancelAnimator(dotAnimator);
            if (!mShowPassword) {
                // We perform an overshoot animation
                ValueAnimator overShootAnimator = ValueAnimator.ofFloat(currentDotSizeFactor,
                        DOT_OVERSHOOT_FACTOR);
                overShootAnimator.addUpdateListener(dotSizeUpdater);
                overShootAnimator.setInterpolator(mAppearInterpolator);
                long overShootDuration = (long) (DOT_APPEAR_DURATION_OVERSHOOT
                        * OVERSHOOT_TIME_POSITION);
                overShootAnimator.setDuration(overShootDuration);
                ValueAnimator settleBackAnimator = ValueAnimator.ofFloat(DOT_OVERSHOOT_FACTOR,
                        1.0f);
                settleBackAnimator.addUpdateListener(dotSizeUpdater);
                settleBackAnimator.setDuration(DOT_APPEAR_DURATION_OVERSHOOT - overShootDuration);
                settleBackAnimator.addListener(dotFinishListener);
                AnimatorSet animatorSet = new AnimatorSet();
                animatorSet.playSequentially(overShootAnimator, settleBackAnimator);
                animatorSet.setStartDelay(delay);
                animatorSet.start();
                dotAnimator = animatorSet;
            } else {
                ValueAnimator growAnimator = ValueAnimator.ofFloat(currentDotSizeFactor, 1.0f);
                growAnimator.addUpdateListener(dotSizeUpdater);
                growAnimator.setDuration((long) (APPEAR_DURATION * (1.0f - currentDotSizeFactor)));
                growAnimator.addListener(dotFinishListener);
                growAnimator.setStartDelay(delay);
                growAnimator.start();
                dotAnimator = growAnimator;
            }
            dotAnimationIsGrowing = true;
        }</code></pre> 
<pre><code class="language-java">void startAppearAnimation() {
            boolean dotNeedsAnimation = !mShowPassword
                    &amp;&amp; (dotAnimator == null || !dotAnimationIsGrowing);
            boolean textNeedsAnimation = mShowPassword
                    &amp;&amp; (textAnimator == null || !textAnimationIsGrowing);
            boolean widthNeedsAnimation = (widthAnimator == null || !widthAnimationIsGrowing);
            if (dotNeedsAnimation) {
                startDotAppearAnimation(0);
            }
            if (textNeedsAnimation) {
                startTextAppearAnimation();
            }
            if (widthNeedsAnimation) {
                startWidthAppearAnimation();
            }
            if (mShowPassword) {
                postDotSwap(TEXT_VISIBILITY_DURATION);
            }
        }</code></pre> 
<p><span style="color:#fe2c24;"><strong>出现问题的地方就是下面代码注释的部分，这个值为True.</strong></span></p> 
<pre><code class="language-java"> public void append(char c) {
        if (ZTelephonyManagerCommon.IS_ZEBRA_WWAN
            &amp;&amp; (mPasswordMaxSize != -1)
            &amp;&amp; (mText.length() &gt;= mPasswordMaxSize)) {
            return;
        }
        int visibleChars = mTextChars.size();
        CharSequence textbefore = getTransformedText();
        mText = mText + c;
        int newLength = mText.length();
        CharState charState;
        if (newLength &gt; visibleChars) {
            charState = obtainCharState(c);
            mTextChars.add(charState);
        } else {
            charState = mTextChars.get(newLength - 1);
            charState.whichChar = c;
        }

//        if (XXX.orElse(false)) {
//            mShowPassword = Settings.System.getInt(mContext.getContentResolver(),
//                    Settings.System.TEXT_SHOW_PASSWORD, 1) == 1;
//        }
        Log.i("TD","mShowPassword---------&gt;"+Settings.System.getInt(mContext.getContentResolver(),
                    Settings.System.TEXT_SHOW_PASSWORD, 1));
        charState.startAppearAnimation();

        // ensure that the previous element is being swapped
        if (newLength &gt; 1) {
            CharState previousState = mTextChars.get(newLength - 2);
            if (previousState.isDotSwapPending) {
                previousState.swapToDotWhenAppearFinished();
            }
        }
        userActivity();
        sendAccessibilityEventTypeViewTextChanged(textbefore, textbefore.length(), 0, 1);
    }
</code></pre> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e2447bcf31eb3bfb997db1a12709dbb0/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">使用Rust发送邮件</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6f044c33ac199f00c140f78ae2d15ada/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">干货满满，网络安全知识赶快学起来！</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>