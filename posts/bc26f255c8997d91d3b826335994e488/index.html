<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>k8s部署mysql一主二从，数据持久化部署 - 菜鸟程序员博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="k8s部署mysql一主二从，数据持久化部署" />
<meta property="og:description" content="mysql-configmap.yaml
apiVersion:v1 kind:ConfigMap metadata: name:mysql labels: app:mysql data: master.cnf:| # Apply this config only on the master. [mysqld] log-bin log_bin_trust_function_creators=1 lower_case_table_names=1 slave.cnf:| # Apply this config only on slaves. [mysqld] super-read-only log_bin_trust_function_creators=1 mysql-service.yaml
apiVersion: v1 kind: Service metadata: name: mysql labels: app: mysql spec: ports: - name: mysql port: 3306 clusterIP: None selector: app: mysql --- apiVersion: v1 kind: Service metadata: name: mysql-read labels: app: mysql spec: ports: - name: mysql port: 3306 selector: app: mysql mysql-statefulset." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cainiaoprogram.github.io/posts/bc26f255c8997d91d3b826335994e488/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-18T11:55:13+08:00" />
<meta property="article:modified_time" content="2023-04-18T11:55:13+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="菜鸟程序员博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">菜鸟程序员博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">k8s部署mysql一主二从，数据持久化部署</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>mysql-configmap.yaml</p> 
<pre><code class="language-bash">apiVersion:v1

kind:ConfigMap

metadata:

  name:mysql

  labels:

    app:mysql

data:

  master.cnf:|

    # Apply this config only on the master.

    [mysqld]

    log-bin

    log_bin_trust_function_creators=1

    lower_case_table_names=1

  slave.cnf:|

    # Apply this config only on slaves.

    [mysqld]

    super-read-only

    log_bin_trust_function_creators=1</code></pre> 
<p>mysql-service.yaml</p> 
<pre><code class="language-bash">apiVersion: v1

kind: Service

metadata:

  name: mysql

  labels:

    app: mysql

spec:

  ports:

  - name: mysql

    port: 3306

  clusterIP: None

  selector:

    app: mysql

---

apiVersion: v1

kind: Service

metadata:

  name: mysql-read

  labels:

    app: mysql

spec:

  ports:

  - name: mysql

    port: 3306

  selector:

    app: mysql</code></pre> 
<p>mysql-statefulset.yaml</p> 
<pre><code class="language-bash">apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mysql
spec:
  selector:
    matchLabels:
      app: mysql
  serviceName: mysql
  replicas: 3
  volumeClaimTemplates:
  - metadata:
      name: data
      annotations:
        volume.beta.kubernetes.io/storage-class: "nfs"
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 10Gi
  template:
    metadata:
      labels:
        app: mysql
    spec:
      initContainers:
      - name: init-mysql
        image: mysql:5.7
        command:
        - bash
        - "-c"
        - |
          set -ex
          [[ `hostname` =~ -([0-9]+)$ ]] || exit 1
          ordinal=${BASH_REMATCH[1]}
          echo [mysqld] &gt; /mnt/conf.d/server-id.cnf
          echo server-id=$((100 + $ordinal)) &gt;&gt; /mnt/conf.d/server-id.cnf
          if [[ $ordinal -eq 0 ]]; then
            cp /mnt/config-map/master.cnf /mnt/conf.d/
          else
            cp /mnt/config-map/slave.cnf /mnt/conf.d/
          fi
        volumeMounts:
        - name: conf
          mountPath: /mnt/conf.d
        - name: config-map
          mountPath: /mnt/config-map
      - name: clone-mysql
        image: gcr.io/google-samples/xtrabackup:1.0
        command:
        - bash
        - "-c"
        - |
          set -ex
          [[ -d /var/lib/mysql/mysql ]] &amp;&amp; exit 0
          [[ `hostname` =~ -([0-9]+)$ ]] || exit 1
          ordinal=${BASH_REMATCH[1]}
          [[ $ordinal -eq 0 ]] &amp;&amp; exit 0
          ncat --recv-only mysql-$(($ordinal-1)).mysql 3307 | xbstream -x -C /var/lib/mysql
          xtrabackup --prepare --target-dir=/var/lib/mysql
        volumeMounts:
        - name: data
          mountPath: /var/lib/mysql
          subPath: mysql
        - name: conf
          mountPath: /etc/mysql/conf.d
      containers:
      - name: mysql
        image: mysql:5.7
        env:
        - name: MYSQL_ALLOW_EMPTY_PASSWORD
          value: "1"
        ports:
        - name: mysql
          containerPort: 3306
        volumeMounts:
        - name: data
          mountPath: /var/lib/mysql
          subPath: mysql
        - name: conf
          mountPath: /etc/mysql/conf.d
        resources:
          requests:
            cpu: 500m
            memory: 1Gi
        livenessProbe:
          exec:
            command: ["mysqladmin", "ping"]
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
        readinessProbe:
          exec:
            command: ["mysql", "-h", "127.0.0.1", "-e", "SELECT 1"]
          initialDelaySeconds: 5
          periodSeconds: 2
          timeoutSeconds: 1
      - name: xtrabackup
        image: gcr.io/google-samples/xtrabackup:1.0
        ports:
        - name: xtrabackup
          containerPort: 3307
        command:
        - bash
        - "-c"
        - |
          set -ex
          cd /var/lib/mysql
          if [[ -f xtrabackup_slave_info ]]; then
            mv xtrabackup_slave_info change_master_to.sql.in
            rm -f xtrabackup_binlog_info
          elif [[ -f xtrabackup_binlog_info ]]; then
            [[ `cat xtrabackup_binlog_info` =~ ^(.*?)[[:space:]]+(.*?)$ ]] || exit 1
            rm xtrabackup_binlog_info
            echo "CHANGE MASTER TO MASTER_LOG_FILE='${BASH_REMATCH[1]}',\
                  MASTER_LOG_POS=${BASH_REMATCH[2]}" &gt; change_master_to.sql.in
          fi
          if [[ -f change_master_to.sql.in ]]; then
            echo "Waiting for mysqld to be ready (accepting connections)"
            until mysql -h 127.0.0.1 -e "SELECT 1"; do sleep 1; done
            echo "Initializing replication from clone position"
            mv change_master_to.sql.in change_master_to.sql.orig
            mysql -h 127.0.0.1 &lt;&lt;EOF
          $(&lt;change_master_to.sql.orig),
            MASTER_HOST='mysql-0.mysql',
            MASTER_USER='root',
            MASTER_PASSWORD='',
            MASTER_CONNECT_RETRY=10;
          START SLAVE;
          EOF
          fi
          exec ncat --listen --keep-open --send-only --max-conns=1 3307 -c \
            "xtrabackup --backup --slave-info --stream=xbstream --host=127.0.0.1 --user=root"
        volumeMounts:
        - name: data
          mountPath: /var/lib/mysql
          subPath: mysql
        - name: conf
          mountPath: /etc/mysql/conf.d
        resources:
          requests:
            cpu: 100m
            memory: 100Mi
      volumes:
      - name: conf
        emptyDir: {}
      - name: config-map
        configMap:
          name: mysql
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      storageClassName: "nfs-storage"
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 10Gi</code></pre> 
<p><a href="https://blog.csdn.net/weixin_55509209/article/details/130214432?spm=1001.2014.3001.5501" title="storageclass 的配置请见文章 ：  k8s1.26 nfs-provisioner配置_weixin_55509209的博客-CSDN博客">storageclass 的配置请见文章 ：  k8s1.26 nfs-provisioner配置_weixin_55509209的博客-CSDN博客</a></p> 
<p>kubectl apply -f  mysql-configmap.yaml</p> 
<p>kubectl apply -f mysql-service.yaml</p> 
<p>kubectl apply -f  mysql-statefulset.yaml</p> 
<p>确认、测试</p> 
<pre><code class="language-bash">[root@k8s-1 mysql]# kubectl get pv,pvc  |grep mysql
persistentvolume/pvc-7795294e-8bbc-44cd-93f5-2057465f771f   10Gi       RWO            Delete           Bound    default/data-mysql-1   nfs-storage             12h
persistentvolume/pvc-ad28c7ab-0070-44ae-9578-4f73955024d6   10Gi       RWO            Delete           Bound    default/data-mysql-2   nfs-storage             12h
persistentvolume/pvc-ffc91da4-3419-47cc-9c81-752e7dfb914f   10Gi       RWO            Delete           Bound    default/data-mysql-0   nfs-storage             13h
persistentvolumeclaim/data-mysql-0   Bound    pvc-ffc91da4-3419-47cc-9c81-752e7dfb914f   10Gi       RWO            nfs-storage    13h
persistentvolumeclaim/data-mysql-1   Bound    pvc-7795294e-8bbc-44cd-93f5-2057465f771f   10Gi       RWO            nfs-storage    12h
persistentvolumeclaim/data-mysql-2   Bound    pvc-ad28c7ab-0070-44ae-9578-4f73955024d6   10Gi       RWO            nfs-storage    12h

[root@k8s-1 mysql]# kubectl get pod  |grep mysql
mysql-0                                   2/2     Running   2 (4h37m ago)   12h
mysql-1                                   2/2     Running   2 (3h54m ago)   12h
mysql-2                                   2/2     Running   2 (4h37m ago)   12h

[root@k8s-1 mysql]# kubectl get svc |grep mysql
mysql        ClusterIP   None             &lt;none&gt;        3306/TCP   13h
mysql-read   ClusterIP   10.110.142.170   &lt;none&gt;        3306/TCP   13h

[root@k8s-1 mysql]# kubectl exec -it mysql-0 bash
kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.
Defaulted container "mysql" out of: mysql, xtrabackup, init-mysql (init), clone-mysql (init)
bash-4.2# mysql
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 8391
Server version: 5.7.41-log MySQL Community Server (GPL)

Copyright (c) 2000, 2023, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql&gt; show databases;
+------------------------+
| Database               |
+------------------------+
| information_schema     |
| SC                     |
| mysql                  |
| performance_schema     |
| sys                    |
| xtrabackup_backupfiles |
+------------------------+
6 rows in set (0.00 sec)</code></pre> 
<p>文章参考：<a href="https://www.kubebiz.com/lchongkf/mysql-production" rel="nofollow" title="https://www.kubebiz.com/lchongkf/mysql-production">https://www.kubebiz.com/lchongkf/mysql-production</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ed8b8005d8873e911f277b4106e6cce4/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">k8s1.26 nfs-provisioner配置</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3acd530cfa49fb8bb5e14a3a8f498ed9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">偷偷告诉mysql这47个SQL性能优化技巧，赶紧收藏了！</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 菜鸟程序员博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>